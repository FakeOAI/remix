import{u as k,r,H as G,as as x,es as J,a3 as H,w as O,o as N,am as j,fm as w}from"./fol9lhe7btzxzxo4.js";import{c as m,d as B,e as K,R as W,g as M,a as L,V as p,b as u,I as X,f as C,h as V,r as z,L as Y,i as Z,j as y}from"./ntyz4f6vpmrh434v.js";import{hj as ee,hk as $,cd as P,aL as te,hl as ne}from"./mgunoh0gidimcomw.js";function Q(){const t=k("716722001").value,e=k("2436427643").value,n=k("1413999995").value;return{av:t,video:e,screenshare:n}}function ae(){se(),oe(),ce(),ie()}function ie(){const{room:t,debug:e}=m(),n=Q(),s=n.video||n.av,c=r.useMemo(()=>{const a=["audioinput","audiooutput"];return s&&a.push("videoinput"),a},[s]);r.useEffect(()=>{async function a(){Promise.all(c.map(async o=>{const d=await W.getLocalDevices(o),l=t?.getActiveDevice(o);if(!d.find(g=>g.deviceId===l)){const g=await M(o);let v=null;g?v=g.deviceId:d[0]&&(v=d[0].deviceId),e(`switching ${o} to ${v}`),v&&await t?.switchActiveDevice(o,v)}}))}if(navigator)return navigator.mediaDevices.addEventListener("devicechange",a),()=>{navigator.mediaDevices.removeEventListener("devicechange",a)}},[t,e,c])}function se(){const{room:t,debug:e}=m(),n=t?.getActiveDevice("audioinput"),s=t?.getActiveDevice("audiooutput");r.useEffect(()=>{async function c(){const a=(await M("audioinput"))?.deviceId,o=(await M("audiooutput"))?.deviceId,d=async()=>{a&&n!==a&&(e("switching audio input to default"),await t?.switchActiveDevice("audioinput",a))},l=async()=>{if(o&&s!==o){e("switching audio output to default");try{await t?.switchActiveDevice("audiooutput",o)}catch(I){e("failed to switch audio output",I)}}};await Promise.all([d(),l()])}c()},[n,s,e,t])}function oe(){const{isVideoEnabled:t,endStartingVideo:e}=B(),{room:n,debug:s}=m(),c=Q(),a=c.video||c.av,o=a?n?.getActiveDevice("videoinput"):void 0;r.useEffect(()=>{async function d(){if(t)try{await n?.localParticipant.setCameraEnabled(!0),e(!0)}catch{e(!1)}else await n?.localParticipant.setCameraEnabled(!1)}n&&d()},[t,e,n]),r.useEffect(()=>{async function d(){const l=(await M("videoinput"))?.deviceId;await(async()=>{l&&o!==l&&(s("switching video input to default"),await n?.switchActiveDevice("videoinput",l))})()}a&&d()},[o,s,n,a])}function ce(){const{room:t}=m(),{isScreenshareEnabled:e,endStartingScreenshare:n}=K();r.useEffect(()=>{async function s(){if(e)try{await t?.localParticipant.setScreenShareEnabled(!0,{video:{displaySurface:"monitor"}}),n(!0)}catch{n(!1)}else await t?.localParticipant.setScreenShareEnabled(!1)}t&&s()},[t,e,n])}function F(){const{debug:t}=m(),e=L(s=>s.conversationId),n=G();return r.useCallback(async s=>{const c=s,a=e&&!x(e)?e:void 0,o=c??a;if(o){t(`refetch conversationId ${o}`);try{await ee(o,!0)}catch(d){const l="Failed to update conversation";t(l,d),n.danger(l)}}},[e,t,n])}const re=5e3,de=2e3,ue=t=>{const{room:e}=m(),n=L(h=>h.disconnectPending),s=L(h=>h.server.remoteState===p.Speaking),c=L(h=>h.conversationId)??void 0,a=J(c),o=r.useRef(!1),d=F(),l=H(),I=O();o.current=s||o.current;const g=r.useCallback(async h=>{clearTimeout(n),u.setState(E=>{E.disconnectPending=void 0}),e?.disconnect(),await d(a),u.setState(X);const b=a??h;b&&$(l,I,b),t?.refetchLater&&window.setTimeout(()=>{d(a)},de)},[n,e,d,a,t?.refetchLater,l,I]),v=o.current&&!a,R=r.useCallback(()=>{u.setState(h=>{h.disconnectPending=window.setTimeout(g,re)})},[g]);return{disconnectPending:n!==void 0,shouldDelayDisconnect:v,delayDisconnect:R,immediateDisconnect:g}};function le(){const t=O(),{room:e,debug:n,decoder:s}=m(),{disconnectPending:c,immediateDisconnect:a}=ue(),o=F(),d=H(),l=r.useRef(!1),I=r.useRef(!1),g=P(v=>v.lastVoiceSessionStartTime);r.useEffect(()=>{const v=async S=>{const{new_state:i}=S;if(u.setState(f=>{f.server.remoteState=i}),i===p.Listening&&!I.current&&g instanceof Date){const T=new Date().getTime()-g.getTime();w.firstListeningLatency.success({durationMs:T}),I.current=!0}i===p.ListeningIntently?w.voiceSessionListeningIntently.stateChange():i===p.Listening?w.voiceSessionListening.stateChange():i===p.Thinking?w.voiceSessionThinking.stateChange():i===p.Speaking?w.voiceSessionSpeaking.stateChange():i===p.Halted&&w.voiceSessionHalted.stateChange()},R=async S=>{u.setState(i=>{i.server.usage=S})},h=async S=>{u.setState(i=>{i.server.toolUpdate={...S}})},b=async S=>{let i;try{i=JSON.parse(s.decode(S)),n("data recevied",i)}catch(f){n("error parsing data",f);return}switch(u.setState(f=>(f.server.messages.push({...i,timestamp:new Date,source:"remote"}),f)),i.type){case V.StateUpdate:n("state update",i.payload);const{new_state:f,delay_s:T}=i.payload;if([p.Thinking,p.Speaking].includes(f)&&u.getState().server.turnContext.clear(),f===p.Listening&&!l.current){l.current=!0,performance.mark("voice_mode.end");const D=performance.measure("voice_mode","voice_mode.start","voice_mode.end").duration.toFixed(0);w.voiceMode.connect({durationMs:D})}f===p.Thinking&&T&&(n(`${e?.name} delay thinking state by ${T} seconds`),v({new_state:p.ListeningIntently,delay_s:T}),await new Promise(D=>setTimeout(D,T*1e3))),v(i.payload);break;case V.ConversationUpdate:{n("conversation update",i.payload);const D=u.getState().conversationId,{conversation_id:A}=i.payload;D&&x(D)&&(N.initThread(D,{kind:j.PrimaryAssistant}),N.setServerIdForNewThread(D,A),u.setState(q=>{q.conversationId=A}),$(te,t,A),ne(t)),await o(A),c&&a(A);break}case V.UsageUpdate:R(i.payload);break;case V.ToolUpdate:h(i.payload);break}},E=(S,i)=>{n("track published",S,i)},_=()=>{n("disconnected"),z(),w.voiceSessionDisconnected.stateChange()},U=(S,i)=>{i instanceof Y&&(n(`Connection quality changed for participant ${i.identity}: ${S}`),u.setState(f=>{f.server.voiceConnectionQuality=S}))};return e?.on(C.DataReceived,b),e?.on(C.TrackPublished,E),e?.on(C.ConnectionQualityChanged,U),e?.on(C.Disconnected,_),()=>{e?.off(C.DataReceived,b),e?.off(C.TrackPublished,E),e?.off(C.ConnectionQualityChanged,U),e?.off(C.Disconnected,_)}},[t,e,o,n,s,d,c,a,g])}function ve(){fe(),ge(),Se(),pe(),he()}function fe(){const{room:t}=m();r.useEffect(()=>{u.setState(e=>{e.dev.room=t})},[t])}function ge(){const{room:t}=m(),e=Z(t);r.useEffect(()=>{u.setState(n=>{n.server.connectionState=e})},[e])}function Se(){const{room:t,debug:e,encoder:n}=m();r.useEffect(()=>{const s=!!u.getState().server.actions;if(t&&!s){const c=async a=>{e("publishing action",a);const o={type:V.ActionRequest,payload:{action:a}};await t.localParticipant.publishData(n.encode(JSON.stringify(o)),{reliable:!0}),u.setState(d=>{d.server.messages.push({...o,timestamp:new Date,source:"local"})})};u.setState(a=>{a.server.actions={[y.StartListeningIntently]:()=>c(y.StartListeningIntently),[y.StopListeningIntently]:()=>c(y.StopListeningIntently),[y.HaltAllActivity]:()=>c(y.HaltAllActivity),[y.ResumeListening]:()=>c(y.ResumeListening),[y.RelayMessage]:()=>c(y.RelayMessage)}})}},[t,e,n])}function pe(){const t=u(e=>e.isVoiceModeActive);r.useEffect(()=>(P.setState({isVoiceActive:t}),()=>{P.setState({isVoiceActive:!1})}),[t])}function he(){const{room:t,encoder:e}=m(),n=r.useCallback(async s=>{await t?.localParticipant.publishData(e.encode(JSON.stringify(s)),{reliable:!0}),u.setState(c=>{c.server.messages.push({...s,timestamp:new Date,source:"local"})})},[t,e]);r.useEffect(()=>{u.setState(s=>{s.server.turnContext.setPublisher(n)})},[n])}const De=r.memo(function(){return le(),ve(),ae(),null});export{De as V,Q as a,ue as u};
//# sourceMappingURL=gt5bfpuemzt7mnen.js.map
