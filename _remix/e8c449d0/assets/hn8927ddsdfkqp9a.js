import{r as v,a8 as H,bh as L,a as _,a3 as Q,cQ as x}from"./ocp1psdvo7s079n6.js";import{d as m,e as F,f as q,R as J,g as R,a as V,V as E,b as u,I as j,h,i as C,r as B,L as G,j as K,k as S}from"./i1ful5binj02wqq4.js";import{o as U}from"./ds76px0yaj99gjto.js";import{r as W}from"./gwcxwlnj3xqo72hp.js";import{f as X}from"./lyrcpf96v5bl5084.js";import{l as N,d as z,T as P}from"./oaq3fl6muamktpp2.js";import{al as Y}from"./rdbylepeccge9tbg.js";import{u as k}from"./izctx8xm0yrnltp4.js";function Z(){te(),ne(),ae(),ee()}function ee(){const{room:t,debug:e}=m();v.useEffect(()=>{async function n(){Promise.all(["audioinput","audiooutput","videoinput"].map(async o=>{const c=await J.getLocalDevices(o),a=t?.getActiveDevice(o);if(!c.find(r=>r.deviceId===a)){const r=await R(o);let d=null;r?d=r.deviceId:c[0]&&(d=c[0].deviceId),e(`switching ${o} to ${d}`),d&&await t?.switchActiveDevice(o,d)}}))}if(navigator)return navigator.mediaDevices.addEventListener("devicechange",n),()=>{navigator.mediaDevices.removeEventListener("devicechange",n)}},[t,e])}function te(){const{room:t,debug:e}=m(),n=t?.getActiveDevice("audioinput"),o=t?.getActiveDevice("audiooutput");v.useEffect(()=>{async function c(){const a=(await R("audioinput"))?.deviceId,s=(await R("audiooutput"))?.deviceId,r=async()=>{a&&n!==a&&(e("switching audio input to default"),await t?.switchActiveDevice("audioinput",a))},d=async()=>{if(s&&o!==s){e("switching audio output to default");try{await t?.switchActiveDevice("audiooutput",s)}catch(g){e("failed to switch audio output",g)}}};await Promise.all([r(),d()])}c()},[n,o,e,t])}function ne(){const{isVideoEnabled:t,endStartingVideo:e}=F(),{room:n,debug:o}=m(),c=n?.getActiveDevice("videoinput");v.useEffect(()=>{async function a(){if(t)try{await n?.localParticipant.setCameraEnabled(!0),e(!0)}catch{e(!1)}else await n?.localParticipant.setCameraEnabled(!1)}n&&a()},[t,e,n]),v.useEffect(()=>{async function a(){const s=(await R("videoinput"))?.deviceId;await(async()=>{s&&c!==s&&(o("switching video input to default"),await n?.switchActiveDevice("videoinput",s))})()}a()},[c,o,n])}function ae(){const{room:t}=m(),{isScreenshareEnabled:e,endStartingScreenshare:n}=q();v.useEffect(()=>{async function o(){if(e)try{await t?.localParticipant.setScreenShareEnabled(!0,{video:{displaySurface:"monitor"}}),n(!0)}catch{n(!1)}else await t?.localParticipant.setScreenShareEnabled(!1)}t&&o()},[t,e,n])}function O(){const{debug:t}=m(),e=V(o=>o.conversationId),n=H();return v.useCallback(async o=>{const c=o,a=e&&!N(e)?e:void 0,s=c??a;if(s){t(`refetch conversationId ${s}`);try{await X(s,!0)}catch(r){const d="Failed to update conversation";t(d,r),n.danger(d)}}},[e,t,n])}const oe=5e3,ie=2e3,se=t=>{const{room:e}=m(),n=V(l=>l.disconnectPending),o=V(l=>l.server.remoteState===E.Speaking),c=V(l=>l.conversationId)??void 0,a=z(c),s=v.useRef(!1),r=O(),d=L(),g=_();s.current=o||s.current;const I=v.useCallback(async l=>{clearTimeout(n),u.setState(A=>{A.disconnectPending=void 0}),e?.disconnect(),await r(a),u.setState(j);const D=a??l;D&&U(d,g,D),t?.refetchLater&&window.setTimeout(()=>{r(a)},ie)},[n,e,r,a,t?.refetchLater,d,g]),M=s.current&&!a,T=v.useCallback(()=>{u.setState(l=>{l.disconnectPending=window.setTimeout(I,oe)})},[I]);return{disconnectPending:n!==void 0,shouldDelayDisconnect:M,delayDisconnect:T,immediateDisconnect:I}};function ce(){const t=_(),{room:e,debug:n,decoder:o}=m(),{disconnectPending:c,immediateDisconnect:a}=se(),s=O(),r=L(),d=v.useRef(!1);v.useEffect(()=>{const g=async f=>{const{new_state:i}=f;u.setState(p=>{p.server.remoteState=i})},I=async f=>{u.setState(i=>{i.server.usage=f})},M=async f=>{u.setState(i=>{i.server.toolUpdate={...f}})},T=async f=>{let i;try{i=JSON.parse(o.decode(f)),n("data recevied",i)}catch(p){n("error parsing data",p);return}switch(u.setState(p=>(p.server.messages.push({...i,timestamp:new Date,source:"remote"}),p)),i.type){case C.StateUpdate:n("state update",i.payload);const{new_state:p,delay_s:b}=i.payload;if(p===E.Listening&&!d.current){d.current=!0,performance.mark("voice_mode.end");const y=performance.measure("voice_mode","voice_mode.start","voice_mode.end").duration.toFixed(0);x.voiceMode.connect({durationMs:y})}p===E.Thinking&&b&&(n(`${e?.name} delay thinking state by ${b} seconds`),g({new_state:E.ListeningIntently,delay_s:b}),await new Promise(y=>setTimeout(y,b*1e3))),g(i.payload);break;case C.ConversationUpdate:{n("conversation update",i.payload);const y=u.getState().conversationId,{conversation_id:w}=i.payload;y&&N(y)&&(P.initThread(y,{kind:Q.PrimaryAssistant}),P.setServerIdForNewThread(y,w),u.setState($=>{$.conversationId=w}),U(Y,t,w),W(t)),await s(w),c&&a(w);break}case C.UsageUpdate:I(i.payload);break;case C.ToolUpdate:M(i.payload);break}},l=(f,i)=>{n("track published",f,i)},D=()=>{n("disconnected"),B()},A=(f,i)=>{i instanceof G&&(n(`Connection quality changed for participant ${i.identity}: ${f}`),u.setState(p=>{p.server.voiceConnectionQuality=f}))};return e?.on(h.DataReceived,T),e?.on(h.TrackPublished,l),e?.on(h.ConnectionQualityChanged,A),e?.on(h.Disconnected,D),()=>{e?.off(h.DataReceived,T),e?.off(h.TrackPublished,l),e?.off(h.ConnectionQualityChanged,A),e?.off(h.Disconnected,D)}},[t,e,s,n,o,r,c,a])}function re(){de(),ue(),ve(),le()}function de(){const{room:t}=m();v.useEffect(()=>{u.setState(e=>{e.dev.room=t})},[t])}function ue(){const{room:t}=m(),e=K(t);v.useEffect(()=>{u.setState(n=>{n.server.connectionState=e})},[e])}function ve(){const{room:t,debug:e,encoder:n}=m();v.useEffect(()=>{const o=!!u.getState().server.actions;if(t&&!o){const c=async a=>{e("publishing action",a);const s={type:C.ActionRequest,payload:{action:a}};await t.localParticipant.publishData(n.encode(JSON.stringify(s)),{reliable:!0}),u.setState(r=>{r.server.messages.push({...s,timestamp:new Date,source:"local"})})};u.setState(a=>{a.server.actions={[S.StartListeningIntently]:()=>c(S.StartListeningIntently),[S.StopListeningIntently]:()=>c(S.StopListeningIntently),[S.HaltAllActivity]:()=>c(S.HaltAllActivity),[S.ResumeListening]:()=>c(S.ResumeListening),[S.RelayMessage]:()=>c(S.RelayMessage)}})}},[t,e,n])}function le(){const t=u(e=>e.isVoiceModeActive);v.useEffect(()=>(k.setState({isVoiceActive:t}),()=>{k.setState({isVoiceActive:!1})}),[t])}const De=v.memo(function(){return ce(),re(),Z(),null});export{De as V,se as u};
//# sourceMappingURL=hn8927ddsdfkqp9a.js.map
