import{r,e as x,a as H}from"./nqo5y2f0dorhrqsr.js";import{a as m,b as q,c as J,R as B,g as R,u as M,V as p,d as u,I as K,e as w,f as V,r as W,L as X,h as j,i as y}from"./by3xwcsf6pm50mbh.js";import{u as k,G as z,ao as O,el as Y,r as N,ai as Z,eE as C}from"./ph3npw8ji7sj8uot.js";import{hb as ee,hc as $,cg as P,aP as te,hd as ne}from"./lhyhests3vwi7plx.js";function Q(){const t=k("716722001").value,e=k("2436427643").value,n=k("1413999995").value;return{av:t,video:e,screenshare:n}}function ae(){se(),oe(),ce(),ie()}function ie(){const{room:t,debug:e}=m(),n=Q(),s=n.video||n.av,c=r.useMemo(()=>{const a=["audioinput","audiooutput"];return s&&a.push("videoinput"),a},[s]);r.useEffect(()=>{async function a(){Promise.all(c.map(async o=>{const d=await B.getLocalDevices(o),l=t?.getActiveDevice(o);if(!d.find(g=>g.deviceId===l)){const g=await R(o);let v=null;g?v=g.deviceId:d[0]&&(v=d[0].deviceId),e(`switching ${o} to ${v}`),v&&await t?.switchActiveDevice(o,v)}}))}if(navigator)return navigator.mediaDevices.addEventListener("devicechange",a),()=>{navigator.mediaDevices.removeEventListener("devicechange",a)}},[t,e,c])}function se(){const{room:t,debug:e}=m(),n=t?.getActiveDevice("audioinput"),s=t?.getActiveDevice("audiooutput");r.useEffect(()=>{async function c(){const a=(await R("audioinput"))?.deviceId,o=(await R("audiooutput"))?.deviceId,d=async()=>{a&&n!==a&&(e("switching audio input to default"),await t?.switchActiveDevice("audioinput",a))},l=async()=>{if(o&&s!==o){e("switching audio output to default");try{await t?.switchActiveDevice("audiooutput",o)}catch(I){e("failed to switch audio output",I)}}};await Promise.all([d(),l()])}c()},[n,s,e,t])}function oe(){const{isVideoEnabled:t,endStartingVideo:e}=q(),{room:n,debug:s}=m(),c=Q(),a=c.video||c.av,o=a?n?.getActiveDevice("videoinput"):void 0;r.useEffect(()=>{async function d(){if(t)try{await n?.localParticipant.setCameraEnabled(!0),e(!0)}catch{e(!1)}else await n?.localParticipant.setCameraEnabled(!1)}n&&d()},[t,e,n]),r.useEffect(()=>{async function d(){const l=(await R("videoinput"))?.deviceId;await(async()=>{l&&o!==l&&(s("switching video input to default"),await n?.switchActiveDevice("videoinput",l))})()}a&&d()},[o,s,n,a])}function ce(){const{room:t}=m(),{isScreenshareEnabled:e,endStartingScreenshare:n}=J();r.useEffect(()=>{async function s(){if(e)try{await t?.localParticipant.setScreenShareEnabled(!0,{video:{displaySurface:"monitor"}}),n(!0)}catch{n(!1)}else await t?.localParticipant.setScreenShareEnabled(!1)}t&&s()},[t,e,n])}function F(){const{debug:t}=m(),e=M(s=>s.conversationId),n=z();return r.useCallback(async s=>{const c=s,a=e&&!O(e)?e:void 0,o=c??a;if(o){t(`refetch conversationId ${o}`);try{await ee(o,!0)}catch(d){const l="Failed to update conversation";t(l,d),n.danger(l)}}},[e,t,n])}const re=5e3,de=2e3,ue=t=>{const{room:e}=m(),n=M(h=>h.disconnectPending),s=M(h=>h.server.remoteState===p.Speaking),c=M(h=>h.conversationId)??void 0,a=Y(c),o=r.useRef(!1),d=F(),l=x(),I=H();o.current=s||o.current;const g=r.useCallback(async h=>{clearTimeout(n),u.setState(E=>{E.disconnectPending=void 0}),e?.disconnect(),await d(a),u.setState(K);const b=a??h;b&&$(l,I,b),t?.refetchLater&&window.setTimeout(()=>{d(a)},de)},[n,e,d,a,t?.refetchLater,l,I]),v=o.current&&!a,L=r.useCallback(()=>{u.setState(h=>{h.disconnectPending=window.setTimeout(g,re)})},[g]);return{disconnectPending:n!==void 0,shouldDelayDisconnect:v,delayDisconnect:L,immediateDisconnect:g}};function le(){const t=H(),{room:e,debug:n,decoder:s}=m(),{disconnectPending:c,immediateDisconnect:a}=ue(),o=F(),d=x(),l=r.useRef(!1),I=r.useRef(!1),g=P(v=>v.lastVoiceSessionStartTime);r.useEffect(()=>{const v=async S=>{const{new_state:i}=S;if(u.setState(f=>{f.server.remoteState=i}),i===p.Listening&&!I.current&&g instanceof Date){const T=new Date().getTime()-g.getTime();C.firstListeningLatency.success({durationMs:T}),I.current=!0}i===p.ListeningIntently?C.voiceSessionListeningIntently.stateChange():i===p.Listening?C.voiceSessionListening.stateChange():i===p.Thinking?C.voiceSessionThinking.stateChange():i===p.Speaking?C.voiceSessionSpeaking.stateChange():i===p.Halted&&C.voiceSessionHalted.stateChange()},L=async S=>{u.setState(i=>{i.server.usage=S})},h=async S=>{u.setState(i=>{i.server.toolUpdate={...S}})},b=async S=>{let i;try{i=JSON.parse(s.decode(S)),n("data recevied",i)}catch(f){n("error parsing data",f);return}switch(u.setState(f=>(f.server.messages.push({...i,timestamp:new Date,source:"remote"}),f)),i.type){case V.StateUpdate:n("state update",i.payload);const{new_state:f,delay_s:T}=i.payload;if([p.Thinking,p.Speaking].includes(f)&&u.getState().server.turnContext.clear(),f===p.Listening&&!l.current){l.current=!0,performance.mark("voice_mode.end");const D=performance.measure("voice_mode","voice_mode.start","voice_mode.end").duration.toFixed(0);C.voiceMode.connect({durationMs:D})}f===p.Thinking&&T&&(n(`${e?.name} delay thinking state by ${T} seconds`),v({new_state:p.ListeningIntently,delay_s:T}),await new Promise(D=>setTimeout(D,T*1e3))),v(i.payload);break;case V.ConversationUpdate:{n("conversation update",i.payload);const D=u.getState().conversationId,{conversation_id:A}=i.payload;D&&O(D)&&(N.initThread(D,{kind:Z.PrimaryAssistant}),N.setServerIdForNewThread(D,A),u.setState(G=>{G.conversationId=A}),$(te,t,A),ne(t)),await o(A),c&&a(A);break}case V.UsageUpdate:L(i.payload);break;case V.ToolUpdate:h(i.payload);break}},E=(S,i)=>{n("track published",S,i)},_=()=>{n("disconnected"),W(),C.voiceSessionDisconnected.stateChange()},U=(S,i)=>{i instanceof X&&(n(`Connection quality changed for participant ${i.identity}: ${S}`),u.setState(f=>{f.server.voiceConnectionQuality=S}))};return e?.on(w.DataReceived,b),e?.on(w.TrackPublished,E),e?.on(w.ConnectionQualityChanged,U),e?.on(w.Disconnected,_),()=>{e?.off(w.DataReceived,b),e?.off(w.TrackPublished,E),e?.off(w.ConnectionQualityChanged,U),e?.off(w.Disconnected,_)}},[t,e,o,n,s,d,c,a,g])}function ve(){fe(),ge(),Se(),pe(),he()}function fe(){const{room:t}=m();r.useEffect(()=>{u.setState(e=>{e.dev.room=t})},[t])}function ge(){const{room:t}=m(),e=j(t);r.useEffect(()=>{u.setState(n=>{n.server.connectionState=e})},[e])}function Se(){const{room:t,debug:e,encoder:n}=m();r.useEffect(()=>{const s=!!u.getState().server.actions;if(t&&!s){const c=async a=>{e("publishing action",a);const o={type:V.ActionRequest,payload:{action:a}};await t.localParticipant.publishData(n.encode(JSON.stringify(o)),{reliable:!0}),u.setState(d=>{d.server.messages.push({...o,timestamp:new Date,source:"local"})})};u.setState(a=>{a.server.actions={[y.StartListeningIntently]:()=>c(y.StartListeningIntently),[y.StopListeningIntently]:()=>c(y.StopListeningIntently),[y.HaltAllActivity]:()=>c(y.HaltAllActivity),[y.ResumeListening]:()=>c(y.ResumeListening),[y.RelayMessage]:()=>c(y.RelayMessage)}})}},[t,e,n])}function pe(){const t=u(e=>e.isVoiceModeActive);r.useEffect(()=>(P.setState({isVoiceActive:t}),()=>{P.setState({isVoiceActive:!1})}),[t])}function he(){const{room:t,encoder:e}=m(),n=r.useCallback(async s=>{await t?.localParticipant.publishData(e.encode(JSON.stringify(s)),{reliable:!0}),u.setState(c=>{c.server.messages.push({...s,timestamp:new Date,source:"local"})})},[t,e]);r.useEffect(()=>{u.setState(s=>{s.server.turnContext.setPublisher(n)})},[n])}const we=r.memo(function(){return le(),ve(),ae(),null});export{we as V,Q as a,ue as u};
//# sourceMappingURL=b0azjqmikabmaz2k.js.map
