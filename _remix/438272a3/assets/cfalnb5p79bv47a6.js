import{U as W,V as R,r as j,en as O,m as e,M as b,o as S,W as H,a0 as Q,bi as M}from"./f37ug925tzgwnb2p.js";import{fB as U,I as L,bh as K,bu as $,fC as T}from"./mybnkq9ibp2jyojd.js";import{bj as B,bk as z,bl as G,bm as X}from"./ees3py8cbftvsdc5.js";import{T as J,I as Y}from"./o2f8petl7bd26kwk.js";const Z=["Not relevant","Inaccurate","Incomplete","Missing sources","I don't like it","Shouldn't have searched Google Drive","Prompt was misunderstood","Didn't like the response style","Other"],ee=["Good sources","Answered my question","I like it","Other"],te=["Not relevant","Out of date","Content is wrong"],se=["Relevant","Up to date","Accurate"];function ne(a){switch(a){case"Not relevant":return x.tagNotRelevant;case"Inaccurate":return x.tagInaccurate;case"Incomplete":return x.tagIncomplete;case"Missing sources":return x.tagMissingSources;case"I don't like it":return x.tagDontLikeIt;case"Shouldn't have searched Google Drive":return x.tagShouldntHaveSearched;case"Prompt was misunderstood":return x.tagPromptMisunderstood;case"Didn't like the response style":return x.tagDidntLikeResponseStyle;case"Other":return x.tagOther;case"Good sources":return x.tagGoodSources;case"Answered my question":return x.tagAnsweredMyQuestion;case"I like it":return x.tagLike;case"Out of date":return x.tagOutOfDate;case"Content is wrong":return x.tagContentWrong;case"Relevant":return x.tagRelevant;case"Up to date":return x.tagUpToDate;case"Accurate":return x.tagAccurate}}function P(a,s){let n;try{n=ne(a)}catch{}return n?s.formatMessage(n):a}function E(a,s){return a.map(n=>({label:P(n,s),value:n}))}const x=W({tagNotRelevant:{id:"T24lap",defaultMessage:"Not relevant"},tagInaccurate:{id:"USOv/g",defaultMessage:"Inaccurate"},tagIncomplete:{id:"Lk26Q8",defaultMessage:"Incomplete"},tagMissingSources:{id:"Fng4pl",defaultMessage:"Missing sources"},tagDontLikeIt:{id:"6eAB3A",defaultMessage:"I don't like it"},tagShouldntHaveSearched:{id:"Y22bKM",defaultMessage:"Shouldn't have searched Google Drive"},tagPromptMisunderstood:{id:"NjmgTt",defaultMessage:"Prompt was misunderstood"},tagDidntLikeResponseStyle:{id:"np+P/8",defaultMessage:"Didn't like the response style"},tagOther:{id:"BK4DWm",defaultMessage:"Other"},tagGoodSources:{id:"SpXc0X",defaultMessage:"Good sources"},tagAnsweredMyQuestion:{id:"jbur49",defaultMessage:"Answered my question"},tagLike:{id:"w9iwLl",defaultMessage:"I like it"},tagOutOfDate:{id:"qzHvzr",defaultMessage:"Out of date"},tagContentWrong:{id:"gGDbwI",defaultMessage:"Content is wrong"},tagRelevant:{id:"G4D31U",defaultMessage:"Relevant"},tagUpToDate:{id:"CsRBPs",defaultMessage:"Up to date"},tagAccurate:{id:"ohD9UA",defaultMessage:"Accurate"}});function ae({citationMetadata:a,noBottomBorder:s=!1,sourceFeedback:n,setSourceFeedback:i}){const d=R(),[l,m]=j.useMemo(()=>{if(a.type!=="file")return["",""];const r=a.name.split(".");return r.length>1?[r.slice(0,-1).join("."),r[r.length-1]]:[a.name,""]},[a]),t=j.useMemo(()=>U(O.GDRIVE,m),[m]),c=j.useMemo(()=>{if(a.type==="file"&&a.extra?.cloud_doc_url)try{return new URL(a.extra.cloud_doc_url).hostname}catch{return}},[a]),u=j.useCallback(r=>{i({rating:r,tags:[]})},[i]);return a.type!=="file"?null:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-row items-center justify-between py-2",children:[e.jsxs("div",{className:"max-width-full mr-2 flex grow flex-row items-center overflow-hidden",children:[e.jsx(t,{className:"mr-2 flex-shrink-0 flex-grow-0"}),e.jsx("a",{href:a.extra?.cloud_doc_url,className:"text-token-primary flex-grow-1 flex-shrink-1 overflow-hidden text-ellipsis whitespace-nowrap text-sm",target:"_blank",rel:"noreferrer",children:l}),c&&e.jsx("div",{className:"ml-2 text-sm text-token-text-secondary",children:c})]}),e.jsxs("div",{className:"flex shrink-0 flex-row items-center",children:[e.jsx("button",{className:"rounded-md p-1 hover:bg-token-main-surface-secondary",children:n?.rating==="thumbsUp"?e.jsx(B,{className:"icon-md-heavy text-token-text-primary",onClick:()=>u(void 0)}):e.jsx(z,{className:"icon-md-heavy text-token-text-secondary",onClick:()=>u("thumbsUp")})}),e.jsx("button",{className:"rounded-md p-1 hover:bg-token-main-surface-secondary",children:n?.rating==="thumbsDown"?e.jsx(G,{className:"icon-md-heavy text-token-text-primary",onClick:()=>u(void 0)}):e.jsx(X,{className:"icon-md-heavy text-token-text-secondary",onClick:()=>u("thumbsDown")})})]})]}),n?.rating&&e.jsx("div",{className:"mb-4 flex flex-row",children:(n.rating==="thumbsDown"?te:se).map(r=>e.jsx(J,{className:"mr-2",$selected:n.tags.includes(r),onClick:()=>i({...n,tags:n.tags.includes(r)?n.tags.filter(p=>p!==r):[...n.tags,r]}),children:P(r,d)},r))}),!s&&e.jsx("div",{className:"w-full border-[0.5px] border-token-border-light"})]})}function re({documentId:a,title:s,externalUrl:n,noBottomBorder:i=!1,shouldHaveBeenIncluded:d,setShouldHaveBeenIncluded:l}){const[m,t]=j.useMemo(()=>{const r=s.split(".");return r.length>1?[r.slice(0,-1).join("."),r[r.length-1]]:[s,""]},[s]),c=j.useMemo(()=>U(O.GDRIVE,t),[t]),u=j.useMemo(()=>{if(n)try{return new URL(n).hostname}catch{return}},[n]);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-row items-center justify-between py-2",children:[e.jsxs("div",{className:"max-width-full mr-2 flex grow flex-row items-center overflow-hidden",children:[e.jsx(c,{className:"mr-2 flex-shrink-0 flex-grow-0"}),e.jsx("a",{href:n,className:"text-token-primary flex-grow-1 flex-shrink-1 overflow-hidden text-ellipsis whitespace-nowrap text-sm",target:"_blank",rel:"noreferrer",children:m}),u&&e.jsx("div",{className:"ml-2 text-sm text-token-text-secondary",children:u})]}),e.jsx("div",{className:"flex shrink-0 flex-row items-center px-2",children:e.jsx(L,{checked:d,onChange:r=>l?.(r.currentTarget.checked),id:`should-have-been-included-${a}`})})]}),!i&&e.jsx("div",{className:"w-full border-[0.5px] border-token-border-light"})]})}const oe=/^【(\d+)†([^†】]+)(†[^†】]+)?】$/,le=["File created at","File last modified at"];function ie(a){let s=[];if(!a||typeof a!="object")return null;if(!Object.hasOwn(a,"results"))return null;const n=a.results;if(!Array.isArray(n))return null;const i=n.map(D);for(let l of i){if(l==null)return null;s.push(l)}let d;if(Object.hasOwn(a,"debug_info")){const l=a.debug_info;if(!l||typeof l!="object"||!Object.hasOwn(l,"retrieval_results")||!Array.isArray(l.retrieval_results))return null;const m=l.retrieval_results;d={retrieval_results:[]};for(const t of m){if(!t||typeof t!="object"||typeof t.query!="string"||!Array.isArray(t.results))return null;const c=t.query;let u=t.results.map(D);const r=[];for(const p of u){if(!p)return null;r.push(p)}d.retrieval_results.push({query:c,results:r})}}return{results:s,debug_info:d}}function D(a){const s={};if(!a||typeof a!="object")return null;for(const[n,i]of Object.entries(a))n==="score"&&typeof i=="number"?s.score=i:["document_id","content","title","created_at","updated_at","file_created_at","file_modified_at","document_chunk_id","cloud_doc_url","document_source"].includes(n)&&(i==null||typeof i=="string")&&(s[n]=i??void 0);return s.document_id==null||s.content==null?null:{...s,document_id:s.document_id,content:s.content}}function ce(a){const s=[];let n=null,i="",d=a.split(`
`);d.length>0&&d[d.length-1].startsWith("Visible: ")&&(i=d.pop()??"");for(const l of d){const m=l.trim(),t=m.startsWith("# ")?oe.exec(m.slice(2)):null;if(t&&t.length>=3){const c=parseInt(t[1],10),u=t[2],r=t[3]?.slice(1)||void 0;n&&s.push(n),n={resultNum:c,title:u,documentId:r,contents:"",metadata:{}}}else if(n)if(n.contents)n.contents+=`
${l}`;else{let c=!1;for(const u of le){const r=`${u}: `;if(m.startsWith(r)){n.metadata[u]=m.slice(r.length),c=!0;break}}c||(n.contents=l)}}return n&&s.push(n),{visibilityLine:i,chunks:s}}function de(a){const s=a.content;switch(s.content_type){case b.Text:return s.parts.join();case b.ExecutionOutput:case b.SystemError:case b.Code:case b.SystemMessage:case b.TetherQuote:case b.TetherBrowsingCode:return s.text;case b.TetherBrowsingDisplay:return s.result;case b.UserEditableContext:case b.ModelEditableContext:return null;case b.MultimodalText:return F(s.parts);case b.SystemContent:return s.instructions==null?null:typeof s.instructions=="string"?s.instructions:F(s.instructions)}}function F(a){return a.filter(s=>typeof s=="string").join()}function ue(a,s){const{entireConversation:n,messageId:i}=s;if(!n)throw new Error("The extraction function only supports exporting the entire conversation for now.");let d=i;const l=[];for(;d;){const m=a.getNodeByIdOrMessageId(d);if(!m){d=null;break}const t=m.message;if(!t)continue;const c=de(t)??"",u=Array.isArray(t.metadata?.citations)?t.metadata.citations:[],r=Array.isArray(t.metadata?.attachments)?t.metadata.attachments:[],p={id:String(t.id),author:t.author.role,recipient:t.recipient??"",createTime:t.create_time,updateTime:t.update_time};switch(t.author.role){case S.System:l.push({...p,type:"system",content:t.content,citations:u,attachments:r});break;case S.Assistant:if(t.recipient&&["user","all"].includes(t.recipient)&&c)l.push({...p,type:"visible_text",text:c,citations:u,attachments:r});else if(t.recipient&&t.recipient.includes("file_search")){const v=t.metadata?.command??"";let k=[];try{const y=JSON.parse(c);typeof y=="object"&&y!=null&&Array.isArray(y.queries)&&(k=y.queries.map(w=>String(w)))}catch{}k?l.push({...p,type:"query",command:v,content:t.content,queries:k}):l.push({...p,type:"generic_file_search_tool",command:v,content:t.content})}break;case S.User:(c||r.length>0)&&l.push({...p,type:"visible_text",text:c,citations:u,attachments:r});break;case S.Tool:if(t.author.name?.includes("file_search")&&t.recipient==="all"){const v=t.metadata?.command??"";if(v==="msearch"&&t.content.content_type===b.TetherBrowsingDisplay){const k=t.content.result;if(k){let y=null;const w=t.metadata?.raw_response;if(typeof w=="object"&&w!=null)try{y=ie(w)}catch{}l.push({...p,type:"result",command:v,content:t.content,result:ce(k),searchResponse:y})}}else v==="context_stuff"&&t.content.content_type===b.TetherQuote?l.push({...p,type:"fetch",command:v,content:t.content}):l.push({...p,type:"generic_file_search_tool",command:v,content:t.content})}break}d=m.parentId||null}return s.orderRootToLeaf&&l.reverse(),{messages:l}}const me="considered-source-should-have-been-used";function pe({citations:a,rating:s,onSubmit:n,onCancel:i,messageId:d,conversationId:l,nodeId:m,conversationTree:t}){const c=R(),u=H(),[r,p]=j.useState(""),[v,k]=j.useState(()=>{const o={};for(const f of a)f.metadata?.type==="file"&&(o[f.metadata.id]={rating:void 0,tags:[],url:f.metadata.extra?.cloud_doc_url});return o}),y=j.useMemo(()=>{const o=new Set,f=[];for(const h of a)!h.metadata||h.metadata.type!=="file"||o.has(h.metadata.id)||(f.push(h.metadata),o.add(h.metadata.id));return f},[a]),[w,I]=j.useState(!0),N=j.useMemo(()=>{const o={hasQuery:!1,lastAssistantMessage:null,lastUserMessage:null,referencedSyncedFiles:[]};if(!t||!m||!t.containsNodeOrMessageId(m))return o;const f=ue(t,{messageId:m,entireConversation:!0});for(const h of f.messages)switch(h.type){case"fetch":case"generic_file_search_tool":case"system":continue;case"result":{h.result.chunks.forEach(g=>{g.documentId&&g.documentId.startsWith("S")&&!o.referencedSyncedFiles.some(_=>_.fileId===g.documentId)&&!y.some(_=>_.type==="file"&&_.id===g.documentId)&&o.referencedSyncedFiles.push({fileId:g.documentId,title:g.title})});continue}case"query":{o.hasQuery=!0;continue}case"visible_text":{if(h.author===S.User){if(!o.lastUserMessage){const g=t.getConversationTurns(h.id),_=g[g.length-1].messages,C=_[_.length-1];o.lastUserMessage=C}}else if(h.author===S.Assistant&&!o.lastAssistantMessage){const g=t.getConversationTurns(h.id),_=g[g.length-1].messages,C=_[_.length-1];o.lastAssistantMessage=C,o.lastUserMessage=null}continue}}return o},[t,y,m]),q=j.useCallback(async o=>{const f={...o,additionalSources:r,sourcesFeedback:v,consentedToShareConvoLink:w};Q.submitCaMessageFeedback({feedback_format:K.ALPHA,message_id:d,conversation_id:l,text:f.textFeedback,rating:s,tags:f.tags,tag_choices:f.tagChoices,additional_sources:f.additionalSources,sources_feedback:f.sourcesFeedback,consented_to_share_convo_link:f.consentedToShareConvoLink}),u.success("Thanks for providing feedback!"),n?.(f)},[r,v,w,d,l,s,u,n]);return e.jsxs(Y,{multiple:!0,allowEmptySubmit:!0,onSubmit:q,onCancel:i,tagOptions:E(s==="thumbsDown"?Z:ee,c),modalOnly:!0,modalTitle:e.jsxs("div",{className:"flex items-center gap-2",children:[s==="thumbsDown"?e.jsx(G,{className:"mb-[-6px]"}):e.jsx(B,{className:"mb-[-6px]"}),e.jsx(M,{id:"h5nasL",defaultMessage:"Provide feedback"})]}),children:[y.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"mt-6 text-base font-semibold",children:e.jsx(M,{id:"G6+7UX",defaultMessage:"Sources"})}),e.jsx("div",{children:y.map((o,f)=>o?.type!=="file"?null:e.jsx(ae,{citationMetadata:o,noBottomBorder:f===y.length-1,sourceFeedback:v[o.id],setSourceFeedback:h=>k(g=>({...g,[o.id]:{...h,url:o.extra?.cloud_doc_url}}))},o.id))})]}),N.referencedSyncedFiles.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-6 flex items-baseline justify-between",children:[e.jsxs("div",{className:"flex-start flex",children:[e.jsx("h3",{className:"text-base font-semibold",children:e.jsx(M,{id:"xvBe/T",defaultMessage:"Considered Sources"})}),e.jsx("p",{className:"ml-2 text-token-text-secondary",children:e.jsx(M,{id:"nX81fN",defaultMessage:"({numSources} sources)",values:{numSources:N.referencedSyncedFiles.length}})})]}),e.jsx("p",{className:"text-sm text-token-text-tertiary",children:e.jsx(M,{id:"0+Uivl",defaultMessage:"Good Source?"})})]}),e.jsx("div",{className:"mt-2 max-h-[200px] overflow-auto",children:N.referencedSyncedFiles.map((o,f)=>{const h=o.fileId.split("--")[1];if(!h)return null;const g=`https://drive.google.com/file/d/${h}`;return e.jsx(re,{title:o.title,documentId:o.fileId,externalUrl:g,noBottomBorder:f===N.referencedSyncedFiles.length-1,shouldHaveBeenIncluded:!!v[o.fileId],setShouldHaveBeenIncluded:_=>k(C=>{const A={...Object.fromEntries(Object.entries(C).filter(([V])=>V!==o.fileId))};return _&&(A[o.fileId]={tags:[me],rating:"thumbsUp",url:g}),A})},o.fileId)})})]}),e.jsxs("div",{className:"mt-6",children:[e.jsx("p",{className:"text-sm text-token-text-primary",children:e.jsx(M,{id:"1ApJVo",defaultMessage:"Add any additional sources"})}),e.jsx($,{name:"feedback",className:"mt-2",placeholder:c.formatMessage({id:"CAFeedbackModal.additionalSourcePlaceholder",defaultMessage:"(Optional) Additional sources"}),value:r,onChange:o=>p(o.target.value)})]}),e.jsxs("div",{className:"mt-6",children:[e.jsx("h3",{className:"mb-2 text-base font-semibold",children:e.jsx(M,{id:"9NcQBu",defaultMessage:"Latest Exchange"})}),e.jsx("div",{className:"p-2",children:e.jsxs("div",{className:"mb-4",children:[N.lastUserMessage&&e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"mb-1 pl-4 text-xs text-token-text-secondary",children:e.jsx(M,{id:"QTWrtR",defaultMessage:"Your message"})}),e.jsx("div",{className:"flex justify-start",children:e.jsx("p",{className:"relative max-w-[70%] rounded-3xl bg-[#f4f4f4] px-5 py-2.5 dark:bg-token-main-surface-secondary",children:N.lastUserMessage?e.jsx(T,{message:N.lastUserMessage,isCompletionInProgress:!1,clientThreadId:l,isUserTurn:!1,turnIndex:0,isFeedbackEnabled:!1,showEditButton:!1,onEnterEdit:()=>null,onRequestMoreCompletions:()=>null}):null})})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("p",{className:"mb-1 pl-4 text-xs text-token-text-secondary",children:e.jsx(M,{id:"ZCTm4h",defaultMessage:"ChatGPT's response"})}),e.jsx("div",{className:"relative rounded-lg bg-token-main-surface-secondary p-4 text-sm",children:N.lastAssistantMessage?e.jsx(T,{message:N.lastAssistantMessage,isCompletionInProgress:!1,clientThreadId:l,isUserTurn:!1,turnIndex:1,isFeedbackEnabled:!1,showEditButton:!1,onEnterEdit:()=>null,onRequestMoreCompletions:()=>null}):null})]})]})}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h3",{className:"mt-6 text-base font-semibold",children:e.jsx(M,{id:"c95uEW",defaultMessage:"Full conversation"})}),e.jsx("p",{className:"mb-2 mt-1 text-sm text-token-text-secondary",children:e.jsx(M,{id:"3E3ZSm",defaultMessage:"If previous portions of this conversation are important to understand your feedback, we encourage you to include it."})}),e.jsx(L,{id:"consented-to-share-entire-convo",label:c.formatMessage({id:"5CC8r8",defaultMessage:"Share Entire Conversation"}),checked:w,onChange:o=>{I(o.currentTarget.checked)}})]})]})]})}export{pe as C,me as a,P as g};
//# sourceMappingURL=cfalnb5p79bv47a6.js.map
