(function(){"use strict";function E(e,t,n,r){function i(s){return s instanceof n?s:new n(function(o){o(s)})}return new(n||(n=Promise))(function(s,o){function c(h){try{g(r.next(h))}catch(m){o(m)}}function f(h){try{g(r.throw(h))}catch(m){o(m)}}function g(h){h.done?s(h.value):i(h.value).then(c,f)}g((r=r.apply(e,t||[])).next())})}typeof SuppressedError=="function"&&SuppressedError;var ke=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Z={exports:{}};(function(e){(function(t,n){e.exports?e.exports=n():t.log=n()})(ke,function(){var t=function(){},n="undefined",r=typeof window!==n&&typeof window.navigator!==n&&/Trident\/|MSIE /.test(window.navigator.userAgent),i=["trace","debug","info","warn","error"],s={},o=null;function c(l,w){var a=l[w];if(typeof a.bind=="function")return a.bind(l);try{return Function.prototype.bind.call(a,l)}catch{return function(){return Function.prototype.apply.apply(a,[l,arguments])}}}function f(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function g(l){return l==="debug"&&(l="log"),typeof console===n?!1:l==="trace"&&r?f:console[l]!==void 0?c(console,l):console.log!==void 0?c(console,"log"):t}function h(){for(var l=this.getLevel(),w=0;w<i.length;w++){var a=i[w];this[a]=w<l?t:this.methodFactory(a,l,this.name)}if(this.log=this.debug,typeof console===n&&l<this.levels.SILENT)return"No console available for logging"}function m(l){return function(){typeof console!==n&&(h.call(this),this[l].apply(this,arguments))}}function p(l,w,a){return g(l)||m.apply(this,arguments)}function v(l,w){var a=this,K,x,k,S="loglevel";typeof l=="string"?S+=":"+l:typeof l=="symbol"&&(S=void 0);function rt(y){var b=(i[y]||"silent").toUpperCase();if(!(typeof window===n||!S)){try{window.localStorage[S]=b;return}catch{}try{window.document.cookie=encodeURIComponent(S)+"="+b+";"}catch{}}}function Se(){var y;if(!(typeof window===n||!S)){try{y=window.localStorage[S]}catch{}if(typeof y===n)try{var b=window.document.cookie,q=encodeURIComponent(S),Ie=b.indexOf(q+"=");Ie!==-1&&(y=/^([^;]+)/.exec(b.slice(Ie+q.length+1))[1])}catch{}return a.levels[y]===void 0&&(y=void 0),y}}function it(){if(!(typeof window===n||!S)){try{window.localStorage.removeItem(S)}catch{}try{window.document.cookie=encodeURIComponent(S)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function M(y){var b=y;if(typeof b=="string"&&a.levels[b.toUpperCase()]!==void 0&&(b=a.levels[b.toUpperCase()]),typeof b=="number"&&b>=0&&b<=a.levels.SILENT)return b;throw new TypeError("log.setLevel() called with invalid level: "+y)}a.name=l,a.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},a.methodFactory=w||p,a.getLevel=function(){return k??x??K},a.setLevel=function(y,b){return k=M(y),b!==!1&&rt(k),h.call(a)},a.setDefaultLevel=function(y){x=M(y),Se()||a.setLevel(y,!1)},a.resetLevel=function(){k=null,it(),h.call(a)},a.enableAll=function(y){a.setLevel(a.levels.TRACE,y)},a.disableAll=function(y){a.setLevel(a.levels.SILENT,y)},a.rebuild=function(){if(o!==a&&(K=M(o.getLevel())),h.call(a),o===a)for(var y in s)s[y].rebuild()},K=M(o?o.getLevel():"WARN");var Ee=Se();Ee!=null&&(k=M(Ee)),h.call(a)}o=new v,o.getLogger=function(w){if(typeof w!="symbol"&&typeof w!="string"||w==="")throw new TypeError("You must supply a name when creating a logger.");var a=s[w];return a||(a=s[w]=new v(w,o.methodFactory)),a};var C=typeof window!==n?window.log:void 0;return o.noConflict=function(){return typeof window!==n&&window.log===o&&(window.log=C),o},o.getLoggers=function(){return s},o.default=o,o})})(Z);var N=Z.exports,G;(function(e){e[e.trace=0]="trace",e[e.debug=1]="debug",e[e.info=2]="info",e[e.warn=3]="warn",e[e.error=4]="error",e[e.silent=5]="silent"})(G||(G={}));var W;(function(e){e.Default="livekit",e.Room="livekit-room",e.Participant="livekit-participant",e.Track="livekit-track",e.Publication="livekit-track-publication",e.Engine="livekit-engine",e.Signal="livekit-signal",e.PCManager="livekit-pc-manager",e.PCTransport="livekit-pc-transport",e.E2EE="lk-e2ee"})(W||(W={}));let Ce=N.getLogger("livekit");Object.values(W).map(e=>N.getLogger(e)),Ce.setDefaultLevel(G.info);const u=N.getLogger("lk-e2ee"),D="AES-GCM",_e=10,X={key:10,delta:3,audio:1,empty:0},J=12,Le={sharedKey:!1,ratchetSalt:"LKFrameEncryptionKey",ratchetWindowSize:8,failureTolerance:_e,keyringSize:16},Ke=100,$=2e3;class Re extends Error{constructor(t,n){super(n||"an error has occured"),this.code=t}}var F;(function(e){e.PermissionDenied="PermissionDenied",e.NotFound="NotFound",e.DeviceInUse="DeviceInUse",e.Other="Other"})(F||(F={})),function(e){function t(n){if(n&&"name"in n)return n.name==="NotFoundError"||n.name==="DevicesNotFoundError"?e.NotFound:n.name==="NotAllowedError"||n.name==="PermissionDeniedError"?e.PermissionDenied:n.name==="NotReadableError"||n.name==="TrackStartError"?e.DeviceInUse:e.Other}e.getFailure=t}(F||(F={}));var I;(function(e){e[e.InvalidKey=0]="InvalidKey",e[e.MissingKey=1]="MissingKey",e[e.InternalError=2]="InternalError"})(I||(I={}));class _ extends Re{constructor(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:I.InternalError;super(40,t),this.reason=n}}var ee;(function(e){e.SetKey="setKey",e.RatchetRequest="ratchetRequest",e.KeyRatcheted="keyRatcheted"})(ee||(ee={}));var O;(function(e){e.KeyRatcheted="keyRatcheted"})(O||(O={}));var te;(function(e){e.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",e.EncryptionError="encryptionError"})(te||(te={}));var L;(function(e){e.Error="cryptorError"})(L||(L={}));var z={exports:{}},R=typeof Reflect=="object"?Reflect:null,ne=R&&typeof R.apply=="function"?R.apply:function(t,n,r){return Function.prototype.apply.call(t,n,r)},U;R&&typeof R.ownKeys=="function"?U=R.ownKeys:Object.getOwnPropertySymbols?U=function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:U=function(t){return Object.getOwnPropertyNames(t)};function Pe(e){console&&console.warn&&console.warn(e)}var re=Number.isNaN||function(t){return t!==t};function d(){d.init.call(this)}z.exports=d,z.exports.once=Ae,d.EventEmitter=d,d.prototype._events=void 0,d.prototype._eventsCount=0,d.prototype._maxListeners=void 0;var ie=10;function B(e){if(typeof e!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}Object.defineProperty(d,"defaultMaxListeners",{enumerable:!0,get:function(){return ie},set:function(e){if(typeof e!="number"||e<0||re(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");ie=e}}),d.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},d.prototype.setMaxListeners=function(t){if(typeof t!="number"||t<0||re(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this};function se(e){return e._maxListeners===void 0?d.defaultMaxListeners:e._maxListeners}d.prototype.getMaxListeners=function(){return se(this)},d.prototype.emit=function(t){for(var n=[],r=1;r<arguments.length;r++)n.push(arguments[r]);var i=t==="error",s=this._events;if(s!==void 0)i=i&&s.error===void 0;else if(!i)return!1;if(i){var o;if(n.length>0&&(o=n[0]),o instanceof Error)throw o;var c=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw c.context=o,c}var f=s[t];if(f===void 0)return!1;if(typeof f=="function")ne(f,this,n);else for(var g=f.length,h=fe(f,g),r=0;r<g;++r)ne(h[r],this,n);return!0};function oe(e,t,n,r){var i,s,o;if(B(n),s=e._events,s===void 0?(s=e._events=Object.create(null),e._eventsCount=0):(s.newListener!==void 0&&(e.emit("newListener",t,n.listener?n.listener:n),s=e._events),o=s[t]),o===void 0)o=s[t]=n,++e._eventsCount;else if(typeof o=="function"?o=s[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),i=se(e),i>0&&o.length>i&&!o.warned){o.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=o.length,Pe(c)}return e}d.prototype.addListener=function(t,n){return oe(this,t,n,!1)},d.prototype.on=d.prototype.addListener,d.prototype.prependListener=function(t,n){return oe(this,t,n,!0)};function xe(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function ae(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=xe.bind(r);return i.listener=n,r.wrapFn=i,i}d.prototype.once=function(t,n){return B(n),this.on(t,ae(this,t,n)),this},d.prototype.prependOnceListener=function(t,n){return B(n),this.prependListener(t,ae(this,t,n)),this},d.prototype.removeListener=function(t,n){var r,i,s,o,c;if(B(n),i=this._events,i===void 0)return this;if(r=i[t],r===void 0)return this;if(r===n||r.listener===n)--this._eventsCount===0?this._events=Object.create(null):(delete i[t],i.removeListener&&this.emit("removeListener",t,r.listener||n));else if(typeof r!="function"){for(s=-1,o=r.length-1;o>=0;o--)if(r[o]===n||r[o].listener===n){c=r[o].listener,s=o;break}if(s<0)return this;s===0?r.shift():Oe(r,s),r.length===1&&(i[t]=r[0]),i.removeListener!==void 0&&this.emit("removeListener",t,c||n)}return this},d.prototype.off=d.prototype.removeListener,d.prototype.removeAllListeners=function(t){var n,r,i;if(r=this._events,r===void 0)return this;if(r.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):r[t]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete r[t]),this;if(arguments.length===0){var s=Object.keys(r),o;for(i=0;i<s.length;++i)o=s[i],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(n=r[t],typeof n=="function")this.removeListener(t,n);else if(n!==void 0)for(i=n.length-1;i>=0;i--)this.removeListener(t,n[i]);return this};function ce(e,t,n){var r=e._events;if(r===void 0)return[];var i=r[t];return i===void 0?[]:typeof i=="function"?n?[i.listener||i]:[i]:n?Te(i):fe(i,i.length)}d.prototype.listeners=function(t){return ce(this,t,!0)},d.prototype.rawListeners=function(t){return ce(this,t,!1)},d.listenerCount=function(e,t){return typeof e.listenerCount=="function"?e.listenerCount(t):ue.call(e,t)},d.prototype.listenerCount=ue;function ue(e){var t=this._events;if(t!==void 0){var n=t[e];if(typeof n=="function")return 1;if(n!==void 0)return n.length}return 0}d.prototype.eventNames=function(){return this._eventsCount>0?U(this._events):[]};function fe(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function Oe(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function Te(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}function Ae(e,t){return new Promise(function(n,r){function i(o){e.removeListener(t,s),r(o)}function s(){typeof e.removeListener=="function"&&e.removeListener("error",i),n([].slice.call(arguments))}le(e,t,s,{once:!0}),t!=="error"&&Me(e,i,{once:!0})})}function Me(e,t,n){typeof e.on=="function"&&le(e,"error",t,n)}function le(e,t,n,r){if(typeof e.on=="function")r.once?e.once(t,n):e.on(t,n);else if(typeof e.addEventListener=="function")e.addEventListener(t,function i(s){r.once&&e.removeEventListener(t,i),n(s)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e)}var de=z.exports;function De(e){return"type"in e}function Fe(e){return E(this,arguments,void 0,function(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{name:D},r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"encrypt";return function*(){return crypto.subtle.importKey("raw",t,n,!1,r==="derive"?["deriveBits","deriveKey"]:["encrypt","decrypt"])}()})}function he(e,t){const r=new TextEncoder().encode(t);switch(e){case"HKDF":return{name:"HKDF",salt:r,hash:"SHA-256",info:new ArrayBuffer(128)};case"PBKDF2":return{name:"PBKDF2",salt:r,hash:"SHA-256",iterations:1e5};default:throw new Error("algorithm ".concat(e," is currently unsupported"))}}function ye(e,t){return E(this,void 0,void 0,function*(){const n=he(e.algorithm.name,t),r=yield crypto.subtle.deriveKey(n,e,{name:D,length:128},!1,["encrypt","decrypt"]);return{material:e,encryptionKey:r}})}function Ue(e,t){return E(this,void 0,void 0,function*(){const n=he(e.algorithm.name,t);return crypto.subtle.deriveBits(n,e,256)})}function Be(e){for(var t=0;t<e.length-3;t++)if(e[t]==0&&e[t+1]==0&&e[t+2]==3)return!0;return!1}function je(e){const t=[];for(var n=e.length,r=0;r<e.length;)n-r>=3&&!e[r]&&!e[r+1]&&e[r+2]==3?(t.push(e[r++]),t.push(e[r++]),r++):t.push(e[r++]);return new Uint8Array(t)}const He=2,pe=3;function Ve(e){const t=[];for(var n=0,r=0;r<e.length;++r){var i=e[r];i<=pe&&n>=He&&(t.push(pe),n=0),t.push(i),i==0?++n:n=0}return new Uint8Array(t)}class qe{constructor(){this.consecutiveSifCount=0,this.lastSifReceivedAt=0,this.userFramesSinceSif=0}recordSif(){var t;this.consecutiveSifCount+=1,(t=this.sifSequenceStartedAt)!==null&&t!==void 0||(this.sifSequenceStartedAt=Date.now()),this.lastSifReceivedAt=Date.now()}recordUserFrame(){this.sifSequenceStartedAt!==void 0&&(this.userFramesSinceSif+=1,(this.userFramesSinceSif>this.consecutiveSifCount||Date.now()-this.lastSifReceivedAt>$)&&this.reset())}isSifAllowed(){return this.consecutiveSifCount<Ke&&(this.sifSequenceStartedAt===void 0||Date.now()-this.sifSequenceStartedAt<$)}reset(){this.userFramesSinceSif=0,this.consecutiveSifCount=0,this.sifSequenceStartedAt=void 0}}const ge=new Map;class Ne extends de.EventEmitter{encodeFunction(t,n){throw Error("not implemented for subclass")}decodeFunction(t,n){throw Error("not implemented for subclass")}}class Ge extends Ne{constructor(t){var n;super(),this.sendCounts=new Map,this.keys=t.keys,this.participantIdentity=t.participantIdentity,this.rtpMap=new Map,this.keyProviderOptions=t.keyProviderOptions,this.sifTrailer=(n=t.sifTrailer)!==null&&n!==void 0?n:Uint8Array.from([]),this.sifGuard=new qe}get logContext(){return{participant:this.participantIdentity,mediaTrackId:this.trackId,fallbackCodec:this.videoCodec}}setParticipant(t,n){u.debug("setting new participant on cryptor",Object.assign(Object.assign({},this.logContext),{participant:t})),this.participantIdentity&&u.error("cryptor has already a participant set, participant should have been unset before",Object.assign({},this.logContext)),this.participantIdentity=t,this.keys=n,this.sifGuard.reset()}unsetParticipant(){u.debug("unsetting participant",this.logContext),this.participantIdentity=void 0}isEnabled(){if(this.participantIdentity)return ge.get(this.participantIdentity)}getParticipantIdentity(){return this.participantIdentity}getTrackId(){return this.trackId}setVideoCodec(t){this.videoCodec=t}setRtpMap(t){this.rtpMap=t}setupTransform(t,n,r,i,s){s&&(u.info("setting codec on cryptor to",{codec:s}),this.videoCodec=s),u.debug("Setting up frame cryptor transform",Object.assign({operation:t,passedTrackId:i,codec:s},this.logContext));const o=t==="encode"?this.encodeFunction:this.decodeFunction,c=new TransformStream({transform:o.bind(this)});n.pipeThrough(c).pipeTo(r).catch(f=>{u.warn(f),this.emit(L.Error,f instanceof _?f:new _(f.message))}),this.trackId=i}setSifTrailer(t){u.debug("setting SIF trailer",Object.assign(Object.assign({},this.logContext),{trailer:t})),this.sifTrailer=t}encodeFunction(t,n){return E(this,void 0,void 0,function*(){var r;if(!this.isEnabled()||t.data.byteLength===0)return n.enqueue(t);const i=this.keys.getKeySet();if(!i)throw new TypeError("key set not found for ".concat(this.participantIdentity," at index ").concat(this.keys.getCurrentKeyIndex()));const{encryptionKey:s}=i,o=this.keys.getCurrentKeyIndex();if(s){const f=this.makeIV((r=t.getMetadata().synchronizationSource)!==null&&r!==void 0?r:-1,t.timestamp);let g=this.getUnencryptedBytes(t);const h=new Uint8Array(t.data,0,g.unencryptedBytes),m=new Uint8Array(2);m[0]=J,m[1]=o;try{const p=yield crypto.subtle.encrypt({name:D,iv:f,additionalData:new Uint8Array(t.data,0,h.byteLength)},s,new Uint8Array(t.data,g.unencryptedBytes));let v=new Uint8Array(p.byteLength+f.byteLength+m.byteLength);v.set(new Uint8Array(p)),v.set(new Uint8Array(f),p.byteLength),v.set(m,p.byteLength+f.byteLength),g.isH264&&(v=Ve(v));var c=new Uint8Array(h.byteLength+v.byteLength);return c.set(h),c.set(v,h.byteLength),t.data=c.buffer,n.enqueue(t)}catch(p){u.error(p)}}else u.debug("failed to decrypt, emitting error",this.logContext),this.emit(L.Error,new _("encryption key missing for encoding",I.MissingKey))})}decodeFunction(t,n){return E(this,void 0,void 0,function*(){if(!this.isEnabled()||t.data.byteLength===0)return u.debug("skipping empty frame",this.logContext),this.sifGuard.recordUserFrame(),n.enqueue(t);if(ze(t.data,this.sifTrailer)){if(u.debug("enqueue SIF",this.logContext),this.sifGuard.recordSif(),this.sifGuard.isSifAllowed())return t.data=t.data.slice(0,t.data.byteLength-this.sifTrailer.byteLength),n.enqueue(t);u.warn("SIF limit reached, dropping frame");return}else this.sifGuard.recordUserFrame();const i=new Uint8Array(t.data)[t.data.byteLength-1];if(this.keys.getKeySet(i)&&this.keys.hasValidKey)try{const s=yield this.decryptFrame(t,i);if(this.keys.decryptionSuccess(),s)return n.enqueue(s)}catch(s){s instanceof _&&s.reason===I.InvalidKey?this.keys.hasValidKey&&(this.emit(L.Error,s),this.keys.decryptionFailure()):u.warn("decoding frame failed",{error:s})}else!this.keys.getKeySet(i)&&this.keys.hasValidKey&&(u.warn("skipping decryption due to missing key at index ".concat(i)),this.emit(L.Error,new _("missing key at index ".concat(i," for participant ").concat(this.participantIdentity),I.MissingKey)))})}decryptFrame(t,n){return E(this,arguments,void 0,function(r,i){var s=this;let o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:void 0,c=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{ratchetCount:0};return function*(){var f;const g=s.keys.getKeySet(i);if(!c.encryptionKey&&!g)throw new TypeError("no encryption key found for decryption of ".concat(s.participantIdentity));let h=s.getUnencryptedBytes(r);try{const p=new Uint8Array(r.data,0,h.unencryptedBytes);var m=new Uint8Array(r.data,p.length,r.data.byteLength-p.length);if(h.isH264&&Be(m)){m=je(m);const S=new Uint8Array(p.byteLength+m.byteLength);S.set(p),S.set(m,p.byteLength),r.data=S.buffer}const v=new Uint8Array(r.data,r.data.byteLength-2,2),C=v[0],l=new Uint8Array(r.data,r.data.byteLength-C-v.byteLength,C),w=p.byteLength,a=r.data.byteLength-(p.byteLength+C+v.byteLength),K=yield crypto.subtle.decrypt({name:D,iv:l,additionalData:new Uint8Array(r.data,0,p.byteLength)},(f=c.encryptionKey)!==null&&f!==void 0?f:g.encryptionKey,new Uint8Array(r.data,w,a)),x=new ArrayBuffer(p.byteLength+K.byteLength),k=new Uint8Array(x);return k.set(new Uint8Array(r.data,0,p.byteLength)),k.set(new Uint8Array(K),p.byteLength),r.data=x,r}catch(p){if(s.keyProviderOptions.ratchetWindowSize>0)if(c.ratchetCount<s.keyProviderOptions.ratchetWindowSize){u.debug("ratcheting key attempt ".concat(c.ratchetCount," of ").concat(s.keyProviderOptions.ratchetWindowSize,", for kind ").concat(r instanceof RTCEncodedAudioFrame?"audio":"video"));let v;if((o??g)===s.keys.getKeySet(i)){const l=yield s.keys.ratchetKey(i,!1);v=yield ye(l,s.keyProviderOptions.ratchetSalt)}const C=yield s.decryptFrame(r,i,o||g,{ratchetCount:c.ratchetCount+1,encryptionKey:v?.encryptionKey});return C&&v&&(o??g)===s.keys.getKeySet(i)&&(s.keys.setKeySet(v,i,!0),s.keys.setCurrentKeyIndex(i)),C}else throw u.warn("maximum ratchet attempts exceeded"),new _("valid key missing for participant ".concat(s.participantIdentity),I.InvalidKey);else throw new _("Decryption failed: ".concat(p.message),I.InvalidKey)}}()})}makeIV(t,n){var r;const i=new ArrayBuffer(J),s=new DataView(i);this.sendCounts.has(t)||this.sendCounts.set(t,Math.floor(Math.random()*65535));const o=(r=this.sendCounts.get(t))!==null&&r!==void 0?r:0;return s.setUint32(0,t),s.setUint32(4,n),s.setUint32(8,n-o%65535),this.sendCounts.set(t,o+1),i}getUnencryptedBytes(t){var n,r={unencryptedBytes:0,isH264:!1};if(De(t)){let i=(n=this.getVideoCodec(t))!==null&&n!==void 0?n:this.videoCodec;if(i!==this.detectedCodec&&(u.debug("detected different codec",Object.assign({detectedCodec:i,oldCodec:this.detectedCodec},this.logContext)),this.detectedCodec=i),i==="av1"||i==="vp9")throw new Error("".concat(i," is not yet supported for end to end encryption"));if(i==="vp8")return r.unencryptedBytes=X[t.type],r;const s=new Uint8Array(t.data);try{const o=We(s);if(r.isH264=i==="h264"||o.some(c=>[P.SLICE_IDR,P.SLICE_NON_IDR].includes(ve(s[c]))),r.isH264){for(const c of o)switch(ve(s[c])){case P.SLICE_IDR:case P.SLICE_NON_IDR:return r.unencryptedBytes=c+2,r;default:break}throw new TypeError("Could not find NALU")}}catch{}return r.unencryptedBytes=X[t.type],r}else return r.unencryptedBytes=X.audio,r}getVideoCodec(t){if(this.rtpMap.size===0)return;const n=t.getMetadata().payloadType;return n?this.rtpMap.get(n):void 0}}function We(e){const t=[];let n=0,r=0,i=e.length-2;for(;r<i;){for(;r<i&&!(e[r]===0&&e[r+1]===0&&e[r+2]===1);)r++;r>=i&&(r=e.length);let s=r;for(;s>n&&e[s-1]===0;)s--;if(n===0){if(s!==n)throw TypeError("byte stream contains leading data")}else t.push(n);n=r=r+3}return t}function ve(e){return e&Xe}const Xe=31;var P;(function(e){e[e.SLICE_NON_IDR=1]="SLICE_NON_IDR",e[e.SLICE_PARTITION_A=2]="SLICE_PARTITION_A",e[e.SLICE_PARTITION_B=3]="SLICE_PARTITION_B",e[e.SLICE_PARTITION_C=4]="SLICE_PARTITION_C",e[e.SLICE_IDR=5]="SLICE_IDR",e[e.SEI=6]="SEI",e[e.SPS=7]="SPS",e[e.PPS=8]="PPS",e[e.AUD=9]="AUD",e[e.END_SEQ=10]="END_SEQ",e[e.END_STREAM=11]="END_STREAM",e[e.FILLER_DATA=12]="FILLER_DATA",e[e.SPS_EXT=13]="SPS_EXT",e[e.PREFIX_NALU=14]="PREFIX_NALU",e[e.SUBSET_SPS=15]="SUBSET_SPS",e[e.DPS=16]="DPS",e[e.SLICE_AUX=19]="SLICE_AUX",e[e.SLICE_EXT=20]="SLICE_EXT",e[e.SLICE_LAYER_EXT=21]="SLICE_LAYER_EXT"})(P||(P={}));function ze(e,t){if(t.byteLength===0)return!1;const n=new Uint8Array(e.slice(e.byteLength-t.byteLength));return t.every((r,i)=>r===n[i])}class we extends de.EventEmitter{get hasValidKey(){return this._hasValidKey}constructor(t,n){if(super(),this.decryptionFailureCount=0,this._hasValidKey=!0,this.currentKeyIndex=0,n.keyringSize<1||n.keyringSize>255)throw new TypeError("Keyring size needs to be between 1 and 256");this.cryptoKeyRing=new Array(n.keyringSize).fill(void 0),this.keyProviderOptions=n,this.ratchetPromiseMap=new Map,this.participantIdentity=t,this.resetKeyStatus()}decryptionFailure(){this.keyProviderOptions.failureTolerance<0||(this.decryptionFailureCount+=1,this.decryptionFailureCount>this.keyProviderOptions.failureTolerance&&(u.warn("key for ".concat(this.participantIdentity," is being marked as invalid")),this._hasValidKey=!1))}decryptionSuccess(){this.resetKeyStatus()}resetKeyStatus(){this.decryptionFailureCount=0,this._hasValidKey=!0}ratchetKey(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;const r=t??this.getCurrentKeyIndex(),i=this.ratchetPromiseMap.get(r);if(typeof i<"u")return i;const s=new Promise((o,c)=>E(this,void 0,void 0,function*(){try{const f=this.getKeySet(r);if(!f)throw new TypeError("Cannot ratchet key without a valid keyset of participant ".concat(this.participantIdentity));const g=f.material,h=yield Fe(yield Ue(g,this.keyProviderOptions.ratchetSalt),g.algorithm.name,"derive");n&&(this.setKeyFromMaterial(h,r,!0),this.emit(O.KeyRatcheted,h,this.participantIdentity,r)),o(h)}catch(f){c(f)}finally{this.ratchetPromiseMap.delete(r)}}));return this.ratchetPromiseMap.set(r,s),s}setKey(t){return E(this,arguments,void 0,function(n){var r=this;let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return function*(){yield r.setKeyFromMaterial(n,i),r.resetKeyStatus()}()})}setKeyFromMaterial(t,n){return E(this,arguments,void 0,function(r,i){var s=this;let o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return function*(){const c=yield ye(r,s.keyProviderOptions.ratchetSalt),f=i>=0?i%s.cryptoKeyRing.length:s.currentKeyIndex;u.debug("setting new key with index ".concat(i),{usage:r.usages,algorithm:r.algorithm,ratchetSalt:s.keyProviderOptions.ratchetSalt}),s.setKeySet(c,f,o),f>=0&&(s.currentKeyIndex=f)}()})}setKeySet(t,n){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;this.cryptoKeyRing[n%this.cryptoKeyRing.length]=t,r&&this.emit(O.KeyRatcheted,t.material,this.participantIdentity,n)}setCurrentKeyIndex(t){return E(this,void 0,void 0,function*(){this.currentKeyIndex=t%this.cryptoKeyRing.length,this.resetKeyStatus()})}getCurrentKeyIndex(){return this.currentKeyIndex}getKeySet(t){return this.cryptoKeyRing[t??this.currentKeyIndex]}}const T=[],me=new Map;let Y,Ye=!1,j=!1,be,A=Le;u.setDefaultLevel("info"),onmessage=e=>{const{kind:t,data:n}=e.data;switch(t){case"init":u.setLevel(n.loglevel),u.info("worker initialized"),A=n.keyProviderOptions,j=!!n.keyProviderOptions.sharedKey,postMessage({kind:"initAck",data:{enabled:Ye}});break;case"enable":Je(n.enabled,n.participantIdentity),u.info("updated e2ee enabled status for ".concat(n.participantIdentity," to ").concat(n.enabled)),postMessage(e.data);break;case"decode":H(n.participantIdentity,n.trackId).setupTransform(t,n.readableStream,n.writableStream,n.trackId,n.codec);break;case"encode":H(n.participantIdentity,n.trackId).setupTransform(t,n.readableStream,n.writableStream,n.trackId,n.codec);break;case"setKey":j?$e(n.key,n.keyIndex):n.participantIdentity?(u.info("set participant sender key ".concat(n.participantIdentity," index ").concat(n.keyIndex)),V(n.participantIdentity).setKey(n.key,n.keyIndex)):u.error("no participant Id was provided and shared key usage is disabled");break;case"removeTransform":Ze(n.trackId,n.participantIdentity);break;case"updateCodec":H(n.participantIdentity,n.trackId).setVideoCodec(n.codec);break;case"setRTPMap":T.forEach(o=>{o.getParticipantIdentity()===n.participantIdentity&&o.setRtpMap(n.map)});break;case"ratchetRequest":Qe(n);break;case"setSifTrailer":nt(n.trailer);break}};function Qe(e){return E(this,void 0,void 0,function*(){if(j){const t=Q();yield t.ratchetKey(e.keyIndex),t.resetKeyStatus()}else if(e.participantIdentity){const t=V(e.participantIdentity);yield t.ratchetKey(e.keyIndex),t.resetKeyStatus()}else u.error("no participant Id was provided for ratchet request and shared key usage is disabled")})}function H(e,t){let n=T.filter(i=>i.getTrackId()===t);if(n.length>1){const i=n.map(s=>({participant:s.getParticipantIdentity()})).join(",");u.error("Found multiple cryptors for the same trackID ".concat(t,". target participant: ").concat(e," "),{participants:i})}let r=n[0];if(r)e!==r.getParticipantIdentity()&&r.setParticipant(e,V(e));else{if(u.info("creating new cryptor for",{participantIdentity:e}),!A)throw Error("Missing keyProvider options");r=new Ge({participantIdentity:e,keys:V(e),keyProviderOptions:A,sifTrailer:be}),et(r),T.push(r)}return r}function V(e){if(j)return Q();let t=me.get(e);return t||(t=new we(e,A),t.on(O.KeyRatcheted,tt),me.set(e,t)),t}function Q(){return Y||(u.debug("creating new shared key handler"),Y=new we("shared-key",A)),Y}function Ze(e,t){const n=T.filter(i=>i.getParticipantIdentity()===t&&i.getTrackId()===e);n.length>1&&u.error("Found multiple cryptors for the same participant and trackID combination",{trackId:e,participantIdentity:t});const r=n[0];r?r.unsetParticipant():u.warn("Could not unset participant on cryptor",{trackId:e,participantIdentity:t})}function Je(e,t){u.debug("setting encryption enabled for all tracks of ".concat(t),{enable:e}),ge.set(t,e)}function $e(e,t){u.info("set shared key",{index:t}),Q().setKey(e,t)}function et(e){e.on(L.Error,t=>{const n={kind:"error",data:{error:new Error("".concat(I[t.reason],": ").concat(t.message))}};postMessage(n)})}function tt(e,t,n){postMessage({kind:"ratchetKey",data:{participantIdentity:t,keyIndex:n,material:e}})}function nt(e){be=e,T.forEach(t=>{t.setSifTrailer(e)})}self.RTCTransformEvent&&(u.debug("setup transform event"),self.onrtctransform=e=>{const t=e.transformer;u.debug("transformer",t),t.handled=!0;const{kind:n,participantIdentity:r,trackId:i,codec:s}=t.options,o=H(r,i);u.debug("transform",{codec:s}),o.setupTransform(n,t.readable,t.writable,i,s)})})();
//# sourceMappingURL=livekit-client.e2ee.worker-DCt9knlM.js.map
