import{u as k,r as d,H as G,ar as H,eo as j,a3 as O,t as $,y as N,am as J,fi as w}from"./j17jyok1wsl0o201.js";import{c as m,d as B,e as K,R as W,g as R,a as M,V as y,b as v,I as X,f as C,h as V,r as z,L as Y,i as Z,j as h}from"./l1q4l2pou132zqpt.js";import{ii as ee,ij as Q,bS as P,aA as te,ik as ne}from"./d6o9dilao46lwpkd.js";function x(){const t=k("716722001").value,e=k("2436427643").value,n=k("1413999995").value;return{av:t,video:e,screenshare:n}}function ae(){oe(),se(),ce(),ie()}function ie(){const{room:t,debug:e}=m(),n=x(),s=n.video||n.av,c=d.useMemo(()=>{const a=["audioinput","audiooutput"];return s&&a.push("videoinput"),a},[s]);d.useEffect(()=>{async function a(){Promise.all(c.map(async o=>{const r=await W.getLocalDevices(o),u=t?.getActiveDevice(o);if(!r.find(f=>f.deviceId===u)){const f=await R(o);let l=null;f?l=f.deviceId:r[0]&&(l=r[0].deviceId),e(`switching ${o} to ${l}`),l&&await t?.switchActiveDevice(o,l)}}))}if(navigator)return navigator.mediaDevices.addEventListener("devicechange",a),()=>{navigator.mediaDevices.removeEventListener("devicechange",a)}},[t,e,c])}function oe(){const{room:t,debug:e}=m(),n=t?.getActiveDevice("audioinput"),s=t?.getActiveDevice("audiooutput");d.useEffect(()=>{async function c(){const a=(await R("audioinput"))?.deviceId,o=(await R("audiooutput"))?.deviceId,r=async()=>{a&&n!==a&&(e("switching audio input to default"),await t?.switchActiveDevice("audioinput",a))},u=async()=>{if(o&&s!==o){e("switching audio output to default");try{await t?.switchActiveDevice("audiooutput",o)}catch(I){e("failed to switch audio output",I)}}};await Promise.all([r(),u()])}c()},[n,s,e,t])}function se(){const{isVideoEnabled:t,endStartingVideo:e}=B(),{room:n,debug:s}=m(),c=x(),a=c.video||c.av,o=a?n?.getActiveDevice("videoinput"):void 0;d.useEffect(()=>{async function r(){if(t)try{await n?.localParticipant.setCameraEnabled(!0),e(!0)}catch{e(!1)}else await n?.localParticipant.setCameraEnabled(!1)}n&&r()},[t,e,n]),d.useEffect(()=>{async function r(){const u=(await R("videoinput"))?.deviceId;await(async()=>{u&&o!==u&&(s("switching video input to default"),await n?.switchActiveDevice("videoinput",u))})()}a&&r()},[o,s,n,a])}function ce(){const{room:t}=m(),{isScreenshareEnabled:e,endStartingScreenshare:n}=K();d.useEffect(()=>{async function s(){if(e)try{await t?.localParticipant.setScreenShareEnabled(!0,{video:{displaySurface:"monitor"}}),n(!0)}catch{n(!1)}else await t?.localParticipant.setScreenShareEnabled(!1)}t&&s()},[t,e,n])}function F(){const{debug:t}=m(),e=M(s=>s.conversationId),n=G();return d.useCallback(async s=>{const c=s,a=e&&!H(e)?e:void 0,o=c??a;if(o){t(`refetch conversationId ${o}`);try{await ee(o,!0)}catch(r){const u="Failed to update conversation";t(u,r),n.danger(u)}}},[e,t,n])}const re=5e3,de=2e3,ue=t=>{const{room:e}=m(),n=M(p=>p.disconnectPending),s=M(p=>p.server.remoteState===y.Speaking),c=M(p=>p.conversationId)??void 0,a=j(c),o=d.useRef(!1),r=F(),u=O(),I=$();o.current=s||o.current;const f=d.useCallback(async p=>{clearTimeout(n),v.setState(E=>{E.disconnectPending=void 0}),e?.disconnect(),await r(a),v.setState(X);const b=a??p;b&&Q(u,I,b),t?.refetchLater&&window.setTimeout(()=>{r(a)},de)},[n,e,r,a,t?.refetchLater,u,I]),l=o.current&&!a,L=d.useCallback(()=>{v.setState(p=>{p.disconnectPending=window.setTimeout(f,re)})},[f]);return{disconnectPending:n!==void 0,shouldDelayDisconnect:l,delayDisconnect:L,immediateDisconnect:f}};function ve(){const t=$(),{room:e,debug:n,decoder:s}=m(),{disconnectPending:c,immediateDisconnect:a}=ue(),o=F(),r=O(),u=d.useRef(!1),I=d.useRef(!1),f=P(l=>l.lastVoiceSessionStartTime);d.useEffect(()=>{const l=async g=>{const{new_state:i}=g;if(v.setState(S=>{S.server.remoteState=i}),i===y.Listening&&!I.current&&f instanceof Date){const T=new Date().getTime()-f.getTime();w.firstListeningLatency.success({durationMs:T}),I.current=!0}i===y.ListeningIntently?w.voiceSessionListeningIntently.stateChange():i===y.Listening?w.voiceSessionListening.stateChange():i===y.Thinking?w.voiceSessionThinking.stateChange():i===y.Speaking?w.voiceSessionSpeaking.stateChange():i===y.Halted&&w.voiceSessionHalted.stateChange()},L=async g=>{v.setState(i=>{i.server.usage=g})},p=async g=>{v.setState(i=>{i.server.toolUpdate={...g}})},b=async g=>{let i;try{i=JSON.parse(s.decode(g)),n("data recevied",i)}catch(S){n("error parsing data",S);return}switch(v.setState(S=>(S.server.messages.push({...i,timestamp:new Date,source:"remote"}),S)),i.type){case V.StateUpdate:n("state update",i.payload);const{new_state:S,delay_s:T}=i.payload;if(S===y.Listening&&!u.current){u.current=!0,performance.mark("voice_mode.end");const D=performance.measure("voice_mode","voice_mode.start","voice_mode.end").duration.toFixed(0);w.voiceMode.connect({durationMs:D})}S===y.Thinking&&T&&(n(`${e?.name} delay thinking state by ${T} seconds`),l({new_state:y.ListeningIntently,delay_s:T}),await new Promise(D=>setTimeout(D,T*1e3))),l(i.payload);break;case V.ConversationUpdate:{n("conversation update",i.payload);const D=v.getState().conversationId,{conversation_id:A}=i.payload;D&&H(D)&&(N.initThread(D,{kind:J.PrimaryAssistant}),N.setServerIdForNewThread(D,A),v.setState(q=>{q.conversationId=A}),Q(te,t,A),ne(t)),await o(A),c&&a(A);break}case V.UsageUpdate:L(i.payload);break;case V.ToolUpdate:p(i.payload);break}},E=(g,i)=>{n("track published",g,i)},_=()=>{n("disconnected"),z(),w.voiceSessionDisconnected.stateChange()},U=(g,i)=>{i instanceof Y&&(n(`Connection quality changed for participant ${i.identity}: ${g}`),v.setState(S=>{S.server.voiceConnectionQuality=g}))};return e?.on(C.DataReceived,b),e?.on(C.TrackPublished,E),e?.on(C.ConnectionQualityChanged,U),e?.on(C.Disconnected,_),()=>{e?.off(C.DataReceived,b),e?.off(C.TrackPublished,E),e?.off(C.ConnectionQualityChanged,U),e?.off(C.Disconnected,_)}},[t,e,o,n,s,r,c,a,f])}function le(){fe(),ge(),Se(),pe()}function fe(){const{room:t}=m();d.useEffect(()=>{v.setState(e=>{e.dev.room=t})},[t])}function ge(){const{room:t}=m(),e=Z(t);d.useEffect(()=>{v.setState(n=>{n.server.connectionState=e})},[e])}function Se(){const{room:t,debug:e,encoder:n}=m();d.useEffect(()=>{const s=!!v.getState().server.actions;if(t&&!s){const c=async a=>{e("publishing action",a);const o={type:V.ActionRequest,payload:{action:a}};await t.localParticipant.publishData(n.encode(JSON.stringify(o)),{reliable:!0}),v.setState(r=>{r.server.messages.push({...o,timestamp:new Date,source:"local"})})};v.setState(a=>{a.server.actions={[h.StartListeningIntently]:()=>c(h.StartListeningIntently),[h.StopListeningIntently]:()=>c(h.StopListeningIntently),[h.HaltAllActivity]:()=>c(h.HaltAllActivity),[h.ResumeListening]:()=>c(h.ResumeListening),[h.RelayMessage]:()=>c(h.RelayMessage)}})}},[t,e,n])}function pe(){const t=v(e=>e.isVoiceModeActive);d.useEffect(()=>(P.setState({isVoiceActive:t}),()=>{P.setState({isVoiceActive:!1})}),[t])}const Ie=d.memo(function(){return ve(),le(),ae(),null});export{Ie as V,x as a,ue as u};
//# sourceMappingURL=e93652g8f0gnwch1.js.map
