import{r as v,a9 as H,bh as L,u as _,a4 as Q,cU as q}from"./ddcjry37y0ueobh3.js";import{c as m,d as x,e as F,R as J,g as R,a as V,V as E,b as u,I as j,f as h,h as C,r as B,L as G,i as K,j as S}from"./g4zv2i39jomarudz.js";import{q as U}from"./bo5lt597wbofkr1p.js";import{r as W}from"./lw8c0noczs2rbs9j.js";import{f as X}from"./nx9wnt9smxe2g0dl.js";import{l as N,d as z,T as P}from"./dcc45rtf5i4crsq0.js";import{bv as Y}from"./mlzz6djcph5fthpz.js";import{u as k}from"./lxw6kvlkbnjsbx5r.js";function Z(){te(),ne(),oe(),ee()}function ee(){const{room:t,debug:e}=m();v.useEffect(()=>{async function n(){Promise.all(["audioinput","audiooutput","videoinput"].map(async a=>{const c=await J.getLocalDevices(a),o=t?.getActiveDevice(a);if(!c.find(r=>r.deviceId===o)){const r=await R(a);let d=null;r?d=r.deviceId:c[0]&&(d=c[0].deviceId),e(`switching ${a} to ${d}`),d&&await t?.switchActiveDevice(a,d)}}))}if(navigator)return navigator.mediaDevices.addEventListener("devicechange",n),()=>{navigator.mediaDevices.removeEventListener("devicechange",n)}},[t,e])}function te(){const{room:t,debug:e}=m(),n=t?.getActiveDevice("audioinput"),a=t?.getActiveDevice("audiooutput");v.useEffect(()=>{async function c(){const o=(await R("audioinput"))?.deviceId,s=(await R("audiooutput"))?.deviceId,r=async()=>{o&&n!==o&&(e("switching audio input to default"),await t?.switchActiveDevice("audioinput",o))},d=async()=>{if(s&&a!==s){e("switching audio output to default");try{await t?.switchActiveDevice("audiooutput",s)}catch(g){e("failed to switch audio output",g)}}};await Promise.all([r(),d()])}c()},[n,a,e,t])}function ne(){const{isVideoEnabled:t,endStartingVideo:e}=x(),{room:n,debug:a}=m(),c=n?.getActiveDevice("videoinput");v.useEffect(()=>{async function o(){if(t)try{await n?.localParticipant.setCameraEnabled(!0),e(!0)}catch{e(!1)}else await n?.localParticipant.setCameraEnabled(!1)}n&&o()},[t,e,n]),v.useEffect(()=>{async function o(){const s=(await R("videoinput"))?.deviceId;await(async()=>{s&&c!==s&&(a("switching video input to default"),await n?.switchActiveDevice("videoinput",s))})()}o()},[c,a,n])}function oe(){const{room:t}=m(),{isScreenshareEnabled:e,endStartingScreenshare:n}=F();v.useEffect(()=>{async function a(){if(e)try{await t?.localParticipant.setScreenShareEnabled(!0,{video:{displaySurface:"monitor"}}),n(!0)}catch{n(!1)}else await t?.localParticipant.setScreenShareEnabled(!1)}t&&a()},[t,e,n])}function O(){const{debug:t}=m(),e=V(a=>a.conversationId),n=H();return v.useCallback(async a=>{const c=a,o=e&&!N(e)?e:void 0,s=c??o;if(s){t(`refetch conversationId ${s}`);try{await X(s,!0)}catch(r){const d="Failed to update conversation";t(d,r),n.danger(d)}}},[e,t,n])}const ae=5e3,ie=2e3,se=t=>{const{room:e}=m(),n=V(l=>l.disconnectPending),a=V(l=>l.server.remoteState===E.Speaking),c=V(l=>l.conversationId)??void 0,o=z(c),s=v.useRef(!1),r=O(),d=L(),g=_();s.current=a||s.current;const I=v.useCallback(async l=>{clearTimeout(n),u.setState(b=>{b.disconnectPending=void 0}),e?.disconnect(),await r(o),u.setState(j);const D=o??l;D&&U(d,g,D),t?.refetchLater&&window.setTimeout(()=>{r(o)},ie)},[n,e,r,o,t?.refetchLater,d,g]),M=s.current&&!o,T=v.useCallback(()=>{u.setState(l=>{l.disconnectPending=window.setTimeout(I,ae)})},[I]);return{disconnectPending:n!==void 0,shouldDelayDisconnect:M,delayDisconnect:T,immediateDisconnect:I}};function ce(){const t=_(),{room:e,debug:n,decoder:a}=m(),{disconnectPending:c,immediateDisconnect:o}=se(),s=O(),r=L(),d=v.useRef(!1);v.useEffect(()=>{const g=async f=>{const{new_state:i}=f;u.setState(p=>{p.server.remoteState=i})},I=async f=>{u.setState(i=>{i.server.usage=f})},M=async f=>{u.setState(i=>{i.server.toolUpdate={...f}})},T=async f=>{let i;try{i=JSON.parse(a.decode(f)),n("data recevied",i)}catch(p){n("error parsing data",p);return}switch(u.setState(p=>(p.server.messages.push({...i,timestamp:new Date,source:"remote"}),p)),i.type){case C.StateUpdate:n("state update",i.payload);const{new_state:p,delay_s:A}=i.payload;if(p===E.Listening&&!d.current){d.current=!0,performance.mark("voice_mode.end");const y=performance.measure("voice_mode","voice_mode.start","voice_mode.end").duration.toFixed(0);q.voiceMode.connect({durationMs:y})}p===E.Thinking&&A&&(n(`${e?.name} delay thinking state by ${A} seconds`),g({new_state:E.ListeningIntently,delay_s:A}),await new Promise(y=>setTimeout(y,A*1e3))),g(i.payload);break;case C.ConversationUpdate:{n("conversation update",i.payload);const y=u.getState().conversationId,{conversation_id:w}=i.payload;y&&N(y)&&(P.initThread(y,{kind:Q.PrimaryAssistant}),P.setServerIdForNewThread(y,w),u.setState($=>{$.conversationId=w}),U(Y,t,w),W(t)),await s(w),c&&o(w);break}case C.UsageUpdate:I(i.payload);break;case C.ToolUpdate:M(i.payload);break}},l=(f,i)=>{n("track published",f,i)},D=()=>{n("disconnected"),B()},b=(f,i)=>{i instanceof G&&(n(`Connection quality changed for participant ${i.identity}: ${f}`),u.setState(p=>{p.server.voiceConnectionQuality=f}))};return e?.on(h.DataReceived,T),e?.on(h.TrackPublished,l),e?.on(h.ConnectionQualityChanged,b),e?.on(h.Disconnected,D),()=>{e?.off(h.DataReceived,T),e?.off(h.TrackPublished,l),e?.off(h.ConnectionQualityChanged,b),e?.off(h.Disconnected,D)}},[t,e,s,n,a,r,c,o])}function re(){de(),ue(),ve(),le()}function de(){const{room:t}=m();v.useEffect(()=>{u.setState(e=>{e.dev.room=t})},[t])}function ue(){const{room:t}=m(),e=K(t);v.useEffect(()=>{u.setState(n=>{n.server.connectionState=e})},[e])}function ve(){const{room:t,debug:e,encoder:n}=m();v.useEffect(()=>{const a=!!u.getState().server.actions;if(t&&!a){const c=async o=>{e("publishing action",o);const s={type:C.ActionRequest,payload:{action:o}};await t.localParticipant.publishData(n.encode(JSON.stringify(s)),{reliable:!0}),u.setState(r=>{r.server.messages.push({...s,timestamp:new Date,source:"local"})})};u.setState(o=>{o.server.actions={[S.StartListeningIntently]:()=>c(S.StartListeningIntently),[S.StopListeningIntently]:()=>c(S.StopListeningIntently),[S.HaltAllActivity]:()=>c(S.HaltAllActivity),[S.ResumeListening]:()=>c(S.ResumeListening),[S.RelayMessage]:()=>c(S.RelayMessage)}})}},[t,e,n])}function le(){const t=u(e=>e.isVoiceModeActive);v.useEffect(()=>(k.setState({isVoiceActive:t}),()=>{k.setState({isVoiceActive:!1})}),[t])}const De=v.memo(function(){return ce(),re(),Z(),null});export{De as V,se as u};
//# sourceMappingURL=g4wu3h1jwsoyejhb.js.map
