import{r as g,ao as w,y as a,M as m,R as _}from"./flidd11gv2mtd3pr.js";import{ey as j}from"./b3rades3r6m68flq.js";import{ab as T,b1 as N,aa as A,b2 as C}from"./hblp7wkoj3uom6wj.js";import{T as k}from"./meugxv74uw703qco.js";const R=["Not relevant","Out of date","Content is wrong"],I=["Relevant","Up to date","Accurate"];function V({citationMetadata:s,noBottomBorder:t=!1,sourceFeedback:n,setSourceFeedback:l}){const[c,r]=g.useMemo(()=>{if(s.type!=="file")return["",""];const o=s.name.split(".");return o.length>1?[o.slice(0,-1).join("."),o[o.length-1]]:[s.name,""]},[s]),f=g.useMemo(()=>j(w.GDRIVE,r),[r]),e=g.useMemo(()=>{if(s.type==="file"&&s.extra?.cloud_doc_url)try{return new URL(s.extra.cloud_doc_url).hostname}catch{return}},[s]),i=g.useCallback(o=>{l({rating:o,tags:[]})},[l]);return s.type!=="file"?null:a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex flex-row items-center justify-between py-2",children:[a.jsxs("div",{className:"max-width-full mr-2 flex grow flex-row items-center overflow-hidden",children:[a.jsx(f,{className:"mr-2 flex-shrink-0 flex-grow-0"}),a.jsx("a",{href:s.extra?.cloud_doc_url,className:"text-token-primary flex-grow-1 flex-shrink-1 overflow-hidden text-ellipsis whitespace-nowrap text-sm",target:"_blank",rel:"noreferrer",children:c}),e&&a.jsx("div",{className:"ml-2 text-sm text-token-text-secondary",children:e})]}),a.jsxs("div",{className:"flex shrink-0 flex-row items-center",children:[a.jsx("button",{className:"rounded-md p-1 hover:bg-token-main-surface-secondary",children:n?.rating==="thumbsUp"?a.jsx(T,{className:"icon-md-heavy text-token-text-primary",onClick:()=>i(void 0)}):a.jsx(N,{className:"icon-md-heavy text-token-text-secondary",onClick:()=>i("thumbsUp")})}),a.jsx("button",{className:"rounded-md p-1 hover:bg-token-main-surface-secondary",children:n?.rating==="thumbsDown"?a.jsx(A,{className:"icon-md-heavy text-token-text-primary",onClick:()=>i(void 0)}):a.jsx(C,{className:"icon-md-heavy text-token-text-secondary",onClick:()=>i("thumbsDown")})})]})]}),n?.rating&&a.jsx("div",{className:"mb-4 flex flex-row",children:(n.rating==="thumbsDown"?R:I).map(o=>a.jsx(k,{className:"mr-2",$selected:n.tags.includes(o),onClick:()=>l({...n,tags:n.tags.includes(o)?n.tags.filter(u=>u!==o):[...n.tags,o]}),children:o},o))}),!t&&a.jsx("div",{className:"w-full border-[0.5px] border-token-border-light"})]})}const S=/^【(\d+)†([^†】]+)(†[^†】]+)?】$/,E=["File created at","File last modified at"];function D(s){let t=[];if(!s||typeof s!="object")return null;if(!Object.hasOwn(s,"results"))return null;const n=s.results;if(!Array.isArray(n))return null;const l=n.map(b);for(let r of l){if(r==null)return null;t.push(r)}let c;if(Object.hasOwn(s,"debug_info")){const r=s.debug_info;if(!r||typeof r!="object"||!Object.hasOwn(r,"retrieval_results")||!Array.isArray(r.retrieval_results))return null;const f=r.retrieval_results;c={retrieval_results:[]};for(const e of f){if(!e||typeof e!="object"||typeof e.query!="string"||!Array.isArray(e.results))return null;const i=e.query;let o=e.results.map(b);const u=[];for(const d of o){if(!d)return null;u.push(d)}c.retrieval_results.push({query:i,results:u})}}return{results:t,debug_info:c}}function b(s){const t={};if(!s||typeof s!="object")return null;for(const[n,l]of Object.entries(s))n==="score"&&typeof l=="number"?t.score=l:["document_id","content","title","created_at","updated_at","file_created_at","file_modified_at","document_chunk_id","cloud_doc_url","document_source"].includes(n)&&(l==null||typeof l=="string")&&(t[n]=l??void 0);return t.document_id==null||t.content==null?null:{...t,document_id:t.document_id,content:t.content}}function O(s){const t=[];let n=null,l="",c=s.split(`
`);c.length>0&&c[c.length-1].startsWith("Visible: ")&&(l=c.pop()??"");for(const r of c){const f=r.trim(),e=f.startsWith("# ")?S.exec(f.slice(2)):null;if(e&&e.length>=3){const i=parseInt(e[1],10),o=e[2],u=e[3]?.slice(1)||void 0;n&&t.push(n),n={resultNum:i,title:o,documentId:u,contents:"",metadata:{}}}else if(n)if(n.contents)n.contents+=`
${r}`;else{let i=!1;for(const o of E){const u=`${o}: `;if(f.startsWith(u)){n.metadata[o]=f.slice(u.length),i=!0;break}}i||(n.contents=r)}}return n&&t.push(n),{visibilityLine:l,chunks:t}}function L(s){const t=s.content;switch(t.content_type){case m.Text:return t.parts.join();case m.ExecutionOutput:case m.SystemError:case m.Code:case m.SystemMessage:case m.TetherQuote:case m.TetherBrowsingCode:return t.text;case m.TetherBrowsingDisplay:return t.result;case m.UserEditableContext:case m.ModelEditableContext:return null;case m.MultimodalText:return v(t.parts);case m.SystemContent:return t.instructions==null?null:typeof t.instructions=="string"?t.instructions:v(t.instructions)}}function v(s){return s.filter(t=>typeof t=="string").join()}function G(s,t){const{entireConversation:n,messageId:l}=t;if(!n)throw new Error("The extraction function only supports exporting the entire conversation for now.");let c=l;const r=[];for(;c;){const f=s.getNodeByIdOrMessageId(c);if(!f){c=null;break}const e=f.message;if(!e)continue;const i=L(e)??"",o=Array.isArray(e.metadata?.citations)?e.metadata.citations:[],u=Array.isArray(e.metadata?.attachments)?e.metadata.attachments:[],d={id:String(e.id),author:e.author.role,recipient:e.recipient??"",createTime:e.create_time,updateTime:e.update_time};switch(e.author.role){case _.System:r.push({...d,type:"system",content:e.content,citations:o,attachments:u});break;case _.Assistant:if(e.recipient&&["user","all"].includes(e.recipient)&&i)r.push({...d,type:"visible_text",text:i,citations:o,attachments:u});else if(e.recipient&&e.recipient.includes("file_search")){const h=e.metadata?.command??"";let y=[];try{const p=JSON.parse(i);typeof p=="object"&&p!=null&&Array.isArray(p.queries)&&(y=p.queries.map(x=>String(x)))}catch{}y?r.push({...d,type:"query",command:h,content:e.content,queries:y}):r.push({...d,type:"generic_file_search_tool",command:h,content:e.content})}break;case _.User:(i||u.length>0)&&r.push({...d,type:"visible_text",text:i,citations:o,attachments:u});break;case _.Tool:if(e.author.name?.includes("file_search")&&e.recipient==="all"){const h=e.metadata?.command??"";if(h==="msearch"&&e.content.content_type===m.TetherBrowsingDisplay){const y=e.content.result;if(y){let p=null;const x=e.metadata?.raw_response;if(typeof x=="object"&&x!=null)try{p=D(x)}catch{}r.push({...d,type:"result",command:h,content:e.content,result:O(y),searchResponse:p})}}else h==="context_stuff"&&e.content.content_type===m.TetherQuote?r.push({...d,type:"fetch",command:h,content:e.content}):r.push({...d,type:"generic_file_search_tool",command:h,content:e.content})}break}c=f.parentId||null}return t.orderRootToLeaf&&r.reverse(),{messages:r}}export{V as C,G as e};
//# sourceMappingURL=cal0u03lp7thvbxn.js.map
