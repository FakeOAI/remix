const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/mjck2auyquef7ta2.js","assets/cbv020t7gzp4f872.js","assets/kq3cjnjkkiu42wsi.js","assets/root-bcm2adyk.css","assets/mhs57eaqa1m5tkcf.js","assets/gpe91l6ql3o0s610.js","assets/conversation-small-eplmind9.css","assets/j1mltnb4g3et1nfv.js","assets/kef8eqa8xs7zksuh.js","assets/f5bxc5nxf4tg9y8c.js","assets/hpiio21pr81kn19y.js","assets/n7z7p9t677plyher.js","assets/pcwsuim2es0x993n.js","assets/is-scrollable-element-i34sjb0l.css","assets/nriec8vah7hgye40.js","assets/n1m1f2dq4jbayfm0.js","assets/lw9lle2awfx0m3zh.js","assets/jcecw02o1g7i3lgl.js","assets/eprwd5wd9a7hvvfw.js","assets/hte00x4vz53jf7hc.js","assets/c039xathbpqv7hjp.js","assets/4kmoegar8udth7vh.js","assets/fte4amidzwa0x0i9.js","assets/hryykjcwq4fvumfr.js","assets/le0igyxp535xhyki.js","assets/ihhnf33zws1gyw0j.js","assets/code-composer-ausyy80t.css","assets/qa3a26l0lzw6fohr.js","assets/cupw4ycf855d1lq4.js","assets/d6nmr9xx2hoyl59u.js","assets/dtgyxk1jks2sr306.js","assets/0egy268icy1r7yxm.js","assets/document-composer-mym9u5r6.css","assets/i13yvb7mip3btqm2.js","assets/hewlejwoarda2nb0.js","assets/6belyjcnc0rvmzmg.js","assets/h627sded8tilmz3i.js","assets/nm04jgpfyxi6pn12.js","assets/ADAVisualizationComponent-mk6ngktc.css","assets/nsfpkontvpbubwqj.js","assets/sso-oxyy036d0y1nz1o5.js","assets/gwjmlj0h1ze4weuw.js","assets/im3v3z931kaknohl.js","assets/lrvsba2dtdmaxv6l.js","assets/evzpfa8rbbv8b0ad.js","assets/pfffrkjyp75ovq2c.js","assets/8p66h03cngymowiu.js","assets/m5s9xl9xzufx8e8t.js","assets/f2gayqlcdqwwsmnp.js","assets/gxxn630wwaiwqexe.js","assets/jg0ylq143luitcmx.js","assets/kqwdyvkaaavvn8k3.js","assets/n751ai9o4d44xsny.js","assets/becd6cul6xkvaxvp.js","assets/l9d2z3vhr1gylijl.js","assets/efqyepbpcx87jnv4.js","assets/e9lafxuzyeh4418f.js","assets/bvy6mtfwcgy742lh.js","assets/cf35vab9q82m0zj4.js","assets/gcyfs34rqvxyqqfn.js","assets/o5uww9jp5rfdq1jb.js","assets/nhwwej1nq0zrd7sc.js","assets/gdtirxggm92let2o.js","assets/op9obis5fwukoa18.js","assets/jaab2qdql5x1ymip.js","assets/caan1pg3ww016xl8.js","assets/lnjq7tpfav8s4s8h.js","assets/l29l32kuno0zg8js.js","assets/lwyj5zt61cufjetj.js","assets/h73djwrxeutdwgij.js","assets/gjpw3bbtuwvhdku2.js","assets/nbel0869cnaupjnl.js","assets/dwg1uidtx2z6dpb7.js","assets/k41xbylswt58q6cl.js","assets/dmw8xeoorsgvt2jn.js","assets/dwwkkgcng7rj4n70.js","assets/fjsdbl30e6mxuamu.js","assets/ju8ozph4tfmwbahu.js","assets/nfpj51mfv78l5ph5.js","assets/bb0qky2a2rq1faet.js","assets/iej0cupg2dqkmejt.js","assets/j427lrhyny0ng3gb.js","assets/jk8w36bsokizpx57.js","assets/e5q9q3nu05vlfgrk.js","assets/lwaqwyvcj7pf3m6q.js","assets/carousel-bss5aguy.css","assets/llfa3invul0gq8sh.js","assets/dbo5aplef1foip7t.js","assets/kyas4wldr2yyvw0d.js","assets/c33ks5f9akdgdfk2.js","assets/kfg98pf0m5bb64ax.js","assets/gxg4rwtqa8nyryfr.js","assets/g1y1k99v1i3yl9h6.js","assets/dyzo3md0brog80y8.js","assets/f3v3nz6reprmd7db.js","assets/dcvoi7xdu0nalgfg.js"])))=>i.map(i=>d[i]);
var Da=Object.defineProperty;var Oa=(i,e,t)=>e in i?Da(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var $=(i,e,t)=>Oa(i,typeof e!="symbol"?e+"":e,t);import{jc as Ra,jd as Aa,hQ as va,je as Ba,T as Ki,N as Fa,hC as Ur,hA as Pa,jf as ja,jg as xs,hD as La,jh as za,ji as ks,ih as Va,h_ as qr,ij as Ua,as as qa,hZ as Wr,jj as Yi,hX as Wa,jk as Ha,fB as Ja,jl as $a,jm as Ga,jn as Ka,jo as Ya,jp as Za,fD as Qa,gF as Xa,fv as el,gD as tl,gE as nl,fx as il,fy as sl,fr as rl,gH as ol,i1 as al,id as ll,fA as ee,fz as vn,gG as Ei,i3 as bs,i2 as cl,jq as dt,jr as Ot,E as dl,js as hl,jt as Mi,ju as ul,jv as fl,bd as ws,jw as Hr,ay as pl,jx as ml,jy as gl,jz as Jr,jA as yl,cn as xl,aQ as kl,aO as bl,cs as wl,ct as Sl,jB as Cl,jC as Tl,jD as El,jE as Ml,fw as P,jF as Il,jG as Nl,jH as _l,jI as Dl,jJ as Ol,jK as Rl,jL as Al,es as vl,hJ as ai,jM as li,jN as Bl,jO as Fl,hH as Pl,hO as jl,hP as Zi,jP as Ll,hM as zl,jQ as cn,o as $r,jR as Vl,jS as Ul,jT as ql,jU as Wl,jV as Hl,g7 as Gr,G as jn,dx as Jl,jW as Kr,c as $l,bb as Gl,X as Kl,jX as Yl,jY as Zl,c7 as Ql,A as Xl,jZ as ec,j_ as tc,d as nc,j$ as ic,k0 as sc,k1 as rc,k2 as oc,k3 as ac,k4 as lc,c4 as cc,k5 as Ln,l as Yr,k6 as dc,dd as Qi,k7 as Xi,k8 as hc,k9 as uc,ka as fc,kb as we,kc as pc,kd as Bn,ke as Nn,kf as mc,kg as Zr,kh as gc,ki as yc,kj as xc,kk as Ss,kl as kc,km as bc,bL as wc,bx as Cs,bN as Sc,kn as Cc,ko as Tc,kp as Ec,kq as Mc,j3 as ci,kr as Ic,Y as Nc,ks as _c,kt as Dc}from"./gpe91l6ql3o0s610.js";import{a7 as Nt,r as R,m as x,a1 as Tn,a6 as es,aD as Ee,aE as ye,q as se,f5 as Oc,d0 as Qn,a5 as ce,fR as Qr,ek as Rc,aH as qe,bd as Ts,c as Ac,aN as vc,fm as Bc,fC as Xr,bK as eo,Q as Es,T as Ms,aw as ts,Z as ut,aG as to,cb as Fc,P as Ke,a as Ne,D as _e,a3 as Ii,bJ as Pc,fS as jc,O as Lc,a_ as ns,M as Xn,bL as zc,bM as Vc,cv as Uc,fT as qc,eQ as no,S as gn,bD as ct,fU as Ni,R as xt,dW as dn,eK as Wc,bE as gt,fV as _i,cS as Hc,fW as io,v as Jc,eN as $c,f as Is,fX as Gc,fY as Ns,fZ as _s,f_ as Kc,cU as Di,ai as Yc,u as Zc,dH as Qc,cT as Xc,cV as Ds,b as ed,d8 as td,aK as nd,ad as id,bo as sd,cZ as rd,eY as od}from"./cbv020t7gzp4f872.js";import{B as ad,P as zn}from"./nriec8vah7hgye40.js";import{P as ld,a as cd,bS as dd,u as hd,e as ud,a7 as fd,a8 as pd}from"./kq3cjnjkkiu42wsi.js";import{f as md,h as so,i as gd,g as yd,j as xd,b as kd}from"./n1m1f2dq4jbayfm0.js";import{m as Tt}from"./j1mltnb4g3et1nfv.js";import{u as bd,J as wd,b as Sd,V as Cd,g as Os,d as Td,W as Ed,X as Md}from"./eprwd5wd9a7hvvfw.js";import{l as is,d as Vn,T as v,K as Id,L as Nd,a as Oi,n as ro,i as ss,M as _d,N as Dd}from"./lw9lle2awfx0m3zh.js";import{i as oo,C as Od,g as Rd,a as Ad,b as vd}from"./hryykjcwq4fvumfr.js";import{r as ao,s as Bd}from"./hte00x4vz53jf7hc.js";import{g as Fd}from"./le0igyxp535xhyki.js";import{T as Pd,u as jd}from"./ihhnf33zws1gyw0j.js";const Ld=({onScroll:i})=>(Ra(({scrollTop:e})=>{i==null||i(e)}),null),zd=({shouldScrollToTop:i})=>{const e=Aa();return R.useEffect(()=>{i===!0&&e({behavior:"smooth"})},[i,e]),null},Vd=()=>{const i=va();R.useEffect(()=>{i({behavior:"smooth"})},[i]);const[e]=Ba();return e?null:x.jsx("button",{onClick:()=>i({behavior:"smooth"}),className:"absolute bottom-5 right-1/2 z-10 flex h-8 w-8 translate-x-1/2 cursor-pointer items-center justify-center rounded-full border border-token-border-light bg-token-main-surface-primary bg-clip-padding text-token-text-secondary",children:x.jsx(ld,{className:"icon-md text-token-text-primary"})})},Ud=Nt.section`w-full h-full flex flex-col popover bg-token-main-surface-primary`,qd=({children:i,onScroll:e,shouldScrollToTop:t,scrollToBottomMode:n="top"},s)=>x.jsx("main",{className:"flex min-h-0 flex-auto flex-grow flex-col",ref:s,children:x.jsxs(ad,{followButtonClassName:"hidden",initialScrollBehavior:"auto",className:"h-full",mode:n,children:[i,n==="bottom"&&x.jsx(Vd,{}),x.jsx(Ld,{onScroll:e}),x.jsx(zd,{shouldScrollToTop:t})]})}),Wd=R.forwardRef(qd),Hd=Nt.header`flex items-center justify-between p-3 h-14`,Jd=Nt.h2`ml-2.5 text-base text-lg text-gray-700 dark:text-token-text-secondary truncate`,$d=({onClick:i})=>{const e=Tn();return x.jsx(Ki,{label:e.formatMessage(Gd.close),children:x.jsx(Fa,{icon:cd,onClick:i})})},Qt=({children:i})=>x.jsx(Ud,{children:i});Qt.Title=Jd;Qt.CloseButton=$d;Qt.Header=Hd;Qt.Content=Wd;const Gd=es({close:{id:"Bix/Kd",defaultMessage:"Close"}}),Kd=Ee(()=>ye(()=>import("./mjck2auyquef7ta2.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26])).then(i=>i.CodeComposer),{ssr:!1,loading:()=>x.jsx("div",{className:Ur.code,children:x.jsx("div",{className:"h-full w-full px-4",children:x.jsx(zn,{lines:20})})})}),Yd=i=>x.jsx(Kd,{...i}),lo=()=>{const[{width:i},e]=Pa(),t=i>=xs+La?xs:za;return x.jsx("div",{className:se(Ur.document,"mt-4"),ref:e,style:{margin:`0 ${ja}px`},children:x.jsx("div",{style:{width:t},children:x.jsx(zn,{lines:20})})})},Zd=Ee(()=>ye(()=>import("./qa3a26l0lzw6fohr.js"),__vite__mapDeps([27,1,2,3,9,5,6,4,7,10,11,12,13,28,16,29,30,17,31,14,15,18,19,20,21,22,23,24,25,32])).then(i=>i.DocumentComposer),{ssr:!1,loading:lo}),Qd=i=>x.jsx(Zd,{...i});function co(i,e,t){for(let n=0;;n++){if(n==i.childCount||n==e.childCount)return i.childCount==e.childCount?null:t;let s=i.child(n),r=e.child(n);if(s==r){t+=s.nodeSize;continue}if(!s.sameMarkup(r))return t;if(s.isText&&s.text!=r.text){for(let o=0;s.text[o]==r.text[o];o++)t++;return t}if(s.content.size||r.content.size){let o=co(s.content,r.content,t+1);if(o!=null)return o}t+=s.nodeSize}}function ho(i,e,t,n){for(let s=i.childCount,r=e.childCount;;){if(s==0||r==0)return s==r?null:{a:t,b:n};let o=i.child(--s),a=e.child(--r),l=o.nodeSize;if(o==a){t-=l,n-=l;continue}if(!o.sameMarkup(a))return{a:t,b:n};if(o.isText&&o.text!=a.text){let d=0,u=Math.min(o.text.length,a.text.length);for(;d<u&&o.text[o.text.length-d-1]==a.text[a.text.length-d-1];)d++,t--,n--;return{a:t,b:n}}if(o.content.size||a.content.size){let d=ho(o.content,a.content,t-1,n-1);if(d)return d}t-=l,n-=l}}class N{constructor(e,t){if(this.content=e,this.size=t||0,t==null)for(let n=0;n<e.length;n++)this.size+=e[n].nodeSize}nodesBetween(e,t,n,s=0,r){for(let o=0,a=0;a<t;o++){let l=this.content[o],d=a+l.nodeSize;if(d>e&&n(l,s+a,r||null,o)!==!1&&l.content.size){let u=a+1;l.nodesBetween(Math.max(0,e-u),Math.min(l.content.size,t-u),n,s+u)}a=d}}descendants(e){this.nodesBetween(0,this.size,e)}textBetween(e,t,n,s){let r="",o=!0;return this.nodesBetween(e,t,(a,l)=>{let d=a.isText?a.text.slice(Math.max(e,l)-l,t-l):a.isLeaf?s?typeof s=="function"?s(a):s:a.type.spec.leafText?a.type.spec.leafText(a):"":"";a.isBlock&&(a.isLeaf&&d||a.isTextblock)&&n&&(o?o=!1:r+=n),r+=d},0),r}append(e){if(!e.size)return this;if(!this.size)return e;let t=this.lastChild,n=e.firstChild,s=this.content.slice(),r=0;for(t.isText&&t.sameMarkup(n)&&(s[s.length-1]=t.withText(t.text+n.text),r=1);r<e.content.length;r++)s.push(e.content[r]);return new N(s,this.size+e.size)}cut(e,t=this.size){if(e==0&&t==this.size)return this;let n=[],s=0;if(t>e)for(let r=0,o=0;o<t;r++){let a=this.content[r],l=o+a.nodeSize;l>e&&((o<e||l>t)&&(a.isText?a=a.cut(Math.max(0,e-o),Math.min(a.text.length,t-o)):a=a.cut(Math.max(0,e-o-1),Math.min(a.content.size,t-o-1))),n.push(a),s+=a.nodeSize),o=l}return new N(n,s)}cutByIndex(e,t){return e==t?N.empty:e==0&&t==this.content.length?this:new N(this.content.slice(e,t))}replaceChild(e,t){let n=this.content[e];if(n==t)return this;let s=this.content.slice(),r=this.size+t.nodeSize-n.nodeSize;return s[e]=t,new N(s,r)}addToStart(e){return new N([e].concat(this.content),this.size+e.nodeSize)}addToEnd(e){return new N(this.content.concat(e),this.size+e.nodeSize)}eq(e){if(this.content.length!=e.content.length)return!1;for(let t=0;t<this.content.length;t++)if(!this.content[t].eq(e.content[t]))return!1;return!0}get firstChild(){return this.content.length?this.content[0]:null}get lastChild(){return this.content.length?this.content[this.content.length-1]:null}get childCount(){return this.content.length}child(e){let t=this.content[e];if(!t)throw new RangeError("Index "+e+" out of range for "+this);return t}maybeChild(e){return this.content[e]||null}forEach(e){for(let t=0,n=0;t<this.content.length;t++){let s=this.content[t];e(s,n,t),n+=s.nodeSize}}findDiffStart(e,t=0){return co(this,e,t)}findDiffEnd(e,t=this.size,n=e.size){return ho(this,e,t,n)}findIndex(e,t=-1){if(e==0)return _n(0,e);if(e==this.size)return _n(this.content.length,e);if(e>this.size||e<0)throw new RangeError(`Position ${e} outside of fragment (${this})`);for(let n=0,s=0;;n++){let r=this.child(n),o=s+r.nodeSize;if(o>=e)return o==e||t>0?_n(n+1,o):_n(n,s);s=o}}toString(){return"<"+this.toStringInner()+">"}toStringInner(){return this.content.join(", ")}toJSON(){return this.content.length?this.content.map(e=>e.toJSON()):null}static fromJSON(e,t){if(!t)return N.empty;if(!Array.isArray(t))throw new RangeError("Invalid input for Fragment.fromJSON");return new N(t.map(e.nodeFromJSON))}static fromArray(e){if(!e.length)return N.empty;let t,n=0;for(let s=0;s<e.length;s++){let r=e[s];n+=r.nodeSize,s&&r.isText&&e[s-1].sameMarkup(r)?(t||(t=e.slice(0,s)),t[t.length-1]=r.withText(t[t.length-1].text+r.text)):t&&t.push(r)}return new N(t||e,n)}static from(e){if(!e)return N.empty;if(e instanceof N)return e;if(Array.isArray(e))return this.fromArray(e);if(e.attrs)return new N([e],e.nodeSize);throw new RangeError("Can not convert "+e+" to a Fragment"+(e.nodesBetween?" (looks like multiple versions of prosemirror-model were loaded)":""))}}N.empty=new N([],0);const di={index:0,offset:0};function _n(i,e){return di.index=i,di.offset=e,di}function Un(i,e){if(i===e)return!0;if(!(i&&typeof i=="object")||!(e&&typeof e=="object"))return!1;let t=Array.isArray(i);if(Array.isArray(e)!=t)return!1;if(t){if(i.length!=e.length)return!1;for(let n=0;n<i.length;n++)if(!Un(i[n],e[n]))return!1}else{for(let n in i)if(!(n in e)||!Un(i[n],e[n]))return!1;for(let n in e)if(!(n in i))return!1}return!0}class G{constructor(e,t){this.type=e,this.attrs=t}addToSet(e){let t,n=!1;for(let s=0;s<e.length;s++){let r=e[s];if(this.eq(r))return e;if(this.type.excludes(r.type))t||(t=e.slice(0,s));else{if(r.type.excludes(this.type))return e;!n&&r.type.rank>this.type.rank&&(t||(t=e.slice(0,s)),t.push(this),n=!0),t&&t.push(r)}}return t||(t=e.slice()),n||t.push(this),t}removeFromSet(e){for(let t=0;t<e.length;t++)if(this.eq(e[t]))return e.slice(0,t).concat(e.slice(t+1));return e}isInSet(e){for(let t=0;t<e.length;t++)if(this.eq(e[t]))return!0;return!1}eq(e){return this==e||this.type==e.type&&Un(this.attrs,e.attrs)}toJSON(){let e={type:this.type.name};for(let t in this.attrs){e.attrs=this.attrs;break}return e}static fromJSON(e,t){if(!t)throw new RangeError("Invalid input for Mark.fromJSON");let n=e.marks[t.type];if(!n)throw new RangeError(`There is no mark type ${t.type} in this schema`);let s=n.create(t.attrs);return n.checkAttrs(s.attrs),s}static sameSet(e,t){if(e==t)return!0;if(e.length!=t.length)return!1;for(let n=0;n<e.length;n++)if(!e[n].eq(t[n]))return!1;return!0}static setFrom(e){if(!e||Array.isArray(e)&&e.length==0)return G.none;if(e instanceof G)return[e];let t=e.slice();return t.sort((n,s)=>n.type.rank-s.type.rank),t}}G.none=[];class qn extends Error{}class D{constructor(e,t,n){this.content=e,this.openStart=t,this.openEnd=n}get size(){return this.content.size-this.openStart-this.openEnd}insertAt(e,t){let n=fo(this.content,e+this.openStart,t);return n&&new D(n,this.openStart,this.openEnd)}removeBetween(e,t){return new D(uo(this.content,e+this.openStart,t+this.openStart),this.openStart,this.openEnd)}eq(e){return this.content.eq(e.content)&&this.openStart==e.openStart&&this.openEnd==e.openEnd}toString(){return this.content+"("+this.openStart+","+this.openEnd+")"}toJSON(){if(!this.content.size)return null;let e={content:this.content.toJSON()};return this.openStart>0&&(e.openStart=this.openStart),this.openEnd>0&&(e.openEnd=this.openEnd),e}static fromJSON(e,t){if(!t)return D.empty;let n=t.openStart||0,s=t.openEnd||0;if(typeof n!="number"||typeof s!="number")throw new RangeError("Invalid input for Slice.fromJSON");return new D(N.fromJSON(e,t.content),n,s)}static maxOpen(e,t=!0){let n=0,s=0;for(let r=e.firstChild;r&&!r.isLeaf&&(t||!r.type.spec.isolating);r=r.firstChild)n++;for(let r=e.lastChild;r&&!r.isLeaf&&(t||!r.type.spec.isolating);r=r.lastChild)s++;return new D(e,n,s)}}D.empty=new D(N.empty,0,0);function uo(i,e,t){let{index:n,offset:s}=i.findIndex(e),r=i.maybeChild(n),{index:o,offset:a}=i.findIndex(t);if(s==e||r.isText){if(a!=t&&!i.child(o).isText)throw new RangeError("Removing non-flat range");return i.cut(0,e).append(i.cut(t))}if(n!=o)throw new RangeError("Removing non-flat range");return i.replaceChild(n,r.copy(uo(r.content,e-s-1,t-s-1)))}function fo(i,e,t,n){let{index:s,offset:r}=i.findIndex(e),o=i.maybeChild(s);if(r==e||o.isText)return i.cut(0,e).append(t).append(i.cut(e));let a=fo(o.content,e-r-1,t);return a&&i.replaceChild(s,o.copy(a))}function Xd(i,e,t){if(t.openStart>i.depth)throw new qn("Inserted content deeper than insertion position");if(i.depth-t.openStart!=e.depth-t.openEnd)throw new qn("Inconsistent open depths");return po(i,e,t,0)}function po(i,e,t,n){let s=i.index(n),r=i.node(n);if(s==e.index(n)&&n<i.depth-t.openStart){let o=po(i,e,t,n+1);return r.copy(r.content.replaceChild(s,o))}else if(t.content.size)if(!t.openStart&&!t.openEnd&&i.depth==n&&e.depth==n){let o=i.parent,a=o.content;return Ft(o,a.cut(0,i.parentOffset).append(t.content).append(a.cut(e.parentOffset)))}else{let{start:o,end:a}=eh(t,i);return Ft(r,go(i,o,a,e,n))}else return Ft(r,Wn(i,e,n))}function mo(i,e){if(!e.type.compatibleContent(i.type))throw new qn("Cannot join "+e.type.name+" onto "+i.type.name)}function Ri(i,e,t){let n=i.node(t);return mo(n,e.node(t)),n}function Bt(i,e){let t=e.length-1;t>=0&&i.isText&&i.sameMarkup(e[t])?e[t]=i.withText(e[t].text+i.text):e.push(i)}function hn(i,e,t,n){let s=(e||i).node(t),r=0,o=e?e.index(t):s.childCount;i&&(r=i.index(t),i.depth>t?r++:i.textOffset&&(Bt(i.nodeAfter,n),r++));for(let a=r;a<o;a++)Bt(s.child(a),n);e&&e.depth==t&&e.textOffset&&Bt(e.nodeBefore,n)}function Ft(i,e){return i.type.checkContent(e),i.copy(e)}function go(i,e,t,n,s){let r=i.depth>s&&Ri(i,e,s+1),o=n.depth>s&&Ri(t,n,s+1),a=[];return hn(null,i,s,a),r&&o&&e.index(s)==t.index(s)?(mo(r,o),Bt(Ft(r,go(i,e,t,n,s+1)),a)):(r&&Bt(Ft(r,Wn(i,e,s+1)),a),hn(e,t,s,a),o&&Bt(Ft(o,Wn(t,n,s+1)),a)),hn(n,null,s,a),new N(a)}function Wn(i,e,t){let n=[];if(hn(null,i,t,n),i.depth>t){let s=Ri(i,e,t+1);Bt(Ft(s,Wn(i,e,t+1)),n)}return hn(e,null,t,n),new N(n)}function eh(i,e){let t=e.depth-i.openStart,s=e.node(t).copy(i.content);for(let r=t-1;r>=0;r--)s=e.node(r).copy(N.from(s));return{start:s.resolveNoCache(i.openStart+t),end:s.resolveNoCache(s.content.size-i.openEnd-t)}}class yn{constructor(e,t,n){this.pos=e,this.path=t,this.parentOffset=n,this.depth=t.length/3-1}resolveDepth(e){return e==null?this.depth:e<0?this.depth+e:e}get parent(){return this.node(this.depth)}get doc(){return this.node(0)}node(e){return this.path[this.resolveDepth(e)*3]}index(e){return this.path[this.resolveDepth(e)*3+1]}indexAfter(e){return e=this.resolveDepth(e),this.index(e)+(e==this.depth&&!this.textOffset?0:1)}start(e){return e=this.resolveDepth(e),e==0?0:this.path[e*3-1]+1}end(e){return e=this.resolveDepth(e),this.start(e)+this.node(e).content.size}before(e){if(e=this.resolveDepth(e),!e)throw new RangeError("There is no position before the top-level node");return e==this.depth+1?this.pos:this.path[e*3-1]}after(e){if(e=this.resolveDepth(e),!e)throw new RangeError("There is no position after the top-level node");return e==this.depth+1?this.pos:this.path[e*3-1]+this.path[e*3].nodeSize}get textOffset(){return this.pos-this.path[this.path.length-1]}get nodeAfter(){let e=this.parent,t=this.index(this.depth);if(t==e.childCount)return null;let n=this.pos-this.path[this.path.length-1],s=e.child(t);return n?e.child(t).cut(n):s}get nodeBefore(){let e=this.index(this.depth),t=this.pos-this.path[this.path.length-1];return t?this.parent.child(e).cut(0,t):e==0?null:this.parent.child(e-1)}posAtIndex(e,t){t=this.resolveDepth(t);let n=this.path[t*3],s=t==0?0:this.path[t*3-1]+1;for(let r=0;r<e;r++)s+=n.child(r).nodeSize;return s}marks(){let e=this.parent,t=this.index();if(e.content.size==0)return G.none;if(this.textOffset)return e.child(t).marks;let n=e.maybeChild(t-1),s=e.maybeChild(t);if(!n){let a=n;n=s,s=a}let r=n.marks;for(var o=0;o<r.length;o++)r[o].type.spec.inclusive===!1&&(!s||!r[o].isInSet(s.marks))&&(r=r[o--].removeFromSet(r));return r}marksAcross(e){let t=this.parent.maybeChild(this.index());if(!t||!t.isInline)return null;let n=t.marks,s=e.parent.maybeChild(e.index());for(var r=0;r<n.length;r++)n[r].type.spec.inclusive===!1&&(!s||!n[r].isInSet(s.marks))&&(n=n[r--].removeFromSet(n));return n}sharedDepth(e){for(let t=this.depth;t>0;t--)if(this.start(t)<=e&&this.end(t)>=e)return t;return 0}blockRange(e=this,t){if(e.pos<this.pos)return e.blockRange(this);for(let n=this.depth-(this.parent.inlineContent||this.pos==e.pos?1:0);n>=0;n--)if(e.pos<=this.end(n)&&(!t||t(this.node(n))))return new ih(this,e,n);return null}sameParent(e){return this.pos-this.parentOffset==e.pos-e.parentOffset}max(e){return e.pos>this.pos?e:this}min(e){return e.pos<this.pos?e:this}toString(){let e="";for(let t=1;t<=this.depth;t++)e+=(e?"/":"")+this.node(t).type.name+"_"+this.index(t-1);return e+":"+this.parentOffset}static resolve(e,t){if(!(t>=0&&t<=e.content.size))throw new RangeError("Position "+t+" out of range");let n=[],s=0,r=t;for(let o=e;;){let{index:a,offset:l}=o.content.findIndex(r),d=r-l;if(n.push(o,a,s+l),!d||(o=o.child(a),o.isText))break;r=d-1,s+=l+1}return new yn(t,n,r)}static resolveCached(e,t){let n=Rs.get(e);if(n)for(let r=0;r<n.elts.length;r++){let o=n.elts[r];if(o.pos==t)return o}else Rs.set(e,n=new th);let s=n.elts[n.i]=yn.resolve(e,t);return n.i=(n.i+1)%nh,s}}class th{constructor(){this.elts=[],this.i=0}}const nh=12,Rs=new WeakMap;class ih{constructor(e,t,n){this.$from=e,this.$to=t,this.depth=n}get start(){return this.$from.before(this.depth+1)}get end(){return this.$to.after(this.depth+1)}get parent(){return this.$from.node(this.depth)}get startIndex(){return this.$from.index(this.depth)}get endIndex(){return this.$to.indexAfter(this.depth)}}const sh=Object.create(null);class it{constructor(e,t,n,s=G.none){this.type=e,this.attrs=t,this.marks=s,this.content=n||N.empty}get nodeSize(){return this.isLeaf?1:2+this.content.size}get childCount(){return this.content.childCount}child(e){return this.content.child(e)}maybeChild(e){return this.content.maybeChild(e)}forEach(e){this.content.forEach(e)}nodesBetween(e,t,n,s=0){this.content.nodesBetween(e,t,n,s,this)}descendants(e){this.nodesBetween(0,this.content.size,e)}get textContent(){return this.isLeaf&&this.type.spec.leafText?this.type.spec.leafText(this):this.textBetween(0,this.content.size,"")}textBetween(e,t,n,s){return this.content.textBetween(e,t,n,s)}get firstChild(){return this.content.firstChild}get lastChild(){return this.content.lastChild}eq(e){return this==e||this.sameMarkup(e)&&this.content.eq(e.content)}sameMarkup(e){return this.hasMarkup(e.type,e.attrs,e.marks)}hasMarkup(e,t,n){return this.type==e&&Un(this.attrs,t||e.defaultAttrs||sh)&&G.sameSet(this.marks,n||G.none)}copy(e=null){return e==this.content?this:new it(this.type,this.attrs,e,this.marks)}mark(e){return e==this.marks?this:new it(this.type,this.attrs,this.content,e)}cut(e,t=this.content.size){return e==0&&t==this.content.size?this:this.copy(this.content.cut(e,t))}slice(e,t=this.content.size,n=!1){if(e==t)return D.empty;let s=this.resolve(e),r=this.resolve(t),o=n?0:s.sharedDepth(t),a=s.start(o),d=s.node(o).content.cut(s.pos-a,r.pos-a);return new D(d,s.depth-o,r.depth-o)}replace(e,t,n){return Xd(this.resolve(e),this.resolve(t),n)}nodeAt(e){for(let t=this;;){let{index:n,offset:s}=t.content.findIndex(e);if(t=t.maybeChild(n),!t)return null;if(s==e||t.isText)return t;e-=s+1}}childAfter(e){let{index:t,offset:n}=this.content.findIndex(e);return{node:this.content.maybeChild(t),index:t,offset:n}}childBefore(e){if(e==0)return{node:null,index:0,offset:0};let{index:t,offset:n}=this.content.findIndex(e);if(n<e)return{node:this.content.child(t),index:t,offset:n};let s=this.content.child(t-1);return{node:s,index:t-1,offset:n-s.nodeSize}}resolve(e){return yn.resolveCached(this,e)}resolveNoCache(e){return yn.resolve(this,e)}rangeHasMark(e,t,n){let s=!1;return t>e&&this.nodesBetween(e,t,r=>(n.isInSet(r.marks)&&(s=!0),!s)),s}get isBlock(){return this.type.isBlock}get isTextblock(){return this.type.isTextblock}get inlineContent(){return this.type.inlineContent}get isInline(){return this.type.isInline}get isText(){return this.type.isText}get isLeaf(){return this.type.isLeaf}get isAtom(){return this.type.isAtom}toString(){if(this.type.spec.toDebugString)return this.type.spec.toDebugString(this);let e=this.type.name;return this.content.size&&(e+="("+this.content.toStringInner()+")"),yo(this.marks,e)}contentMatchAt(e){let t=this.type.contentMatch.matchFragment(this.content,0,e);if(!t)throw new Error("Called contentMatchAt on a node with invalid content");return t}canReplace(e,t,n=N.empty,s=0,r=n.childCount){let o=this.contentMatchAt(e).matchFragment(n,s,r),a=o&&o.matchFragment(this.content,t);if(!a||!a.validEnd)return!1;for(let l=s;l<r;l++)if(!this.type.allowsMarks(n.child(l).marks))return!1;return!0}canReplaceWith(e,t,n,s){if(s&&!this.type.allowsMarks(s))return!1;let r=this.contentMatchAt(e).matchType(n),o=r&&r.matchFragment(this.content,t);return o?o.validEnd:!1}canAppend(e){return e.content.size?this.canReplace(this.childCount,this.childCount,e.content):this.type.compatibleContent(e.type)}check(){this.type.checkContent(this.content),this.type.checkAttrs(this.attrs);let e=G.none;for(let t=0;t<this.marks.length;t++){let n=this.marks[t];n.type.checkAttrs(n.attrs),e=n.addToSet(e)}if(!G.sameSet(e,this.marks))throw new RangeError(`Invalid collection of marks for node ${this.type.name}: ${this.marks.map(t=>t.type.name)}`);this.content.forEach(t=>t.check())}toJSON(){let e={type:this.type.name};for(let t in this.attrs){e.attrs=this.attrs;break}return this.content.size&&(e.content=this.content.toJSON()),this.marks.length&&(e.marks=this.marks.map(t=>t.toJSON())),e}static fromJSON(e,t){if(!t)throw new RangeError("Invalid input for Node.fromJSON");let n;if(t.marks){if(!Array.isArray(t.marks))throw new RangeError("Invalid mark data for Node.fromJSON");n=t.marks.map(e.markFromJSON)}if(t.type=="text"){if(typeof t.text!="string")throw new RangeError("Invalid text node in JSON");return e.text(t.text,n)}let s=N.fromJSON(e,t.content),r=e.nodeType(t.type).create(t.attrs,s,n);return r.type.checkAttrs(r.attrs),r}}it.prototype.text=void 0;class Hn extends it{constructor(e,t,n,s){if(super(e,t,null,s),!n)throw new RangeError("Empty text nodes are not allowed");this.text=n}toString(){return this.type.spec.toDebugString?this.type.spec.toDebugString(this):yo(this.marks,JSON.stringify(this.text))}get textContent(){return this.text}textBetween(e,t){return this.text.slice(e,t)}get nodeSize(){return this.text.length}mark(e){return e==this.marks?this:new Hn(this.type,this.attrs,this.text,e)}withText(e){return e==this.text?this:new Hn(this.type,this.attrs,e,this.marks)}cut(e=0,t=this.text.length){return e==0&&t==this.text.length?this:this.withText(this.text.slice(e,t))}eq(e){return this.sameMarkup(e)&&this.text==e.text}toJSON(){let e=super.toJSON();return e.text=this.text,e}}function yo(i,e){for(let t=i.length-1;t>=0;t--)e=i[t].type.name+"("+e+")";return e}class Lt{constructor(e){this.validEnd=e,this.next=[],this.wrapCache=[]}static parse(e,t){let n=new rh(e,t);if(n.next==null)return Lt.empty;let s=xo(n);n.next&&n.err("Unexpected trailing text");let r=uh(hh(s));return fh(r,n),r}matchType(e){for(let t=0;t<this.next.length;t++)if(this.next[t].type==e)return this.next[t].next;return null}matchFragment(e,t=0,n=e.childCount){let s=this;for(let r=t;s&&r<n;r++)s=s.matchType(e.child(r).type);return s}get inlineContent(){return this.next.length!=0&&this.next[0].type.isInline}get defaultType(){for(let e=0;e<this.next.length;e++){let{type:t}=this.next[e];if(!(t.isText||t.hasRequiredAttrs()))return t}return null}compatible(e){for(let t=0;t<this.next.length;t++)for(let n=0;n<e.next.length;n++)if(this.next[t].type==e.next[n].type)return!0;return!1}fillBefore(e,t=!1,n=0){let s=[this];function r(o,a){let l=o.matchFragment(e,n);if(l&&(!t||l.validEnd))return N.from(a.map(d=>d.createAndFill()));for(let d=0;d<o.next.length;d++){let{type:u,next:m}=o.next[d];if(!(u.isText||u.hasRequiredAttrs())&&s.indexOf(m)==-1){s.push(m);let p=r(m,a.concat(u));if(p)return p}}return null}return r(this,[])}findWrapping(e){for(let n=0;n<this.wrapCache.length;n+=2)if(this.wrapCache[n]==e)return this.wrapCache[n+1];let t=this.computeWrapping(e);return this.wrapCache.push(e,t),t}computeWrapping(e){let t=Object.create(null),n=[{match:this,type:null,via:null}];for(;n.length;){let s=n.shift(),r=s.match;if(r.matchType(e)){let o=[];for(let a=s;a.type;a=a.via)o.push(a.type);return o.reverse()}for(let o=0;o<r.next.length;o++){let{type:a,next:l}=r.next[o];!a.isLeaf&&!a.hasRequiredAttrs()&&!(a.name in t)&&(!s.type||l.validEnd)&&(n.push({match:a.contentMatch,type:a,via:s}),t[a.name]=!0)}}return null}get edgeCount(){return this.next.length}edge(e){if(e>=this.next.length)throw new RangeError(`There's no ${e}th edge in this content match`);return this.next[e]}toString(){let e=[];function t(n){e.push(n);for(let s=0;s<n.next.length;s++)e.indexOf(n.next[s].next)==-1&&t(n.next[s].next)}return t(this),e.map((n,s)=>{let r=s+(n.validEnd?"*":" ")+" ";for(let o=0;o<n.next.length;o++)r+=(o?", ":"")+n.next[o].type.name+"->"+e.indexOf(n.next[o].next);return r}).join(`
`)}}Lt.empty=new Lt(!0);class rh{constructor(e,t){this.string=e,this.nodeTypes=t,this.inline=null,this.pos=0,this.tokens=e.split(/\s*(?=\b|\W|$)/),this.tokens[this.tokens.length-1]==""&&this.tokens.pop(),this.tokens[0]==""&&this.tokens.shift()}get next(){return this.tokens[this.pos]}eat(e){return this.next==e&&(this.pos++||!0)}err(e){throw new SyntaxError(e+" (in content expression '"+this.string+"')")}}function xo(i){let e=[];do e.push(oh(i));while(i.eat("|"));return e.length==1?e[0]:{type:"choice",exprs:e}}function oh(i){let e=[];do e.push(ah(i));while(i.next&&i.next!=")"&&i.next!="|");return e.length==1?e[0]:{type:"seq",exprs:e}}function ah(i){let e=dh(i);for(;;)if(i.eat("+"))e={type:"plus",expr:e};else if(i.eat("*"))e={type:"star",expr:e};else if(i.eat("?"))e={type:"opt",expr:e};else if(i.eat("{"))e=lh(i,e);else break;return e}function As(i){/\D/.test(i.next)&&i.err("Expected number, got '"+i.next+"'");let e=Number(i.next);return i.pos++,e}function lh(i,e){let t=As(i),n=t;return i.eat(",")&&(i.next!="}"?n=As(i):n=-1),i.eat("}")||i.err("Unclosed braced range"),{type:"range",min:t,max:n,expr:e}}function ch(i,e){let t=i.nodeTypes,n=t[e];if(n)return[n];let s=[];for(let r in t){let o=t[r];o.groups.indexOf(e)>-1&&s.push(o)}return s.length==0&&i.err("No node type or group '"+e+"' found"),s}function dh(i){if(i.eat("(")){let e=xo(i);return i.eat(")")||i.err("Missing closing paren"),e}else if(/\W/.test(i.next))i.err("Unexpected token '"+i.next+"'");else{let e=ch(i,i.next).map(t=>(i.inline==null?i.inline=t.isInline:i.inline!=t.isInline&&i.err("Mixing inline and block content"),{type:"name",value:t}));return i.pos++,e.length==1?e[0]:{type:"choice",exprs:e}}}function hh(i){let e=[[]];return s(r(i,0),t()),e;function t(){return e.push([])-1}function n(o,a,l){let d={term:l,to:a};return e[o].push(d),d}function s(o,a){o.forEach(l=>l.to=a)}function r(o,a){if(o.type=="choice")return o.exprs.reduce((l,d)=>l.concat(r(d,a)),[]);if(o.type=="seq")for(let l=0;;l++){let d=r(o.exprs[l],a);if(l==o.exprs.length-1)return d;s(d,a=t())}else if(o.type=="star"){let l=t();return n(a,l),s(r(o.expr,l),l),[n(l)]}else if(o.type=="plus"){let l=t();return s(r(o.expr,a),l),s(r(o.expr,l),l),[n(l)]}else{if(o.type=="opt")return[n(a)].concat(r(o.expr,a));if(o.type=="range"){let l=a;for(let d=0;d<o.min;d++){let u=t();s(r(o.expr,l),u),l=u}if(o.max==-1)s(r(o.expr,l),l);else for(let d=o.min;d<o.max;d++){let u=t();n(l,u),s(r(o.expr,l),u),l=u}return[n(l)]}else{if(o.type=="name")return[n(a,void 0,o.value)];throw new Error("Unknown expr type")}}}}function ko(i,e){return e-i}function vs(i,e){let t=[];return n(e),t.sort(ko);function n(s){let r=i[s];if(r.length==1&&!r[0].term)return n(r[0].to);t.push(s);for(let o=0;o<r.length;o++){let{term:a,to:l}=r[o];!a&&t.indexOf(l)==-1&&n(l)}}}function uh(i){let e=Object.create(null);return t(vs(i,0));function t(n){let s=[];n.forEach(o=>{i[o].forEach(({term:a,to:l})=>{if(!a)return;let d;for(let u=0;u<s.length;u++)s[u][0]==a&&(d=s[u][1]);vs(i,l).forEach(u=>{d||s.push([a,d=[]]),d.indexOf(u)==-1&&d.push(u)})})});let r=e[n.join(",")]=new Lt(n.indexOf(i.length-1)>-1);for(let o=0;o<s.length;o++){let a=s[o][1].sort(ko);r.next.push({type:s[o][0],next:e[a.join(",")]||t(a)})}return r}}function fh(i,e){for(let t=0,n=[i];t<n.length;t++){let s=n[t],r=!s.validEnd,o=[];for(let a=0;a<s.next.length;a++){let{type:l,next:d}=s.next[a];o.push(l.name),r&&!(l.isText||l.hasRequiredAttrs())&&(r=!1),n.indexOf(d)==-1&&n.push(d)}r&&e.err("Only non-generatable nodes ("+o.join(", ")+") in a required position (see https://prosemirror.net/docs/guide/#generatable)")}}function bo(i){let e=Object.create(null);for(let t in i){let n=i[t];if(!n.hasDefault)return null;e[t]=n.default}return e}function wo(i,e){let t=Object.create(null);for(let n in i){let s=e&&e[n];if(s===void 0){let r=i[n];if(r.hasDefault)s=r.default;else throw new RangeError("No value supplied for attribute "+n)}t[n]=s}return t}function So(i,e,t,n){for(let s in e)if(!(s in i))throw new RangeError(`Unsupported attribute ${s} for ${t} of type ${s}`);for(let s in i){let r=i[s];r.validate&&r.validate(e[s])}}function Co(i,e){let t=Object.create(null);if(e)for(let n in e)t[n]=new mh(i,n,e[n]);return t}let Bs=class To{constructor(e,t,n){this.name=e,this.schema=t,this.spec=n,this.markSet=null,this.groups=n.group?n.group.split(" "):[],this.attrs=Co(e,n.attrs),this.defaultAttrs=bo(this.attrs),this.contentMatch=null,this.inlineContent=null,this.isBlock=!(n.inline||e=="text"),this.isText=e=="text"}get isInline(){return!this.isBlock}get isTextblock(){return this.isBlock&&this.inlineContent}get isLeaf(){return this.contentMatch==Lt.empty}get isAtom(){return this.isLeaf||!!this.spec.atom}get whitespace(){return this.spec.whitespace||(this.spec.code?"pre":"normal")}hasRequiredAttrs(){for(let e in this.attrs)if(this.attrs[e].isRequired)return!0;return!1}compatibleContent(e){return this==e||this.contentMatch.compatible(e.contentMatch)}computeAttrs(e){return!e&&this.defaultAttrs?this.defaultAttrs:wo(this.attrs,e)}create(e=null,t,n){if(this.isText)throw new Error("NodeType.create can't construct text nodes");return new it(this,this.computeAttrs(e),N.from(t),G.setFrom(n))}createChecked(e=null,t,n){return t=N.from(t),this.checkContent(t),new it(this,this.computeAttrs(e),t,G.setFrom(n))}createAndFill(e=null,t,n){if(e=this.computeAttrs(e),t=N.from(t),t.size){let o=this.contentMatch.fillBefore(t);if(!o)return null;t=o.append(t)}let s=this.contentMatch.matchFragment(t),r=s&&s.fillBefore(N.empty,!0);return r?new it(this,e,t.append(r),G.setFrom(n)):null}validContent(e){let t=this.contentMatch.matchFragment(e);if(!t||!t.validEnd)return!1;for(let n=0;n<e.childCount;n++)if(!this.allowsMarks(e.child(n).marks))return!1;return!0}checkContent(e){if(!this.validContent(e))throw new RangeError(`Invalid content for node ${this.name}: ${e.toString().slice(0,50)}`)}checkAttrs(e){So(this.attrs,e,"node",this.name)}allowsMarkType(e){return this.markSet==null||this.markSet.indexOf(e)>-1}allowsMarks(e){if(this.markSet==null)return!0;for(let t=0;t<e.length;t++)if(!this.allowsMarkType(e[t].type))return!1;return!0}allowedMarks(e){if(this.markSet==null)return e;let t;for(let n=0;n<e.length;n++)this.allowsMarkType(e[n].type)?t&&t.push(e[n]):t||(t=e.slice(0,n));return t?t.length?t:G.none:e}static compile(e,t){let n=Object.create(null);e.forEach((r,o)=>n[r]=new To(r,t,o));let s=t.spec.topNode||"doc";if(!n[s])throw new RangeError("Schema is missing its top node type ('"+s+"')");if(!n.text)throw new RangeError("Every schema needs a 'text' type");for(let r in n.text.attrs)throw new RangeError("The text node type should not have attributes");return n}};function ph(i,e,t){let n=t.split("|");return s=>{let r=s===null?"null":typeof s;if(n.indexOf(r)<0)throw new RangeError(`Expected value of type ${n} for attribute ${e} on type ${i}, got ${r}`)}}class mh{constructor(e,t,n){this.hasDefault=Object.prototype.hasOwnProperty.call(n,"default"),this.default=n.default,this.validate=typeof n.validate=="string"?ph(e,t,n.validate):n.validate}get isRequired(){return!this.hasDefault}}class ei{constructor(e,t,n,s){this.name=e,this.rank=t,this.schema=n,this.spec=s,this.attrs=Co(e,s.attrs),this.excluded=null;let r=bo(this.attrs);this.instance=r?new G(this,r):null}create(e=null){return!e&&this.instance?this.instance:new G(this,wo(this.attrs,e))}static compile(e,t){let n=Object.create(null),s=0;return e.forEach((r,o)=>n[r]=new ei(r,s++,t,o)),n}removeFromSet(e){for(var t=0;t<e.length;t++)e[t].type==this&&(e=e.slice(0,t).concat(e.slice(t+1)),t--);return e}isInSet(e){for(let t=0;t<e.length;t++)if(e[t].type==this)return e[t]}checkAttrs(e){So(this.attrs,e,"mark",this.name)}excludes(e){return this.excluded.indexOf(e)>-1}}class Fm{constructor(e){this.linebreakReplacement=null,this.cached=Object.create(null);let t=this.spec={};for(let s in e)t[s]=e[s];t.nodes=ks.from(e.nodes),t.marks=ks.from(e.marks||{}),this.nodes=Bs.compile(this.spec.nodes,this),this.marks=ei.compile(this.spec.marks,this);let n=Object.create(null);for(let s in this.nodes){if(s in this.marks)throw new RangeError(s+" can not be both a node and a mark");let r=this.nodes[s],o=r.spec.content||"",a=r.spec.marks;if(r.contentMatch=n[o]||(n[o]=Lt.parse(o,this.nodes)),r.inlineContent=r.contentMatch.inlineContent,r.spec.linebreakReplacement){if(this.linebreakReplacement)throw new RangeError("Multiple linebreak nodes defined");if(!r.isInline||!r.isLeaf)throw new RangeError("Linebreak replacement nodes must be inline leaf nodes");this.linebreakReplacement=r}r.markSet=a=="_"?null:a?Fs(this,a.split(" ")):a==""||!r.inlineContent?[]:null}for(let s in this.marks){let r=this.marks[s],o=r.spec.excludes;r.excluded=o==null?[r]:o==""?[]:Fs(this,o.split(" "))}this.nodeFromJSON=this.nodeFromJSON.bind(this),this.markFromJSON=this.markFromJSON.bind(this),this.topNodeType=this.nodes[this.spec.topNode||"doc"],this.cached.wrappings=Object.create(null)}node(e,t=null,n,s){if(typeof e=="string")e=this.nodeType(e);else if(e instanceof Bs){if(e.schema!=this)throw new RangeError("Node type from different schema used ("+e.name+")")}else throw new RangeError("Invalid node type: "+e);return e.createChecked(t,n,s)}text(e,t){let n=this.nodes.text;return new Hn(n,n.defaultAttrs,e,G.setFrom(t))}mark(e,t){return typeof e=="string"&&(e=this.marks[e]),e.create(t)}nodeFromJSON(e){return it.fromJSON(this,e)}markFromJSON(e){return G.fromJSON(this,e)}nodeType(e){let t=this.nodes[e];if(!t)throw new RangeError("Unknown node type: "+e);return t}}function Fs(i,e){let t=[];for(let n=0;n<e.length;n++){let s=e[n],r=i.marks[s],o=r;if(r)t.push(r);else for(let a in i.marks){let l=i.marks[a];(s=="_"||l.spec.group&&l.spec.group.split(" ").indexOf(s)>-1)&&t.push(o=l)}if(!o)throw new SyntaxError("Unknown mark type: '"+e[n]+"'")}return t}function gh(i){return i.tag!=null}function yh(i){return i.style!=null}class xn{constructor(e,t){this.schema=e,this.rules=t,this.tags=[],this.styles=[];let n=this.matchedStyles=[];t.forEach(s=>{if(gh(s))this.tags.push(s);else if(yh(s)){let r=/[^=]*/.exec(s.style)[0];n.indexOf(r)<0&&n.push(r),this.styles.push(s)}}),this.normalizeLists=!this.tags.some(s=>{if(!/^(ul|ol)\b/.test(s.tag)||!s.node)return!1;let r=e.nodes[s.node];return r.contentMatch.matchType(r)})}parse(e,t={}){let n=new js(this,t,!1);return n.addAll(e,t.from,t.to),n.finish()}parseSlice(e,t={}){let n=new js(this,t,!0);return n.addAll(e,t.from,t.to),D.maxOpen(n.finish())}matchTag(e,t,n){for(let s=n?this.tags.indexOf(n)+1:0;s<this.tags.length;s++){let r=this.tags[s];if(bh(e,r.tag)&&(r.namespace===void 0||e.namespaceURI==r.namespace)&&(!r.context||t.matchesContext(r.context))){if(r.getAttrs){let o=r.getAttrs(e);if(o===!1)continue;r.attrs=o||void 0}return r}}}matchStyle(e,t,n,s){for(let r=s?this.styles.indexOf(s)+1:0;r<this.styles.length;r++){let o=this.styles[r],a=o.style;if(!(a.indexOf(e)!=0||o.context&&!n.matchesContext(o.context)||a.length>e.length&&(a.charCodeAt(e.length)!=61||a.slice(e.length+1)!=t))){if(o.getAttrs){let l=o.getAttrs(t);if(l===!1)continue;o.attrs=l||void 0}return o}}}static schemaRules(e){let t=[];function n(s){let r=s.priority==null?50:s.priority,o=0;for(;o<t.length;o++){let a=t[o];if((a.priority==null?50:a.priority)<r)break}t.splice(o,0,s)}for(let s in e.marks){let r=e.marks[s].spec.parseDOM;r&&r.forEach(o=>{n(o=Ls(o)),o.mark||o.ignore||o.clearMark||(o.mark=s)})}for(let s in e.nodes){let r=e.nodes[s].spec.parseDOM;r&&r.forEach(o=>{n(o=Ls(o)),o.node||o.ignore||o.mark||(o.node=s)})}return t}static fromSchema(e){return e.cached.domParser||(e.cached.domParser=new xn(e,xn.schemaRules(e)))}}const Eo={address:!0,article:!0,aside:!0,blockquote:!0,canvas:!0,dd:!0,div:!0,dl:!0,fieldset:!0,figcaption:!0,figure:!0,footer:!0,form:!0,h1:!0,h2:!0,h3:!0,h4:!0,h5:!0,h6:!0,header:!0,hgroup:!0,hr:!0,li:!0,noscript:!0,ol:!0,output:!0,p:!0,pre:!0,section:!0,table:!0,tfoot:!0,ul:!0},xh={head:!0,noscript:!0,object:!0,script:!0,style:!0,title:!0},Mo={ol:!0,ul:!0},Jn=1,$n=2,un=4;function Ps(i,e,t){return e!=null?(e?Jn:0)|(e==="full"?$n:0):i&&i.whitespace=="pre"?Jn|$n:t&~un}class Dn{constructor(e,t,n,s,r,o,a){this.type=e,this.attrs=t,this.marks=n,this.pendingMarks=s,this.solid=r,this.options=a,this.content=[],this.activeMarks=G.none,this.stashMarks=[],this.match=o||(a&un?null:e.contentMatch)}findWrapping(e){if(!this.match){if(!this.type)return[];let t=this.type.contentMatch.fillBefore(N.from(e));if(t)this.match=this.type.contentMatch.matchFragment(t);else{let n=this.type.contentMatch,s;return(s=n.findWrapping(e.type))?(this.match=n,s):null}}return this.match.findWrapping(e.type)}finish(e){if(!(this.options&Jn)){let n=this.content[this.content.length-1],s;if(n&&n.isText&&(s=/[ \t\r\n\u000c]+$/.exec(n.text))){let r=n;n.text.length==s[0].length?this.content.pop():this.content[this.content.length-1]=r.withText(r.text.slice(0,r.text.length-s[0].length))}}let t=N.from(this.content);return!e&&this.match&&(t=t.append(this.match.fillBefore(N.empty,!0))),this.type?this.type.create(this.attrs,t,this.marks):t}popFromStashMark(e){for(let t=this.stashMarks.length-1;t>=0;t--)if(e.eq(this.stashMarks[t]))return this.stashMarks.splice(t,1)[0]}applyPending(e){for(let t=0,n=this.pendingMarks;t<n.length;t++){let s=n[t];(this.type?this.type.allowsMarkType(s.type):wh(s.type,e))&&!s.isInSet(this.activeMarks)&&(this.activeMarks=s.addToSet(this.activeMarks),this.pendingMarks=s.removeFromSet(this.pendingMarks))}}inlineContext(e){return this.type?this.type.inlineContent:this.content.length?this.content[0].isInline:e.parentNode&&!Eo.hasOwnProperty(e.parentNode.nodeName.toLowerCase())}}class js{constructor(e,t,n){this.parser=e,this.options=t,this.isOpen=n,this.open=0;let s=t.topNode,r,o=Ps(null,t.preserveWhitespace,0)|(n?un:0);s?r=new Dn(s.type,s.attrs,G.none,G.none,!0,t.topMatch||s.type.contentMatch,o):n?r=new Dn(null,null,G.none,G.none,!0,null,o):r=new Dn(e.schema.topNodeType,null,G.none,G.none,!0,null,o),this.nodes=[r],this.find=t.findPositions,this.needsBlock=!1}get top(){return this.nodes[this.open]}addDOM(e){e.nodeType==3?this.addTextNode(e):e.nodeType==1&&this.addElement(e)}withStyleRules(e,t){let n=e.style;if(!n||!n.length)return t();let s=this.readStyles(e.style);if(!s)return;let[r,o]=s,a=this.top;for(let l=0;l<o.length;l++)this.removePendingMark(o[l],a);for(let l=0;l<r.length;l++)this.addPendingMark(r[l]);t();for(let l=0;l<r.length;l++)this.removePendingMark(r[l],a);for(let l=0;l<o.length;l++)this.addPendingMark(o[l])}addTextNode(e){let t=e.nodeValue,n=this.top;if(n.options&$n||n.inlineContext(e)||/[^ \t\r\n\u000c]/.test(t)){if(n.options&Jn)n.options&$n?t=t.replace(/\r\n?/g,`
`):t=t.replace(/\r?\n|\r/g," ");else if(t=t.replace(/[ \t\r\n\u000c]+/g," "),/^[ \t\r\n\u000c]/.test(t)&&this.open==this.nodes.length-1){let s=n.content[n.content.length-1],r=e.previousSibling;(!s||r&&r.nodeName=="BR"||s.isText&&/[ \t\r\n\u000c]$/.test(s.text))&&(t=t.slice(1))}t&&this.insertNode(this.parser.schema.text(t)),this.findInText(e)}else this.findInside(e)}addElement(e,t){let n=e.nodeName.toLowerCase(),s;Mo.hasOwnProperty(n)&&this.parser.normalizeLists&&kh(e);let r=this.options.ruleFromNode&&this.options.ruleFromNode(e)||(s=this.parser.matchTag(e,this,t));if(r?r.ignore:xh.hasOwnProperty(n))this.findInside(e),this.ignoreFallback(e);else if(!r||r.skip||r.closeParent){r&&r.closeParent?this.open=Math.max(0,this.open-1):r&&r.skip.nodeType&&(e=r.skip);let o,a=this.top,l=this.needsBlock;if(Eo.hasOwnProperty(n))a.content.length&&a.content[0].isInline&&this.open&&(this.open--,a=this.top),o=!0,a.type||(this.needsBlock=!0);else if(!e.firstChild){this.leafFallback(e);return}r&&r.skip?this.addAll(e):this.withStyleRules(e,()=>this.addAll(e)),o&&this.sync(a),this.needsBlock=l}else this.withStyleRules(e,()=>{this.addElementByRule(e,r,r.consuming===!1?s:void 0)})}leafFallback(e){e.nodeName=="BR"&&this.top.type&&this.top.type.inlineContent&&this.addTextNode(e.ownerDocument.createTextNode(`
`))}ignoreFallback(e){e.nodeName=="BR"&&(!this.top.type||!this.top.type.inlineContent)&&this.findPlace(this.parser.schema.text("-"))}readStyles(e){let t=G.none,n=G.none;if(e.length)for(let s=0;s<this.parser.matchedStyles.length;s++){let r=this.parser.matchedStyles[s],o=e.getPropertyValue(r);if(o)for(let a=void 0;;){let l=this.parser.matchStyle(r,o,this,a);if(!l)break;if(l.ignore)return null;if(l.clearMark?this.top.pendingMarks.concat(this.top.activeMarks).forEach(d=>{l.clearMark(d)&&(n=d.addToSet(n))}):t=this.parser.schema.marks[l.mark].create(l.attrs).addToSet(t),l.consuming===!1)a=l;else break}}return[t,n]}addElementByRule(e,t,n){let s,r,o;t.node?(r=this.parser.schema.nodes[t.node],r.isLeaf?this.insertNode(r.create(t.attrs))||this.leafFallback(e):s=this.enter(r,t.attrs||null,t.preserveWhitespace)):(o=this.parser.schema.marks[t.mark].create(t.attrs),this.addPendingMark(o));let a=this.top;if(r&&r.isLeaf)this.findInside(e);else if(n)this.addElement(e,n);else if(t.getContent)this.findInside(e),t.getContent(e,this.parser.schema).forEach(l=>this.insertNode(l));else{let l=e;typeof t.contentElement=="string"?l=e.querySelector(t.contentElement):typeof t.contentElement=="function"?l=t.contentElement(e):t.contentElement&&(l=t.contentElement),this.findAround(e,l,!0),this.addAll(l)}s&&this.sync(a)&&this.open--,o&&this.removePendingMark(o,a)}addAll(e,t,n){let s=t||0;for(let r=t?e.childNodes[t]:e.firstChild,o=n==null?null:e.childNodes[n];r!=o;r=r.nextSibling,++s)this.findAtPoint(e,s),this.addDOM(r);this.findAtPoint(e,s)}findPlace(e){let t,n;for(let s=this.open;s>=0;s--){let r=this.nodes[s],o=r.findWrapping(e);if(o&&(!t||t.length>o.length)&&(t=o,n=r,!o.length)||r.solid)break}if(!t)return!1;this.sync(n);for(let s=0;s<t.length;s++)this.enterInner(t[s],null,!1);return!0}insertNode(e){if(e.isInline&&this.needsBlock&&!this.top.type){let t=this.textblockFromContext();t&&this.enterInner(t)}if(this.findPlace(e)){this.closeExtra();let t=this.top;t.applyPending(e.type),t.match&&(t.match=t.match.matchType(e.type));let n=t.activeMarks;for(let s=0;s<e.marks.length;s++)(!t.type||t.type.allowsMarkType(e.marks[s].type))&&(n=e.marks[s].addToSet(n));return t.content.push(e.mark(n)),!0}return!1}enter(e,t,n){let s=this.findPlace(e.create(t));return s&&this.enterInner(e,t,!0,n),s}enterInner(e,t=null,n=!1,s){this.closeExtra();let r=this.top;r.applyPending(e),r.match=r.match&&r.match.matchType(e);let o=Ps(e,s,r.options);r.options&un&&r.content.length==0&&(o|=un),this.nodes.push(new Dn(e,t,r.activeMarks,r.pendingMarks,n,null,o)),this.open++}closeExtra(e=!1){let t=this.nodes.length-1;if(t>this.open){for(;t>this.open;t--)this.nodes[t-1].content.push(this.nodes[t].finish(e));this.nodes.length=this.open+1}}finish(){return this.open=0,this.closeExtra(this.isOpen),this.nodes[0].finish(this.isOpen||this.options.topOpen)}sync(e){for(let t=this.open;t>=0;t--)if(this.nodes[t]==e)return this.open=t,!0;return!1}get currentPos(){this.closeExtra();let e=0;for(let t=this.open;t>=0;t--){let n=this.nodes[t].content;for(let s=n.length-1;s>=0;s--)e+=n[s].nodeSize;t&&e++}return e}findAtPoint(e,t){if(this.find)for(let n=0;n<this.find.length;n++)this.find[n].node==e&&this.find[n].offset==t&&(this.find[n].pos=this.currentPos)}findInside(e){if(this.find)for(let t=0;t<this.find.length;t++)this.find[t].pos==null&&e.nodeType==1&&e.contains(this.find[t].node)&&(this.find[t].pos=this.currentPos)}findAround(e,t,n){if(e!=t&&this.find)for(let s=0;s<this.find.length;s++)this.find[s].pos==null&&e.nodeType==1&&e.contains(this.find[s].node)&&t.compareDocumentPosition(this.find[s].node)&(n?2:4)&&(this.find[s].pos=this.currentPos)}findInText(e){if(this.find)for(let t=0;t<this.find.length;t++)this.find[t].node==e&&(this.find[t].pos=this.currentPos-(e.nodeValue.length-this.find[t].offset))}matchesContext(e){if(e.indexOf("|")>-1)return e.split(/\s*\|\s*/).some(this.matchesContext,this);let t=e.split("/"),n=this.options.context,s=!this.isOpen&&(!n||n.parent.type==this.nodes[0].type),r=-(n?n.depth+1:0)+(s?0:1),o=(a,l)=>{for(;a>=0;a--){let d=t[a];if(d==""){if(a==t.length-1||a==0)continue;for(;l>=r;l--)if(o(a-1,l))return!0;return!1}else{let u=l>0||l==0&&s?this.nodes[l].type:n&&l>=r?n.node(l-r).type:null;if(!u||u.name!=d&&u.groups.indexOf(d)==-1)return!1;l--}}return!0};return o(t.length-1,this.open)}textblockFromContext(){let e=this.options.context;if(e)for(let t=e.depth;t>=0;t--){let n=e.node(t).contentMatchAt(e.indexAfter(t)).defaultType;if(n&&n.isTextblock&&n.defaultAttrs)return n}for(let t in this.parser.schema.nodes){let n=this.parser.schema.nodes[t];if(n.isTextblock&&n.defaultAttrs)return n}}addPendingMark(e){let t=Sh(e,this.top.pendingMarks);t&&this.top.stashMarks.push(t),this.top.pendingMarks=e.addToSet(this.top.pendingMarks)}removePendingMark(e,t){for(let n=this.open;n>=0;n--){let s=this.nodes[n];if(s.pendingMarks.lastIndexOf(e)>-1)s.pendingMarks=e.removeFromSet(s.pendingMarks);else{s.activeMarks=e.removeFromSet(s.activeMarks);let o=s.popFromStashMark(e);o&&s.type&&s.type.allowsMarkType(o.type)&&(s.activeMarks=o.addToSet(s.activeMarks))}if(s==t)break}}}function kh(i){for(let e=i.firstChild,t=null;e;e=e.nextSibling){let n=e.nodeType==1?e.nodeName.toLowerCase():null;n&&Mo.hasOwnProperty(n)&&t?(t.appendChild(e),e=t):n=="li"?t=e:n&&(t=null)}}function bh(i,e){return(i.matches||i.msMatchesSelector||i.webkitMatchesSelector||i.mozMatchesSelector).call(i,e)}function Ls(i){let e={};for(let t in i)e[t]=i[t];return e}function wh(i,e){let t=e.schema.nodes;for(let n in t){let s=t[n];if(!s.allowsMarkType(i))continue;let r=[],o=a=>{r.push(a);for(let l=0;l<a.edgeCount;l++){let{type:d,next:u}=a.edge(l);if(d==e||r.indexOf(u)<0&&o(u))return!0}};if(o(s.contentMatch))return!0}}function Sh(i,e){for(let t=0;t<e.length;t++)if(i.eq(e[t]))return e[t]}class nn{constructor(e,t){this.nodes=e,this.marks=t}serializeFragment(e,t={},n){n||(n=hi(t).createDocumentFragment());let s=n,r=[];return e.forEach(o=>{if(r.length||o.marks.length){let a=0,l=0;for(;a<r.length&&l<o.marks.length;){let d=o.marks[l];if(!this.marks[d.type.name]){l++;continue}if(!d.eq(r[a][0])||d.type.spec.spanning===!1)break;a++,l++}for(;a<r.length;)s=r.pop()[1];for(;l<o.marks.length;){let d=o.marks[l++],u=this.serializeMark(d,o.isInline,t);u&&(r.push([d,s]),s.appendChild(u.dom),s=u.contentDOM||u.dom)}}s.appendChild(this.serializeNodeInner(o,t))}),n}serializeNodeInner(e,t){let{dom:n,contentDOM:s}=Fn(hi(t),this.nodes[e.type.name](e),null,e.attrs);if(s){if(e.isLeaf)throw new RangeError("Content hole not allowed in a leaf node spec");this.serializeFragment(e.content,t,s)}return n}serializeNode(e,t={}){let n=this.serializeNodeInner(e,t);for(let s=e.marks.length-1;s>=0;s--){let r=this.serializeMark(e.marks[s],e.isInline,t);r&&((r.contentDOM||r.dom).appendChild(n),n=r.dom)}return n}serializeMark(e,t,n={}){let s=this.marks[e.type.name];return s&&Fn(hi(n),s(e,t),null,e.attrs)}static renderSpec(e,t,n=null,s){return Fn(e,t,n,s)}static fromSchema(e){return e.cached.domSerializer||(e.cached.domSerializer=new nn(this.nodesFromSchema(e),this.marksFromSchema(e)))}static nodesFromSchema(e){let t=zs(e.nodes);return t.text||(t.text=n=>n.text),t}static marksFromSchema(e){return zs(e.marks)}}function zs(i){let e={};for(let t in i){let n=i[t].spec.toDOM;n&&(e[t]=n)}return e}function hi(i){return i.document||window.document}const Vs=new WeakMap;function Ch(i){let e=Vs.get(i);return e===void 0&&Vs.set(i,e=Th(i)),e}function Th(i){let e=null;function t(n){if(n&&typeof n=="object")if(Array.isArray(n))if(typeof n[0]=="string")e||(e=[]),e.push(n);else for(let s=0;s<n.length;s++)t(n[s]);else for(let s in n)t(n[s])}return t(i),e}function Fn(i,e,t,n){if(typeof e=="string")return{dom:i.createTextNode(e)};if(e.nodeType!=null)return{dom:e};if(e.dom&&e.dom.nodeType!=null)return e;let s=e[0],r;if(typeof s!="string")throw new RangeError("Invalid array passed to renderSpec");if(n&&(r=Ch(n))&&r.indexOf(e)>-1)throw new RangeError("Using an array from an attribute object as a DOM spec. This may be an attempted cross site scripting attack.");let o=s.indexOf(" ");o>0&&(t=s.slice(0,o),s=s.slice(o+1));let a,l=t?i.createElementNS(t,s):i.createElement(s),d=e[1],u=1;if(d&&typeof d=="object"&&d.nodeType==null&&!Array.isArray(d)){u=2;for(let m in d)if(d[m]!=null){let p=m.indexOf(" ");p>0?l.setAttributeNS(m.slice(0,p),m.slice(p+1),d[m]):l.setAttribute(m,d[m])}}for(let m=u;m<e.length;m++){let p=e[m];if(p===0){if(m<e.length-1||m>u)throw new RangeError("Content hole must be the only child of its parent node");return{dom:l,contentDOM:l}}else{let{dom:k,contentDOM:y}=Fn(i,p,t,n);if(l.appendChild(k),y){if(a)throw new RangeError("Multiple content holes");a=y}}}return{dom:l,contentDOM:a}}const Io=65535,No=Math.pow(2,16);function Eh(i,e){return i+e*No}function Us(i){return i&Io}function Mh(i){return(i-(i&Io))/No}const _o=1,Do=2,Pn=4,Oo=8;class Ai{constructor(e,t,n){this.pos=e,this.delInfo=t,this.recover=n}get deleted(){return(this.delInfo&Oo)>0}get deletedBefore(){return(this.delInfo&(_o|Pn))>0}get deletedAfter(){return(this.delInfo&(Do|Pn))>0}get deletedAcross(){return(this.delInfo&Pn)>0}}class Le{constructor(e,t=!1){if(this.ranges=e,this.inverted=t,!e.length&&Le.empty)return Le.empty}recover(e){let t=0,n=Us(e);if(!this.inverted)for(let s=0;s<n;s++)t+=this.ranges[s*3+2]-this.ranges[s*3+1];return this.ranges[n*3]+t+Mh(e)}mapResult(e,t=1){return this._map(e,t,!1)}map(e,t=1){return this._map(e,t,!0)}_map(e,t,n){let s=0,r=this.inverted?2:1,o=this.inverted?1:2;for(let a=0;a<this.ranges.length;a+=3){let l=this.ranges[a]-(this.inverted?s:0);if(l>e)break;let d=this.ranges[a+r],u=this.ranges[a+o],m=l+d;if(e<=m){let p=d?e==l?-1:e==m?1:t:t,k=l+s+(p<0?0:u);if(n)return k;let y=e==(t<0?l:m)?null:Eh(a/3,e-l),S=e==l?Do:e==m?_o:Pn;return(t<0?e!=l:e!=m)&&(S|=Oo),new Ai(k,S,y)}s+=u-d}return n?e+s:new Ai(e+s,0,null)}touches(e,t){let n=0,s=Us(t),r=this.inverted?2:1,o=this.inverted?1:2;for(let a=0;a<this.ranges.length;a+=3){let l=this.ranges[a]-(this.inverted?n:0);if(l>e)break;let d=this.ranges[a+r],u=l+d;if(e<=u&&a==s*3)return!0;n+=this.ranges[a+o]-d}return!1}forEach(e){let t=this.inverted?2:1,n=this.inverted?1:2;for(let s=0,r=0;s<this.ranges.length;s+=3){let o=this.ranges[s],a=o-(this.inverted?r:0),l=o+(this.inverted?0:r),d=this.ranges[s+t],u=this.ranges[s+n];e(a,a+d,l,l+u),r+=u-d}}invert(){return new Le(this.ranges,!this.inverted)}toString(){return(this.inverted?"-":"")+JSON.stringify(this.ranges)}static offset(e){return e==0?Le.empty:new Le(e<0?[0,-e,0]:[0,0,e])}}Le.empty=new Le([]);class fn{constructor(e=[],t,n=0,s=e.length){this.maps=e,this.mirror=t,this.from=n,this.to=s}slice(e=0,t=this.maps.length){return new fn(this.maps,this.mirror,e,t)}copy(){return new fn(this.maps.slice(),this.mirror&&this.mirror.slice(),this.from,this.to)}appendMap(e,t){this.to=this.maps.push(e),t!=null&&this.setMirror(this.maps.length-1,t)}appendMapping(e){for(let t=0,n=this.maps.length;t<e.maps.length;t++){let s=e.getMirror(t);this.appendMap(e.maps[t],s!=null&&s<t?n+s:void 0)}}getMirror(e){if(this.mirror){for(let t=0;t<this.mirror.length;t++)if(this.mirror[t]==e)return this.mirror[t+(t%2?-1:1)]}}setMirror(e,t){this.mirror||(this.mirror=[]),this.mirror.push(e,t)}appendMappingInverted(e){for(let t=e.maps.length-1,n=this.maps.length+e.maps.length;t>=0;t--){let s=e.getMirror(t);this.appendMap(e.maps[t].invert(),s!=null&&s>t?n-s-1:void 0)}}invert(){let e=new fn;return e.appendMappingInverted(this),e}map(e,t=1){if(this.mirror)return this._map(e,t,!0);for(let n=this.from;n<this.to;n++)e=this.maps[n].map(e,t);return e}mapResult(e,t=1){return this._map(e,t,!1)}_map(e,t,n){let s=0;for(let r=this.from;r<this.to;r++){let o=this.maps[r],a=o.mapResult(e,t);if(a.recover!=null){let l=this.getMirror(r);if(l!=null&&l>r&&l<this.to){r=l,e=this.maps[l].recover(a.recover);continue}}s|=a.delInfo,e=a.pos}return n?e:new Ai(e,s,null)}}const ui=Object.create(null);class Me{getMap(){return Le.empty}merge(e){return null}static fromJSON(e,t){if(!t||!t.stepType)throw new RangeError("Invalid input for Step.fromJSON");let n=ui[t.stepType];if(!n)throw new RangeError(`No step type ${t.stepType} defined`);return n.fromJSON(e,t)}static jsonID(e,t){if(e in ui)throw new RangeError("Duplicate use of step JSON ID "+e);return ui[e]=t,t.prototype.jsonID=e,t}}class de{constructor(e,t){this.doc=e,this.failed=t}static ok(e){return new de(e,null)}static fail(e){return new de(null,e)}static fromReplace(e,t,n,s){try{return de.ok(e.replace(t,n,s))}catch(r){if(r instanceof qn)return de.fail(r.message);throw r}}}function rs(i,e,t){let n=[];for(let s=0;s<i.childCount;s++){let r=i.child(s);r.content.size&&(r=r.copy(rs(r.content,e,r))),r.isInline&&(r=e(r,t,s)),n.push(r)}return N.fromArray(n)}class wt extends Me{constructor(e,t,n){super(),this.from=e,this.to=t,this.mark=n}apply(e){let t=e.slice(this.from,this.to),n=e.resolve(this.from),s=n.node(n.sharedDepth(this.to)),r=new D(rs(t.content,(o,a)=>!o.isAtom||!a.type.allowsMarkType(this.mark.type)?o:o.mark(this.mark.addToSet(o.marks)),s),t.openStart,t.openEnd);return de.fromReplace(e,this.from,this.to,r)}invert(){return new nt(this.from,this.to,this.mark)}map(e){let t=e.mapResult(this.from,1),n=e.mapResult(this.to,-1);return t.deleted&&n.deleted||t.pos>=n.pos?null:new wt(t.pos,n.pos,this.mark)}merge(e){return e instanceof wt&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from?new wt(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark):null}toJSON(){return{stepType:"addMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for AddMarkStep.fromJSON");return new wt(t.from,t.to,e.markFromJSON(t.mark))}}Me.jsonID("addMark",wt);class nt extends Me{constructor(e,t,n){super(),this.from=e,this.to=t,this.mark=n}apply(e){let t=e.slice(this.from,this.to),n=new D(rs(t.content,s=>s.mark(this.mark.removeFromSet(s.marks)),e),t.openStart,t.openEnd);return de.fromReplace(e,this.from,this.to,n)}invert(){return new wt(this.from,this.to,this.mark)}map(e){let t=e.mapResult(this.from,1),n=e.mapResult(this.to,-1);return t.deleted&&n.deleted||t.pos>=n.pos?null:new nt(t.pos,n.pos,this.mark)}merge(e){return e instanceof nt&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from?new nt(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark):null}toJSON(){return{stepType:"removeMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for RemoveMarkStep.fromJSON");return new nt(t.from,t.to,e.markFromJSON(t.mark))}}Me.jsonID("removeMark",nt);class St extends Me{constructor(e,t){super(),this.pos=e,this.mark=t}apply(e){let t=e.nodeAt(this.pos);if(!t)return de.fail("No node at mark step's position");let n=t.type.create(t.attrs,null,this.mark.addToSet(t.marks));return de.fromReplace(e,this.pos,this.pos+1,new D(N.from(n),0,t.isLeaf?0:1))}invert(e){let t=e.nodeAt(this.pos);if(t){let n=this.mark.addToSet(t.marks);if(n.length==t.marks.length){for(let s=0;s<t.marks.length;s++)if(!t.marks[s].isInSet(n))return new St(this.pos,t.marks[s]);return new St(this.pos,this.mark)}}return new Xt(this.pos,this.mark)}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new St(t.pos,this.mark)}toJSON(){return{stepType:"addNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for AddNodeMarkStep.fromJSON");return new St(t.pos,e.markFromJSON(t.mark))}}Me.jsonID("addNodeMark",St);class Xt extends Me{constructor(e,t){super(),this.pos=e,this.mark=t}apply(e){let t=e.nodeAt(this.pos);if(!t)return de.fail("No node at mark step's position");let n=t.type.create(t.attrs,null,this.mark.removeFromSet(t.marks));return de.fromReplace(e,this.pos,this.pos+1,new D(N.from(n),0,t.isLeaf?0:1))}invert(e){let t=e.nodeAt(this.pos);return!t||!this.mark.isInSet(t.marks)?this:new St(this.pos,this.mark)}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new Xt(t.pos,this.mark)}toJSON(){return{stepType:"removeNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for RemoveNodeMarkStep.fromJSON");return new Xt(t.pos,e.markFromJSON(t.mark))}}Me.jsonID("removeNodeMark",Xt);class Ce extends Me{constructor(e,t,n,s=!1){super(),this.from=e,this.to=t,this.slice=n,this.structure=s}apply(e){return this.structure&&vi(e,this.from,this.to)?de.fail("Structure replace would overwrite content"):de.fromReplace(e,this.from,this.to,this.slice)}getMap(){return new Le([this.from,this.to-this.from,this.slice.size])}invert(e){return new Ce(this.from,this.from+this.slice.size,e.slice(this.from,this.to))}map(e){let t=e.mapResult(this.from,1),n=e.mapResult(this.to,-1);return t.deletedAcross&&n.deletedAcross?null:new Ce(t.pos,Math.max(t.pos,n.pos),this.slice)}merge(e){if(!(e instanceof Ce)||e.structure||this.structure)return null;if(this.from+this.slice.size==e.from&&!this.slice.openEnd&&!e.slice.openStart){let t=this.slice.size+e.slice.size==0?D.empty:new D(this.slice.content.append(e.slice.content),this.slice.openStart,e.slice.openEnd);return new Ce(this.from,this.to+(e.to-e.from),t,this.structure)}else if(e.to==this.from&&!this.slice.openStart&&!e.slice.openEnd){let t=this.slice.size+e.slice.size==0?D.empty:new D(e.slice.content.append(this.slice.content),e.slice.openStart,this.slice.openEnd);return new Ce(e.from,this.to,t,this.structure)}else return null}toJSON(){let e={stepType:"replace",from:this.from,to:this.to};return this.slice.size&&(e.slice=this.slice.toJSON()),this.structure&&(e.structure=!0),e}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for ReplaceStep.fromJSON");return new Ce(t.from,t.to,D.fromJSON(e,t.slice),!!t.structure)}}Me.jsonID("replace",Ce);class Ye extends Me{constructor(e,t,n,s,r,o,a=!1){super(),this.from=e,this.to=t,this.gapFrom=n,this.gapTo=s,this.slice=r,this.insert=o,this.structure=a}apply(e){if(this.structure&&(vi(e,this.from,this.gapFrom)||vi(e,this.gapTo,this.to)))return de.fail("Structure gap-replace would overwrite content");let t=e.slice(this.gapFrom,this.gapTo);if(t.openStart||t.openEnd)return de.fail("Gap is not a flat range");let n=this.slice.insertAt(this.insert,t.content);return n?de.fromReplace(e,this.from,this.to,n):de.fail("Content does not fit in gap")}getMap(){return new Le([this.from,this.gapFrom-this.from,this.insert,this.gapTo,this.to-this.gapTo,this.slice.size-this.insert])}invert(e){let t=this.gapTo-this.gapFrom;return new Ye(this.from,this.from+this.slice.size+t,this.from+this.insert,this.from+this.insert+t,e.slice(this.from,this.to).removeBetween(this.gapFrom-this.from,this.gapTo-this.from),this.gapFrom-this.from,this.structure)}map(e){let t=e.mapResult(this.from,1),n=e.mapResult(this.to,-1),s=this.from==this.gapFrom?t.pos:e.map(this.gapFrom,-1),r=this.to==this.gapTo?n.pos:e.map(this.gapTo,1);return t.deletedAcross&&n.deletedAcross||s<t.pos||r>n.pos?null:new Ye(t.pos,n.pos,s,r,this.slice,this.insert,this.structure)}toJSON(){let e={stepType:"replaceAround",from:this.from,to:this.to,gapFrom:this.gapFrom,gapTo:this.gapTo,insert:this.insert};return this.slice.size&&(e.slice=this.slice.toJSON()),this.structure&&(e.structure=!0),e}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number"||typeof t.gapFrom!="number"||typeof t.gapTo!="number"||typeof t.insert!="number")throw new RangeError("Invalid input for ReplaceAroundStep.fromJSON");return new Ye(t.from,t.to,t.gapFrom,t.gapTo,D.fromJSON(e,t.slice),t.insert,!!t.structure)}}Me.jsonID("replaceAround",Ye);function vi(i,e,t){let n=i.resolve(e),s=t-e,r=n.depth;for(;s>0&&r>0&&n.indexAfter(r)==n.node(r).childCount;)r--,s--;if(s>0){let o=n.node(r).maybeChild(n.indexAfter(r));for(;s>0;){if(!o||o.isLeaf)return!0;o=o.firstChild,s--}}return!1}function Ih(i,e,t,n){let s=[],r=[],o,a;i.doc.nodesBetween(e,t,(l,d,u)=>{if(!l.isInline)return;let m=l.marks;if(!n.isInSet(m)&&u.type.allowsMarkType(n.type)){let p=Math.max(d,e),k=Math.min(d+l.nodeSize,t),y=n.addToSet(m);for(let S=0;S<m.length;S++)m[S].isInSet(y)||(o&&o.to==p&&o.mark.eq(m[S])?o.to=k:s.push(o=new nt(p,k,m[S])));a&&a.to==p?a.to=k:r.push(a=new wt(p,k,n))}}),s.forEach(l=>i.step(l)),r.forEach(l=>i.step(l))}function Nh(i,e,t,n){let s=[],r=0;i.doc.nodesBetween(e,t,(o,a)=>{if(!o.isInline)return;r++;let l=null;if(n instanceof ei){let d=o.marks,u;for(;u=n.isInSet(d);)(l||(l=[])).push(u),d=u.removeFromSet(d)}else n?n.isInSet(o.marks)&&(l=[n]):l=o.marks;if(l&&l.length){let d=Math.min(a+o.nodeSize,t);for(let u=0;u<l.length;u++){let m=l[u],p;for(let k=0;k<s.length;k++){let y=s[k];y.step==r-1&&m.eq(s[k].style)&&(p=y)}p?(p.to=d,p.step=r):s.push({style:m,from:Math.max(a,e),to:d,step:r})}}}),s.forEach(o=>i.step(new nt(o.from,o.to,o.style)))}function Ro(i,e,t,n=t.contentMatch,s=!0){let r=i.doc.nodeAt(e),o=[],a=e+1;for(let l=0;l<r.childCount;l++){let d=r.child(l),u=a+d.nodeSize,m=n.matchType(d.type);if(!m)o.push(new Ce(a,u,D.empty));else{n=m;for(let p=0;p<d.marks.length;p++)t.allowsMarkType(d.marks[p].type)||i.step(new nt(a,u,d.marks[p]));if(s&&d.isText&&t.whitespace!="pre"){let p,k=/\r?\n|\r/g,y;for(;p=k.exec(d.text);)y||(y=new D(N.from(t.schema.text(" ",t.allowedMarks(d.marks))),0,0)),o.push(new Ce(a+p.index,a+p.index+p[0].length,y))}}a=u}if(!n.validEnd){let l=n.fillBefore(N.empty,!0);i.replace(a,a,new D(l,0,0))}for(let l=o.length-1;l>=0;l--)i.step(o[l])}function _h(i,e,t){return(e==0||i.canReplace(e,i.childCount))&&(t==i.childCount||i.canReplace(0,t))}function Pm(i){let t=i.parent.content.cutByIndex(i.startIndex,i.endIndex);for(let n=i.depth;;--n){let s=i.$from.node(n),r=i.$from.index(n),o=i.$to.indexAfter(n);if(n<i.depth&&s.canReplace(r,o,t))return n;if(n==0||s.type.spec.isolating||!_h(s,r,o))break}return null}function Dh(i,e,t){let{$from:n,$to:s,depth:r}=e,o=n.before(r+1),a=s.after(r+1),l=o,d=a,u=N.empty,m=0;for(let y=r,S=!1;y>t;y--)S||n.index(y)>0?(S=!0,u=N.from(n.node(y).copy(u)),m++):l--;let p=N.empty,k=0;for(let y=r,S=!1;y>t;y--)S||s.after(y+1)<s.end(y)?(S=!0,p=N.from(s.node(y).copy(p)),k++):d++;i.step(new Ye(l,d,o,a,new D(u.append(p),m,k),u.size-m,!0))}function jm(i,e,t=null,n=i){let s=Oh(i,e),r=s&&Rh(n,e);return r?s.map(qs).concat({type:e,attrs:t}).concat(r.map(qs)):null}function qs(i){return{type:i,attrs:null}}function Oh(i,e){let{parent:t,startIndex:n,endIndex:s}=i,r=t.contentMatchAt(n).findWrapping(e);if(!r)return null;let o=r.length?r[0]:e;return t.canReplaceWith(n,s,o)?r:null}function Rh(i,e){let{parent:t,startIndex:n,endIndex:s}=i,r=t.child(n),o=e.contentMatch.findWrapping(r.type);if(!o)return null;let l=(o.length?o[o.length-1]:e).contentMatch;for(let d=n;l&&d<s;d++)l=l.matchType(t.child(d).type);return!l||!l.validEnd?null:o}function Ah(i,e,t){let n=N.empty;for(let o=t.length-1;o>=0;o--){if(n.size){let a=t[o].type.contentMatch.matchFragment(n);if(!a||!a.validEnd)throw new RangeError("Wrapper type given to Transform.wrap does not form valid content of its parent wrapper")}n=N.from(t[o].type.create(t[o].attrs,n))}let s=e.start,r=e.end;i.step(new Ye(s,r,s,r,new D(n,0,0),t.length,!0))}function vh(i,e,t,n,s){if(!n.isTextblock)throw new RangeError("Type given to setBlockType should be a textblock");let r=i.steps.length;i.doc.nodesBetween(e,t,(o,a)=>{if(o.isTextblock&&!o.hasMarkup(n,s)&&Ph(i.doc,i.mapping.slice(r).map(a),n)){let l=null;if(n.schema.linebreakReplacement){let p=n.whitespace=="pre",k=!!n.contentMatch.matchType(n.schema.linebreakReplacement);p&&!k?l=!1:!p&&k&&(l=!0)}l===!1&&Fh(i,o,a,r),Ro(i,i.mapping.slice(r).map(a,1),n,void 0,l===null);let d=i.mapping.slice(r),u=d.map(a,1),m=d.map(a+o.nodeSize,1);return i.step(new Ye(u,m,u+1,m-1,new D(N.from(n.create(s,null,o.marks)),0,0),1,!0)),l===!0&&Bh(i,o,a,r),!1}})}function Bh(i,e,t,n){e.forEach((s,r)=>{if(s.isText){let o,a=/\r?\n|\r/g;for(;o=a.exec(s.text);){let l=i.mapping.slice(n).map(t+1+r+o.index);i.replaceWith(l,l+1,e.type.schema.linebreakReplacement.create())}}})}function Fh(i,e,t,n){e.forEach((s,r)=>{if(s.type==s.type.schema.linebreakReplacement){let o=i.mapping.slice(n).map(t+1+r);i.replaceWith(o,o+1,e.type.schema.text(`
`))}})}function Ph(i,e,t){let n=i.resolve(e),s=n.index();return n.parent.canReplaceWith(s,s+1,t)}function jh(i,e,t,n,s){let r=i.doc.nodeAt(e);if(!r)throw new RangeError("No node at given position");t||(t=r.type);let o=t.create(n,null,s||r.marks);if(r.isLeaf)return i.replaceWith(e,e+r.nodeSize,o);if(!t.validContent(r.content))throw new RangeError("Invalid content for node type "+t.name);i.step(new Ye(e,e+r.nodeSize,e+1,e+r.nodeSize-1,new D(N.from(o),0,0),1,!0))}function Lm(i,e,t=1,n){let s=i.resolve(e),r=s.depth-t,o=n&&n[n.length-1]||s.parent;if(r<0||s.parent.type.spec.isolating||!s.parent.canReplace(s.index(),s.parent.childCount)||!o.type.validContent(s.parent.content.cutByIndex(s.index(),s.parent.childCount)))return!1;for(let d=s.depth-1,u=t-2;d>r;d--,u--){let m=s.node(d),p=s.index(d);if(m.type.spec.isolating)return!1;let k=m.content.cutByIndex(p,m.childCount),y=n&&n[u+1];y&&(k=k.replaceChild(0,y.type.create(y.attrs)));let S=n&&n[u]||m;if(!m.canReplace(p+1,m.childCount)||!S.type.validContent(k))return!1}let a=s.indexAfter(r),l=n&&n[0];return s.node(r).canReplaceWith(a,a,l?l.type:s.node(r+1).type)}function Lh(i,e,t=1,n){let s=i.doc.resolve(e),r=N.empty,o=N.empty;for(let a=s.depth,l=s.depth-t,d=t-1;a>l;a--,d--){r=N.from(s.node(a).copy(r));let u=n&&n[d];o=N.from(u?u.type.create(u.attrs,o):s.node(a).copy(o))}i.step(new Ce(e,e,new D(r.append(o),t,t),!0))}function zm(i,e){let t=i.resolve(e),n=t.index();return zh(t.nodeBefore,t.nodeAfter)&&t.parent.canReplace(n,n+1)}function zh(i,e){return!!(i&&e&&!i.isLeaf&&i.canAppend(e))}function Vh(i,e,t){let n=new Ce(e-t,e+t,D.empty,!0);i.step(n)}function Uh(i,e,t){let n=i.resolve(e);if(n.parent.canReplaceWith(n.index(),n.index(),t))return e;if(n.parentOffset==0)for(let s=n.depth-1;s>=0;s--){let r=n.index(s);if(n.node(s).canReplaceWith(r,r,t))return n.before(s+1);if(r>0)return null}if(n.parentOffset==n.parent.content.size)for(let s=n.depth-1;s>=0;s--){let r=n.indexAfter(s);if(n.node(s).canReplaceWith(r,r,t))return n.after(s+1);if(r<n.node(s).childCount)return null}return null}function qh(i,e,t){let n=i.resolve(e);if(!t.content.size)return e;let s=t.content;for(let r=0;r<t.openStart;r++)s=s.firstChild.content;for(let r=1;r<=(t.openStart==0&&t.size?2:1);r++)for(let o=n.depth;o>=0;o--){let a=o==n.depth?0:n.pos<=(n.start(o+1)+n.end(o+1))/2?-1:1,l=n.index(o)+(a>0?1:0),d=n.node(o),u=!1;if(r==1)u=d.canReplace(l,l,s);else{let m=d.contentMatchAt(l).findWrapping(s.firstChild.type);u=m&&d.canReplaceWith(l,l,m[0])}if(u)return a==0?n.pos:a<0?n.before(o+1):n.after(o+1)}return null}function Wh(i,e,t=e,n=D.empty){if(e==t&&!n.size)return null;let s=i.resolve(e),r=i.resolve(t);return Ao(s,r,n)?new Ce(e,t,n):new Hh(s,r,n).fit()}function Ao(i,e,t){return!t.openStart&&!t.openEnd&&i.start()==e.start()&&i.parent.canReplace(i.index(),e.index(),t.content)}class Hh{constructor(e,t,n){this.$from=e,this.$to=t,this.unplaced=n,this.frontier=[],this.placed=N.empty;for(let s=0;s<=e.depth;s++){let r=e.node(s);this.frontier.push({type:r.type,match:r.contentMatchAt(e.indexAfter(s))})}for(let s=e.depth;s>0;s--)this.placed=N.from(e.node(s).copy(this.placed))}get depth(){return this.frontier.length-1}fit(){for(;this.unplaced.size;){let d=this.findFittable();d?this.placeNodes(d):this.openMore()||this.dropNode()}let e=this.mustMoveInline(),t=this.placed.size-this.depth-this.$from.depth,n=this.$from,s=this.close(e<0?this.$to:n.doc.resolve(e));if(!s)return null;let r=this.placed,o=n.depth,a=s.depth;for(;o&&a&&r.childCount==1;)r=r.firstChild.content,o--,a--;let l=new D(r,o,a);return e>-1?new Ye(n.pos,e,this.$to.pos,this.$to.end(),l,t):l.size||n.pos!=this.$to.pos?new Ce(n.pos,s.pos,l):null}findFittable(){let e=this.unplaced.openStart;for(let t=this.unplaced.content,n=0,s=this.unplaced.openEnd;n<e;n++){let r=t.firstChild;if(t.childCount>1&&(s=0),r.type.spec.isolating&&s<=n){e=n;break}t=r.content}for(let t=1;t<=2;t++)for(let n=t==1?e:this.unplaced.openStart;n>=0;n--){let s,r=null;n?(r=fi(this.unplaced.content,n-1).firstChild,s=r.content):s=this.unplaced.content;let o=s.firstChild;for(let a=this.depth;a>=0;a--){let{type:l,match:d}=this.frontier[a],u,m=null;if(t==1&&(o?d.matchType(o.type)||(m=d.fillBefore(N.from(o),!1)):r&&l.compatibleContent(r.type)))return{sliceDepth:n,frontierDepth:a,parent:r,inject:m};if(t==2&&o&&(u=d.findWrapping(o.type)))return{sliceDepth:n,frontierDepth:a,parent:r,wrap:u};if(r&&d.matchType(r.type))break}}}openMore(){let{content:e,openStart:t,openEnd:n}=this.unplaced,s=fi(e,t);return!s.childCount||s.firstChild.isLeaf?!1:(this.unplaced=new D(e,t+1,Math.max(n,s.size+t>=e.size-n?t+1:0)),!0)}dropNode(){let{content:e,openStart:t,openEnd:n}=this.unplaced,s=fi(e,t);if(s.childCount<=1&&t>0){let r=e.size-t<=t+s.size;this.unplaced=new D(rn(e,t-1,1),t-1,r?t-1:n)}else this.unplaced=new D(rn(e,t,1),t,n)}placeNodes({sliceDepth:e,frontierDepth:t,parent:n,inject:s,wrap:r}){for(;this.depth>t;)this.closeFrontierNode();if(r)for(let S=0;S<r.length;S++)this.openFrontierNode(r[S]);let o=this.unplaced,a=n?n.content:o.content,l=o.openStart-e,d=0,u=[],{match:m,type:p}=this.frontier[t];if(s){for(let S=0;S<s.childCount;S++)u.push(s.child(S));m=m.matchFragment(s)}let k=a.size+e-(o.content.size-o.openEnd);for(;d<a.childCount;){let S=a.child(d),w=m.matchType(S.type);if(!w)break;d++,(d>1||l==0||S.content.size)&&(m=w,u.push(vo(S.mark(p.allowedMarks(S.marks)),d==1?l:0,d==a.childCount?k:-1)))}let y=d==a.childCount;y||(k=-1),this.placed=on(this.placed,t,N.from(u)),this.frontier[t].match=m,y&&k<0&&n&&n.type==this.frontier[this.depth].type&&this.frontier.length>1&&this.closeFrontierNode();for(let S=0,w=a;S<k;S++){let E=w.lastChild;this.frontier.push({type:E.type,match:E.contentMatchAt(E.childCount)}),w=E.content}this.unplaced=y?e==0?D.empty:new D(rn(o.content,e-1,1),e-1,k<0?o.openEnd:e-1):new D(rn(o.content,e,d),o.openStart,o.openEnd)}mustMoveInline(){if(!this.$to.parent.isTextblock)return-1;let e=this.frontier[this.depth],t;if(!e.type.isTextblock||!pi(this.$to,this.$to.depth,e.type,e.match,!1)||this.$to.depth==this.depth&&(t=this.findCloseLevel(this.$to))&&t.depth==this.depth)return-1;let{depth:n}=this.$to,s=this.$to.after(n);for(;n>1&&s==this.$to.end(--n);)++s;return s}findCloseLevel(e){e:for(let t=Math.min(this.depth,e.depth);t>=0;t--){let{match:n,type:s}=this.frontier[t],r=t<e.depth&&e.end(t+1)==e.pos+(e.depth-(t+1)),o=pi(e,t,s,n,r);if(o){for(let a=t-1;a>=0;a--){let{match:l,type:d}=this.frontier[a],u=pi(e,a,d,l,!0);if(!u||u.childCount)continue e}return{depth:t,fit:o,move:r?e.doc.resolve(e.after(t+1)):e}}}}close(e){let t=this.findCloseLevel(e);if(!t)return null;for(;this.depth>t.depth;)this.closeFrontierNode();t.fit.childCount&&(this.placed=on(this.placed,t.depth,t.fit)),e=t.move;for(let n=t.depth+1;n<=e.depth;n++){let s=e.node(n),r=s.type.contentMatch.fillBefore(s.content,!0,e.index(n));this.openFrontierNode(s.type,s.attrs,r)}return e}openFrontierNode(e,t=null,n){let s=this.frontier[this.depth];s.match=s.match.matchType(e),this.placed=on(this.placed,this.depth,N.from(e.create(t,n))),this.frontier.push({type:e,match:e.contentMatch})}closeFrontierNode(){let t=this.frontier.pop().match.fillBefore(N.empty,!0);t.childCount&&(this.placed=on(this.placed,this.frontier.length,t))}}function rn(i,e,t){return e==0?i.cutByIndex(t,i.childCount):i.replaceChild(0,i.firstChild.copy(rn(i.firstChild.content,e-1,t)))}function on(i,e,t){return e==0?i.append(t):i.replaceChild(i.childCount-1,i.lastChild.copy(on(i.lastChild.content,e-1,t)))}function fi(i,e){for(let t=0;t<e;t++)i=i.firstChild.content;return i}function vo(i,e,t){if(e<=0)return i;let n=i.content;return e>1&&(n=n.replaceChild(0,vo(n.firstChild,e-1,n.childCount==1?t-1:0))),e>0&&(n=i.type.contentMatch.fillBefore(n).append(n),t<=0&&(n=n.append(i.type.contentMatch.matchFragment(n).fillBefore(N.empty,!0)))),i.copy(n)}function pi(i,e,t,n,s){let r=i.node(e),o=s?i.indexAfter(e):i.index(e);if(o==r.childCount&&!t.compatibleContent(r.type))return null;let a=n.fillBefore(r.content,!0,o);return a&&!Jh(t,r.content,o)?a:null}function Jh(i,e,t){for(let n=t;n<e.childCount;n++)if(!i.allowsMarks(e.child(n).marks))return!0;return!1}function $h(i){return i.spec.defining||i.spec.definingForContent}function Gh(i,e,t,n){if(!n.size)return i.deleteRange(e,t);let s=i.doc.resolve(e),r=i.doc.resolve(t);if(Ao(s,r,n))return i.step(new Ce(e,t,n));let o=Fo(s,i.doc.resolve(t));o[o.length-1]==0&&o.pop();let a=-(s.depth+1);o.unshift(a);for(let p=s.depth,k=s.pos-1;p>0;p--,k--){let y=s.node(p).type.spec;if(y.defining||y.definingAsContext||y.isolating)break;o.indexOf(p)>-1?a=p:s.before(p)==k&&o.splice(1,0,-p)}let l=o.indexOf(a),d=[],u=n.openStart;for(let p=n.content,k=0;;k++){let y=p.firstChild;if(d.push(y),k==n.openStart)break;p=y.content}for(let p=u-1;p>=0;p--){let k=d[p],y=$h(k.type);if(y&&!k.sameMarkup(s.node(Math.abs(a)-1)))u=p;else if(y||!k.type.isTextblock)break}for(let p=n.openStart;p>=0;p--){let k=(p+u+1)%(n.openStart+1),y=d[k];if(y)for(let S=0;S<o.length;S++){let w=o[(S+l)%o.length],E=!0;w<0&&(E=!1,w=-w);let _=s.node(w-1),L=s.index(w-1);if(_.canReplaceWith(L,L,y.type,y.marks))return i.replace(s.before(w),E?r.after(w):t,new D(Bo(n.content,0,n.openStart,k),k,n.openEnd))}}let m=i.steps.length;for(let p=o.length-1;p>=0&&(i.replace(e,t,n),!(i.steps.length>m));p--){let k=o[p];k<0||(e=s.before(k),t=r.after(k))}}function Bo(i,e,t,n,s){if(e<t){let r=i.firstChild;i=i.replaceChild(0,r.copy(Bo(r.content,e+1,t,n,r)))}if(e>n){let r=s.contentMatchAt(0),o=r.fillBefore(i).append(i);i=o.append(r.matchFragment(o).fillBefore(N.empty,!0))}return i}function Kh(i,e,t,n){if(!n.isInline&&e==t&&i.doc.resolve(e).parent.content.size){let s=Uh(i.doc,e,n.type);s!=null&&(e=t=s)}i.replaceRange(e,t,new D(N.from(n),0,0))}function Yh(i,e,t){let n=i.doc.resolve(e),s=i.doc.resolve(t),r=Fo(n,s);for(let o=0;o<r.length;o++){let a=r[o],l=o==r.length-1;if(l&&a==0||n.node(a).type.contentMatch.validEnd)return i.delete(n.start(a),s.end(a));if(a>0&&(l||n.node(a-1).canReplace(n.index(a-1),s.indexAfter(a-1))))return i.delete(n.before(a),s.after(a))}for(let o=1;o<=n.depth&&o<=s.depth;o++)if(e-n.start(o)==n.depth-o&&t>n.end(o)&&s.end(o)-t!=s.depth-o)return i.delete(n.before(o),t);i.delete(e,t)}function Fo(i,e){let t=[],n=Math.min(i.depth,e.depth);for(let s=n;s>=0;s--){let r=i.start(s);if(r<i.pos-(i.depth-s)||e.end(s)>e.pos+(e.depth-s)||i.node(s).type.spec.isolating||e.node(s).type.spec.isolating)break;(r==e.start(s)||s==i.depth&&s==e.depth&&i.parent.inlineContent&&e.parent.inlineContent&&s&&e.start(s-1)==r-1)&&t.push(s)}return t}class Kt extends Me{constructor(e,t,n){super(),this.pos=e,this.attr=t,this.value=n}apply(e){let t=e.nodeAt(this.pos);if(!t)return de.fail("No node at attribute step's position");let n=Object.create(null);for(let r in t.attrs)n[r]=t.attrs[r];n[this.attr]=this.value;let s=t.type.create(n,null,t.marks);return de.fromReplace(e,this.pos,this.pos+1,new D(N.from(s),0,t.isLeaf?0:1))}getMap(){return Le.empty}invert(e){return new Kt(this.pos,this.attr,e.nodeAt(this.pos).attrs[this.attr])}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new Kt(t.pos,this.attr,this.value)}toJSON(){return{stepType:"attr",pos:this.pos,attr:this.attr,value:this.value}}static fromJSON(e,t){if(typeof t.pos!="number"||typeof t.attr!="string")throw new RangeError("Invalid input for AttrStep.fromJSON");return new Kt(t.pos,t.attr,t.value)}}Me.jsonID("attr",Kt);class kn extends Me{constructor(e,t){super(),this.attr=e,this.value=t}apply(e){let t=Object.create(null);for(let s in e.attrs)t[s]=e.attrs[s];t[this.attr]=this.value;let n=e.type.create(t,e.content,e.marks);return de.ok(n)}getMap(){return Le.empty}invert(e){return new kn(this.attr,e.attrs[this.attr])}map(e){return this}toJSON(){return{stepType:"docAttr",attr:this.attr,value:this.value}}static fromJSON(e,t){if(typeof t.attr!="string")throw new RangeError("Invalid input for DocAttrStep.fromJSON");return new kn(t.attr,t.value)}}Me.jsonID("docAttr",kn);let en=class extends Error{};en=function i(e){let t=Error.call(this,e);return t.__proto__=i.prototype,t};en.prototype=Object.create(Error.prototype);en.prototype.constructor=en;en.prototype.name="TransformError";class Zh{constructor(e){this.doc=e,this.steps=[],this.docs=[],this.mapping=new fn}get before(){return this.docs.length?this.docs[0]:this.doc}step(e){let t=this.maybeStep(e);if(t.failed)throw new en(t.failed);return this}maybeStep(e){let t=e.apply(this.doc);return t.failed||this.addStep(e,t.doc),t}get docChanged(){return this.steps.length>0}addStep(e,t){this.docs.push(this.doc),this.steps.push(e),this.mapping.appendMap(e.getMap()),this.doc=t}replace(e,t=e,n=D.empty){let s=Wh(this.doc,e,t,n);return s&&this.step(s),this}replaceWith(e,t,n){return this.replace(e,t,new D(N.from(n),0,0))}delete(e,t){return this.replace(e,t,D.empty)}insert(e,t){return this.replaceWith(e,e,t)}replaceRange(e,t,n){return Gh(this,e,t,n),this}replaceRangeWith(e,t,n){return Kh(this,e,t,n),this}deleteRange(e,t){return Yh(this,e,t),this}lift(e,t){return Dh(this,e,t),this}join(e,t=1){return Vh(this,e,t),this}wrap(e,t){return Ah(this,e,t),this}setBlockType(e,t=e,n,s=null){return vh(this,e,t,n,s),this}setNodeMarkup(e,t,n=null,s){return jh(this,e,t,n,s),this}setNodeAttribute(e,t,n){return this.step(new Kt(e,t,n)),this}setDocAttribute(e,t){return this.step(new kn(e,t)),this}addNodeMark(e,t){return this.step(new St(e,t)),this}removeNodeMark(e,t){if(!(t instanceof G)){let n=this.doc.nodeAt(e);if(!n)throw new RangeError("No node at position "+e);if(t=t.isInSet(n.marks),!t)return this}return this.step(new Xt(e,t)),this}split(e,t=1,n){return Lh(this,e,t,n),this}addMark(e,t,n){return Ih(this,e,t,n),this}removeMark(e,t,n){return Nh(this,e,t,n),this}clearIncompatible(e,t,n){return Ro(this,e,t,n),this}}const mi=Object.create(null);class Q{constructor(e,t,n){this.$anchor=e,this.$head=t,this.ranges=n||[new Qh(e.min(t),e.max(t))]}get anchor(){return this.$anchor.pos}get head(){return this.$head.pos}get from(){return this.$from.pos}get to(){return this.$to.pos}get $from(){return this.ranges[0].$from}get $to(){return this.ranges[0].$to}get empty(){let e=this.ranges;for(let t=0;t<e.length;t++)if(e[t].$from.pos!=e[t].$to.pos)return!1;return!0}content(){return this.$from.doc.slice(this.from,this.to,!0)}replace(e,t=D.empty){let n=t.content.lastChild,s=null;for(let a=0;a<t.openEnd;a++)s=n,n=n.lastChild;let r=e.steps.length,o=this.ranges;for(let a=0;a<o.length;a++){let{$from:l,$to:d}=o[a],u=e.mapping.slice(r);e.replaceRange(u.map(l.pos),u.map(d.pos),a?D.empty:t),a==0&&Js(e,r,(n?n.isInline:s&&s.isTextblock)?-1:1)}}replaceWith(e,t){let n=e.steps.length,s=this.ranges;for(let r=0;r<s.length;r++){let{$from:o,$to:a}=s[r],l=e.mapping.slice(n),d=l.map(o.pos),u=l.map(a.pos);r?e.deleteRange(d,u):(e.replaceRangeWith(d,u,t),Js(e,n,t.isInline?-1:1))}}static findFrom(e,t,n=!1){let s=e.parent.inlineContent?new ie(e):$t(e.node(0),e.parent,e.pos,e.index(),t,n);if(s)return s;for(let r=e.depth-1;r>=0;r--){let o=t<0?$t(e.node(0),e.node(r),e.before(r+1),e.index(r),t,n):$t(e.node(0),e.node(r),e.after(r+1),e.index(r)+1,t,n);if(o)return o}return null}static near(e,t=1){return this.findFrom(e,t)||this.findFrom(e,-t)||new st(e.node(0))}static atStart(e){return $t(e,e,0,0,1)||new st(e)}static atEnd(e){return $t(e,e,e.content.size,e.childCount,-1)||new st(e)}static fromJSON(e,t){if(!t||!t.type)throw new RangeError("Invalid input for Selection.fromJSON");let n=mi[t.type];if(!n)throw new RangeError(`No selection type ${t.type} defined`);return n.fromJSON(e,t)}static jsonID(e,t){if(e in mi)throw new RangeError("Duplicate use of selection JSON ID "+e);return mi[e]=t,t.prototype.jsonID=e,t}getBookmark(){return ie.between(this.$anchor,this.$head).getBookmark()}}Q.prototype.visible=!0;class Qh{constructor(e,t){this.$from=e,this.$to=t}}let Ws=!1;function Hs(i){!Ws&&!i.parent.inlineContent&&(Ws=!0,console.warn("TextSelection endpoint not pointing into a node with inline content ("+i.parent.type.name+")"))}class ie extends Q{constructor(e,t=e){Hs(e),Hs(t),super(e,t)}get $cursor(){return this.$anchor.pos==this.$head.pos?this.$head:null}map(e,t){let n=e.resolve(t.map(this.head));if(!n.parent.inlineContent)return Q.near(n);let s=e.resolve(t.map(this.anchor));return new ie(s.parent.inlineContent?s:n,n)}replace(e,t=D.empty){if(super.replace(e,t),t==D.empty){let n=this.$from.marksAcross(this.$to);n&&e.ensureMarks(n)}}eq(e){return e instanceof ie&&e.anchor==this.anchor&&e.head==this.head}getBookmark(){return new ti(this.anchor,this.head)}toJSON(){return{type:"text",anchor:this.anchor,head:this.head}}static fromJSON(e,t){if(typeof t.anchor!="number"||typeof t.head!="number")throw new RangeError("Invalid input for TextSelection.fromJSON");return new ie(e.resolve(t.anchor),e.resolve(t.head))}static create(e,t,n=t){let s=e.resolve(t);return new this(s,n==t?s:e.resolve(n))}static between(e,t,n){let s=e.pos-t.pos;if((!n||s)&&(n=s>=0?1:-1),!t.parent.inlineContent){let r=Q.findFrom(t,n,!0)||Q.findFrom(t,-n,!0);if(r)t=r.$head;else return Q.near(t,n)}return e.parent.inlineContent||(s==0?e=t:(e=(Q.findFrom(e,-n,!0)||Q.findFrom(e,n,!0)).$anchor,e.pos<t.pos!=s<0&&(e=t))),new ie(e,t)}}Q.jsonID("text",ie);class ti{constructor(e,t){this.anchor=e,this.head=t}map(e){return new ti(e.map(this.anchor),e.map(this.head))}resolve(e){return ie.between(e.resolve(this.anchor),e.resolve(this.head))}}class W extends Q{constructor(e){let t=e.nodeAfter,n=e.node(0).resolve(e.pos+t.nodeSize);super(e,n),this.node=t}map(e,t){let{deleted:n,pos:s}=t.mapResult(this.anchor),r=e.resolve(s);return n?Q.near(r):new W(r)}content(){return new D(N.from(this.node),0,0)}eq(e){return e instanceof W&&e.anchor==this.anchor}toJSON(){return{type:"node",anchor:this.anchor}}getBookmark(){return new os(this.anchor)}static fromJSON(e,t){if(typeof t.anchor!="number")throw new RangeError("Invalid input for NodeSelection.fromJSON");return new W(e.resolve(t.anchor))}static create(e,t){return new W(e.resolve(t))}static isSelectable(e){return!e.isText&&e.type.spec.selectable!==!1}}W.prototype.visible=!1;Q.jsonID("node",W);class os{constructor(e){this.anchor=e}map(e){let{deleted:t,pos:n}=e.mapResult(this.anchor);return t?new ti(n,n):new os(n)}resolve(e){let t=e.resolve(this.anchor),n=t.nodeAfter;return n&&W.isSelectable(n)?new W(t):Q.near(t)}}class st extends Q{constructor(e){super(e.resolve(0),e.resolve(e.content.size))}replace(e,t=D.empty){if(t==D.empty){e.delete(0,e.doc.content.size);let n=Q.atStart(e.doc);n.eq(e.selection)||e.setSelection(n)}else super.replace(e,t)}toJSON(){return{type:"all"}}static fromJSON(e){return new st(e)}map(e){return new st(e)}eq(e){return e instanceof st}getBookmark(){return Xh}}Q.jsonID("all",st);const Xh={map(){return this},resolve(i){return new st(i)}};function $t(i,e,t,n,s,r=!1){if(e.inlineContent)return ie.create(i,t);for(let o=n-(s>0?0:1);s>0?o<e.childCount:o>=0;o+=s){let a=e.child(o);if(a.isAtom){if(!r&&W.isSelectable(a))return W.create(i,t-(s<0?a.nodeSize:0))}else{let l=$t(i,a,t+s,s<0?a.childCount:0,s,r);if(l)return l}t+=a.nodeSize*s}return null}function Js(i,e,t){let n=i.steps.length-1;if(n<e)return;let s=i.steps[n];if(!(s instanceof Ce||s instanceof Ye))return;let r=i.mapping.maps[n],o;r.forEach((a,l,d,u)=>{o==null&&(o=u)}),i.setSelection(Q.near(i.doc.resolve(o),t))}const $s=1,On=2,Gs=4;class eu extends Zh{constructor(e){super(e.doc),this.curSelectionFor=0,this.updated=0,this.meta=Object.create(null),this.time=Date.now(),this.curSelection=e.selection,this.storedMarks=e.storedMarks}get selection(){return this.curSelectionFor<this.steps.length&&(this.curSelection=this.curSelection.map(this.doc,this.mapping.slice(this.curSelectionFor)),this.curSelectionFor=this.steps.length),this.curSelection}setSelection(e){if(e.$from.doc!=this.doc)throw new RangeError("Selection passed to setSelection must point at the current document");return this.curSelection=e,this.curSelectionFor=this.steps.length,this.updated=(this.updated|$s)&~On,this.storedMarks=null,this}get selectionSet(){return(this.updated&$s)>0}setStoredMarks(e){return this.storedMarks=e,this.updated|=On,this}ensureMarks(e){return G.sameSet(this.storedMarks||this.selection.$from.marks(),e)||this.setStoredMarks(e),this}addStoredMark(e){return this.ensureMarks(e.addToSet(this.storedMarks||this.selection.$head.marks()))}removeStoredMark(e){return this.ensureMarks(e.removeFromSet(this.storedMarks||this.selection.$head.marks()))}get storedMarksSet(){return(this.updated&On)>0}addStep(e,t){super.addStep(e,t),this.updated=this.updated&~On,this.storedMarks=null}setTime(e){return this.time=e,this}replaceSelection(e){return this.selection.replace(this,e),this}replaceSelectionWith(e,t=!0){let n=this.selection;return t&&(e=e.mark(this.storedMarks||(n.empty?n.$from.marks():n.$from.marksAcross(n.$to)||G.none))),n.replaceWith(this,e),this}deleteSelection(){return this.selection.replace(this),this}insertText(e,t,n){let s=this.doc.type.schema;if(t==null)return e?this.replaceSelectionWith(s.text(e),!0):this.deleteSelection();{if(n==null&&(n=t),n=n??t,!e)return this.deleteRange(t,n);let r=this.storedMarks;if(!r){let o=this.doc.resolve(t);r=n==t?o.marks():o.marksAcross(this.doc.resolve(n))}return this.replaceRangeWith(t,n,s.text(e,r)),this.selection.empty||this.setSelection(Q.near(this.selection.$to)),this}}setMeta(e,t){return this.meta[typeof e=="string"?e:e.key]=t,this}getMeta(e){return this.meta[typeof e=="string"?e:e.key]}get isGeneric(){for(let e in this.meta)return!1;return!0}scrollIntoView(){return this.updated|=Gs,this}get scrolledIntoView(){return(this.updated&Gs)>0}}function Ks(i,e){return!e||!i?i:i.bind(e)}class an{constructor(e,t,n){this.name=e,this.init=Ks(t.init,n),this.apply=Ks(t.apply,n)}}const tu=[new an("doc",{init(i){return i.doc||i.schema.topNodeType.createAndFill()},apply(i){return i.doc}}),new an("selection",{init(i,e){return i.selection||Q.atStart(e.doc)},apply(i){return i.selection}}),new an("storedMarks",{init(i){return i.storedMarks||null},apply(i,e,t,n){return n.selection.$cursor?i.storedMarks:null}}),new an("scrollToSelection",{init(){return 0},apply(i,e){return i.scrolledIntoView?e+1:e}})];class gi{constructor(e,t){this.schema=e,this.plugins=[],this.pluginsByKey=Object.create(null),this.fields=tu.slice(),t&&t.forEach(n=>{if(this.pluginsByKey[n.key])throw new RangeError("Adding different instances of a keyed plugin ("+n.key+")");this.plugins.push(n),this.pluginsByKey[n.key]=n,n.spec.state&&this.fields.push(new an(n.key,n.spec.state,n))})}}class ln{constructor(e){this.config=e}get schema(){return this.config.schema}get plugins(){return this.config.plugins}apply(e){return this.applyTransaction(e).state}filterTransaction(e,t=-1){for(let n=0;n<this.config.plugins.length;n++)if(n!=t){let s=this.config.plugins[n];if(s.spec.filterTransaction&&!s.spec.filterTransaction.call(s,e,this))return!1}return!0}applyTransaction(e){if(!this.filterTransaction(e))return{state:this,transactions:[]};let t=[e],n=this.applyInner(e),s=null;for(;;){let r=!1;for(let o=0;o<this.config.plugins.length;o++){let a=this.config.plugins[o];if(a.spec.appendTransaction){let l=s?s[o].n:0,d=s?s[o].state:this,u=l<t.length&&a.spec.appendTransaction.call(a,l?t.slice(l):t,d,n);if(u&&n.filterTransaction(u,o)){if(u.setMeta("appendedTransaction",e),!s){s=[];for(let m=0;m<this.config.plugins.length;m++)s.push(m<o?{state:n,n:t.length}:{state:this,n:0})}t.push(u),n=n.applyInner(u),r=!0}s&&(s[o]={state:n,n:t.length})}}if(!r)return{state:n,transactions:t}}}applyInner(e){if(!e.before.eq(this.doc))throw new RangeError("Applying a mismatched transaction");let t=new ln(this.config),n=this.config.fields;for(let s=0;s<n.length;s++){let r=n[s];t[r.name]=r.apply(e,this[r.name],this,t)}return t}get tr(){return new eu(this)}static create(e){let t=new gi(e.doc?e.doc.type.schema:e.schema,e.plugins),n=new ln(t);for(let s=0;s<t.fields.length;s++)n[t.fields[s].name]=t.fields[s].init(e,n);return n}reconfigure(e){let t=new gi(this.schema,e.plugins),n=t.fields,s=new ln(t);for(let r=0;r<n.length;r++){let o=n[r].name;s[o]=this.hasOwnProperty(o)?this[o]:n[r].init(e,s)}return s}toJSON(e){let t={doc:this.doc.toJSON(),selection:this.selection.toJSON()};if(this.storedMarks&&(t.storedMarks=this.storedMarks.map(n=>n.toJSON())),e&&typeof e=="object")for(let n in e){if(n=="doc"||n=="selection")throw new RangeError("The JSON fields `doc` and `selection` are reserved");let s=e[n],r=s.spec.state;r&&r.toJSON&&(t[n]=r.toJSON.call(s,this[s.key]))}return t}static fromJSON(e,t,n){if(!t)throw new RangeError("Invalid input for EditorState.fromJSON");if(!e.schema)throw new RangeError("Required config field 'schema' missing");let s=new gi(e.schema,e.plugins),r=new ln(s);return s.fields.forEach(o=>{if(o.name=="doc")r.doc=it.fromJSON(e.schema,t.doc);else if(o.name=="selection")r.selection=Q.fromJSON(r.doc,t.selection);else if(o.name=="storedMarks")t.storedMarks&&(r.storedMarks=t.storedMarks.map(e.schema.markFromJSON));else{if(n)for(let a in n){let l=n[a],d=l.spec.state;if(l.key==o.name&&d&&d.fromJSON&&Object.prototype.hasOwnProperty.call(t,a)){r[o.name]=d.fromJSON.call(l,e,t[a],r);return}}r[o.name]=o.init(e,r)}}),r}}function Po(i,e,t){for(let n in i){let s=i[n];s instanceof Function?s=s.bind(e):n=="handleDOMEvents"&&(s=Po(s,e,{})),t[n]=s}return t}class Vm{constructor(e){this.spec=e,this.props={},e.props&&Po(e.props,this,this.props),this.key=e.key?e.key.key:jo("plugin")}getState(e){return e[this.key]}}const yi=Object.create(null);function jo(i){return i in yi?i+"$"+ ++yi[i]:(yi[i]=0,i+"$")}class Um{constructor(e="key"){this.key=jo(e)}get(e){return e.config.pluginsByKey[this.key]}getState(e){return e[this.key]}}const ge=function(i){for(var e=0;;e++)if(i=i.previousSibling,!i)return e},bn=function(i){let e=i.assignedSlot||i.parentNode;return e&&e.nodeType==11?e.host:e};let Bi=null;const lt=function(i,e,t){let n=Bi||(Bi=document.createRange());return n.setEnd(i,t??i.nodeValue.length),n.setStart(i,e||0),n},nu=function(){Bi=null},zt=function(i,e,t,n){return t&&(Ys(i,e,t,n,-1)||Ys(i,e,t,n,1))},iu=/^(img|br|input|textarea|hr)$/i;function Ys(i,e,t,n,s){for(;;){if(i==t&&e==n)return!0;if(e==(s<0?0:tt(i))){let r=i.parentNode;if(!r||r.nodeType!=1||En(i)||iu.test(i.nodeName)||i.contentEditable=="false")return!1;e=ge(i)+(s<0?0:1),i=r}else if(i.nodeType==1){if(i=i.childNodes[e+(s<0?-1:0)],i.contentEditable=="false")return!1;e=s<0?tt(i):0}else return!1}}function tt(i){return i.nodeType==3?i.nodeValue.length:i.childNodes.length}function su(i,e){for(;;){if(i.nodeType==3&&e)return i;if(i.nodeType==1&&e>0){if(i.contentEditable=="false")return null;i=i.childNodes[e-1],e=tt(i)}else if(i.parentNode&&!En(i))e=ge(i),i=i.parentNode;else return null}}function ru(i,e){for(;;){if(i.nodeType==3&&e<i.nodeValue.length)return i;if(i.nodeType==1&&e<i.childNodes.length){if(i.contentEditable=="false")return null;i=i.childNodes[e],e=0}else if(i.parentNode&&!En(i))e=ge(i)+1,i=i.parentNode;else return null}}function ou(i,e,t){for(let n=e==0,s=e==tt(i);n||s;){if(i==t)return!0;let r=ge(i);if(i=i.parentNode,!i)return!1;n=n&&r==0,s=s&&r==tt(i)}}function En(i){let e;for(let t=i;t&&!(e=t.pmViewDesc);t=t.parentNode);return e&&e.node&&e.node.isBlock&&(e.dom==i||e.contentDOM==i)}const ni=function(i){return i.focusNode&&zt(i.focusNode,i.focusOffset,i.anchorNode,i.anchorOffset)};function Rt(i,e){let t=document.createEvent("Event");return t.initEvent("keydown",!0,!0),t.keyCode=i,t.key=t.code=e,t}function au(i){let e=i.activeElement;for(;e&&e.shadowRoot;)e=e.shadowRoot.activeElement;return e}function lu(i,e,t){if(i.caretPositionFromPoint)try{let n=i.caretPositionFromPoint(e,t);if(n)return{node:n.offsetNode,offset:n.offset}}catch{}if(i.caretRangeFromPoint){let n=i.caretRangeFromPoint(e,t);if(n)return{node:n.startContainer,offset:n.startOffset}}}const rt=typeof navigator<"u"?navigator:null,Zs=typeof document<"u"?document:null,_t=rt&&rt.userAgent||"",Fi=/Edge\/(\d+)/.exec(_t),Lo=/MSIE \d/.exec(_t),Pi=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(_t),Fe=!!(Lo||Pi||Fi),Et=Lo?document.documentMode:Pi?+Pi[1]:Fi?+Fi[1]:0,Ze=!Fe&&/gecko\/(\d+)/i.test(_t);Ze&&+(/Firefox\/(\d+)/.exec(_t)||[0,0])[1];const ji=!Fe&&/Chrome\/(\d+)/.exec(_t),Te=!!ji,zo=ji?+ji[1]:0,De=!Fe&&!!rt&&/Apple Computer/.test(rt.vendor),tn=De&&(/Mobile\/\w+/.test(_t)||!!rt&&rt.maxTouchPoints>2),Ue=tn||(rt?/Mac/.test(rt.platform):!1),cu=rt?/Win/.test(rt.platform):!1,$e=/Android \d/.test(_t),Mn=!!Zs&&"webkitFontSmoothing"in Zs.documentElement.style,du=Mn?+(/\bAppleWebKit\/(\d+)/.exec(navigator.userAgent)||[0,0])[1]:0;function hu(i){let e=i.defaultView&&i.defaultView.visualViewport;return e?{left:0,right:e.width,top:0,bottom:e.height}:{left:0,right:i.documentElement.clientWidth,top:0,bottom:i.documentElement.clientHeight}}function at(i,e){return typeof i=="number"?i:i[e]}function uu(i){let e=i.getBoundingClientRect(),t=e.width/i.offsetWidth||1,n=e.height/i.offsetHeight||1;return{left:e.left,right:e.left+i.clientWidth*t,top:e.top,bottom:e.top+i.clientHeight*n}}function Qs(i,e,t){let n=i.someProp("scrollThreshold")||0,s=i.someProp("scrollMargin")||5,r=i.dom.ownerDocument;for(let o=t||i.dom;o;o=bn(o)){if(o.nodeType!=1)continue;let a=o,l=a==r.body,d=l?hu(r):uu(a),u=0,m=0;if(e.top<d.top+at(n,"top")?m=-(d.top-e.top+at(s,"top")):e.bottom>d.bottom-at(n,"bottom")&&(m=e.bottom-e.top>d.bottom-d.top?e.top+at(s,"top")-d.top:e.bottom-d.bottom+at(s,"bottom")),e.left<d.left+at(n,"left")?u=-(d.left-e.left+at(s,"left")):e.right>d.right-at(n,"right")&&(u=e.right-d.right+at(s,"right")),u||m)if(l)r.defaultView.scrollBy(u,m);else{let p=a.scrollLeft,k=a.scrollTop;m&&(a.scrollTop+=m),u&&(a.scrollLeft+=u);let y=a.scrollLeft-p,S=a.scrollTop-k;e={left:e.left-y,top:e.top-S,right:e.right-y,bottom:e.bottom-S}}if(l||/^(fixed|sticky)$/.test(getComputedStyle(o).position))break}}function fu(i){let e=i.dom.getBoundingClientRect(),t=Math.max(0,e.top),n,s;for(let r=(e.left+e.right)/2,o=t+1;o<Math.min(innerHeight,e.bottom);o+=5){let a=i.root.elementFromPoint(r,o);if(!a||a==i.dom||!i.dom.contains(a))continue;let l=a.getBoundingClientRect();if(l.top>=t-20){n=a,s=l.top;break}}return{refDOM:n,refTop:s,stack:Vo(i.dom)}}function Vo(i){let e=[],t=i.ownerDocument;for(let n=i;n&&(e.push({dom:n,top:n.scrollTop,left:n.scrollLeft}),i!=t);n=bn(n));return e}function pu({refDOM:i,refTop:e,stack:t}){let n=i?i.getBoundingClientRect().top:0;Uo(t,n==0?0:n-e)}function Uo(i,e){for(let t=0;t<i.length;t++){let{dom:n,top:s,left:r}=i[t];n.scrollTop!=s+e&&(n.scrollTop=s+e),n.scrollLeft!=r&&(n.scrollLeft=r)}}let qt=null;function mu(i){if(i.setActive)return i.setActive();if(qt)return i.focus(qt);let e=Vo(i);i.focus(qt==null?{get preventScroll(){return qt={preventScroll:!0},!0}}:void 0),qt||(qt=!1,Uo(e,0))}function qo(i,e){let t,n=2e8,s,r=0,o=e.top,a=e.top,l,d;for(let u=i.firstChild,m=0;u;u=u.nextSibling,m++){let p;if(u.nodeType==1)p=u.getClientRects();else if(u.nodeType==3)p=lt(u).getClientRects();else continue;for(let k=0;k<p.length;k++){let y=p[k];if(y.top<=o&&y.bottom>=a){o=Math.max(y.bottom,o),a=Math.min(y.top,a);let S=y.left>e.left?y.left-e.left:y.right<e.left?e.left-y.right:0;if(S<n){t=u,n=S,s=S&&t.nodeType==3?{left:y.right<e.left?y.right:y.left,top:e.top}:e,u.nodeType==1&&S&&(r=m+(e.left>=(y.left+y.right)/2?1:0));continue}}else y.top>e.top&&!l&&y.left<=e.left&&y.right>=e.left&&(l=u,d={left:Math.max(y.left,Math.min(y.right,e.left)),top:y.top});!t&&(e.left>=y.right&&e.top>=y.top||e.left>=y.left&&e.top>=y.bottom)&&(r=m+1)}}return!t&&l&&(t=l,s=d,n=0),t&&t.nodeType==3?gu(t,s):!t||n&&t.nodeType==1?{node:i,offset:r}:qo(t,s)}function gu(i,e){let t=i.nodeValue.length,n=document.createRange();for(let s=0;s<t;s++){n.setEnd(i,s+1),n.setStart(i,s);let r=yt(n,1);if(r.top!=r.bottom&&as(e,r))return{node:i,offset:s+(e.left>=(r.left+r.right)/2?1:0)}}return{node:i,offset:0}}function as(i,e){return i.left>=e.left-1&&i.left<=e.right+1&&i.top>=e.top-1&&i.top<=e.bottom+1}function yu(i,e){let t=i.parentNode;return t&&/^li$/i.test(t.nodeName)&&e.left<i.getBoundingClientRect().left?t:i}function xu(i,e,t){let{node:n,offset:s}=qo(e,t),r=-1;if(n.nodeType==1&&!n.firstChild){let o=n.getBoundingClientRect();r=o.left!=o.right&&t.left>(o.left+o.right)/2?1:-1}return i.docView.posFromDOM(n,s,r)}function ku(i,e,t,n){let s=-1;for(let r=e,o=!1;r!=i.dom;){let a=i.docView.nearestDesc(r,!0);if(!a)return null;if(a.dom.nodeType==1&&(a.node.isBlock&&a.parent||!a.contentDOM)){let l=a.dom.getBoundingClientRect();if(a.node.isBlock&&a.parent&&(!o&&l.left>n.left||l.top>n.top?s=a.posBefore:(!o&&l.right<n.left||l.bottom<n.top)&&(s=a.posAfter),o=!0),!a.contentDOM&&s<0&&!a.node.isText)return(a.node.isBlock?n.top<(l.top+l.bottom)/2:n.left<(l.left+l.right)/2)?a.posBefore:a.posAfter}r=a.dom.parentNode}return s>-1?s:i.docView.posFromDOM(e,t,-1)}function Wo(i,e,t){let n=i.childNodes.length;if(n&&t.top<t.bottom)for(let s=Math.max(0,Math.min(n-1,Math.floor(n*(e.top-t.top)/(t.bottom-t.top))-2)),r=s;;){let o=i.childNodes[r];if(o.nodeType==1){let a=o.getClientRects();for(let l=0;l<a.length;l++){let d=a[l];if(as(e,d))return Wo(o,e,d)}}if((r=(r+1)%n)==s)break}return i}function bu(i,e){let t=i.dom.ownerDocument,n,s=0,r=lu(t,e.left,e.top);r&&({node:n,offset:s}=r);let o=(i.root.elementFromPoint?i.root:t).elementFromPoint(e.left,e.top),a;if(!o||!i.dom.contains(o.nodeType!=1?o.parentNode:o)){let d=i.dom.getBoundingClientRect();if(!as(e,d)||(o=Wo(i.dom,e,d),!o))return null}if(De)for(let d=o;n&&d;d=bn(d))d.draggable&&(n=void 0);if(o=yu(o,e),n){if(Ze&&n.nodeType==1&&(s=Math.min(s,n.childNodes.length),s<n.childNodes.length)){let u=n.childNodes[s],m;u.nodeName=="IMG"&&(m=u.getBoundingClientRect()).right<=e.left&&m.bottom>e.top&&s++}let d;Mn&&s&&n.nodeType==1&&(d=n.childNodes[s-1]).nodeType==1&&d.contentEditable=="false"&&d.getBoundingClientRect().top>=e.top&&s--,n==i.dom&&s==n.childNodes.length-1&&n.lastChild.nodeType==1&&e.top>n.lastChild.getBoundingClientRect().bottom?a=i.state.doc.content.size:(s==0||n.nodeType!=1||n.childNodes[s-1].nodeName!="BR")&&(a=ku(i,n,s,e))}a==null&&(a=xu(i,o,e));let l=i.docView.nearestDesc(o,!0);return{pos:a,inside:l?l.posAtStart-l.border:-1}}function Xs(i){return i.top<i.bottom||i.left<i.right}function yt(i,e){let t=i.getClientRects();if(t.length){let n=t[e<0?0:t.length-1];if(Xs(n))return n}return Array.prototype.find.call(t,Xs)||i.getBoundingClientRect()}const wu=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/;function Ho(i,e,t){let{node:n,offset:s,atom:r}=i.docView.domFromPos(e,t<0?-1:1),o=Mn||Ze;if(n.nodeType==3)if(o&&(wu.test(n.nodeValue)||(t<0?!s:s==n.nodeValue.length))){let l=yt(lt(n,s,s),t);if(Ze&&s&&/\s/.test(n.nodeValue[s-1])&&s<n.nodeValue.length){let d=yt(lt(n,s-1,s-1),-1);if(d.top==l.top){let u=yt(lt(n,s,s+1),-1);if(u.top!=l.top)return sn(u,u.left<d.left)}}return l}else{let l=s,d=s,u=t<0?1:-1;return t<0&&!s?(d++,u=-1):t>=0&&s==n.nodeValue.length?(l--,u=1):t<0?l--:d++,sn(yt(lt(n,l,d),u),u<0)}if(!i.state.doc.resolve(e-(r||0)).parent.inlineContent){if(r==null&&s&&(t<0||s==tt(n))){let l=n.childNodes[s-1];if(l.nodeType==1)return xi(l.getBoundingClientRect(),!1)}if(r==null&&s<tt(n)){let l=n.childNodes[s];if(l.nodeType==1)return xi(l.getBoundingClientRect(),!0)}return xi(n.getBoundingClientRect(),t>=0)}if(r==null&&s&&(t<0||s==tt(n))){let l=n.childNodes[s-1],d=l.nodeType==3?lt(l,tt(l)-(o?0:1)):l.nodeType==1&&(l.nodeName!="BR"||!l.nextSibling)?l:null;if(d)return sn(yt(d,1),!1)}if(r==null&&s<tt(n)){let l=n.childNodes[s];for(;l.pmViewDesc&&l.pmViewDesc.ignoreForCoords;)l=l.nextSibling;let d=l?l.nodeType==3?lt(l,0,o?0:1):l.nodeType==1?l:null:null;if(d)return sn(yt(d,-1),!0)}return sn(yt(n.nodeType==3?lt(n):n,-t),t>=0)}function sn(i,e){if(i.width==0)return i;let t=e?i.left:i.right;return{top:i.top,bottom:i.bottom,left:t,right:t}}function xi(i,e){if(i.height==0)return i;let t=e?i.top:i.bottom;return{top:t,bottom:t,left:i.left,right:i.right}}function Jo(i,e,t){let n=i.state,s=i.root.activeElement;n!=e&&i.updateState(e),s!=i.dom&&i.focus();try{return t()}finally{n!=e&&i.updateState(n),s!=i.dom&&s&&s.focus()}}function Su(i,e,t){let n=e.selection,s=t=="up"?n.$from:n.$to;return Jo(i,e,()=>{let{node:r}=i.docView.domFromPos(s.pos,t=="up"?-1:1);for(;;){let a=i.docView.nearestDesc(r,!0);if(!a)break;if(a.node.isBlock){r=a.contentDOM||a.dom;break}r=a.dom.parentNode}let o=Ho(i,s.pos,1);for(let a=r.firstChild;a;a=a.nextSibling){let l;if(a.nodeType==1)l=a.getClientRects();else if(a.nodeType==3)l=lt(a,0,a.nodeValue.length).getClientRects();else continue;for(let d=0;d<l.length;d++){let u=l[d];if(u.bottom>u.top+1&&(t=="up"?o.top-u.top>(u.bottom-o.top)*2:u.bottom-o.bottom>(o.bottom-u.top)*2))return!1}}return!0})}const Cu=/[\u0590-\u08ac]/;function Tu(i,e,t){let{$head:n}=e.selection;if(!n.parent.isTextblock)return!1;let s=n.parentOffset,r=!s,o=s==n.parent.content.size,a=i.domSelection();return!Cu.test(n.parent.textContent)||!a.modify?t=="left"||t=="backward"?r:o:Jo(i,e,()=>{let{focusNode:l,focusOffset:d,anchorNode:u,anchorOffset:m}=i.domSelectionRange(),p=a.caretBidiLevel;a.modify("move",t,"character");let k=n.depth?i.docView.domAfterPos(n.before()):i.dom,{focusNode:y,focusOffset:S}=i.domSelectionRange(),w=y&&!k.contains(y.nodeType==1?y:y.parentNode)||l==y&&d==S;try{a.collapse(u,m),l&&(l!=u||d!=m)&&a.extend&&a.extend(l,d)}catch{}return p!=null&&(a.caretBidiLevel=p),w})}let er=null,tr=null,nr=!1;function Eu(i,e,t){return er==e&&tr==t?nr:(er=e,tr=t,nr=t=="up"||t=="down"?Su(i,e,t):Tu(i,e,t))}const He=0,ir=1,At=2,ot=3;class In{constructor(e,t,n,s){this.parent=e,this.children=t,this.dom=n,this.contentDOM=s,this.dirty=He,n.pmViewDesc=this}matchesWidget(e){return!1}matchesMark(e){return!1}matchesNode(e,t,n){return!1}matchesHack(e){return!1}parseRule(){return null}stopEvent(e){return!1}get size(){let e=0;for(let t=0;t<this.children.length;t++)e+=this.children[t].size;return e}get border(){return 0}destroy(){this.parent=void 0,this.dom.pmViewDesc==this&&(this.dom.pmViewDesc=void 0);for(let e=0;e<this.children.length;e++)this.children[e].destroy()}posBeforeChild(e){for(let t=0,n=this.posAtStart;;t++){let s=this.children[t];if(s==e)return n;n+=s.size}}get posBefore(){return this.parent.posBeforeChild(this)}get posAtStart(){return this.parent?this.parent.posBeforeChild(this)+this.border:0}get posAfter(){return this.posBefore+this.size}get posAtEnd(){return this.posAtStart+this.size-2*this.border}localPosFromDOM(e,t,n){if(this.contentDOM&&this.contentDOM.contains(e.nodeType==1?e:e.parentNode))if(n<0){let r,o;if(e==this.contentDOM)r=e.childNodes[t-1];else{for(;e.parentNode!=this.contentDOM;)e=e.parentNode;r=e.previousSibling}for(;r&&!((o=r.pmViewDesc)&&o.parent==this);)r=r.previousSibling;return r?this.posBeforeChild(o)+o.size:this.posAtStart}else{let r,o;if(e==this.contentDOM)r=e.childNodes[t];else{for(;e.parentNode!=this.contentDOM;)e=e.parentNode;r=e.nextSibling}for(;r&&!((o=r.pmViewDesc)&&o.parent==this);)r=r.nextSibling;return r?this.posBeforeChild(o):this.posAtEnd}let s;if(e==this.dom&&this.contentDOM)s=t>ge(this.contentDOM);else if(this.contentDOM&&this.contentDOM!=this.dom&&this.dom.contains(this.contentDOM))s=e.compareDocumentPosition(this.contentDOM)&2;else if(this.dom.firstChild){if(t==0)for(let r=e;;r=r.parentNode){if(r==this.dom){s=!1;break}if(r.previousSibling)break}if(s==null&&t==e.childNodes.length)for(let r=e;;r=r.parentNode){if(r==this.dom){s=!0;break}if(r.nextSibling)break}}return s??n>0?this.posAtEnd:this.posAtStart}nearestDesc(e,t=!1){for(let n=!0,s=e;s;s=s.parentNode){let r=this.getDesc(s),o;if(r&&(!t||r.node))if(n&&(o=r.nodeDOM)&&!(o.nodeType==1?o.contains(e.nodeType==1?e:e.parentNode):o==e))n=!1;else return r}}getDesc(e){let t=e.pmViewDesc;for(let n=t;n;n=n.parent)if(n==this)return t}posFromDOM(e,t,n){for(let s=e;s;s=s.parentNode){let r=this.getDesc(s);if(r)return r.localPosFromDOM(e,t,n)}return-1}descAt(e){for(let t=0,n=0;t<this.children.length;t++){let s=this.children[t],r=n+s.size;if(n==e&&r!=n){for(;!s.border&&s.children.length;)s=s.children[0];return s}if(e<r)return s.descAt(e-n-s.border);n=r}}domFromPos(e,t){if(!this.contentDOM)return{node:this.dom,offset:0,atom:e+1};let n=0,s=0;for(let r=0;n<this.children.length;n++){let o=this.children[n],a=r+o.size;if(a>e||o instanceof Go){s=e-r;break}r=a}if(s)return this.children[n].domFromPos(s-this.children[n].border,t);for(let r;n&&!(r=this.children[n-1]).size&&r instanceof $o&&r.side>=0;n--);if(t<=0){let r,o=!0;for(;r=n?this.children[n-1]:null,!(!r||r.dom.parentNode==this.contentDOM);n--,o=!1);return r&&t&&o&&!r.border&&!r.domAtom?r.domFromPos(r.size,t):{node:this.contentDOM,offset:r?ge(r.dom)+1:0}}else{let r,o=!0;for(;r=n<this.children.length?this.children[n]:null,!(!r||r.dom.parentNode==this.contentDOM);n++,o=!1);return r&&o&&!r.border&&!r.domAtom?r.domFromPos(0,t):{node:this.contentDOM,offset:r?ge(r.dom):this.contentDOM.childNodes.length}}}parseRange(e,t,n=0){if(this.children.length==0)return{node:this.contentDOM,from:e,to:t,fromOffset:0,toOffset:this.contentDOM.childNodes.length};let s=-1,r=-1;for(let o=n,a=0;;a++){let l=this.children[a],d=o+l.size;if(s==-1&&e<=d){let u=o+l.border;if(e>=u&&t<=d-l.border&&l.node&&l.contentDOM&&this.contentDOM.contains(l.contentDOM))return l.parseRange(e,t,u);e=o;for(let m=a;m>0;m--){let p=this.children[m-1];if(p.size&&p.dom.parentNode==this.contentDOM&&!p.emptyChildAt(1)){s=ge(p.dom)+1;break}e-=p.size}s==-1&&(s=0)}if(s>-1&&(d>t||a==this.children.length-1)){t=d;for(let u=a+1;u<this.children.length;u++){let m=this.children[u];if(m.size&&m.dom.parentNode==this.contentDOM&&!m.emptyChildAt(-1)){r=ge(m.dom);break}t+=m.size}r==-1&&(r=this.contentDOM.childNodes.length);break}o=d}return{node:this.contentDOM,from:e,to:t,fromOffset:s,toOffset:r}}emptyChildAt(e){if(this.border||!this.contentDOM||!this.children.length)return!1;let t=this.children[e<0?0:this.children.length-1];return t.size==0||t.emptyChildAt(e)}domAfterPos(e){let{node:t,offset:n}=this.domFromPos(e,0);if(t.nodeType!=1||n==t.childNodes.length)throw new RangeError("No node after pos "+e);return t.childNodes[n]}setSelection(e,t,n,s=!1){let r=Math.min(e,t),o=Math.max(e,t);for(let p=0,k=0;p<this.children.length;p++){let y=this.children[p],S=k+y.size;if(r>k&&o<S)return y.setSelection(e-k-y.border,t-k-y.border,n,s);k=S}let a=this.domFromPos(e,e?-1:1),l=t==e?a:this.domFromPos(t,t?-1:1),d=n.getSelection(),u=!1;if((Ze||De)&&e==t){let{node:p,offset:k}=a;if(p.nodeType==3){if(u=!!(k&&p.nodeValue[k-1]==`
`),u&&k==p.nodeValue.length)for(let y=p,S;y;y=y.parentNode){if(S=y.nextSibling){S.nodeName=="BR"&&(a=l={node:S.parentNode,offset:ge(S)+1});break}let w=y.pmViewDesc;if(w&&w.node&&w.node.isBlock)break}}else{let y=p.childNodes[k-1];u=y&&(y.nodeName=="BR"||y.contentEditable=="false")}}if(Ze&&d.focusNode&&d.focusNode!=l.node&&d.focusNode.nodeType==1){let p=d.focusNode.childNodes[d.focusOffset];p&&p.contentEditable=="false"&&(s=!0)}if(!(s||u&&De)&&zt(a.node,a.offset,d.anchorNode,d.anchorOffset)&&zt(l.node,l.offset,d.focusNode,d.focusOffset))return;let m=!1;if((d.extend||e==t)&&!u){d.collapse(a.node,a.offset);try{e!=t&&d.extend(l.node,l.offset),m=!0}catch{}}if(!m){if(e>t){let k=a;a=l,l=k}let p=document.createRange();p.setEnd(l.node,l.offset),p.setStart(a.node,a.offset),d.removeAllRanges(),d.addRange(p)}}ignoreMutation(e){return!this.contentDOM&&e.type!="selection"}get contentLost(){return this.contentDOM&&this.contentDOM!=this.dom&&!this.dom.contains(this.contentDOM)}markDirty(e,t){for(let n=0,s=0;s<this.children.length;s++){let r=this.children[s],o=n+r.size;if(n==o?e<=o&&t>=n:e<o&&t>n){let a=n+r.border,l=o-r.border;if(e>=a&&t<=l){this.dirty=e==n||t==o?At:ir,e==a&&t==l&&(r.contentLost||r.dom.parentNode!=this.contentDOM)?r.dirty=ot:r.markDirty(e-a,t-a);return}else r.dirty=r.dom==r.contentDOM&&r.dom.parentNode==this.contentDOM&&!r.children.length?At:ot}n=o}this.dirty=At}markParentsDirty(){let e=1;for(let t=this.parent;t;t=t.parent,e++){let n=e==1?At:ir;t.dirty<n&&(t.dirty=n)}}get domAtom(){return!1}get ignoreForCoords(){return!1}isText(e){return!1}}class $o extends In{constructor(e,t,n,s){let r,o=t.type.toDOM;if(typeof o=="function"&&(o=o(n,()=>{if(!r)return s;if(r.parent)return r.parent.posBeforeChild(r)})),!t.type.spec.raw){if(o.nodeType!=1){let a=document.createElement("span");a.appendChild(o),o=a}o.contentEditable="false",o.classList.add("ProseMirror-widget")}super(e,[],o,null),this.widget=t,this.widget=t,r=this}matchesWidget(e){return this.dirty==He&&e.type.eq(this.widget.type)}parseRule(){return{ignore:!0}}stopEvent(e){let t=this.widget.spec.stopEvent;return t?t(e):!1}ignoreMutation(e){return e.type!="selection"||this.widget.spec.ignoreSelection}destroy(){this.widget.type.destroy(this.dom),super.destroy()}get domAtom(){return!0}get side(){return this.widget.type.side}}class Mu extends In{constructor(e,t,n,s){super(e,[],t,null),this.textDOM=n,this.text=s}get size(){return this.text.length}localPosFromDOM(e,t){return e!=this.textDOM?this.posAtStart+(t?this.size:0):this.posAtStart+t}domFromPos(e){return{node:this.textDOM,offset:e}}ignoreMutation(e){return e.type==="characterData"&&e.target.nodeValue==e.oldValue}}class Vt extends In{constructor(e,t,n,s){super(e,[],n,s),this.mark=t}static create(e,t,n,s){let r=s.nodeViews[t.type.name],o=r&&r(t,s,n);return(!o||!o.dom)&&(o=nn.renderSpec(document,t.type.spec.toDOM(t,n),null,t.attrs)),new Vt(e,t,o.dom,o.contentDOM||o.dom)}parseRule(){return this.dirty&ot||this.mark.type.spec.reparseInView?null:{mark:this.mark.type.name,attrs:this.mark.attrs,contentElement:this.contentDOM}}matchesMark(e){return this.dirty!=ot&&this.mark.eq(e)}markDirty(e,t){if(super.markDirty(e,t),this.dirty!=He){let n=this.parent;for(;!n.node;)n=n.parent;n.dirty<this.dirty&&(n.dirty=this.dirty),this.dirty=He}}slice(e,t,n){let s=Vt.create(this.parent,this.mark,!0,n),r=this.children,o=this.size;t<o&&(r=Vi(r,t,o,n)),e>0&&(r=Vi(r,0,e,n));for(let a=0;a<r.length;a++)r[a].parent=s;return s.children=r,s}}class Mt extends In{constructor(e,t,n,s,r,o,a,l,d){super(e,[],r,o),this.node=t,this.outerDeco=n,this.innerDeco=s,this.nodeDOM=a}static create(e,t,n,s,r,o){let a=r.nodeViews[t.type.name],l,d=a&&a(t,r,()=>{if(!l)return o;if(l.parent)return l.parent.posBeforeChild(l)},n,s),u=d&&d.dom,m=d&&d.contentDOM;if(t.isText){if(!u)u=document.createTextNode(t.text);else if(u.nodeType!=3)throw new RangeError("Text must be rendered as a DOM text node")}else u||({dom:u,contentDOM:m}=nn.renderSpec(document,t.type.spec.toDOM(t),null,t.attrs));!m&&!t.isText&&u.nodeName!="BR"&&(u.hasAttribute("contenteditable")||(u.contentEditable="false"),t.type.spec.draggable&&(u.draggable=!0));let p=u;return u=Zo(u,n,t),d?l=new Iu(e,t,n,s,u,m||null,p,d,r,o+1):t.isText?new ii(e,t,n,s,u,p,r):new Mt(e,t,n,s,u,m||null,p,r,o+1)}parseRule(){if(this.node.type.spec.reparseInView)return null;let e={node:this.node.type.name,attrs:this.node.attrs};if(this.node.type.whitespace=="pre"&&(e.preserveWhitespace="full"),!this.contentDOM)e.getContent=()=>this.node.content;else if(!this.contentLost)e.contentElement=this.contentDOM;else{for(let t=this.children.length-1;t>=0;t--){let n=this.children[t];if(this.dom.contains(n.dom.parentNode)){e.contentElement=n.dom.parentNode;break}}e.contentElement||(e.getContent=()=>N.empty)}return e}matchesNode(e,t,n){return this.dirty==He&&e.eq(this.node)&&zi(t,this.outerDeco)&&n.eq(this.innerDeco)}get size(){return this.node.nodeSize}get border(){return this.node.isLeaf?0:1}updateChildren(e,t){let n=this.node.inlineContent,s=t,r=e.composing?this.localCompositionInfo(e,t):null,o=r&&r.pos>-1?r:null,a=r&&r.pos<0,l=new _u(this,o&&o.node,e);Ru(this.node,this.innerDeco,(d,u,m)=>{d.spec.marks?l.syncToMarks(d.spec.marks,n,e):d.type.side>=0&&!m&&l.syncToMarks(u==this.node.childCount?G.none:this.node.child(u).marks,n,e),l.placeWidget(d,e,s)},(d,u,m,p)=>{l.syncToMarks(d.marks,n,e);let k;l.findNodeMatch(d,u,m,p)||a&&e.state.selection.from>s&&e.state.selection.to<s+d.nodeSize&&(k=l.findIndexWithChild(r.node))>-1&&l.updateNodeAt(d,u,m,k,e)||l.updateNextNode(d,u,m,e,p,s)||l.addNode(d,u,m,e,s),s+=d.nodeSize}),l.syncToMarks([],n,e),this.node.isTextblock&&l.addTextblockHacks(),l.destroyRest(),(l.changed||this.dirty==At)&&(o&&this.protectLocalComposition(e,o),Ko(this.contentDOM,this.children,e),tn&&Au(this.dom))}localCompositionInfo(e,t){let{from:n,to:s}=e.state.selection;if(!(e.state.selection instanceof ie)||n<t||s>t+this.node.content.size)return null;let r=e.input.compositionNode;if(!r||!this.dom.contains(r.parentNode))return null;if(this.node.inlineContent){let o=r.nodeValue,a=vu(this.node.content,o,n-t,s-t);return a<0?null:{node:r,pos:a,text:o}}else return{node:r,pos:-1,text:""}}protectLocalComposition(e,{node:t,pos:n,text:s}){if(this.getDesc(t))return;let r=t;for(;r.parentNode!=this.contentDOM;r=r.parentNode){for(;r.previousSibling;)r.parentNode.removeChild(r.previousSibling);for(;r.nextSibling;)r.parentNode.removeChild(r.nextSibling);r.pmViewDesc&&(r.pmViewDesc=void 0)}let o=new Mu(this,r,t,s);e.input.compositionNodes.push(o),this.children=Vi(this.children,n,n+s.length,e,o)}update(e,t,n,s){return this.dirty==ot||!e.sameMarkup(this.node)?!1:(this.updateInner(e,t,n,s),!0)}updateInner(e,t,n,s){this.updateOuterDeco(t),this.node=e,this.innerDeco=n,this.contentDOM&&this.updateChildren(s,this.posAtStart),this.dirty=He}updateOuterDeco(e){if(zi(e,this.outerDeco))return;let t=this.nodeDOM.nodeType!=1,n=this.dom;this.dom=Yo(this.dom,this.nodeDOM,Li(this.outerDeco,this.node,t),Li(e,this.node,t)),this.dom!=n&&(n.pmViewDesc=void 0,this.dom.pmViewDesc=this),this.outerDeco=e}selectNode(){this.nodeDOM.nodeType==1&&this.nodeDOM.classList.add("ProseMirror-selectednode"),(this.contentDOM||!this.node.type.spec.draggable)&&(this.dom.draggable=!0)}deselectNode(){this.nodeDOM.nodeType==1&&(this.nodeDOM.classList.remove("ProseMirror-selectednode"),(this.contentDOM||!this.node.type.spec.draggable)&&this.dom.removeAttribute("draggable"))}get domAtom(){return this.node.isAtom}}function sr(i,e,t,n,s){Zo(n,e,i);let r=new Mt(void 0,i,e,t,n,n,n,s,0);return r.contentDOM&&r.updateChildren(s,0),r}class ii extends Mt{constructor(e,t,n,s,r,o,a){super(e,t,n,s,r,null,o,a,0)}parseRule(){let e=this.nodeDOM.parentNode;for(;e&&e!=this.dom&&!e.pmIsDeco;)e=e.parentNode;return{skip:e||!0}}update(e,t,n,s){return this.dirty==ot||this.dirty!=He&&!this.inParent()||!e.sameMarkup(this.node)?!1:(this.updateOuterDeco(t),(this.dirty!=He||e.text!=this.node.text)&&e.text!=this.nodeDOM.nodeValue&&(this.nodeDOM.nodeValue=e.text,s.trackWrites==this.nodeDOM&&(s.trackWrites=null)),this.node=e,this.dirty=He,!0)}inParent(){let e=this.parent.contentDOM;for(let t=this.nodeDOM;t;t=t.parentNode)if(t==e)return!0;return!1}domFromPos(e){return{node:this.nodeDOM,offset:e}}localPosFromDOM(e,t,n){return e==this.nodeDOM?this.posAtStart+Math.min(t,this.node.text.length):super.localPosFromDOM(e,t,n)}ignoreMutation(e){return e.type!="characterData"&&e.type!="selection"}slice(e,t,n){let s=this.node.cut(e,t),r=document.createTextNode(s.text);return new ii(this.parent,s,this.outerDeco,this.innerDeco,r,r,n)}markDirty(e,t){super.markDirty(e,t),this.dom!=this.nodeDOM&&(e==0||t==this.nodeDOM.nodeValue.length)&&(this.dirty=ot)}get domAtom(){return!1}isText(e){return this.node.text==e}}class Go extends In{parseRule(){return{ignore:!0}}matchesHack(e){return this.dirty==He&&this.dom.nodeName==e}get domAtom(){return!0}get ignoreForCoords(){return this.dom.nodeName=="IMG"}}class Iu extends Mt{constructor(e,t,n,s,r,o,a,l,d,u){super(e,t,n,s,r,o,a,d,u),this.spec=l}update(e,t,n,s){if(this.dirty==ot)return!1;if(this.spec.update){let r=this.spec.update(e,t,n);return r&&this.updateInner(e,t,n,s),r}else return!this.contentDOM&&!e.isLeaf?!1:super.update(e,t,n,s)}selectNode(){this.spec.selectNode?this.spec.selectNode():super.selectNode()}deselectNode(){this.spec.deselectNode?this.spec.deselectNode():super.deselectNode()}setSelection(e,t,n,s){this.spec.setSelection?this.spec.setSelection(e,t,n):super.setSelection(e,t,n,s)}destroy(){this.spec.destroy&&this.spec.destroy(),super.destroy()}stopEvent(e){return this.spec.stopEvent?this.spec.stopEvent(e):!1}ignoreMutation(e){return this.spec.ignoreMutation?this.spec.ignoreMutation(e):super.ignoreMutation(e)}}function Ko(i,e,t){let n=i.firstChild,s=!1;for(let r=0;r<e.length;r++){let o=e[r],a=o.dom;if(a.parentNode==i){for(;a!=n;)n=rr(n),s=!0;n=n.nextSibling}else s=!0,i.insertBefore(a,n);if(o instanceof Vt){let l=n?n.previousSibling:i.lastChild;Ko(o.contentDOM,o.children,t),n=l?l.nextSibling:i.firstChild}}for(;n;)n=rr(n),s=!0;s&&t.trackWrites==i&&(t.trackWrites=null)}const pn=function(i){i&&(this.nodeName=i)};pn.prototype=Object.create(null);const vt=[new pn];function Li(i,e,t){if(i.length==0)return vt;let n=t?vt[0]:new pn,s=[n];for(let r=0;r<i.length;r++){let o=i[r].type.attrs;if(o){o.nodeName&&s.push(n=new pn(o.nodeName));for(let a in o){let l=o[a];l!=null&&(t&&s.length==1&&s.push(n=new pn(e.isInline?"span":"div")),a=="class"?n.class=(n.class?n.class+" ":"")+l:a=="style"?n.style=(n.style?n.style+";":"")+l:a!="nodeName"&&(n[a]=l))}}}return s}function Yo(i,e,t,n){if(t==vt&&n==vt)return e;let s=e;for(let r=0;r<n.length;r++){let o=n[r],a=t[r];if(r){let l;a&&a.nodeName==o.nodeName&&s!=i&&(l=s.parentNode)&&l.nodeName.toLowerCase()==o.nodeName||(l=document.createElement(o.nodeName),l.pmIsDeco=!0,l.appendChild(s),a=vt[0]),s=l}Nu(s,a||vt[0],o)}return s}function Nu(i,e,t){for(let n in e)n!="class"&&n!="style"&&n!="nodeName"&&!(n in t)&&i.removeAttribute(n);for(let n in t)n!="class"&&n!="style"&&n!="nodeName"&&t[n]!=e[n]&&i.setAttribute(n,t[n]);if(e.class!=t.class){let n=e.class?e.class.split(" ").filter(Boolean):[],s=t.class?t.class.split(" ").filter(Boolean):[];for(let r=0;r<n.length;r++)s.indexOf(n[r])==-1&&i.classList.remove(n[r]);for(let r=0;r<s.length;r++)n.indexOf(s[r])==-1&&i.classList.add(s[r]);i.classList.length==0&&i.removeAttribute("class")}if(e.style!=t.style){if(e.style){let n=/\s*([\w\-\xa1-\uffff]+)\s*:(?:"(?:\\.|[^"])*"|'(?:\\.|[^'])*'|\(.*?\)|[^;])*/g,s;for(;s=n.exec(e.style);)i.style.removeProperty(s[1])}t.style&&(i.style.cssText+=t.style)}}function Zo(i,e,t){return Yo(i,i,vt,Li(e,t,i.nodeType!=1))}function zi(i,e){if(i.length!=e.length)return!1;for(let t=0;t<i.length;t++)if(!i[t].type.eq(e[t].type))return!1;return!0}function rr(i){let e=i.nextSibling;return i.parentNode.removeChild(i),e}class _u{constructor(e,t,n){this.lock=t,this.view=n,this.index=0,this.stack=[],this.changed=!1,this.top=e,this.preMatch=Du(e.node.content,e)}destroyBetween(e,t){if(e!=t){for(let n=e;n<t;n++)this.top.children[n].destroy();this.top.children.splice(e,t-e),this.changed=!0}}destroyRest(){this.destroyBetween(this.index,this.top.children.length)}syncToMarks(e,t,n){let s=0,r=this.stack.length>>1,o=Math.min(r,e.length);for(;s<o&&(s==r-1?this.top:this.stack[s+1<<1]).matchesMark(e[s])&&e[s].type.spec.spanning!==!1;)s++;for(;s<r;)this.destroyRest(),this.top.dirty=He,this.index=this.stack.pop(),this.top=this.stack.pop(),r--;for(;r<e.length;){this.stack.push(this.top,this.index+1);let a=-1;for(let l=this.index;l<Math.min(this.index+3,this.top.children.length);l++){let d=this.top.children[l];if(d.matchesMark(e[r])&&!this.isLocked(d.dom)){a=l;break}}if(a>-1)a>this.index&&(this.changed=!0,this.destroyBetween(this.index,a)),this.top=this.top.children[this.index];else{let l=Vt.create(this.top,e[r],t,n);this.top.children.splice(this.index,0,l),this.top=l,this.changed=!0}this.index=0,r++}}findNodeMatch(e,t,n,s){let r=-1,o;if(s>=this.preMatch.index&&(o=this.preMatch.matches[s-this.preMatch.index]).parent==this.top&&o.matchesNode(e,t,n))r=this.top.children.indexOf(o,this.index);else for(let a=this.index,l=Math.min(this.top.children.length,a+5);a<l;a++){let d=this.top.children[a];if(d.matchesNode(e,t,n)&&!this.preMatch.matched.has(d)){r=a;break}}return r<0?!1:(this.destroyBetween(this.index,r),this.index++,!0)}updateNodeAt(e,t,n,s,r){let o=this.top.children[s];return o.dirty==ot&&o.dom==o.contentDOM&&(o.dirty=At),o.update(e,t,n,r)?(this.destroyBetween(this.index,s),this.index++,!0):!1}findIndexWithChild(e){for(;;){let t=e.parentNode;if(!t)return-1;if(t==this.top.contentDOM){let n=e.pmViewDesc;if(n){for(let s=this.index;s<this.top.children.length;s++)if(this.top.children[s]==n)return s}return-1}e=t}}updateNextNode(e,t,n,s,r,o){for(let a=this.index;a<this.top.children.length;a++){let l=this.top.children[a];if(l instanceof Mt){let d=this.preMatch.matched.get(l);if(d!=null&&d!=r)return!1;let u=l.dom,m,p=this.isLocked(u)&&!(e.isText&&l.node&&l.node.isText&&l.nodeDOM.nodeValue==e.text&&l.dirty!=ot&&zi(t,l.outerDeco));if(!p&&l.update(e,t,n,s))return this.destroyBetween(this.index,a),l.dom!=u&&(this.changed=!0),this.index++,!0;if(!p&&(m=this.recreateWrapper(l,e,t,n,s,o)))return this.top.children[this.index]=m,m.contentDOM&&(m.dirty=At,m.updateChildren(s,o+1),m.dirty=He),this.changed=!0,this.index++,!0;break}}return!1}recreateWrapper(e,t,n,s,r,o){if(e.dirty||t.isAtom||!e.children.length||!e.node.content.eq(t.content))return null;let a=Mt.create(this.top,t,n,s,r,o);if(a.contentDOM){a.children=e.children,e.children=[];for(let l of a.children)l.parent=a}return e.destroy(),a}addNode(e,t,n,s,r){let o=Mt.create(this.top,e,t,n,s,r);o.contentDOM&&o.updateChildren(s,r+1),this.top.children.splice(this.index++,0,o),this.changed=!0}placeWidget(e,t,n){let s=this.index<this.top.children.length?this.top.children[this.index]:null;if(s&&s.matchesWidget(e)&&(e==s.widget||!s.widget.type.toDOM.parentNode))this.index++;else{let r=new $o(this.top,e,t,n);this.top.children.splice(this.index++,0,r),this.changed=!0}}addTextblockHacks(){let e=this.top.children[this.index-1],t=this.top;for(;e instanceof Vt;)t=e,e=t.children[t.children.length-1];(!e||!(e instanceof ii)||/\n$/.test(e.node.text)||this.view.requiresGeckoHackNode&&/\s$/.test(e.node.text))&&((De||Te)&&e&&e.dom.contentEditable=="false"&&this.addHackNode("IMG",t),this.addHackNode("BR",this.top))}addHackNode(e,t){if(t==this.top&&this.index<t.children.length&&t.children[this.index].matchesHack(e))this.index++;else{let n=document.createElement(e);e=="IMG"&&(n.className="ProseMirror-separator",n.alt=""),e=="BR"&&(n.className="ProseMirror-trailingBreak");let s=new Go(this.top,[],n,null);t!=this.top?t.children.push(s):t.children.splice(this.index++,0,s),this.changed=!0}}isLocked(e){return this.lock&&(e==this.lock||e.nodeType==1&&e.contains(this.lock.parentNode))}}function Du(i,e){let t=e,n=t.children.length,s=i.childCount,r=new Map,o=[];e:for(;s>0;){let a;for(;;)if(n){let d=t.children[n-1];if(d instanceof Vt)t=d,n=d.children.length;else{a=d,n--;break}}else{if(t==e)break e;n=t.parent.children.indexOf(t),t=t.parent}let l=a.node;if(l){if(l!=i.child(s-1))break;--s,r.set(a,s),o.push(a)}}return{index:s,matched:r,matches:o.reverse()}}function Ou(i,e){return i.type.side-e.type.side}function Ru(i,e,t,n){let s=e.locals(i),r=0;if(s.length==0){for(let d=0;d<i.childCount;d++){let u=i.child(d);n(u,s,e.forChild(r,u),d),r+=u.nodeSize}return}let o=0,a=[],l=null;for(let d=0;;){let u,m;for(;o<s.length&&s[o].to==r;){let w=s[o++];w.widget&&(u?(m||(m=[u])).push(w):u=w)}if(u)if(m){m.sort(Ou);for(let w=0;w<m.length;w++)t(m[w],d,!!l)}else t(u,d,!!l);let p,k;if(l)k=-1,p=l,l=null;else if(d<i.childCount)k=d,p=i.child(d++);else break;for(let w=0;w<a.length;w++)a[w].to<=r&&a.splice(w--,1);for(;o<s.length&&s[o].from<=r&&s[o].to>r;)a.push(s[o++]);let y=r+p.nodeSize;if(p.isText){let w=y;o<s.length&&s[o].from<w&&(w=s[o].from);for(let E=0;E<a.length;E++)a[E].to<w&&(w=a[E].to);w<y&&(l=p.cut(w-r),p=p.cut(0,w-r),y=w,k=-1)}else for(;o<s.length&&s[o].to<y;)o++;let S=p.isInline&&!p.isLeaf?a.filter(w=>!w.inline):a.slice();n(p,S,e.forChild(r,p),k),r=y}}function Au(i){if(i.nodeName=="UL"||i.nodeName=="OL"){let e=i.style.cssText;i.style.cssText=e+"; list-style: square !important",window.getComputedStyle(i).listStyle,i.style.cssText=e}}function vu(i,e,t,n){for(let s=0,r=0;s<i.childCount&&r<=n;){let o=i.child(s++),a=r;if(r+=o.nodeSize,!o.isText)continue;let l=o.text;for(;s<i.childCount;){let d=i.child(s++);if(r+=d.nodeSize,!d.isText)break;l+=d.text}if(r>=t){if(r>=n&&l.slice(n-e.length-a,n-a)==e)return n-e.length;let d=a<n?l.lastIndexOf(e,n-a-1):-1;if(d>=0&&d+e.length+a>=t)return a+d;if(t==n&&l.length>=n+e.length-a&&l.slice(n-a,n-a+e.length)==e)return n}}return-1}function Vi(i,e,t,n,s){let r=[];for(let o=0,a=0;o<i.length;o++){let l=i[o],d=a,u=a+=l.size;d>=t||u<=e?r.push(l):(d<e&&r.push(l.slice(0,e-d,n)),s&&(r.push(s),s=void 0),u>t&&r.push(l.slice(t-d,l.size,n)))}return r}function ls(i,e=null){let t=i.domSelectionRange(),n=i.state.doc;if(!t.focusNode)return null;let s=i.docView.nearestDesc(t.focusNode),r=s&&s.size==0,o=i.docView.posFromDOM(t.focusNode,t.focusOffset,1);if(o<0)return null;let a=n.resolve(o),l,d;if(ni(t)){for(l=a;s&&!s.node;)s=s.parent;let u=s.node;if(s&&u.isAtom&&W.isSelectable(u)&&s.parent&&!(u.isInline&&ou(t.focusNode,t.focusOffset,s.dom))){let m=s.posBefore;d=new W(o==m?a:n.resolve(m))}}else{let u=i.docView.posFromDOM(t.anchorNode,t.anchorOffset,1);if(u<0)return null;l=n.resolve(u)}if(!d){let u=e=="pointer"||i.state.selection.head<a.pos&&!r?1:-1;d=cs(i,l,a,u)}return d}function Qo(i){return i.editable?i.hasFocus():ea(i)&&document.activeElement&&document.activeElement.contains(i.dom)}function ht(i,e=!1){let t=i.state.selection;if(Xo(i,t),!!Qo(i)){if(!e&&i.input.mouseDown&&i.input.mouseDown.allowDefault&&Te){let n=i.domSelectionRange(),s=i.domObserver.currentSelection;if(n.anchorNode&&s.anchorNode&&zt(n.anchorNode,n.anchorOffset,s.anchorNode,s.anchorOffset)){i.input.mouseDown.delayedSelectionSync=!0,i.domObserver.setCurSelection();return}}if(i.domObserver.disconnectSelection(),i.cursorWrapper)Fu(i);else{let{anchor:n,head:s}=t,r,o;or&&!(t instanceof ie)&&(t.$from.parent.inlineContent||(r=ar(i,t.from)),!t.empty&&!t.$from.parent.inlineContent&&(o=ar(i,t.to))),i.docView.setSelection(n,s,i.root,e),or&&(r&&lr(r),o&&lr(o)),t.visible?i.dom.classList.remove("ProseMirror-hideselection"):(i.dom.classList.add("ProseMirror-hideselection"),"onselectionchange"in document&&Bu(i))}i.domObserver.setCurSelection(),i.domObserver.connectSelection()}}const or=De||Te&&zo<63;function ar(i,e){let{node:t,offset:n}=i.docView.domFromPos(e,0),s=n<t.childNodes.length?t.childNodes[n]:null,r=n?t.childNodes[n-1]:null;if(De&&s&&s.contentEditable=="false")return ki(s);if((!s||s.contentEditable=="false")&&(!r||r.contentEditable=="false")){if(s)return ki(s);if(r)return ki(r)}}function ki(i){return i.contentEditable="true",De&&i.draggable&&(i.draggable=!1,i.wasDraggable=!0),i}function lr(i){i.contentEditable="false",i.wasDraggable&&(i.draggable=!0,i.wasDraggable=null)}function Bu(i){let e=i.dom.ownerDocument;e.removeEventListener("selectionchange",i.input.hideSelectionGuard);let t=i.domSelectionRange(),n=t.anchorNode,s=t.anchorOffset;e.addEventListener("selectionchange",i.input.hideSelectionGuard=()=>{(t.anchorNode!=n||t.anchorOffset!=s)&&(e.removeEventListener("selectionchange",i.input.hideSelectionGuard),setTimeout(()=>{(!Qo(i)||i.state.selection.visible)&&i.dom.classList.remove("ProseMirror-hideselection")},20))})}function Fu(i){let e=i.domSelection(),t=document.createRange(),n=i.cursorWrapper.dom,s=n.nodeName=="IMG";s?t.setEnd(n.parentNode,ge(n)+1):t.setEnd(n,0),t.collapse(!1),e.removeAllRanges(),e.addRange(t),!s&&!i.state.selection.visible&&Fe&&Et<=11&&(n.disabled=!0,n.disabled=!1)}function Xo(i,e){if(e instanceof W){let t=i.docView.descAt(e.from);t!=i.lastSelectedViewDesc&&(cr(i),t&&t.selectNode(),i.lastSelectedViewDesc=t)}else cr(i)}function cr(i){i.lastSelectedViewDesc&&(i.lastSelectedViewDesc.parent&&i.lastSelectedViewDesc.deselectNode(),i.lastSelectedViewDesc=void 0)}function cs(i,e,t,n){return i.someProp("createSelectionBetween",s=>s(i,e,t))||ie.between(e,t,n)}function dr(i){return i.editable&&!i.hasFocus()?!1:ea(i)}function ea(i){let e=i.domSelectionRange();if(!e.anchorNode)return!1;try{return i.dom.contains(e.anchorNode.nodeType==3?e.anchorNode.parentNode:e.anchorNode)&&(i.editable||i.dom.contains(e.focusNode.nodeType==3?e.focusNode.parentNode:e.focusNode))}catch{return!1}}function Pu(i){let e=i.docView.domFromPos(i.state.selection.anchor,0),t=i.domSelectionRange();return zt(e.node,e.offset,t.anchorNode,t.anchorOffset)}function Ui(i,e){let{$anchor:t,$head:n}=i.selection,s=e>0?t.max(n):t.min(n),r=s.parent.inlineContent?s.depth?i.doc.resolve(e>0?s.after():s.before()):null:s;return r&&Q.findFrom(r,e)}function kt(i,e){return i.dispatch(i.state.tr.setSelection(e).scrollIntoView()),!0}function hr(i,e,t){let n=i.state.selection;if(n instanceof ie)if(t.indexOf("s")>-1){let{$head:s}=n,r=s.textOffset?null:e<0?s.nodeBefore:s.nodeAfter;if(!r||r.isText||!r.isLeaf)return!1;let o=i.state.doc.resolve(s.pos+r.nodeSize*(e<0?-1:1));return kt(i,new ie(n.$anchor,o))}else if(n.empty){if(i.endOfTextblock(e>0?"forward":"backward")){let s=Ui(i.state,e);return s&&s instanceof W?kt(i,s):!1}else if(!(Ue&&t.indexOf("m")>-1)){let s=n.$head,r=s.textOffset?null:e<0?s.nodeBefore:s.nodeAfter,o;if(!r||r.isText)return!1;let a=e<0?s.pos-r.nodeSize:s.pos;return r.isAtom||(o=i.docView.descAt(a))&&!o.contentDOM?W.isSelectable(r)?kt(i,new W(e<0?i.state.doc.resolve(s.pos-r.nodeSize):s)):Mn?kt(i,new ie(i.state.doc.resolve(e<0?a:a+r.nodeSize))):!1:!1}}else return!1;else{if(n instanceof W&&n.node.isInline)return kt(i,new ie(e>0?n.$to:n.$from));{let s=Ui(i.state,e);return s?kt(i,s):!1}}}function Gn(i){return i.nodeType==3?i.nodeValue.length:i.childNodes.length}function mn(i,e){let t=i.pmViewDesc;return t&&t.size==0&&(e<0||i.nextSibling||i.nodeName!="BR")}function Wt(i,e){return e<0?ju(i):Lu(i)}function ju(i){let e=i.domSelectionRange(),t=e.focusNode,n=e.focusOffset;if(!t)return;let s,r,o=!1;for(Ze&&t.nodeType==1&&n<Gn(t)&&mn(t.childNodes[n],-1)&&(o=!0);;)if(n>0){if(t.nodeType!=1)break;{let a=t.childNodes[n-1];if(mn(a,-1))s=t,r=--n;else if(a.nodeType==3)t=a,n=t.nodeValue.length;else break}}else{if(ta(t))break;{let a=t.previousSibling;for(;a&&mn(a,-1);)s=t.parentNode,r=ge(a),a=a.previousSibling;if(a)t=a,n=Gn(t);else{if(t=t.parentNode,t==i.dom)break;n=0}}}o?qi(i,t,n):s&&qi(i,s,r)}function Lu(i){let e=i.domSelectionRange(),t=e.focusNode,n=e.focusOffset;if(!t)return;let s=Gn(t),r,o;for(;;)if(n<s){if(t.nodeType!=1)break;let a=t.childNodes[n];if(mn(a,1))r=t,o=++n;else break}else{if(ta(t))break;{let a=t.nextSibling;for(;a&&mn(a,1);)r=a.parentNode,o=ge(a)+1,a=a.nextSibling;if(a)t=a,n=0,s=Gn(t);else{if(t=t.parentNode,t==i.dom)break;n=s=0}}}r&&qi(i,r,o)}function ta(i){let e=i.pmViewDesc;return e&&e.node&&e.node.isBlock}function zu(i,e){for(;i&&e==i.childNodes.length&&!En(i);)e=ge(i)+1,i=i.parentNode;for(;i&&e<i.childNodes.length;){let t=i.childNodes[e];if(t.nodeType==3)return t;if(t.nodeType==1&&t.contentEditable=="false")break;i=t,e=0}}function Vu(i,e){for(;i&&!e&&!En(i);)e=ge(i),i=i.parentNode;for(;i&&e;){let t=i.childNodes[e-1];if(t.nodeType==3)return t;if(t.nodeType==1&&t.contentEditable=="false")break;i=t,e=i.childNodes.length}}function qi(i,e,t){if(e.nodeType!=3){let r,o;(o=zu(e,t))?(e=o,t=0):(r=Vu(e,t))&&(e=r,t=r.nodeValue.length)}let n=i.domSelection();if(ni(n)){let r=document.createRange();r.setEnd(e,t),r.setStart(e,t),n.removeAllRanges(),n.addRange(r)}else n.extend&&n.extend(e,t);i.domObserver.setCurSelection();let{state:s}=i;setTimeout(()=>{i.state==s&&ht(i)},50)}function ur(i,e){let t=i.state.doc.resolve(e);if(!(Te||cu)&&t.parent.inlineContent){let s=i.coordsAtPos(e);if(e>t.start()){let r=i.coordsAtPos(e-1),o=(r.top+r.bottom)/2;if(o>s.top&&o<s.bottom&&Math.abs(r.left-s.left)>1)return r.left<s.left?"ltr":"rtl"}if(e<t.end()){let r=i.coordsAtPos(e+1),o=(r.top+r.bottom)/2;if(o>s.top&&o<s.bottom&&Math.abs(r.left-s.left)>1)return r.left>s.left?"ltr":"rtl"}}return getComputedStyle(i.dom).direction=="rtl"?"rtl":"ltr"}function fr(i,e,t){let n=i.state.selection;if(n instanceof ie&&!n.empty||t.indexOf("s")>-1||Ue&&t.indexOf("m")>-1)return!1;let{$from:s,$to:r}=n;if(!s.parent.inlineContent||i.endOfTextblock(e<0?"up":"down")){let o=Ui(i.state,e);if(o&&o instanceof W)return kt(i,o)}if(!s.parent.inlineContent){let o=e<0?s:r,a=n instanceof st?Q.near(o,e):Q.findFrom(o,e);return a?kt(i,a):!1}return!1}function pr(i,e){if(!(i.state.selection instanceof ie))return!0;let{$head:t,$anchor:n,empty:s}=i.state.selection;if(!t.sameParent(n))return!0;if(!s)return!1;if(i.endOfTextblock(e>0?"forward":"backward"))return!0;let r=!t.textOffset&&(e<0?t.nodeBefore:t.nodeAfter);if(r&&!r.isText){let o=i.state.tr;return e<0?o.delete(t.pos-r.nodeSize,t.pos):o.delete(t.pos,t.pos+r.nodeSize),i.dispatch(o),!0}return!1}function mr(i,e,t){i.domObserver.stop(),e.contentEditable=t,i.domObserver.start()}function Uu(i){if(!De||i.state.selection.$head.parentOffset>0)return!1;let{focusNode:e,focusOffset:t}=i.domSelectionRange();if(e&&e.nodeType==1&&t==0&&e.firstChild&&e.firstChild.contentEditable=="false"){let n=e.firstChild;mr(i,n,"true"),setTimeout(()=>mr(i,n,"false"),20)}return!1}function qu(i){let e="";return i.ctrlKey&&(e+="c"),i.metaKey&&(e+="m"),i.altKey&&(e+="a"),i.shiftKey&&(e+="s"),e}function Wu(i,e){let t=e.keyCode,n=qu(e);if(t==8||Ue&&t==72&&n=="c")return pr(i,-1)||Wt(i,-1);if(t==46&&!e.shiftKey||Ue&&t==68&&n=="c")return pr(i,1)||Wt(i,1);if(t==13||t==27)return!0;if(t==37||Ue&&t==66&&n=="c"){let s=t==37?ur(i,i.state.selection.from)=="ltr"?-1:1:-1;return hr(i,s,n)||Wt(i,s)}else if(t==39||Ue&&t==70&&n=="c"){let s=t==39?ur(i,i.state.selection.from)=="ltr"?1:-1:1;return hr(i,s,n)||Wt(i,s)}else{if(t==38||Ue&&t==80&&n=="c")return fr(i,-1,n)||Wt(i,-1);if(t==40||Ue&&t==78&&n=="c")return Uu(i)||fr(i,1,n)||Wt(i,1);if(n==(Ue?"m":"c")&&(t==66||t==73||t==89||t==90))return!0}return!1}function na(i,e){i.someProp("transformCopied",k=>{e=k(e,i)});let t=[],{content:n,openStart:s,openEnd:r}=e;for(;s>1&&r>1&&n.childCount==1&&n.firstChild.childCount==1;){s--,r--;let k=n.firstChild;t.push(k.type.name,k.attrs!=k.type.defaultAttrs?k.attrs:null),n=k.content}let o=i.someProp("clipboardSerializer")||nn.fromSchema(i.state.schema),a=la(),l=a.createElement("div");l.appendChild(o.serializeFragment(n,{document:a}));let d=l.firstChild,u,m=0;for(;d&&d.nodeType==1&&(u=aa[d.nodeName.toLowerCase()]);){for(let k=u.length-1;k>=0;k--){let y=a.createElement(u[k]);for(;l.firstChild;)y.appendChild(l.firstChild);l.appendChild(y),m++}d=l.firstChild}d&&d.nodeType==1&&d.setAttribute("data-pm-slice",`${s} ${r}${m?` -${m}`:""} ${JSON.stringify(t)}`);let p=i.someProp("clipboardTextSerializer",k=>k(e,i))||e.content.textBetween(0,e.content.size,`

`);return{dom:l,text:p,slice:e}}function ia(i,e,t,n,s){let r=s.parent.type.spec.code,o,a;if(!t&&!e)return null;let l=e&&(n||r||!t);if(l){if(i.someProp("transformPastedText",p=>{e=p(e,r||n,i)}),r)return e?new D(N.from(i.state.schema.text(e.replace(/\r\n?/g,`
`))),0,0):D.empty;let m=i.someProp("clipboardTextParser",p=>p(e,s,n,i));if(m)a=m;else{let p=s.marks(),{schema:k}=i.state,y=nn.fromSchema(k);o=document.createElement("div"),e.split(/(?:\r\n?|\n)+/).forEach(S=>{let w=o.appendChild(document.createElement("p"));S&&w.appendChild(y.serializeNode(k.text(S,p)))})}}else i.someProp("transformPastedHTML",m=>{t=m(t,i)}),o=$u(t),Mn&&Gu(o);let d=o&&o.querySelector("[data-pm-slice]"),u=d&&/^(\d+) (\d+)(?: -(\d+))? (.*)/.exec(d.getAttribute("data-pm-slice")||"");if(u&&u[3])for(let m=+u[3];m>0;m--){let p=o.firstChild;for(;p&&p.nodeType!=1;)p=p.nextSibling;if(!p)break;o=p}if(a||(a=(i.someProp("clipboardParser")||i.someProp("domParser")||xn.fromSchema(i.state.schema)).parseSlice(o,{preserveWhitespace:!!(l||u),context:s,ruleFromNode(p){return p.nodeName=="BR"&&!p.nextSibling&&p.parentNode&&!Hu.test(p.parentNode.nodeName)?{ignore:!0}:null}})),u)a=Ku(gr(a,+u[1],+u[2]),u[4]);else if(a=D.maxOpen(Ju(a.content,s),!0),a.openStart||a.openEnd){let m=0,p=0;for(let k=a.content.firstChild;m<a.openStart&&!k.type.spec.isolating;m++,k=k.firstChild);for(let k=a.content.lastChild;p<a.openEnd&&!k.type.spec.isolating;p++,k=k.lastChild);a=gr(a,m,p)}return i.someProp("transformPasted",m=>{a=m(a,i)}),a}const Hu=/^(a|abbr|acronym|b|cite|code|del|em|i|ins|kbd|label|output|q|ruby|s|samp|span|strong|sub|sup|time|u|tt|var)$/i;function Ju(i,e){if(i.childCount<2)return i;for(let t=e.depth;t>=0;t--){let s=e.node(t).contentMatchAt(e.index(t)),r,o=[];if(i.forEach(a=>{if(!o)return;let l=s.findWrapping(a.type),d;if(!l)return o=null;if(d=o.length&&r.length&&ra(l,r,a,o[o.length-1],0))o[o.length-1]=d;else{o.length&&(o[o.length-1]=oa(o[o.length-1],r.length));let u=sa(a,l);o.push(u),s=s.matchType(u.type),r=l}}),o)return N.from(o)}return i}function sa(i,e,t=0){for(let n=e.length-1;n>=t;n--)i=e[n].create(null,N.from(i));return i}function ra(i,e,t,n,s){if(s<i.length&&s<e.length&&i[s]==e[s]){let r=ra(i,e,t,n.lastChild,s+1);if(r)return n.copy(n.content.replaceChild(n.childCount-1,r));if(n.contentMatchAt(n.childCount).matchType(s==i.length-1?t.type:i[s+1]))return n.copy(n.content.append(N.from(sa(t,i,s+1))))}}function oa(i,e){if(e==0)return i;let t=i.content.replaceChild(i.childCount-1,oa(i.lastChild,e-1)),n=i.contentMatchAt(i.childCount).fillBefore(N.empty,!0);return i.copy(t.append(n))}function Wi(i,e,t,n,s,r){let o=e<0?i.firstChild:i.lastChild,a=o.content;return i.childCount>1&&(r=0),s<n-1&&(a=Wi(a,e,t,n,s+1,r)),s>=t&&(a=e<0?o.contentMatchAt(0).fillBefore(a,r<=s).append(a):a.append(o.contentMatchAt(o.childCount).fillBefore(N.empty,!0))),i.replaceChild(e<0?0:i.childCount-1,o.copy(a))}function gr(i,e,t){return e<i.openStart&&(i=new D(Wi(i.content,-1,e,i.openStart,0,i.openEnd),e,i.openEnd)),t<i.openEnd&&(i=new D(Wi(i.content,1,t,i.openEnd,0,0),i.openStart,t)),i}const aa={thead:["table"],tbody:["table"],tfoot:["table"],caption:["table"],colgroup:["table"],col:["table","colgroup"],tr:["table","tbody"],td:["table","tbody","tr"],th:["table","tbody","tr"]};let yr=null;function la(){return yr||(yr=document.implementation.createHTMLDocument("title"))}function $u(i){let e=/^(\s*<meta [^>]*>)*/.exec(i);e&&(i=i.slice(e[0].length));let t=la().createElement("div"),n=/<([a-z][^>\s]+)/i.exec(i),s;if((s=n&&aa[n[1].toLowerCase()])&&(i=s.map(r=>"<"+r+">").join("")+i+s.map(r=>"</"+r+">").reverse().join("")),t.innerHTML=i,s)for(let r=0;r<s.length;r++)t=t.querySelector(s[r])||t;return t}function Gu(i){let e=i.querySelectorAll(Te?"span:not([class]):not([style])":"span.Apple-converted-space");for(let t=0;t<e.length;t++){let n=e[t];n.childNodes.length==1&&n.textContent==" "&&n.parentNode&&n.parentNode.replaceChild(i.ownerDocument.createTextNode(" "),n)}}function Ku(i,e){if(!i.size)return i;let t=i.content.firstChild.type.schema,n;try{n=JSON.parse(e)}catch{return i}let{content:s,openStart:r,openEnd:o}=i;for(let a=n.length-2;a>=0;a-=2){let l=t.nodes[n[a]];if(!l||l.hasRequiredAttrs())break;s=N.from(l.create(n[a+1],s)),r++,o++}return new D(s,r,o)}const Oe={},Re={},Yu={touchstart:!0,touchmove:!0};class Zu{constructor(){this.shiftKey=!1,this.mouseDown=null,this.lastKeyCode=null,this.lastKeyCodeTime=0,this.lastClick={time:0,x:0,y:0,type:""},this.lastSelectionOrigin=null,this.lastSelectionTime=0,this.lastIOSEnter=0,this.lastIOSEnterFallbackTimeout=-1,this.lastFocus=0,this.lastTouch=0,this.lastAndroidDelete=0,this.composing=!1,this.compositionNode=null,this.composingTimeout=-1,this.compositionNodes=[],this.compositionEndedAt=-2e8,this.compositionID=1,this.compositionPendingChanges=0,this.domChangeCount=0,this.eventHandlers=Object.create(null),this.hideSelectionGuard=null}}function Qu(i){for(let e in Oe){let t=Oe[e];i.dom.addEventListener(e,i.input.eventHandlers[e]=n=>{ef(i,n)&&!ds(i,n)&&(i.editable||!(n.type in Re))&&t(i,n)},Yu[e]?{passive:!0}:void 0)}De&&i.dom.addEventListener("input",()=>null),Hi(i)}function Ct(i,e){i.input.lastSelectionOrigin=e,i.input.lastSelectionTime=Date.now()}function Xu(i){i.domObserver.stop();for(let e in i.input.eventHandlers)i.dom.removeEventListener(e,i.input.eventHandlers[e]);clearTimeout(i.input.composingTimeout),clearTimeout(i.input.lastIOSEnterFallbackTimeout)}function Hi(i){i.someProp("handleDOMEvents",e=>{for(let t in e)i.input.eventHandlers[t]||i.dom.addEventListener(t,i.input.eventHandlers[t]=n=>ds(i,n))})}function ds(i,e){return i.someProp("handleDOMEvents",t=>{let n=t[e.type];return n?n(i,e)||e.defaultPrevented:!1})}function ef(i,e){if(!e.bubbles)return!0;if(e.defaultPrevented)return!1;for(let t=e.target;t!=i.dom;t=t.parentNode)if(!t||t.nodeType==11||t.pmViewDesc&&t.pmViewDesc.stopEvent(e))return!1;return!0}function tf(i,e){!ds(i,e)&&Oe[e.type]&&(i.editable||!(e.type in Re))&&Oe[e.type](i,e)}Re.keydown=(i,e)=>{let t=e;if(i.input.shiftKey=t.keyCode==16||t.shiftKey,!da(i,t)&&(i.input.lastKeyCode=t.keyCode,i.input.lastKeyCodeTime=Date.now(),!($e&&Te&&t.keyCode==13)))if(t.keyCode!=229&&i.domObserver.forceFlush(),tn&&t.keyCode==13&&!t.ctrlKey&&!t.altKey&&!t.metaKey){let n=Date.now();i.input.lastIOSEnter=n,i.input.lastIOSEnterFallbackTimeout=setTimeout(()=>{i.input.lastIOSEnter==n&&(i.someProp("handleKeyDown",s=>s(i,Rt(13,"Enter"))),i.input.lastIOSEnter=0)},200)}else i.someProp("handleKeyDown",n=>n(i,t))||Wu(i,t)?t.preventDefault():Ct(i,"key")};Re.keyup=(i,e)=>{e.keyCode==16&&(i.input.shiftKey=!1)};Re.keypress=(i,e)=>{let t=e;if(da(i,t)||!t.charCode||t.ctrlKey&&!t.altKey||Ue&&t.metaKey)return;if(i.someProp("handleKeyPress",s=>s(i,t))){t.preventDefault();return}let n=i.state.selection;if(!(n instanceof ie)||!n.$from.sameParent(n.$to)){let s=String.fromCharCode(t.charCode);!/[\r\n]/.test(s)&&!i.someProp("handleTextInput",r=>r(i,n.$from.pos,n.$to.pos,s))&&i.dispatch(i.state.tr.insertText(s).scrollIntoView()),t.preventDefault()}};function si(i){return{left:i.clientX,top:i.clientY}}function nf(i,e){let t=e.x-i.clientX,n=e.y-i.clientY;return t*t+n*n<100}function hs(i,e,t,n,s){if(n==-1)return!1;let r=i.state.doc.resolve(n);for(let o=r.depth+1;o>0;o--)if(i.someProp(e,a=>o>r.depth?a(i,t,r.nodeAfter,r.before(o),s,!0):a(i,t,r.node(o),r.before(o),s,!1)))return!0;return!1}function Yt(i,e,t){i.focused||i.focus();let n=i.state.tr.setSelection(e);n.setMeta("pointer",!0),i.dispatch(n)}function sf(i,e){if(e==-1)return!1;let t=i.state.doc.resolve(e),n=t.nodeAfter;return n&&n.isAtom&&W.isSelectable(n)?(Yt(i,new W(t)),!0):!1}function rf(i,e){if(e==-1)return!1;let t=i.state.selection,n,s;t instanceof W&&(n=t.node);let r=i.state.doc.resolve(e);for(let o=r.depth+1;o>0;o--){let a=o>r.depth?r.nodeAfter:r.node(o);if(W.isSelectable(a)){n&&t.$from.depth>0&&o>=t.$from.depth&&r.before(t.$from.depth+1)==t.$from.pos?s=r.before(t.$from.depth):s=r.before(o);break}}return s!=null?(Yt(i,W.create(i.state.doc,s)),!0):!1}function of(i,e,t,n,s){return hs(i,"handleClickOn",e,t,n)||i.someProp("handleClick",r=>r(i,e,n))||(s?rf(i,t):sf(i,t))}function af(i,e,t,n){return hs(i,"handleDoubleClickOn",e,t,n)||i.someProp("handleDoubleClick",s=>s(i,e,n))}function lf(i,e,t,n){return hs(i,"handleTripleClickOn",e,t,n)||i.someProp("handleTripleClick",s=>s(i,e,n))||cf(i,t,n)}function cf(i,e,t){if(t.button!=0)return!1;let n=i.state.doc;if(e==-1)return n.inlineContent?(Yt(i,ie.create(n,0,n.content.size)),!0):!1;let s=n.resolve(e);for(let r=s.depth+1;r>0;r--){let o=r>s.depth?s.nodeAfter:s.node(r),a=s.before(r);if(o.inlineContent)Yt(i,ie.create(n,a+1,a+1+o.content.size));else if(W.isSelectable(o))Yt(i,W.create(n,a));else continue;return!0}}function us(i){return Kn(i)}const ca=Ue?"metaKey":"ctrlKey";Oe.mousedown=(i,e)=>{let t=e;i.input.shiftKey=t.shiftKey;let n=us(i),s=Date.now(),r="singleClick";s-i.input.lastClick.time<500&&nf(t,i.input.lastClick)&&!t[ca]&&(i.input.lastClick.type=="singleClick"?r="doubleClick":i.input.lastClick.type=="doubleClick"&&(r="tripleClick")),i.input.lastClick={time:s,x:t.clientX,y:t.clientY,type:r};let o=i.posAtCoords(si(t));o&&(r=="singleClick"?(i.input.mouseDown&&i.input.mouseDown.done(),i.input.mouseDown=new df(i,o,t,!!n)):(r=="doubleClick"?af:lf)(i,o.pos,o.inside,t)?t.preventDefault():Ct(i,"pointer"))};class df{constructor(e,t,n,s){this.view=e,this.pos=t,this.event=n,this.flushed=s,this.delayedSelectionSync=!1,this.mightDrag=null,this.startDoc=e.state.doc,this.selectNode=!!n[ca],this.allowDefault=n.shiftKey;let r,o;if(t.inside>-1)r=e.state.doc.nodeAt(t.inside),o=t.inside;else{let u=e.state.doc.resolve(t.pos);r=u.parent,o=u.depth?u.before():0}const a=s?null:n.target,l=a?e.docView.nearestDesc(a,!0):null;this.target=l&&l.dom.nodeType==1?l.dom:null;let{selection:d}=e.state;(n.button==0&&r.type.spec.draggable&&r.type.spec.selectable!==!1||d instanceof W&&d.from<=o&&d.to>o)&&(this.mightDrag={node:r,pos:o,addAttr:!!(this.target&&!this.target.draggable),setUneditable:!!(this.target&&Ze&&!this.target.hasAttribute("contentEditable"))}),this.target&&this.mightDrag&&(this.mightDrag.addAttr||this.mightDrag.setUneditable)&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&(this.target.draggable=!0),this.mightDrag.setUneditable&&setTimeout(()=>{this.view.input.mouseDown==this&&this.target.setAttribute("contentEditable","false")},20),this.view.domObserver.start()),e.root.addEventListener("mouseup",this.up=this.up.bind(this)),e.root.addEventListener("mousemove",this.move=this.move.bind(this)),Ct(e,"pointer")}done(){this.view.root.removeEventListener("mouseup",this.up),this.view.root.removeEventListener("mousemove",this.move),this.mightDrag&&this.target&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&this.target.removeAttribute("draggable"),this.mightDrag.setUneditable&&this.target.removeAttribute("contentEditable"),this.view.domObserver.start()),this.delayedSelectionSync&&setTimeout(()=>ht(this.view)),this.view.input.mouseDown=null}up(e){if(this.done(),!this.view.dom.contains(e.target))return;let t=this.pos;this.view.state.doc!=this.startDoc&&(t=this.view.posAtCoords(si(e))),this.updateAllowDefault(e),this.allowDefault||!t?Ct(this.view,"pointer"):of(this.view,t.pos,t.inside,e,this.selectNode)?e.preventDefault():e.button==0&&(this.flushed||De&&this.mightDrag&&!this.mightDrag.node.isAtom||Te&&!this.view.state.selection.visible&&Math.min(Math.abs(t.pos-this.view.state.selection.from),Math.abs(t.pos-this.view.state.selection.to))<=2)?(Yt(this.view,Q.near(this.view.state.doc.resolve(t.pos))),e.preventDefault()):Ct(this.view,"pointer")}move(e){this.updateAllowDefault(e),Ct(this.view,"pointer"),e.buttons==0&&this.done()}updateAllowDefault(e){!this.allowDefault&&(Math.abs(this.event.x-e.clientX)>4||Math.abs(this.event.y-e.clientY)>4)&&(this.allowDefault=!0)}}Oe.touchstart=i=>{i.input.lastTouch=Date.now(),us(i),Ct(i,"pointer")};Oe.touchmove=i=>{i.input.lastTouch=Date.now(),Ct(i,"pointer")};Oe.contextmenu=i=>us(i);function da(i,e){return i.composing?!0:De&&Math.abs(e.timeStamp-i.input.compositionEndedAt)<500?(i.input.compositionEndedAt=-2e8,!0):!1}const hf=$e?5e3:-1;Re.compositionstart=Re.compositionupdate=i=>{if(!i.composing){i.domObserver.flush();let{state:e}=i,t=e.selection.$from;if(e.selection.empty&&(e.storedMarks||!t.textOffset&&t.parentOffset&&t.nodeBefore.marks.some(n=>n.type.spec.inclusive===!1)))i.markCursor=i.state.storedMarks||t.marks(),Kn(i,!0),i.markCursor=null;else if(Kn(i),Ze&&e.selection.empty&&t.parentOffset&&!t.textOffset&&t.nodeBefore.marks.length){let n=i.domSelectionRange();for(let s=n.focusNode,r=n.focusOffset;s&&s.nodeType==1&&r!=0;){let o=r<0?s.lastChild:s.childNodes[r-1];if(!o)break;if(o.nodeType==3){i.domSelection().collapse(o,o.nodeValue.length);break}else s=o,r=-1}}i.input.composing=!0}ha(i,hf)};Re.compositionend=(i,e)=>{i.composing&&(i.input.composing=!1,i.input.compositionEndedAt=e.timeStamp,i.input.compositionPendingChanges=i.domObserver.pendingRecords().length?i.input.compositionID:0,i.input.compositionNode=null,i.input.compositionPendingChanges&&Promise.resolve().then(()=>i.domObserver.flush()),i.input.compositionID++,ha(i,20))};function ha(i,e){clearTimeout(i.input.composingTimeout),e>-1&&(i.input.composingTimeout=setTimeout(()=>Kn(i),e))}function ua(i){for(i.composing&&(i.input.composing=!1,i.input.compositionEndedAt=ff());i.input.compositionNodes.length>0;)i.input.compositionNodes.pop().markParentsDirty()}function uf(i){let e=i.domSelectionRange();if(!e.focusNode)return null;let t=su(e.focusNode,e.focusOffset),n=ru(e.focusNode,e.focusOffset);if(t&&n&&t!=n){let s=n.pmViewDesc,r=i.domObserver.lastChangedTextNode;if(t==r||n==r)return r;if(!s||!s.isText(n.nodeValue))return n;if(i.input.compositionNode==n){let o=t.pmViewDesc;if(!(!o||!o.isText(t.nodeValue)))return n}}return t||n}function ff(){let i=document.createEvent("Event");return i.initEvent("event",!0,!0),i.timeStamp}function Kn(i,e=!1){if(!($e&&i.domObserver.flushingSoon>=0)){if(i.domObserver.forceFlush(),ua(i),e||i.docView&&i.docView.dirty){let t=ls(i);return t&&!t.eq(i.state.selection)?i.dispatch(i.state.tr.setSelection(t)):i.updateState(i.state),!0}return!1}}function pf(i,e){if(!i.dom.parentNode)return;let t=i.dom.parentNode.appendChild(document.createElement("div"));t.appendChild(e),t.style.cssText="position: fixed; left: -10000px; top: 10px";let n=getSelection(),s=document.createRange();s.selectNodeContents(e),i.dom.blur(),n.removeAllRanges(),n.addRange(s),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t),i.focus()},50)}const wn=Fe&&Et<15||tn&&du<604;Oe.copy=Re.cut=(i,e)=>{let t=e,n=i.state.selection,s=t.type=="cut";if(n.empty)return;let r=wn?null:t.clipboardData,o=n.content(),{dom:a,text:l}=na(i,o);r?(t.preventDefault(),r.clearData(),r.setData("text/html",a.innerHTML),r.setData("text/plain",l)):pf(i,a),s&&i.dispatch(i.state.tr.deleteSelection().scrollIntoView().setMeta("uiEvent","cut"))};function mf(i){return i.openStart==0&&i.openEnd==0&&i.content.childCount==1?i.content.firstChild:null}function gf(i,e){if(!i.dom.parentNode)return;let t=i.input.shiftKey||i.state.selection.$from.parent.type.spec.code,n=i.dom.parentNode.appendChild(document.createElement(t?"textarea":"div"));t||(n.contentEditable="true"),n.style.cssText="position: fixed; left: -10000px; top: 10px",n.focus();let s=i.input.shiftKey&&i.input.lastKeyCode!=45;setTimeout(()=>{i.focus(),n.parentNode&&n.parentNode.removeChild(n),t?Sn(i,n.value,null,s,e):Sn(i,n.textContent,n.innerHTML,s,e)},50)}function Sn(i,e,t,n,s){let r=ia(i,e,t,n,i.state.selection.$from);if(i.someProp("handlePaste",l=>l(i,s,r||D.empty)))return!0;if(!r)return!1;let o=mf(r),a=o?i.state.tr.replaceSelectionWith(o,n):i.state.tr.replaceSelection(r);return i.dispatch(a.scrollIntoView().setMeta("paste",!0).setMeta("uiEvent","paste")),!0}function fa(i){let e=i.getData("text/plain")||i.getData("Text");if(e)return e;let t=i.getData("text/uri-list");return t?t.replace(/\r?\n/g," "):""}Re.paste=(i,e)=>{let t=e;if(i.composing&&!$e)return;let n=wn?null:t.clipboardData,s=i.input.shiftKey&&i.input.lastKeyCode!=45;n&&Sn(i,fa(n),n.getData("text/html"),s,t)?t.preventDefault():gf(i,t)};class pa{constructor(e,t,n){this.slice=e,this.move=t,this.node=n}}const ma=Ue?"altKey":"ctrlKey";Oe.dragstart=(i,e)=>{let t=e,n=i.input.mouseDown;if(n&&n.done(),!t.dataTransfer)return;let s=i.state.selection,r=s.empty?null:i.posAtCoords(si(t)),o;if(!(r&&r.pos>=s.from&&r.pos<=(s instanceof W?s.to-1:s.to))){if(n&&n.mightDrag)o=W.create(i.state.doc,n.mightDrag.pos);else if(t.target&&t.target.nodeType==1){let m=i.docView.nearestDesc(t.target,!0);m&&m.node.type.spec.draggable&&m!=i.docView&&(o=W.create(i.state.doc,m.posBefore))}}let a=(o||i.state.selection).content(),{dom:l,text:d,slice:u}=na(i,a);(!t.dataTransfer.files.length||!Te||zo>120)&&t.dataTransfer.clearData(),t.dataTransfer.setData(wn?"Text":"text/html",l.innerHTML),t.dataTransfer.effectAllowed="copyMove",wn||t.dataTransfer.setData("text/plain",d),i.dragging=new pa(u,!t[ma],o)};Oe.dragend=i=>{let e=i.dragging;window.setTimeout(()=>{i.dragging==e&&(i.dragging=null)},50)};Re.dragover=Re.dragenter=(i,e)=>e.preventDefault();Re.drop=(i,e)=>{let t=e,n=i.dragging;if(i.dragging=null,!t.dataTransfer)return;let s=i.posAtCoords(si(t));if(!s)return;let r=i.state.doc.resolve(s.pos),o=n&&n.slice;o?i.someProp("transformPasted",y=>{o=y(o,i)}):o=ia(i,fa(t.dataTransfer),wn?null:t.dataTransfer.getData("text/html"),!1,r);let a=!!(n&&!t[ma]);if(i.someProp("handleDrop",y=>y(i,t,o||D.empty,a))){t.preventDefault();return}if(!o)return;t.preventDefault();let l=o?qh(i.state.doc,r.pos,o):r.pos;l==null&&(l=r.pos);let d=i.state.tr;if(a){let{node:y}=n;y?y.replace(d):d.deleteSelection()}let u=d.mapping.map(l),m=o.openStart==0&&o.openEnd==0&&o.content.childCount==1,p=d.doc;if(m?d.replaceRangeWith(u,u,o.content.firstChild):d.replaceRange(u,u,o),d.doc.eq(p))return;let k=d.doc.resolve(u);if(m&&W.isSelectable(o.content.firstChild)&&k.nodeAfter&&k.nodeAfter.sameMarkup(o.content.firstChild))d.setSelection(new W(k));else{let y=d.mapping.map(l);d.mapping.maps[d.mapping.maps.length-1].forEach((S,w,E,_)=>y=_),d.setSelection(cs(i,k,d.doc.resolve(y)))}i.focus(),i.dispatch(d.setMeta("uiEvent","drop"))};Oe.focus=i=>{i.input.lastFocus=Date.now(),i.focused||(i.domObserver.stop(),i.dom.classList.add("ProseMirror-focused"),i.domObserver.start(),i.focused=!0,setTimeout(()=>{i.docView&&i.hasFocus()&&!i.domObserver.currentSelection.eq(i.domSelectionRange())&&ht(i)},20))};Oe.blur=(i,e)=>{let t=e;i.focused&&(i.domObserver.stop(),i.dom.classList.remove("ProseMirror-focused"),i.domObserver.start(),t.relatedTarget&&i.dom.contains(t.relatedTarget)&&i.domObserver.currentSelection.clear(),i.focused=!1)};Oe.beforeinput=(i,e)=>{if(Te&&$e&&e.inputType=="deleteContentBackward"){i.domObserver.flushSoon();let{domChangeCount:n}=i.input;setTimeout(()=>{if(i.input.domChangeCount!=n||(i.dom.blur(),i.focus(),i.someProp("handleKeyDown",r=>r(i,Rt(8,"Backspace")))))return;let{$cursor:s}=i.state.selection;s&&s.pos>0&&i.dispatch(i.state.tr.delete(s.pos-1,s.pos).scrollIntoView())},50)}};for(let i in Re)Oe[i]=Re[i];function Cn(i,e){if(i==e)return!0;for(let t in i)if(i[t]!==e[t])return!1;for(let t in e)if(!(t in i))return!1;return!0}class Yn{constructor(e,t){this.toDOM=e,this.spec=t||Pt,this.side=this.spec.side||0}map(e,t,n,s){let{pos:r,deleted:o}=e.mapResult(t.from+s,this.side<0?-1:1);return o?null:new Ge(r-n,r-n,this)}valid(){return!0}eq(e){return this==e||e instanceof Yn&&(this.spec.key&&this.spec.key==e.spec.key||this.toDOM==e.toDOM&&Cn(this.spec,e.spec))}destroy(e){this.spec.destroy&&this.spec.destroy(e)}}class It{constructor(e,t){this.attrs=e,this.spec=t||Pt}map(e,t,n,s){let r=e.map(t.from+s,this.spec.inclusiveStart?-1:1)-n,o=e.map(t.to+s,this.spec.inclusiveEnd?1:-1)-n;return r>=o?null:new Ge(r,o,this)}valid(e,t){return t.from<t.to}eq(e){return this==e||e instanceof It&&Cn(this.attrs,e.attrs)&&Cn(this.spec,e.spec)}static is(e){return e.type instanceof It}destroy(){}}class fs{constructor(e,t){this.attrs=e,this.spec=t||Pt}map(e,t,n,s){let r=e.mapResult(t.from+s,1);if(r.deleted)return null;let o=e.mapResult(t.to+s,-1);return o.deleted||o.pos<=r.pos?null:new Ge(r.pos-n,o.pos-n,this)}valid(e,t){let{index:n,offset:s}=e.content.findIndex(t.from),r;return s==t.from&&!(r=e.child(n)).isText&&s+r.nodeSize==t.to}eq(e){return this==e||e instanceof fs&&Cn(this.attrs,e.attrs)&&Cn(this.spec,e.spec)}destroy(){}}class Ge{constructor(e,t,n){this.from=e,this.to=t,this.type=n}copy(e,t){return new Ge(e,t,this.type)}eq(e,t=0){return this.type.eq(e.type)&&this.from+t==e.from&&this.to+t==e.to}map(e,t,n){return this.type.map(e,this,t,n)}static widget(e,t,n){return new Ge(e,e,new Yn(t,n))}static inline(e,t,n,s){return new Ge(e,t,new It(n,s))}static node(e,t,n,s){return new Ge(e,t,new fs(n,s))}get spec(){return this.type.spec}get inline(){return this.type instanceof It}get widget(){return this.type instanceof Yn}}const Gt=[],Pt={};class fe{constructor(e,t){this.local=e.length?e:Gt,this.children=t.length?t:Gt}static create(e,t){return t.length?Zn(t,e,0,Pt):Se}find(e,t,n){let s=[];return this.findInner(e??0,t??1e9,s,0,n),s}findInner(e,t,n,s,r){for(let o=0;o<this.local.length;o++){let a=this.local[o];a.from<=t&&a.to>=e&&(!r||r(a.spec))&&n.push(a.copy(a.from+s,a.to+s))}for(let o=0;o<this.children.length;o+=3)if(this.children[o]<t&&this.children[o+1]>e){let a=this.children[o]+1;this.children[o+2].findInner(e-a,t-a,n,s+a,r)}}map(e,t,n){return this==Se||e.maps.length==0?this:this.mapInner(e,t,0,0,n||Pt)}mapInner(e,t,n,s,r){let o;for(let a=0;a<this.local.length;a++){let l=this.local[a].map(e,n,s);l&&l.type.valid(t,l)?(o||(o=[])).push(l):r.onRemove&&r.onRemove(this.local[a].spec)}return this.children.length?yf(this.children,o||[],e,t,n,s,r):o?new fe(o.sort(jt),Gt):Se}add(e,t){return t.length?this==Se?fe.create(e,t):this.addInner(e,t,0):this}addInner(e,t,n){let s,r=0;e.forEach((a,l)=>{let d=l+n,u;if(u=ya(t,a,d)){for(s||(s=this.children.slice());r<s.length&&s[r]<l;)r+=3;s[r]==l?s[r+2]=s[r+2].addInner(a,u,d+1):s.splice(r,0,l,l+a.nodeSize,Zn(u,a,d+1,Pt)),r+=3}});let o=ga(r?xa(t):t,-n);for(let a=0;a<o.length;a++)o[a].type.valid(e,o[a])||o.splice(a--,1);return new fe(o.length?this.local.concat(o).sort(jt):this.local,s||this.children)}remove(e){return e.length==0||this==Se?this:this.removeInner(e,0)}removeInner(e,t){let n=this.children,s=this.local;for(let r=0;r<n.length;r+=3){let o,a=n[r]+t,l=n[r+1]+t;for(let u=0,m;u<e.length;u++)(m=e[u])&&m.from>a&&m.to<l&&(e[u]=null,(o||(o=[])).push(m));if(!o)continue;n==this.children&&(n=this.children.slice());let d=n[r+2].removeInner(o,a+1);d!=Se?n[r+2]=d:(n.splice(r,3),r-=3)}if(s.length){for(let r=0,o;r<e.length;r++)if(o=e[r])for(let a=0;a<s.length;a++)s[a].eq(o,t)&&(s==this.local&&(s=this.local.slice()),s.splice(a--,1))}return n==this.children&&s==this.local?this:s.length||n.length?new fe(s,n):Se}forChild(e,t){if(this==Se)return this;if(t.isLeaf)return fe.empty;let n,s;for(let a=0;a<this.children.length;a+=3)if(this.children[a]>=e){this.children[a]==e&&(n=this.children[a+2]);break}let r=e+1,o=r+t.content.size;for(let a=0;a<this.local.length;a++){let l=this.local[a];if(l.from<o&&l.to>r&&l.type instanceof It){let d=Math.max(r,l.from)-r,u=Math.min(o,l.to)-r;d<u&&(s||(s=[])).push(l.copy(d,u))}}if(s){let a=new fe(s.sort(jt),Gt);return n?new bt([a,n]):a}return n||Se}eq(e){if(this==e)return!0;if(!(e instanceof fe)||this.local.length!=e.local.length||this.children.length!=e.children.length)return!1;for(let t=0;t<this.local.length;t++)if(!this.local[t].eq(e.local[t]))return!1;for(let t=0;t<this.children.length;t+=3)if(this.children[t]!=e.children[t]||this.children[t+1]!=e.children[t+1]||!this.children[t+2].eq(e.children[t+2]))return!1;return!0}locals(e){return ps(this.localsInner(e))}localsInner(e){if(this==Se)return Gt;if(e.inlineContent||!this.local.some(It.is))return this.local;let t=[];for(let n=0;n<this.local.length;n++)this.local[n].type instanceof It||t.push(this.local[n]);return t}}fe.empty=new fe([],[]);fe.removeOverlap=ps;const Se=fe.empty;class bt{constructor(e){this.members=e}map(e,t){const n=this.members.map(s=>s.map(e,t,Pt));return bt.from(n)}forChild(e,t){if(t.isLeaf)return fe.empty;let n=[];for(let s=0;s<this.members.length;s++){let r=this.members[s].forChild(e,t);r!=Se&&(r instanceof bt?n=n.concat(r.members):n.push(r))}return bt.from(n)}eq(e){if(!(e instanceof bt)||e.members.length!=this.members.length)return!1;for(let t=0;t<this.members.length;t++)if(!this.members[t].eq(e.members[t]))return!1;return!0}locals(e){let t,n=!0;for(let s=0;s<this.members.length;s++){let r=this.members[s].localsInner(e);if(r.length)if(!t)t=r;else{n&&(t=t.slice(),n=!1);for(let o=0;o<r.length;o++)t.push(r[o])}}return t?ps(n?t:t.sort(jt)):Gt}static from(e){switch(e.length){case 0:return Se;case 1:return e[0];default:return new bt(e.every(t=>t instanceof fe)?e:e.reduce((t,n)=>t.concat(n instanceof fe?n:n.members),[]))}}}function yf(i,e,t,n,s,r,o){let a=i.slice();for(let d=0,u=r;d<t.maps.length;d++){let m=0;t.maps[d].forEach((p,k,y,S)=>{let w=S-y-(k-p);for(let E=0;E<a.length;E+=3){let _=a[E+1];if(_<0||p>_+u-m)continue;let L=a[E]+u-m;k>=L?a[E+1]=p<=L?-2:-1:p>=u&&w&&(a[E]+=w,a[E+1]+=w)}m+=w}),u=t.maps[d].map(u,-1)}let l=!1;for(let d=0;d<a.length;d+=3)if(a[d+1]<0){if(a[d+1]==-2){l=!0,a[d+1]=-1;continue}let u=t.map(i[d]+r),m=u-s;if(m<0||m>=n.content.size){l=!0;continue}let p=t.map(i[d+1]+r,-1),k=p-s,{index:y,offset:S}=n.content.findIndex(m),w=n.maybeChild(y);if(w&&S==m&&S+w.nodeSize==k){let E=a[d+2].mapInner(t,w,u+1,i[d]+r+1,o);E!=Se?(a[d]=m,a[d+1]=k,a[d+2]=E):(a[d+1]=-2,l=!0)}else l=!0}if(l){let d=xf(a,i,e,t,s,r,o),u=Zn(d,n,0,o);e=u.local;for(let m=0;m<a.length;m+=3)a[m+1]<0&&(a.splice(m,3),m-=3);for(let m=0,p=0;m<u.children.length;m+=3){let k=u.children[m];for(;p<a.length&&a[p]<k;)p+=3;a.splice(p,0,u.children[m],u.children[m+1],u.children[m+2])}}return new fe(e.sort(jt),a)}function ga(i,e){if(!e||!i.length)return i;let t=[];for(let n=0;n<i.length;n++){let s=i[n];t.push(new Ge(s.from+e,s.to+e,s.type))}return t}function xf(i,e,t,n,s,r,o){function a(l,d){for(let u=0;u<l.local.length;u++){let m=l.local[u].map(n,s,d);m?t.push(m):o.onRemove&&o.onRemove(l.local[u].spec)}for(let u=0;u<l.children.length;u+=3)a(l.children[u+2],l.children[u]+d+1)}for(let l=0;l<i.length;l+=3)i[l+1]==-1&&a(i[l+2],e[l]+r+1);return t}function ya(i,e,t){if(e.isLeaf)return null;let n=t+e.nodeSize,s=null;for(let r=0,o;r<i.length;r++)(o=i[r])&&o.from>t&&o.to<n&&((s||(s=[])).push(o),i[r]=null);return s}function xa(i){let e=[];for(let t=0;t<i.length;t++)i[t]!=null&&e.push(i[t]);return e}function Zn(i,e,t,n){let s=[],r=!1;e.forEach((a,l)=>{let d=ya(i,a,l+t);if(d){r=!0;let u=Zn(d,a,t+l+1,n);u!=Se&&s.push(l,l+a.nodeSize,u)}});let o=ga(r?xa(i):i,-t).sort(jt);for(let a=0;a<o.length;a++)o[a].type.valid(e,o[a])||(n.onRemove&&n.onRemove(o[a].spec),o.splice(a--,1));return o.length||s.length?new fe(o,s):Se}function jt(i,e){return i.from-e.from||i.to-e.to}function ps(i){let e=i;for(let t=0;t<e.length-1;t++){let n=e[t];if(n.from!=n.to)for(let s=t+1;s<e.length;s++){let r=e[s];if(r.from==n.from){r.to!=n.to&&(e==i&&(e=i.slice()),e[s]=r.copy(r.from,n.to),xr(e,s+1,r.copy(n.to,r.to)));continue}else{r.from<n.to&&(e==i&&(e=i.slice()),e[t]=n.copy(n.from,r.from),xr(e,s,n.copy(r.from,n.to)));break}}}return e}function xr(i,e,t){for(;e<i.length&&jt(t,i[e])>0;)e++;i.splice(e,0,t)}function bi(i){let e=[];return i.someProp("decorations",t=>{let n=t(i.state);n&&n!=Se&&e.push(n)}),i.cursorWrapper&&e.push(fe.create(i.state.doc,[i.cursorWrapper.deco])),bt.from(e)}const kf={childList:!0,characterData:!0,characterDataOldValue:!0,attributes:!0,attributeOldValue:!0,subtree:!0},bf=Fe&&Et<=11;class wf{constructor(){this.anchorNode=null,this.anchorOffset=0,this.focusNode=null,this.focusOffset=0}set(e){this.anchorNode=e.anchorNode,this.anchorOffset=e.anchorOffset,this.focusNode=e.focusNode,this.focusOffset=e.focusOffset}clear(){this.anchorNode=this.focusNode=null}eq(e){return e.anchorNode==this.anchorNode&&e.anchorOffset==this.anchorOffset&&e.focusNode==this.focusNode&&e.focusOffset==this.focusOffset}}class Sf{constructor(e,t){this.view=e,this.handleDOMChange=t,this.queue=[],this.flushingSoon=-1,this.observer=null,this.currentSelection=new wf,this.onCharData=null,this.suppressingSelectionUpdates=!1,this.lastChangedTextNode=null,this.observer=window.MutationObserver&&new window.MutationObserver(n=>{for(let s=0;s<n.length;s++)this.queue.push(n[s]);Fe&&Et<=11&&n.some(s=>s.type=="childList"&&s.removedNodes.length||s.type=="characterData"&&s.oldValue.length>s.target.nodeValue.length)?this.flushSoon():this.flush()}),bf&&(this.onCharData=n=>{this.queue.push({target:n.target,type:"characterData",oldValue:n.prevValue}),this.flushSoon()}),this.onSelectionChange=this.onSelectionChange.bind(this)}flushSoon(){this.flushingSoon<0&&(this.flushingSoon=window.setTimeout(()=>{this.flushingSoon=-1,this.flush()},20))}forceFlush(){this.flushingSoon>-1&&(window.clearTimeout(this.flushingSoon),this.flushingSoon=-1,this.flush())}start(){this.observer&&(this.observer.takeRecords(),this.observer.observe(this.view.dom,kf)),this.onCharData&&this.view.dom.addEventListener("DOMCharacterDataModified",this.onCharData),this.connectSelection()}stop(){if(this.observer){let e=this.observer.takeRecords();if(e.length){for(let t=0;t<e.length;t++)this.queue.push(e[t]);window.setTimeout(()=>this.flush(),20)}this.observer.disconnect()}this.onCharData&&this.view.dom.removeEventListener("DOMCharacterDataModified",this.onCharData),this.disconnectSelection()}connectSelection(){this.view.dom.ownerDocument.addEventListener("selectionchange",this.onSelectionChange)}disconnectSelection(){this.view.dom.ownerDocument.removeEventListener("selectionchange",this.onSelectionChange)}suppressSelectionUpdates(){this.suppressingSelectionUpdates=!0,setTimeout(()=>this.suppressingSelectionUpdates=!1,50)}onSelectionChange(){if(dr(this.view)){if(this.suppressingSelectionUpdates)return ht(this.view);if(Fe&&Et<=11&&!this.view.state.selection.empty){let e=this.view.domSelectionRange();if(e.focusNode&&zt(e.focusNode,e.focusOffset,e.anchorNode,e.anchorOffset))return this.flushSoon()}this.flush()}}setCurSelection(){this.currentSelection.set(this.view.domSelectionRange())}ignoreSelectionChange(e){if(!e.focusNode)return!0;let t=new Set,n;for(let r=e.focusNode;r;r=bn(r))t.add(r);for(let r=e.anchorNode;r;r=bn(r))if(t.has(r)){n=r;break}let s=n&&this.view.docView.nearestDesc(n);if(s&&s.ignoreMutation({type:"selection",target:n.nodeType==3?n.parentNode:n}))return this.setCurSelection(),!0}pendingRecords(){if(this.observer)for(let e of this.observer.takeRecords())this.queue.push(e);return this.queue}flush(){let{view:e}=this;if(!e.docView||this.flushingSoon>-1)return;let t=this.pendingRecords();t.length&&(this.queue=[]);let n=e.domSelectionRange(),s=!this.suppressingSelectionUpdates&&!this.currentSelection.eq(n)&&dr(e)&&!this.ignoreSelectionChange(n),r=-1,o=-1,a=!1,l=[];if(e.editable)for(let u=0;u<t.length;u++){let m=this.registerMutation(t[u],l);m&&(r=r<0?m.from:Math.min(m.from,r),o=o<0?m.to:Math.max(m.to,o),m.typeOver&&(a=!0))}if(Ze&&l.length){let u=l.filter(m=>m.nodeName=="BR");if(u.length==2){let[m,p]=u;m.parentNode&&m.parentNode.parentNode==p.parentNode?p.remove():m.remove()}else{let{focusNode:m}=this.currentSelection;for(let p of u){let k=p.parentNode;k&&k.nodeName=="LI"&&(!m||Ef(e,m)!=k)&&p.remove()}}}let d=null;r<0&&s&&e.input.lastFocus>Date.now()-200&&Math.max(e.input.lastTouch,e.input.lastClick.time)<Date.now()-300&&ni(n)&&(d=ls(e))&&d.eq(Q.near(e.state.doc.resolve(0),1))?(e.input.lastFocus=0,ht(e),this.currentSelection.set(n),e.scrollToSelection()):(r>-1||s)&&(r>-1&&(e.docView.markDirty(r,o),Cf(e)),this.handleDOMChange(r,o,a,l),e.docView&&e.docView.dirty?e.updateState(e.state):this.currentSelection.eq(n)||ht(e),this.currentSelection.set(n))}registerMutation(e,t){if(t.indexOf(e.target)>-1)return null;let n=this.view.docView.nearestDesc(e.target);if(e.type=="attributes"&&(n==this.view.docView||e.attributeName=="contenteditable"||e.attributeName=="style"&&!e.oldValue&&!e.target.getAttribute("style"))||!n||n.ignoreMutation(e))return null;if(e.type=="childList"){for(let u=0;u<e.addedNodes.length;u++){let m=e.addedNodes[u];t.push(m),m.nodeType==3&&(this.lastChangedTextNode=m)}if(n.contentDOM&&n.contentDOM!=n.dom&&!n.contentDOM.contains(e.target))return{from:n.posBefore,to:n.posAfter};let s=e.previousSibling,r=e.nextSibling;if(Fe&&Et<=11&&e.addedNodes.length)for(let u=0;u<e.addedNodes.length;u++){let{previousSibling:m,nextSibling:p}=e.addedNodes[u];(!m||Array.prototype.indexOf.call(e.addedNodes,m)<0)&&(s=m),(!p||Array.prototype.indexOf.call(e.addedNodes,p)<0)&&(r=p)}let o=s&&s.parentNode==e.target?ge(s)+1:0,a=n.localPosFromDOM(e.target,o,-1),l=r&&r.parentNode==e.target?ge(r):e.target.childNodes.length,d=n.localPosFromDOM(e.target,l,1);return{from:a,to:d}}else return e.type=="attributes"?{from:n.posAtStart-n.border,to:n.posAtEnd+n.border}:(this.lastChangedTextNode=e.target,{from:n.posAtStart,to:n.posAtEnd,typeOver:e.target.nodeValue==e.oldValue})}}let kr=new WeakMap,br=!1;function Cf(i){if(!kr.has(i)&&(kr.set(i,null),["normal","nowrap","pre-line"].indexOf(getComputedStyle(i.dom).whiteSpace)!==-1)){if(i.requiresGeckoHackNode=Ze,br)return;console.warn("ProseMirror expects the CSS white-space property to be set, preferably to 'pre-wrap'. It is recommended to load style/prosemirror.css from the prosemirror-view package."),br=!0}}function wr(i,e){let t=e.startContainer,n=e.startOffset,s=e.endContainer,r=e.endOffset,o=i.domAtPos(i.state.selection.anchor);return zt(o.node,o.offset,s,r)&&([t,n,s,r]=[s,r,t,n]),{anchorNode:t,anchorOffset:n,focusNode:s,focusOffset:r}}function Tf(i,e){if(e.getComposedRanges){let s=e.getComposedRanges(i.root)[0];if(s)return wr(i,s)}let t;function n(s){s.preventDefault(),s.stopImmediatePropagation(),t=s.getTargetRanges()[0]}return i.dom.addEventListener("beforeinput",n,!0),document.execCommand("indent"),i.dom.removeEventListener("beforeinput",n,!0),t?wr(i,t):null}function Ef(i,e){for(let t=e.parentNode;t&&t!=i.dom;t=t.parentNode){let n=i.docView.nearestDesc(t,!0);if(n&&n.node.isBlock)return t}return null}function Mf(i,e,t){let{node:n,fromOffset:s,toOffset:r,from:o,to:a}=i.docView.parseRange(e,t),l=i.domSelectionRange(),d,u=l.anchorNode;if(u&&i.dom.contains(u.nodeType==1?u:u.parentNode)&&(d=[{node:u,offset:l.anchorOffset}],ni(l)||d.push({node:l.focusNode,offset:l.focusOffset})),Te&&i.input.lastKeyCode===8)for(let w=r;w>s;w--){let E=n.childNodes[w-1],_=E.pmViewDesc;if(E.nodeName=="BR"&&!_){r=w;break}if(!_||_.size)break}let m=i.state.doc,p=i.someProp("domParser")||xn.fromSchema(i.state.schema),k=m.resolve(o),y=null,S=p.parse(n,{topNode:k.parent,topMatch:k.parent.contentMatchAt(k.index()),topOpen:!0,from:s,to:r,preserveWhitespace:k.parent.type.whitespace=="pre"?"full":!0,findPositions:d,ruleFromNode:If,context:k});if(d&&d[0].pos!=null){let w=d[0].pos,E=d[1]&&d[1].pos;E==null&&(E=w),y={anchor:w+o,head:E+o}}return{doc:S,sel:y,from:o,to:a}}function If(i){let e=i.pmViewDesc;if(e)return e.parseRule();if(i.nodeName=="BR"&&i.parentNode){if(De&&/^(ul|ol)$/i.test(i.parentNode.nodeName)){let t=document.createElement("div");return t.appendChild(document.createElement("li")),{skip:t}}else if(i.parentNode.lastChild==i||De&&/^(tr|table)$/i.test(i.parentNode.nodeName))return{ignore:!0}}else if(i.nodeName=="IMG"&&i.getAttribute("mark-placeholder"))return{ignore:!0};return null}const Nf=/^(a|abbr|acronym|b|bd[io]|big|br|button|cite|code|data(list)?|del|dfn|em|i|ins|kbd|label|map|mark|meter|output|q|ruby|s|samp|small|span|strong|su[bp]|time|u|tt|var)$/i;function _f(i,e,t,n,s){let r=i.input.compositionPendingChanges||(i.composing?i.input.compositionID:0);if(i.input.compositionPendingChanges=0,e<0){let O=i.input.lastSelectionTime>Date.now()-50?i.input.lastSelectionOrigin:null,J=ls(i,O);if(J&&!i.state.selection.eq(J)){if(Te&&$e&&i.input.lastKeyCode===13&&Date.now()-100<i.input.lastKeyCodeTime&&i.someProp("handleKeyDown",X=>X(i,Rt(13,"Enter"))))return;let ae=i.state.tr.setSelection(J);O=="pointer"?ae.setMeta("pointer",!0):O=="key"&&ae.scrollIntoView(),r&&ae.setMeta("composition",r),i.dispatch(ae)}return}let o=i.state.doc.resolve(e),a=o.sharedDepth(t);e=o.before(a+1),t=i.state.doc.resolve(t).after(a+1);let l=i.state.selection,d=Mf(i,e,t),u=i.state.doc,m=u.slice(d.from,d.to),p,k;i.input.lastKeyCode===8&&Date.now()-100<i.input.lastKeyCodeTime?(p=i.state.selection.to,k="end"):(p=i.state.selection.from,k="start"),i.input.lastKeyCode=null;let y=Rf(m.content,d.doc.content,d.from,p,k);if((tn&&i.input.lastIOSEnter>Date.now()-225||$e)&&s.some(O=>O.nodeType==1&&!Nf.test(O.nodeName))&&(!y||y.endA>=y.endB)&&i.someProp("handleKeyDown",O=>O(i,Rt(13,"Enter")))){i.input.lastIOSEnter=0;return}if(!y)if(n&&l instanceof ie&&!l.empty&&l.$head.sameParent(l.$anchor)&&!i.composing&&!(d.sel&&d.sel.anchor!=d.sel.head))y={start:l.from,endA:l.to,endB:l.to};else{if(d.sel){let O=Sr(i,i.state.doc,d.sel);if(O&&!O.eq(i.state.selection)){let J=i.state.tr.setSelection(O);r&&J.setMeta("composition",r),i.dispatch(J)}}return}i.input.domChangeCount++,i.state.selection.from<i.state.selection.to&&y.start==y.endB&&i.state.selection instanceof ie&&(y.start>i.state.selection.from&&y.start<=i.state.selection.from+2&&i.state.selection.from>=d.from?y.start=i.state.selection.from:y.endA<i.state.selection.to&&y.endA>=i.state.selection.to-2&&i.state.selection.to<=d.to&&(y.endB+=i.state.selection.to-y.endA,y.endA=i.state.selection.to)),Fe&&Et<=11&&y.endB==y.start+1&&y.endA==y.start&&y.start>d.from&&d.doc.textBetween(y.start-d.from-1,y.start-d.from+1)=="  "&&(y.start--,y.endA--,y.endB--);let S=d.doc.resolveNoCache(y.start-d.from),w=d.doc.resolveNoCache(y.endB-d.from),E=u.resolve(y.start),_=S.sameParent(w)&&S.parent.inlineContent&&E.end()>=y.endA,L;if((tn&&i.input.lastIOSEnter>Date.now()-225&&(!_||s.some(O=>O.nodeName=="DIV"||O.nodeName=="P"))||!_&&S.pos<d.doc.content.size&&!S.sameParent(w)&&(L=Q.findFrom(d.doc.resolve(S.pos+1),1,!0))&&L.head==w.pos)&&i.someProp("handleKeyDown",O=>O(i,Rt(13,"Enter")))){i.input.lastIOSEnter=0;return}if(i.state.selection.anchor>y.start&&Of(u,y.start,y.endA,S,w)&&i.someProp("handleKeyDown",O=>O(i,Rt(8,"Backspace")))){$e&&Te&&i.domObserver.suppressSelectionUpdates();return}Te&&$e&&y.endB==y.start&&(i.input.lastAndroidDelete=Date.now()),$e&&!_&&S.start()!=w.start()&&w.parentOffset==0&&S.depth==w.depth&&d.sel&&d.sel.anchor==d.sel.head&&d.sel.head==y.endA&&(y.endB-=2,w=d.doc.resolveNoCache(y.endB-d.from),setTimeout(()=>{i.someProp("handleKeyDown",function(O){return O(i,Rt(13,"Enter"))})},20));let U=y.start,M=y.endA,A,H,z;if(_){if(S.pos==w.pos)Fe&&Et<=11&&S.parentOffset==0&&(i.domObserver.suppressSelectionUpdates(),setTimeout(()=>ht(i),20)),A=i.state.tr.delete(U,M),H=u.resolve(y.start).marksAcross(u.resolve(y.endA));else if(y.endA==y.endB&&(z=Df(S.parent.content.cut(S.parentOffset,w.parentOffset),E.parent.content.cut(E.parentOffset,y.endA-E.start()))))A=i.state.tr,z.type=="add"?A.addMark(U,M,z.mark):A.removeMark(U,M,z.mark);else if(S.parent.child(S.index()).isText&&S.index()==w.index()-(w.textOffset?0:1)){let O=S.parent.textBetween(S.parentOffset,w.parentOffset);if(i.someProp("handleTextInput",J=>J(i,U,M,O)))return;A=i.state.tr.insertText(O,U,M)}}if(A||(A=i.state.tr.replace(U,M,d.doc.slice(y.start-d.from,y.endB-d.from))),d.sel){let O=Sr(i,A.doc,d.sel);O&&!(Te&&$e&&i.composing&&O.empty&&(y.start!=y.endB||i.input.lastAndroidDelete<Date.now()-100)&&(O.head==U||O.head==A.mapping.map(M)-1)||Fe&&O.empty&&O.head==U)&&A.setSelection(O)}H&&A.ensureMarks(H),r&&A.setMeta("composition",r),i.dispatch(A.scrollIntoView())}function Sr(i,e,t){return Math.max(t.anchor,t.head)>e.content.size?null:cs(i,e.resolve(t.anchor),e.resolve(t.head))}function Df(i,e){let t=i.firstChild.marks,n=e.firstChild.marks,s=t,r=n,o,a,l;for(let u=0;u<n.length;u++)s=n[u].removeFromSet(s);for(let u=0;u<t.length;u++)r=t[u].removeFromSet(r);if(s.length==1&&r.length==0)a=s[0],o="add",l=u=>u.mark(a.addToSet(u.marks));else if(s.length==0&&r.length==1)a=r[0],o="remove",l=u=>u.mark(a.removeFromSet(u.marks));else return null;let d=[];for(let u=0;u<e.childCount;u++)d.push(l(e.child(u)));if(N.from(d).eq(i))return{mark:a,type:o}}function Of(i,e,t,n,s){if(t-e<=s.pos-n.pos||wi(n,!0,!1)<s.pos)return!1;let r=i.resolve(e);if(!n.parent.isTextblock){let a=r.nodeAfter;return a!=null&&t==e+a.nodeSize}if(r.parentOffset<r.parent.content.size||!r.parent.isTextblock)return!1;let o=i.resolve(wi(r,!0,!0));return!o.parent.isTextblock||o.pos>t||wi(o,!0,!1)<t?!1:n.parent.content.cut(n.parentOffset).eq(o.parent.content)}function wi(i,e,t){let n=i.depth,s=e?i.end():i.pos;for(;n>0&&(e||i.indexAfter(n)==i.node(n).childCount);)n--,s++,e=!1;if(t){let r=i.node(n).maybeChild(i.indexAfter(n));for(;r&&!r.isLeaf;)r=r.firstChild,s++}return s}function Rf(i,e,t,n,s){let r=i.findDiffStart(e,t);if(r==null)return null;let{a:o,b:a}=i.findDiffEnd(e,t+i.size,t+e.size);if(s=="end"){let l=Math.max(0,r-Math.min(o,a));n-=o+l-r}if(o<r&&i.size<e.size){let l=n<=r&&n>=o?r-n:0;r-=l,r&&r<e.size&&Cr(e.textBetween(r-1,r+1))&&(r+=l?1:-1),a=r+(a-o),o=r}else if(a<r){let l=n<=r&&n>=a?r-n:0;r-=l,r&&r<i.size&&Cr(i.textBetween(r-1,r+1))&&(r+=l?1:-1),o=r+(o-a),a=r}return{start:r,endA:o,endB:a}}function Cr(i){if(i.length!=2)return!1;let e=i.charCodeAt(0),t=i.charCodeAt(1);return e>=56320&&e<=57343&&t>=55296&&t<=56319}class qm{constructor(e,t){this._root=null,this.focused=!1,this.trackWrites=null,this.mounted=!1,this.markCursor=null,this.cursorWrapper=null,this.lastSelectedViewDesc=void 0,this.input=new Zu,this.prevDirectPlugins=[],this.pluginViews=[],this.requiresGeckoHackNode=!1,this.dragging=null,this._props=t,this.state=t.state,this.directPlugins=t.plugins||[],this.directPlugins.forEach(Nr),this.dispatch=this.dispatch.bind(this),this.dom=e&&e.mount||document.createElement("div"),e&&(e.appendChild?e.appendChild(this.dom):typeof e=="function"?e(this.dom):e.mount&&(this.mounted=!0)),this.editable=Mr(this),Er(this),this.nodeViews=Ir(this),this.docView=sr(this.state.doc,Tr(this),bi(this),this.dom,this),this.domObserver=new Sf(this,(n,s,r,o)=>_f(this,n,s,r,o)),this.domObserver.start(),Qu(this),this.updatePluginViews()}get composing(){return this.input.composing}get props(){if(this._props.state!=this.state){let e=this._props;this._props={};for(let t in e)this._props[t]=e[t];this._props.state=this.state}return this._props}update(e){e.handleDOMEvents!=this._props.handleDOMEvents&&Hi(this);let t=this._props;this._props=e,e.plugins&&(e.plugins.forEach(Nr),this.directPlugins=e.plugins),this.updateStateInner(e.state,t)}setProps(e){let t={};for(let n in this._props)t[n]=this._props[n];t.state=this.state;for(let n in e)t[n]=e[n];this.update(t)}updateState(e){this.updateStateInner(e,this._props)}updateStateInner(e,t){var n;let s=this.state,r=!1,o=!1;e.storedMarks&&this.composing&&(ua(this),o=!0),this.state=e;let a=s.plugins!=e.plugins||this._props.plugins!=t.plugins;if(a||this._props.plugins!=t.plugins||this._props.nodeViews!=t.nodeViews){let k=Ir(this);vf(k,this.nodeViews)&&(this.nodeViews=k,r=!0)}(a||t.handleDOMEvents!=this._props.handleDOMEvents)&&Hi(this),this.editable=Mr(this),Er(this);let l=bi(this),d=Tr(this),u=s.plugins!=e.plugins&&!s.doc.eq(e.doc)?"reset":e.scrollToSelection>s.scrollToSelection?"to selection":"preserve",m=r||!this.docView.matchesNode(e.doc,d,l);(m||!e.selection.eq(s.selection))&&(o=!0);let p=u=="preserve"&&o&&this.dom.style.overflowAnchor==null&&fu(this);if(o){this.domObserver.stop();let k=m&&(Fe||Te)&&!this.composing&&!s.selection.empty&&!e.selection.empty&&Af(s.selection,e.selection);if(m){let y=Te?this.trackWrites=this.domSelectionRange().focusNode:null;this.composing&&(this.input.compositionNode=uf(this)),(r||!this.docView.update(e.doc,d,l,this))&&(this.docView.updateOuterDeco(d),this.docView.destroy(),this.docView=sr(e.doc,d,l,this.dom,this)),y&&!this.trackWrites&&(k=!0)}k||!(this.input.mouseDown&&this.domObserver.currentSelection.eq(this.domSelectionRange())&&Pu(this))?ht(this,k):(Xo(this,e.selection),this.domObserver.setCurSelection()),this.domObserver.start()}this.updatePluginViews(s),!((n=this.dragging)===null||n===void 0)&&n.node&&!s.doc.eq(e.doc)&&this.updateDraggedNode(this.dragging,s),u=="reset"?this.dom.scrollTop=0:u=="to selection"?this.scrollToSelection():p&&pu(p)}scrollToSelection(){let e=this.domSelectionRange().focusNode;if(!this.someProp("handleScrollToSelection",t=>t(this)))if(this.state.selection instanceof W){let t=this.docView.domAfterPos(this.state.selection.from);t.nodeType==1&&Qs(this,t.getBoundingClientRect(),e)}else Qs(this,this.coordsAtPos(this.state.selection.head,1),e)}destroyPluginViews(){let e;for(;e=this.pluginViews.pop();)e.destroy&&e.destroy()}updatePluginViews(e){if(!e||e.plugins!=this.state.plugins||this.directPlugins!=this.prevDirectPlugins){this.prevDirectPlugins=this.directPlugins,this.destroyPluginViews();for(let t=0;t<this.directPlugins.length;t++){let n=this.directPlugins[t];n.spec.view&&this.pluginViews.push(n.spec.view(this))}for(let t=0;t<this.state.plugins.length;t++){let n=this.state.plugins[t];n.spec.view&&this.pluginViews.push(n.spec.view(this))}}else for(let t=0;t<this.pluginViews.length;t++){let n=this.pluginViews[t];n.update&&n.update(this,e)}}updateDraggedNode(e,t){let n=e.node,s=-1;if(this.state.doc.nodeAt(n.from)==n.node)s=n.from;else{let r=n.from+(this.state.doc.content.size-t.doc.content.size);(r>0&&this.state.doc.nodeAt(r))==n.node&&(s=r)}this.dragging=new pa(e.slice,e.move,s<0?void 0:W.create(this.state.doc,s))}someProp(e,t){let n=this._props&&this._props[e],s;if(n!=null&&(s=t?t(n):n))return s;for(let o=0;o<this.directPlugins.length;o++){let a=this.directPlugins[o].props[e];if(a!=null&&(s=t?t(a):a))return s}let r=this.state.plugins;if(r)for(let o=0;o<r.length;o++){let a=r[o].props[e];if(a!=null&&(s=t?t(a):a))return s}}hasFocus(){if(Fe){let e=this.root.activeElement;if(e==this.dom)return!0;if(!e||!this.dom.contains(e))return!1;for(;e&&this.dom!=e&&this.dom.contains(e);){if(e.contentEditable=="false")return!1;e=e.parentElement}return!0}return this.root.activeElement==this.dom}focus(){this.domObserver.stop(),this.editable&&mu(this.dom),ht(this),this.domObserver.start()}get root(){let e=this._root;if(e==null){for(let t=this.dom.parentNode;t;t=t.parentNode)if(t.nodeType==9||t.nodeType==11&&t.host)return t.getSelection||(Object.getPrototypeOf(t).getSelection=()=>t.ownerDocument.getSelection()),this._root=t}return e||document}updateRoot(){this._root=null}posAtCoords(e){return bu(this,e)}coordsAtPos(e,t=1){return Ho(this,e,t)}domAtPos(e,t=0){return this.docView.domFromPos(e,t)}nodeDOM(e){let t=this.docView.descAt(e);return t?t.nodeDOM:null}posAtDOM(e,t,n=-1){let s=this.docView.posFromDOM(e,t,n);if(s==null)throw new RangeError("DOM position not inside the editor");return s}endOfTextblock(e,t){return Eu(this,t||this.state,e)}pasteHTML(e,t){return Sn(this,"",e,!1,t||new ClipboardEvent("paste"))}pasteText(e,t){return Sn(this,e,null,!0,t||new ClipboardEvent("paste"))}destroy(){this.docView&&(Xu(this),this.destroyPluginViews(),this.mounted?(this.docView.update(this.state.doc,[],bi(this),this),this.dom.textContent=""):this.dom.parentNode&&this.dom.parentNode.removeChild(this.dom),this.docView.destroy(),this.docView=null,nu())}get isDestroyed(){return this.docView==null}dispatchEvent(e){return tf(this,e)}dispatch(e){let t=this._props.dispatchTransaction;t?t.call(this,e):this.updateState(this.state.apply(e))}domSelectionRange(){let e=this.domSelection();return De&&this.root.nodeType===11&&au(this.dom.ownerDocument)==this.dom&&Tf(this,e)||e}domSelection(){return this.root.getSelection()}}function Tr(i){let e=Object.create(null);return e.class="ProseMirror",e.contenteditable=String(i.editable),i.someProp("attributes",t=>{if(typeof t=="function"&&(t=t(i.state)),t)for(let n in t)n=="class"?e.class+=" "+t[n]:n=="style"?e.style=(e.style?e.style+";":"")+t[n]:!e[n]&&n!="contenteditable"&&n!="nodeName"&&(e[n]=String(t[n]))}),e.translate||(e.translate="no"),[Ge.node(0,i.state.doc.content.size,e)]}function Er(i){if(i.markCursor){let e=document.createElement("img");e.className="ProseMirror-separator",e.setAttribute("mark-placeholder","true"),e.setAttribute("alt",""),i.cursorWrapper={dom:e,deco:Ge.widget(i.state.selection.head,e,{raw:!0,marks:i.markCursor})}}else i.cursorWrapper=null}function Mr(i){return!i.someProp("editable",e=>e(i.state)===!1)}function Af(i,e){let t=Math.min(i.$anchor.sharedDepth(i.head),e.$anchor.sharedDepth(e.head));return i.$anchor.start(t)!=e.$anchor.start(t)}function Ir(i){let e=Object.create(null);function t(n){for(let s in n)Object.prototype.hasOwnProperty.call(e,s)||(e[s]=n[s])}return i.someProp("nodeViews",t),i.someProp("markViews",t),e}function vf(i,e){let t=0,n=0;for(let s in i){if(i[s]!=e[s])return!0;t++}for(let s in e)n++;return t!=n}function Nr(i){if(i.spec.state||i.spec.filterTransaction||i.spec.appendTransaction)throw new RangeError("Plugins passed directly to the view must not have a state component")}const Bf=({onScroll:i,textdocId:e})=>{const t=md(e),{windowWidth:n}=Oc(u=>u,{windowWidth:0,windowHeight:0});if(!t)return null;const{versions:s}=t,r=s.length-1,o=s[r],a=o.comments.filter(u=>u.status!==Va.DISMISSED),l=!!(o!=null&&o.isPartial);let d=null;switch(o.type){case Wr.DOCUMENT:d=x.jsx(Qd,{value:o.content,comments:[],edits:[],isRequestActive:l,isPreview:!0,isDisabled:!0,hideAccelerators:!0,hideComments:!0,hideToolbar:!0,hideEditOverlay:!0,width:n,modelCursor:o.modelCursor});break;default:qr(o.type)&&(d=x.jsx(Yd,{id:"codemirror",currentlyStreamingLineIndex:null,language:Ua(o.type),value:o.content,hideComments:!0,hideToolbar:!0,hideAccelerators:!0,comments:a,readonlyReason:qa.Streaming,isRequestActive:l}))}return x.jsx(Qt,{children:x.jsx(Qt.Content,{onScroll:i,children:d})})},Ff=R.memo(Bf);function Pf(i,e){switch(i){case"presentation":return x.jsx(Za,{});case"table":return x.jsx(Ya,{});case"chart":return x.jsx(Ka,{});case Wr.DOCUMENT:return x.jsx(hd,{className:se("icon-md",{"text-token-text-primary":e,"text-token-text-tertiary":!e})});default:return qr(i)?x.jsx($a,{className:se("icon-md",{"text-token-text-primary":e,"text-token-text-tertiary":!e})}):x.jsx(Ga,{})}}const Ji=({type:i,name:e,isStreaming:t=!1,isFocused:n=!1,onClick:s,textdocId:r,isFetching:o=!1,isCanvasOpen:a=!1,showInlinePreview:l=!1,isMissingFromThread:d=!1})=>{const[u,m]=R.useState(!1),p=Tn(),{resolvedTheme:k}=Qn(),y=R.useRef(null),S=k==="dark",w=Yi(r),[E,_]=R.useState(!1),L=d,U=()=>{!y.current||L||(Qa.logButtonClick(Xa.MESSAGE_ATTACHMENT,{type:i}),el(y.current),s==null||s())},M=t&&x.jsx(Wa,{size:20,className:se("flex-shrink-0",n?"text-blue-selection":"text-token-text-secondary")}),A=i?x.jsx("span",{className:se("flex-shrink-0 transition-[filter]",{grayscale:!n&&!u}),children:Pf(i,w&&a)}):x.jsx("div",{className:"flex h-6 w-6 flex-shrink-0 items-center overflow-hidden",children:x.jsx(zn,{lines:1,size:"base",width:100,widthVariance:0})}),[H]=R.useState(()=>Ha(100,180,!1)),z=d?x.jsx("span",{className:"min-w-0 truncate",children:p.formatMessage({id:"oZTAp8",defaultMessage:"Unknown title"})}):e?x.jsx("span",{className:"min-w-0 truncate",children:e}):x.jsx("div",{className:"flex h-5 flex-grow items-center overflow-hidden",style:{width:H},children:x.jsx(zn,{lines:1,size:"base",width:100,widthVariance:0})}),O=J=>{_(J>0)};return x.jsxs(Tt.div,{role:"button",id:Ja(r),initial:{opacity:t?0:1,scale:t?.9:1},animate:{opacity:1,scale:1},transition:{type:"spring",bounce:0,duration:.72},className:se("popover relative flex select-none flex-col overflow-hidden border bg-token-main-surface-primary transition-shadow duration-500",L?"cursor-default":"cursor-pointer",{"border-token-text-tertiary font-medium dark:border-gray-600":w&&a,"font-regular":!w,"border-token-border-light":!u&&!w,"border-token-border-medium":u&&!w,"mb-3 flex min-w-0 max-w-full flex-shrink flex-grow-0 items-center justify-between self-start rounded-xl":a||!l,"mb-4 h-96 w-full rounded-2xl":!a&&l}),onMouseEnter:()=>!L&&m(!0),onMouseLeave:()=>m(!1),onClick:U,ref:y,style:{boxShadow:a?w?"0px 2px 6px 0px rgba(0, 0, 0, 0.06)":"0px 2px 6px 0px rgba(0, 0, 0, 0)":l?u||w?"0px 12px 32px 0px rgba(0, 0, 0, 0.064)":"0px 6px 14px 0px rgba(0, 0, 0, 0.04)":"0px 2px 6px 0px rgba(0, 0, 0, 0)"},children:[x.jsxs("div",{className:se("flex w-full min-w-0 items-center justify-between gap-2 self-start border-token-border-light px-4 transition-colors duration-700",{"border-token-border-light":!u&&!w,"border-token-border-medium":u&&!w,"text-sm font-medium text-token-text-primary":!a&&u&&l,"py-2":a||!l,"py-3":!a&&l,"text-sm font-medium text-token-text-secondary":!a&&!u&&l}),children:[x.jsxs("div",{className:se("flex min-w-0 items-center",{"gap-2":a||!l,"gap-3.5":!a&&l}),children:[A,z]}),a?x.jsx(Tt.span,{animate:M?"show":"initial",variants:{initial:{opacity:0,paddingLeft:0,width:"0"},show:{opacity:1,paddingLeft:2,width:"24px"}},transition:{type:"tween",duration:.18},children:M}):l&&!L?x.jsx(Ki,{label:p.formatMessage({id:"KMbgyZ",defaultMessage:"Open in canvas"}),children:x.jsx(Tt.div,{role:"button",animate:{opacity:u?1:.64},transition:{type:"tween",duration:.18},className:"text-token-text-secondary transition-colors",children:x.jsx(dd,{className:"icon-md"})})}):null]}),!a&&l&&r&&x.jsxs(x.Fragment,{children:[x.jsx("div",{className:se("relative flex min-h-0 flex-auto flex-col overflow-hidden border-t transition-colors",{"border-token-border-light":E,"border-transparent":!E}),children:d?x.jsx("div",{className:"m-auto text-token-text-secondary",children:x.jsx(ce,{id:"DZUSSk",defaultMessage:"Canvas not found"})}):o?x.jsx(lo,{}):x.jsx(Ff,{onScroll:O,textdocId:r})}),x.jsx("div",{className:"absolute bottom-0 z-20 h-24 w-full transition-colors",style:{background:`linear-gradient(${S?"rgba(0,0,0,0)":"rgba(255,255,255,0)"}, ${S?"#2f2f2f":"#ffffff"})`}})]})]})},jf=({messages:i,isRequestActive:e})=>{const t=Tn(),n=tl(i),s=nl(i),r=R.useMemo(()=>{if(il(n==null?void 0:n.message))return sl(e,n.message,(s==null?void 0:s.message)??null)},[e,n,s]),o=rl(),a=(r==null?void 0:r.textdocId)??o??void 0,l=so(a),d=ol(),u=Yi(a),m=gd(),p=al(),k=yd(),y=ll(),S=xd(z=>{const O=z==null?void 0:z.lastCanvasAssistantMessageById;return O==null||a==null?null:O[a]}),w=S===(n==null?void 0:n.nodeId);if(!r)return null;const E=!k&&!l&&r.status!==ee.STREAMING&&r.status!==ee.WAITING;let _,L;if(r.status!==ee.REDACTED&&r.status!==ee.FAILED&&!E&&a){const z=y&&r.function===vn.UpdateTextdoc&&r.status===ee.COMPLETE;_=()=>{z&&r.versionInt?cl(a,r.versionInt):Ei(a)},L=()=>{z&&r.versionInt&&p(a,r.versionInt)}}const U=Lf(r,l);if(r.function===vn.CreateTextdoc){if(r.status===ee.STREAMING||r.status===ee.WAITING||r.status===ee.COMPLETE){const O=k===!0&&(r.status===ee.STREAMING||r.status===ee.WAITING);return x.jsx(Ji,{showInlinePreview:w||S==null,isMissingFromThread:E,isFetching:O,type:r.type??null,name:U,isFocused:u,isStreaming:r.status===ee.STREAMING,onClick:_,isCanvasOpen:d,textdocId:a})}let z;switch(r.status){case ee.FAILED:z=t.formatMessage({id:"SNarKX",defaultMessage:"Failed to generate"});break;case ee.CANCELED:z=t.formatMessage({id:"1A6W36",defaultMessage:"Stopped generating"});break;case ee.REDACTED:z=x.jsx(Ki,{align:"start",label:t.formatMessage({id:"F6q1k7",defaultMessage:"Removed from shared conversation"}),children:t.formatMessage({id:"BqyYDu",defaultMessage:"Created document"})});break}return x.jsx(_r,{children:z})}const M=E||r.status===ee.REDACTED,A=m&&!M?U:null,H=x.jsx(_r,{onClick:_,onMouseOver:L,isStreaming:r.status===ee.STREAMING,children:r.function===vn.CommentTextdoc?Vf(t,r,A):zf(t,r,A)});return w&&!d?x.jsxs("div",{className:"flex flex-col gap-2",children:[x.jsx(Ji,{showInlinePreview:!0,isMissingFromThread:E,isFetching:!1,type:(l==null?void 0:l.type)??null,name:U,isFocused:u,isStreaming:r.status===ee.STREAMING,onClick:a!=null?()=>Ei(a):void 0,isCanvasOpen:d,textdocId:a}),H]}):H};function Lf(i,e){return e!=null&&e.title?bs(e.title):i.function===vn.CreateTextdoc&&i.title?bs(i.title):null}const _r=({isStreaming:i=!1,onClick:e,onMouseOver:t,children:n})=>x.jsx("button",{disabled:!e,className:se(i&&"loading-shimmer","flex min-h-5 w-fit select-none pt-[3px] text-start text-token-text-secondary",e&&"hover:text-token-text-primary"),onClick:e,onMouseOver:t,children:n}),ka=9;function zf(i,e,t){var s;if(e.status===ee.STREAMING)return t?i.formatMessage({id:"W2xN1Z",defaultMessage:"Editing {documentTitle}"},{documentTitle:t}):i.formatMessage({id:"8taq8v",defaultMessage:"Editing"});if(e.status===ee.FAILED)return t?i.formatMessage({id:"UjJKYZ",defaultMessage:"Failed to edit {documentTitle}"},{documentTitle:t}):i.formatMessage({id:"kWUVkg",defaultMessage:"Failed to edit"});if(e.status===ee.CANCELED)return t?i.formatMessage({id:"TmSrCd",defaultMessage:"Stopped editing {documentTitle}"},{documentTitle:t}):i.formatMessage({id:"bYV7xA",defaultMessage:"Stopped editing"});const n=(s=e.updates)==null?void 0:s.length;return e.status===ee.REDACTED||!n||n>ka?t?i.formatMessage({id:"n+G/ct",defaultMessage:"Edited {documentTitle}"},{documentTitle:t}):i.formatMessage({id:"aegqpL",defaultMessage:"Edited"}):t?i.formatMessage({id:"osYMSb",defaultMessage:"{numEdits, plural, one {Edited {documentTitle}} other {Made {numEdits} edits to {documentTitle}}}"},{numEdits:n,documentTitle:t}):i.formatMessage({id:"xJD3WR",defaultMessage:"{numEdits, plural, one {Edited} other {Made {numEdits} edits}}"},{numEdits:n})}function Vf(i,e,t){var s;if(e.status===ee.STREAMING)return t?i.formatMessage({id:"8xQH/P",defaultMessage:"Commenting on {documentTitle}"},{documentTitle:t}):i.formatMessage({id:"5yqLeN",defaultMessage:"Commenting"});if(e.status===ee.FAILED)return t?i.formatMessage({id:"Rl821S",defaultMessage:"Failed to comment on {documentTitle}"},{documentTitle:t}):i.formatMessage({id:"W007jt",defaultMessage:"Failed to comment"});if(e.status===ee.CANCELED)return t?i.formatMessage({id:"bozPdq",defaultMessage:"Stopped commenting on {documentTitle}"},{documentTitle:t}):i.formatMessage({id:"hyBGa7",defaultMessage:"Stopped commenting"});const n=(s=e.comments)==null?void 0:s.length;return e.status===ee.REDACTED||!n||n>ka?t?i.formatMessage({id:"LXEzK7",defaultMessage:"Commented on {documentTitle}"},{documentTitle:t}):i.formatMessage({id:"KeMYhy",defaultMessage:"Commented"}):t?i.formatMessage({id:"Ql5lPq",defaultMessage:"{numComments, plural, one {Commented on {documentTitle}} other {Added {numComments} comments on {documentTitle}}}"},{numComments:n,documentTitle:t}):i.formatMessage({id:"FHtyJQ",defaultMessage:"{numComments, plural, one {Commented} other {Added {numComments} comments}}"},{numComments:n})}function Uf(i){var e,t;return((t=(e=i.message.metadata)==null?void 0:e.finish_details)==null?void 0:t.type)==="content_filter"}function ms(i){if(i===void 0)return{flagSeverity:void 0,shouldHideContent:!1,errCode:void 0,errMessage:void 0};const{errType:e,errCode:t,err:n,disclaimers:s}=i,r=Uf(i);return!(s&&s.length>0)&&r?{flagSeverity:"warning",shouldHideContent:!0,errCode:dt.ContentOrTos,errMessage:n}:{flagSeverity:e,shouldHideContent:e==="danger"&&(t===dt.ContentPolicy||t===dt.ModelIncompatibility),disclaimers:s,errCode:t,errMessage:n}}function qf(i){return x.jsx(Ot,{flag:"danger",isUserTurn:!1,children:x.jsx(ce,{...je.somethingWentWrong})})}function Wf({message:i,onRequestMoreCompletions:e,clientThreadId:t,id:n,isFeedbackEnabled:s,isUserTurn:r,className:o}){const{errCode:a,errMessage:l,flagSeverity:d}=ms(i);switch(a){case dt.ContentPolicy:return x.jsx(Ot,{flag:d,isUserTurn:r,className:o,children:x.jsx($f,{isFeedbackEnabled:s})});case dt.ModelIncompatibility:return x.jsx(Ot,{flag:d,isUserTurn:r,className:o,children:x.jsx(ce,{...je.modelIncompatibilityMessage})});case dt.ContentOrTos:return x.jsx(Ot,{flag:d,isUserTurn:r,className:o,children:x.jsx(Jf,{isFeedbackEnabled:s})});case Mi:return x.jsx(Hf,{className:o,id:n,onRequestMoreCompletions:e,flag:d,clientThreadId:t,isUserTurn:r});case Qr:return x.jsx(Ot,{flag:d,isUserTurn:r,className:o,children:x.jsx(ce,{...je.historyDisabledConversationMissing})});default:return l!==void 0?x.jsx(Ot,{flag:d,isUserTurn:r,className:o,children:x.jsx(dl,{rehypePlugins:[[hl,{target:"_new",rel:"noopener noreferrer"}]],className:"markdown prose w-full break-words dark:prose-invert",children:l})}):null}}function Hf({className:i,id:e,onRequestMoreCompletions:t,flag:n,clientThreadId:s,isUserTurn:r}){const o=ul(S=>S.isoDate),a=fl(o),l=is(s??Rc),d=l&&l.kind!==qe.PrimaryAssistant,u=bd(),m=wd(),p=R.useCallback(()=>{const S=new ws;t(e,{eventSource:"mouse"},S,!0,"none",!1)},[e,t]),k=R.useCallback(()=>{const S=new ws,w=m.id;u({modelId:w,location:"Model switcher menu item"}),t(e,{eventSource:"mouse"},S,!0,"none",!0)},[t,e,m.id,u]);let y;return d?y=o!=null?x.jsx("span",{children:x.jsx(ce,{...je.gptUsageCapExceededCustomFeature,values:{link:Dr,formattedTime:a}})}):x.jsx(ce,{...je.gptUsageCapExceededExpired}):y=o!=null?x.jsx("span",{children:x.jsx(ce,{...je.gptUsageCapExceeded,values:{link:Dr,formattedTime:a}})}):x.jsx(ce,{...je.gptUsageCapExceededExpired}),x.jsx(Ot,{flag:o!=null?n:void 0,isUserTurn:r,className:i,children:x.jsxs("div",{className:"flex items-center gap-6",children:[y,o==null&&x.jsx(Ts,{color:"secondary",className:"flex-shrink-0",onClick:p,children:x.jsx(ce,{...je.buttonTryAgain})}),o!=null&&!d&&x.jsx(Ts,{color:"secondary",className:"flex-shrink-0",onClick:k,children:x.jsx(ce,{...je.buttonUseDefaultModel})})]})})}const Dr=i=>x.jsx("a",{href:"https://share.hsforms.com/16d0ZZVM3QZirXnCD_q7u1Q4sk30",target:"_blank",rel:"noreferrer",className:"underline",children:i});function Jf({isFeedbackEnabled:i}){return x.jsxs(x.Fragment,{children:[x.jsx("div",{className:i?"font-semibold":"",children:x.jsx(ce,{...je.contentOrTosViolationNoFeedback,values:{contentPolicyLink:ba,termsLink:Gf}})}),x.jsx("div",{children:i&&x.jsx(ce,{...je.contentPolicyFeedback})})]})}function $f({isFeedbackEnabled:i}){return x.jsxs(x.Fragment,{children:[x.jsx("div",{className:i?"font-semibold":"",children:x.jsx(ce,{...je.contentPolicyViolationNoFeedback,values:{contentPolicyLink:ba}})}),x.jsx("div",{children:i&&x.jsx(ce,{...je.contentPolicyFeedback})})]})}const ba=i=>x.jsx(Hr,{target:"_blank",href:"https://openai.com/policies/usage-policies",rel:"noreferrer",children:i}),Gf=i=>x.jsx(Hr,{target:"_blank",href:"https://openai.com/policies/terms-of-use",rel:"noreferrer",children:i}),je=es({contentPolicyFeedback:{id:"TextMessageDisplay.contentPolicyFeedback",defaultMessage:"Did we get it wrong? Please tell us by giving this response a thumbs down."},contentPolicyViolation:{id:"TextMessageDisplay.contentPolicyViolation.2",defaultMessage:"This content may violate our <contentPolicyLink>usage policies</contentPolicyLink>. Did we get it wrong? Please tell us by giving this response a thumbs down."},contentPolicyViolationNoFeedback:{id:"TextMessageDisplay.contentPolicyViolationNoFeedback",defaultMessage:"This content may violate our <contentPolicyLink>usage policies</contentPolicyLink>."},modelIncompatibilityMessage:{id:"cyOWhN",defaultMessage:"Your request was flagged as potentially violating our usage policy. Please try again with a different prompt."},contentOrTosViolation:{id:"TextMessageDisplay.contentOrTosViolation.2",defaultMessage:"This content may violate our <termsLink>Terms of Use</termsLink> or <contentPolicyLink>usage policies</contentPolicyLink>. Did we get it wrong? Please tell us by giving this response a thumbs down."},contentOrTosViolationNoFeedback:{id:"TextMessageDisplay.contentOrTosViolationNoFeedback",defaultMessage:"This content may violate our <termsLink>Terms of Use</termsLink> or <contentPolicyLink>usage policies</contentPolicyLink>."},historyDisabledConversationMissing:{id:"TextMessageDisplay.historyDisabledConversationMissing",defaultMessage:"Sorry, conversations created when Chat History is off expire after 6 hours of inactivity. Please start a new conversation to continue using ChatGPT."},somethingWentWrong:{id:"TextMessageDisplay.somethingWentWrong",defaultMessage:"Something went wrong."},gptUsageCapExceeded:{id:"TextMessageDisplay.gptUsageCapExceeded",defaultMessage:"You've reached the current usage cap for GPT-4. You can continue with the default model now, or try again {formattedTime}. <link>Learn more</link>"},gptUsageCapExceededCustomFeature:{id:"TextMessageDisplay.gptUsageCapExceededCustomFeature",defaultMessage:"You've reached the current usage cap for GPT-4, please try again {formattedTime}. <link>Learn more</link>"},gptUsageCapExceededExpired:{id:"TextMessageDisplay.gptUsageCapExceededExpired",defaultMessage:"You previously reached your usage cap for GPT-4, but you can now try sending your message again"},buttonUseDefaultModel:{id:"TextMessageDisplay.buttonUseDefaultModel",defaultMessage:"Use default model"},buttonTryAgain:{id:"TextMessageDisplay.buttonTryAgain",defaultMessage:"Try again"}}),Kf=({textdocId:i})=>{const e=so(i),t=Yi(e==null?void 0:e.textdocId);if(!e)return null;const n=()=>{Ei(e==null?void 0:e.textdocId)};return x.jsx("div",{children:x.jsx(Ji,{type:e.type,name:e.title,isFocused:t,onClick:n,showInlinePreview:!0})})},Yf=({messages:i})=>{var n;const[e]=i,t=(n=e==null?void 0:e.message.metadata)==null?void 0:n.canvas;return!t||t.user_message_type!=null?null:x.jsx(Kf,{textdocId:t.textdoc_id})};function gs(){return Xr(eo.DataAnalysisV2)}function Wm(){const i=pl(),e=vc();return e&&i&&!Bc(i)&&e.isEnterprise()}function Zf(){return Xr(eo.ChartSerialization)}function Hm(i,e){const t=i==="chart"?Es.HasSeenAdaInteractiveChart:Es.HasSeenAdaInteractiveTable,[n,s]=R.useState(Ms.getItem(t,{userId:e})??!1),r=R.useCallback(()=>{s(!0),Ms.setItem(t,!0,{userId:e})},[t,e]);return[n,r]}function Jm(i){const[e,t]=R.useState([]),n=Vn(()=>{const s=v.resolveThreadId(i),r=v.getThreadCurrentLeafId(i);return v.getTree(s).getBranchFromLeaf(r)});return R.useEffect(()=>{const s=Sa(n);s.length!==e.length&&t(s)},[e.length,i,n]),e}function Qf(i){return Vn(()=>{const e=v.resolveThreadId(i),t=v.getThreadCurrentLeafId(i),s=v.getTree(e).getBranchFromLeaf(t);return Sa(s).length>0})}function wa(i){var r,o,a,l;const e=((o=(r=i.metadata)==null?void 0:r.aggregate_result)==null?void 0:o.messages.filter(oo))??[];let t=0;const n=(((a=i.metadata)==null?void 0:a.ada_visualizations)??[]).map(d=>{let u=d;return d.type=="chart"&&(u={...d,fallback_image:e[t++]}),u}),s=(((l=i.metadata)==null?void 0:l.attachments)??[]).filter(d=>Jr(d.name)).map(d=>({type:"table",file_id:d.id??"",title:yl(d),file_name:d.name,context_connector_info:d.context_connector_info}));return[...n,...s]}function Sa(i){return i.filter(t=>{var n,s,r,o;return((n=t.message)==null?void 0:n.author.role)==="tool"&&((s=t.message)==null?void 0:s.author.name)==="python"||(((o=(r=t.message)==null?void 0:r.metadata)==null?void 0:o.attachments)??[]).length>0}).flatMap(t=>wa(t.message))}Ac(i=>({selectedSpreadsheet:null,setSelectedSpreadsheet:e=>i({selectedSpreadsheet:e})}));async function Xf(i,e,t){const n=await i.text(),{parse:s}=await ye(async()=>{const{parse:o}=await import("./oeujip5i1ptrxie5.js");return{parse:o}},[]),r=s(n);return{content:{columnNames:r.shift(),columnTypes:r[0].map(()=>"string"),rows:r},file_name:e,download_url:t}}function ep(i){const e=i[0].values.length,t=[];for(let n=0;n<e;n++){const s=i.map(r=>r.values[n]);t.push(s)}return t}function $m(i){return ts({queryKey:["ada-visualization","chart",i.file_id],queryFn:async()=>{const e=await ut.getFileDownloadLink(i.file_id);if(e.status===to.Success){const n=await(await fetch(e.download_url)).json();return{content:{chart_type:n.type,title:n.title,labels:n.labels,datasets:n.datasets,x_label:n.x_label,y_label:n.y_label},file_name:e.file_name??"",download_url:e.download_url}}else throw new Error("Failed to download chart json from interpreter")}})}function Gm(i){return ts({queryKey:["ada-visualization","table",i.file_id],queryFn:async()=>{if(i.file_name&&ml(i.file_name)){const e=await ut.getAdaExcelFileContents(i.file_id);return{content:e.sheets.map(t=>({name:t.name,columnNames:t.columns.map(n=>n.name),columnTypes:t.columns.map(()=>"string"),rows:ep(t.columns)})),download_url:e.download_url,file_name:i.file_name}}else{const e=await ut.getFileDownloadLink(i.file_id);if(e.status===to.Success){const t=await fetch(e.download_url);return Xf(t,e.file_name??"",e.download_url)}else throw new Error("Failed to download from interpreter")}}})}function Km(i){const e=gl(),t=Qf(i),n=gs();return t&&n&&!e.displayingSideBySideFeedback}const tp=Ee(()=>ye(()=>import("./i13yvb7mip3btqm2.js").then(i=>i.A),__vite__mapDeps([33,1,2,3,5,6,7,16,22,23,34,35,36,37,17,38])).then(i=>i.default)),np=Nt.div`flex gap-2 flex-wrap mt-1 max-w-[80%] justify-end`,ip=Nt.div`flex flex-col gap-2`,sp=({parts:i,attachments:e,isUserTurn:t,clientThreadId:n})=>{const s=Fc(),r=gs(),o=xl.getImageAssetPointersFromParts(i),a=new Set(o.map(k=>kl(k.asset_pointer))),d=bl()||s,u=(e??[]).filter(k=>Jr(k.name)),m=(e??[]).filter(k=>k.id==null||a.has(k.id)?!1:r?!u.includes(k):!0);return(r?(m.length>0||u.length>0)&&t:m.length>0&&t)?x.jsxs(x.Fragment,{children:[x.jsx(np,{children:m.map(k=>x.jsx(wl,{file:k.name,fileId:k.id,contextConnectorInfo:Sl(k.context_connector_info),width:s?"normal":"wide",alwaysShowData:!0},k.id))}),r&&x.jsx(ip,{className:se(!d&&"w-[80%]"),children:u.map(k=>x.jsx(tp,{clientThreadId:n,visualization:Cl(k)},k.id))})]}):null};function Ca(i){return Tl(i)&&!El(i)}const Rn=50,rp=95;function op(i,e){if(i<=e)return i/e*Rn;{const t=Rn,n=rp-Rn,s=i-e,o=-(Rn/e)/n;return t+n*(1-Math.exp(o*s))}}class ap{constructor(){$(this,"mostRecentCompletionRequest");$(this,"loggedRequests",new Set)}onCompletionRequestStarted(e){this.mostRecentCompletionRequest={requestId:e,timestamp:Date.now()},this.loggedRequests.clear()}logEvent(e,t,n,s,r){const o=this.mostRecentCompletionRequest;if(o!=null&&!this.loggedRequests.has(e)){const l=v.getThreadConversationTurns(t,n).find(d=>d.messages.some(u=>u.message.id===n));l!=null&&l.messages.some(d=>d.nodeId===o.requestId)&&(Ke.logEvent(e,{messageId:n,timeMs:Date.now()-o.timestamp,...s}),r==null||r(),this.loggedRequests.add(e))}}}const $i=new ap;function lp(i){var s;const e=i.find(r=>{var o;return((o=r.message.metadata)==null?void 0:o.image_search_results)!==void 0});return(((s=e==null?void 0:e.message.metadata)==null?void 0:s.image_search_results)??[]).slice(0,5)}function cp({messages:i}){const e=lp(i),t=Ml();return e.length===0?null:x.jsx("div",{className:se({"mb-2":!0,"grid grid-flow-col gap-3":e.length>1,"w-1/3":e.length===1}),children:e.filter(({contentUrl:n})=>t.has(n)).map((n,s)=>x.jsx("a",{href:n.hostPageUrl,target:"_blank",rel:"noreferrer",children:x.jsx("img",{src:n.contentUrl,alt:n.name,className:"aspect-square rounded-xl object-cover"})},s))})}function Ta({attachments:i,citations:e,contentReferences:t,className:n,clientThreadId:s,displayParts:r,isCompletionInProgress:o,id:a,isActivelyStreaming:l,isUserTurn:d,turnIndex:u,isFeedbackEnabled:m,messages:p,onRequestMoreCompletions:k,parts:y,prevGroupedMessageType:S,prevGroupedMessages:w,showEditButton:E,onEnterEdit:_,size:L="medium"}){var J,ae;const U=kd(s),M=p.length>1,{flagSeverity:A,shouldHideContent:H}=ms(M?void 0:p[0]),z=!y.some(X=>X!==""),O=((J=p[0].message.metadata)==null?void 0:J.targeted_reply_label)??((ae=p[0].message.metadata)==null?void 0:ae.targeted_reply);return R.useEffect(()=>{var X;if(!z)switch(S){case P.Browsing:$i.logEvent(Ne.browsingTimeToFirstTextToken,s,p[0].message.id);break;case P.SearchGPTQuery:{const ue=p[0].message,le=(X=ue.metadata)==null?void 0:X.search_source;$i.logEvent(Ne.searchToolTimeToFirstTextToken,s,ue.id,{search_source:le},()=>{le==="instant_query"&&_e.addFirstTiming("chatgpt.web.search.instant-query-ttft")});break}}},[z,p,s,S]),x.jsxs("div",{"data-message-author-role":p[0].message.author.role,"data-message-id":p[0].message.id,dir:"auto",className:se(n,"text-message flex w-full flex-col items-end gap-2 whitespace-normal break-words [.text-message+&]:mt-5"),children:[O&&x.jsxs("div",{className:"mb-1 ml-6 mt-1 flex items-start gap-1.5 text-sm font-normal text-token-text-tertiary sm:ml-7 lg:ml-8",children:[x.jsx(ud,{className:"icon-md mt-1 shrink-0"}),x.jsx("p",{className:"mr-2 line-clamp-3",children:O})]}),d&&U&&x.jsx(Yf,{messages:p}),x.jsx(Il,{messages:p}),x.jsx(dp,{parts:y,attachments:i,isUserTurn:d,isCompletionInProgress:o,turnIndex:u,displayParts:r,isActivelyStreaming:l,shouldHideContent:H,showEditButton:E,onEnterEdit:_,clientThreadId:s,id:a,isEmpty:z,prevGroupedMessageType:S,prevGroupedMessages:w,flagSeverity:A,messages:p,citations:e,contentReferences:t,size:L}),x.jsx(Wf,{message:M?void 0:p[0],id:a,isFeedbackEnabled:m,onRequestMoreCompletions:k,clientThreadId:s,isUserTurn:d}),x.jsx(Nl,{isUserTurn:d,message:M?void 0:p[0]}),!d&&!l&&w&&S===P.SearchResult&&x.jsx(cp,{messages:w})]})}function dp({clientThreadId:i,id:e,displayParts:t,isCompletionInProgress:n,turnIndex:s,isActivelyStreaming:r,shouldHideContent:o,showEditButton:a=!1,onEnterEdit:l,isEmpty:d,prevGroupedMessageType:u,prevGroupedMessages:m,messages:p,citations:k,contentReferences:y,size:S,isUserTurn:w,parts:E,attachments:_}){var Ve,Je;const L=Tn(),U=_l(t),[M,A]=R.useState({}),[H,z]=R.useState(!1),O=Dl(),{streamingContext:J}=Ol();R.useEffect(()=>{O&&(J.setOnStylesUpdatedCallback(A),J.onStreamingChanged(n),J.setOnResetCallback(()=>z(!1)),n&&(z(!0),A(J.createTopLevelStyles())))},[O,n,J]);const ae=Rl(),X=(Ve=p[0].message.metadata)==null?void 0:Ve.gizmo_id,ue=(Je=p[0].message.metadata)==null?void 0:Je.serialization_metadata,le=Id(p[0].message).length,ze=R.useMemo(()=>({clientThreadId:i,messageId:e,turnIndex:s}),[i,e,s]),xe=Al(p[0].message),ke=!!X&&ae.includes(X),Ie=R.useCallback(F=>{vl.open(F,s,e)},[s,e]),pe=x.jsx(sp,{parts:E,attachments:_,isUserTurn:w,clientThreadId:i},"files-and-tables"),Ae=!!(_!=null&&_.length||t.some(F=>F.type==="images"));function B(F,I){const j=u===P.CodeInterpreter?m==null?void 0:m.map(Y=>Y.message):void 0,{text:te,contentReferences:ve}=Fl(I,k,y,ke),{processedText:me,displayedContentReferences:Qe}=Pl(te,ve,r?void 0:j);return x.jsx(jl.Provider,{value:{analyticsMetadata:ze,message:p[0].message,contentReferences:Qe,onShowSearchResults:Ie,numImageResults:le,isActivelyStreaming:r,useSafeUrls:!0},children:x.jsx(Zi,{clientThreadId:i,messageId:e,isStreamingOrProcessing:H,size:S,className:se(r&&!O&&"result-streaming",xe&&"headers-v2"),children:me===""?"&#8203;":me})},F)}const K=t.map((F,I)=>{var j;if(F.type==="transcription"){const te=o?null:F.text;let ve=null;if(w&&o)ve=x.jsx("span",{className:"italic opacity-30",children:x.jsx(ce,{...An.contentRemoved})});else if(w&&te!=null)ve=te.trim().length===0?x.jsx("span",{className:"italic opacity-30",children:x.jsx(ai,{text:L.formatMessage(An.transcriptUnavailable),customSymbolOffsets:void 0})}):x.jsx("span",{className:"italic opacity-65",children:x.jsx(ai,{text:`“${te.trim()}”`,customSymbolOffsets:void 0})});else if(!w&&te!=null)return B(I,te);return x.jsx(li,{containsImagesOrAttachments:Ae,isUserTurn:w,showEditButton:a,onEnterEdit:l,children:ve},I)}else if(F.type==="text"){const te=o?null:F.text;return!d&&!o&&!w?B(I,U):d&&r&&!w?O?x.jsx("div",{className:"pulsing-dot"},I):x.jsx("div",{className:"result-streaming",children:x.jsx("span",{children:x.jsx("pre",{})})},I):x.jsx(li,{containsImagesOrAttachments:Ae,isUserTurn:w,showEditButton:a,onEnterEdit:l,children:w&&o?x.jsx("span",{className:"italic opacity-30",children:x.jsx(ce,{...An.contentRemoved})}):te?x.jsx(ai,{text:te,customSymbolOffsets:ue==null?void 0:ue.custom_symbol_offsets}):null},I)}else if(F.type==="images"){const te=((j=p[0].message.metadata)==null?void 0:j.attachments)??[];return x.jsx(Bl,{assets:F.imageAssets,attachments:te},I)}else return null}),Pe=t.findIndex(F=>F.type==="text");if(Pe!==-1?K.splice(Pe,0,pe):K.push(pe),o&&w)K.length=0,K.push(x.jsx(li,{containsImagesOrAttachments:Ae,isUserTurn:w,onEnterEdit:Ii,children:x.jsx("span",{className:"italic opacity-30",children:x.jsx(ce,{...An.contentRemoved})})}));else if(o&&!w)return null;return x.jsx("div",{className:se("flex w-full flex-col gap-1 empty:hidden",w&&"items-end rtl:items-start",!w&&"first:pt-[3px]",H&&"streaming-response"),style:M,children:K})}const An=es({contentRemoved:{id:"textMessage.contentRemoved",defaultMessage:"Content removed"},transcriptUnavailable:{id:"textMessage.transcriptUnavailable",defaultMessage:"Transcript Unavailable"}});function hp(i){var d;const{isActivelyStreaming:e,...t}=i,n=Pc(),s=(n==null?void 0:n.includes("debug"))??!1,r=i.messages[i.messages.length-1].message.id,[o,a]=R.useState([]),l=R.useRef();return l.current===void 0&&(l.current=(n==null?void 0:n.includes(jc))??!1?new Ll(i.parts,a,e,void 0,{debug:s}):new zl(i.parts,a,e)),R.useEffect(()=>{l.current!=null&&(l.current.onMessagePartsUpdated(i.parts,e),l.current.isBuffering()&&cn.addDelayedRenderingMessage(r))},[i.parts,r,e]),R.useEffect(()=>{l.current!=null&&!l.current.isBuffering()&&cn.removeDelayedRenderingMessage(r)},[o,r]),R.useEffect(()=>()=>cn.removeDelayedRenderingMessage(r),[r]),R.useEffect(()=>()=>{l.current!=null&&(l.current.destroy(),l.current=void 0)},[]),x.jsx(Ta,{...t,displayParts:o,isActivelyStreaming:e||((d=l.current)==null?void 0:d.isBuffering())})}function up({message:i,isCompletionInProgress:e,clientThreadId:t,className:n,isUserTurn:s,turnIndex:r,isFeedbackEnabled:o,prevGroupedMessageType:a,prevGroupedMessages:l,showEditButton:d,onEnterEdit:u,onRequestMoreCompletions:m}){var k,y,S;const p=R.useMemo(()=>"parts"in i.message.content?i.message.content.parts:[$r(i.message)],[i]);return x.jsx(pp,{parts:p,messages:[i],isCompletionInProgress:e,className:n,citations:(k=i.message.metadata)==null?void 0:k.citations,contentReferences:(y=i.message.metadata)==null?void 0:y.content_references,attachments:(S=i.message.metadata)==null?void 0:S.attachments,isUserTurn:s,turnIndex:r,id:i.nodeId,isFeedbackEnabled:o,onRequestMoreCompletions:m,clientThreadId:t,showEditButton:d,onEnterEdit:u,prevGroupedMessageType:a,prevGroupedMessages:l})}const fp=Lc.memo(up);function pp(i){const e=i.messages.length>1,{flagSeverity:t}=ms(e?void 0:i.messages[0]),n=t!=="danger"&&i.isCompletionInProgress,s=!i.parts.some(o=>o!==""),[r]=R.useState(()=>!i.isUserTurn&&(i.isCompletionInProgress||s));return r?x.jsx(hp,{...i,isActivelyStreaming:n}):x.jsx(Ta,{...i,displayParts:Vl({isUserTurn:i.isUserTurn,parts:i.parts}),isActivelyStreaming:n})}const mp=Ee(()=>ye(()=>import("./nsfpkontvpbubwqj.js"),__vite__mapDeps([39,1,2,3])));function Ea({animationData:i,animationSegmentToPlay:e,animationLoopCounter:t}){const n=R.useRef(null);return R.useEffect(()=>{var s;(s=n.current)==null||s.playSegments(e,!0)},[t]),x.jsx(mp,{animationData:i,lottieRef:n,loop:!1,autoplay:!1})}function gp(i){return x.jsx(ns,{width:"8",height:"9",viewBox:"0 0 8 9",fill:"none",...i,children:x.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M7.66607 0.376042C8.01072 0.605806 8.10385 1.07146 7.87408 1.4161L3.54075 7.9161C3.40573 8.11863 3.18083 8.24304 2.93752 8.24979C2.69421 8.25654 2.46275 8.1448 2.31671 7.95008L0.150044 5.06119C-0.098484 4.72982 -0.0313267 4.25972 0.300044 4.01119C0.631415 3.76266 1.10152 3.82982 1.35004 4.16119L2.88068 6.20204L6.62601 0.584055C6.85577 0.239408 7.32142 0.146278 7.66607 0.376042Z",fill:"currentColor"})})}function yp(i){return x.jsxs(ns,{width:"4",height:"12",viewBox:"0 0 4 12",fill:"none",...i,children:[x.jsx("mask",{id:"path-1-inside-1_1975_4008",fill:"currentColor",children:x.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M1 6.5C1 7.05228 1.44772 7.5 2 7.5C2.55228 7.5 3 7.05228 3 6.5V1.5C3 0.947715 2.55228 0.5 2 0.5C1.44772 0.5 1 0.947715 1 1.5L1 6.5ZM0.75 10.25C0.75 10.9404 1.30964 11.5 2 11.5C2.69036 11.5 3.25 10.9404 3.25 10.25C3.25 9.55964 2.69036 9 2 9C1.30964 9 0.75 9.55964 0.75 10.25Z"})}),x.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M1 6.5C1 7.05228 1.44772 7.5 2 7.5C2.55228 7.5 3 7.05228 3 6.5V1.5C3 0.947715 2.55228 0.5 2 0.5C1.44772 0.5 1 0.947715 1 1.5L1 6.5ZM0.75 10.25C0.75 10.9404 1.30964 11.5 2 11.5C2.69036 11.5 3.25 10.9404 3.25 10.25C3.25 9.55964 2.69036 9 2 9C1.30964 9 0.75 9.55964 0.75 10.25Z",fill:"currentColor"}),x.jsx("path",{d:"M1 6.5H-0.25H1ZM1 1.5L-0.25 1.5L-0.25 1.5L1 1.5ZM2 6.25C2.13807 6.25 2.25 6.36193 2.25 6.5H-0.25C-0.25 7.74264 0.757359 8.75 2 8.75V6.25ZM1.75 6.5C1.75 6.36193 1.86193 6.25 2 6.25V8.75C3.24264 8.75 4.25 7.74264 4.25 6.5H1.75ZM1.75 1.5V6.5H4.25V1.5H1.75ZM2 1.75C1.86193 1.75 1.75 1.63807 1.75 1.5H4.25C4.25 0.257359 3.24264 -0.75 2 -0.75V1.75ZM2.25 1.5C2.25 1.63807 2.13807 1.75 2 1.75V-0.75C0.757359 -0.75 -0.25 0.257359 -0.25 1.5L2.25 1.5ZM2.25 6.5L2.25 1.5L-0.25 1.5L-0.25 6.5L2.25 6.5ZM2 10.25H-0.5C-0.5 11.6307 0.619288 12.75 2 12.75V10.25ZM2 10.25V12.75C3.38071 12.75 4.5 11.6307 4.5 10.25H2ZM2 10.25H2H4.5C4.5 8.86929 3.38071 7.75 2 7.75V10.25ZM2 10.25H2V7.75C0.619288 7.75 -0.5 8.86929 -0.5 10.25H2Z",fill:"currentColor",mask:"url(#path-1-inside-1_1975_4008)"})]})}function xp(i){return x.jsx(ns,{width:"8",height:"9",viewBox:"0 0 8 9",fill:"none",...i,children:x.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M7.32256 1.48447C7.59011 1.16827 7.55068 0.695034 7.23447 0.427476C6.91827 0.159918 6.44503 0.199354 6.17748 0.515559L4.00002 3.08892L1.82256 0.515559C1.555 0.199354 1.08176 0.159918 0.765559 0.427476C0.449355 0.695034 0.409918 1.16827 0.677476 1.48447L3.01755 4.25002L0.677476 7.01556C0.409918 7.33176 0.449354 7.805 0.765559 8.07256C1.08176 8.34011 1.555 8.30068 1.82256 7.98447L4.00002 5.41111L6.17748 7.98447C6.44503 8.30068 6.91827 8.34011 7.23447 8.07256C7.55068 7.805 7.59011 7.33176 7.32256 7.01556L4.98248 4.25002L7.32256 1.48447Z",fill:"currentColor"})})}function Ym({animationLoopCounter:i}){const{resolvedTheme:e}=Qn(),t=e==="dark";return x.jsx(Ea,{animationData:t?Ul:ql,animationSegmentToPlay:[0,300],animationLoopCounter:i})}function Zm({animationLoopCounter:i}){const{resolvedTheme:e}=Qn(),t=e==="dark";return x.jsx(Ea,{animationData:t?Wl:Hl,animationSegmentToPlay:[0,400],animationLoopCounter:i})}const kp=2e3,Ma=.4,bp=.45,wp=.2,Sp=.1,Cp=.25;var We=(i=>(i[i.Running=0]="Running",i[i.Finished=1]="Finished",i[i.Error=2]="Error",i[i.Stopped=3]="Stopped",i[i.Paused=4]="Paused",i))(We||{});function Qm({conversationMessages:i,icon:e,status:t,text:n,estimatedToolDurationMs:s,animationLoopDurationMs:r=kp,shouldPersistAfterFinished:o=!1}){const[a,l]=R.useState(t===0?0:t===1&&!o?7:1),[d,u]=R.useState(0);R.useEffect(()=>{t===2?l(8):t===3?l(9):t===4?l(10):t===1?l(a===2?3:7):t===0&&a===10&&(l(2),u(p=>p+1))},[t]);const m=Mp(a);return R.useEffect(()=>{const p=i[0].message.id;if(m)return cn.addDelayedRenderingMessage(p),()=>{cn.removeDelayedRenderingMessage(p)}},[m]),Gr(()=>{Zt(a)&&u(p=>p+1)},r),a===7&&!o?null:x.jsxs("div",{className:"my-2.5 flex items-center gap-2.5",children:[x.jsx(Tp,{icon:e,status:t,uiState:a,estimatedToolDurationMs:s,animationLoopCounter:d,shouldPersistAfterFinished:o,onFillProgressBarAnimationComplete:()=>l(4),onFinishAnimationComplete:()=>{l(5),setTimeout(()=>{l(o?7:6)},Sp*1e3)},onHideAnimationComplete:()=>l(7)}),x.jsx(Ep,{text:n,uiState:a,animationLoopCounter:d,onEnterAnimationComplete:()=>l(2)})]})}const Or=50;function Tp({icon:i,status:e,uiState:t,estimatedToolDurationMs:n,animationLoopCounter:s,shouldPersistAfterFinished:r,onFillProgressBarAnimationComplete:o,onFinishAnimationComplete:a,onHideAnimationComplete:l}){const[d,u]=R.useState(0);Gr(()=>{Zt(t)?u(_=>_+Or):t===10&&u(0)},Or);let m,p,k;Zt(t)||t===10?(m="running",p=x.jsx(i,{animationLoopCounter:s}),k="bg-transparent"):t===4||t===5||t===7&&r?(m="finished",p=x.jsx(gp,{}),k="bg-brand-purple"):e===2?(m="error",p=x.jsx(yp,{}),k="bg-orange-500"):e===3&&(m="stopped",p=x.jsx(xp,{}),k="bg-gray-300");let y={opacity:0,scale:0,rotate:-180,x:0},S={type:"spring",bounce:.3,duration:bp},w={opacity:0,scale:.6,rotate:0,x:0};t===0?(y={opacity:0,scale:.5,rotate:-180,x:-8},S={type:"spring",bounce:.3,duration:Ma}):t===1?y=!1:t===5&&(w={opacity:0,scale:0,rotate:0,x:0},S={type:"spring",bounce:.3,duration:Cp});const E=op(d,n);return x.jsx("div",{className:"relative h-5 w-5 shrink-0",children:x.jsx(jn,{onExitComplete:()=>{t===6&&l()},children:m!=null&&x.jsxs(Tt.div,{className:se("absolute left-0 top-0 flex h-full w-full items-center justify-center rounded-full text-white",k),initial:y,animate:{opacity:1,scale:1,rotate:0,x:0},exit:w,transition:S,onAnimationComplete:()=>{t===4&&a()},children:[p,(Zt(t)||t===10)&&x.jsx(Jl,{percentage:t===3?100:E,thickness:1.5/23,className:"absolute left-1/2 top-1/2 h-[23px] w-[23px] -translate-x-1/2 -translate-y-1/2 text-brand-purple",backgroundStrokeClassName:"stroke-brand-purple/25 dark:stroke-brand-purple/50",transitionDuration:t===3?`${(100-E)/100*wp}s`:void 0,transitionTimingFunction:t===3?"cubic-bezier(0.55, 0, 1, 1)":void 0,onTransitionEnd:()=>{t===3&&o()}})]},m)})})}function Ep({text:i,uiState:e,animationLoopCounter:t,onEnterAnimationComplete:n}){const[s,r]=R.useState(i);R.useEffect(()=>{e===2&&r(i)},[t]),R.useEffect(()=>{Zt(e)||r(i)},[e,i]);let o={opacity:0,x:0,y:15},a={type:"spring",bounce:.3,opacity:{duration:.15},y:{duration:.3}};e===0?(o={opacity:0,x:-8,y:0},a={type:"spring",bounce:.3,duration:Ma,delay:.15}):e===1&&(o=!1);const l=s??void 0;return x.jsx("div",{className:se("relative h-5 w-full leading-5",e===8||e===9?"text-token-text-tertiary":"text-token-text-secondary"),children:x.jsx(jn,{children:l!=null&&x.jsx(Tt.div,{className:"absolute left-0 top-0 line-clamp-1 overflow-visible",initial:o,animate:{opacity:1,x:0,y:0},exit:{opacity:0,x:0,y:-15},transition:a,onAnimationComplete:()=>{e===0&&n()},children:l},l.toString())})})}function Zt(i){return i===0||i===2||i===3}function Mp(i){return Zt(i)||i===4||i===5||i===6||i===10}const Rr=Nt.div`group absolute left-0 top-0 mr-1.5 h-8 overflow-hidden mt-1`;function ys({highlightedCommand:i,status:e,children:t,showWorkUserSetting:n=!1,hideOnlyIfNotInteractedWith:s=!1,onOpenAnalytics:r}){const o=t!=null,[a]=R.useState(n),[l,d]=R.useState(n),[u,m]=R.useState(!1),p=e===We.Finished||e===We.Error,k=s?a?!1:!u:!1,y=e===We.Running&&"loading-shimmer";return p&&k?null:o?x.jsxs(x.Fragment,{children:[x.jsx(Ar,{$canShowWork:!0,children:x.jsx(jn,{children:x.jsx(Rr,{children:x.jsx(Tt.button,{onClick:()=>{l||r==null||r(),d(S=>!S),m(!0)},initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},className:se(y),children:x.jsxs("div",{className:"flex items-center justify-start gap-1",children:[x.jsx("span",{children:i}),l?x.jsx(fd,{className:"icon-md"}):x.jsx(pd,{className:"icon-md"})]})},i==null?void 0:i.toString())})})}),x.jsx(jn,{children:l&&t&&x.jsx(Tt.div,{initial:"collapsed",animate:"reveal",exit:"collapsed",variants:{collapsed:{translateY:-20,opacity:0,height:0},reveal:{translateY:0,opacity:1,height:"auto"}},transition:{duration:.3,ease:"easeInOut"},className:"overflow-hidden",children:t})})]}):x.jsx(Ar,{$canShowWork:!1,children:x.jsx(Rr,{className:se(y),children:i})})}const Ar=Nt.p`first:mt-0 relative h-8
${({$canShowWork:i})=>i?"text-token-text-secondary hover:text-token-text-primary my-1.5":"text-token-text-secondary"}`,vr=Ee(()=>ye(()=>import("./i13yvb7mip3btqm2.js").then(i=>i.A),__vite__mapDeps([33,1,2,3,5,6,7,16,22,23,34,35,36,37,17,38])).then(i=>i.default));function Ip({messages:i,isRequestActive:e,clientThreadId:t}){var S,w,E;const[n,s]=i,r=Ca(n.message),o=(S=s==null?void 0:s.message.metadata)==null?void 0:S.aggregate_result,a=Zf(),l=gs(),d=s!=null&&s.message?wa(s.message):[],u=((E=(w=s==null?void 0:s.message.metadata)==null?void 0:w.aggregate_result)==null?void 0:E.messages.filter(oo))??[],p=(d.filter(_=>_.type==="chart")??[]).length!==u.length,k=l&&!p;let y=We.Running;return(o==null?void 0:o.status)==="success"?y=We.Finished:s!=null&&s.message.content.content_type!==Xn.ExecutionOutput||o!=null&&o.status!=="running"?y=We.Error:(r||!e)&&(y=We.Stopped),x.jsxs(x.Fragment,{children:[x.jsx(Np,{messages:i,status:y,isRequestActive:e}),k&&d.map((_,L)=>{const{type:U}=_;return U==="chart"&&!a?(_.fallback_to_image=!0,x.jsx(Br,{children:x.jsx(vr,{clientThreadId:t,visualization:_})},L)):x.jsx(Br,{children:x.jsx(vr,{clientThreadId:t,visualization:_})},L)}),!k&&s!=null&&x.jsx(Od,{message:s.message})]})}const Br=Nt.div`mb-3 max-w-[80%]`;function Np({messages:i,status:e,isRequestActive:t}){var m;const[n,s]=i,r=Tn(),o=(m=s==null?void 0:s.message.metadata)==null?void 0:m.aggregate_result,a=Ca(n.message),{data:l,error:d}=zc(Vc.ShowExpandedCodeView);let u=r.formatMessage({id:"message.tools.data-analysis.running",defaultMessage:"Analyzing"});if((o==null?void 0:o.status)==="success"?u=r.formatMessage({id:"message.tools.data-analysis.finished",defaultMessage:"Analyzed"}):s!=null&&s.message.content.content_type!==Xn.ExecutionOutput||o!=null&&o.status!=="running"?u=r.formatMessage({id:"message.tools.data-analysis.error",defaultMessage:"Analysis errored"}):(a||!t)&&(u=r.formatMessage({id:"message.tools.data-analysis.stopped",defaultMessage:"Analysis paused"})),l!==void 0||d){const p=Rd(n.message)!=null;return x.jsx(ys,{status:e,highlightedCommand:u,showWorkUserSetting:l??!1,hideOnlyIfNotInteractedWith:!0,children:p?x.jsxs("div",{className:"mb-3 mt-0.5 overflow-hidden rounded-xl bg-black",children:[x.jsx(Ad,{message:n.message,FormattedText:Zi}),s!=null&&x.jsx(vd,{message:s.message})]}):null})}return null}const _p=3,Dp=.1,Fr=[0,.26,.4];function Op({nextMessage:i,isLastMessage:e,isRequestActive:t}){let n=e||!i||i&&!Kr(i.message);const s=Nd(i==null?void 0:i.message),r=$l(s.slice(0,_p).map(o=>o.entries[0].url));if(n){const o=t?x.jsxs("div",{className:"flex items-center gap-1",children:[r.map((a,l)=>x.jsx(Tt.div,{className:"-ml-1.5 first:ml-0 last:mr-1.5",initial:{width:l===0?0:6,opacity:0},animate:{width:20,opacity:1},transition:{duration:Dp,delay:Fr[Math.min(l,Fr.length-1)]},children:x.jsx("div",{className:se("flex h-5 w-5 items-center overflow-hidden rounded","border-l-2 border-token-main-surface-primary bg-token-main-surface-primary"),children:x.jsx(Gl,{url:a,size:32,minSize:16,className:"icon-md rounded"})})},a)),x.jsx(ce,{id:"jjx8Qg",defaultMessage:"Searching the web"})]}):x.jsx(ce,{id:"fssXGM",defaultMessage:"Error while searching"});return x.jsx(ys,{highlightedCommand:o,status:t?We.Running:We.Error})}return null}const Rp={strong:i=>{const{node:e,children:t,...n}=i;return x.jsx("strong",{...n,className:se(n.className,"font-semibold text-token-text-primary"),children:t})},p:i=>{const{node:e,children:t,...n}=i;return x.jsx("p",{...n,className:se(n.className,"text-base","has-[strong]:mb-1 [&:not(:first-child)]:has-[strong]:mt-3 [&:not(:has(strong))]:mb-3"),children:t})}};function Ap({messages:i,isStreaming:e,clientThreadId:t}){var k,y;const[n,s]=R.useState(""),[r,o]=R.useState(!1),a=i[0].message,l=a.id,d=v.getServerThreadId(t),u=$r(a);R.useEffect(()=>{var _;const S=/\*\*(.*?)(?:\*\*|\n|$)/g;let w,E="";for(;(w=S.exec(u))!=null;)E=w[1].trim();E?s(E):((_=a.metadata)==null?void 0:_.initial_text)!=null&&s(a.metadata.initial_text)},[u,(k=a.metadata)==null?void 0:k.initial_text]),R.useEffect(()=>{u.length>0&&o(!0)},[u]);const m=R.useMemo(()=>({client_thread_id:t,message_id:l,conversationId:d}),[t,l,d]);R.useEffect(()=>{r&&Ke.logEvent(Ne.receivedA8KM123Message,m)},[r]);const p=R.useCallback(()=>{Ke.logEvent(Ne.openedA8KM123Message,{...m,isStreaming:e})},[m,e]);return x.jsx(ys,{status:e?We.Running:We.Finished,highlightedCommand:e?n:((y=a.metadata)==null?void 0:y.finished_text)??"",onOpenAnalytics:p,children:r?x.jsx("div",{className:"mb-4 border-l-2 pl-4 dark:border-token-text-secondary",children:x.jsx(Zi,{componentOverrides:Rp,className:"not-prose leading-6",children:u})}):null})}const vp=Ee(()=>ye(()=>import("./sso-oxyy036d0y1nz1o5.js").then(i=>i.J),__vite__mapDeps([40,1,2,3,19,5,6,20,16,7,18,41,22,42,43,44,45,46,14,47,17,48,49,50,51,52,53,54,55,56,12,57,58,25,59,60,61,62,63,64,30,10,65,66,24,67,68,69,70,71,72,15,21,73,74,75,76,77,78,79,80,81,82,83,84,85,36,37])).then(i=>i.JawboneMessage).catch(()=>qf)),Bp=Ee(()=>ye(()=>import("./llfa3invul0gq8sh.js"),__vite__mapDeps([86,1,2,3,5,6,14,7,15,16,17,18,19,20,21,22,23,24,25]))),Fp=Ee(()=>ye(()=>import("./dbo5aplef1foip7t.js"),__vite__mapDeps([87,1,2,3,5,6]))),Pp=Ee(()=>ye(()=>import("./kyas4wldr2yyvw0d.js"),__vite__mapDeps([88,1,2,3,5,6,14,7,15,16,17,18,19,20,21,22,23,24,25]))),jp=Ee(()=>ye(()=>import("./c33ks5f9akdgdfk2.js"),__vite__mapDeps([89,1,2,3,5,6,16,7])).then(i=>i.TextMessageEditor)),Lp=Ee(()=>ye(()=>import("./kfg98pf0m5bb64ax.js"),__vite__mapDeps([90,1,2,3,5,6,7,70,16,14,15,17,18,19,20,21,22,23,24,25]))),zp=Ee(()=>ye(()=>import("./gxg4rwtqa8nyryfr.js"),__vite__mapDeps([91,1,2,3,5,6,14,7,15,16,17,18,19,20,21,22,23,24,25]))),Vp=Ee(()=>ye(()=>import("./g1y1k99v1i3yl9h6.js"),__vite__mapDeps([92,1,2,3,5,6,18,16,7,52,14,15,17,19,20,21,22,23,24,25])).then(i=>i.BrowsingMessage)),Up=Ee(()=>ye(()=>import("./dyzo3md0brog80y8.js"),__vite__mapDeps([93,1,2,3,5,6,14,7,15,16,17,18,19,20,21,22,23,24,25])).then(i=>i.SearchResultMessage)),qp=Ee(()=>ye(()=>import("./f3v3nz6reprmd7db.js"),__vite__mapDeps([94,1,2,3,5,6,18,16,7,69,66])).then(i=>i.GizmoContactsMessage)),Wp=Ee(()=>ye(()=>import("./dcvoi7xdu0nalgfg.js"),__vite__mapDeps([95,1,2,3,5,6,18,16,7,14,15,17,19,20,21,22,23,24,25])).then(i=>i.JITPluginMessage));function Xm(i){switch(i.type){case P.Text:case P.Debug:return[i.message];case P.MultiText:case P.Browsing:case P.CodeInterpreter:case P.JITPlugin:case P.RetrievalBrowsing:case P.ParallelBrowsing:case P.Dalle:case P.GizmoEditor:case P.SearchResult:case P.GizmoContacts:case P.a8km123:case P.f959b8c:case P.Canmore:case P.Jawbone:case P.SearchGPTQuery:return i.messages;default:throw new Error("Bad")}}function eg({groupedMessagesToRender:i,allGroupedMessages:e,clientThreadId:t,isEditing:n,isUserTurn:s,isCompletionRequestInProgress:r,isFeedbackEnabled:o,isFinalTurn:a,turnIndex:l,hasActiveRequest:d,showEditButton:u=!1,handleEnterEdit:m,handleExitEdit:p,onChangeItemInView:k,onRequestMoreCompletions:y,onRequestCompletion:S,shouldGrowContainer:w=!0}){const{showDebugConversationTurns:E}=Kl(),_=is(t),L=e.some(M=>Yl.includes(M.type)),U=i.map((M,A)=>{var z,O,J,ae,X,ue,le,ze,xe,ke,Ie,pe,Ae;const H=A===e.length-1;switch(M.type){case P.Text:case P.MultiText:{const B=i[A-1],K=B==null?void 0:B.type,Pe=B&&"messages"in B?B.messages:void 0;if(M.type===P.Text){const Ve=(M==null?void 0:M.message)&&!Kr(M.message.message),F=n?x.jsx(jp,{message:M.message,clientThreadId:t,onChangeItemInView:k,onRequestCompletion:S,onRequestMoreCompletions:y,onExitEdit:p,disabled:d}):L&&Ve?null:x.jsx(fp,{className:"min-h-8",message:M.message,isFeedbackEnabled:o,isCompletionInProgress:H&&r,turnIndex:l,clientThreadId:t,showEditButton:u,onEnterEdit:m,isUserTurn:s,onRequestMoreCompletions:y,prevGroupedMessageType:K,prevGroupedMessages:Pe});return x.jsxs(R.Fragment,{children:[F,x.jsx(Zl,{isUserTurn:s,message:M.message.message})]},"group-"+M.message.nodeId)}else return M.type===P.MultiText?x.jsx(Pp,{clientThreadId:t,messages:M.messages,isCompletionInProgress:H&&r,isFeedbackEnabled:o,onRequestMoreCompletions:y,prevGroupedMessageType:K,prevGroupedMessages:Pe},"multitext-"+(((z=M.messages[0])==null?void 0:z.nodeId)??A)):M.type}case P.Browsing:case P.RetrievalBrowsing:{const B=_!=null&&[qe.GizmoInteraction,qe.GizmoMagicCreate,qe.GizmoTest].includes(_.kind);return x.jsx(Vp,{messages:M.messages,isRequestActive:d,isLastMessageInTurn:H,isUsingGizmo:B,isRetrieval:M.type===P.RetrievalBrowsing},"browsing-"+(((O=M.messages[0])==null?void 0:O.nodeId)??A))}case P.SearchGPTQuery:{const B=e[A+1];return x.jsx(Op,{isRequestActive:d,isLastMessage:H,nextMessage:B&&B.type===P.Text?B.message:void 0},"searchquery-"+(((J=M.messages[0])==null?void 0:J.nodeId)??A))}case P.a8km123:return x.jsx(Ap,{messages:M.messages,isStreaming:H&&r,clientThreadId:t},"sum-"+(((ae=M.messages[0])==null?void 0:ae.nodeId)??A));case P.f959b8c:return null;case P.Jawbone:{const B=A+1<e.length?e[A+1]:void 0;return x.jsx(vp,{nextMessage:B&&B.type===P.Text?B.message:void 0,isLastMessage:H,isRequestActive:d},"jawbone-"+(((X=M.messages[0])==null?void 0:X.nodeId)??A))}case P.ParallelBrowsing:return x.jsx(zp,{messages:M.messages},"parallel-"+(((ue=M.messages[0])==null?void 0:ue.nodeId)??A));case P.CodeInterpreter:return x.jsx(Ip,{messages:M.messages,isRequestActive:d,clientThreadId:t},"ada-"+(((le=M.messages[0])==null?void 0:le.nodeId)??A));case P.JITPlugin:return x.jsx(Wp,{messages:M.messages,clientThreadId:t,isLastTurnInConversation:a,onRequestCompletion:S},"jit-"+(((ze=M.messages[0])==null?void 0:ze.nodeId)??A));case P.GizmoContacts:return x.jsx(qp,{messages:M.messages,clientThreadId:t,isLastTurnInConversation:a,onRequestCompletion:S},"gizmo-contacts-"+(((xe=M.messages[0])==null?void 0:xe.nodeId)??A));case P.Dalle:return x.jsx(Lp,{messages:M.messages,clientThreadId:t},"dalle-"+(((ke=M.messages[0])==null?void 0:ke.nodeId)??A));case P.GizmoEditor:return x.jsx(Bp,{messages:M.messages},"gizmo-editor-"+(((Ie=M.messages[0])==null?void 0:Ie.nodeId)??A));case P.Canmore:return x.jsx(jf,{messages:M.messages,isRequestActive:d},"canmore-"+(((pe=M.messages[0])==null?void 0:pe.nodeId)??A));case P.Debug:return E?x.jsx(Fp,{message:M.message},"debug-"+M.message.nodeId):null;case P.SearchResult:return x.jsx(Up,{messages:M.messages},"search-result-"+(((Ae=M.messages[0])==null?void 0:Ae.nodeId)??A))}});return x.jsx(Jp,{shouldGrowContainer:w,children:U})}function Hp(){return x.jsx(Ql,{type:"danger",children:x.jsx(ce,{id:"daIg0P",defaultMessage:"Unable to display this message due to a error."})})}function Jp({children:i,shouldGrowContainer:e}){return x.jsx("div",{className:se({"flex max-w-full flex-col":!0,"flex-grow":e}),children:x.jsx(Uc,{name:"GroupedMessages",fallback:Hp,children:i})})}function $p(i){return i==null||[qe.PrimaryAssistant,qe.GizmoInteraction].includes(i.kind)}function tg(i,e){const t=is(i,e),{data:n}=Sd(t!=null&&"gizmo_id"in t?t.gizmo_id:void 0,(t==null?void 0:t.kind)===qe.GizmoTest);if(t!=null)switch(t.kind){case qe.GizmoInteraction:case qe.GizmoMagicCreate:case qe.GizmoTest:return{gizmo:n,...t};case qe.PrimaryAssistant:return t}}function Gp(i,e,t){const s=v.getTree(e).getMessageId(v.getThreadCurrentLeafId(e));ut.generateTitle(e,s,t).then(({title:r})=>{v.setTitle(e,r,ro.Generated),ao(i),Ke.logEvent(Ne.renameThread,{threadId:e,content:r,model:t})}).catch(_e.addError)}function ng(i,e,t){const n=()=>{const r=Os(t);i(r)},s=Oi.getGizmoId(t);s!=null?Cd(e,s).then(r=>{Xl(Os(t,r))}).catch(r=>{_e.addError(r),n()}):n()}const Gi={onCreate(i,e,t,n){Ke.logEvent(Ne.newThread),!n&&$p(Oi.getConversationMode(e))&&qc(t).then(s=>{no(s)||(ao(t),i(e))})},onCreateFinished(i,e,t){var n;if(!(t||!e)&&!gn.checkGate("2562876640")){const s=(n=Oi.getThread(e))==null?void 0:n.initialThreadData.lastModelUsed;s==null&&_e.addError("missing lastModelUsed on conversation create finished"),Gp(i,e,s)}}};function Pr(i,e){i.updateNodeMetadata(e.id,{completionSampleFinishTime:Date.now()})}class Kp{constructor(e,t,n,s,r,o,a,l,d,u,m,p){$(this,"currentTree");$(this,"currentNodeId");$(this,"firstResponse",!0);$(this,"didCreateFirstCompletionInNewThread",!1);$(this,"activeBranchLastMessage");$(this,"messagesToUpdate",{});$(this,"allIncompleteStreamedMessages",{});$(this,"responseThreadId");$(this,"isCompletionBlocked",!1);$(this,"isEitherFlagged",!1);$(this,"variantsInStreamInfo");$(this,"activeBranchNodeId");$(this,"blurDuringCompletionTracker",new tc);$(this,"completionLatencyTracker");$(this,"turnTracker");$(this,"debouncedUpdateCompletion",nc(()=>{this.isCompletionBlocked||v.updateTree(this.clientThreadId,e=>{Object.values(this.messagesToUpdate).forEach(t=>{e.updateNodeMessage(t.id,t)})}),this.messagesToUpdate={}},50,{leading:!0,maxWait:50}));$(this,"handleResponse",async e=>{if(e.type!=="done"&&this.turnTracker.onUpdateEventCount(),this.completionLatencyTracker.onResponse(e,this.activeBranchLastMessage,this.responseThreadId),this.responseThreadId===void 0&&"conversationId"in e){const t=e.conversationId;this.responseThreadId=t,ss(this.clientThreadId)&&v.getServerThreadId(this.clientThreadId)!==t&&(v.setServerIdForNewThread(this.clientThreadId,t),Ke.logEvent(Ne.attributeClientThreadToServerThread,{client_thread_id:this.clientThreadId,server_thread_id:t}))}switch(e.type){case"error":this.handleError(e);break;case"num_variants_in_stream":this.bindVariantInfoToTree(e);break;case"moderation":this.handleModeration(e);break;case"url_moderation":this.handleUrlModeration(e);break;case"message":this.handleMessage(e),this.debouncedUpdateCompletion();break;case"done":this.handleDone();break;case"gizmo_inline_review":this.handleGizmoInlineReview(e);break;case"title_generation":this.handleTitleGeneration(e);break;case"conversation_detail_metadata":this.handleConversationDetailMetadata(e);break}});this.queryClient=e,this.clientThreadId=t,this.targetNodeId=n,this.completionType=s,this.model=r,this.eventSource=o,this.onCreate=a,this.callModelAgain=d,this.onCompletionFinished=u,this.isHistoryAndTrainingDisabled=p,this.currentTree=v.getTree(t),this.currentNodeId=n,this.activeBranchLastMessage=this.currentTree.getMessage(this.currentNodeId),this.completionLatencyTracker=new ec(l),this.turnTracker=m,this.turnTracker.onCompletionStarted(s,this.model)}handleError(e){const t=e.error,n=(t==null?void 0:t.message)||"Something went wrong",s=t instanceof ct&&t.code||"",r=t instanceof ct&&t.status,o=t instanceof ct?t.canRetry:void 0;switch(this.turnTracker.handleRawError(n,r),v.updateTree(this.clientThreadId,a=>{a.updateNodeMessage(this.currentNodeId,this.activeBranchLastMessage),a.updateNodeMetadata(this.currentNodeId,{err:n,errType:"danger",errCode:s,completionSampleFinishTime:Date.now(),canRetry:o})}),s){case dt.ContentPolicy:case dt.ContentOrTos:case Mi:case Qr:break;default:n!==void 0&&gn.logEvent("chatgpt_conversation_error_web",n)}this.blurDuringCompletionTracker.onMessageError(),this.cleanUp(),this.onCompletionFinished(this.responseThreadId),t instanceof ct&&(t==null?void 0:t.code)===Mi&&(t!=null&&t.clearsIn)&&(ic(new Date(Date.now()+t.clearsIn*1e3).toISOString()),setTimeout(()=>{sc()},t.clearsIn*1e3))}handleGizmoInlineReview(e){v.setPromptGptRating(this.clientThreadId,e.gizmoId)}handleTitleGeneration(e){v.setTitle(this.clientThreadId,e.title,ro.Generated)}handleConversationDetailMetadata(e){const{default_model_slug:t}=e;t&&v.setThreadModelId(this.clientThreadId,t),Ni.updateDetails(e)}bindVariantInfoToTree(e){this.variantsInStreamInfo=e,v.updateTree(this.clientThreadId,t=>{const n=t.getParentPromptNode(this.currentNodeId);t.updateNodeMetadata(n.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}handleModeration(e){const{isCompletion:t,messageId:n,conversationId:s,flagged:r,blocked:o,disclaimers:a,metadata:l}=e,d=!!(a!=null&&a.length)&&t;(r||o||d)&&(this.isEitherFlagged=!0,o&&t&&(this.isCompletionBlocked=!0),v.updateTree(this.clientThreadId,u=>{const m=u.messageIdToNodeId(n);o&&u.clearNodeMessageParts(m),u.updateNodeMetadata(m,{...(d&&!!(a!=null&&a.length)&&rc(a,o))??{},...r&&oc,...o&&(l!=null&&l.model_incompatibility?ac:lc),completionSampleFinishTime:Date.now()})}),Ke.logEvent(t?o?Ne.completionBlockedByModeration:Ne.completionFlaggedByModeration:o?Ne.promptBlockedByModeration:Ne.promptFlaggedByModeration,{threadId:s,id:n}))}handleUrlModeration(e){const{conversationId:t,url:n,isSafe:s}=e;s&&v.addThreadSafeUrl(t,n)}handleMessage(e){var r,o,a,l,d,u,m,p,k,y,S;let t=!0;const{message:n,conversationId:s}=e;if(this.turnTracker.onMessageUpdate((r=n.metadata)==null?void 0:r.model_slug,(o=n.metadata)==null?void 0:o.gizmo_id,n.author.name,n.author.role),this.firstResponse&&!this.currentTree.hasReceivedServerCompletion){if((n==null?void 0:n.author.role)===xt.System){const w=(a=n.metadata)!=null&&a.parent_id?this.currentTree.getNodeByIdOrMessageId(n.metadata.parent_id):void 0;if((w==null?void 0:w.message.author.role)!==xt.User){this.currentTree.appendSystemMessageToRoot(n);return}}else if((n==null?void 0:n.author.role)===xt.User)return;if(this.currentTree.hasNodeOrMessageId(n.id))return}if(this.firstResponse&&((l=n.metadata)!=null&&l.rebase_system_message)){v.updateTree(this.clientThreadId,w=>{var _;if(((_=n.metadata)==null?void 0:_.parent_id)==null)throw Error("Unexpected rebased system message without parent");const E=w.getNodeByIdOrMessageId(this.targetNodeId);w.deleteNode(this.targetNodeId),w.addNode(n.id,n,n.metadata.parent_id,n.author.role),w.addNode(E.id,E.message,n.id,E.message.author.role)});return}if(this.firstResponse){const w=((d=Vn.getState().threads[this.clientThreadId])==null?void 0:d.continuingFromSharedConversationId)!=null;v.removeContinuingFromSharedConversationId(this.clientThreadId),this.firstResponse=!1,this.didCreateFirstCompletionInNewThread=!this.currentTree.hasReceivedServerCompletion||w,v.updateTree(this.clientThreadId,_=>{_.updateNodeMessage(this.currentNodeId,n)}),this.didCreateFirstCompletionInNewThread&&Gi.onCreate(this.onCreate,s,this.queryClient,this.isHistoryAndTrainingDisabled);const E={id:this.targetNodeId,threadId:s,completionType:this.completionType,eventSource:this.eventSource,model:this.model};if(this.completionType===dn.Next){const _=Vn.getState().threads[s],L=(u=_==null?void 0:_.conversationTurns)==null?void 0:u.length,U=(m=_==null?void 0:_.conversationTurns)==null?void 0:m.filter(A=>A.role==xt.User),M=U&&((p=U[U.length-1])==null?void 0:p.messages[0].message);if((M==null?void 0:M.content.content_type)==Xn.Text){const A=M.content.parts.join("").length,H=(U==null?void 0:U.length)??0;E.countConversationTurns=L,E.countUserSubmittedMessages=H,E.countLastUserPromptTextMessageLength=A}}Ke.logEvent(Ne.generateCompletion,E)}else if(this.completionType!==dn.Continue){const w=this.currentTree.containsNodeOrMessageId(n.id),E=(k=n.metadata)==null?void 0:k.parent_id;if(w||(this.debouncedUpdateCompletion.flush(),v.updateTree(this.clientThreadId,_=>{if(E==null)throw new Error(`Received a message with no parentId: ${JSON.stringify(n)}`);_.addNode(n.id,n,E,xt.Assistant)})),E!=null&&E===this.activeBranchNodeId){const _=this.allIncompleteStreamedMessages[E];_!=null&&(v.updateTree(this.clientThreadId,L=>{Pr(L,_)}),delete this.allIncompleteStreamedMessages[E])}if(t=(((y=this.variantsInStreamInfo)==null?void 0:y.num_variants_in_stream)??1)===1||this.activeBranchNodeId==null||this.activeBranchNodeId===n.id||this.currentTree.isAncestorOfNode(this.activeBranchNodeId,n.id),t&&this.activeBranchNodeId!==n.id){this.activeBranchNodeId=n.id,this.currentNodeId=n.id;const _=v.getThreadCurrentLeafId(this.clientThreadId);this.currentTree.messageIdToNodeId(this.currentNodeId)!==this.currentTree.messageIdToNodeId(_)&&v.setThreadCurrentLeafId(this.clientThreadId,this.currentNodeId),E!=null&&v.updateTree(this.clientThreadId,L=>{const U=L.getParentPromptNode(n.id);L.updateNodeMetadata(U.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}}if((n==null?void 0:n.author.role)===xt.Tool&&(n==null?void 0:n.author.name)==="bio"){const w=(S=n.metadata)==null?void 0:S.gizmo_id;setTimeout(()=>{this.queryClient.invalidateQueries({queryKey:cc(w)})},5e3)}t&&(this.activeBranchLastMessage=n),this.messagesToUpdate[n.id]=n,this.allIncompleteStreamedMessages[n.id]=n}async handleDone(){var e,t;if(this.turnTracker.model_message_update_count>0?this.turnTracker.logCompletion({type:Ln.Success}):this.turnTracker.logCompletion({type:Ln.Error,error:{reason:"empty_response",message:"Successful completion ended with no messages"}}),this.isCompletionBlocked||(this.debouncedUpdateCompletion.flush(),this.isEitherFlagged||(this.didCreateFirstCompletionInNewThread&&Gi.onCreateFinished(this.queryClient,this.responseThreadId,this.isHistoryAndTrainingDisabled),this.onCompletionFinished(this.responseThreadId))),v.updateTree(this.clientThreadId,n=>{Object.values(this.allIncompleteStreamedMessages).forEach(s=>{Pr(n,s)})}),Yr.publish({kind:"createConversation",clientThreadId:this.clientThreadId}),this.blurDuringCompletionTracker.onMessageDone(),this.cleanUp(),((t=(e=this.activeBranchLastMessage)==null?void 0:e.metadata)==null?void 0:t.client_actions)!==void 0){const n=await dc(this.clientThreadId,this.activeBranchLastMessage);n.length>0&&this.callModelAgain(this.currentNodeId,n)}}cleanUp(){setTimeout(()=>{Bd(this.clientThreadId,Wc.FINISHED),Qi.removeRequest(this.targetNodeId),v.releaseThread(this.clientThreadId)},0)}}/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(i){const e=hc,t=uc,n=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;i.Buffer=a,i.SlowBuffer=_,i.INSPECT_MAX_BYTES=50;const s=2147483647;i.kMaxLength=s,a.TYPED_ARRAY_SUPPORT=r(),!a.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function r(){try{const f=new Uint8Array(1),c={foo:function(){return 42}};return Object.setPrototypeOf(c,Uint8Array.prototype),Object.setPrototypeOf(f,c),f.foo()===42}catch{return!1}}Object.defineProperty(a.prototype,"parent",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.buffer}}),Object.defineProperty(a.prototype,"offset",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.byteOffset}});function o(f){if(f>s)throw new RangeError('The value "'+f+'" is invalid for option "size"');const c=new Uint8Array(f);return Object.setPrototypeOf(c,a.prototype),c}function a(f,c,h){if(typeof f=="number"){if(typeof c=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return m(f)}return l(f,c,h)}a.poolSize=8192;function l(f,c,h){if(typeof f=="string")return p(f,c);if(ArrayBuffer.isView(f))return y(f);if(f==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof f);if(et(f,ArrayBuffer)||f&&et(f.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(et(f,SharedArrayBuffer)||f&&et(f.buffer,SharedArrayBuffer)))return S(f,c,h);if(typeof f=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const g=f.valueOf&&f.valueOf();if(g!=null&&g!==f)return a.from(g,c,h);const b=w(f);if(b)return b;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof f[Symbol.toPrimitive]=="function")return a.from(f[Symbol.toPrimitive]("string"),c,h);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof f)}a.from=function(f,c,h){return l(f,c,h)},Object.setPrototypeOf(a.prototype,Uint8Array.prototype),Object.setPrototypeOf(a,Uint8Array);function d(f){if(typeof f!="number")throw new TypeError('"size" argument must be of type number');if(f<0)throw new RangeError('The value "'+f+'" is invalid for option "size"')}function u(f,c,h){return d(f),f<=0?o(f):c!==void 0?typeof h=="string"?o(f).fill(c,h):o(f).fill(c):o(f)}a.alloc=function(f,c,h){return u(f,c,h)};function m(f){return d(f),o(f<0?0:E(f)|0)}a.allocUnsafe=function(f){return m(f)},a.allocUnsafeSlow=function(f){return m(f)};function p(f,c){if((typeof c!="string"||c==="")&&(c="utf8"),!a.isEncoding(c))throw new TypeError("Unknown encoding: "+c);const h=L(f,c)|0;let g=o(h);const b=g.write(f,c);return b!==h&&(g=g.slice(0,b)),g}function k(f){const c=f.length<0?0:E(f.length)|0,h=o(c);for(let g=0;g<c;g+=1)h[g]=f[g]&255;return h}function y(f){if(et(f,Uint8Array)){const c=new Uint8Array(f);return S(c.buffer,c.byteOffset,c.byteLength)}return k(f)}function S(f,c,h){if(c<0||f.byteLength<c)throw new RangeError('"offset" is outside of buffer bounds');if(f.byteLength<c+(h||0))throw new RangeError('"length" is outside of buffer bounds');let g;return c===void 0&&h===void 0?g=new Uint8Array(f):h===void 0?g=new Uint8Array(f,c):g=new Uint8Array(f,c,h),Object.setPrototypeOf(g,a.prototype),g}function w(f){if(a.isBuffer(f)){const c=E(f.length)|0,h=o(c);return h.length===0||f.copy(h,0,0,c),h}if(f.length!==void 0)return typeof f.length!="number"||oi(f.length)?o(0):k(f);if(f.type==="Buffer"&&Array.isArray(f.data))return k(f.data)}function E(f){if(f>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return f|0}function _(f){return+f!=f&&(f=0),a.alloc(+f)}a.isBuffer=function(c){return c!=null&&c._isBuffer===!0&&c!==a.prototype},a.compare=function(c,h){if(et(c,Uint8Array)&&(c=a.from(c,c.offset,c.byteLength)),et(h,Uint8Array)&&(h=a.from(h,h.offset,h.byteLength)),!a.isBuffer(c)||!a.isBuffer(h))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(c===h)return 0;let g=c.length,b=h.length;for(let C=0,T=Math.min(g,b);C<T;++C)if(c[C]!==h[C]){g=c[C],b=h[C];break}return g<b?-1:b<g?1:0},a.isEncoding=function(c){switch(String(c).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},a.concat=function(c,h){if(!Array.isArray(c))throw new TypeError('"list" argument must be an Array of Buffers');if(c.length===0)return a.alloc(0);let g;if(h===void 0)for(h=0,g=0;g<c.length;++g)h+=c[g].length;const b=a.allocUnsafe(h);let C=0;for(g=0;g<c.length;++g){let T=c[g];if(et(T,Uint8Array))C+T.length>b.length?(a.isBuffer(T)||(T=a.from(T)),T.copy(b,C)):Uint8Array.prototype.set.call(b,T,C);else if(a.isBuffer(T))T.copy(b,C);else throw new TypeError('"list" argument must be an Array of Buffers');C+=T.length}return b};function L(f,c){if(a.isBuffer(f))return f.length;if(ArrayBuffer.isView(f)||et(f,ArrayBuffer))return f.byteLength;if(typeof f!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof f);const h=f.length,g=arguments.length>2&&arguments[2]===!0;if(!g&&h===0)return 0;let b=!1;for(;;)switch(c){case"ascii":case"latin1":case"binary":return h;case"utf8":case"utf-8":return ft(f).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return h*2;case"hex":return h>>>1;case"base64":return Ut(f).length;default:if(b)return g?-1:ft(f).length;c=(""+c).toLowerCase(),b=!0}}a.byteLength=L;function U(f,c,h){let g=!1;if((c===void 0||c<0)&&(c=0),c>this.length||((h===void 0||h>this.length)&&(h=this.length),h<=0)||(h>>>=0,c>>>=0,h<=c))return"";for(f||(f="utf8");;)switch(f){case"hex":return pe(this,c,h);case"utf8":case"utf-8":return le(this,c,h);case"ascii":return ke(this,c,h);case"latin1":case"binary":return Ie(this,c,h);case"base64":return ue(this,c,h);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Ae(this,c,h);default:if(g)throw new TypeError("Unknown encoding: "+f);f=(f+"").toLowerCase(),g=!0}}a.prototype._isBuffer=!0;function M(f,c,h){const g=f[c];f[c]=f[h],f[h]=g}a.prototype.swap16=function(){const c=this.length;if(c%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let h=0;h<c;h+=2)M(this,h,h+1);return this},a.prototype.swap32=function(){const c=this.length;if(c%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let h=0;h<c;h+=4)M(this,h,h+3),M(this,h+1,h+2);return this},a.prototype.swap64=function(){const c=this.length;if(c%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let h=0;h<c;h+=8)M(this,h,h+7),M(this,h+1,h+6),M(this,h+2,h+5),M(this,h+3,h+4);return this},a.prototype.toString=function(){const c=this.length;return c===0?"":arguments.length===0?le(this,0,c):U.apply(this,arguments)},a.prototype.toLocaleString=a.prototype.toString,a.prototype.equals=function(c){if(!a.isBuffer(c))throw new TypeError("Argument must be a Buffer");return this===c?!0:a.compare(this,c)===0},a.prototype.inspect=function(){let c="";const h=i.INSPECT_MAX_BYTES;return c=this.toString("hex",0,h).replace(/(.{2})/g,"$1 ").trim(),this.length>h&&(c+=" ... "),"<Buffer "+c+">"},n&&(a.prototype[n]=a.prototype.inspect),a.prototype.compare=function(c,h,g,b,C){if(et(c,Uint8Array)&&(c=a.from(c,c.offset,c.byteLength)),!a.isBuffer(c))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof c);if(h===void 0&&(h=0),g===void 0&&(g=c?c.length:0),b===void 0&&(b=0),C===void 0&&(C=this.length),h<0||g>c.length||b<0||C>this.length)throw new RangeError("out of range index");if(b>=C&&h>=g)return 0;if(b>=C)return-1;if(h>=g)return 1;if(h>>>=0,g>>>=0,b>>>=0,C>>>=0,this===c)return 0;let T=C-b,q=g-h;const re=Math.min(T,q),ne=this.slice(b,C),oe=c.slice(h,g);for(let Z=0;Z<re;++Z)if(ne[Z]!==oe[Z]){T=ne[Z],q=oe[Z];break}return T<q?-1:q<T?1:0};function A(f,c,h,g,b){if(f.length===0)return-1;if(typeof h=="string"?(g=h,h=0):h>2147483647?h=2147483647:h<-2147483648&&(h=-2147483648),h=+h,oi(h)&&(h=b?0:f.length-1),h<0&&(h=f.length+h),h>=f.length){if(b)return-1;h=f.length-1}else if(h<0)if(b)h=0;else return-1;if(typeof c=="string"&&(c=a.from(c,g)),a.isBuffer(c))return c.length===0?-1:H(f,c,h,g,b);if(typeof c=="number")return c=c&255,typeof Uint8Array.prototype.indexOf=="function"?b?Uint8Array.prototype.indexOf.call(f,c,h):Uint8Array.prototype.lastIndexOf.call(f,c,h):H(f,[c],h,g,b);throw new TypeError("val must be string, number or Buffer")}function H(f,c,h,g,b){let C=1,T=f.length,q=c.length;if(g!==void 0&&(g=String(g).toLowerCase(),g==="ucs2"||g==="ucs-2"||g==="utf16le"||g==="utf-16le")){if(f.length<2||c.length<2)return-1;C=2,T/=2,q/=2,h/=2}function re(oe,Z){return C===1?oe[Z]:oe.readUInt16BE(Z*C)}let ne;if(b){let oe=-1;for(ne=h;ne<T;ne++)if(re(f,ne)===re(c,oe===-1?0:ne-oe)){if(oe===-1&&(oe=ne),ne-oe+1===q)return oe*C}else oe!==-1&&(ne-=ne-oe),oe=-1}else for(h+q>T&&(h=T-q),ne=h;ne>=0;ne--){let oe=!0;for(let Z=0;Z<q;Z++)if(re(f,ne+Z)!==re(c,Z)){oe=!1;break}if(oe)return ne}return-1}a.prototype.includes=function(c,h,g){return this.indexOf(c,h,g)!==-1},a.prototype.indexOf=function(c,h,g){return A(this,c,h,g,!0)},a.prototype.lastIndexOf=function(c,h,g){return A(this,c,h,g,!1)};function z(f,c,h,g){h=Number(h)||0;const b=f.length-h;g?(g=Number(g),g>b&&(g=b)):g=b;const C=c.length;g>C/2&&(g=C/2);let T;for(T=0;T<g;++T){const q=parseInt(c.substr(T*2,2),16);if(oi(q))return T;f[h+T]=q}return T}function O(f,c,h,g){return pt(ft(c,f.length-h),f,h,g)}function J(f,c,h,g){return pt(V(c),f,h,g)}function ae(f,c,h,g){return pt(Ut(c),f,h,g)}function X(f,c,h,g){return pt(Dt(c,f.length-h),f,h,g)}a.prototype.write=function(c,h,g,b){if(h===void 0)b="utf8",g=this.length,h=0;else if(g===void 0&&typeof h=="string")b=h,g=this.length,h=0;else if(isFinite(h))h=h>>>0,isFinite(g)?(g=g>>>0,b===void 0&&(b="utf8")):(b=g,g=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const C=this.length-h;if((g===void 0||g>C)&&(g=C),c.length>0&&(g<0||h<0)||h>this.length)throw new RangeError("Attempt to write outside buffer bounds");b||(b="utf8");let T=!1;for(;;)switch(b){case"hex":return z(this,c,h,g);case"utf8":case"utf-8":return O(this,c,h,g);case"ascii":case"latin1":case"binary":return J(this,c,h,g);case"base64":return ae(this,c,h,g);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return X(this,c,h,g);default:if(T)throw new TypeError("Unknown encoding: "+b);b=(""+b).toLowerCase(),T=!0}},a.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function ue(f,c,h){return c===0&&h===f.length?e.fromByteArray(f):e.fromByteArray(f.slice(c,h))}function le(f,c,h){h=Math.min(f.length,h);const g=[];let b=c;for(;b<h;){const C=f[b];let T=null,q=C>239?4:C>223?3:C>191?2:1;if(b+q<=h){let re,ne,oe,Z;switch(q){case 1:C<128&&(T=C);break;case 2:re=f[b+1],(re&192)===128&&(Z=(C&31)<<6|re&63,Z>127&&(T=Z));break;case 3:re=f[b+1],ne=f[b+2],(re&192)===128&&(ne&192)===128&&(Z=(C&15)<<12|(re&63)<<6|ne&63,Z>2047&&(Z<55296||Z>57343)&&(T=Z));break;case 4:re=f[b+1],ne=f[b+2],oe=f[b+3],(re&192)===128&&(ne&192)===128&&(oe&192)===128&&(Z=(C&15)<<18|(re&63)<<12|(ne&63)<<6|oe&63,Z>65535&&Z<1114112&&(T=Z))}}T===null?(T=65533,q=1):T>65535&&(T-=65536,g.push(T>>>10&1023|55296),T=56320|T&1023),g.push(T),b+=q}return xe(g)}const ze=4096;function xe(f){const c=f.length;if(c<=ze)return String.fromCharCode.apply(String,f);let h="",g=0;for(;g<c;)h+=String.fromCharCode.apply(String,f.slice(g,g+=ze));return h}function ke(f,c,h){let g="";h=Math.min(f.length,h);for(let b=c;b<h;++b)g+=String.fromCharCode(f[b]&127);return g}function Ie(f,c,h){let g="";h=Math.min(f.length,h);for(let b=c;b<h;++b)g+=String.fromCharCode(f[b]);return g}function pe(f,c,h){const g=f.length;(!c||c<0)&&(c=0),(!h||h<0||h>g)&&(h=g);let b="";for(let C=c;C<h;++C)b+=Na[f[C]];return b}function Ae(f,c,h){const g=f.slice(c,h);let b="";for(let C=0;C<g.length-1;C+=2)b+=String.fromCharCode(g[C]+g[C+1]*256);return b}a.prototype.slice=function(c,h){const g=this.length;c=~~c,h=h===void 0?g:~~h,c<0?(c+=g,c<0&&(c=0)):c>g&&(c=g),h<0?(h+=g,h<0&&(h=0)):h>g&&(h=g),h<c&&(h=c);const b=this.subarray(c,h);return Object.setPrototypeOf(b,a.prototype),b};function B(f,c,h){if(f%1!==0||f<0)throw new RangeError("offset is not uint");if(f+c>h)throw new RangeError("Trying to access beyond buffer length")}a.prototype.readUintLE=a.prototype.readUIntLE=function(c,h,g){c=c>>>0,h=h>>>0,g||B(c,h,this.length);let b=this[c],C=1,T=0;for(;++T<h&&(C*=256);)b+=this[c+T]*C;return b},a.prototype.readUintBE=a.prototype.readUIntBE=function(c,h,g){c=c>>>0,h=h>>>0,g||B(c,h,this.length);let b=this[c+--h],C=1;for(;h>0&&(C*=256);)b+=this[c+--h]*C;return b},a.prototype.readUint8=a.prototype.readUInt8=function(c,h){return c=c>>>0,h||B(c,1,this.length),this[c]},a.prototype.readUint16LE=a.prototype.readUInt16LE=function(c,h){return c=c>>>0,h||B(c,2,this.length),this[c]|this[c+1]<<8},a.prototype.readUint16BE=a.prototype.readUInt16BE=function(c,h){return c=c>>>0,h||B(c,2,this.length),this[c]<<8|this[c+1]},a.prototype.readUint32LE=a.prototype.readUInt32LE=function(c,h){return c=c>>>0,h||B(c,4,this.length),(this[c]|this[c+1]<<8|this[c+2]<<16)+this[c+3]*16777216},a.prototype.readUint32BE=a.prototype.readUInt32BE=function(c,h){return c=c>>>0,h||B(c,4,this.length),this[c]*16777216+(this[c+1]<<16|this[c+2]<<8|this[c+3])},a.prototype.readBigUInt64LE=mt(function(c){c=c>>>0,Y(c,"offset");const h=this[c],g=this[c+7];(h===void 0||g===void 0)&&he(c,this.length-8);const b=h+this[++c]*2**8+this[++c]*2**16+this[++c]*2**24,C=this[++c]+this[++c]*2**8+this[++c]*2**16+g*2**24;return BigInt(b)+(BigInt(C)<<BigInt(32))}),a.prototype.readBigUInt64BE=mt(function(c){c=c>>>0,Y(c,"offset");const h=this[c],g=this[c+7];(h===void 0||g===void 0)&&he(c,this.length-8);const b=h*2**24+this[++c]*2**16+this[++c]*2**8+this[++c],C=this[++c]*2**24+this[++c]*2**16+this[++c]*2**8+g;return(BigInt(b)<<BigInt(32))+BigInt(C)}),a.prototype.readIntLE=function(c,h,g){c=c>>>0,h=h>>>0,g||B(c,h,this.length);let b=this[c],C=1,T=0;for(;++T<h&&(C*=256);)b+=this[c+T]*C;return C*=128,b>=C&&(b-=Math.pow(2,8*h)),b},a.prototype.readIntBE=function(c,h,g){c=c>>>0,h=h>>>0,g||B(c,h,this.length);let b=h,C=1,T=this[c+--b];for(;b>0&&(C*=256);)T+=this[c+--b]*C;return C*=128,T>=C&&(T-=Math.pow(2,8*h)),T},a.prototype.readInt8=function(c,h){return c=c>>>0,h||B(c,1,this.length),this[c]&128?(255-this[c]+1)*-1:this[c]},a.prototype.readInt16LE=function(c,h){c=c>>>0,h||B(c,2,this.length);const g=this[c]|this[c+1]<<8;return g&32768?g|4294901760:g},a.prototype.readInt16BE=function(c,h){c=c>>>0,h||B(c,2,this.length);const g=this[c+1]|this[c]<<8;return g&32768?g|4294901760:g},a.prototype.readInt32LE=function(c,h){return c=c>>>0,h||B(c,4,this.length),this[c]|this[c+1]<<8|this[c+2]<<16|this[c+3]<<24},a.prototype.readInt32BE=function(c,h){return c=c>>>0,h||B(c,4,this.length),this[c]<<24|this[c+1]<<16|this[c+2]<<8|this[c+3]},a.prototype.readBigInt64LE=mt(function(c){c=c>>>0,Y(c,"offset");const h=this[c],g=this[c+7];(h===void 0||g===void 0)&&he(c,this.length-8);const b=this[c+4]+this[c+5]*2**8+this[c+6]*2**16+(g<<24);return(BigInt(b)<<BigInt(32))+BigInt(h+this[++c]*2**8+this[++c]*2**16+this[++c]*2**24)}),a.prototype.readBigInt64BE=mt(function(c){c=c>>>0,Y(c,"offset");const h=this[c],g=this[c+7];(h===void 0||g===void 0)&&he(c,this.length-8);const b=(h<<24)+this[++c]*2**16+this[++c]*2**8+this[++c];return(BigInt(b)<<BigInt(32))+BigInt(this[++c]*2**24+this[++c]*2**16+this[++c]*2**8+g)}),a.prototype.readFloatLE=function(c,h){return c=c>>>0,h||B(c,4,this.length),t.read(this,c,!0,23,4)},a.prototype.readFloatBE=function(c,h){return c=c>>>0,h||B(c,4,this.length),t.read(this,c,!1,23,4)},a.prototype.readDoubleLE=function(c,h){return c=c>>>0,h||B(c,8,this.length),t.read(this,c,!0,52,8)},a.prototype.readDoubleBE=function(c,h){return c=c>>>0,h||B(c,8,this.length),t.read(this,c,!1,52,8)};function K(f,c,h,g,b,C){if(!a.isBuffer(f))throw new TypeError('"buffer" argument must be a Buffer instance');if(c>b||c<C)throw new RangeError('"value" argument is out of bounds');if(h+g>f.length)throw new RangeError("Index out of range")}a.prototype.writeUintLE=a.prototype.writeUIntLE=function(c,h,g,b){if(c=+c,h=h>>>0,g=g>>>0,!b){const q=Math.pow(2,8*g)-1;K(this,c,h,g,q,0)}let C=1,T=0;for(this[h]=c&255;++T<g&&(C*=256);)this[h+T]=c/C&255;return h+g},a.prototype.writeUintBE=a.prototype.writeUIntBE=function(c,h,g,b){if(c=+c,h=h>>>0,g=g>>>0,!b){const q=Math.pow(2,8*g)-1;K(this,c,h,g,q,0)}let C=g-1,T=1;for(this[h+C]=c&255;--C>=0&&(T*=256);)this[h+C]=c/T&255;return h+g},a.prototype.writeUint8=a.prototype.writeUInt8=function(c,h,g){return c=+c,h=h>>>0,g||K(this,c,h,1,255,0),this[h]=c&255,h+1},a.prototype.writeUint16LE=a.prototype.writeUInt16LE=function(c,h,g){return c=+c,h=h>>>0,g||K(this,c,h,2,65535,0),this[h]=c&255,this[h+1]=c>>>8,h+2},a.prototype.writeUint16BE=a.prototype.writeUInt16BE=function(c,h,g){return c=+c,h=h>>>0,g||K(this,c,h,2,65535,0),this[h]=c>>>8,this[h+1]=c&255,h+2},a.prototype.writeUint32LE=a.prototype.writeUInt32LE=function(c,h,g){return c=+c,h=h>>>0,g||K(this,c,h,4,4294967295,0),this[h+3]=c>>>24,this[h+2]=c>>>16,this[h+1]=c>>>8,this[h]=c&255,h+4},a.prototype.writeUint32BE=a.prototype.writeUInt32BE=function(c,h,g){return c=+c,h=h>>>0,g||K(this,c,h,4,4294967295,0),this[h]=c>>>24,this[h+1]=c>>>16,this[h+2]=c>>>8,this[h+3]=c&255,h+4};function Pe(f,c,h,g,b){Qe(c,g,b,f,h,7);let C=Number(c&BigInt(4294967295));f[h++]=C,C=C>>8,f[h++]=C,C=C>>8,f[h++]=C,C=C>>8,f[h++]=C;let T=Number(c>>BigInt(32)&BigInt(4294967295));return f[h++]=T,T=T>>8,f[h++]=T,T=T>>8,f[h++]=T,T=T>>8,f[h++]=T,h}function Ve(f,c,h,g,b){Qe(c,g,b,f,h,7);let C=Number(c&BigInt(4294967295));f[h+7]=C,C=C>>8,f[h+6]=C,C=C>>8,f[h+5]=C,C=C>>8,f[h+4]=C;let T=Number(c>>BigInt(32)&BigInt(4294967295));return f[h+3]=T,T=T>>8,f[h+2]=T,T=T>>8,f[h+1]=T,T=T>>8,f[h]=T,h+8}a.prototype.writeBigUInt64LE=mt(function(c,h=0){return Pe(this,c,h,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeBigUInt64BE=mt(function(c,h=0){return Ve(this,c,h,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeIntLE=function(c,h,g,b){if(c=+c,h=h>>>0,!b){const re=Math.pow(2,8*g-1);K(this,c,h,g,re-1,-re)}let C=0,T=1,q=0;for(this[h]=c&255;++C<g&&(T*=256);)c<0&&q===0&&this[h+C-1]!==0&&(q=1),this[h+C]=(c/T>>0)-q&255;return h+g},a.prototype.writeIntBE=function(c,h,g,b){if(c=+c,h=h>>>0,!b){const re=Math.pow(2,8*g-1);K(this,c,h,g,re-1,-re)}let C=g-1,T=1,q=0;for(this[h+C]=c&255;--C>=0&&(T*=256);)c<0&&q===0&&this[h+C+1]!==0&&(q=1),this[h+C]=(c/T>>0)-q&255;return h+g},a.prototype.writeInt8=function(c,h,g){return c=+c,h=h>>>0,g||K(this,c,h,1,127,-128),c<0&&(c=255+c+1),this[h]=c&255,h+1},a.prototype.writeInt16LE=function(c,h,g){return c=+c,h=h>>>0,g||K(this,c,h,2,32767,-32768),this[h]=c&255,this[h+1]=c>>>8,h+2},a.prototype.writeInt16BE=function(c,h,g){return c=+c,h=h>>>0,g||K(this,c,h,2,32767,-32768),this[h]=c>>>8,this[h+1]=c&255,h+2},a.prototype.writeInt32LE=function(c,h,g){return c=+c,h=h>>>0,g||K(this,c,h,4,2147483647,-2147483648),this[h]=c&255,this[h+1]=c>>>8,this[h+2]=c>>>16,this[h+3]=c>>>24,h+4},a.prototype.writeInt32BE=function(c,h,g){return c=+c,h=h>>>0,g||K(this,c,h,4,2147483647,-2147483648),c<0&&(c=4294967295+c+1),this[h]=c>>>24,this[h+1]=c>>>16,this[h+2]=c>>>8,this[h+3]=c&255,h+4},a.prototype.writeBigInt64LE=mt(function(c,h=0){return Pe(this,c,h,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),a.prototype.writeBigInt64BE=mt(function(c,h=0){return Ve(this,c,h,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function Je(f,c,h,g,b,C){if(h+g>f.length)throw new RangeError("Index out of range");if(h<0)throw new RangeError("Index out of range")}function F(f,c,h,g,b){return c=+c,h=h>>>0,b||Je(f,c,h,4),t.write(f,c,h,g,23,4),h+4}a.prototype.writeFloatLE=function(c,h,g){return F(this,c,h,!0,g)},a.prototype.writeFloatBE=function(c,h,g){return F(this,c,h,!1,g)};function I(f,c,h,g,b){return c=+c,h=h>>>0,b||Je(f,c,h,8),t.write(f,c,h,g,52,8),h+8}a.prototype.writeDoubleLE=function(c,h,g){return I(this,c,h,!0,g)},a.prototype.writeDoubleBE=function(c,h,g){return I(this,c,h,!1,g)},a.prototype.copy=function(c,h,g,b){if(!a.isBuffer(c))throw new TypeError("argument should be a Buffer");if(g||(g=0),!b&&b!==0&&(b=this.length),h>=c.length&&(h=c.length),h||(h=0),b>0&&b<g&&(b=g),b===g||c.length===0||this.length===0)return 0;if(h<0)throw new RangeError("targetStart out of bounds");if(g<0||g>=this.length)throw new RangeError("Index out of range");if(b<0)throw new RangeError("sourceEnd out of bounds");b>this.length&&(b=this.length),c.length-h<b-g&&(b=c.length-h+g);const C=b-g;return this===c&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(h,g,b):Uint8Array.prototype.set.call(c,this.subarray(g,b),h),C},a.prototype.fill=function(c,h,g,b){if(typeof c=="string"){if(typeof h=="string"?(b=h,h=0,g=this.length):typeof g=="string"&&(b=g,g=this.length),b!==void 0&&typeof b!="string")throw new TypeError("encoding must be a string");if(typeof b=="string"&&!a.isEncoding(b))throw new TypeError("Unknown encoding: "+b);if(c.length===1){const T=c.charCodeAt(0);(b==="utf8"&&T<128||b==="latin1")&&(c=T)}}else typeof c=="number"?c=c&255:typeof c=="boolean"&&(c=Number(c));if(h<0||this.length<h||this.length<g)throw new RangeError("Out of range index");if(g<=h)return this;h=h>>>0,g=g===void 0?this.length:g>>>0,c||(c=0);let C;if(typeof c=="number")for(C=h;C<g;++C)this[C]=c;else{const T=a.isBuffer(c)?c:a.from(c,b),q=T.length;if(q===0)throw new TypeError('The value "'+c+'" is invalid for argument "value"');for(C=0;C<g-h;++C)this[C+h]=T[C%q]}return this};const j={};function te(f,c,h){j[f]=class extends h{constructor(){super(),Object.defineProperty(this,"message",{value:c.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${f}]`,this.stack,delete this.name}get code(){return f}set code(b){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:b,writable:!0})}toString(){return`${this.name} [${f}]: ${this.message}`}}}te("ERR_BUFFER_OUT_OF_BOUNDS",function(f){return f?`${f} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),te("ERR_INVALID_ARG_TYPE",function(f,c){return`The "${f}" argument must be of type number. Received type ${typeof c}`},TypeError),te("ERR_OUT_OF_RANGE",function(f,c,h){let g=`The value of "${f}" is out of range.`,b=h;return Number.isInteger(h)&&Math.abs(h)>2**32?b=ve(String(h)):typeof h=="bigint"&&(b=String(h),(h>BigInt(2)**BigInt(32)||h<-(BigInt(2)**BigInt(32)))&&(b=ve(b)),b+="n"),g+=` It must be ${c}. Received ${b}`,g},RangeError);function ve(f){let c="",h=f.length;const g=f[0]==="-"?1:0;for(;h>=g+4;h-=3)c=`_${f.slice(h-3,h)}${c}`;return`${f.slice(0,h)}${c}`}function me(f,c,h){Y(c,"offset"),(f[c]===void 0||f[c+h]===void 0)&&he(c,f.length-(h+1))}function Qe(f,c,h,g,b,C){if(f>h||f<c){const T=typeof c=="bigint"?"n":"";let q;throw c===0||c===BigInt(0)?q=`>= 0${T} and < 2${T} ** ${(C+1)*8}${T}`:q=`>= -(2${T} ** ${(C+1)*8-1}${T}) and < 2 ** ${(C+1)*8-1}${T}`,new j.ERR_OUT_OF_RANGE("value",q,f)}me(g,b,C)}function Y(f,c){if(typeof f!="number")throw new j.ERR_INVALID_ARG_TYPE(c,"number",f)}function he(f,c,h){throw Math.floor(f)!==f?(Y(f,h),new j.ERR_OUT_OF_RANGE("offset","an integer",f)):c<0?new j.ERR_BUFFER_OUT_OF_BOUNDS:new j.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${c}`,f)}const Xe=/[^+/0-9A-Za-z-_]/g;function be(f){if(f=f.split("=")[0],f=f.trim().replace(Xe,""),f.length<2)return"";for(;f.length%4!==0;)f=f+"=";return f}function ft(f,c){c=c||1/0;let h;const g=f.length;let b=null;const C=[];for(let T=0;T<g;++T){if(h=f.charCodeAt(T),h>55295&&h<57344){if(!b){if(h>56319){(c-=3)>-1&&C.push(239,191,189);continue}else if(T+1===g){(c-=3)>-1&&C.push(239,191,189);continue}b=h;continue}if(h<56320){(c-=3)>-1&&C.push(239,191,189),b=h;continue}h=(b-55296<<10|h-56320)+65536}else b&&(c-=3)>-1&&C.push(239,191,189);if(b=null,h<128){if((c-=1)<0)break;C.push(h)}else if(h<2048){if((c-=2)<0)break;C.push(h>>6|192,h&63|128)}else if(h<65536){if((c-=3)<0)break;C.push(h>>12|224,h>>6&63|128,h&63|128)}else if(h<1114112){if((c-=4)<0)break;C.push(h>>18|240,h>>12&63|128,h>>6&63|128,h&63|128)}else throw new Error("Invalid code point")}return C}function V(f){const c=[];for(let h=0;h<f.length;++h)c.push(f.charCodeAt(h)&255);return c}function Dt(f,c){let h,g,b;const C=[];for(let T=0;T<f.length&&!((c-=2)<0);++T)h=f.charCodeAt(T),g=h>>8,b=h%256,C.push(b),C.push(g);return C}function Ut(f){return e.toByteArray(be(f))}function pt(f,c,h,g){let b;for(b=0;b<g&&!(b+h>=c.length||b>=f.length);++b)c[b+h]=f[b];return b}function et(f,c){return f instanceof c||f!=null&&f.constructor!=null&&f.constructor.name!=null&&f.constructor.name===c.name}function oi(f){return f!==f}const Na=function(){const f="0123456789abcdef",c=new Array(256);for(let h=0;h<16;++h){const g=h*16;for(let b=0;b<16;++b)c[g+b]=f[h]+f[b]}return c}();function mt(f){return typeof BigInt>"u"?_a:f}function _a(){throw new Error("BigInt not supported")}})(Xi);function Yp(i){if(typeof i!="string")throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!i)throw new Error("No input");const e=JSON.parse(i),t=e;let n;if(t.type==="system")if(t.event==="connected")n=Object.assign(Object.assign({},e),{kind:"connected"});else if(t.event==="disconnected")n=Object.assign(Object.assign({},e),{kind:"disconnected"});else return null;else if(t.type==="message")if(t.from==="group"){const s=Lr(e.data,e.dataType);if(s===null)return null;n=Object.assign(Object.assign({},e),{data:s,kind:"groupData"})}else if(t.from==="server"){const s=Lr(e.data,e.dataType);if(s===null)return null;n=Object.assign(Object.assign({},e),{data:s,kind:"serverData"})}else return null;else if(t.type==="ack")n=Object.assign(Object.assign({},e),{kind:"ack"});else return null;return n}function Zp(i){let e;switch(i.kind){case"joinGroup":{e={type:"joinGroup",group:i.group,ackId:i.ackId};break}case"leaveGroup":{e={type:"leaveGroup",group:i.group,ackId:i.ackId};break}case"sendEvent":{e={type:"event",event:i.event,ackId:i.ackId,dataType:i.dataType,data:jr(i.data,i.dataType)};break}case"sendToGroup":{e={type:"sendToGroup",group:i.group,ackId:i.ackId,dataType:i.dataType,data:jr(i.data,i.dataType),noEcho:i.noEcho};break}case"sequenceAck":{e={type:"sequenceAck",sequenceId:i.sequenceId};break}default:throw new Error(`Unsupported type: ${i.kind}`)}return JSON.stringify(e)}function jr(i,e){switch(e){case"text":{if(typeof i!="string")throw new TypeError("Message must be a string.");return i}case"json":return i;case"binary":case"protobuf":{if(i instanceof ArrayBuffer)return Xi.Buffer.from(i).toString("base64");throw new TypeError("Message must be a ArrayBuffer")}}}function Lr(i,e){if(e==="text"){if(typeof i!="string")throw new TypeError("Message must be a string when dataType is text");return i}else{if(e==="json")return i;if(e==="binary"||e==="protobuf"){const t=Xi.Buffer.from(i,"base64");return t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}else return null}}class Qp{constructor(){this.isReliableSubProtocol=!0,this.name="json.reliable.webpubsub.azure.v1"}parseMessages(e){return Yp(e)}writeMessage(e){return Zp(e)}}const Xp=()=>new Qp;var Be;(function(i){i.Stopped="Stopped",i.Disconnected="Disconnected",i.Connecting="Connecting",i.Connected="Connected",i.Recovering="Recovering"})(Be||(Be={}));class em{nextAckId(){return this._ackId=this._ackId+1,this._ackId}constructor(e,t){this._quickSequenceAckDiff=300,this._activeTimeoutInMs=2e4,this._emitter=new fc,this._isStopping=!1,this._isInitialConnected=!1,typeof e=="string"?this._credential={getClientAccessUrl:e}:this._credential=e,t==null&&(t={}),this._buildDefaultOptions(t),this._options=t,this._messageRetryPolicy=new zr(this._options.messageRetryOptions),this._reconnectRetryPolicy=new zr(this._options.reconnectRetryOptions),this._protocol=this._options.protocol,this._groupMap=new Map,this._ackMap=new Map,this._sequenceId=new im,this._state=Be.Stopped,this._ackId=0}async start(e){if(this._isStopping)throw new Error("Can't start a client during stopping");if(this._state!==Be.Stopped)throw new Error("Client can be only started when it's Stopped");let t;e&&(t=e.abortSignal),this._activeKeepaliveTask||(this._activeKeepaliveTask=this._getActiveKeepaliveTask());try{await this._startCore(t)}catch(n){throw this._changeState(Be.Stopped),this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0),this._isStopping=!1,n}}async _startFromRestarting(e){if(this._state!==Be.Disconnected)throw new Error("Client can be only restarted when it's Disconnected");try{we.verbose("Staring reconnecting."),await this._startCore(e)}catch(t){throw this._changeState(Be.Disconnected),t}}async _startCore(e){if(this._changeState(Be.Connecting),we.info("Staring a new connection"),this._sequenceId.reset(),this._isInitialConnected=!1,this._lastCloseEvent=void 0,this._lastDisconnectedMessage=void 0,this._connectionId=void 0,this._reconnectionToken=void 0,this._uri=void 0,typeof this._credential.getClientAccessUrl=="string"?this._uri=this._credential.getClientAccessUrl:this._uri=await this._credential.getClientAccessUrl({abortSignal:e}),typeof this._uri!="string")throw new Error(`The clientAccessUrl must be a string but currently it's ${typeof this._uri}`);await this._connectCore(this._uri)}stop(){this._state===Be.Stopped||this._isStopping||(this._isStopping=!0,this._wsClient&&this._wsClient.isOpen()?this._wsClient.close():this._isStopping=!1,this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0))}on(e,t){this._emitter.on(e,t)}off(e,t){this._emitter.removeListener(e,t)}_emitEvent(e,t){this._emitter.emit(e,t)}async sendEvent(e,t,n,s){return await this._operationExecuteWithRetry(()=>this._sendEventAttempt(e,t,n,s),s==null?void 0:s.abortSignal)}async _sendEventAttempt(e,t,n,s){var r;if(!((r=s==null?void 0:s.fireAndForget)!==null&&r!==void 0?r:!1))return await this._sendMessageWithAckId(l=>({kind:"sendEvent",dataType:n,data:t,ackId:l,event:e}),s==null?void 0:s.ackId,s==null?void 0:s.abortSignal);const a={kind:"sendEvent",dataType:n,data:t,event:e};return await this._sendMessage(a,s==null?void 0:s.abortSignal),{isDuplicated:!1}}async joinGroup(e,t){return await this._operationExecuteWithRetry(()=>this._joinGroupAttempt(e,t),t==null?void 0:t.abortSignal)}async _joinGroupAttempt(e,t){const n=this._getOrAddGroup(e),s=await this._joinGroupCore(e,t);return n.isJoined=!0,s}async _joinGroupCore(e,t){return await this._sendMessageWithAckId(n=>({group:e,ackId:n,kind:"joinGroup"}),t==null?void 0:t.ackId,t==null?void 0:t.abortSignal)}async leaveGroup(e,t){return await this._operationExecuteWithRetry(()=>this._leaveGroupAttempt(e,t),t==null?void 0:t.abortSignal)}async _leaveGroupAttempt(e,t){const n=this._getOrAddGroup(e),s=await this._sendMessageWithAckId(r=>({group:e,ackId:r,kind:"leaveGroup"}),t==null?void 0:t.ackId,t==null?void 0:t.abortSignal);return n.isJoined=!1,s}async sendToGroup(e,t,n,s){return await this._operationExecuteWithRetry(()=>this._sendToGroupAttempt(e,t,n,s),s==null?void 0:s.abortSignal)}async _sendToGroupAttempt(e,t,n,s){var r,o;const a=(r=s==null?void 0:s.fireAndForget)!==null&&r!==void 0?r:!1,l=(o=s==null?void 0:s.noEcho)!==null&&o!==void 0?o:!1;if(!a)return await this._sendMessageWithAckId(u=>({kind:"sendToGroup",group:e,dataType:n,data:t,ackId:u,noEcho:l}),s==null?void 0:s.ackId,s==null?void 0:s.abortSignal);const d={kind:"sendToGroup",group:e,dataType:n,data:t,noEcho:l};return await this._sendMessage(d,s==null?void 0:s.abortSignal),{isDuplicated:!1}}_getWebSocketClientFactory(){return new pc}async _trySendSequenceAck(){if(!this._protocol.isReliableSubProtocol)return;const[e,t]=this._sequenceId.tryGetSequenceId();if(e&&t){const n={kind:"sequenceAck",sequenceId:t};try{await this._sendMessage(n)}catch{this._sequenceId.tryUpdate(t)}}}_connectCore(e){if(this._isStopping)throw new Error("Can't start a client during stopping");return new Promise((t,n)=>{const s=this._wsClient=this._getWebSocketClientFactory().create(e,this._protocol.name);s.onopen(()=>{if(this._isStopping){try{s.close()}catch{}n(new Error("The client is stopped"))}we.verbose("WebSocket connection has opened"),this._changeState(Be.Connected),this._protocol.isReliableSubProtocol&&(this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),this._sequenceAckTask=new Vr(async()=>{await this._trySendSequenceAck()},1e3)),t()}),s.onerror(r=>{this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),n(r)}),s.onclose((r,o)=>{this._state===Be.Connected?(we.verbose("WebSocket closed after open"),this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),we.info(`WebSocket connection closed. Code: ${r}, Reason: ${o}`),this._lastCloseEvent={code:r,reason:o},this._handleConnectionClose.call(this)):(we.verbose("WebSocket closed before open"),n(new Error(`Failed to start WebSocket: ${r}`)))}),s.onmessage(r=>{const o=p=>{if(this._ackMap.has(p.ackId)){const k=this._ackMap.get(p.ackId);this._ackMap.delete(p.ackId);const y=p.error!=null&&p.error.name==="Duplicate";p.success||y?k.resolve({ackId:p.ackId,isDuplicated:y}):k.reject(new Nn("Failed to send message.",{ackId:p.ackId,errorDetail:p.error}))}},a=async p=>{if(this._connectionId=p.connectionId,this._reconnectionToken=p.reconnectionToken,!this._isInitialConnected){if(this._isInitialConnected=!0,this._options.autoRejoinGroups){const k=[];this._groupMap.forEach(y=>{y.isJoined&&k.push((async()=>{try{await this._joinGroupCore(y.name)}catch(S){this._safeEmitRejoinGroupFailed(y.name,S)}})())});try{await Promise.all(k)}catch{}}this._safeEmitConnected(p.connectionId,p.userId)}},l=p=>{this._lastDisconnectedMessage=p},d=p=>{if(p.sequenceId!=null){const k=this._sequenceId.tryUpdate(p.sequenceId);if(k===0)return;k>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitGroupMessage(p)},u=p=>{if(p.sequenceId!=null){const k=this._sequenceId.tryUpdate(p.sequenceId);if(k===0)return;k>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitServerMessage(p)};let m;try{let p;if(Array.isArray(r)?p=Buffer.concat(r):p=r,m=this._protocol.parseMessages(p),m===null)return}catch(p){throw we.warning("An error occurred while parsing the message from service",p),p}Array.isArray(m)||(m=[m]),m.forEach(p=>{try{switch(p.kind){case"ack":{o(p);break}case"connected":{a(p);break}case"disconnected":{l(p);break}case"groupData":{d(p);break}case"serverData":{u(p);break}}}catch(k){we.warning(`An error occurred while handling the message with kind: ${p.kind} from service`,k)}})})})}async _handleConnectionCloseAndNoRecovery(){this._state=Be.Disconnected,this._safeEmitDisconnected(this._connectionId,this._lastDisconnectedMessage),this._options.autoReconnect?await this._autoReconnect():await this._handleConnectionStopped()}async _autoReconnect(){let e=!1,t=0;try{for(;!this._isStopping;)try{await this._startFromRestarting(),e=!0;break}catch(n){we.warning("An attempt to reconnect connection failed.",n),t++;const s=this._reconnectRetryPolicy.nextRetryDelayInMs(t);if(s==null)break;try{we.verbose(`Delay time for reconnect attempt ${t}: ${s}`),await Bn(s)}catch{}}}finally{e||this._handleConnectionStopped()}}_handleConnectionStopped(){this._isStopping=!1,this._state=Be.Stopped,this._safeEmitStopped()}_getActiveKeepaliveTask(){return new Vr(async()=>{this._sequenceId.tryUpdate(0)},this._activeTimeoutInMs)}async _sendMessage(e,t){if(!this._wsClient||!this._wsClient.isOpen())throw new Error("The connection is not connected.");const n=this._protocol.writeMessage(e);await this._wsClient.send(n,t)}async _sendMessageWithAckId(e,t,n){t==null&&(t=this.nextAckId());const s=e(t);this._ackMap.has(t)||this._ackMap.set(t,new nm(t));const r=this._ackMap.get(t);try{await this._sendMessage(s,n)}catch(o){this._ackMap.delete(t);let a="";throw o instanceof Error&&(a=o.message),new Nn(a,{ackId:t})}if(n)try{return await mc(r.promise(),n)}catch(o){throw o instanceof Error&&o.name==="AbortError"?new Nn("Cancelled by abortSignal",{ackId:t}):o}return await r.promise()}async _handleConnectionClose(){if(this._ackMap.forEach((s,r)=>{this._ackMap.delete(r)&&s.reject(new Nn("Connection is disconnected before receive ack from the service",{ackId:s.ackId}))}),this._isStopping){we.warning("The client is stopping state. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(this._lastCloseEvent&&this._lastCloseEvent.code===1008){we.warning("The websocket close with status code 1008. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(!this._protocol.isReliableSubProtocol){we.warning("The protocol is not reliable, recovery is not applicable"),this._handleConnectionCloseAndNoRecovery();return}const e=this._buildRecoveryUri();if(!e){we.warning("Connection id or reconnection token is not available"),this._handleConnectionCloseAndNoRecovery();return}let t=!1;this._state=Be.Recovering;const n=Zr.timeout(30*1e3);try{for(;!n.aborted||this._isStopping;)try{await this._connectCore.call(this,e),t=!0;return}catch{await Bn(1e3)}}finally{t||(we.warning("Recovery attempts failed more then 30 seconds or the client is stopping"),this._handleConnectionCloseAndNoRecovery())}}_safeEmitConnected(e,t){this._emitEvent("connected",{connectionId:e,userId:t})}_safeEmitDisconnected(e,t){this._emitEvent("disconnected",{connectionId:e,message:t})}_safeEmitGroupMessage(e){this._emitEvent("group-message",{message:e})}_safeEmitServerMessage(e){this._emitEvent("server-message",{message:e})}_safeEmitStopped(){this._emitEvent("stopped",{})}_safeEmitRejoinGroupFailed(e,t){this._emitEvent("rejoin-group-failed",{group:e,error:t})}_buildDefaultOptions(e){return e.autoReconnect==null&&(e.autoReconnect=!0),e.autoRejoinGroups==null&&(e.autoRejoinGroups=!0),e.protocol==null&&(e.protocol=Xp()),this._buildMessageRetryOptions(e),this._buildReconnectRetryOptions(e),e}_buildMessageRetryOptions(e){e.messageRetryOptions||(e.messageRetryOptions={}),(e.messageRetryOptions.maxRetries==null||e.messageRetryOptions.maxRetries<0)&&(e.messageRetryOptions.maxRetries=3),(e.messageRetryOptions.retryDelayInMs==null||e.messageRetryOptions.retryDelayInMs<0)&&(e.messageRetryOptions.retryDelayInMs=1e3),(e.messageRetryOptions.maxRetryDelayInMs==null||e.messageRetryOptions.maxRetryDelayInMs<0)&&(e.messageRetryOptions.maxRetryDelayInMs=3e4),e.messageRetryOptions.mode==null&&(e.messageRetryOptions.mode="Fixed")}_buildReconnectRetryOptions(e){e.reconnectRetryOptions||(e.reconnectRetryOptions={}),(e.reconnectRetryOptions.maxRetries==null||e.reconnectRetryOptions.maxRetries<0)&&(e.reconnectRetryOptions.maxRetries=Number.MAX_VALUE),(e.reconnectRetryOptions.retryDelayInMs==null||e.reconnectRetryOptions.retryDelayInMs<0)&&(e.reconnectRetryOptions.retryDelayInMs=1e3),(e.reconnectRetryOptions.maxRetryDelayInMs==null||e.reconnectRetryOptions.maxRetryDelayInMs<0)&&(e.reconnectRetryOptions.maxRetryDelayInMs=3e4),e.reconnectRetryOptions.mode==null&&(e.reconnectRetryOptions.mode="Fixed")}_buildRecoveryUri(){if(this._connectionId&&this._reconnectionToken&&this._uri){const e=new URL(this._uri);return e.searchParams.append("awps_connection_id",this._connectionId),e.searchParams.append("awps_reconnection_token",this._reconnectionToken),e.toString()}return null}_getOrAddGroup(e){return this._groupMap.has(e)||this._groupMap.set(e,new tm(e)),this._groupMap.get(e)}_changeState(e){we.verbose(`The client state transfer from ${this._state.toString()} to ${e.toString()}`),this._state=e}async _operationExecuteWithRetry(e,t){let n=0;for(;;)try{return await e.call(this)}catch(s){n++;const r=this._messageRetryPolicy.nextRetryDelayInMs(n);if(r==null||(await Bn(r),t!=null&&t.aborted))throw s}}}class zr{constructor(e){this._retryOptions=e,this._maxRetriesToGetMaxDelay=Math.ceil(Math.log2(this._retryOptions.maxRetryDelayInMs)-Math.log2(this._retryOptions.retryDelayInMs)+1)}nextRetryDelayInMs(e){return e>this._retryOptions.maxRetries?null:this._retryOptions.mode==="Fixed"?this._retryOptions.retryDelayInMs:this._calculateExponentialDelay(e)}_calculateExponentialDelay(e){return e>=this._maxRetriesToGetMaxDelay?this._retryOptions.maxRetryDelayInMs:(1<<e-1)*this._retryOptions.retryDelayInMs}}class tm{constructor(e){this.isJoined=!1,this.name=e}}class nm{constructor(e){this._promise=new Promise((t,n)=>{this._resolve=t,this._reject=n}),this.ackId=e}promise(){return this._promise}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}class im{constructor(){this._sequenceId=0,this._isUpdate=!1}tryUpdate(e){if(this._isUpdate=!0,e>this._sequenceId){const t=e-this._sequenceId;return this._sequenceId=e,t}return 0}tryGetSequenceId(){return this._isUpdate?(this._isUpdate=!1,[!0,this._sequenceId]):[!1,null]}reset(){this._sequenceId=0,this._isUpdate=!1}}class Vr{constructor(e,t,n){this._func=e,this._abortController=new Zr,this._interval=t,this._obj=n,this._start()}abort(){try{this._abortController.abort()}catch{}}async _start(){const e=this._abortController.signal;for(;!e.aborted;)try{await this._func(this._obj)}catch{}finally{await Bn(this._interval)}}}const sm=1e3*60*60,rm=1e3*30;class om{constructor(e,t,n,s=null,r=new Map){$(this,"client");$(this,"handler");$(this,"terminationTimeout",null);$(this,"connectionUrl");$(this,"expiresAt");$(this,"connected",!1);$(this,"websocketRequestId",null);$(this,"conversationId",null);$(this,"secondaryTypeBasedHandlers",new Map);this.connectionUrl=t,this.expiresAt=n,this.client=new em({getClientAccessUrl:()=>e(this.connectionUrl,this.expiresAt)},{autoReconnect:!0,reconnectRetryOptions:{maxRetries:5,retryDelayInMs:100,maxRetryDelayInMs:1e4,mode:"Exponential"}}),this.handler=s,this.secondaryTypeBasedHandlers=r}async start(){const e=t=>{if(this.secondaryTypeBasedHandlers.has(t.message.data.type)){const n=this.secondaryTypeBasedHandlers.get(t.message.data.type);if(!n)return;n(t.message.data)}else{const n=t.message.data.body,s=atob(n).trim();if(s.startsWith("data: ")){const r=s.replace("data: ",""),o=this.handler;if(!o)return;o({conversationId:t.message.data.conversation_id,responseId:t.message.data.response_id,message:{id:"",event:"",data:r},websocketRequestId:t.message.data.websocket_request_id})}}};this.client.on("group-message",t=>e(t)),this.client.on("server-message",t=>e(t)),this.client.on("connected",()=>{this.connected=!0}),this.client.on("disconnected",()=>{this.connected=!1}),await this.client.start()}addSecondaryTypeHandler(e,t){this.secondaryTypeBasedHandlers.set(e,t)}isConnected(){return this.connected}async stop(e){e&&this.conversationId!==e||this.websocketRequestId&&await ut.stopWebsocketConversation(this.websocketRequestId)}setHandler(e,t,n,s){!this.handler&&this.websocketRequestId===n||(this.handler!=null&&this.websocketRequestId!==n&&(Hc.warn("[websockets] Overwriting existing handler without silencing. This may indicate a race condition."),Ke.logEvent(Ne.asyncHandlerOverwritten,{originalWebsocketRequestId:this.websocketRequestId,newWebsocketRequestId:n,conversationId:e,responseId:t})),this.websocketRequestId=n,this.conversationId=e,this.handler=r=>{(r.websocketRequestId===n||r.conversationId===e&&r.responseId===t)&&s(r.message)})}silence(){this.handler=null}close(){this.client.stop()}scheduleForTermination(e){this.terminationTimeout=setTimeout(()=>{this.close(),e()},sm)}preventTermination(){this.terminationTimeout&&(clearTimeout(this.terminationTimeout),this.terminationTimeout=null)}updateConnectionUrl(e,t){this.connectionUrl=e,this.expiresAt=t}}class am{constructor(){$(this,"activeSocketMap",new Map);$(this,"secondaryTypeBasedHandlers",new Map)}async register(){const e=await ut.postRegisterWebsocket();e.wss_url&&(this.getOrCreateSocket(e.wss_url,new Date(e.expires_at),!0),e.fallback_wss_url&&this.getOrCreateSocket(e.fallback_wss_url,new Date(e.expires_at),!1))}async registerIfNotConnected(){if(this.activeSocketMap.size===0){await this.register();return}for(const e of this.activeSocketMap.values())if(!e.isConnected()){await this.register();return}}isWebsocketConnected(){for(const e of this.activeSocketMap.values())if(e.isConnected())return!0;return this.activeSocketMap.size>0&&_e.addError("Cannot connect to any websocket."),!1}async getOrCreateSocket(e,t,n){const s=e.split("?")[0];let r;const o=this.activeSocketMap.get(s);if(o&&o.isConnected())o.preventTermination(),o.updateConnectionUrl(e,t),r=o;else{o&&o.close(),r=new om(async(a,l)=>{if(new Date<new Date(l.getTime()-5*1e3))return a;const d=await ut.postRegisterWebsocket();return n?d.wss_url:d.fallback_wss_url??""},e,t,null,this.secondaryTypeBasedHandlers),this.activeSocketMap.set(s,r);try{await r.start()}catch(a){throw _e.addError(new Error("Error occurred while starting websocket: ",{cause:a})),a}}return r}preSetupWebsocket(e,t,n){for(const s of this.activeSocketMap.values())this.setupWebSocketHandler(s,null,null,null,e,t,n)}addSecondaryTypeHandler(e,t){this.secondaryTypeBasedHandlers.set(e,t);for(const n of this.activeSocketMap.values())n.addSecondaryTypeHandler(e,t)}hasSecondaryTypeHandler(e){return this.secondaryTypeBasedHandlers.has(e)}async processWebSocketConversationStream(e,t,n,s,r,o,a,l,d){const u=[this.getOrCreateSocket(e,n,!0)];t&&u.push(this.getOrCreateSocket(t,n,!1));const m=await Promise.allSettled(u),p=m[0].status==="fulfilled"?m[0].value:null,k=m.length>1&&m[1].status==="fulfilled"?m[1].value:null;if((!p||!p.isConnected())&&_e.addError(`Cannot connect to primary websocket, websocketRequestId: ${o}, token: ${e.substring(0,e.indexOf("access_token="))}`),(!p||!p.isConnected())&&(!k||!k.isConnected()))throw t&&_e.addError(`Cannot connect to fallback websocket, websocketRequestId: ${o}, token: ${t.substring(0,t.indexOf("access_token="))}`),new gt(`An error occurred while connecting to the websocket. ${_i}`);let y=setTimeout(()=>{_e.addError(`WebSocket took too long to respond: ${r}, ${s}, ${o}, ${e.substring(0,60)}...${e.slice(-20)}`,{supportsWebSockets:"WebSocket"in window&&window.WebSocket.CLOSING===2})},rm);const S=w=>(d&&(clearTimeout(d),d=null),y&&(clearTimeout(y),y=null),a(w));p&&this.setupWebSocketHandler(p,e,s,r,o,S,l),k&&t&&this.setupWebSocketHandler(k,t,s,r,o,S,l)}async stopConversation(e){for(const t of this.activeSocketMap.values())await t.stop(e)}setupWebSocketHandler(e,t,n,s,r,o,a){e.setHandler(n,s,r,o),this.secondaryTypeBasedHandlers.forEach((d,u)=>{e.addSecondaryTypeHandler(u,d)});const l=()=>{t?e.scheduleForTermination(()=>{this.activeSocketMap.delete(t.split("?")[0])}):(this.stopConversation(n),e.silence())};a.addEventListener("abort",l)}}const ri=new am;function lm(i){return{webSocketUrl:i.wss_url,fallbackWebSocketUrl:i.fallback_wss_url,conversationId:i.conversation_id,responseId:i.response_id,expiresAt:i.expires_at&&new Date(i.expires_at),websocketRequestId:i.websocket_request_id}}async function cm(i,e,t){return ri.preSetupWebsocket(i,e,t)}async function dm(i,e,t,n,s,r,o,a,l){return ri.processWebSocketConversationStream(i,e,t,n,s,r,o,a,l)}const hm="OAI-Echo-Logs",Ht={FOCUS_IN:0,FOCUS_OUT:1,COPY:2,PASTE:3,TOUCH_START:4,TOUCH_END:5},Ia=[];function Jt(i){return()=>{Ia.push({type:i,ts:Math.round(performance.now())})}}const um={focusin:Jt(Ht.FOCUS_IN),focusout:Jt(Ht.FOCUS_OUT),copy:Jt(Ht.COPY),paste:Jt(Ht.PASTE),touchstart:Jt(Ht.TOUCH_START),touchend:Jt(Ht.TOUCH_END)};function sg(i){const e=i??document.getElementById(Pd);for(const[t,n]of Object.entries(um))e==null||e.removeEventListener(t,n),e==null||e.addEventListener(t,n)}function fm(){return{[hm]:Ia.slice(0,10).map(i=>`${i.type},${i.ts}`).join(",")}}const pm=1e3*30,Si=io.getTracer("completion"),Ci=i=>(i==null?void 0:i.code)==="challenge_required";class Ti extends Error{}function mm(i,e,t,n){const s=async(r=null,o=!1)=>{var pe,Ae,B,K,Pe,Ve,Je;gc()&&await yc();const a=new AbortController,l="threadId"in e?e.threadId:void 0,d="continueFromSharedConversationId"in e?e.continueFromSharedConversationId:void 0,u=Jc(),m=gn.checkGate("1987334402"),p=gn.checkGate("2964350589"),k=[m&&"v0",p&&"v0_test"].filter(Boolean),y={action:e.completionType,messages:e.messages.length>0?e.messages:void 0,conversation_id:l,continue_from_shared_conversation_id:l!=null?void 0:d,parent_message_id:e.parentMessageId,model:e.model,timezone_offset_min:new Date().getTimezoneOffset(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,variant_purpose:(pe=e.completionMetadata)==null?void 0:pe.variantPurpose,suggestions:(Ae=e.completionMetadata)!=null&&Ae.suggestions?e.completionMetadata.suggestions.map(F=>Fd(F)):void 0,history_and_training_disabled:e.historyDisabled,juice:(B=e.completionMetadata)==null?void 0:B.juice,conversation_mode:(K=e.completionMetadata)==null?void 0:K.conversationMode,force_paragen:e.forceParagen,force_paragen_model_slug:e.forceParagenModel,force_indepth_feedback:e.forceIndepthFeedback,force_rate_limit:e.forceRateLimit,reset_rate_limits:e.resetRateLimits,disable_system_content_toggling:e.disableSystemContentToggling,websocket_request_id:u,source:(Pe=e.completionMetadata)==null?void 0:Pe.source,system_hints:(Ve=e.completionMetadata)==null?void 0:Ve.systemHints,prefetch_ids:(Je=e.completionMetadata)==null?void 0:Je.prefetchIds,force_use_sse:!ri.isWebsocketConnected(),supported_encodings:k,conversation_origin:e.conversationOrigin,force_use_search:e.forceUseSearch,client_contextual_info:e.contextualInfo};let S,w;const E=$c(i);no(E)?(w="https://chatgpt.com/backend-anon",S=Is.getUnauthHeaders().additionalHeaders):(w="https://chatgpt.com/backend-api",S=Is.getAuthedHeadersWithAccessToken(E==null?void 0:E.accessToken));const _=`${w}/conversation`;let L=!0,U=!0;const M=Gc(e.chatReq,r??e.arkoseToken,e.turnstileToken,e.proofToken,null),A={...S,...fm(),...M};let H,z,O;Si.startActiveSpan("completion.response",F=>{H=Si.startSpan("completion.first_response"),z=Si.startSpan("completion.first_token"),O=F});const J=io.setSpan(Ns.active(),O);let ae=null,X=null,ue,le=!1;function ze(F){if(e.turnTracker.onBytesReceived(F.data),F.data==="[DONE]")a.abort(),O.end(),t({type:"done"}),Ss();else if(F.event!=="ping")try{let I=JSON.parse(F.data);if(F.event==="delta_encoding")if(I==="v1"||I==="v1_test")ae=I,X=new kc;else{_e.addError(`[completion-delta] unknown delta encoding: ${I}`);return}else if(F.event==="delta"){if(!X){_e.addError("[completion-delta] delta event before delta_encoding");return}const j=X.applyDelta(I);if(ae==="v1_test"){!le&&!Yc(j,ue)&&(le=!0,_e.addError("[completion-delta] delta resulted in a different object",{differences:bc(j,ue)}));return}else I=j}else ae==="v1_test"&&!le&&(ue=I);if(I.error){const j=new gt(I.error);throw t({type:"error",error:j}),j}else"type"in I?I.type==="gizmo_inline_review"?t({type:"gizmo_inline_review",gizmoId:I.gizmo_id}):I.type==="title_generation"?t({type:"title_generation",title:I.title,conversation_id:I.conversation_id}):I.type==="moderation"?t({type:"moderation",conversationId:I.conversation_id,messageId:I.message_id,isCompletion:I.is_completion,flagged:I.moderation_response.flagged,blocked:I.moderation_response.blocked,disclaimers:I.moderation_response.disclaimers,metadata:I.moderation_response.metadata}):I.type==="url_moderation"?t({type:"url_moderation",conversationId:I.conversation_id,messageId:I.message_id,url:I.url_moderation_result.full_url,isSafe:I.url_moderation_result.is_safe}):I.type==="num_variants_in_stream"?t({type:"num_variants_in_stream",num_variants_in_stream:I.num_variants_in_stream,display_treatment:I.display_treatment}):I.type==="conversation_detail_metadata"&&t(I):(t({type:"message",message:I.message,conversationId:I.conversation_id}),U&&(U=!1,H.end()),L&&I.message.author.role==="assistant"&&I.message.content.content_type==="text"&&I.message.content.parts[0]!==""&&(L=!1,z.end()))}catch(I){if(I instanceof ct)throw new gt(I.message)}}let xe=null,ke=setTimeout(()=>{xe===!0?(Ke.logEvent(Ne.asyncResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:Ln.Error,error:{reason:"timeout",message:"Async Response Took Too Long to Come Back"}})):xe===!1&&(Ke.logEvent(Ne.sseResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:Ln.Error,error:{reason:"timeout",message:"SSE Response Took Too Long to Come Back"}}))},pm);return cm(u,ze,a.signal),Ns.with(J,()=>{var F;return(F=e.profiler)==null||F.logTiming("fetch_event_source"),xc(_,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...A},body:JSON.stringify(y),signal:a.signal,openWhenHidden:!0,async onopen(I){var ve;const j=I.headers.get("content-type")??"",te=I.headers.get("Cf-Ray")??null;if(I.ok&&j.includes("text/event-stream")){xe=!1,n(te,e.model,e.turnTracker);return}else if(j.includes("application/json")){const me=await I.json(),{webSocketUrl:Qe,fallbackWebSocketUrl:Y,conversationId:he,responseId:Xe,expiresAt:be,websocketRequestId:ft}=lm(me);if(Qe!=null&&he!=null&&Xe!=null&&ft!=null&&be){xe=!0,n(te,e.model,e.turnTracker);try{await dm(Qe,Y,be,he,Xe,ft,ze,a.signal,ke)}catch(V){V instanceof gt&&t({type:"error",error:V})}throw new Ti}else{const V=(me==null?void 0:me.error)??(me==null?void 0:me.detail),Dt=(V==null?void 0:V.message)??V??"Unknown server error";if(V){if(Ci(V))throw new ct(Dt,I.status,V.code);if(I.status>=500)throw new gt(Dt);{if(((V==null?void 0:V.code)==="expired_session_key"||(V==null?void 0:V.code)==="invalid_api_key"||(V==null?void 0:V.code)==="token_expired")&&typeof window<"u"&&((ve=window._oaiHandleSessionExpired)==null||ve.call(window,"stream",JSON.stringify(V))),(V==null?void 0:V.code)==="deactivated_workspace"){window.location.href.includes("/workspace/deactivated")||(window.location.href="/workspace/deactivated");return}const Ut=V==null?void 0:V.can_retry;throw new ct(Dt,I.status,V==null?void 0:V.code,V==null?void 0:V.type,void 0,V==null?void 0:V.clears_in,Ut)}}else _e.addError("Missing completion error field",{json:me,serverRequestId:te})}}else _e.addError("Unexpected completion open message content type",{contentType:j,serverRequestId:te});throw new gt(_s)},onmessage:I=>{if(xe)throw new gt(_s);ke&&(clearTimeout(ke),ke=null),ze(I)},onerror(I){let j=I instanceof Error?I:new Error(JSON.stringify(I));throw j instanceof Ti||xe||Ci(j)&&!o||(j.message==="Failed to fetch"&&(j=new gt(`An error occurred. Either the engine you requested does not exist or there was another issue processing your request. ${_i}`)),j.message==="network error"&&(j=new ct(`A network error occurred. Please check your connection and try again. ${_i}`,400)),Kc("fetch-error:conversation:new-message",{url:_,message:j==null?void 0:j.message}),t({type:"error",error:j}),Ss(j)),j}})}).catch(async F=>{if(Ci(F)){if(o)throw new ct("Failed to complete your call, please try again",F.status);{const I=await Di.getEnforcementToken(e.chatReq);return s(I,!0)}}F instanceof Ti||(_e.addError(F),e.turnTracker.handleRawError(F.message??"Something went wrong",F.status))}),a};return s()}function rg({clientThreadId:i,continuingFromSharedConversationId:e,onCompletionFinished:t=Ii,onCreate:n=Ii}){const s=Zc(),{resolvedTheme:r}=Qn(),o=r==="dark",a=R.useRef(t),l=Qc();a.current=t;const d=R.useCallback(async function({model:u,completionType:m,parentNodeId:p,metadata:k,focusOnNewCompletion:y=!0,completionMetadata:S,chatReq:w,arkoseToken:E,turnstileToken:_,proofToken:L,preflightTime:U,extraStreamParams:M,appendMessages:A,updateTree:H,turnTracker:z,profiler:O}){var F,I,j,te,ve,me,Qe;Yr.publish({kind:"requestCompletion"});const J=v.getTree(i);v.retainThread(i);const ae=_d(),X=`${wc}${i}-${ae}`,ue=`${i}-${ae}`;H==null||H();const le=J.getNodeByIdOrMessageId(p),xe={gizmo_id:(F=le.message.metadata)==null?void 0:F.gizmo_id};(S==null?void 0:S.juice)!=null&&(xe.snorkle_status=1),v.updateTree(i,Y=>{Y.addNode(X,"",p,xt.Assistant,void 0,xe)}),y&&v.setThreadCurrentLeafId(i,X);let ke,Ie=[],pe=J.getNodeByIdOrMessageId(le.parentId);for(;pe!=null&&(((I=pe.metadata)==null?void 0:I.isPlaceholderTemplateAssistantWelcomeMessage)===!0||((j=pe.metadata)==null?void 0:j.isClientCreatedSystemMessage)===!0);){const Y=pe.message;Ie.unshift(Y);const he=J.getNodeByIdOrMessageId(pe.parentId);ke=((te=he.message)==null?void 0:te.id)??he.id,pe=he}if(m===dn.Next||m===dn.Variant){const Y=J.getNodeByIdOrMessageId(le.parentId);if(ke??(ke=((ve=Y.message)==null?void 0:ve.id)??Y.id),Ie.push(le.message),A){let he=p;v.updateTree(i,Xe=>{for(const be of A)Xe.insertNodeBefore(X,{id:be.id,message:be,parentId:he,children:[]}),he=be.id}),Ie.push(...A)}Ie=gm(Ie,M)}else ke??(ke=le.message.id);const Ae=v.getServerThreadId(i);Ae===void 0&&ss(i)&&v.updateInitialThreadDataForNewThread(i,u);async function B(Y,he){const Xe=performance.now(),be=await Xc();Di.initializeAndGatherData(be),Cs.initializeAndGatherData(be),Ds.initializeAndGatherData(be),v.updateTree(i,Ut=>{for(const pt of he)Ut.addNode(pt.id,pt,Y,xt.Assistant,{completionSampleFinishTime:Date.now()}),Y=pt.id}),v.setThreadCurrentLeafId(i,Y);const ft=await Di.getEnforcementToken(be),V=await Cs.getEnforcementToken(be),Dt=await Ds.getEnforcementToken(be);d({model:u,completionType:dn.Next,parentNodeId:Y,metadata:{},chatReq:be,arkoseToken:ft??null,turnstileToken:V??null,proofToken:Dt??null,preflightTime:performance.now()-Xe,extraStreamParams:M,turnTracker:z})}z.updateAttachmentCount(Ie);const K=new Kp(s,i,X,m,u,k.eventSource,n,ue,B,(...Y)=>a.current(...Y),z,l),Pe=(Y,he,Xe)=>{Y&&Xe.onReceivedRequestId(Y),Cc(ue,he,Y,U)},Ve={is_dark_mode:o,time_since_loaded:Math.floor(performance.now()/1e3),page_height:window==null?void 0:window.innerHeight,page_width:window==null?void 0:window.innerWidth,pixel_ratio:window==null?void 0:window.devicePixelRatio,screen_height:(me=window==null?void 0:window.screen)==null?void 0:me.height,screen_width:(Qe=window==null?void 0:window.screen)==null?void 0:Qe.width},Je=await mm(s,{conversationOrigin:v.getConversationOrigin(i),model:u,completionType:m,threadId:Ae,continueFromSharedConversationId:e,historyDisabled:l,parentMessageId:ke,messages:Ie,chatReq:w,arkoseToken:E??null,turnstileToken:_??null,proofToken:L??null,completionMetadata:S,...M,turnTracker:z,profiler:O,contextualInfo:Ve},K.handleResponse,Pe);Qi.addRequest(X,Je,z),$i.onCompletionRequestStarted(X)},[i,s,n,e,l,o]);return d}const gm=(i,e)=>{let t=i;return(e==null?void 0:e.forceUseSearch)===!1&&i.length>0&&(t=i.map(n=>{const{system_hints:s,...r}=n.metadata||{};return{...n,metadata:{...r,system_hints:s==null?void 0:s.filter(o=>o!==Sc.Search)}}})),t};function og(i,e,t,n){let s=Tc.getReadyFiles(i.getState());(n==null?void 0:n.kind)===qe.GizmoMagicCreate?s=s.filter(p=>p.gizmoId!=null):s=s.filter(p=>p.gizmoId==null);let r=e??"";const o=[],a=[],l=Ec(t,n),u=Mc(t,n).length>0,m=l===ci.Interpreter||l===ci.Retrieval||l===ci.ContextConnector;return s.forEach(({fileSpec:p})=>{if(m){const k=p.contextConnectorInfo;o.push({id:p.id,size:p.size,name:p.name,context_connector_info:k?{context_connector:k==null?void 0:k.contextConnector,source_url:k==null?void 0:k.sourceUrl,synthetic_extension:(k==null?void 0:k.syntheticExtension)??null,type:k==null?void 0:k.type}:void 0,mime_type:p.mimeType,width:"width"in p?p.width:void 0,height:"height"in p?p.height:void 0,file_token_size:p.fileTokenSize})}u&&"width"in p&&"height"in p&&a.push({content_type:ed.ImageAssetPointer,asset_pointer:Ic(p.id),size_bytes:p.size,width:p.width,height:p.height})}),a.length>0&&(a.push(e??""),r={content_type:Xn.MultimodalText,parts:a}),{content:r,attachments:o}}async function ag({clientThreadId:i,currentRequestId:e,queryClient:t,isHistoryAndTrainingDisabled:n}){var a;const s=v.getServerThreadId(i);ri.stopConversation(s);const r=v.getTree(i);!r.hasReceivedServerCompletion&&!n&&((a=r.getParent(e).metadata)==null?void 0:a.errCode)!==dt.ContentPolicy&&setTimeout(()=>{Gi.onCreateFinished(t,s,n)},500),s&&gn.checkGate("3922476776")&&await ut.stopConversationProcess(s),Qi.abortRequest(e)&&v.updateTree(i,l=>{const d=v.getThreadCurrentLeafId(i);l.updateNodeMessageMetadata(d,{finish_details:{type:"interrupted"}})})}function ym(i){return`https://chatgpt.com${Td(i)}`}function lg(i,e,t,n){Nc(ym(i),e,t),n&&e.info(n)}function cg(i){return i.some(e=>e.type===td.JIT_PLUGIN)}function xm(i){return"gizmo_id"in i?i.gizmo_id??null:null}const km=i=>["conversation","init",i],bm=({clientThreadId:i,conversationMode:e,clientModelId:t},n)=>{const s=xm(e),r=ss(i)?null:i;return{gcTime:0,refetchOnWindowFocus:!0,refetchOnMount:"always",queryKey:km(i),queryFn:()=>ut.getConversationDetails({conversationId:r,gizmoId:s,requestedDefaultModel:t}),enabled:!_c(i)}},wm=i=>(nd(),ts(bm(i))),Sm=(i,e)=>{const t=(typeof i=="string"?[i]:i)??[];for(const n of t)if(n&&e.has(n))return n;return null},dg=(i,e)=>{const t=Ed(),{query:n}=id(),s=Md(n),{modelId:r=null}=Dc()??{};jd(i);const o=Dd(i)??null,a=[s,o,r],l=Sm(a,t);R.useEffect(()=>{v.initThread(i,e,l),Ni.reset()},[i]);const d=sd(),u=R.useCallback(()=>{const y={...n};delete y.model;const S=rd.stringify(y);d({search:S.length>0?`?${S}`:""})},[n,d]),{isLoading:m,data:p}=wm({clientThreadId:i,clientModelId:a.find(y=>!!y)??null,conversationMode:e}),k=od();R.useEffect(()=>{if(!(!s||m)){if(!t.has(s)||k.find(y=>y.model_slug===s))return u();v.setThreadModelId(i,s)}},[s,k,t,i]),R.useEffect(()=>{if(m||!p)return;const{default_model_slug:y}=p;s&&y&&s!==y&&u(),Ni.updateDetails(p),y&&v.setThreadModelId(i,y)},[m,p])};export{wt as $,st as A,lg as B,eg as C,fe as D,qm as E,N as F,Zm as G,ym as H,Ce as I,Km as J,Fm as K,ln as L,fn as M,W as N,sg as O,Vm as P,ri as Q,Ye as R,Q as S,ys as T,og as U,cg as V,ms as W,Xm as X,Qh as Y,ih as Z,nn as _,We as a,nt as a0,qh as a1,Gm as a2,$m as a3,Wm as a4,Zf as a5,Hm as a6,D as b,zm as c,ie as d,Lm as e,jm as f,tg as g,pp as h,Ca as i,lp as j,Jm as k,Pm as l,Qm as m,ng as n,Ym as o,Ge as p,Um as q,Wh as r,$p as s,Qt as t,dg as u,rg as v,Yd as w,Qd as x,ag as y,lo as z};
//# sourceMappingURL=m9c7p1d7qbcooudb.js.map
