import{u as U,r as m,h as Y,R as Z,y as $}from"./i5bamk05qmvsi6c3.js";import{dK as j,dL as Q,dM as X,dN as k,dO as J,dP as W,dQ as z,dR as A,dS as ee,dT as P,bO as se,dU as te,dV as oe,dW as re,dX as ne,cG as ae,dY as ce,dZ as de,d_ as ie,d$ as ue,e0 as fe,e1 as me,e2 as Te,e3 as _,e4 as le,e5 as pe,e6 as xe,e7 as Ie,e8 as N,e9 as L,ea as ge,eb as ve}from"./b5wtmoh4inpzei0d.js";import{a as Me,T as y,m as Ce,o as he,s as Ee}from"./hyvagn7wiyqjw66o.js";import{f as ye}from"./i5ztl46q405lbqos.js";const Fe=e=>Y.safeGet("/conversation/{conversation_id}/textdocs",{parameters:{path:{conversation_id:e}}}),Re=async e=>{const t=await Fe(e),o=new Map(t?.map(r=>[r.id,r])),s=[];for(const{id:r,content:a,version:c,textdoc_type:n,title:T,comments:l}of t)s.push({textdocId:r,messageId:null,type:k(n),comments:J(l,a),title:T,content:a,versionInt:c,createdAt:0});return{persistedTextdocVersionById:new Map(s.map(r=>[r.textdocId,r])),persistedTextdocVersions:s,persistedTextdocById:o}};function Le({clientThreadId:e,isEnabled:t}){const o=Me(()=>y.getServerThreadId(e)),{data:s,error:d,isLoading:r,isFetching:a,refetch:c}=U({queryKey:[o,"textdocs"],enabled:!!o&&t,gcTime:0,queryFn:()=>o&&Re(o)});return m.useEffect(()=>{if(!s)return;const{persistedTextdocVersions:n}=s;j(n),Q(n),X(n)},[s]),[{...s,error:d,isLoading:r,isFetching:a},c]}var b=(e=>(e[e.INITIALIZING=0]="INITIALIZING",e[e.READY=1]="READY",e[e.REFETCHING=2]="REFETCHING",e))(b||{});function Oe({clientThreadId:e,isEnabled:t}){const[{error:o,persistedTextdocVersionById:s=null,isLoading:d,isFetching:r},a]=Le({clientThreadId:e,isEnabled:t}),c=W();z(()=>{if(!t)return;const T=y.getThreadCurrentLeafId(e),l=y.getThreadConversationTurns(e,T),p=A(l)?.messages??[],i=ee(p);if(i==null)return;const F=i.message.metadata?.canvas?.textdoc_id,v=i.message.metadata?.canvas?.version;F!=null&&v!=null&&c(F,v),a()});let n=0;return s&&r?n=2:s&&!r&&!d&&(n=1),m.useMemo(()=>({status:n,fetchError:o,textdocVersionById:s,refetch:a}),[n,o,s,a])}const D=e=>{if(!e)return;const{messages:t}=e,o=te(t??[],({message:d})=>d.author.role===Z.System),s=o===-1?t:t?.slice(o+1);if(s&&oe(s))return s},Ve=({lastTurn:e,clientThreadId:t,isEnabled:o,isRequestActive:s,persistedTextdocStoreStatus:d})=>{const[r,a]=m.useState(!0),c=o&&(s||!r||d===b.REFETCHING),n=m.useMemo(()=>{if(!e||!P(e))return null;const l=y.getTree(t),{variantIds:g}=e;return g.map(p=>{const i=l.getLeafFromNode(p).id;return A(y.getThreadConversationTurns(t,i))})},[t,e]);return[m.useMemo(()=>!c||!e?null:P(e)?n?.flatMap(D).filter(se)??null:D(e)??null,[c,e,n]),a]};function Be({clientThreadId:e,isEnabled:t}){const o=Ce(e),s=he(e,o),d=Ee(e),r=ae(d),a=Oe({isEnabled:t,clientThreadId:e}),c=ce(),n=de(()=>Promise.allSettled([a.refetch(),ye(e,!0)])),[T,l]=Ve({isEnabled:t,isRequestActive:r,lastTurn:A(s),clientThreadId:e,persistedTextdocStoreStatus:a.status}),g=!!T,p=n??T,i=!!n||r,F=m.useMemo(()=>s.slice(0,g?-1:s.length),[s.length,g]),v=ie(F),O=ue(),S=fe(),G=me(),M=m.useMemo(()=>{let R=Te(v);const{textdocVersionById:q,fetchError:w,status:K}=a;return R=_(R,u=>{u.fetchError=w,u.isFetchingFromPersistence=K===b.REFETCHING;for(const{pastedAt:x,content:C,metadata:h,tempId:f}of G){const B=u.resolveTempTextdocId[f]??f,{title:E="",type:I=Ie.DOCUMENT}=h??{};N(u,{textdocId:B,title:E,type:I,content:C,createdAt:x,versionInt:0,comments:[],messageId:null})}if(q)for(const[x,C]of q.entries()){u.allTextdocIdSet[x]=x;const h=c.get(x);let f=h&&(h.versionInt??L)>(C.versionInt??L)?{...C,...h}:C;const B=S.filter(I=>I.textdocId===x&&I.kind===ge.REMOVE_COMMENT);let E=f.versionInt;for(const I of B)f=ve(f,I),E=Math.max(E??L,I.versionInt??L);f={...f,versionInt:E},u.textdocById[x]=void 0,N(u,f)}}),O?_(R,u=>{N(u,O,!1)}):R},[G,v,a,c,O,S]),H=m.useMemo(()=>p?.length?le(i,M,p):null,[p,i,M]),V=pe(i,H,l);return m.useMemo(()=>V?xe(M,V):M,[M,V])}function qe({clientThreadId:e,children:t}){const o=re(),s=Be({clientThreadId:e,isEnabled:o});return $.jsx(ne.Provider,{value:s,children:t})}export{qe as T};
//# sourceMappingURL=gs79fvhyldtvksv2.js.map
