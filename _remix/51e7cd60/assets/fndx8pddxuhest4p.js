import{B as j,r as u,gt as U,gu as L,gU as v,gV as k,eV as b,V as E,W as T,U as F,bB as V,v as Q,a0 as I,gW as $,ex as q,bb as K,m as P,u as z,cj as N}from"./kqru8lsn8we722yx.js";import{fg as W,bQ as _,fh as D}from"./nms257ef1lzn00g8.js";import{A as G}from"./lwt6g4izs8lu1n2g.js";import{aP as H,bd as J,aN as X}from"./jtfo8pfmx9vwsskh.js";function Y({audioAssetPointer:t,conversationId:e}){const r=j(),[o,s]=u.useState(!1),a=u.useRef(!0),[l,m]=u.useState(void 0),n=u.useRef(null),i=U(),h=L(f=>f.isPlaying&&f.sourceUrl===l),d=u.useCallback(()=>{const f=v();if(f)n.current?n.current.then(()=>{f.stop(),n.current=null}):f.stop();else return},[]);u.useEffect(()=>(a.current=!0,()=>{a.current=!1}),[]),u.useEffect(()=>()=>{k().isPlaying&&d()},[d]);const g=u.useCallback(async()=>{if(!i||!a.current)return;s(!0);const{url:f}=await G.fetch(r,{asset:t,conversationId:e});s(!1),m(f),i.changeSource(f),n.current=i.play()},[t,e,i,r]);return{togglePlayback:u.useCallback(()=>{if(i)h?d():(b.messagePlayback.click(),g());else return},[h,g,i,d]),isPlaying:h,isLoading:o}}class Z{capacity;cache;dispose;constructor({capacity:e,dispose:r}){this.capacity=e,this.cache=new Map,this.dispose=r}get(e){if(!this.cache.has(e))return null;const r=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,r),r}set(e,r){if(this.cache.has(e)){this.cache.delete(e),this.cache.set(e,r);return}if(this.cache.size>=this.capacity){const o=this.cache.keys().next().value;this.delete(o)}this.cache.set(e,r)}delete(e){const r=this.cache.get(e);this.cache.delete(e),this.dispose&&this.dispose(r)}}function ee({conversationId:t,messageId:e}){const[r,o]=u.useState(!1),s=u.useRef({isMediaSourceAvailable:R(),mediaSourceFormat:M()??"n/a",playPromise:null,shouldAbortQueuedPlayback:!1}).current,a=E(),l=T(),{voiceName:m}=W(),n=`${t}.${e}.${m}`,i=U(),h=L(c=>c.isPlaying&&c.sourceUrl===y.get(n)?.src),d=u.useCallback(async()=>{if(!i)return;o(!0);const c={isMediaSourceAvailable:s.isMediaSourceAvailable,format:s.mediaSourceFormat};try{const S=await te({key:n,message_id:e,conversation_id:t,voice:m,onStreamingError:B=>{b.readAloud.error(B,c),o(!1),l.danger(a.formatMessage(w.playbackError,{error:B.message}))},onStreamingStart:()=>{o(!1)}});if(s.shouldAbortQueuedPlayback){s.shouldAbortQueuedPlayback=!1;return}i.changeSource(S),s.playPromise=i.play()}catch(S){b.readAloud.error(S,c),o(!1),l.danger(a.formatMessage(w.playbackError,{error:S.message}))}},[i,s,n,e,t,m,l,a]),g=u.useCallback(()=>{const c=v();c&&(s.playPromise?s.playPromise.then(()=>{c.stop(),s.playPromise=null}):c.stop())},[s]),p=u.useCallback(()=>{const c=v();c&&(c.state.isPlaying&&c.state.sourceUrl===y.get(n)?.src?g():(b.readAloud.click({isMediaSourceAvailable:s.isMediaSourceAvailable,format:s.mediaSourceFormat}),d()))},[n,s,d,g]);u.useEffect(()=>{r&&h&&o(!1)},[r,h]);const f=u.useRef(n);return u.useEffect(()=>{f.current=n}),u.useEffect(()=>(s.shouldAbortQueuedPlayback=!1,()=>{const c=k();c.isPlaying&&c.sourceUrl===y.get(f.current)?.src?g():s.shouldAbortQueuedPlayback=!0}),[s,g]),{togglePlayback:p,isPlaying:h,isLoading:r}}async function C({message_id:t,conversation_id:e,voice:r}){const o=await I.synthesize({message_id:t,conversation_id:e,voice:r,format:M()}),s=o.headers.get("content-type")??"audio/aac";return{response:o,format:s}}async function te(t){return R()?se(t):ae(t)}async function ae({key:t,...e}){const r=y.get(t);if(r?.blob)return r.src;const{response:o,format:s}=await C(e),a=await o.arrayBuffer(),l=new Blob([a],{type:s}),m=x({key:t,src:URL.createObjectURL(l),format:s,blob:l});return y.set(t,m),m.src}async function se({key:t,onStreamingError:e,onStreamingStart:r,...o}){let s=y.get(t);s?.streaming&&(y.delete(t),s=null);let a,l;const m=oe(),n=new m;if(s)a=s,a.src=URL.createObjectURL(n);else{const{format:d,response:g}=await C(o);l=g,a=x({key:t,src:URL.createObjectURL(n),format:d})}const i=re(a.id),h={sourceopen:async()=>{i("sourceopen");const d=n.addSourceBuffer(a.format),g=async()=>{d.updating&&await new Promise(p=>d.addEventListener("updateend",p,{once:!0}))};if(a.segments.length&&!a.streaming){i("streaming from cache"),a.streaming=!0,r();for(const p of a.segments)d.appendBuffer(p),await g();n.readyState==="open"&&n.endOfStream(),a.streaming=!1,i("done streaming from cache");return}if(l){i("fetching audio");try{const p=l.body?.getReader();if(!p)return;for(;y.get(t)?.id===a.id;){const{done:f,value:c}=await p.read();if(f){i("done streaming"),a.streaming=!1,n.readyState==="open"&&n.endOfStream();break}if(!Array.from(n.sourceBuffers).includes(d)){i("stop streaming, source buffer removed"),a.streaming=!1;break}a.streaming||(i("start streaming"),a.streaming=!0,r()),d.appendBuffer(c),a.segments.push(c),await g()}}catch(p){if(i("error while streaming",p),a.streaming=!1,n.readyState==="open")try{n.endOfStream("network")}catch(f){b.readAloud.error(f)}y.delete(t),e(p)}}},sourceclose:()=>{i("sourceclose"),a.streaming&&(a.streaming=!1,y.get(t)?.id===a.id&&(i("sourceclosed while streaming, cleaning up cache"),y.delete(t)))},sourceended:V};for(const[d,g]of Object.entries(h))n.addEventListener(d,()=>{try{return g()}catch(p){b.readAloud.error(p)}});return y.set(t,a),a.src}const w=F({playbackError:{id:"useVoiceReadAloudAudio.playbackError",defaultMessage:"Failed to play message"}}),re=t=>V;function oe(){return R()?window.MediaSource:null}function R(){return!!M()}function M(){if("MediaSource"in window){const t=e=>$(e)&&MediaSource.isTypeSupported(e);if(t("audio/aac"))return"aac";if(t("audio/mpeg"))return"mp3";if(t("audio/ogg"))return"ogg"}}const x=t=>({id:Q(),segments:[],streaming:!1,...t}),y=new Z({capacity:50,dispose:t=>{URL.revokeObjectURL(t.src)}}),fe=u.memo(function(e){const r=z("1923022511")?.value,o=q(e.conversationId),{errCode:s}=_(e.message);if(!r||!o||s)return null;const a=K.getAudioAssetPointers(e.message.message)[0];return a?P.jsx(ne,{audioAssetPointer:a,conversationId:o}):P.jsx(ie,{...e,conversationId:o})});function ne({audioAssetPointer:t,conversationId:e}){const{isLoading:r,isPlaying:o,togglePlayback:s}=Y({audioAssetPointer:t,conversationId:e});return P.jsx(O,{onClick:s,isPlaying:o,isLoading:r,playText:A.replay,playIcon:H})}function ie({conversationId:t,message:e}){const{isLoading:r,isPlaying:o,togglePlayback:s}=ee({conversationId:t,messageId:e.message.id});return P.jsx(O,{onClick:s,isPlaying:o,isLoading:r,playText:A.play,playIcon:J})}function O({onClick:t,isPlaying:e,isLoading:r,playText:o,playIcon:s}){let a,l;const m=E();return r?(a=N,l=A.loading):e?(a=X,l=A.stop):(a=s,l=o),P.jsx(D,{icon:a,label:l?m.formatMessage(l):void 0,disabled:r,onClick:t,style:e||r?{visibility:"visible"}:void 0,testId:"voice-play-turn-action-button"})}const A={replay:{id:"VoiceReadOutLoudButton.replay",defaultMessage:"Replay",description:"The tooltip for the replay button"},play:{id:"VoiceReadOutLoudButton.play",defaultMessage:"Read aloud",description:"The tooltip for the read aloud button"},stop:{id:"VoiceReadOutLoudButton.stop",defaultMessage:"Stop",description:"The tooltip for the stop button"},loading:{id:"VoiceReadOutLoudButton.loading",defaultMessage:"Loading",description:"The tooltip for the spinner"}};export{O as PlayButton,ne as VoiceMessagePlaybackButton,fe as VoicePlayButton,ie as VoiceReadAloudButton};
//# sourceMappingURL=fndx8pddxuhest4p.js.map
