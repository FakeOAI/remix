const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/gp8pwa3ldjlohwkx.js","assets/ggqkrs5vmoblzdof.js","assets/ewkai8s4e9yar8dc.js","assets/root-iiaju9r7.css","assets/o80ux0facb235uz7.js","assets/q9yjk42glkz6k7z4.js","assets/conversation-small-ogafjggy.css","assets/cvj4mfmc4a67wtlp.js","assets/kl4uzc01l95ohk4w.js","assets/epki1omfq4el3erx.js","assets/eio2we3hcce7krab.js","assets/jt3ibd2tok9xqii3.js","assets/ep578kky843j3b48.js","assets/o5xl8td8i97kggrl.js","assets/oe6e7r02lhpma7fp.js"])))=>i.map(i=>d[i]);
import{l as e,r as d,a1 as _,M as V,aK as Y,bg as L,R as A,m as re,bh as oe,aD as H,aE as Q,X as W,bR as X,Y as R,$ as ie,a0 as le,f0 as f,a as Z,aC as ce}from"./ggqkrs5vmoblzdof.js";import{y as de,T as b,z as ue}from"./b8d848azo3dhtxr3.js";import"./i0warstii4ooeu5q.js";import"./b2ipu85lq53l0g5n.js";import{eY as $,eZ as z,W as p,cG as me,e as ge,c as ee,m as C,b as se,Z as xe,O as he,Q as pe,U as B,V as q,Y as fe,db as P,e_ as be,e$ as ve,f0 as te}from"./q9yjk42glkz6k7z4.js";import{S as je,c as ye}from"./k7xxq0bt8m7898kc.js";import{C as Se}from"./i707jjdl1du9m1ed.js";import{C as Ce}from"./o80ux0facb235uz7.js";import{aq as we,ay as ae,b7 as _e,o as Ne}from"./ewkai8s4e9yar8dc.js";import{d as ke}from"./cpxgbmji7o6dpuj3.js";import"./iza8y8l6mmli306n.js";import"./flx3aslm8lcme041.js";import"./fzrn137102spawew.js";import"./e9lafxuzyeh4418f.js";import"./cvu2wuwh0n4w0tkw.js";import"./nqbt8yx7mry886w9.js";import"./ewyixyddh5pmlp1p.js";import"./kcu7yb7kmfakkuk4.js";import"./lurjpvlfqaw76wz0.js";import"./hmddwd68wyz1zxhg.js";import"./dy0de7qsh4wsq4f7.js";import"./dnnti5ycxlkock1t.js";import"./pi90stopy4shtu36.js";import"./jlb9l8rbqx4i5ov5.js";import"./o64a6eeici4vp3h1.js";import"./o4sp6ycnliaevawi.js";import"./nk84vjeawg79ihe8.js";import"./nknlh5fqjrqo75k7.js";import"./grfy5trva0gtc1qj.js";import"./j1b37ssqqo48obtm.js";import"./fz6zlryqc5ygvbv8.js";import"./eh7h2s7qojuftokk.js";function Me({children:s,sidebarOpen:n,onClose:o}){return e.jsx($.Root,{show:n,as:d.Fragment,children:e.jsxs(z,{as:"div",className:"relative z-10",onClose:o,children:[e.jsx("div",{className:"fixed inset-0"}),e.jsx("div",{className:"fixed inset-0 overflow-hidden",children:e.jsx("div",{className:"absolute inset-0 overflow-hidden",children:e.jsx("div",{className:"pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-10",children:e.jsx($.Child,{as:d.Fragment,enter:"transform transition ease-in-out duration-100 sm:duration-300",enterFrom:"translate-x-full",enterTo:"translate-x-0",leave:"transform transition ease-in-out duration-300 sm:duration-500",leaveFrom:"translate-x-0",leaveTo:"translate-x-full",children:e.jsx(z.Panel,{className:"pointer-events-auto w-screen max-w-md border-l border-gray-100 dark:border-gray-700",children:e.jsx("div",{className:"h-full overflow-y-auto bg-token-main-surface-primary shadow-xl",children:s})})})})})})]})})}function De({clientThreadId:s}){const{rebaseSystemMessageContent:n,showDebugConversationTurns:o}=p(),[a,r]=d.useState(()=>n?JSON.stringify(n,null,2):void 0),[i,c]=d.useState(!!n),t=de(s,b.getThreadCurrentLeafId(s)),u=me(t,m=>m.content.content_type===V.SystemContent)?.content??null,j=()=>{r(u?JSON.stringify(u,null,2):"")},x=Y(),h=d.useMemo(()=>ge(m=>{try{m?p.setState({rebaseSystemMessageContent:{...JSON.parse(m),content_type:V.SystemContent}}):p.setState({rebaseSystemMessageContent:null}),x.closeAll()}catch{x.danger("The System Message is not valid JSON")}},500),[x]);return d.useEffect(()=>{i?h(a):(h.cancel(),p.setState({rebaseSystemMessageContent:null}))},[h,i,a]),e.jsxs("div",{className:"flex flex-col gap-3 px-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(ee,{label:"Enable to apply this system message to the current conversation.",children:e.jsx(C,{id:"enabled",label:"Enabled",checked:i,onChange:m=>c(m.currentTarget.checked)})}),e.jsx(C,{id:"show-internal-conversation-turns",label:"Conversation debug mode",checked:o,onChange:()=>{p.setState({showDebugConversationTurns:!o})}})]}),e.jsx(L,{disabled:!u,className:"mt-2",onClick:j,size:"small",children:"Load active system message"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm",children:"System Message"}),e.jsx(Te,{disabled:!i,placeholder:u?"Press `Load active system message` to pre-populate this":"Start a conversation and then press `Load active system message` to pre-populate this",className:"min-h-[75vh] rounded-md border border-gray-400 p-1 font-mono",value:a,onChange:m=>r(m.target.value)})]})]})}const Te=_.textarea`w-full rounded-lg border border-token-border-light bg-token-main-surface-primary text-sm text-token-text-primary focus:border-token-text-primary focus:shadow-none focus:outline-none focus:ring-token-text-primary disabled:bg-token-main-surface-tertiary`;function Re({clientThreadId:s}){const[n,o]=d.useState([]),a=b.getThreadCurrentLeafId(s),r=b.getThreadConversationTurns(s,a),i=t=>{const u=b.getTree(s).getLeafFromNode(t);b.setThreadCurrentLeafId(s,u.id)},c=t=>{o(l=>[...l,a]),i(t)};return e.jsxs(e.Fragment,{children:[n.length>0&&e.jsxs(L,{className:"absolute left-2 top-2",color:"secondary",onClick:()=>{const t=n[n.length-1];i(t),o(l=>l.slice(0,-1))},children:[e.jsx(we,{className:"icon-sm"}),"Go back to ",n[n.length-1]]}),e.jsx("div",{className:"flex flex-col items-center gap-4 overflow-auto p-4 text-xs",children:r.map((t,l)=>{const u=t.messages[0].nodeId,j=b.getTree(s),x=l!==0?j.getParent(u):null,h=x!=null?x.children.findIndex(g=>u===g):0,m=x!=null?x.children:[],S=m.slice(0,h),y=m.slice(h+1);let v;switch(t.role){case A.User:v="bg-blue-500";break;case A.Assistant:v="bg-gray-600";break;default:v="bg-gray-400";break}return e.jsxs("div",{className:re("relative p-2",v),children:[e.jsx("div",{className:"absolute bottom-0 left-0 -ml-2 flex -translate-x-full gap-2 pl-2",children:S.map(g=>e.jsx(G,{variantId:g,onChangeItemInView:c},g))}),e.jsx("div",{className:"absolute left-full top-0 ml-2 flex gap-2 pr-2",children:y.map(g=>e.jsx(G,{variantId:g,onChangeItemInView:c},g))}),e.jsx("div",{className:"flex flex-col gap-2",children:t.messages.map(g=>e.jsxs("div",{className:"h-14 w-32 truncate bg-gray-200 p-1 text-black",children:[e.jsx("div",{className:"font-semibold",children:g.nodeId}),e.jsx("div",{className:"italic text-token-text-tertiary",children:g.message.author.role}),e.jsx("div",{children:se(g.message)})]},g.nodeId))})]},l)})})]})}function G({variantId:s,onChangeItemInView:n}){return e.jsx("button",{className:"w-32 truncate bg-gray-400 p-2 text-black opacity-50 hover:opacity-100",onClick:()=>{n(s)},children:e.jsx("span",{className:"bg-gray-200 p-2",children:s})},s)}const Pe=H(()=>Q(()=>import("./gp8pwa3ldjlohwkx.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13])).then(s=>s.DebugModalContents),{ssr:!1}),Ae=H(()=>Q(()=>import("./oe6e7r02lhpma7fp.js"),__vite__mapDeps([14,1,2,3,5,6])).then(s=>s.FramesViewer),{ssr:!1});function Ss(){return e.jsx("button",{"data-testid":"open-debug-sidebar-button",className:"flex h-6 w-6 items-center justify-center rounded-full border border-token-border-light text-xs text-token-text-secondary",onClick:()=>{xe.setActiveSidebar("debug")},children:e.jsx(ae,{className:"icon-xs"})})}function Le({children:s,title:n,icon:o,isOpen:a,slideOver:r,onClose:i}){const c=e.jsxs($e,{children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 text-lg font-semibold text-gray-900 dark:text-white",children:[e.jsx(o,{className:"icon-sm"}),n]}),e.jsx("div",{className:"mr-2 mt-2 flex h-7 items-center",children:e.jsx(oe,{onClick:i})})]}),s]});return r?e.jsx(Me,{sidebarOpen:a,onClose:i,children:c}):a?c:null}function Fe({nodes:s,setDebugNodeIndex:n,setFrameSrc:o,conversationId:a}){const r=s.map((i,c)=>{const t=i.message,{role:l,name:u}=t.author,j=u&&u!==l,x=f(t,"metadata.__internal.model_id"),h=f(t,"metadata.__internal.agent.settings.completion_api.engine"),m=f(t,"metadata.__internal.model_experiment_name"),S=f(t,"metadata.__internal.model_experiment_treatment"),y=f(t,"metadata.__internal.normalized_model_side"),v=f(t,"metadata.__internal.alternative_model_selection_rule"),g=f(t,"metadata.__internal.model_experiment_group_name"),N=f(t,"metadata.__internal.model_experiment_group_params"),k=f(t,"metadata.__internal.model_experiment_override"),E=f(t,"metadata.__internal.model_experiment_eval_seq"),M=f(t,"metadata.__internal.raw_tokens")?.length,I=f(t,"metadata.request_id"),O=P.getAudio(t),U=P.getAudioAssetPointers(t),ne=P.getFrameAssetPointers(t);return e.jsxs(Be,{role:"button",onClick:()=>n(c),children:[e.jsxs("div",{className:"text-xs font-semibold uppercase text-token-text-tertiary",children:[l,j&&` (${u})`,t.recipient&&" -> ",be(t)]}),(t.author.role!==A.System||I)&&e.jsxs("div",{className:"text-xs text-token-text-tertiary",children:[e.jsxs("div",{children:["ID: ",t.id]}),i.id!==t.id&&e.jsxs("div",{children:["UI Node ID: ",i.id]}),e.jsxs("div",{children:["Req ID: ",I||"Reload page to see ID"]})]}),e.jsx("div",{className:"line-clamp-6",children:se(t)}),(M||x||h||m||S||y||v||g||N||k||E)&&e.jsxs("div",{className:"mt-4 w-full self-start rounded-xl bg-blue-200 px-3 py-0.5 text-xs text-black",children:[M!==void 0&&e.jsxs("div",{children:[e.jsx("b",{children:"Tokens Count:"})," ",M]}),x&&e.jsxs("div",{children:[e.jsx("b",{children:"Model ID:"})," ",x]}),h&&e.jsxs("div",{children:[e.jsx("b",{children:"Engine:"})," ",h]}),m&&e.jsxs("div",{children:[e.jsx("b",{children:"Experiment:"})," ",m]}),S&&e.jsxs("div",{children:[e.jsx("b",{children:"Treatment:"})," ",S]}),y&&e.jsxs("div",{children:[e.jsx("b",{children:"Normalized Side:"})," ",y]}),v&&e.jsxs("div",{children:[e.jsx("b",{children:"Alternative Model Rule:"})," ",v]}),g&&e.jsxs("div",{children:[e.jsx("b",{children:"Group Name:"})," ",g]}),N&&e.jsxs("div",{children:[e.jsx("b",{children:"Group Params:"}),e.jsx("div",{children:JSON.stringify(N,null,2)})]}),k&&e.jsxs("div",{children:[e.jsx("b",{children:"Above Params are Overridden By:"})," ",k]}),E&&e.jsxs("div",{children:[e.jsx("b",{children:"Experiment Eval Seq:"})," click to see"]})]}),O.length||U.length?e.jsxs("div",{className:"mt-4 flex flex-col flex-nowrap gap-2",children:[e.jsx(Ve,{frameAssets:ne,setFrameSrc:o},c),O.map((D,T)=>e.jsx(w,{audio:D,conversationId:a},T)),U.map((D,T)=>e.jsx(w,{assetPointer:D,conversationId:a},T))]}):null]},t.id)});return e.jsx(ze,{children:r})}const J=s=>e.jsx(ye.Input,{...s,inputClassName:"focus:ring-0"});function Ee(){const s=p(),o=ke().map(a=>({label:a.name,options:a.options.map(r=>({label:`${r.value} (${r.name})`,value:r.value}))}));return e.jsxs("div",{className:"mt-2 flex flex-col justify-around gap-3 px-4 py-1 text-xs font-semibold",children:[e.jsx(C,{id:"force-paragen",label:"Force Parallel Gen",checked:s.forceParagen,onChange:()=>{p.setState({forceParagen:!s.forceParagen})}}),e.jsx(Se,{options:o,name:"force-paragen-model",className:"shadow-none dark:text-gray-800",isDisabled:!s.forceParagen,isLoading:o.length===0,value:s.forceParagenModel,isClearable:!0,isMulti:!1,components:{Input:J},onChange:a=>{p.setState({forceParagenModel:a??ve})}}),e.jsx(C,{id:"show-paragen-metadata",label:"Show Paragen Metadata",checked:s.showParagenMetadata,onChange:()=>{p.setState({showParagenMetadata:!s.showParagenMetadata})}}),e.jsx("div",{id:"force-use-search-label",children:"Force Use Search:"}),e.jsx(je,{id:"force-use-search",options:[{label:"Default",value:"default"},{label:"Force",value:"true"},{label:"Disable",value:"false"}],name:"force-use-search",className:"shadow-none dark:text-gray-800",value:s.forceUseSearch==null?{value:"default",label:"Default"}:s.forceUseSearch?{value:"true",label:"Force"}:{value:"false",label:"Disable"},isMulti:!1,components:{Input:J},onChange:a=>{p.setState({forceUseSearch:(a?.value??"default")==="default"?null:a?.value==="true"})}}),e.jsx(C,{id:"force-rate-limit",label:"Force Rate Limit",checked:s.forceRateLimit,onChange:()=>{p.setState({forceRateLimit:!s.forceRateLimit})}}),e.jsx(C,{id:"reset-rate-limit",label:"Reset Rate Limits",checked:s.resetRateLimits,onChange:()=>{p.setState({resetRateLimits:!s.resetRateLimits})}}),e.jsx(ee,{label:"Enabling this will show debug conversation messages in the chat",children:e.jsx(C,{id:"show-internal-conversation-turns",label:"Conversation debug mode",checked:s.showDebugConversationTurns,onChange:()=>{p.setState({showDebugConversationTurns:!s.showDebugConversationTurns})}})})]})}const K=_.div`px-3 pb-2 text-xs font-semibold uppercase border-b-2 ${({$isSelected:s})=>s?"border-black dark:border-white":"border-transparent"}`;function Cs({clientThreadId:s,isOpen:n,slideOver:o,onClose:a}){const r=W(),i=X(),[c,t]=d.useState("conversation");return i?.includes("debug")?e.jsx(Le,{icon:ae,title:r.formatMessage(F.debugTitle),isOpen:n,slideOver:o,onClose:a,children:e.jsxs(he,{orientation:"vertical",defaultValue:c,onValueChange:l=>t(l),children:[e.jsxs(pe,{className:"mb-4 flex items-center justify-center gap-2 px-2 py-1 text-xs",children:[e.jsx(B,{value:"conversation",children:e.jsx(K,{$isSelected:c==="conversation",children:"Conversation"})}),e.jsx(B,{value:"system-message-editor",children:e.jsx(K,{$isSelected:c==="system-message-editor",children:"System Message"})}),!1]}),e.jsx(q,{value:"conversation",children:e.jsx(Ie,{clientThreadId:s})}),e.jsx(q,{value:"system-message-editor",children:e.jsx(De,{clientThreadId:s})}),!1]})}):null}function Ie({clientThreadId:s}){const n=W(),o=b.getThreadCurrentLeafId(s),a=ue(s,o),[r,i]=d.useState(),c=X(),t=d.useCallback(()=>{i(void 0)},[]),l=Y(),u=d.useCallback(y=>{const v=b.getTree(s);fe(v.getTextFromThread(o),l,y)},[o,s,l]),[j,x]=d.useState(!1),[h,m]=d.useState(void 0);return c?.includes("debug")?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-2 flex items-center justify-around px-4 py-1 text-xs font-semibold uppercase",children:e.jsx(Ue,{clientThreadId:s,messages:a.map(y=>y.message)})}),!1,e.jsxs("div",{className:"flex items-center justify-around gap-2 px-4 py-1 text-xs font-semibold uppercase",children:[e.jsx("div",{children:e.jsx(Ce,{onCopy:u,buttonText:n.formatMessage(F.copyText)})}),e.jsxs("button",{className:"flex items-center justify-center gap-2",onClick:()=>x(!0),children:[e.jsx(_e,{className:"icon-sm rotate-90"}),"View tree"]})]}),e.jsx(Ee,{}),e.jsx(Fe,{nodes:a,setDebugNodeIndex:i,setFrameSrc:m,conversationId:b.getServerThreadId(s)}),r!==void 0&&e.jsx(R,{type:"success",size:"fullscreen",noPadding:!0,isOpen:!0,onClose:t,children:e.jsx(Pe,{threadId:a[r].message.metadata?.__internal?.sonic_thread_id,threadUserId:a[r].message.metadata?.__internal?.sonic_user_id,onClose:t,message:a[r].message})},`DebugMessageModal-${r}`),j&&e.jsx(R,{isOpen:!0,onClose:()=>x(!1),type:"success",size:"custom",noPadding:!0,children:e.jsx(Re,{clientThreadId:s})},"DebugTreeViewer"),h&&e.jsx(R,{size:"normal",isOpen:!0,onClose:()=>m(void 0),type:"success",children:e.jsx("img",{src:h,alt:"debug image"})},"DebugFrameViewer")]}):null}function Oe(s,n){const o=JSON.stringify({conversation_id:b.getServerThreadId(s),messages:n},null,2),a=new Blob([o],{type:"application/json"}),r=URL.createObjectURL(a),i=document.createElement("a");i.href=r,i.download=`messages-${b.getServerThreadId(s)}.json`,i.click(),URL.revokeObjectURL(r)}function Ue({clientThreadId:s,messages:n}){const o=d.useCallback(()=>{Oe(s,n)},[s,n]);return e.jsx(L,{onClick:o,color:"primary",size:"small",icon:Ne,children:e.jsx(ie,{...F.downloadRawConversation})})}function Ve(s){const[n,o]=d.useState([]),a=Z(),{frameAssets:r}=s;return d.useEffect(()=>{async function i(){const c=r.map(async({image_asset_pointer:t,timestamp:l})=>{const u={asset:t};return{src:(await te.fetch(a,u)).url,timestamp:l}});return Promise.all(c)}r.length>0&&i().then(o)},[r,a]),e.jsx(Ae,{frames:n,setFrameSrc:s.setFrameSrc})}function w(s){const n=w.useAssetPointerSource(s.assetPointer,s.conversationId),o=w.useAudioSource(s.audio),a=n??o,i=ce("3230069703").config.value.expirySeconds,[c,t]=d.useState(Date.now()),l=d.useRef(null);return d.useEffect(()=>{const u=setInterval(()=>{l.current&&l.current.currentTime>0&&!l.current.paused&&!l.current.ended&&l.current.readyState>2||t(Date.now())},i*1e3);return()=>clearInterval(u)},[i]),a?e.jsx("audio",{ref:l,controls:!0,src:a,className:"w-full"},c):null}w.useAssetPointerSource=(s,n)=>{const[o,a]=d.useState(null),r=Z();return d.useEffect(()=>{s&&te.fetch(r,{asset:s,conversationId:n}).then(i=>{a(i.url)})},[r,s,n]),o};w.useAudioSource=s=>{const[n,o]=d.useState(null);return d.useEffect(()=>{if(s){const a=atob(s.payload),r=new Uint8Array(a.length);for(let t=0;t<a.length;t++)r[t]=a.charCodeAt(t);const i=new Blob([r],{type:`audio/${s.format}`}),c=URL.createObjectURL(i);return o(c),()=>{URL.revokeObjectURL(c)}}},[s]),n};const $e=_.div`overflow-y-auto h-full md:w-[250px] lg:w-[300px] xl:w-[350px] 2xl:w-[400px] md:border-l md:border-gray-100 md:dark:border-gray-700 popover bg-token-main-surface-primary`,ze=_.pre`whitespace-pre-wrap text-sm`,Be=_.div`px-6 py-4 flex flex-col gap-1 hover:bg-gray-50 dark:hover:bg-gray-500/10 cursor-pointer border-b dark:border-white/10 border-gray-200`,F=le({debugTitle:{id:"DebugSidebar.debugTitle",defaultMessage:"Debug"},copyText:{id:"DebugSidebar.copyText",defaultMessage:"Copy text"},downloadRawConversation:{id:"DebugSidebar.downloadRawConversation",defaultMessage:"Download raw conversation"},uploadRawConversation:{id:"DebugSidebar.uploadRawConversation",defaultMessage:"Upload conversation dump"},closeSidebar:{id:"DebugSidebar.closeSidebar",defaultMessage:"Close sidebar"}});export{Ie as DebugConversation,Cs as DebugConversationSidebar,Ss as OpenDebugSidebarButton,Le as default,Oe as downloadMessages};
//# sourceMappingURL=icj492z8ap0wmvbo.js.map
