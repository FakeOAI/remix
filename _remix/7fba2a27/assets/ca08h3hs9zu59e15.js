const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/bxdl65vfohrw8di7.js","assets/mcyyoqk6c65s5m7y.js","assets/j6bdhpkfr2kjp58j.js","assets/root-o2p2036q.css","assets/1wtkrtn14xtx9d9j.js","assets/eqi5dfq4lqgt3gmd.js","assets/conversation-small-eplmind9.css","assets/dwfbwyjm7zopu5av.js","assets/g7xx6bp77agi8w8p.js","assets/kfrqyi6i2yyi96jh.js","assets/cu9l7fpkp3smphcy.js","assets/shared-mk6ngktc.css","assets/ohg1s3et26cja7zg.js","assets/bonalo3y1m1wonxg.js","assets/i82vv89dbyen7vll.js","assets/nh1durdkfwadep5g.js","assets/ey11d34qwjrrcz36.js","assets/kv39u2w28gozcl8g.js","assets/ocf4s6fktqnxrie6.js","assets/g30wksaahx5tfh97.js","assets/hg65d6uq4z8ncdrn.js","assets/hw6k3xdq2xxqdd1w.js","assets/kepaiod7hnq9d0bs.js","assets/nk8858u2pajbgcf4.js","assets/ocuzgloke56d7jc9.js","assets/bbv41foyq3azc2ez.js","assets/vok2992ho3jw6p06.js","assets/sso-wherv7nuadrq5lwl.js","assets/lgpf00wf7j2hcdwb.js","assets/iz4svkq3d37265vb.js","assets/ljisu34p8rpjm1ia.js","assets/fizlqcuiyxfj6fl5.js","assets/eefu4sew62i6j489.js","assets/lkby6z00tc2njyno.js","assets/fngkaki024xqbbzk.js","assets/gw3j9xc2akge4a0v.js","assets/hgubdw8uytlo7t5y.js","assets/of96tfkt8icl4kmf.js","assets/ffvajde8vwykgw6p.js","assets/kqwdyvkaaavvn8k3.js","assets/oyy17mc6nz1mt98j.js","assets/64g2ju0yqbxbbddp.js","assets/bripl6nlve1swt8t.js","assets/cyokxgzk3nk1705p.js","assets/b26d4khzhx7ogybe.js","assets/m1rv9f9ynturcje1.js","assets/eiwoz6s64ss0s8qy.js","assets/ephj8h5copu3cxqm.js","assets/nhdygcow3ujiffwu.js","assets/ntvzgspnnc3vz5ap.js","assets/f7xeg3xdk6faohl7.js","assets/kz3qmnk8s0y5jvdn.js","assets/j3fxc322iv6cne2p.js","assets/nhwwej1nq0zrd7sc.js","assets/95idkitnucyuuib6.js","assets/bev1ou9ghqnz7dah.js","assets/my2wvv2nnx2x0r56.js","assets/isjdmfmhzv09v01t.js","assets/mnarfnpi5sfdzqp0.js","assets/iksfwaicch97wq14.js","assets/j9yjpuzkf8104bkb.js","assets/mc7mffyhm6en8tkm.js","assets/g3pxwv6e6q8tl0o6.js","assets/hl1414xyqel8z1mn.js","assets/lztuzpitvagpkuqx.js","assets/e9pz3q14ejpb88gk.js","assets/ja6uz1kz6divt6k9.js","assets/fliddicphpkz4ver.js","assets/iej0cupg2dqkmejt.js","assets/cpa6178rhby96s3x.js","assets/jk8w36bsokizpx57.js","assets/liqp6cwyux4xf50c.js","assets/5sngip5omnm5mvst.js","assets/ozsqzno0rre7yudu.js","assets/jwcp4h2rxuxzuinu.js","assets/n5pcfalvu8anbnam.js","assets/bgbqhrhtei5khtpx.js","assets/okii1csr8pe9unn9.js","assets/cl3xqqmqz9bxy80a.js","assets/2hfi3g3gttaeux12.js","assets/nv2lv1cvhl61pg2m.js","assets/sso-jmjhjxeo.css","assets/e7fqh7qaid8ff1a6.js","assets/nubefgodcf9auqfw.js","assets/lef0meq529p5sfxe.js","assets/gf68msj5qmlu0ac1.js","assets/c7u7k2xj5hs6a9i7.js","assets/ctsdaoaqt15rs8o8.js","assets/k2xaglsw4nmvc5wc.js","assets/ir6q8tly4h9ztz7l.js","assets/hpmr41wsjihrk7ov.js","assets/d5e87ynk6cehldp6.js","assets/kasrkb3l8202c3ce.js"])))=>i.map(i=>d[i]);
var Ho=Object.defineProperty;var qo=(t,e,s)=>e in t?Ho(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var z=(t,e,s)=>qo(t,typeof e!="symbol"?e+"":e,s);import{R as Ze,a4 as De,bX as We,g2 as ps,cV as Vo,P as O,A,bQ as Ce,g3 as ea,ff as ta,ak as He,O as Ae,j as a,r as u,K as U,bz as yn,H as re,e7 as Wo,c as G,bO as $o,fI as Ko,B as St,aU as Zo,bt as wt,bv as sa,g4 as na,fC as xs,x as aa,a5 as Jo,L as yt,N as Re,as as js,fy as Yo,fO as oa,aN as Ms,y as _n,u as ia,bT as ra,c2 as ce,bV as Qo,J as ys,eq as Xo,cN as be,g5 as Rs,bH as ca,a7 as qt,b_ as Vt,bZ as ke,U as ei,V as ti,W as si,Q as ni,ax as la,dc as ai,g6 as Es,cJ as oi,bD as Jt,X as da,a_ as ii,f9 as Gt,dG as ri,fK as ua,eG as vn,aM as ma,cs as ci,eF as li,fa as di,cZ as fa,c_ as Wt,c$ as _s,e0 as ui,g7 as mi,aC as fi,g8 as hi,fG as gi,eb as Ke,fm as ha,f0 as ga,E as pa,fz as _t,e8 as pi,aQ as xi,cm as fe,cK as yi,g9 as _i,ga as vi,w as bi,cz as xa,d9 as As,c0 as Ns,c8 as Yt,aO as Si,aP as wi,cn as ki,br as Ge,fA as Ci,gb as Ii,gc as Ti,gd as ji,ge as Mi,gf as ya,ag as Ri,a2 as bn,gg as Ei,gh as Sn,gi as wn,gj as Ai,gk as Ni}from"./mcyyoqk6c65s5m7y.js";import{iX as Pi,iY as ye,iZ as Di,i_ as Ht,i$ as Pt,j0 as Fi,j1 as _a,a8 as Oi,dL as Li,bJ as Qt,aD as Xt,ey as Bi,gr as va,ez as Ps,j2 as zi,cP as es,n as Ds,j3 as Ui,j4 as ba,b2 as $t,eB as Ne,bR as Fs,j5 as Fe,u as Os,A as ct,cp as Gi,cs as Hi,b5 as qi,aX as Vi,aN as Wi,co as $i,hT as Ki,i7 as Zi,j6 as Ji,i4 as vt,j7 as he,j8 as Sa,j9 as vs,fJ as Yi,ja as Qi,jb as Xi,jc as er,jd as tr,b4 as wa,je as sr,hM as ka,aq as Ca,jf as nr,eK as ar,c7 as ts,iS as or,e3 as Ia,ab as ir,jg as rr,ii as cr,jh as Ta,eD as ss,iW as bt,ji as $e,iO as tt,jj as ds,jk as lr,a4 as dr,jl as kn,jm as ja,jn as Kt,jo as Ls,jp as Bs,jq as Ma,jr as Ra,d_ as Ea,iQ as Aa,dY as Na,dZ as Pa,js as ur,jt as mr,iu as zs,ju as fr,jv as Da,iv as Us,jw as Gs,jx as Dt,jy as hr,jz as gr,jA as pr,hQ as Zt,H as Fa,jB as xr,jC as yr,jD as _r,cz as vr,hy as br,hx as Oa,eM as Sr,hw as wr,jE as La,jF as kr,hs as bs,dS as it,ci as Cr,cg as Ir,jG as Tr,jH as jr,eE as Mr,jI as Rr,jJ as Er,E as Ar,al as Ba,jK as Nr,jL as Cn,w as Ss,i5 as Pr,jM as Dr,a9 as Fr,U as In,aw as za,jN as Or,jO as Lr,jP as Br,jQ as zr,jR as Ur,cN as Ua,d$ as Gr,g6 as Hr,et as Tn,jS as qr,jT as Vr,jU as Wr,s as $r,hJ as Kr,hn as ws,ho as Zr,jV as Jr,g3 as Hs,jW as Yr,cO as Qr,ar as jn,jX as Xr,ap as E,jY as ec,jZ as tc,j_ as sc,ia as nc,ib as ac,hU as oc,hN as ic,gm as rc,hg as Ft,j$ as us,k0 as cc,he as lc,hj as dc,hk as qs,k1 as uc,k2 as mc,C as fc,k3 as xt,k4 as hc,k5 as gc,k6 as pc,k7 as xc,k8 as yc,gW as Ga,e0 as _c,F as vc,bI as bc,k9 as Sc,cm as wc,ka as kc,kb as Cc,B as Ic,kc as Tc,kd as jc,ct as Mc,ke as ks,_ as Ha,kf as Rc,kg as Ec,kh as Ac,ki as Nc,kj as Mn,kk as Pc}from"./eqi5dfq4lqgt3gmd.js";import{q as Vs,d as Oe,T as C,H as qa,Y as Dc,b as ns,f as Va,w as lt,u as dt,e as Fc,c as Wa,g as Oc,Q as Lc,k as Bc,Z as zc,_ as Uc,A as Gc,h as Hc,$ as qc,a0 as Vc,i as $a,a1 as Wc}from"./ohg1s3et26cja7zg.js";import{a2 as Ka,bx as $c,aa as Za,bZ as Kc,R as Zc,bg as Jc,b_ as Yc,Z as Ws,ae as Qc,b$ as Xc,aJ as el,bP as Ja,ag as tl,z as sl,a5 as nl}from"./j6bdhpkfr2kjp58j.js";import{d as $s,U as al,h as ol,J as Ya,V as il,H as rl,u as cl,W as ll,X as dl,Y as ul,Z as ml,y as fl}from"./nh1durdkfwadep5g.js";import{a as hl}from"./ey11d34qwjrrcz36.js";import{m as ge}from"./dwfbwyjm7zopu5av.js";import{u as gl,P as pl,I as xl}from"./kv39u2w28gozcl8g.js";import{D as Q}from"./cu9l7fpkp3smphcy.js";import{r as Qa,e as yl,f as _l}from"./g30wksaahx5tfh97.js";import{t as vl,i as Xa,f as bl,h as eo,u as to,T as Sl,M as wl,a as kl,j as Cl}from"./kepaiod7hnq9d0bs.js";import{G as Il}from"./ocf4s6fktqnxrie6.js";import{L as Tl,G as jl,O as Ml,Q as Rl,U as Ot,V as El,X as Al,W as Nl,F as kt,I as so,Y as Pl}from"./nk8858u2pajbgcf4.js";import{b as Ks,s as Dl}from"./hw6k3xdq2xxqdd1w.js";import{i as no,a as Fl,g as Ol,b as Ll,c as Bl}from"./i82vv89dbyen7vll.js";import{g as Rn}from"./bbv41foyq3azc2ez.js";import{r as zl}from"./vok2992ho3jw6p06.js";var ao=zl();function Ul(t){if(typeof t!="string")throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!t)throw new Error("No input");const e=JSON.parse(t),s=e;let n;if(s.type==="system")if(s.event==="connected")n=Object.assign(Object.assign({},e),{kind:"connected"});else if(s.event==="disconnected")n=Object.assign(Object.assign({},e),{kind:"disconnected"});else return null;else if(s.type==="message")if(s.from==="group"){const o=An(e.data,e.dataType);if(o===null)return null;n=Object.assign(Object.assign({},e),{data:o,kind:"groupData"})}else if(s.from==="server"){const o=An(e.data,e.dataType);if(o===null)return null;n=Object.assign(Object.assign({},e),{data:o,kind:"serverData"})}else return null;else if(s.type==="ack")n=Object.assign(Object.assign({},e),{kind:"ack"});else return null;return n}function Gl(t){let e;switch(t.kind){case"joinGroup":{e={type:"joinGroup",group:t.group,ackId:t.ackId};break}case"leaveGroup":{e={type:"leaveGroup",group:t.group,ackId:t.ackId};break}case"sendEvent":{e={type:"event",event:t.event,ackId:t.ackId,dataType:t.dataType,data:En(t.data,t.dataType)};break}case"sendToGroup":{e={type:"sendToGroup",group:t.group,ackId:t.ackId,dataType:t.dataType,data:En(t.data,t.dataType),noEcho:t.noEcho};break}case"sequenceAck":{e={type:"sequenceAck",sequenceId:t.sequenceId};break}default:throw new Error(`Unsupported type: ${t.kind}`)}return JSON.stringify(e)}function En(t,e){switch(e){case"text":{if(typeof t!="string")throw new TypeError("Message must be a string.");return t}case"json":return t;case"binary":case"protobuf":{if(t instanceof ArrayBuffer)return ao.Buffer.from(t).toString("base64");throw new TypeError("Message must be a ArrayBuffer")}}}function An(t,e){if(e==="text"){if(typeof t!="string")throw new TypeError("Message must be a string when dataType is text");return t}else{if(e==="json")return t;if(e==="binary"||e==="protobuf"){const s=ao.Buffer.from(t,"base64");return s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength)}else return null}}class Hl{constructor(){this.isReliableSubProtocol=!0,this.name="json.reliable.webpubsub.azure.v1"}parseMessages(e){return Ul(e)}writeMessage(e){return Gl(e)}}const ql=()=>new Hl;var we;(function(t){t.Stopped="Stopped",t.Disconnected="Disconnected",t.Connecting="Connecting",t.Connected="Connected",t.Recovering="Recovering"})(we||(we={}));class Vl{nextAckId(){return this._ackId=this._ackId+1,this._ackId}constructor(e,s){this._quickSequenceAckDiff=300,this._activeTimeoutInMs=2e4,this._emitter=new Pi,this._isStopping=!1,this._isInitialConnected=!1,typeof e=="string"?this._credential={getClientAccessUrl:e}:this._credential=e,s==null&&(s={}),this._buildDefaultOptions(s),this._options=s,this._messageRetryPolicy=new Nn(this._options.messageRetryOptions),this._reconnectRetryPolicy=new Nn(this._options.reconnectRetryOptions),this._protocol=this._options.protocol,this._groupMap=new Map,this._ackMap=new Map,this._sequenceId=new Kl,this._state=we.Stopped,this._ackId=0}async start(e){if(this._isStopping)throw new Error("Can't start a client during stopping");if(this._state!==we.Stopped)throw new Error("Client can be only started when it's Stopped");let s;e&&(s=e.abortSignal),this._activeKeepaliveTask||(this._activeKeepaliveTask=this._getActiveKeepaliveTask());try{await this._startCore(s)}catch(n){throw this._changeState(we.Stopped),this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0),this._isStopping=!1,n}}async _startFromRestarting(e){if(this._state!==we.Disconnected)throw new Error("Client can be only restarted when it's Disconnected");try{ye.verbose("Staring reconnecting."),await this._startCore(e)}catch(s){throw this._changeState(we.Disconnected),s}}async _startCore(e){if(this._changeState(we.Connecting),ye.info("Staring a new connection"),this._sequenceId.reset(),this._isInitialConnected=!1,this._lastCloseEvent=void 0,this._lastDisconnectedMessage=void 0,this._connectionId=void 0,this._reconnectionToken=void 0,this._uri=void 0,typeof this._credential.getClientAccessUrl=="string"?this._uri=this._credential.getClientAccessUrl:this._uri=await this._credential.getClientAccessUrl({abortSignal:e}),typeof this._uri!="string")throw new Error(`The clientAccessUrl must be a string but currently it's ${typeof this._uri}`);await this._connectCore(this._uri)}stop(){this._state===we.Stopped||this._isStopping||(this._isStopping=!0,this._wsClient&&this._wsClient.isOpen()?this._wsClient.close():this._isStopping=!1,this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0))}on(e,s){this._emitter.on(e,s)}off(e,s){this._emitter.removeListener(e,s)}_emitEvent(e,s){this._emitter.emit(e,s)}async sendEvent(e,s,n,o){return await this._operationExecuteWithRetry(()=>this._sendEventAttempt(e,s,n,o),o==null?void 0:o.abortSignal)}async _sendEventAttempt(e,s,n,o){var i;if(!((i=o==null?void 0:o.fireAndForget)!==null&&i!==void 0?i:!1))return await this._sendMessageWithAckId(l=>({kind:"sendEvent",dataType:n,data:s,ackId:l,event:e}),o==null?void 0:o.ackId,o==null?void 0:o.abortSignal);const c={kind:"sendEvent",dataType:n,data:s,event:e};return await this._sendMessage(c,o==null?void 0:o.abortSignal),{isDuplicated:!1}}async joinGroup(e,s){return await this._operationExecuteWithRetry(()=>this._joinGroupAttempt(e,s),s==null?void 0:s.abortSignal)}async _joinGroupAttempt(e,s){const n=this._getOrAddGroup(e),o=await this._joinGroupCore(e,s);return n.isJoined=!0,o}async _joinGroupCore(e,s){return await this._sendMessageWithAckId(n=>({group:e,ackId:n,kind:"joinGroup"}),s==null?void 0:s.ackId,s==null?void 0:s.abortSignal)}async leaveGroup(e,s){return await this._operationExecuteWithRetry(()=>this._leaveGroupAttempt(e,s),s==null?void 0:s.abortSignal)}async _leaveGroupAttempt(e,s){const n=this._getOrAddGroup(e),o=await this._sendMessageWithAckId(i=>({group:e,ackId:i,kind:"leaveGroup"}),s==null?void 0:s.ackId,s==null?void 0:s.abortSignal);return n.isJoined=!1,o}async sendToGroup(e,s,n,o){return await this._operationExecuteWithRetry(()=>this._sendToGroupAttempt(e,s,n,o),o==null?void 0:o.abortSignal)}async _sendToGroupAttempt(e,s,n,o){var i,r;const c=(i=o==null?void 0:o.fireAndForget)!==null&&i!==void 0?i:!1,l=(r=o==null?void 0:o.noEcho)!==null&&r!==void 0?r:!1;if(!c)return await this._sendMessageWithAckId(f=>({kind:"sendToGroup",group:e,dataType:n,data:s,ackId:f,noEcho:l}),o==null?void 0:o.ackId,o==null?void 0:o.abortSignal);const m={kind:"sendToGroup",group:e,dataType:n,data:s,noEcho:l};return await this._sendMessage(m,o==null?void 0:o.abortSignal),{isDuplicated:!1}}_getWebSocketClientFactory(){return new Di}async _trySendSequenceAck(){if(!this._protocol.isReliableSubProtocol)return;const[e,s]=this._sequenceId.tryGetSequenceId();if(e&&s){const n={kind:"sequenceAck",sequenceId:s};try{await this._sendMessage(n)}catch{this._sequenceId.tryUpdate(s)}}}_connectCore(e){if(this._isStopping)throw new Error("Can't start a client during stopping");return new Promise((s,n)=>{const o=this._wsClient=this._getWebSocketClientFactory().create(e,this._protocol.name);o.onopen(()=>{if(this._isStopping){try{o.close()}catch{}n(new Error("The client is stopped"))}ye.verbose("WebSocket connection has opened"),this._changeState(we.Connected),this._protocol.isReliableSubProtocol&&(this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),this._sequenceAckTask=new Pn(async()=>{await this._trySendSequenceAck()},1e3)),s()}),o.onerror(i=>{this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),n(i)}),o.onclose((i,r)=>{this._state===we.Connected?(ye.verbose("WebSocket closed after open"),this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),ye.info(`WebSocket connection closed. Code: ${i}, Reason: ${r}`),this._lastCloseEvent={code:i,reason:r},this._handleConnectionClose.call(this)):(ye.verbose("WebSocket closed before open"),n(new Error(`Failed to start WebSocket: ${i}`)))}),o.onmessage(i=>{const r=d=>{if(this._ackMap.has(d.ackId)){const v=this._ackMap.get(d.ackId);this._ackMap.delete(d.ackId);const x=d.error!=null&&d.error.name==="Duplicate";d.success||x?v.resolve({ackId:d.ackId,isDuplicated:x}):v.reject(new Pt("Failed to send message.",{ackId:d.ackId,errorDetail:d.error}))}},c=async d=>{if(this._connectionId=d.connectionId,this._reconnectionToken=d.reconnectionToken,!this._isInitialConnected){if(this._isInitialConnected=!0,this._options.autoRejoinGroups){const v=[];this._groupMap.forEach(x=>{x.isJoined&&v.push((async()=>{try{await this._joinGroupCore(x.name)}catch(h){this._safeEmitRejoinGroupFailed(x.name,h)}})())});try{await Promise.all(v)}catch{}}this._safeEmitConnected(d.connectionId,d.userId)}},l=d=>{this._lastDisconnectedMessage=d},m=d=>{if(d.sequenceId!=null){const v=this._sequenceId.tryUpdate(d.sequenceId);if(v===0)return;v>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitGroupMessage(d)},f=d=>{if(d.sequenceId!=null){const v=this._sequenceId.tryUpdate(d.sequenceId);if(v===0)return;v>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitServerMessage(d)};let g;try{let d;if(Array.isArray(i)?d=Buffer.concat(i):d=i,g=this._protocol.parseMessages(d),g===null)return}catch(d){throw ye.warning("An error occurred while parsing the message from service",d),d}Array.isArray(g)||(g=[g]),g.forEach(d=>{try{switch(d.kind){case"ack":{r(d);break}case"connected":{c(d);break}case"disconnected":{l(d);break}case"groupData":{m(d);break}case"serverData":{f(d);break}}}catch(v){ye.warning(`An error occurred while handling the message with kind: ${d.kind} from service`,v)}})})})}async _handleConnectionCloseAndNoRecovery(){this._state=we.Disconnected,this._safeEmitDisconnected(this._connectionId,this._lastDisconnectedMessage),this._options.autoReconnect?await this._autoReconnect():await this._handleConnectionStopped()}async _autoReconnect(){let e=!1,s=0;try{for(;!this._isStopping;)try{await this._startFromRestarting(),e=!0;break}catch(n){ye.warning("An attempt to reconnect connection failed.",n),s++;const o=this._reconnectRetryPolicy.nextRetryDelayInMs(s);if(o==null)break;try{ye.verbose(`Delay time for reconnect attempt ${s}: ${o}`),await Ht(o)}catch{}}}finally{e||this._handleConnectionStopped()}}_handleConnectionStopped(){this._isStopping=!1,this._state=we.Stopped,this._safeEmitStopped()}_getActiveKeepaliveTask(){return new Pn(async()=>{this._sequenceId.tryUpdate(0)},this._activeTimeoutInMs)}async _sendMessage(e,s){if(!this._wsClient||!this._wsClient.isOpen())throw new Error("The connection is not connected.");const n=this._protocol.writeMessage(e);await this._wsClient.send(n,s)}async _sendMessageWithAckId(e,s,n){s==null&&(s=this.nextAckId());const o=e(s);this._ackMap.has(s)||this._ackMap.set(s,new $l(s));const i=this._ackMap.get(s);try{await this._sendMessage(o,n)}catch(r){this._ackMap.delete(s);let c="";throw r instanceof Error&&(c=r.message),new Pt(c,{ackId:s})}if(n)try{return await Fi(i.promise(),n)}catch(r){throw r instanceof Error&&r.name==="AbortError"?new Pt("Cancelled by abortSignal",{ackId:s}):r}return await i.promise()}async _handleConnectionClose(){if(this._ackMap.forEach((o,i)=>{this._ackMap.delete(i)&&o.reject(new Pt("Connection is disconnected before receive ack from the service",{ackId:o.ackId}))}),this._isStopping){ye.warning("The client is stopping state. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(this._lastCloseEvent&&this._lastCloseEvent.code===1008){ye.warning("The websocket close with status code 1008. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(!this._protocol.isReliableSubProtocol){ye.warning("The protocol is not reliable, recovery is not applicable"),this._handleConnectionCloseAndNoRecovery();return}const e=this._buildRecoveryUri();if(!e){ye.warning("Connection id or reconnection token is not available"),this._handleConnectionCloseAndNoRecovery();return}let s=!1;this._state=we.Recovering;const n=_a.timeout(30*1e3);try{for(;!n.aborted||this._isStopping;)try{await this._connectCore.call(this,e),s=!0;return}catch{await Ht(1e3)}}finally{s||(ye.warning("Recovery attempts failed more then 30 seconds or the client is stopping"),this._handleConnectionCloseAndNoRecovery())}}_safeEmitConnected(e,s){this._emitEvent("connected",{connectionId:e,userId:s})}_safeEmitDisconnected(e,s){this._emitEvent("disconnected",{connectionId:e,message:s})}_safeEmitGroupMessage(e){this._emitEvent("group-message",{message:e})}_safeEmitServerMessage(e){this._emitEvent("server-message",{message:e})}_safeEmitStopped(){this._emitEvent("stopped",{})}_safeEmitRejoinGroupFailed(e,s){this._emitEvent("rejoin-group-failed",{group:e,error:s})}_buildDefaultOptions(e){return e.autoReconnect==null&&(e.autoReconnect=!0),e.autoRejoinGroups==null&&(e.autoRejoinGroups=!0),e.protocol==null&&(e.protocol=ql()),this._buildMessageRetryOptions(e),this._buildReconnectRetryOptions(e),e}_buildMessageRetryOptions(e){e.messageRetryOptions||(e.messageRetryOptions={}),(e.messageRetryOptions.maxRetries==null||e.messageRetryOptions.maxRetries<0)&&(e.messageRetryOptions.maxRetries=3),(e.messageRetryOptions.retryDelayInMs==null||e.messageRetryOptions.retryDelayInMs<0)&&(e.messageRetryOptions.retryDelayInMs=1e3),(e.messageRetryOptions.maxRetryDelayInMs==null||e.messageRetryOptions.maxRetryDelayInMs<0)&&(e.messageRetryOptions.maxRetryDelayInMs=3e4),e.messageRetryOptions.mode==null&&(e.messageRetryOptions.mode="Fixed")}_buildReconnectRetryOptions(e){e.reconnectRetryOptions||(e.reconnectRetryOptions={}),(e.reconnectRetryOptions.maxRetries==null||e.reconnectRetryOptions.maxRetries<0)&&(e.reconnectRetryOptions.maxRetries=Number.MAX_VALUE),(e.reconnectRetryOptions.retryDelayInMs==null||e.reconnectRetryOptions.retryDelayInMs<0)&&(e.reconnectRetryOptions.retryDelayInMs=1e3),(e.reconnectRetryOptions.maxRetryDelayInMs==null||e.reconnectRetryOptions.maxRetryDelayInMs<0)&&(e.reconnectRetryOptions.maxRetryDelayInMs=3e4),e.reconnectRetryOptions.mode==null&&(e.reconnectRetryOptions.mode="Fixed")}_buildRecoveryUri(){if(this._connectionId&&this._reconnectionToken&&this._uri){const e=new URL(this._uri);return e.searchParams.append("awps_connection_id",this._connectionId),e.searchParams.append("awps_reconnection_token",this._reconnectionToken),e.toString()}return null}_getOrAddGroup(e){return this._groupMap.has(e)||this._groupMap.set(e,new Wl(e)),this._groupMap.get(e)}_changeState(e){ye.verbose(`The client state transfer from ${this._state.toString()} to ${e.toString()}`),this._state=e}async _operationExecuteWithRetry(e,s){let n=0;for(;;)try{return await e.call(this)}catch(o){n++;const i=this._messageRetryPolicy.nextRetryDelayInMs(n);if(i==null||(await Ht(i),s!=null&&s.aborted))throw o}}}class Nn{constructor(e){this._retryOptions=e,this._maxRetriesToGetMaxDelay=Math.ceil(Math.log2(this._retryOptions.maxRetryDelayInMs)-Math.log2(this._retryOptions.retryDelayInMs)+1)}nextRetryDelayInMs(e){return e>this._retryOptions.maxRetries?null:this._retryOptions.mode==="Fixed"?this._retryOptions.retryDelayInMs:this._calculateExponentialDelay(e)}_calculateExponentialDelay(e){return e>=this._maxRetriesToGetMaxDelay?this._retryOptions.maxRetryDelayInMs:(1<<e-1)*this._retryOptions.retryDelayInMs}}class Wl{constructor(e){this.isJoined=!1,this.name=e}}class $l{constructor(e){this._promise=new Promise((s,n)=>{this._resolve=s,this._reject=n}),this.ackId=e}promise(){return this._promise}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}class Kl{constructor(){this._sequenceId=0,this._isUpdate=!1}tryUpdate(e){if(this._isUpdate=!0,e>this._sequenceId){const s=e-this._sequenceId;return this._sequenceId=e,s}return 0}tryGetSequenceId(){return this._isUpdate?(this._isUpdate=!1,[!0,this._sequenceId]):[!1,null]}reset(){this._sequenceId=0,this._isUpdate=!1}}class Pn{constructor(e,s,n){this._func=e,this._abortController=new _a,this._interval=s,this._obj=n,this._start()}abort(){try{this._abortController.abort()}catch{}}async _start(){const e=this._abortController.signal;for(;!e.aborted;)try{await this._func(this._obj)}catch{}finally{await Ht(this._interval)}}}const Zl=1e3*60*60,Jl=1e3*30;class Yl{constructor(e,s,n,o=null,i=new Map){z(this,"client");z(this,"handler");z(this,"terminationTimeout",null);z(this,"connectionUrl");z(this,"expiresAt");z(this,"connected",!1);z(this,"websocketRequestId",null);z(this,"conversationId",null);z(this,"secondaryTypeBasedHandlers",new Map);this.connectionUrl=s,this.expiresAt=n,this.client=new Vl({getClientAccessUrl:()=>e(this.connectionUrl,this.expiresAt)},{autoReconnect:!0,reconnectRetryOptions:{maxRetries:5,retryDelayInMs:100,maxRetryDelayInMs:1e4,mode:"Exponential"}}),this.handler=o,this.secondaryTypeBasedHandlers=i}async start(){const e=s=>{if(this.secondaryTypeBasedHandlers.has(s.message.data.type)){const n=this.secondaryTypeBasedHandlers.get(s.message.data.type);if(!n)return;n(s.message.data)}else{const n=s.message.data.body,o=atob(n).trim();if(o.startsWith("data: ")){const i=o.replace("data: ",""),r=this.handler;if(!r)return;r({conversationId:s.message.data.conversation_id,responseId:s.message.data.response_id,message:{id:"",event:"",data:i},websocketRequestId:s.message.data.websocket_request_id})}}};this.client.on("group-message",s=>e(s)),this.client.on("server-message",s=>e(s)),this.client.on("connected",()=>{this.connected=!0}),this.client.on("disconnected",()=>{this.connected=!1}),await this.client.start()}addSecondaryTypeHandler(e,s){this.secondaryTypeBasedHandlers.set(e,s)}isConnected(){return this.connected}async stop(e){e&&this.conversationId!==e||this.websocketRequestId&&await Ze.stopWebsocketConversation(this.websocketRequestId)}setHandler(e,s,n,o){!this.handler&&this.websocketRequestId===n||(this.handler!=null&&this.websocketRequestId!==n&&(Vo.warn("[websockets] Overwriting existing handler without silencing. This may indicate a race condition."),O.logEvent(A.asyncHandlerOverwritten,{originalWebsocketRequestId:this.websocketRequestId,newWebsocketRequestId:n,conversationId:e,responseId:s})),this.websocketRequestId=n,this.conversationId=e,this.handler=i=>{(i.websocketRequestId===n||i.conversationId===e&&i.responseId===s)&&o(i.message)})}silence(){this.handler=null}close(){this.client.stop()}scheduleForTermination(e){this.terminationTimeout=setTimeout(()=>{this.close(),e()},Zl)}preventTermination(){this.terminationTimeout&&(clearTimeout(this.terminationTimeout),this.terminationTimeout=null)}updateConnectionUrl(e,s){this.connectionUrl=e,this.expiresAt=s}}class Ql{constructor(){z(this,"activeSocketMap",new Map);z(this,"secondaryTypeBasedHandlers",new Map)}async register(){const e=await Ze.postRegisterWebsocket();e.wss_url&&(this.getOrCreateSocket(e.wss_url,new Date(e.expires_at),!0),e.fallback_wss_url&&this.getOrCreateSocket(e.fallback_wss_url,new Date(e.expires_at),!1))}async registerIfNotConnected(){if(this.activeSocketMap.size===0){await this.register();return}for(const e of this.activeSocketMap.values())if(!e.isConnected()){await this.register();return}}isWebsocketConnected(){for(const e of this.activeSocketMap.values())if(e.isConnected())return!0;return this.activeSocketMap.size>0&&De.addError("Cannot connect to any websocket."),!1}async getOrCreateSocket(e,s,n){const o=e.split("?")[0];let i;const r=this.activeSocketMap.get(o);if(r&&r.isConnected())r.preventTermination(),r.updateConnectionUrl(e,s),i=r;else{r&&r.close(),i=new Yl(async(c,l)=>{if(new Date<new Date(l.getTime()-5*1e3))return c;const m=await Ze.postRegisterWebsocket();return n?m.wss_url:m.fallback_wss_url??""},e,s,null,this.secondaryTypeBasedHandlers),this.activeSocketMap.set(o,i);try{await i.start()}catch(c){throw De.addError(new Error("Error occurred while starting websocket: ",{cause:c})),c}}return i}preSetupWebsocket(e,s,n){for(const o of this.activeSocketMap.values())this.setupWebSocketHandler(o,null,null,null,e,s,n)}addSecondaryTypeHandler(e,s){this.secondaryTypeBasedHandlers.set(e,s);for(const n of this.activeSocketMap.values())n.addSecondaryTypeHandler(e,s)}hasSecondaryTypeHandler(e){return this.secondaryTypeBasedHandlers.has(e)}async processWebSocketConversationStream(e,s,n,o,i,r,c,l,m){const f=[this.getOrCreateSocket(e,n,!0)];s&&f.push(this.getOrCreateSocket(s,n,!1));const g=await Promise.allSettled(f),d=g[0].status==="fulfilled"?g[0].value:null,v=g.length>1&&g[1].status==="fulfilled"?g[1].value:null;if((!d||!d.isConnected())&&De.addError(`Cannot connect to primary websocket, websocketRequestId: ${r}, token: ${e.substring(0,e.indexOf("access_token="))}`),(!d||!d.isConnected())&&(!v||!v.isConnected()))throw s&&De.addError(`Cannot connect to fallback websocket, websocketRequestId: ${r}, token: ${s.substring(0,s.indexOf("access_token="))}`),new We(`An error occurred while connecting to the websocket. ${ps}`);let x=setTimeout(()=>{De.addError(`WebSocket took too long to respond: ${i}, ${o}, ${r}, ${e.substring(0,60)}...${e.slice(-20)}`,{supportsWebSockets:"WebSocket"in window&&window.WebSocket.CLOSING===2})},Jl);const h=S=>(m&&(clearTimeout(m),m=null),x&&(clearTimeout(x),x=null),c(S));d&&this.setupWebSocketHandler(d,e,o,i,r,h,l),v&&s&&this.setupWebSocketHandler(v,s,o,i,r,h,l)}async stopConversation(e){for(const s of this.activeSocketMap.values())await s.stop(e)}setupWebSocketHandler(e,s,n,o,i,r,c){e.setHandler(n,o,i,r),this.secondaryTypeBasedHandlers.forEach((m,f)=>{e.addSecondaryTypeHandler(f,m)});const l=()=>{s?e.scheduleForTermination(()=>{this.activeSocketMap.delete(s.split("?")[0])}):(this.stopConversation(n),e.silence())};c.addEventListener("abort",l)}}const Ct=new Ql;function Xl(t){return{webSocketUrl:t.wss_url,fallbackWebSocketUrl:t.fallback_wss_url,conversationId:t.conversation_id,responseId:t.response_id,expiresAt:t.expires_at&&new Date(t.expires_at),websocketRequestId:t.websocket_request_id}}async function ed(t,e,s){return Ct.preSetupWebsocket(t,e,s)}async function td(t,e,s,n,o,i,r,c,l){return Ct.processWebSocketConversationStream(t,e,s,n,o,i,r,c,l)}function sd(t){return t==null||[Ce.PrimaryAssistant,Ce.GizmoInteraction].includes(t.kind)}function Zs(t,e){const s=Vs(t,e),{data:n}=$s(s!=null&&"gizmo_id"in s?s.gizmo_id:void 0,(s==null?void 0:s.kind)===Ce.GizmoTest);if(s!=null)switch(s.kind){case Ce.GizmoInteraction:case Ce.GizmoMagicCreate:case Ce.GizmoTest:return{gizmo:n,...s};case Ce.PrimaryAssistant:return s}}function nd(t,e,s){const o=C.getTree(e).getMessageId(C.getThreadCurrentLeafId(e));Ze.generateTitle(e,o,s).then(({title:i})=>{C.setTitle(e,i,qa.Generated),Qa(t),O.logEvent(A.renameThread,{threadId:e,content:i,model:s})}).catch(De.addError)}function ad(t,e,s){const n=()=>{const i=Rn(s);t(i)},o=Oe.getGizmoId(s);o!=null?al(e,o).then(i=>{Oi(Rn(s,i))}).catch(i=>{De.addError(i),n()}):n()}const Cs={onCreate(t,e,s,n){O.logEvent(A.newThread),!n&&sd(Oe.getConversationMode(e))&&ea(s).then(o=>{ta(o)||(Qa(s),ad(t,s,e))})},onCreateFinished(t,e,s){var n;if(!(s||!e)&&!He.checkGate("2562876640")){const o=(n=Oe.getThread(e))==null?void 0:n.initialThreadData.lastModelUsed;o==null&&De.addError("missing lastModelUsed on conversation create finished"),nd(t,e,o)}}},Dn=Ae.div`m-8 flex flex-col items-center`;function Fn(t){return a.jsx(ge.div,{initial:{opacity:0,translateY:20},animate:{opacity:1,translateY:0,transition:{duration:.5,ease:"easeIn"}},...t})}function od({clientThreadId:t}){const e=Dc(t),s=e==null?void 0:e.gizmoId,{data:n}=$s(s);return s==null||n==null||!Li(n)?null:a.jsx(id,{gizmoId:s})}function id({gizmoId:t}){const[e,s]=u.useState(!1),[n,o]=u.useState(!1),i=ol(t),r=async l=>{s(!0),setTimeout(()=>{o(!0)},5e3),O.logEvent(A.submitInlineRating,{gizmo_id:t,rating:l}),await i.mutateAsync({rating:l})},c=async()=>{o(!0),O.logEvent(A.dismissInlineRating,{gizmo_id:t}),await i.mutateAsync({})};return u.useEffect(()=>{n||O.logEvent(A.showInlineRating,{gizmo_id:t})},[n,t]),n?null:e?a.jsx(Dn,{children:a.jsxs(Fn,{className:"flex flex-col items-center gap-4",children:[a.jsx("div",{className:"rounded-lg border border-token-border-heavy p-4",children:a.jsxs("div",{className:"flex justify-between gap-2",children:[a.jsx(U,{id:"gizmo.inlineReview.reviewLeft",defaultMessage:"Feedback sent"}),a.jsx(yn,{onClick:()=>{o(!0)}})]})}),a.jsx("div",{className:"text-xs text-token-text-tertiary",children:a.jsx(U,{id:"gizmo.inlineReview.reviewLeftSubtext",defaultMessage:'To update your rating, click "Send Feedback" in the GPT Menu'})})]})}):a.jsx(Dn,{children:a.jsxs(Fn,{className:"flex flex-col items-center gap-4 rounded-lg border border-token-border-heavy p-4",children:[a.jsxs("div",{className:"flex justify-between gap-2",children:[a.jsx(U,{id:"gizmo.inlineReview.prompt",defaultMessage:"How would you rate this GPT so far?"}),a.jsx(yn,{onClick:c})]}),a.jsx(hl,{rating:void 0,onRating:r})]})})}function rd(t,e){const s=Qt(Xt.MentionGPTs),n=Bi(),[o,i]=u.useState(!1),r=()=>{i(!0),s.markAsViewed()};return u.useImperativeHandle(e,()=>({handleClose:r})),s.eligible&&!s.isLoading&&!n?a.jsx(cd,{wasDismissed:o,onDismiss:r}):null}function cd({wasDismissed:t,onDismiss:e}){const s=re(),{recent:n,pinned:o}=gl(),i=n&&n.pages.flatMap(r=>r.list.items).length>0||o&&o.items.length>0;return u.useEffect(()=>{i&&O.logEvent(A.mentionsDisplayNux)},[i]),i?a.jsx(va,{badge:"beta",align:"start",side:"top",arrowPadding:58,show:!t,title:s.formatMessage({id:"mentionGptsAnnouncement.title",defaultMessage:"GPT mentions"}),onDismiss:e,sideOffset:25,theme:"default",description:a.jsx(U,{id:"mentionGptsAnnouncement.description",defaultMessage:"Type {key} to mention a GPT and add it directly into your conversation",values:{key:a.jsx("span",{className:"font-bold",children:"@"})}}),children:a.jsx("div",{className:"absolute sm:left-16"})}):null}const ld=u.forwardRef(rd);function dd({composerController:t}){const{doesUserHaveAnyAccountsWithPlusFeatures:e}=Wo(),s=re(),n=Ps();return a.jsxs("div",{className:G("flex justify-between",!n&&"bg-gradient-to-t from-token-main-surface-primary to-transparent px-4"),children:[a.jsx("div",{className:"flex gap-2",children:a.jsx(md,{onClickStyle:o=>{Ln(s.formatMessage(o.expandedName??o.name),t)}})}),e&&a.jsx("div",{className:"flex gap-2",children:a.jsx(ud,{onClickAspectRatio:o=>Ln(s.formatMessage(o.expandedName),t)})})]})}function ud({onClickAspectRatio:t}){const e=re();return a.jsxs(Q.Root,{onOpenChange:s=>{s&&(He.logEvent(A.dalleOpenAspectRatioDropdown),O.logEvent(A.dalleOpenAspectRatioDropdown))},children:[a.jsxs(Is,{$as:Q.Trigger,className:"pr-1.5",children:[a.jsx(U,{id:"dalleControls.aspectRatio",defaultMessage:"Aspect Ratio"}),a.jsx(Ka,{className:"icon-md"})]}),a.jsx(Q.Portal,{children:a.jsx(Q.Content,{children:zi.map(s=>a.jsx(Q.Item,{onClick:()=>{var n;t(s),He.logEvent(A.dalleClickAspectRatio,(n=s.name.defaultMessage)==null?void 0:n.toString()),O.logEvent(A.dalleClickAspectRatio,{aspectRatio:s.name.defaultMessage})},icon:s.icon,children:e.formatMessage(s.name)},s.name.id))})})]})}function md({onClickStyle:t}){const[e,s]=u.useState(On()),n=$o(),o=Ko(),i=es(),r=re();let c=2;return i||(o?c=5:n&&(c=3)),a.jsxs(a.Fragment,{children:[e.slice(0,c).map(l=>a.jsx(Ds,{label:a.jsx(fd,{style:l}),side:"top",sideOffset:4,customPaddingClassName:"p-1",children:a.jsxs(Is,{$as:"button",type:"button",onClick:()=>{var m;t(l),He.logEvent(A.dalleClickStyle,(m=l.name.defaultMessage)==null?void 0:m.toString()),O.logEvent(A.dalleClickStyle,{style:l.name.defaultMessage})},children:[a.jsx($c,{className:"h-4 w-4 text-token-text-tertiary"}),r.formatMessage(l.name)]})},l.name.id)),a.jsx(Is,{$as:"button",type:"button",onClick:()=>{s(On()),He.logEvent(A.dalleShuffleStyles),O.logEvent(A.dalleShuffleStyles)},children:a.jsx(Ui,{className:"icon-sm text-token-text-tertiary"})}),ba.map(l=>a.jsx("img",{src:l.image.src,alt:r.formatMessage(l.name),width:100,height:100,className:"invisible fixed -left-96 -top-96"},l.name.id))]})}function fd({style:t}){const e=re();return a.jsxs("div",{className:"flex flex-col gap-1",children:[a.jsx("img",{src:t.image.src,alt:e.formatMessage(t.name),width:100,height:100,className:"rounded-md"}),a.jsx("div",{className:"text-xs font-medium",children:e.formatMessage(t.name)})]})}function On(){return[...ba].sort(()=>Math.random()-.5)}function hd(t,e){const s=e.getCurrentText();return s.trim()===""?t:s.endsWith(",")?` ${t.toLocaleLowerCase()}`:s.endsWith(", ")?t.toLocaleLowerCase():`, ${t.toLocaleLowerCase()}`}function Ln(t,e){const s=hd(t,e);e.appendText(s),$t()}const Is=Ae.div`h-7 bg-token-main-surface-primary border border-token-border-light text-xs hover:bg-token-main-surface-secondary hover:text-token-text-primary px-2.5 radix-state-open:bg-token-main-surface-secondary radix-state-open:text-token-text-primary rounded-full flex flex-nowrap gap-0.5 items-center text-token-text-secondary font-normal`,Lt={initial:{opacity:0,y:20,scale:.9},animate:{opacity:1,y:0,scale:1},transition:{delay:.1},exit:{opacity:0,scale:.5,transition:{duration:.2}}},gd=({suggestions:t,onSelectingSuggestedReply:e})=>a.jsx("div",{className:"absolute bottom-full flex w-full max-w-[100vw] grow gap-2 overflow-auto px-1 pb-1 contain-inline-size sm:mb-0 sm:justify-start sm:px-2 sm:pb-0 md:static md:mb-2 md:max-w-none md:justify-center md:overflow-visible",children:t.slice(0,2).map((s,n)=>a.jsx(ge.div,{initial:Lt.initial,animate:Lt.animate,transition:{delay:(n-1)*Lt.transition.delay},exit:Lt.exit,children:a.jsx(wt,{as:"button",color:"secondary",size:"small",onClick:()=>{e(s,t,n)},className:"group whitespace-nowrap md:whitespace-normal",children:a.jsx(xd,{suggestion:s})},n)},n))});function pd({suggestions:t,onSelectingSuggestedReply:e,clientThreadId:s}){const n=(t==null?void 0:t.length)>0;u.useEffect(()=>{n&&vl(t,s)},[n,s]);const{isUnauthenticated:o}=St();return n?t.every(Xa)?a.jsxs(ge.div,{initial:{opacity:0},animate:{opacity:1},transition:{duration:.3},className:"flex flex-col items-center",children:[o&&a.jsx(Zo,{className:"mb-6 h-12 w-12 sm:hidden"}),a.jsx(bl,{starterPrompts:t,onSelectStarterPrompt:e})]}):t.every(eo)?a.jsx(gd,{suggestions:t,onSelectingSuggestedReply:e}):null:null}function xd({suggestion:t}){return eo(t)?a.jsx(a.Fragment,{children:t.text}):Xa(t)?a.jsxs("div",{className:"flex flex-col overflow-hidden",children:[t.title&&a.jsx("div",{className:"truncate font-semibold",children:t.title}),a.jsx("div",{className:G("truncate font-normal",t.title?"opacity-50":""),children:t.body})]}):null}function yd(){const{store:t}=Ne(),e=t.useSharedProps();return e?a.jsx(_d,{...e}):null}function _d({clientThreadId:t,suggestions:e}){const s=to();return e===void 0||e.length===0?null:a.jsx("div",{children:a.jsx(vd,{children:a.jsx("div",{className:"grow",children:e!==void 0&&a.jsx(pd,{suggestions:e,onSelectingSuggestedReply:s,clientThreadId:t})})})})}const vd=Ae.div`h-full flex ml-1 md:w-full md:m-auto gap-0 md:gap-2 justify-center`,oo=({className:t,children:e})=>a.jsx(ge.div,{className:t,initial:{opacity:0},animate:{opacity:1},exit:{opacity:0,transition:{duration:.1,delay:0}},transition:{type:"tween",duration:.3,delay:.2},children:e});function bd({currentLeafId:t,canContinue:e,onContinueGenerating:s}){const n=u.useCallback(()=>{const i=new Fs;s(t,i),$t()},[s,t]);let o=null;return e&&(o=a.jsx(Sd,{onHandleContinueGenerating:n})),o&&a.jsx("div",{className:"flex h-full w-full items-center justify-end gap-0 py-4 md:gap-2",children:o})}const Sd=({onHandleContinueGenerating:t})=>{const e=sa();return a.jsx(oo,{children:a.jsxs(wt,{as:"button",color:"secondary",onClick:t,className:"whitespace-nowrap border-0 md:border",children:[a.jsx(Za,{className:G("-rotate-180",e?"icon-xs":"icon-sm")}),e&&a.jsx(U,{...Fe.continueGenerating})]})})},wd=({clientThreadId:t})=>{const e=na(),s=ns(t),n=Os(s);u.useEffect(()=>{n&&xs.dismissBanner()},[n]);const o=e!=null&&e.is_dismissible?()=>xs.dismissBanner():void 0;return a.jsx(ct,{children:e&&a.jsx(ge.div,{transition:{type:"tween",ease:"easeInOut",duration:.1},initial:{opacity:0,transform:"translateY(8px)"},animate:{opacity:1,transform:"translateY(0px)"},exit:{opacity:0,transform:"translateY(8px)"},children:a.jsx(pl,{clientThreadId:t,rateLimitInfo:e,onDismiss:o})})})};function kd(t){const e=ns(t),s=Os(e),n=na();return!s&&n!=null}const Ue=window.sessionStorage,Ts=aa(Jo(()=>({memoryFullBannerDismissed:!!(Ue!=null&&Ue.getItem(yt.MemoryFullBannerDismissed))}))),io={dismissBanner(){Ts.setState(t=>{t.memoryFullBannerDismissed=!0}),Ue==null||Ue.setItem(yt.MemoryFullBannerDismissed,"true")},clearDismissedBanner(){Ts.setState(t=>{t.memoryFullBannerDismissed=!1}),Ue==null||Ue.removeItem(yt.MemoryFullBannerDismissed)}};function Cd(t){const e=Va(t),s=Gi(),{data:n}=Hi(e,!1,s),o=n!=null,i=o&&n.memoryFullPct>=100,[r,c]=u.useState(!1);u.useEffect(()=>{!i&&o&&(c(!0),io.clearDismissedBanner())},[i,o]);const l=Ts(m=>m.memoryFullBannerDismissed);return i&&r&&!l}function Id(){const t=re(),{openSettings:e}=qi();return a.jsx(ge.div,{initial:{opacity:0},animate:{opacity:1},children:a.jsx(Vi,{title:t.formatMessage(Bt.memoryFullTitle),content:t.formatMessage(Bt.memoryFullTooltip,Bt.memoryFullTooltip.values),primaryCtaText:t.formatMessage(Bt.memoryManageButton),onPrimaryCtaClick:()=>e(Wi.Personalization),onDismiss:()=>io.dismissBanner()})})}const Bt=Re({memoryFullTitle:{id:"yRGU2/",defaultMessage:"Memory is full."},memoryManageButton:{id:"a5A88o",defaultMessage:"Manage"},memoryFullTooltip:{id:"neUc+N",defaultMessage:"New memories won’t be created until you make space. <a>Learn more</a>",values:{a:t=>a.jsx("a",{href:$i,target:"_blank",rel:"noopener noreferrer",className:"underline",children:t})}}}),Td=()=>{const{shouldShowSkipButton:t}=Ki();return t?a.jsx(oo,{className:"flex justify-center",children:a.jsx(wt,{as:"button",color:"secondary",onClick:()=>Zi.skipParagen(),children:a.jsx(U,{...jd.skip})})}):null},jd=Re({skip:{id:"dvcUbp",defaultMessage:"Skip"}}),Md=u.memo(function({className:e}){const{store:s}=Ne(),n=s.useIsHeaderContentAreaPopulated();return a.jsx("div",{className:G(e??"absolute bottom-full left-0 right-0",vs.PromptTextareaHeader),children:a.jsx(Ji,{shouldRender:n,contentArea:vt.Header,children:a.jsxs("div",{className:"mb-2 flex flex-col gap-3.5 pt-2",children:[a.jsx(Rd,{}),a.jsx(Ed,{})]})})})});function Rd(){const{store:t}=Ne(),e=t.useContentAreaId(vt.HeaderTop);let s;switch(e){case he.ParagenControls:s=a.jsx(Td,{});break;case he.ItemActions:s=a.jsx(yd,{});break;case he.BannerSignup:s=a.jsx(Nd,{});break;case he.BannerTermsDisclaimer:s=a.jsx(Pd,{});break;case he.PromptTextareaAction:s=a.jsx(Dd,{});break;case he.BannersRateLimit:s=a.jsx(Fd,{});break;case he.BannerSidekickAnnouncement:s=a.jsx(yl,{});break;case he.BannerMemoryFull:s=a.jsx(Id,{});break;case he.Box:s=a.jsxs("div",{className:"flex h-20 w-full items-center justify-center gap-2 bg-red-500 p-2",children:["box",a.jsxs("div",{className:"flex h-full w-full items-center justify-center gap-2 bg-blue-500 p-2",children:["inner",a.jsx("div",{className:"flex h-full w-full items-center justify-center bg-yellow-400 text-center",children:"actual content"})]})]});break;default:s=null;break}return s}function Ed(){const{store:t}=Ne(),e=t.useContentAreaId(vt.HeaderBottom);let s;switch(e){case Sa.DallePromptControls:s=a.jsx(Ad,{});break;default:s=null;break}return s}function Ad(){const{store:t}=Ne(),e=t.useSharedProps(s=>s==null?void 0:s.composerController);return e?a.jsx(dd,{composerController:e}):null}function Nd(){const{store:t}=Ne(),e=t.useSharedProps(o=>o==null?void 0:o.clientThreadId),s=Yi(),n=Qi();return e?s?a.jsx(Xi,{threadId:e,showSignUp:n}):a.jsx(er,{threadId:e,showLogin:n}):null}function Pd(){const{store:t}=Ne(),e=t.useSharedProps(s=>s==null?void 0:s.clientThreadId);return e?a.jsx(tr,{threadId:e}):null}function Dd(){const{store:t}=Ne(),e=t.useSharedProps();return e?a.jsx(bd,{...e}):null}function Fd(){const{store:t}=Ne(),e=t.useSharedProps(s=>s==null?void 0:s.clientThreadId);return e?a.jsx(wd,{clientThreadId:e}):null}function Js(){return oa(Ms.DataAnalysisV2)}function uf(){const t=wa(),e=js();return e&&t&&!Yo(t)&&e.isEnterprise()}function Od(){return oa(Ms.ChartSerialization)}function mf(t,e){const s=t==="chart"?yt.HasSeenAdaInteractiveChart:yt.HasSeenAdaInteractiveTable,[n,o]=u.useState(_n.getItem(s,{userId:e})??!1),i=u.useCallback(()=>{o(!0),_n.setItem(s,!0,{userId:e})},[s,e]);return[n,i]}function ff(t){const[e,s]=u.useState([]),n=lt(()=>{const o=C.resolveThreadId(t),i=C.getThreadCurrentLeafId(t);return C.getTree(o).getBranchFromLeaf(i)});return u.useEffect(()=>{const o=co(n);o.length!==e.length&&s(o)},[e.length,t,n]),e}function Ld(t){return lt(()=>{const e=C.resolveThreadId(t),s=C.getThreadCurrentLeafId(t),o=C.getTree(e).getBranchFromLeaf(s);return co(o).length>0})}function ro(t){var i,r,c,l;const e=((r=(i=t.metadata)==null?void 0:i.aggregate_result)==null?void 0:r.messages.filter(no))??[];let s=0;const n=(((c=t.metadata)==null?void 0:c.ada_visualizations)??[]).map(m=>{let f=m;return m.type=="chart"&&(f={...m,fallback_image:e[s++]}),f}),o=(((l=t.metadata)==null?void 0:l.attachments)??[]).filter(m=>Ca(m.name)).map(m=>({type:"table",file_id:m.id??"",title:nr(m),file_name:m.name,context_connector_info:m.context_connector_info}));return[...n,...o]}function co(t){return t.filter(s=>{var n,o,i,r;return((n=s.message)==null?void 0:n.author.role)==="tool"&&((o=s.message)==null?void 0:o.author.name)==="python"||(((r=(i=s.message)==null?void 0:i.metadata)==null?void 0:r.attachments)??[]).length>0}).flatMap(s=>ro(s.message))}aa(t=>({selectedSpreadsheet:null,setSelectedSpreadsheet:e=>t({selectedSpreadsheet:e})}));async function Bd(t,e,s){const n=await t.text(),{parse:o}=await ce(async()=>{const{parse:r}=await import("./oeujip5i1ptrxie5.js");return{parse:r}},[]),i=o(n);return{content:{columnNames:i.shift(),columnTypes:i[0].map(()=>"string"),rows:i},file_name:e,download_url:s}}function zd(t){const e=t[0].values.length,s=[];for(let n=0;n<e;n++){const o=t.map(i=>i.values[n]);s.push(o)}return s}function hf(t){return ia({queryKey:["ada-visualization","chart",t.file_id],queryFn:async()=>{const e=await Ze.getFileDownloadLink(t.file_id);if(e.status===ra.Success){const n=await(await fetch(e.download_url)).json();return{content:{chart_type:n.type,title:n.title,labels:n.labels,datasets:n.datasets,x_label:n.x_label,y_label:n.y_label},file_name:e.file_name??"",download_url:e.download_url}}else throw new Error("Failed to download chart json from interpreter")}})}function gf(t){return ia({queryKey:["ada-visualization","table",t.file_id],queryFn:async()=>{if(t.file_name&&sr(t.file_name)){const e=await Ze.getAdaExcelFileContents(t.file_id);return{content:e.sheets.map(s=>({name:s.name,columnNames:s.columns.map(n=>n.name),columnTypes:s.columns.map(()=>"string"),rows:zd(s.columns)})),download_url:e.download_url,file_name:t.file_name}}else{const e=await Ze.getFileDownloadLink(t.file_id);if(e.status===ra.Success){const s=await fetch(e.download_url);return Bd(s,e.file_name??"",e.download_url)}else throw new Error("Failed to download from interpreter")}}})}function Ud(t){const e=ka(),s=Ld(t),n=Js();return s&&n&&!e.displayingSideBySideFeedback}function Gd(t){var e,s;return((s=(e=t.metadata)==null?void 0:e.dalle)==null?void 0:s.prompt)??""}async function Hd(t,e,s="image/png"){return new Promise((n,o)=>{t.toBlob(i=>{i!=null?n(new File([i],e,{type:s})):o(new Error("Failed to convert canvas to blob"))},s)})}async function qd(t,e){const s=document.createElement("canvas");s.width=t.width,s.height=t.height;const n=s.getContext("2d");if(n==null)throw new Error("Failed to get 2d context for mask canvas");const o=n.createImageData(t.width,t.height);for(let i=0;i<t.data.length;i+=4)t.data[i+3]!==0?(o.data[i]=0,o.data[i+1]=0,o.data[i+2]=0,o.data[i+3]=255):(o.data[i]=255,o.data[i+1]=255,o.data[i+2]=255,o.data[i+3]=255);return n.putImageData(o,0,0),Hd(s,e)}async function Vd(t,e){const n=await(await fetch(t)).blob(),o=document.createElement("a");o.href=URL.createObjectURL(n),o.download=e,o.click(),o.remove()}function Wd(t){const e=ir(new Date,"yyyy-MM-dd HH.mm.ss");let s=t.slice(0,150);return s.endsWith(".")&&(s=s.slice(0,-1)),`DALL·E ${e} - ${s}.webp`}async function pf(t,e,s){var i,r,c,l,m,f,g,d,v,x;const n=Gd(t),o=Wd(n);await Vd(t.url,o),He.logEvent("chatgpt_dalle_image_download",null,{sourceOperation:((r=(i=t.metadata)==null?void 0:i.dalle)==null?void 0:r.edit_op)??"none",hasParent:((l=(c=t.metadata)==null?void 0:c.dalle)==null?void 0:l.parent_gen_id)!=null?"true":"false"}),O.logEvent(A.dalleImageDownload,{conversationId:e,messageId:s,generationId:(f=(m=t.metadata)==null?void 0:m.dalle)==null?void 0:f.gen_id,parentGenerationId:(d=(g=t.metadata)==null?void 0:g.dalle)==null?void 0:d.parent_gen_id,fileId:ts(t.asset_pointer),sourceOperation:(x=(v=t.metadata)==null?void 0:v.dalle)==null?void 0:x.edit_op})}function $d(t){const e=Zs(t),s=es(),n=e&&"gizmo"in e?e.gizmo:void 0;return!s&&(n==null?void 0:n.gizmo.id)===ar}function xf(t,e){var o,i;const s=(i=(o=e.metadata)==null?void 0:o.dalle)==null?void 0:i.gen_id,n=ts(e.asset_pointer);return n==null||s==null?t:{...t,messageMetadata:{...t.messageMetadata,dalle:{from_client:{operation:{type:"transformation",original_gen_id:s,original_file_id:n}}}}}}async function Kd(t,e,s){return new Promise((n,o)=>{or(Ia(t),t,e,{kind:Qo.DalleAgent},{onFileCreated:ys,onFileUploadProgress:ys,onFileUploaded:(i,r)=>n(r),onError:(i,r)=>{o(new Error(`Failed to upload file with reason: ${r}`))}},s)})}async function yf(t,e,s,n){var r,c;const o=(c=(r=e.metadata)==null?void 0:r.dalle)==null?void 0:c.gen_id,i=ts(e.asset_pointer);if(i==null||o==null||s==null)return t;try{const l=await qd(s,"mask.png"),m=await Kd(l,n,{imageDimensions:{width:e.width,height:e.height}});return{...t,messageMetadata:{...t.messageMetadata,dalle:{from_client:{operation:{type:"inpainting",original_gen_id:o,original_file_id:i,mask_file_id:m}}}}}}catch(l){return De.addError(l),t}}const Zd=u.memo(function(e){return Jd(e),Yd(e),Qd(),null});function Jd(t){const{store:e}=Ne(),s=e.useSetSharedProps();u.useLayoutEffect(()=>{s(t)},[t,s])}function Yd(t){const{clientThreadId:e,canContinue:s}=t,{store:n}=Ne(),o=u.useRef({top:n.useContentAreaApi(vt.HeaderTop),bottom:n.useContentAreaApi(vt.HeaderBottom)}).current,i=tu(t),r=$d(e),{shouldShowBannerSignup:c,shouldShowBannerTermsDisclaimer:l}=su(e),m=kd(e),f=_l(t),g=Cd(e),d=rr();u.useLayoutEffect(()=>{d?o.top.set(he.ParagenControls):l?o.top.set(he.BannerTermsDisclaimer):m?o.top.set(he.BannersRateLimit):f.eligible?o.top.set(he.BannerSidekickAnnouncement):i?o.top.set(he.ItemActions):s?o.top.set(he.PromptTextareaAction):c?o.top.set(he.BannerSignup):g?o.top.set(he.BannerMemoryFull):o.top.set(null)},[o,i,s,l,c,m,f,g,d]),u.useLayoutEffect(()=>{r&&o.bottom.set(Sa.DallePromptControls)},[o,r])}function Qd(){const{store:t}=Ne();u.useEffect(()=>()=>{t.reset()},[t])}function Xd(t){var o,i;const e=Ta(),s=dt(t),n=(i=(o=C.getTree(t).getLastValidNode(s))==null?void 0:o.message)==null?void 0:i.id;return(e==null?void 0:e.messageId)===n?e.suggestions:[]}function eu(t){return Xd(t).length>0}function tu(t){const e=Ud(t.clientThreadId),s=eu(t.clientThreadId);return t.isDisabled?!1:t.isNewThread||e||s}function su(t){var g;const{isUnauthenticated:e}=St(),s=dt(t),{layer:n}=Xo("3637408529"),o=n.get("should_show_no_auth_signup_banner",!0),i=cr(d=>d.bannerDisclaimerClientThreadId),r={shouldShowBannerTermsDisclaimer:!1,shouldShowBannerSignup:!1};if(!t)return r;const c=C.getTree(t),l=c.countMessagesByAuthor(be.User),m=c.getNodeByIdOrMessageId(s),f=((g=m==null?void 0:m.message)==null?void 0:g.author.role)===be.Assistant&&Rs(m.message);return r.shouldShowBannerTermsDisclaimer=f&&e&&l===1&&(i==null||i===t),r.shouldShowBannerSignup=o&&f&&e&&l>0&&l%5===0,r}function nu(t,e,s,n,o){const{getGizmoId:i}=ss(),[r,c]=u.useState();u.useEffect(()=>{i?i().then(f=>c(f)):c(void 0)},[i]);const l=ca(e);return u.useCallback(f=>{const{docsReferencedByURL:g}=Oe.getThread(t)??{};if(g!=null)for(const d of f){const{id:v,type:x,handler:h}=d,S=`${x}:${v}`,M=g[S],T=bt.getState().files.find(y=>y.tempId===v);if(M!=null&&M!=="failed"&&T){qt.success(s.formatMessage(ms.fileAlreadyAttached),{hasCloseButton:!0});continue}switch(h.type){case"fetch":{C.updateReferencedDocState(t,S,"pending"),$e.uploadFile(v,new File([],s.formatMessage(ms.fileLoading)),tt.None,n,s,{skipUpload:!0,gizmoId:r},o,{contextConnector:x,sourceUrl:d.url,syntheticExtension:null,type:Vt.Link}),ds.linkMetadataFetchStarted(x),h.tryFetch().then(y=>{if($e.remove(v,"none"),y==null)return null;const{id:_,title:k,connector:P,mimeType:N,url:D,syntheticExtension:R,o365DriveId:Y}=y;ds.linkMetadataFetchSucceeded(x,N),C.updateReferencedDocState(t,S,"fetched");let L=k;P===ke.GDRIVE&&(L=R?`${k}.${R}`:k),$e.uploadFile(_,new File([],L,{type:N.split(";")[0]}),tt.Retrieval,n,s,{gizmoId:r},o,{contextConnector:P,sourceUrl:D,syntheticExtension:R,type:Vt.Link,o365DriveId:Y})}).catch(y=>{ds.linkMetadataFetchFailed(x,y),qt.danger(s.formatMessage(ms.fileFetchFailed),{hasCloseButton:!0}),C.updateReferencedDocState(t,S,"failed"),$e.remove(v,"none")});break}case"prompt":{l.appendMessageIfNotDismissed({connector:x,type:h.message}),C.updateReferencedDocState(t,S,"prompted");break}}}},[o,t,l,r,s,n])}const ms=Re({fileLoading:{id:"CCC.fileLoading",defaultMessage:"Loading…"},fileFetchFailed:{id:"CCC.fileFetchFailed",defaultMessage:"Unable to fetch file information"},fileAlreadyAttached:{id:"CCC.fileAlreadyAttached",defaultMessage:"This file is already a part of your message."}}),lo=({clientThreadId:t,rateLimitPopup:e,children:s,highlightTooltip:n=!1})=>{const o=re(),i=Fc(t),r=js(),[c,l]=u.useState(n),[m,f]=u.useState(!1),g=u.useCallback(()=>{m||l(!0)},[m]),d=u.useCallback(()=>{l(!1),f(!1)},[]),v=u.useCallback(()=>{l(!1),f(!0)},[]);u.useEffect(()=>{l(n)},[n]);const x=S=>{e!=null&&S&&O.logPopoverHover({type:"rate_limit",location:"file_upload",plan_type:(r==null?void 0:r.planType)??"unknown"})},h=!!e;return a.jsx(a.Fragment,{children:h?a.jsxs(ei,{delayDuration:150,onOpenChange:x,children:[a.jsx(ti,{children:s}),a.jsx(si,{children:a.jsx(lr,{$as:ni,side:"top",sideOffset:4,className:"max-w-[260px]",children:a.jsx(au,{isNewConversation:i,rateLimitPopup:e})})})]}):a.jsx(Ds,{sideOffset:14,label:o.formatMessage({id:"oUK/GV",defaultMessage:"Attach file"}),className:"flex",open:c||n,side:"top",children:a.jsx("span",{onPointerEnter:g,onPointerLeave:d,onClick:v,children:s})})})},au=({isNewConversation:t=!1,rateLimitPopup:e})=>{const s=js(),n=la();if(e==null)return null;const{call_to_action:o,description:i}=e,r=i||a.jsx(U,{...Bn.defaultDescription}),c=o==null?void 0:o.includes(ai.GET_PLUS);return a.jsxs("div",{className:"p-2 text-sm text-token-text-primary",children:[a.jsx("div",{children:r}),c?a.jsx(wt,{size:"small",color:"secondary",className:"mt-3",onClick:()=>{dr(n,"Rate limited file upload popover"),O.logRateLimitGetPlusButtonClicked({type:"file_upload",location:"popover",plan_type:(s==null?void 0:s.planType)??"unknown",is_hard_block:!1,is_new_conversation:t,hard_block_reason:""})},children:a.jsx(U,{...Bn.getPlus})}):null]})},Bn=Re({defaultDescription:{id:"U5qAWP",defaultMessage:"You've reached your daily upload limit. Get ChatGPT Plus to unlock more."},getPlus:{id:"TeyLcp",defaultMessage:"Get Plus"}});function ou({clientThreadId:t,getInputProps:e,openFileDialog:s,uploadType:n,icon:o,highlightTooltip:i=!1}){const r=re(),c=Es(),l=!!c,m=a.jsx(ja,{className:"mb-1",disabled:l,onClick:d=>{d.preventDefault(),O.logEvent(A.openFileViewer,{intent:n.toString()}),s()},"aria-label":r.formatMessage({id:"PromptFilePicker.attachFiles",defaultMessage:"Attach files"}),children:o}),f=a.jsx("input",{disabled:l,...e({className:"hidden"})}),g=a.jsxs("div",{className:"flex",children:[m,f]});return a.jsx(lo,{clientThreadId:t,rateLimitPopup:c,highlightTooltip:i,children:g})}function iu({code:t,message:e}){switch(t){case kn.FileTooLarge:return zn.errorFileTooLarge;case kn.TooManyFiles:return O.logEvent(A.uploadedMaxFilesError),zn.errorTooManyFiles;default:return e}}const zn=Re({attachImages:{id:"PromptFilePicker.attachImages",defaultMessage:"Attach images"},attachFiles:{id:"PromptFilePicker.attachFiles",defaultMessage:"Attach files"},errorFileTooLarge:{id:"PromptFilePicker.errorFileTooLarge",defaultMessage:"Your file is too large. The maximum file size is {size}MB."},errorTooManyFiles:{id:"PromptFilePicker.errorTooManyFiles",defaultMessage:"You may only upload {maxNum} files at a time."},defaultFileUploadRateLimited:{id:"U5qAWP",defaultMessage:"You've reached your daily upload limit. Get ChatGPT Plus to unlock more."},getPlusButton:{id:"TeyLcp",defaultMessage:"Get Plus"}}),Un=Re({dragInstructions:{id:"FileDropZone.dragInstructions",defaultMessage:"Add anything"},dragAllAccepted:{id:"FileDropZone.dragAllAccepted",defaultMessage:"Drop any file here to add it to the conversation"}});function _f(t){var y;const{className:e,children:s,clientThreadId:n,currentModelConfig:o}=t,i=re(),r=Zs(n),c=Kt(o,r),l=c!==tt.None,m=bt(_=>_.files),f=(c===tt.Multimodal?Ls:Bs)-m.length,g=f<=0,{getGizmoId:d}=ss(),{handleFileAccepted:v}=mo(i,Kt(o,r),Ra(o,r),"drag",d,(y=Ma(o,r))==null?void 0:y.attachments),x=Es(),h=Ea(Aa(o,r)),{getRootProps:S,isDragActive:M}=Na({maxFiles:f,disabled:!l||g||x!=null,noClick:!0,onDropAccepted:v,onDropRejected:_=>uo(_,i,c),multiple:!0,maxSize:Pa,...h}),I=T();function T(){if(!h.accept||Object.keys(h.accept).length===0)return[];const _=[];return Object.values(h.accept).forEach(k=>_.push(...k)),_.sort()}return a.jsxs("div",{...S({className:e}),children:[s,M&&a.jsxs(ru,{children:[a.jsx(ur,{}),a.jsx("h3",{children:a.jsx(U,{...Un.dragInstructions})}),a.jsx("h4",{className:"w-2/3 text-center",children:I.length>0?I.join(", "):a.jsx(U,{...Un.dragAllAccepted})})]})]})}function uo(t,e,s){const{errors:n}=t[0];n.forEach(o=>{const i=iu(o);typeof i=="string"?qt.danger(i,{hasCloseButton:!0}):qt.danger(e.formatMessage(i,{size:mr,maxNum:s===tt.Multimodal?Ls:Bs}),{hasCloseButton:!0})})}function mo(t,e,s,n,o,i){return{handleFileAccepted:u.useCallback(async(c,l)=>{O.logEvent(A.uploadFile,{client:"web",eventSource:n,intent:e.toString()});const m=o!=null?await o():void 0;c.length>0&&c.forEach(f=>{$e.uploadFile(Ia(f),f,e,s,t,{gizmoId:m},i)})},[n,e,o,s,t,i])}}const ru=Ae.div`absolute inset-0 opacity-80 flex gap-2 flex-col justify-center items-center bg-token-main-surface-primary text-token-text-primary`;function fo({children:t,className:e,showBackground:s}){return a.jsxs("div",{className:"relative",children:[t,s&&a.jsx(ge.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:260,damping:20},className:G("pointer-events-none absolute bottom-0 top-0 h-8 w-8 rounded-full",e)})]})}function Gn({entry:t,onClick:e}){const{connectorConfig:s}=zs();u.useEffect(()=>{if(!open||t.type!==ke.GDRIVE)return;const r=s.get(ke.GDRIVE),c=r==null?void 0:r.access_token;c&&fr(c)},[s,t.type]);const n=Da(t.type),o=re(),i=t.access_token?Hn.uploadFromMessage:Hn.signinWithMessage;return a.jsx(Q.Item,{onClick:e,icon:n,children:a.jsxs("div",{className:"flex flex-col",children:[a.jsx(U,{...i,values:{connectorName:Us(t.type,o)}}),t.type===ke.O365_BUSINESS&&a.jsx("div",{className:"text-s text-token-text-tertiary",children:a.jsx(U,{...Gs.includesSharePoint})})]})},t.id)}const Hn=Re({signinWithMessage:{id:"ContextConnectorPickerDropdownItem.signInWithMessage",defaultMessage:"Connect to {connectorName}"},uploadFromMessage:{id:"ContextConnectorPickerDropdownItem.uploadWithMessage",defaultMessage:"Add from {connectorName}"}});function cu({clientThreadId:t,icon:e,setOpen:s,highlightTooltip:n=!1}){const o=Es(),i=!!o,r=re();return a.jsxs(a.Fragment,{children:[a.jsx(Q.Trigger,{className:"m-0 h-0 w-0 border-none bg-transparent p-0"}),a.jsx(lo,{clientThreadId:t,rateLimitPopup:o,highlightTooltip:n,children:a.jsx(ja,{className:"mb-1","aria-disabled":i,"aria-label":r.formatMessage({id:"tA7CXR",defaultMessage:"Attach files"}),onClick:c=>{c.preventDefault(),i||s(!0)},children:e})})]})}function lu({connectorEntries:t,onOauthRedirect:e}){const s=re();return a.jsxs(Q.Sub,{children:[a.jsx(Q.SubMenuTrigger,{icon:Kc,children:a.jsx("div",{className:"line-clamp-1 text-ellipsis",children:a.jsx(U,{...du.connectApps})})}),a.jsx(Q.Portal,{children:a.jsx(Q.SubContent,{children:t.map(n=>a.jsx(Q.Item,{onClick:()=>e(n),icon:Da(n.type),children:a.jsxs("div",{className:"flex flex-col",children:[Us(n.type,s),n.type===ke.O365_BUSINESS&&a.jsx("div",{className:"text-s text-token-text-tertiary",children:a.jsx(U,{...Gs.includesSharePoint})})]})},n.id))})})]})}const du=Re({connectApps:{id:"ContextConnectorPicker.connectApps",defaultMessage:"Connect apps"}});function uu({onOauthRedirect:t,connectors:e}){const s=re();return a.jsxs(Q.Sub,{children:[a.jsx(Q.SubMenuTrigger,{icon:Zc,children:a.jsx(U,{...mu.oneDriveSubmenuName})}),a.jsx(Q.Portal,{children:a.jsx(Q.SubContent,{children:e.map(n=>n?a.jsx(Q.Item,{onClick:()=>t(n),children:a.jsxs("div",{className:"flex flex-col",children:[Us(n.type,s),n.type===ke.O365_BUSINESS&&a.jsx("div",{className:"text-s text-token-text-tertiary",children:a.jsx(U,{...Gs.includesSharePoint})})]})},n.id):null)})})]})}const mu=Re({oneDriveSubmenuName:{id:"ContextConnectorPickerOneDriveSubmenu.oneDriveSubmenuName",defaultMessage:"Connect to Microsoft OneDrive"}});function fu(){const{connectorConfig:t}=zs(),e=Jt(),[s,n]=Zt(Fa([...t.values()],m=>!!m.access_token),m=>!!m.access_token),[o,i]=Zt(n,m=>m.type===ke.O365_PERSONAL||m.type===ke.O365_BUSINESS),r=!e&&!Gt&&s.length>0,c=!e&&!Gt&&!r&&o.length>1;return{unconnectedConnectors:Gt?[]:c?i:n,showUnconnectedInSubmenu:r,showOneDriveInSubmenu:c}}function hu({clientThreadId:t,icon:e,modelAcceptedMimeTypes:s,modelSupportedImageMimeTypes:n,attachmentsProductFeature:o,onOauthRedirect:i,uploadType:r,getInputProps:c,openFileDialog:l,highlightTooltip:m=!1}){const{currentLocale:f}=oi(),g=re(),d=Jt(),{connectorConfig:v,isLoading:x}=zs(),h=Qt(Xt.ContextConnectors),{getGizmoId:S}=ss(),[M,I]=u.useState();u.useEffect(()=>{S?S().then(p=>I(p)):I(void 0)},[S]);const T=u.useRef(null),[y,_]=u.useState(!1),k=u.useRef(!1),P=u.useCallback(()=>{var se;const p=(se=T.current)==null?void 0:se.files;Array.from(p??[]).forEach(de=>Dt.uploadFile(de,n,g,o))},[n,o,g]),[N,D]=u.useState(null),R=u.useCallback(()=>D(null),[D]),Y=u.useCallback((p,se)=>Dt.uploadPickedFile(p,se,n,s,o,M,g),[n,s,o,M,g]),{openMenu:L,confirmMenuOpened:H}=hr();u.useEffect(()=>{L&&(_(!0),H())},[L,H,_]);const le=da(),ae=u.useCallback(p=>{Dt.doContextConnectorOauthRedirect(le.asPath,p,i,Vt.Picker),i()},[i,le.asPath]),Z=u.useCallback(p=>{Dt.uploadPickedFile(p,ke.GDRIVE,n,s,o,M,g)},[n,s,o,M,g]),K=u.useCallback(async p=>{const{access_token:se}=p;if(!se){ae(p);return}switch(gr(p,Vt.Picker),p.type){case ke.GDRIVE:pr(f,p.type,se,de=>de.forEach(Z));break;case ke.O365_PERSONAL:case ke.O365_BUSINESS:D(p.type);break}},[Z,ae,D,f]),j=()=>{O.logEvent(A.openFileViewer,{intent:r.toString()}),l()},b=p=>{if(!p&&k.current&&!x)j();else if(p&&ee&&!x){j();return}_(p),p&&(h.eligible&&h.markAsViewed(),O.logEvent(A.composerOpenContextConnectorPicker),k.current=!0,setTimeout(()=>{k.current=!1},250))},[F,X]=Zt(Fa([...v.values()],p=>!!p.access_token),p=>!!p.access_token);gu(F,K);const[ne]=Zt(X,p=>p.type===ke.O365_PERSONAL||p.type===ke.O365_BUSINESS),{unconnectedConnectors:V,showUnconnectedInSubmenu:pe,showOneDriveInSubmenu:W}=fu(),ee=!F.length&&!V.length,_e=a.jsxs(a.Fragment,{children:[pe&&V.length>0&&a.jsx(lu,{connectorEntries:V,onOauthRedirect:p=>ae(p)}),!pe&&V.map(p=>a.jsx(Gn,{entry:p,onClick:()=>K(p)},p.id)),W&&a.jsx(uu,{connectors:ne,onOauthRedirect:ae}),x&&a.jsx(Q.Item,{icon:a.jsx(ii,{className:"text-token-text-secondary"})}),(V.length>0||x)&&a.jsx(Q.Separator,{}),F.map(p=>a.jsx(Gn,{entry:p,onClick:()=>K(p)},p.id)),a.jsx(Q.Item,{onClick:j,icon:Jc,children:a.jsx(U,{...d?qn.uploadFileMobile:qn.uploadFile})},"upload")]}),te=a.jsxs("div",{className:"flex flex-col",children:[a.jsx(xr,{type:N,onClose:R,uploadPickedFile:Y}),a.jsx("input",{onChange:P,...c({className:"hidden"})}),a.jsxs(Q.Root,{open:y,onOpenChange:b,children:[a.jsx(cu,{clientThreadId:t,icon:e,setOpen:b,highlightTooltip:m}),a.jsx(Q.Portal,{children:a.jsx(Q.Content,{size:"large",children:_e})})]}),a.jsx(yr,{hasConnectors:!x&&!ee})]});return{dropdownItems:_e,mainComponent:te}}function gu(t,e){const{connector:s,clearParam:n}=_r(),o=t.find(i=>i.type===s&&!!i.access_token);u.useEffect(()=>{o&&(e(o),n())},[o,e,n])}function pu(t){const{mainComponent:e}=hu(t);return e}const qn=Re({attachFiles:{id:"ContextConnectorPicker.attachFiles",defaultMessage:"Attach files"},uploadFile:{id:"LocalFileDropdownItem.uploadFile",defaultMessage:"Upload from computer"},uploadFileMobile:{id:"LocalFileDropdownItem.uploadFileMobile",defaultMessage:"Upload file"}});function xu({clientThreadId:t,uploadType:e,modelAcceptedMimeTypes:s,modelSupportedImageMimeTypes:n,attachmentsProductFeature:o,getInputProps:i,openFileDialog:r,onOauthRedirect:c,historyDisabled:l,className:m,highlightTooltip:f}){const{gdriveStatus:g,o365Status:d}=vr(),v=a.jsx(Yc,{className:l?"text-white":f?"text-brand-blue-800":void 0});return a.jsx("div",{className:G("relative",m),children:a.jsx(fo,{showBackground:f,className:"bg-brand-blue-800/20",children:g!=="false"||d!=="false"?a.jsx(pu,{clientThreadId:t,icon:v,modelAcceptedMimeTypes:s,modelSupportedImageMimeTypes:n,attachmentsProductFeature:o,onOauthRedirect:c,uploadType:e,openFileDialog:r,getInputProps:i,highlightTooltip:f}):a.jsx(ou,{clientThreadId:t,uploadType:e,openFileDialog:r,getInputProps:i,icon:v,highlightTooltip:f})})})}const yu=u.forwardRef(function({type:e,placeholder:s,replyRegions:n,state:o,renderFiles:i,leftSideActions:r,onSubmit:c,inputState:l,currentLeafId:m,composerController:f,clientThreadId:g,gizmoId:d},v){const x=Ps(),h=br();return u.useEffect(()=>{f.focus()},[h==null?void 0:h.modelId,f]),a.jsxs("div",{ref:v,className:G("flex w-full flex-col gap-1.5 rounded-[26px] p-1.5 transition-colors",x&&"backdrop-blur-2xl no-transparency:backdrop-blur-none",x&&e!=="temporary"&&"bg-token-composer-surface",!x&&e!=="temporary"&&"bg-[#f4f4f4] dark:bg-token-main-surface-secondary",e==="temporary"&&"dark bg-black"),children:[a.jsx(ct,{children:n.length>0&&a.jsx(ge.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0,transition:{duration:.06}},transition:{ease:"easeOut",duration:.1},children:a.jsx(Su,{replyRegions:n})})}),a.jsxs("div",{className:"flex items-end gap-1.5 pl-4 md:gap-2",children:[!!(r!=null&&r.length)&&a.jsx(ge.div,{initial:{opacity:0},animate:{opacity:1},transition:{ease:"easeOut",duration:.06},className:"-ml-2.5 flex",children:r},"leftSideActions"),a.jsxs(ge.div,{layout:!0,transition:{duration:.1},className:G("flex min-w-0 flex-1 flex-col"),children:[i,f instanceof Oa?a.jsx(_u,{composerController:f,currentLeafId:m,placeholder:s,inputState:l}):a.jsx(Tl,{composerController:f,placeholder:s})]}),a.jsx(vu,{inputState:l,state:o,onSubmit:c,composerController:f,clientThreadId:g,gizmoId:d})]})]})});function _u({composerController:t,currentLeafId:e,placeholder:s,inputState:n}){const o=u.useContext(ri);return a.jsxs(a.Fragment,{children:[a.jsx(Sr,{id:wr,autoFocus:!0,tabIndex:0,"data-id":e,dir:"auto",ref:i=>{if(!(t instanceof Oa))throw new Error("Expected TextAreaComposerController");i!=null&&(t.textArea=i,t.logPageMount())},rows:1,placeholder:s,disabled:n!=="default",className:G("m-0 resize-none border-0 bg-transparent px-0 text-token-text-primary focus:ring-0 focus-visible:ring-0",n==="disabled"&&"text-center",["max-h-[25dvh]","max-h-52"])}),a.jsx("script",{nonce:o.cspScriptNonce,suppressHydrationWarning:!0,children:"requestAnimationFrame((function(){window.__oai_logTTI?window.__oai_logTTI():window.__oai_SSR_TTI=window.__oai_SSR_TTI??Date.now()}))"})]})}function vu(t){const{isUnauthenticated:e}=St(),s=bt(La.hasUploadInProgress);if(t.inputState==="disabled")return null;const n=a.jsx(bu,{state:t.state,onSubmit:t.onSubmit});return!e&&!s&&t.state==="disabled"&&t.clientThreadId?a.jsx("div",{className:"w-10",children:a.jsx(kr,{clientThreadId:t.clientThreadId,gizmoId:t.gizmoId,fallback:()=>n})}):n}function bu({state:t,onSubmit:e}){const s=t==="streaming"?Xc:el,n=re(),o=n.formatMessage({id:"+yfm/p",defaultMessage:"Stop streaming"}),i=n.formatMessage({id:"xfIykB",defaultMessage:"Send prompt"}),r=Ps();return a.jsx("button",{onClick:e,disabled:t==="disabled","aria-label":t==="streaming"?o:i,"data-testid":t==="streaming"?"stop-button":"send-button",className:G("mb-1 me-1 flex h-8 w-8 items-center justify-center rounded-full bg-black text-white transition-colors hover:opacity-70 focus-visible:outline-none focus-visible:outline-black disabled:text-[#f4f4f4] disabled:hover:opacity-100 dark:bg-white dark:text-black dark:focus-visible:outline-white disabled:dark:bg-token-text-quaternary dark:disabled:text-token-main-surface-secondary",r&&"disabled:bg-black disabled:bg-opacity-[0.27]",!r&&"disabled:bg-[#D7D7D7]"),children:a.jsx(s,{className:G(t==="streaming"?"icon-lg":"icon-2xl")})})}function Su({replyRegions:t}){return a.jsx("div",{className:"flex flex-col divide-y divide-token-border-light overflow-hidden rounded-b-lg rounded-t-[20px] bg-token-main-surface-primary",children:t.map((e,s)=>{switch(e.type){case"text":return a.jsx(wu,{value:e.value,onRemoveRegion:e.onRemoveRegion},s);case"object":return a.jsx(ku,{value:e.value,onRemoveRegion:e.onRemoveRegion},s);case"mention":case"system_hint":return a.jsx(Cu,{value:e.value,icon:e.icon,onRemoveRegion:e.onRemoveRegion},s)}})})}function wu({value:t,onRemoveRegion:e}){return a.jsxs(Qs,{className:"text-token-text-secondary",children:[a.jsx(Xs,{children:a.jsx(Ws,{className:"icon-lg-heavy"})}),a.jsx(en,{children:`“${t}”`}),a.jsx(Ys,{onClick:e})]})}function ku({value:t,onRemoveRegion:e}){return a.jsxs(Qs,{className:"text-blue-selection",children:[a.jsx(Xs,{children:a.jsx(Ws,{className:"icon-lg-heavy"})}),a.jsx(en,{className:"font-semibold",children:t}),a.jsx(Ys,{onClick:e})]})}function Cu({value:t,icon:e,onRemoveRegion:s}){return a.jsxs(Qs,{children:[a.jsx(Xs,{className:"mt-0",children:e}),a.jsx(en,{className:"font-semibold text-token-text-primary",children:t}),a.jsx(Ys,{onClick:s})]})}function Ys({onClick:t}){return a.jsx("button",{onClick:t,type:"button",className:"flex-shrink-0 text-token-text-secondary",children:a.jsx(Qc,{className:"icon-lg"})})}const Qs=Ae.div`flex items-start py-2.5 gap-3 pl-3 pr-1.5 text-sm`,Xs=Ae.span`flex-shrink-0 mt-0.5 w-7 h-6 flex justify-center items-center`,en=Ae.span`flex-1 line-clamp-3 py-0.5`;function Iu({composerController:t,highlightTooltip:e}){return a.jsx(ju,{highlightTooltip:e,children:a.jsx(fo,{showBackground:e,className:"bg-brand-purple/20",children:a.jsx("button",{className:"mb-1 flex h-8 w-8 items-center justify-center text-token-text-primary",onClick:()=>{O.logEvent(A.composerSearchButtonClicked),bs.addPersistedSystemHint(it.Search),/^search\s?$/i.test(t.getCurrentText())&&t.setText(""),t.focus()},children:a.jsx(Ja,{className:G(e&&"text-brand-purple-800 dark:text-brand-purple-600")})})})})}function Tu(){const t=Qt(Xt.hasSeenComposerSearchButtonTooltip);return!t.isLoading&&t.eligible}function ju({children:t,highlightTooltip:e}){const s=Tu(),n=re(),o=Qt(Xt.hasSeenComposerSearchButtonTooltip);return s?a.jsx(va,{side:"top",show:!0,dismissOnOutsideClick:!0,badge:"none",title:n.formatMessage({id:"WhBf/L",defaultMessage:"The web is now in ChatGPT"}),contentAlign:"center",onDismiss:o.markAsViewed,sideOffset:2,className:"!max-w-2xs",description:n.formatMessage({id:"INHpvZ",defaultMessage:"Search the web for instant answers and links to trusted sources."}),children:a.jsx("div",{children:t})}):a.jsx("div",{children:a.jsx(Ds,{sideOffset:14,label:n.formatMessage({id:"c+4o2s",defaultMessage:"Search the web"}),side:"top",open:e?!0:void 0,children:t})})}function Mu({composerController:t,clientThreadId:e}){const s=Wa(e),n=Ya(e,ua.Search),o=il(e),[i,r]=u.useState([]),[c,l]=u.useState(void 0),[m,f]=u.useState(0);u.useEffect(()=>{r(c?o.filter(_=>_.name.toLocaleLowerCase().startsWith(c.text.toLocaleLowerCase())||_.systemHint.toLocaleLowerCase().startsWith(c.text.toLocaleLowerCase())):[])},[c]);const g=t.useState(_=>_.getSystemHints().length>0);u.useEffect(()=>{const _=k=>{l(P=>!P||!k?k:P.text===k.text&&P.range.from===k.range.to&&P.range.to?P:k)};t.view.dispatch(t.view.state.tr.setMeta(Ml,{onHintMatch:_}))},[t]);const d=g||!o.length||!i.length||!c;u.useEffect(()=>{d&&f(0)},[d]);const v=i.length,x=u.useCallback(_=>{f(k=>(_(k)%v+v)%v)},[v]),h=i[m],S=({hintToSave:_=h,expectPerfectMatch:k,appendSpace:P=!0})=>{if(!c||!h||k&&_.name.toLowerCase()!==c.text.toLowerCase())return;O.logEvent(A.systemHintSelected,{system_hint:_.systemHint,conversation_id:s??vn});const N=c.text+_.name.slice(c.text.length);El(t.view,{id:_.systemHint,hint:N},c.range,P,n),Ot(t.view)},M=u.useRef(S);M.current=S;const I=u.useRef(x);I.current=x;const T=u.useRef(c);T.current=c;const y=t.view;return u.useEffect(()=>(d||Rl(y,_=>{_==="up"?I.current(k=>k-1):_==="down"?I.current(k=>k+1):_==="cancel"?(Ot(y),Al(y)):_==="submit"?(M.current({expectPerfectMatch:!1}),Ot(y)):_==="checkMatch"&&M.current({expectPerfectMatch:!0,appendSpace:!1})}),()=>Ot(y)),[d,y]),u.useEffect(()=>{d||O.logEvent(A.systemHintListOpened,{conversation_id:s??vn})},[d]),d?null:a.jsx(Cr,{className:"max-w-60",onMouseDown:_=>{_.preventDefault()},children:i.map((_,k)=>a.jsx("div",{onMouseOver:()=>f(k),onClick:()=>{S({hintToSave:_,expectPerfectMatch:!1}),t.focus()},children:a.jsx(Ir,{autoFocus:!1,className:"hover:bg-inherit rounded-lg px-1 py-2",spoofHovered:k===m,children:a.jsx(Ru,{title:_.name,description:_.description,icon:a.jsx(Tr,{svgString:_.logo,className:"icon-lg text-token-text-secondary"}),checked:!1})})},_.systemHint))})}function Ru({title:t,description:e,icon:s,checked:n}){return a.jsxs("div",{className:"inline-flex w-full items-center justify-start gap-1.5 pl-1.5 pr-3",children:[a.jsx("div",{className:"flex h-7 w-7 items-center justify-center gap-2.5",children:s}),a.jsxs("div",{className:"shrink grow basis-0",children:[a.jsx("p",{className:"text-sm font-normal leading-tight text-token-text-primary",children:t}),!!e&&a.jsx("p",{className:"text-[13px] font-normal leading-[18px] text-token-text-secondary",children:e})]}),n&&a.jsx(tl,{className:G("icon-md text-token-text-primary",{"group-hover:hidden":!n})})]})}function Eu({composerController:t,clientThreadId:e}){return t instanceof jl?a.jsx(Mu,{composerController:t,clientThreadId:e}):null}function Au({suggestions:t,composerController:e,onSelect:s,onChange:n}){const o=to(),i=u.useCallback((l,m,f)=>{s==null||s(l,m,f),o(l,m,f)},[s,o]),[r,c]=u.useState(-1);return u.useEffect(()=>{const l=m=>{if(m.key==="ArrowDown"){const f=r===t.length-1?0:r+1;c(f),n==null||n(f,!0,t[f])}else if(m.key==="ArrowUp"){m.preventDefault();const f=r<=0?t.length-1:r-1;c(f),n==null||n(f,!0,t[f])}else m.key==="Enter"&&t[r]&&i(t[r],t,r)};return e.subscribe("keydown",l)},[t,r,n,i,e]),u.useEffect(()=>e.subscribe("blur",()=>{c(-1),n==null||n(-1,!1)}),[e,n]),a.jsx(ge.ul,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"hidden w-full flex-col p-2.5 group-focus-within:block",children:t.map((l,m)=>a.jsxs(ge.li,{initial:{opacity:0,translateY:4},animate:{opacity:1,translateY:0},transition:{delay:m*.03},exit:{opacity:0,translateY:4},className:"w-full",children:[m>0&&a.jsx("div",{className:G("h-[1px] opacity-60",r===m||r===m-1?"mx-2 bg-token-main-surface-secondary":"bg-token-border-light")}),a.jsxs("button",{className:G("inline w-full cursor-pointer items-center justify-start rounded-lg px-2.5 py-3 text-start",r===m?"bg-token-main-surface-secondary":"bg-token-main-surface-primary"),onClick:f=>{f.preventDefault(),i(l,t,m)},onMouseEnter:()=>{c(m),n==null||n(m,!1,l)},onMouseLeave:()=>{c(-1),n==null||n(-1,!1,l)},children:[a.jsx("span",{className:"text-token-text-tertiary",children:l.title}),a.jsx("span",{className:"text-token-text-primary",children:l.body})]})]},l.id??m))})}const Nu=1,Pu=3e3;function Du({files:t,className:e}){const s=Jt();return a.jsx("div",{className:e,children:t.map(n=>a.jsx(Ua,{width:s?"normal":"wide",onRemoveFileClick:()=>$e.remove(n.tempId,"none"),file:n.file,fileId:n.fileId??void 0,contextConnectorInfo:n.contextConnectorInfo,loadingPercentage:n.status===Gr.Uploading?n.progress:void 0},n.tempId))})}function Fu({onAbortCompletion:t,onCreateNewCompletion:e,onContinueGenerating:s,currentModelId:n,clientThreadId:o,isNewThread:i,isCompletionInProgress:r,className:c,disabled:l=!1,disabledReason:m,canPause:f=!1,canContinue:g=!1,suggestions:d,isInteractableSharedThread:v,composerContainerRef:x,composerController:h,autocompletions:S,requiresFileUpload:M,onComposerInput:I,onComposerChange:T,onAutocompleteSelect:y,headerClassName:_,hideHeader:k,setComposerBarElement:P,onTaggingDropdownOpen:N,onTaggingDropdownClose:D}){var hn,gn;const R=wa(),{isUnauthenticated:Y}=St(),L=re(),H=dt(o),le=ns(o),ae=da(),{gizmoEditorData:Z,mode:K,getGizmoId:j}=ss(),b=ma(),F=sa(),X=ci(),ne=es(),V=Wa(o),pe=!!li(),W=jr(),ee=!!di(),[_e,te]=u.useState({}),[p,se]=u.useState(!1),[de,q]=u.useState(!1),oe=u.useRef(!1),Se=rl(),J=n!==null?Se[n]:void 0,Ie=W.has(it.Search);let B=Zs(o),ve=B&&"gizmo"in B?B.gizmo:void 0;const[ue,Pe]=u.useState(null);ue!==null&&(B={gizmo:ue,gizmo_id:ue.gizmo.id,kind:Ce.GizmoInteraction},ve=ue);const st=Kt(J,B);let Je=!1;Mr(B)&&(ve==null?void 0:ve.gizmo.id)===Rr&&(Je=!0);const It=!l&&st!==tt.None&&!Je&&!Y,qe=Ra(J,B),ut=Aa(J,B);let ie=bt(w=>w.files);const[me]=u.useState(()=>Er());K==="magic"?ie=ie.filter(w=>w.gizmoId!=null):ie=ie.filter(w=>w.gizmoId==null);const Te=ie.length>0,nt=bt(La.hasUploadInProgress),Tt=h.useState(w=>!w.isEmpty()),Le=Te?!nt:Tt,Ye=(st===tt.Multimodal?Ls:Bs)-ie.length,at=Ye<=0,Ve=Le&&!l&&!r&&!ee,[sn,_o]=u.useState(!1),vo=cl(),bo=n||vo.id,So=Ya(o,ua.Search),as=!l&&So&&!ve&&!Ie,wo=(hn=Se[bo])==null?void 0:hn.tags,{targetedContent:jt,setTargetedContent:Mt}=Ar(),$=jt!=null&&jt.isFocusedViewContent&&!ne?void 0:jt,{rebaseSystemMessageContent:nn}=Ba();u.useEffect(()=>{Nr()}),u.useEffect(()=>{if(!(R!=null&&R.id))return;const w=Cn.getAndReset(R==null?void 0:R.id,V);w&&h.setText(w.inputText)},[R==null?void 0:R.id,V,h]),u.useEffect(()=>{sn!==Ve&&(_o(Ve),Ve&&(fa(!0).then(w=>{Wt.startEnforcement(w),Ss.startEnforcement(w),_s.startEnforcement(w)}),b!=null&&b.includes(Ms.SharedWebsocket)&&Ct.registerIfNotConnected()))},[Ve,sn,B==null?void 0:B.kind,b]);const Be=Ma(J,B),{handleFileAccepted:ko}=mo(L,Kt(J,B),qe,"mouse",j,Be==null?void 0:Be.attachments),{getInputProps:Co,open:Io}=Na({disabled:l||!It||at,noClick:!0,onDropAccepted:ko,onDropRejected:w=>uo(w,L,st),multiple:!0,maxSize:Pa,maxFiles:Ye,...Ea(ut)}),an=ca(me),on=u.useCallback(()=>{h.eraseContent(),an.clearMessages(),h.resize(Nu),Pr();for(const w of ie)$e.remove(w.tempId,"none")},[ie,an,h]),mt=async(w,xe)=>{var xn;if(w==null||w.preventDefault(),l||!Le&&!xe||!B||Oe.isLoading(o)!==!1)return;const je=new Fs;se(!0);const ze=h.getContentToSend(),Xe=ze.content.replace(/[\u{E0000}-\u{E007F}]+/gu,""),Ee=`${H}-nextPrompt`,et=Hr({namespace:Tn.CompletionRequest,key:Ee,opts:{expectedTimingLogs:[{name:"prompt_submitted",expectedInMs:3e3}]}}),{content:Go,attachments:pn}=qr(Xe,J,B),rs=[];nn&&rs.push(hi(nn));const cs={...B};"gizmo"in cs&&delete cs.gizmo;const ls=h.getSystemHints();let pt={promptId:Ee,content:Go,eventMetadata:{eventSource:w?"mouse":"keyboard"},completionMetadata:{suggestions:d,conversationMode:cs,systemHints:ls},messageMetadata:{...pn.length>0&&{attachments:pn},...ue&&{gizmo_id:ue==null?void 0:ue.gizmo.id},..._e,...ls.length>0&&{system_hints:ls},...!!ze.metadata&&{serialization_metadata:ze.metadata}},appendMessages:rs.length>0?rs:void 0,turnTracker:je};pt=Vr(pt),$!=null&&$.createNewCompletionParams&&(pt=await $.createNewCompletionParams(pt)),et.logTiming("request_params_ready"),await e(pt),(xn=$==null?void 0:$.onCreateCompletion)==null||xn.call($,{serverThreadId:V,currentLeafId:H}),($==null?void 0:$.shouldPersistAcrossMessages)!==!0&&Mt(void 0),In.hideThreadHeader(),on(),se(!1),et.logTiming("prompt_submitted"),Wr({namespace:Tn.CompletionRequest,key:Ee}),d!==void 0&&(He.logEvent("chatgpt_prompt_ignore_suggestions"),O.logEvent(A.promptIgnoreSuggestions))},rn=u.useRef(mt);u.useLayoutEffect(()=>{rn.current=mt}),u.useEffect(()=>ui.subscribe(mi.SEND_PROMPT,({prompt:w})=>{h.setText(w),rn.current(void 0,!0)}),[h]);const To=w=>{Mt(w.targetedReply),w.targetedReply&&(h.focus(),O.logEvent(A.targetedReplyButtonClicked,{conversationId:V,sourceMessageId:w.messageId}))},cn=u.useCallback(()=>{var w;(w=$==null?void 0:$.onCleared)==null||w.call($,{serverThreadId:V,currentLeafId:H}),Mt(void 0),h.focus()},[H,V,$,Mt,h]),ln={Enter:{validator:w=>{const xe=w.isComposing||w.keyCode===229,je=de&&oe.current;return Ve&&!je&&(w.metaKey||(F||Gt)&&!w.shiftKey&&!xe)},handler:w=>{w.preventDefault(),mt()}},Escape:{validator:w=>!w.isComposing,handler:w=>{f&&r&&(t("",le),O.logEvent(A.pauseCompletion,{threadId:C.getServerThreadId(o),currentLeafId:C.getTree(o).getMessageId(H),eventSource:"keyboard"})),w.target.value===""&&cn()}}},ft=u.useRef(ln);ft.current=ln;const dn=u.useRef(null),ht=ll(wo,B==null?void 0:B.kind),[os,Rt]=u.useState(!1),[is,un]=u.useState(!1),Et=ht&&os,mn=h.isReady();u.useEffect(()=>h.subscribe("keydown",w=>{var ze,Xe;h.acceptLegacyKeydown()&&((ze=ft.current[w.key])!=null&&ze.validator(w))&&ft.current[w.key].handler(w);const je=h.getCurrentText();if(w.key==="@"){const Ee=h.getSelectionStart(),et=je.substring(0,Ee);(!et||/\s$/.test(et)||Ee===0)&&((Xe=dn.current)==null||Xe.handleClose(),setTimeout(()=>Rt(!0),10))}else os&&Rt(!1);if(w.key==="Escape"&&(Pe(null),q(!1)),as){let Ee;w.key==="Backspace"?Ee=je.substring(0,je.length-1):Ee=je+w.key,/^search\s?$/i.test(Ee)?un(!0):is&&un(!1)}Ie&&w.key==="Escape"&&bs.removePersistedSystemHint(it.Search)}),[h,mn,os,is,as,Ie]),u.useEffect(()=>{const w=Object.fromEntries(Object.keys(ft.current).map(xe=>[xe,ze=>{const Xe=ft.current[xe];if(!Xe||h.acceptLegacyKeydown())return!1;const{validator:Ee,handler:et}=Xe;return Ee(ze)?(et(ze),!0):!1}]));h.registerKeyHandlers(w)},[h,mn]),u.useEffect(()=>h.subscribe("paste",w=>{Dr({event:w,intl:L,clientThreadId:o,conversationMode:B,currentModelConfig:J,getEditorGizmoId:j,modelSupportedImageMimeTypes:qe})}),[L,o,B,J,j,qe,h]);const jo=w=>{pe||Pe(w),h.trimLeadingText("@"),$t(),Rt(!1)},Mo=nu(o,me,L,qe,Be==null?void 0:Be.attachments),Ro=u.useCallback(()=>{t("",le),O.logEvent(A.pauseCompletion,{threadId:C.getServerThreadId(o),currentLeafId:C.getTree(o).getMessageId(H),eventSource:"mouse"}),$t()},[t,o,le,H]),fn=u.useCallback(()=>{Cn.set(R==null?void 0:R.id,V,h.getCurrentText())},[V,R==null?void 0:R.id,h]);u.useEffect(()=>{Z||p||h.focus()},[p,h]),u.useEffect(()=>{Z||$e.reset()},[n,Z]),u.useEffect(()=>{(!ht&&ue||pe)&&Pe(null)},[ht,ue,pe]);const[Eo,Ao]=(()=>{switch(m){case"workspaceDisallowsGizmo":return[Fe.disallowedByWorkspacePlaceholder,!0];case"feedbackRequired":return[Fe.disabledFeedbackPlaceholder,!0];case"noModelsAvailable":return[Fe.noModelsAvailablePlaceholder,!0];case"requiresPluginsToBeInstalled":return[Fe.requiresPluginsToBeInstalled,!0];case"loadingPlugins":return[Fe.loading,!0];case"noTestGizmoId":return[Fe.noTestGizmoId,!0];default:return v?[Fe.continueSharedConversationPlaceholder,!1]:($==null?void 0:$.placeholderTextOverride)!=null?[$.placeholderTextOverride,!1]:[Fe.placeholderWithName,!1]}})(),No=L.formatMessage(Eo,{name:Z!=null?K==="magic"?dl:Z.name||"GPT":(ve==null?void 0:ve.gizmo.display.name)??"ChatGPT"});u.useEffect(()=>h.subscribe("input",()=>{Fr.getState().isThreadHeaderVisible&&In.hideThreadHeader(),q(!0)}),[h]),u.useEffect(()=>{if(I)return h.subscribe("input",()=>{I==null||I()})},[h,I]),u.useEffect(()=>{if(T)return h.subscribe("change",()=>{T==null||T()})},[h,T]),u.useEffect(()=>h.subscribe("focus",()=>{q(!0)}),[h]);const Po={clientThreadId:o,uploadType:st,modelAcceptedMimeTypes:ut,modelSupportedImageMimeTypes:qe,attachmentsProductFeature:Be==null?void 0:Be.attachments,getInputProps:Co,openFileDialog:Io,historyDisabled:X,onOauthRedirect:fn,highlightTooltip:M&&!Te},Qe=[];!l&&!at&&It&&!Ie&&Qe.push(a.jsx(xu,{...Po},"file-upload-button")),as&&Qe.push(a.jsx(Iu,{composerController:h,highlightTooltip:is},"search-button"));const Do=Te&&a.jsxs(a.Fragment,{children:[K==="magic"&&a.jsx("div",{className:"m-2 mb-0 rounded-lg bg-token-main-surface-secondary p-2 text-xs text-token-text-secondary",children:a.jsx(U,{...Fe.gizmoKnowledgeWarning})}),a.jsx(Du,{files:ie,className:"flex flex-nowrap gap-2 overflow-x-auto pb-1.5 pt-[7px]"})]}),Fo=Ao?"disabled":"default",At=r&&f?"streaming":!(Ve||Ie)||p?"disabled":"idle",gt=u.useRef(null),ot=u.useRef(null),{layer:Oo}=fi("387752763"),Lo=Oo.get("enable_slash_commands",!1),Bo=n&&[ul,ml].includes(n),zo=Lo&&(B==null?void 0:B.kind)===Ce.PrimaryAssistant&&!Ie;u.useEffect(()=>{const w=()=>{gt.current!=null&&De.addAction("composer_state_disabled",{threadId:C.getServerThreadId(o),disabledReason:gt.current})};if(Le&&At==="disabled"){let xe="unknown";l?xe=m??"component_disabled_unknown":r?xe="completion_in_progress":ee?xe="thread_hard_blocked":p&&(xe="starting_new_completion_request"),gt.current!==xe&&(ot.current&&clearTimeout(ot.current),ot.current=setTimeout(w,Pu)),gt.current=xe}else gt.current=null;return()=>{ot.current&&(clearTimeout(ot.current),ot.current=null)}},[o,Le,At,l,m,r,ee,p]);const Nt=[];if($!=null&&$.label&&Nt.push({type:$.type,value:$.label,onRemoveRegion:cn}),W!=null&&W.has(it.Search)&&Nt.push({type:"system_hint",value:L.formatMessage(Ou.searchMode),icon:a.jsx("span",{className:"flex h-7 w-7 items-center justify-center rounded-full bg-brand-purple/15",children:a.jsx(Ja,{className:"h-[20px] w-[20px] shrink-0 text-brand-purple-600"})}),onRemoveRegion:()=>{bs.removePersistedSystemHint(it.Search),h.focus()}}),ue!==null){const w=!!((gn=ue.gizmo.tags)!=null&&gn.includes(za.FirstParty));Nt.push({type:"mention",value:ue.gizmo.display.name,icon:a.jsx(Il,{isFirstParty:w,src:ue.gizmo.display.profile_picture_url,className:"icon-md"}),onRemoveRegion:()=>{Pe(null),h.focus()}})}u.useEffect(()=>{(!S||S.length===0||!de)&&(oe.current=!1)},[S,de]);const Uo=(w,xe,je)=>{oe.current=w>=0,xe&&h.setText(je?`${je.title}${je.body}`:"")};return u.useEffect(()=>{Et?N==null||N():D==null||D()},[Et,N,D]),a.jsxs(Or.Provider,{value:me,children:[a.jsx(Lr,{onOauthRedirect:fn,children:a.jsx("form",{className:c,onSubmit:mt,children:a.jsxs("div",{className:"relative flex h-full max-w-full flex-1 flex-col",children:[!k&&a.jsx(Md,{className:_}),a.jsxs("div",{ref:x,className:"group relative flex w-full items-center",children:[i&&"from_template_row"in ae.query&&a.jsx("button",{type:"button",onClick:()=>{ae.push("/",void 0,{shallow:!0})},className:"mr-2 flex h-8 w-8 items-center justify-center text-token-text-tertiary hover:text-token-text-secondary",children:a.jsx(sl,{className:"icon-lg"})}),ht&&!!V&&a.jsx(ld,{ref:dn}),Et&&a.jsx("div",{className:G("absolute bottom-16 w-full space-y-2",vs.TagGpt),children:a.jsx(xl,{onClick:w=>jo(w),onClose:()=>{Rt(!1),h.focus()}})}),zo&&a.jsx("div",{className:G("absolute bottom-16 space-y-2",vs.TagGpt),children:a.jsx(Eu,{composerController:h,clientThreadId:o})}),a.jsx(yu,{type:X?"temporary":"default",ref:P,replyRegions:Nt,placeholder:No,inputState:Fo,composerController:h,leftSideActions:Qe,state:At,onSubmit:At==="streaming"?Ro:mt,renderFiles:Do,currentLeafId:H,clientThreadId:o,gizmoId:ve==null?void 0:ve.gizmo.id}),de&&S&&S.length>0&&!Et&&h.canShowAutocompletion()&&a.jsx("div",{className:G("absolute left-0 top-full z-10 mt-2 box-border w-full bg-token-main-surface-primary",(Qe==null?void 0:Qe.length)>0?`px-${Qe.length*8}`:"pl-0"),children:a.jsx(Au,{suggestions:S,composerController:h,onSelect:y,onChange:Uo})})]}),a.jsx(Br,{composerController:h,parsedDocumentHandler:Mo})]})})}),a.jsx(Zd,{canUseInlineTagging:ht,isDisabled:l,clientThreadId:o,currentLeafId:H,currentRequestId:le,canContinue:g,composerController:h,setPromptInputMetadata:te,suggestions:d,isNewThread:i,onCreateNewCompletion:e,onContinueGenerating:s,onResetState:on,conversationMode:B}),B!=null&&!Bo&&zr.includes(B.kind)&&a.jsx(Ur,{onTargetedReply:To})]})}const Ou=Re({searchMode:{id:"LSO1pB",defaultMessage:"Search the web"}});function Lu(t){const e=u.useContext(gi);return({id:n,requestedModelId:o,eventMetadata:i,focusOnNewCompletion:r=!0,variantPurpose:c="none",useDefaultModel:l,appendMessages:m,conversationMode:f,juice:g=void 0,turnTracker:d,extraStreamParams:v})=>{var M;const h=C.getTree(t).getParentPromptNode(n),S=h.id;e({type:Ke.Variant,promptId:S,requestedModelId:o,eventMetadata:i,cancelActiveRequests:!1,focusOnNewCompletion:r,useDefaultModel:l,completionMetadata:{variantPurpose:c,conversationMode:f,juice:g,systemHints:(M=h.message.metadata)==null?void 0:M.system_hints},appendMessages:m,turnTracker:d,extraStreamParams:v})}}function Bu(t){var o,i,r,c,l;const e=((o=t.message)==null?void 0:o.author.role)===be.User,s=((i=t.metadata)==null?void 0:i.err)!=null&&((r=t.metadata)==null?void 0:r.errCode)!==_t.ContentPolicy,n=((c=t.metadata)==null?void 0:c.errCode)===_t.ModelIncompatibility;return((l=t.metadata)==null?void 0:l.canRetry)===!1||n?!1:e||s}function vf(t){return t.composerController?a.jsx(Vn,{...t,composerController:t.composerController}):a.jsx(Nl,{children:e=>a.jsx(Vn,{...t,composerController:e})})}function Vn({clientThreadId:t,isNewThread:e,currentModelId:s,showPromptStarters:n,onRequestCompletion:o,composerContainerRef:i,composerController:r,setComposerBarElement:c}){const l=Oc(),m=$r(),f=lt(g=>{const d=Oe.getCurrentNode(t,g);return Bu(d)});return Kr(r),!m&&f?a.jsx(zu,{clientThreadId:t}):a.jsxs(a.Fragment,{children:[a.jsx(od,{clientThreadId:t}),a.jsx(Sl,{clientThreadId:t,isStaticSharedThread:l,showInlineEmbeddedDisplay:!1,withVerticalPadding:!1,withHorizontalPadding:!0,children:a.jsx(wl,{children:a.jsx(Uu,{composerContainerRef:i,composerController:r,clientThreadId:t,currentModelId:s,isNewThread:e,showPromptStarters:n,setComposerBarElement:c,onRequestCompletion:o})})})]})}function zu({clientThreadId:t}){const e=Lu(t),s=lt(i=>{var c;return((c=Oe.getCurrentNode(t,i).metadata)==null?void 0:c.errCode)===ws}),n=Zr(i=>i.isoDate),o=dt(t);return s&&n!=null&&n!==""?null:a.jsxs("div",{children:[a.jsx("div",{className:"mb-3 text-center text-xs",children:a.jsx(U,{...Wn.errorGeneratingResponse})}),a.jsx("div",{className:"flex items-center md:mb-4",children:a.jsx(wt,{as:"button",color:"primary",onClick:()=>{const i=new Fs;e({id:o,eventMetadata:{eventSource:"mouse"},conversationMode:Oe.getConversationMode(t),turnTracker:i})},className:"m-auto",icon:Za,children:a.jsx(U,{...Wn.regenerateResponse})})})]})}function Uu({clientThreadId:t,currentModelId:e,isNewThread:s,onRequestCompletion:n,showPromptStarters:o,composerContainerRef:i,composerController:r,autocompletions:c,requiresFileUpload:l,onComposerInput:m,onComposerChange:f,onAutocompleteSelect:g,headerClassName:d,hideHeader:v,setComposerBarElement:x,onTaggingDropdownClose:h,onTaggingDropdownOpen:S}){var qe,ut;const M=dt(t),I=ns(t),T=ka(),{isUnauthenticated:y}=St(),k=Lc(t)===ha.PENDING,P=Bc({clientThreadId:t,conversationLeafId:M}),N=Os(I),D=(N||k)&&!P,R=dt(t),Y=!y,L=ga(),{isOpen:H,onClose:le}=Jr(),ae=u.useCallback((ie,me)=>{O.logEvent(A.continueCompletion),n({type:Ke.Continue,promptId:ie,eventMetadata:{eventSource:"mouse"},cancelActiveRequests:!1,completionMetadata:{conversationMode:Oe.getConversationMode(t)},turnTracker:me})},[n,t]),Z=pa(),K=u.useCallback(async(ie,me)=>{var Le;const Te=C.getServerThreadId(t);Ct.stopConversation(Te);const nt=C.getTree(t);!nt.hasReceivedServerCompletion&&!L&&((Le=nt.getParent(me).metadata)==null?void 0:Le.errCode)!==_t.ContentPolicy&&setTimeout(()=>{Cs.onCreateFinished(Z,Te,L)},500),Te&&He.checkGate("3922476776")&&await Ze.stopConversationProcess(Te),Hs.abortRequest(me)&&C.updateTree(t,Ye=>{const at=C.getThreadCurrentLeafId(t);Ye.updateNodeMessageMetadata(at,{finish_details:{type:"interrupted"}})})},[t,L,Z]),j=u.useCallback(async({promptId:ie,content:me,eventMetadata:Te,completionMetadata:nt,messageMetadata:Tt,appendMessages:Le,turnTracker:Ye})=>{const at=C.getThreadCurrentLeafId(t);C.updateTree(t,Ve=>{Ve.addNode(ie,me,at,be.User,void 0,Tt)}),await n({type:Ke.Next,promptId:ie,eventMetadata:Te,cancelActiveRequests:!0,completionMetadata:nt,appendMessages:Le,turnTracker:Ye})},[t,n]),b=zc(t,M),F=Uc(t,M),X=!P&&(N||k),ne=u.useMemo(()=>X?!1:!b&&F,[b,F,X]),V=X&&e!=="gpt-4-pbrowse",pe=Gc(t),W=Va(t),ee=$s(W).data,{promptStarters:_e,isSuccess:te}=kl(s&&!pe,t,4),p=Ta(),se=(()=>{var ie,me;if((p==null?void 0:p.messageId)===((me=(ie=C.getTree(t).getLastValidNode(M))==null?void 0:ie.message)==null?void 0:me.id))return p==null?void 0:p.suggestions;if(o&&!pe&&te&&!Y)return _e})(),de=C.getTree(t),q=de.countMessagesByAuthor(be.User),oe=u.useRef(),Se=u.useRef();let J=!1;oe.current==q&&Se.current==R?J=!0:oe.current!==q&&Se.current!==R&&(J=!0,oe.current=q,Se.current=R);const Ie=de.getNodeByIdOrMessageId(M),B=J&&((qe=Ie==null?void 0:Ie.message)==null?void 0:qe.author.role)==be.Assistant&&Rs(Ie.message),ve=fl(),ue=pi(),Pe=(()=>{var Te;if(((Te=ee==null?void 0:ee.gizmo.tags)==null?void 0:Te.includes(za.WorkspaceDisabled))&&!ue)return"workspaceDisallowsGizmo";if(ve.size){if(T.displayingSideBySideFeedback&&T.unskippable)return"feedbackRequired"}else return"noModelsAvailable";const me=Oe.getConversationMode(t);return(me==null?void 0:me.kind)===Ce.GizmoTest&&me.gizmo_id==null?"noTestGizmoId":null})(),st=Hc(t),Je=Vs(t),It=(ut=xi("15117983"))==null?void 0:ut.value;return a.jsxs(a.Fragment,{children:[(s||B)&&H?a.jsx(Yr,{onClose:le}):null,It&&Je&&Je.kind===Ce.PrimaryAssistant&&Je.plugin_ids&&Je.plugin_ids.length>0?a.jsx(Gu,{}):a.jsx(Fu,{composerContainerRef:i,composerController:r,clientThreadId:t,onCreateNewCompletion:j,onAbortCompletion:K,onContinueGenerating:ae,currentModelId:e,isNewThread:s,isCompletionInProgress:D,className:"w-full",canContinue:ne,suggestions:se??[],disabled:!!Pe,disabledReason:Pe??void 0,canPause:V,isInteractableSharedThread:st,autocompletions:c,requiresFileUpload:l,onComposerInput:m,onComposerChange:f,onAutocompleteSelect:g,headerClassName:d,hideHeader:v,setComposerBarElement:x,onTaggingDropdownClose:h,onTaggingDropdownOpen:S},t)]})}function Gu(){return a.jsxs("div",{className:"mx-auto flex max-w-md flex-col items-center justify-center gap-2 rounded-xl border border-token-border-light bg-token-main-surface-primary p-6 shadow-lg",children:[a.jsx("span",{className:"text-token-text-primary",children:a.jsx(U,{id:"PluginsDecrepatedNotice.pluginsDeprecationTitle",defaultMessage:"Conversations with plugins are archived"})}),a.jsx("span",{className:"text-token-text-secondary",children:a.jsx(U,{id:"PluginsDecrepatedNotice.pluginsDeprecationSubtitle",defaultMessage:"Explore GPT Store to find a replacement"})}),a.jsxs("a",{href:"https://chat.openai.com/gpts",className:"text-green-500 hover:cursor-pointer dark:text-green-400",children:[a.jsx(U,{id:"PluginsDecrepatedNotice.pluginsDeprecationGptStoreLink",defaultMessage:"Explore GPTs"}),a.jsx("span",{className:"ml-2",children:a.jsx(U,{id:"PluginsDecrepatedNotice.pluginsDeprecationGptStoreLinkArrow",defaultMessage:"→"})})]})]})}const Wn=Re({errorGeneratingResponse:{id:"PromptTextarea.errorGeneratingResponse",defaultMessage:"There was an error generating a response"},regenerateResponse:{id:"PromptTextarea.regenerateResponse",defaultMessage:"Regenerate"}}),Hu=fe(()=>ce(()=>import("./bxdl65vfohrw8di7.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26])).then(t=>t.default)),qu=fe(()=>ce(()=>import("./sso-wherv7nuadrq5lwl.js").then(t=>t.j),__vite__mapDeps([27,1,2,3,28,5,6,13,29,30,31,32,33,34,10,35,7,12,36,37,38,39,40,25,15,41,42,43,44,45,18,21,24,46,19,20,47,48,49,50,51,52,53,54,55,56,57,23,58,59,60,61,62,17,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,4,8,9,11,14,81])).then(t=>t.default).catch(()=>kt)),Vu=Ae.div`flex gap-2 flex-wrap mt-1 max-w-[80%] justify-end`,Wu=Ae.div`flex flex-col gap-2`,$u=({parts:t,attachments:e,isUserTurn:s,clientThreadId:n})=>{const o=Jt(),i=Ks(n),r=Js(),c=yi.getImageAssetPointersFromParts(t),l=new Set(c.map(x=>ts(x.asset_pointer))),f=es()||o,g=(e??[]).filter(x=>Ca(x.name)),d=(e??[]).filter(x=>x.id==null||l.has(x.id)?!1:r||i?!g.includes(x):!0);return(r||i?(d.length>0||g.length>0)&&s:d.length>0&&s)?a.jsxs(a.Fragment,{children:[a.jsxs(Vu,{children:[d.map(x=>a.jsx(Ua,{file:x.name,fileId:x.id,contextConnectorInfo:Qr(x.context_connector_info),width:o?"normal":"wide",alwaysShowData:!0},x.id)),i&&g.map(x=>a.jsx(qu,{visualization:jn(x)},x.id))]}),r&&!i&&a.jsx(Wu,{className:G(!f&&"w-[80%]"),children:g.map(x=>a.jsx(Hu,{clientThreadId:n,visualization:jn(x)},x.id))})]}):null};function ho(t){return Rs(t)&&!_i(t)}const zt=50,Ku=95;function Zu(t,e){if(t<=e)return t/e*zt;{const s=zt,n=Ku-zt,o=t-e,r=-(zt/e)/n;return s+n*(1-Math.exp(r*o))}}class Ju{constructor(){z(this,"mostRecentCompletionRequest");z(this,"loggedRequestIds",new Set)}onCompletionRequestStarted(e){this.mostRecentCompletionRequest={requestId:e,timestamp:Date.now()}}onDisplayTextAfterBrowsingSession(e,s){const n=this.mostRecentCompletionRequest;if(n!=null&&!this.loggedRequestIds.has(n.requestId)){const i=C.getThreadConversationTurns(e,s).find(r=>r.messages.some(c=>c.message.id===s));i!=null&&i.messages.some(r=>r.nodeId===n.requestId)&&(O.logEvent(A.browsingTimeToFirstTextToken,{messageId:s,timeMs:Date.now()-n.timestamp}),this.loggedRequestIds.add(n.requestId))}}}const go=new Ju;function Yu(t){var o;const e=t.find(i=>{var r;return((r=i.message.metadata)==null?void 0:r.image_search_results)!==void 0});return(((o=e==null?void 0:e.message.metadata)==null?void 0:o.image_search_results)??[]).slice(0,5)}function Qu({messages:t}){const e=Yu(t),s=Xr();return e.length===0?null:a.jsx("div",{className:G({"mb-2":!0,"grid grid-flow-col gap-3":e.length>1,"w-1/3":e.length===1}),children:e.filter(({contentUrl:n})=>s.has(n)).map((n,o)=>a.jsx("a",{href:n.hostPageUrl,target:"_blank",rel:"noreferrer",children:a.jsx("img",{src:n.contentUrl,alt:n.name,className:"aspect-square rounded-xl object-cover"})},o))})}const Xu=fe(()=>ce(()=>import("./sso-wherv7nuadrq5lwl.js").then(t=>t.k),__vite__mapDeps([27,1,2,3,28,5,6,13,29,30,31,32,33,34,10,35,7,12,36,37,38,39,40,25,15,41,42,43,44,45,18,21,24,46,19,20,47,48,49,50,51,52,53,54,55,56,57,23,58,59,60,61,62,17,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,4,8,9,11,14,81])).then(t=>t.default).catch(()=>kt));function po({attachments:t,citations:e,contentReferences:s,className:n,clientThreadId:o,displayParts:i,isCompletionInProgress:r,id:c,isActivelyStreaming:l,isUserTurn:m,turnIndex:f,isFeedbackEnabled:g,messages:d,onRequestMoreCompletions:v,parts:x,prevGroupedMessageType:h,prevGroupedMessages:S,showEditButton:M,onEnterEdit:I,size:T="medium"}){var R,Y;const y=Ks(o),_=d.length>1,{flagSeverity:k,shouldHideContent:P}=so(_?void 0:d[0]),N=!x.some(L=>L!==""),D=((R=d[0].message.metadata)==null?void 0:R.targeted_reply_label)??((Y=d[0].message.metadata)==null?void 0:Y.targeted_reply);return u.useEffect(()=>{!N&&h===E.Browsing&&go.onDisplayTextAfterBrowsingSession(o,d[0].message.id)},[N,d,o,h]),a.jsxs("div",{"data-message-author-role":d[0].message.author.role,"data-message-id":d[0].message.id,dir:"auto",className:G(n,"text-message flex w-full flex-col items-end gap-2 whitespace-normal break-words [.text-message+&]:mt-5"),children:[D&&a.jsxs("div",{className:"mb-1 ml-6 mt-1 flex items-start gap-1.5 text-sm font-normal text-token-text-tertiary sm:ml-7 lg:ml-8",children:[a.jsx(Ws,{className:"icon-md mt-1 shrink-0"}),a.jsx("p",{className:"mr-2 line-clamp-3",children:D})]}),m&&y&&a.jsx(Xu,{messages:d}),a.jsx(ec,{messages:d}),a.jsx(em,{parts:x,attachments:t,isUserTurn:m,isCompletionInProgress:r,turnIndex:f,displayParts:i,isActivelyStreaming:l,shouldHideContent:P,showEditButton:M,onEnterEdit:I,clientThreadId:o,id:c,isEmpty:N,prevGroupedMessageType:h,prevGroupedMessages:S,flagSeverity:k,messages:d,citations:e,contentReferences:s,size:T}),a.jsx(Pl,{message:_?void 0:d[0],id:c,isFeedbackEnabled:g,onRequestMoreCompletions:v,clientThreadId:o,isUserTurn:m}),a.jsx(tc,{isUserTurn:m,message:_?void 0:d[0]}),!m&&!l&&S&&h===E.SearchResult&&a.jsx(Qu,{messages:S})]})}function em({clientThreadId:t,id:e,displayParts:s,isCompletionInProgress:n,turnIndex:o,isActivelyStreaming:i,shouldHideContent:r,showEditButton:c=!1,onEnterEdit:l,isEmpty:m,prevGroupedMessageType:f,prevGroupedMessages:g,messages:d,citations:v,contentReferences:x,size:h,isUserTurn:S,parts:M,attachments:I}){var V,pe;const T=re(),y=sc(s),[_,k]=u.useState({}),[P,N]=u.useState(!1),D=nc(),{streamingContext:R}=ac();u.useEffect(()=>{D&&(R.setOnStylesUpdatedCallback(k),R.onStreamingChanged(n),R.setOnResetCallback(()=>N(!1)),n&&(N(!0),k(R.createTopLevelStyles())))},[D,n,R]);const Y=oc(),L=(V=d[0].message.metadata)==null?void 0:V.gizmo_id,H=(pe=d[0].message.metadata)==null?void 0:pe.serialization_metadata,le=qc(d[0].message).length,ae=u.useMemo(()=>({clientThreadId:t,messageId:e,turnIndex:o}),[t,e,o]),Z=ic(d[0].message),K=!!L&&Y.includes(L),j=u.useCallback(W=>{rc.open(W,o,e)},[o,e]),b=a.jsx($u,{parts:M,attachments:I,isUserTurn:S,clientThreadId:t},"files-and-tables"),F=!!(I!=null&&I.length||s.some(W=>W.type==="images")),X=s.map((W,ee)=>{var _e;if(W.type==="transcription"){const te=r?null:W.text;let p=null;return S&&r?p=a.jsx("span",{className:"italic opacity-30",children:a.jsx(U,{...Ut.contentRemoved})}):S&&te!=null?p=te.trim().length===0?a.jsx("span",{className:"italic opacity-30",children:a.jsx(Ft,{text:T.formatMessage(Ut.transcriptUnavailable),customSymbolOffsets:void 0})}):a.jsx("span",{className:"italic opacity-65",children:a.jsx(Ft,{text:`“${te.trim()}”`,customSymbolOffsets:void 0})}):!S&&te!=null&&(p=a.jsx(Ft,{text:te,customSymbolOffsets:void 0})),a.jsx(us,{containsImagesOrAttachments:F,isUserTurn:S,showEditButton:c,onEnterEdit:l,children:p},ee)}else if(W.type==="text"){const te=r?null:W.text;if(!m&&!r&&!S){const p=f===E.CodeInterpreter?g==null?void 0:g.map(Se=>Se.message):void 0,{text:se,contentReferences:de}=cc(y,v,x,K),{processedText:q,displayedContentReferences:oe}=lc(se,de,i?void 0:p);return a.jsx(dc.Provider,{value:{analyticsMetadata:ae,message:d[0].message,contentReferences:oe,onShowSearchResults:j,numImageResults:le,isActivelyStreaming:i,useSafeUrls:!0},children:a.jsx(qs,{clientThreadId:t,messageId:e,isStreamingOrProcessing:P,size:h,className:G(i&&!D&&"result-streaming",Z&&"headers-v2"),children:q===""?"&#8203;":q})},ee)}else if(m&&i&&!S)return a.jsx("div",{className:"result-streaming",children:a.jsx("div",{children:a.jsx("pre",{})})},ee);return a.jsx(us,{containsImagesOrAttachments:F,isUserTurn:S,showEditButton:c,onEnterEdit:l,children:S&&r?a.jsx("span",{className:"italic opacity-30",children:a.jsx(U,{...Ut.contentRemoved})}):te?a.jsx(Ft,{text:te,customSymbolOffsets:H==null?void 0:H.custom_symbol_offsets}):null},ee)}else if(W.type==="images"){const te=((_e=d[0].message.metadata)==null?void 0:_e.attachments)??[];return a.jsx(uc,{assets:W.imageAssets,attachments:te},ee)}else return null}),ne=s.findIndex(W=>W.type==="text");if(ne!==-1?X.splice(ne,0,b):X.push(b),r&&S)X.length=0,X.push(a.jsx(us,{containsImagesOrAttachments:F,isUserTurn:S,onEnterEdit:ys,children:a.jsx("span",{className:"italic opacity-30",children:a.jsx(U,{...Ut.contentRemoved})})}));else if(r&&!S)return null;return a.jsx("div",{className:G("flex w-full flex-col gap-1 empty:hidden",S&&"items-end rtl:items-start",!S&&"first:pt-[3px]",P&&"streaming-response"),style:_,children:X})}const Ut=Re({contentRemoved:{id:"textMessage.contentRemoved",defaultMessage:"Content removed"},transcriptUnavailable:{id:"textMessage.transcriptUnavailable",defaultMessage:"Transcript Unavailable"}});function tm(t){var m;const{isActivelyStreaming:e,...s}=t,n=ma(),o=(n==null?void 0:n.includes("debug"))??!1,i=t.messages[t.messages.length-1].message.id,[r,c]=u.useState([]),l=u.useRef();return l.current===void 0&&(l.current=(n==null?void 0:n.includes(vi))??!1?new mc(t.parts,c,e,void 0,{debug:o}):new fc(t.parts,c,e)),u.useEffect(()=>{l.current!=null&&(l.current.onMessagePartsUpdated(t.parts,e),l.current.isBuffering()&&xt.addDelayedRenderingMessage(i))},[t.parts,i,e]),u.useEffect(()=>{l.current!=null&&!l.current.isBuffering()&&xt.removeDelayedRenderingMessage(i)},[r,i]),u.useEffect(()=>()=>xt.removeDelayedRenderingMessage(i),[i]),u.useEffect(()=>()=>{l.current!=null&&(l.current.destroy(),l.current=void 0)},[]),a.jsx(po,{...s,displayParts:r,isActivelyStreaming:e||((m=l.current)==null?void 0:m.isBuffering())})}function sm({message:t,isCompletionInProgress:e,clientThreadId:s,className:n,isUserTurn:o,turnIndex:i,isFeedbackEnabled:r,prevGroupedMessageType:c,prevGroupedMessages:l,showEditButton:m,onEnterEdit:f,onRequestMoreCompletions:g}){var v,x,h;const d=u.useMemo(()=>"parts"in t.message.content?t.message.content.parts:[xa(t.message)],[t]);return a.jsx(am,{parts:d,messages:[t],isCompletionInProgress:e,className:n,citations:(v=t.message.metadata)==null?void 0:v.citations,contentReferences:(x=t.message.metadata)==null?void 0:x.content_references,attachments:(h=t.message.metadata)==null?void 0:h.attachments,isUserTurn:o,turnIndex:i,id:t.nodeId,isFeedbackEnabled:r,onRequestMoreCompletions:g,clientThreadId:s,showEditButton:m,onEnterEdit:f,prevGroupedMessageType:c,prevGroupedMessages:l})}const nm=bi.memo(sm);function am(t){const e=t.messages.length>1,{flagSeverity:s}=so(e?void 0:t.messages[0]),n=s!=="danger"&&t.isCompletionInProgress,o=!t.parts.some(r=>r!==""),[i]=u.useState(()=>!t.isUserTurn&&(t.isCompletionInProgress||o));return i?a.jsx(tm,{...t,isActivelyStreaming:n}):a.jsx(po,{...t,displayParts:hc({isUserTurn:t.isUserTurn,parts:t.parts}),isActivelyStreaming:n})}const om=fe(()=>ce(()=>import("./e7fqh7qaid8ff1a6.js"),__vite__mapDeps([82,1,2,3])));function xo({animationData:t,animationSegmentToPlay:e,animationLoopCounter:s}){const n=u.useRef(null);return u.useEffect(()=>{var o;(o=n.current)==null||o.playSegments(e,!0)},[s]),a.jsx(om,{animationData:t,lottieRef:n,loop:!1,autoplay:!1})}function im(t){return a.jsx(Ns,{width:"8",height:"9",viewBox:"0 0 8 9",fill:"none",...t,children:a.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M7.66607 0.376042C8.01072 0.605806 8.10385 1.07146 7.87408 1.4161L3.54075 7.9161C3.40573 8.11863 3.18083 8.24304 2.93752 8.24979C2.69421 8.25654 2.46275 8.1448 2.31671 7.95008L0.150044 5.06119C-0.098484 4.72982 -0.0313267 4.25972 0.300044 4.01119C0.631415 3.76266 1.10152 3.82982 1.35004 4.16119L2.88068 6.20204L6.62601 0.584055C6.85577 0.239408 7.32142 0.146278 7.66607 0.376042Z",fill:"currentColor"})})}function rm(t){return a.jsxs(Ns,{width:"4",height:"12",viewBox:"0 0 4 12",fill:"none",...t,children:[a.jsx("mask",{id:"path-1-inside-1_1975_4008",fill:"currentColor",children:a.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M1 6.5C1 7.05228 1.44772 7.5 2 7.5C2.55228 7.5 3 7.05228 3 6.5V1.5C3 0.947715 2.55228 0.5 2 0.5C1.44772 0.5 1 0.947715 1 1.5L1 6.5ZM0.75 10.25C0.75 10.9404 1.30964 11.5 2 11.5C2.69036 11.5 3.25 10.9404 3.25 10.25C3.25 9.55964 2.69036 9 2 9C1.30964 9 0.75 9.55964 0.75 10.25Z"})}),a.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M1 6.5C1 7.05228 1.44772 7.5 2 7.5C2.55228 7.5 3 7.05228 3 6.5V1.5C3 0.947715 2.55228 0.5 2 0.5C1.44772 0.5 1 0.947715 1 1.5L1 6.5ZM0.75 10.25C0.75 10.9404 1.30964 11.5 2 11.5C2.69036 11.5 3.25 10.9404 3.25 10.25C3.25 9.55964 2.69036 9 2 9C1.30964 9 0.75 9.55964 0.75 10.25Z",fill:"currentColor"}),a.jsx("path",{d:"M1 6.5H-0.25H1ZM1 1.5L-0.25 1.5L-0.25 1.5L1 1.5ZM2 6.25C2.13807 6.25 2.25 6.36193 2.25 6.5H-0.25C-0.25 7.74264 0.757359 8.75 2 8.75V6.25ZM1.75 6.5C1.75 6.36193 1.86193 6.25 2 6.25V8.75C3.24264 8.75 4.25 7.74264 4.25 6.5H1.75ZM1.75 1.5V6.5H4.25V1.5H1.75ZM2 1.75C1.86193 1.75 1.75 1.63807 1.75 1.5H4.25C4.25 0.257359 3.24264 -0.75 2 -0.75V1.75ZM2.25 1.5C2.25 1.63807 2.13807 1.75 2 1.75V-0.75C0.757359 -0.75 -0.25 0.257359 -0.25 1.5L2.25 1.5ZM2.25 6.5L2.25 1.5L-0.25 1.5L-0.25 6.5L2.25 6.5ZM2 10.25H-0.5C-0.5 11.6307 0.619288 12.75 2 12.75V10.25ZM2 10.25V12.75C3.38071 12.75 4.5 11.6307 4.5 10.25H2ZM2 10.25H2H4.5C4.5 8.86929 3.38071 7.75 2 7.75V10.25ZM2 10.25H2V7.75C0.619288 7.75 -0.5 8.86929 -0.5 10.25H2Z",fill:"currentColor",mask:"url(#path-1-inside-1_1975_4008)"})]})}function cm(t){return a.jsx(Ns,{width:"8",height:"9",viewBox:"0 0 8 9",fill:"none",...t,children:a.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M7.32256 1.48447C7.59011 1.16827 7.55068 0.695034 7.23447 0.427476C6.91827 0.159918 6.44503 0.199354 6.17748 0.515559L4.00002 3.08892L1.82256 0.515559C1.555 0.199354 1.08176 0.159918 0.765559 0.427476C0.449355 0.695034 0.409918 1.16827 0.677476 1.48447L3.01755 4.25002L0.677476 7.01556C0.409918 7.33176 0.449354 7.805 0.765559 8.07256C1.08176 8.34011 1.555 8.30068 1.82256 7.98447L4.00002 5.41111L6.17748 7.98447C6.44503 8.30068 6.91827 8.34011 7.23447 8.07256C7.55068 7.805 7.59011 7.33176 7.32256 7.01556L4.98248 4.25002L7.32256 1.48447Z",fill:"currentColor"})})}function bf({animationLoopCounter:t}){const{resolvedTheme:e}=As(),s=e==="dark";return a.jsx(xo,{animationData:s?gc:pc,animationSegmentToPlay:[0,300],animationLoopCounter:t})}function Sf({animationLoopCounter:t}){const{resolvedTheme:e}=As(),s=e==="dark";return a.jsx(xo,{animationData:s?xc:yc,animationSegmentToPlay:[0,400],animationLoopCounter:t})}const lm=2e3,yo=.4,dm=.45,um=.2,mm=.1,fm=.25;var Me=(t=>(t[t.Running=0]="Running",t[t.Finished=1]="Finished",t[t.Error=2]="Error",t[t.Stopped=3]="Stopped",t[t.Paused=4]="Paused",t))(Me||{});function wf({conversationMessages:t,icon:e,status:s,text:n,estimatedToolDurationMs:o,animationLoopDurationMs:i=lm,shouldPersistAfterFinished:r=!1}){const[c,l]=u.useState(s===0?0:s===1&&!r?7:1),[m,f]=u.useState(0);u.useEffect(()=>{s===2?l(8):s===3?l(9):s===4?l(10):s===1?l(c===2?3:7):s===0&&c===10&&(l(2),f(d=>d+1))},[s]);const g=pm(c);return u.useEffect(()=>{const d=t[0].message.id;if(g)return xt.addDelayedRenderingMessage(d),()=>{xt.removeDelayedRenderingMessage(d)}},[g]),Ga(()=>{rt(c)&&f(d=>d+1)},i),c===7&&!r?null:a.jsxs("div",{className:"my-2.5 flex items-center gap-2.5",children:[a.jsx(hm,{icon:e,status:s,uiState:c,estimatedToolDurationMs:o,animationLoopCounter:m,shouldPersistAfterFinished:r,onFillProgressBarAnimationComplete:()=>l(4),onFinishAnimationComplete:()=>{l(5),setTimeout(()=>{l(r?7:6)},mm*1e3)},onHideAnimationComplete:()=>l(7)}),a.jsx(gm,{text:n,uiState:c,animationLoopCounter:m,onEnterAnimationComplete:()=>l(2)})]})}const $n=50;function hm({icon:t,status:e,uiState:s,estimatedToolDurationMs:n,animationLoopCounter:o,shouldPersistAfterFinished:i,onFillProgressBarAnimationComplete:r,onFinishAnimationComplete:c,onHideAnimationComplete:l}){const[m,f]=u.useState(0);Ga(()=>{rt(s)?f(I=>I+$n):s===10&&f(0)},$n);let g,d,v;rt(s)||s===10?(g="running",d=a.jsx(t,{animationLoopCounter:o}),v="bg-transparent"):s===4||s===5||s===7&&i?(g="finished",d=a.jsx(im,{}),v="bg-brand-purple"):e===2?(g="error",d=a.jsx(rm,{}),v="bg-orange-500"):e===3&&(g="stopped",d=a.jsx(cm,{}),v="bg-gray-300");let x={opacity:0,scale:0,rotate:-180,x:0},h={type:"spring",bounce:.3,duration:dm},S={opacity:0,scale:.6,rotate:0,x:0};s===0?(x={opacity:0,scale:.5,rotate:-180,x:-8},h={type:"spring",bounce:.3,duration:yo}):s===1?x=!1:s===5&&(S={opacity:0,scale:0,rotate:0,x:0},h={type:"spring",bounce:.3,duration:fm});const M=Zu(m,n);return a.jsx("div",{className:"relative h-5 w-5 shrink-0",children:a.jsx(ct,{onExitComplete:()=>{s===6&&l()},children:g!=null&&a.jsxs(ge.div,{className:G("absolute left-0 top-0 flex h-full w-full items-center justify-center rounded-full text-white",v),initial:x,animate:{opacity:1,scale:1,rotate:0,x:0},exit:S,transition:h,onAnimationComplete:()=>{s===4&&c()},children:[d,(rt(s)||s===10)&&a.jsx(_c,{percentage:s===3?100:M,thickness:1.5/23,className:"absolute left-1/2 top-1/2 h-[23px] w-[23px] -translate-x-1/2 -translate-y-1/2 text-brand-purple",backgroundStrokeClassName:"stroke-brand-purple/25 dark:stroke-brand-purple/50",transitionDuration:s===3?`${(100-M)/100*um}s`:void 0,transitionTimingFunction:s===3?"cubic-bezier(0.55, 0, 1, 1)":void 0,onTransitionEnd:()=>{s===3&&r()}})]},g)})})}function gm({text:t,uiState:e,animationLoopCounter:s,onEnterAnimationComplete:n}){const[o,i]=u.useState(t);u.useEffect(()=>{e===2&&i(t)},[s]),u.useEffect(()=>{rt(e)||i(t)},[e,t]);let r={opacity:0,x:0,y:15},c={type:"spring",bounce:.3,opacity:{duration:.15},y:{duration:.3}};e===0?(r={opacity:0,x:-8,y:0},c={type:"spring",bounce:.3,duration:yo,delay:.15}):e===1&&(r=!1);const l=o??void 0;return a.jsx("div",{className:G("relative h-5 w-full leading-5",e===8||e===9?"text-token-text-tertiary":"text-token-text-secondary"),children:a.jsx(ct,{children:l!=null&&a.jsx(ge.div,{className:"absolute left-0 top-0 line-clamp-1 overflow-visible",initial:r,animate:{opacity:1,x:0,y:0},exit:{opacity:0,x:0,y:-15},transition:c,onAnimationComplete:()=>{e===0&&n()},children:l},l.toString())})})}function rt(t){return t===0||t===2||t===3}function pm(t){return rt(t)||t===4||t===5||t===6||t===10}const Kn=Ae.div`group absolute left-0 top-0 mr-1.5 h-8 overflow-hidden mt-1`;function tn({highlightedCommand:t,status:e,children:s,showWorkUserSetting:n=!1,hideOnlyIfNotInteractedWith:o=!1,onOpenAnalytics:i}){const r=s!=null,[c]=u.useState(n),[l,m]=u.useState(n),[f,g]=u.useState(!1),d=e===Me.Finished||e===Me.Error,v=o?c?!1:!f:!1,x=e===Me.Running&&"loading-shimmer";return d&&v?null:r?a.jsxs(a.Fragment,{children:[a.jsx(Zn,{$canShowWork:!0,children:a.jsx(ct,{children:a.jsx(Kn,{children:a.jsx(ge.button,{onClick:()=>{l||i==null||i(),m(h=>!h),g(!0)},initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},className:G(x),children:a.jsxs("div",{className:"flex items-center justify-start gap-1",children:[a.jsx("span",{children:t}),l?a.jsx(nl,{className:"icon-md"}):a.jsx(Ka,{className:"icon-md"})]})},t==null?void 0:t.toString())})})}),a.jsx(ct,{children:l&&s&&a.jsx(ge.div,{initial:"collapsed",animate:"reveal",exit:"collapsed",variants:{collapsed:{translateY:-20,opacity:0,height:0},reveal:{translateY:0,opacity:1,height:"auto"}},transition:{duration:.3,ease:"easeInOut"},className:"overflow-hidden",children:s})})]}):a.jsx(Zn,{$canShowWork:!1,children:a.jsx(Kn,{className:G(x),children:t})})}const Zn=Ae.p`first:mt-0 my-1.5 relative h-8
${({$canShowWork:t})=>t?"text-token-text-secondary hover:text-token-text-primary":"text-token-text-secondary"}`,xm=fe(()=>ce(()=>import("./sso-wherv7nuadrq5lwl.js").then(t=>t.j),__vite__mapDeps([27,1,2,3,28,5,6,13,29,30,31,32,33,34,10,35,7,12,36,37,38,39,40,25,15,41,42,43,44,45,18,21,24,46,19,20,47,48,49,50,51,52,53,54,55,56,57,23,58,59,60,61,62,17,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,4,8,9,11,14,81])).then(t=>t.default).catch(()=>kt)),Jn=fe(()=>ce(()=>import("./bxdl65vfohrw8di7.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26])).then(t=>t.default));function ym({messages:t,isRequestActive:e,clientThreadId:s}){var S,M,I;const[n,o]=t,i=ho(n.message),r=(S=o==null?void 0:o.message.metadata)==null?void 0:S.aggregate_result,c=Od(),l=Js(),m=Ks(s),f=o!=null&&o.message?ro(o.message):[],g=((I=(M=o==null?void 0:o.message.metadata)==null?void 0:M.aggregate_result)==null?void 0:I.messages.filter(no))??[],v=(f.filter(T=>T.type==="chart")??[]).length!==g.length,x=l&&!v;let h=Me.Running;return(r==null?void 0:r.status)==="success"?h=Me.Finished:o!=null&&o.message.content.content_type!==Yt.ExecutionOutput||r!=null&&r.status!=="running"?h=Me.Error:(i||!e)&&(h=Me.Stopped),a.jsxs(a.Fragment,{children:[a.jsx(_m,{messages:t,status:h,isRequestActive:e}),x&&f.map((T,y)=>{const{file_id:_,type:k}=T;return m?a.jsx(xm,{isStreaming:h===Me.Running,visualization:T},_):k==="chart"&&!c?(T.fallback_to_image=!0,a.jsx(Yn,{children:a.jsx(Jn,{clientThreadId:s,visualization:T})},y)):a.jsx(Yn,{children:a.jsx(Jn,{clientThreadId:s,visualization:T})},y)}),!x&&o!=null&&a.jsx(Fl,{message:o.message})]})}const Yn=Ae.div`mb-3 max-w-[80%]`;function _m({messages:t,status:e,isRequestActive:s}){var g;const[n,o]=t,i=re(),r=(g=o==null?void 0:o.message.metadata)==null?void 0:g.aggregate_result,c=ho(n.message),{data:l,error:m}=Si(wi.ShowExpandedCodeView);let f=i.formatMessage({id:"message.tools.data-analysis.running",defaultMessage:"Analyzing"});if((r==null?void 0:r.status)==="success"?f=i.formatMessage({id:"message.tools.data-analysis.finished",defaultMessage:"Analyzed"}):o!=null&&o.message.content.content_type!==Yt.ExecutionOutput||r!=null&&r.status!=="running"?f=i.formatMessage({id:"message.tools.data-analysis.error",defaultMessage:"Analysis errored"}):(c||!s)&&(f=i.formatMessage({id:"message.tools.data-analysis.stopped",defaultMessage:"Analysis paused"})),l!==void 0||m){const d=Ol(n.message)!=null;return a.jsx(tn,{status:e,highlightedCommand:f,showWorkUserSetting:l??!1,hideOnlyIfNotInteractedWith:!0,children:d?a.jsxs("div",{className:"mb-3 mt-0.5 overflow-hidden rounded-xl bg-black",children:[a.jsx(Ll,{message:n.message,FormattedText:qs}),o!=null&&a.jsx(Bl,{message:o.message})]}):null})}return null}const vm=3,bm=.1,Qn=[0,.6,.9];function Sm({nextMessage:t,isLastMessage:e,isRequestActive:s}){let n=e||(t==null?void 0:t.message.content.content_type)===Yt.Text&&!(t!=null&&t.message.content.parts.some(r=>r.length>0));const o=Vc(t==null?void 0:t.message),i=vc(o.slice(0,vm).map(r=>r.entries[0].url));if(n){const r=s?a.jsxs("div",{className:"flex items-center gap-1",children:[i.map((c,l)=>a.jsx(ge.div,{className:"-ml-1.5 first:ml-0 last:mr-1.5",initial:{width:l===0?0:6,opacity:0},animate:{width:20,opacity:1},transition:{duration:bm,delay:Qn[Math.min(l,Qn.length-1)]},children:a.jsx("div",{className:G("flex h-5 w-5 items-center overflow-hidden rounded","border-l-2 border-token-main-surface-primary bg-token-main-surface-primary"),children:a.jsx(bc,{url:c,size:32,minSize:16,className:"icon-md rounded"})})},c)),a.jsx(U,{id:"jjx8Qg",defaultMessage:"Searching the web"})]}):a.jsx(U,{id:"fssXGM",defaultMessage:"Error while searching"});return a.jsx(tn,{highlightedCommand:r,status:s?Me.Running:Me.Error})}return null}const wm={strong:t=>{const{node:e,children:s,...n}=t;return a.jsx("strong",{...n,className:G(n.className,"font-semibold text-token-text-primary"),children:s})},p:t=>{const{node:e,children:s,...n}=t;return a.jsx("p",{...n,className:G(n.className,"text-base","has-[strong]:mb-1 [&:not(:first-child)]:has-[strong]:mt-3 [&:not(:has(strong))]:mb-3"),children:s})}};function km({messages:t,isStreaming:e,clientThreadId:s}){var v,x;const[n,o]=u.useState(""),[i,r]=u.useState(!1),c=t[0].message,l=c.id,m=C.getServerThreadId(s),f=xa(c);u.useEffect(()=>{var I;const h=/\*\*(.*?)(?:\*\*|\n|$)/g;let S,M="";for(;(S=h.exec(f))!=null;)M=S[1].trim();M?o(M):((I=c.metadata)==null?void 0:I.initial_text)!=null&&o(c.metadata.initial_text)},[f,(v=c.metadata)==null?void 0:v.initial_text]),u.useEffect(()=>{f.length>0&&r(!0)},[f]);const g=u.useMemo(()=>({client_thread_id:s,message_id:l,conversationId:m}),[s,l,m]);u.useEffect(()=>{i&&O.logEvent(A.receivedA8KM123Message,g)},[i]);const d=u.useCallback(()=>{O.logEvent(A.openedA8KM123Message,{...g,isStreaming:e})},[g,e]);return a.jsx(tn,{status:e?Me.Running:Me.Finished,highlightedCommand:e?n:((x=c.metadata)==null?void 0:x.finished_text)??"",onOpenAnalytics:d,children:i?a.jsx("div",{className:"mb-4 border-l-2 pl-4 dark:border-token-text-secondary",children:a.jsx(qs,{componentOverrides:wm,className:"not-prose leading-6",children:f})}):null})}const Cm=fe(()=>ce(()=>import("./sso-wherv7nuadrq5lwl.js").then(t=>t.l),__vite__mapDeps([27,1,2,3,28,5,6,13,29,30,31,32,33,34,10,35,7,12,36,37,38,39,40,25,15,41,42,43,44,45,18,21,24,46,19,20,47,48,49,50,51,52,53,54,55,56,57,23,58,59,60,61,62,17,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,4,8,9,11,14,81])).then(t=>t.default).catch(()=>kt)),Im=fe(()=>ce(()=>import("./sso-wherv7nuadrq5lwl.js").then(t=>t.J),__vite__mapDeps([27,1,2,3,28,5,6,13,29,30,31,32,33,34,10,35,7,12,36,37,38,39,40,25,15,41,42,43,44,45,18,21,24,46,19,20,47,48,49,50,51,52,53,54,55,56,57,23,58,59,60,61,62,17,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,4,8,9,11,14,81])).then(t=>t.JawboneMessage).catch(()=>kt)),Tm=fe(()=>ce(()=>import("./nubefgodcf9auqfw.js"),__vite__mapDeps([83,1,2,3,5,6,12,7,15,16,17,18,10,19,20,21,22,23,24,14,25,26]))),jm=fe(()=>ce(()=>import("./lef0meq529p5sfxe.js"),__vite__mapDeps([84,1,2,3]))),Mm=fe(()=>ce(()=>import("./gf68msj5qmlu0ac1.js"),__vite__mapDeps([85,1,2,3,5,6,12,7,15,16,17,18,10,19,20,21,22,23,24,14,25,26]))),Rm=fe(()=>ce(()=>import("./c7u7k2xj5hs6a9i7.js"),__vite__mapDeps([86,1,2,3,5,6,12,7])).then(t=>t.TextMessageEditor)),Em=fe(()=>ce(()=>import("./ctsdaoaqt15rs8o8.js"),__vite__mapDeps([87,1,2,3,5,6,7,12,15,16,17,18,10,19,20,21,22,23,24,14,25,26]))),Am=fe(()=>ce(()=>import("./k2xaglsw4nmvc5wc.js"),__vite__mapDeps([88,1,2,3,5,6,12,7,15,16,17,18,10,19,20,21,22,23,24,14,25,26]))),Nm=fe(()=>ce(()=>import("./ir6q8tly4h9ztz7l.js"),__vite__mapDeps([89,1,2,3,5,6,25,15,12,7,40,16,17,18,10,19,20,21,22,23,24,14,26])).then(t=>t.BrowsingMessage)),Pm=fe(()=>ce(()=>import("./hpmr41wsjihrk7ov.js"),__vite__mapDeps([90,1,2,3,5,6,12,7,15,16,17,18,10,19,20,21,22,23,24,14,25,26])).then(t=>t.SearchResultMessage)),Dm=fe(()=>ce(()=>import("./d5e87ynk6cehldp6.js"),__vite__mapDeps([91,1,2,3,5,6,15,12,7,17,18])).then(t=>t.GizmoContactsMessage)),Fm=fe(()=>ce(()=>import("./kasrkb3l8202c3ce.js"),__vite__mapDeps([92,1,2,3,5,6,15,12,7,25,16,17,18,10,19,20,21,22,23,24,14,26])).then(t=>t.JITPluginMessage));function kf(t){switch(t.type){case E.Text:case E.Debug:return[t.message];case E.MultiText:case E.Browsing:case E.CodeInterpreter:case E.JITPlugin:case E.RetrievalBrowsing:case E.ParallelBrowsing:case E.Dalle:case E.GizmoEditor:case E.SearchResult:case E.GizmoContacts:case E.a8km123:case E.Canmore:case E.Jawbone:case E.SearchGPTQuery:return t.messages;default:throw new Error("Bad")}}function Cf({groupedMessagesToRender:t,allGroupedMessages:e,clientThreadId:s,isEditing:n,isUserTurn:o,isCompletionRequestInProgress:i,isFeedbackEnabled:r,isFinalTurn:c,turnIndex:l,hasActiveRequest:m,showEditButton:f=!1,handleEnterEdit:g,handleExitEdit:d,onChangeItemInView:v,onRequestMoreCompletions:x,onRequestCompletion:h,shouldGrowContainer:S=!0}){const{showDebugConversationTurns:M}=Ba(),I=Vs(s),T=t.map((y,_)=>{var P,N,D,R,Y,L,H,le,ae,Z,K,j,b;const k=_===e.length-1;switch(y.type){case E.Text:case E.MultiText:{const F=t[_-1],X=F==null?void 0:F.type,ne=F&&"messages"in F?F.messages:void 0;if(y.type===E.Text){const V=n?a.jsx(Rm,{message:y.message,clientThreadId:s,onChangeItemInView:v,onRequestCompletion:h,onRequestMoreCompletions:x,onExitEdit:d,disabled:m}):a.jsx(nm,{className:"min-h-[20px]",message:y.message,isFeedbackEnabled:r,isCompletionInProgress:k&&i,turnIndex:l,clientThreadId:s,showEditButton:f,onEnterEdit:g,isUserTurn:o,onRequestMoreCompletions:x,prevGroupedMessageType:X,prevGroupedMessages:ne});return a.jsxs(u.Fragment,{children:[V,a.jsx(Sc,{isUserTurn:o,message:y.message.message})]},"group-"+y.message.nodeId)}else return y.type===E.MultiText?a.jsx(Mm,{clientThreadId:s,messages:y.messages,isCompletionInProgress:k&&i,isFeedbackEnabled:r,onRequestMoreCompletions:x,prevGroupedMessageType:X,prevGroupedMessages:ne},"multitext-"+(((P=y.messages[0])==null?void 0:P.nodeId)??_)):y.type}case E.Browsing:case E.RetrievalBrowsing:{const F=I!=null&&[Ce.GizmoInteraction,Ce.GizmoMagicCreate,Ce.GizmoTest].includes(I.kind);return a.jsx(Nm,{messages:y.messages,isRequestActive:m,isLastMessageInTurn:k,isUsingGizmo:F,isRetrieval:y.type===E.RetrievalBrowsing},"browsing-"+(((N=y.messages[0])==null?void 0:N.nodeId)??_))}case E.SearchGPTQuery:{const F=e[_+1];return a.jsx(Sm,{isRequestActive:m,isLastMessage:k,nextMessage:F&&F.type===E.Text?F.message:void 0},"searchquery-"+(((D=y.messages[0])==null?void 0:D.nodeId)??_))}case E.a8km123:return a.jsx(km,{messages:y.messages,isStreaming:k&&i,clientThreadId:s},"sum-"+(((R=y.messages[0])==null?void 0:R.nodeId)??_));case E.Jawbone:{const F=_+1<e.length?e[_+1]:void 0;return a.jsx(Im,{nextMessage:F&&F.type===E.Debug?F.message:void 0,isLastMessage:k,isRequestActive:m},"jawbone-"+(((Y=y.messages[0])==null?void 0:Y.nodeId)??_))}case E.ParallelBrowsing:return a.jsx(Am,{messages:y.messages},"parallel-"+(((L=y.messages[0])==null?void 0:L.nodeId)??_));case E.CodeInterpreter:return a.jsx(ym,{messages:y.messages,isRequestActive:m,clientThreadId:s},"ada-"+(((H=y.messages[0])==null?void 0:H.nodeId)??_));case E.JITPlugin:return a.jsx(Fm,{messages:y.messages,clientThreadId:s,isLastTurnInConversation:c,onRequestCompletion:h},"jit-"+(((le=y.messages[0])==null?void 0:le.nodeId)??_));case E.GizmoContacts:return a.jsx(Dm,{messages:y.messages,clientThreadId:s,isLastTurnInConversation:c,onRequestCompletion:h},"gizmo-contacts-"+(((ae=y.messages[0])==null?void 0:ae.nodeId)??_));case E.Dalle:return a.jsx(Em,{messages:y.messages,clientThreadId:s},"dalle-"+(((Z=y.messages[0])==null?void 0:Z.nodeId)??_));case E.GizmoEditor:return a.jsx(Tm,{messages:y.messages},"gizmo-editor-"+(((K=y.messages[0])==null?void 0:K.nodeId)??_));case E.Canmore:return a.jsx(Cm,{clientThreadId:s,messages:y.messages,isRequestActive:m},"canmore-"+(((j=y.messages[0])==null?void 0:j.nodeId)??_));case E.Debug:return M?a.jsx(jm,{message:y.message},"debug-"+y.message.nodeId):null;case E.SearchResult:return a.jsx(Pm,{messages:y.messages},"search-result-"+(((b=y.messages[0])==null?void 0:b.nodeId)??_))}});return a.jsx(Lm,{shouldGrowContainer:S,children:T})}function Om(){return a.jsx(wc,{type:"danger",children:a.jsx(U,{id:"daIg0P",defaultMessage:"Unable to display this message due to a error."})})}function Lm({children:t,shouldGrowContainer:e}){return a.jsx("div",{className:G({"flex max-w-full flex-col":!0,"flex-grow":e}),children:a.jsx(ki,{name:"GroupedMessages",fallback:Om,children:t})})}function Xn(t,e){t.updateNodeMetadata(e.id,{completionSampleFinishTime:Date.now()})}class Bm{constructor(e,s,n,o,i,r,c,l,m,f,g,d){z(this,"currentTree");z(this,"currentNodeId");z(this,"firstResponse",!0);z(this,"didCreateFirstCompletionInNewThread",!1);z(this,"activeBranchLastMessage");z(this,"messagesToUpdate",{});z(this,"allIncompleteStreamedMessages",{});z(this,"responseThreadId");z(this,"isCompletionBlocked",!1);z(this,"isEitherFlagged",!1);z(this,"variantsInStreamInfo");z(this,"activeBranchNodeId");z(this,"blurDuringCompletionTracker",new Cc);z(this,"completionLatencyTracker");z(this,"turnTracker");z(this,"debouncedUpdateCompletion",Ic(()=>{this.isCompletionBlocked||C.updateTree(this.clientThreadId,e=>{Object.values(this.messagesToUpdate).forEach(s=>{e.updateNodeMessage(s.id,s)})}),this.messagesToUpdate={}},50,{leading:!0,maxWait:50}));z(this,"handleResponse",async e=>{if(this.turnTracker.onUpdateEventCount(),this.completionLatencyTracker.onResponse(e,this.activeBranchLastMessage,this.responseThreadId),this.responseThreadId===void 0&&"conversationId"in e){const s=e.conversationId;this.responseThreadId=s,$a(this.clientThreadId)&&C.getServerThreadId(this.clientThreadId)!==s&&(C.setServerIdForNewThread(this.clientThreadId,s),O.logEvent(A.attributeClientThreadToServerThread,{client_thread_id:this.clientThreadId,server_thread_id:s}))}switch(e.type){case"error":this.handleError(e);break;case"num_variants_in_stream":this.bindVariantInfoToTree(e);break;case"moderation":this.handleModeration(e);break;case"url_moderation":this.handleUrlModeration(e);break;case"message":this.handleMessage(e),this.debouncedUpdateCompletion();break;case"done":this.handleDone();break;case"gizmo_inline_review":this.handleGizmoInlineReview(e);break;case"title_generation":this.handleTitleGeneration(e);break;case"conversation_detail_metadata":this.handleConversationDetailMetadata(e);break}});this.queryClient=e,this.clientThreadId=s,this.targetNodeId=n,this.completionType=o,this.model=i,this.eventSource=r,this.navigate=c,this.callModelAgain=m,this.onCompletionFinished=f,this.isHistoryAndTrainingDisabled=d,this.currentTree=C.getTree(s),this.currentNodeId=n,this.activeBranchLastMessage=this.currentTree.getMessage(this.currentNodeId),this.completionLatencyTracker=new kc(l),this.turnTracker=g,this.turnTracker.onCompletionStarted(o,this.model)}handleError(e){const s=e.error,n=(s==null?void 0:s.message)||"Something went wrong",o=s instanceof Ge&&s.code||"",i=s instanceof Ge&&s.status,r=s instanceof Ge?s.canRetry:void 0;switch(this.turnTracker.handleRawError(n,i),C.updateTree(this.clientThreadId,c=>{c.updateNodeMessage(this.currentNodeId,this.activeBranchLastMessage),c.updateNodeMetadata(this.currentNodeId,{err:n,errType:"danger",errCode:o,completionSampleFinishTime:Date.now(),canRetry:r})}),o){case _t.ContentPolicy:case _t.ContentOrTos:case ws:case Ci:break;default:n!==void 0&&He.logEvent("chatgpt_conversation_error_web",n)}this.blurDuringCompletionTracker.onMessageError(),this.cleanUp(),this.onCompletionFinished(this.responseThreadId),s instanceof Ge&&(s==null?void 0:s.code)===ws&&(s!=null&&s.clearsIn)&&(Tc(new Date(Date.now()+s.clearsIn*1e3).toISOString()),setTimeout(()=>{jc()},s.clearsIn*1e3))}handleGizmoInlineReview(e){C.setPromptGptRating(this.clientThreadId,e.gizmoId)}handleTitleGeneration(e){C.setTitle(this.clientThreadId,e.title,qa.Generated)}handleConversationDetailMetadata(e){const{default_model_slug:s}=e;s&&C.setThreadModelId(this.clientThreadId,s),xs.updateDetails(e)}bindVariantInfoToTree(e){this.variantsInStreamInfo=e,C.updateTree(this.clientThreadId,s=>{const n=s.getParentPromptNode(this.currentNodeId);s.updateNodeMetadata(n.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}handleModeration(e){const{isCompletion:s,messageId:n,conversationId:o,flagged:i,blocked:r,disclaimers:c,metadata:l}=e,m=!!(c!=null&&c.length)&&s;(i||r||m)&&(this.isEitherFlagged=!0,r&&s&&(this.isCompletionBlocked=!0),C.updateTree(this.clientThreadId,f=>{const g=f.messageIdToNodeId(n);r&&f.clearNodeMessageParts(g),f.updateNodeMetadata(g,{...(m&&!!(c!=null&&c.length)&&Ii(c,r))??{},...i&&Ti,...r&&(l!=null&&l.model_incompatibility?ji:Mi),completionSampleFinishTime:Date.now()})}),O.logEvent(s?r?A.completionBlockedByModeration:A.completionFlaggedByModeration:r?A.promptBlockedByModeration:A.promptFlaggedByModeration,{threadId:o,id:n}))}handleUrlModeration(e){const{conversationId:s,url:n,isSafe:o}=e;o&&C.addThreadSafeUrl(s,n)}handleMessage(e){var i,r,c,l,m,f,g,d,v,x,h,S,M;let s=!0;const{message:n,conversationId:o}=e;if((n==null?void 0:n.author.role)===be.Tool?this.turnTracker.onMessageUpdate((i=n.metadata)==null?void 0:i.model_slug,(r=n.metadata)==null?void 0:r.gizmo_id,n.author.name):this.turnTracker.onMessageUpdate((c=n.metadata)==null?void 0:c.model_slug,(l=n.metadata)==null?void 0:l.gizmo_id,void 0),this.firstResponse&&!this.currentTree.hasReceivedServerCompletion){if((n==null?void 0:n.author.role)===be.System){const I=(m=n.metadata)!=null&&m.parent_id?this.currentTree.getNodeByIdOrMessageId(n.metadata.parent_id):void 0;if((I==null?void 0:I.message.author.role)!==be.User){this.currentTree.appendSystemMessageToRoot(n);return}}else if((n==null?void 0:n.author.role)===be.User)return;if(this.currentTree.hasNodeOrMessageId(n.id))return}if(this.firstResponse&&((f=n.metadata)!=null&&f.rebase_system_message)){C.updateTree(this.clientThreadId,I=>{var y;if(((y=n.metadata)==null?void 0:y.parent_id)==null)throw Error("Unexpected rebased system message without parent");const T=I.getNodeByIdOrMessageId(this.targetNodeId);I.deleteNode(this.targetNodeId),I.addNode(n.id,n,n.metadata.parent_id,n.author.role),I.addNode(T.id,T.message,n.id,T.message.author.role)});return}if(this.firstResponse){const I=((g=lt.getState().threads[this.clientThreadId])==null?void 0:g.continuingFromSharedConversationId)!=null;C.removeContinuingFromSharedConversationId(this.clientThreadId),this.firstResponse=!1,this.didCreateFirstCompletionInNewThread=!this.currentTree.hasReceivedServerCompletion||I,C.updateTree(this.clientThreadId,y=>{y.updateNodeMessage(this.currentNodeId,n)}),this.didCreateFirstCompletionInNewThread&&Cs.onCreate(this.navigate,o,this.queryClient,this.isHistoryAndTrainingDisabled);const T={id:this.targetNodeId,threadId:o,completionType:this.completionType,eventSource:this.eventSource,model:this.model};if(this.completionType===Ke.Next){const y=lt.getState().threads[o],_=(d=y==null?void 0:y.conversationTurns)==null?void 0:d.length,k=(v=y==null?void 0:y.conversationTurns)==null?void 0:v.filter(N=>N.role==be.User),P=k&&((x=k[k.length-1])==null?void 0:x.messages[0].message);if((P==null?void 0:P.content.content_type)==Yt.Text){const N=P.content.parts.join("").length,D=(k==null?void 0:k.length)??0;T.countConversationTurns=_,T.countUserSubmittedMessages=D,T.countLastUserPromptTextMessageLength=N}}O.logEvent(A.generateCompletion,T)}else if(this.completionType!==Ke.Continue){const I=this.currentTree.containsNodeOrMessageId(n.id),T=(h=n.metadata)==null?void 0:h.parent_id;if(I||(this.debouncedUpdateCompletion.flush(),C.updateTree(this.clientThreadId,y=>{if(T==null)throw new Error(`Received a message with no parentId: ${JSON.stringify(n)}`);y.addNode(n.id,n,T,be.Assistant)})),T!=null&&T===this.activeBranchNodeId){const y=this.allIncompleteStreamedMessages[T];y!=null&&(C.updateTree(this.clientThreadId,_=>{Xn(_,y)}),delete this.allIncompleteStreamedMessages[T])}if(s=(((S=this.variantsInStreamInfo)==null?void 0:S.num_variants_in_stream)??1)===1||this.activeBranchNodeId==null||this.activeBranchNodeId===n.id||this.currentTree.isAncestorOfNode(this.activeBranchNodeId,n.id),s&&this.activeBranchNodeId!==n.id){this.activeBranchNodeId=n.id,this.currentNodeId=n.id;const y=C.getThreadCurrentLeafId(this.clientThreadId);this.currentTree.messageIdToNodeId(this.currentNodeId)!==this.currentTree.messageIdToNodeId(y)&&C.setThreadCurrentLeafId(this.clientThreadId,this.currentNodeId),T!=null&&C.updateTree(this.clientThreadId,_=>{const k=_.getParentPromptNode(n.id);_.updateNodeMetadata(k.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}}if((n==null?void 0:n.author.role)===be.Tool&&(n==null?void 0:n.author.name)==="bio"){const I=(M=n.metadata)==null?void 0:M.gizmo_id;setTimeout(()=>{this.queryClient.invalidateQueries({queryKey:Mc(I)})},5e3)}s&&(this.activeBranchLastMessage=n),this.messagesToUpdate[n.id]=n,this.allIncompleteStreamedMessages[n.id]=n}async handleDone(){var e,s;if(this.turnTracker.logCompletion({type:ks.Success}),this.isCompletionBlocked||(this.debouncedUpdateCompletion.flush(),this.isEitherFlagged||(this.didCreateFirstCompletionInNewThread&&Cs.onCreateFinished(this.queryClient,this.responseThreadId,this.isHistoryAndTrainingDisabled),this.onCompletionFinished(this.responseThreadId))),C.updateTree(this.clientThreadId,n=>{Object.values(this.allIncompleteStreamedMessages).forEach(o=>{Xn(n,o)})}),Ha.publish({kind:"createConversation",clientThreadId:this.clientThreadId}),this.blurDuringCompletionTracker.onMessageDone(),this.cleanUp(),((s=(e=this.activeBranchLastMessage)==null?void 0:e.metadata)==null?void 0:s.client_actions)!==void 0){const n=await Rc(this.clientThreadId,this.activeBranchLastMessage);n.length>0&&this.callModelAgain(this.currentNodeId,n)}}cleanUp(){setTimeout(()=>{Dl(this.clientThreadId,ha.FINISHED),Hs.removeRequest(this.targetNodeId),C.releaseThread(this.clientThreadId)},0)}}const zm=1e3*30,fs=ya.getTracer("completion"),hs=t=>(t==null?void 0:t.code)==="challenge_required";class gs extends Error{}function Um(t,e,s,n){const o=async(i=null,r=!1)=>{var L,H,le,ae,Z,K;await Ec();const c=new AbortController,l="threadId"in e?e.threadId:void 0,m="continueFromSharedConversationId"in e?e.continueFromSharedConversationId:void 0,f=Ri(),g={action:e.completionType,messages:e.messages.length>0?e.messages:void 0,conversation_id:l,continue_from_shared_conversation_id:l!=null?void 0:m,parent_message_id:e.parentMessageId,model:e.model,timezone_offset_min:new Date().getTimezoneOffset(),variant_purpose:(L=e.completionMetadata)==null?void 0:L.variantPurpose,suggestions:(H=e.completionMetadata)!=null&&H.suggestions?e.completionMetadata.suggestions.map(j=>Cl(j)):void 0,history_and_training_disabled:e.historyDisabled,juice:(le=e.completionMetadata)==null?void 0:le.juice,conversation_mode:(ae=e.completionMetadata)==null?void 0:ae.conversationMode,force_paragen:e.forceParagen,force_paragen_model_slug:e.forceParagenModel,force_nulligen:e.forceNulligen,force_indepth_feedback:e.forceIndepthFeedback,force_rate_limit:e.forceRateLimit,reset_rate_limits:e.resetRateLimits,disable_system_content_toggling:e.disableSystemContentToggling,websocket_request_id:f,source:(Z=e.completionMetadata)==null?void 0:Z.source,system_hints:(K=e.completionMetadata)==null?void 0:K.systemHints,force_use_sse:!Ct.isWebsocketConnected(),conversation_origin:e.conversationOrigin,force_use_search:e.forceUseSearch,client_contextual_info:e.contextualInfo},d=ta(await ea(t));let v="https://chatgpt.com/backend-api";d&&(v="https://chatgpt.com/backend-anon");const x=`${v}/conversation`;let h=!0,S=!0;const M=d?bn.getUnauthHeaders().additionalHeaders:await bn.getAuthedHeaders(),I=Ei(e.chatReq,i??e.arkoseToken,e.turnstileToken,e.proofToken,null),T={...M,...Ac(),...I};let y,_,k;fs.startActiveSpan("completion.response",j=>{y=fs.startSpan("completion.first_response"),_=fs.startSpan("completion.first_token"),k=j});const P=ya.setSpan(Sn.active(),k);function N(j){if(j.data==="[DONE]")c.abort(),k.end(),s({type:"done"}),Mn();else if(j.event!=="ping")try{const b=JSON.parse(j.data);if(b.error){const F=new We(b.error);throw s({type:"error",error:F}),F}else"type"in b?b.type==="gizmo_inline_review"?s({type:"gizmo_inline_review",gizmoId:b.gizmo_id}):b.type==="title_generation"?s({type:"title_generation",title:b.title,conversation_id:b.conversation_id}):b.type==="moderation"?s({type:"moderation",conversationId:b.conversation_id,messageId:b.message_id,isCompletion:b.is_completion,flagged:b.moderation_response.flagged,blocked:b.moderation_response.blocked,disclaimers:b.moderation_response.disclaimers,metadata:b.moderation_response.metadata}):b.type==="url_moderation"?s({type:"url_moderation",conversationId:b.conversation_id,messageId:b.message_id,url:b.url_moderation_result.full_url,isSafe:b.url_moderation_result.is_safe}):b.type==="num_variants_in_stream"?s({type:"num_variants_in_stream",num_variants_in_stream:b.num_variants_in_stream,display_treatment:b.display_treatment}):b.type==="conversation_detail_metadata"&&s(b):(s({type:"message",message:b.message,conversationId:b.conversation_id}),S&&(S=!1,y.end()),h&&b.message.author.role==="assistant"&&b.message.content.content_type==="text"&&b.message.content.parts[0]!==""&&(h=!1,_.end()))}catch(b){if(b instanceof Ge)throw new We(b.message)}}let D=null,R=setTimeout(()=>{D===!0?(O.logEvent(A.asyncResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:ks.Error,error:{reason:"timeout",message:"Async Response Took Too Long to Come Back"}})):D===!1&&(O.logEvent(A.sseResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:ks.Error,error:{reason:"timeout",message:"SSE Response Took Too Long to Come Back"}}))},zm);return ed(f,N,c.signal),Sn.with(P,()=>Nc(x,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...T},body:JSON.stringify(g),signal:c.signal,openWhenHidden:!0,async onopen(j){var X;const b=j.headers.get("content-type")??"",F=j.headers.get("Cf-Ray")??null;if(j.ok&&b.includes("text/event-stream")){D=!1,n(F,e.model,e.turnTracker);return}else if(b.includes("application/json")){const ne=await j.json(),{webSocketUrl:V,fallbackWebSocketUrl:pe,conversationId:W,responseId:ee,expiresAt:_e,websocketRequestId:te}=Xl(ne);if(V!=null&&W!=null&&ee!=null&&te!=null&&_e){D=!0,n(F,e.model,e.turnTracker);try{await td(V,pe,_e,W,ee,te,N,c.signal,R)}catch(p){p instanceof We&&s({type:"error",error:p})}throw new gs}else{const p=(ne==null?void 0:ne.error)??(ne==null?void 0:ne.detail),se=(p==null?void 0:p.message)??p??"Unknown server error";if(p){if(hs(p))throw new Ge(se,j.status,p.code);if(j.status>=500)throw new We(se);{if(((p==null?void 0:p.code)==="expired_session_key"||(p==null?void 0:p.code)==="invalid_api_key"||(p==null?void 0:p.code)==="token_expired")&&typeof window<"u"&&((X=window._oaiHandleSessionExpired)==null||X.call(window,"stream",JSON.stringify(p))),(p==null?void 0:p.code)==="deactivated_workspace"){window.location.href.includes("/workspace/deactivated")||(window.location.href="/workspace/deactivated");return}const de=p==null?void 0:p.can_retry;throw new Ge(se,j.status,p==null?void 0:p.code,p==null?void 0:p.type,void 0,p==null?void 0:p.clears_in,de)}}}}throw new We(wn)},onmessage:j=>{if(D)throw new We(wn);R&&(clearTimeout(R),R=null),N(j)},onerror(j){let b=j instanceof Error?j:new Error(JSON.stringify(j));throw b instanceof gs||D||hs(b)&&!r||(b.message==="Failed to fetch"&&(b=new We(`An error occurred. Either the engine you requested does not exist or there was another issue processing your request. ${ps}`)),b.message==="network error"&&(b=new Ge(`A network error occurred. Please check your connection and try again. ${ps}`,400)),Ai("fetch-error:conversation:new-message",{url:x,message:b==null?void 0:b.message}),s({type:"error",error:b}),Mn(b)),b}})).catch(async j=>{if(hs(j)){if(r)throw new Ge("Failed to complete your call, please try again",j.status);{const b=await Wt.getEnforcementToken(e.chatReq);return o(b,!0)}}j instanceof gs||(De.addError(j),e.turnTracker.handleRawError(j.message??"Something went wrong",j.status))}),c};return o()}function If(t,e,s){const n=pa(),{resolvedTheme:o}=As(),i=o==="dark",r=la(),c=u.useRef(s),l=ga();c.current=s;const m=u.useCallback(async function({model:f,completionType:g,parentNodeId:d,metadata:v,focusOnNewCompletion:x=!0,completionMetadata:h,chatReq:S,arkoseToken:M,turnstileToken:I,proofToken:T,preflightTime:y,extraStreamParams:_,appendMessages:k,updateTree:P,turnTracker:N}){var W,ee,_e,te,p,se,de;Ha.publish({kind:"requestCompletion"});const D=C.getTree(t);C.retainThread(t);const R=Wc(),Y=`${Ni}${t}-${R}`,L=`${t}-${R}`;P==null||P();const H=D.getNodeByIdOrMessageId(d),ae={gizmo_id:(W=H.message.metadata)==null?void 0:W.gizmo_id};(h==null?void 0:h.juice)!=null&&(ae.snorkle_status=1),C.updateTree(t,q=>{q.addNode(Y,"",d,be.Assistant,void 0,ae)}),x&&C.setThreadCurrentLeafId(t,Y);let Z,K=[],j=D.getNodeByIdOrMessageId(H.parentId);for(;j!=null&&(((ee=j.metadata)==null?void 0:ee.isPlaceholderTemplateAssistantWelcomeMessage)===!0||((_e=j.metadata)==null?void 0:_e.isClientCreatedSystemMessage)===!0);){const q=j.message;K.unshift(q);const oe=D.getNodeByIdOrMessageId(j.parentId);Z=((te=oe.message)==null?void 0:te.id)??oe.id,j=oe}if(g===Ke.Next||g===Ke.Variant){const q=D.getNodeByIdOrMessageId(H.parentId);if(Z??(Z=((p=q.message)==null?void 0:p.id)??q.id),K.push(H.message),k){let oe=d;C.updateTree(t,Se=>{for(const J of k)Se.insertNodeBefore(Y,{id:J.id,message:J,parentId:oe,children:[]}),oe=J.id}),K.push(...k)}K=Gm(K,_)}else Z??(Z=H.message.id);const b=C.getServerThreadId(t);b===void 0&&$a(t)&&C.updateInitialThreadDataForNewThread(t,f);async function F(q,oe){const Se=performance.now(),J=await fa();Wt.initializeAndGatherData(J),Ss.initializeAndGatherData(J),_s.initializeAndGatherData(J),C.updateTree(t,ue=>{for(const Pe of oe)ue.addNode(Pe.id,Pe,q,be.Assistant,{completionSampleFinishTime:Date.now()}),q=Pe.id}),C.setThreadCurrentLeafId(t,q);const Ie=await Wt.getEnforcementToken(J),B=await Ss.getEnforcementToken(J),ve=await _s.getEnforcementToken(J);m({model:f,completionType:Ke.Next,parentNodeId:q,metadata:{},chatReq:J,arkoseToken:Ie??null,turnstileToken:B??null,proofToken:ve??null,preflightTime:performance.now()-Se,extraStreamParams:_,turnTracker:N})}N.updateAttachmentCount(K);const X=new Bm(n,t,Y,g,f,v.eventSource,r,L,F,(...q)=>c.current(...q),N,l),ne=(q,oe,Se)=>{q&&Se.onReceivedRequestId(q),Pc(L,oe,q,y)},V={is_dark_mode:i,time_since_loaded:Math.floor(performance.now()/1e3),page_height:window==null?void 0:window.innerHeight,page_width:window==null?void 0:window.innerWidth,pixel_ratio:window==null?void 0:window.devicePixelRatio,screen_height:(se=window==null?void 0:window.screen)==null?void 0:se.height,screen_width:(de=window==null?void 0:window.screen)==null?void 0:de.width},pe=await Um(n,{conversationOrigin:C.getConversationOrigin(t),model:f,completionType:g,threadId:b,continueFromSharedConversationId:e,historyDisabled:l,parentMessageId:Z,messages:K,chatReq:S,arkoseToken:M??null,turnstileToken:I??null,proofToken:T??null,completionMetadata:h,..._,turnTracker:N,contextualInfo:V},X.handleResponse,ne);Hs.addRequest(Y,pe,N),go.onCompletionRequestStarted(Y)},[t,n,r,e,l,i]);return m}const Gm=(t,e)=>{let s=t;return(e==null?void 0:e.forceUseSearch)===!1&&t.length>0&&(s=t.map(n=>{const{system_hints:o,...i}=n.metadata||{};return{...n,metadata:{...i,system_hints:o==null?void 0:o.filter(r=>r!==it.Search)}}})),s};export{uo as A,Cf as C,_f as F,Sf as G,Uu as P,vf as T,tn as a,Me as b,gf as c,uf as d,Od as e,hf as f,ro as g,ff as h,am as i,ho as j,Yu as k,Zs as l,wf as m,ad as n,bf as o,mf as p,Gd as q,pf as r,xf as s,yf as t,If as u,Lu as v,kf as w,sd as x,Ud as y,Ct as z};
//# sourceMappingURL=ca08h3hs9zu59e15.js.map
