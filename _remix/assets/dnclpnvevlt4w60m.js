const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/sso-ipuhfmti911l5wbt.js","assets/ofly9yrztlesgrye.js","assets/pbk6784aea0pnvmy.js","assets/root-cmvuzs81.css","assets/nqzijea2w2642vxo.js","assets/index-small-c8xg50op.css","assets/ffzjrrth2s7rj53y.js","assets/hgskjx43egewob6w.js","assets/lj5rtlp3i0cfoffa.js","assets/d4ayzlfdvw3mppxq.js","assets/nhwwej1nq0zrd7sc.js","assets/bioahmdl0dhuzf2s.js","assets/ndz7khihe98mo9mr.js","assets/m35een31x7hl7one.js","assets/h7f61j8yt7zvajch.js","assets/cxynijnwgmoep20m.js","assets/kyhim0cxnn9lnc9c.js","assets/c4wbs9sfbozms9h9.js","assets/d0g8ptgc5gcqjwyj.js","assets/iketqivbiq1uua6y.js","assets/f50xww4ndvvgi9wd.js","assets/isjdmfmhzv09v01t.js","assets/hiowkoznbcbuyj5y.js","assets/nr3n8xw311uli2v7.js","assets/du2biz3bflj3ny15.js","assets/dqjxcbzr89kaex61.js","assets/m56qawl3nz8ab6w3.js","assets/eni5d61fsksdl3xv.js","assets/cpruitoywmh2hmz7.js","assets/ip1g1wxksvlp6l12.js","assets/giz03xvnujeqild8.js","assets/mspfsragw34dubp8.js","assets/nja8bkvzwivp0d1e.js","assets/26qzd5j5c4gu7vgg.js","assets/ebjnzfyjozehhu1d.js","assets/hxk29e4mntnfdwo1.js","assets/g6g5o5sxy8te57v6.js","assets/cjrwfkkoj3f7v9aq.js","assets/fsddy3bxlesj6ecw.js","assets/j2pqa1cuq7toz2li.js","assets/lgunmrbg0zk74byl.js","assets/fjwokyxx7t8vavyv.js","assets/otl3kmh55r9mpho8.js","assets/mgd2lih2oegztyuc.js","assets/o7xzgyksykwpw458.js","assets/jhuun61paojcem1l.js","assets/kk3g11g1tx1qyiou.js","assets/nfegrk5dyqdjzy1l.js","assets/kqwdyvkaaavvn8k3.js","assets/knrqgejkx7kf6de9.js","assets/muiq032a7v6lqwp1.js","assets/j793iupxz6cbek3f.js","assets/jgtw8bw0po3nqr9k.js","assets/crv9067h7en0x84a.js","assets/pdyd96jvf5nj4arp.js","assets/cfu4tlrhgvcp30sx.js","assets/c9ruca640f27asij.js","assets/fs11lsv0j2bplke3.js","assets/f57vlzxujq1abxlh.js","assets/iej0cupg2dqkmejt.js","assets/gt5btci5dtrnoaqo.js","assets/k8blgkgtyu77dvqj.js","assets/ngly12g8pku877oj.js","assets/gijjijf6bgeseo0o.js","assets/jddbarybj7ituzga.js","assets/nlwvsjzhecxypowl.js","assets/shared-mk6ngktc.css","assets/i7lxzk5wl4daufg5.js","assets/mrlqxqghd8fc4s3q.js","assets/sso-ibshx6th.css","assets/k91hjk4k5trlg30x.js","assets/kc58xbimy8wdgqxx.js","assets/o5cwi3uc9dagkivp.js","assets/o70b5rlocd70y24d.js","assets/kdfb7z4c9wk9qcaq.js","assets/j8udrimwvg5wgb50.js","assets/o72bhizxu5dr6xab.js","assets/de1sh4yg7kfyvnat.js","assets/ba7bhfdkajmvt0h4.js","assets/h61j7juun17jlipc.js","assets/ch7m0dtn3tkgxchl.js","assets/pdkvk4o7mhuecbpo.js","assets/mb9f30xbxwu6hage.js","assets/ktco86tc31me1kno.js","assets/khibibvll96oqiww.js","assets/md59z0s55jl7efgb.js","assets/xo04pgxauy0sokrl.js","assets/olemw1ilowewv5z3.js","assets/jbrorneya2zaabc8.js","assets/pfkiqelxmyef7oy9.js","assets/h3gsuuatifr9wuhu.js","assets/gjdw252hn2nkbxlt.js","assets/cedf28omz6l9fq0n.js","assets/eqr28ld2ct19pnp8.js","assets/e3wvc95rncvkhskv.js","assets/dtqnuz2p9woh73gu.js","assets/sn3xcrw3vrcc2hpz.js","assets/f3yoq3eqacn2jfld.js"])))=>i.map(i=>d[i]);
var Im=Object.defineProperty;var zc=n=>{throw TypeError(n)};var Am=(n,e,t)=>e in n?Im(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var ie=(n,e,t)=>Am(n,typeof e!="symbol"?e+"":e,t),ua=(n,e,t)=>e.has(n)||zc("Cannot "+t);var C=(n,e,t)=>(ua(n,e,"read from private field"),t?t.call(n):e.get(n)),De=(n,e,t)=>e.has(n)?zc("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),oe=(n,e,t,s)=>(ua(n,e,"write to private field"),s?s.call(n,t):e.set(n,t),t),se=(n,e,t)=>(ua(n,e,"access private method"),t);var Br=(n,e,t,s)=>({set _(i){oe(n,e,i,t)},get _(){return C(n,e,s)}});import{hM as Rm,K as Dm,hN as Yu,hI as Qu,bY as Rl,bX as Bo,b_ as Lo,e as vs,hO as Dl,hP as jm,hQ as Om,hR as Pm,hS as Mt,hT as Fm,hU as Xr,hV as Lr,hW as Bm,hX as Xu,bu as Uc,r as jl,c$ as Lm,bk as zo,ay as Uo,g7 as zm,fu as Ol,eO as Vo,hY as Um,cg as Tr,hZ as Vm,h_ as Zu,ax as eh,a8 as dr,aT as th,eQ as Qt,h$ as An,u as Fn,A as Xs,aS as Gm,bE as nh,fz as Wm,bW as Hm,i0 as sh,i1 as ih,i2 as qm,i3 as Ai,i4 as wt,i5 as rh,i6 as Ha,fc as $m,i7 as Km,i8 as Jm,i9 as Ym,dZ as Qm,bF as Go,gI as Xm,dJ as oh,p as Zm,ia as eg,ib as ah,ic as lh,eR as Er,gM as po,id as gs,gD as Zs,ie as ha,ig as tg,s as Pl,ih as Vc,ii as ch,ij as mo,ik as Fl,il as Bl,im as dh,io as uh,dE as hh,gF as fh,dC as ph,dD as mh,ip as ng,iq as sg,hz as Ll,ir as ig,is as gh,hA as zl,it as Ul,iu as zr,iv as rg,iw as og,ix as ag,gG as go,aa as yh,iy as lg,iz as cg,iA as dg,cU as ug,iB as Gc,iC as hg,h7 as fg,h8 as pg,iD as xh,iE as mg,iF as bh,iG as qa,iH as Sh,iI as gg,bQ as yg,bO as xg,iJ as bg,iK as Sg,aD as Vl,eS as wg,iL as kg,iM as Cg,iN as Mg,R as wh,dS as ii,iO as vg,iP as Wc,a1 as yo,iQ as $a,iR as Tg,o as kh,U as Ri,aq as Gl,iS as Eg,iT as _g,iU as Ng,iV as Ig,iW as Ag,ce as Ch,dF as Rg,fV as Dg,fU as xo,iX as jg,iY as Og,iZ as Pg,a0 as Wl,i_ as bo,i$ as Mh,aQ as ur,j0 as Fg,fR as Wo,j1 as Bg,q as Hl,eP as Hc,eT as Lg,j2 as vh,j3 as zg,j4 as Ug,ao as Vg,j5 as Gg,aK as Th,j6 as Eh,j7 as Ls,j8 as Wg,j9 as Hg,ja as qg,jb as _h,n as $g,jc as Kg,_ as Zr,aF as Ka,aE as Jg,i as Yg,cf as Qg,h as qc,jd as Xg,G as de,je as Zg,jf as ey,jg as ty,jh as Nh,ji as ny,hf as Ur,jj as fa,jk as sy,hd as iy,hi as ry,hj as Ih,jl as oy,jm as ay,C as ly,jn as ir,jo as cy,jp as dy,jq as uy,jr as hy,js as fy,jt as ql,gr as Ah,dG as py,ju as my,jv as gy,bU as yy,fG as xy,aO as hr,fs as by,jw as Rh,jx as Sy,jy as Dh,g as So,cp as wo,cq as $l,dY as wy,eU as jh,j as ky,jz as Cy,jA as My,cd as vy,jB as Ty,jC as Ey,jD as _y,jE as Ny,jF as Iy,jG as Ay,jH as Ry,jI as Dy,O as rn,b0 as jy,aH as Oy,B as Py,fT as Oh,b3 as Ph,jJ as Fy,aJ as pa,D as By,gb as Ly,fb as zy,jK as Uy,dO as Vy,jL as Gy,c3 as Wy,bB as Hy,dP as $c,jM as qy,hk as $y,jN as Ky,jO as Jy,jP as Yy,jQ as Qy,jR as Xy,b$ as Zy,jS as ex,jT as tx,jU as nx,jV as sx,v as ix,jW as rx,jX as ox,fi as Kc,jY as ax,a2 as lx,jZ as cx,j_ as dx,j$ as ux,k0 as hx,k1 as fx,k2 as px,k3 as mx,k4 as gx}from"./nqzijea2w2642vxo.js";import{h as Kl,i as yx,f as Ho,j as Fh,c as Jl,e as Bh,k as xx,b as _r,l as bx,S as Sx,u as Lh,G as wx,a as kx}from"./d4ayzlfdvw3mppxq.js";import{S as Fi,cL as es,af as Yl,a2 as ln,da as Cx,C as Je,r as S,fs as fr,bd as Bi,ft as Mx,fu as zh,D as je,j as c,H as qe,Z as jt,bM as as,fv as Ja,cM as vx,P as ee,x as $,bF as ot,eV as qo,b6 as at,fw as Uh,eN as Vh,I as et,G as U,bc as Ya,c as te,dC as ri,by as Tx,fh as Ql,bz as Xt,b5 as It,b8 as Nr,fx as Gh,w as Ex,a0 as _x,L as ko,bK as Nx,F as _t,eY as Wh,cB as Ue,fy as Xl,bn as Hh,bP as Co,bO as zt,ai as ts,N as Ix,O as Ax,Q as Rx,J as Dx,cT as jx,fz as Zl,cx as Ox,bl as Ir,aC as qh,fA as Px,eQ as Fx,eI as Bx,cc as We,bS as Ve,aq as Li,ei as Lx,eK as ec,d2 as tc,d3 as pr,d4 as Mo,ar as Ar,dP as zx,fB as Ux,a7 as ns,fC as Vx,fD as Gx,fE as nc,dX as On,fF as $h,cZ as vo,z as $o,fG as cn,dY as Wx,au as Qn,a8 as sc,c1 as Rr,fH as Hx,fI as Jc,ch as Ko,fJ as qx,dB as $x,cf as Kh,co as Kx,fK as Jx,bZ as un,fL as Jh,ej as Yx,cr as Qx,cs as Xx,cv as rr,ct as Yc,cu as Zx,fM as eb,cR as Yh,fN as tb,fO as nb,u as ic,cn as Jo,d8 as Qh,as as sb,at as ib,an as Ji,eX as rb,cP as Yi,e1 as mr,b$ as ob,bw as mt,cz as Xh,dD as ab,M as qn,E as Zh,fP as lb,fQ as Qc,b0 as cb,b1 as db,eB as ub,b3 as zs,fR as hb,fS as fb,fT as pb,fU as mb,fV as ef,X as Xc,fW as gb,fX as Zc,fY as ed,fZ as yb,f_ as xb,aw as bb,f$ as Sb,bi as wb,cl as kb,g0 as Cb,e6 as Mb,g1 as vb,eO as Tb,be as Eb,a_ as _b}from"./ofly9yrztlesgrye.js";import{I as tf,e as nf,u as Ts,J as Nb,g as td,a as Ib,K as Ab,L as Rb,G as Db,M as jb}from"./c4wbs9sfbozms9h9.js";import{j as zi,f as sf,i as Xn,G as Ob,T as O,c as rc,q as Es,g as Ot,B as rf,H as Pb,u as Ui,e as hn,a as Bn,d as Dr,k as ei,I as oc,J as of,K as Fb,L as Bb,y as ac,M as af,N as nd,z as sd,O as Lb,b as lf,P as zb,Q as Ub,R as Vb,S as Gb,U as cf,r as Wb,s as Hb,V as df,D as uf,W as qb,X as $b,Y as Kb,Z as Jb,_ as hf}from"./hgskjx43egewob6w.js";import{G as Yb,T as Qb}from"./o70b5rlocd70y24d.js";import{u as ff,t as To,i as pf,S as Xb,a as mf,T as lc,M as cc,b as gf,H as Zb,c as e0,d as t0,e as n0,G as s0,L as i0,f as r0,g as o0}from"./kdfb7z4c9wk9qcaq.js";import{_ as yf,E as gr,Y as Yo,bq as a0,ax as xf,bN as l0,R as c0,b8 as bf,bO as d0,U as dc,an as u0,bP as h0,aG as f0,a2 as Sf,x as p0,bf as Qo,aH as wf,b2 as m0,bJ as g0,bK as y0,X as x0,bQ as b0,u as S0,al as uc,am as hc,B as w0,ak as k0,aj as C0,a1 as M0,az as v0,ah as T0,bR as E0,bS as _0,r as N0,bA as I0}from"./pbk6784aea0pnvmy.js";import{a as A0}from"./j8udrimwvg5wgb50.js";import{m as gt}from"./lj5rtlp3i0cfoffa.js";import{u as R0,P as D0,I as j0}from"./pdyd96jvf5nj4arp.js";import{d as Xo,e as O0,f as P0,C as F0}from"./ndz7khihe98mo9mr.js";import{D as ve,$ as kf,B as B0}from"./ffzjrrth2s7rj53y.js";import{c as L0,d as z0,e as U0}from"./m35een31x7hl7one.js";import{f as Cf,h as Mf,b as V0,g as G0}from"./du2biz3bflj3ny15.js";import{G as vf,a as W0}from"./eni5d61fsksdl3xv.js";import{i as Tf,a as H0,g as q0,b as $0,c as K0}from"./dqjxcbzr89kaex61.js";import{a as J0}from"./ngly12g8pku877oj.js";import{I as Y0,B as Q0}from"./nr3n8xw311uli2v7.js";import{H as X0}from"./o72bhizxu5dr6xab.js";const Z0=n=>{const{asPath:e,replace:t}=Fi(),s=es(),i=zi();Yl({queryKey:["conversation",n],queryFn:()=>sf(n).catch(r=>{const o=Rm(e),a=o!=null?tf(o):"/";throw t(a,void 0,{shallow:!0}),ln.danger(`Unable to load conversation ${n}`),r}),enabled:!Xn(n)&&!s&&!i})};function eS(n){return`${nf(n)}`}function x_(n,e){Dm(eS(n)),e&&ln.info(e)}function tS(n){return n.some(e=>e.type===Cx.JIT_PLUGIN)}function nS(n){return"gizmo_id"in n?n.gizmo_id??null:null}const sS=n=>["conversation","init",n],iS=({clientThreadId:n,conversationMode:e,clientModelId:t})=>{const s=nS(e),i=Xn(n)?null:n;return{gcTime:0,refetchOnWindowFocus:!0,refetchOnMount:"always",queryKey:sS(n),queryFn:()=>Je.getConversationDetails({conversationId:i,gizmoId:s,requestedDefaultModel:t})}},rS=n=>Yl(iS(n)),oS=(n,e)=>{const t=(typeof n=="string"?[n]:n)??[];for(const s of t)if(s&&e.has(s))return s;return null},b_=(n,e)=>{const t=Kl(),{query:s}=Fi(),i=yx(s),{modelId:r=null}=Yu()??{};Z0(n);const o=Ob(n)??null,a=[i,o,r],l=oS(a,t);S.useEffect(()=>{O.initThread(n,e,l),fr.reset()},[n]);const d=Bi(),u=S.useCallback(()=>{const g={...s};delete g.model;const x=Mx.stringify(g);d({search:x.length>0?`?${x}`:""})},[s,d]),{isLoading:p,data:m}=rS({clientThreadId:n,clientModelId:a.find(g=>!!g)??null,conversationMode:e}),b=zh();S.useEffect(()=>{if(!(!i||p)){if(!t.has(i)||b.find(g=>g.model_slug===i))return u();O.setThreadModelId(n,i)}},[i,b,t,n]),S.useEffect(()=>{if(p||!m)return;const{default_model_slug:g}=m;i&&g&&i!==g&&u(),fr.updateDetails(m),g&&O.setThreadModelId(n,g)},[p,m])};function ma({label:n,tooltip:e,Icon:t}){return c.jsxs("div",{className:"flex items-center gap-1 text-sm font-semibold opacity-70",children:[t&&c.jsx(t,{className:"icon-sm"}),c.jsx("div",{children:n}),c.jsx(vs,{label:e,children:c.jsx(gr,{className:"icon-sm ml-1"})})]})}function aS({clientThreadId:n,gizmoId:e}){const t=je(),s=Qu(),i=Rl(),r=Bo(),{data:o}=Lo(e,!1,r),a=!!e,l=es(),d=rc(n);return r?l&&(!d||a)?c.jsx(ma,{label:t.formatMessage(mi.temporaryChat),tooltip:t.formatMessage(mi.temporaryChatTooltip),Icon:yf}):s&&!i&&!l?c.jsx(ma,{label:t.formatMessage(mi.memoryOff),tooltip:t.formatMessage(mi.memoryOffTooltip)}):o&&(o==null?void 0:o.memoryFullPct)>=100?c.jsx(ma,{label:t.formatMessage(mi.memoryFull),tooltip:t.formatMessage(mi.memoryFullTooltip)}):null:null}const mi=qe({temporaryChat:{id:"ConversationPrivacyIndicator.temporaryChat",defaultMessage:"Temporary Chat"},temporaryChatTooltip:{id:"ConversationPrivacyIndicator.temporaryChatTooltip",defaultMessage:"Temporary Chats won't appear in your history, and ChatGPT won't remember anything you talk about."},memoryOff:{id:"ConversationPrivacyIndicator.memoryOff",defaultMessage:"Memory Off"},memoryOffTooltip:{id:"ConversationPrivacyIndicator.memoryOffTooltip",defaultMessage:"ChatGPT won't remember anything you talk about in this conversation."},memoryFull:{id:"2Eq+5y",defaultMessage:"Memory Full"},memoryFullTooltip:{id:"dNA8jQ",defaultMessage:"ChatGPT's memory is full. You can forget existing memories to make space."}});/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(n){const e=jm,t=Om,s=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;n.Buffer=a,n.SlowBuffer=N,n.INSPECT_MAX_BYTES=50;const i=2147483647;n.kMaxLength=i,a.TYPED_ARRAY_SUPPORT=r(),!a.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function r(){try{const y=new Uint8Array(1),h={foo:function(){return 42}};return Object.setPrototypeOf(h,Uint8Array.prototype),Object.setPrototypeOf(y,h),y.foo()===42}catch{return!1}}Object.defineProperty(a.prototype,"parent",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.buffer}}),Object.defineProperty(a.prototype,"offset",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.byteOffset}});function o(y){if(y>i)throw new RangeError('The value "'+y+'" is invalid for option "size"');const h=new Uint8Array(y);return Object.setPrototypeOf(h,a.prototype),h}function a(y,h,f){if(typeof y=="number"){if(typeof h=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return p(y)}return l(y,h,f)}a.poolSize=8192;function l(y,h,f){if(typeof y=="string")return m(y,h);if(ArrayBuffer.isView(y))return g(y);if(y==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof y);if(tt(y,ArrayBuffer)||y&&tt(y.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(tt(y,SharedArrayBuffer)||y&&tt(y.buffer,SharedArrayBuffer)))return x(y,h,f);if(typeof y=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const w=y.valueOf&&y.valueOf();if(w!=null&&w!==y)return a.from(w,h,f);const v=k(y);if(v)return v;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof y[Symbol.toPrimitive]=="function")return a.from(y[Symbol.toPrimitive]("string"),h,f);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof y)}a.from=function(y,h,f){return l(y,h,f)},Object.setPrototypeOf(a.prototype,Uint8Array.prototype),Object.setPrototypeOf(a,Uint8Array);function d(y){if(typeof y!="number")throw new TypeError('"size" argument must be of type number');if(y<0)throw new RangeError('The value "'+y+'" is invalid for option "size"')}function u(y,h,f){return d(y),y<=0?o(y):h!==void 0?typeof f=="string"?o(y).fill(h,f):o(y).fill(h):o(y)}a.alloc=function(y,h,f){return u(y,h,f)};function p(y){return d(y),o(y<0?0:M(y)|0)}a.allocUnsafe=function(y){return p(y)},a.allocUnsafeSlow=function(y){return p(y)};function m(y,h){if((typeof h!="string"||h==="")&&(h="utf8"),!a.isEncoding(h))throw new TypeError("Unknown encoding: "+h);const f=A(y,h)|0;let w=o(f);const v=w.write(y,h);return v!==f&&(w=w.slice(0,v)),w}function b(y){const h=y.length<0?0:M(y.length)|0,f=o(h);for(let w=0;w<h;w+=1)f[w]=y[w]&255;return f}function g(y){if(tt(y,Uint8Array)){const h=new Uint8Array(y);return x(h.buffer,h.byteOffset,h.byteLength)}return b(y)}function x(y,h,f){if(h<0||y.byteLength<h)throw new RangeError('"offset" is outside of buffer bounds');if(y.byteLength<h+(f||0))throw new RangeError('"length" is outside of buffer bounds');let w;return h===void 0&&f===void 0?w=new Uint8Array(y):f===void 0?w=new Uint8Array(y,h):w=new Uint8Array(y,h,f),Object.setPrototypeOf(w,a.prototype),w}function k(y){if(a.isBuffer(y)){const h=M(y.length)|0,f=o(h);return f.length===0||y.copy(f,0,0,h),f}if(y.length!==void 0)return typeof y.length!="number"||He(y.length)?o(0):b(y);if(y.type==="Buffer"&&Array.isArray(y.data))return b(y.data)}function M(y){if(y>=i)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+i.toString(16)+" bytes");return y|0}function N(y){return+y!=y&&(y=0),a.alloc(+y)}a.isBuffer=function(h){return h!=null&&h._isBuffer===!0&&h!==a.prototype},a.compare=function(h,f){if(tt(h,Uint8Array)&&(h=a.from(h,h.offset,h.byteLength)),tt(f,Uint8Array)&&(f=a.from(f,f.offset,f.byteLength)),!a.isBuffer(h)||!a.isBuffer(f))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(h===f)return 0;let w=h.length,v=f.length;for(let E=0,R=Math.min(w,v);E<R;++E)if(h[E]!==f[E]){w=h[E],v=f[E];break}return w<v?-1:v<w?1:0},a.isEncoding=function(h){switch(String(h).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},a.concat=function(h,f){if(!Array.isArray(h))throw new TypeError('"list" argument must be an Array of Buffers');if(h.length===0)return a.alloc(0);let w;if(f===void 0)for(f=0,w=0;w<h.length;++w)f+=h[w].length;const v=a.allocUnsafe(f);let E=0;for(w=0;w<h.length;++w){let R=h[w];if(tt(R,Uint8Array))E+R.length>v.length?(a.isBuffer(R)||(R=a.from(R)),R.copy(v,E)):Uint8Array.prototype.set.call(v,R,E);else if(a.isBuffer(R))R.copy(v,E);else throw new TypeError('"list" argument must be an Array of Buffers');E+=R.length}return v};function A(y,h){if(a.isBuffer(y))return y.length;if(ArrayBuffer.isView(y)||tt(y,ArrayBuffer))return y.byteLength;if(typeof y!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof y);const f=y.length,w=arguments.length>2&&arguments[2]===!0;if(!w&&f===0)return 0;let v=!1;for(;;)switch(h){case"ascii":case"latin1":case"binary":return f;case"utf8":case"utf-8":return Be(y).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return f*2;case"hex":return f>>>1;case"base64":return lt(y).length;default:if(v)return w?-1:Be(y).length;h=(""+h).toLowerCase(),v=!0}}a.byteLength=A;function T(y,h,f){let w=!1;if((h===void 0||h<0)&&(h=0),h>this.length||((f===void 0||f>this.length)&&(f=this.length),f<=0)||(f>>>=0,h>>>=0,f<=h))return"";for(y||(y="utf8");;)switch(y){case"hex":return F(this,h,f);case"utf8":case"utf-8":return J(this,h,f);case"ascii":return ye(this,h,f);case"latin1":case"binary":return L(this,h,f);case"base64":return V(this,h,f);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return xe(this,h,f);default:if(w)throw new TypeError("Unknown encoding: "+y);y=(y+"").toLowerCase(),w=!0}}a.prototype._isBuffer=!0;function _(y,h,f){const w=y[h];y[h]=y[f],y[f]=w}a.prototype.swap16=function(){const h=this.length;if(h%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let f=0;f<h;f+=2)_(this,f,f+1);return this},a.prototype.swap32=function(){const h=this.length;if(h%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let f=0;f<h;f+=4)_(this,f,f+3),_(this,f+1,f+2);return this},a.prototype.swap64=function(){const h=this.length;if(h%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let f=0;f<h;f+=8)_(this,f,f+7),_(this,f+1,f+6),_(this,f+2,f+5),_(this,f+3,f+4);return this},a.prototype.toString=function(){const h=this.length;return h===0?"":arguments.length===0?J(this,0,h):T.apply(this,arguments)},a.prototype.toLocaleString=a.prototype.toString,a.prototype.equals=function(h){if(!a.isBuffer(h))throw new TypeError("Argument must be a Buffer");return this===h?!0:a.compare(this,h)===0},a.prototype.inspect=function(){let h="";const f=n.INSPECT_MAX_BYTES;return h=this.toString("hex",0,f).replace(/(.{2})/g,"$1 ").trim(),this.length>f&&(h+=" ... "),"<Buffer "+h+">"},s&&(a.prototype[s]=a.prototype.inspect),a.prototype.compare=function(h,f,w,v,E){if(tt(h,Uint8Array)&&(h=a.from(h,h.offset,h.byteLength)),!a.isBuffer(h))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof h);if(f===void 0&&(f=0),w===void 0&&(w=h?h.length:0),v===void 0&&(v=0),E===void 0&&(E=this.length),f<0||w>h.length||v<0||E>this.length)throw new RangeError("out of range index");if(v>=E&&f>=w)return 0;if(v>=E)return-1;if(f>=w)return 1;if(f>>>=0,w>>>=0,v>>>=0,E>>>=0,this===h)return 0;let R=E-v,ne=w-f;const Re=Math.min(R,ne),_e=this.slice(v,E),ge=h.slice(f,w);for(let fe=0;fe<Re;++fe)if(_e[fe]!==ge[fe]){R=_e[fe],ne=ge[fe];break}return R<ne?-1:ne<R?1:0};function j(y,h,f,w,v){if(y.length===0)return-1;if(typeof f=="string"?(w=f,f=0):f>2147483647?f=2147483647:f<-2147483648&&(f=-2147483648),f=+f,He(f)&&(f=v?0:y.length-1),f<0&&(f=y.length+f),f>=y.length){if(v)return-1;f=y.length-1}else if(f<0)if(v)f=0;else return-1;if(typeof h=="string"&&(h=a.from(h,w)),a.isBuffer(h))return h.length===0?-1:P(y,h,f,w,v);if(typeof h=="number")return h=h&255,typeof Uint8Array.prototype.indexOf=="function"?v?Uint8Array.prototype.indexOf.call(y,h,f):Uint8Array.prototype.lastIndexOf.call(y,h,f):P(y,[h],f,w,v);throw new TypeError("val must be string, number or Buffer")}function P(y,h,f,w,v){let E=1,R=y.length,ne=h.length;if(w!==void 0&&(w=String(w).toLowerCase(),w==="ucs2"||w==="ucs-2"||w==="utf16le"||w==="utf-16le")){if(y.length<2||h.length<2)return-1;E=2,R/=2,ne/=2,f/=2}function Re(ge,fe){return E===1?ge[fe]:ge.readUInt16BE(fe*E)}let _e;if(v){let ge=-1;for(_e=f;_e<R;_e++)if(Re(y,_e)===Re(h,ge===-1?0:_e-ge)){if(ge===-1&&(ge=_e),_e-ge+1===ne)return ge*E}else ge!==-1&&(_e-=_e-ge),ge=-1}else for(f+ne>R&&(f=R-ne),_e=f;_e>=0;_e--){let ge=!0;for(let fe=0;fe<ne;fe++)if(Re(y,_e+fe)!==Re(h,fe)){ge=!1;break}if(ge)return _e}return-1}a.prototype.includes=function(h,f,w){return this.indexOf(h,f,w)!==-1},a.prototype.indexOf=function(h,f,w){return j(this,h,f,w,!0)},a.prototype.lastIndexOf=function(h,f,w){return j(this,h,f,w,!1)};function B(y,h,f,w){f=Number(f)||0;const v=y.length-f;w?(w=Number(w),w>v&&(w=v)):w=v;const E=h.length;w>E/2&&(w=E/2);let R;for(R=0;R<w;++R){const ne=parseInt(h.substr(R*2,2),16);if(He(ne))return R;y[f+R]=ne}return R}function I(y,h,f,w){return ct(Be(h,y.length-f),y,f,w)}function q(y,h,f,w){return ct(Se(h),y,f,w)}function G(y,h,f,w){return ct(lt(h),y,f,w)}function D(y,h,f,w){return ct(it(h,y.length-f),y,f,w)}a.prototype.write=function(h,f,w,v){if(f===void 0)v="utf8",w=this.length,f=0;else if(w===void 0&&typeof f=="string")v=f,w=this.length,f=0;else if(isFinite(f))f=f>>>0,isFinite(w)?(w=w>>>0,v===void 0&&(v="utf8")):(v=w,w=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const E=this.length-f;if((w===void 0||w>E)&&(w=E),h.length>0&&(w<0||f<0)||f>this.length)throw new RangeError("Attempt to write outside buffer bounds");v||(v="utf8");let R=!1;for(;;)switch(v){case"hex":return B(this,h,f,w);case"utf8":case"utf-8":return I(this,h,f,w);case"ascii":case"latin1":case"binary":return q(this,h,f,w);case"base64":return G(this,h,f,w);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return D(this,h,f,w);default:if(R)throw new TypeError("Unknown encoding: "+v);v=(""+v).toLowerCase(),R=!0}},a.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function V(y,h,f){return h===0&&f===y.length?e.fromByteArray(y):e.fromByteArray(y.slice(h,f))}function J(y,h,f){f=Math.min(y.length,f);const w=[];let v=h;for(;v<f;){const E=y[v];let R=null,ne=E>239?4:E>223?3:E>191?2:1;if(v+ne<=f){let Re,_e,ge,fe;switch(ne){case 1:E<128&&(R=E);break;case 2:Re=y[v+1],(Re&192)===128&&(fe=(E&31)<<6|Re&63,fe>127&&(R=fe));break;case 3:Re=y[v+1],_e=y[v+2],(Re&192)===128&&(_e&192)===128&&(fe=(E&15)<<12|(Re&63)<<6|_e&63,fe>2047&&(fe<55296||fe>57343)&&(R=fe));break;case 4:Re=y[v+1],_e=y[v+2],ge=y[v+3],(Re&192)===128&&(_e&192)===128&&(ge&192)===128&&(fe=(E&15)<<18|(Re&63)<<12|(_e&63)<<6|ge&63,fe>65535&&fe<1114112&&(R=fe))}}R===null?(R=65533,ne=1):R>65535&&(R-=65536,w.push(R>>>10&1023|55296),R=56320|R&1023),w.push(R),v+=ne}return X(w)}const W=4096;function X(y){const h=y.length;if(h<=W)return String.fromCharCode.apply(String,y);let f="",w=0;for(;w<h;)f+=String.fromCharCode.apply(String,y.slice(w,w+=W));return f}function ye(y,h,f){let w="";f=Math.min(y.length,f);for(let v=h;v<f;++v)w+=String.fromCharCode(y[v]&127);return w}function L(y,h,f){let w="";f=Math.min(y.length,f);for(let v=h;v<f;++v)w+=String.fromCharCode(y[v]);return w}function F(y,h,f){const w=y.length;(!h||h<0)&&(h=0),(!f||f<0||f>w)&&(f=w);let v="";for(let E=h;E<f;++E)v+=ft[y[E]];return v}function xe(y,h,f){const w=y.slice(h,f);let v="";for(let E=0;E<w.length-1;E+=2)v+=String.fromCharCode(w[E]+w[E+1]*256);return v}a.prototype.slice=function(h,f){const w=this.length;h=~~h,f=f===void 0?w:~~f,h<0?(h+=w,h<0&&(h=0)):h>w&&(h=w),f<0?(f+=w,f<0&&(f=0)):f>w&&(f=w),f<h&&(f=h);const v=this.subarray(h,f);return Object.setPrototypeOf(v,a.prototype),v};function re(y,h,f){if(y%1!==0||y<0)throw new RangeError("offset is not uint");if(y+h>f)throw new RangeError("Trying to access beyond buffer length")}a.prototype.readUintLE=a.prototype.readUIntLE=function(h,f,w){h=h>>>0,f=f>>>0,w||re(h,f,this.length);let v=this[h],E=1,R=0;for(;++R<f&&(E*=256);)v+=this[h+R]*E;return v},a.prototype.readUintBE=a.prototype.readUIntBE=function(h,f,w){h=h>>>0,f=f>>>0,w||re(h,f,this.length);let v=this[h+--f],E=1;for(;f>0&&(E*=256);)v+=this[h+--f]*E;return v},a.prototype.readUint8=a.prototype.readUInt8=function(h,f){return h=h>>>0,f||re(h,1,this.length),this[h]},a.prototype.readUint16LE=a.prototype.readUInt16LE=function(h,f){return h=h>>>0,f||re(h,2,this.length),this[h]|this[h+1]<<8},a.prototype.readUint16BE=a.prototype.readUInt16BE=function(h,f){return h=h>>>0,f||re(h,2,this.length),this[h]<<8|this[h+1]},a.prototype.readUint32LE=a.prototype.readUInt32LE=function(h,f){return h=h>>>0,f||re(h,4,this.length),(this[h]|this[h+1]<<8|this[h+2]<<16)+this[h+3]*16777216},a.prototype.readUint32BE=a.prototype.readUInt32BE=function(h,f){return h=h>>>0,f||re(h,4,this.length),this[h]*16777216+(this[h+1]<<16|this[h+2]<<8|this[h+3])},a.prototype.readBigUInt64LE=Le(function(h){h=h>>>0,Ee(h,"offset");const f=this[h],w=this[h+7];(f===void 0||w===void 0)&&ae(h,this.length-8);const v=f+this[++h]*2**8+this[++h]*2**16+this[++h]*2**24,E=this[++h]+this[++h]*2**8+this[++h]*2**16+w*2**24;return BigInt(v)+(BigInt(E)<<BigInt(32))}),a.prototype.readBigUInt64BE=Le(function(h){h=h>>>0,Ee(h,"offset");const f=this[h],w=this[h+7];(f===void 0||w===void 0)&&ae(h,this.length-8);const v=f*2**24+this[++h]*2**16+this[++h]*2**8+this[++h],E=this[++h]*2**24+this[++h]*2**16+this[++h]*2**8+w;return(BigInt(v)<<BigInt(32))+BigInt(E)}),a.prototype.readIntLE=function(h,f,w){h=h>>>0,f=f>>>0,w||re(h,f,this.length);let v=this[h],E=1,R=0;for(;++R<f&&(E*=256);)v+=this[h+R]*E;return E*=128,v>=E&&(v-=Math.pow(2,8*f)),v},a.prototype.readIntBE=function(h,f,w){h=h>>>0,f=f>>>0,w||re(h,f,this.length);let v=f,E=1,R=this[h+--v];for(;v>0&&(E*=256);)R+=this[h+--v]*E;return E*=128,R>=E&&(R-=Math.pow(2,8*f)),R},a.prototype.readInt8=function(h,f){return h=h>>>0,f||re(h,1,this.length),this[h]&128?(255-this[h]+1)*-1:this[h]},a.prototype.readInt16LE=function(h,f){h=h>>>0,f||re(h,2,this.length);const w=this[h]|this[h+1]<<8;return w&32768?w|4294901760:w},a.prototype.readInt16BE=function(h,f){h=h>>>0,f||re(h,2,this.length);const w=this[h+1]|this[h]<<8;return w&32768?w|4294901760:w},a.prototype.readInt32LE=function(h,f){return h=h>>>0,f||re(h,4,this.length),this[h]|this[h+1]<<8|this[h+2]<<16|this[h+3]<<24},a.prototype.readInt32BE=function(h,f){return h=h>>>0,f||re(h,4,this.length),this[h]<<24|this[h+1]<<16|this[h+2]<<8|this[h+3]},a.prototype.readBigInt64LE=Le(function(h){h=h>>>0,Ee(h,"offset");const f=this[h],w=this[h+7];(f===void 0||w===void 0)&&ae(h,this.length-8);const v=this[h+4]+this[h+5]*2**8+this[h+6]*2**16+(w<<24);return(BigInt(v)<<BigInt(32))+BigInt(f+this[++h]*2**8+this[++h]*2**16+this[++h]*2**24)}),a.prototype.readBigInt64BE=Le(function(h){h=h>>>0,Ee(h,"offset");const f=this[h],w=this[h+7];(f===void 0||w===void 0)&&ae(h,this.length-8);const v=(f<<24)+this[++h]*2**16+this[++h]*2**8+this[++h];return(BigInt(v)<<BigInt(32))+BigInt(this[++h]*2**24+this[++h]*2**16+this[++h]*2**8+w)}),a.prototype.readFloatLE=function(h,f){return h=h>>>0,f||re(h,4,this.length),t.read(this,h,!0,23,4)},a.prototype.readFloatBE=function(h,f){return h=h>>>0,f||re(h,4,this.length),t.read(this,h,!1,23,4)},a.prototype.readDoubleLE=function(h,f){return h=h>>>0,f||re(h,8,this.length),t.read(this,h,!0,52,8)},a.prototype.readDoubleBE=function(h,f){return h=h>>>0,f||re(h,8,this.length),t.read(this,h,!1,52,8)};function Z(y,h,f,w,v,E){if(!a.isBuffer(y))throw new TypeError('"buffer" argument must be a Buffer instance');if(h>v||h<E)throw new RangeError('"value" argument is out of bounds');if(f+w>y.length)throw new RangeError("Index out of range")}a.prototype.writeUintLE=a.prototype.writeUIntLE=function(h,f,w,v){if(h=+h,f=f>>>0,w=w>>>0,!v){const ne=Math.pow(2,8*w)-1;Z(this,h,f,w,ne,0)}let E=1,R=0;for(this[f]=h&255;++R<w&&(E*=256);)this[f+R]=h/E&255;return f+w},a.prototype.writeUintBE=a.prototype.writeUIntBE=function(h,f,w,v){if(h=+h,f=f>>>0,w=w>>>0,!v){const ne=Math.pow(2,8*w)-1;Z(this,h,f,w,ne,0)}let E=w-1,R=1;for(this[f+E]=h&255;--E>=0&&(R*=256);)this[f+E]=h/R&255;return f+w},a.prototype.writeUint8=a.prototype.writeUInt8=function(h,f,w){return h=+h,f=f>>>0,w||Z(this,h,f,1,255,0),this[f]=h&255,f+1},a.prototype.writeUint16LE=a.prototype.writeUInt16LE=function(h,f,w){return h=+h,f=f>>>0,w||Z(this,h,f,2,65535,0),this[f]=h&255,this[f+1]=h>>>8,f+2},a.prototype.writeUint16BE=a.prototype.writeUInt16BE=function(h,f,w){return h=+h,f=f>>>0,w||Z(this,h,f,2,65535,0),this[f]=h>>>8,this[f+1]=h&255,f+2},a.prototype.writeUint32LE=a.prototype.writeUInt32LE=function(h,f,w){return h=+h,f=f>>>0,w||Z(this,h,f,4,4294967295,0),this[f+3]=h>>>24,this[f+2]=h>>>16,this[f+1]=h>>>8,this[f]=h&255,f+4},a.prototype.writeUint32BE=a.prototype.writeUInt32BE=function(h,f,w){return h=+h,f=f>>>0,w||Z(this,h,f,4,4294967295,0),this[f]=h>>>24,this[f+1]=h>>>16,this[f+2]=h>>>8,this[f+3]=h&255,f+4};function ke(y,h,f,w,v){Qe(h,w,v,y,f,7);let E=Number(h&BigInt(4294967295));y[f++]=E,E=E>>8,y[f++]=E,E=E>>8,y[f++]=E,E=E>>8,y[f++]=E;let R=Number(h>>BigInt(32)&BigInt(4294967295));return y[f++]=R,R=R>>8,y[f++]=R,R=R>>8,y[f++]=R,R=R>>8,y[f++]=R,f}function be(y,h,f,w,v){Qe(h,w,v,y,f,7);let E=Number(h&BigInt(4294967295));y[f+7]=E,E=E>>8,y[f+6]=E,E=E>>8,y[f+5]=E,E=E>>8,y[f+4]=E;let R=Number(h>>BigInt(32)&BigInt(4294967295));return y[f+3]=R,R=R>>8,y[f+2]=R,R=R>>8,y[f+1]=R,R=R>>8,y[f]=R,f+8}a.prototype.writeBigUInt64LE=Le(function(h,f=0){return ke(this,h,f,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeBigUInt64BE=Le(function(h,f=0){return be(this,h,f,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeIntLE=function(h,f,w,v){if(h=+h,f=f>>>0,!v){const Re=Math.pow(2,8*w-1);Z(this,h,f,w,Re-1,-Re)}let E=0,R=1,ne=0;for(this[f]=h&255;++E<w&&(R*=256);)h<0&&ne===0&&this[f+E-1]!==0&&(ne=1),this[f+E]=(h/R>>0)-ne&255;return f+w},a.prototype.writeIntBE=function(h,f,w,v){if(h=+h,f=f>>>0,!v){const Re=Math.pow(2,8*w-1);Z(this,h,f,w,Re-1,-Re)}let E=w-1,R=1,ne=0;for(this[f+E]=h&255;--E>=0&&(R*=256);)h<0&&ne===0&&this[f+E+1]!==0&&(ne=1),this[f+E]=(h/R>>0)-ne&255;return f+w},a.prototype.writeInt8=function(h,f,w){return h=+h,f=f>>>0,w||Z(this,h,f,1,127,-128),h<0&&(h=255+h+1),this[f]=h&255,f+1},a.prototype.writeInt16LE=function(h,f,w){return h=+h,f=f>>>0,w||Z(this,h,f,2,32767,-32768),this[f]=h&255,this[f+1]=h>>>8,f+2},a.prototype.writeInt16BE=function(h,f,w){return h=+h,f=f>>>0,w||Z(this,h,f,2,32767,-32768),this[f]=h>>>8,this[f+1]=h&255,f+2},a.prototype.writeInt32LE=function(h,f,w){return h=+h,f=f>>>0,w||Z(this,h,f,4,2147483647,-2147483648),this[f]=h&255,this[f+1]=h>>>8,this[f+2]=h>>>16,this[f+3]=h>>>24,f+4},a.prototype.writeInt32BE=function(h,f,w){return h=+h,f=f>>>0,w||Z(this,h,f,4,2147483647,-2147483648),h<0&&(h=4294967295+h+1),this[f]=h>>>24,this[f+1]=h>>>16,this[f+2]=h>>>8,this[f+3]=h&255,f+4},a.prototype.writeBigInt64LE=Le(function(h,f=0){return ke(this,h,f,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),a.prototype.writeBigInt64BE=Le(function(h,f=0){return be(this,h,f,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function le(y,h,f,w,v,E){if(f+w>y.length)throw new RangeError("Index out of range");if(f<0)throw new RangeError("Index out of range")}function he(y,h,f,w,v){return h=+h,f=f>>>0,v||le(y,h,f,4),t.write(y,h,f,w,23,4),f+4}a.prototype.writeFloatLE=function(h,f,w){return he(this,h,f,!0,w)},a.prototype.writeFloatBE=function(h,f,w){return he(this,h,f,!1,w)};function Oe(y,h,f,w,v){return h=+h,f=f>>>0,v||le(y,h,f,8),t.write(y,h,f,w,52,8),f+8}a.prototype.writeDoubleLE=function(h,f,w){return Oe(this,h,f,!0,w)},a.prototype.writeDoubleBE=function(h,f,w){return Oe(this,h,f,!1,w)},a.prototype.copy=function(h,f,w,v){if(!a.isBuffer(h))throw new TypeError("argument should be a Buffer");if(w||(w=0),!v&&v!==0&&(v=this.length),f>=h.length&&(f=h.length),f||(f=0),v>0&&v<w&&(v=w),v===w||h.length===0||this.length===0)return 0;if(f<0)throw new RangeError("targetStart out of bounds");if(w<0||w>=this.length)throw new RangeError("Index out of range");if(v<0)throw new RangeError("sourceEnd out of bounds");v>this.length&&(v=this.length),h.length-f<v-w&&(v=h.length-f+w);const E=v-w;return this===h&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(f,w,v):Uint8Array.prototype.set.call(h,this.subarray(w,v),f),E},a.prototype.fill=function(h,f,w,v){if(typeof h=="string"){if(typeof f=="string"?(v=f,f=0,w=this.length):typeof w=="string"&&(v=w,w=this.length),v!==void 0&&typeof v!="string")throw new TypeError("encoding must be a string");if(typeof v=="string"&&!a.isEncoding(v))throw new TypeError("Unknown encoding: "+v);if(h.length===1){const R=h.charCodeAt(0);(v==="utf8"&&R<128||v==="latin1")&&(h=R)}}else typeof h=="number"?h=h&255:typeof h=="boolean"&&(h=Number(h));if(f<0||this.length<f||this.length<w)throw new RangeError("Out of range index");if(w<=f)return this;f=f>>>0,w=w===void 0?this.length:w>>>0,h||(h=0);let E;if(typeof h=="number")for(E=f;E<w;++E)this[E]=h;else{const R=a.isBuffer(h)?h:a.from(h,v),ne=R.length;if(ne===0)throw new TypeError('The value "'+h+'" is invalid for argument "value"');for(E=0;E<w-f;++E)this[E+f]=R[E%ne]}return this};const ce={};function z(y,h,f){ce[y]=class extends f{constructor(){super(),Object.defineProperty(this,"message",{value:h.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${y}]`,this.stack,delete this.name}get code(){return y}set code(v){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:v,writable:!0})}toString(){return`${this.name} [${y}]: ${this.message}`}}}z("ERR_BUFFER_OUT_OF_BOUNDS",function(y){return y?`${y} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),z("ERR_INVALID_ARG_TYPE",function(y,h){return`The "${y}" argument must be of type number. Received type ${typeof h}`},TypeError),z("ERR_OUT_OF_RANGE",function(y,h,f){let w=`The value of "${y}" is out of range.`,v=f;return Number.isInteger(f)&&Math.abs(f)>2**32?v=Ce(String(f)):typeof f=="bigint"&&(v=String(f),(f>BigInt(2)**BigInt(32)||f<-(BigInt(2)**BigInt(32)))&&(v=Ce(v)),v+="n"),w+=` It must be ${h}. Received ${v}`,w},RangeError);function Ce(y){let h="",f=y.length;const w=y[0]==="-"?1:0;for(;f>=w+4;f-=3)h=`_${y.slice(f-3,f)}${h}`;return`${y.slice(0,f)}${h}`}function Ye(y,h,f){Ee(h,"offset"),(y[h]===void 0||y[h+f]===void 0)&&ae(h,y.length-(f+1))}function Qe(y,h,f,w,v,E){if(y>f||y<h){const R=typeof h=="bigint"?"n":"";let ne;throw h===0||h===BigInt(0)?ne=`>= 0${R} and < 2${R} ** ${(E+1)*8}${R}`:ne=`>= -(2${R} ** ${(E+1)*8-1}${R}) and < 2 ** ${(E+1)*8-1}${R}`,new ce.ERR_OUT_OF_RANGE("value",ne,y)}Ye(w,v,E)}function Ee(y,h){if(typeof y!="number")throw new ce.ERR_INVALID_ARG_TYPE(h,"number",y)}function ae(y,h,f){throw Math.floor(y)!==y?(Ee(y,f),new ce.ERR_OUT_OF_RANGE("offset","an integer",y)):h<0?new ce.ERR_BUFFER_OUT_OF_BOUNDS:new ce.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${h}`,y)}const $e=/[^+/0-9A-Za-z-_]/g;function Ge(y){if(y=y.split("=")[0],y=y.trim().replace($e,""),y.length<2)return"";for(;y.length%4!==0;)y=y+"=";return y}function Be(y,h){h=h||1/0;let f;const w=y.length;let v=null;const E=[];for(let R=0;R<w;++R){if(f=y.charCodeAt(R),f>55295&&f<57344){if(!v){if(f>56319){(h-=3)>-1&&E.push(239,191,189);continue}else if(R+1===w){(h-=3)>-1&&E.push(239,191,189);continue}v=f;continue}if(f<56320){(h-=3)>-1&&E.push(239,191,189),v=f;continue}f=(v-55296<<10|f-56320)+65536}else v&&(h-=3)>-1&&E.push(239,191,189);if(v=null,f<128){if((h-=1)<0)break;E.push(f)}else if(f<2048){if((h-=2)<0)break;E.push(f>>6|192,f&63|128)}else if(f<65536){if((h-=3)<0)break;E.push(f>>12|224,f>>6&63|128,f&63|128)}else if(f<1114112){if((h-=4)<0)break;E.push(f>>18|240,f>>12&63|128,f>>6&63|128,f&63|128)}else throw new Error("Invalid code point")}return E}function Se(y){const h=[];for(let f=0;f<y.length;++f)h.push(y.charCodeAt(f)&255);return h}function it(y,h){let f,w,v;const E=[];for(let R=0;R<y.length&&!((h-=2)<0);++R)f=y.charCodeAt(R),w=f>>8,v=f%256,E.push(v),E.push(w);return E}function lt(y){return e.toByteArray(Ge(y))}function ct(y,h,f,w){let v;for(v=0;v<w&&!(v+f>=h.length||v>=y.length);++v)h[v+f]=y[v];return v}function tt(y,h){return y instanceof h||y!=null&&y.constructor!=null&&y.constructor.name!=null&&y.constructor.name===h.name}function He(y){return y!==y}const ft=function(){const y="0123456789abcdef",h=new Array(256);for(let f=0;f<16;++f){const w=f*16;for(let v=0;v<16;++v)h[w+v]=y[f]+y[v]}return h}();function Le(y){return typeof BigInt>"u"?Ae:y}function Ae(){throw new Error("BigInt not supported")}})(Dl);function lS(n){if(typeof n!="string")throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!n)throw new Error("No input");const e=JSON.parse(n),t=e;let s;if(t.type==="system")if(t.event==="connected")s=Object.assign(Object.assign({},e),{kind:"connected"});else if(t.event==="disconnected")s=Object.assign(Object.assign({},e),{kind:"disconnected"});else return null;else if(t.type==="message")if(t.from==="group"){const i=rd(e.data,e.dataType);if(i===null)return null;s=Object.assign(Object.assign({},e),{data:i,kind:"groupData"})}else if(t.from==="server"){const i=rd(e.data,e.dataType);if(i===null)return null;s=Object.assign(Object.assign({},e),{data:i,kind:"serverData"})}else return null;else if(t.type==="ack")s=Object.assign(Object.assign({},e),{kind:"ack"});else return null;return s}function cS(n){let e;switch(n.kind){case"joinGroup":{e={type:"joinGroup",group:n.group,ackId:n.ackId};break}case"leaveGroup":{e={type:"leaveGroup",group:n.group,ackId:n.ackId};break}case"sendEvent":{e={type:"event",event:n.event,ackId:n.ackId,dataType:n.dataType,data:id(n.data,n.dataType)};break}case"sendToGroup":{e={type:"sendToGroup",group:n.group,ackId:n.ackId,dataType:n.dataType,data:id(n.data,n.dataType),noEcho:n.noEcho};break}case"sequenceAck":{e={type:"sequenceAck",sequenceId:n.sequenceId};break}default:throw new Error(`Unsupported type: ${n.kind}`)}return JSON.stringify(e)}function id(n,e){switch(e){case"text":{if(typeof n!="string")throw new TypeError("Message must be a string.");return n}case"json":return n;case"binary":case"protobuf":{if(n instanceof ArrayBuffer)return Dl.Buffer.from(n).toString("base64");throw new TypeError("Message must be a ArrayBuffer")}}}function rd(n,e){if(e==="text"){if(typeof n!="string")throw new TypeError("Message must be a string when dataType is text");return n}else{if(e==="json")return n;if(e==="binary"||e==="protobuf"){const t=Dl.Buffer.from(n,"base64");return t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}else return null}}class dS{constructor(){this.isReliableSubProtocol=!0,this.name="json.reliable.webpubsub.azure.v1"}parseMessages(e){return lS(e)}writeMessage(e){return cS(e)}}const uS=()=>new dS;var Lt;(function(n){n.Stopped="Stopped",n.Disconnected="Disconnected",n.Connecting="Connecting",n.Connected="Connected",n.Recovering="Recovering"})(Lt||(Lt={}));class hS{nextAckId(){return this._ackId=this._ackId+1,this._ackId}constructor(e,t){this._quickSequenceAckDiff=300,this._activeTimeoutInMs=2e4,this._emitter=new Pm,this._isStopping=!1,this._isInitialConnected=!1,typeof e=="string"?this._credential={getClientAccessUrl:e}:this._credential=e,t==null&&(t={}),this._buildDefaultOptions(t),this._options=t,this._messageRetryPolicy=new od(this._options.messageRetryOptions),this._reconnectRetryPolicy=new od(this._options.reconnectRetryOptions),this._protocol=this._options.protocol,this._groupMap=new Map,this._ackMap=new Map,this._sequenceId=new mS,this._state=Lt.Stopped,this._ackId=0}async start(e){if(this._isStopping)throw new Error("Can't start a client during stopping");if(this._state!==Lt.Stopped)throw new Error("Client can be only started when it's Stopped");let t;e&&(t=e.abortSignal),this._activeKeepaliveTask||(this._activeKeepaliveTask=this._getActiveKeepaliveTask());try{await this._startCore(t)}catch(s){throw this._changeState(Lt.Stopped),this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0),this._isStopping=!1,s}}async _startFromRestarting(e){if(this._state!==Lt.Disconnected)throw new Error("Client can be only restarted when it's Disconnected");try{Mt.verbose("Staring reconnecting."),await this._startCore(e)}catch(t){throw this._changeState(Lt.Disconnected),t}}async _startCore(e){if(this._changeState(Lt.Connecting),Mt.info("Staring a new connection"),this._sequenceId.reset(),this._isInitialConnected=!1,this._lastCloseEvent=void 0,this._lastDisconnectedMessage=void 0,this._connectionId=void 0,this._reconnectionToken=void 0,this._uri=void 0,typeof this._credential.getClientAccessUrl=="string"?this._uri=this._credential.getClientAccessUrl:this._uri=await this._credential.getClientAccessUrl({abortSignal:e}),typeof this._uri!="string")throw new Error(`The clientAccessUrl must be a string but currently it's ${typeof this._uri}`);await this._connectCore(this._uri)}stop(){this._state===Lt.Stopped||this._isStopping||(this._isStopping=!0,this._wsClient&&this._wsClient.isOpen()?this._wsClient.close():this._isStopping=!1,this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0))}on(e,t){this._emitter.on(e,t)}off(e,t){this._emitter.removeListener(e,t)}_emitEvent(e,t){this._emitter.emit(e,t)}async sendEvent(e,t,s,i){return await this._operationExecuteWithRetry(()=>this._sendEventAttempt(e,t,s,i),i==null?void 0:i.abortSignal)}async _sendEventAttempt(e,t,s,i){var r;if(!((r=i==null?void 0:i.fireAndForget)!==null&&r!==void 0?r:!1))return await this._sendMessageWithAckId(l=>({kind:"sendEvent",dataType:s,data:t,ackId:l,event:e}),i==null?void 0:i.ackId,i==null?void 0:i.abortSignal);const a={kind:"sendEvent",dataType:s,data:t,event:e};return await this._sendMessage(a,i==null?void 0:i.abortSignal),{isDuplicated:!1}}async joinGroup(e,t){return await this._operationExecuteWithRetry(()=>this._joinGroupAttempt(e,t),t==null?void 0:t.abortSignal)}async _joinGroupAttempt(e,t){const s=this._getOrAddGroup(e),i=await this._joinGroupCore(e,t);return s.isJoined=!0,i}async _joinGroupCore(e,t){return await this._sendMessageWithAckId(s=>({group:e,ackId:s,kind:"joinGroup"}),t==null?void 0:t.ackId,t==null?void 0:t.abortSignal)}async leaveGroup(e,t){return await this._operationExecuteWithRetry(()=>this._leaveGroupAttempt(e,t),t==null?void 0:t.abortSignal)}async _leaveGroupAttempt(e,t){const s=this._getOrAddGroup(e),i=await this._sendMessageWithAckId(r=>({group:e,ackId:r,kind:"leaveGroup"}),t==null?void 0:t.ackId,t==null?void 0:t.abortSignal);return s.isJoined=!1,i}async sendToGroup(e,t,s,i){return await this._operationExecuteWithRetry(()=>this._sendToGroupAttempt(e,t,s,i),i==null?void 0:i.abortSignal)}async _sendToGroupAttempt(e,t,s,i){var r,o;const a=(r=i==null?void 0:i.fireAndForget)!==null&&r!==void 0?r:!1,l=(o=i==null?void 0:i.noEcho)!==null&&o!==void 0?o:!1;if(!a)return await this._sendMessageWithAckId(u=>({kind:"sendToGroup",group:e,dataType:s,data:t,ackId:u,noEcho:l}),i==null?void 0:i.ackId,i==null?void 0:i.abortSignal);const d={kind:"sendToGroup",group:e,dataType:s,data:t,noEcho:l};return await this._sendMessage(d,i==null?void 0:i.abortSignal),{isDuplicated:!1}}_getWebSocketClientFactory(){return new Fm}async _trySendSequenceAck(){if(!this._protocol.isReliableSubProtocol)return;const[e,t]=this._sequenceId.tryGetSequenceId();if(e&&t){const s={kind:"sequenceAck",sequenceId:t};try{await this._sendMessage(s)}catch{this._sequenceId.tryUpdate(t)}}}_connectCore(e){if(this._isStopping)throw new Error("Can't start a client during stopping");return new Promise((t,s)=>{const i=this._wsClient=this._getWebSocketClientFactory().create(e,this._protocol.name);i.onopen(()=>{if(this._isStopping){try{i.close()}catch{}s(new Error("The client is stopped"))}Mt.verbose("WebSocket connection has opened"),this._changeState(Lt.Connected),this._protocol.isReliableSubProtocol&&(this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),this._sequenceAckTask=new ad(async()=>{await this._trySendSequenceAck()},1e3)),t()}),i.onerror(r=>{this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),s(r)}),i.onclose((r,o)=>{this._state===Lt.Connected?(Mt.verbose("WebSocket closed after open"),this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),Mt.info(`WebSocket connection closed. Code: ${r}, Reason: ${o}`),this._lastCloseEvent={code:r,reason:o},this._handleConnectionClose.call(this)):(Mt.verbose("WebSocket closed before open"),s(new Error(`Failed to start WebSocket: ${r}`)))}),i.onmessage(r=>{const o=m=>{if(this._ackMap.has(m.ackId)){const b=this._ackMap.get(m.ackId);this._ackMap.delete(m.ackId);const g=m.error!=null&&m.error.name==="Duplicate";m.success||g?b.resolve({ackId:m.ackId,isDuplicated:g}):b.reject(new Lr("Failed to send message.",{ackId:m.ackId,errorDetail:m.error}))}},a=async m=>{if(this._connectionId=m.connectionId,this._reconnectionToken=m.reconnectionToken,!this._isInitialConnected){if(this._isInitialConnected=!0,this._options.autoRejoinGroups){const b=[];this._groupMap.forEach(g=>{g.isJoined&&b.push((async()=>{try{await this._joinGroupCore(g.name)}catch(x){this._safeEmitRejoinGroupFailed(g.name,x)}})())});try{await Promise.all(b)}catch{}}this._safeEmitConnected(m.connectionId,m.userId)}},l=m=>{this._lastDisconnectedMessage=m},d=m=>{if(m.sequenceId!=null){const b=this._sequenceId.tryUpdate(m.sequenceId);if(b===0)return;b>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitGroupMessage(m)},u=m=>{if(m.sequenceId!=null){const b=this._sequenceId.tryUpdate(m.sequenceId);if(b===0)return;b>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitServerMessage(m)};let p;try{let m;if(Array.isArray(r)?m=Buffer.concat(r):m=r,p=this._protocol.parseMessages(m),p===null)return}catch(m){throw Mt.warning("An error occurred while parsing the message from service",m),m}Array.isArray(p)||(p=[p]),p.forEach(m=>{try{switch(m.kind){case"ack":{o(m);break}case"connected":{a(m);break}case"disconnected":{l(m);break}case"groupData":{d(m);break}case"serverData":{u(m);break}}}catch(b){Mt.warning(`An error occurred while handling the message with kind: ${m.kind} from service`,b)}})})})}async _handleConnectionCloseAndNoRecovery(){this._state=Lt.Disconnected,this._safeEmitDisconnected(this._connectionId,this._lastDisconnectedMessage),this._options.autoReconnect?await this._autoReconnect():await this._handleConnectionStopped()}async _autoReconnect(){let e=!1,t=0;try{for(;!this._isStopping;)try{await this._startFromRestarting(),e=!0;break}catch(s){Mt.warning("An attempt to reconnect connection failed.",s),t++;const i=this._reconnectRetryPolicy.nextRetryDelayInMs(t);if(i==null)break;try{Mt.verbose(`Delay time for reconnect attempt ${t}: ${i}`),await Xr(i)}catch{}}}finally{e||this._handleConnectionStopped()}}_handleConnectionStopped(){this._isStopping=!1,this._state=Lt.Stopped,this._safeEmitStopped()}_getActiveKeepaliveTask(){return new ad(async()=>{this._sequenceId.tryUpdate(0)},this._activeTimeoutInMs)}async _sendMessage(e,t){if(!this._wsClient||!this._wsClient.isOpen())throw new Error("The connection is not connected.");const s=this._protocol.writeMessage(e);await this._wsClient.send(s,t)}async _sendMessageWithAckId(e,t,s){t==null&&(t=this.nextAckId());const i=e(t);this._ackMap.has(t)||this._ackMap.set(t,new pS(t));const r=this._ackMap.get(t);try{await this._sendMessage(i,s)}catch(o){this._ackMap.delete(t);let a="";throw o instanceof Error&&(a=o.message),new Lr(a,{ackId:t})}if(s)try{return await Bm(r.promise(),s)}catch(o){throw o instanceof Error&&o.name==="AbortError"?new Lr("Cancelled by abortSignal",{ackId:t}):o}return await r.promise()}async _handleConnectionClose(){if(this._ackMap.forEach((i,r)=>{this._ackMap.delete(r)&&i.reject(new Lr("Connection is disconnected before receive ack from the service",{ackId:i.ackId}))}),this._isStopping){Mt.warning("The client is stopping state. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(this._lastCloseEvent&&this._lastCloseEvent.code===1008){Mt.warning("The websocket close with status code 1008. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(!this._protocol.isReliableSubProtocol){Mt.warning("The protocol is not reliable, recovery is not applicable"),this._handleConnectionCloseAndNoRecovery();return}const e=this._buildRecoveryUri();if(!e){Mt.warning("Connection id or reconnection token is not available"),this._handleConnectionCloseAndNoRecovery();return}let t=!1;this._state=Lt.Recovering;const s=Xu.timeout(30*1e3);try{for(;!s.aborted||this._isStopping;)try{await this._connectCore.call(this,e),t=!0;return}catch{await Xr(1e3)}}finally{t||(Mt.warning("Recovery attempts failed more then 30 seconds or the client is stopping"),this._handleConnectionCloseAndNoRecovery())}}_safeEmitConnected(e,t){this._emitEvent("connected",{connectionId:e,userId:t})}_safeEmitDisconnected(e,t){this._emitEvent("disconnected",{connectionId:e,message:t})}_safeEmitGroupMessage(e){this._emitEvent("group-message",{message:e})}_safeEmitServerMessage(e){this._emitEvent("server-message",{message:e})}_safeEmitStopped(){this._emitEvent("stopped",{})}_safeEmitRejoinGroupFailed(e,t){this._emitEvent("rejoin-group-failed",{group:e,error:t})}_buildDefaultOptions(e){return e.autoReconnect==null&&(e.autoReconnect=!0),e.autoRejoinGroups==null&&(e.autoRejoinGroups=!0),e.protocol==null&&(e.protocol=uS()),this._buildMessageRetryOptions(e),this._buildReconnectRetryOptions(e),e}_buildMessageRetryOptions(e){e.messageRetryOptions||(e.messageRetryOptions={}),(e.messageRetryOptions.maxRetries==null||e.messageRetryOptions.maxRetries<0)&&(e.messageRetryOptions.maxRetries=3),(e.messageRetryOptions.retryDelayInMs==null||e.messageRetryOptions.retryDelayInMs<0)&&(e.messageRetryOptions.retryDelayInMs=1e3),(e.messageRetryOptions.maxRetryDelayInMs==null||e.messageRetryOptions.maxRetryDelayInMs<0)&&(e.messageRetryOptions.maxRetryDelayInMs=3e4),e.messageRetryOptions.mode==null&&(e.messageRetryOptions.mode="Fixed")}_buildReconnectRetryOptions(e){e.reconnectRetryOptions||(e.reconnectRetryOptions={}),(e.reconnectRetryOptions.maxRetries==null||e.reconnectRetryOptions.maxRetries<0)&&(e.reconnectRetryOptions.maxRetries=Number.MAX_VALUE),(e.reconnectRetryOptions.retryDelayInMs==null||e.reconnectRetryOptions.retryDelayInMs<0)&&(e.reconnectRetryOptions.retryDelayInMs=1e3),(e.reconnectRetryOptions.maxRetryDelayInMs==null||e.reconnectRetryOptions.maxRetryDelayInMs<0)&&(e.reconnectRetryOptions.maxRetryDelayInMs=3e4),e.reconnectRetryOptions.mode==null&&(e.reconnectRetryOptions.mode="Fixed")}_buildRecoveryUri(){if(this._connectionId&&this._reconnectionToken&&this._uri){const e=new URL(this._uri);return e.searchParams.append("awps_connection_id",this._connectionId),e.searchParams.append("awps_reconnection_token",this._reconnectionToken),e.toString()}return null}_getOrAddGroup(e){return this._groupMap.has(e)||this._groupMap.set(e,new fS(e)),this._groupMap.get(e)}_changeState(e){Mt.verbose(`The client state transfer from ${this._state.toString()} to ${e.toString()}`),this._state=e}async _operationExecuteWithRetry(e,t){let s=0;for(;;)try{return await e.call(this)}catch(i){s++;const r=this._messageRetryPolicy.nextRetryDelayInMs(s);if(r==null||(await Xr(r),t!=null&&t.aborted))throw i}}}class od{constructor(e){this._retryOptions=e,this._maxRetriesToGetMaxDelay=Math.ceil(Math.log2(this._retryOptions.maxRetryDelayInMs)-Math.log2(this._retryOptions.retryDelayInMs)+1)}nextRetryDelayInMs(e){return e>this._retryOptions.maxRetries?null:this._retryOptions.mode==="Fixed"?this._retryOptions.retryDelayInMs:this._calculateExponentialDelay(e)}_calculateExponentialDelay(e){return e>=this._maxRetriesToGetMaxDelay?this._retryOptions.maxRetryDelayInMs:(1<<e-1)*this._retryOptions.retryDelayInMs}}class fS{constructor(e){this.isJoined=!1,this.name=e}}class pS{constructor(e){this._promise=new Promise((t,s)=>{this._resolve=t,this._reject=s}),this.ackId=e}promise(){return this._promise}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}class mS{constructor(){this._sequenceId=0,this._isUpdate=!1}tryUpdate(e){if(this._isUpdate=!0,e>this._sequenceId){const t=e-this._sequenceId;return this._sequenceId=e,t}return 0}tryGetSequenceId(){return this._isUpdate?(this._isUpdate=!1,[!0,this._sequenceId]):[!1,null]}reset(){this._sequenceId=0,this._isUpdate=!1}}class ad{constructor(e,t,s){this._func=e,this._abortController=new Xu,this._interval=t,this._obj=s,this._start()}abort(){try{this._abortController.abort()}catch{}}async _start(){const e=this._abortController.signal;for(;!e.aborted;)try{await this._func(this._obj)}catch{}finally{await Xr(this._interval)}}}const gS=1e3*60*60,yS=1e3*30;class xS{constructor(e,t,s,i=null,r=new Map){ie(this,"client");ie(this,"handler");ie(this,"terminationTimeout",null);ie(this,"connectionUrl");ie(this,"expiresAt");ie(this,"connected",!1);ie(this,"websocketRequestId",null);ie(this,"conversationId",null);ie(this,"secondaryTypeBasedHandlers",new Map);this.connectionUrl=t,this.expiresAt=s,this.client=new hS({getClientAccessUrl:()=>e(this.connectionUrl,this.expiresAt)},{autoReconnect:!0,reconnectRetryOptions:{maxRetries:5,retryDelayInMs:100,maxRetryDelayInMs:1e4,mode:"Exponential"}}),this.handler=i,this.secondaryTypeBasedHandlers=r}async start(){const e=t=>{if(this.secondaryTypeBasedHandlers.has(t.message.data.type)){const s=this.secondaryTypeBasedHandlers.get(t.message.data.type);if(!s)return;s(t.message.data)}else{const s=t.message.data.body,i=atob(s).trim();if(i.startsWith("data: ")){const r=i.replace("data: ",""),o=this.handler;if(!o)return;o({conversationId:t.message.data.conversation_id,responseId:t.message.data.response_id,message:{id:"",event:"",data:r},websocketRequestId:t.message.data.websocket_request_id})}}};this.client.on("group-message",t=>e(t)),this.client.on("server-message",t=>e(t)),this.client.on("connected",()=>{this.connected=!0}),this.client.on("disconnected",()=>{this.connected=!1}),await this.client.start()}addSecondaryTypeHandler(e,t){this.secondaryTypeBasedHandlers.set(e,t)}isConnected(){return this.connected}async stop(e){e&&this.conversationId!==e||this.websocketRequestId&&await Je.stopWebsocketConversation(this.websocketRequestId)}setHandler(e,t,s,i){!this.handler&&this.websocketRequestId===s||(this.handler!=null&&this.websocketRequestId!==s&&(vx.warn("[websockets] Overwriting existing handler without silencing. This may indicate a race condition."),ee.logEvent($.asyncHandlerOverwritten,{originalWebsocketRequestId:this.websocketRequestId,newWebsocketRequestId:s,conversationId:e,responseId:t})),this.websocketRequestId=s,this.conversationId=e,this.handler=r=>{(r.websocketRequestId===s||r.conversationId===e&&r.responseId===t)&&i(r.message)})}silence(){this.handler=null}close(){this.client.stop()}scheduleForTermination(e){this.terminationTimeout=setTimeout(()=>{this.close(),e()},gS)}preventTermination(){this.terminationTimeout&&(clearTimeout(this.terminationTimeout),this.terminationTimeout=null)}updateConnectionUrl(e,t){this.connectionUrl=e,this.expiresAt=t}}class bS{constructor(){ie(this,"activeSocketMap",new Map);ie(this,"secondaryTypeBasedHandlers",new Map)}async register(){const e=await Je.postRegisterWebsocket();e.wss_url&&(this.getOrCreateSocket(e.wss_url,new Date(e.expires_at),!0),e.fallback_wss_url&&this.getOrCreateSocket(e.fallback_wss_url,new Date(e.expires_at),!1))}async registerIfNotConnected(){if(this.activeSocketMap.size===0){await this.register();return}for(const e of this.activeSocketMap.values())if(!e.isConnected()){await this.register();return}}isWebsocketConnected(){for(const e of this.activeSocketMap.values())if(e.isConnected())return!0;return this.activeSocketMap.size>0&&jt.addError("Cannot connect to any websocket."),!1}async getOrCreateSocket(e,t,s){const i=e.split("?")[0];let r;const o=this.activeSocketMap.get(i);if(o&&o.isConnected())o.preventTermination(),o.updateConnectionUrl(e,t),r=o;else{o&&o.close(),r=new xS(async(a,l)=>{if(new Date<new Date(l.getTime()-5*1e3))return a;const d=await Je.postRegisterWebsocket();return s?d.wss_url:d.fallback_wss_url??""},e,t,null,this.secondaryTypeBasedHandlers),this.activeSocketMap.set(i,r);try{await r.start()}catch(a){throw jt.addError(new Error("Error occurred while starting websocket: ",{cause:a})),a}}return r}preSetupWebsocket(e,t,s){for(const i of this.activeSocketMap.values())this.setupWebSocketHandler(i,null,null,null,e,t,s)}addSecondaryTypeHandler(e,t){this.secondaryTypeBasedHandlers.set(e,t);for(const s of this.activeSocketMap.values())s.addSecondaryTypeHandler(e,t)}hasSecondaryTypeHandler(e){return this.secondaryTypeBasedHandlers.has(e)}async processWebSocketConversationStream(e,t,s,i,r,o,a,l,d){const u=[this.getOrCreateSocket(e,s,!0)];t&&u.push(this.getOrCreateSocket(t,s,!1));const p=await Promise.allSettled(u),m=p[0].status==="fulfilled"?p[0].value:null,b=p.length>1&&p[1].status==="fulfilled"?p[1].value:null;if((!m||!m.isConnected())&&jt.addError(`Cannot connect to primary websocket, websocketRequestId: ${o}, token: ${e.substring(0,e.indexOf("access_token="))}`),(!m||!m.isConnected())&&(!b||!b.isConnected()))throw t&&jt.addError(`Cannot connect to fallback websocket, websocketRequestId: ${o}, token: ${t.substring(0,t.indexOf("access_token="))}`),new as(`An error occurred while connecting to the websocket. ${Ja}`);let g=setTimeout(()=>{jt.addError(`WebSocket took too long to respond: ${r}, ${i}, ${o}, ${e.substring(0,60)}...${e.slice(-20)}`,{supportsWebSockets:"WebSocket"in window&&window.WebSocket.CLOSING===2})},yS);const x=k=>(d&&(clearTimeout(d),d=null),g&&(clearTimeout(g),g=null),a(k));m&&this.setupWebSocketHandler(m,e,i,r,o,x,l),b&&t&&this.setupWebSocketHandler(b,t,i,r,o,x,l)}async stopConversation(e){for(const t of this.activeSocketMap.values())await t.stop(e)}setupWebSocketHandler(e,t,s,i,r,o,a){e.setHandler(s,i,r,o),this.secondaryTypeBasedHandlers.forEach((d,u)=>{e.addSecondaryTypeHandler(u,d)});const l=()=>{t?e.scheduleForTermination(()=>{this.activeSocketMap.delete(t.split("?")[0])}):(this.stopConversation(s),e.silence())};a.addEventListener("abort",l)}}const Ss=new bS;function SS(n){return{webSocketUrl:n.wss_url,fallbackWebSocketUrl:n.fallback_wss_url,conversationId:n.conversation_id,responseId:n.response_id,expiresAt:n.expires_at&&new Date(n.expires_at),websocketRequestId:n.websocket_request_id}}async function wS(n,e,t){return Ss.preSetupWebsocket(n,e,t)}async function kS(n,e,t,s,i,r,o,a,l){return Ss.processWebSocketConversationStream(n,e,t,s,i,r,o,a,l)}function eo(n){return n==null||[ot.PrimaryAssistant,ot.GizmoInteraction].includes(n.kind)}function Zo(n,e){const t=Es(n,e),{data:s}=Ts(t!=null&&"gizmo_id"in t?t.gizmo_id:void 0,(t==null?void 0:t.kind)===ot.GizmoTest);if(t!=null)switch(t.kind){case ot.GizmoInteraction:case ot.GizmoMagicCreate:case ot.GizmoTest:return{gizmo:s,...t};case ot.PrimaryAssistant:return t}}function CS(n,e,t){const i=O.getTree(e).getMessageId(O.getThreadCurrentLeafId(e));Je.generateTitle(e,i,t).then(({title:r})=>{O.setTitle(e,r,rf.Generated),jl(n),ee.logEvent($.renameThread,{threadId:e,content:r,model:t})}).catch(jt.addError)}function MS(n,e,t){const s=()=>{const r=td(t);Uc(r)},i=Ot.getGizmoId(t);i!=null?Nb(e,i).then(r=>{Uc(td(t,r))}).catch(r=>{jt.addError(r),s()}):s()}const Qa={onCreate(n){jl(n),ee.logEvent($.newThread)},onCreateFinished(n,e,t){var i;if(qo()||!t)return;if(!at.checkGate("2562876640")){const r=(i=Ot.getThread(t))==null?void 0:i.initialThreadData.lastModelUsed;r==null&&jt.addError("missing lastModelUsed on conversation create finished"),CS(e,t,r)}const s=Ot.getConversationMode(t);eo(s)&&Uh(e).then(r=>{Vh(r)||MS(n,e,t)})}},ld=et.div`m-8 flex flex-col items-center`;function cd(n){return c.jsx(gt.div,{initial:{opacity:0,translateY:20},animate:{opacity:1,translateY:0,transition:{duration:.5,ease:"easeIn"}},...n})}function vS({clientThreadId:n}){const e=Pb(n),t=e==null?void 0:e.gizmoId,{data:s}=Ts(t);return t==null||s==null||!Lm(s)?null:c.jsx(TS,{gizmoId:t})}function TS({gizmoId:n}){const[e,t]=S.useState(!1),[s,i]=S.useState(!1),r=Ib(n),o=async l=>{t(!0),setTimeout(()=>{i(!0)},5e3),ee.logEvent($.submitInlineRating,{gizmo_id:n,rating:l}),await r.mutateAsync({rating:l})},a=async()=>{i(!0),ee.logEvent($.dismissInlineRating,{gizmo_id:n}),await r.mutateAsync({})};return S.useEffect(()=>{s||ee.logEvent($.showInlineRating,{gizmo_id:n})},[s,n]),s?null:e?c.jsx(ld,{children:c.jsxs(cd,{className:"flex flex-col items-center gap-4",children:[c.jsx("div",{className:"rounded-lg border border-token-border-heavy p-4",children:c.jsxs("div",{className:"flex justify-between gap-2",children:[c.jsx(U,{id:"gizmo.inlineReview.reviewLeft",defaultMessage:"Feedback sent"}),c.jsx(Ya,{onClick:()=>{i(!0)}})]})}),c.jsx("div",{className:"text-xs text-token-text-tertiary",children:c.jsx(U,{id:"gizmo.inlineReview.reviewLeftSubtext",defaultMessage:'To update your rating, click "Send Feedback" in the GPT Menu'})})]})}):c.jsx(ld,{children:c.jsxs(cd,{className:"flex flex-col items-center gap-4 rounded-lg border border-token-border-heavy p-4",children:[c.jsxs("div",{className:"flex justify-between gap-2",children:[c.jsx(U,{id:"gizmo.inlineReview.prompt",defaultMessage:"How would you rate this GPT so far?"}),c.jsx(Ya,{onClick:a})]}),c.jsx(A0,{rating:void 0,onRating:o})]})})}function ES(n,e){const t=zo(Uo.MentionGPTs),s=zm(),[i,r]=S.useState(!1),o=()=>{r(!0),t.markAsViewed()};return S.useImperativeHandle(e,()=>({handleClose:o})),t.eligible&&!t.isLoading&&!s?c.jsx(_S,{wasDismissed:i,onDismiss:o}):null}function _S({wasDismissed:n,onDismiss:e}){const t=je(),{recent:s,pinned:i}=R0(),r=s&&s.pages.flatMap(o=>o.list.items).length>0||i&&i.items.length>0;return S.useEffect(()=>{r&&ee.logEvent($.mentionsDisplayNux)},[r]),r?c.jsx(Ol,{badge:"beta",align:"start",side:"top",arrowPadding:58,show:!n,title:t.formatMessage({id:"mentionGptsAnnouncement.title",defaultMessage:"GPT mentions"}),onDismiss:e,sideOffset:25,theme:"default",description:c.jsx(U,{id:"mentionGptsAnnouncement.description",defaultMessage:"Type {key} to mention a GPT and add it directly into your conversation",values:{key:c.jsx("span",{className:"font-bold",children:"@"})}}),children:c.jsx("div",{className:"absolute sm:left-16"})}):null}const NS=S.forwardRef(ES);function IS({suggestions:n,composerController:e,onSelect:t,onChange:s}){const i=ff(),r=S.useCallback((l,d,u)=>{t==null||t(l,d,u),i(l,d,u)},[t,i]),[o,a]=S.useState(-1);return S.useEffect(()=>{const l=d=>{if(d.key==="ArrowDown"){const u=o===n.length-1?0:o+1;a(u),s==null||s(u,!0,n[u])}else if(d.key==="ArrowUp"){d.preventDefault();const u=o===0?n.length-1:o-1;a(u),s==null||s(u,!0,n[u])}else d.key==="Enter"&&n[o]&&r(n[o],n,o)};return e.subscribe("keydown",l)},[n,o,s,r,e]),S.useEffect(()=>e.subscribe("blur",()=>{a(-1),s==null||s(-1,!1)}),[e,s]),c.jsx(gt.ul,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"hidden w-full flex-col p-2.5 group-focus-within:block",children:n.map((l,d)=>c.jsxs(gt.li,{initial:{opacity:0},animate:{opacity:1},transition:{delay:d*.03},exit:{opacity:0},className:"w-full",children:[d>0&&c.jsx("div",{className:te("h-[1px] opacity-60",o===d||o===d-1?"mx-2 bg-token-main-surface-secondary":"bg-token-border-light")}),c.jsxs("button",{className:te("inline w-full cursor-pointer items-center justify-start rounded-lg px-2.5 py-3 text-start",o===d?"bg-token-main-surface-secondary":"bg-token-main-surface-primary"),onClick:u=>{u.preventDefault(),r(l,n,d)},onMouseEnter:()=>{a(d),s==null||s(d,!1,l)},onMouseLeave:()=>{a(-1),s==null||s(-1,!1,l)},children:[c.jsx("span",{className:"text-token-text-primary",children:l.title}),c.jsx("span",{className:"ml-1 text-token-text-secondary",children:l.body})]})]},l.id??d))})}function AS({composerController:n}){const{doesUserHaveAnyAccountsWithPlusFeatures:e}=ri(),t=je(),s=Vo();return c.jsxs("div",{className:te("flex justify-between",!s&&"bg-gradient-to-t from-token-main-surface-primary to-transparent px-4"),children:[c.jsx("div",{className:"flex gap-2",children:c.jsx(DS,{onClickStyle:i=>{ud(t.formatMessage(i.expandedName??i.name),n)}})}),e&&c.jsx("div",{className:"flex gap-2",children:c.jsx(RS,{onClickAspectRatio:i=>ud(t.formatMessage(i.expandedName),n)})})]})}function RS({onClickAspectRatio:n}){const e=je();return c.jsxs(ve.Root,{onOpenChange:t=>{t&&(at.logEvent($.dalleOpenAspectRatioDropdown),ee.logEvent($.dalleOpenAspectRatioDropdown))},children:[c.jsxs(Xa,{$as:ve.Trigger,className:"pr-1.5",children:[c.jsx(U,{id:"dalleControls.aspectRatio",defaultMessage:"Aspect Ratio"}),c.jsx(Yo,{className:"icon-md"})]}),c.jsx(ve.Portal,{children:c.jsx(ve.Content,{children:Um.map(t=>c.jsx(ve.Item,{onClick:()=>{var s;n(t),at.logEvent($.dalleClickAspectRatio,(s=t.name.defaultMessage)==null?void 0:s.toString()),ee.logEvent($.dalleClickAspectRatio,{aspectRatio:t.name.defaultMessage})},icon:t.icon,children:e.formatMessage(t.name)},t.name.id))})})]})}function DS({onClickStyle:n}){const[e,t]=S.useState(dd()),s=Tx(),i=Ql(),r=Tr(),o=je();let a=2;return r||(i?a=5:s&&(a=3)),c.jsxs(c.Fragment,{children:[e.slice(0,a).map(l=>c.jsx(vs,{label:c.jsx(jS,{style:l}),side:"top",sideOffset:4,customPaddingClassName:"p-1",children:c.jsxs(Xa,{$as:"button",type:"button",onClick:()=>{var d;n(l),at.logEvent($.dalleClickStyle,(d=l.name.defaultMessage)==null?void 0:d.toString()),ee.logEvent($.dalleClickStyle,{style:l.name.defaultMessage})},children:[c.jsx(a0,{className:"h-4 w-4 text-token-text-tertiary"}),o.formatMessage(l.name)]})},l.name.id)),c.jsx(Xa,{$as:"button",type:"button",onClick:()=>{t(dd()),at.logEvent($.dalleShuffleStyles),ee.logEvent($.dalleShuffleStyles)},children:c.jsx(Vm,{className:"icon-sm text-token-text-tertiary"})}),Zu.map(l=>c.jsx(eh,{src:l.image,alt:o.formatMessage(l.name),width:100,height:100,className:"invisible fixed -left-96 -top-96"},l.name.id))]})}function jS({style:n}){const e=je();return c.jsxs("div",{className:"flex flex-col gap-1",children:[c.jsx(eh,{src:n.image,alt:e.formatMessage(n.name),width:100,height:100,className:"rounded-md"}),c.jsx("div",{className:"text-xs font-medium",children:e.formatMessage(n.name)})]})}function dd(){return[...Zu].sort(()=>Math.random()-.5)}function OS(n,e){const t=e.getCurrentText();return t.trim()===""?n:t.endsWith(",")?` ${n.toLocaleLowerCase()}`:t.endsWith(", ")?n.toLocaleLowerCase():`, ${n.toLocaleLowerCase()}`}function ud(n,e){const t=OS(n,e);e.appendText(t),dr()}const Xa=et.div`h-7 bg-token-main-surface-primary border border-token-border-light text-xs hover:bg-token-main-surface-secondary hover:text-token-text-primary px-2.5 radix-state-open:bg-token-main-surface-secondary radix-state-open:text-token-text-primary rounded-full flex flex-nowrap gap-0.5 items-center text-token-text-secondary font-normal`,Vr={initial:{opacity:0,y:20,scale:.9},animate:{opacity:1,y:0,scale:1},transition:{delay:.1},exit:{opacity:0,scale:.5,transition:{duration:.2}}},PS=({suggestions:n,onSelectingSuggestedReply:e})=>c.jsx("div",{className:"absolute bottom-full flex w-full max-w-[100vw] grow gap-2 overflow-auto px-1 pb-1 contain-inline-size sm:mb-0 sm:justify-start sm:px-2 sm:pb-0 md:static md:mb-2 md:max-w-none md:justify-center md:overflow-visible",children:n.slice(0,2).map((t,s)=>c.jsx(gt.div,{initial:Vr.initial,animate:Vr.animate,transition:{delay:(s-1)*Vr.transition.delay},exit:Vr.exit,children:c.jsx(It,{as:"button",color:"secondary",size:"small",onClick:()=>{e(t,n,s)},className:"group whitespace-nowrap md:whitespace-normal",children:c.jsx(BS,{suggestion:t})},s)},s))});function FS({suggestions:n,onSelectingSuggestedReply:e,clientThreadId:t}){const s=(n==null?void 0:n.length)>0;S.useEffect(()=>{s&&To(n,t)},[s,t]);const{isUnauthenticated:i}=Xt();return s?n.every(pf)?c.jsxs(gt.div,{initial:{opacity:0},animate:{opacity:1},transition:{duration:.3},className:"flex flex-col items-center",children:[i&&c.jsx(th,{className:"mb-6 h-12 w-12 sm:hidden"}),c.jsx(Xb,{starterPrompts:n,onSelectStarterPrompt:e})]}):n.every(mf)?c.jsx(PS,{suggestions:n,onSelectingSuggestedReply:e}):null:null}function BS({suggestion:n}){return mf(n)?c.jsx(c.Fragment,{children:n.text}):pf(n)?c.jsxs("div",{className:"flex flex-col overflow-hidden",children:[n.title&&c.jsx("div",{className:"truncate font-semibold",children:n.title}),c.jsx("div",{className:te("truncate font-normal",n.title?"opacity-50":""),children:n.body})]}):null}function LS(){const{store:n}=Qt(),e=n.useSharedProps();return e?c.jsx(zS,{...e}):null}function zS({clientThreadId:n,suggestions:e}){const t=ff();return e===void 0||e.length===0?null:c.jsx("div",{children:c.jsx(US,{children:c.jsx("div",{className:"grow",children:e!==void 0&&c.jsx(FS,{suggestions:e,onSelectingSuggestedReply:t,clientThreadId:n})})})})}const US=et.div`h-full flex ml-1 md:w-full md:m-auto gap-0 md:gap-2 justify-center`,Ef=({className:n,children:e})=>c.jsx(gt.div,{className:n,initial:{opacity:0},animate:{opacity:1},exit:{opacity:0,transition:{duration:.1,delay:0}},transition:{type:"tween",duration:.3,delay:.2},children:e});function VS({currentLeafId:n,canContinue:e,onContinueGenerating:t}){const s=S.useCallback(()=>{t(n),dr()},[t,n]);let i=null;return e&&(i=c.jsx(GS,{onHandleContinueGenerating:s})),i&&c.jsx("div",{className:"flex h-full w-full items-center justify-end gap-0 py-4 md:gap-2",children:i})}const GS=({onHandleContinueGenerating:n})=>{const e=Nr();return c.jsx(Ef,{children:c.jsxs(It,{as:"button",color:"secondary",onClick:n,className:"whitespace-nowrap border-0 md:border",children:[c.jsx(xf,{className:te("-rotate-180",e?"icon-xs":"icon-sm")}),e&&c.jsx(U,{...An.continueGenerating})]})})},WS=({clientThreadId:n})=>{const e=Gh(),t=Ui(n),s=Fn(t);S.useEffect(()=>{s&&fr.dismissBanner()},[s]);const i=e!=null&&e.is_dismissible?()=>fr.dismissBanner():void 0;return c.jsx(Xs,{children:e&&c.jsx(gt.div,{transition:{type:"tween",ease:"easeInOut",duration:.1},initial:{opacity:0,transform:"translateY(8px)"},animate:{opacity:1,transform:"translateY(0px)"},exit:{opacity:0,transform:"translateY(8px)"},children:c.jsx(D0,{clientThreadId:n,rateLimitInfo:e,onDismiss:i})})})};function HS(n){const e=Ui(n),t=Fn(e),s=Gh();return!t&&s!=null}const Kn=window.sessionStorage,Za=Ex(_x(()=>({memoryFullBannerDismissed:!!(Kn!=null&&Kn.getItem(ko.MemoryFullBannerDismissed))}))),_f={dismissBanner(){Za.setState(n=>{n.memoryFullBannerDismissed=!0}),Kn==null||Kn.setItem(ko.MemoryFullBannerDismissed,"true")},clearDismissedBanner(){Za.setState(n=>{n.memoryFullBannerDismissed=!1}),Kn==null||Kn.removeItem(ko.MemoryFullBannerDismissed)}};function qS(n){const e=hn(n),t=Bo(),{data:s}=Lo(e,!1,t),i=s!=null,r=i&&s.memoryFullPct>=100,[o,a]=S.useState(!1);S.useEffect(()=>{!r&&i&&(a(!0),_f.clearDismissedBanner())},[r,i]);const l=Za(d=>d.memoryFullBannerDismissed);return r&&o&&!l}function $S(){const n=je(),{openSettings:e}=Gm();return c.jsx(gt.div,{initial:{opacity:0},animate:{opacity:1},children:c.jsx(nh,{title:n.formatMessage(Gr.memoryFullTitle),content:n.formatMessage(Gr.memoryFullTooltip,Gr.memoryFullTooltip.values),primaryCtaText:n.formatMessage(Gr.memoryManageButton),onPrimaryCtaClick:()=>e(Wm.Personalization),onDismiss:()=>_f.dismissBanner()})})}const Gr=qe({memoryFullTitle:{id:"yRGU2/",defaultMessage:"Memory is full."},memoryManageButton:{id:"a5A88o",defaultMessage:"Manage"},memoryFullTooltip:{id:"neUc+N",defaultMessage:"New memories wont be created until you make space. <a>Learn more</a>",values:{a:n=>c.jsx("a",{href:Hm,target:"_blank",rel:"noopener noreferrer",className:"underline",children:n})}}}),KS=()=>{const{shouldShowSkipButton:n}=sh();return n?c.jsx(Ef,{className:"flex justify-center",children:c.jsx(It,{as:"button",color:"secondary",onClick:()=>ih.skipParagen(),children:c.jsx(U,{...JS.skip})})}):null},JS=qe({skip:{id:"dvcUbp",defaultMessage:"Skip"}}),YS=S.memo(function({className:e}){const{store:t}=Qt(),s=t.useIsHeaderContentAreaPopulated();return c.jsx("div",{className:te(e??"absolute bottom-full left-0 right-0",Ha.PromptTextareaHeader),children:c.jsx(qm,{shouldRender:s,contentArea:Ai.Header,children:c.jsxs("div",{className:"flex flex-col gap-3.5 pt-2",children:[c.jsx(QS,{}),c.jsx(XS,{})]})})})});function QS(){const{store:n}=Qt(),e=n.useContentAreaId(Ai.HeaderTop);let t;switch(e){case wt.ParagenControls:t=c.jsx(KS,{});break;case wt.ItemActions:t=c.jsx(LS,{});break;case wt.BannerSignup:t=c.jsx(ew,{});break;case wt.BannerTermsDisclaimer:t=c.jsx(tw,{});break;case wt.PromptTextareaAction:t=c.jsx(nw,{});break;case wt.BannersRateLimit:t=c.jsx(sw,{});break;case wt.BannerSidekickAnnouncement:t=c.jsx(L0,{});break;case wt.BannerMemoryFull:t=c.jsx($S,{});break;case wt.Box:t=c.jsxs("div",{className:"flex h-20 w-full items-center justify-center gap-2 bg-red-500 p-2",children:["box",c.jsxs("div",{className:"flex h-full w-full items-center justify-center gap-2 bg-blue-500 p-2",children:["inner",c.jsx("div",{className:"flex h-full w-full items-center justify-center bg-yellow-400 text-center",children:"actual content"})]})]});break;default:t=null;break}return t}function XS(){const{store:n}=Qt(),e=n.useContentAreaId(Ai.HeaderBottom);let t;switch(e){case rh.DallePromptControls:t=c.jsx(ZS,{});break;default:t=null;break}return t}function ZS(){const{store:n}=Qt(),e=n.useSharedProps(t=>t==null?void 0:t.composerController);return e?c.jsx(AS,{composerController:e}):null}function ew(){const{store:n}=Qt(),e=n.useSharedProps(s=>s==null?void 0:s.clientThreadId),t=$m();return e?t?c.jsx(Km,{threadId:e}):c.jsx(Jm,{threadId:e}):null}function tw(){const{store:n}=Qt(),e=n.useSharedProps(t=>t==null?void 0:t.clientThreadId);return e?c.jsx(Ym,{threadId:e}):null}function nw(){const{store:n}=Qt(),e=n.useSharedProps();return e?c.jsx(VS,{...e}):null}function sw(){const{store:n}=Qt(),e=n.useSharedProps(t=>t==null?void 0:t.clientThreadId);return e?c.jsx(WS,{clientThreadId:e}):null}function iw(n){var e,t;return((t=(e=n.metadata)==null?void 0:e.dalle)==null?void 0:t.prompt)??""}async function rw(n,e,t="image/png"){return new Promise((s,i)=>{n.toBlob(r=>{r!=null?s(new File([r],e,{type:t})):i(new Error("Failed to convert canvas to blob"))},t)})}async function ow(n,e){const t=document.createElement("canvas");t.width=n.width,t.height=n.height;const s=t.getContext("2d");if(s==null)throw new Error("Failed to get 2d context for mask canvas");const i=s.createImageData(n.width,n.height);for(let r=0;r<n.data.length;r+=4)n.data[r+3]!==0?(i.data[r]=0,i.data[r+1]=0,i.data[r+2]=0,i.data[r+3]=255):(i.data[r]=255,i.data[r+1]=255,i.data[r+2]=255,i.data[r+3]=255);return s.putImageData(i,0,0),rw(t,e)}async function aw(n,e){const s=await(await fetch(n)).blob(),i=document.createElement("a");i.href=URL.createObjectURL(s),i.download=e,i.click(),i.remove()}function lw(n){const e=Zm(new Date,"yyyy-MM-dd HH.mm.ss");let t=n.slice(0,150);return t.endsWith(".")&&(t=t.slice(0,-1)),`DALLE ${e} - ${t}.webp`}async function w_(n,e,t){var r,o,a,l,d,u,p,m,b,g;const s=iw(n),i=lw(s);await aw(n.url,i),at.logEvent("chatgpt_dalle_image_download",null,{sourceOperation:((o=(r=n.metadata)==null?void 0:r.dalle)==null?void 0:o.edit_op)??"none",hasParent:((l=(a=n.metadata)==null?void 0:a.dalle)==null?void 0:l.parent_gen_id)!=null?"true":"false"}),ee.logEvent($.dalleImageDownload,{conversationId:e,messageId:t,generationId:(u=(d=n.metadata)==null?void 0:d.dalle)==null?void 0:u.gen_id,parentGenerationId:(m=(p=n.metadata)==null?void 0:p.dalle)==null?void 0:m.parent_gen_id,fileId:Go(n.asset_pointer),sourceOperation:(g=(b=n.metadata)==null?void 0:b.dalle)==null?void 0:g.edit_op})}function cw(n){const e=Zo(n),t=Tr(),s=e&&"gizmo"in e?e.gizmo:void 0;return!t&&(s==null?void 0:s.gizmo.id)===Qm}function k_(n,e){var i,r;const t=(r=(i=e.metadata)==null?void 0:i.dalle)==null?void 0:r.gen_id,s=Go(e.asset_pointer);return s==null||t==null?n:{...n,messageMetadata:{...n.messageMetadata,dalle:{from_client:{operation:{type:"transformation",original_gen_id:t,original_file_id:s}}}}}}async function dw(n,e,t){return new Promise((s,i)=>{Xm(oh(n),n,e,{kind:Nx.DalleAgent},{onFileCreated:_t,onFileUploadProgress:_t,onFileUploaded:(r,o)=>s(o),onError:(r,o)=>{i(new Error(`Failed to upload file with reason: ${o}`))}},t)})}async function C_(n,e,t,s){var o,a;const i=(a=(o=e.metadata)==null?void 0:o.dalle)==null?void 0:a.gen_id,r=Go(e.asset_pointer);if(r==null||i==null||t==null)return n;try{const l=await ow(t,"mask.png"),d=await dw(l,s,{imageDimensions:{width:e.width,height:e.height}});return{...n,messageMetadata:{...n.messageMetadata,dalle:{from_client:{operation:{type:"inpainting",original_gen_id:i,original_file_id:r,mask_file_id:d}}}}}}catch(l){return jt.addError(l),n}}const uw=S.memo(function(e){return hw(e),fw(e),pw(),null});function hw(n){const{store:e}=Qt(),t=e.useSetSharedProps();S.useLayoutEffect(()=>{t(n)},[n,t])}function fw(n){const{clientThreadId:e,canContinue:t}=n,{store:s}=Qt(),i=S.useRef({top:s.useContentAreaApi(Ai.HeaderTop),bottom:s.useContentAreaApi(Ai.HeaderBottom)}).current,r=yw(n),o=cw(e),{shouldShowBannerSignup:a,shouldShowBannerTermsDisclaimer:l}=xw(e),d=HS(e),u=z0(n),p=qS(e),m=eg();S.useLayoutEffect(()=>{m?i.top.set(wt.ParagenControls):l?i.top.set(wt.BannerTermsDisclaimer):d?i.top.set(wt.BannersRateLimit):u.eligible?i.top.set(wt.BannerSidekickAnnouncement):r?i.top.set(wt.ItemActions):t?i.top.set(wt.PromptTextareaAction):a?i.top.set(wt.BannerSignup):p?i.top.set(wt.BannerMemoryFull):i.top.set(null)},[i,r,t,l,a,d,u,p,m]),S.useLayoutEffect(()=>{o&&i.bottom.set(rh.DallePromptControls)},[i,o])}function pw(){const{store:n}=Qt();S.useEffect(()=>()=>{n.reset()},[n])}function mw(n){var i,r;const e=lh(),t=Bn(n),s=(r=(i=O.getTree(n).getLastValidNode(t))==null?void 0:i.message)==null?void 0:r.id;return(e==null?void 0:e.messageId)===s?e.suggestions:[]}function gw(n){return mw(n).length>0}function yw(n){const e=Cf(n.clientThreadId),t=gw(n.clientThreadId);return n.isDisabled?!1:n.isNewThread||e||t}function xw(n){var p;const{isUnauthenticated:e}=Xt(),t=Bn(n),{layer:s}=Wh("3637408529"),i=s.get("should_show_no_auth_signup_banner",!0),r=ah(m=>m.bannerDisclaimerClientThreadId),o={shouldShowBannerTermsDisclaimer:!1,shouldShowBannerSignup:!1};if(!n)return o;const a=O.getTree(n),l=a.countMessagesByAuthor(Ue.User),d=a.getNodeByIdOrMessageId(t),u=((p=d==null?void 0:d.message)==null?void 0:p.author.role)===Ue.Assistant&&Xl(d.message);return o.shouldShowBannerTermsDisclaimer=u&&e&&l===1&&(r==null||r===n),o.shouldShowBannerSignup=i&&u&&e&&l>0&&l%5===0,o}function bw(n,e,t,s,i){const{getGizmoId:r}=Er(),[o,a]=S.useState();S.useEffect(()=>{r?r().then(u=>a(u)):a(void 0)},[r]);const l=Hh(e);return S.useCallback(u=>{const{docsReferencedByURL:p}=Ot.getThread(n)??{};if(p!=null)for(const m of u){const{id:b,type:g,handler:x}=m,k=`${g}:${b}`,M=p[k],A=po.getState().files.find(T=>T.tempId===b);if(M!=null&&M!=="failed"&&A){ln.success(t.formatMessage(ga.fileAlreadyAttached),{hasCloseButton:!0});continue}switch(x.type){case"fetch":{O.updateReferencedDocState(n,k,"pending"),gs.uploadFile(b,new File([],t.formatMessage(ga.fileLoading)),Zs.None,s,t,{skipUpload:!0,gizmoId:o},i,{contextConnector:g,sourceUrl:m.url,syntheticExtension:null,type:Co.Link}),ha.linkMetadataFetchStarted(g),x.tryFetch().then(T=>{if(gs.remove(b,"none"),T==null)return null;const{id:_,title:j,connector:P,mimeType:B,url:I,syntheticExtension:q,o365DriveId:G}=T;ha.linkMetadataFetchSucceeded(g,B),O.updateReferencedDocState(n,k,"fetched");let D=j;P===zt.GDRIVE&&(D=q?`${j}.${q}`:j),gs.uploadFile(_,new File([],D,{type:B.split(";")[0]}),Zs.Retrieval,s,t,{gizmoId:o},i,{contextConnector:P,sourceUrl:I,syntheticExtension:q,type:Co.Link,o365DriveId:G})}).catch(T=>{ha.linkMetadataFetchFailed(g,T),ln.danger(t.formatMessage(ga.fileFetchFailed),{hasCloseButton:!0}),O.updateReferencedDocState(n,k,"failed"),gs.remove(b,"none")});break}case"prompt":{l.appendMessageIfNotDismissed({connector:g,type:x.message}),O.updateReferencedDocState(n,k,"prompted");break}}}},[i,n,l,o,t,s])}const ga=qe({fileLoading:{id:"CCC.fileLoading",defaultMessage:"Loading"},fileFetchFailed:{id:"CCC.fileFetchFailed",defaultMessage:"Unable to fetch file information"},fileAlreadyAttached:{id:"CCC.fileAlreadyAttached",defaultMessage:"This file is already a part of your message."}}),Nf=({clientThreadId:n,rateLimitPopup:e,children:t,highlightTooltip:s=!1})=>{const i=je(),r=rc(n),o=ts(),[a,l]=S.useState(s),[d,u]=S.useState(!1),p=S.useCallback(()=>{d||l(!0)},[d]),m=S.useCallback(()=>{l(!1),u(!1)},[]),b=S.useCallback(()=>{l(!1),u(!0)},[]);S.useEffect(()=>{l(s)},[s]);const g=k=>{e!=null&&k&&ee.logPopoverHover({type:"rate_limit",location:"file_upload",plan_type:(o==null?void 0:o.planType)??"unknown"})},x=!!e;return c.jsx(c.Fragment,{children:x?c.jsxs(Ix,{delayDuration:150,onOpenChange:g,children:[c.jsx(Ax,{children:t}),c.jsx(Rx,{children:c.jsx(tg,{$as:Dx,side:"top",sideOffset:4,className:"max-w-[260px]",children:c.jsx(Sw,{isNewConversation:r,rateLimitPopup:e})})})]}):c.jsx(vs,{sideOffset:14,label:i.formatMessage({id:"oUK/GV",defaultMessage:"Attach file"}),className:"flex",open:a||s,side:"top",children:c.jsx("span",{onPointerEnter:p,onPointerLeave:m,onClick:b,children:t})})})},Sw=({isNewConversation:n=!1,rateLimitPopup:e})=>{const t=ts(),s=Bi();if(e==null)return null;const{call_to_action:i,description:r}=e,o=r||c.jsx(U,{...hd.defaultDescription}),a=i==null?void 0:i.includes(jx.GET_PLUS);return c.jsxs("div",{className:"p-2 text-sm text-token-text-primary",children:[c.jsx("div",{children:o}),a?c.jsx(It,{size:"small",color:"secondary",className:"mt-3",onClick:()=>{Pl(s,"Rate limited file upload popover"),ee.logRateLimitGetPlusButtonClicked({type:"file_upload",location:"popover",plan_type:(t==null?void 0:t.planType)??"unknown",is_hard_block:!1,is_new_conversation:n,hard_block_reason:""})},children:c.jsx(U,{...hd.getPlus})}):null]})},hd=qe({defaultDescription:{id:"U5qAWP",defaultMessage:"You've reached your daily upload limit. Get ChatGPT Plus to unlock more."},getPlus:{id:"TeyLcp",defaultMessage:"Get Plus"}});function ww({clientThreadId:n,getInputProps:e,openFileDialog:t,uploadType:s,icon:i,highlightTooltip:r=!1}){const o=je(),a=Zl(),l=!!a,d=c.jsx(ch,{className:"mb-1 ml-1.5",disabled:l,onClick:m=>{m.preventDefault(),ee.logEvent($.openFileViewer,{intent:s.toString()}),t()},"aria-label":o.formatMessage({id:"PromptFilePicker.attachFiles",defaultMessage:"Attach files"}),children:i}),u=c.jsx("input",{disabled:l,...e({className:"hidden"})}),p=c.jsxs("div",{className:"flex",children:[d,u]});return c.jsx(Nf,{clientThreadId:n,rateLimitPopup:a,highlightTooltip:r,children:p})}function kw({code:n,message:e}){switch(n){case Vc.FileTooLarge:return fd.errorFileTooLarge;case Vc.TooManyFiles:return ee.logEvent($.uploadedMaxFilesError),fd.errorTooManyFiles;default:return e}}const fd=qe({attachImages:{id:"PromptFilePicker.attachImages",defaultMessage:"Attach images"},attachFiles:{id:"PromptFilePicker.attachFiles",defaultMessage:"Attach files"},errorFileTooLarge:{id:"PromptFilePicker.errorFileTooLarge",defaultMessage:"Your file is too large. The maximum file size is {size}MB."},errorTooManyFiles:{id:"PromptFilePicker.errorTooManyFiles",defaultMessage:"You may only upload {maxNum} files at a time."},defaultFileUploadRateLimited:{id:"U5qAWP",defaultMessage:"You've reached your daily upload limit. Get ChatGPT Plus to unlock more."},getPlusButton:{id:"TeyLcp",defaultMessage:"Get Plus"}}),pd=qe({dragInstructions:{id:"FileDropZone.dragInstructions",defaultMessage:"Add anything"},dragAllAccepted:{id:"FileDropZone.dragAllAccepted",defaultMessage:"Drop any file here to add it to the conversation"}});function Cw(n){var T;const{className:e,children:t,clientThreadId:s,currentModelConfig:i}=n,r=je(),o=Zo(s),a=mo(i,o),l=a!==Zs.None,d=po(_=>_.files),u=(a===Zs.Multimodal?Fl:Bl)-d.length,p=u<=0,{getGizmoId:m}=Er(),{handleFileAccepted:b}=Af(r,mo(i,o),uh(i,o),"drag",m,(T=dh(i,o))==null?void 0:T.attachments),g=Zl(),x=hh(fh(i,o)),{getRootProps:k,isDragActive:M}=ph({maxFiles:u,disabled:!l||p||g!=null,noClick:!0,onDropAccepted:b,onDropRejected:_=>If(_,r,a),multiple:!0,maxSize:mh,...x}),N=A();function A(){if(!x.accept||Object.keys(x.accept).length===0)return[];const _=[];return Object.values(x.accept).forEach(j=>_.push(...j)),_.sort()}return c.jsxs("div",{...k({className:e}),children:[t,M&&c.jsxs(Mw,{children:[c.jsx(ng,{}),c.jsx("h3",{children:c.jsx(U,{...pd.dragInstructions})}),c.jsx("h4",{className:"w-2/3 text-center",children:N.length>0?N.join(", "):c.jsx(U,{...pd.dragAllAccepted})})]})]})}function If(n,e,t){const{errors:s}=n[0];s.forEach(i=>{const r=kw(i);typeof r=="string"?ln.danger(r,{hasCloseButton:!0}):ln.danger(e.formatMessage(r,{size:sg,maxNum:t===Zs.Multimodal?Fl:Bl}),{hasCloseButton:!0})})}function Af(n,e,t,s,i,r){return{handleFileAccepted:S.useCallback(async(a,l)=>{ee.logEvent($.uploadFile,{client:"web",eventSource:s,intent:e.toString()});const d=i!=null?await i():void 0;a.length>0&&a.forEach(u=>{gs.uploadFile(oh(u),u,e,t,n,{gizmoId:d},r)})},[s,e,i,t,n,r])}}const Mw=et.div`absolute inset-0 opacity-80 flex gap-2 flex-col justify-center items-center bg-token-main-surface-primary text-token-text-primary`;function md({entry:n,onClick:e}){const{connectorConfig:t}=Ll();S.useEffect(()=>{if(!open||n.type!==zt.GDRIVE)return;const o=t.get(zt.GDRIVE),a=o==null?void 0:o.access_token;a&&ig(a)},[t,n.type]);const s=gh(n.type),i=je(),r=n.access_token?gd.uploadFromMessage:gd.signinWithMessage;return c.jsx(ve.Item,{onClick:e,icon:s,children:c.jsxs("div",{className:"flex flex-col",children:[c.jsx(U,{...r,values:{connectorName:zl(n.type,i)}}),n.type===zt.O365_BUSINESS&&c.jsx("div",{className:"text-s text-token-text-tertiary",children:c.jsx(U,{...Ul.includesSharePoint})})]})},n.id)}const gd=qe({signinWithMessage:{id:"ContextConnectorPickerDropdownItem.signInWithMessage",defaultMessage:"Connect to {connectorName}"},uploadFromMessage:{id:"ContextConnectorPickerDropdownItem.uploadWithMessage",defaultMessage:"Add from {connectorName}"}});function vw({clientThreadId:n,icon:e,setOpen:t,highlightTooltip:s=!1}){const i=Zl(),r=!!i,o=je();return c.jsxs(c.Fragment,{children:[c.jsx(ve.Trigger,{className:"m-0 h-0 w-0 border-none bg-transparent p-0"}),c.jsx(Nf,{clientThreadId:n,rateLimitPopup:i,highlightTooltip:s,children:c.jsx(ch,{className:"mb-1 ml-1.5","aria-disabled":r,"aria-label":o.formatMessage({id:"tA7CXR",defaultMessage:"Attach files"}),onClick:a=>{a.preventDefault(),r||t(!0)},children:e})})]})}function Tw({connectorEntries:n,onOauthRedirect:e}){const t=je();return c.jsxs(ve.Sub,{children:[c.jsx(ve.SubMenuTrigger,{icon:l0,children:c.jsx("div",{className:"line-clamp-1 text-ellipsis",children:c.jsx(U,{...Ew.connectApps})})}),c.jsx(ve.Portal,{children:c.jsx(ve.SubContent,{children:n.map(s=>c.jsx(ve.Item,{onClick:()=>e(s),icon:gh(s.type),children:c.jsxs("div",{className:"flex flex-col",children:[zl(s.type,t),s.type===zt.O365_BUSINESS&&c.jsx("div",{className:"text-s text-token-text-tertiary",children:c.jsx(U,{...Ul.includesSharePoint})})]})},s.id))})})]})}const Ew=qe({connectApps:{id:"ContextConnectorPicker.connectApps",defaultMessage:"Connect apps"}});function _w({onOauthRedirect:n,connectors:e}){const t=je();return c.jsxs(ve.Sub,{children:[c.jsx(ve.SubMenuTrigger,{icon:c0,children:c.jsx(U,{...Nw.oneDriveSubmenuName})}),c.jsx(ve.Portal,{children:c.jsx(ve.SubContent,{children:e.map(s=>s?c.jsx(ve.Item,{onClick:()=>n(s),children:c.jsxs("div",{className:"flex flex-col",children:[zl(s.type,t),s.type===zt.O365_BUSINESS&&c.jsx("div",{className:"text-s text-token-text-tertiary",children:c.jsx(U,{...Ul.includesSharePoint})})]})},s.id):null)})})]})}const Nw=qe({oneDriveSubmenuName:{id:"ContextConnectorPickerOneDriveSubmenu.oneDriveSubmenuName",defaultMessage:"Connect to Microsoft OneDrive"}});function Iw(){const{connectorConfig:n}=Ll(),e=Ir(),[t,s]=go(yh([...n.values()],d=>!!d.access_token),d=>!!d.access_token),[i,r]=go(s,d=>d.type===zt.O365_PERSONAL||d.type===zt.O365_BUSINESS),o=!e&&t.length>0,a=!e&&!o&&i.length>1;return{unconnectedConnectors:a?r:s,showUnconnectedInSubmenu:o,showOneDriveInSubmenu:a}}function Aw({clientThreadId:n,icon:e,modelAcceptedMimeTypes:t,modelSupportedImageMimeTypes:s,attachmentsProductFeature:i,onOauthRedirect:r,uploadType:o,getInputProps:a,openFileDialog:l,highlightTooltip:d=!1}){const{currentLocale:u}=Ox(),p=je(),m=Ir(),{connectorConfig:b,isLoading:g}=Ll(),x=zo(Uo.ContextConnectors),{getGizmoId:k}=Er(),[M,N]=S.useState();S.useEffect(()=>{k?k().then(z=>N(z)):N(void 0)},[k]);const A=S.useRef(null),[T,_]=S.useState(!1),j=S.useRef(!1),P=S.useCallback(()=>{var Ce;const z=(Ce=A.current)==null?void 0:Ce.files;Array.from(z??[]).forEach(Ye=>zr.uploadFile(Ye,s,p,i))},[s,i,p]),[B,I]=S.useState(null),q=S.useCallback(()=>I(null),[I]),G=S.useCallback((z,Ce)=>zr.uploadPickedFile(z,Ce,s,t,i,M,p),[s,t,i,M,p]),{openMenu:D,confirmMenuOpened:V}=rg();S.useEffect(()=>{D&&(_(!0),V())},[D,V,_]);const J=Fi(),W=S.useCallback(z=>{zr.doContextConnectorOauthRedirect(J.asPath,z,r,Co.Picker),r()},[r,J.asPath]),X=S.useCallback(z=>{zr.uploadPickedFile(z,zt.GDRIVE,s,t,i,M,p)},[s,t,i,M,p]),ye=S.useCallback(async z=>{const{access_token:Ce}=z;if(!Ce){W(z);return}switch(og(z,Co.Picker),z.type){case zt.GDRIVE:ag(u,z.type,Ce,Ye=>Ye.forEach(X));break;case zt.O365_PERSONAL:case zt.O365_BUSINESS:I(z.type);break}},[X,W,I,u]),L=()=>{ee.logEvent($.openFileViewer,{intent:o.toString()}),l()},F=z=>{if(!z&&j.current&&!g)L();else if(z&&he&&!g){L();return}_(z),z&&(x.eligible&&x.markAsViewed(),ee.logEvent($.composerOpenContextConnectorPicker),j.current=!0,setTimeout(()=>{j.current=!1},250))},[xe,re]=go(yh([...b.values()],z=>!!z.access_token),z=>!!z.access_token);Rw(xe,ye);const[Z]=go(re,z=>z.type===zt.O365_PERSONAL||z.type===zt.O365_BUSINESS),{unconnectedConnectors:ke,showUnconnectedInSubmenu:be,showOneDriveInSubmenu:le}=Iw(),he=!xe.length&&!ke.length,Oe=c.jsxs(c.Fragment,{children:[be&&ke.length>0&&c.jsx(Tw,{connectorEntries:ke,onOauthRedirect:z=>W(z)}),!be&&ke.map(z=>c.jsx(md,{entry:z,onClick:()=>ye(z)},z.id)),le&&c.jsx(_w,{connectors:Z,onOauthRedirect:W}),g&&c.jsx(ve.Item,{icon:c.jsx(qh,{className:"text-token-text-secondary"})}),(ke.length>0||g)&&c.jsx(ve.Separator,{}),xe.map(z=>c.jsx(md,{entry:z,onClick:()=>ye(z)},z.id)),c.jsx(ve.Item,{onClick:L,icon:bf,children:c.jsx(U,{...m?yd.uploadFileMobile:yd.uploadFile})},"upload")]}),ce=c.jsxs("div",{className:"flex flex-col",children:[c.jsx(lg,{type:B,onClose:q,uploadPickedFile:G}),c.jsx("input",{onChange:P,...a({className:"hidden"})}),c.jsxs(ve.Root,{open:T,onOpenChange:F,children:[c.jsx(vw,{clientThreadId:n,icon:e,setOpen:F,highlightTooltip:d}),c.jsx(ve.Portal,{children:c.jsx(ve.Content,{size:"large",children:Oe})})]}),c.jsx(cg,{hasConnectors:!g&&!he})]});return{dropdownItems:Oe,mainComponent:ce}}function Rw(n,e){const{connector:t,clearParam:s}=dg(),i=n.find(r=>r.type===t&&!!r.access_token);S.useEffect(()=>{i&&(e(i),s())},[i,e,s])}function Dw(n){const{mainComponent:e}=Aw(n);return e}const yd=qe({attachFiles:{id:"ContextConnectorPicker.attachFiles",defaultMessage:"Attach files"},uploadFile:{id:"LocalFileDropdownItem.uploadFile",defaultMessage:"Upload from computer"},uploadFileMobile:{id:"LocalFileDropdownItem.uploadFileMobile",defaultMessage:"Upload file"}});function jw({clientThreadId:n,uploadType:e,modelAcceptedMimeTypes:t,modelSupportedImageMimeTypes:s,attachmentsProductFeature:i,getInputProps:r,openFileDialog:o,onOauthRedirect:a,historyDisabled:l,className:d,highlightTooltip:u}){const{gdriveStatus:p,o365Status:m}=ug(),b=c.jsx(d0,{className:l?"text-white":u?"text-brand-blue-800":void 0});return c.jsxs("div",{className:te("relative",d),children:[p!=="false"||m!=="false"?c.jsx(Dw,{clientThreadId:n,icon:b,modelAcceptedMimeTypes:t,modelSupportedImageMimeTypes:s,attachmentsProductFeature:i,onOauthRedirect:a,uploadType:e,openFileDialog:o,getInputProps:r,highlightTooltip:u}):c.jsx(ww,{clientThreadId:n,uploadType:e,openFileDialog:o,getInputProps:r,icon:b,highlightTooltip:u}),u&&c.jsx(gt.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:260,damping:20},className:"pointer-events-none absolute bottom-1 left-1.5 h-8 w-8 rounded-full bg-brand-blue-800/20"})]})}function Rf(n,e,t){for(let s=0;;s++){if(s==n.childCount||s==e.childCount)return n.childCount==e.childCount?null:t;let i=n.child(s),r=e.child(s);if(i==r){t+=i.nodeSize;continue}if(!i.sameMarkup(r))return t;if(i.isText&&i.text!=r.text){for(let o=0;i.text[o]==r.text[o];o++)t++;return t}if(i.content.size||r.content.size){let o=Rf(i.content,r.content,t+1);if(o!=null)return o}t+=i.nodeSize}}function Df(n,e,t,s){for(let i=n.childCount,r=e.childCount;;){if(i==0||r==0)return i==r?null:{a:t,b:s};let o=n.child(--i),a=e.child(--r),l=o.nodeSize;if(o==a){t-=l,s-=l;continue}if(!o.sameMarkup(a))return{a:t,b:s};if(o.isText&&o.text!=a.text){let d=0,u=Math.min(o.text.length,a.text.length);for(;d<u&&o.text[o.text.length-d-1]==a.text[a.text.length-d-1];)d++,t--,s--;return{a:t,b:s}}if(o.content.size||a.content.size){let d=Df(o.content,a.content,t-1,s-1);if(d)return d}t-=l,s-=l}}class H{constructor(e,t){if(this.content=e,this.size=t||0,t==null)for(let s=0;s<e.length;s++)this.size+=e[s].nodeSize}nodesBetween(e,t,s,i=0,r){for(let o=0,a=0;a<t;o++){let l=this.content[o],d=a+l.nodeSize;if(d>e&&s(l,i+a,r||null,o)!==!1&&l.content.size){let u=a+1;l.nodesBetween(Math.max(0,e-u),Math.min(l.content.size,t-u),s,i+u)}a=d}}descendants(e){this.nodesBetween(0,this.size,e)}textBetween(e,t,s,i){let r="",o=!0;return this.nodesBetween(e,t,(a,l)=>{let d=a.isText?a.text.slice(Math.max(e,l)-l,t-l):a.isLeaf?i?typeof i=="function"?i(a):i:a.type.spec.leafText?a.type.spec.leafText(a):"":"";a.isBlock&&(a.isLeaf&&d||a.isTextblock)&&s&&(o?o=!1:r+=s),r+=d},0),r}append(e){if(!e.size)return this;if(!this.size)return e;let t=this.lastChild,s=e.firstChild,i=this.content.slice(),r=0;for(t.isText&&t.sameMarkup(s)&&(i[i.length-1]=t.withText(t.text+s.text),r=1);r<e.content.length;r++)i.push(e.content[r]);return new H(i,this.size+e.size)}cut(e,t=this.size){if(e==0&&t==this.size)return this;let s=[],i=0;if(t>e)for(let r=0,o=0;o<t;r++){let a=this.content[r],l=o+a.nodeSize;l>e&&((o<e||l>t)&&(a.isText?a=a.cut(Math.max(0,e-o),Math.min(a.text.length,t-o)):a=a.cut(Math.max(0,e-o-1),Math.min(a.content.size,t-o-1))),s.push(a),i+=a.nodeSize),o=l}return new H(s,i)}cutByIndex(e,t){return e==t?H.empty:e==0&&t==this.content.length?this:new H(this.content.slice(e,t))}replaceChild(e,t){let s=this.content[e];if(s==t)return this;let i=this.content.slice(),r=this.size+t.nodeSize-s.nodeSize;return i[e]=t,new H(i,r)}addToStart(e){return new H([e].concat(this.content),this.size+e.nodeSize)}addToEnd(e){return new H(this.content.concat(e),this.size+e.nodeSize)}eq(e){if(this.content.length!=e.content.length)return!1;for(let t=0;t<this.content.length;t++)if(!this.content[t].eq(e.content[t]))return!1;return!0}get firstChild(){return this.content.length?this.content[0]:null}get lastChild(){return this.content.length?this.content[this.content.length-1]:null}get childCount(){return this.content.length}child(e){let t=this.content[e];if(!t)throw new RangeError("Index "+e+" out of range for "+this);return t}maybeChild(e){return this.content[e]||null}forEach(e){for(let t=0,s=0;t<this.content.length;t++){let i=this.content[t];e(i,s,t),s+=i.nodeSize}}findDiffStart(e,t=0){return Rf(this,e,t)}findDiffEnd(e,t=this.size,s=e.size){return Df(this,e,t,s)}findIndex(e,t=-1){if(e==0)return Wr(0,e);if(e==this.size)return Wr(this.content.length,e);if(e>this.size||e<0)throw new RangeError(`Position ${e} outside of fragment (${this})`);for(let s=0,i=0;;s++){let r=this.child(s),o=i+r.nodeSize;if(o>=e)return o==e||t>0?Wr(s+1,o):Wr(s,i);i=o}}toString(){return"<"+this.toStringInner()+">"}toStringInner(){return this.content.join(", ")}toJSON(){return this.content.length?this.content.map(e=>e.toJSON()):null}static fromJSON(e,t){if(!t)return H.empty;if(!Array.isArray(t))throw new RangeError("Invalid input for Fragment.fromJSON");return new H(t.map(e.nodeFromJSON))}static fromArray(e){if(!e.length)return H.empty;let t,s=0;for(let i=0;i<e.length;i++){let r=e[i];s+=r.nodeSize,i&&r.isText&&e[i-1].sameMarkup(r)?(t||(t=e.slice(0,i)),t[t.length-1]=r.withText(t[t.length-1].text+r.text)):t&&t.push(r)}return new H(t||e,s)}static from(e){if(!e)return H.empty;if(e instanceof H)return e;if(Array.isArray(e))return this.fromArray(e);if(e.attrs)return new H([e],e.nodeSize);throw new RangeError("Can not convert "+e+" to a Fragment"+(e.nodesBetween?" (looks like multiple versions of prosemirror-model were loaded)":""))}}H.empty=new H([],0);const ya={index:0,offset:0};function Wr(n,e){return ya.index=n,ya.offset=e,ya}function Eo(n,e){if(n===e)return!0;if(!(n&&typeof n=="object")||!(e&&typeof e=="object"))return!1;let t=Array.isArray(n);if(Array.isArray(e)!=t)return!1;if(t){if(n.length!=e.length)return!1;for(let s=0;s<n.length;s++)if(!Eo(n[s],e[s]))return!1}else{for(let s in n)if(!(s in e)||!Eo(n[s],e[s]))return!1;for(let s in e)if(!(s in n))return!1}return!0}class Pe{constructor(e,t){this.type=e,this.attrs=t}addToSet(e){let t,s=!1;for(let i=0;i<e.length;i++){let r=e[i];if(this.eq(r))return e;if(this.type.excludes(r.type))t||(t=e.slice(0,i));else{if(r.type.excludes(this.type))return e;!s&&r.type.rank>this.type.rank&&(t||(t=e.slice(0,i)),t.push(this),s=!0),t&&t.push(r)}}return t||(t=e.slice()),s||t.push(this),t}removeFromSet(e){for(let t=0;t<e.length;t++)if(this.eq(e[t]))return e.slice(0,t).concat(e.slice(t+1));return e}isInSet(e){for(let t=0;t<e.length;t++)if(this.eq(e[t]))return!0;return!1}eq(e){return this==e||this.type==e.type&&Eo(this.attrs,e.attrs)}toJSON(){let e={type:this.type.name};for(let t in this.attrs){e.attrs=this.attrs;break}return e}static fromJSON(e,t){if(!t)throw new RangeError("Invalid input for Mark.fromJSON");let s=e.marks[t.type];if(!s)throw new RangeError(`There is no mark type ${t.type} in this schema`);let i=s.create(t.attrs);return s.checkAttrs(i.attrs),i}static sameSet(e,t){if(e==t)return!0;if(e.length!=t.length)return!1;for(let s=0;s<e.length;s++)if(!e[s].eq(t[s]))return!1;return!0}static setFrom(e){if(!e||Array.isArray(e)&&e.length==0)return Pe.none;if(e instanceof Pe)return[e];let t=e.slice();return t.sort((s,i)=>s.type.rank-i.type.rank),t}}Pe.none=[];class _o extends Error{}class Q{constructor(e,t,s){this.content=e,this.openStart=t,this.openEnd=s}get size(){return this.content.size-this.openStart-this.openEnd}insertAt(e,t){let s=Of(this.content,e+this.openStart,t);return s&&new Q(s,this.openStart,this.openEnd)}removeBetween(e,t){return new Q(jf(this.content,e+this.openStart,t+this.openStart),this.openStart,this.openEnd)}eq(e){return this.content.eq(e.content)&&this.openStart==e.openStart&&this.openEnd==e.openEnd}toString(){return this.content+"("+this.openStart+","+this.openEnd+")"}toJSON(){if(!this.content.size)return null;let e={content:this.content.toJSON()};return this.openStart>0&&(e.openStart=this.openStart),this.openEnd>0&&(e.openEnd=this.openEnd),e}static fromJSON(e,t){if(!t)return Q.empty;let s=t.openStart||0,i=t.openEnd||0;if(typeof s!="number"||typeof i!="number")throw new RangeError("Invalid input for Slice.fromJSON");return new Q(H.fromJSON(e,t.content),s,i)}static maxOpen(e,t=!0){let s=0,i=0;for(let r=e.firstChild;r&&!r.isLeaf&&(t||!r.type.spec.isolating);r=r.firstChild)s++;for(let r=e.lastChild;r&&!r.isLeaf&&(t||!r.type.spec.isolating);r=r.lastChild)i++;return new Q(e,s,i)}}Q.empty=new Q(H.empty,0,0);function jf(n,e,t){let{index:s,offset:i}=n.findIndex(e),r=n.maybeChild(s),{index:o,offset:a}=n.findIndex(t);if(i==e||r.isText){if(a!=t&&!n.child(o).isText)throw new RangeError("Removing non-flat range");return n.cut(0,e).append(n.cut(t))}if(s!=o)throw new RangeError("Removing non-flat range");return n.replaceChild(s,r.copy(jf(r.content,e-i-1,t-i-1)))}function Of(n,e,t,s){let{index:i,offset:r}=n.findIndex(e),o=n.maybeChild(i);if(r==e||o.isText)return n.cut(0,e).append(t).append(n.cut(e));let a=Of(o.content,e-r-1,t);return a&&n.replaceChild(i,o.copy(a))}function Ow(n,e,t){if(t.openStart>n.depth)throw new _o("Inserted content deeper than insertion position");if(n.depth-t.openStart!=e.depth-t.openEnd)throw new _o("Inconsistent open depths");return Pf(n,e,t,0)}function Pf(n,e,t,s){let i=n.index(s),r=n.node(s);if(i==e.index(s)&&s<n.depth-t.openStart){let o=Pf(n,e,t,s+1);return r.copy(r.content.replaceChild(i,o))}else if(t.content.size)if(!t.openStart&&!t.openEnd&&n.depth==s&&e.depth==s){let o=n.parent,a=o.content;return Ks(o,a.cut(0,n.parentOffset).append(t.content).append(a.cut(e.parentOffset)))}else{let{start:o,end:a}=Pw(t,n);return Ks(r,Bf(n,o,a,e,s))}else return Ks(r,No(n,e,s))}function Ff(n,e){if(!e.type.compatibleContent(n.type))throw new _o("Cannot join "+e.type.name+" onto "+n.type.name)}function el(n,e,t){let s=n.node(t);return Ff(s,e.node(t)),s}function $s(n,e){let t=e.length-1;t>=0&&n.isText&&n.sameMarkup(e[t])?e[t]=n.withText(e[t].text+n.text):e.push(n)}function or(n,e,t,s){let i=(e||n).node(t),r=0,o=e?e.index(t):i.childCount;n&&(r=n.index(t),n.depth>t?r++:n.textOffset&&($s(n.nodeAfter,s),r++));for(let a=r;a<o;a++)$s(i.child(a),s);e&&e.depth==t&&e.textOffset&&$s(e.nodeBefore,s)}function Ks(n,e){return n.type.checkContent(e),n.copy(e)}function Bf(n,e,t,s,i){let r=n.depth>i&&el(n,e,i+1),o=s.depth>i&&el(t,s,i+1),a=[];return or(null,n,i,a),r&&o&&e.index(i)==t.index(i)?(Ff(r,o),$s(Ks(r,Bf(n,e,t,s,i+1)),a)):(r&&$s(Ks(r,No(n,e,i+1)),a),or(e,t,i,a),o&&$s(Ks(o,No(t,s,i+1)),a)),or(s,null,i,a),new H(a)}function No(n,e,t){let s=[];if(or(null,n,t,s),n.depth>t){let i=el(n,e,t+1);$s(Ks(i,No(n,e,t+1)),s)}return or(e,null,t,s),new H(s)}function Pw(n,e){let t=e.depth-n.openStart,i=e.node(t).copy(n.content);for(let r=t-1;r>=0;r--)i=e.node(r).copy(H.from(i));return{start:i.resolveNoCache(n.openStart+t),end:i.resolveNoCache(i.content.size-n.openEnd-t)}}class yr{constructor(e,t,s){this.pos=e,this.path=t,this.parentOffset=s,this.depth=t.length/3-1}resolveDepth(e){return e==null?this.depth:e<0?this.depth+e:e}get parent(){return this.node(this.depth)}get doc(){return this.node(0)}node(e){return this.path[this.resolveDepth(e)*3]}index(e){return this.path[this.resolveDepth(e)*3+1]}indexAfter(e){return e=this.resolveDepth(e),this.index(e)+(e==this.depth&&!this.textOffset?0:1)}start(e){return e=this.resolveDepth(e),e==0?0:this.path[e*3-1]+1}end(e){return e=this.resolveDepth(e),this.start(e)+this.node(e).content.size}before(e){if(e=this.resolveDepth(e),!e)throw new RangeError("There is no position before the top-level node");return e==this.depth+1?this.pos:this.path[e*3-1]}after(e){if(e=this.resolveDepth(e),!e)throw new RangeError("There is no position after the top-level node");return e==this.depth+1?this.pos:this.path[e*3-1]+this.path[e*3].nodeSize}get textOffset(){return this.pos-this.path[this.path.length-1]}get nodeAfter(){let e=this.parent,t=this.index(this.depth);if(t==e.childCount)return null;let s=this.pos-this.path[this.path.length-1],i=e.child(t);return s?e.child(t).cut(s):i}get nodeBefore(){let e=this.index(this.depth),t=this.pos-this.path[this.path.length-1];return t?this.parent.child(e).cut(0,t):e==0?null:this.parent.child(e-1)}posAtIndex(e,t){t=this.resolveDepth(t);let s=this.path[t*3],i=t==0?0:this.path[t*3-1]+1;for(let r=0;r<e;r++)i+=s.child(r).nodeSize;return i}marks(){let e=this.parent,t=this.index();if(e.content.size==0)return Pe.none;if(this.textOffset)return e.child(t).marks;let s=e.maybeChild(t-1),i=e.maybeChild(t);if(!s){let a=s;s=i,i=a}let r=s.marks;for(var o=0;o<r.length;o++)r[o].type.spec.inclusive===!1&&(!i||!r[o].isInSet(i.marks))&&(r=r[o--].removeFromSet(r));return r}marksAcross(e){let t=this.parent.maybeChild(this.index());if(!t||!t.isInline)return null;let s=t.marks,i=e.parent.maybeChild(e.index());for(var r=0;r<s.length;r++)s[r].type.spec.inclusive===!1&&(!i||!s[r].isInSet(i.marks))&&(s=s[r--].removeFromSet(s));return s}sharedDepth(e){for(let t=this.depth;t>0;t--)if(this.start(t)<=e&&this.end(t)>=e)return t;return 0}blockRange(e=this,t){if(e.pos<this.pos)return e.blockRange(this);for(let s=this.depth-(this.parent.inlineContent||this.pos==e.pos?1:0);s>=0;s--)if(e.pos<=this.end(s)&&(!t||t(this.node(s))))return new Lw(this,e,s);return null}sameParent(e){return this.pos-this.parentOffset==e.pos-e.parentOffset}max(e){return e.pos>this.pos?e:this}min(e){return e.pos<this.pos?e:this}toString(){let e="";for(let t=1;t<=this.depth;t++)e+=(e?"/":"")+this.node(t).type.name+"_"+this.index(t-1);return e+":"+this.parentOffset}static resolve(e,t){if(!(t>=0&&t<=e.content.size))throw new RangeError("Position "+t+" out of range");let s=[],i=0,r=t;for(let o=e;;){let{index:a,offset:l}=o.content.findIndex(r),d=r-l;if(s.push(o,a,i+l),!d||(o=o.child(a),o.isText))break;r=d-1,i+=l+1}return new yr(t,s,r)}static resolveCached(e,t){let s=xd.get(e);if(s)for(let r=0;r<s.elts.length;r++){let o=s.elts[r];if(o.pos==t)return o}else xd.set(e,s=new Fw);let i=s.elts[s.i]=yr.resolve(e,t);return s.i=(s.i+1)%Bw,i}}class Fw{constructor(){this.elts=[],this.i=0}}const Bw=12,xd=new WeakMap;class Lw{constructor(e,t,s){this.$from=e,this.$to=t,this.depth=s}get start(){return this.$from.before(this.depth+1)}get end(){return this.$to.after(this.depth+1)}get parent(){return this.$from.node(this.depth)}get startIndex(){return this.$from.index(this.depth)}get endIndex(){return this.$to.indexAfter(this.depth)}}const zw=Object.create(null);class Pn{constructor(e,t,s,i=Pe.none){this.type=e,this.attrs=t,this.marks=i,this.content=s||H.empty}get nodeSize(){return this.isLeaf?1:2+this.content.size}get childCount(){return this.content.childCount}child(e){return this.content.child(e)}maybeChild(e){return this.content.maybeChild(e)}forEach(e){this.content.forEach(e)}nodesBetween(e,t,s,i=0){this.content.nodesBetween(e,t,s,i,this)}descendants(e){this.nodesBetween(0,this.content.size,e)}get textContent(){return this.isLeaf&&this.type.spec.leafText?this.type.spec.leafText(this):this.textBetween(0,this.content.size,"")}textBetween(e,t,s,i){return this.content.textBetween(e,t,s,i)}get firstChild(){return this.content.firstChild}get lastChild(){return this.content.lastChild}eq(e){return this==e||this.sameMarkup(e)&&this.content.eq(e.content)}sameMarkup(e){return this.hasMarkup(e.type,e.attrs,e.marks)}hasMarkup(e,t,s){return this.type==e&&Eo(this.attrs,t||e.defaultAttrs||zw)&&Pe.sameSet(this.marks,s||Pe.none)}copy(e=null){return e==this.content?this:new Pn(this.type,this.attrs,e,this.marks)}mark(e){return e==this.marks?this:new Pn(this.type,this.attrs,this.content,e)}cut(e,t=this.content.size){return e==0&&t==this.content.size?this:this.copy(this.content.cut(e,t))}slice(e,t=this.content.size,s=!1){if(e==t)return Q.empty;let i=this.resolve(e),r=this.resolve(t),o=s?0:i.sharedDepth(t),a=i.start(o),d=i.node(o).content.cut(i.pos-a,r.pos-a);return new Q(d,i.depth-o,r.depth-o)}replace(e,t,s){return Ow(this.resolve(e),this.resolve(t),s)}nodeAt(e){for(let t=this;;){let{index:s,offset:i}=t.content.findIndex(e);if(t=t.maybeChild(s),!t)return null;if(i==e||t.isText)return t;e-=i+1}}childAfter(e){let{index:t,offset:s}=this.content.findIndex(e);return{node:this.content.maybeChild(t),index:t,offset:s}}childBefore(e){if(e==0)return{node:null,index:0,offset:0};let{index:t,offset:s}=this.content.findIndex(e);if(s<e)return{node:this.content.child(t),index:t,offset:s};let i=this.content.child(t-1);return{node:i,index:t-1,offset:s-i.nodeSize}}resolve(e){return yr.resolveCached(this,e)}resolveNoCache(e){return yr.resolve(this,e)}rangeHasMark(e,t,s){let i=!1;return t>e&&this.nodesBetween(e,t,r=>(s.isInSet(r.marks)&&(i=!0),!i)),i}get isBlock(){return this.type.isBlock}get isTextblock(){return this.type.isTextblock}get inlineContent(){return this.type.inlineContent}get isInline(){return this.type.isInline}get isText(){return this.type.isText}get isLeaf(){return this.type.isLeaf}get isAtom(){return this.type.isAtom}toString(){if(this.type.spec.toDebugString)return this.type.spec.toDebugString(this);let e=this.type.name;return this.content.size&&(e+="("+this.content.toStringInner()+")"),Lf(this.marks,e)}contentMatchAt(e){let t=this.type.contentMatch.matchFragment(this.content,0,e);if(!t)throw new Error("Called contentMatchAt on a node with invalid content");return t}canReplace(e,t,s=H.empty,i=0,r=s.childCount){let o=this.contentMatchAt(e).matchFragment(s,i,r),a=o&&o.matchFragment(this.content,t);if(!a||!a.validEnd)return!1;for(let l=i;l<r;l++)if(!this.type.allowsMarks(s.child(l).marks))return!1;return!0}canReplaceWith(e,t,s,i){if(i&&!this.type.allowsMarks(i))return!1;let r=this.contentMatchAt(e).matchType(s),o=r&&r.matchFragment(this.content,t);return o?o.validEnd:!1}canAppend(e){return e.content.size?this.canReplace(this.childCount,this.childCount,e.content):this.type.compatibleContent(e.type)}check(){this.type.checkContent(this.content),this.type.checkAttrs(this.attrs);let e=Pe.none;for(let t=0;t<this.marks.length;t++){let s=this.marks[t];s.type.checkAttrs(s.attrs),e=s.addToSet(e)}if(!Pe.sameSet(e,this.marks))throw new RangeError(`Invalid collection of marks for node ${this.type.name}: ${this.marks.map(t=>t.type.name)}`);this.content.forEach(t=>t.check())}toJSON(){let e={type:this.type.name};for(let t in this.attrs){e.attrs=this.attrs;break}return this.content.size&&(e.content=this.content.toJSON()),this.marks.length&&(e.marks=this.marks.map(t=>t.toJSON())),e}static fromJSON(e,t){if(!t)throw new RangeError("Invalid input for Node.fromJSON");let s;if(t.marks){if(!Array.isArray(t.marks))throw new RangeError("Invalid mark data for Node.fromJSON");s=t.marks.map(e.markFromJSON)}if(t.type=="text"){if(typeof t.text!="string")throw new RangeError("Invalid text node in JSON");return e.text(t.text,s)}let i=H.fromJSON(e,t.content),r=e.nodeType(t.type).create(t.attrs,i,s);return r.type.checkAttrs(r.attrs),r}}Pn.prototype.text=void 0;class Io extends Pn{constructor(e,t,s,i){if(super(e,t,null,i),!s)throw new RangeError("Empty text nodes are not allowed");this.text=s}toString(){return this.type.spec.toDebugString?this.type.spec.toDebugString(this):Lf(this.marks,JSON.stringify(this.text))}get textContent(){return this.text}textBetween(e,t){return this.text.slice(e,t)}get nodeSize(){return this.text.length}mark(e){return e==this.marks?this:new Io(this.type,this.attrs,this.text,e)}withText(e){return e==this.text?this:new Io(this.type,this.attrs,e,this.marks)}cut(e=0,t=this.text.length){return e==0&&t==this.text.length?this:this.withText(this.text.slice(e,t))}eq(e){return this.sameMarkup(e)&&this.text==e.text}toJSON(){let e=super.toJSON();return e.text=this.text,e}}function Lf(n,e){for(let t=n.length-1;t>=0;t--)e=n[t].type.name+"("+e+")";return e}class ti{constructor(e){this.validEnd=e,this.next=[],this.wrapCache=[]}static parse(e,t){let s=new Uw(e,t);if(s.next==null)return ti.empty;let i=zf(s);s.next&&s.err("Unexpected trailing text");let r=Kw($w(i));return Jw(r,s),r}matchType(e){for(let t=0;t<this.next.length;t++)if(this.next[t].type==e)return this.next[t].next;return null}matchFragment(e,t=0,s=e.childCount){let i=this;for(let r=t;i&&r<s;r++)i=i.matchType(e.child(r).type);return i}get inlineContent(){return this.next.length!=0&&this.next[0].type.isInline}get defaultType(){for(let e=0;e<this.next.length;e++){let{type:t}=this.next[e];if(!(t.isText||t.hasRequiredAttrs()))return t}return null}compatible(e){for(let t=0;t<this.next.length;t++)for(let s=0;s<e.next.length;s++)if(this.next[t].type==e.next[s].type)return!0;return!1}fillBefore(e,t=!1,s=0){let i=[this];function r(o,a){let l=o.matchFragment(e,s);if(l&&(!t||l.validEnd))return H.from(a.map(d=>d.createAndFill()));for(let d=0;d<o.next.length;d++){let{type:u,next:p}=o.next[d];if(!(u.isText||u.hasRequiredAttrs())&&i.indexOf(p)==-1){i.push(p);let m=r(p,a.concat(u));if(m)return m}}return null}return r(this,[])}findWrapping(e){for(let s=0;s<this.wrapCache.length;s+=2)if(this.wrapCache[s]==e)return this.wrapCache[s+1];let t=this.computeWrapping(e);return this.wrapCache.push(e,t),t}computeWrapping(e){let t=Object.create(null),s=[{match:this,type:null,via:null}];for(;s.length;){let i=s.shift(),r=i.match;if(r.matchType(e)){let o=[];for(let a=i;a.type;a=a.via)o.push(a.type);return o.reverse()}for(let o=0;o<r.next.length;o++){let{type:a,next:l}=r.next[o];!a.isLeaf&&!a.hasRequiredAttrs()&&!(a.name in t)&&(!i.type||l.validEnd)&&(s.push({match:a.contentMatch,type:a,via:i}),t[a.name]=!0)}}return null}get edgeCount(){return this.next.length}edge(e){if(e>=this.next.length)throw new RangeError(`There's no ${e}th edge in this content match`);return this.next[e]}toString(){let e=[];function t(s){e.push(s);for(let i=0;i<s.next.length;i++)e.indexOf(s.next[i].next)==-1&&t(s.next[i].next)}return t(this),e.map((s,i)=>{let r=i+(s.validEnd?"*":" ")+" ";for(let o=0;o<s.next.length;o++)r+=(o?", ":"")+s.next[o].type.name+"->"+e.indexOf(s.next[o].next);return r}).join(`
`)}}ti.empty=new ti(!0);class Uw{constructor(e,t){this.string=e,this.nodeTypes=t,this.inline=null,this.pos=0,this.tokens=e.split(/\s*(?=\b|\W|$)/),this.tokens[this.tokens.length-1]==""&&this.tokens.pop(),this.tokens[0]==""&&this.tokens.shift()}get next(){return this.tokens[this.pos]}eat(e){return this.next==e&&(this.pos++||!0)}err(e){throw new SyntaxError(e+" (in content expression '"+this.string+"')")}}function zf(n){let e=[];do e.push(Vw(n));while(n.eat("|"));return e.length==1?e[0]:{type:"choice",exprs:e}}function Vw(n){let e=[];do e.push(Gw(n));while(n.next&&n.next!=")"&&n.next!="|");return e.length==1?e[0]:{type:"seq",exprs:e}}function Gw(n){let e=qw(n);for(;;)if(n.eat("+"))e={type:"plus",expr:e};else if(n.eat("*"))e={type:"star",expr:e};else if(n.eat("?"))e={type:"opt",expr:e};else if(n.eat("{"))e=Ww(n,e);else break;return e}function bd(n){/\D/.test(n.next)&&n.err("Expected number, got '"+n.next+"'");let e=Number(n.next);return n.pos++,e}function Ww(n,e){let t=bd(n),s=t;return n.eat(",")&&(n.next!="}"?s=bd(n):s=-1),n.eat("}")||n.err("Unclosed braced range"),{type:"range",min:t,max:s,expr:e}}function Hw(n,e){let t=n.nodeTypes,s=t[e];if(s)return[s];let i=[];for(let r in t){let o=t[r];o.groups.indexOf(e)>-1&&i.push(o)}return i.length==0&&n.err("No node type or group '"+e+"' found"),i}function qw(n){if(n.eat("(")){let e=zf(n);return n.eat(")")||n.err("Missing closing paren"),e}else if(/\W/.test(n.next))n.err("Unexpected token '"+n.next+"'");else{let e=Hw(n,n.next).map(t=>(n.inline==null?n.inline=t.isInline:n.inline!=t.isInline&&n.err("Mixing inline and block content"),{type:"name",value:t}));return n.pos++,e.length==1?e[0]:{type:"choice",exprs:e}}}function $w(n){let e=[[]];return i(r(n,0),t()),e;function t(){return e.push([])-1}function s(o,a,l){let d={term:l,to:a};return e[o].push(d),d}function i(o,a){o.forEach(l=>l.to=a)}function r(o,a){if(o.type=="choice")return o.exprs.reduce((l,d)=>l.concat(r(d,a)),[]);if(o.type=="seq")for(let l=0;;l++){let d=r(o.exprs[l],a);if(l==o.exprs.length-1)return d;i(d,a=t())}else if(o.type=="star"){let l=t();return s(a,l),i(r(o.expr,l),l),[s(l)]}else if(o.type=="plus"){let l=t();return i(r(o.expr,a),l),i(r(o.expr,l),l),[s(l)]}else{if(o.type=="opt")return[s(a)].concat(r(o.expr,a));if(o.type=="range"){let l=a;for(let d=0;d<o.min;d++){let u=t();i(r(o.expr,l),u),l=u}if(o.max==-1)i(r(o.expr,l),l);else for(let d=o.min;d<o.max;d++){let u=t();s(l,u),i(r(o.expr,l),u),l=u}return[s(l)]}else{if(o.type=="name")return[s(a,void 0,o.value)];throw new Error("Unknown expr type")}}}}function Uf(n,e){return e-n}function Sd(n,e){let t=[];return s(e),t.sort(Uf);function s(i){let r=n[i];if(r.length==1&&!r[0].term)return s(r[0].to);t.push(i);for(let o=0;o<r.length;o++){let{term:a,to:l}=r[o];!a&&t.indexOf(l)==-1&&s(l)}}}function Kw(n){let e=Object.create(null);return t(Sd(n,0));function t(s){let i=[];s.forEach(o=>{n[o].forEach(({term:a,to:l})=>{if(!a)return;let d;for(let u=0;u<i.length;u++)i[u][0]==a&&(d=i[u][1]);Sd(n,l).forEach(u=>{d||i.push([a,d=[]]),d.indexOf(u)==-1&&d.push(u)})})});let r=e[s.join(",")]=new ti(s.indexOf(n.length-1)>-1);for(let o=0;o<i.length;o++){let a=i[o][1].sort(Uf);r.next.push({type:i[o][0],next:e[a.join(",")]||t(a)})}return r}}function Jw(n,e){for(let t=0,s=[n];t<s.length;t++){let i=s[t],r=!i.validEnd,o=[];for(let a=0;a<i.next.length;a++){let{type:l,next:d}=i.next[a];o.push(l.name),r&&!(l.isText||l.hasRequiredAttrs())&&(r=!1),s.indexOf(d)==-1&&s.push(d)}r&&e.err("Only non-generatable nodes ("+o.join(", ")+") in a required position (see https://prosemirror.net/docs/guide/#generatable)")}}function Vf(n){let e=Object.create(null);for(let t in n){let s=n[t];if(!s.hasDefault)return null;e[t]=s.default}return e}function Gf(n,e){let t=Object.create(null);for(let s in n){let i=e&&e[s];if(i===void 0){let r=n[s];if(r.hasDefault)i=r.default;else throw new RangeError("No value supplied for attribute "+s)}t[s]=i}return t}function Wf(n,e,t,s){for(let i in e)if(!(i in n))throw new RangeError(`Unsupported attribute ${i} for ${t} of type ${i}`);for(let i in n){let r=n[i];r.validate&&r.validate(e[i])}}function Hf(n,e){let t=Object.create(null);if(e)for(let s in e)t[s]=new Qw(n,s,e[s]);return t}let wd=class qf{constructor(e,t,s){this.name=e,this.schema=t,this.spec=s,this.markSet=null,this.groups=s.group?s.group.split(" "):[],this.attrs=Hf(e,s.attrs),this.defaultAttrs=Vf(this.attrs),this.contentMatch=null,this.inlineContent=null,this.isBlock=!(s.inline||e=="text"),this.isText=e=="text"}get isInline(){return!this.isBlock}get isTextblock(){return this.isBlock&&this.inlineContent}get isLeaf(){return this.contentMatch==ti.empty}get isAtom(){return this.isLeaf||!!this.spec.atom}get whitespace(){return this.spec.whitespace||(this.spec.code?"pre":"normal")}hasRequiredAttrs(){for(let e in this.attrs)if(this.attrs[e].isRequired)return!0;return!1}compatibleContent(e){return this==e||this.contentMatch.compatible(e.contentMatch)}computeAttrs(e){return!e&&this.defaultAttrs?this.defaultAttrs:Gf(this.attrs,e)}create(e=null,t,s){if(this.isText)throw new Error("NodeType.create can't construct text nodes");return new Pn(this,this.computeAttrs(e),H.from(t),Pe.setFrom(s))}createChecked(e=null,t,s){return t=H.from(t),this.checkContent(t),new Pn(this,this.computeAttrs(e),t,Pe.setFrom(s))}createAndFill(e=null,t,s){if(e=this.computeAttrs(e),t=H.from(t),t.size){let o=this.contentMatch.fillBefore(t);if(!o)return null;t=o.append(t)}let i=this.contentMatch.matchFragment(t),r=i&&i.fillBefore(H.empty,!0);return r?new Pn(this,e,t.append(r),Pe.setFrom(s)):null}validContent(e){let t=this.contentMatch.matchFragment(e);if(!t||!t.validEnd)return!1;for(let s=0;s<e.childCount;s++)if(!this.allowsMarks(e.child(s).marks))return!1;return!0}checkContent(e){if(!this.validContent(e))throw new RangeError(`Invalid content for node ${this.name}: ${e.toString().slice(0,50)}`)}checkAttrs(e){Wf(this.attrs,e,"node",this.name)}allowsMarkType(e){return this.markSet==null||this.markSet.indexOf(e)>-1}allowsMarks(e){if(this.markSet==null)return!0;for(let t=0;t<e.length;t++)if(!this.allowsMarkType(e[t].type))return!1;return!0}allowedMarks(e){if(this.markSet==null)return e;let t;for(let s=0;s<e.length;s++)this.allowsMarkType(e[s].type)?t&&t.push(e[s]):t||(t=e.slice(0,s));return t?t.length?t:Pe.none:e}static compile(e,t){let s=Object.create(null);e.forEach((r,o)=>s[r]=new qf(r,t,o));let i=t.spec.topNode||"doc";if(!s[i])throw new RangeError("Schema is missing its top node type ('"+i+"')");if(!s.text)throw new RangeError("Every schema needs a 'text' type");for(let r in s.text.attrs)throw new RangeError("The text node type should not have attributes");return s}};function Yw(n,e,t){let s=t.split("|");return i=>{let r=i===null?"null":typeof i;if(s.indexOf(r)<0)throw new RangeError(`Expected value of type ${s} for attribute ${e} on type ${n}, got ${r}`)}}class Qw{constructor(e,t,s){this.hasDefault=Object.prototype.hasOwnProperty.call(s,"default"),this.default=s.default,this.validate=typeof s.validate=="string"?Yw(e,t,s.validate):s.validate}get isRequired(){return!this.hasDefault}}class ea{constructor(e,t,s,i){this.name=e,this.rank=t,this.schema=s,this.spec=i,this.attrs=Hf(e,i.attrs),this.excluded=null;let r=Vf(this.attrs);this.instance=r?new Pe(this,r):null}create(e=null){return!e&&this.instance?this.instance:new Pe(this,Gf(this.attrs,e))}static compile(e,t){let s=Object.create(null),i=0;return e.forEach((r,o)=>s[r]=new ea(r,i++,t,o)),s}removeFromSet(e){for(var t=0;t<e.length;t++)e[t].type==this&&(e=e.slice(0,t).concat(e.slice(t+1)),t--);return e}isInSet(e){for(let t=0;t<e.length;t++)if(e[t].type==this)return e[t]}checkAttrs(e){Wf(this.attrs,e,"mark",this.name)}excludes(e){return this.excluded.indexOf(e)>-1}}class Xw{constructor(e){this.linebreakReplacement=null,this.cached=Object.create(null);let t=this.spec={};for(let i in e)t[i]=e[i];t.nodes=Gc.from(e.nodes),t.marks=Gc.from(e.marks||{}),this.nodes=wd.compile(this.spec.nodes,this),this.marks=ea.compile(this.spec.marks,this);let s=Object.create(null);for(let i in this.nodes){if(i in this.marks)throw new RangeError(i+" can not be both a node and a mark");let r=this.nodes[i],o=r.spec.content||"",a=r.spec.marks;if(r.contentMatch=s[o]||(s[o]=ti.parse(o,this.nodes)),r.inlineContent=r.contentMatch.inlineContent,r.spec.linebreakReplacement){if(this.linebreakReplacement)throw new RangeError("Multiple linebreak nodes defined");if(!r.isInline||!r.isLeaf)throw new RangeError("Linebreak replacement nodes must be inline leaf nodes");this.linebreakReplacement=r}r.markSet=a=="_"?null:a?kd(this,a.split(" ")):a==""||!r.inlineContent?[]:null}for(let i in this.marks){let r=this.marks[i],o=r.spec.excludes;r.excluded=o==null?[r]:o==""?[]:kd(this,o.split(" "))}this.nodeFromJSON=this.nodeFromJSON.bind(this),this.markFromJSON=this.markFromJSON.bind(this),this.topNodeType=this.nodes[this.spec.topNode||"doc"],this.cached.wrappings=Object.create(null)}node(e,t=null,s,i){if(typeof e=="string")e=this.nodeType(e);else if(e instanceof wd){if(e.schema!=this)throw new RangeError("Node type from different schema used ("+e.name+")")}else throw new RangeError("Invalid node type: "+e);return e.createChecked(t,s,i)}text(e,t){let s=this.nodes.text;return new Io(s,s.defaultAttrs,e,Pe.setFrom(t))}mark(e,t){return typeof e=="string"&&(e=this.marks[e]),e.create(t)}nodeFromJSON(e){return Pn.fromJSON(this,e)}markFromJSON(e){return Pe.fromJSON(this,e)}nodeType(e){let t=this.nodes[e];if(!t)throw new RangeError("Unknown node type: "+e);return t}}function kd(n,e){let t=[];for(let s=0;s<e.length;s++){let i=e[s],r=n.marks[i],o=r;if(r)t.push(r);else for(let a in n.marks){let l=n.marks[a];(i=="_"||l.spec.group&&l.spec.group.split(" ").indexOf(i)>-1)&&t.push(o=l)}if(!o)throw new SyntaxError("Unknown mark type: '"+e[s]+"'")}return t}function Zw(n){return n.tag!=null}function ek(n){return n.style!=null}class xr{constructor(e,t){this.schema=e,this.rules=t,this.tags=[],this.styles=[];let s=this.matchedStyles=[];t.forEach(i=>{if(Zw(i))this.tags.push(i);else if(ek(i)){let r=/[^=]*/.exec(i.style)[0];s.indexOf(r)<0&&s.push(r),this.styles.push(i)}}),this.normalizeLists=!this.tags.some(i=>{if(!/^(ul|ol)\b/.test(i.tag)||!i.node)return!1;let r=e.nodes[i.node];return r.contentMatch.matchType(r)})}parse(e,t={}){let s=new Md(this,t,!1);return s.addAll(e,t.from,t.to),s.finish()}parseSlice(e,t={}){let s=new Md(this,t,!0);return s.addAll(e,t.from,t.to),Q.maxOpen(s.finish())}matchTag(e,t,s){for(let i=s?this.tags.indexOf(s)+1:0;i<this.tags.length;i++){let r=this.tags[i];if(sk(e,r.tag)&&(r.namespace===void 0||e.namespaceURI==r.namespace)&&(!r.context||t.matchesContext(r.context))){if(r.getAttrs){let o=r.getAttrs(e);if(o===!1)continue;r.attrs=o||void 0}return r}}}matchStyle(e,t,s,i){for(let r=i?this.styles.indexOf(i)+1:0;r<this.styles.length;r++){let o=this.styles[r],a=o.style;if(!(a.indexOf(e)!=0||o.context&&!s.matchesContext(o.context)||a.length>e.length&&(a.charCodeAt(e.length)!=61||a.slice(e.length+1)!=t))){if(o.getAttrs){let l=o.getAttrs(t);if(l===!1)continue;o.attrs=l||void 0}return o}}}static schemaRules(e){let t=[];function s(i){let r=i.priority==null?50:i.priority,o=0;for(;o<t.length;o++){let a=t[o];if((a.priority==null?50:a.priority)<r)break}t.splice(o,0,i)}for(let i in e.marks){let r=e.marks[i].spec.parseDOM;r&&r.forEach(o=>{s(o=vd(o)),o.mark||o.ignore||o.clearMark||(o.mark=i)})}for(let i in e.nodes){let r=e.nodes[i].spec.parseDOM;r&&r.forEach(o=>{s(o=vd(o)),o.node||o.ignore||o.mark||(o.node=i)})}return t}static fromSchema(e){return e.cached.domParser||(e.cached.domParser=new xr(e,xr.schemaRules(e)))}}const $f={address:!0,article:!0,aside:!0,blockquote:!0,canvas:!0,dd:!0,div:!0,dl:!0,fieldset:!0,figcaption:!0,figure:!0,footer:!0,form:!0,h1:!0,h2:!0,h3:!0,h4:!0,h5:!0,h6:!0,header:!0,hgroup:!0,hr:!0,li:!0,noscript:!0,ol:!0,output:!0,p:!0,pre:!0,section:!0,table:!0,tfoot:!0,ul:!0},tk={head:!0,noscript:!0,object:!0,script:!0,style:!0,title:!0},Kf={ol:!0,ul:!0},Ao=1,Ro=2,ar=4;function Cd(n,e,t){return e!=null?(e?Ao:0)|(e==="full"?Ro:0):n&&n.whitespace=="pre"?Ao|Ro:t&~ar}class Hr{constructor(e,t,s,i,r,o,a){this.type=e,this.attrs=t,this.marks=s,this.pendingMarks=i,this.solid=r,this.options=a,this.content=[],this.activeMarks=Pe.none,this.stashMarks=[],this.match=o||(a&ar?null:e.contentMatch)}findWrapping(e){if(!this.match){if(!this.type)return[];let t=this.type.contentMatch.fillBefore(H.from(e));if(t)this.match=this.type.contentMatch.matchFragment(t);else{let s=this.type.contentMatch,i;return(i=s.findWrapping(e.type))?(this.match=s,i):null}}return this.match.findWrapping(e.type)}finish(e){if(!(this.options&Ao)){let s=this.content[this.content.length-1],i;if(s&&s.isText&&(i=/[ \t\r\n\u000c]+$/.exec(s.text))){let r=s;s.text.length==i[0].length?this.content.pop():this.content[this.content.length-1]=r.withText(r.text.slice(0,r.text.length-i[0].length))}}let t=H.from(this.content);return!e&&this.match&&(t=t.append(this.match.fillBefore(H.empty,!0))),this.type?this.type.create(this.attrs,t,this.marks):t}popFromStashMark(e){for(let t=this.stashMarks.length-1;t>=0;t--)if(e.eq(this.stashMarks[t]))return this.stashMarks.splice(t,1)[0]}applyPending(e){for(let t=0,s=this.pendingMarks;t<s.length;t++){let i=s[t];(this.type?this.type.allowsMarkType(i.type):ik(i.type,e))&&!i.isInSet(this.activeMarks)&&(this.activeMarks=i.addToSet(this.activeMarks),this.pendingMarks=i.removeFromSet(this.pendingMarks))}}inlineContext(e){return this.type?this.type.inlineContent:this.content.length?this.content[0].isInline:e.parentNode&&!$f.hasOwnProperty(e.parentNode.nodeName.toLowerCase())}}class Md{constructor(e,t,s){this.parser=e,this.options=t,this.isOpen=s,this.open=0;let i=t.topNode,r,o=Cd(null,t.preserveWhitespace,0)|(s?ar:0);i?r=new Hr(i.type,i.attrs,Pe.none,Pe.none,!0,t.topMatch||i.type.contentMatch,o):s?r=new Hr(null,null,Pe.none,Pe.none,!0,null,o):r=new Hr(e.schema.topNodeType,null,Pe.none,Pe.none,!0,null,o),this.nodes=[r],this.find=t.findPositions,this.needsBlock=!1}get top(){return this.nodes[this.open]}addDOM(e){e.nodeType==3?this.addTextNode(e):e.nodeType==1&&this.addElement(e)}withStyleRules(e,t){let s=e.style;if(!s||!s.length)return t();let i=this.readStyles(e.style);if(!i)return;let[r,o]=i,a=this.top;for(let l=0;l<o.length;l++)this.removePendingMark(o[l],a);for(let l=0;l<r.length;l++)this.addPendingMark(r[l]);t();for(let l=0;l<r.length;l++)this.removePendingMark(r[l],a);for(let l=0;l<o.length;l++)this.addPendingMark(o[l])}addTextNode(e){let t=e.nodeValue,s=this.top;if(s.options&Ro||s.inlineContext(e)||/[^ \t\r\n\u000c]/.test(t)){if(s.options&Ao)s.options&Ro?t=t.replace(/\r\n?/g,`
`):t=t.replace(/\r?\n|\r/g," ");else if(t=t.replace(/[ \t\r\n\u000c]+/g," "),/^[ \t\r\n\u000c]/.test(t)&&this.open==this.nodes.length-1){let i=s.content[s.content.length-1],r=e.previousSibling;(!i||r&&r.nodeName=="BR"||i.isText&&/[ \t\r\n\u000c]$/.test(i.text))&&(t=t.slice(1))}t&&this.insertNode(this.parser.schema.text(t)),this.findInText(e)}else this.findInside(e)}addElement(e,t){let s=e.nodeName.toLowerCase(),i;Kf.hasOwnProperty(s)&&this.parser.normalizeLists&&nk(e);let r=this.options.ruleFromNode&&this.options.ruleFromNode(e)||(i=this.parser.matchTag(e,this,t));if(r?r.ignore:tk.hasOwnProperty(s))this.findInside(e),this.ignoreFallback(e);else if(!r||r.skip||r.closeParent){r&&r.closeParent?this.open=Math.max(0,this.open-1):r&&r.skip.nodeType&&(e=r.skip);let o,a=this.top,l=this.needsBlock;if($f.hasOwnProperty(s))a.content.length&&a.content[0].isInline&&this.open&&(this.open--,a=this.top),o=!0,a.type||(this.needsBlock=!0);else if(!e.firstChild){this.leafFallback(e);return}r&&r.skip?this.addAll(e):this.withStyleRules(e,()=>this.addAll(e)),o&&this.sync(a),this.needsBlock=l}else this.withStyleRules(e,()=>{this.addElementByRule(e,r,r.consuming===!1?i:void 0)})}leafFallback(e){e.nodeName=="BR"&&this.top.type&&this.top.type.inlineContent&&this.addTextNode(e.ownerDocument.createTextNode(`
`))}ignoreFallback(e){e.nodeName=="BR"&&(!this.top.type||!this.top.type.inlineContent)&&this.findPlace(this.parser.schema.text("-"))}readStyles(e){let t=Pe.none,s=Pe.none;if(e.length)for(let i=0;i<this.parser.matchedStyles.length;i++){let r=this.parser.matchedStyles[i],o=e.getPropertyValue(r);if(o)for(let a=void 0;;){let l=this.parser.matchStyle(r,o,this,a);if(!l)break;if(l.ignore)return null;if(l.clearMark?this.top.pendingMarks.concat(this.top.activeMarks).forEach(d=>{l.clearMark(d)&&(s=d.addToSet(s))}):t=this.parser.schema.marks[l.mark].create(l.attrs).addToSet(t),l.consuming===!1)a=l;else break}}return[t,s]}addElementByRule(e,t,s){let i,r,o;t.node?(r=this.parser.schema.nodes[t.node],r.isLeaf?this.insertNode(r.create(t.attrs))||this.leafFallback(e):i=this.enter(r,t.attrs||null,t.preserveWhitespace)):(o=this.parser.schema.marks[t.mark].create(t.attrs),this.addPendingMark(o));let a=this.top;if(r&&r.isLeaf)this.findInside(e);else if(s)this.addElement(e,s);else if(t.getContent)this.findInside(e),t.getContent(e,this.parser.schema).forEach(l=>this.insertNode(l));else{let l=e;typeof t.contentElement=="string"?l=e.querySelector(t.contentElement):typeof t.contentElement=="function"?l=t.contentElement(e):t.contentElement&&(l=t.contentElement),this.findAround(e,l,!0),this.addAll(l)}i&&this.sync(a)&&this.open--,o&&this.removePendingMark(o,a)}addAll(e,t,s){let i=t||0;for(let r=t?e.childNodes[t]:e.firstChild,o=s==null?null:e.childNodes[s];r!=o;r=r.nextSibling,++i)this.findAtPoint(e,i),this.addDOM(r);this.findAtPoint(e,i)}findPlace(e){let t,s;for(let i=this.open;i>=0;i--){let r=this.nodes[i],o=r.findWrapping(e);if(o&&(!t||t.length>o.length)&&(t=o,s=r,!o.length)||r.solid)break}if(!t)return!1;this.sync(s);for(let i=0;i<t.length;i++)this.enterInner(t[i],null,!1);return!0}insertNode(e){if(e.isInline&&this.needsBlock&&!this.top.type){let t=this.textblockFromContext();t&&this.enterInner(t)}if(this.findPlace(e)){this.closeExtra();let t=this.top;t.applyPending(e.type),t.match&&(t.match=t.match.matchType(e.type));let s=t.activeMarks;for(let i=0;i<e.marks.length;i++)(!t.type||t.type.allowsMarkType(e.marks[i].type))&&(s=e.marks[i].addToSet(s));return t.content.push(e.mark(s)),!0}return!1}enter(e,t,s){let i=this.findPlace(e.create(t));return i&&this.enterInner(e,t,!0,s),i}enterInner(e,t=null,s=!1,i){this.closeExtra();let r=this.top;r.applyPending(e),r.match=r.match&&r.match.matchType(e);let o=Cd(e,i,r.options);r.options&ar&&r.content.length==0&&(o|=ar),this.nodes.push(new Hr(e,t,r.activeMarks,r.pendingMarks,s,null,o)),this.open++}closeExtra(e=!1){let t=this.nodes.length-1;if(t>this.open){for(;t>this.open;t--)this.nodes[t-1].content.push(this.nodes[t].finish(e));this.nodes.length=this.open+1}}finish(){return this.open=0,this.closeExtra(this.isOpen),this.nodes[0].finish(this.isOpen||this.options.topOpen)}sync(e){for(let t=this.open;t>=0;t--)if(this.nodes[t]==e)return this.open=t,!0;return!1}get currentPos(){this.closeExtra();let e=0;for(let t=this.open;t>=0;t--){let s=this.nodes[t].content;for(let i=s.length-1;i>=0;i--)e+=s[i].nodeSize;t&&e++}return e}findAtPoint(e,t){if(this.find)for(let s=0;s<this.find.length;s++)this.find[s].node==e&&this.find[s].offset==t&&(this.find[s].pos=this.currentPos)}findInside(e){if(this.find)for(let t=0;t<this.find.length;t++)this.find[t].pos==null&&e.nodeType==1&&e.contains(this.find[t].node)&&(this.find[t].pos=this.currentPos)}findAround(e,t,s){if(e!=t&&this.find)for(let i=0;i<this.find.length;i++)this.find[i].pos==null&&e.nodeType==1&&e.contains(this.find[i].node)&&t.compareDocumentPosition(this.find[i].node)&(s?2:4)&&(this.find[i].pos=this.currentPos)}findInText(e){if(this.find)for(let t=0;t<this.find.length;t++)this.find[t].node==e&&(this.find[t].pos=this.currentPos-(e.nodeValue.length-this.find[t].offset))}matchesContext(e){if(e.indexOf("|")>-1)return e.split(/\s*\|\s*/).some(this.matchesContext,this);let t=e.split("/"),s=this.options.context,i=!this.isOpen&&(!s||s.parent.type==this.nodes[0].type),r=-(s?s.depth+1:0)+(i?0:1),o=(a,l)=>{for(;a>=0;a--){let d=t[a];if(d==""){if(a==t.length-1||a==0)continue;for(;l>=r;l--)if(o(a-1,l))return!0;return!1}else{let u=l>0||l==0&&i?this.nodes[l].type:s&&l>=r?s.node(l-r).type:null;if(!u||u.name!=d&&u.groups.indexOf(d)==-1)return!1;l--}}return!0};return o(t.length-1,this.open)}textblockFromContext(){let e=this.options.context;if(e)for(let t=e.depth;t>=0;t--){let s=e.node(t).contentMatchAt(e.indexAfter(t)).defaultType;if(s&&s.isTextblock&&s.defaultAttrs)return s}for(let t in this.parser.schema.nodes){let s=this.parser.schema.nodes[t];if(s.isTextblock&&s.defaultAttrs)return s}}addPendingMark(e){let t=rk(e,this.top.pendingMarks);t&&this.top.stashMarks.push(t),this.top.pendingMarks=e.addToSet(this.top.pendingMarks)}removePendingMark(e,t){for(let s=this.open;s>=0;s--){let i=this.nodes[s];if(i.pendingMarks.lastIndexOf(e)>-1)i.pendingMarks=e.removeFromSet(i.pendingMarks);else{i.activeMarks=e.removeFromSet(i.activeMarks);let o=i.popFromStashMark(e);o&&i.type&&i.type.allowsMarkType(o.type)&&(i.activeMarks=o.addToSet(i.activeMarks))}if(i==t)break}}}function nk(n){for(let e=n.firstChild,t=null;e;e=e.nextSibling){let s=e.nodeType==1?e.nodeName.toLowerCase():null;s&&Kf.hasOwnProperty(s)&&t?(t.appendChild(e),e=t):s=="li"?t=e:s&&(t=null)}}function sk(n,e){return(n.matches||n.msMatchesSelector||n.webkitMatchesSelector||n.mozMatchesSelector).call(n,e)}function vd(n){let e={};for(let t in n)e[t]=n[t];return e}function ik(n,e){let t=e.schema.nodes;for(let s in t){let i=t[s];if(!i.allowsMarkType(n))continue;let r=[],o=a=>{r.push(a);for(let l=0;l<a.edgeCount;l++){let{type:d,next:u}=a.edge(l);if(d==e||r.indexOf(u)<0&&o(u))return!0}};if(o(i.contentMatch))return!0}}function rk(n,e){for(let t=0;t<e.length;t++)if(n.eq(e[t]))return e[t]}class Vi{constructor(e,t){this.nodes=e,this.marks=t}serializeFragment(e,t={},s){s||(s=xa(t).createDocumentFragment());let i=s,r=[];return e.forEach(o=>{if(r.length||o.marks.length){let a=0,l=0;for(;a<r.length&&l<o.marks.length;){let d=o.marks[l];if(!this.marks[d.type.name]){l++;continue}if(!d.eq(r[a][0])||d.type.spec.spanning===!1)break;a++,l++}for(;a<r.length;)i=r.pop()[1];for(;l<o.marks.length;){let d=o.marks[l++],u=this.serializeMark(d,o.isInline,t);u&&(r.push([d,i]),i.appendChild(u.dom),i=u.contentDOM||u.dom)}}i.appendChild(this.serializeNodeInner(o,t))}),s}serializeNodeInner(e,t){let{dom:s,contentDOM:i}=to(xa(t),this.nodes[e.type.name](e),null,e.attrs);if(i){if(e.isLeaf)throw new RangeError("Content hole not allowed in a leaf node spec");this.serializeFragment(e.content,t,i)}return s}serializeNode(e,t={}){let s=this.serializeNodeInner(e,t);for(let i=e.marks.length-1;i>=0;i--){let r=this.serializeMark(e.marks[i],e.isInline,t);r&&((r.contentDOM||r.dom).appendChild(s),s=r.dom)}return s}serializeMark(e,t,s={}){let i=this.marks[e.type.name];return i&&to(xa(s),i(e,t),null,e.attrs)}static renderSpec(e,t,s=null,i){return to(e,t,s,i)}static fromSchema(e){return e.cached.domSerializer||(e.cached.domSerializer=new Vi(this.nodesFromSchema(e),this.marksFromSchema(e)))}static nodesFromSchema(e){let t=Td(e.nodes);return t.text||(t.text=s=>s.text),t}static marksFromSchema(e){return Td(e.marks)}}function Td(n){let e={};for(let t in n){let s=n[t].spec.toDOM;s&&(e[t]=s)}return e}function xa(n){return n.document||window.document}const Ed=new WeakMap;function ok(n){let e=Ed.get(n);return e===void 0&&Ed.set(n,e=ak(n)),e}function ak(n){let e=null;function t(s){if(s&&typeof s=="object")if(Array.isArray(s))if(typeof s[0]=="string")e||(e=[]),e.push(s);else for(let i=0;i<s.length;i++)t(s[i]);else for(let i in s)t(s[i])}return t(n),e}function to(n,e,t,s){if(typeof e=="string")return{dom:n.createTextNode(e)};if(e.nodeType!=null)return{dom:e};if(e.dom&&e.dom.nodeType!=null)return e;let i=e[0],r;if(typeof i!="string")throw new RangeError("Invalid array passed to renderSpec");if(s&&(r=ok(s))&&r.indexOf(e)>-1)throw new RangeError("Using an array from an attribute object as a DOM spec. This may be an attempted cross site scripting attack.");let o=i.indexOf(" ");o>0&&(t=i.slice(0,o),i=i.slice(o+1));let a,l=t?n.createElementNS(t,i):n.createElement(i),d=e[1],u=1;if(d&&typeof d=="object"&&d.nodeType==null&&!Array.isArray(d)){u=2;for(let p in d)if(d[p]!=null){let m=p.indexOf(" ");m>0?l.setAttributeNS(p.slice(0,m),p.slice(m+1),d[p]):l.setAttribute(p,d[p])}}for(let p=u;p<e.length;p++){let m=e[p];if(m===0){if(p<e.length-1||p>u)throw new RangeError("Content hole must be the only child of its parent node");return{dom:l,contentDOM:l}}else{let{dom:b,contentDOM:g}=to(n,m,t,s);if(l.appendChild(b),g){if(a)throw new RangeError("Multiple content holes");a=g}}}return{dom:l,contentDOM:a}}const Jf=65535,Yf=Math.pow(2,16);function lk(n,e){return n+e*Yf}function _d(n){return n&Jf}function ck(n){return(n-(n&Jf))/Yf}const Qf=1,Xf=2,no=4,Zf=8;class tl{constructor(e,t,s){this.pos=e,this.delInfo=t,this.recover=s}get deleted(){return(this.delInfo&Zf)>0}get deletedBefore(){return(this.delInfo&(Qf|no))>0}get deletedAfter(){return(this.delInfo&(Xf|no))>0}get deletedAcross(){return(this.delInfo&no)>0}}class $t{constructor(e,t=!1){if(this.ranges=e,this.inverted=t,!e.length&&$t.empty)return $t.empty}recover(e){let t=0,s=_d(e);if(!this.inverted)for(let i=0;i<s;i++)t+=this.ranges[i*3+2]-this.ranges[i*3+1];return this.ranges[s*3]+t+ck(e)}mapResult(e,t=1){return this._map(e,t,!1)}map(e,t=1){return this._map(e,t,!0)}_map(e,t,s){let i=0,r=this.inverted?2:1,o=this.inverted?1:2;for(let a=0;a<this.ranges.length;a+=3){let l=this.ranges[a]-(this.inverted?i:0);if(l>e)break;let d=this.ranges[a+r],u=this.ranges[a+o],p=l+d;if(e<=p){let m=d?e==l?-1:e==p?1:t:t,b=l+i+(m<0?0:u);if(s)return b;let g=e==(t<0?l:p)?null:lk(a/3,e-l),x=e==l?Xf:e==p?Qf:no;return(t<0?e!=l:e!=p)&&(x|=Zf),new tl(b,x,g)}i+=u-d}return s?e+i:new tl(e+i,0,null)}touches(e,t){let s=0,i=_d(t),r=this.inverted?2:1,o=this.inverted?1:2;for(let a=0;a<this.ranges.length;a+=3){let l=this.ranges[a]-(this.inverted?s:0);if(l>e)break;let d=this.ranges[a+r],u=l+d;if(e<=u&&a==i*3)return!0;s+=this.ranges[a+o]-d}return!1}forEach(e){let t=this.inverted?2:1,s=this.inverted?1:2;for(let i=0,r=0;i<this.ranges.length;i+=3){let o=this.ranges[i],a=o-(this.inverted?r:0),l=o+(this.inverted?0:r),d=this.ranges[i+t],u=this.ranges[i+s];e(a,a+d,l,l+u),r+=u-d}}invert(){return new $t(this.ranges,!this.inverted)}toString(){return(this.inverted?"-":"")+JSON.stringify(this.ranges)}static offset(e){return e==0?$t.empty:new $t(e<0?[0,-e,0]:[0,0,e])}}$t.empty=new $t([]);class ki{constructor(e=[],t,s=0,i=e.length){this.maps=e,this.mirror=t,this.from=s,this.to=i}slice(e=0,t=this.maps.length){return new ki(this.maps,this.mirror,e,t)}copy(){return new ki(this.maps.slice(),this.mirror&&this.mirror.slice(),this.from,this.to)}appendMap(e,t){this.to=this.maps.push(e),t!=null&&this.setMirror(this.maps.length-1,t)}appendMapping(e){for(let t=0,s=this.maps.length;t<e.maps.length;t++){let i=e.getMirror(t);this.appendMap(e.maps[t],i!=null&&i<t?s+i:void 0)}}getMirror(e){if(this.mirror){for(let t=0;t<this.mirror.length;t++)if(this.mirror[t]==e)return this.mirror[t+(t%2?-1:1)]}}setMirror(e,t){this.mirror||(this.mirror=[]),this.mirror.push(e,t)}appendMappingInverted(e){for(let t=e.maps.length-1,s=this.maps.length+e.maps.length;t>=0;t--){let i=e.getMirror(t);this.appendMap(e.maps[t].invert(),i!=null&&i>t?s-i-1:void 0)}}invert(){let e=new ki;return e.appendMappingInverted(this),e}map(e,t=1){if(this.mirror)return this._map(e,t,!0);for(let s=this.from;s<this.to;s++)e=this.maps[s].map(e,t);return e}mapResult(e,t=1){return this._map(e,t,!1)}_map(e,t,s){let i=0;for(let r=this.from;r<this.to;r++){let o=this.maps[r],a=o.mapResult(e,t);if(a.recover!=null){let l=this.getMirror(r);if(l!=null&&l>r&&l<this.to){r=l,e=this.maps[l].recover(a.recover);continue}}i|=a.delInfo,e=a.pos}return s?e:new tl(e,i,null)}}const ba=Object.create(null);class At{getMap(){return $t.empty}merge(e){return null}static fromJSON(e,t){if(!t||!t.stepType)throw new RangeError("Invalid input for Step.fromJSON");let s=ba[t.stepType];if(!s)throw new RangeError(`No step type ${t.stepType} defined`);return s.fromJSON(e,t)}static jsonID(e,t){if(e in ba)throw new RangeError("Duplicate use of step JSON ID "+e);return ba[e]=t,t.prototype.jsonID=e,t}}class ht{constructor(e,t){this.doc=e,this.failed=t}static ok(e){return new ht(e,null)}static fail(e){return new ht(null,e)}static fromReplace(e,t,s,i){try{return ht.ok(e.replace(t,s,i))}catch(r){if(r instanceof _o)return ht.fail(r.message);throw r}}}function fc(n,e,t){let s=[];for(let i=0;i<n.childCount;i++){let r=n.child(i);r.content.size&&(r=r.copy(fc(r.content,e,r))),r.isInline&&(r=e(r,t,i)),s.push(r)}return H.fromArray(s)}class ys extends At{constructor(e,t,s){super(),this.from=e,this.to=t,this.mark=s}apply(e){let t=e.slice(this.from,this.to),s=e.resolve(this.from),i=s.node(s.sharedDepth(this.to)),r=new Q(fc(t.content,(o,a)=>!o.isAtom||!a.type.allowsMarkType(this.mark.type)?o:o.mark(this.mark.addToSet(o.marks)),i),t.openStart,t.openEnd);return ht.fromReplace(e,this.from,this.to,r)}invert(){return new jn(this.from,this.to,this.mark)}map(e){let t=e.mapResult(this.from,1),s=e.mapResult(this.to,-1);return t.deleted&&s.deleted||t.pos>=s.pos?null:new ys(t.pos,s.pos,this.mark)}merge(e){return e instanceof ys&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from?new ys(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark):null}toJSON(){return{stepType:"addMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for AddMarkStep.fromJSON");return new ys(t.from,t.to,e.markFromJSON(t.mark))}}At.jsonID("addMark",ys);class jn extends At{constructor(e,t,s){super(),this.from=e,this.to=t,this.mark=s}apply(e){let t=e.slice(this.from,this.to),s=new Q(fc(t.content,i=>i.mark(this.mark.removeFromSet(i.marks)),e),t.openStart,t.openEnd);return ht.fromReplace(e,this.from,this.to,s)}invert(){return new ys(this.from,this.to,this.mark)}map(e){let t=e.mapResult(this.from,1),s=e.mapResult(this.to,-1);return t.deleted&&s.deleted||t.pos>=s.pos?null:new jn(t.pos,s.pos,this.mark)}merge(e){return e instanceof jn&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from?new jn(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark):null}toJSON(){return{stepType:"removeMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for RemoveMarkStep.fromJSON");return new jn(t.from,t.to,e.markFromJSON(t.mark))}}At.jsonID("removeMark",jn);class xs extends At{constructor(e,t){super(),this.pos=e,this.mark=t}apply(e){let t=e.nodeAt(this.pos);if(!t)return ht.fail("No node at mark step's position");let s=t.type.create(t.attrs,null,this.mark.addToSet(t.marks));return ht.fromReplace(e,this.pos,this.pos+1,new Q(H.from(s),0,t.isLeaf?0:1))}invert(e){let t=e.nodeAt(this.pos);if(t){let s=this.mark.addToSet(t.marks);if(s.length==t.marks.length){for(let i=0;i<t.marks.length;i++)if(!t.marks[i].isInSet(s))return new xs(this.pos,t.marks[i]);return new xs(this.pos,this.mark)}}return new Di(this.pos,this.mark)}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new xs(t.pos,this.mark)}toJSON(){return{stepType:"addNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for AddNodeMarkStep.fromJSON");return new xs(t.pos,e.markFromJSON(t.mark))}}At.jsonID("addNodeMark",xs);class Di extends At{constructor(e,t){super(),this.pos=e,this.mark=t}apply(e){let t=e.nodeAt(this.pos);if(!t)return ht.fail("No node at mark step's position");let s=t.type.create(t.attrs,null,this.mark.removeFromSet(t.marks));return ht.fromReplace(e,this.pos,this.pos+1,new Q(H.from(s),0,t.isLeaf?0:1))}invert(e){let t=e.nodeAt(this.pos);return!t||!this.mark.isInSet(t.marks)?this:new xs(this.pos,this.mark)}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new Di(t.pos,this.mark)}toJSON(){return{stepType:"removeNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for RemoveNodeMarkStep.fromJSON");return new Di(t.pos,e.markFromJSON(t.mark))}}At.jsonID("removeNodeMark",Di);class Et extends At{constructor(e,t,s,i=!1){super(),this.from=e,this.to=t,this.slice=s,this.structure=i}apply(e){return this.structure&&nl(e,this.from,this.to)?ht.fail("Structure replace would overwrite content"):ht.fromReplace(e,this.from,this.to,this.slice)}getMap(){return new $t([this.from,this.to-this.from,this.slice.size])}invert(e){return new Et(this.from,this.from+this.slice.size,e.slice(this.from,this.to))}map(e){let t=e.mapResult(this.from,1),s=e.mapResult(this.to,-1);return t.deletedAcross&&s.deletedAcross?null:new Et(t.pos,Math.max(t.pos,s.pos),this.slice)}merge(e){if(!(e instanceof Et)||e.structure||this.structure)return null;if(this.from+this.slice.size==e.from&&!this.slice.openEnd&&!e.slice.openStart){let t=this.slice.size+e.slice.size==0?Q.empty:new Q(this.slice.content.append(e.slice.content),this.slice.openStart,e.slice.openEnd);return new Et(this.from,this.to+(e.to-e.from),t,this.structure)}else if(e.to==this.from&&!this.slice.openStart&&!e.slice.openEnd){let t=this.slice.size+e.slice.size==0?Q.empty:new Q(e.slice.content.append(this.slice.content),e.slice.openStart,this.slice.openEnd);return new Et(e.from,this.to,t,this.structure)}else return null}toJSON(){let e={stepType:"replace",from:this.from,to:this.to};return this.slice.size&&(e.slice=this.slice.toJSON()),this.structure&&(e.structure=!0),e}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for ReplaceStep.fromJSON");return new Et(t.from,t.to,Q.fromJSON(e,t.slice),!!t.structure)}}At.jsonID("replace",Et);class Jt extends At{constructor(e,t,s,i,r,o,a=!1){super(),this.from=e,this.to=t,this.gapFrom=s,this.gapTo=i,this.slice=r,this.insert=o,this.structure=a}apply(e){if(this.structure&&(nl(e,this.from,this.gapFrom)||nl(e,this.gapTo,this.to)))return ht.fail("Structure gap-replace would overwrite content");let t=e.slice(this.gapFrom,this.gapTo);if(t.openStart||t.openEnd)return ht.fail("Gap is not a flat range");let s=this.slice.insertAt(this.insert,t.content);return s?ht.fromReplace(e,this.from,this.to,s):ht.fail("Content does not fit in gap")}getMap(){return new $t([this.from,this.gapFrom-this.from,this.insert,this.gapTo,this.to-this.gapTo,this.slice.size-this.insert])}invert(e){let t=this.gapTo-this.gapFrom;return new Jt(this.from,this.from+this.slice.size+t,this.from+this.insert,this.from+this.insert+t,e.slice(this.from,this.to).removeBetween(this.gapFrom-this.from,this.gapTo-this.from),this.gapFrom-this.from,this.structure)}map(e){let t=e.mapResult(this.from,1),s=e.mapResult(this.to,-1),i=this.from==this.gapFrom?t.pos:e.map(this.gapFrom,-1),r=this.to==this.gapTo?s.pos:e.map(this.gapTo,1);return t.deletedAcross&&s.deletedAcross||i<t.pos||r>s.pos?null:new Jt(t.pos,s.pos,i,r,this.slice,this.insert,this.structure)}toJSON(){let e={stepType:"replaceAround",from:this.from,to:this.to,gapFrom:this.gapFrom,gapTo:this.gapTo,insert:this.insert};return this.slice.size&&(e.slice=this.slice.toJSON()),this.structure&&(e.structure=!0),e}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number"||typeof t.gapFrom!="number"||typeof t.gapTo!="number"||typeof t.insert!="number")throw new RangeError("Invalid input for ReplaceAroundStep.fromJSON");return new Jt(t.from,t.to,t.gapFrom,t.gapTo,Q.fromJSON(e,t.slice),t.insert,!!t.structure)}}At.jsonID("replaceAround",Jt);function nl(n,e,t){let s=n.resolve(e),i=t-e,r=s.depth;for(;i>0&&r>0&&s.indexAfter(r)==s.node(r).childCount;)r--,i--;if(i>0){let o=s.node(r).maybeChild(s.indexAfter(r));for(;i>0;){if(!o||o.isLeaf)return!0;o=o.firstChild,i--}}return!1}function dk(n,e,t,s){let i=[],r=[],o,a;n.doc.nodesBetween(e,t,(l,d,u)=>{if(!l.isInline)return;let p=l.marks;if(!s.isInSet(p)&&u.type.allowsMarkType(s.type)){let m=Math.max(d,e),b=Math.min(d+l.nodeSize,t),g=s.addToSet(p);for(let x=0;x<p.length;x++)p[x].isInSet(g)||(o&&o.to==m&&o.mark.eq(p[x])?o.to=b:i.push(o=new jn(m,b,p[x])));a&&a.to==m?a.to=b:r.push(a=new ys(m,b,s))}}),i.forEach(l=>n.step(l)),r.forEach(l=>n.step(l))}function uk(n,e,t,s){let i=[],r=0;n.doc.nodesBetween(e,t,(o,a)=>{if(!o.isInline)return;r++;let l=null;if(s instanceof ea){let d=o.marks,u;for(;u=s.isInSet(d);)(l||(l=[])).push(u),d=u.removeFromSet(d)}else s?s.isInSet(o.marks)&&(l=[s]):l=o.marks;if(l&&l.length){let d=Math.min(a+o.nodeSize,t);for(let u=0;u<l.length;u++){let p=l[u],m;for(let b=0;b<i.length;b++){let g=i[b];g.step==r-1&&p.eq(i[b].style)&&(m=g)}m?(m.to=d,m.step=r):i.push({style:p,from:Math.max(a,e),to:d,step:r})}}}),i.forEach(o=>n.step(new jn(o.from,o.to,o.style)))}function ep(n,e,t,s=t.contentMatch,i=!0){let r=n.doc.nodeAt(e),o=[],a=e+1;for(let l=0;l<r.childCount;l++){let d=r.child(l),u=a+d.nodeSize,p=s.matchType(d.type);if(!p)o.push(new Et(a,u,Q.empty));else{s=p;for(let m=0;m<d.marks.length;m++)t.allowsMarkType(d.marks[m].type)||n.step(new jn(a,u,d.marks[m]));if(i&&d.isText&&t.whitespace!="pre"){let m,b=/\r?\n|\r/g,g;for(;m=b.exec(d.text);)g||(g=new Q(H.from(t.schema.text(" ",t.allowedMarks(d.marks))),0,0)),o.push(new Et(a+m.index,a+m.index+m[0].length,g))}}a=u}if(!s.validEnd){let l=s.fillBefore(H.empty,!0);n.replace(a,a,new Q(l,0,0))}for(let l=o.length-1;l>=0;l--)n.step(o[l])}function hk(n,e,t){return(e==0||n.canReplace(e,n.childCount))&&(t==n.childCount||n.canReplace(0,t))}function pc(n){let t=n.parent.content.cutByIndex(n.startIndex,n.endIndex);for(let s=n.depth;;--s){let i=n.$from.node(s),r=n.$from.index(s),o=n.$to.indexAfter(s);if(s<n.depth&&i.canReplace(r,o,t))return s;if(s==0||i.type.spec.isolating||!hk(i,r,o))break}return null}function fk(n,e,t){let{$from:s,$to:i,depth:r}=e,o=s.before(r+1),a=i.after(r+1),l=o,d=a,u=H.empty,p=0;for(let g=r,x=!1;g>t;g--)x||s.index(g)>0?(x=!0,u=H.from(s.node(g).copy(u)),p++):l--;let m=H.empty,b=0;for(let g=r,x=!1;g>t;g--)x||i.after(g+1)<i.end(g)?(x=!0,m=H.from(i.node(g).copy(m)),b++):d++;n.step(new Jt(l,d,o,a,new Q(u.append(m),p,b),u.size-p,!0))}function pk(n,e,t=null,s=n){let i=mk(n,e),r=i&&gk(s,e);return r?i.map(Nd).concat({type:e,attrs:t}).concat(r.map(Nd)):null}function Nd(n){return{type:n,attrs:null}}function mk(n,e){let{parent:t,startIndex:s,endIndex:i}=n,r=t.contentMatchAt(s).findWrapping(e);if(!r)return null;let o=r.length?r[0]:e;return t.canReplaceWith(s,i,o)?r:null}function gk(n,e){let{parent:t,startIndex:s,endIndex:i}=n,r=t.child(s),o=e.contentMatch.findWrapping(r.type);if(!o)return null;let l=(o.length?o[o.length-1]:e).contentMatch;for(let d=s;l&&d<i;d++)l=l.matchType(t.child(d).type);return!l||!l.validEnd?null:o}function yk(n,e,t){let s=H.empty;for(let o=t.length-1;o>=0;o--){if(s.size){let a=t[o].type.contentMatch.matchFragment(s);if(!a||!a.validEnd)throw new RangeError("Wrapper type given to Transform.wrap does not form valid content of its parent wrapper")}s=H.from(t[o].type.create(t[o].attrs,s))}let i=e.start,r=e.end;n.step(new Jt(i,r,i,r,new Q(s,0,0),t.length,!0))}function xk(n,e,t,s,i){if(!s.isTextblock)throw new RangeError("Type given to setBlockType should be a textblock");let r=n.steps.length;n.doc.nodesBetween(e,t,(o,a)=>{if(o.isTextblock&&!o.hasMarkup(s,i)&&wk(n.doc,n.mapping.slice(r).map(a),s)){let l=null;if(s.schema.linebreakReplacement){let m=s.whitespace=="pre",b=!!s.contentMatch.matchType(s.schema.linebreakReplacement);m&&!b?l=!1:!m&&b&&(l=!0)}l===!1&&Sk(n,o,a,r),ep(n,n.mapping.slice(r).map(a,1),s,void 0,l===null);let d=n.mapping.slice(r),u=d.map(a,1),p=d.map(a+o.nodeSize,1);return n.step(new Jt(u,p,u+1,p-1,new Q(H.from(s.create(i,null,o.marks)),0,0),1,!0)),l===!0&&bk(n,o,a,r),!1}})}function bk(n,e,t,s){e.forEach((i,r)=>{if(i.isText){let o,a=/\r?\n|\r/g;for(;o=a.exec(i.text);){let l=n.mapping.slice(s).map(t+1+r+o.index);n.replaceWith(l,l+1,e.type.schema.linebreakReplacement.create())}}})}function Sk(n,e,t,s){e.forEach((i,r)=>{if(i.type==i.type.schema.linebreakReplacement){let o=n.mapping.slice(s).map(t+1+r);n.replaceWith(o,o+1,e.type.schema.text(`
`))}})}function wk(n,e,t){let s=n.resolve(e),i=s.index();return s.parent.canReplaceWith(i,i+1,t)}function kk(n,e,t,s,i){let r=n.doc.nodeAt(e);if(!r)throw new RangeError("No node at given position");t||(t=r.type);let o=t.create(s,null,i||r.marks);if(r.isLeaf)return n.replaceWith(e,e+r.nodeSize,o);if(!t.validContent(r.content))throw new RangeError("Invalid content for node type "+t.name);n.step(new Jt(e,e+r.nodeSize,e+1,e+r.nodeSize-1,new Q(H.from(o),0,0),1,!0))}function so(n,e,t=1,s){let i=n.resolve(e),r=i.depth-t,o=s&&s[s.length-1]||i.parent;if(r<0||i.parent.type.spec.isolating||!i.parent.canReplace(i.index(),i.parent.childCount)||!o.type.validContent(i.parent.content.cutByIndex(i.index(),i.parent.childCount)))return!1;for(let d=i.depth-1,u=t-2;d>r;d--,u--){let p=i.node(d),m=i.index(d);if(p.type.spec.isolating)return!1;let b=p.content.cutByIndex(m,p.childCount),g=s&&s[u+1];g&&(b=b.replaceChild(0,g.type.create(g.attrs)));let x=s&&s[u]||p;if(!p.canReplace(m+1,p.childCount)||!x.type.validContent(b))return!1}let a=i.indexAfter(r),l=s&&s[0];return i.node(r).canReplaceWith(a,a,l?l.type:i.node(r+1).type)}function Ck(n,e,t=1,s){let i=n.doc.resolve(e),r=H.empty,o=H.empty;for(let a=i.depth,l=i.depth-t,d=t-1;a>l;a--,d--){r=H.from(i.node(a).copy(r));let u=s&&s[d];o=H.from(u?u.type.create(u.attrs,o):i.node(a).copy(o))}n.step(new Et(e,e,new Q(r.append(o),t,t),!0))}function tp(n,e){let t=n.resolve(e),s=t.index();return Mk(t.nodeBefore,t.nodeAfter)&&t.parent.canReplace(s,s+1)}function Mk(n,e){return!!(n&&e&&!n.isLeaf&&n.canAppend(e))}function vk(n,e,t){let s=new Et(e-t,e+t,Q.empty,!0);n.step(s)}function Tk(n,e,t){let s=n.resolve(e);if(s.parent.canReplaceWith(s.index(),s.index(),t))return e;if(s.parentOffset==0)for(let i=s.depth-1;i>=0;i--){let r=s.index(i);if(s.node(i).canReplaceWith(r,r,t))return s.before(i+1);if(r>0)return null}if(s.parentOffset==s.parent.content.size)for(let i=s.depth-1;i>=0;i--){let r=s.indexAfter(i);if(s.node(i).canReplaceWith(r,r,t))return s.after(i+1);if(r<s.node(i).childCount)return null}return null}function Ek(n,e,t){let s=n.resolve(e);if(!t.content.size)return e;let i=t.content;for(let r=0;r<t.openStart;r++)i=i.firstChild.content;for(let r=1;r<=(t.openStart==0&&t.size?2:1);r++)for(let o=s.depth;o>=0;o--){let a=o==s.depth?0:s.pos<=(s.start(o+1)+s.end(o+1))/2?-1:1,l=s.index(o)+(a>0?1:0),d=s.node(o),u=!1;if(r==1)u=d.canReplace(l,l,i);else{let p=d.contentMatchAt(l).findWrapping(i.firstChild.type);u=p&&d.canReplaceWith(l,l,p[0])}if(u)return a==0?s.pos:a<0?s.before(o+1):s.after(o+1)}return null}function mc(n,e,t=e,s=Q.empty){if(e==t&&!s.size)return null;let i=n.resolve(e),r=n.resolve(t);return np(i,r,s)?new Et(e,t,s):new _k(i,r,s).fit()}function np(n,e,t){return!t.openStart&&!t.openEnd&&n.start()==e.start()&&n.parent.canReplace(n.index(),e.index(),t.content)}class _k{constructor(e,t,s){this.$from=e,this.$to=t,this.unplaced=s,this.frontier=[],this.placed=H.empty;for(let i=0;i<=e.depth;i++){let r=e.node(i);this.frontier.push({type:r.type,match:r.contentMatchAt(e.indexAfter(i))})}for(let i=e.depth;i>0;i--)this.placed=H.from(e.node(i).copy(this.placed))}get depth(){return this.frontier.length-1}fit(){for(;this.unplaced.size;){let d=this.findFittable();d?this.placeNodes(d):this.openMore()||this.dropNode()}let e=this.mustMoveInline(),t=this.placed.size-this.depth-this.$from.depth,s=this.$from,i=this.close(e<0?this.$to:s.doc.resolve(e));if(!i)return null;let r=this.placed,o=s.depth,a=i.depth;for(;o&&a&&r.childCount==1;)r=r.firstChild.content,o--,a--;let l=new Q(r,o,a);return e>-1?new Jt(s.pos,e,this.$to.pos,this.$to.end(),l,t):l.size||s.pos!=this.$to.pos?new Et(s.pos,i.pos,l):null}findFittable(){let e=this.unplaced.openStart;for(let t=this.unplaced.content,s=0,i=this.unplaced.openEnd;s<e;s++){let r=t.firstChild;if(t.childCount>1&&(i=0),r.type.spec.isolating&&i<=s){e=s;break}t=r.content}for(let t=1;t<=2;t++)for(let s=t==1?e:this.unplaced.openStart;s>=0;s--){let i,r=null;s?(r=Sa(this.unplaced.content,s-1).firstChild,i=r.content):i=this.unplaced.content;let o=i.firstChild;for(let a=this.depth;a>=0;a--){let{type:l,match:d}=this.frontier[a],u,p=null;if(t==1&&(o?d.matchType(o.type)||(p=d.fillBefore(H.from(o),!1)):r&&l.compatibleContent(r.type)))return{sliceDepth:s,frontierDepth:a,parent:r,inject:p};if(t==2&&o&&(u=d.findWrapping(o.type)))return{sliceDepth:s,frontierDepth:a,parent:r,wrap:u};if(r&&d.matchType(r.type))break}}}openMore(){let{content:e,openStart:t,openEnd:s}=this.unplaced,i=Sa(e,t);return!i.childCount||i.firstChild.isLeaf?!1:(this.unplaced=new Q(e,t+1,Math.max(s,i.size+t>=e.size-s?t+1:0)),!0)}dropNode(){let{content:e,openStart:t,openEnd:s}=this.unplaced,i=Sa(e,t);if(i.childCount<=1&&t>0){let r=e.size-t<=t+i.size;this.unplaced=new Q(Qi(e,t-1,1),t-1,r?t-1:s)}else this.unplaced=new Q(Qi(e,t,1),t,s)}placeNodes({sliceDepth:e,frontierDepth:t,parent:s,inject:i,wrap:r}){for(;this.depth>t;)this.closeFrontierNode();if(r)for(let x=0;x<r.length;x++)this.openFrontierNode(r[x]);let o=this.unplaced,a=s?s.content:o.content,l=o.openStart-e,d=0,u=[],{match:p,type:m}=this.frontier[t];if(i){for(let x=0;x<i.childCount;x++)u.push(i.child(x));p=p.matchFragment(i)}let b=a.size+e-(o.content.size-o.openEnd);for(;d<a.childCount;){let x=a.child(d),k=p.matchType(x.type);if(!k)break;d++,(d>1||l==0||x.content.size)&&(p=k,u.push(sp(x.mark(m.allowedMarks(x.marks)),d==1?l:0,d==a.childCount?b:-1)))}let g=d==a.childCount;g||(b=-1),this.placed=Xi(this.placed,t,H.from(u)),this.frontier[t].match=p,g&&b<0&&s&&s.type==this.frontier[this.depth].type&&this.frontier.length>1&&this.closeFrontierNode();for(let x=0,k=a;x<b;x++){let M=k.lastChild;this.frontier.push({type:M.type,match:M.contentMatchAt(M.childCount)}),k=M.content}this.unplaced=g?e==0?Q.empty:new Q(Qi(o.content,e-1,1),e-1,b<0?o.openEnd:e-1):new Q(Qi(o.content,e,d),o.openStart,o.openEnd)}mustMoveInline(){if(!this.$to.parent.isTextblock)return-1;let e=this.frontier[this.depth],t;if(!e.type.isTextblock||!wa(this.$to,this.$to.depth,e.type,e.match,!1)||this.$to.depth==this.depth&&(t=this.findCloseLevel(this.$to))&&t.depth==this.depth)return-1;let{depth:s}=this.$to,i=this.$to.after(s);for(;s>1&&i==this.$to.end(--s);)++i;return i}findCloseLevel(e){e:for(let t=Math.min(this.depth,e.depth);t>=0;t--){let{match:s,type:i}=this.frontier[t],r=t<e.depth&&e.end(t+1)==e.pos+(e.depth-(t+1)),o=wa(e,t,i,s,r);if(o){for(let a=t-1;a>=0;a--){let{match:l,type:d}=this.frontier[a],u=wa(e,a,d,l,!0);if(!u||u.childCount)continue e}return{depth:t,fit:o,move:r?e.doc.resolve(e.after(t+1)):e}}}}close(e){let t=this.findCloseLevel(e);if(!t)return null;for(;this.depth>t.depth;)this.closeFrontierNode();t.fit.childCount&&(this.placed=Xi(this.placed,t.depth,t.fit)),e=t.move;for(let s=t.depth+1;s<=e.depth;s++){let i=e.node(s),r=i.type.contentMatch.fillBefore(i.content,!0,e.index(s));this.openFrontierNode(i.type,i.attrs,r)}return e}openFrontierNode(e,t=null,s){let i=this.frontier[this.depth];i.match=i.match.matchType(e),this.placed=Xi(this.placed,this.depth,H.from(e.create(t,s))),this.frontier.push({type:e,match:e.contentMatch})}closeFrontierNode(){let t=this.frontier.pop().match.fillBefore(H.empty,!0);t.childCount&&(this.placed=Xi(this.placed,this.frontier.length,t))}}function Qi(n,e,t){return e==0?n.cutByIndex(t,n.childCount):n.replaceChild(0,n.firstChild.copy(Qi(n.firstChild.content,e-1,t)))}function Xi(n,e,t){return e==0?n.append(t):n.replaceChild(n.childCount-1,n.lastChild.copy(Xi(n.lastChild.content,e-1,t)))}function Sa(n,e){for(let t=0;t<e;t++)n=n.firstChild.content;return n}function sp(n,e,t){if(e<=0)return n;let s=n.content;return e>1&&(s=s.replaceChild(0,sp(s.firstChild,e-1,s.childCount==1?t-1:0))),e>0&&(s=n.type.contentMatch.fillBefore(s).append(s),t<=0&&(s=s.append(n.type.contentMatch.matchFragment(s).fillBefore(H.empty,!0)))),n.copy(s)}function wa(n,e,t,s,i){let r=n.node(e),o=i?n.indexAfter(e):n.index(e);if(o==r.childCount&&!t.compatibleContent(r.type))return null;let a=s.fillBefore(r.content,!0,o);return a&&!Nk(t,r.content,o)?a:null}function Nk(n,e,t){for(let s=t;s<e.childCount;s++)if(!n.allowsMarks(e.child(s).marks))return!0;return!1}function Ik(n){return n.spec.defining||n.spec.definingForContent}function Ak(n,e,t,s){if(!s.size)return n.deleteRange(e,t);let i=n.doc.resolve(e),r=n.doc.resolve(t);if(np(i,r,s))return n.step(new Et(e,t,s));let o=rp(i,n.doc.resolve(t));o[o.length-1]==0&&o.pop();let a=-(i.depth+1);o.unshift(a);for(let m=i.depth,b=i.pos-1;m>0;m--,b--){let g=i.node(m).type.spec;if(g.defining||g.definingAsContext||g.isolating)break;o.indexOf(m)>-1?a=m:i.before(m)==b&&o.splice(1,0,-m)}let l=o.indexOf(a),d=[],u=s.openStart;for(let m=s.content,b=0;;b++){let g=m.firstChild;if(d.push(g),b==s.openStart)break;m=g.content}for(let m=u-1;m>=0;m--){let b=d[m],g=Ik(b.type);if(g&&!b.sameMarkup(i.node(Math.abs(a)-1)))u=m;else if(g||!b.type.isTextblock)break}for(let m=s.openStart;m>=0;m--){let b=(m+u+1)%(s.openStart+1),g=d[b];if(g)for(let x=0;x<o.length;x++){let k=o[(x+l)%o.length],M=!0;k<0&&(M=!1,k=-k);let N=i.node(k-1),A=i.index(k-1);if(N.canReplaceWith(A,A,g.type,g.marks))return n.replace(i.before(k),M?r.after(k):t,new Q(ip(s.content,0,s.openStart,b),b,s.openEnd))}}let p=n.steps.length;for(let m=o.length-1;m>=0&&(n.replace(e,t,s),!(n.steps.length>p));m--){let b=o[m];b<0||(e=i.before(b),t=r.after(b))}}function ip(n,e,t,s,i){if(e<t){let r=n.firstChild;n=n.replaceChild(0,r.copy(ip(r.content,e+1,t,s,r)))}if(e>s){let r=i.contentMatchAt(0),o=r.fillBefore(n).append(n);n=o.append(r.matchFragment(o).fillBefore(H.empty,!0))}return n}function Rk(n,e,t,s){if(!s.isInline&&e==t&&n.doc.resolve(e).parent.content.size){let i=Tk(n.doc,e,s.type);i!=null&&(e=t=i)}n.replaceRange(e,t,new Q(H.from(s),0,0))}function Dk(n,e,t){let s=n.doc.resolve(e),i=n.doc.resolve(t),r=rp(s,i);for(let o=0;o<r.length;o++){let a=r[o],l=o==r.length-1;if(l&&a==0||s.node(a).type.contentMatch.validEnd)return n.delete(s.start(a),i.end(a));if(a>0&&(l||s.node(a-1).canReplace(s.index(a-1),i.indexAfter(a-1))))return n.delete(s.before(a),i.after(a))}for(let o=1;o<=s.depth&&o<=i.depth;o++)if(e-s.start(o)==s.depth-o&&t>s.end(o)&&i.end(o)-t!=i.depth-o)return n.delete(s.before(o),t);n.delete(e,t)}function rp(n,e){let t=[],s=Math.min(n.depth,e.depth);for(let i=s;i>=0;i--){let r=n.start(i);if(r<n.pos-(n.depth-i)||e.end(i)>e.pos+(e.depth-i)||n.node(i).type.spec.isolating||e.node(i).type.spec.isolating)break;(r==e.start(i)||i==n.depth&&i==e.depth&&n.parent.inlineContent&&e.parent.inlineContent&&i&&e.start(i-1)==r-1)&&t.push(i)}return t}class Ci extends At{constructor(e,t,s){super(),this.pos=e,this.attr=t,this.value=s}apply(e){let t=e.nodeAt(this.pos);if(!t)return ht.fail("No node at attribute step's position");let s=Object.create(null);for(let r in t.attrs)s[r]=t.attrs[r];s[this.attr]=this.value;let i=t.type.create(s,null,t.marks);return ht.fromReplace(e,this.pos,this.pos+1,new Q(H.from(i),0,t.isLeaf?0:1))}getMap(){return $t.empty}invert(e){return new Ci(this.pos,this.attr,e.nodeAt(this.pos).attrs[this.attr])}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new Ci(t.pos,this.attr,this.value)}toJSON(){return{stepType:"attr",pos:this.pos,attr:this.attr,value:this.value}}static fromJSON(e,t){if(typeof t.pos!="number"||typeof t.attr!="string")throw new RangeError("Invalid input for AttrStep.fromJSON");return new Ci(t.pos,t.attr,t.value)}}At.jsonID("attr",Ci);class br extends At{constructor(e,t){super(),this.attr=e,this.value=t}apply(e){let t=Object.create(null);for(let i in e.attrs)t[i]=e.attrs[i];t[this.attr]=this.value;let s=e.type.create(t,e.content,e.marks);return ht.ok(s)}getMap(){return $t.empty}invert(e){return new br(this.attr,e.attrs[this.attr])}map(e){return this}toJSON(){return{stepType:"docAttr",attr:this.attr,value:this.value}}static fromJSON(e,t){if(typeof t.attr!="string")throw new RangeError("Invalid input for DocAttrStep.fromJSON");return new br(t.attr,t.value)}}At.jsonID("docAttr",br);let ji=class extends Error{};ji=function n(e){let t=Error.call(this,e);return t.__proto__=n.prototype,t};ji.prototype=Object.create(Error.prototype);ji.prototype.constructor=ji;ji.prototype.name="TransformError";class jk{constructor(e){this.doc=e,this.steps=[],this.docs=[],this.mapping=new ki}get before(){return this.docs.length?this.docs[0]:this.doc}step(e){let t=this.maybeStep(e);if(t.failed)throw new ji(t.failed);return this}maybeStep(e){let t=e.apply(this.doc);return t.failed||this.addStep(e,t.doc),t}get docChanged(){return this.steps.length>0}addStep(e,t){this.docs.push(this.doc),this.steps.push(e),this.mapping.appendMap(e.getMap()),this.doc=t}replace(e,t=e,s=Q.empty){let i=mc(this.doc,e,t,s);return i&&this.step(i),this}replaceWith(e,t,s){return this.replace(e,t,new Q(H.from(s),0,0))}delete(e,t){return this.replace(e,t,Q.empty)}insert(e,t){return this.replaceWith(e,e,t)}replaceRange(e,t,s){return Ak(this,e,t,s),this}replaceRangeWith(e,t,s){return Rk(this,e,t,s),this}deleteRange(e,t){return Dk(this,e,t),this}lift(e,t){return fk(this,e,t),this}join(e,t=1){return vk(this,e,t),this}wrap(e,t){return yk(this,e,t),this}setBlockType(e,t=e,s,i=null){return xk(this,e,t,s,i),this}setNodeMarkup(e,t,s=null,i){return kk(this,e,t,s,i),this}setNodeAttribute(e,t,s){return this.step(new Ci(e,t,s)),this}setDocAttribute(e,t){return this.step(new br(e,t)),this}addNodeMark(e,t){return this.step(new xs(e,t)),this}removeNodeMark(e,t){if(!(t instanceof Pe)){let s=this.doc.nodeAt(e);if(!s)throw new RangeError("No node at position "+e);if(t=t.isInSet(s.marks),!t)return this}return this.step(new Di(e,t)),this}split(e,t=1,s){return Ck(this,e,t,s),this}addMark(e,t,s){return dk(this,e,t,s),this}removeMark(e,t,s){return uk(this,e,t,s),this}clearIncompatible(e,t,s){return ep(this,e,t,s),this}}const ka=Object.create(null);class Ne{constructor(e,t,s){this.$anchor=e,this.$head=t,this.ranges=s||[new Ok(e.min(t),e.max(t))]}get anchor(){return this.$anchor.pos}get head(){return this.$head.pos}get from(){return this.$from.pos}get to(){return this.$to.pos}get $from(){return this.ranges[0].$from}get $to(){return this.ranges[0].$to}get empty(){let e=this.ranges;for(let t=0;t<e.length;t++)if(e[t].$from.pos!=e[t].$to.pos)return!1;return!0}content(){return this.$from.doc.slice(this.from,this.to,!0)}replace(e,t=Q.empty){let s=t.content.lastChild,i=null;for(let a=0;a<t.openEnd;a++)i=s,s=s.lastChild;let r=e.steps.length,o=this.ranges;for(let a=0;a<o.length;a++){let{$from:l,$to:d}=o[a],u=e.mapping.slice(r);e.replaceRange(u.map(l.pos),u.map(d.pos),a?Q.empty:t),a==0&&Rd(e,r,(s?s.isInline:i&&i.isTextblock)?-1:1)}}replaceWith(e,t){let s=e.steps.length,i=this.ranges;for(let r=0;r<i.length;r++){let{$from:o,$to:a}=i[r],l=e.mapping.slice(s),d=l.map(o.pos),u=l.map(a.pos);r?e.deleteRange(d,u):(e.replaceRangeWith(d,u,t),Rd(e,s,t.isInline?-1:1))}}static findFrom(e,t,s=!1){let i=e.parent.inlineContent?new Fe(e):bi(e.node(0),e.parent,e.pos,e.index(),t,s);if(i)return i;for(let r=e.depth-1;r>=0;r--){let o=t<0?bi(e.node(0),e.node(r),e.before(r+1),e.index(r),t,s):bi(e.node(0),e.node(r),e.after(r+1),e.index(r)+1,t,s);if(o)return o}return null}static near(e,t=1){return this.findFrom(e,t)||this.findFrom(e,-t)||new Yt(e.node(0))}static atStart(e){return bi(e,e,0,0,1)||new Yt(e)}static atEnd(e){return bi(e,e,e.content.size,e.childCount,-1)||new Yt(e)}static fromJSON(e,t){if(!t||!t.type)throw new RangeError("Invalid input for Selection.fromJSON");let s=ka[t.type];if(!s)throw new RangeError(`No selection type ${t.type} defined`);return s.fromJSON(e,t)}static jsonID(e,t){if(e in ka)throw new RangeError("Duplicate use of selection JSON ID "+e);return ka[e]=t,t.prototype.jsonID=e,t}getBookmark(){return Fe.between(this.$anchor,this.$head).getBookmark()}}Ne.prototype.visible=!0;class Ok{constructor(e,t){this.$from=e,this.$to=t}}let Id=!1;function Ad(n){!Id&&!n.parent.inlineContent&&(Id=!0,console.warn("TextSelection endpoint not pointing into a node with inline content ("+n.parent.type.name+")"))}class Fe extends Ne{constructor(e,t=e){Ad(e),Ad(t),super(e,t)}get $cursor(){return this.$anchor.pos==this.$head.pos?this.$head:null}map(e,t){let s=e.resolve(t.map(this.head));if(!s.parent.inlineContent)return Ne.near(s);let i=e.resolve(t.map(this.anchor));return new Fe(i.parent.inlineContent?i:s,s)}replace(e,t=Q.empty){if(super.replace(e,t),t==Q.empty){let s=this.$from.marksAcross(this.$to);s&&e.ensureMarks(s)}}eq(e){return e instanceof Fe&&e.anchor==this.anchor&&e.head==this.head}getBookmark(){return new ta(this.anchor,this.head)}toJSON(){return{type:"text",anchor:this.anchor,head:this.head}}static fromJSON(e,t){if(typeof t.anchor!="number"||typeof t.head!="number")throw new RangeError("Invalid input for TextSelection.fromJSON");return new Fe(e.resolve(t.anchor),e.resolve(t.head))}static create(e,t,s=t){let i=e.resolve(t);return new this(i,s==t?i:e.resolve(s))}static between(e,t,s){let i=e.pos-t.pos;if((!s||i)&&(s=i>=0?1:-1),!t.parent.inlineContent){let r=Ne.findFrom(t,s,!0)||Ne.findFrom(t,-s,!0);if(r)t=r.$head;else return Ne.near(t,s)}return e.parent.inlineContent||(i==0?e=t:(e=(Ne.findFrom(e,-s,!0)||Ne.findFrom(e,s,!0)).$anchor,e.pos<t.pos!=i<0&&(e=t))),new Fe(e,t)}}Ne.jsonID("text",Fe);class ta{constructor(e,t){this.anchor=e,this.head=t}map(e){return new ta(e.map(this.anchor),e.map(this.head))}resolve(e){return Fe.between(e.resolve(this.anchor),e.resolve(this.head))}}class ue extends Ne{constructor(e){let t=e.nodeAfter,s=e.node(0).resolve(e.pos+t.nodeSize);super(e,s),this.node=t}map(e,t){let{deleted:s,pos:i}=t.mapResult(this.anchor),r=e.resolve(i);return s?Ne.near(r):new ue(r)}content(){return new Q(H.from(this.node),0,0)}eq(e){return e instanceof ue&&e.anchor==this.anchor}toJSON(){return{type:"node",anchor:this.anchor}}getBookmark(){return new gc(this.anchor)}static fromJSON(e,t){if(typeof t.anchor!="number")throw new RangeError("Invalid input for NodeSelection.fromJSON");return new ue(e.resolve(t.anchor))}static create(e,t){return new ue(e.resolve(t))}static isSelectable(e){return!e.isText&&e.type.spec.selectable!==!1}}ue.prototype.visible=!1;Ne.jsonID("node",ue);class gc{constructor(e){this.anchor=e}map(e){let{deleted:t,pos:s}=e.mapResult(this.anchor);return t?new ta(s,s):new gc(s)}resolve(e){let t=e.resolve(this.anchor),s=t.nodeAfter;return s&&ue.isSelectable(s)?new ue(t):Ne.near(t)}}class Yt extends Ne{constructor(e){super(e.resolve(0),e.resolve(e.content.size))}replace(e,t=Q.empty){if(t==Q.empty){e.delete(0,e.doc.content.size);let s=Ne.atStart(e.doc);s.eq(e.selection)||e.setSelection(s)}else super.replace(e,t)}toJSON(){return{type:"all"}}static fromJSON(e){return new Yt(e)}map(e){return new Yt(e)}eq(e){return e instanceof Yt}getBookmark(){return Pk}}Ne.jsonID("all",Yt);const Pk={map(){return this},resolve(n){return new Yt(n)}};function bi(n,e,t,s,i,r=!1){if(e.inlineContent)return Fe.create(n,t);for(let o=s-(i>0?0:1);i>0?o<e.childCount:o>=0;o+=i){let a=e.child(o);if(a.isAtom){if(!r&&ue.isSelectable(a))return ue.create(n,t-(i<0?a.nodeSize:0))}else{let l=bi(n,a,t+i,i<0?a.childCount:0,i,r);if(l)return l}t+=a.nodeSize*i}return null}function Rd(n,e,t){let s=n.steps.length-1;if(s<e)return;let i=n.steps[s];if(!(i instanceof Et||i instanceof Jt))return;let r=n.mapping.maps[s],o;r.forEach((a,l,d,u)=>{o==null&&(o=u)}),n.setSelection(Ne.near(n.doc.resolve(o),t))}const Dd=1,qr=2,jd=4;class Fk extends jk{constructor(e){super(e.doc),this.curSelectionFor=0,this.updated=0,this.meta=Object.create(null),this.time=Date.now(),this.curSelection=e.selection,this.storedMarks=e.storedMarks}get selection(){return this.curSelectionFor<this.steps.length&&(this.curSelection=this.curSelection.map(this.doc,this.mapping.slice(this.curSelectionFor)),this.curSelectionFor=this.steps.length),this.curSelection}setSelection(e){if(e.$from.doc!=this.doc)throw new RangeError("Selection passed to setSelection must point at the current document");return this.curSelection=e,this.curSelectionFor=this.steps.length,this.updated=(this.updated|Dd)&~qr,this.storedMarks=null,this}get selectionSet(){return(this.updated&Dd)>0}setStoredMarks(e){return this.storedMarks=e,this.updated|=qr,this}ensureMarks(e){return Pe.sameSet(this.storedMarks||this.selection.$from.marks(),e)||this.setStoredMarks(e),this}addStoredMark(e){return this.ensureMarks(e.addToSet(this.storedMarks||this.selection.$head.marks()))}removeStoredMark(e){return this.ensureMarks(e.removeFromSet(this.storedMarks||this.selection.$head.marks()))}get storedMarksSet(){return(this.updated&qr)>0}addStep(e,t){super.addStep(e,t),this.updated=this.updated&~qr,this.storedMarks=null}setTime(e){return this.time=e,this}replaceSelection(e){return this.selection.replace(this,e),this}replaceSelectionWith(e,t=!0){let s=this.selection;return t&&(e=e.mark(this.storedMarks||(s.empty?s.$from.marks():s.$from.marksAcross(s.$to)||Pe.none))),s.replaceWith(this,e),this}deleteSelection(){return this.selection.replace(this),this}insertText(e,t,s){let i=this.doc.type.schema;if(t==null)return e?this.replaceSelectionWith(i.text(e),!0):this.deleteSelection();{if(s==null&&(s=t),s=s??t,!e)return this.deleteRange(t,s);let r=this.storedMarks;if(!r){let o=this.doc.resolve(t);r=s==t?o.marks():o.marksAcross(this.doc.resolve(s))}return this.replaceRangeWith(t,s,i.text(e,r)),this.selection.empty||this.setSelection(Ne.near(this.selection.$to)),this}}setMeta(e,t){return this.meta[typeof e=="string"?e:e.key]=t,this}getMeta(e){return this.meta[typeof e=="string"?e:e.key]}get isGeneric(){for(let e in this.meta)return!1;return!0}scrollIntoView(){return this.updated|=jd,this}get scrolledIntoView(){return(this.updated&jd)>0}}function Od(n,e){return!e||!n?n:n.bind(e)}class Zi{constructor(e,t,s){this.name=e,this.init=Od(t.init,s),this.apply=Od(t.apply,s)}}const Bk=[new Zi("doc",{init(n){return n.doc||n.schema.topNodeType.createAndFill()},apply(n){return n.doc}}),new Zi("selection",{init(n,e){return n.selection||Ne.atStart(e.doc)},apply(n){return n.selection}}),new Zi("storedMarks",{init(n){return n.storedMarks||null},apply(n,e,t,s){return s.selection.$cursor?n.storedMarks:null}}),new Zi("scrollToSelection",{init(){return 0},apply(n,e){return n.scrolledIntoView?e+1:e}})];class Ca{constructor(e,t){this.schema=e,this.plugins=[],this.pluginsByKey=Object.create(null),this.fields=Bk.slice(),t&&t.forEach(s=>{if(this.pluginsByKey[s.key])throw new RangeError("Adding different instances of a keyed plugin ("+s.key+")");this.plugins.push(s),this.pluginsByKey[s.key]=s,s.spec.state&&this.fields.push(new Zi(s.key,s.spec.state,s))})}}class wi{constructor(e){this.config=e}get schema(){return this.config.schema}get plugins(){return this.config.plugins}apply(e){return this.applyTransaction(e).state}filterTransaction(e,t=-1){for(let s=0;s<this.config.plugins.length;s++)if(s!=t){let i=this.config.plugins[s];if(i.spec.filterTransaction&&!i.spec.filterTransaction.call(i,e,this))return!1}return!0}applyTransaction(e){if(!this.filterTransaction(e))return{state:this,transactions:[]};let t=[e],s=this.applyInner(e),i=null;for(;;){let r=!1;for(let o=0;o<this.config.plugins.length;o++){let a=this.config.plugins[o];if(a.spec.appendTransaction){let l=i?i[o].n:0,d=i?i[o].state:this,u=l<t.length&&a.spec.appendTransaction.call(a,l?t.slice(l):t,d,s);if(u&&s.filterTransaction(u,o)){if(u.setMeta("appendedTransaction",e),!i){i=[];for(let p=0;p<this.config.plugins.length;p++)i.push(p<o?{state:s,n:t.length}:{state:this,n:0})}t.push(u),s=s.applyInner(u),r=!0}i&&(i[o]={state:s,n:t.length})}}if(!r)return{state:s,transactions:t}}}applyInner(e){if(!e.before.eq(this.doc))throw new RangeError("Applying a mismatched transaction");let t=new wi(this.config),s=this.config.fields;for(let i=0;i<s.length;i++){let r=s[i];t[r.name]=r.apply(e,this[r.name],this,t)}return t}get tr(){return new Fk(this)}static create(e){let t=new Ca(e.doc?e.doc.type.schema:e.schema,e.plugins),s=new wi(t);for(let i=0;i<t.fields.length;i++)s[t.fields[i].name]=t.fields[i].init(e,s);return s}reconfigure(e){let t=new Ca(this.schema,e.plugins),s=t.fields,i=new wi(t);for(let r=0;r<s.length;r++){let o=s[r].name;i[o]=this.hasOwnProperty(o)?this[o]:s[r].init(e,i)}return i}toJSON(e){let t={doc:this.doc.toJSON(),selection:this.selection.toJSON()};if(this.storedMarks&&(t.storedMarks=this.storedMarks.map(s=>s.toJSON())),e&&typeof e=="object")for(let s in e){if(s=="doc"||s=="selection")throw new RangeError("The JSON fields `doc` and `selection` are reserved");let i=e[s],r=i.spec.state;r&&r.toJSON&&(t[s]=r.toJSON.call(i,this[i.key]))}return t}static fromJSON(e,t,s){if(!t)throw new RangeError("Invalid input for EditorState.fromJSON");if(!e.schema)throw new RangeError("Required config field 'schema' missing");let i=new Ca(e.schema,e.plugins),r=new wi(i);return i.fields.forEach(o=>{if(o.name=="doc")r.doc=Pn.fromJSON(e.schema,t.doc);else if(o.name=="selection")r.selection=Ne.fromJSON(r.doc,t.selection);else if(o.name=="storedMarks")t.storedMarks&&(r.storedMarks=t.storedMarks.map(e.schema.markFromJSON));else{if(s)for(let a in s){let l=s[a],d=l.spec.state;if(l.key==o.name&&d&&d.fromJSON&&Object.prototype.hasOwnProperty.call(t,a)){r[o.name]=d.fromJSON.call(l,e,t[a],r);return}}r[o.name]=o.init(e,r)}}),r}}function op(n,e,t){for(let s in n){let i=n[s];i instanceof Function?i=i.bind(e):s=="handleDOMEvents"&&(i=op(i,e,{})),t[s]=i}return t}class _s{constructor(e){this.spec=e,this.props={},e.props&&op(e.props,this,this.props),this.key=e.key?e.key.key:ap("plugin")}getState(e){return e[this.key]}}const Ma=Object.create(null);function ap(n){return n in Ma?n+"$"+ ++Ma[n]:(Ma[n]=0,n+"$")}class oi{constructor(e="key"){this.key=ap(e)}get(e){return e.config.pluginsByKey[this.key]}getState(e){return e[this.key]}}const lp=new oi("transactionEventPlugin"),sl="prosemirrorDispatchTransaction";function Pd(n,e){const{eventTarget:t}=lp.getState(n.state);return t.addEventListener(sl,e),()=>{t.removeEventListener(sl,e)}}function Lk(n){return new _s({key:lp,state:{init(){return{eventTarget:n}},apply(e,t){return t}}})}const io=new oi("customKeymapPlugin");function zk(n,e){n.dispatch(n.state.tr.setMeta(io,{handlers:e}))}function Uk(n={handlers:{}}){return new _s({key:io,state:{init(){return{...n}},apply(e,t){const s=e.getMeta(io);return s?{...t,...s}:t}},props:{handleKeyDown(e,t){const i=io.getState(e.state).handlers[t.key];return i?i(t):!1}}})}const cp=(n,e)=>n.selection.empty?!1:(e&&e(n.tr.deleteSelection().scrollIntoView()),!0);function Vk(n,e){let{$cursor:t}=n.selection;return!t||(e?!e.endOfTextblock("backward",n):t.parentOffset>0)?null:t}const Gk=(n,e,t)=>{let s=Vk(n,t);if(!s)return!1;let i=dp(s);if(!i){let o=s.blockRange(),a=o&&pc(o);return a==null?!1:(e&&e(n.tr.lift(o,a).scrollIntoView()),!0)}let r=i.nodeBefore;if(!r.type.spec.isolating&&mp(n,i,e))return!0;if(s.parent.content.size==0&&(Oi(r,"end")||ue.isSelectable(r))){let o=mc(n.doc,s.before(),s.after(),Q.empty);if(o&&o.slice.size<o.to-o.from){if(e){let a=n.tr.step(o);a.setSelection(Oi(r,"end")?Ne.findFrom(a.doc.resolve(a.mapping.map(i.pos,-1)),-1):ue.create(a.doc,i.pos-r.nodeSize)),e(a.scrollIntoView())}return!0}}return r.isAtom&&i.depth==s.depth-1?(e&&e(n.tr.delete(i.pos-r.nodeSize,i.pos).scrollIntoView()),!0):!1};function Oi(n,e,t=!1){for(let s=n;s;s=e=="start"?s.firstChild:s.lastChild){if(s.isTextblock)return!0;if(t&&s.childCount!=1)return!1}return!1}const Wk=(n,e,t)=>{let{$head:s,empty:i}=n.selection,r=s;if(!i)return!1;if(s.parent.isTextblock){if(t?!t.endOfTextblock("backward",n):s.parentOffset>0)return!1;r=dp(s)}let o=r&&r.nodeBefore;return!o||!ue.isSelectable(o)?!1:(e&&e(n.tr.setSelection(ue.create(n.doc,r.pos-o.nodeSize)).scrollIntoView()),!0)};function dp(n){if(!n.parent.type.spec.isolating)for(let e=n.depth-1;e>=0;e--){if(n.index(e)>0)return n.doc.resolve(n.before(e+1));if(n.node(e).type.spec.isolating)break}return null}function Hk(n,e){let{$cursor:t}=n.selection;return!t||(e?!e.endOfTextblock("forward",n):t.parentOffset<t.parent.content.size)?null:t}const qk=(n,e,t)=>{let s=Hk(n,t);if(!s)return!1;let i=up(s);if(!i)return!1;let r=i.nodeAfter;if(mp(n,i,e))return!0;if(s.parent.content.size==0&&(Oi(r,"start")||ue.isSelectable(r))){let o=mc(n.doc,s.before(),s.after(),Q.empty);if(o&&o.slice.size<o.to-o.from){if(e){let a=n.tr.step(o);a.setSelection(Oi(r,"start")?Ne.findFrom(a.doc.resolve(a.mapping.map(i.pos)),1):ue.create(a.doc,a.mapping.map(i.pos))),e(a.scrollIntoView())}return!0}}return r.isAtom&&i.depth==s.depth-1?(e&&e(n.tr.delete(i.pos,i.pos+r.nodeSize).scrollIntoView()),!0):!1},$k=(n,e,t)=>{let{$head:s,empty:i}=n.selection,r=s;if(!i)return!1;if(s.parent.isTextblock){if(t?!t.endOfTextblock("forward",n):s.parentOffset<s.parent.content.size)return!1;r=up(s)}let o=r&&r.nodeAfter;return!o||!ue.isSelectable(o)?!1:(e&&e(n.tr.setSelection(ue.create(n.doc,r.pos)).scrollIntoView()),!0)};function up(n){if(!n.parent.type.spec.isolating)for(let e=n.depth-1;e>=0;e--){let t=n.node(e);if(n.index(e)+1<t.childCount)return n.doc.resolve(n.after(e+1));if(t.type.spec.isolating)break}return null}const Kk=(n,e)=>{let{$head:t,$anchor:s}=n.selection;return!t.parent.type.spec.code||!t.sameParent(s)?!1:(e&&e(n.tr.insertText(`
`).scrollIntoView()),!0)};function yc(n){for(let e=0;e<n.edgeCount;e++){let{type:t}=n.edge(e);if(t.isTextblock&&!t.hasRequiredAttrs())return t}return null}const Jk=(n,e)=>{let{$head:t,$anchor:s}=n.selection;if(!t.parent.type.spec.code||!t.sameParent(s))return!1;let i=t.node(-1),r=t.indexAfter(-1),o=yc(i.contentMatchAt(r));if(!o||!i.canReplaceWith(r,r,o))return!1;if(e){let a=t.after(),l=n.tr.replaceWith(a,a,o.createAndFill());l.setSelection(Ne.near(l.doc.resolve(a),1)),e(l.scrollIntoView())}return!0},hp=(n,e)=>{let t=n.selection,{$from:s,$to:i}=t;if(t instanceof Yt||s.parent.inlineContent||i.parent.inlineContent)return!1;let r=yc(i.parent.contentMatchAt(i.indexAfter()));if(!r||!r.isTextblock)return!1;if(e){let o=(!s.parentOffset&&i.index()<i.parent.childCount?s:i).pos,a=n.tr.insert(o,r.createAndFill());a.setSelection(Fe.create(a.doc,o+1)),e(a.scrollIntoView())}return!0},fp=(n,e)=>{let{$cursor:t}=n.selection;if(!t||t.parent.content.size)return!1;if(t.depth>1&&t.after()!=t.end(-1)){let r=t.before();if(so(n.doc,r))return e&&e(n.tr.split(r).scrollIntoView()),!0}let s=t.blockRange(),i=s&&pc(s);return i==null?!1:(e&&e(n.tr.lift(s,i).scrollIntoView()),!0)};function Yk(n){return(e,t)=>{let{$from:s,$to:i}=e.selection;if(e.selection instanceof ue&&e.selection.node.isBlock)return!s.parentOffset||!so(e.doc,s.pos)?!1:(t&&t(e.tr.split(s.pos).scrollIntoView()),!0);if(!s.parent.isBlock)return!1;if(t){let r=i.parentOffset==i.parent.content.size,o=e.tr;(e.selection instanceof Fe||e.selection instanceof Yt)&&o.deleteSelection();let a=s.depth==0?null:yc(s.node(-1).contentMatchAt(s.indexAfter(-1))),l=r&&a?[{type:a}]:void 0,d=so(o.doc,o.mapping.map(s.pos),1,l);if(!l&&!d&&so(o.doc,o.mapping.map(s.pos),1,a?[{type:a}]:void 0)&&(a&&(l=[{type:a}]),d=!0),d&&(o.split(o.mapping.map(s.pos),1,l),!r&&!s.parentOffset&&s.parent.type!=a)){let u=o.mapping.map(s.before()),p=o.doc.resolve(u);a&&s.node(-1).canReplaceWith(p.index(),p.index()+1,a)&&o.setNodeMarkup(o.mapping.map(s.before()),a)}t(o.scrollIntoView())}return!0}}const pp=Yk(),Qk=(n,e)=>(e&&e(n.tr.setSelection(new Yt(n.doc))),!0);function Xk(n,e,t){let s=e.nodeBefore,i=e.nodeAfter,r=e.index();return!s||!i||!s.type.compatibleContent(i.type)?!1:!s.content.size&&e.parent.canReplace(r-1,r)?(t&&t(n.tr.delete(e.pos-s.nodeSize,e.pos).scrollIntoView()),!0):!e.parent.canReplace(r,r+1)||!(i.isTextblock||tp(n.doc,e.pos))?!1:(t&&t(n.tr.clearIncompatible(e.pos,s.type,s.contentMatchAt(s.childCount)).join(e.pos).scrollIntoView()),!0)}function mp(n,e,t){let s=e.nodeBefore,i=e.nodeAfter,r,o;if(s.type.spec.isolating||i.type.spec.isolating)return!1;if(Xk(n,e,t))return!0;let a=e.parent.canReplace(e.index(),e.index()+1);if(a&&(r=(o=s.contentMatchAt(s.childCount)).findWrapping(i.type))&&o.matchType(r[0]||i.type).validEnd){if(t){let p=e.pos+i.nodeSize,m=H.empty;for(let x=r.length-1;x>=0;x--)m=H.from(r[x].create(null,m));m=H.from(s.copy(m));let b=n.tr.step(new Jt(e.pos-1,p,e.pos,p,new Q(m,1,0),r.length,!0)),g=p+2*r.length;tp(b.doc,g)&&b.join(g),t(b.scrollIntoView())}return!0}let l=Ne.findFrom(e,1),d=l&&l.$from.blockRange(l.$to),u=d&&pc(d);if(u!=null&&u>=e.depth)return t&&t(n.tr.lift(d,u).scrollIntoView()),!0;if(a&&Oi(i,"start",!0)&&Oi(s,"end")){let p=s,m=[];for(;m.push(p),!p.isTextblock;)p=p.lastChild;let b=i,g=1;for(;!b.isTextblock;b=b.firstChild)g++;if(p.canReplace(p.childCount,p.childCount,b.content)){if(t){let x=H.empty;for(let M=m.length-1;M>=0;M--)x=H.from(m[M].copy(x));let k=n.tr.step(new Jt(e.pos-m.length,e.pos+i.nodeSize,e.pos+g,e.pos+i.nodeSize-g,new Q(x,m.length,0),0,!0));t(k.scrollIntoView())}return!0}}return!1}function gp(n){return function(e,t){let s=e.selection,i=n<0?s.$from:s.$to,r=i.depth;for(;i.node(r).isInline;){if(!r)return!1;r--}return i.node(r).isTextblock?(t&&t(e.tr.setSelection(Fe.create(e.doc,n<0?i.start(r):i.end(r)))),!0):!1}}const Zk=gp(-1),eC=gp(1);function M_(n,e=null){return function(t,s){let{$from:i,$to:r}=t.selection,o=i.blockRange(r),a=o&&pk(o,n,e);return a?(s&&s(t.tr.wrap(o,a).scrollIntoView()),!0):!1}}function v_(n,e=null){return function(t,s){let i=!1;for(let r=0;r<t.selection.ranges.length&&!i;r++){let{$from:{pos:o},$to:{pos:a}}=t.selection.ranges[r];t.doc.nodesBetween(o,a,(l,d)=>{if(i)return!1;if(!(!l.isTextblock||l.hasMarkup(n,e)))if(l.type==n)i=!0;else{let u=t.doc.resolve(d),p=u.index();i=u.parent.canReplaceWith(p,p+1,n)}})}if(!i)return!1;if(s){let r=t.tr;for(let o=0;o<t.selection.ranges.length;o++){let{$from:{pos:a},$to:{pos:l}}=t.selection.ranges[o];r.setBlockType(a,l,n,e)}s(r.scrollIntoView())}return!0}}function tC(n,e,t){for(let s=0;s<e.length;s++){let{$from:i,$to:r}=e[s],o=i.depth==0?n.inlineContent&&n.type.allowsMarkType(t):!1;if(n.nodesBetween(i.pos,r.pos,a=>{if(o)return!1;o=a.inlineContent&&a.type.allowsMarkType(t)}),o)return!0}return!1}function T_(n,e=null){return function(t,s){let{empty:i,$cursor:r,ranges:o}=t.selection;if(i&&!r||!tC(t.doc,o,n))return!1;if(s)if(r)n.isInSet(t.storedMarks||r.marks())?s(t.tr.removeStoredMark(n)):s(t.tr.addStoredMark(n.create(e)));else{let a=!1,l=t.tr;for(let d=0;!a&&d<o.length;d++){let{$from:u,$to:p}=o[d];a=t.doc.rangeHasMark(u.pos,p.pos,n)}for(let d=0;d<o.length;d++){let{$from:u,$to:p}=o[d];if(a)l.removeMark(u.pos,p.pos,n);else{let m=u.pos,b=p.pos,g=u.nodeAfter,x=p.nodeBefore,k=g&&g.isText?/^\s*/.exec(g.text)[0].length:0,M=x&&x.isText?/\s*$/.exec(x.text)[0].length:0;m+k<b&&(m+=k,b-=M),l.addMark(m,b,n.create(e))}}s(l.scrollIntoView())}return!0}}function na(...n){return function(e,t,s){for(let i=0;i<n.length;i++)if(n[i](e,t,s))return!0;return!1}}let va=na(cp,Gk,Wk),Fd=na(cp,qk,$k);const Jn={Enter:na(Kk,hp,fp,pp),"Mod-Enter":Jk,Backspace:va,"Mod-Backspace":va,"Shift-Backspace":va,Delete:Fd,"Mod-Delete":Fd,"Mod-a":Qk},yp={"Ctrl-h":Jn.Backspace,"Alt-Backspace":Jn["Mod-Backspace"],"Ctrl-d":Jn.Delete,"Ctrl-Alt-Backspace":Jn["Mod-Delete"],"Alt-Delete":Jn["Mod-Delete"],"Alt-d":Jn["Mod-Delete"],"Ctrl-a":Zk,"Ctrl-e":eC};for(let n in Jn)yp[n]=Jn[n];const nC=typeof navigator<"u"?/Mac|iP(hone|[oa]d)/.test(navigator.platform):typeof os<"u"&&os.platform?os.platform()=="darwin":!1,sC=nC?yp:Jn;function xp(n){let e="",t=!1;const s=[];function i(r){if(t=!1,r.type.name==="paragraph")return r.descendants(o=>i(o)),e+=`
`,t=!0,!1;if(r.type.name==="command_token"){const o=r.textContent;return s.push({symbol:Px.SystemHint,startIndex:e.length,endIndex:e.length+o.length}),e+=o,!1}else r.isText&&r.text!==void 0&&(e+=r.text)}return n.descendants(r=>i(r)),t&&e.endsWith(`
`)&&(e=e.slice(0,-1)),{content:e,metadata:{custom_symbol_offsets:s}}}function iC(n){return xp(n.state.doc)}const il=na(hp,fp,pp);async function rC(n,e){e.split(`
`).forEach((t,s)=>{s!==0&&il(n.state,n.dispatch),n.dispatch(n.state.tr.insertText(t))})}const Mi=new oi("menuSelectorPlugin");function er(n){n.dispatch(n.state.tr.setMeta(Mi,{active:!1,onMenuAction:void 0}))}function bp(n,e){n.dispatch(n.state.tr.setMeta(Mi,{active:!0,onMenuAction:e}))}function oC(n={submitKeys:["Enter","Tab"],cancelKeys:["Escape"],checkStrictMatchKeys:[]}){return new _s({key:Mi,state:{init(){return{...n,active:!1}},apply(e,t){const s=e.getMeta(Mi);return s?{...t,...s}:t}},props:{handleKeyDown(e,t){var i,r,o,a,l;const s=Mi.getState(e.state);return s.active?s.submitKeys.includes(t.key)?(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),(i=s.onMenuAction)==null||i.call(s,"submit"),er(e),!0):s.cancelKeys.includes(t.key)?(t.preventDefault(),(r=s.onMenuAction)==null||r.call(s,"cancel"),bp(e,s.onMenuAction),!0):t.key==="ArrowUp"?(t.preventDefault(),(o=s.onMenuAction)==null||o.call(s,"up"),!0):t.key==="ArrowDown"?(t.preventDefault(),(a=s.onMenuAction)==null||a.call(s,"down"),!0):(s.checkStrictMatchKeys.includes(t.key)&&((l=s.onMenuAction)==null||l.call(s,"checkMatch")),!1):!1}}})}const kt=function(n){for(var e=0;;e++)if(n=n.previousSibling,!n)return e},Sr=function(n){let e=n.assignedSlot||n.parentNode;return e&&e.nodeType==11?e.host:e};let rl=null;const $n=function(n,e,t){let s=rl||(rl=document.createRange());return s.setEnd(n,t??n.nodeValue.length),s.setStart(n,e||0),s},aC=function(){rl=null},ni=function(n,e,t,s){return t&&(Bd(n,e,t,s,-1)||Bd(n,e,t,s,1))},lC=/^(img|br|input|textarea|hr)$/i;function Bd(n,e,t,s,i){for(;;){if(n==t&&e==s)return!0;if(e==(i<0?0:Dn(n))){let r=n.parentNode;if(!r||r.nodeType!=1||jr(n)||lC.test(n.nodeName)||n.contentEditable=="false")return!1;e=kt(n)+(i<0?0:1),n=r}else if(n.nodeType==1){if(n=n.childNodes[e+(i<0?-1:0)],n.contentEditable=="false")return!1;e=i<0?Dn(n):0}else return!1}}function Dn(n){return n.nodeType==3?n.nodeValue.length:n.childNodes.length}function cC(n,e){for(;;){if(n.nodeType==3&&e)return n;if(n.nodeType==1&&e>0){if(n.contentEditable=="false")return null;n=n.childNodes[e-1],e=Dn(n)}else if(n.parentNode&&!jr(n))e=kt(n),n=n.parentNode;else return null}}function dC(n,e){for(;;){if(n.nodeType==3&&e<n.nodeValue.length)return n;if(n.nodeType==1&&e<n.childNodes.length){if(n.contentEditable=="false")return null;n=n.childNodes[e],e=0}else if(n.parentNode&&!jr(n))e=kt(n)+1,n=n.parentNode;else return null}}function uC(n,e,t){for(let s=e==0,i=e==Dn(n);s||i;){if(n==t)return!0;let r=kt(n);if(n=n.parentNode,!n)return!1;s=s&&r==0,i=i&&r==Dn(n)}}function jr(n){let e;for(let t=n;t&&!(e=t.pmViewDesc);t=t.parentNode);return e&&e.node&&e.node.isBlock&&(e.dom==n||e.contentDOM==n)}const sa=function(n){return n.focusNode&&ni(n.focusNode,n.focusOffset,n.anchorNode,n.anchorOffset)};function Us(n,e){let t=document.createEvent("Event");return t.initEvent("keydown",!0,!0),t.keyCode=n,t.key=t.code=e,t}function hC(n){let e=n.activeElement;for(;e&&e.shadowRoot;)e=e.shadowRoot.activeElement;return e}function fC(n,e,t){if(n.caretPositionFromPoint)try{let s=n.caretPositionFromPoint(e,t);if(s)return{node:s.offsetNode,offset:s.offset}}catch{}if(n.caretRangeFromPoint){let s=n.caretRangeFromPoint(e,t);if(s)return{node:s.startContainer,offset:s.startOffset}}}const Ln=typeof navigator<"u"?navigator:null,Ld=typeof document<"u"?document:null,Ns=Ln&&Ln.userAgent||"",ol=/Edge\/(\d+)/.exec(Ns),Sp=/MSIE \d/.exec(Ns),al=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(Ns),Ut=!!(Sp||al||ol),ws=Sp?document.documentMode:al?+al[1]:ol?+ol[1]:0,Tn=!Ut&&/gecko\/(\d+)/i.test(Ns);Tn&&+(/Firefox\/(\d+)/.exec(Ns)||[0,0])[1];const ll=!Ut&&/Chrome\/(\d+)/.exec(Ns),Nt=!!ll,wp=ll?+ll[1]:0,Pt=!Ut&&!!Ln&&/Apple Computer/.test(Ln.vendor),Pi=Pt&&(/Mobile\/\w+/.test(Ns)||!!Ln&&Ln.maxTouchPoints>2),on=Pi||(Ln?/Mac/.test(Ln.platform):!1),pC=Ln?/Win/.test(Ln.platform):!1,Cn=/Android \d/.test(Ns),Or=!!Ld&&"webkitFontSmoothing"in Ld.documentElement.style,mC=Or?+(/\bAppleWebKit\/(\d+)/.exec(navigator.userAgent)||[0,0])[1]:0;function gC(n){let e=n.defaultView&&n.defaultView.visualViewport;return e?{left:0,right:e.width,top:0,bottom:e.height}:{left:0,right:n.documentElement.clientWidth,top:0,bottom:n.documentElement.clientHeight}}function Hn(n,e){return typeof n=="number"?n:n[e]}function yC(n){let e=n.getBoundingClientRect(),t=e.width/n.offsetWidth||1,s=e.height/n.offsetHeight||1;return{left:e.left,right:e.left+n.clientWidth*t,top:e.top,bottom:e.top+n.clientHeight*s}}function zd(n,e,t){let s=n.someProp("scrollThreshold")||0,i=n.someProp("scrollMargin")||5,r=n.dom.ownerDocument;for(let o=t||n.dom;o;o=Sr(o)){if(o.nodeType!=1)continue;let a=o,l=a==r.body,d=l?gC(r):yC(a),u=0,p=0;if(e.top<d.top+Hn(s,"top")?p=-(d.top-e.top+Hn(i,"top")):e.bottom>d.bottom-Hn(s,"bottom")&&(p=e.bottom-e.top>d.bottom-d.top?e.top+Hn(i,"top")-d.top:e.bottom-d.bottom+Hn(i,"bottom")),e.left<d.left+Hn(s,"left")?u=-(d.left-e.left+Hn(i,"left")):e.right>d.right-Hn(s,"right")&&(u=e.right-d.right+Hn(i,"right")),u||p)if(l)r.defaultView.scrollBy(u,p);else{let m=a.scrollLeft,b=a.scrollTop;p&&(a.scrollTop+=p),u&&(a.scrollLeft+=u);let g=a.scrollLeft-m,x=a.scrollTop-b;e={left:e.left-g,top:e.top-x,right:e.right-g,bottom:e.bottom-x}}if(l||/^(fixed|sticky)$/.test(getComputedStyle(o).position))break}}function xC(n){let e=n.dom.getBoundingClientRect(),t=Math.max(0,e.top),s,i;for(let r=(e.left+e.right)/2,o=t+1;o<Math.min(innerHeight,e.bottom);o+=5){let a=n.root.elementFromPoint(r,o);if(!a||a==n.dom||!n.dom.contains(a))continue;let l=a.getBoundingClientRect();if(l.top>=t-20){s=a,i=l.top;break}}return{refDOM:s,refTop:i,stack:kp(n.dom)}}function kp(n){let e=[],t=n.ownerDocument;for(let s=n;s&&(e.push({dom:s,top:s.scrollTop,left:s.scrollLeft}),n!=t);s=Sr(s));return e}function bC({refDOM:n,refTop:e,stack:t}){let s=n?n.getBoundingClientRect().top:0;Cp(t,s==0?0:s-e)}function Cp(n,e){for(let t=0;t<n.length;t++){let{dom:s,top:i,left:r}=n[t];s.scrollTop!=i+e&&(s.scrollTop=i+e),s.scrollLeft!=r&&(s.scrollLeft=r)}}let gi=null;function SC(n){if(n.setActive)return n.setActive();if(gi)return n.focus(gi);let e=kp(n);n.focus(gi==null?{get preventScroll(){return gi={preventScroll:!0},!0}}:void 0),gi||(gi=!1,Cp(e,0))}function Mp(n,e){let t,s=2e8,i,r=0,o=e.top,a=e.top,l,d;for(let u=n.firstChild,p=0;u;u=u.nextSibling,p++){let m;if(u.nodeType==1)m=u.getClientRects();else if(u.nodeType==3)m=$n(u).getClientRects();else continue;for(let b=0;b<m.length;b++){let g=m[b];if(g.top<=o&&g.bottom>=a){o=Math.max(g.bottom,o),a=Math.min(g.top,a);let x=g.left>e.left?g.left-e.left:g.right<e.left?e.left-g.right:0;if(x<s){t=u,s=x,i=x&&t.nodeType==3?{left:g.right<e.left?g.right:g.left,top:e.top}:e,u.nodeType==1&&x&&(r=p+(e.left>=(g.left+g.right)/2?1:0));continue}}else g.top>e.top&&!l&&g.left<=e.left&&g.right>=e.left&&(l=u,d={left:Math.max(g.left,Math.min(g.right,e.left)),top:g.top});!t&&(e.left>=g.right&&e.top>=g.top||e.left>=g.left&&e.top>=g.bottom)&&(r=p+1)}}return!t&&l&&(t=l,i=d,s=0),t&&t.nodeType==3?wC(t,i):!t||s&&t.nodeType==1?{node:n,offset:r}:Mp(t,i)}function wC(n,e){let t=n.nodeValue.length,s=document.createRange();for(let i=0;i<t;i++){s.setEnd(n,i+1),s.setStart(n,i);let r=ls(s,1);if(r.top!=r.bottom&&xc(e,r))return{node:n,offset:i+(e.left>=(r.left+r.right)/2?1:0)}}return{node:n,offset:0}}function xc(n,e){return n.left>=e.left-1&&n.left<=e.right+1&&n.top>=e.top-1&&n.top<=e.bottom+1}function kC(n,e){let t=n.parentNode;return t&&/^li$/i.test(t.nodeName)&&e.left<n.getBoundingClientRect().left?t:n}function CC(n,e,t){let{node:s,offset:i}=Mp(e,t),r=-1;if(s.nodeType==1&&!s.firstChild){let o=s.getBoundingClientRect();r=o.left!=o.right&&t.left>(o.left+o.right)/2?1:-1}return n.docView.posFromDOM(s,i,r)}function MC(n,e,t,s){let i=-1;for(let r=e,o=!1;r!=n.dom;){let a=n.docView.nearestDesc(r,!0);if(!a)return null;if(a.dom.nodeType==1&&(a.node.isBlock&&a.parent||!a.contentDOM)){let l=a.dom.getBoundingClientRect();if(a.node.isBlock&&a.parent&&(!o&&l.left>s.left||l.top>s.top?i=a.posBefore:(!o&&l.right<s.left||l.bottom<s.top)&&(i=a.posAfter),o=!0),!a.contentDOM&&i<0&&!a.node.isText)return(a.node.isBlock?s.top<(l.top+l.bottom)/2:s.left<(l.left+l.right)/2)?a.posBefore:a.posAfter}r=a.dom.parentNode}return i>-1?i:n.docView.posFromDOM(e,t,-1)}function vp(n,e,t){let s=n.childNodes.length;if(s&&t.top<t.bottom)for(let i=Math.max(0,Math.min(s-1,Math.floor(s*(e.top-t.top)/(t.bottom-t.top))-2)),r=i;;){let o=n.childNodes[r];if(o.nodeType==1){let a=o.getClientRects();for(let l=0;l<a.length;l++){let d=a[l];if(xc(e,d))return vp(o,e,d)}}if((r=(r+1)%s)==i)break}return n}function vC(n,e){let t=n.dom.ownerDocument,s,i=0,r=fC(t,e.left,e.top);r&&({node:s,offset:i}=r);let o=(n.root.elementFromPoint?n.root:t).elementFromPoint(e.left,e.top),a;if(!o||!n.dom.contains(o.nodeType!=1?o.parentNode:o)){let d=n.dom.getBoundingClientRect();if(!xc(e,d)||(o=vp(n.dom,e,d),!o))return null}if(Pt)for(let d=o;s&&d;d=Sr(d))d.draggable&&(s=void 0);if(o=kC(o,e),s){if(Tn&&s.nodeType==1&&(i=Math.min(i,s.childNodes.length),i<s.childNodes.length)){let u=s.childNodes[i],p;u.nodeName=="IMG"&&(p=u.getBoundingClientRect()).right<=e.left&&p.bottom>e.top&&i++}let d;Or&&i&&s.nodeType==1&&(d=s.childNodes[i-1]).nodeType==1&&d.contentEditable=="false"&&d.getBoundingClientRect().top>=e.top&&i--,s==n.dom&&i==s.childNodes.length-1&&s.lastChild.nodeType==1&&e.top>s.lastChild.getBoundingClientRect().bottom?a=n.state.doc.content.size:(i==0||s.nodeType!=1||s.childNodes[i-1].nodeName!="BR")&&(a=MC(n,s,i,e))}a==null&&(a=CC(n,o,e));let l=n.docView.nearestDesc(o,!0);return{pos:a,inside:l?l.posAtStart-l.border:-1}}function Ud(n){return n.top<n.bottom||n.left<n.right}function ls(n,e){let t=n.getClientRects();if(t.length){let s=t[e<0?0:t.length-1];if(Ud(s))return s}return Array.prototype.find.call(t,Ud)||n.getBoundingClientRect()}const TC=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/;function Tp(n,e,t){let{node:s,offset:i,atom:r}=n.docView.domFromPos(e,t<0?-1:1),o=Or||Tn;if(s.nodeType==3)if(o&&(TC.test(s.nodeValue)||(t<0?!i:i==s.nodeValue.length))){let l=ls($n(s,i,i),t);if(Tn&&i&&/\s/.test(s.nodeValue[i-1])&&i<s.nodeValue.length){let d=ls($n(s,i-1,i-1),-1);if(d.top==l.top){let u=ls($n(s,i,i+1),-1);if(u.top!=l.top)return Ki(u,u.left<d.left)}}return l}else{let l=i,d=i,u=t<0?1:-1;return t<0&&!i?(d++,u=-1):t>=0&&i==s.nodeValue.length?(l--,u=1):t<0?l--:d++,Ki(ls($n(s,l,d),u),u<0)}if(!n.state.doc.resolve(e-(r||0)).parent.inlineContent){if(r==null&&i&&(t<0||i==Dn(s))){let l=s.childNodes[i-1];if(l.nodeType==1)return Ta(l.getBoundingClientRect(),!1)}if(r==null&&i<Dn(s)){let l=s.childNodes[i];if(l.nodeType==1)return Ta(l.getBoundingClientRect(),!0)}return Ta(s.getBoundingClientRect(),t>=0)}if(r==null&&i&&(t<0||i==Dn(s))){let l=s.childNodes[i-1],d=l.nodeType==3?$n(l,Dn(l)-(o?0:1)):l.nodeType==1&&(l.nodeName!="BR"||!l.nextSibling)?l:null;if(d)return Ki(ls(d,1),!1)}if(r==null&&i<Dn(s)){let l=s.childNodes[i];for(;l.pmViewDesc&&l.pmViewDesc.ignoreForCoords;)l=l.nextSibling;let d=l?l.nodeType==3?$n(l,0,o?0:1):l.nodeType==1?l:null:null;if(d)return Ki(ls(d,-1),!0)}return Ki(ls(s.nodeType==3?$n(s):s,-t),t>=0)}function Ki(n,e){if(n.width==0)return n;let t=e?n.left:n.right;return{top:n.top,bottom:n.bottom,left:t,right:t}}function Ta(n,e){if(n.height==0)return n;let t=e?n.top:n.bottom;return{top:t,bottom:t,left:n.left,right:n.right}}function Ep(n,e,t){let s=n.state,i=n.root.activeElement;s!=e&&n.updateState(e),i!=n.dom&&n.focus();try{return t()}finally{s!=e&&n.updateState(s),i!=n.dom&&i&&i.focus()}}function EC(n,e,t){let s=e.selection,i=t=="up"?s.$from:s.$to;return Ep(n,e,()=>{let{node:r}=n.docView.domFromPos(i.pos,t=="up"?-1:1);for(;;){let a=n.docView.nearestDesc(r,!0);if(!a)break;if(a.node.isBlock){r=a.contentDOM||a.dom;break}r=a.dom.parentNode}let o=Tp(n,i.pos,1);for(let a=r.firstChild;a;a=a.nextSibling){let l;if(a.nodeType==1)l=a.getClientRects();else if(a.nodeType==3)l=$n(a,0,a.nodeValue.length).getClientRects();else continue;for(let d=0;d<l.length;d++){let u=l[d];if(u.bottom>u.top+1&&(t=="up"?o.top-u.top>(u.bottom-o.top)*2:u.bottom-o.bottom>(o.bottom-u.top)*2))return!1}}return!0})}const _C=/[\u0590-\u08ac]/;function NC(n,e,t){let{$head:s}=e.selection;if(!s.parent.isTextblock)return!1;let i=s.parentOffset,r=!i,o=i==s.parent.content.size,a=n.domSelection();return!_C.test(s.parent.textContent)||!a.modify?t=="left"||t=="backward"?r:o:Ep(n,e,()=>{let{focusNode:l,focusOffset:d,anchorNode:u,anchorOffset:p}=n.domSelectionRange(),m=a.caretBidiLevel;a.modify("move",t,"character");let b=s.depth?n.docView.domAfterPos(s.before()):n.dom,{focusNode:g,focusOffset:x}=n.domSelectionRange(),k=g&&!b.contains(g.nodeType==1?g:g.parentNode)||l==g&&d==x;try{a.collapse(u,p),l&&(l!=u||d!=p)&&a.extend&&a.extend(l,d)}catch{}return m!=null&&(a.caretBidiLevel=m),k})}let Vd=null,Gd=null,Wd=!1;function IC(n,e,t){return Vd==e&&Gd==t?Wd:(Vd=e,Gd=t,Wd=t=="up"||t=="down"?EC(n,e,t):NC(n,e,t))}const dn=0,Hd=1,Gs=2,zn=3;class Pr{constructor(e,t,s,i){this.parent=e,this.children=t,this.dom=s,this.contentDOM=i,this.dirty=dn,s.pmViewDesc=this}matchesWidget(e){return!1}matchesMark(e){return!1}matchesNode(e,t,s){return!1}matchesHack(e){return!1}parseRule(){return null}stopEvent(e){return!1}get size(){let e=0;for(let t=0;t<this.children.length;t++)e+=this.children[t].size;return e}get border(){return 0}destroy(){this.parent=void 0,this.dom.pmViewDesc==this&&(this.dom.pmViewDesc=void 0);for(let e=0;e<this.children.length;e++)this.children[e].destroy()}posBeforeChild(e){for(let t=0,s=this.posAtStart;;t++){let i=this.children[t];if(i==e)return s;s+=i.size}}get posBefore(){return this.parent.posBeforeChild(this)}get posAtStart(){return this.parent?this.parent.posBeforeChild(this)+this.border:0}get posAfter(){return this.posBefore+this.size}get posAtEnd(){return this.posAtStart+this.size-2*this.border}localPosFromDOM(e,t,s){if(this.contentDOM&&this.contentDOM.contains(e.nodeType==1?e:e.parentNode))if(s<0){let r,o;if(e==this.contentDOM)r=e.childNodes[t-1];else{for(;e.parentNode!=this.contentDOM;)e=e.parentNode;r=e.previousSibling}for(;r&&!((o=r.pmViewDesc)&&o.parent==this);)r=r.previousSibling;return r?this.posBeforeChild(o)+o.size:this.posAtStart}else{let r,o;if(e==this.contentDOM)r=e.childNodes[t];else{for(;e.parentNode!=this.contentDOM;)e=e.parentNode;r=e.nextSibling}for(;r&&!((o=r.pmViewDesc)&&o.parent==this);)r=r.nextSibling;return r?this.posBeforeChild(o):this.posAtEnd}let i;if(e==this.dom&&this.contentDOM)i=t>kt(this.contentDOM);else if(this.contentDOM&&this.contentDOM!=this.dom&&this.dom.contains(this.contentDOM))i=e.compareDocumentPosition(this.contentDOM)&2;else if(this.dom.firstChild){if(t==0)for(let r=e;;r=r.parentNode){if(r==this.dom){i=!1;break}if(r.previousSibling)break}if(i==null&&t==e.childNodes.length)for(let r=e;;r=r.parentNode){if(r==this.dom){i=!0;break}if(r.nextSibling)break}}return i??s>0?this.posAtEnd:this.posAtStart}nearestDesc(e,t=!1){for(let s=!0,i=e;i;i=i.parentNode){let r=this.getDesc(i),o;if(r&&(!t||r.node))if(s&&(o=r.nodeDOM)&&!(o.nodeType==1?o.contains(e.nodeType==1?e:e.parentNode):o==e))s=!1;else return r}}getDesc(e){let t=e.pmViewDesc;for(let s=t;s;s=s.parent)if(s==this)return t}posFromDOM(e,t,s){for(let i=e;i;i=i.parentNode){let r=this.getDesc(i);if(r)return r.localPosFromDOM(e,t,s)}return-1}descAt(e){for(let t=0,s=0;t<this.children.length;t++){let i=this.children[t],r=s+i.size;if(s==e&&r!=s){for(;!i.border&&i.children.length;)i=i.children[0];return i}if(e<r)return i.descAt(e-s-i.border);s=r}}domFromPos(e,t){if(!this.contentDOM)return{node:this.dom,offset:0,atom:e+1};let s=0,i=0;for(let r=0;s<this.children.length;s++){let o=this.children[s],a=r+o.size;if(a>e||o instanceof Np){i=e-r;break}r=a}if(i)return this.children[s].domFromPos(i-this.children[s].border,t);for(let r;s&&!(r=this.children[s-1]).size&&r instanceof _p&&r.side>=0;s--);if(t<=0){let r,o=!0;for(;r=s?this.children[s-1]:null,!(!r||r.dom.parentNode==this.contentDOM);s--,o=!1);return r&&t&&o&&!r.border&&!r.domAtom?r.domFromPos(r.size,t):{node:this.contentDOM,offset:r?kt(r.dom)+1:0}}else{let r,o=!0;for(;r=s<this.children.length?this.children[s]:null,!(!r||r.dom.parentNode==this.contentDOM);s++,o=!1);return r&&o&&!r.border&&!r.domAtom?r.domFromPos(0,t):{node:this.contentDOM,offset:r?kt(r.dom):this.contentDOM.childNodes.length}}}parseRange(e,t,s=0){if(this.children.length==0)return{node:this.contentDOM,from:e,to:t,fromOffset:0,toOffset:this.contentDOM.childNodes.length};let i=-1,r=-1;for(let o=s,a=0;;a++){let l=this.children[a],d=o+l.size;if(i==-1&&e<=d){let u=o+l.border;if(e>=u&&t<=d-l.border&&l.node&&l.contentDOM&&this.contentDOM.contains(l.contentDOM))return l.parseRange(e,t,u);e=o;for(let p=a;p>0;p--){let m=this.children[p-1];if(m.size&&m.dom.parentNode==this.contentDOM&&!m.emptyChildAt(1)){i=kt(m.dom)+1;break}e-=m.size}i==-1&&(i=0)}if(i>-1&&(d>t||a==this.children.length-1)){t=d;for(let u=a+1;u<this.children.length;u++){let p=this.children[u];if(p.size&&p.dom.parentNode==this.contentDOM&&!p.emptyChildAt(-1)){r=kt(p.dom);break}t+=p.size}r==-1&&(r=this.contentDOM.childNodes.length);break}o=d}return{node:this.contentDOM,from:e,to:t,fromOffset:i,toOffset:r}}emptyChildAt(e){if(this.border||!this.contentDOM||!this.children.length)return!1;let t=this.children[e<0?0:this.children.length-1];return t.size==0||t.emptyChildAt(e)}domAfterPos(e){let{node:t,offset:s}=this.domFromPos(e,0);if(t.nodeType!=1||s==t.childNodes.length)throw new RangeError("No node after pos "+e);return t.childNodes[s]}setSelection(e,t,s,i=!1){let r=Math.min(e,t),o=Math.max(e,t);for(let m=0,b=0;m<this.children.length;m++){let g=this.children[m],x=b+g.size;if(r>b&&o<x)return g.setSelection(e-b-g.border,t-b-g.border,s,i);b=x}let a=this.domFromPos(e,e?-1:1),l=t==e?a:this.domFromPos(t,t?-1:1),d=s.getSelection(),u=!1;if((Tn||Pt)&&e==t){let{node:m,offset:b}=a;if(m.nodeType==3){if(u=!!(b&&m.nodeValue[b-1]==`
`),u&&b==m.nodeValue.length)for(let g=m,x;g;g=g.parentNode){if(x=g.nextSibling){x.nodeName=="BR"&&(a=l={node:x.parentNode,offset:kt(x)+1});break}let k=g.pmViewDesc;if(k&&k.node&&k.node.isBlock)break}}else{let g=m.childNodes[b-1];u=g&&(g.nodeName=="BR"||g.contentEditable=="false")}}if(Tn&&d.focusNode&&d.focusNode!=l.node&&d.focusNode.nodeType==1){let m=d.focusNode.childNodes[d.focusOffset];m&&m.contentEditable=="false"&&(i=!0)}if(!(i||u&&Pt)&&ni(a.node,a.offset,d.anchorNode,d.anchorOffset)&&ni(l.node,l.offset,d.focusNode,d.focusOffset))return;let p=!1;if((d.extend||e==t)&&!u){d.collapse(a.node,a.offset);try{e!=t&&d.extend(l.node,l.offset),p=!0}catch{}}if(!p){if(e>t){let b=a;a=l,l=b}let m=document.createRange();m.setEnd(l.node,l.offset),m.setStart(a.node,a.offset),d.removeAllRanges(),d.addRange(m)}}ignoreMutation(e){return!this.contentDOM&&e.type!="selection"}get contentLost(){return this.contentDOM&&this.contentDOM!=this.dom&&!this.dom.contains(this.contentDOM)}markDirty(e,t){for(let s=0,i=0;i<this.children.length;i++){let r=this.children[i],o=s+r.size;if(s==o?e<=o&&t>=s:e<o&&t>s){let a=s+r.border,l=o-r.border;if(e>=a&&t<=l){this.dirty=e==s||t==o?Gs:Hd,e==a&&t==l&&(r.contentLost||r.dom.parentNode!=this.contentDOM)?r.dirty=zn:r.markDirty(e-a,t-a);return}else r.dirty=r.dom==r.contentDOM&&r.dom.parentNode==this.contentDOM&&!r.children.length?Gs:zn}s=o}this.dirty=Gs}markParentsDirty(){let e=1;for(let t=this.parent;t;t=t.parent,e++){let s=e==1?Gs:Hd;t.dirty<s&&(t.dirty=s)}}get domAtom(){return!1}get ignoreForCoords(){return!1}isText(e){return!1}}class _p extends Pr{constructor(e,t,s,i){let r,o=t.type.toDOM;if(typeof o=="function"&&(o=o(s,()=>{if(!r)return i;if(r.parent)return r.parent.posBeforeChild(r)})),!t.type.spec.raw){if(o.nodeType!=1){let a=document.createElement("span");a.appendChild(o),o=a}o.contentEditable="false",o.classList.add("ProseMirror-widget")}super(e,[],o,null),this.widget=t,this.widget=t,r=this}matchesWidget(e){return this.dirty==dn&&e.type.eq(this.widget.type)}parseRule(){return{ignore:!0}}stopEvent(e){let t=this.widget.spec.stopEvent;return t?t(e):!1}ignoreMutation(e){return e.type!="selection"||this.widget.spec.ignoreSelection}destroy(){this.widget.type.destroy(this.dom),super.destroy()}get domAtom(){return!0}get side(){return this.widget.type.side}}class AC extends Pr{constructor(e,t,s,i){super(e,[],t,null),this.textDOM=s,this.text=i}get size(){return this.text.length}localPosFromDOM(e,t){return e!=this.textDOM?this.posAtStart+(t?this.size:0):this.posAtStart+t}domFromPos(e){return{node:this.textDOM,offset:e}}ignoreMutation(e){return e.type==="characterData"&&e.target.nodeValue==e.oldValue}}class si extends Pr{constructor(e,t,s,i){super(e,[],s,i),this.mark=t}static create(e,t,s,i){let r=i.nodeViews[t.type.name],o=r&&r(t,i,s);return(!o||!o.dom)&&(o=Vi.renderSpec(document,t.type.spec.toDOM(t,s),null,t.attrs)),new si(e,t,o.dom,o.contentDOM||o.dom)}parseRule(){return this.dirty&zn||this.mark.type.spec.reparseInView?null:{mark:this.mark.type.name,attrs:this.mark.attrs,contentElement:this.contentDOM}}matchesMark(e){return this.dirty!=zn&&this.mark.eq(e)}markDirty(e,t){if(super.markDirty(e,t),this.dirty!=dn){let s=this.parent;for(;!s.node;)s=s.parent;s.dirty<this.dirty&&(s.dirty=this.dirty),this.dirty=dn}}slice(e,t,s){let i=si.create(this.parent,this.mark,!0,s),r=this.children,o=this.size;t<o&&(r=ul(r,t,o,s)),e>0&&(r=ul(r,0,e,s));for(let a=0;a<r.length;a++)r[a].parent=i;return i.children=r,i}}class ks extends Pr{constructor(e,t,s,i,r,o,a,l,d){super(e,[],r,o),this.node=t,this.outerDeco=s,this.innerDeco=i,this.nodeDOM=a}static create(e,t,s,i,r,o){let a=r.nodeViews[t.type.name],l,d=a&&a(t,r,()=>{if(!l)return o;if(l.parent)return l.parent.posBeforeChild(l)},s,i),u=d&&d.dom,p=d&&d.contentDOM;if(t.isText){if(!u)u=document.createTextNode(t.text);else if(u.nodeType!=3)throw new RangeError("Text must be rendered as a DOM text node")}else u||({dom:u,contentDOM:p}=Vi.renderSpec(document,t.type.spec.toDOM(t),null,t.attrs));!p&&!t.isText&&u.nodeName!="BR"&&(u.hasAttribute("contenteditable")||(u.contentEditable="false"),t.type.spec.draggable&&(u.draggable=!0));let m=u;return u=Rp(u,s,t),d?l=new RC(e,t,s,i,u,p||null,m,d,r,o+1):t.isText?new ia(e,t,s,i,u,m,r):new ks(e,t,s,i,u,p||null,m,r,o+1)}parseRule(){if(this.node.type.spec.reparseInView)return null;let e={node:this.node.type.name,attrs:this.node.attrs};if(this.node.type.whitespace=="pre"&&(e.preserveWhitespace="full"),!this.contentDOM)e.getContent=()=>this.node.content;else if(!this.contentLost)e.contentElement=this.contentDOM;else{for(let t=this.children.length-1;t>=0;t--){let s=this.children[t];if(this.dom.contains(s.dom.parentNode)){e.contentElement=s.dom.parentNode;break}}e.contentElement||(e.getContent=()=>H.empty)}return e}matchesNode(e,t,s){return this.dirty==dn&&e.eq(this.node)&&dl(t,this.outerDeco)&&s.eq(this.innerDeco)}get size(){return this.node.nodeSize}get border(){return this.node.isLeaf?0:1}updateChildren(e,t){let s=this.node.inlineContent,i=t,r=e.composing?this.localCompositionInfo(e,t):null,o=r&&r.pos>-1?r:null,a=r&&r.pos<0,l=new jC(this,o&&o.node,e);FC(this.node,this.innerDeco,(d,u,p)=>{d.spec.marks?l.syncToMarks(d.spec.marks,s,e):d.type.side>=0&&!p&&l.syncToMarks(u==this.node.childCount?Pe.none:this.node.child(u).marks,s,e),l.placeWidget(d,e,i)},(d,u,p,m)=>{l.syncToMarks(d.marks,s,e);let b;l.findNodeMatch(d,u,p,m)||a&&e.state.selection.from>i&&e.state.selection.to<i+d.nodeSize&&(b=l.findIndexWithChild(r.node))>-1&&l.updateNodeAt(d,u,p,b,e)||l.updateNextNode(d,u,p,e,m,i)||l.addNode(d,u,p,e,i),i+=d.nodeSize}),l.syncToMarks([],s,e),this.node.isTextblock&&l.addTextblockHacks(),l.destroyRest(),(l.changed||this.dirty==Gs)&&(o&&this.protectLocalComposition(e,o),Ip(this.contentDOM,this.children,e),Pi&&BC(this.dom))}localCompositionInfo(e,t){let{from:s,to:i}=e.state.selection;if(!(e.state.selection instanceof Fe)||s<t||i>t+this.node.content.size)return null;let r=e.input.compositionNode;if(!r||!this.dom.contains(r.parentNode))return null;if(this.node.inlineContent){let o=r.nodeValue,a=LC(this.node.content,o,s-t,i-t);return a<0?null:{node:r,pos:a,text:o}}else return{node:r,pos:-1,text:""}}protectLocalComposition(e,{node:t,pos:s,text:i}){if(this.getDesc(t))return;let r=t;for(;r.parentNode!=this.contentDOM;r=r.parentNode){for(;r.previousSibling;)r.parentNode.removeChild(r.previousSibling);for(;r.nextSibling;)r.parentNode.removeChild(r.nextSibling);r.pmViewDesc&&(r.pmViewDesc=void 0)}let o=new AC(this,r,t,i);e.input.compositionNodes.push(o),this.children=ul(this.children,s,s+i.length,e,o)}update(e,t,s,i){return this.dirty==zn||!e.sameMarkup(this.node)?!1:(this.updateInner(e,t,s,i),!0)}updateInner(e,t,s,i){this.updateOuterDeco(t),this.node=e,this.innerDeco=s,this.contentDOM&&this.updateChildren(i,this.posAtStart),this.dirty=dn}updateOuterDeco(e){if(dl(e,this.outerDeco))return;let t=this.nodeDOM.nodeType!=1,s=this.dom;this.dom=Ap(this.dom,this.nodeDOM,cl(this.outerDeco,this.node,t),cl(e,this.node,t)),this.dom!=s&&(s.pmViewDesc=void 0,this.dom.pmViewDesc=this),this.outerDeco=e}selectNode(){this.nodeDOM.nodeType==1&&this.nodeDOM.classList.add("ProseMirror-selectednode"),(this.contentDOM||!this.node.type.spec.draggable)&&(this.dom.draggable=!0)}deselectNode(){this.nodeDOM.nodeType==1&&(this.nodeDOM.classList.remove("ProseMirror-selectednode"),(this.contentDOM||!this.node.type.spec.draggable)&&this.dom.removeAttribute("draggable"))}get domAtom(){return this.node.isAtom}}function qd(n,e,t,s,i){Rp(s,e,n);let r=new ks(void 0,n,e,t,s,s,s,i,0);return r.contentDOM&&r.updateChildren(i,0),r}class ia extends ks{constructor(e,t,s,i,r,o,a){super(e,t,s,i,r,null,o,a,0)}parseRule(){let e=this.nodeDOM.parentNode;for(;e&&e!=this.dom&&!e.pmIsDeco;)e=e.parentNode;return{skip:e||!0}}update(e,t,s,i){return this.dirty==zn||this.dirty!=dn&&!this.inParent()||!e.sameMarkup(this.node)?!1:(this.updateOuterDeco(t),(this.dirty!=dn||e.text!=this.node.text)&&e.text!=this.nodeDOM.nodeValue&&(this.nodeDOM.nodeValue=e.text,i.trackWrites==this.nodeDOM&&(i.trackWrites=null)),this.node=e,this.dirty=dn,!0)}inParent(){let e=this.parent.contentDOM;for(let t=this.nodeDOM;t;t=t.parentNode)if(t==e)return!0;return!1}domFromPos(e){return{node:this.nodeDOM,offset:e}}localPosFromDOM(e,t,s){return e==this.nodeDOM?this.posAtStart+Math.min(t,this.node.text.length):super.localPosFromDOM(e,t,s)}ignoreMutation(e){return e.type!="characterData"&&e.type!="selection"}slice(e,t,s){let i=this.node.cut(e,t),r=document.createTextNode(i.text);return new ia(this.parent,i,this.outerDeco,this.innerDeco,r,r,s)}markDirty(e,t){super.markDirty(e,t),this.dom!=this.nodeDOM&&(e==0||t==this.nodeDOM.nodeValue.length)&&(this.dirty=zn)}get domAtom(){return!1}isText(e){return this.node.text==e}}class Np extends Pr{parseRule(){return{ignore:!0}}matchesHack(e){return this.dirty==dn&&this.dom.nodeName==e}get domAtom(){return!0}get ignoreForCoords(){return this.dom.nodeName=="IMG"}}class RC extends ks{constructor(e,t,s,i,r,o,a,l,d,u){super(e,t,s,i,r,o,a,d,u),this.spec=l}update(e,t,s,i){if(this.dirty==zn)return!1;if(this.spec.update){let r=this.spec.update(e,t,s);return r&&this.updateInner(e,t,s,i),r}else return!this.contentDOM&&!e.isLeaf?!1:super.update(e,t,s,i)}selectNode(){this.spec.selectNode?this.spec.selectNode():super.selectNode()}deselectNode(){this.spec.deselectNode?this.spec.deselectNode():super.deselectNode()}setSelection(e,t,s,i){this.spec.setSelection?this.spec.setSelection(e,t,s):super.setSelection(e,t,s,i)}destroy(){this.spec.destroy&&this.spec.destroy(),super.destroy()}stopEvent(e){return this.spec.stopEvent?this.spec.stopEvent(e):!1}ignoreMutation(e){return this.spec.ignoreMutation?this.spec.ignoreMutation(e):super.ignoreMutation(e)}}function Ip(n,e,t){let s=n.firstChild,i=!1;for(let r=0;r<e.length;r++){let o=e[r],a=o.dom;if(a.parentNode==n){for(;a!=s;)s=$d(s),i=!0;s=s.nextSibling}else i=!0,n.insertBefore(a,s);if(o instanceof si){let l=s?s.previousSibling:n.lastChild;Ip(o.contentDOM,o.children,t),s=l?l.nextSibling:n.firstChild}}for(;s;)s=$d(s),i=!0;i&&t.trackWrites==n&&(t.trackWrites=null)}const lr=function(n){n&&(this.nodeName=n)};lr.prototype=Object.create(null);const Ws=[new lr];function cl(n,e,t){if(n.length==0)return Ws;let s=t?Ws[0]:new lr,i=[s];for(let r=0;r<n.length;r++){let o=n[r].type.attrs;if(o){o.nodeName&&i.push(s=new lr(o.nodeName));for(let a in o){let l=o[a];l!=null&&(t&&i.length==1&&i.push(s=new lr(e.isInline?"span":"div")),a=="class"?s.class=(s.class?s.class+" ":"")+l:a=="style"?s.style=(s.style?s.style+";":"")+l:a!="nodeName"&&(s[a]=l))}}}return i}function Ap(n,e,t,s){if(t==Ws&&s==Ws)return e;let i=e;for(let r=0;r<s.length;r++){let o=s[r],a=t[r];if(r){let l;a&&a.nodeName==o.nodeName&&i!=n&&(l=i.parentNode)&&l.nodeName.toLowerCase()==o.nodeName||(l=document.createElement(o.nodeName),l.pmIsDeco=!0,l.appendChild(i),a=Ws[0]),i=l}DC(i,a||Ws[0],o)}return i}function DC(n,e,t){for(let s in e)s!="class"&&s!="style"&&s!="nodeName"&&!(s in t)&&n.removeAttribute(s);for(let s in t)s!="class"&&s!="style"&&s!="nodeName"&&t[s]!=e[s]&&n.setAttribute(s,t[s]);if(e.class!=t.class){let s=e.class?e.class.split(" ").filter(Boolean):[],i=t.class?t.class.split(" ").filter(Boolean):[];for(let r=0;r<s.length;r++)i.indexOf(s[r])==-1&&n.classList.remove(s[r]);for(let r=0;r<i.length;r++)s.indexOf(i[r])==-1&&n.classList.add(i[r]);n.classList.length==0&&n.removeAttribute("class")}if(e.style!=t.style){if(e.style){let s=/\s*([\w\-\xa1-\uffff]+)\s*:(?:"(?:\\.|[^"])*"|'(?:\\.|[^'])*'|\(.*?\)|[^;])*/g,i;for(;i=s.exec(e.style);)n.style.removeProperty(i[1])}t.style&&(n.style.cssText+=t.style)}}function Rp(n,e,t){return Ap(n,n,Ws,cl(e,t,n.nodeType!=1))}function dl(n,e){if(n.length!=e.length)return!1;for(let t=0;t<n.length;t++)if(!n[t].type.eq(e[t].type))return!1;return!0}function $d(n){let e=n.nextSibling;return n.parentNode.removeChild(n),e}class jC{constructor(e,t,s){this.lock=t,this.view=s,this.index=0,this.stack=[],this.changed=!1,this.top=e,this.preMatch=OC(e.node.content,e)}destroyBetween(e,t){if(e!=t){for(let s=e;s<t;s++)this.top.children[s].destroy();this.top.children.splice(e,t-e),this.changed=!0}}destroyRest(){this.destroyBetween(this.index,this.top.children.length)}syncToMarks(e,t,s){let i=0,r=this.stack.length>>1,o=Math.min(r,e.length);for(;i<o&&(i==r-1?this.top:this.stack[i+1<<1]).matchesMark(e[i])&&e[i].type.spec.spanning!==!1;)i++;for(;i<r;)this.destroyRest(),this.top.dirty=dn,this.index=this.stack.pop(),this.top=this.stack.pop(),r--;for(;r<e.length;){this.stack.push(this.top,this.index+1);let a=-1;for(let l=this.index;l<Math.min(this.index+3,this.top.children.length);l++){let d=this.top.children[l];if(d.matchesMark(e[r])&&!this.isLocked(d.dom)){a=l;break}}if(a>-1)a>this.index&&(this.changed=!0,this.destroyBetween(this.index,a)),this.top=this.top.children[this.index];else{let l=si.create(this.top,e[r],t,s);this.top.children.splice(this.index,0,l),this.top=l,this.changed=!0}this.index=0,r++}}findNodeMatch(e,t,s,i){let r=-1,o;if(i>=this.preMatch.index&&(o=this.preMatch.matches[i-this.preMatch.index]).parent==this.top&&o.matchesNode(e,t,s))r=this.top.children.indexOf(o,this.index);else for(let a=this.index,l=Math.min(this.top.children.length,a+5);a<l;a++){let d=this.top.children[a];if(d.matchesNode(e,t,s)&&!this.preMatch.matched.has(d)){r=a;break}}return r<0?!1:(this.destroyBetween(this.index,r),this.index++,!0)}updateNodeAt(e,t,s,i,r){let o=this.top.children[i];return o.dirty==zn&&o.dom==o.contentDOM&&(o.dirty=Gs),o.update(e,t,s,r)?(this.destroyBetween(this.index,i),this.index++,!0):!1}findIndexWithChild(e){for(;;){let t=e.parentNode;if(!t)return-1;if(t==this.top.contentDOM){let s=e.pmViewDesc;if(s){for(let i=this.index;i<this.top.children.length;i++)if(this.top.children[i]==s)return i}return-1}e=t}}updateNextNode(e,t,s,i,r,o){for(let a=this.index;a<this.top.children.length;a++){let l=this.top.children[a];if(l instanceof ks){let d=this.preMatch.matched.get(l);if(d!=null&&d!=r)return!1;let u=l.dom,p,m=this.isLocked(u)&&!(e.isText&&l.node&&l.node.isText&&l.nodeDOM.nodeValue==e.text&&l.dirty!=zn&&dl(t,l.outerDeco));if(!m&&l.update(e,t,s,i))return this.destroyBetween(this.index,a),l.dom!=u&&(this.changed=!0),this.index++,!0;if(!m&&(p=this.recreateWrapper(l,e,t,s,i,o)))return this.top.children[this.index]=p,p.contentDOM&&(p.dirty=Gs,p.updateChildren(i,o+1),p.dirty=dn),this.changed=!0,this.index++,!0;break}}return!1}recreateWrapper(e,t,s,i,r,o){if(e.dirty||t.isAtom||!e.children.length||!e.node.content.eq(t.content))return null;let a=ks.create(this.top,t,s,i,r,o);if(a.contentDOM){a.children=e.children,e.children=[];for(let l of a.children)l.parent=a}return e.destroy(),a}addNode(e,t,s,i,r){let o=ks.create(this.top,e,t,s,i,r);o.contentDOM&&o.updateChildren(i,r+1),this.top.children.splice(this.index++,0,o),this.changed=!0}placeWidget(e,t,s){let i=this.index<this.top.children.length?this.top.children[this.index]:null;if(i&&i.matchesWidget(e)&&(e==i.widget||!i.widget.type.toDOM.parentNode))this.index++;else{let r=new _p(this.top,e,t,s);this.top.children.splice(this.index++,0,r),this.changed=!0}}addTextblockHacks(){let e=this.top.children[this.index-1],t=this.top;for(;e instanceof si;)t=e,e=t.children[t.children.length-1];(!e||!(e instanceof ia)||/\n$/.test(e.node.text)||this.view.requiresGeckoHackNode&&/\s$/.test(e.node.text))&&((Pt||Nt)&&e&&e.dom.contentEditable=="false"&&this.addHackNode("IMG",t),this.addHackNode("BR",this.top))}addHackNode(e,t){if(t==this.top&&this.index<t.children.length&&t.children[this.index].matchesHack(e))this.index++;else{let s=document.createElement(e);e=="IMG"&&(s.className="ProseMirror-separator",s.alt=""),e=="BR"&&(s.className="ProseMirror-trailingBreak");let i=new Np(this.top,[],s,null);t!=this.top?t.children.push(i):t.children.splice(this.index++,0,i),this.changed=!0}}isLocked(e){return this.lock&&(e==this.lock||e.nodeType==1&&e.contains(this.lock.parentNode))}}function OC(n,e){let t=e,s=t.children.length,i=n.childCount,r=new Map,o=[];e:for(;i>0;){let a;for(;;)if(s){let d=t.children[s-1];if(d instanceof si)t=d,s=d.children.length;else{a=d,s--;break}}else{if(t==e)break e;s=t.parent.children.indexOf(t),t=t.parent}let l=a.node;if(l){if(l!=n.child(i-1))break;--i,r.set(a,i),o.push(a)}}return{index:i,matched:r,matches:o.reverse()}}function PC(n,e){return n.type.side-e.type.side}function FC(n,e,t,s){let i=e.locals(n),r=0;if(i.length==0){for(let d=0;d<n.childCount;d++){let u=n.child(d);s(u,i,e.forChild(r,u),d),r+=u.nodeSize}return}let o=0,a=[],l=null;for(let d=0;;){let u,p;for(;o<i.length&&i[o].to==r;){let k=i[o++];k.widget&&(u?(p||(p=[u])).push(k):u=k)}if(u)if(p){p.sort(PC);for(let k=0;k<p.length;k++)t(p[k],d,!!l)}else t(u,d,!!l);let m,b;if(l)b=-1,m=l,l=null;else if(d<n.childCount)b=d,m=n.child(d++);else break;for(let k=0;k<a.length;k++)a[k].to<=r&&a.splice(k--,1);for(;o<i.length&&i[o].from<=r&&i[o].to>r;)a.push(i[o++]);let g=r+m.nodeSize;if(m.isText){let k=g;o<i.length&&i[o].from<k&&(k=i[o].from);for(let M=0;M<a.length;M++)a[M].to<k&&(k=a[M].to);k<g&&(l=m.cut(k-r),m=m.cut(0,k-r),g=k,b=-1)}else for(;o<i.length&&i[o].to<g;)o++;let x=m.isInline&&!m.isLeaf?a.filter(k=>!k.inline):a.slice();s(m,x,e.forChild(r,m),b),r=g}}function BC(n){if(n.nodeName=="UL"||n.nodeName=="OL"){let e=n.style.cssText;n.style.cssText=e+"; list-style: square !important",window.getComputedStyle(n).listStyle,n.style.cssText=e}}function LC(n,e,t,s){for(let i=0,r=0;i<n.childCount&&r<=s;){let o=n.child(i++),a=r;if(r+=o.nodeSize,!o.isText)continue;let l=o.text;for(;i<n.childCount;){let d=n.child(i++);if(r+=d.nodeSize,!d.isText)break;l+=d.text}if(r>=t){if(r>=s&&l.slice(s-e.length-a,s-a)==e)return s-e.length;let d=a<s?l.lastIndexOf(e,s-a-1):-1;if(d>=0&&d+e.length+a>=t)return a+d;if(t==s&&l.length>=s+e.length-a&&l.slice(s-a,s-a+e.length)==e)return s}}return-1}function ul(n,e,t,s,i){let r=[];for(let o=0,a=0;o<n.length;o++){let l=n[o],d=a,u=a+=l.size;d>=t||u<=e?r.push(l):(d<e&&r.push(l.slice(0,e-d,s)),i&&(r.push(i),i=void 0),u>t&&r.push(l.slice(t-d,l.size,s)))}return r}function bc(n,e=null){let t=n.domSelectionRange(),s=n.state.doc;if(!t.focusNode)return null;let i=n.docView.nearestDesc(t.focusNode),r=i&&i.size==0,o=n.docView.posFromDOM(t.focusNode,t.focusOffset,1);if(o<0)return null;let a=s.resolve(o),l,d;if(sa(t)){for(l=a;i&&!i.node;)i=i.parent;let u=i.node;if(i&&u.isAtom&&ue.isSelectable(u)&&i.parent&&!(u.isInline&&uC(t.focusNode,t.focusOffset,i.dom))){let p=i.posBefore;d=new ue(o==p?a:s.resolve(p))}}else{let u=n.docView.posFromDOM(t.anchorNode,t.anchorOffset,1);if(u<0)return null;l=s.resolve(u)}if(!d){let u=e=="pointer"||n.state.selection.head<a.pos&&!r?1:-1;d=Sc(n,l,a,u)}return d}function Dp(n){return n.editable?n.hasFocus():Op(n)&&document.activeElement&&document.activeElement.contains(n.dom)}function Zn(n,e=!1){let t=n.state.selection;if(jp(n,t),!!Dp(n)){if(!e&&n.input.mouseDown&&n.input.mouseDown.allowDefault&&Nt){let s=n.domSelectionRange(),i=n.domObserver.currentSelection;if(s.anchorNode&&i.anchorNode&&ni(s.anchorNode,s.anchorOffset,i.anchorNode,i.anchorOffset)){n.input.mouseDown.delayedSelectionSync=!0,n.domObserver.setCurSelection();return}}if(n.domObserver.disconnectSelection(),n.cursorWrapper)UC(n);else{let{anchor:s,head:i}=t,r,o;Kd&&!(t instanceof Fe)&&(t.$from.parent.inlineContent||(r=Jd(n,t.from)),!t.empty&&!t.$from.parent.inlineContent&&(o=Jd(n,t.to))),n.docView.setSelection(s,i,n.root,e),Kd&&(r&&Yd(r),o&&Yd(o)),t.visible?n.dom.classList.remove("ProseMirror-hideselection"):(n.dom.classList.add("ProseMirror-hideselection"),"onselectionchange"in document&&zC(n))}n.domObserver.setCurSelection(),n.domObserver.connectSelection()}}const Kd=Pt||Nt&&wp<63;function Jd(n,e){let{node:t,offset:s}=n.docView.domFromPos(e,0),i=s<t.childNodes.length?t.childNodes[s]:null,r=s?t.childNodes[s-1]:null;if(Pt&&i&&i.contentEditable=="false")return Ea(i);if((!i||i.contentEditable=="false")&&(!r||r.contentEditable=="false")){if(i)return Ea(i);if(r)return Ea(r)}}function Ea(n){return n.contentEditable="true",Pt&&n.draggable&&(n.draggable=!1,n.wasDraggable=!0),n}function Yd(n){n.contentEditable="false",n.wasDraggable&&(n.draggable=!0,n.wasDraggable=null)}function zC(n){let e=n.dom.ownerDocument;e.removeEventListener("selectionchange",n.input.hideSelectionGuard);let t=n.domSelectionRange(),s=t.anchorNode,i=t.anchorOffset;e.addEventListener("selectionchange",n.input.hideSelectionGuard=()=>{(t.anchorNode!=s||t.anchorOffset!=i)&&(e.removeEventListener("selectionchange",n.input.hideSelectionGuard),setTimeout(()=>{(!Dp(n)||n.state.selection.visible)&&n.dom.classList.remove("ProseMirror-hideselection")},20))})}function UC(n){let e=n.domSelection(),t=document.createRange(),s=n.cursorWrapper.dom,i=s.nodeName=="IMG";i?t.setEnd(s.parentNode,kt(s)+1):t.setEnd(s,0),t.collapse(!1),e.removeAllRanges(),e.addRange(t),!i&&!n.state.selection.visible&&Ut&&ws<=11&&(s.disabled=!0,s.disabled=!1)}function jp(n,e){if(e instanceof ue){let t=n.docView.descAt(e.from);t!=n.lastSelectedViewDesc&&(Qd(n),t&&t.selectNode(),n.lastSelectedViewDesc=t)}else Qd(n)}function Qd(n){n.lastSelectedViewDesc&&(n.lastSelectedViewDesc.parent&&n.lastSelectedViewDesc.deselectNode(),n.lastSelectedViewDesc=void 0)}function Sc(n,e,t,s){return n.someProp("createSelectionBetween",i=>i(n,e,t))||Fe.between(e,t,s)}function Xd(n){return n.editable&&!n.hasFocus()?!1:Op(n)}function Op(n){let e=n.domSelectionRange();if(!e.anchorNode)return!1;try{return n.dom.contains(e.anchorNode.nodeType==3?e.anchorNode.parentNode:e.anchorNode)&&(n.editable||n.dom.contains(e.focusNode.nodeType==3?e.focusNode.parentNode:e.focusNode))}catch{return!1}}function VC(n){let e=n.docView.domFromPos(n.state.selection.anchor,0),t=n.domSelectionRange();return ni(e.node,e.offset,t.anchorNode,t.anchorOffset)}function hl(n,e){let{$anchor:t,$head:s}=n.selection,i=e>0?t.max(s):t.min(s),r=i.parent.inlineContent?i.depth?n.doc.resolve(e>0?i.after():i.before()):null:i;return r&&Ne.findFrom(r,e)}function hs(n,e){return n.dispatch(n.state.tr.setSelection(e).scrollIntoView()),!0}function Zd(n,e,t){let s=n.state.selection;if(s instanceof Fe)if(t.indexOf("s")>-1){let{$head:i}=s,r=i.textOffset?null:e<0?i.nodeBefore:i.nodeAfter;if(!r||r.isText||!r.isLeaf)return!1;let o=n.state.doc.resolve(i.pos+r.nodeSize*(e<0?-1:1));return hs(n,new Fe(s.$anchor,o))}else if(s.empty){if(n.endOfTextblock(e>0?"forward":"backward")){let i=hl(n.state,e);return i&&i instanceof ue?hs(n,i):!1}else if(!(on&&t.indexOf("m")>-1)){let i=s.$head,r=i.textOffset?null:e<0?i.nodeBefore:i.nodeAfter,o;if(!r||r.isText)return!1;let a=e<0?i.pos-r.nodeSize:i.pos;return r.isAtom||(o=n.docView.descAt(a))&&!o.contentDOM?ue.isSelectable(r)?hs(n,new ue(e<0?n.state.doc.resolve(i.pos-r.nodeSize):i)):Or?hs(n,new Fe(n.state.doc.resolve(e<0?a:a+r.nodeSize))):!1:!1}}else return!1;else{if(s instanceof ue&&s.node.isInline)return hs(n,new Fe(e>0?s.$to:s.$from));{let i=hl(n.state,e);return i?hs(n,i):!1}}}function Do(n){return n.nodeType==3?n.nodeValue.length:n.childNodes.length}function cr(n,e){let t=n.pmViewDesc;return t&&t.size==0&&(e<0||n.nextSibling||n.nodeName!="BR")}function yi(n,e){return e<0?GC(n):WC(n)}function GC(n){let e=n.domSelectionRange(),t=e.focusNode,s=e.focusOffset;if(!t)return;let i,r,o=!1;for(Tn&&t.nodeType==1&&s<Do(t)&&cr(t.childNodes[s],-1)&&(o=!0);;)if(s>0){if(t.nodeType!=1)break;{let a=t.childNodes[s-1];if(cr(a,-1))i=t,r=--s;else if(a.nodeType==3)t=a,s=t.nodeValue.length;else break}}else{if(Pp(t))break;{let a=t.previousSibling;for(;a&&cr(a,-1);)i=t.parentNode,r=kt(a),a=a.previousSibling;if(a)t=a,s=Do(t);else{if(t=t.parentNode,t==n.dom)break;s=0}}}o?fl(n,t,s):i&&fl(n,i,r)}function WC(n){let e=n.domSelectionRange(),t=e.focusNode,s=e.focusOffset;if(!t)return;let i=Do(t),r,o;for(;;)if(s<i){if(t.nodeType!=1)break;let a=t.childNodes[s];if(cr(a,1))r=t,o=++s;else break}else{if(Pp(t))break;{let a=t.nextSibling;for(;a&&cr(a,1);)r=a.parentNode,o=kt(a)+1,a=a.nextSibling;if(a)t=a,s=0,i=Do(t);else{if(t=t.parentNode,t==n.dom)break;s=i=0}}}r&&fl(n,r,o)}function Pp(n){let e=n.pmViewDesc;return e&&e.node&&e.node.isBlock}function HC(n,e){for(;n&&e==n.childNodes.length&&!jr(n);)e=kt(n)+1,n=n.parentNode;for(;n&&e<n.childNodes.length;){let t=n.childNodes[e];if(t.nodeType==3)return t;if(t.nodeType==1&&t.contentEditable=="false")break;n=t,e=0}}function qC(n,e){for(;n&&!e&&!jr(n);)e=kt(n),n=n.parentNode;for(;n&&e;){let t=n.childNodes[e-1];if(t.nodeType==3)return t;if(t.nodeType==1&&t.contentEditable=="false")break;n=t,e=n.childNodes.length}}function fl(n,e,t){if(e.nodeType!=3){let r,o;(o=HC(e,t))?(e=o,t=0):(r=qC(e,t))&&(e=r,t=r.nodeValue.length)}let s=n.domSelection();if(sa(s)){let r=document.createRange();r.setEnd(e,t),r.setStart(e,t),s.removeAllRanges(),s.addRange(r)}else s.extend&&s.extend(e,t);n.domObserver.setCurSelection();let{state:i}=n;setTimeout(()=>{n.state==i&&Zn(n)},50)}function eu(n,e){let t=n.state.doc.resolve(e);if(!(Nt||pC)&&t.parent.inlineContent){let i=n.coordsAtPos(e);if(e>t.start()){let r=n.coordsAtPos(e-1),o=(r.top+r.bottom)/2;if(o>i.top&&o<i.bottom&&Math.abs(r.left-i.left)>1)return r.left<i.left?"ltr":"rtl"}if(e<t.end()){let r=n.coordsAtPos(e+1),o=(r.top+r.bottom)/2;if(o>i.top&&o<i.bottom&&Math.abs(r.left-i.left)>1)return r.left>i.left?"ltr":"rtl"}}return getComputedStyle(n.dom).direction=="rtl"?"rtl":"ltr"}function tu(n,e,t){let s=n.state.selection;if(s instanceof Fe&&!s.empty||t.indexOf("s")>-1||on&&t.indexOf("m")>-1)return!1;let{$from:i,$to:r}=s;if(!i.parent.inlineContent||n.endOfTextblock(e<0?"up":"down")){let o=hl(n.state,e);if(o&&o instanceof ue)return hs(n,o)}if(!i.parent.inlineContent){let o=e<0?i:r,a=s instanceof Yt?Ne.near(o,e):Ne.findFrom(o,e);return a?hs(n,a):!1}return!1}function nu(n,e){if(!(n.state.selection instanceof Fe))return!0;let{$head:t,$anchor:s,empty:i}=n.state.selection;if(!t.sameParent(s))return!0;if(!i)return!1;if(n.endOfTextblock(e>0?"forward":"backward"))return!0;let r=!t.textOffset&&(e<0?t.nodeBefore:t.nodeAfter);if(r&&!r.isText){let o=n.state.tr;return e<0?o.delete(t.pos-r.nodeSize,t.pos):o.delete(t.pos,t.pos+r.nodeSize),n.dispatch(o),!0}return!1}function su(n,e,t){n.domObserver.stop(),e.contentEditable=t,n.domObserver.start()}function $C(n){if(!Pt||n.state.selection.$head.parentOffset>0)return!1;let{focusNode:e,focusOffset:t}=n.domSelectionRange();if(e&&e.nodeType==1&&t==0&&e.firstChild&&e.firstChild.contentEditable=="false"){let s=e.firstChild;su(n,s,"true"),setTimeout(()=>su(n,s,"false"),20)}return!1}function KC(n){let e="";return n.ctrlKey&&(e+="c"),n.metaKey&&(e+="m"),n.altKey&&(e+="a"),n.shiftKey&&(e+="s"),e}function JC(n,e){let t=e.keyCode,s=KC(e);if(t==8||on&&t==72&&s=="c")return nu(n,-1)||yi(n,-1);if(t==46&&!e.shiftKey||on&&t==68&&s=="c")return nu(n,1)||yi(n,1);if(t==13||t==27)return!0;if(t==37||on&&t==66&&s=="c"){let i=t==37?eu(n,n.state.selection.from)=="ltr"?-1:1:-1;return Zd(n,i,s)||yi(n,i)}else if(t==39||on&&t==70&&s=="c"){let i=t==39?eu(n,n.state.selection.from)=="ltr"?1:-1:1;return Zd(n,i,s)||yi(n,i)}else{if(t==38||on&&t==80&&s=="c")return tu(n,-1,s)||yi(n,-1);if(t==40||on&&t==78&&s=="c")return $C(n)||tu(n,1,s)||yi(n,1);if(s==(on?"m":"c")&&(t==66||t==73||t==89||t==90))return!0}return!1}function Fp(n,e){n.someProp("transformCopied",b=>{e=b(e,n)});let t=[],{content:s,openStart:i,openEnd:r}=e;for(;i>1&&r>1&&s.childCount==1&&s.firstChild.childCount==1;){i--,r--;let b=s.firstChild;t.push(b.type.name,b.attrs!=b.type.defaultAttrs?b.attrs:null),s=b.content}let o=n.someProp("clipboardSerializer")||Vi.fromSchema(n.state.schema),a=Gp(),l=a.createElement("div");l.appendChild(o.serializeFragment(s,{document:a}));let d=l.firstChild,u,p=0;for(;d&&d.nodeType==1&&(u=Vp[d.nodeName.toLowerCase()]);){for(let b=u.length-1;b>=0;b--){let g=a.createElement(u[b]);for(;l.firstChild;)g.appendChild(l.firstChild);l.appendChild(g),p++}d=l.firstChild}d&&d.nodeType==1&&d.setAttribute("data-pm-slice",`${i} ${r}${p?` -${p}`:""} ${JSON.stringify(t)}`);let m=n.someProp("clipboardTextSerializer",b=>b(e,n))||e.content.textBetween(0,e.content.size,`

`);return{dom:l,text:m,slice:e}}function Bp(n,e,t,s,i){let r=i.parent.type.spec.code,o,a;if(!t&&!e)return null;let l=e&&(s||r||!t);if(l){if(n.someProp("transformPastedText",m=>{e=m(e,r||s,n)}),r)return e?new Q(H.from(n.state.schema.text(e.replace(/\r\n?/g,`
`))),0,0):Q.empty;let p=n.someProp("clipboardTextParser",m=>m(e,i,s,n));if(p)a=p;else{let m=i.marks(),{schema:b}=n.state,g=Vi.fromSchema(b);o=document.createElement("div"),e.split(/(?:\r\n?|\n)+/).forEach(x=>{let k=o.appendChild(document.createElement("p"));x&&k.appendChild(g.serializeNode(b.text(x,m)))})}}else n.someProp("transformPastedHTML",p=>{t=p(t,n)}),o=XC(t),Or&&ZC(o);let d=o&&o.querySelector("[data-pm-slice]"),u=d&&/^(\d+) (\d+)(?: -(\d+))? (.*)/.exec(d.getAttribute("data-pm-slice")||"");if(u&&u[3])for(let p=+u[3];p>0;p--){let m=o.firstChild;for(;m&&m.nodeType!=1;)m=m.nextSibling;if(!m)break;o=m}if(a||(a=(n.someProp("clipboardParser")||n.someProp("domParser")||xr.fromSchema(n.state.schema)).parseSlice(o,{preserveWhitespace:!!(l||u),context:i,ruleFromNode(m){return m.nodeName=="BR"&&!m.nextSibling&&m.parentNode&&!YC.test(m.parentNode.nodeName)?{ignore:!0}:null}})),u)a=eM(iu(a,+u[1],+u[2]),u[4]);else if(a=Q.maxOpen(QC(a.content,i),!0),a.openStart||a.openEnd){let p=0,m=0;for(let b=a.content.firstChild;p<a.openStart&&!b.type.spec.isolating;p++,b=b.firstChild);for(let b=a.content.lastChild;m<a.openEnd&&!b.type.spec.isolating;m++,b=b.lastChild);a=iu(a,p,m)}return n.someProp("transformPasted",p=>{a=p(a,n)}),a}const YC=/^(a|abbr|acronym|b|cite|code|del|em|i|ins|kbd|label|output|q|ruby|s|samp|span|strong|sub|sup|time|u|tt|var)$/i;function QC(n,e){if(n.childCount<2)return n;for(let t=e.depth;t>=0;t--){let i=e.node(t).contentMatchAt(e.index(t)),r,o=[];if(n.forEach(a=>{if(!o)return;let l=i.findWrapping(a.type),d;if(!l)return o=null;if(d=o.length&&r.length&&zp(l,r,a,o[o.length-1],0))o[o.length-1]=d;else{o.length&&(o[o.length-1]=Up(o[o.length-1],r.length));let u=Lp(a,l);o.push(u),i=i.matchType(u.type),r=l}}),o)return H.from(o)}return n}function Lp(n,e,t=0){for(let s=e.length-1;s>=t;s--)n=e[s].create(null,H.from(n));return n}function zp(n,e,t,s,i){if(i<n.length&&i<e.length&&n[i]==e[i]){let r=zp(n,e,t,s.lastChild,i+1);if(r)return s.copy(s.content.replaceChild(s.childCount-1,r));if(s.contentMatchAt(s.childCount).matchType(i==n.length-1?t.type:n[i+1]))return s.copy(s.content.append(H.from(Lp(t,n,i+1))))}}function Up(n,e){if(e==0)return n;let t=n.content.replaceChild(n.childCount-1,Up(n.lastChild,e-1)),s=n.contentMatchAt(n.childCount).fillBefore(H.empty,!0);return n.copy(t.append(s))}function pl(n,e,t,s,i,r){let o=e<0?n.firstChild:n.lastChild,a=o.content;return n.childCount>1&&(r=0),i<s-1&&(a=pl(a,e,t,s,i+1,r)),i>=t&&(a=e<0?o.contentMatchAt(0).fillBefore(a,r<=i).append(a):a.append(o.contentMatchAt(o.childCount).fillBefore(H.empty,!0))),n.replaceChild(e<0?0:n.childCount-1,o.copy(a))}function iu(n,e,t){return e<n.openStart&&(n=new Q(pl(n.content,-1,e,n.openStart,0,n.openEnd),e,n.openEnd)),t<n.openEnd&&(n=new Q(pl(n.content,1,t,n.openEnd,0,0),n.openStart,t)),n}const Vp={thead:["table"],tbody:["table"],tfoot:["table"],caption:["table"],colgroup:["table"],col:["table","colgroup"],tr:["table","tbody"],td:["table","tbody","tr"],th:["table","tbody","tr"]};let ru=null;function Gp(){return ru||(ru=document.implementation.createHTMLDocument("title"))}function XC(n){let e=/^(\s*<meta [^>]*>)*/.exec(n);e&&(n=n.slice(e[0].length));let t=Gp().createElement("div"),s=/<([a-z][^>\s]+)/i.exec(n),i;if((i=s&&Vp[s[1].toLowerCase()])&&(n=i.map(r=>"<"+r+">").join("")+n+i.map(r=>"</"+r+">").reverse().join("")),t.innerHTML=n,i)for(let r=0;r<i.length;r++)t=t.querySelector(i[r])||t;return t}function ZC(n){let e=n.querySelectorAll(Nt?"span:not([class]):not([style])":"span.Apple-converted-space");for(let t=0;t<e.length;t++){let s=e[t];s.childNodes.length==1&&s.textContent==""&&s.parentNode&&s.parentNode.replaceChild(n.ownerDocument.createTextNode(" "),s)}}function eM(n,e){if(!n.size)return n;let t=n.content.firstChild.type.schema,s;try{s=JSON.parse(e)}catch{return n}let{content:i,openStart:r,openEnd:o}=n;for(let a=s.length-2;a>=0;a-=2){let l=t.nodes[s[a]];if(!l||l.hasRequiredAttrs())break;i=H.from(l.create(s[a+1],i)),r++,o++}return new Q(i,r,o)}const Ft={},Bt={},tM={touchstart:!0,touchmove:!0};class nM{constructor(){this.shiftKey=!1,this.mouseDown=null,this.lastKeyCode=null,this.lastKeyCodeTime=0,this.lastClick={time:0,x:0,y:0,type:""},this.lastSelectionOrigin=null,this.lastSelectionTime=0,this.lastIOSEnter=0,this.lastIOSEnterFallbackTimeout=-1,this.lastFocus=0,this.lastTouch=0,this.lastAndroidDelete=0,this.composing=!1,this.compositionNode=null,this.composingTimeout=-1,this.compositionNodes=[],this.compositionEndedAt=-2e8,this.compositionID=1,this.compositionPendingChanges=0,this.domChangeCount=0,this.eventHandlers=Object.create(null),this.hideSelectionGuard=null}}function sM(n){for(let e in Ft){let t=Ft[e];n.dom.addEventListener(e,n.input.eventHandlers[e]=s=>{rM(n,s)&&!wc(n,s)&&(n.editable||!(s.type in Bt))&&t(n,s)},tM[e]?{passive:!0}:void 0)}Pt&&n.dom.addEventListener("input",()=>null),ml(n)}function bs(n,e){n.input.lastSelectionOrigin=e,n.input.lastSelectionTime=Date.now()}function iM(n){n.domObserver.stop();for(let e in n.input.eventHandlers)n.dom.removeEventListener(e,n.input.eventHandlers[e]);clearTimeout(n.input.composingTimeout),clearTimeout(n.input.lastIOSEnterFallbackTimeout)}function ml(n){n.someProp("handleDOMEvents",e=>{for(let t in e)n.input.eventHandlers[t]||n.dom.addEventListener(t,n.input.eventHandlers[t]=s=>wc(n,s))})}function wc(n,e){return n.someProp("handleDOMEvents",t=>{let s=t[e.type];return s?s(n,e)||e.defaultPrevented:!1})}function rM(n,e){if(!e.bubbles)return!0;if(e.defaultPrevented)return!1;for(let t=e.target;t!=n.dom;t=t.parentNode)if(!t||t.nodeType==11||t.pmViewDesc&&t.pmViewDesc.stopEvent(e))return!1;return!0}function oM(n,e){!wc(n,e)&&Ft[e.type]&&(n.editable||!(e.type in Bt))&&Ft[e.type](n,e)}Bt.keydown=(n,e)=>{let t=e;if(n.input.shiftKey=t.keyCode==16||t.shiftKey,!Hp(n,t)&&(n.input.lastKeyCode=t.keyCode,n.input.lastKeyCodeTime=Date.now(),!(Cn&&Nt&&t.keyCode==13)))if(t.keyCode!=229&&n.domObserver.forceFlush(),Pi&&t.keyCode==13&&!t.ctrlKey&&!t.altKey&&!t.metaKey){let s=Date.now();n.input.lastIOSEnter=s,n.input.lastIOSEnterFallbackTimeout=setTimeout(()=>{n.input.lastIOSEnter==s&&(n.someProp("handleKeyDown",i=>i(n,Us(13,"Enter"))),n.input.lastIOSEnter=0)},200)}else n.someProp("handleKeyDown",s=>s(n,t))||JC(n,t)?t.preventDefault():bs(n,"key")};Bt.keyup=(n,e)=>{e.keyCode==16&&(n.input.shiftKey=!1)};Bt.keypress=(n,e)=>{let t=e;if(Hp(n,t)||!t.charCode||t.ctrlKey&&!t.altKey||on&&t.metaKey)return;if(n.someProp("handleKeyPress",i=>i(n,t))){t.preventDefault();return}let s=n.state.selection;if(!(s instanceof Fe)||!s.$from.sameParent(s.$to)){let i=String.fromCharCode(t.charCode);!/[\r\n]/.test(i)&&!n.someProp("handleTextInput",r=>r(n,s.$from.pos,s.$to.pos,i))&&n.dispatch(n.state.tr.insertText(i).scrollIntoView()),t.preventDefault()}};function ra(n){return{left:n.clientX,top:n.clientY}}function aM(n,e){let t=e.x-n.clientX,s=e.y-n.clientY;return t*t+s*s<100}function kc(n,e,t,s,i){if(s==-1)return!1;let r=n.state.doc.resolve(s);for(let o=r.depth+1;o>0;o--)if(n.someProp(e,a=>o>r.depth?a(n,t,r.nodeAfter,r.before(o),i,!0):a(n,t,r.node(o),r.before(o),i,!1)))return!0;return!1}function vi(n,e,t){n.focused||n.focus();let s=n.state.tr.setSelection(e);s.setMeta("pointer",!0),n.dispatch(s)}function lM(n,e){if(e==-1)return!1;let t=n.state.doc.resolve(e),s=t.nodeAfter;return s&&s.isAtom&&ue.isSelectable(s)?(vi(n,new ue(t)),!0):!1}function cM(n,e){if(e==-1)return!1;let t=n.state.selection,s,i;t instanceof ue&&(s=t.node);let r=n.state.doc.resolve(e);for(let o=r.depth+1;o>0;o--){let a=o>r.depth?r.nodeAfter:r.node(o);if(ue.isSelectable(a)){s&&t.$from.depth>0&&o>=t.$from.depth&&r.before(t.$from.depth+1)==t.$from.pos?i=r.before(t.$from.depth):i=r.before(o);break}}return i!=null?(vi(n,ue.create(n.state.doc,i)),!0):!1}function dM(n,e,t,s,i){return kc(n,"handleClickOn",e,t,s)||n.someProp("handleClick",r=>r(n,e,s))||(i?cM(n,t):lM(n,t))}function uM(n,e,t,s){return kc(n,"handleDoubleClickOn",e,t,s)||n.someProp("handleDoubleClick",i=>i(n,e,s))}function hM(n,e,t,s){return kc(n,"handleTripleClickOn",e,t,s)||n.someProp("handleTripleClick",i=>i(n,e,s))||fM(n,t,s)}function fM(n,e,t){if(t.button!=0)return!1;let s=n.state.doc;if(e==-1)return s.inlineContent?(vi(n,Fe.create(s,0,s.content.size)),!0):!1;let i=s.resolve(e);for(let r=i.depth+1;r>0;r--){let o=r>i.depth?i.nodeAfter:i.node(r),a=i.before(r);if(o.inlineContent)vi(n,Fe.create(s,a+1,a+1+o.content.size));else if(ue.isSelectable(o))vi(n,ue.create(s,a));else continue;return!0}}function Cc(n){return jo(n)}const Wp=on?"metaKey":"ctrlKey";Ft.mousedown=(n,e)=>{let t=e;n.input.shiftKey=t.shiftKey;let s=Cc(n),i=Date.now(),r="singleClick";i-n.input.lastClick.time<500&&aM(t,n.input.lastClick)&&!t[Wp]&&(n.input.lastClick.type=="singleClick"?r="doubleClick":n.input.lastClick.type=="doubleClick"&&(r="tripleClick")),n.input.lastClick={time:i,x:t.clientX,y:t.clientY,type:r};let o=n.posAtCoords(ra(t));o&&(r=="singleClick"?(n.input.mouseDown&&n.input.mouseDown.done(),n.input.mouseDown=new pM(n,o,t,!!s)):(r=="doubleClick"?uM:hM)(n,o.pos,o.inside,t)?t.preventDefault():bs(n,"pointer"))};class pM{constructor(e,t,s,i){this.view=e,this.pos=t,this.event=s,this.flushed=i,this.delayedSelectionSync=!1,this.mightDrag=null,this.startDoc=e.state.doc,this.selectNode=!!s[Wp],this.allowDefault=s.shiftKey;let r,o;if(t.inside>-1)r=e.state.doc.nodeAt(t.inside),o=t.inside;else{let u=e.state.doc.resolve(t.pos);r=u.parent,o=u.depth?u.before():0}const a=i?null:s.target,l=a?e.docView.nearestDesc(a,!0):null;this.target=l&&l.dom.nodeType==1?l.dom:null;let{selection:d}=e.state;(s.button==0&&r.type.spec.draggable&&r.type.spec.selectable!==!1||d instanceof ue&&d.from<=o&&d.to>o)&&(this.mightDrag={node:r,pos:o,addAttr:!!(this.target&&!this.target.draggable),setUneditable:!!(this.target&&Tn&&!this.target.hasAttribute("contentEditable"))}),this.target&&this.mightDrag&&(this.mightDrag.addAttr||this.mightDrag.setUneditable)&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&(this.target.draggable=!0),this.mightDrag.setUneditable&&setTimeout(()=>{this.view.input.mouseDown==this&&this.target.setAttribute("contentEditable","false")},20),this.view.domObserver.start()),e.root.addEventListener("mouseup",this.up=this.up.bind(this)),e.root.addEventListener("mousemove",this.move=this.move.bind(this)),bs(e,"pointer")}done(){this.view.root.removeEventListener("mouseup",this.up),this.view.root.removeEventListener("mousemove",this.move),this.mightDrag&&this.target&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&this.target.removeAttribute("draggable"),this.mightDrag.setUneditable&&this.target.removeAttribute("contentEditable"),this.view.domObserver.start()),this.delayedSelectionSync&&setTimeout(()=>Zn(this.view)),this.view.input.mouseDown=null}up(e){if(this.done(),!this.view.dom.contains(e.target))return;let t=this.pos;this.view.state.doc!=this.startDoc&&(t=this.view.posAtCoords(ra(e))),this.updateAllowDefault(e),this.allowDefault||!t?bs(this.view,"pointer"):dM(this.view,t.pos,t.inside,e,this.selectNode)?e.preventDefault():e.button==0&&(this.flushed||Pt&&this.mightDrag&&!this.mightDrag.node.isAtom||Nt&&!this.view.state.selection.visible&&Math.min(Math.abs(t.pos-this.view.state.selection.from),Math.abs(t.pos-this.view.state.selection.to))<=2)?(vi(this.view,Ne.near(this.view.state.doc.resolve(t.pos))),e.preventDefault()):bs(this.view,"pointer")}move(e){this.updateAllowDefault(e),bs(this.view,"pointer"),e.buttons==0&&this.done()}updateAllowDefault(e){!this.allowDefault&&(Math.abs(this.event.x-e.clientX)>4||Math.abs(this.event.y-e.clientY)>4)&&(this.allowDefault=!0)}}Ft.touchstart=n=>{n.input.lastTouch=Date.now(),Cc(n),bs(n,"pointer")};Ft.touchmove=n=>{n.input.lastTouch=Date.now(),bs(n,"pointer")};Ft.contextmenu=n=>Cc(n);function Hp(n,e){return n.composing?!0:Pt&&Math.abs(e.timeStamp-n.input.compositionEndedAt)<500?(n.input.compositionEndedAt=-2e8,!0):!1}const mM=Cn?5e3:-1;Bt.compositionstart=Bt.compositionupdate=n=>{if(!n.composing){n.domObserver.flush();let{state:e}=n,t=e.selection.$from;if(e.selection.empty&&(e.storedMarks||!t.textOffset&&t.parentOffset&&t.nodeBefore.marks.some(s=>s.type.spec.inclusive===!1)))n.markCursor=n.state.storedMarks||t.marks(),jo(n,!0),n.markCursor=null;else if(jo(n),Tn&&e.selection.empty&&t.parentOffset&&!t.textOffset&&t.nodeBefore.marks.length){let s=n.domSelectionRange();for(let i=s.focusNode,r=s.focusOffset;i&&i.nodeType==1&&r!=0;){let o=r<0?i.lastChild:i.childNodes[r-1];if(!o)break;if(o.nodeType==3){n.domSelection().collapse(o,o.nodeValue.length);break}else i=o,r=-1}}n.input.composing=!0}qp(n,mM)};Bt.compositionend=(n,e)=>{n.composing&&(n.input.composing=!1,n.input.compositionEndedAt=e.timeStamp,n.input.compositionPendingChanges=n.domObserver.pendingRecords().length?n.input.compositionID:0,n.input.compositionNode=null,n.input.compositionPendingChanges&&Promise.resolve().then(()=>n.domObserver.flush()),n.input.compositionID++,qp(n,20))};function qp(n,e){clearTimeout(n.input.composingTimeout),e>-1&&(n.input.composingTimeout=setTimeout(()=>jo(n),e))}function $p(n){for(n.composing&&(n.input.composing=!1,n.input.compositionEndedAt=yM());n.input.compositionNodes.length>0;)n.input.compositionNodes.pop().markParentsDirty()}function gM(n){let e=n.domSelectionRange();if(!e.focusNode)return null;let t=cC(e.focusNode,e.focusOffset),s=dC(e.focusNode,e.focusOffset);if(t&&s&&t!=s){let i=s.pmViewDesc,r=n.domObserver.lastChangedTextNode;if(t==r||s==r)return r;if(!i||!i.isText(s.nodeValue))return s;if(n.input.compositionNode==s){let o=t.pmViewDesc;if(!(!o||!o.isText(t.nodeValue)))return s}}return t||s}function yM(){let n=document.createEvent("Event");return n.initEvent("event",!0,!0),n.timeStamp}function jo(n,e=!1){if(!(Cn&&n.domObserver.flushingSoon>=0)){if(n.domObserver.forceFlush(),$p(n),e||n.docView&&n.docView.dirty){let t=bc(n);return t&&!t.eq(n.state.selection)?n.dispatch(n.state.tr.setSelection(t)):n.updateState(n.state),!0}return!1}}function xM(n,e){if(!n.dom.parentNode)return;let t=n.dom.parentNode.appendChild(document.createElement("div"));t.appendChild(e),t.style.cssText="position: fixed; left: -10000px; top: 10px";let s=getSelection(),i=document.createRange();i.selectNodeContents(e),n.dom.blur(),s.removeAllRanges(),s.addRange(i),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t),n.focus()},50)}const wr=Ut&&ws<15||Pi&&mC<604;Ft.copy=Bt.cut=(n,e)=>{let t=e,s=n.state.selection,i=t.type=="cut";if(s.empty)return;let r=wr?null:t.clipboardData,o=s.content(),{dom:a,text:l}=Fp(n,o);r?(t.preventDefault(),r.clearData(),r.setData("text/html",a.innerHTML),r.setData("text/plain",l)):xM(n,a),i&&n.dispatch(n.state.tr.deleteSelection().scrollIntoView().setMeta("uiEvent","cut"))};function bM(n){return n.openStart==0&&n.openEnd==0&&n.content.childCount==1?n.content.firstChild:null}function SM(n,e){if(!n.dom.parentNode)return;let t=n.input.shiftKey||n.state.selection.$from.parent.type.spec.code,s=n.dom.parentNode.appendChild(document.createElement(t?"textarea":"div"));t||(s.contentEditable="true"),s.style.cssText="position: fixed; left: -10000px; top: 10px",s.focus();let i=n.input.shiftKey&&n.input.lastKeyCode!=45;setTimeout(()=>{n.focus(),s.parentNode&&s.parentNode.removeChild(s),t?kr(n,s.value,null,i,e):kr(n,s.textContent,s.innerHTML,i,e)},50)}function kr(n,e,t,s,i){let r=Bp(n,e,t,s,n.state.selection.$from);if(n.someProp("handlePaste",l=>l(n,i,r||Q.empty)))return!0;if(!r)return!1;let o=bM(r),a=o?n.state.tr.replaceSelectionWith(o,s):n.state.tr.replaceSelection(r);return n.dispatch(a.scrollIntoView().setMeta("paste",!0).setMeta("uiEvent","paste")),!0}function Kp(n){let e=n.getData("text/plain")||n.getData("Text");if(e)return e;let t=n.getData("text/uri-list");return t?t.replace(/\r?\n/g," "):""}Bt.paste=(n,e)=>{let t=e;if(n.composing&&!Cn)return;let s=wr?null:t.clipboardData,i=n.input.shiftKey&&n.input.lastKeyCode!=45;s&&kr(n,Kp(s),s.getData("text/html"),i,t)?t.preventDefault():SM(n,t)};class Jp{constructor(e,t,s){this.slice=e,this.move=t,this.node=s}}const Yp=on?"altKey":"ctrlKey";Ft.dragstart=(n,e)=>{let t=e,s=n.input.mouseDown;if(s&&s.done(),!t.dataTransfer)return;let i=n.state.selection,r=i.empty?null:n.posAtCoords(ra(t)),o;if(!(r&&r.pos>=i.from&&r.pos<=(i instanceof ue?i.to-1:i.to))){if(s&&s.mightDrag)o=ue.create(n.state.doc,s.mightDrag.pos);else if(t.target&&t.target.nodeType==1){let p=n.docView.nearestDesc(t.target,!0);p&&p.node.type.spec.draggable&&p!=n.docView&&(o=ue.create(n.state.doc,p.posBefore))}}let a=(o||n.state.selection).content(),{dom:l,text:d,slice:u}=Fp(n,a);(!t.dataTransfer.files.length||!Nt||wp>120)&&t.dataTransfer.clearData(),t.dataTransfer.setData(wr?"Text":"text/html",l.innerHTML),t.dataTransfer.effectAllowed="copyMove",wr||t.dataTransfer.setData("text/plain",d),n.dragging=new Jp(u,!t[Yp],o)};Ft.dragend=n=>{let e=n.dragging;window.setTimeout(()=>{n.dragging==e&&(n.dragging=null)},50)};Bt.dragover=Bt.dragenter=(n,e)=>e.preventDefault();Bt.drop=(n,e)=>{let t=e,s=n.dragging;if(n.dragging=null,!t.dataTransfer)return;let i=n.posAtCoords(ra(t));if(!i)return;let r=n.state.doc.resolve(i.pos),o=s&&s.slice;o?n.someProp("transformPasted",g=>{o=g(o,n)}):o=Bp(n,Kp(t.dataTransfer),wr?null:t.dataTransfer.getData("text/html"),!1,r);let a=!!(s&&!t[Yp]);if(n.someProp("handleDrop",g=>g(n,t,o||Q.empty,a))){t.preventDefault();return}if(!o)return;t.preventDefault();let l=o?Ek(n.state.doc,r.pos,o):r.pos;l==null&&(l=r.pos);let d=n.state.tr;if(a){let{node:g}=s;g?g.replace(d):d.deleteSelection()}let u=d.mapping.map(l),p=o.openStart==0&&o.openEnd==0&&o.content.childCount==1,m=d.doc;if(p?d.replaceRangeWith(u,u,o.content.firstChild):d.replaceRange(u,u,o),d.doc.eq(m))return;let b=d.doc.resolve(u);if(p&&ue.isSelectable(o.content.firstChild)&&b.nodeAfter&&b.nodeAfter.sameMarkup(o.content.firstChild))d.setSelection(new ue(b));else{let g=d.mapping.map(l);d.mapping.maps[d.mapping.maps.length-1].forEach((x,k,M,N)=>g=N),d.setSelection(Sc(n,b,d.doc.resolve(g)))}n.focus(),n.dispatch(d.setMeta("uiEvent","drop"))};Ft.focus=n=>{n.input.lastFocus=Date.now(),n.focused||(n.domObserver.stop(),n.dom.classList.add("ProseMirror-focused"),n.domObserver.start(),n.focused=!0,setTimeout(()=>{n.docView&&n.hasFocus()&&!n.domObserver.currentSelection.eq(n.domSelectionRange())&&Zn(n)},20))};Ft.blur=(n,e)=>{let t=e;n.focused&&(n.domObserver.stop(),n.dom.classList.remove("ProseMirror-focused"),n.domObserver.start(),t.relatedTarget&&n.dom.contains(t.relatedTarget)&&n.domObserver.currentSelection.clear(),n.focused=!1)};Ft.beforeinput=(n,e)=>{if(Nt&&Cn&&e.inputType=="deleteContentBackward"){n.domObserver.flushSoon();let{domChangeCount:s}=n.input;setTimeout(()=>{if(n.input.domChangeCount!=s||(n.dom.blur(),n.focus(),n.someProp("handleKeyDown",r=>r(n,Us(8,"Backspace")))))return;let{$cursor:i}=n.state.selection;i&&i.pos>0&&n.dispatch(n.state.tr.delete(i.pos-1,i.pos).scrollIntoView())},50)}};for(let n in Bt)Ft[n]=Bt[n];function Cr(n,e){if(n==e)return!0;for(let t in n)if(n[t]!==e[t])return!1;for(let t in e)if(!(t in n))return!1;return!0}class Oo{constructor(e,t){this.toDOM=e,this.spec=t||Js,this.side=this.spec.side||0}map(e,t,s,i){let{pos:r,deleted:o}=e.mapResult(t.from+i,this.side<0?-1:1);return o?null:new Kt(r-s,r-s,this)}valid(){return!0}eq(e){return this==e||e instanceof Oo&&(this.spec.key&&this.spec.key==e.spec.key||this.toDOM==e.toDOM&&Cr(this.spec,e.spec))}destroy(e){this.spec.destroy&&this.spec.destroy(e)}}class Cs{constructor(e,t){this.attrs=e,this.spec=t||Js}map(e,t,s,i){let r=e.map(t.from+i,this.spec.inclusiveStart?-1:1)-s,o=e.map(t.to+i,this.spec.inclusiveEnd?1:-1)-s;return r>=o?null:new Kt(r,o,this)}valid(e,t){return t.from<t.to}eq(e){return this==e||e instanceof Cs&&Cr(this.attrs,e.attrs)&&Cr(this.spec,e.spec)}static is(e){return e.type instanceof Cs}destroy(){}}class Mc{constructor(e,t){this.attrs=e,this.spec=t||Js}map(e,t,s,i){let r=e.mapResult(t.from+i,1);if(r.deleted)return null;let o=e.mapResult(t.to+i,-1);return o.deleted||o.pos<=r.pos?null:new Kt(r.pos-s,o.pos-s,this)}valid(e,t){let{index:s,offset:i}=e.content.findIndex(t.from),r;return i==t.from&&!(r=e.child(s)).isText&&i+r.nodeSize==t.to}eq(e){return this==e||e instanceof Mc&&Cr(this.attrs,e.attrs)&&Cr(this.spec,e.spec)}destroy(){}}class Kt{constructor(e,t,s){this.from=e,this.to=t,this.type=s}copy(e,t){return new Kt(e,t,this.type)}eq(e,t=0){return this.type.eq(e.type)&&this.from+t==e.from&&this.to+t==e.to}map(e,t,s){return this.type.map(e,this,t,s)}static widget(e,t,s){return new Kt(e,e,new Oo(t,s))}static inline(e,t,s,i){return new Kt(e,t,new Cs(s,i))}static node(e,t,s,i){return new Kt(e,t,new Mc(s,i))}get spec(){return this.type.spec}get inline(){return this.type instanceof Cs}get widget(){return this.type instanceof Oo}}const Si=[],Js={};class ut{constructor(e,t){this.local=e.length?e:Si,this.children=t.length?t:Si}static create(e,t){return t.length?Po(t,e,0,Js):Tt}find(e,t,s){let i=[];return this.findInner(e??0,t??1e9,i,0,s),i}findInner(e,t,s,i,r){for(let o=0;o<this.local.length;o++){let a=this.local[o];a.from<=t&&a.to>=e&&(!r||r(a.spec))&&s.push(a.copy(a.from+i,a.to+i))}for(let o=0;o<this.children.length;o+=3)if(this.children[o]<t&&this.children[o+1]>e){let a=this.children[o]+1;this.children[o+2].findInner(e-a,t-a,s,i+a,r)}}map(e,t,s){return this==Tt||e.maps.length==0?this:this.mapInner(e,t,0,0,s||Js)}mapInner(e,t,s,i,r){let o;for(let a=0;a<this.local.length;a++){let l=this.local[a].map(e,s,i);l&&l.type.valid(t,l)?(o||(o=[])).push(l):r.onRemove&&r.onRemove(this.local[a].spec)}return this.children.length?wM(this.children,o||[],e,t,s,i,r):o?new ut(o.sort(Ys),Si):Tt}add(e,t){return t.length?this==Tt?ut.create(e,t):this.addInner(e,t,0):this}addInner(e,t,s){let i,r=0;e.forEach((a,l)=>{let d=l+s,u;if(u=Xp(t,a,d)){for(i||(i=this.children.slice());r<i.length&&i[r]<l;)r+=3;i[r]==l?i[r+2]=i[r+2].addInner(a,u,d+1):i.splice(r,0,l,l+a.nodeSize,Po(u,a,d+1,Js)),r+=3}});let o=Qp(r?Zp(t):t,-s);for(let a=0;a<o.length;a++)o[a].type.valid(e,o[a])||o.splice(a--,1);return new ut(o.length?this.local.concat(o).sort(Ys):this.local,i||this.children)}remove(e){return e.length==0||this==Tt?this:this.removeInner(e,0)}removeInner(e,t){let s=this.children,i=this.local;for(let r=0;r<s.length;r+=3){let o,a=s[r]+t,l=s[r+1]+t;for(let u=0,p;u<e.length;u++)(p=e[u])&&p.from>a&&p.to<l&&(e[u]=null,(o||(o=[])).push(p));if(!o)continue;s==this.children&&(s=this.children.slice());let d=s[r+2].removeInner(o,a+1);d!=Tt?s[r+2]=d:(s.splice(r,3),r-=3)}if(i.length){for(let r=0,o;r<e.length;r++)if(o=e[r])for(let a=0;a<i.length;a++)i[a].eq(o,t)&&(i==this.local&&(i=this.local.slice()),i.splice(a--,1))}return s==this.children&&i==this.local?this:i.length||s.length?new ut(i,s):Tt}forChild(e,t){if(this==Tt)return this;if(t.isLeaf)return ut.empty;let s,i;for(let a=0;a<this.children.length;a+=3)if(this.children[a]>=e){this.children[a]==e&&(s=this.children[a+2]);break}let r=e+1,o=r+t.content.size;for(let a=0;a<this.local.length;a++){let l=this.local[a];if(l.from<o&&l.to>r&&l.type instanceof Cs){let d=Math.max(r,l.from)-r,u=Math.min(o,l.to)-r;d<u&&(i||(i=[])).push(l.copy(d,u))}}if(i){let a=new ut(i.sort(Ys),Si);return s?new ps([a,s]):a}return s||Tt}eq(e){if(this==e)return!0;if(!(e instanceof ut)||this.local.length!=e.local.length||this.children.length!=e.children.length)return!1;for(let t=0;t<this.local.length;t++)if(!this.local[t].eq(e.local[t]))return!1;for(let t=0;t<this.children.length;t+=3)if(this.children[t]!=e.children[t]||this.children[t+1]!=e.children[t+1]||!this.children[t+2].eq(e.children[t+2]))return!1;return!0}locals(e){return vc(this.localsInner(e))}localsInner(e){if(this==Tt)return Si;if(e.inlineContent||!this.local.some(Cs.is))return this.local;let t=[];for(let s=0;s<this.local.length;s++)this.local[s].type instanceof Cs||t.push(this.local[s]);return t}}ut.empty=new ut([],[]);ut.removeOverlap=vc;const Tt=ut.empty;class ps{constructor(e){this.members=e}map(e,t){const s=this.members.map(i=>i.map(e,t,Js));return ps.from(s)}forChild(e,t){if(t.isLeaf)return ut.empty;let s=[];for(let i=0;i<this.members.length;i++){let r=this.members[i].forChild(e,t);r!=Tt&&(r instanceof ps?s=s.concat(r.members):s.push(r))}return ps.from(s)}eq(e){if(!(e instanceof ps)||e.members.length!=this.members.length)return!1;for(let t=0;t<this.members.length;t++)if(!this.members[t].eq(e.members[t]))return!1;return!0}locals(e){let t,s=!0;for(let i=0;i<this.members.length;i++){let r=this.members[i].localsInner(e);if(r.length)if(!t)t=r;else{s&&(t=t.slice(),s=!1);for(let o=0;o<r.length;o++)t.push(r[o])}}return t?vc(s?t:t.sort(Ys)):Si}static from(e){switch(e.length){case 0:return Tt;case 1:return e[0];default:return new ps(e.every(t=>t instanceof ut)?e:e.reduce((t,s)=>t.concat(s instanceof ut?s:s.members),[]))}}}function wM(n,e,t,s,i,r,o){let a=n.slice();for(let d=0,u=r;d<t.maps.length;d++){let p=0;t.maps[d].forEach((m,b,g,x)=>{let k=x-g-(b-m);for(let M=0;M<a.length;M+=3){let N=a[M+1];if(N<0||m>N+u-p)continue;let A=a[M]+u-p;b>=A?a[M+1]=m<=A?-2:-1:m>=u&&k&&(a[M]+=k,a[M+1]+=k)}p+=k}),u=t.maps[d].map(u,-1)}let l=!1;for(let d=0;d<a.length;d+=3)if(a[d+1]<0){if(a[d+1]==-2){l=!0,a[d+1]=-1;continue}let u=t.map(n[d]+r),p=u-i;if(p<0||p>=s.content.size){l=!0;continue}let m=t.map(n[d+1]+r,-1),b=m-i,{index:g,offset:x}=s.content.findIndex(p),k=s.maybeChild(g);if(k&&x==p&&x+k.nodeSize==b){let M=a[d+2].mapInner(t,k,u+1,n[d]+r+1,o);M!=Tt?(a[d]=p,a[d+1]=b,a[d+2]=M):(a[d+1]=-2,l=!0)}else l=!0}if(l){let d=kM(a,n,e,t,i,r,o),u=Po(d,s,0,o);e=u.local;for(let p=0;p<a.length;p+=3)a[p+1]<0&&(a.splice(p,3),p-=3);for(let p=0,m=0;p<u.children.length;p+=3){let b=u.children[p];for(;m<a.length&&a[m]<b;)m+=3;a.splice(m,0,u.children[p],u.children[p+1],u.children[p+2])}}return new ut(e.sort(Ys),a)}function Qp(n,e){if(!e||!n.length)return n;let t=[];for(let s=0;s<n.length;s++){let i=n[s];t.push(new Kt(i.from+e,i.to+e,i.type))}return t}function kM(n,e,t,s,i,r,o){function a(l,d){for(let u=0;u<l.local.length;u++){let p=l.local[u].map(s,i,d);p?t.push(p):o.onRemove&&o.onRemove(l.local[u].spec)}for(let u=0;u<l.children.length;u+=3)a(l.children[u+2],l.children[u]+d+1)}for(let l=0;l<n.length;l+=3)n[l+1]==-1&&a(n[l+2],e[l]+r+1);return t}function Xp(n,e,t){if(e.isLeaf)return null;let s=t+e.nodeSize,i=null;for(let r=0,o;r<n.length;r++)(o=n[r])&&o.from>t&&o.to<s&&((i||(i=[])).push(o),n[r]=null);return i}function Zp(n){let e=[];for(let t=0;t<n.length;t++)n[t]!=null&&e.push(n[t]);return e}function Po(n,e,t,s){let i=[],r=!1;e.forEach((a,l)=>{let d=Xp(n,a,l+t);if(d){r=!0;let u=Po(d,a,t+l+1,s);u!=Tt&&i.push(l,l+a.nodeSize,u)}});let o=Qp(r?Zp(n):n,-t).sort(Ys);for(let a=0;a<o.length;a++)o[a].type.valid(e,o[a])||(s.onRemove&&s.onRemove(o[a].spec),o.splice(a--,1));return o.length||i.length?new ut(o,i):Tt}function Ys(n,e){return n.from-e.from||n.to-e.to}function vc(n){let e=n;for(let t=0;t<e.length-1;t++){let s=e[t];if(s.from!=s.to)for(let i=t+1;i<e.length;i++){let r=e[i];if(r.from==s.from){r.to!=s.to&&(e==n&&(e=n.slice()),e[i]=r.copy(r.from,s.to),ou(e,i+1,r.copy(s.to,r.to)));continue}else{r.from<s.to&&(e==n&&(e=n.slice()),e[t]=s.copy(s.from,r.from),ou(e,i,s.copy(r.from,s.to)));break}}}return e}function ou(n,e,t){for(;e<n.length&&Ys(t,n[e])>0;)e++;n.splice(e,0,t)}function _a(n){let e=[];return n.someProp("decorations",t=>{let s=t(n.state);s&&s!=Tt&&e.push(s)}),n.cursorWrapper&&e.push(ut.create(n.state.doc,[n.cursorWrapper.deco])),ps.from(e)}const CM={childList:!0,characterData:!0,characterDataOldValue:!0,attributes:!0,attributeOldValue:!0,subtree:!0},MM=Ut&&ws<=11;class vM{constructor(){this.anchorNode=null,this.anchorOffset=0,this.focusNode=null,this.focusOffset=0}set(e){this.anchorNode=e.anchorNode,this.anchorOffset=e.anchorOffset,this.focusNode=e.focusNode,this.focusOffset=e.focusOffset}clear(){this.anchorNode=this.focusNode=null}eq(e){return e.anchorNode==this.anchorNode&&e.anchorOffset==this.anchorOffset&&e.focusNode==this.focusNode&&e.focusOffset==this.focusOffset}}class TM{constructor(e,t){this.view=e,this.handleDOMChange=t,this.queue=[],this.flushingSoon=-1,this.observer=null,this.currentSelection=new vM,this.onCharData=null,this.suppressingSelectionUpdates=!1,this.lastChangedTextNode=null,this.observer=window.MutationObserver&&new window.MutationObserver(s=>{for(let i=0;i<s.length;i++)this.queue.push(s[i]);Ut&&ws<=11&&s.some(i=>i.type=="childList"&&i.removedNodes.length||i.type=="characterData"&&i.oldValue.length>i.target.nodeValue.length)?this.flushSoon():this.flush()}),MM&&(this.onCharData=s=>{this.queue.push({target:s.target,type:"characterData",oldValue:s.prevValue}),this.flushSoon()}),this.onSelectionChange=this.onSelectionChange.bind(this)}flushSoon(){this.flushingSoon<0&&(this.flushingSoon=window.setTimeout(()=>{this.flushingSoon=-1,this.flush()},20))}forceFlush(){this.flushingSoon>-1&&(window.clearTimeout(this.flushingSoon),this.flushingSoon=-1,this.flush())}start(){this.observer&&(this.observer.takeRecords(),this.observer.observe(this.view.dom,CM)),this.onCharData&&this.view.dom.addEventListener("DOMCharacterDataModified",this.onCharData),this.connectSelection()}stop(){if(this.observer){let e=this.observer.takeRecords();if(e.length){for(let t=0;t<e.length;t++)this.queue.push(e[t]);window.setTimeout(()=>this.flush(),20)}this.observer.disconnect()}this.onCharData&&this.view.dom.removeEventListener("DOMCharacterDataModified",this.onCharData),this.disconnectSelection()}connectSelection(){this.view.dom.ownerDocument.addEventListener("selectionchange",this.onSelectionChange)}disconnectSelection(){this.view.dom.ownerDocument.removeEventListener("selectionchange",this.onSelectionChange)}suppressSelectionUpdates(){this.suppressingSelectionUpdates=!0,setTimeout(()=>this.suppressingSelectionUpdates=!1,50)}onSelectionChange(){if(Xd(this.view)){if(this.suppressingSelectionUpdates)return Zn(this.view);if(Ut&&ws<=11&&!this.view.state.selection.empty){let e=this.view.domSelectionRange();if(e.focusNode&&ni(e.focusNode,e.focusOffset,e.anchorNode,e.anchorOffset))return this.flushSoon()}this.flush()}}setCurSelection(){this.currentSelection.set(this.view.domSelectionRange())}ignoreSelectionChange(e){if(!e.focusNode)return!0;let t=new Set,s;for(let r=e.focusNode;r;r=Sr(r))t.add(r);for(let r=e.anchorNode;r;r=Sr(r))if(t.has(r)){s=r;break}let i=s&&this.view.docView.nearestDesc(s);if(i&&i.ignoreMutation({type:"selection",target:s.nodeType==3?s.parentNode:s}))return this.setCurSelection(),!0}pendingRecords(){if(this.observer)for(let e of this.observer.takeRecords())this.queue.push(e);return this.queue}flush(){let{view:e}=this;if(!e.docView||this.flushingSoon>-1)return;let t=this.pendingRecords();t.length&&(this.queue=[]);let s=e.domSelectionRange(),i=!this.suppressingSelectionUpdates&&!this.currentSelection.eq(s)&&Xd(e)&&!this.ignoreSelectionChange(s),r=-1,o=-1,a=!1,l=[];if(e.editable)for(let u=0;u<t.length;u++){let p=this.registerMutation(t[u],l);p&&(r=r<0?p.from:Math.min(p.from,r),o=o<0?p.to:Math.max(p.to,o),p.typeOver&&(a=!0))}if(Tn&&l.length){let u=l.filter(p=>p.nodeName=="BR");if(u.length==2){let[p,m]=u;p.parentNode&&p.parentNode.parentNode==m.parentNode?m.remove():p.remove()}else{let{focusNode:p}=this.currentSelection;for(let m of u){let b=m.parentNode;b&&b.nodeName=="LI"&&(!p||NM(e,p)!=b)&&m.remove()}}}let d=null;r<0&&i&&e.input.lastFocus>Date.now()-200&&Math.max(e.input.lastTouch,e.input.lastClick.time)<Date.now()-300&&sa(s)&&(d=bc(e))&&d.eq(Ne.near(e.state.doc.resolve(0),1))?(e.input.lastFocus=0,Zn(e),this.currentSelection.set(s),e.scrollToSelection()):(r>-1||i)&&(r>-1&&(e.docView.markDirty(r,o),EM(e)),this.handleDOMChange(r,o,a,l),e.docView&&e.docView.dirty?e.updateState(e.state):this.currentSelection.eq(s)||Zn(e),this.currentSelection.set(s))}registerMutation(e,t){if(t.indexOf(e.target)>-1)return null;let s=this.view.docView.nearestDesc(e.target);if(e.type=="attributes"&&(s==this.view.docView||e.attributeName=="contenteditable"||e.attributeName=="style"&&!e.oldValue&&!e.target.getAttribute("style"))||!s||s.ignoreMutation(e))return null;if(e.type=="childList"){for(let u=0;u<e.addedNodes.length;u++){let p=e.addedNodes[u];t.push(p),p.nodeType==3&&(this.lastChangedTextNode=p)}if(s.contentDOM&&s.contentDOM!=s.dom&&!s.contentDOM.contains(e.target))return{from:s.posBefore,to:s.posAfter};let i=e.previousSibling,r=e.nextSibling;if(Ut&&ws<=11&&e.addedNodes.length)for(let u=0;u<e.addedNodes.length;u++){let{previousSibling:p,nextSibling:m}=e.addedNodes[u];(!p||Array.prototype.indexOf.call(e.addedNodes,p)<0)&&(i=p),(!m||Array.prototype.indexOf.call(e.addedNodes,m)<0)&&(r=m)}let o=i&&i.parentNode==e.target?kt(i)+1:0,a=s.localPosFromDOM(e.target,o,-1),l=r&&r.parentNode==e.target?kt(r):e.target.childNodes.length,d=s.localPosFromDOM(e.target,l,1);return{from:a,to:d}}else return e.type=="attributes"?{from:s.posAtStart-s.border,to:s.posAtEnd+s.border}:(this.lastChangedTextNode=e.target,{from:s.posAtStart,to:s.posAtEnd,typeOver:e.target.nodeValue==e.oldValue})}}let au=new WeakMap,lu=!1;function EM(n){if(!au.has(n)&&(au.set(n,null),["normal","nowrap","pre-line"].indexOf(getComputedStyle(n.dom).whiteSpace)!==-1)){if(n.requiresGeckoHackNode=Tn,lu)return;console.warn("ProseMirror expects the CSS white-space property to be set, preferably to 'pre-wrap'. It is recommended to load style/prosemirror.css from the prosemirror-view package."),lu=!0}}function cu(n,e){let t=e.startContainer,s=e.startOffset,i=e.endContainer,r=e.endOffset,o=n.domAtPos(n.state.selection.anchor);return ni(o.node,o.offset,i,r)&&([t,s,i,r]=[i,r,t,s]),{anchorNode:t,anchorOffset:s,focusNode:i,focusOffset:r}}function _M(n,e){if(e.getComposedRanges){let i=e.getComposedRanges(n.root)[0];if(i)return cu(n,i)}let t;function s(i){i.preventDefault(),i.stopImmediatePropagation(),t=i.getTargetRanges()[0]}return n.dom.addEventListener("beforeinput",s,!0),document.execCommand("indent"),n.dom.removeEventListener("beforeinput",s,!0),t?cu(n,t):null}function NM(n,e){for(let t=e.parentNode;t&&t!=n.dom;t=t.parentNode){let s=n.docView.nearestDesc(t,!0);if(s&&s.node.isBlock)return t}return null}function IM(n,e,t){let{node:s,fromOffset:i,toOffset:r,from:o,to:a}=n.docView.parseRange(e,t),l=n.domSelectionRange(),d,u=l.anchorNode;if(u&&n.dom.contains(u.nodeType==1?u:u.parentNode)&&(d=[{node:u,offset:l.anchorOffset}],sa(l)||d.push({node:l.focusNode,offset:l.focusOffset})),Nt&&n.input.lastKeyCode===8)for(let k=r;k>i;k--){let M=s.childNodes[k-1],N=M.pmViewDesc;if(M.nodeName=="BR"&&!N){r=k;break}if(!N||N.size)break}let p=n.state.doc,m=n.someProp("domParser")||xr.fromSchema(n.state.schema),b=p.resolve(o),g=null,x=m.parse(s,{topNode:b.parent,topMatch:b.parent.contentMatchAt(b.index()),topOpen:!0,from:i,to:r,preserveWhitespace:b.parent.type.whitespace=="pre"?"full":!0,findPositions:d,ruleFromNode:AM,context:b});if(d&&d[0].pos!=null){let k=d[0].pos,M=d[1]&&d[1].pos;M==null&&(M=k),g={anchor:k+o,head:M+o}}return{doc:x,sel:g,from:o,to:a}}function AM(n){let e=n.pmViewDesc;if(e)return e.parseRule();if(n.nodeName=="BR"&&n.parentNode){if(Pt&&/^(ul|ol)$/i.test(n.parentNode.nodeName)){let t=document.createElement("div");return t.appendChild(document.createElement("li")),{skip:t}}else if(n.parentNode.lastChild==n||Pt&&/^(tr|table)$/i.test(n.parentNode.nodeName))return{ignore:!0}}else if(n.nodeName=="IMG"&&n.getAttribute("mark-placeholder"))return{ignore:!0};return null}const RM=/^(a|abbr|acronym|b|bd[io]|big|br|button|cite|code|data(list)?|del|dfn|em|i|ins|kbd|label|map|mark|meter|output|q|ruby|s|samp|small|span|strong|su[bp]|time|u|tt|var)$/i;function DM(n,e,t,s,i){let r=n.input.compositionPendingChanges||(n.composing?n.input.compositionID:0);if(n.input.compositionPendingChanges=0,e<0){let I=n.input.lastSelectionTime>Date.now()-50?n.input.lastSelectionOrigin:null,q=bc(n,I);if(q&&!n.state.selection.eq(q)){if(Nt&&Cn&&n.input.lastKeyCode===13&&Date.now()-100<n.input.lastKeyCodeTime&&n.someProp("handleKeyDown",D=>D(n,Us(13,"Enter"))))return;let G=n.state.tr.setSelection(q);I=="pointer"?G.setMeta("pointer",!0):I=="key"&&G.scrollIntoView(),r&&G.setMeta("composition",r),n.dispatch(G)}return}let o=n.state.doc.resolve(e),a=o.sharedDepth(t);e=o.before(a+1),t=n.state.doc.resolve(t).after(a+1);let l=n.state.selection,d=IM(n,e,t),u=n.state.doc,p=u.slice(d.from,d.to),m,b;n.input.lastKeyCode===8&&Date.now()-100<n.input.lastKeyCodeTime?(m=n.state.selection.to,b="end"):(m=n.state.selection.from,b="start"),n.input.lastKeyCode=null;let g=PM(p.content,d.doc.content,d.from,m,b);if((Pi&&n.input.lastIOSEnter>Date.now()-225||Cn)&&i.some(I=>I.nodeType==1&&!RM.test(I.nodeName))&&(!g||g.endA>=g.endB)&&n.someProp("handleKeyDown",I=>I(n,Us(13,"Enter")))){n.input.lastIOSEnter=0;return}if(!g)if(s&&l instanceof Fe&&!l.empty&&l.$head.sameParent(l.$anchor)&&!n.composing&&!(d.sel&&d.sel.anchor!=d.sel.head))g={start:l.from,endA:l.to,endB:l.to};else{if(d.sel){let I=du(n,n.state.doc,d.sel);if(I&&!I.eq(n.state.selection)){let q=n.state.tr.setSelection(I);r&&q.setMeta("composition",r),n.dispatch(q)}}return}n.input.domChangeCount++,n.state.selection.from<n.state.selection.to&&g.start==g.endB&&n.state.selection instanceof Fe&&(g.start>n.state.selection.from&&g.start<=n.state.selection.from+2&&n.state.selection.from>=d.from?g.start=n.state.selection.from:g.endA<n.state.selection.to&&g.endA>=n.state.selection.to-2&&n.state.selection.to<=d.to&&(g.endB+=n.state.selection.to-g.endA,g.endA=n.state.selection.to)),Ut&&ws<=11&&g.endB==g.start+1&&g.endA==g.start&&g.start>d.from&&d.doc.textBetween(g.start-d.from-1,g.start-d.from+1)==" "&&(g.start--,g.endA--,g.endB--);let x=d.doc.resolveNoCache(g.start-d.from),k=d.doc.resolveNoCache(g.endB-d.from),M=u.resolve(g.start),N=x.sameParent(k)&&x.parent.inlineContent&&M.end()>=g.endA,A;if((Pi&&n.input.lastIOSEnter>Date.now()-225&&(!N||i.some(I=>I.nodeName=="DIV"||I.nodeName=="P"))||!N&&x.pos<d.doc.content.size&&!x.sameParent(k)&&(A=Ne.findFrom(d.doc.resolve(x.pos+1),1,!0))&&A.head==k.pos)&&n.someProp("handleKeyDown",I=>I(n,Us(13,"Enter")))){n.input.lastIOSEnter=0;return}if(n.state.selection.anchor>g.start&&OM(u,g.start,g.endA,x,k)&&n.someProp("handleKeyDown",I=>I(n,Us(8,"Backspace")))){Cn&&Nt&&n.domObserver.suppressSelectionUpdates();return}Nt&&Cn&&g.endB==g.start&&(n.input.lastAndroidDelete=Date.now()),Cn&&!N&&x.start()!=k.start()&&k.parentOffset==0&&x.depth==k.depth&&d.sel&&d.sel.anchor==d.sel.head&&d.sel.head==g.endA&&(g.endB-=2,k=d.doc.resolveNoCache(g.endB-d.from),setTimeout(()=>{n.someProp("handleKeyDown",function(I){return I(n,Us(13,"Enter"))})},20));let T=g.start,_=g.endA,j,P,B;if(N){if(x.pos==k.pos)Ut&&ws<=11&&x.parentOffset==0&&(n.domObserver.suppressSelectionUpdates(),setTimeout(()=>Zn(n),20)),j=n.state.tr.delete(T,_),P=u.resolve(g.start).marksAcross(u.resolve(g.endA));else if(g.endA==g.endB&&(B=jM(x.parent.content.cut(x.parentOffset,k.parentOffset),M.parent.content.cut(M.parentOffset,g.endA-M.start()))))j=n.state.tr,B.type=="add"?j.addMark(T,_,B.mark):j.removeMark(T,_,B.mark);else if(x.parent.child(x.index()).isText&&x.index()==k.index()-(k.textOffset?0:1)){let I=x.parent.textBetween(x.parentOffset,k.parentOffset);if(n.someProp("handleTextInput",q=>q(n,T,_,I)))return;j=n.state.tr.insertText(I,T,_)}}if(j||(j=n.state.tr.replace(T,_,d.doc.slice(g.start-d.from,g.endB-d.from))),d.sel){let I=du(n,j.doc,d.sel);I&&!(Nt&&Cn&&n.composing&&I.empty&&(g.start!=g.endB||n.input.lastAndroidDelete<Date.now()-100)&&(I.head==T||I.head==j.mapping.map(_)-1)||Ut&&I.empty&&I.head==T)&&j.setSelection(I)}P&&j.ensureMarks(P),r&&j.setMeta("composition",r),n.dispatch(j.scrollIntoView())}function du(n,e,t){return Math.max(t.anchor,t.head)>e.content.size?null:Sc(n,e.resolve(t.anchor),e.resolve(t.head))}function jM(n,e){let t=n.firstChild.marks,s=e.firstChild.marks,i=t,r=s,o,a,l;for(let u=0;u<s.length;u++)i=s[u].removeFromSet(i);for(let u=0;u<t.length;u++)r=t[u].removeFromSet(r);if(i.length==1&&r.length==0)a=i[0],o="add",l=u=>u.mark(a.addToSet(u.marks));else if(i.length==0&&r.length==1)a=r[0],o="remove",l=u=>u.mark(a.removeFromSet(u.marks));else return null;let d=[];for(let u=0;u<e.childCount;u++)d.push(l(e.child(u)));if(H.from(d).eq(n))return{mark:a,type:o}}function OM(n,e,t,s,i){if(t-e<=i.pos-s.pos||Na(s,!0,!1)<i.pos)return!1;let r=n.resolve(e);if(!s.parent.isTextblock){let a=r.nodeAfter;return a!=null&&t==e+a.nodeSize}if(r.parentOffset<r.parent.content.size||!r.parent.isTextblock)return!1;let o=n.resolve(Na(r,!0,!0));return!o.parent.isTextblock||o.pos>t||Na(o,!0,!1)<t?!1:s.parent.content.cut(s.parentOffset).eq(o.parent.content)}function Na(n,e,t){let s=n.depth,i=e?n.end():n.pos;for(;s>0&&(e||n.indexAfter(s)==n.node(s).childCount);)s--,i++,e=!1;if(t){let r=n.node(s).maybeChild(n.indexAfter(s));for(;r&&!r.isLeaf;)r=r.firstChild,i++}return i}function PM(n,e,t,s,i){let r=n.findDiffStart(e,t);if(r==null)return null;let{a:o,b:a}=n.findDiffEnd(e,t+n.size,t+e.size);if(i=="end"){let l=Math.max(0,r-Math.min(o,a));s-=o+l-r}if(o<r&&n.size<e.size){let l=s<=r&&s>=o?r-s:0;r-=l,r&&r<e.size&&uu(e.textBetween(r-1,r+1))&&(r+=l?1:-1),a=r+(a-o),o=r}else if(a<r){let l=s<=r&&s>=a?r-s:0;r-=l,r&&r<n.size&&uu(n.textBetween(r-1,r+1))&&(r+=l?1:-1),o=r+(o-a),a=r}return{start:r,endA:o,endB:a}}function uu(n){if(n.length!=2)return!1;let e=n.charCodeAt(0),t=n.charCodeAt(1);return e>=56320&&e<=57343&&t>=55296&&t<=56319}class FM{constructor(e,t){this._root=null,this.focused=!1,this.trackWrites=null,this.mounted=!1,this.markCursor=null,this.cursorWrapper=null,this.lastSelectedViewDesc=void 0,this.input=new nM,this.prevDirectPlugins=[],this.pluginViews=[],this.requiresGeckoHackNode=!1,this.dragging=null,this._props=t,this.state=t.state,this.directPlugins=t.plugins||[],this.directPlugins.forEach(gu),this.dispatch=this.dispatch.bind(this),this.dom=e&&e.mount||document.createElement("div"),e&&(e.appendChild?e.appendChild(this.dom):typeof e=="function"?e(this.dom):e.mount&&(this.mounted=!0)),this.editable=pu(this),fu(this),this.nodeViews=mu(this),this.docView=qd(this.state.doc,hu(this),_a(this),this.dom,this),this.domObserver=new TM(this,(s,i,r,o)=>DM(this,s,i,r,o)),this.domObserver.start(),sM(this),this.updatePluginViews()}get composing(){return this.input.composing}get props(){if(this._props.state!=this.state){let e=this._props;this._props={};for(let t in e)this._props[t]=e[t];this._props.state=this.state}return this._props}update(e){e.handleDOMEvents!=this._props.handleDOMEvents&&ml(this);let t=this._props;this._props=e,e.plugins&&(e.plugins.forEach(gu),this.directPlugins=e.plugins),this.updateStateInner(e.state,t)}setProps(e){let t={};for(let s in this._props)t[s]=this._props[s];t.state=this.state;for(let s in e)t[s]=e[s];this.update(t)}updateState(e){this.updateStateInner(e,this._props)}updateStateInner(e,t){var s;let i=this.state,r=!1,o=!1;e.storedMarks&&this.composing&&($p(this),o=!0),this.state=e;let a=i.plugins!=e.plugins||this._props.plugins!=t.plugins;if(a||this._props.plugins!=t.plugins||this._props.nodeViews!=t.nodeViews){let b=mu(this);LM(b,this.nodeViews)&&(this.nodeViews=b,r=!0)}(a||t.handleDOMEvents!=this._props.handleDOMEvents)&&ml(this),this.editable=pu(this),fu(this);let l=_a(this),d=hu(this),u=i.plugins!=e.plugins&&!i.doc.eq(e.doc)?"reset":e.scrollToSelection>i.scrollToSelection?"to selection":"preserve",p=r||!this.docView.matchesNode(e.doc,d,l);(p||!e.selection.eq(i.selection))&&(o=!0);let m=u=="preserve"&&o&&this.dom.style.overflowAnchor==null&&xC(this);if(o){this.domObserver.stop();let b=p&&(Ut||Nt)&&!this.composing&&!i.selection.empty&&!e.selection.empty&&BM(i.selection,e.selection);if(p){let g=Nt?this.trackWrites=this.domSelectionRange().focusNode:null;this.composing&&(this.input.compositionNode=gM(this)),(r||!this.docView.update(e.doc,d,l,this))&&(this.docView.updateOuterDeco(d),this.docView.destroy(),this.docView=qd(e.doc,d,l,this.dom,this)),g&&!this.trackWrites&&(b=!0)}b||!(this.input.mouseDown&&this.domObserver.currentSelection.eq(this.domSelectionRange())&&VC(this))?Zn(this,b):(jp(this,e.selection),this.domObserver.setCurSelection()),this.domObserver.start()}this.updatePluginViews(i),!((s=this.dragging)===null||s===void 0)&&s.node&&!i.doc.eq(e.doc)&&this.updateDraggedNode(this.dragging,i),u=="reset"?this.dom.scrollTop=0:u=="to selection"?this.scrollToSelection():m&&bC(m)}scrollToSelection(){let e=this.domSelectionRange().focusNode;if(!this.someProp("handleScrollToSelection",t=>t(this)))if(this.state.selection instanceof ue){let t=this.docView.domAfterPos(this.state.selection.from);t.nodeType==1&&zd(this,t.getBoundingClientRect(),e)}else zd(this,this.coordsAtPos(this.state.selection.head,1),e)}destroyPluginViews(){let e;for(;e=this.pluginViews.pop();)e.destroy&&e.destroy()}updatePluginViews(e){if(!e||e.plugins!=this.state.plugins||this.directPlugins!=this.prevDirectPlugins){this.prevDirectPlugins=this.directPlugins,this.destroyPluginViews();for(let t=0;t<this.directPlugins.length;t++){let s=this.directPlugins[t];s.spec.view&&this.pluginViews.push(s.spec.view(this))}for(let t=0;t<this.state.plugins.length;t++){let s=this.state.plugins[t];s.spec.view&&this.pluginViews.push(s.spec.view(this))}}else for(let t=0;t<this.pluginViews.length;t++){let s=this.pluginViews[t];s.update&&s.update(this,e)}}updateDraggedNode(e,t){let s=e.node,i=-1;if(this.state.doc.nodeAt(s.from)==s.node)i=s.from;else{let r=s.from+(this.state.doc.content.size-t.doc.content.size);(r>0&&this.state.doc.nodeAt(r))==s.node&&(i=r)}this.dragging=new Jp(e.slice,e.move,i<0?void 0:ue.create(this.state.doc,i))}someProp(e,t){let s=this._props&&this._props[e],i;if(s!=null&&(i=t?t(s):s))return i;for(let o=0;o<this.directPlugins.length;o++){let a=this.directPlugins[o].props[e];if(a!=null&&(i=t?t(a):a))return i}let r=this.state.plugins;if(r)for(let o=0;o<r.length;o++){let a=r[o].props[e];if(a!=null&&(i=t?t(a):a))return i}}hasFocus(){if(Ut){let e=this.root.activeElement;if(e==this.dom)return!0;if(!e||!this.dom.contains(e))return!1;for(;e&&this.dom!=e&&this.dom.contains(e);){if(e.contentEditable=="false")return!1;e=e.parentElement}return!0}return this.root.activeElement==this.dom}focus(){this.domObserver.stop(),this.editable&&SC(this.dom),Zn(this),this.domObserver.start()}get root(){let e=this._root;if(e==null){for(let t=this.dom.parentNode;t;t=t.parentNode)if(t.nodeType==9||t.nodeType==11&&t.host)return t.getSelection||(Object.getPrototypeOf(t).getSelection=()=>t.ownerDocument.getSelection()),this._root=t}return e||document}updateRoot(){this._root=null}posAtCoords(e){return vC(this,e)}coordsAtPos(e,t=1){return Tp(this,e,t)}domAtPos(e,t=0){return this.docView.domFromPos(e,t)}nodeDOM(e){let t=this.docView.descAt(e);return t?t.nodeDOM:null}posAtDOM(e,t,s=-1){let i=this.docView.posFromDOM(e,t,s);if(i==null)throw new RangeError("DOM position not inside the editor");return i}endOfTextblock(e,t){return IC(this,t||this.state,e)}pasteHTML(e,t){return kr(this,"",e,!1,t||new ClipboardEvent("paste"))}pasteText(e,t){return kr(this,e,null,!0,t||new ClipboardEvent("paste"))}destroy(){this.docView&&(iM(this),this.destroyPluginViews(),this.mounted?(this.docView.update(this.state.doc,[],_a(this),this),this.dom.textContent=""):this.dom.parentNode&&this.dom.parentNode.removeChild(this.dom),this.docView.destroy(),this.docView=null,aC())}get isDestroyed(){return this.docView==null}dispatchEvent(e){return oM(this,e)}dispatch(e){let t=this._props.dispatchTransaction;t?t.call(this,e):this.updateState(this.state.apply(e))}domSelectionRange(){let e=this.domSelection();return Pt&&this.root.nodeType===11&&hC(this.dom.ownerDocument)==this.dom&&_M(this,e)||e}domSelection(){return this.root.getSelection()}}function hu(n){let e=Object.create(null);return e.class="ProseMirror",e.contenteditable=String(n.editable),n.someProp("attributes",t=>{if(typeof t=="function"&&(t=t(n.state)),t)for(let s in t)s=="class"?e.class+=" "+t[s]:s=="style"?e.style=(e.style?e.style+";":"")+t[s]:!e[s]&&s!="contenteditable"&&s!="nodeName"&&(e[s]=String(t[s]))}),e.translate||(e.translate="no"),[Kt.node(0,n.state.doc.content.size,e)]}function fu(n){if(n.markCursor){let e=document.createElement("img");e.className="ProseMirror-separator",e.setAttribute("mark-placeholder","true"),e.setAttribute("alt",""),n.cursorWrapper={dom:e,deco:Kt.widget(n.state.selection.head,e,{raw:!0,marks:n.markCursor})}}else n.cursorWrapper=null}function pu(n){return!n.someProp("editable",e=>e(n.state)===!1)}function BM(n,e){let t=Math.min(n.$anchor.sharedDepth(n.head),e.$anchor.sharedDepth(e.head));return n.$anchor.start(t)!=e.$anchor.start(t)}function mu(n){let e=Object.create(null);function t(s){for(let i in s)Object.prototype.hasOwnProperty.call(e,i)||(e[i]=s[i])}return n.someProp("nodeViews",t),n.someProp("markViews",t),e}function LM(n,e){let t=0,s=0;for(let i in n){if(n[i]!=e[i])return!0;t++}for(let i in e)s++;return t!=s}function gu(n){if(n.spec.state||n.spec.filterTransaction||n.spec.appendTransaction)throw new RangeError("Plugins passed directly to the view must not have a state component")}const tr=new oi("placeholderPlugin");function zM(n){return new _s({key:tr,state:{init(){return{placeholder:n}},apply(e,t){return e.getMeta(tr)?{placeholder:e.getMeta(tr).placeholder}:t}},props:{decorations(e){var i;const{doc:t}=e;if(t.childCount===1&&((i=t.firstChild)==null?void 0:i.isTextblock)&&t.firstChild.content.size===0){const r=[],{placeholder:o}=tr.getState(e);return e.doc.descendants((a,l)=>{const d=Kt.node(l,l+a.nodeSize,{class:"placeholder","data-placeholder":o});r.push(d)}),ut.create(t,r)}}}})}const Tc="command_token",UM={group:"inline",inline:!0,atom:!0,content:"text*",attrs:{id:"",hint:""},selectable:!1,draggable:!1,toDOM:n=>["span",{"data-mention-id":n.attrs.id,"data-mention-hint":n.attrs.hint,class:"hint-pill"},n.attrs.hint],parseDOM:[{tag:"span[data-mention-id][data-mention-hint]",getAttrs:n=>{const e=n.getAttribute("data-mention-id"),t=n.getAttribute("data-mention-hint");return{id:e,hint:t}}}]};function VM(n){if(n.depth===0)return;const e=n.before(),s=n.doc.textBetween(e,n.pos,`
`,"\0").match(new RegExp(/(^|\s)\/(\w*)$/));if(s&&s.index!==void 0){const i=s[0].startsWith(" ")?s.index+1:s.index,r=s[0].startsWith(" ")?s[0].length-1:s[0].length,o=n.start()+i,a=o+r;return{range:{from:o,to:a},queryText:s[2]}}}const gl=new oi("slashCommandPlugin");function yu(){return{queryText:"",active:!1,range:void 0}}function GM(n,e,t,s){const i=n.state.schema.nodes[Tc].create({...e},n.state.schema.text(e.hint)),r=n.state.tr.replaceWith(t.from,t.to,i);s&&r.insertText(" ",t.from+i.nodeSize),n.dispatch(r)}function xu(n){const{active:e,range:t,queryText:s,onHintMatch:i}=n;if(i)return i(!e||!t?void 0:{text:s,range:t})}function WM(n){const e=[];return n.descendants(t=>{var s;t.type.name===Tc&&typeof((s=t.attrs)==null?void 0:s.id)=="string"&&e.push(t.attrs.id)}),e}function HM(){return new _s({key:gl,state:{init(){return yu()},apply(n,e){const t=n.getMeta(gl),s=n.selection,i=s.$from,r=VM(i),o={...yu(),...e,...t};return s.from!==s.to?(xu(o),o):(o.active=!!r,r&&(o.queryText=r.queryText,o.range=r.range),xu(o),o)}}})}class oa extends hg{constructor(e){super(),this.view=e}isEmpty(){return!this.view.state.doc.textContent}trimLeadingText(e){const s=this.view.state.tr;let i=!1,r=!1;return s.doc.descendants((o,a)=>{var l;i||!o.isText||(i=!0,(l=o.text)!=null&&l.startsWith(e)&&(r=!0,s.insertText(o.text.replace(e,""),a,a+o.text.length)))}),r&&this.view.dispatch(s),r}replaceAll(e,t){const i=this.view.state.tr,r=[];i.doc.descendants((o,a)=>{!o.isText||o.text===void 0||r.push({node:o,pos:a})}),r.reverse(),r.forEach(({node:o,pos:a})=>{!o.isText||o.text===void 0||o.text.includes(e)&&i.insertText(o.text.replaceAll(e,t),a,a+o.text.length)}),this.view.dispatch(i)}appendText(e){this.view.dispatch(this.view.state.tr.insertText(e))}focus(){this.view.dom.focus()}setText(e){const{tr:t,schema:s}=this.view.state,i=e?s.nodes.paragraph.create(null,s.text(e)):s.nodes.paragraph.create();this.view.dispatch(t.replaceWith(0,this.view.state.doc.content.size,i)),this.view.hasFocus()&&this.view.dispatch(this.view.state.tr.setSelection(Fe.atEnd(this.view.state.doc)))}getCurrentText(){return this.view.state.doc.textContent}getContentToSend(){return iC(this.view)}resize(){}isReady(){return!!this.view.state.doc}setPlaceholder(e){this.view.dispatch(this.view.state.tr.setMeta(tr,{placeholder:e}))}getSelectionStart(){return this.view.state.selection.ranges[0].$from.pos}isMenuSelectorActive(){return Mi.getState(this.view.state).active}registerKeyHandlers(e){zk(this.view,e)}acceptLegacyKeydown(){return!1}subscribe(e,t){var s;if(e==="change"){const i=()=>t(void 0);return Pd(this.view,i)}return(s=this.view.dom)==null||s.addEventListener(e,t),()=>{var i;(i=this.view.dom)==null||i.removeEventListener(e,t)}}useState(e){return S.useSyncExternalStore(t=>Pd(this.view,t),()=>e(this))}getSystemHints(){const e=WM(this.view.state.tr.doc);return e.length?[e[0]]:[]}canShowAutocompletion(){return!this.isMenuSelectorActive()&&!this.getSystemHints().length}}const qM=typeof navigator<"u"?/Mac|iP(hone|[oa]d)/.test(navigator.platform):!1;function $M(n){let e=n.split(/-(?!$)/),t=e[e.length-1];t=="Space"&&(t=" ");let s,i,r,o;for(let a=0;a<e.length-1;a++){let l=e[a];if(/^(cmd|meta|m)$/i.test(l))o=!0;else if(/^a(lt)?$/i.test(l))s=!0;else if(/^(c|ctrl|control)$/i.test(l))i=!0;else if(/^s(hift)?$/i.test(l))r=!0;else if(/^mod$/i.test(l))qM?o=!0:i=!0;else throw new Error("Unrecognized modifier name: "+l)}return s&&(t="Alt-"+t),i&&(t="Ctrl-"+t),o&&(t="Meta-"+t),r&&(t="Shift-"+t),t}function KM(n){let e=Object.create(null);for(let t in n)e[$M(t)]=n[t];return e}function Ia(n,e,t=!0){return e.altKey&&(n="Alt-"+n),e.ctrlKey&&(n="Ctrl-"+n),e.metaKey&&(n="Meta-"+n),t&&e.shiftKey&&(n="Shift-"+n),n}function yl(n){return new _s({props:{handleKeyDown:em(n)}})}function em(n){let e=KM(n);return function(t,s){let i=fg(s),r,o=e[Ia(i,s)];if(o&&o(t.state,t.dispatch,t))return!0;if(i.length==1&&i!=" "){if(s.shiftKey){let a=e[Ia(i,s,!1)];if(a&&a(t.state,t.dispatch,t))return!0}if((s.shiftKey||s.altKey||s.metaKey||i.charCodeAt(0)>127)&&(r=pg[s.keyCode])&&r!=i){let a=e[Ia(r,s)];if(a&&a(t.state,t.dispatch,t))return!0}}return!1}}class rt extends Ne{constructor(e){super(e,e)}map(e,t){let s=e.resolve(t.map(this.head));return rt.valid(s)?new rt(s):Ne.near(s)}content(){return Q.empty}eq(e){return e instanceof rt&&e.head==this.head}toJSON(){return{type:"gapcursor",pos:this.head}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for GapCursor.fromJSON");return new rt(e.resolve(t.pos))}getBookmark(){return new Ec(this.anchor)}static valid(e){let t=e.parent;if(t.isTextblock||!JM(e)||!YM(e))return!1;let s=t.type.spec.allowGapCursor;if(s!=null)return s;let i=t.contentMatchAt(e.index()).defaultType;return i&&i.isTextblock}static findGapCursorFrom(e,t,s=!1){e:for(;;){if(!s&&rt.valid(e))return e;let i=e.pos,r=null;for(let o=e.depth;;o--){let a=e.node(o);if(t>0?e.indexAfter(o)<a.childCount:e.index(o)>0){r=a.child(t>0?e.indexAfter(o):e.index(o)-1);break}else if(o==0)return null;i+=t;let l=e.doc.resolve(i);if(rt.valid(l))return l}for(;;){let o=t>0?r.firstChild:r.lastChild;if(!o){if(r.isAtom&&!r.isText&&!ue.isSelectable(r)){e=e.doc.resolve(i+r.nodeSize*t),s=!1;continue e}break}r=o,i+=t;let a=e.doc.resolve(i);if(rt.valid(a))return a}return null}}}rt.prototype.visible=!1;rt.findFrom=rt.findGapCursorFrom;Ne.jsonID("gapcursor",rt);class Ec{constructor(e){this.pos=e}map(e){return new Ec(e.map(this.pos))}resolve(e){let t=e.resolve(this.pos);return rt.valid(t)?new rt(t):Ne.near(t)}}function JM(n){for(let e=n.depth;e>=0;e--){let t=n.index(e),s=n.node(e);if(t==0){if(s.type.spec.isolating)return!0;continue}for(let i=s.child(t-1);;i=i.lastChild){if(i.childCount==0&&!i.inlineContent||i.isAtom||i.type.spec.isolating)return!0;if(i.inlineContent)return!1}}return!0}function YM(n){for(let e=n.depth;e>=0;e--){let t=n.indexAfter(e),s=n.node(e);if(t==s.childCount){if(s.type.spec.isolating)return!0;continue}for(let i=s.child(t);;i=i.firstChild){if(i.childCount==0&&!i.inlineContent||i.isAtom||i.type.spec.isolating)return!0;if(i.inlineContent)return!1}}return!0}function QM(){return new _s({props:{decorations:tv,createSelectionBetween(n,e,t){return e.pos==t.pos&&rt.valid(t)?new rt(t):null},handleClick:ZM,handleKeyDown:XM,handleDOMEvents:{beforeinput:ev}}})}const XM=em({ArrowLeft:$r("horiz",-1),ArrowRight:$r("horiz",1),ArrowUp:$r("vert",-1),ArrowDown:$r("vert",1)});function $r(n,e){const t=n=="vert"?e>0?"down":"up":e>0?"right":"left";return function(s,i,r){let o=s.selection,a=e>0?o.$to:o.$from,l=o.empty;if(o instanceof Fe){if(!r.endOfTextblock(t)||a.depth==0)return!1;l=!1,a=s.doc.resolve(e>0?a.after():a.before())}let d=rt.findGapCursorFrom(a,e,l);return d?(i&&i(s.tr.setSelection(new rt(d))),!0):!1}}function ZM(n,e,t){if(!n||!n.editable)return!1;let s=n.state.doc.resolve(e);if(!rt.valid(s))return!1;let i=n.posAtCoords({left:t.clientX,top:t.clientY});return i&&i.inside>-1&&ue.isSelectable(n.state.doc.nodeAt(i.inside))?!1:(n.dispatch(n.state.tr.setSelection(new rt(s))),!0)}function ev(n,e){if(e.inputType!="insertCompositionText"||!(n.state.selection instanceof rt))return!1;let{$from:t}=n.state.selection,s=t.parent.contentMatchAt(t.index()).findWrapping(n.state.schema.nodes.text);if(!s)return!1;let i=H.empty;for(let o=s.length-1;o>=0;o--)i=H.from(s[o].createAndFill(null,i));let r=n.state.tr.replace(t.pos,t.pos,new Q(i,0,0));return r.setSelection(Fe.near(r.doc.resolve(t.pos+1))),n.dispatch(r),!1}function tv(n){if(!(n.selection instanceof rt))return null;let e=document.createElement("div");return e.className="ProseMirror-gapcursor",ut.create(n.doc,[Kt.widget(n.selection.head,e,{key:"gapcursor"})])}const nv=500;class Mn{constructor(e,t){this.items=e,this.eventCount=t}popEvent(e,t){if(this.eventCount==0)return null;let s=this.items.length;for(;;s--)if(this.items.get(s-1).selection){--s;break}let i,r;t&&(i=this.remapping(s,this.items.length),r=i.maps.length);let o=e.tr,a,l,d=[],u=[];return this.items.forEach((p,m)=>{if(!p.step){i||(i=this.remapping(s,m+1),r=i.maps.length),r--,u.push(p);return}if(i){u.push(new Rn(p.map));let b=p.step.map(i.slice(r)),g;b&&o.maybeStep(b).doc&&(g=o.mapping.maps[o.mapping.maps.length-1],d.push(new Rn(g,void 0,void 0,d.length+u.length))),r--,g&&i.appendMap(g,r)}else o.maybeStep(p.step);if(p.selection)return a=i?p.selection.map(i.slice(r)):p.selection,l=new Mn(this.items.slice(0,s).append(u.reverse().concat(d)),this.eventCount-1),!1},this.items.length,0),{remaining:l,transform:o,selection:a}}addTransform(e,t,s,i){let r=[],o=this.eventCount,a=this.items,l=!i&&a.length?a.get(a.length-1):null;for(let u=0;u<e.steps.length;u++){let p=e.steps[u].invert(e.docs[u]),m=new Rn(e.mapping.maps[u],p,t),b;(b=l&&l.merge(m))&&(m=b,u?r.pop():a=a.slice(0,a.length-1)),r.push(m),t&&(o++,t=void 0),i||(l=m)}let d=o-s.depth;return d>iv&&(a=sv(a,d),o-=d),new Mn(a.append(r),o)}remapping(e,t){let s=new ki;return this.items.forEach((i,r)=>{let o=i.mirrorOffset!=null&&r-i.mirrorOffset>=e?s.maps.length-i.mirrorOffset:void 0;s.appendMap(i.map,o)},e,t),s}addMaps(e){return this.eventCount==0?this:new Mn(this.items.append(e.map(t=>new Rn(t))),this.eventCount)}rebased(e,t){if(!this.eventCount)return this;let s=[],i=Math.max(0,this.items.length-t),r=e.mapping,o=e.steps.length,a=this.eventCount;this.items.forEach(m=>{m.selection&&a--},i);let l=t;this.items.forEach(m=>{let b=r.getMirror(--l);if(b==null)return;o=Math.min(o,b);let g=r.maps[b];if(m.step){let x=e.steps[b].invert(e.docs[b]),k=m.selection&&m.selection.map(r.slice(l+1,b));k&&a++,s.push(new Rn(g,x,k))}else s.push(new Rn(g))},i);let d=[];for(let m=t;m<o;m++)d.push(new Rn(r.maps[m]));let u=this.items.slice(0,i).append(d).append(s),p=new Mn(u,a);return p.emptyItemCount()>nv&&(p=p.compress(this.items.length-s.length)),p}emptyItemCount(){let e=0;return this.items.forEach(t=>{t.step||e++}),e}compress(e=this.items.length){let t=this.remapping(0,e),s=t.maps.length,i=[],r=0;return this.items.forEach((o,a)=>{if(a>=e)i.push(o),o.selection&&r++;else if(o.step){let l=o.step.map(t.slice(s)),d=l&&l.getMap();if(s--,d&&t.appendMap(d,s),l){let u=o.selection&&o.selection.map(t.slice(s));u&&r++;let p=new Rn(d.invert(),l,u),m,b=i.length-1;(m=i.length&&i[b].merge(p))?i[b]=m:i.push(p)}}else o.map&&s--},this.items.length,0),new Mn(xh.from(i.reverse()),r)}}Mn.empty=new Mn(xh.empty,0);function sv(n,e){let t;return n.forEach((s,i)=>{if(s.selection&&e--==0)return t=i,!1}),n.slice(t)}class Rn{constructor(e,t,s,i){this.map=e,this.step=t,this.selection=s,this.mirrorOffset=i}merge(e){if(this.step&&e.step&&!e.selection){let t=e.step.merge(this.step);if(t)return new Rn(t.getMap().invert(),t,this.selection)}}}class fs{constructor(e,t,s,i,r){this.done=e,this.undone=t,this.prevRanges=s,this.prevTime=i,this.prevComposition=r}}const iv=20;function rv(n,e,t,s){let i=t.getMeta(Qs),r;if(i)return i.historyState;t.getMeta(lv)&&(n=new fs(n.done,n.undone,null,0,-1));let o=t.getMeta("appendedTransaction");if(t.steps.length==0)return n;if(o&&o.getMeta(Qs))return o.getMeta(Qs).redo?new fs(n.done.addTransform(t,void 0,s,ro(e)),n.undone,bu(t.mapping.maps),n.prevTime,n.prevComposition):new fs(n.done,n.undone.addTransform(t,void 0,s,ro(e)),null,n.prevTime,n.prevComposition);if(t.getMeta("addToHistory")!==!1&&!(o&&o.getMeta("addToHistory")===!1)){let a=t.getMeta("composition"),l=n.prevTime==0||!o&&n.prevComposition!=a&&(n.prevTime<(t.time||0)-s.newGroupDelay||!ov(t,n.prevRanges)),d=o?Aa(n.prevRanges,t.mapping):bu(t.mapping.maps);return new fs(n.done.addTransform(t,l?e.selection.getBookmark():void 0,s,ro(e)),Mn.empty,d,t.time,a??n.prevComposition)}else return(r=t.getMeta("rebased"))?new fs(n.done.rebased(t,r),n.undone.rebased(t,r),Aa(n.prevRanges,t.mapping),n.prevTime,n.prevComposition):new fs(n.done.addMaps(t.mapping.maps),n.undone.addMaps(t.mapping.maps),Aa(n.prevRanges,t.mapping),n.prevTime,n.prevComposition)}function ov(n,e){if(!e)return!1;if(!n.docChanged)return!0;let t=!1;return n.mapping.maps[0].forEach((s,i)=>{for(let r=0;r<e.length;r+=2)s<=e[r+1]&&i>=e[r]&&(t=!0)}),t}function bu(n){let e=[];for(let t=n.length-1;t>=0&&e.length==0;t--)n[t].forEach((s,i,r,o)=>e.push(r,o));return e}function Aa(n,e){if(!n)return null;let t=[];for(let s=0;s<n.length;s+=2){let i=e.map(n[s],1),r=e.map(n[s+1],-1);i<=r&&t.push(i,r)}return t}function av(n,e,t){let s=ro(e),i=Qs.get(e).spec.config,r=(t?n.undone:n.done).popEvent(e,s);if(!r)return null;let o=r.selection.resolve(r.transform.doc),a=(t?n.done:n.undone).addTransform(r.transform,e.selection.getBookmark(),i,s),l=new fs(t?a:r.remaining,t?r.remaining:a,null,0,-1);return r.transform.setSelection(o).setMeta(Qs,{redo:t,historyState:l})}let Ra=!1,Su=null;function ro(n){let e=n.plugins;if(Su!=e){Ra=!1,Su=e;for(let t=0;t<e.length;t++)if(e[t].spec.historyPreserveItems){Ra=!0;break}}return Ra}const Qs=new oi("history"),lv=new oi("closeHistory");function cv(n={}){return n={depth:n.depth||100,newGroupDelay:n.newGroupDelay||500},new _s({key:Qs,state:{init(){return new fs(Mn.empty,Mn.empty,null,0,-1)},apply(e,t,s){return rv(t,s,e,n)}},config:n,props:{handleDOMEvents:{beforeinput(e,t){let s=t.inputType,i=s=="historyUndo"?nm:s=="historyRedo"?xl:null;return i?(t.preventDefault(),i(e.state,e.dispatch)):!1}}}})}function tm(n,e){return(t,s)=>{let i=Qs.getState(t);if(!i||(n?i.undone:i.done).eventCount==0)return!1;if(s){let r=av(i,t,n);r&&s(e?r.scrollIntoView():r)}return!0}}const nm=tm(!1,!0),xl=tm(!0,!0);function dv(){return yl({"Shift-Enter":(n,e)=>il(n,e),Enter:(n,e)=>window.innerWidth>Fx[Bx.Medium]?!1:il(n,e)})}const uv=["p",0],hv=["br"],fv=new Xw({nodes:{paragraph:{content:"inline*",group:"block",parseDOM:[{tag:"p",preserveWhitespace:"full"}],toDOM(){return uv}},text:{group:"inline"},hard_break:{inline:!0,group:"inline",selectable:!1,parseDOM:[{tag:"br"}],toDOM(){return hv}},[Tc]:UM,doc:{content:"block+"}},marks:{}});function pv(){const n=new EventTarget,e=new FM(null,{state:wi.create({schema:fv,plugins:[cv(),oC({submitKeys:["Enter","Tab"],cancelKeys:["Escape"],checkStrictMatchKeys:[" "]}),zM(""),HM(),dv(),yl({"Mod-z":nm,"Mod-y":xl,"Mod-Shift-z":xl}),Uk(),yl(sC),Lk(n),QM()]}),dispatchTransaction(t){const s=e.state.apply(t);e.updateState(s),t.docChanged&&n.dispatchEvent(new Event(sl))},handlePaste(t,s){var r;const i=(r=s.clipboardData)==null?void 0:r.getData("text/plain");return i===void 0?!1:(rC(t,i),!0)},clipboardTextSerializer(t){return xp(t.content).content}});return e}function mv(){try{return navigator.userAgent.toLocaleLowerCase().includes("firefox")}catch{return!1}}const gv=[te([mg["prosemirror-parent"],"text-token-text-primary","max-h-[25dvh]","max-h-52","overflow-auto",mv()?"firefox":"default-browser"])],yv=({children:n})=>{const[e]=S.useState(()=>pv()),[t]=S.useState(()=>new oa(e));return n(t)},xv=({composerController:n,placeholder:e})=>{if(!(n instanceof oa))throw new Error(`Expected instance of ProseMirrorComposerController but got ${n.constructor.name}`);const t=S.useRef(null);return S.useEffect(()=>{t.current.appendChild(n.view.dom)},[]),S.useEffect(()=>{const s=n.view.dom;s&&(s.id=bh,n.focus())},[n]),S.useEffect(()=>{n.setPlaceholder(e)},[e,n]),S.useEffect(()=>{n.logPageMount()},[]),c.jsx("div",{ref:t,className:te(gv)})},bv=S.forwardRef(function({type:e,placeholder:t,replyRegions:s,state:i,renderFiles:r,icon:o,onSubmit:a,inputState:l,currentLeafId:d,composerController:u,clientThreadId:p,gizmoId:m},b){const g=Vo(),x=Yu();return S.useEffect(()=>{u.focus()},[x==null?void 0:x.modelId,u]),c.jsxs("div",{ref:b,className:te("flex w-full flex-col gap-1.5 rounded-[26px] p-1.5 transition-colors",g&&"backdrop-blur-2xl no-transparency:backdrop-blur-none",g&&e!=="temporary"&&"bg-token-composer-surface",!g&&e!=="temporary"&&"bg-[#f4f4f4] dark:bg-token-main-surface-secondary",e==="temporary"&&"dark bg-black"),children:[s.length>0&&c.jsx(kv,{replyRegions:s}),c.jsxs("div",{className:"flex items-end gap-1.5 md:gap-2",children:[o,c.jsxs("div",{className:te("flex min-w-0 flex-1 flex-col",!o&&"pl-4"),children:[r,u instanceof qa?c.jsx(Sh,{id:bh,tabIndex:0,"data-id":d,dir:"auto",ref:k=>{if(!(u instanceof qa))throw new Error("Expected TextAreaComposerController");k!=null&&(u.textArea=k,u.logPageMount())},rows:1,placeholder:t,disabled:l!=="default",className:te("m-0 resize-none border-0 bg-transparent px-0 text-token-text-primary focus:ring-0 focus-visible:ring-0",l==="disabled"&&"text-center",["max-h-[25dvh]","max-h-52"])}):c.jsx(xv,{composerController:u,placeholder:t})]}),c.jsx(Sv,{inputState:l,state:i,onSubmit:a,composerController:u,clientThreadId:p,gizmoId:m})]})]})});function Sv(n){const{isUnauthenticated:e}=Xt();if(n.inputState==="disabled")return null;const t=c.jsx(wv,{state:n.state,onSubmit:n.onSubmit});return!e&&n.state==="disabled"&&n.clientThreadId?c.jsx(gg,{clientThreadId:n.clientThreadId,gizmoId:n.gizmoId,fallback:()=>t}):t}function wv({state:n,onSubmit:e}){const t=n==="streaming"?h0:f0,s=je(),i=s.formatMessage({id:"+yfm/p",defaultMessage:"Stop streaming"}),r=s.formatMessage({id:"xfIykB",defaultMessage:"Send prompt"}),o=Vo();return c.jsx("button",{onClick:e,disabled:n==="disabled","aria-label":n==="streaming"?i:r,"data-testid":n==="streaming"?"stop-button":"send-button",className:te("mb-1 me-1 flex h-8 w-8 items-center justify-center rounded-full bg-black text-white transition-colors hover:opacity-70 focus-visible:outline-none focus-visible:outline-black disabled:text-[#f4f4f4] disabled:hover:opacity-100 dark:bg-white dark:text-black dark:focus-visible:outline-white disabled:dark:bg-token-text-quaternary dark:disabled:text-token-main-surface-secondary",o&&"disabled:bg-black disabled:bg-opacity-[0.27]",!o&&"disabled:bg-[#D7D7D7]"),children:c.jsx(t,{className:te(n==="streaming"?"icon-lg":"icon-2xl")})})}function kv({replyRegions:n}){return c.jsx("div",{className:"flex flex-col divide-y divide-token-border-light overflow-hidden rounded-b-lg rounded-t-[20px] bg-token-main-surface-primary",children:n.map((e,t)=>{switch(e.type){case"text":return c.jsx(Cv,{value:e.value,onRemoveRegion:e.onRemoveRegion},t);case"object":return c.jsx(Mv,{value:e.value,onRemoveRegion:e.onRemoveRegion},t);case"mention":return c.jsx(vv,{value:e.value,icon:e.icon,onRemoveRegion:e.onRemoveRegion},t)}})})}function Cv({value:n,onRemoveRegion:e}){return c.jsxs(Nc,{className:"text-token-text-secondary",children:[c.jsx(Ic,{children:c.jsx(dc,{className:"icon-lg-heavy"})}),c.jsx(Ac,{children:`${n}`}),c.jsx(_c,{onClick:e})]})}function Mv({value:n,onRemoveRegion:e}){return c.jsxs(Nc,{className:"text-blue-selection",children:[c.jsx(Ic,{children:c.jsx(dc,{className:"icon-lg-heavy"})}),c.jsx(Ac,{className:"font-semibold",children:n}),c.jsx(_c,{onClick:e})]})}function vv({value:n,icon:e,onRemoveRegion:t}){return c.jsxs(Nc,{children:[c.jsx(Ic,{className:"mt-0",children:e}),c.jsx(Ac,{className:"font-semibold text-token-text-secondary",children:n}),c.jsx(_c,{onClick:t})]})}function _c({onClick:n}){return c.jsx("button",{onClick:n,className:"flex-shrink-0 text-token-text-secondary",children:c.jsx(u0,{className:"icon-lg"})})}const Nc=et.div`flex items-start py-2.5 gap-4 pl-3 pr-1.5 text-sm`,Ic=et.span`flex-shrink-0 mt-0.5 w-6 h-6 flex justify-center items-center`,Ac=et.span`flex-1 line-clamp-3 py-0.5`;function Tv(n){const e=Sg(),t=Ho(n),s=S.useMemo(()=>!e.isSuccess||!e.data?[]:e.data,[e.data,e.isSuccess]);return S.useMemo(()=>{const r=new Set(t.enabledTools||[]);return s.filter(o=>o.requiredFeatures.length?o.requiredFeatures.every(a=>r.has(a)):!0)},[s,t])}function Ev({composerController:n,clientThreadId:e}){const t=Tv(e),[s,i]=S.useState([]),[r,o]=S.useState(void 0),[a,l]=S.useState(0);S.useEffect(()=>{i(r?t.filter(A=>A.name.toLowerCase().startsWith(r.text.toLowerCase())):[])},[r,t]);const d=n.useState(A=>A.getSystemHints().length>0);S.useEffect(()=>{const A=T=>{o(_=>!_||!T?T:_.text===T.text&&_.range.from===T.range.to&&_.range.to?_:T)};n.view.dispatch(n.view.state.tr.setMeta(gl,{onHintMatch:A}))},[n]);const u=d||!t.length||!s.length||!r;S.useEffect(()=>{u&&l(0)},[u]);const p=s.length,m=S.useCallback(A=>{l(T=>(A(T)%p+p)%p)},[p]),b=s[a],g=({hintToSave:A=b,expectPerfectMatch:T,appendSpace:_=!0})=>{if(!r||!b||T&&A.name.toLowerCase()!==r.text.toLowerCase())return;const j=r.text+A.name.slice(r.text.length);GM(n.view,{id:A.systemHint,hint:j},r.range,_),er(n.view)},x=S.useRef(g);x.current=g;const k=S.useRef(m);k.current=m;const M=S.useRef(r);M.current=r;const N=n.view;return S.useEffect(()=>(u||bp(N,A=>{A==="up"?k.current(T=>T-1):A==="down"?k.current(T=>T+1):A==="cancel"?er(N):A==="submit"?(x.current({expectPerfectMatch:!1}),er(N)):A==="checkMatch"&&x.current({expectPerfectMatch:!0,appendSpace:!1})}),()=>er(N)),[u,N]),u?null:c.jsx(yg,{className:"max-w-60",children:s.map((A,T)=>c.jsx("div",{children:c.jsx(xg,{autoFocus:!1,className:"rounded-xl px-1 py-2",spoofHovered:T===a,onMouseOver:()=>l(T),onClick:()=>{g({hintToSave:A,expectPerfectMatch:!1}),n.focus()},children:c.jsx(_v,{title:A.name,description:A.description,icon:c.jsx(bg,{svgString:A.logo,className:"icon-lg text-token-text-secondary"}),checked:!1})})},A.systemHint))})}function _v({title:n,description:e,icon:t,onClick:s,checked:i}){return c.jsxs("div",{className:"inline-flex w-full items-center justify-start gap-1.5 pl-1.5 pr-3",onClick:s,children:[c.jsx("div",{className:"flex h-7 w-7 items-center justify-center gap-2.5",children:t}),c.jsxs("div",{className:"shrink grow basis-0",children:[c.jsxs("span",{className:"text-sm font-normal leading-tight text-token-text-primary",children:[n,c.jsx("br",{})]}),!!e&&c.jsx("span",{className:"text-[13px] font-normal leading-[18px] text-token-text-secondary",children:e})]}),i&&c.jsx(Sf,{className:te("icon-md text-token-text-primary",{"group-hover:hidden":!i})})]})}function Nv({composerController:n,clientThreadId:e}){return n instanceof oa?c.jsx(Ev,{composerController:n,clientThreadId:e}):null}const sm=We(()=>Ve(()=>import("./sso-ipuhfmti911l5wbt.js").then(n=>n.b),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69])).then(n=>n.default),{ssr:!1}),Iv=We(()=>Ve(()=>import("./sso-ipuhfmti911l5wbt.js").then(n=>n.c),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69])).then(n=>n.default),{ssr:!1}),Av=1,Rv=3e3;function Dv({files:n,className:e,clientThreadId:t,isCanmoreEnabled:s=!1}){const i=Ir();return c.jsxs("div",{className:e,children:[s&&c.jsx(sm,{clientThreadId:t}),n.map(r=>c.jsx(Ch,{width:i?"normal":"wide",onRemoveFileClick:()=>gs.remove(r.tempId,"none"),file:r.file,fileId:r.fileId??void 0,contextConnectorInfo:r.contextConnectorInfo,loadingPercentage:r.status===Rg.Uploading?r.progress:void 0},r.tempId))]})}function jv({onAbortCompletion:n,onCreateNewCompletion:e,onContinueGenerating:t,currentModelId:s,clientThreadId:i,isNewThread:r,isCompletionInProgress:o,className:a,disabled:l=!1,disabledReason:d,canPause:u=!1,canContinue:p=!1,suggestions:m,isInteractableSharedThread:b,composerContainerRef:g,composerController:x,autocompletions:k,requiresFileUpload:M,onComposerInput:N,onAutocompleteSelect:A,headerClassName:T,hideHeader:_,setComposerBarElement:j,onTaggingDropdownOpen:P,onTaggingDropdownClose:B}){var rs,Fr;const I=Vl(),{isUnauthenticated:q}=Xt(),G=je(),D=Bn(i),V=Ui(i),J=Fi(),{gizmoEditorData:W,mode:X,getGizmoId:ye}=Er(),L=Li(),F=Nr(),xe=es(),re=Tr(),Z=Dr(i),ke=!!Lx(),be=!!ec(),[le,he]=S.useState({}),[Oe,ce]=S.useState(!1),[z,Ce]=S.useState(!1),Ye=S.useRef(!1),Qe=Fh(),Ee=s!==null?Qe[s]:void 0;let ae=Zo(i),$e=ae&&"gizmo"in ae?ae.gizmo:void 0;const[Ge,Be]=S.useState(null);Ge!==null&&(ae={gizmo:Ge,gizmo_id:Ge.gizmo.id,kind:ot.GizmoInteraction},$e=Ge);const Se=mo(Ee,ae);let it=!1;wg(ae)&&($e==null?void 0:$e.gizmo.id)===kg&&(it=!0);const lt=!l&&Se!==Zs.None&&!it&&!q,ct=uh(Ee,ae),tt=fh(Ee,ae);let He=po(Y=>Y.files);const[ft]=S.useState(()=>Cg());X==="magic"?He=He.filter(Y=>Y.gizmoId!=null):He=He.filter(Y=>Y.gizmoId==null);const Le=He.length>0,Ae=po(Mg.hasUploadInProgress),y=x.useState(Y=>!Y.isEmpty()),h=Le?!Ae:y,f=(Se===Zs.Multimodal?Fl:Bl)-He.length,w=f<=0,v=h&&!l&&!o&&!be,[E,R]=S.useState(!1),ne=Jl(),Re=s||ne.id,_e=(rs=Qe[Re])==null?void 0:rs.tags,{targetedContent:ge,setTargetedContent:fe}=wh(),Me=ge!=null&&ge.isFocusedViewContent&&!re?void 0:ge,{rebaseSystemMessageContent:fn}=ii();S.useEffect(()=>{vg()}),S.useEffect(()=>{if(!(I!=null&&I.id))return;const Y=Wc.getAndReset(I==null?void 0:I.id,Z);Y&&x.setText(Y.inputText)},[I==null?void 0:I.id,Z,x]),S.useEffect(()=>{E!==v&&(R(v),v&&(tc(!0).then(Y=>{pr.startEnforcement(Y),yo.startEnforcement(Y),Mo.startEnforcement(Y)}),L!=null&&L.includes(Ar.SharedWebsocket)&&Ss.registerIfNotConnected()))},[v,E,ae==null?void 0:ae.kind,L]);const Ct=dh(Ee,ae),{handleFileAccepted:Is}=Af(G,mo(Ee,ae),ct,"mouse",ye,Ct==null?void 0:Ct.attachments),{getInputProps:En,open:ze}=ph({disabled:l||!lt||w,noClick:!0,onDropAccepted:Is,onDropRejected:Y=>If(Y,G,Se),multiple:!0,maxSize:mh,maxFiles:f,...hh(tt)}),nt=Hh(ft),st=S.useCallback(()=>{x.eraseContent(),nt.clearMessages(),x.resize(Av),$a();for(const Y of He)gs.remove(Y.tempId,"none")},[He,nt,x]),Zt=async(Y,yt)=>{var Lc;if(Y==null||Y.preventDefault(),l||!h&&!yt||!ae||Ot.isLoading(i)!==!1)return;ce(!0);const sn=x.getContentToSend(),Os=sn.content.replace(/[\u{E0000}-\u{E007F}]+/gu,""),Wn=`${D}-nextPrompt`,Ps=Dg({namespace:xo.CompletionRequest,key:Wn,opts:{expectedTimingLogs:[{name:"prompt_submitted",expectedInMs:3e3}]}}),{content:pi,attachments:Bc}=jg(Os,Ee,ae),la=[];fn&&la.push(Vx(fn));const ca={...ae};"gizmo"in ca&&delete ca.gizmo;const da=x.getSystemHints();let $i={promptId:Wn,content:pi,eventMetadata:{eventSource:Y?"mouse":"keyboard"},completionMetadata:{suggestions:m,conversationMode:ca,systemHints:da},messageMetadata:{...Bc.length>0&&{attachments:Bc},...Ge&&{gizmo_id:Ge==null?void 0:Ge.gizmo.id},...le,...da.length>0&&{system_hints:da},...!!sn.metadata&&{serialization_metadata:sn.metadata}},appendMessages:la.length>0?la:void 0};$i=Og($i),Me!=null&&Me.createNewCompletionParams&&($i=await Me.createNewCompletionParams($i)),Ps.logTiming("request_params_ready"),await e($i),(Lc=Me==null?void 0:Me.onCreateCompletion)==null||Lc.call(Me,{serverThreadId:Z,currentLeafId:D}),(Me==null?void 0:Me.shouldPersistAcrossMessages)!==!0&&fe(void 0),Ri.hideThreadHeader(),st(),ce(!1),Ps.logTiming("prompt_submitted"),Pg({namespace:xo.CompletionRequest,key:Wn}),m!==void 0&&(at.logEvent("chatgpt_prompt_ignore_suggestions"),ee.logEvent($.promptIgnoreSuggestions))},ai=S.useRef(Zt);S.useLayoutEffect(()=>{ai.current=Zt}),S.useEffect(()=>zx.subscribe(Ux.SEND_PROMPT,({prompt:Y})=>{x.setText(Y),ai.current(void 0,!0)}),[x]);const ss=Y=>{fe(Y.targetedReply),Y.targetedReply&&(x.focus(),ee.logEvent($.targetedReplyButtonClicked,{conversationId:Z,sourceMessageId:Y.messageId}))},li=S.useCallback(()=>{var Y;(Y=Me==null?void 0:Me.onCleared)==null||Y.call(Me,{serverThreadId:Z,currentLeafId:D}),fe(void 0),x.focus()},[D,Z,Me,fe,x]),Un={Enter:{validator:Y=>{const yt=Y.isComposing||Y.keyCode===229,sn=z&&Ye.current;return v&&!sn&&(Y.metaKey||(F||Gx)&&!Y.shiftKey&&!yt)},handler:Y=>{Y.preventDefault(),Zt()}},Escape:{validator:Y=>!Y.isComposing,handler:Y=>{u&&o&&(n("",V),ee.logEvent($.pauseCompletion,{threadId:O.getServerThreadId(i),currentLeafId:O.getTree(i).getMessageId(D),eventSource:"keyboard"})),Y.target.value===""&&li()}}},en=S.useRef(Un);en.current=Un;const Vn=S.useRef(null),tn=Ab(_e,ae==null?void 0:ae.kind),[As,Gn]=S.useState(!1),Rs=tn&&As,_n=x.isReady();S.useEffect(()=>x.subscribe("keydown",Y=>{var Os,Wn;x.acceptLegacyKeydown()&&((Os=en.current[Y.key])!=null&&Os.validator(Y))&&en.current[Y.key].handler(Y);const sn=x.getCurrentText();if(Y.key==="@"){const Ps=x.getSelectionStart(),pi=sn.substring(0,Ps);(!pi||/\s$/.test(pi)||Ps===0)&&((Wn=Vn.current)==null||Wn.handleClose(),setTimeout(()=>Gn(!0),10))}else As&&Gn(!1);Y.key==="Escape"&&(Be(null),Ce(!1))}),[x,_n,As]),S.useEffect(()=>{const Y=Object.fromEntries(Object.keys(en.current).map(yt=>[yt,Os=>{const Wn=en.current[yt];if(!Wn||x.acceptLegacyKeydown())return!1;const{validator:Ps,handler:pi}=Wn;return Ps(Os)?(pi(Os),!0):!1}]));x.registerKeyHandlers(Y)},[x,_n]),S.useEffect(()=>x.subscribe("paste",Y=>{Tg({event:Y,intl:G,clientThreadId:i,conversationMode:ae,currentModelConfig:Ee,getEditorGizmoId:ye,modelSupportedImageMimeTypes:ct})}),[G,i,ae,Ee,ye,ct,x]);const ci=Y=>{ke||Be(Y),x.trimLeadingText("@"),dr(),Gn(!1)},Wi=bw(i,ft,G,ct,Ct==null?void 0:Ct.attachments),Hi=S.useCallback(()=>{n("",V),ee.logEvent($.pauseCompletion,{threadId:O.getServerThreadId(i),currentLeafId:O.getTree(i).getMessageId(D),eventSource:"mouse"}),dr()},[n,i,V,D]),di=S.useCallback(()=>{Wc.set(I==null?void 0:I.id,Z,x.getCurrentText())},[Z,I==null?void 0:I.id,x]);S.useEffect(()=>{W||Oe||x.focus()},[Oe,x]),S.useEffect(()=>{W||gs.reset()},[s,W]),S.useEffect(()=>{(!tn&&Ge||ke)&&Be(null)},[tn,Ge,ke]);const[ui,hi]=(()=>{switch(d){case"workspaceDisallowsGizmo":return[An.disallowedByWorkspacePlaceholder,!0];case"feedbackRequired":return[An.disabledFeedbackPlaceholder,!0];case"noModelsAvailable":return[An.noModelsAvailablePlaceholder,!0];case"requiresPluginsToBeInstalled":return[An.requiresPluginsToBeInstalled,!0];case"loadingPlugins":return[An.loading,!0];case"noTestGizmoId":return[An.noTestGizmoId,!0];default:return b?[An.continueSharedConversationPlaceholder,!1]:(Me==null?void 0:Me.placeholderTextOverride)!=null?[Me.placeholderTextOverride,!1]:[An.placeholderWithName,!1]}})(),fi=G.formatMessage(ui,{name:W!=null?X==="magic"?Rb:W.name||"GPT":($e==null?void 0:$e.gizmo.display.name)??"ChatGPT"});S.useEffect(()=>x.subscribe("input",()=>{kh.getState().isThreadHeaderVisible&&Ri.hideThreadHeader(),Ce(!0)}),[x]),S.useEffect(()=>{if(N)return x instanceof oa?x.subscribe("change",()=>{N==null||N()}):x.subscribe("input",()=>{N==null||N()})},[x,N]),S.useEffect(()=>x.subscribe("focus",()=>{Ce(!0)}),[x]);const pe={clientThreadId:i,uploadType:Se,modelAcceptedMimeTypes:tt,modelSupportedImageMimeTypes:ct,attachmentsProductFeature:Ct==null?void 0:Ct.attachments,getInputProps:En,openFileDialog:ze,historyDisabled:xe,onOauthRedirect:di,highlightTooltip:M&&!Le},we=!l&&!w&&lt&&c.jsx(jw,{...pe}),Ke=Xo(i),Nn=Le?c.jsxs(c.Fragment,{children:[X==="magic"&&c.jsx("div",{className:"m-2 mb-0 rounded-lg bg-token-main-surface-secondary p-2 text-xs text-token-text-secondary",children:c.jsx(U,{...An.gizmoKnowledgeWarning})}),c.jsx(Dv,{files:He,clientThreadId:i,className:"flex flex-nowrap gap-2 overflow-x-auto pb-1.5 pt-[7px]"})]}):Ke&&c.jsx(sm,{wrapperClassName:"flex flex-nowrap gap-2 overflow-x-auto pb-1.5 pt-[7px]",clientThreadId:i}),is=hi?"disabled":"default",pn=o&&u?"streaming":!v||Oe?"disabled":"idle",In=S.useRef(null),nn=S.useRef(null),{layer:Ds}=ns("387752763"),qi=Ds.get("enable_slash_commands",!1);S.useEffect(()=>{const Y=()=>{In.current!=null&&jt.addAction("composer_state_disabled",{threadId:O.getServerThreadId(i),disabledReason:In.current})};if(h&&pn==="disabled"){let yt="unknown";l?yt=d??"component_disabled_unknown":o?yt="completion_in_progress":be?yt="thread_hard_blocked":Oe&&(yt="starting_new_completion_request"),In.current!==yt&&(nn.current&&clearTimeout(nn.current),nn.current=setTimeout(Y,Rv)),In.current=yt}else In.current=null;return()=>{nn.current&&(clearTimeout(nn.current),nn.current=null)}},[i,h,pn,l,d,o,be,Oe]);const js=[];if(Me!=null&&Me.label&&js.push({type:Me.type,value:Me.label,onRemoveRegion:li}),Ge!==null){const Y=!!((Fr=Ge.gizmo.tags)!=null&&Fr.includes(Gl.FirstParty));js.push({type:"mention",value:Ge.gizmo.display.name,icon:c.jsx(vf,{isFirstParty:Y,src:Ge.gizmo.display.profile_picture_url,className:"icon-md"}),onRemoveRegion:()=>{Be(null),x.focus()}})}S.useEffect(()=>{(!k||k.length===0||!z)&&(Ye.current=!1)},[k,z]);const St=(Y,yt,sn)=>{Ye.current=Y>=0,yt&&x.setText(sn?`${sn.title} ${sn.body}`:"")};return S.useEffect(()=>{Rs?P==null||P():B==null||B()},[Rs,P,B]),c.jsxs(Eg.Provider,{value:ft,children:[c.jsx(_g,{onOauthRedirect:di,children:c.jsx("form",{className:a,onSubmit:Zt,children:c.jsxs("div",{className:"relative flex h-full max-w-full flex-1 flex-col",children:[!_&&c.jsx(YS,{className:T}),c.jsxs("div",{ref:g,className:"group relative flex w-full items-center",children:[r&&"from_template_row"in J.query&&c.jsx("button",{type:"button",onClick:()=>{J.push("/",void 0,{shallow:!0})},className:"mr-2 flex h-8 w-8 items-center justify-center text-token-text-tertiary hover:text-token-text-secondary",children:c.jsx(p0,{className:"icon-lg"})}),tn&&!!Z&&c.jsx(NS,{ref:Vn}),Rs&&c.jsx("div",{className:te("absolute bottom-16 w-full space-y-2",Ha.TagGpt),children:c.jsx(j0,{onClick:Y=>ci(Y),onClose:()=>{Gn(!1),x.focus()}})}),qi&&c.jsx("div",{className:te("absolute bottom-16 w-full space-y-2",Ha.TagGpt),children:c.jsx(Nv,{composerController:x,clientThreadId:i})}),Ke&&c.jsx(Iv,{composerController:x}),c.jsx(bv,{type:xe?"temporary":"default",ref:j,replyRegions:js,placeholder:fi,inputState:is,composerController:x,icon:we,state:pn,onSubmit:pn==="streaming"?Hi:Zt,renderFiles:Nn,currentLeafId:D,clientThreadId:i,gizmoId:$e==null?void 0:$e.gizmo.id}),z&&k&&k.length>0&&!Rs&&x.canShowAutocompletion()&&c.jsx("div",{className:te("absolute left-0 top-full z-10 mt-2 box-border w-full bg-token-main-surface-primary",we?"px-8":"pl-0"),children:c.jsx(IS,{suggestions:k,composerController:x,onSelect:A,onChange:St})})]}),c.jsx(Ng,{composerController:x,parsedDocumentHandler:Wi})]})})}),c.jsx(uw,{canUseInlineTagging:tn,isDisabled:l,clientThreadId:i,currentLeafId:D,currentRequestId:V,canContinue:p,composerController:x,setPromptInputMetadata:he,suggestions:m,isNewThread:r,onCreateNewCompletion:e,onContinueGenerating:t,onResetState:st,conversationMode:ae}),ae!=null&&Ig.includes(ae.kind)&&c.jsx(Ag,{onTargetedReply:ss})]})}function im(n){const e=S.useContext(nc);return({id:s,requestedModelId:i,eventMetadata:r,focusOnNewCompletion:o=!0,variantPurpose:a="none",useDefaultModel:l,appendMessages:d,conversationMode:u,juice:p=void 0})=>{const b=O.getTree(n).getParentPromptNode(s).id;e({type:On.Variant,promptId:b,requestedModelId:i,eventMetadata:r,cancelActiveRequests:!1,focusOnNewCompletion:o,useDefaultModel:l,completionMetadata:{variantPurpose:a,conversationMode:u,juice:p},appendMessages:d})}}const Ov=({children:n})=>{const[e]=S.useState(()=>new qa);return n(e)},rm=({children:n})=>{const{layer:e}=ns("387752763");return e.get("enable_rich_text_composer",!1)?c.jsx(yv,{children:n}):c.jsx(Ov,{children:n})};function Pv(n){var s,i,r;const e=((s=n.message)==null?void 0:s.author.role)===Ue.User,t=((i=n.metadata)==null?void 0:i.err)!=null&&((r=n.metadata)==null?void 0:r.errCode)!==cn.ContentPolicy;return e||t}function Fv(n){return n.composerController?c.jsx(wu,{...n,composerController:n.composerController}):c.jsx(rm,{children:e=>c.jsx(wu,{...n,composerController:e})})}function wu({clientThreadId:n,isNewThread:e,currentModelId:t,showPromptStarters:s,onRequestCompletion:i,composerContainerRef:r,composerController:o,setComposerBarElement:a}){const l=zi(),d=Wl(),u=ei(p=>{const m=Ot.getCurrentNode(n,p);return Pv(m)});return!d&&u?c.jsx(Bv,{clientThreadId:n}):c.jsxs($h,{children:[c.jsx(vS,{clientThreadId:n}),c.jsx(lc,{clientThreadId:n,isStaticSharedThread:l,showInlineEmbeddedDisplay:!1,withVerticalPadding:!1,withHorizontalPadding:!0,children:c.jsx(cc,{children:c.jsx(om,{composerContainerRef:r,composerController:o,clientThreadId:n,currentModelId:t,isNewThread:e,showPromptStarters:s,setComposerBarElement:a,onRequestCompletion:i})})})]})}function Bv({clientThreadId:n}){const e=im(n),t=ei(r=>{var a;return((a=Ot.getCurrentNode(n,r).metadata)==null?void 0:a.errCode)===bo}),s=Mh(r=>r.isoDate),i=Bn(n);return t&&s!=null&&s!==""?null:c.jsxs("div",{children:[c.jsx("div",{className:"mb-3 text-center text-xs",children:c.jsx(U,{...ku.errorGeneratingResponse})}),c.jsx("div",{className:"flex items-center md:mb-4",children:c.jsx(It,{as:"button",color:"primary",onClick:()=>{e({id:i,eventMetadata:{eventSource:"mouse"},conversationMode:Ot.getConversationMode(n)})},className:"m-auto",icon:xf,children:c.jsx(U,{...ku.regenerateResponse})})})]})}function om({clientThreadId:n,currentModelId:e,isNewThread:t,onRequestCompletion:s,showPromptStarters:i,composerContainerRef:r,composerController:o,autocompletions:a,requiresFileUpload:l,onComposerInput:d,onAutocompleteSelect:u,headerClassName:p,hideHeader:m,setComposerBarElement:b,onTaggingDropdownClose:g,onTaggingDropdownOpen:x}){var He,ft;const k=Bn(n),M=Ui(n),N=ur(),{isUnauthenticated:A}=Xt(),_=oc(n)===vo.PENDING,j=of({clientThreadId:n,conversationLeafId:k}),P=Fn(M),B=(P||_)&&!j,I=Bn(n),q=!A,{isOpen:G,onClose:D}=Fg(),V=S.useCallback(Le=>{ee.logEvent($.continueCompletion),s({type:On.Continue,promptId:Le,eventMetadata:{eventSource:"mouse"},cancelActiveRequests:!1,completionMetadata:{conversationMode:Ot.getConversationMode(n)}})},[s,n]),J=$o(),W=Bi(),X=S.useCallback(async(Le,Ae)=>{var w;const y=O.getServerThreadId(n);Ss.stopConversation(y);const h=O.getTree(n);!h.hasReceivedServerCompletion&&!qo()&&((w=h.getParent(Ae).metadata)==null?void 0:w.errCode)!==cn.ContentPolicy&&setTimeout(()=>{Qa.onCreateFinished(W,J,y)},500),y&&at.checkGate("3922476776")&&await Je.stopConversationProcess(y),Wo.abortRequest(Ae)&&O.updateTree(n,v=>{const E=O.getThreadCurrentLeafId(n);v.updateNodeMessageMetadata(E,{finish_details:{type:"interrupted"}})})},[J,n,W]),ye=S.useCallback(async({promptId:Le,content:Ae,eventMetadata:y,completionMetadata:h,messageMetadata:f,appendMessages:w})=>{const v=O.getThreadCurrentLeafId(n);O.updateTree(n,E=>{E.addNode(Le,Ae,v,Ue.User,void 0,f)}),await s({type:On.Next,promptId:Le,eventMetadata:y,cancelActiveRequests:!0,completionMetadata:h,appendMessages:w})},[n,s]),L=Fb(n,k),F=Bb(n,k),xe=!j&&(P||_),re=S.useMemo(()=>xe?!1:!L&&F,[L,F,xe]),Z=xe&&e!=="gpt-4-pbrowse",ke=ac(n),be=hn(n),le=Ts(be).data,{promptStarters:he,isSuccess:Oe}=gf(t&&!ke,n,4),ce=lh(),z=(()=>{var Le,Ae;if((ce==null?void 0:ce.messageId)===((Ae=(Le=O.getTree(n).getLastValidNode(k))==null?void 0:Le.message)==null?void 0:Ae.id))return ce==null?void 0:ce.suggestions;if(i&&!ke&&Oe&&!q)return he})(),Ce=O.getTree(n),Ye=Ce.countMessagesByAuthor(Ue.User),Qe=S.useRef(),Ee=S.useRef();let ae=!1;Qe.current==Ye&&Ee.current==I?ae=!0:Qe.current!==Ye&&Ee.current!==I&&(ae=!0,Qe.current=Ye,Ee.current=I);const $e=Ce.getNodeByIdOrMessageId(k),Ge=ae&&((He=$e==null?void 0:$e.message)==null?void 0:He.author.role)==Ue.Assistant&&Xl($e.message),Be=Kl(),Se=Wx(),it=(()=>{var y;if(((y=le==null?void 0:le.gizmo.tags)==null?void 0:y.includes(Gl.WorkspaceDisabled))&&!Se)return"workspaceDisallowsGizmo";if(Be.size){if(N.displayingSideBySideFeedback&&N.unskippable)return"feedbackRequired"}else return"noModelsAvailable";const Ae=Ot.getConversationMode(n);return(Ae==null?void 0:Ae.kind)===ot.GizmoTest&&Ae.gizmo_id==null?"noTestGizmoId":null})(),lt=af(n),ct=Es(n),tt=(ft=Qn("15117983"))==null?void 0:ft.value;return c.jsxs(c.Fragment,{children:[(t||Ge)&&G?c.jsx(Bg,{onClose:D}):null,tt&&ct&&ct.kind===ot.PrimaryAssistant&&ct.plugin_ids&&ct.plugin_ids.length>0?c.jsx(Lv,{}):c.jsx(jv,{composerContainerRef:r,composerController:o,clientThreadId:n,onCreateNewCompletion:ye,onAbortCompletion:X,onContinueGenerating:V,currentModelId:e,isNewThread:t,isCompletionInProgress:B,className:"w-full",canContinue:re,suggestions:z??[],disabled:!!it,disabledReason:it??void 0,canPause:Z,isInteractableSharedThread:lt,autocompletions:a,requiresFileUpload:l,onComposerInput:d,onAutocompleteSelect:u,headerClassName:p,hideHeader:m,setComposerBarElement:b,onTaggingDropdownClose:g,onTaggingDropdownOpen:x},n)]})}function Lv(){return c.jsxs("div",{className:"mx-auto flex max-w-md flex-col items-center justify-center gap-2 rounded-xl border border-token-border-light bg-token-main-surface-primary p-6 shadow-lg",children:[c.jsx("span",{className:"text-token-text-primary",children:c.jsx(U,{id:"PluginsDecrepatedNotice.pluginsDeprecationTitle",defaultMessage:"Conversations with plugins are archived"})}),c.jsx("span",{className:"text-token-text-secondary",children:c.jsx(U,{id:"PluginsDecrepatedNotice.pluginsDeprecationSubtitle",defaultMessage:"Explore GPT Store to find a replacement"})}),c.jsxs("a",{href:"https://chat.openai.com/gpts",className:"text-green-500 hover:cursor-pointer dark:text-green-400",children:[c.jsx(U,{id:"PluginsDecrepatedNotice.pluginsDeprecationGptStoreLink",defaultMessage:"Explore GPTs"}),c.jsx("span",{className:"ml-2",children:c.jsx(U,{id:"PluginsDecrepatedNotice.pluginsDeprecationGptStoreLinkArrow",defaultMessage:""})})]})]})}const ku=qe({errorGeneratingResponse:{id:"PromptTextarea.errorGeneratingResponse",defaultMessage:"There was an error generating a response"},regenerateResponse:{id:"PromptTextarea.regenerateResponse",defaultMessage:"Regenerate"}});function zv(n){const{layer:e}=ns("4031588851"),{layer:t}=Wh("4031588851");return n?e.get("enable_new_homepage",!1):t.get("enable_new_homepage",!1)}function Uv(n){return c.jsx(rm,{children:e=>c.jsx(Vv,{...n,composerController:e})})}function Vv({clientThreadId:n,currentModelId:e,onRequestCompletion:t,composerController:s}){const i=Xn(n),r=ac(n),o=ec(),a=Ir(),[l,d]=S.useState([]),u=S.useRef(!1),p=sc("589604007").value,{promptStarters:m,isSuccess:b,isError:g}=gf(i&&!r,n,a?4:8,p,!0),x=!!l.find(D=>!!D.requires_file_upload),k=S.useRef(null),M=S.useRef(null),N=(D,V,J)=>{const W=D.title;d([]),s.focus(),s.setText(W),requestAnimationFrame(()=>{const X=((m==null?void 0:m.filter(ye=>ye.theme===D.theme))??[]).map(ye=>({...ye,type:Hc.Autocomplete}));d(X),X.length>0&&To(X,n),e0(D,J,n)})},A=m==null?void 0:m.reduce((D,V)=>(V.theme&&!D[V.theme]&&(D[V.theme]=V),D),{}),T=[];if(A)for(const D in A)T.push(A[D]);const _=T&&T.length>0,j=!!(b&&_),{layer:P}=ns("4031588851"),B=P.get("autocomplete_mode","HARDCODED"),I=S.useCallback(Hl(async()=>{const D=s.getCurrentText();if(!D){d([]);return}if(u.current)return;d(J=>J.filter(W=>W.title===D));const V=Date.now();M.current=D,k.current=V;try{const J=await Je.generateAutocompletions(D,4);if(k.current!==V||s.getCurrentText()!==M.current)return;const W=J.completions.map(X=>({id:Rr(),type:Hc.Autocomplete,title:D,body:X,oneliner:X,prompt:`${D} ${X}`}));d(W),W.length>0&&To(W,n)}catch{}},250),[s]);S.useEffect(()=>{u.current&&d([])},[u]);const q=S.useCallback(()=>{d(s.getCurrentText()?l.filter(D=>`${D.title} ${D.body}`.startsWith(s.getCurrentText())):[])},[s,l]),G=S.useMemo(()=>B==="MODEL"?I:q,[B,I,q]);return c.jsx(c.Fragment,{children:c.jsx(Xs,{children:(g||b)&&c.jsx(c.Fragment,{children:c.jsx(lc,{isStaticSharedThread:!1,showInlineEmbeddedDisplay:!1,withVerticalPadding:!0,withHorizontalPadding:!0,clientThreadId:n,children:c.jsxs(Zb,{children:[c.jsx(Gv,{}),c.jsx($h,{children:c.jsx("div",{className:"w-full",children:c.jsx(om,{clientThreadId:n,isNewThread:i,currentModelId:e,onRequestCompletion:t,showPromptStarters:!1,composerController:s,autocompletions:l,requiresFileUpload:x,onComposerInput:G,onAutocompleteSelect:(D,V,J)=>{d([V[J]])},onTaggingDropdownClose:()=>{u.current=!1},onTaggingDropdownOpen:()=>{u.current=!0},hideHeader:!0})})}),j&&c.jsx(Wv,{initial:{opacity:0},animate:{opacity:1},transition:{duration:.3},promptStarters:T,onSelectStarterPrompt:N,isSendBlocked:o,clientThreadId:n,className:"h-8"})]})})})})})}function Gv(){const{layer:n}=ns("4031588851"),e=n.get("headline_option","HELP_WITH"),s=je().formatMessage(e==="WHERE_TO_START"?bl.whereShouldWeStart:bl.whatCanIHelpWith),[i,r]=S.useState(1),[o,a]=S.useState(!0),l=20;return S.useEffect(()=>{let d;return i<s.length?d=setTimeout(()=>{r(i+1)},l):o&&(d=setTimeout(()=>{a(!1)},500)),()=>clearTimeout(d)},[s,i,o]),c.jsxs("div",{className:"mb-7 flex justify-center text-center text-2xl font-semibold leading-9",children:[c.jsx("h1",{children:s.substring(0,i)}),c.jsx("h1",{className:"result-streaming transition-opacity",style:{opacity:o?1:0},children:c.jsx("span",{})})]})}function Wv({promptStarters:n,onSelectStarterPrompt:e,isSendBlocked:t,clientThreadId:s,...i}){return c.jsx(gt.div,{...i,children:c.jsx(Kv,{starterPrompts:n,onSelectStarterPrompt:e,disabled:t,clientThreadId:s})})}const Hv=/\s/;function qv({starterPrompt:n,starterPrompts:e,index:t,disabled:s,onSelectStarterPrompt:i}){const r=n.theme??n.title,o=Hv.test(r);return c.jsxs("button",{className:"relative flex items-center gap-1.5 rounded-full border border-token-border-light px-3 py-2 text-start text-[13px] shadow-xxs transition enabled:hover:bg-token-main-surface-secondary disabled:cursor-not-allowed xl:gap-2 xl:text-[14px]",disabled:s,onClick:()=>i(n,e,t),children:[c.jsx(Lg,{starterPrompt:n,useV2Colors:!0}),c.jsx("div",{className:te("max-w-full text-balance text-gray-600 dark:text-gray-500",o?"break-word":"break-all"),children:r})]})}function Cu({starterPrompts:n,onSelectStarterPrompt:e,disabled:t,clientThreadId:s,children:i}){return S.useEffect(()=>{To(n,s)},[s]),c.jsxs("ul",{className:"flex max-w-3xl flex-wrap items-stretch justify-center gap-2 xl:mx-3 xl:gap-2.5",children:[n.map((r,o)=>c.jsx(gt.li,{initial:{opacity:0},animate:{opacity:1},transition:{delay:o*.03},exit:{opacity:0},children:c.jsx(qv,{starterPrompt:r,starterPrompts:n,index:o,disabled:t,onSelectStarterPrompt:e})},r.id??o)),i]})}function $v({clientThreadId:n,onClick:e}){S.useEffect(()=>{t0(n)},[n]);const t=je();return c.jsx("button",{className:"relative flex max-w-full items-center gap-2 text-balance rounded-full border border-token-border-light px-3 py-2 text-start text-[14px] text-gray-600 shadow-xxs transition enabled:hover:bg-token-main-surface-secondary disabled:cursor-not-allowed dark:text-gray-500",onClick:()=>{n0(n),e()},children:t.formatMessage(bl.moreStarterPrompts)})}function Kv({starterPrompts:n,onSelectStarterPrompt:e,disabled:t,clientThreadId:s}){const[i,r]=S.useState(4),o=4,a=n.slice(0,o),l=n.slice(o,i).map(d=>({...d,isAdditional:!0}));return c.jsxs("div",{className:"mt-7 flex flex-col flex-wrap gap-y-2.5",children:[c.jsx("div",{children:c.jsx(Cu,{starterPrompts:a,onSelectStarterPrompt:e,disabled:t,clientThreadId:s,children:n.length>i&&c.jsx($v,{clientThreadId:s,onClick:()=>{r(n.length)}})})}),l&&l.length>0&&c.jsx(Cu,{starterPrompts:l,onSelectStarterPrompt:e,disabled:t,clientThreadId:s})]})}const bl=qe({whatCanIHelpWith:{id:"SplashScreenV2.whatCanIHelpWith",defaultMessage:"What can I help with?"},whereShouldWeStart:{id:"SplashScreenV2.whereShouldWeStart",defaultMessage:"Where should we start?"},moreStarterPrompts:{id:"SplashScreenV2.moreStarterPrompts",defaultMessage:"More"}});function am(n){const t=Bn(n)==="root",s=Ui(n),i=Fn(s),{serviceStatus:r}=S.useContext(Hx),o=ur(),{isUnauthenticated:a}=Xt();return!t&&!i&&!(r!=null&&r.oof)&&!o.displayingSideBySideFeedback&&!a}function lm({clientThreadId:n}){var o;const e=O.getThreadCurrentLeafId(n),s=((o=O.getTree(n).getMessage(e).metadata)==null?void 0:o.model_switcher_deny)??[],i={};s.forEach(a=>{const{slug:l,context:d,reason:u,description:p}=a,m=i[l]??{},b=m[d]??[];b.push({reason:u,description:p}),m[d]=b,i[l]=m});const r=zh();for(const{resets_after:a,model_slug:l}of r)[Jc.CONVERSATION,Jc.REGENERATE].forEach(d=>{const u=i[l]??{},p=u[d]??[],m={reason:Ko.RATE_LIMIT,resetsAfter:a};p.push(m),u[d]=p,i[l]=u});return i}var cm=(n=>(n.BROWSING="browsing_model",n.CODE_INTERPRETER="code_interpreter_model",n.DALLE="dalle_model",n))(cm||{}),Fs=(n=>(n.ALPHA="alpha",n.EXPERIMENTS="experiments",n.MAINLINE="mainline",n))(Fs||{});const Da={browsing_model:{name:c.jsxs("span",{children:["Browse with ",c.jsx(Gg,{className:"icon-sm mt-[-3px] inline-block"})," Bing"]})},code_interpreter_model:{name:"Advanced Data Analysis"},dalle_model:{name:"DALLE 3"}};function Jv(n){const e=Yv(n??void 0);return vh(["alpha","experiments","mainline"],e)?"bg-orange-500 text-white":"bg-token-main-surface-primary text-token-text-primary"}function Yv(n){const e=Rc();for(const t of e)if(t.options.length>0&&t.options.find(i=>i.value===n))return t.categoryId;return null}function Qv(n,e){const{data:t}=Bh();return(t==null?void 0:t.categories.some(i=>i[e]===n))??!1}const Xv=n=>Vg(n,({id:e})=>e.split(":").slice(0,1).join(":"));function Rc(){const{data:n}=Bh(),e=zg(),t=ts(),s=qx(t==null?void 0:t.getWorkspaceId()),i=(t==null?void 0:t.isEnterprise())??!1,{modelSwitcherDisclaimer:r}=Ug(),o=Kl();return S.useMemo(()=>{const a=[];if(!n)return a;const{categories:l,groups:d,modelsMap:u}=n;for(const p of l){const{defaultModel:m,categoryId:b,label:g}=p;if(o.has(m)){const x=e===m,k=n.modelsMap[m],M=x?[]:Zv(s.data,p,o,n.modelsMap,i);a.push({categoryId:b,value:m,name:g,description:x?r:k.description,options:[Ti(k,{name:"Default"}),...M]})}}for(const p of d){const{group:m,label:b,modelIds:g}=p,x=g[0],k=g.map(M=>u[M]).filter(({tags:M})=>!M.includes($x.HIDDEN));if(m==="experiments"){const M=Xv(k),N=Object.entries(M).map(([A,T])=>{const _=A.split(":").slice(-1)[0];return{key:A,value:_,name:_,options:T.map(j=>{const{title:P}=j;return Ti({...j,title:P.replace(_,"")})})}});a.push({categoryId:m,value:x,name:b,options:N})}else a.push({categoryId:m,value:x,name:b,options:k.map(M=>Ti(M))})}return a},[n,o,e,s.data,i,r])}function Ti(n,e={}){return{value:n.id,name:n.title,...e}}function Zv(n,e,t,s,i){const r=[],o=n==null?void 0:n.browsing;if((i&&o||!i)&&e.browsing_model!=null&&t.has(e.browsing_model)){const l=Da.browsing_model;r.push(Ti(s[e.browsing_model],{name:l.name}))}if(e.code_interpreter_model!=null&&t.has(e.code_interpreter_model)){const l=Da.code_interpreter_model;r.push(Ti(s[e.code_interpreter_model],{name:l.name}))}if(e.dalle_model!=null&&t.has(e.dalle_model)){const l=Da.dalle_model;r.push(Ti(s[e.dalle_model],{name:l.name}))}return r}const Dc=({categoryId:n,type:e,className:t})=>{const{data:s,isLoading:i}=xx(),r=c.jsx("div",{className:t});if(i)return r;const{iconFilledSrc:o,iconOutlineSrc:a}=(s==null?void 0:s[n])??{},l=(e==="filled"?o:a)??"";return c.jsx(Kh,{name:"ModelCategoryIcon",fallback:r,children:c.jsx("div",{className:te("[&_svg]:h-full [&_svg]:w-full",t),dangerouslySetInnerHTML:{__html:l}})})},dm=({clientThreadId:n,message:e})=>{var x,k,M,N,A,T,_,j;const t=Rc(),s=zo(Uo.ModelSwitcherAutoDowngrade),{categories:i}=_r({isRegen:!0}),r=lm({clientThreadId:n}),{doesUserHaveAnyAccountsWithPlusFeatures:o}=ri(),a=bx()!=null,l=[];for(const P of i){if(Th(P))continue;const{defaultModel:B,label:I,tagline:q,categoryId:G,subscriptionLevel:D}=P,V=(k=(x=r[B])==null?void 0:x.regenerate)==null?void 0:k[0];l.push({label:I,value:B,subtitle:q,icon:c.jsx(Dc,{className:"icon-md h-4 w-4",categoryId:G,type:"filled"}),modelSwitcherDeny:V,subscriptionLevel:D})}const d=eT(n,e.nodeId),u=(M=e.message.metadata)==null?void 0:M.model_slug,p=(N=t.find(P=>P.value===u))==null?void 0:N.name,m=tT(a,d,u),b=(A=e.message.metadata)==null?void 0:A.model_adjustments,g=o&&s.eligible&&!s.isLoading&&p&&((T=l[0])==null?void 0:T.label)&&p!==((_=l[0])==null?void 0:_.label)&&(b==null?void 0:b.some(P=>P.startsWith("auto:smaller_model")));return{modelOptions:l,modelSlug:u,animateModelLabelOnRender:m,nuxProps:{shouldRenderNux:g,usedModelName:p,largestModelName:(j=l[0])==null?void 0:j.label,announcement:s}}};function eT(n,e){var o,a;return(a=(o=O.getTree(n).getConversationTurns(e).flatMap(l=>l.messages).filter(l=>l.message.author.role===Ue.Assistant&&!Kx(l.message)).reverse()[1])==null?void 0:o.message.metadata)==null?void 0:a.model_slug}function tT(n,e,t){return n&&!e?!0:!!(e&&t!==e)}function nT(){const{doesUserHaveAnyAccountsWithPlusFeatures:n}=ri(),{categories:e}=_r();return!!n||!!e.find(Th)}const Sl=({modelSwitcherDeny:n,value:e,label:t,subtitle:s,icon:i,onMouseEnter:r,onMouseLeave:o,onSelect:a,messageModelSlug:l,isHovered:d=!1,shouldShowUpsell:u=!1,className:p,includeCheck:m,includeRegenerate:b})=>{const g=ts(),x=!n,k=!x&&!u,M=Bi(),N=()=>{if(!u){a==null||a();return}ee.logEvent($.openModalAccountPaymentfromMessageModelPicker),ee.logRateLimitGetPlusButtonClicked({type:Ko.RATE_LIMIT,location:"message_model_switcher_dropdown",plan_type:(g==null?void 0:g.planType)??"unknown",is_hard_block:!1,hard_block_reason:"",is_new_conversation:!1}),Pl(M,"Message model switcher dropdown")};return c.jsx(ve.Item,{onSelect:N,onMouseEnter:()=>x&&(r==null?void 0:r()),onMouseLeave:()=>x&&(o==null?void 0:o()),disabled:k,className:p??"radix-disabled:pointer-events-auto radix-disabled:cursor-not-allowed radix-disabled:hover:bg-transparent",children:c.jsxs(vs,{label:n&&c.jsx(Eh,{modelSwitcherDeny:n}),className:"flex w-full items-center justify-between gap-2",sideOffset:0,children:[c.jsxs("div",{className:"flex items-center gap-3",children:[c.jsx("span",{className:"flex h-7 w-7 items-center justify-center rounded-full bg-token-main-surface-secondary",children:i}),c.jsxs("div",{children:[c.jsx("div",{children:t}),c.jsx("div",{className:te({"text-sm text-token-text-secondary":!k},{"text-sm text-token-text-quaternary":k}),children:s})]})]}),u?c.jsx(It,{color:"secondary",size:"small",children:c.jsx(U,{id:"54fmrA",defaultMessage:"Get Plus"})}):c.jsx(sT,{messageModelSlug:l,isHovered:d,modelSwitcherDeny:n,optionModelSlug:e,includeCheck:m,includeRegenerate:b})]})})},sT=({modelSwitcherDeny:n,optionModelSlug:e,isHovered:t,messageModelSlug:s,includeRegenerate:i=!0,includeCheck:r=!0})=>{let o=null;if(n)switch(n.reason){case Ko.RATE_LIMIT:o=m0;break;default:o=gr;break}if(n)return c.jsx(o,{className:"icon-md"});const a=!!i&&c.jsx(Qo,{className:te("icon-md hidden text-token-text-tertiary",{"group-hover:block":t})});return s===e&&r?c.jsxs(c.Fragment,{children:[c.jsx(wf,{className:te("icon-md text-token-text-primary",{"group-hover:hidden":t})}),a]}):a};function iT({className:n,clientThreadId:e,message:t,onModelSelect:s,onDropdownChange:i}){const[r,o]=S.useState(null),[a,l]=S.useState(!1),[d,u]=S.useState(!1),p=nT(),m=am(e),b=hn(e),g=dm({clientThreadId:e,message:t}),{doesUserHaveAnyAccountsWithPlusFeatures:x}=ri(),k=S.useRef(null),M=I=>{I||setTimeout(()=>{k.current&&k.current.blur()},10)};if(S.useEffect(()=>{M(a)},[a]),!p||b)return null;const{modelOptions:N,modelSlug:A,animateModelLabelOnRender:T,nuxProps:_}=g;let j,P;_.shouldRenderNux?(j=oT,P={title:c.jsx(U,{id:"g/+2Hh",defaultMessage:"Optimized your response"}),description:c.jsx(U,{id:"H0Flqm",defaultMessage:"Used {usedModelName} for a faster response that saves your limited {largestModelName} messages",values:{usedModelName:_.usedModelName,largestModelName:_.largestModelName}}),markAsViewed:_.announcement.markAsViewed}):(j=rT,P={label:m?c.jsx(U,{id:"LBYK9a",defaultMessage:"Change model"}):c.jsx(U,{id:"nygjPN",defaultMessage:"Used {modelName}",values:{modelName:_.usedModelName}})});const B=m&&N.some(I=>kl(I,x));return c.jsxs(ve.Root,{onOpenChange:I=>{m&&(l(I),i(I),M(I)),I&&ee.logEvent($.conversationOpenMessageModelSelector,{has_get_plus_button:B})},children:[c.jsx(j,{...P,children:c.jsx(kf,{ref:k,className:te("cursor-pointer",n),onMouseEnter:()=>u(!0),onMouseLeave:()=>u(!1),children:c.jsx(wl,{modelSlug:A,animateModelLabelOnRender:T,isDropdownOpen:a,isRegenerateEnabled:m,isHovered:d})})}),m&&c.jsx(ve.Content,{className:"z-30 origin-top-right text-token-text-primary",side:"bottom",align:"start",children:N.map(I=>{var V;const q=kl(I,x),{value:G,...D}=I;return c.jsx(Sl,{value:G,onSelect:()=>s(G),onMouseEnter:()=>o(G),onMouseLeave:()=>o(null),isHovered:r===G,messageModelSlug:(V=t.message.metadata)==null?void 0:V.model_slug,shouldShowUpsell:q,...D},G)})})]})}function wl({modelSlug:n,animateModelLabelOnRender:e,isDropdownOpen:t,isRegenerateEnabled:s,isHovered:i,isRegenLabel:r=!1,animateShortLabel:o}){const[a,l]=S.useState("initial"),{categories:d}=_r({isRegen:!!r});S.useEffect(()=>{if(e){const k=setTimeout(()=>l("show"),500),M=setTimeout(()=>l("initial"),2e3);return()=>{clearTimeout(k),clearTimeout(M)}}l("initial")},[e]);const u=d.find(({defaultModel:k})=>k===n),p=n===Sx?{categoryId:"gpt_3.5",shorterLabel:"3.5"}:{},{categoryId:m,shorterLabel:b}=u??p,g={initial:{opacity:0,paddingLeft:0,width:"0"},show:{opacity:1,paddingLeft:2,width:"100%"},visible:{opacity:1,paddingLeft:2,width:"100%",transition:{delay:0,duration:0}}},x=t?"visible":i?"show":a;return c.jsxs(gt.div,{initial:"initial",animate:x,className:"flex items-center pb-0",children:[r?c.jsx(Qo,{className:"icon-md h-4 w-4"}):m&&c.jsx(Dc,{type:"outline",categoryId:m,className:"icon-md h-4 w-4"}),(s||o)&&c.jsx(gt.span,{className:"overflow-hidden text-clip whitespace-nowrap text-sm",variants:g,transition:{type:"tween",duration:.18},children:b}),s&&c.jsx(Yo,{className:te("icon-sm",{"text-token-text-quaternary":!i},{"text-token-text-secondary":i})})]})}function rT({children:n,label:e}){return c.jsx(vs,{label:e,sideOffset:0,children:n})}function oT({children:n,title:e,description:t,markAsViewed:s}){return c.jsx(Ol,{show:!0,side:"bottom",sideOffset:-4,title:e,description:t,badge:"beta",onDismiss:s,dismissOnOutsideClick:!0,children:n})}function kl(n,e){const{modelSwitcherDeny:t,subscriptionLevel:s}=n;return!!t&&t.reason===Ko.RATE_LIMIT&&s===Jx.PLUS&&!e}const aT=S.memo(iT),Mu=ko.IndepthFeedbackDismissedAt;function lT(){const[n,e]=S.useState(()=>{const s=localStorage.getItem(Mu);return s?cT(new Date(s)):!1}),t=S.useCallback(()=>{e(!0),localStorage.setItem(Mu,new Date().toISOString())},[]);return[n,t]}function cT(n){const e=new Date;return n.getFullYear()===e.getFullYear()&&n.getMonth()===e.getMonth()&&n.getDate()===e.getDate()}function dT({clientThreadId:n,conversationLeafId:e,trigger:t,variantIds:s}){const i=s.find(u=>u!==e),r=ii(u=>u.forceIndepthFeedback&&u.forceIndepthFeedbackPrompt),o=at.getExperimentValue({experimentName:"4146182738",key:t==="paragen"?"enable_indepth_feedback_paragen":"enable_indepth_feedback_thumbsdown",defaultValue:!1,shouldLogExposure:!1}),a=at.getExperimentValue({experimentName:"4146182738",key:t==="paragen"?"indepth_feedback_paragen_prompt":"indepth_feedback_thumbsdown_prompt",defaultValue:"",shouldLogExposure:!1}),l=i?O.getTree(n).getTextFromNode(i):"NONE";return(r||(o?a:"")).replace("{paragen_losing_response}",l)}function uT({clientThreadId:n,conversationLeafId:e,trigger:t,variantIds:s}){const[i,r]=lT(),o=fT({clientThreadId:n}),a=dT({clientThreadId:n,conversationLeafId:e,trigger:t,variantIds:s}),l=()=>{r(),ee.logEventWithStatsig($.messageIndepthFeedbackDeclined,"chatgpt_indepth_feedback_declined",{trigger:t})},d=()=>{o(e,{intent:"indepth_feedback"},a),ee.logEventWithStatsig($.messageIndepthFeedbackAccepted,"chatgpt_indepth_feedback_accepted",{trigger:t})};return i||!a?null:c.jsx(nh,{content:c.jsx(U,{...ja.indepthFeedbackPrompt}),primaryCtaText:c.jsx(U,{...ja.indepthFeedbackAcceptButton}),onPrimaryCtaClick:d,secondaryCtaText:c.jsx(U,{...ja.indepthFeedbackRejectButton}),onSecondaryCtaClick:l})}function hT(n){const e=n.rating==="thumbsDown"?"thumbsDown":vh(["original","new"],n.inlineComparisonRating)?"paragen":void 0,t=ii(i=>i.forceIndepthFeedback);if(!e||t||e==="paragen"||at.getExperimentValue({experimentName:"4146182738",key:"enable_indepth_feedback_thumbsdown",defaultValue:!1,shouldLogExposure:!0}))return e}function fT({clientThreadId:n}){const e=S.useContext(nc),t=Ot.getConversationMode(n);return(i,r,o)=>{e({type:On.Next,promptId:i,eventMetadata:r,focusOnNewCompletion:!0,cancelActiveRequests:!1,completionMetadata:{conversationMode:t},useDefaultModel:!1,appendMessages:[{id:Rr(),author:{role:Ue.System},content:{content_type:un.Text,parts:[o]},metadata:{is_indepth_feedback:!0,indepth_feedback_prompt:o}}]})}}const ja=qe({indepthFeedbackPrompt:{id:"qEHwDx",defaultMessage:"Would you like to tell ChatGPT more about your feedback, so it can improve its responses?"},indepthFeedbackAcceptButton:{id:"IeyTQ7",defaultMessage:"Continue"},indepthFeedbackRejectButton:{id:"+o5xmp",defaultMessage:"Not now"},indepthFeedbackRejectAlwaysButton:{id:"Qdko+f",defaultMessage:"Don't ask again"}});function pT({clientThreadId:n,conversationMode:e}){const t=im(n);return(i,r,o,a,l)=>{const u=O.getTree(n).getConversationTurns(i),p=u==null?void 0:u[(u==null?void 0:u.length)-1].variantIds,m=(p==null?void 0:p.length)===1,b=m?{...r,intent:"comparison_implicit"}:r;t({id:i,requestedModelId:o,eventMetadata:b,focusOnNewCompletion:!0,variantPurpose:m?"comparison_implicit":"none",conversationMode:e??Ot.getConversationMode(n),useDefaultModel:!1,appendMessages:a?[{id:Rr(),author:{role:Ue.System},content:{content_type:un.Text,parts:[a]},metadata:{exclude_after_next_user_message:!0}}]:void 0,juice:l})}}function mT(n){var e,t;return((t=(e=n.message.metadata)==null?void 0:e.finish_details)==null?void 0:t.type)==="content_filter"}function Gi(n){if(n===void 0)return{flagSeverity:void 0,shouldHideContent:!1,errCode:void 0,errMessage:void 0};const{errType:e,errCode:t,err:s,disclaimers:i}=n,r=mT(n);return!(i&&i.length>0)&&r?{flagSeverity:"warning",shouldHideContent:!1,errCode:cn.ContentOrTos,errMessage:s}:{flagSeverity:e,shouldHideContent:e==="danger"&&(t===cn.ContentPolicy||t===cn.ModelIncompatibility),disclaimers:i,errCode:t,errMessage:s}}function aa(n){return c.jsx(Ls,{flag:"danger",isUserTurn:!1,children:c.jsx(U,{...qt.somethingWentWrong})})}function gT({message:n,onRequestMoreCompletions:e,clientThreadId:t,id:s,isFeedbackEnabled:i,isUserTurn:r,className:o}){const{errCode:a,errMessage:l,flagSeverity:d}=Gi(n);switch(a){case cn.ContentPolicy:return c.jsx(Ls,{flag:d,isUserTurn:r,className:o,children:c.jsx(bT,{isFeedbackEnabled:i})});case cn.ModelIncompatibility:return c.jsx(Ls,{flag:d,isUserTurn:r,className:o,children:c.jsx(U,{...qt.modelIncompatibilityMessage})});case cn.ContentOrTos:return c.jsx(Ls,{flag:d,isUserTurn:r,className:o,children:c.jsx(xT,{isFeedbackEnabled:i})});case bo:return c.jsx(yT,{className:o,id:s,onRequestMoreCompletions:e,flag:d,clientThreadId:t,isUserTurn:r});case Jh:return c.jsx(Ls,{flag:d,isUserTurn:r,className:o,children:c.jsx(U,{...qt.historyDisabledConversationMissing})});default:return l!==void 0?c.jsx(Ls,{flag:d,isUserTurn:r,className:o,children:c.jsx(Wg,{rehypePlugins:[[Hg,{target:"_new",rel:"noopener noreferrer"}]],className:"markdown prose w-full break-words dark:prose-invert",children:l})}):null}}function yT({className:n,id:e,onRequestMoreCompletions:t,flag:s,clientThreadId:i,isUserTurn:r}){const o=Mh(x=>x.isoDate),a=qg(o),l=Es(i??Yx),d=l&&l.kind!==ot.PrimaryAssistant,u=Lh(),p=Jl(),m=S.useCallback(()=>{t(e,{eventSource:"mouse"},!0,"none",!1)},[e,t]),b=S.useCallback(()=>{const x=p.id;u({modelId:x,location:"Model switcher menu item"}),t(e,{eventSource:"mouse"},!0,"none",!0)},[t,e,p.id,u]);let g;return d?g=o!=null?c.jsx("span",{children:c.jsx(U,{...qt.gptUsageCapExceededCustomFeature,values:{link:vu,formattedTime:a}})}):c.jsx(U,{...qt.gptUsageCapExceededExpired}):g=o!=null?c.jsx("span",{children:c.jsx(U,{...qt.gptUsageCapExceeded,values:{link:vu,formattedTime:a}})}):c.jsx(U,{...qt.gptUsageCapExceededExpired}),c.jsx(Ls,{flag:o!=null?s:void 0,isUserTurn:r,className:n,children:c.jsxs("div",{className:"flex items-center gap-6",children:[g,o==null&&c.jsx(It,{color:"secondary",className:"flex-shrink-0",onClick:m,children:c.jsx(U,{...qt.buttonTryAgain})}),o!=null&&!d&&c.jsx(It,{color:"secondary",className:"flex-shrink-0",onClick:b,children:c.jsx(U,{...qt.buttonUseDefaultModel})})]})})}const vu=n=>c.jsx("a",{href:"https://share.hsforms.com/16d0ZZVM3QZirXnCD_q7u1Q4sk30",target:"_blank",rel:"noreferrer",className:"underline",children:n});function xT({isFeedbackEnabled:n}){return c.jsxs(c.Fragment,{children:[c.jsx("div",{className:n?"font-semibold":"",children:c.jsx(U,{...qt.contentOrTosViolationNoFeedback,values:{contentPolicyLink:um,termsLink:ST}})}),c.jsx("div",{children:n&&c.jsx(U,{...qt.contentPolicyFeedback})})]})}function bT({isFeedbackEnabled:n}){return c.jsxs(c.Fragment,{children:[c.jsx("div",{className:n?"font-semibold":"",children:c.jsx(U,{...qt.contentPolicyViolationNoFeedback,values:{contentPolicyLink:um}})}),c.jsx("div",{children:n&&c.jsx(U,{...qt.contentPolicyFeedback})})]})}const um=n=>c.jsx(_h,{target:"_blank",href:"https://openai.com/policies/usage-policies",rel:"noreferrer",children:n}),ST=n=>c.jsx(_h,{target:"_blank",href:"https://openai.com/policies/terms-of-use",rel:"noreferrer",children:n}),qt=qe({contentPolicyFeedback:{id:"TextMessageDisplay.contentPolicyFeedback",defaultMessage:"Did we get it wrong? Please tell us by giving this response a thumbs down."},contentPolicyViolation:{id:"TextMessageDisplay.contentPolicyViolation.2",defaultMessage:"This content may violate our <contentPolicyLink>usage policies</contentPolicyLink>. Did we get it wrong? Please tell us by giving this response a thumbs down."},contentPolicyViolationNoFeedback:{id:"TextMessageDisplay.contentPolicyViolationNoFeedback",defaultMessage:"This content may violate our <contentPolicyLink>usage policies</contentPolicyLink>."},modelIncompatibilityMessage:{id:"zXOUK3",defaultMessage:"This model can't support this action. Try again with a different model."},contentOrTosViolation:{id:"TextMessageDisplay.contentOrTosViolation.2",defaultMessage:"This content may violate our <termsLink>Terms of Use</termsLink> or <contentPolicyLink>usage policies</contentPolicyLink>. Did we get it wrong? Please tell us by giving this response a thumbs down."},contentOrTosViolationNoFeedback:{id:"TextMessageDisplay.contentOrTosViolationNoFeedback",defaultMessage:"This content may violate our <termsLink>Terms of Use</termsLink> or <contentPolicyLink>usage policies</contentPolicyLink>."},historyDisabledConversationMissing:{id:"TextMessageDisplay.historyDisabledConversationMissing",defaultMessage:"Sorry, conversations created when Chat History is off expire after 6 hours of inactivity. Please start a new conversation to continue using ChatGPT."},somethingWentWrong:{id:"TextMessageDisplay.somethingWentWrong",defaultMessage:"Something went wrong."},gptUsageCapExceeded:{id:"TextMessageDisplay.gptUsageCapExceeded",defaultMessage:"You've reached the current usage cap for GPT-4. You can continue with the default model now, or try again {formattedTime}. <link>Learn more</link>"},gptUsageCapExceededCustomFeature:{id:"TextMessageDisplay.gptUsageCapExceededCustomFeature",defaultMessage:"You've reached the current usage cap for GPT-4, please try again {formattedTime}. <link>Learn more</link>"},gptUsageCapExceededExpired:{id:"TextMessageDisplay.gptUsageCapExceededExpired",defaultMessage:"You previously reached your usage cap for GPT-4, but you can now try sending your message again"},buttonUseDefaultModel:{id:"TextMessageDisplay.buttonUseDefaultModel",defaultMessage:"Use default model"},buttonTryAgain:{id:"TextMessageDisplay.buttonTryAgain",defaultMessage:"Try again"}}),xi=typeof performance=="object"&&performance&&typeof performance.now=="function"?performance:Date,hm=new Set,Cl=typeof process=="object"&&process?process:{},fm=(n,e,t,s)=>{typeof Cl.emitWarning=="function"?Cl.emitWarning(n,e,t,s):console.error(`[${t}] ${e}: ${n}`)};let Fo=globalThis.AbortController,Tu=globalThis.AbortSignal;var $u;if(typeof Fo>"u"){Tu=class{constructor(){ie(this,"onabort");ie(this,"_onabort",[]);ie(this,"reason");ie(this,"aborted",!1)}addEventListener(s,i){this._onabort.push(i)}},Fo=class{constructor(){ie(this,"signal",new Tu);e()}abort(s){var i,r;if(!this.signal.aborted){this.signal.reason=s,this.signal.aborted=!0;for(const o of this.signal._onabort)o(s);(r=(i=this.signal).onabort)==null||r.call(i,s)}}};let n=(($u=Cl.env)==null?void 0:$u.LRU_CACHE_IGNORE_AC_WARNING)!=="1";const e=()=>{n&&(n=!1,fm("AbortController is not defined. If using lru-cache in node 14, load an AbortController polyfill from the `node-abort-controller` package. A minimal polyfill is provided for use by LRUCache.fetch(), but it should not be relied upon in other contexts (eg, passing it to other APIs that use AbortController/AbortSignal might have undesirable effects). You may disable this with LRU_CACHE_IGNORE_AC_WARNING=1 in the env.","NO_ABORT_CONTROLLER","ENOTSUP",e))}}const wT=n=>!hm.has(n),cs=n=>n&&n===Math.floor(n)&&n>0&&isFinite(n),pm=n=>cs(n)?n<=Math.pow(2,8)?Uint8Array:n<=Math.pow(2,16)?Uint16Array:n<=Math.pow(2,32)?Uint32Array:n<=Number.MAX_SAFE_INTEGER?oo:null:null;class oo extends Array{constructor(e){super(e),this.fill(0)}}var _i;const Vs=class Vs{constructor(e,t){ie(this,"heap");ie(this,"length");if(!C(Vs,_i))throw new TypeError("instantiate Stack using Stack.create(n)");this.heap=new t(e),this.length=0}static create(e){const t=pm(e);if(!t)return[];oe(Vs,_i,!0);const s=new Vs(e,t);return oe(Vs,_i,!1),s}push(e){this.heap[this.length++]=e}pop(){return this.heap[--this.length]}};_i=new WeakMap,De(Vs,_i,!1);let Ml=Vs;var Ku,Ju,mn,Vt,gn,yn,Ni,pt,xn,dt,Ze,me,Rt,Gt,vt,xt,bn,bt,Sn,wn,Wt,kn,ms,Dt,K,Tl,Hs,Yn,Mr,Ht,mm,qs,Ii,vr,ds,us,El,ao,lo,Xe,_l,nr;const Fc=class Fc{constructor(e){De(this,K);De(this,mn);De(this,Vt);De(this,gn);De(this,yn);De(this,Ni);ie(this,"ttl");ie(this,"ttlResolution");ie(this,"ttlAutopurge");ie(this,"updateAgeOnGet");ie(this,"updateAgeOnHas");ie(this,"allowStale");ie(this,"noDisposeOnSet");ie(this,"noUpdateTTL");ie(this,"maxEntrySize");ie(this,"sizeCalculation");ie(this,"noDeleteOnFetchRejection");ie(this,"noDeleteOnStaleGet");ie(this,"allowStaleOnFetchAbort");ie(this,"allowStaleOnFetchRejection");ie(this,"ignoreFetchAbort");De(this,pt);De(this,xn);De(this,dt);De(this,Ze);De(this,me);De(this,Rt);De(this,Gt);De(this,vt);De(this,xt);De(this,bn);De(this,bt);De(this,Sn);De(this,wn);De(this,Wt);De(this,kn);De(this,ms);De(this,Dt);De(this,Hs,()=>{});De(this,Yn,()=>{});De(this,Mr,()=>{});De(this,Ht,()=>!1);De(this,qs,e=>{});De(this,Ii,(e,t,s)=>{});De(this,vr,(e,t,s,i)=>{if(s||i)throw new TypeError("cannot set size without setting maxSize or maxEntrySize on cache");return 0});ie(this,Ku,"LRUCache");const{max:t=0,ttl:s,ttlResolution:i=1,ttlAutopurge:r,updateAgeOnGet:o,updateAgeOnHas:a,allowStale:l,dispose:d,disposeAfter:u,noDisposeOnSet:p,noUpdateTTL:m,maxSize:b=0,maxEntrySize:g=0,sizeCalculation:x,fetchMethod:k,noDeleteOnFetchRejection:M,noDeleteOnStaleGet:N,allowStaleOnFetchRejection:A,allowStaleOnFetchAbort:T,ignoreFetchAbort:_}=e;if(t!==0&&!cs(t))throw new TypeError("max option must be a nonnegative integer");const j=t?pm(t):Array;if(!j)throw new Error("invalid max value: "+t);if(oe(this,mn,t),oe(this,Vt,b),this.maxEntrySize=g||C(this,Vt),this.sizeCalculation=x,this.sizeCalculation){if(!C(this,Vt)&&!this.maxEntrySize)throw new TypeError("cannot set sizeCalculation without setting maxSize or maxEntrySize");if(typeof this.sizeCalculation!="function")throw new TypeError("sizeCalculation set to non-function")}if(k!==void 0&&typeof k!="function")throw new TypeError("fetchMethod must be a function if specified");if(oe(this,Ni,k),oe(this,ms,!!k),oe(this,dt,new Map),oe(this,Ze,new Array(t).fill(void 0)),oe(this,me,new Array(t).fill(void 0)),oe(this,Rt,new j(t)),oe(this,Gt,new j(t)),oe(this,vt,0),oe(this,xt,0),oe(this,bn,Ml.create(t)),oe(this,pt,0),oe(this,xn,0),typeof d=="function"&&oe(this,gn,d),typeof u=="function"?(oe(this,yn,u),oe(this,bt,[])):(oe(this,yn,void 0),oe(this,bt,void 0)),oe(this,kn,!!C(this,gn)),oe(this,Dt,!!C(this,yn)),this.noDisposeOnSet=!!p,this.noUpdateTTL=!!m,this.noDeleteOnFetchRejection=!!M,this.allowStaleOnFetchRejection=!!A,this.allowStaleOnFetchAbort=!!T,this.ignoreFetchAbort=!!_,this.maxEntrySize!==0){if(C(this,Vt)!==0&&!cs(C(this,Vt)))throw new TypeError("maxSize must be a positive integer if specified");if(!cs(this.maxEntrySize))throw new TypeError("maxEntrySize must be a positive integer if specified");se(this,K,mm).call(this)}if(this.allowStale=!!l,this.noDeleteOnStaleGet=!!N,this.updateAgeOnGet=!!o,this.updateAgeOnHas=!!a,this.ttlResolution=cs(i)||i===0?i:1,this.ttlAutopurge=!!r,this.ttl=s||0,this.ttl){if(!cs(this.ttl))throw new TypeError("ttl must be a positive integer if specified");se(this,K,Tl).call(this)}if(C(this,mn)===0&&this.ttl===0&&C(this,Vt)===0)throw new TypeError("At least one of max, maxSize, or ttl is required");if(!this.ttlAutopurge&&!C(this,mn)&&!C(this,Vt)){const P="LRU_CACHE_UNBOUNDED";wT(P)&&(hm.add(P),fm("TTL caching without ttlAutopurge, max, or maxSize can result in unbounded memory consumption.","UnboundedCacheWarning",P,Fc))}}static unsafeExposeInternals(e){return{starts:C(e,wn),ttls:C(e,Wt),sizes:C(e,Sn),keyMap:C(e,dt),keyList:C(e,Ze),valList:C(e,me),next:C(e,Rt),prev:C(e,Gt),get head(){return C(e,vt)},get tail(){return C(e,xt)},free:C(e,bn),isBackgroundFetch:t=>{var s;return se(s=e,K,Xe).call(s,t)},backgroundFetch:(t,s,i,r)=>{var o;return se(o=e,K,lo).call(o,t,s,i,r)},moveToTail:t=>{var s;return se(s=e,K,nr).call(s,t)},indexes:t=>{var s;return se(s=e,K,ds).call(s,t)},rindexes:t=>{var s;return se(s=e,K,us).call(s,t)},isStale:t=>{var s;return C(s=e,Ht).call(s,t)}}}get max(){return C(this,mn)}get maxSize(){return C(this,Vt)}get calculatedSize(){return C(this,xn)}get size(){return C(this,pt)}get fetchMethod(){return C(this,Ni)}get dispose(){return C(this,gn)}get disposeAfter(){return C(this,yn)}getRemainingTTL(e){return C(this,dt).has(e)?1/0:0}*entries(){for(const e of se(this,K,ds).call(this))C(this,me)[e]!==void 0&&C(this,Ze)[e]!==void 0&&!se(this,K,Xe).call(this,C(this,me)[e])&&(yield[C(this,Ze)[e],C(this,me)[e]])}*rentries(){for(const e of se(this,K,us).call(this))C(this,me)[e]!==void 0&&C(this,Ze)[e]!==void 0&&!se(this,K,Xe).call(this,C(this,me)[e])&&(yield[C(this,Ze)[e],C(this,me)[e]])}*keys(){for(const e of se(this,K,ds).call(this)){const t=C(this,Ze)[e];t!==void 0&&!se(this,K,Xe).call(this,C(this,me)[e])&&(yield t)}}*rkeys(){for(const e of se(this,K,us).call(this)){const t=C(this,Ze)[e];t!==void 0&&!se(this,K,Xe).call(this,C(this,me)[e])&&(yield t)}}*values(){for(const e of se(this,K,ds).call(this))C(this,me)[e]!==void 0&&!se(this,K,Xe).call(this,C(this,me)[e])&&(yield C(this,me)[e])}*rvalues(){for(const e of se(this,K,us).call(this))C(this,me)[e]!==void 0&&!se(this,K,Xe).call(this,C(this,me)[e])&&(yield C(this,me)[e])}[(Ju=Symbol.iterator,Ku=Symbol.toStringTag,Ju)](){return this.entries()}find(e,t={}){for(const s of se(this,K,ds).call(this)){const i=C(this,me)[s],r=se(this,K,Xe).call(this,i)?i.__staleWhileFetching:i;if(r!==void 0&&e(r,C(this,Ze)[s],this))return this.get(C(this,Ze)[s],t)}}forEach(e,t=this){for(const s of se(this,K,ds).call(this)){const i=C(this,me)[s],r=se(this,K,Xe).call(this,i)?i.__staleWhileFetching:i;r!==void 0&&e.call(t,r,C(this,Ze)[s],this)}}rforEach(e,t=this){for(const s of se(this,K,us).call(this)){const i=C(this,me)[s],r=se(this,K,Xe).call(this,i)?i.__staleWhileFetching:i;r!==void 0&&e.call(t,r,C(this,Ze)[s],this)}}purgeStale(){let e=!1;for(const t of se(this,K,us).call(this,{allowStale:!0}))C(this,Ht).call(this,t)&&(this.delete(C(this,Ze)[t]),e=!0);return e}info(e){const t=C(this,dt).get(e);if(t===void 0)return;const s=C(this,me)[t],i=se(this,K,Xe).call(this,s)?s.__staleWhileFetching:s;if(i===void 0)return;const r={value:i};if(C(this,Wt)&&C(this,wn)){const o=C(this,Wt)[t],a=C(this,wn)[t];if(o&&a){const l=o-(xi.now()-a);r.ttl=l,r.start=Date.now()}}return C(this,Sn)&&(r.size=C(this,Sn)[t]),r}dump(){const e=[];for(const t of se(this,K,ds).call(this,{allowStale:!0})){const s=C(this,Ze)[t],i=C(this,me)[t],r=se(this,K,Xe).call(this,i)?i.__staleWhileFetching:i;if(r===void 0||s===void 0)continue;const o={value:r};if(C(this,Wt)&&C(this,wn)){o.ttl=C(this,Wt)[t];const a=xi.now()-C(this,wn)[t];o.start=Math.floor(Date.now()-a)}C(this,Sn)&&(o.size=C(this,Sn)[t]),e.unshift([s,o])}return e}load(e){this.clear();for(const[t,s]of e){if(s.start){const i=Date.now()-s.start;s.start=xi.now()-i}this.set(t,s.value,s)}}set(e,t,s={}){var m,b,g,x,k;if(t===void 0)return this.delete(e),this;const{ttl:i=this.ttl,start:r,noDisposeOnSet:o=this.noDisposeOnSet,sizeCalculation:a=this.sizeCalculation,status:l}=s;let{noUpdateTTL:d=this.noUpdateTTL}=s;const u=C(this,vr).call(this,e,t,s.size||0,a);if(this.maxEntrySize&&u>this.maxEntrySize)return l&&(l.set="miss",l.maxEntrySizeExceeded=!0),this.delete(e),this;let p=C(this,pt)===0?void 0:C(this,dt).get(e);if(p===void 0)p=C(this,pt)===0?C(this,xt):C(this,bn).length!==0?C(this,bn).pop():C(this,pt)===C(this,mn)?se(this,K,ao).call(this,!1):C(this,pt),C(this,Ze)[p]=e,C(this,me)[p]=t,C(this,dt).set(e,p),C(this,Rt)[C(this,xt)]=p,C(this,Gt)[p]=C(this,xt),oe(this,xt,p),Br(this,pt)._++,C(this,Ii).call(this,p,u,l),l&&(l.set="add"),d=!1;else{se(this,K,nr).call(this,p);const M=C(this,me)[p];if(t!==M){if(C(this,ms)&&se(this,K,Xe).call(this,M)){M.__abortController.abort(new Error("replaced"));const{__staleWhileFetching:N}=M;N!==void 0&&!o&&(C(this,kn)&&((m=C(this,gn))==null||m.call(this,N,e,"set")),C(this,Dt)&&((b=C(this,bt))==null||b.push([N,e,"set"])))}else o||(C(this,kn)&&((g=C(this,gn))==null||g.call(this,M,e,"set")),C(this,Dt)&&((x=C(this,bt))==null||x.push([M,e,"set"])));if(C(this,qs).call(this,p),C(this,Ii).call(this,p,u,l),C(this,me)[p]=t,l){l.set="replace";const N=M&&se(this,K,Xe).call(this,M)?M.__staleWhileFetching:M;N!==void 0&&(l.oldValue=N)}}else l&&(l.set="update")}if(i!==0&&!C(this,Wt)&&se(this,K,Tl).call(this),C(this,Wt)&&(d||C(this,Mr).call(this,p,i,r),l&&C(this,Yn).call(this,l,p)),!o&&C(this,Dt)&&C(this,bt)){const M=C(this,bt);let N;for(;N=M==null?void 0:M.shift();)(k=C(this,yn))==null||k.call(this,...N)}return this}pop(){var e;try{for(;C(this,pt);){const t=C(this,me)[C(this,vt)];if(se(this,K,ao).call(this,!0),se(this,K,Xe).call(this,t)){if(t.__staleWhileFetching)return t.__staleWhileFetching}else if(t!==void 0)return t}}finally{if(C(this,Dt)&&C(this,bt)){const t=C(this,bt);let s;for(;s=t==null?void 0:t.shift();)(e=C(this,yn))==null||e.call(this,...s)}}}has(e,t={}){const{updateAgeOnHas:s=this.updateAgeOnHas,status:i}=t,r=C(this,dt).get(e);if(r!==void 0){const o=C(this,me)[r];if(se(this,K,Xe).call(this,o)&&o.__staleWhileFetching===void 0)return!1;if(C(this,Ht).call(this,r))i&&(i.has="stale",C(this,Yn).call(this,i,r));else return s&&C(this,Hs).call(this,r),i&&(i.has="hit",C(this,Yn).call(this,i,r)),!0}else i&&(i.has="miss");return!1}peek(e,t={}){const{allowStale:s=this.allowStale}=t,i=C(this,dt).get(e);if(i===void 0||!s&&C(this,Ht).call(this,i))return;const r=C(this,me)[i];return se(this,K,Xe).call(this,r)?r.__staleWhileFetching:r}async fetch(e,t={}){const{allowStale:s=this.allowStale,updateAgeOnGet:i=this.updateAgeOnGet,noDeleteOnStaleGet:r=this.noDeleteOnStaleGet,ttl:o=this.ttl,noDisposeOnSet:a=this.noDisposeOnSet,size:l=0,sizeCalculation:d=this.sizeCalculation,noUpdateTTL:u=this.noUpdateTTL,noDeleteOnFetchRejection:p=this.noDeleteOnFetchRejection,allowStaleOnFetchRejection:m=this.allowStaleOnFetchRejection,ignoreFetchAbort:b=this.ignoreFetchAbort,allowStaleOnFetchAbort:g=this.allowStaleOnFetchAbort,context:x,forceRefresh:k=!1,status:M,signal:N}=t;if(!C(this,ms))return M&&(M.fetch="get"),this.get(e,{allowStale:s,updateAgeOnGet:i,noDeleteOnStaleGet:r,status:M});const A={allowStale:s,updateAgeOnGet:i,noDeleteOnStaleGet:r,ttl:o,noDisposeOnSet:a,size:l,sizeCalculation:d,noUpdateTTL:u,noDeleteOnFetchRejection:p,allowStaleOnFetchRejection:m,allowStaleOnFetchAbort:g,ignoreFetchAbort:b,status:M,signal:N};let T=C(this,dt).get(e);if(T===void 0){M&&(M.fetch="miss");const _=se(this,K,lo).call(this,e,T,A,x);return _.__returned=_}else{const _=C(this,me)[T];if(se(this,K,Xe).call(this,_)){const q=s&&_.__staleWhileFetching!==void 0;return M&&(M.fetch="inflight",q&&(M.returnedStale=!0)),q?_.__staleWhileFetching:_.__returned=_}const j=C(this,Ht).call(this,T);if(!k&&!j)return M&&(M.fetch="hit"),se(this,K,nr).call(this,T),i&&C(this,Hs).call(this,T),M&&C(this,Yn).call(this,M,T),_;const P=se(this,K,lo).call(this,e,T,A,x),I=P.__staleWhileFetching!==void 0&&s;return M&&(M.fetch=j?"stale":"refresh",I&&j&&(M.returnedStale=!0)),I?P.__staleWhileFetching:P.__returned=P}}get(e,t={}){const{allowStale:s=this.allowStale,updateAgeOnGet:i=this.updateAgeOnGet,noDeleteOnStaleGet:r=this.noDeleteOnStaleGet,status:o}=t,a=C(this,dt).get(e);if(a!==void 0){const l=C(this,me)[a],d=se(this,K,Xe).call(this,l);return o&&C(this,Yn).call(this,o,a),C(this,Ht).call(this,a)?(o&&(o.get="stale"),d?(o&&s&&l.__staleWhileFetching!==void 0&&(o.returnedStale=!0),s?l.__staleWhileFetching:void 0):(r||this.delete(e),o&&s&&(o.returnedStale=!0),s?l:void 0)):(o&&(o.get="hit"),d?l.__staleWhileFetching:(se(this,K,nr).call(this,a),i&&C(this,Hs).call(this,a),l))}else o&&(o.get="miss")}delete(e){var s,i,r,o;let t=!1;if(C(this,pt)!==0){const a=C(this,dt).get(e);if(a!==void 0)if(t=!0,C(this,pt)===1)this.clear();else{C(this,qs).call(this,a);const l=C(this,me)[a];if(se(this,K,Xe).call(this,l)?l.__abortController.abort(new Error("deleted")):(C(this,kn)||C(this,Dt))&&(C(this,kn)&&((s=C(this,gn))==null||s.call(this,l,e,"delete")),C(this,Dt)&&((i=C(this,bt))==null||i.push([l,e,"delete"]))),C(this,dt).delete(e),C(this,Ze)[a]=void 0,C(this,me)[a]=void 0,a===C(this,xt))oe(this,xt,C(this,Gt)[a]);else if(a===C(this,vt))oe(this,vt,C(this,Rt)[a]);else{const d=C(this,Gt)[a];C(this,Rt)[d]=C(this,Rt)[a];const u=C(this,Rt)[a];C(this,Gt)[u]=C(this,Gt)[a]}Br(this,pt)._--,C(this,bn).push(a)}}if(C(this,Dt)&&((r=C(this,bt))!=null&&r.length)){const a=C(this,bt);let l;for(;l=a==null?void 0:a.shift();)(o=C(this,yn))==null||o.call(this,...l)}return t}clear(){var e,t,s;for(const i of se(this,K,us).call(this,{allowStale:!0})){const r=C(this,me)[i];if(se(this,K,Xe).call(this,r))r.__abortController.abort(new Error("deleted"));else{const o=C(this,Ze)[i];C(this,kn)&&((e=C(this,gn))==null||e.call(this,r,o,"delete")),C(this,Dt)&&((t=C(this,bt))==null||t.push([r,o,"delete"]))}}if(C(this,dt).clear(),C(this,me).fill(void 0),C(this,Ze).fill(void 0),C(this,Wt)&&C(this,wn)&&(C(this,Wt).fill(0),C(this,wn).fill(0)),C(this,Sn)&&C(this,Sn).fill(0),oe(this,vt,0),oe(this,xt,0),C(this,bn).length=0,oe(this,xn,0),oe(this,pt,0),C(this,Dt)&&C(this,bt)){const i=C(this,bt);let r;for(;r=i==null?void 0:i.shift();)(s=C(this,yn))==null||s.call(this,...r)}}};mn=new WeakMap,Vt=new WeakMap,gn=new WeakMap,yn=new WeakMap,Ni=new WeakMap,pt=new WeakMap,xn=new WeakMap,dt=new WeakMap,Ze=new WeakMap,me=new WeakMap,Rt=new WeakMap,Gt=new WeakMap,vt=new WeakMap,xt=new WeakMap,bn=new WeakMap,bt=new WeakMap,Sn=new WeakMap,wn=new WeakMap,Wt=new WeakMap,kn=new WeakMap,ms=new WeakMap,Dt=new WeakMap,K=new WeakSet,Tl=function(){const e=new oo(C(this,mn)),t=new oo(C(this,mn));oe(this,Wt,e),oe(this,wn,t),oe(this,Mr,(r,o,a=xi.now())=>{if(t[r]=o!==0?a:0,e[r]=o,o!==0&&this.ttlAutopurge){const l=setTimeout(()=>{C(this,Ht).call(this,r)&&this.delete(C(this,Ze)[r])},o+1);l.unref&&l.unref()}}),oe(this,Hs,r=>{t[r]=e[r]!==0?xi.now():0}),oe(this,Yn,(r,o)=>{if(e[o]){const a=e[o],l=t[o];if(!a||!l)return;r.ttl=a,r.start=l,r.now=s||i();const d=r.now-l;r.remainingTTL=a-d}});let s=0;const i=()=>{const r=xi.now();if(this.ttlResolution>0){s=r;const o=setTimeout(()=>s=0,this.ttlResolution);o.unref&&o.unref()}return r};this.getRemainingTTL=r=>{const o=C(this,dt).get(r);if(o===void 0)return 0;const a=e[o],l=t[o];if(!a||!l)return 1/0;const d=(s||i())-l;return a-d},oe(this,Ht,r=>{const o=t[r],a=e[r];return!!a&&!!o&&(s||i())-o>a})},Hs=new WeakMap,Yn=new WeakMap,Mr=new WeakMap,Ht=new WeakMap,mm=function(){const e=new oo(C(this,mn));oe(this,xn,0),oe(this,Sn,e),oe(this,qs,t=>{oe(this,xn,C(this,xn)-e[t]),e[t]=0}),oe(this,vr,(t,s,i,r)=>{if(se(this,K,Xe).call(this,s))return 0;if(!cs(i))if(r){if(typeof r!="function")throw new TypeError("sizeCalculation must be a function");if(i=r(s,t),!cs(i))throw new TypeError("sizeCalculation return invalid (expect positive integer)")}else throw new TypeError("invalid size value (must be positive integer). When maxSize or maxEntrySize is used, sizeCalculation or size must be set.");return i}),oe(this,Ii,(t,s,i)=>{if(e[t]=s,C(this,Vt)){const r=C(this,Vt)-e[t];for(;C(this,xn)>r;)se(this,K,ao).call(this,!0)}oe(this,xn,C(this,xn)+e[t]),i&&(i.entrySize=s,i.totalCalculatedSize=C(this,xn))})},qs=new WeakMap,Ii=new WeakMap,vr=new WeakMap,ds=function*({allowStale:e=this.allowStale}={}){if(C(this,pt))for(let t=C(this,xt);!(!se(this,K,El).call(this,t)||((e||!C(this,Ht).call(this,t))&&(yield t),t===C(this,vt)));)t=C(this,Gt)[t]},us=function*({allowStale:e=this.allowStale}={}){if(C(this,pt))for(let t=C(this,vt);!(!se(this,K,El).call(this,t)||((e||!C(this,Ht).call(this,t))&&(yield t),t===C(this,xt)));)t=C(this,Rt)[t]},El=function(e){return e!==void 0&&C(this,dt).get(C(this,Ze)[e])===e},ao=function(e){var r,o;const t=C(this,vt),s=C(this,Ze)[t],i=C(this,me)[t];return C(this,ms)&&se(this,K,Xe).call(this,i)?i.__abortController.abort(new Error("evicted")):(C(this,kn)||C(this,Dt))&&(C(this,kn)&&((r=C(this,gn))==null||r.call(this,i,s,"evict")),C(this,Dt)&&((o=C(this,bt))==null||o.push([i,s,"evict"]))),C(this,qs).call(this,t),e&&(C(this,Ze)[t]=void 0,C(this,me)[t]=void 0,C(this,bn).push(t)),C(this,pt)===1?(oe(this,vt,oe(this,xt,0)),C(this,bn).length=0):oe(this,vt,C(this,Rt)[t]),C(this,dt).delete(s),Br(this,pt)._--,t},lo=function(e,t,s,i){const r=t===void 0?void 0:C(this,me)[t];if(se(this,K,Xe).call(this,r))return r;const o=new Fo,{signal:a}=s;a==null||a.addEventListener("abort",()=>o.abort(a.reason),{signal:o.signal});const l={signal:o.signal,options:s,context:i},d=(x,k=!1)=>{const{aborted:M}=o.signal,N=s.ignoreFetchAbort&&x!==void 0;if(s.status&&(M&&!k?(s.status.fetchAborted=!0,s.status.fetchError=o.signal.reason,N&&(s.status.fetchAbortIgnored=!0)):s.status.fetchResolved=!0),M&&!N&&!k)return p(o.signal.reason);const A=b;return C(this,me)[t]===b&&(x===void 0?A.__staleWhileFetching?C(this,me)[t]=A.__staleWhileFetching:this.delete(e):(s.status&&(s.status.fetchUpdated=!0),this.set(e,x,l.options))),x},u=x=>(s.status&&(s.status.fetchRejected=!0,s.status.fetchError=x),p(x)),p=x=>{const{aborted:k}=o.signal,M=k&&s.allowStaleOnFetchAbort,N=M||s.allowStaleOnFetchRejection,A=N||s.noDeleteOnFetchRejection,T=b;if(C(this,me)[t]===b&&(!A||T.__staleWhileFetching===void 0?this.delete(e):M||(C(this,me)[t]=T.__staleWhileFetching)),N)return s.status&&T.__staleWhileFetching!==void 0&&(s.status.returnedStale=!0),T.__staleWhileFetching;if(T.__returned===T)throw x},m=(x,k)=>{var N;const M=(N=C(this,Ni))==null?void 0:N.call(this,e,r,l);M&&M instanceof Promise&&M.then(A=>x(A===void 0?void 0:A),k),o.signal.addEventListener("abort",()=>{(!s.ignoreFetchAbort||s.allowStaleOnFetchAbort)&&(x(void 0),s.allowStaleOnFetchAbort&&(x=A=>d(A,!0)))})};s.status&&(s.status.fetchDispatched=!0);const b=new Promise(m).then(d,u),g=Object.assign(b,{__abortController:o,__staleWhileFetching:r,__returned:void 0});return t===void 0?(this.set(e,g,{...l.options,status:void 0}),t=C(this,dt).get(e)):C(this,me)[t]=g,g},Xe=function(e){if(!C(this,ms))return!1;const t=e;return!!t&&t instanceof Promise&&t.hasOwnProperty("__staleWhileFetching")&&t.__abortController instanceof Fo},_l=function(e,t){C(this,Gt)[t]=e,C(this,Rt)[e]=t},nr=function(e){e!==C(this,xt)&&(e===C(this,vt)?oe(this,vt,C(this,Rt)[e]):se(this,K,_l).call(this,C(this,Gt)[e],C(this,Rt)[e]),se(this,K,_l).call(this,C(this,xt),e),oe(this,xt,e))};let vl=Fc;function kT({conversationId:n,messageId:e}){const[t,s]=S.useState(!1),i=S.useRef({isMediaSourceAvailable:jc(),mediaSourceFormat:Oc()??"n/a",playPromise:null,shouldAbortQueuedPlayback:!1}).current,r=je(),{voiceName:o}=$g(),a=`${n}.${e}.${o}`,l=Qx(),d=Xx(g=>{var x;return g.isPlaying&&g.sourceUrl===((x=an.get(a))==null?void 0:x.src)}),u=S.useCallback(async()=>{if(!l)return;s(!0);const g={isMediaSourceAvailable:i.isMediaSourceAvailable,format:i.mediaSourceFormat};try{const x=await CT({key:a,message_id:e,conversation_id:n,voice:o,onStreamingError:k=>{rr.readAloud.error(k,g),s(!1),ln.danger(r.formatMessage(Eu.playbackError,{error:k.message}))},onStreamingStart:()=>{s(!1)}});if(i.shouldAbortQueuedPlayback){i.shouldAbortQueuedPlayback=!1;return}l.changeSource(x),i.playPromise=l.play()}catch(x){rr.readAloud.error(x,g),s(!1),ln.danger(r.formatMessage(Eu.playbackError,{error:x.message}))}},[l,a,e,n,o,i,r]),p=S.useCallback(()=>{const g=Yc();g&&(i.playPromise?i.playPromise.then(()=>{g.stop(),i.playPromise=null}):g.stop())},[i]),m=S.useCallback(()=>{var x;const g=Yc();g&&(g.state.isPlaying&&g.state.sourceUrl===((x=an.get(a))==null?void 0:x.src)?p():(rr.readAloud.click({isMediaSourceAvailable:i.isMediaSourceAvailable,format:i.mediaSourceFormat}),u()))},[a,i,u,p]);S.useEffect(()=>{t&&d&&s(!1)},[t,d]);const b=S.useRef(a);return S.useEffect(()=>{b.current=a}),S.useEffect(()=>(i.shouldAbortQueuedPlayback=!1,()=>{var k;const g=Zx();g.isPlaying&&g.sourceUrl===((k=an.get(b.current))==null?void 0:k.src)?p():i.shouldAbortQueuedPlayback=!0}),[i,p]),{togglePlayback:m,isPlaying:d,isLoading:t}}async function gm({message_id:n,conversation_id:e,voice:t}){const s=await Je.synthesize({message_id:n,conversation_id:e,voice:t,format:Oc()}),i=s.headers.get("content-type")??"audio/aac";return{response:s,format:i}}async function CT(n){return jc()?vT(n):MT(n)}async function MT({key:n,...e}){const t=an.get(n);if(t!=null&&t.blob)return t.src;const{response:s,format:i}=await gm(e),r=await s.arrayBuffer(),o=new Blob([r],{type:i}),a=ym({key:n,src:URL.createObjectURL(o),format:i,blob:o});return an.set(n,a),a.src}async function vT({key:n,onStreamingError:e,onStreamingStart:t,...s}){let i=an.get(n);i!=null&&i.streaming&&(an.delete(n),i=void 0);let r,o;const a=ET(),l=new a;if(i)r=i,r.src=URL.createObjectURL(l);else{const{format:p,response:m}=await gm(s);o=m,r=ym({key:n,src:URL.createObjectURL(l),format:p})}const d=TT(r.id),u={sourceopen:async()=>{var b,g;d("sourceopen");const p=l.addSourceBuffer(r.format),m=async()=>{p.updating&&await new Promise(x=>p.addEventListener("updateend",x,{once:!0}))};if(r.segments.length&&!r.streaming){d("streaming from cache"),r.streaming=!0,t();for(const x of r.segments)p.appendBuffer(x),await m();l.readyState==="open"&&l.endOfStream(),r.streaming=!1,d("done streaming from cache");return}if(o){d("fetching audio");try{const x=(b=o.body)==null?void 0:b.getReader();if(!x)return;for(;((g=an.get(n))==null?void 0:g.id)===r.id;){const{done:k,value:M}=await x.read();if(k){d("done streaming"),r.streaming=!1,l.readyState==="open"&&l.endOfStream();break}if(!Array.from(l.sourceBuffers).includes(p)){d("stop streaming, source buffer removed"),r.streaming=!1;break}r.streaming||(d("start streaming"),r.streaming=!0,t()),p.appendBuffer(M),r.segments.push(M),await m()}}catch(x){if(d("error while streaming",x),r.streaming=!1,l.readyState==="open")try{l.endOfStream("network")}catch(k){rr.readAloud.error(k)}an.delete(n),e(x)}}},sourceclose:()=>{var p;d("sourceclose"),r.streaming&&(r.streaming=!1,((p=an.get(n))==null?void 0:p.id)===r.id&&(d("sourceclosed while streaming, cleaning up cache"),an.delete(n)))},sourceended:_t};for(const[p,m]of Object.entries(u))l.addEventListener(p,()=>{try{return m()}catch(b){rr.readAloud.error(b)}});return an.set(n,r),r.src}const Eu=qe({playbackError:{id:"useVoiceReadAloudAudio.playbackError",defaultMessage:"Failed to play message"}}),TT=n=>_t;function ET(){return jc()?window.MediaSource:null}function jc(){return!!Oc()}function Oc(){if("MediaSource"in window){const n=e=>eb(e)&&MediaSource.isTypeSupported(e);if(n("audio/aac"))return"aac";if(n("audio/mpeg"))return"mp3";if(n("audio/ogg"))return"ogg"}}const ym=n=>({id:Rr(),segments:[],streaming:!1,...n}),an=new vl({max:50,dispose:n=>{URL.revokeObjectURL(n.src)}}),_T=S.memo(function(e){var o;const t=(o=Qn("1923022511"))==null?void 0:o.value,s=Dr(e.conversationId),{errCode:i}=Gi(e.message);if(!t||!s||i)return null;const r=Yh.getAudioAssetPointers(e.message.message)[0];return r?c.jsx(NT,{audioAssetPointer:r}):c.jsx(IT,{...e,conversationId:s})});function NT({audioAssetPointer:n}){const{isLoading:e,isPlaying:t,togglePlayback:s}=Kg({audioAssetPointer:n});return c.jsx(xm,{onClick:s,isPlaying:t,isLoading:e,playText:Pc.replay})}function IT({conversationId:n,message:e}){const{isLoading:t,isPlaying:s,togglePlayback:i}=kT({conversationId:n,messageId:e.message.id});return c.jsx(xm,{onClick:i,isPlaying:s,isLoading:t,playText:Pc.play})}function xm({onClick:n,isPlaying:e,isLoading:t,playText:s}){let i,r;const o=je();return t?i=qh:e?(i=g0,r=Pc.stop):(i=y0,r=s),c.jsx(Zr,{icon:i,label:r?o.formatMessage(r):void 0,disabled:t,onClick:n,style:e||t?{visibility:"visible"}:void 0})}const Pc={replay:{id:"VoiceReadOutLoudButton.replay",defaultMessage:"Replay",description:"The tooltip for the replay button"},play:{id:"VoiceReadOutLoudButton.play",defaultMessage:"Read Aloud",description:"The tooltip for the read aloud button"},stop:{id:"VoiceReadOutLoudButton.stop",defaultMessage:"Stop",description:"The tooltip for the stop button"}},AT="bg-token-main-surface-primary text-token-text-primary",RT="openai",_u=["bg-blue-300 text-white"];function DT(n){return _u[((n==null?void 0:n.charCodeAt(0))??0)%_u.length]}const Kr=({children:n})=>c.jsx("div",{className:"pt-0",children:c.jsx("div",{className:te(S.isValidElement(n)&&n.type===Ka?"gizmo-bot-avatar":"gizmo-shadow-stroke","flex h-8 w-8 items-center justify-center overflow-hidden rounded-full"),children:n})});function Nl({messages:n,isUserTurn:e,avatarClassName:t,gizmo:s,showInlineEmbeddedDisplay:i=!1}){var b;const r="medium",o=n[0],a=(b=o==null?void 0:o.message.metadata)==null?void 0:b.shared_conversation_id,l=a!=null,d=Vl(),{gizmoEditorData:u,mode:p}=Er();let m=c.jsx(Kr,{children:c.jsx(Ka,{className:t??AT,iconName:RT,size:r})});return s?m=c.jsx(Kr,{children:c.jsx(W0,{gizmoId:s.gizmo.id,className:"h-full w-full"})}):u!=null&&p==="test"&&(m=c.jsx(vf,{isFirstParty:!1,src:u.profilePictureUrl,className:"h-8 w-8 first:pt-[3px]"})),c.jsx("div",{children:e?l||i?c.jsx(Kr,{children:c.jsx(Ka,{className:DT(a),iconName:"user",size:r})}):c.jsx(Kr,{children:c.jsx(Jg,{user:d,size:r})}):m})}const jT=We(()=>Ve(()=>import("./k91hjk4k5trlg30x.js"),__vite__mapDeps([70,1,2,3,63,4,5,8,64,65,6,66,7,16,25,24])).then(n=>n.default)),OT=We(()=>Ve(()=>import("./sso-ipuhfmti911l5wbt.js").then(n=>n.d),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69])).then(n=>n.default).catch(()=>aa)),PT=et.div`flex gap-2 flex-wrap mt-1 max-w-[80%] justify-end`,FT=et.div`flex flex-col gap-2`,BT=({parts:n,attachments:e,isUserTurn:t,clientThreadId:s})=>{const i=Ir(),r=Xo(s),o=Mf(),a=Yh.getImageAssetPointersFromParts(n),l=new Set(a.map(g=>Go(g.asset_pointer))),u=Tr()||i,p=(e??[]).filter(g=>Yg(g.name)),m=(e??[]).filter(g=>g.id==null||l.has(g.id)?!1:o||r?!p.includes(g):!0);return(o||r?(m.length>0||p.length>0)&&t:m.length>0&&t)?c.jsxs(c.Fragment,{children:[c.jsxs(PT,{children:[m.map(g=>c.jsx(Ch,{file:g.name,fileId:g.id,contextConnectorInfo:Qg(g.context_connector_info),width:i?"normal":"wide",alwaysShowData:!0},g.id)),r&&p.map(g=>c.jsx(OT,{clientThreadId:s,visualization:qc(g)},g.id))]}),o&&!r&&c.jsx(FT,{className:te(!u&&"w-[80%]"),children:p.map(g=>c.jsx(jT,{clientThreadId:s,visualization:qc(g)},g.id))})]}):null};function bm(n){return Xl(n)&&!tb(n)}const Jr=50,LT=95;function zT(n,e){if(n<=e)return n/e*Jr;{const t=Jr,s=LT-Jr,i=n-e,o=-(Jr/e)/s;return t+s*(1-Math.exp(o*i))}}class UT{constructor(){ie(this,"mostRecentCompletionRequest");ie(this,"loggedRequestIds",new Set)}onCompletionRequestStarted(e){this.mostRecentCompletionRequest={requestId:e,timestamp:Date.now()}}onDisplayTextAfterBrowsingSession(e,t){const s=this.mostRecentCompletionRequest;if(s!=null&&!this.loggedRequestIds.has(s.requestId)){const r=O.getThreadConversationTurns(e,t).find(o=>o.messages.some(a=>a.message.id===t));r!=null&&r.messages.some(o=>o.nodeId===s.requestId)&&(ee.logEvent($.browsingTimeToFirstTextToken,{messageId:t,timeMs:Date.now()-s.timestamp}),this.loggedRequestIds.add(s.requestId))}}}const Sm=new UT;function VT(n){var i;const e=n.find(r=>{var o;return((o=r.message.metadata)==null?void 0:o.image_search_results)!==void 0});return(((i=e==null?void 0:e.message.metadata)==null?void 0:i.image_search_results)??[]).slice(0,5)}function GT({messages:n}){const e=VT(n),t=Xg();return e.length===0?null:c.jsx("div",{className:te({"mb-2":!0,"grid grid-flow-col gap-3":e.length>1,"w-1/3":e.length===1}),children:e.filter(({contentUrl:s})=>t.has(s)).map((s,i)=>c.jsx("a",{href:s.hostPageUrl,target:"_blank",rel:"noreferrer",children:c.jsx("img",{src:s.contentUrl,alt:s.name,className:"aspect-square rounded-xl object-cover"})},i))})}const WT=We(()=>Ve(()=>import("./sso-ipuhfmti911l5wbt.js").then(n=>n.e),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69])).then(n=>n.default).catch(()=>aa));function wm({attachments:n,citations:e,contentReferences:t,className:s,clientThreadId:i,displayParts:r,id:o,isActivelyStreaming:a,isUserTurn:l,turnIndex:d,isFeedbackEnabled:u,messages:p,onRequestMoreCompletions:m,parts:b,prevGroupedMessageType:g,prevGroupedMessages:x,showEditButton:k,onEnterEdit:M,size:N="medium"}){var q,G,D;const A=Xo(i),T=p.length>1,{flagSeverity:_,shouldHideContent:j}=Gi(T?void 0:p[0]),P=!b.some(V=>V!==""),B=((q=sc("2342431234"))==null?void 0:q.value)!==!0,I=((G=p[0].message.metadata)==null?void 0:G.targeted_reply_label)??((D=p[0].message.metadata)==null?void 0:D.targeted_reply);return S.useEffect(()=>{!P&&g===de.Browsing&&Sm.onDisplayTextAfterBrowsingSession(i,p[0].message.id)},[P,p,i,g]),c.jsxs("div",{"data-message-author-role":p[0].message.author.role,"data-message-id":p[0].message.id,dir:"auto",className:te(s,"text-message flex w-full flex-col items-end gap-2 break-words [.text-message+&]:mt-5",!P&&"overflow-x-auto",B?"whitespace-pre-wrap":"whitespace-normal"),children:[I&&c.jsxs("div",{className:"mb-1 mt-1 flex items-start gap-1.5 text-sm font-normal text-token-text-tertiary",children:[c.jsx(dc,{className:"icon-md mt-1 shrink-0"}),c.jsx("p",{className:"mr-5 line-clamp-3",children:I})]}),l&&A&&c.jsx(WT,{clientThreadId:i,messages:p}),c.jsx(Zg,{messages:p}),c.jsx(HT,{parts:b,attachments:n,isUserTurn:l,turnIndex:d,displayParts:r,isActivelyStreaming:a,shouldHideContent:j,showEditButton:k,onEnterEdit:M,clientThreadId:i,id:o,isEmpty:P,prevGroupedMessageType:g,prevGroupedMessages:x,flagSeverity:_,messages:p,citations:e,contentReferences:t,size:N}),c.jsx(gT,{message:T?void 0:p[0],id:o,isFeedbackEnabled:u,onRequestMoreCompletions:m,clientThreadId:i,isUserTurn:l}),c.jsx(ey,{isUserTurn:l,message:T?void 0:p[0]}),!l&&!a&&x&&g===de.SearchResult&&c.jsx(GT,{messages:x})]})}function HT({clientThreadId:n,id:e,displayParts:t,turnIndex:s,isActivelyStreaming:i,shouldHideContent:r,showEditButton:o=!1,onEnterEdit:a,isEmpty:l,prevGroupedMessageType:d,prevGroupedMessages:u,messages:p,citations:m,contentReferences:b,size:g,isUserTurn:x,parts:k,attachments:M}){var V,J;const N=je(),A=ty(t),T=Nh(),_=(V=p[0].message.metadata)==null?void 0:V.gizmo_id,j=(J=p[0].message.metadata)==null?void 0:J.serialization_metadata,P=ny(p[0].message),B=!!_&&T.includes(_),I=c.jsx(BT,{parts:k,attachments:M,isUserTurn:x,clientThreadId:n},"files-and-tables"),q=!!(M!=null&&M.length||t.some(W=>W.type==="images")),G=t.map((W,X)=>{var ye;if(W.type==="transcription"){const L=r?null:W.text;let F=null;return x&&r?F=c.jsx("span",{className:"italic opacity-30",children:c.jsx(U,{...Yr.contentRemoved})}):x&&L!=null?F=L.trim().length===0?c.jsx("span",{className:"italic opacity-30",children:c.jsx(Ur,{text:N.formatMessage(Yr.transcriptUnavailable),customSymbolOffsets:void 0})}):c.jsx("span",{className:"italic opacity-65",children:c.jsx(Ur,{text:`${L.trim()}`,customSymbolOffsets:void 0})}):!x&&L!=null&&(F=c.jsx(Ur,{text:L,customSymbolOffsets:void 0})),c.jsx(fa,{containsImagesOrAttachments:q,isUserTurn:x,showEditButton:o,onEnterEdit:a,children:F},X)}else if(W.type==="text"){const L=r?null:W.text;if(!l&&!r&&!x){const F=d===de.CodeInterpreter?u==null?void 0:u.map(be=>be.message):void 0,{text:xe,contentReferences:re}=sy(A,m,b,B),{processedText:Z,displayedContentReferences:ke}=iy(xe,re,i?void 0:F);return c.jsx(ry.Provider,{value:{clientThreadId:n,message:p[0].message,contentReferences:ke,isActivelyStreaming:i,turnIndex:s,useSafeUrls:!0},children:c.jsx(Ih,{clientThreadId:n,messageId:e,size:g,className:te(i&&"result-streaming",P&&"headers-v2"),children:Z===""?"&#8203;":Z})},X)}else if(l&&i&&!x)return c.jsx("div",{className:"result-streaming",children:c.jsx("div",{children:c.jsx("pre",{})})},X);return c.jsx(fa,{containsImagesOrAttachments:q,isUserTurn:x,showEditButton:o,onEnterEdit:a,children:x&&r?c.jsx("span",{className:"italic opacity-30",children:c.jsx(U,{...Yr.contentRemoved})}):L?c.jsx(Ur,{text:L,customSymbolOffsets:j==null?void 0:j.custom_symbol_offsets}):null},X)}else if(W.type==="images"){const L=((ye=p[0].message.metadata)==null?void 0:ye.attachments)??[];return c.jsx(oy,{assets:W.imageAssets,attachments:L},X)}else return null}),D=t.findIndex(W=>W.type==="text");if(D!==-1?G.splice(D,0,I):G.push(I),r&&x)G.length=0,G.push(c.jsx(fa,{containsImagesOrAttachments:q,isUserTurn:x,onEnterEdit:_t,children:c.jsx("span",{className:"italic opacity-30",children:c.jsx(U,{...Yr.contentRemoved})})}));else if(r&&!x)return null;return c.jsx("div",{className:te("flex w-full flex-col gap-1 empty:hidden",x&&"items-end rtl:items-start",!x&&"first:pt-[3px]"),children:G})}const Yr=qe({contentRemoved:{id:"textMessage.contentRemoved",defaultMessage:"Content removed"},transcriptUnavailable:{id:"textMessage.transcriptUnavailable",defaultMessage:"Transcript Unavailable"}});function qT(n){var d;const{isActivelyStreaming:e,...t}=n,s=Li(),i=(s==null?void 0:s.includes("debug"))??!1,r=n.messages[n.messages.length-1].message.id,[o,a]=S.useState([]),l=S.useRef();return l.current===void 0&&(l.current=(s==null?void 0:s.includes(nb))??!1?new ay(n.parts,a,e,void 0,{debug:i}):new ly(n.parts,a,e)),S.useEffect(()=>{l.current!=null&&(l.current.onMessagePartsUpdated(n.parts,e),l.current.isBuffering()&&ir.addDelayedRenderingMessage(r))},[n.parts,r,e]),S.useEffect(()=>{l.current!=null&&!l.current.isBuffering()&&ir.removeDelayedRenderingMessage(r)},[o,r]),S.useEffect(()=>()=>ir.removeDelayedRenderingMessage(r),[r]),S.useEffect(()=>()=>{l.current!=null&&(l.current.destroy(),l.current=void 0)},[]),c.jsx(wm,{...t,displayParts:o,isActivelyStreaming:e||((d=l.current)==null?void 0:d.isBuffering())})}function $T({message:n,isCompletionInProgress:e,clientThreadId:t,className:s,isUserTurn:i,turnIndex:r,isFeedbackEnabled:o,prevGroupedMessageType:a,prevGroupedMessages:l,showEditButton:d,onEnterEdit:u,onRequestMoreCompletions:p}){var b,g,x;const m=S.useMemo(()=>"parts"in n.message.content?n.message.content.parts:[Jo(n.message)],[n]);return c.jsx(JT,{parts:m,messages:[n],isCompletionInProgress:e,className:s,citations:(b=n.message.metadata)==null?void 0:b.citations,contentReferences:(g=n.message.metadata)==null?void 0:g.content_references,attachments:(x=n.message.metadata)==null?void 0:x.attachments,isUserTurn:i,turnIndex:r,id:n.nodeId,isFeedbackEnabled:o,onRequestMoreCompletions:p,clientThreadId:t,showEditButton:d,onEnterEdit:u,prevGroupedMessageType:a,prevGroupedMessages:l})}const KT=ic.memo($T);function JT(n){const e=n.messages.length>1,{flagSeverity:t}=Gi(e?void 0:n.messages[0]),s=t!=="danger"&&n.isCompletionInProgress,i=!n.parts.some(o=>o!==""),[r]=S.useState(()=>!n.isUserTurn&&(n.isCompletionInProgress||i));return r?c.jsx(qT,{...n,isActivelyStreaming:s}):c.jsx(wm,{...n,displayParts:cy({isUserTurn:n.isUserTurn,parts:n.parts}),isActivelyStreaming:s})}const YT=We(()=>Ve(()=>import("./kc58xbimy8wdgqxx.js"),__vite__mapDeps([71,1,2,3])));function km({animationData:n,animationSegmentToPlay:e,animationLoopCounter:t}){const s=S.useRef(null);return S.useEffect(()=>{var i;(i=s.current)==null||i.playSegments(e,!0)},[t]),c.jsx(YT,{animationData:n,lottieRef:s,loop:!1,autoplay:!1})}function QT(n){return c.jsx(ql,{width:"8",height:"9",viewBox:"0 0 8 9",fill:"none",...n,children:c.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M7.66607 0.376042C8.01072 0.605806 8.10385 1.07146 7.87408 1.4161L3.54075 7.9161C3.40573 8.11863 3.18083 8.24304 2.93752 8.24979C2.69421 8.25654 2.46275 8.1448 2.31671 7.95008L0.150044 5.06119C-0.098484 4.72982 -0.0313267 4.25972 0.300044 4.01119C0.631415 3.76266 1.10152 3.82982 1.35004 4.16119L2.88068 6.20204L6.62601 0.584055C6.85577 0.239408 7.32142 0.146278 7.66607 0.376042Z",fill:"currentColor"})})}function XT(n){return c.jsxs(ql,{width:"4",height:"12",viewBox:"0 0 4 12",fill:"none",...n,children:[c.jsx("mask",{id:"path-1-inside-1_1975_4008",fill:"currentColor",children:c.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M1 6.5C1 7.05228 1.44772 7.5 2 7.5C2.55228 7.5 3 7.05228 3 6.5V1.5C3 0.947715 2.55228 0.5 2 0.5C1.44772 0.5 1 0.947715 1 1.5L1 6.5ZM0.75 10.25C0.75 10.9404 1.30964 11.5 2 11.5C2.69036 11.5 3.25 10.9404 3.25 10.25C3.25 9.55964 2.69036 9 2 9C1.30964 9 0.75 9.55964 0.75 10.25Z"})}),c.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M1 6.5C1 7.05228 1.44772 7.5 2 7.5C2.55228 7.5 3 7.05228 3 6.5V1.5C3 0.947715 2.55228 0.5 2 0.5C1.44772 0.5 1 0.947715 1 1.5L1 6.5ZM0.75 10.25C0.75 10.9404 1.30964 11.5 2 11.5C2.69036 11.5 3.25 10.9404 3.25 10.25C3.25 9.55964 2.69036 9 2 9C1.30964 9 0.75 9.55964 0.75 10.25Z",fill:"currentColor"}),c.jsx("path",{d:"M1 6.5H-0.25H1ZM1 1.5L-0.25 1.5L-0.25 1.5L1 1.5ZM2 6.25C2.13807 6.25 2.25 6.36193 2.25 6.5H-0.25C-0.25 7.74264 0.757359 8.75 2 8.75V6.25ZM1.75 6.5C1.75 6.36193 1.86193 6.25 2 6.25V8.75C3.24264 8.75 4.25 7.74264 4.25 6.5H1.75ZM1.75 1.5V6.5H4.25V1.5H1.75ZM2 1.75C1.86193 1.75 1.75 1.63807 1.75 1.5H4.25C4.25 0.257359 3.24264 -0.75 2 -0.75V1.75ZM2.25 1.5C2.25 1.63807 2.13807 1.75 2 1.75V-0.75C0.757359 -0.75 -0.25 0.257359 -0.25 1.5L2.25 1.5ZM2.25 6.5L2.25 1.5L-0.25 1.5L-0.25 6.5L2.25 6.5ZM2 10.25H-0.5C-0.5 11.6307 0.619288 12.75 2 12.75V10.25ZM2 10.25V12.75C3.38071 12.75 4.5 11.6307 4.5 10.25H2ZM2 10.25H2H4.5C4.5 8.86929 3.38071 7.75 2 7.75V10.25ZM2 10.25H2V7.75C0.619288 7.75 -0.5 8.86929 -0.5 10.25H2Z",fill:"currentColor",mask:"url(#path-1-inside-1_1975_4008)"})]})}function ZT(n){return c.jsx(ql,{width:"8",height:"9",viewBox:"0 0 8 9",fill:"none",...n,children:c.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M7.32256 1.48447C7.59011 1.16827 7.55068 0.695034 7.23447 0.427476C6.91827 0.159918 6.44503 0.199354 6.17748 0.515559L4.00002 3.08892L1.82256 0.515559C1.555 0.199354 1.08176 0.159918 0.765559 0.427476C0.449355 0.695034 0.409918 1.16827 0.677476 1.48447L3.01755 4.25002L0.677476 7.01556C0.409918 7.33176 0.449354 7.805 0.765559 8.07256C1.08176 8.34011 1.555 8.30068 1.82256 7.98447L4.00002 5.41111L6.17748 7.98447C6.44503 8.30068 6.91827 8.34011 7.23447 8.07256C7.55068 7.805 7.59011 7.33176 7.32256 7.01556L4.98248 4.25002L7.32256 1.48447Z",fill:"currentColor"})})}function N_({animationLoopCounter:n}){const{resolvedTheme:e}=Qh(),t=e==="dark";return c.jsx(km,{animationData:t?dy:uy,animationSegmentToPlay:[0,300],animationLoopCounter:n})}function I_({animationLoopCounter:n}){const{resolvedTheme:e}=Qh(),t=e==="dark";return c.jsx(km,{animationData:t?hy:fy,animationSegmentToPlay:[0,400],animationLoopCounter:n})}const e1=2e3,Cm=.4,t1=.45,n1=.2,s1=.1,i1=.25;var vn=(n=>(n[n.Running=0]="Running",n[n.Finished=1]="Finished",n[n.Error=2]="Error",n[n.Stopped=3]="Stopped",n[n.Paused=4]="Paused",n))(vn||{});function A_({conversationMessages:n,icon:e,status:t,text:s,estimatedToolDurationMs:i,animationLoopDurationMs:r=e1,shouldPersistAfterFinished:o=!1}){const[a,l]=S.useState(t===0?0:t===1&&!o?7:1),[d,u]=S.useState(0);S.useEffect(()=>{t===2?l(8):t===3?l(9):t===4?l(10):t===1?l(a===2?3:7):t===0&&a===10&&(l(2),u(m=>m+1))},[t]);const p=a1(a);return S.useEffect(()=>{const m=n[0].message.id;if(p)return ir.addDelayedRenderingMessage(m),()=>{ir.removeDelayedRenderingMessage(m)}},[p]),Ah(()=>{Ei(a)&&u(m=>m+1)},r),a===7&&!o?null:c.jsxs("div",{className:"my-2.5 flex items-center gap-2.5",children:[c.jsx(r1,{icon:e,status:t,uiState:a,estimatedToolDurationMs:i,animationLoopCounter:d,shouldPersistAfterFinished:o,onFillProgressBarAnimationComplete:()=>l(4),onFinishAnimationComplete:()=>{l(5),setTimeout(()=>{l(o?7:6)},s1*1e3)},onHideAnimationComplete:()=>l(7)}),c.jsx(o1,{text:s,uiState:a,animationLoopCounter:d,onEnterAnimationComplete:()=>l(2)})]})}const Nu=50;function r1({icon:n,status:e,uiState:t,estimatedToolDurationMs:s,animationLoopCounter:i,shouldPersistAfterFinished:r,onFillProgressBarAnimationComplete:o,onFinishAnimationComplete:a,onHideAnimationComplete:l}){const[d,u]=S.useState(0);Ah(()=>{Ei(t)?u(N=>N+Nu):t===10&&u(0)},Nu);let p,m,b;Ei(t)||t===10?(p="running",m=c.jsx(n,{animationLoopCounter:i}),b="bg-transparent"):t===4||t===5||t===7&&r?(p="finished",m=c.jsx(QT,{}),b="bg-brand-purple"):e===2?(p="error",m=c.jsx(XT,{}),b="bg-orange-500"):e===3&&(p="stopped",m=c.jsx(ZT,{}),b="bg-gray-300");let g={opacity:0,scale:0,rotate:-180,x:0},x={type:"spring",bounce:.3,duration:t1},k={opacity:0,scale:.6,rotate:0,x:0};t===0?(g={opacity:0,scale:.5,rotate:-180,x:-8},x={type:"spring",bounce:.3,duration:Cm}):t===1?g=!1:t===5&&(k={opacity:0,scale:0,rotate:0,x:0},x={type:"spring",bounce:.3,duration:i1});const M=zT(d,s);return c.jsx("div",{className:"relative h-5 w-5 shrink-0",children:c.jsx(Xs,{onExitComplete:()=>{t===6&&l()},children:p!=null&&c.jsxs(gt.div,{className:te("absolute left-0 top-0 flex h-full w-full items-center justify-center rounded-full text-white",b),initial:g,animate:{opacity:1,scale:1,rotate:0,x:0},exit:k,transition:x,onAnimationComplete:()=>{t===4&&a()},children:[m,(Ei(t)||t===10)&&c.jsx(py,{percentage:t===3?100:M,thickness:1.5/23,className:"absolute left-1/2 top-1/2 h-[23px] w-[23px] -translate-x-1/2 -translate-y-1/2 text-brand-purple",backgroundStrokeClassName:"stroke-brand-purple/25 dark:stroke-brand-purple/50",transitionDuration:t===3?`${(100-M)/100*n1}s`:void 0,transitionTimingFunction:t===3?"cubic-bezier(0.55, 0, 1, 1)":void 0,onTransitionEnd:()=>{t===3&&o()}})]},p)})})}function o1({text:n,uiState:e,animationLoopCounter:t,onEnterAnimationComplete:s}){const[i,r]=S.useState(n);S.useEffect(()=>{e===2&&r(n)},[t]),S.useEffect(()=>{Ei(e)||r(n)},[e,n]);let o={opacity:0,x:0,y:15},a={type:"spring",bounce:.3,opacity:{duration:.15},y:{duration:.3}};e===0?(o={opacity:0,x:-8,y:0},a={type:"spring",bounce:.3,duration:Cm,delay:.15}):e===1&&(o=!1);const l=i??void 0;return c.jsx("div",{className:te("relative h-5 w-full leading-5",e===8||e===9?"text-token-text-tertiary":"text-token-text-secondary"),children:c.jsx(Xs,{children:l!=null&&c.jsx(gt.div,{className:"absolute left-0 top-0 line-clamp-1 overflow-visible",initial:o,animate:{opacity:1,x:0,y:0},exit:{opacity:0,x:0,y:-15},transition:a,onAnimationComplete:()=>{e===0&&s()},children:l},l.toString())})})}function Ei(n){return n===0||n===2||n===3}function a1(n){return Ei(n)||n===4||n===5||n===6||n===10}function Mm({highlightedCommand:n,status:e,children:t,showWorkUserSetting:s=!1,hideOnlyIfNotInteractedWith:i=!1}){const r=t!=null,[o]=S.useState(s),[a,l]=S.useState(s),[d,u]=S.useState(!1);return(e===vn.Finished||e===vn.Error)&&(i?o?!1:!d:!1)?null:r?c.jsxs(c.Fragment,{children:[c.jsx(Iu,{$canShowWork:!0,children:c.jsx(Xs,{children:c.jsx(gt.button,{onClick:()=>{l(b=>!b),u(!0)},initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},className:te(e===vn.Running&&"loading-shimmer","group absolute left-0 top-0 mr-1.5 h-8 overflow-hidden"),children:c.jsxs("div",{className:"flex items-center justify-start gap-1",children:[c.jsx("span",{children:n}),a?c.jsx(x0,{className:"icon-md group-hover:visible md:invisible"}):c.jsx(Yo,{className:"icon-md group-hover:visible md:invisible"})]})},n==null?void 0:n.toString())})}),c.jsx(Xs,{children:a&&t&&c.jsx(gt.div,{initial:"collapsed",animate:"reveal",exit:"collapsed",variants:{collapsed:{translateY:-20,opacity:0,height:0},reveal:{translateY:0,opacity:1,height:"auto"}},transition:{duration:.3,ease:"easeInOut"},className:"overflow-hidden",children:t})})]}):c.jsx(Iu,{$canShowWork:!1,children:n})}const Iu=et.p`first:mt-0 my-1.5 relative h-8
${({$canShowWork:n})=>n?"text-token-text-secondary hover:text-token-text-primary":"text-token-text-secondary"}`,l1=We(()=>Ve(()=>import("./sso-ipuhfmti911l5wbt.js").then(n=>n.d),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69])).then(n=>n.default).catch(()=>aa)),Au=We(()=>Ve(()=>import("./k91hjk4k5trlg30x.js"),__vite__mapDeps([70,1,2,3,63,4,5,8,64,65,6,66,7,16,25,24])).then(n=>n.default));function c1({messages:n,isRequestActive:e,clientThreadId:t}){var k,M,N;const[s,i]=n,r=bm(s.message),o=(k=i==null?void 0:i.message.metadata)==null?void 0:k.aggregate_result,a=V0(),l=Mf(),d=Xo(t),u=i!=null&&i.message?G0(i.message):[],p=((N=(M=i==null?void 0:i.message.metadata)==null?void 0:M.aggregate_result)==null?void 0:N.messages.filter(Tf))??[],b=(u.filter(A=>A.type==="chart")??[]).length!==p.length,g=l&&!b;let x=vn.Running;return(o==null?void 0:o.status)==="success"?x=vn.Finished:i!=null&&i.message.content.content_type!==un.ExecutionOutput||o!=null&&o.status!=="running"?x=vn.Error:(r||!e)&&(x=vn.Stopped),c.jsxs(c.Fragment,{children:[c.jsx(d1,{messages:n,status:x,isRequestActive:e}),g&&u.map((A,T)=>{const{file_id:_,type:j}=A;return d?c.jsx(l1,{clientThreadId:t,isStreaming:x===vn.Running,visualization:A},_):j==="chart"&&!a?(A.fallback_to_image=!0,c.jsx(Ru,{children:c.jsx(Au,{clientThreadId:t,visualization:A})},T)):c.jsx(Ru,{children:c.jsx(Au,{clientThreadId:t,visualization:A})},T)}),!g&&i!=null&&c.jsx(H0,{message:i.message})]})}const Ru=et.div`mb-3 max-w-[80%]`;function d1({messages:n,status:e,isRequestActive:t}){var p;const[s,i]=n,r=je(),o=(p=i==null?void 0:i.message.metadata)==null?void 0:p.aggregate_result,a=bm(s.message),{data:l,error:d}=sb(ib.ShowExpandedCodeView);let u=r.formatMessage({id:"message.tools.data-analysis.running",defaultMessage:"Analyzing"});if((o==null?void 0:o.status)==="success"?u=r.formatMessage({id:"message.tools.data-analysis.finished",defaultMessage:"Analyzed"}):i!=null&&i.message.content.content_type!==un.ExecutionOutput||o!=null&&o.status!=="running"?u=r.formatMessage({id:"message.tools.data-analysis.error",defaultMessage:"Analysis errored"}):(a||!t)&&(u=r.formatMessage({id:"message.tools.data-analysis.stopped",defaultMessage:"Analysis paused"})),l!==void 0||d){const m=q0(s.message)!=null;return c.jsx(Mm,{status:e,highlightedCommand:u,showWorkUserSetting:l??!1,hideOnlyIfNotInteractedWith:!0,children:m?c.jsxs("div",{className:"mb-3 mt-0.5 overflow-hidden rounded-xl bg-black",children:[c.jsx($0,{message:s.message,FormattedText:Ih}),i!=null&&c.jsx(K0,{message:i.message})]}):null})}return null}function u1({nextMessage:n,isLastMessage:e,isRequestActive:t}){if(e||(n==null?void 0:n.message.content.content_type)===un.Text&&!(n!=null&&n.message.content.parts.some(i=>i.length>0))){const i=t?c.jsx(U,{id:"O+zD9o",defaultMessage:"Searching..."}):c.jsx(U,{id:"fssXGM",defaultMessage:"Error while searching"});return c.jsx(Mm,{highlightedCommand:i,status:t?vn.Running:vn.Error,children:i})}return null}const h1=We(()=>Ve(()=>import("./sso-ipuhfmti911l5wbt.js").then(n=>n.f),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69])).then(n=>n.default).catch(()=>aa)),f1=We(()=>Ve(()=>import("./o5cwi3uc9dagkivp.js"),__vite__mapDeps([72,1,2,3,4,5,9,7,8,17,73,74,27,61,6,75,54,12,13,14,15,16,24,25,62,23,76]))),p1=We(()=>Ve(()=>import("./de1sh4yg7kfyvnat.js"),__vite__mapDeps([77,1,2,3]))),m1=We(()=>Ve(()=>import("./ba7bhfdkajmvt0h4.js"),__vite__mapDeps([78,1,2,3,4,5,9,7,8,17,73,74,27,61,6,75,54,12,13,14,15,16,24,25,62,23,76]))),g1=We(()=>Ve(()=>import("./h61j7juun17jlipc.js"),__vite__mapDeps([79,1,2,3,4,5,7,8])).then(n=>n.TextMessageEditor)),y1=We(()=>Ve(()=>import("./ch7m0dtn3tkgxchl.js"),__vite__mapDeps([80,1,2,3,4,5,8,7,9,17,73,74,27,61,6,75,54,12,13,14,15,16,24,25,62,23,76]))),x1=We(()=>Ve(()=>import("./pdkvk4o7mhuecbpo.js"),__vite__mapDeps([81,1,2,3,4,5,9,7,8,17,73,74,27,61,6,75,54,12,13,14,15,16,24,25,62,23,76]))),b1=We(()=>Ve(()=>import("./mb9f30xbxwu6hage.js"),__vite__mapDeps([82,1,2,3,4,5,47,17,9,7,8,49,73,74,27,61,6,75,54,12,13,14,15,16,24,25,62,23,76])).then(n=>n.BrowsingMessage)),S1=We(()=>Ve(()=>import("./ktco86tc31me1kno.js"),__vite__mapDeps([83,1,2,3,47,4,5,9,7,8,17,73,74,27,61,6,75,54,12,13,14,15,16,24,25,62,23,76])).then(n=>n.SearchResultMessage)),w1=We(()=>Ve(()=>import("./khibibvll96oqiww.js"),__vite__mapDeps([84,1,2,3,17,4,5,9,7,8,54,27])).then(n=>n.GizmoContactsMessage)),k1=We(()=>Ve(()=>import("./md59z0s55jl7efgb.js"),__vite__mapDeps([85,1,2,3,4,5,17,9,7,8,73,74,27,61,6,75,54,12,13,14,15,16,24,25,62,23,76])).then(n=>n.JITPluginMessage));function C1(n){switch(n.type){case de.Text:case de.Debug:return[n.message];case de.MultiText:case de.Browsing:case de.CodeInterpreter:case de.JITPlugin:case de.RetrievalBrowsing:case de.ParallelBrowsing:case de.Dalle:case de.GizmoEditor:case de.SearchResult:case de.GizmoContacts:case de.a8km123:case de.Canmore:case de.SearchGPTQuery:return n.messages;default:throw new Error("Bad")}}function Il({groupedMessagesToRender:n,allGroupedMessages:e,clientThreadId:t,isEditing:s,isUserTurn:i,isCompletionRequestInProgress:r,isFeedbackEnabled:o,isFinalTurn:a,turnIndex:l,hasActiveRequest:d,showEditButton:u=!1,handleEnterEdit:p,handleExitEdit:m,onChangeItemInView:b,onRequestMoreCompletions:g,onRequestCompletion:x,shouldGrowContainer:k=!0}){const{showDebugConversationTurns:M}=ii(),N=Es(t),A=n.map((T,_)=>{var P,B,I,q,G,D,V,J,W,X,ye,L;const j=_===e.length-1;switch(T.type){case de.Text:case de.MultiText:{const F=n[_-1],xe=F==null?void 0:F.type,re=F&&"messages"in F?F.messages:void 0;if(T.type===de.Text){const Z=s?c.jsx(g1,{message:T.message,clientThreadId:t,onChangeItemInView:b,onRequestCompletion:x,onRequestMoreCompletions:g,onExitEdit:m,disabled:d}):c.jsx(KT,{className:"min-h-[20px]",message:T.message,isFeedbackEnabled:o,isCompletionInProgress:j&&r,turnIndex:l,clientThreadId:t,showEditButton:u,onEnterEdit:p,isUserTurn:i,onRequestMoreCompletions:g,prevGroupedMessageType:xe,prevGroupedMessages:re});return c.jsxs(S.Fragment,{children:[Z,c.jsx(gy,{isUserTurn:i,message:T.message.message})]},"group-"+T.message.nodeId)}else return T.type===de.MultiText?c.jsx(m1,{clientThreadId:t,messages:T.messages,isCompletionInProgress:j&&r,isFeedbackEnabled:o,onRequestMoreCompletions:g,prevGroupedMessageType:xe,prevGroupedMessages:re},"multitext-"+(((P=T.messages[0])==null?void 0:P.nodeId)??_)):T.type}case de.Browsing:case de.RetrievalBrowsing:{const F=N!=null&&[ot.GizmoInteraction,ot.GizmoMagicCreate,ot.GizmoTest].includes(N.kind);return c.jsx(b1,{messages:T.messages,isRequestActive:d,isLastMessageInTurn:j,isUsingGizmo:F,isRetrieval:T.type===de.RetrievalBrowsing},"browsing-"+(((B=T.messages[0])==null?void 0:B.nodeId)??_))}case de.SearchGPTQuery:{const F=e[_+1];return c.jsx(u1,{isRequestActive:d,isLastMessage:j,nextMessage:F&&F.type===de.Text?F.message:void 0},"searchquery-"+(((I=T.messages[0])==null?void 0:I.nodeId)??_))}case de.a8km123:return c.jsx(my,{messages:T.messages,isStreaming:j&&r},"sum-"+(((q=T.messages[0])==null?void 0:q.nodeId)??_));case de.ParallelBrowsing:return c.jsx(x1,{messages:T.messages},"parallel-"+(((G=T.messages[0])==null?void 0:G.nodeId)??_));case de.CodeInterpreter:return c.jsx(c1,{messages:T.messages,isRequestActive:d,clientThreadId:t},"ada-"+(((D=T.messages[0])==null?void 0:D.nodeId)??_));case de.JITPlugin:return c.jsx(k1,{messages:T.messages,clientThreadId:t,isLastTurnInConversation:a,onRequestCompletion:x},"jit-"+(((V=T.messages[0])==null?void 0:V.nodeId)??_));case de.GizmoContacts:return c.jsx(w1,{messages:T.messages,clientThreadId:t,isLastTurnInConversation:a,onRequestCompletion:x},"gizmo-contacts-"+(((J=T.messages[0])==null?void 0:J.nodeId)??_));case de.Dalle:return c.jsx(y1,{messages:T.messages,clientThreadId:t},"dalle-"+(((W=T.messages[0])==null?void 0:W.nodeId)??_));case de.GizmoEditor:return c.jsx(f1,{messages:T.messages},"gizmo-editor-"+(((X=T.messages[0])==null?void 0:X.nodeId)??_));case de.Canmore:return c.jsx(h1,{messages:T.messages,isRequestActive:d,clientThreadId:t},"canmore-"+(((ye=T.messages[0])==null?void 0:ye.nodeId)??_));case de.Debug:return M?c.jsx(p1,{message:T.message},"debug-"+T.message.nodeId):null;case de.SearchResult:return c.jsx(S1,{messages:T.messages},"search-result-"+(((L=T.messages[0])==null?void 0:L.nodeId)??_))}});return c.jsx(v1,{shouldGrowContainer:k,children:A})}function M1(){return c.jsx(yy,{type:"danger",children:c.jsx(U,{id:"daIg0P",defaultMessage:"Unable to display this message due to a error."})})}function v1({children:n,shouldGrowContainer:e}){return c.jsx("div",{className:te({"flex max-w-full flex-col":!0,"flex-grow":e}),children:c.jsx(Kh,{name:"GroupedMessages",fallback:M1,children:n})})}const Du="rounded-lg";function T1({className:n,clientThreadId:e,message:t,onModelSelect:s,onDropdownChange:i,canRegenerateResponse:r}){var B;const o=je(),[a,l]=S.useState(null),[d,u]=S.useState(!1),[p,m]=S.useState(!1),b=hn(e),g=dm({clientThreadId:e,message:t}),x=(B=t.message.metadata)==null?void 0:B.model_slug,{modelOptions:k,modelSlug:M,animateModelLabelOnRender:N}=g,A=S.useMemo(()=>k.find(I=>I.value==x),[k,x]),T=S.useRef(null),{doesUserHaveAnyAccountsWithPlusFeatures:_}=ri(),j=I=>{I||setTimeout(()=>{T.current&&T.current.blur()},10)};S.useEffect(()=>{j(d)},[d]);const P=r&&k.some(I=>kl(I,_));return b?null:c.jsxs(ve.Root,{onOpenChange:I=>{r&&(u(I),i(I),j(I)),I&&ee.logEvent($.conversationOpenMessageModelSelector,{has_get_plus_button:P,is_new_regen_dropdown:!0})},children:[r?c.jsx(E1,{label:c.jsx(U,{id:"LBYK9a",defaultMessage:"Change model"}),children:c.jsx(kf,{ref:T,className:te("cursor-pointer",n),onMouseEnter:()=>m(!0),onMouseLeave:()=>m(!1),children:c.jsx(wl,{modelSlug:M,animateModelLabelOnRender:N,isDropdownOpen:d,isRegenerateEnabled:r,isHovered:p,isRegenLabel:!0})})}):c.jsx("button",{className:te("cursor-pointer",n),onMouseEnter:()=>m(!0),onMouseLeave:()=>m(!1),children:c.jsx(wl,{modelSlug:M,animateModelLabelOnRender:N,isDropdownOpen:!1,isRegenerateEnabled:!1,isHovered:p,animateShortLabel:!0})}),r&&c.jsxs(ve.Content,{className:"z-30 origin-top-right text-token-text-primary",side:"bottom",align:"start",children:[c.jsx(ve.Item,{disabled:!0,className:"pb-0",children:c.jsx("b",{className:"text-token-text-secondary",children:c.jsx(U,{id:"bFLh5u",defaultMessage:"Switch model"})})}),k.map(({value:I,...q})=>c.jsx(Sl,{value:I,onSelect:()=>s(I),includeRegenerate:!1,onMouseEnter:()=>l(I),onMouseLeave:()=>l(null),isHovered:a===I,messageModelSlug:x,includeCheck:!1,className:Du,...q},I)),!!A&&c.jsxs(c.Fragment,{children:[c.jsx(ve.Separator,{}),c.jsx(Sl,{onSelect:()=>s(A.value),includeRegenerate:!0,onMouseEnter:()=>l(A.value),onMouseLeave:()=>l(null),messageModelSlug:x,includeCheck:!1,className:Du,...A,label:o.formatMessage(_1.tryAgain),subtitle:A.label,icon:c.jsx(Qo,{className:"icon-sm"})},A.value)]})]})]})}function E1({children:n,label:e}){return c.jsx(vs,{label:e,sideOffset:0,children:n})}const _1=qe({tryAgain:{id:"VbsBGW",defaultMessage:"Try again"}}),N1=S.memo(T1);function Al({messages:n,isMemoryEnabled:e,isMemoryFull:t,gizmoId:s,isParagen:i}){const[r,o]=S.useState(!1),[a,l]=S.useState(!1),{eligible:d,isLoading:u}=xy(),p=e&&!t,m=n.filter((x,k)=>{const M=n[k+1],A=(M==null?void 0:M.message.recipient)==="assistant"&&(M==null?void 0:M.message.author.role)===Ue.Tool&&(M==null?void 0:M.message.author.name)==="bio"&&Jo(M.message)==="Model set context updated."||!M&&p;return x.message.author.role===Ue.Assistant&&x.message.recipient==="bio"&&A}).flatMap(x=>{const k=x.message.content.content_type;return k===un.Text?x.message.content.parts:k===un.Code?[x.message.content.text]:[]}).map(I1),b=S.useMemo(()=>m.length>0,[m]);if(S.useEffect(()=>{b&&d&&!u&&Ri.openModal(hr.GlobalMemoryOnboarding)},[b,d,u]),m.length===0)return null;const g=x=>{const k=x??!a;l(k),k&&ee.logEvent($.memoryUpdatePopoverShown,{updateCount:m.length})};return c.jsxs(c.Fragment,{children:[c.jsx("div",{className:"inline-block",onMouseEnter:()=>g(!0),onMouseLeave:()=>g(!1),children:c.jsxs(by,{open:a,sideOffset:4,side:"bottom",alignAgainstAnchor:"start",size:"none",className:"z-10 min-w-60 max-w-96 text-sm",onOpenChange:x=>g(x),disableAutofocus:!0,triggerButton:c.jsxs("button",{className:te("my-1 flex items-center gap-1 text-sm font-semibold outline-none",a?"text-token-text-secondary":"text-token-text-tertiary"),children:[c.jsx(b0,{className:"mb-[-1px]"}),m.length===1?c.jsx(U,{id:"MemoryActionResult.memoryWriteSingular.1",defaultMessage:"Memory updated"}):c.jsx(U,{id:"MemoryActionResult.memoryWritePlural.1",defaultMessage:"Memories updated"})]}),children:[c.jsx("div",{className:"mb-2 rounded border border-token-border-light bg-token-main-surface-secondary",children:m.map((x,k)=>c.jsx("div",{className:"border-b border-token-border-light px-3 py-2 first-letter:uppercase last:border-b-0",children:x},k))}),i?c.jsx("div",{className:"text-xs text-token-text-tertiary",children:c.jsx(U,{id:"MemoryActionResult.paragenMessage",defaultMessage:"This memory will be saved if you choose this response."})}):c.jsxs("button",{className:"flex w-full items-center justify-between rounded px-3 py-2 font-semibold hover:bg-token-main-surface-secondary",onClick:()=>{o(!0),ee.logEvent($.memoryUpdatePopoverManageButtonClicked,{updateCount:m.length})},children:[c.jsx(U,{id:"MemoryActionResult.manageMemories",defaultMessage:"Manage memories"}),c.jsx(S0,{className:"icon-md -mr-1 text-token-text-tertiary"})]})]})}),r&&c.jsx(J0,{initialGizmoId:s,onClose:()=>o(!1)})]})}function I1(n){const e=["The user ","The user's ","User ","User's "];for(const t of e)if(n.startsWith(t))return n.slice(t.length);return n}function ju(n,e,t){O.updateTree(n,s=>{s.updateNodeMetadata(e,{inlineComparisonRating:t})})}const Ou=({messages:n})=>{for(const{message:{metadata:e}}of n){const{augmented_paragen_prompt_label:t}=e??{};if(t)return t}};function A1(n){const e=P1(),t=S.useRef({left_visibility_initial:null,left_visibility_max:null,right_visibility_initial:null,right_visibility_max:null});return n.stubSideBySideFeedback?c.jsx(vm,{shouldEnableUnifiedDesign:e,setPreferredFeedback:()=>{},leftVariantId:"left-placeholder",rightVariantId:"right-placeholder",leftTurn:null,rightTurn:null,originalTurn:null,hasActiveRequest:!0,visibilityStateRef:t,...n}):c.jsx(R1,{...n,shouldEnableUnifiedDesign:e,visibilityStateRef:t})}function R1({shouldEnableUnifiedDesign:n,...e}){const{clientThreadId:t,variantIds:s,variantsInStreamInfo:i}=e;if(s.length!==2)throw new Error("ConversationTurnSideBySideFeedback requires exactly two variant IDs");const[r]=S.useState(()=>Date.now()),o=Wl(),[a,l]=S.useMemo(()=>Rh(s.join(""))()<.5?[0,1]:[1,0],[s[0],s[1]]),d=a<l?"left":"right",u=d==="left"?"right":"left",p=s[a],m=s[l],b=nd(t,p),g=nd(t,m),x=Ji(sd(t,Ji(b).id)),k=Ji(sd(t,Ji(g).id)),M=d==="left"?x:k,N=d==="left"?k:x,A=i.display_treatment==="unskippable",T=A?"unskippable_parallel_2_in_stream:a:1.0":n?"skippable_parallel_2_in_stream:a:1.5":"skippable_parallel_2_in_stream:a:1.0";S.useEffect(()=>(ur.setState({displayingSideBySideFeedback:!0,unskippable:A}),()=>{ur.setState({displayingSideBySideFeedback:!1,unskippable:!1})}),[A]),Sy();const _=S.useRef({left_visibility_initial:null,left_visibility_max:null,right_visibility_initial:null,right_visibility_max:null});S.useEffect(()=>rb(Dh,{requestCompletion:()=>{var I,q,G,D;const P=(I=Yi(M.messages))==null?void 0:I.completionSampleFinishTime,B=(q=Yi(N.messages))==null?void 0:q.completionSampleFinishTime;Je.submitMessageComparisonFeedback({feedback_version:T,original_message_id:(G=M.messages[M.messages.length-1])==null?void 0:G.message.id,new_message_id:(D=N.messages[N.messages.length-1])==null?void 0:D.message.id,rating:"none",conversation_id:O.getServerThreadId(t),text:"",tags:[],completion_comparison_rating:"skip",new_completion_placement:u,feedback_start_time:r,compare_step_start_time:r,original_completion_load_start_time:r,original_completion_load_end_time:P??0,new_completion_load_start_time:r,new_completion_load_end_time:B??0,frontend_submission_time:Date.now(),timezone_offset_min:new Date().getTimezoneOffset(),..._.current})}}),[x,k,t,r,T,u,M==null?void 0:M.messages,N==null?void 0:N.messages]);const j=P=>{var W,X,ye,L;const I=O.getTree(t).getLeafFromNode(P);O.setThreadCurrentLeafId(t,I.id);const G=P===p===(d==="left"),D=(W=Yi(M.messages))==null?void 0:W.completionSampleFinishTime,V=(X=Yi(N.messages))==null?void 0:X.completionSampleFinishTime;M.messages.length>0&&ju(t,M.messages[M.messages.length-1].nodeId,G?"original":"new"),N.messages.length>0&&ju(t,N.messages[N.messages.length-1].nodeId,G?"original":"new");let J;D==null||V==null?J=G?"partial_load_comparison_original":"partial_load_comparison_new":J=G?"original":"new",Je.submitMessageComparisonFeedback({feedback_version:T,original_message_id:(ye=M.messages[M.messages.length-1])==null?void 0:ye.message.id,new_message_id:(L=N.messages[N.messages.length-1])==null?void 0:L.message.id,rating:"none",conversation_id:O.getServerThreadId(t),text:"",tags:[],completion_comparison_rating:J,new_completion_placement:u,feedback_start_time:r,compare_step_start_time:r,original_completion_load_start_time:r,original_completion_load_end_time:D??null,new_completion_load_start_time:r,new_completion_load_end_time:V??null,frontend_submission_time:Date.now(),timezone_offset_min:new Date().getTimezoneOffset(),..._.current})};return c.jsx(vm,{...e,setPreferredFeedback:j,leftVariantId:p,rightVariantId:m,leftTurn:x,rightTurn:k,hasActiveRequest:o,shouldEnableUnifiedDesign:n,originalTurn:M,visibilityStateRef:_})}function D1(n){if(!n.length)return!1;const e=n.filter(t=>t.type===de.Text||t.type===de.MultiText).filter(t=>{var s;return t.message.message.status!=="finished_successfully"&&((s=t.message.message.metadata)==null?void 0:s.snorkle_status)!==void 0});return e.length>0&&e.every(t=>{const s=t.message.message.content;return(s==null?void 0:s.content_type)===un.Text&&s.parts.join("")===""})}function vm({setPreferredFeedback:n,shouldEnableUnifiedDesign:e,leftVariantId:t,rightVariantId:s,leftTurn:i,rightTurn:r,hasActiveRequest:o,originalTurn:a,visibilityStateRef:l,...d}){const{defaultParagenLabel:u,shouldShowParagenLabels:p=!1}=sh(),m=i&&Ou(i)||u,b=r&&Ou(r)||u,g=S.useMemo(()=>(i==null?void 0:i.messages)??[],[i==null?void 0:i.messages]),x=S.useMemo(()=>(r==null?void 0:r.messages)??[],[r==null?void 0:r.messages]),{avatarClassName:k}=d,M=S.useMemo(()=>So(g),[g]),N=S.useMemo(()=>So(x),[x]),A=Bo(),T=ii();function _(ke){var Oe,ce;if(!T.showDebugConversationTurns&&!T.forceParagen)return null;let be=ke===a?"ORIGINAL":"NEW";const le=ke.messages[ke.messages.length-1],he=(ce=(Oe=le==null?void 0:le.message)==null?void 0:Oe.metadata)==null?void 0:ce.__internal;if(he){const{model_id:z,model_definition_slug:Ce,model_definition_virtual_model_id:Ye,augmented_paragen_prompt_group_id:Qe,augmented_paragen_prompt_id:Ee,augmented_paragen_prompt:ae}=he;z&&(be+=`
Model ID: ${z}`),Ce&&(be+=`
Model Slug: ${Ce}`),Ye&&(be+=`
Virtual Model ID: ${Ye}`),Qe&&(be+=`
Prompt Group ID: ${Qe}`),Ee&&(be+=`
Prompt ID: ${Ee}`),ae&&(be+=`
Prompt: ${ae}`)}return c.jsx("div",{className:"whitespace-pre-wrap text-sm text-red-500",children:be})}const[j,P]=S.useMemo(()=>[M,N].map(ke=>D1(ke)),[M,N]),B=Fn(i?mr.getRequestIdFromConversationTurn(i):"")||j,I=Fn(r?mr.getRequestIdFromConversationTurn(r):"")||P,q=(i==null?void 0:i.role)===Ue.User,G=(r==null?void 0:r.role)===Ue.User,D=Rl(),V=S.useRef(null),J=S.useRef(null),W=S.useRef(null);S.useEffect(()=>{if(V.current&&J.current&&W.current){const ke=Array(11).fill(0).map((le,he)=>he/10),be=new IntersectionObserver(le=>le.forEach(he=>{he.target===J.current?(l.current.left_visibility_initial==null&&(l.current.left_visibility_initial=he.intersectionRatio),l.current.left_visibility_max=Math.max(l.current.left_visibility_max??0,he.intersectionRatio)):he.target===W.current&&(l.current.right_visibility_initial==null&&(l.current.right_visibility_initial=he.intersectionRatio),l.current.right_visibility_max=Math.max(l.current.right_visibility_max??0,he.intersectionRatio))}),{root:V.current,threshold:ke});return be.observe(J.current),be.observe(W.current),()=>be.disconnect()}},[l]);const{data:X}=Lo(void 0,!1,A),ye=F1(),L=X==null?void 0:X.memoryFullPct,F=typeof L=="number"&&L>=100,xe=c.jsx(U,{id:"TK934w",defaultMessage:"Which response do you prefer? Responses may take a moment to load."});let re,Z;switch(ye){case 1:{re=c.jsx(U,{id:"JgCHDY",defaultMessage:"Youre giving feedback on a new version of ChatGPT."}),Z=xe;break}case 2:{re=c.jsx(U,{id:"AOeHRv",defaultMessage:"Youre giving feedback on an experimental version of ChatGPT."}),Z=xe;break}case 0:default:{re=c.jsx(U,{...sr.responsePrompt}),Z=c.jsx(U,{...sr.responsePromptExplanation});break}}return c.jsxs("div",{className:"relative flex flex-col",children:[c.jsx("div",{className:"sticky top-[-1px] z-[1] text-pretty bg-token-main-surface-primary px-6 text-center text-lg md:static",children:re}),c.jsx("div",{className:"text-pretty px-6 pb-5 pt-1 text-center text-sm text-token-text-secondary",children:Z}),c.jsx("div",{className:"sticky top-[calc(1.75em-1px)] z-[1] h-3 bg-gradient-to-b from-token-main-surface-primary from-50% to-transparent md:static"}),c.jsx("div",{className:"-mb-2 snap-x snap-mandatory overflow-x-auto px-3 pb-4 md:px-5 lg:px-10",ref:V,children:c.jsx("div",{className:"min-w-fit",children:c.jsxs("div",{className:te({"mx-auto flex max-w-6xl":!0,"gap-2 sm:gap-3":!e,"items-start gap-4 sm:gap-6":e}),children:[c.jsxs(Pu,{elemRef:J,onClick:()=>{n(t)},shouldEnableUnifiedDesign:e,hasActiveRequest:o,children:[c.jsxs(Bu,{children:[c.jsx(Nl,{messages:g,isUserTurn:q,avatarClassName:k,showInlineEmbeddedDisplay:!1}),c.jsx(Fu,{children:p?c.jsx("span",{className:"font-bold text-token-text-primary",children:m}):c.jsx(U,{...sr.responseNumber,values:{responseIndex:1}})})]}),X!=null&&!q&&c.jsx(Al,{messages:g,isMemoryEnabled:D,isMemoryFull:F,isParagen:!0}),c.jsx(Il,{...d,groupedMessagesToRender:M,allGroupedMessages:M,isEditing:!1,isUserTurn:q,isCompletionRequestInProgress:B,hasActiveRequest:o,handleEnterEdit:_t,handleExitEdit:_t,shouldGrowContainer:!e}),!!i&&_(i)]}),c.jsxs(Pu,{elemRef:W,onClick:()=>{n(s)},shouldEnableUnifiedDesign:e,hasActiveRequest:o,children:[c.jsxs(Bu,{children:[c.jsx(Nl,{messages:x,isUserTurn:G,avatarClassName:k,showInlineEmbeddedDisplay:!1}),c.jsx(Fu,{children:p?c.jsx("span",{className:"font-bold text-token-text-primary",children:b}):c.jsx(U,{...sr.responseNumber,values:{responseIndex:2}})})]}),X!=null&&!G&&c.jsx(Al,{messages:x,isMemoryEnabled:D,isMemoryFull:F,isParagen:!0}),c.jsx(Il,{...d,groupedMessagesToRender:N,allGroupedMessages:N,isEditing:!1,isUserTurn:G,isCompletionRequestInProgress:I,hasActiveRequest:o,handleEnterEdit:_t,handleExitEdit:_t,shouldGrowContainer:!e}),!!r&&_(r)]})]})})})]})}function Pu({shouldEnableUnifiedDesign:n,...e}){return n?c.jsx(j1,{...e}):c.jsx(O1,{...e})}function j1({elemRef:n,onClick:e,children:t,hasActiveRequest:s}){return c.jsxs("div",{className:"relative flex w-full min-w-[min(450px,80vw)] snap-center flex-col gap-1 truncate rounded-2xl border border-token-main-surface-tertiary bg-white p-5 text-left dark:bg-gray-700",ref:n,children:[t,s?null:c.jsx(It,{className:"mt-4 self-start",onClick:e,children:c.jsx(U,{id:"U2EAH6",defaultMessage:"I prefer this response"})})]})}function O1({elemRef:n,onClick:e,children:t}){const s=ob(),i="relative flex w-full flex-col gap-1 bg-white cursor-pointer truncate rounded-lg border border-token-main-surface-tertiary text-left dark:bg-gray-700 p-3 sm:py-4 sm:px-5 hover:border-gray-300 min-w-[min(450px,80vw)] snap-center";return s?c.jsx("button",{className:i,onClick:e,ref:n,children:t}):c.jsxs("div",{className:i,ref:n,children:[t,c.jsx("button",{className:"mt-4 rounded-full bg-token-main-surface-primary p-2",onClick:e,children:c.jsx(U,{...sr.responseChoice})})]})}const Fu=et.div`text-sm text-token-text-tertiary font-semibold`,Bu=et.div`flex gap-4 items-center mb-1`,sr=qe({responsePrompt:{id:"ConversationTurnTwoUpFeedback.responsePrompt",defaultMessage:"Which response do you prefer?"},responsePromptExplanation:{id:"ConversationTurnTwoUpFeedback.responsePromptExplanation",defaultMessage:"Your choice will help make ChatGPT better."},responseNumber:{id:"ConversationTurnTwoUpFeedback.responseNumber",defaultMessage:"Response {responseIndex, number}"},responseChoice:{id:"ConversationTurnTwoUpFeedback.responseChoice",defaultMessage:"Choose this response"}});function P1(){const{layer:n}=ns("229662723");return n.get("should-enable-chair",!1)}function F1(){const{layer:n}=ns("229662723");return n.get("bread-version",0)}function B1({clientThreadId:n,messageForRating:e,variantIds:t,conversationTurnMountTime:s}){const[i]=S.useState(()=>e.message.create_time!=null?e.message.create_time*1e3:Date.now()),[r]=S.useState(()=>Date.now());function o(a){var _,j;const l=O.getTree(n),d=t[0]||"",u=(l==null?void 0:l.getConversationTurns(d))||[],p=u[u.length-1],m=(p==null?void 0:p.messages)||[],b=m[m.length-1],g=((_=b==null?void 0:b.message)==null?void 0:_.id)||"",x=t[1]||"",k=(l==null?void 0:l.getConversationTurns(x))||[],M=k[k.length-1],N=(M==null?void 0:M.messages)||[],A=N[N.length-1],T=((j=A==null?void 0:A.message)==null?void 0:j.id)||"";Je.submitMessageComparisonFeedback({feedback_version:"inline_regen_feedback:a:1.0",original_message_id:g,new_message_id:T,rating:"none",conversation_id:O.getServerThreadId(n),text:"",tags:[],completion_comparison_rating:a,new_completion_placement:"not-applicable",feedback_start_time:s,compare_step_start_time:s,new_completion_load_start_time:i,new_completion_load_end_time:r,frontend_submission_time:Date.now(),timezone_offset_min:new Date().getTimezoneOffset()}),O.updateTree(n,P=>{P.updateNodeMetadata(e.nodeId,{inlineComparisonRating:a})}),O.updateTree(n,P=>{P.updateNodeMetadata(b.nodeId,{inlineComparisonRating:"baseline"})})}return c.jsxs(L1,{children:[c.jsx("h6",{className:"min-w-[150px] grow",children:c.jsx(U,{...Qr.regenTitle})}),c.jsxs("div",{className:"flex flex-wrap items-end justify-center gap-2",children:[c.jsx(It,{color:"secondary",onClick:()=>o("new"),children:c.jsx(U,{...Qr.regenBetterText})}),c.jsx(It,{color:"secondary",onClick:()=>o("original"),children:c.jsx(U,{...Qr.regenWorseText})}),c.jsx(It,{color:"secondary",onClick:()=>o("same"),children:c.jsx(U,{...Qr.regenSameText})})]}),c.jsx(Ya,{onClick:()=>{O.updateTree(n,a=>{a.updateNodeMetadata(e.nodeId,{inlineComparisonRating:"skip"})})}})]})}const L1=et.div`flex items-center p-4 rounded-2xl bg-token-main-surface-primary text-token-text-primary text-sm border border-token-border-light gap-5 mt-3`,Qr=qe({regenTitle:{id:"ConversationTurnInlineFeedback.regenTitle",defaultMessage:"Was this response better or worse?"},regenBetterText:{id:"ConversationTurnInlineFeedback.regenBetterText",defaultMessage:"Better"},regenWorseText:{id:"ConversationTurnInlineFeedback.regenWorseText",defaultMessage:"Worse"},regenSameText:{id:"ConversationTurnInlineFeedback.regenSameText",defaultMessage:"Same"}}),Lu=({allGroupedMessages:n})=>n.some(e=>[de.Browsing,de.RetrievalBrowsing,de.ParallelBrowsing].includes(e.type)),zu=({allGroupedMessages:n})=>n.some(e=>e.type===de.CodeInterpreter);function z1(n){return!n||!n.instructions?"":typeof n.instructions=="string"?n.instructions:n.instructions.filter(e=>typeof e=="string").join("")}const U1=[{match:Lu,tag:"Shouldn't have searched the web",label:mt({id:"kL047b",defaultMessage:"Shouldn't have searched the web"})},{match:Lu,tag:"Don't like the source it cited",label:mt({id:"+ds/Q/",defaultMessage:"Don't like the source it cited"})},{match:zu,tag:"Shouldn't have run code",label:mt({id:"53w4ay",defaultMessage:"Shouldn't have run code"})},{match:zu,tag:"Couldn't handle my file",label:mt({id:"EkFTQ5",defaultMessage:"Couldn't handle my file"})},{match:({allGroupedMessages:n})=>n.some(e=>e.type===de.Dalle),tag:"Shouldn't have created an image",label:mt({id:"S8FRsr",defaultMessage:"Shouldn't have created an image"})},{match:({allGroupedMessages:n})=>n.some(e=>{if(e.type!==de.Text)return!1;const{message:t}=e.message,{content:s}=t;return s.content_type===un.Text&&Jo(t).match(/^```[\S]+\n/gm)}),tag:"Code was incorrect",label:mt({id:"4EBdQk",defaultMessage:"Code was incorrect"})},{match:({systemContent:n})=>z1(n).includes("Personality")??!1,tag:"Too chatty or casual",label:mt({id:"ATzJKW",defaultMessage:"Too chatty or casual"})},{match:({features:n})=>n.includes(Ar.Sunshine),tag:"Shouldn't have used Memory",label:mt({id:"yfUEiz",defaultMessage:"Shouldn't have used Memory"})},{tag:"Don't like the style",label:mt({id:"nGxjdj",defaultMessage:"Don't like the style"})},{tag:"Not factually correct",label:mt({id:"Ke7JtQ",defaultMessage:"Not factually correct"})},{tag:"Didn't fully follow instructions",label:mt({id:"Rdlt9V",defaultMessage:"Didn't fully follow instructions"})},{tag:"Refused when it shouldn't have",label:mt({id:"2yRS/Q",defaultMessage:"Refused when it shouldn't have"})},{tag:"Being lazy",label:mt({id:"14MPmT",defaultMessage:"Being lazy"})},{tag:"Unsafe or problematic",label:mt({id:"02pXBl",defaultMessage:"Unsafe or problematic"})},{tag:"Other",label:mt({id:"WiIGE+",defaultMessage:"Other"})}],V1=[{tag:"I disagree with the policy",label:mt({id:"oKyDLz",defaultMessage:"I disagree with the policy"})},{tag:"This didn't violate the policy",label:mt({id:"7fUkVF",defaultMessage:"This didn't violate the policy"})},{tag:"I don't understand the policy",label:mt({id:"4Cdp6N",defaultMessage:"I don't understand the policy"})},{tag:"This didn't take the full context",label:mt({id:"vnZJDP",defaultMessage:"This didn't take the full context"})}];function G1(n,e,t){return e.filter(s=>!s.match||s.match(t)).map(s=>({value:s.tag,label:n.formatMessage(s.label)}))}function W1(n){const e=n[n.length-1];if(!e)return!1;const t="message"in e?e.message:null;if(t){const{errCode:s}=Gi(t);return[cn.ContentPolicy,cn.ContentOrTos].includes(s)}else return!1}function H1({clientThreadId:n,conversationMessage:e,currentModelId:t,allGroupedMessages:s}){const i=je(),r=Li()??[],o=e.rating,{value:a}=Qn("1410082514"),l=Lb(n,e.message.id),d=(l==null?void 0:l.message.content.content_type)===un.SystemContent?l==null?void 0:l.message.content:null,u=S.useCallback(b=>{var M;const g=O.getServerThreadId(n);if(!g||b.tags.length===0&&!b.textFeedback)return;ee.logEvent(b.source==="inline"?$.messageFeedbackInlineSubmitted:$.messageFeedbackDialogSubmitted,{id:e.message.id,threadId:g,tags:b.tags,content:b.textFeedback,model:t,rating:o});const k=a&&((M=e.message.metadata)==null?void 0:M.snorkle_status)!=null?Je.submitSnorkleFeedback:Je.submitMessageFeedback;o&&k({message_id:e.message.id,conversation_id:g,rating:o,text:b.textFeedback,tags:b.tags,tag_choices:b.tagChoices})},[n,e.message,t,o,a]),p=()=>{ee.logEvent($.messageFeedbackMoreOptionsClicked,{id:e.message.id,threadId:O.getServerThreadId(n),model:t,rating:o})},m=G1(i,W1(s)?V1:U1,{allGroupedMessages:s,features:r,currentModelId:t,systemContent:d});return o==="thumbsUp"?null:c.jsx(Y0,{tagOptions:m,onSubmit:u,onMoreClicked:p})}const Uu=[1,2,3,4],q1=.5;function $1({clientThreadId:n,conversationLeafId:e}){const t=wo($l.isBusinessWorkspace),s=S.useRef(!1),i=Dr(n),r=Es(n),{isUnauthenticated:o}=Xt(),{value:a}=Qn("1410082514"),l=S.useMemo(()=>{if(!i)return-1;const D=Rh(i);return D()>q1?-1:Uu[Math.floor(D()*Uu.length)]},[i]),d=lf(n,e),u=d[d.length-1],p=S.useMemo(()=>mr.getRequestIdFromConversationTurn(u),[u]),m=Fn(p),[b,g]=S.useState(null),[x,k]=S.useState(!1),[M,N]=S.useState(!1),[A,T]=S.useState(!1),_=D=>{var J,W;const V=(W=(J=Yi(d))==null?void 0:J.messages[0])==null?void 0:W.message.id;g(D),q(V,D)},j=d.filter(D=>D.role===Ue.Assistant).length,P=(u==null?void 0:u.role)===Ue.Assistant,B=u==null?void 0:u.messages.some(D=>{var V;return(V=D.message.metadata)==null?void 0:V.is_nulligen}),I=a&&(u==null?void 0:u.messages.some(D=>{var V;return((V=D.message.metadata)==null?void 0:V.snorkle_status)!=null})),q=S.useMemo(()=>Hl((D,V)=>{i&&D&&(I?Je.submitSnorkleFeedback({conversation_id:i,message_id:D,rating:V}):Je.submitConversationRating({conversation_id:i,message_id:D,rating:V,shown_at_assistant_turn:l})),ee.logEvent($.conversationRatingSubmitted,{rating:V,showAtAssistantTurn:l,conversationId:i}),k(!0),setTimeout(()=>{N(!0)},1500)},2e3),[i,l,I]),G=j!==l||m||!P||B||!!t||(r==null?void 0:r.kind)!==ot.PrimaryAssistant||A||o;return S.useEffect(()=>{!G&&!s.current&&(ee.logEvent($.conversationRatingShown,{showAtAssistantTurn:l,conversationId:i}),s.current=!0)},[G]),A||G&&!I?null:c.jsxs("div",{className:"mx-auto",children:[c.jsx(Xs,{children:x&&!M&&c.jsx(gt.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},children:c.jsx(Vu,{$padded:!0,children:c.jsx("span",{className:"text-sm text-token-text-tertiary",children:c.jsx(U,{id:"rating.thanks",defaultMessage:"Thanks for your feedback!"})})})},"submitted")}),!x&&c.jsx(gt.div,{initial:{opacity:0},animate:{opacity:1},transition:{duration:.1},children:c.jsxs(Vu,{$padded:!1,children:[c.jsxs("div",{className:"flex items-center justify-center gap-4 px-4 py-3 text-sm text-token-text-secondary",children:[c.jsx(U,{id:"rating.instructions",defaultMessage:"Is this conversation helpful so far?"}),c.jsxs("div",{className:"flex items-center gap-5",children:[c.jsx(Oa,{$selected:b==="thumbsUp",onClick:()=>_("thumbsUp"),children:c.jsx(uc,{className:"icon-md"})}),c.jsx(Oa,{$selected:b==="thumbsDown",onClick:()=>_("thumbsDown"),children:c.jsx(hc,{className:"icon-md"})})]})]}),c.jsx("div",{className:"w-px flex-1 self-stretch bg-token-main-surface-tertiary"}),c.jsx(Oa,{className:"p-3",$selected:!1,onClick:()=>T(!0),children:c.jsx(w0,{className:"icon-md text-token-text-secondary hover:text-token-text-primary"})})]})},"rating")]})}const Oa=et.button`
  ${n=>n.$selected?"text-token-text-primary":"text-token-text-secondary"}
  hover:text-token-text-primary
`,Vu=et.div`inline-flex rounded-xl border border-gray-100 dark:border-gray-700
${n=>n.$padded&&"py-3 px-4"}
`;function K1({clientThreadId:n,conversationLeafId:e,canShowIndepthFeedbackType:t,canShowInlineComparisonFeedback:s,canShowInlineMessageFeedback:i,messageForRating:r,allGroupedMessages:o,currentModelId:a,conversationTurnMountTime:l,variantIds:d}){let u=null;return zb(n,e)?null:(t!==void 0?u=c.jsx(uT,{clientThreadId:n,conversationLeafId:e,trigger:t,variantIds:d}):r.rating&&i?u=c.jsx(H1,{clientThreadId:n,conversationMessage:r,allGroupedMessages:o,currentModelId:a}):s?u=c.jsx(B1,{clientThreadId:n,messageForRating:r,variantIds:d,conversationTurnMountTime:l}):u=c.jsx("div",{className:"text-center",children:c.jsx($1,{clientThreadId:n,conversationLeafId:e})}),c.jsx("div",{className:"mt-3 w-full empty:hidden",children:u}))}const J1=We(()=>Ve(()=>import("./sso-ipuhfmti911l5wbt.js").then(n=>n.g),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69])).then(n=>n.ContextualAnswerCitationCards).catch(()=>()=>null));function Y1(n){var pe;const{turnIndex:e,conversationLeafId:t,isFinalTurn:s,clientThreadId:i,onChangeItemInView:r,onChangeRating:o,showInlineEmbeddedDisplay:a=!1,currentModelId:l,initiallyHighlightedMessageId:d,avatarClassName:u,scrollToBottom:p}=n,m=je(),b=zi(),g=wo($l.isBusinessWorkspace),x=Rl(),k=Bo(),M=Ji(Ub(i,e,t)),{messages:N,variantIds:A,variantsInStreamInfo:T}=M,_=So(N),j=wy();let P=N[N.length-1];for(const Te of _){const we=C1(Te);if(we.some(Ke=>j.has(Ke.message.id))){P=we[we.length-1];break}}const B=N.slice(0,N.indexOf(P)+1),I=Ql(),[q,G]=S.useState(!1),[D,V]=S.useState(!1),J=A.findIndex(Te=>B.some(we=>we.nodeId===Te)),W=M.role===Ue.User,X=es(),ye=hn(i),L=(pe=Ts(M.gizmoId??ye))==null?void 0:pe.data,F=Nh(),xe=L&&F.includes(L.gizmo.id),re=jh(l),Z=Es(i,L==null?void 0:L.gizmo.id),be=oc(i)===vo.PENDING,{data:le}=Lo(L==null?void 0:L.gizmo.id,!1,k),he=le==null?void 0:le.memoryFullPct,Oe=he!==void 0&&he>=100,ce=Li(),{value:z}=Qn("1410082514"),{value:Ce}=Qn("2291672486"),Ye=B.some(Te=>Te.message.content.content_type===un.MultimodalText),{isUnauthenticated:Qe}=Xt(),[Ee,ae]=S.useState(!1),[$e,Ge]=S.useState(!1);ky(()=>{M.role==="user"&&p&&p()});const Be=S.useRef(null);S.useEffect(()=>{var we;if(d==null)return;M.messages.map(Ke=>Ke.message.id).includes(d)&&((we=Be.current)==null||we.scrollIntoView({behavior:"auto"}))},[d]);const Se=N[N.length-1],it=Se.rating,lt=()=>{B.length===1&&(ee.logEvent($.editPrompt,{id:B[0].message.id,threadId:O.getServerThreadId(i)}),at.logEvent("chatgpt_edit_prompt"),G(!0))},ct=S.useCallback(()=>{G(!1)},[]),tt=S.useCallback(()=>{O.copyMessageToClipboard(i,e)},[i,e]),He=Te=>{o({nodeId:Se.nodeId,messageId:Se.message.id,rating:Te}),at.getExperimentValue({experimentName:"101132775",key:"show_new_ui",defaultValue:!1})&&(ee.logEvent($.messageFeedbackThumbsDownClicked,{id:Se.message.id,threadId:O.getServerThreadId(i),model:l,rating:Te}),V(!0))},[ft]=S.useState(()=>Date.now()),Le=S.useMemo(()=>mr.getRequestIdFromConversationTurn(M),[M]),Ae=of({clientThreadId:i,conversationLeafId:t}),y=Fn(Le)&&!Ae,h=Wl(),f=So(B),{showDebugConversationTurns:w}=ii(),v=af(i),E=am(i),R=pT({clientThreadId:i,conversationMode:Z}),ne=Bn(i),Re=S.useCallback((Te,we,Ke)=>{R(Se.nodeId,{eventSource:"mouse"},Te,we,Ke)},[Se,R]),_e=z&&B.some(Te=>{var we;return((we=Te.message.metadata)==null?void 0:we.snorkle_status)!=null}),ge=!b&&!v&&!X&&!W,fe=ge&&(!g||_e),Me=Cy(),fn=!Qe&&fe&&I&&!y&&!be&&!a&&!q&&(Z==null?void 0:Z.kind)!==ot.GizmoMagicCreate&&J===1&&s&&!Se.inlineComparisonRating&&!it&&A.length===2&&!Me&&Date.now()-(Se.message.create_time??0)*1e3<1e3*60*10,Ct=!Qe&&fe&&!y&&!be&&!a&&!q&&(Z==null?void 0:Z.kind)!==ot.GizmoMagicCreate&&l===wx&&s&&x&&!Oe&&Date.now()-(Se.message.create_time??0)*1e3<1e3*60*10,Is=hT(Se),En=P.message.author.role===Ue.Assistant?P.message:null;My({isCompletionRequestInProgress:y,isUserTurn:W,message:En});const ze=Ct?Is:void 0,nt=Vb(i,A),st=vy(Z),Zt=!Me&&!st&&ge&&s&&(T==null?void 0:T.num_variants_in_stream)===2&&!Se.inlineComparisonRating&&!nt,ai=A.length===2,ss=Zt,li=Zt&&!ai,Un=!W&&!a&&!b&&!v&&!st&&!be&&!y,en=Un&&(!g||_e||re)&&!st&&!Qe&&!X,Vn=!b&&!a&&!((y||be)&&s)&&A.length>1&&!q&&!ss;let tn=!1;if(W&&B.length===1){const{shouldHideContent:Te}=Gi(B[0]);Te&&(tn=!0)}const As=W&&!a&&!st&&!b&&!Ye&&B.length===1&&!tn&&!q&&!Qe,Gn=Te=>{r(A[Te]),ee.logEvent($.changeNode,{intent:"toggle_between"})};if(!(M.role===Ue.Root?!1:M.role===Ue.System||B.every(Te=>{var we;return(we=Te.message.metadata)==null?void 0:we.is_visually_hidden_from_conversation})?w:!0)&&!ss)return null;const _n=s&&E&&!Ce?c.jsx(Zr,{onClick:()=>{R(ne,{eventSource:"mouse"}),dr()},icon:Qo,label:m.formatMessage({id:"ConversationTurn.regenerateTooltip",defaultMessage:"Regenerate"})}):null,ci="h-[30px] rounded-md px-1 text-token-text-secondary hover:bg-token-main-surface-secondary",Wi=Ce?c.jsx(N1,{className:ci,clientThreadId:i,message:Se,onModelSelect:Re,onDropdownChange:ae,canRegenerateResponse:E}):null,Hi=!W&&!tn&&!a&&(!s||!y)?c.jsx(Ry,{onClick:tt}):null,di=!W&&!a&&(!s||!y)&&(Se.disclaimers??[]).length===0&&Se.nodeId?c.jsx(_T,{conversationId:i,message:Se,iconClassName:"icon-md",className:"gap-1.5 rounded-md p-1 text-xs text-token-text-tertiary hover:text-token-text-primary"}):null,ui=!W&&!a&&Se&&(!s||!y)?c.jsx(Dy,{message:Se,isFinalTurn:s,iconClassName:"icon-md",className:"gap-1.5 rounded-md p-1 text-token-text-tertiary hover:text-token-text-primary"}):null,hi=en&&!y?c.jsxs("div",{className:"flex",children:[!(ce!=null&&ce.includes(Ar.ThumbsDownOnly))&&it!=="thumbsDown"&&c.jsx(Zr,{onClick:()=>He("thumbsUp"),disabled:it==="thumbsUp",icon:it==="thumbsUp"?k0:uc,label:m.formatMessage({id:"ConversationTurn.goodResponseTooltip",defaultMessage:"Good response"})},`thumbsUp:${Se.nodeId}`),it!=="thumbsUp"&&c.jsx(Zr,{onClick:()=>He("thumbsDown"),disabled:it==="thumbsDown",icon:it==="thumbsDown"?C0:hc,label:m.formatMessage({id:"ConversationTurn.badResponseTooltip",defaultMessage:"Bad response"})},`thumbsDown:${Se.nodeId}`)]}):null,fi=!Ce&&c.jsx(aT,{className:ci,clientThreadId:i,message:Se,onModelSelect:Re,onDropdownChange:ae});return c.jsxs("article",{className:"w-full text-token-text-primary focus-visible:outline-2 focus-visible:outline-offset-[-4px]",ref:Be,dir:"auto","data-testid":`conversation-turn-${e}`,"data-scroll-anchor":s,onMouseEnter:()=>Ge(!0),onMouseLeave:()=>Ge(!1),children:[c.jsx(Ty,{role:M.role}),c.jsx(lc,{clientThreadId:i,showInlineEmbeddedDisplay:a,isStaticSharedThread:b,withVerticalPadding:!0,withHorizontalPadding:!ss,children:ss?c.jsx(A1,{isFeedbackEnabled:en,variantIds:A,variantsInStreamInfo:T,conversationTurnMountTime:ft,stubSideBySideFeedback:li,...n}):c.jsxs(cc,{children:[!W&&c.jsx(Q1,{children:c.jsx(Nl,{messages:B,isUserTurn:W,avatarClassName:u,showInlineEmbeddedDisplay:a,gizmo:L})}),c.jsx("div",{className:te("group/conversation-turn relative flex w-full min-w-0 flex-col",!W&&Ey),children:c.jsx("div",{className:"flex-col gap-1 md:gap-3",children:c.jsxs(c.Fragment,{children:[!W&&!b&&c.jsx(Al,{messages:B,isMemoryEnabled:x,isMemoryFull:Oe,gizmoId:L==null?void 0:L.gizmo.id}),c.jsx(Il,{groupedMessagesToRender:f,allGroupedMessages:_,...n,isEditing:q,isUserTurn:W,isCompletionRequestInProgress:y,isFeedbackEnabled:en,isFinalTurn:s,hasActiveRequest:h,showEditButton:As,handleEnterEdit:lt,handleExitEdit:ct}),xe&&c.jsx("div",{className:"mb-4",children:c.jsx(_y,{messages:B})}),re&&c.jsx("div",{className:"mb-4",children:c.jsx(J1,{messages:B})}),(Un||Vn)&&c.jsxs(c.Fragment,{children:[c.jsx("div",{className:te("mt-1 flex gap-3 empty:hidden",W?"mr-1 flex-row-reverse":"-ml-2"),children:c.jsx(Ny,{alwaysShow:s,showInline:s||Vn,isHovered:$e||Ee,pagination:Vn&&c.jsx(Iy,{showInline:s||Vn,currentPage:J,onChangeIndex:Gn,length:A.length,className:te("self-center",A.length>1?"visible":"!invisible")}),actions:Un&&c.jsxs(c.Fragment,{children:[di,Hi,_n,hi,ui,fi,Wi]})})}),Un&&!y?c.jsx("div",{className:"pr-2 lg:pr-0",children:c.jsx(Ay,{message:Se,isFinalTurn:s})}):null,s&&!y&&c.jsx(K1,{canShowIndepthFeedbackType:ze,canShowInlineComparisonFeedback:fn,canShowInlineMessageFeedback:D,clientThreadId:i,conversationLeafId:t,messageForRating:Se,allGroupedMessages:_,currentModelId:l,conversationTurnMountTime:ft,variantIds:A})]})]})})})]})})]})}const co=ic.memo(Y1),Q1=et.div`flex-shrink-0 flex flex-col relative items-end`,Ie=qe({submitFeedback:{id:"feedbackModal.submitFeedback",defaultMessage:"Submit feedback"},submitReport:{id:"feedbackModal.submitReport",defaultMessage:"Submit report"},submitRejectModeration:{id:"feedbackModal.moderationReject",defaultMessage:"Block Content"},submitAcceptModeration:{id:"feedbackModal.moderationAccept",defaultMessage:"Allow Content"},thumbsUpPlaceholder:{id:"feedbackModal.thumbsUpPlaceholder",defaultMessage:"What do you like about the response?"},thumbsDownPlaceholder:{id:"feedbackModal.thumbsDownPlaceholder",defaultMessage:"What was the issue with the response? How could it be improved?"},reportContentExplanationPlaceholder:{id:"feedbackModal.reportContentExplanationPlaceholder",defaultMessage:"What is wrong with the response? What about this response is harmful? Please be as specific as possible, and add any details that are not present in the checkboxes below."},harmfulUnsafe:{id:"feedbackModal.harmfulUnsafe",defaultMessage:"This is harmful / unsafe"},harmfulOffensive:{id:"feedbackModal.harmfulOffensive",defaultMessage:"This content is harmful or offensive"},copyrightContent:{id:"feedbackModal.copyrightContent",defaultMessage:"This content violates copyright law"},reportOtherContent:{id:"feedbackModal.reportOtherContent",defaultMessage:"I don't like this for some other reason (please describe)"},notTrue:{id:"feedbackModal.notTrue",defaultMessage:"This isn't true"},notHelpful:{id:"feedbackModal.notHelpful",defaultMessage:"This isn't helpful"},dontLikeThis:{id:"feedbackModal.dontLikeThis",defaultMessage:"I don't like this"},sexualAbuse:{id:"feedbackModal.sexualAbuse",defaultMessage:"This content contains sexual abuse"},provideAdditionalFeedback:{id:"feedbackModal.provideAdditionalFeedback",defaultMessage:"Provide additional feedback"},provideReportModalTitle:{id:"feedbackModal.provideReportModalTitle",defaultMessage:"Report This Content"},pickBestAnswer:{id:"feedbackModal.pickBestAnswer",defaultMessage:"Pick the best answer to improve the model"},newAnswer:{id:"feedbackModal.newAnswer",defaultMessage:"New Answer"},originalAnswer:{id:"feedbackModal.originalAnswer",defaultMessage:"Original Answer"},newAnswerBetter:{id:"feedbackModal.newAnswerBetter",defaultMessage:"New answer is better"},originalAnswerBetter:{id:"feedbackModal.originalAnswerBetter",defaultMessage:"Original answer is better"},neitherAnswerBetter:{id:"feedbackModal.neitherAnswerBetter",defaultMessage:"Neither answer is better"},skipStep:{id:"feedbackModal.skipStep",defaultMessage:"Skip this step"},continueWithChosenAnswer:{id:"feedbackModal.continueWithChosenAnswer",defaultMessage:"The conversation will continue with the answer you choose."},employeeConsent:{id:"feedbackModal.employeeConsent",defaultMessage:"Allow this content to be used for model evals"},employeeConsentExplanation:{id:"feedbackModal.employeeConsentExplanation",defaultMessage:"Allow your feedback and conversation to be used to in model evals. Please verify there is no confidential data in the conversation."}});function uo(n,e=!1){var t,s,i;return((t=n==null?void 0:n.messages)==null?void 0:t.length)===1&&!((s=n==null?void 0:n.messages)!=null&&s.some(r=>"error"in r))&&(e?!(((i=n==null?void 0:n.messages)==null?void 0:i.length)===1&&Jo(n==null?void 0:n.messages[0].message).length<20):!0)}function Pa({ratingModalNodeId:n,ratingModalOpen:e,onCloseRatingModal:t,onSubmitFeedback:s,onHandleChangeFeedbackComparisonRating:i,feedbackTextareaRef:r,clientThreadId:o,currentModelId:a,onChangeItemInView:l,onRequestMoreCompletions:d,onRequestCompletion:u}){var En;const p=je(),m=O.getTree(o),b=(En=S.useContext(Xh))==null?void 0:En.serverSharedThreadId,g=O.getServerThreadId(o),x=b??g,k=Vl(),M=!!k&&ab(k),[N,A]=S.useState(!1),T=S.useRef(Math.random()<.5?"left":"right"),_=m==null?void 0:m.getConversationTurns(n||"root"),j=_.length-1,P=_[_.length-1],[B,I]=S.useState("critique"),q=Nr(),G=uo(P,!0)&&q,D=S.useMemo(()=>({id:n||"root",threadId:O.getServerThreadId(o),rating:e,model:a}),[n,o,e,a]),V=_==null?void 0:_[(_==null?void 0:_.length)-1].variantIds,J=V==null?void 0:V[(V==null?void 0:V.length)-1],W=function(){const ze=m==null?void 0:m.getConversationTurns(J),nt=ze[ze.length-1];return nt.messages[nt.messages.length-1].nodeId}(),X=function(){return m==null?void 0:m.getConversationTurns(W)}(),ye=S.useMemo(()=>{const ze=X==null?void 0:X[(X==null?void 0:X.length)-1];return e==="thumbsDown"&&G&&uo(ze)&&uo(P)},[e,G,X,P]),L=S.useRef(Date.now()),F=S.useRef(-1),xe=S.useRef(Date.now()),re=S.useRef(Date.now());S.useEffect(()=>{B==="compare"?(F.current=Date.now(),ee.logEvent($.displayedComparisonUIV0,D)):B==="critique"&&e==="thumbsDown"&&ee.logEvent($.displayedThumbsDownFeedbackForm,D)},[B]);const Z=_.length-2,ke=X.length-1,be=X[X.length-1],le=S.useMemo(()=>be&&mr.getRequestIdFromConversationTurn(be),[be]),he=Fn(le);S.useMemo(()=>{he||(re.current=Date.now())},[he]);const Oe=P.messages,ce=Oe[Oe.length-1],z=ce.message.id,Ce=ce.nodeId,Ye=m.getLeafFromNode(Ce),Qe=be.messages,Ee=Qe[Qe.length-1],ae=Ee.message.id,$e=Ee.nodeId,Ge=m.getLeafFromNode($e),Be=B==="critique"?e==="report"?p.formatMessage(Ie.provideReportModalTitle):p.formatMessage(Ie.provideAdditionalFeedback):p.formatMessage(Ie.pickBestAnswer),Se=S.useRef([]),it=S.useRef(""),lt=S.useCallback(()=>{var nt;const ze=(nt=r.current)==null?void 0:nt.elements;Se.current=[...ze||[]].filter(st=>st.checked).map(st=>st.id).map(st=>st.replace("feedback-","")),it.current=(ze==null?void 0:ze["feedback-other"].value)||""},[r]),ct=S.useCallback(()=>{lt(),s({customFeedback:it.current,tags:Se.current,employeeConsented:M?N:void 0}),e==="thumbsDown"&&ee.logEvent($.submitThumbsDownFeedbackForm,D),ye?I("compare"):t()},[lt,s,M,N,e,ye,D,t]),tt=S.useCallback((ze,nt)=>{if(x==null){ln.danger("Moderation NOT logged successfully! serverThreadId is null"),jt.addError("Moderation: serverThreadId is null");return}const st=m.getMessageId(O.getThreadCurrentLeafId(o));Je.submitSharedConversationReportFeedback({message_id:st,shared_conversation_id:x,text:ze,tags:nt}).then(()=>{ln.success("Moderation logged successfully")}).catch(Zt=>{ln.danger("Moderation NOT logged successfully! Please try again"),jt.addError(new Error("Moderation: failed to log",{cause:Zt}))}),t()},[m,o,t,x]),He=S.useCallback(()=>{lt(),Se.current.push("moderation-reject"),tt(it.current,Se.current)},[tt,lt]),ft=S.useCallback(()=>{lt(),Se.current.push("moderation-accept"),tt(it.current,Se.current)},[tt,lt]),Le=e==="moderate"?c.jsxs(c.Fragment,{children:[c.jsx(qn.Button,{title:p.formatMessage(Ie.submitRejectModeration),color:"danger",onClick:He}),c.jsx(qn.Button,{title:p.formatMessage(Ie.submitAcceptModeration),color:"primary",onClick:ft})]}):B==="critique"?c.jsxs("div",{className:"flex items-center gap-3",children:[M&&e!=="report"&&c.jsx(vs,{label:p.formatMessage(Ie.employeeConsentExplanation),children:c.jsx(rn,{id:"employee-consent",checked:N,onChange:ze=>A(ze.currentTarget.checked),label:p.formatMessage(Ie.employeeConsent)})}),c.jsx(qn.Button,{title:p.formatMessage(e==="report"?Ie.submitReport:Ie.submitFeedback),onClick:ct})]}):null,Ae=T.current==="left",y=Ae?ke:j,h=Ae?j:ke,f=Ae?$e:Ce,w=Ae?Ce:$e,v=Ae?"new":"original",E=Ae?"original":"new",R=Ae?p.formatMessage(Ie.newAnswer):p.formatMessage(Ie.originalAnswer),ne=Ae?p.formatMessage(Ie.originalAnswer):p.formatMessage(Ie.newAnswer),Re=Ae?p.formatMessage(Ie.newAnswerBetter):p.formatMessage(Ie.originalAnswerBetter),_e=Ae?p.formatMessage(Ie.originalAnswerBetter):p.formatMessage(Ie.newAnswerBetter),ge=e&&e!=="report"&&e!=="moderate",fe=S.useCallback(ze=>{const nt=ze==="left"?v:ze==="right"?E:"same";if(ee.logEvent($.submittedComparisonUIV0,Object.assign({},D,{choice:nt})),ge){const st=O.getTree(o);st.updateNodeMetadata(Ce,{inlineComparisonRating:"baseline"}),st.updateNodeMetadata($e,{inlineComparisonRating:nt}),i(z,ae,e,nt,T.current,L.current,F.current,xe.current,re.current,it.current,Se.current)}O.setThreadCurrentLeafId(o,ze===T.current?Ge.id:Ye.id),t()},[v,E,D,ge,o,Ge.id,Ye.id,t,Ce,$e,i,z,ae,e]),Me=!he&&re.current!=null&&ye,fn=S.useCallback(()=>{t(),B==="critique"?ee.logEvent($.skippedThumbsDownFeedbackForm,Object.assign({},D)):B==="compare"&&ee.logEvent($.skippedComparisonUIV0,Object.assign({},D))},[t,D,B]),[Ct,Is]=S.useState([]);return S.useEffect(()=>{e==="moderate"&&Je.fetchShareModerationCategories().then(ze=>{const nt=ze.moderation_categories;Is(Object.keys(nt).map(st=>[st,nt[st]]))})},[]),c.jsxs(Zh,{isOpen:!0,onClose:fn,showCloseButton:!0,size:"custom",className:"md:max-w-[672px] lg:max-w-[896px] xl:max-w-6xl",type:B==="critique"?e==="thumbsUp"?"success":"danger":"success",icon:B==="critique"?e==="thumbsUp"?uc:hc:void 0,title:Be,children:[B==="critique"&&c.jsxs("form",{ref:r,children:[c.jsx(Sh,{id:"feedback-other",placeholder:e==="thumbsUp"?p.formatMessage(Ie.thumbsUpPlaceholder):e==="report"?p.formatMessage(Ie.reportContentExplanationPlaceholder):p.formatMessage(Ie.thumbsDownPlaceholder),rows:3,className:"mb-1 mt-4 w-full resize-none rounded-md bg-token-main-surface-primary"}),e==="thumbsDown"&&c.jsxs("div",{className:"mb-4",children:[c.jsx(rn,{id:"feedback-harmful",label:p.formatMessage(Ie.harmfulUnsafe)}),c.jsx(rn,{id:"feedback-false",label:p.formatMessage(Ie.notTrue)}),c.jsx(rn,{id:"feedback-not-helpful",label:p.formatMessage(Ie.notHelpful)})]}),e!=null&&!ge&&c.jsx(c.Fragment,{children:c.jsxs("div",{className:"mb-4",children:[e==="report"&&c.jsxs(c.Fragment,{children:[c.jsx(rn,{id:"feedback-dont-like-this",label:p.formatMessage(Ie.dontLikeThis)}),c.jsx(rn,{id:"feedback-false",label:p.formatMessage(Ie.notTrue)}),c.jsx(rn,{id:"feedback-not-helpful",label:p.formatMessage(Ie.notHelpful)}),c.jsx(rn,{id:"feedback-harmful-offensive",label:p.formatMessage(Ie.harmfulOffensive)}),c.jsx(rn,{id:"feedback-sexual-abuse",label:p.formatMessage(Ie.sexualAbuse)})]}),e==="moderate"&&c.jsxs(c.Fragment,{children:[Ct.map(([ze,nt])=>c.jsx(rn,{id:"feedback-"+ze,label:nt},ze)),c.jsx(rn,{id:"feedback-copyright",label:p.formatMessage(Ie.copyrightContent)})]}),c.jsx(rn,{id:"feedback-content-other",label:p.formatMessage(Ie.reportOtherContent)})]})})]}),B==="compare"&&X&&x!==void 0&&c.jsxs("div",{className:te("w-full"),children:[c.jsx("p",{className:te("mb-7 mt-3"),children:c.jsx(U,{...Ie.continueWithChosenAnswer})}),c.jsx(X1,{className:"rounded-md",children:c.jsx(Fa,{children:c.jsx(co,{currentModelId:a,turnIndex:Z,conversationLeafId:w,isFinalTurn:!1,clientThreadId:o,onChangeItemInView:l,onChangeRating:_t,onRequestMoreCompletions:d,onRequestCompletion:u,showInlineEmbeddedDisplay:!0})})}),c.jsxs("div",{className:te(),children:[c.jsxs("div",{className:te("mb-2 grid w-full grid-cols-2 gap-5"),children:[c.jsx("div",{children:c.jsx("p",{className:te("font-semibold"),children:R})}),c.jsx("div",{children:c.jsx("p",{className:te("font-semibold"),children:ne})})]}),c.jsxs("div",{className:te("mb-5 grid w-full grid-cols-2 gap-5"),children:[c.jsxs(Wu,{children:[c.jsx(Fa,{children:c.jsx(co,{currentModelId:a,turnIndex:y,conversationLeafId:f,isFinalTurn:!0,clientThreadId:o,onChangeItemInView:l,onChangeRating:_t,onRequestMoreCompletions:d,onRequestCompletion:u,showInlineEmbeddedDisplay:!0})}),c.jsx(Gu,{children:c.jsx(qn.Button,{disabled:!Me,title:Re,onClick:()=>fe("left"),color:"primary"})})]}),c.jsxs(Wu,{children:[c.jsx(Fa,{children:c.jsx(co,{currentModelId:a,turnIndex:h,conversationLeafId:w,isFinalTurn:!0,clientThreadId:o,onChangeItemInView:l,onChangeRating:_t,onRequestMoreCompletions:d,onRequestCompletion:u,showInlineEmbeddedDisplay:!0})}),c.jsx(Gu,{children:c.jsx(qn.Button,{disabled:!Me,title:_e,onClick:()=>fe("right"),color:"primary"})})]})]}),c.jsx("div",{className:te("grid w-full"),children:c.jsxs("div",{className:te("mb-2 text-right"),children:[c.jsx(qn.Button,{disabled:!Me,title:p.formatMessage(Ie.neitherAnswerBetter),color:"primary",onClick:()=>fe("same"),className:te("mr-2")}),c.jsx(qn.Button,{title:p.formatMessage(Ie.skipStep),onClick:()=>t()})]})})]})]}),c.jsx(qn.Actions,{primaryButton:Le})]},`RatingModal-${n}`)}const Gu=et.div`mb-2 mt-auto ml-auto mr-auto`,Wu=et.div`relative rounded-md border border-token-border-light bg-token-main-surface-secondary flex flex-col overflow-hidden`,X1=et.div`mb-5 border bg-token-main-surface-primary overflow-hidden`,Fa=et.div``;function Z1({clientThreadId:n,currentLeafId:e,currentModelId:t,onChangeItemInView:s,onRequestMoreCompletions:i,onChangeRating:r,onRequestCompletion:o,ratingModalOpen:a,ratingModalNodeId:l,ratingModalCompletionId:d,sharedConversationReportModalNodeId:u,setRatingModalOpen:p,setSharedConversationReportModalNodeId:m}){const b=je(),g=S.useRef(null),x=jy(hr.SharedConversationModeration),[k,M]=S.useState(!1),N=S.useCallback(_=>{const{customFeedback:j,tags:P,employeeConsented:B}=_;if(a&&l!=null&&l!==""&&(j||P.length>0||B)){const I=O.getServerThreadId(n);ee.logEvent($.reportResult,{id:d,threadId:I,content:j,model:t,rating:a,tags:P}),n&&d&&Je.submitMessageFeedback({message_id:d,conversation_id:I,rating:a,text:j,tags:P,employee_consented:B})}},[a,l,n,d,t]),A=S.useCallback(_=>{const{customFeedback:j,tags:P}=_;if(u!=null&&u!==""){const B=O.getServerThreadId(n);ee.logEvent($.reportResult,{id:d,threadId:B,content:j,model:t,rating:a,tags:P}),Je.submitSharedConversationReportFeedback({message_id:u,shared_conversation_id:B,text:j,tags:P}),M(!0)}},[u,n,d,t,a,M]),T=S.useCallback(async(_,j,P,B,I,q,G,D,V,J,W)=>{await Je.submitMessageComparisonFeedback({feedback_version:"comparison_feedback_modal:a:1.0",original_message_id:_,new_message_id:j,rating:P,conversation_id:O.getServerThreadId(n),text:J,tags:W.map(X=>X.replace("feedback-","")),completion_comparison_rating:B,new_completion_placement:I,feedback_start_time:q,compare_step_start_time:G,new_completion_load_start_time:D,new_completion_load_end_time:V,frontend_submission_time:Date.now(),timezone_offset_min:new Date().getTimezoneOffset()})},[n]);return a!=null?c.jsx(Pa,{ratingModalNodeId:l,ratingModalOpen:a,onCloseRatingModal:()=>p(void 0),onSubmitFeedback:N,onHandleChangeFeedbackComparisonRating:T,currentModelId:t,feedbackTextareaRef:g,clientThreadId:n,onChangeItemInView:s,onRequestMoreCompletions:i,onChangeRating:r,onRequestCompletion:o}):u!=null?c.jsx(Pa,{ratingModalNodeId:u,ratingModalOpen:"report",onCloseRatingModal:()=>m(void 0),onSubmitFeedback:A,onHandleChangeFeedbackComparisonRating:_t,currentModelId:t,feedbackTextareaRef:g,clientThreadId:n,onChangeItemInView:s,onRequestMoreCompletions:i,onChangeRating:r,onRequestCompletion:o}):k?c.jsx(Zh,{onClose:()=>M(!1),isOpen:!0,icon:M0,title:b.formatMessage(Ba.reportModalThankYouTitle),description:b.formatMessage(Ba.reportModalThankYouDescription),primaryButton:c.jsx(qn.Button,{onClick:()=>M(!1),title:b.formatMessage(Ba.reportModalThankYouDismiss)}),type:"danger"}):x?c.jsx(Pa,{ratingModalNodeId:e,ratingModalOpen:"moderate",onCloseRatingModal:()=>Ri.closeModal(hr.SharedConversationModeration),onSubmitFeedback:_t,onHandleChangeFeedbackComparisonRating:_t,currentModelId:t,feedbackTextareaRef:g,clientThreadId:n,onChangeItemInView:s,onRequestMoreCompletions:i,onChangeRating:r,onRequestCompletion:o}):null}const Ba=qe({reportModalThankYouTitle:{id:"thread.modal.reportModalThankYou.title",defaultMessage:"Thank you for your report!"},reportModalThankYouDescription:{id:"thread.modal.reportModalThankYou.description",defaultMessage:"Thank you for your report."},reportModalThankYouDismiss:{id:"thread.modal.reportModalThankYou.dismissButton",defaultMessage:"Close"}}),eE=({clientThreadId:n})=>{const e=ts(),t=hn(n),{data:s,isLoading:i}=Ts(t);if(i)return null;const r=e!=null&&e.id?s?La.loggedInCtaGizmo:La.loggedInCta:La.loggedOutCta,o=e&&s?nf(s):"/";let a=$.sharedConversationLoggedOutClicked;return e&&(e.isFree()?a=s?$.sharedConversationFreeGizmoClicked:$.sharedConversationFreeClicked:a=s?$.sharedConversationPaidGizmoClicked:$.sharedConversationPaidClicked),c.jsx("div",{className:"flex flex-col items-center gap-4",children:c.jsx(Oy,{href:o,onClickTrackingEventName:a,children:c.jsx(U,{...r,values:{name:s==null?void 0:s.gizmo.display.name}})})})},La=qe({loggedOutCta:{id:"GizmoSharedConversationCTA.loggedOutCta",defaultMessage:"Sign up to chat"},loggedInCtaGizmo:{id:"GizmoSharedConversationCTA.loggedInCtaGizmo",defaultMessage:"Get started with {name}"},loggedInCta:{id:"GizmoSharedConversationCTA.loggedInCta",defaultMessage:"Get started with ChatGPT"}});function tE({clientThreadId:n,isModeratingThread:e,continueConversationUrl:t}){const s=Li(),i=je();return c.jsxs("div",{className:"relative flex w-full flex-1 flex-col items-center justify-center gap-2 pt-3 empty:hidden sm:flex-row",children:[c.jsx(eE,{clientThreadId:n}),e&&c.jsx(It,{onClick:()=>{Ri.openModal(hr.SharedConversationModeration)},children:i.formatMessage({id:"thread.sharedConversation.moderate",defaultMessage:"Moderate conversation"})}),(s==null?void 0:s.includes("debug"))&&t&&c.jsx(It,{color:"secondary",as:"link",to:t,icon:v0,size:"giant",children:i.formatMessage({id:"thread.sharedConversation.continue",defaultMessage:"Continue this conversation"})})]})}function nE({children:n}){const e=zo(Uo.AG8PqS2q),{eligible:t,isLoading:s}=U0(),{doesUserHaveAnyAccountsWithPlusFeatures:i}=ri(),r=t&&!s;if(S.useEffect(()=>{r&&ee.logEvent($.gpt4oNUXTooltipShown)},[r]),!r)return c.jsx(c.Fragment,{children:n});const o=()=>{ee.logEvent($.gpt4oNUXTooltipDismissed),e.markAsViewed()};return c.jsx(Ol,{side:"bottom",show:!0,title:c.jsx(U,{...za.title,values:{modelName:"GPT4o"}}),onDismiss:o,sideOffset:0,theme:"default",description:c.jsx(U,{...i?za.bodyPaidFinal:za.bodyFreeFinal,values:{modelName:"GPT4o",anotherModelName:"GPT4"}}),children:n})}const za=qe({title:{id:"1kewDD",defaultMessage:"Introducing {modelName}"},bodyPaidFinal:{id:"Z6KHqN",defaultMessage:"You can now try our newest model, {modelName}. Its faster than {anotherModelName}, better at understanding images, and speaks more languages."},bodyFreeFinal:{id:"w8Y79o",defaultMessage:"You now have limited access to our latest model, {modelName}. Its smarter, understands images, can browse the web, and speaks more languages."}});function sE({currentModel:n,categoryOptions:e,className:t,modelSwitcherDenialsBySlug:s}){const i=n==null?void 0:n.id;return c.jsx(ve.Portal,{children:c.jsx(ve.SubContent,{className:t,children:e.map(r=>{const{value:o}=r;return"options"in r?c.jsx(ho,{currentModel:n,isSelected:i.startsWith(o),option:r,modelSwitcherDenialsBySlug:s},o):c.jsx(fo,{isSelected:i===o,value:o,renderName:()=>r.name,modelSwitcherDenialsBySlug:s,showNewChatHint:!1},o)})})})}function ho({currentModel:n,option:e,isSelected:t=!1,modelSwitcherDenialsBySlug:s}){const{name:i,options:r,categoryId:o}=e,a=`${i} Models`,l=()=>c.jsx("div",{className:"flex shrink-0 grow justify-between gap-2",children:c.jsxs("div",{className:"flex items-center gap-3",children:[c.jsx(T0,{className:"icon-md w-7 text-token-text-secondary"}),a]})});return c.jsxs(ve.Sub,{children:[c.jsx(ve.SubMenuTrigger,{children:c.jsxs("div",{className:"flex grow justify-between gap-2 overflow-hidden",children:[o?l():i,t&&c.jsx("div",{className:"truncate text-token-text-tertiary",children:n.title})]})}),c.jsx(sE,{currentModel:n,categoryOptions:r,modelSwitcherDenialsBySlug:s})]})}function fo({value:n,renderName:e,isSelected:t,showNewChatHint:s=!0,onClick:i,modelSwitcherDenialsBySlug:r,isUpgradeUpsell:o=!1}){var m,b;const a=Lh(),l=Py(),d=n?(b=(m=r[n])==null?void 0:m.conversation)==null?void 0:b[0]:null,{layer:u}=ns("1846737571"),p=c.jsx(ve.Item,{onClick:()=>{if(i)i();else if(n){const g=n;a({modelId:g,location:"Model switcher menu item"}),l(g)}},className:te("!pr-3",t&&"!opacity-100",d&&"pointer-events-none text-token-text-quaternary"),children:c.jsxs("div",{className:"flex grow items-center justify-between gap-2",children:[c.jsx("div",{children:e(d!=null)}),o&&c.jsx(It,{color:"secondary",size:"small",className:u.get("is_upgrade_button_blue",!1)?"border-none bg-blue-600 text-white hover:bg-blue-800":"",children:c.jsx(U,{id:"oKo8wt",defaultMessage:"Upgrade"})}),o?c.jsx(c.Fragment,{children:t&&c.jsx(wf,{className:te("icon-md group-hover:invisible",!s&&"block group-hover:hidden")})}):t&&c.jsx(Sf,{className:"icon-md"})]})},n);return d?c.jsx(vs,{isLeftArrow:!0,sideOffset:-10,label:c.jsx(Eh,{modelSwitcherDeny:d}),children:p}):p}const iE=We(()=>Ve(()=>import("./xo04pgxauy0sokrl.js"),__vite__mapDeps([86,1,2,3,17,4,5,9,7,8,87,73])).then(n=>n.ThreadHeaderGizmoDropdown)),rE=We(()=>Ve(()=>import("./sso-ipuhfmti911l5wbt.js").then(n=>n.h),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69])).then(n=>n.default)),Hu=et.div`group flex cursor-pointer items-center gap-1 rounded-lg py-1.5 px-3 text-lg font-semibold hover:bg-token-main-surface-secondary radix-state-open:bg-token-main-surface-secondary text-token-text-secondary overflow-hidden whitespace-nowrap`;function oE({clientThreadId:n}){const e=je(),t=es(),s=rc(n),i=Fi(),r=()=>{zy(i,s,t,!0)};return c.jsx(ve.Item,{size:"large",className:"!pr-3",onClick:r,icon:yf,children:c.jsxs("div",{className:"flex grow items-center justify-between gap-2",children:[c.jsx("div",{className:"flex flex-1 items-center gap-3",children:c.jsx(U,{...hE.temporaryChat})}),c.jsx(By,{onChange:r,enabled:t,label:e.formatMessage({defaultMessage:"Temporary",id:"temporaryChatToggleLabel"})})]})})}function Tm(n,e,t){let s=n;if(n===Qc.AUTO){const o=e.filter(({defaultModel:a})=>a!==Qc.AUTO);o.length===1&&(s=o[0].defaultModel)}const i=e.find(({defaultModel:o})=>o===s);if(i){const{categoryId:o,shortLabel:a}=i;return{selectedCategory:o,modelLabel:a}}const r=t.find(({modelIds:o})=>o.includes(s));if(r){const{group:o,shortLabel:a}=r;return{selectedCategory:o,modelLabel:a}}return{selectedCategory:null,modelLabel:null}}function aE({modelLabel:n}){return c.jsx("span",{className:"text-token-text-secondary",children:n})}function lE({clientThreadId:n,inMobileHeader:e}){const{isLoading:t,categories:s,groups:i}=_r(),r=lb(),a=Ho(n).id,l=Rc(),{modelLabel:d}=Tm(a,s,i),u=cE(n,l),p=je(),{isUnauthenticated:m}=Xt(),b=Em(),g=(!m||!b)&&!r;S.useEffect(()=>{var k;t||(k=Oh({namespace:xo.ChatPageLoad}))==null||k.logTiming("render_model_switcher")},[t]);const x=c.jsxs("div",{className:"text-token-text-secondary",children:[Ly," ",g?c.jsx("span",{className:"text-token-text-secondary",children:d}):m&&d?c.jsx(aE,{modelLabel:d}):null]});return u.length?t?null:c.jsx(B0,{sideOffset:8,size:"large",triggerButton:c.jsxs(Hu,{"aria-label":d?p.formatMessage({id:"JrtGPQ",defaultMessage:"Model selector, current model is {modelLabel}"},{modelLabel:d}):"",children:[x,c.jsx(Yo,{className:"icon-md text-token-text-tertiary"})]}),onOpenChange:k=>{ee.logEvent($.toggleModelSwitcher,{isOpen:k}),at.logEvent("toggle_model_switcher",null,{isOpen:String(k)})},contentAlign:e?"center":"start",children:c.jsx(dE,{sections:u})}):c.jsx(Hu,{className:"cursor-default",children:x})}function Em(){return sc("462735957").value}function cE(n,e){var W,X,ye;const t=Ho(n),s=t.id,i=hn(n),{categories:r,groups:o}=_r(),{doesUserHaveAnyAccountsWithPlusFeatures:a}=ri(),l=O.getServerThreadId(n),d=lm({clientThreadId:n}),u=O0(),p=je(),m=!l,{isUnauthenticated:b}=Xt(),g=Ph(),{layer:x}=ns("2723963139"),k=x.get("is_dynamic_model_enabled",!1),M=Em(),N=e.find(({categoryId:L})=>L===Fs.ALPHA),A=e.find(({categoryId:L})=>L===Fs.EXPERIMENTS),T=e.find(({categoryId:L})=>L===Fs.MAINLINE),_=!!((W=N==null?void 0:N.options)!=null&&W.length),j=!!((X=A==null?void 0:A.options)!=null&&X.length),P=!!((ye=T==null?void 0:T.options)!=null&&ye.length),B=Bi(),I=S.useCallback(()=>{ee.logEvent($.openModalAccountPaymentfromModelPicker,{content:"gizmo-button"}),Pl(B,"Thread header dropdown")},[B]),q=()=>{if(at.logEvent("chatgpt_model_switcher_plus_upgrade_button_clicked"),ee.logEvent($.modelSwitcherPlusUpgradeButtonClicked),b){cb.setCookie(db.ShowPaymentModal,!0,{maxAge:6*60*60});const L=g();ee.logSignUpButtonClicked({location:"Model switcher GPT-4 upsell",provider:L})}else I()},G=[],D=c.jsxs("div",{className:"mb-1 flex items-center justify-between px-5 pt-2",children:[c.jsx("span",{className:"text-sm text-token-text-tertiary",children:c.jsx(U,{id:"ilkdMh",defaultMessage:"Model"})}),c.jsx("a",{href:k?"https://help.openai.com/en/articles/9155758-what-is-the-chatgpt-plus-model-selector":"https://help.openai.com/en/articles/7102672-how-can-i-access-gpt-4",target:"_blank",rel:"noreferrer",children:c.jsx(gr,{className:"icon-md h-5 w-5 pl-0.5 text-token-text-tertiary"})})]},"header");if(M&&b){const L={id:"modelSection",content:[]};L.content.push(c.jsx(Fy,{},"noAuthUpsell")),G.push(L)}else if(a){const L={id:"modelSection",content:[]};r.length&&L.content.push(D);for(const{categoryId:F,defaultModel:xe,label:re,description:Z}of r)L.content.push(c.jsx(fo,{value:xe,modelSwitcherDenialsBySlug:d,renderName:ke=>c.jsx(Ua,{categoryId:F,name:re,description:Z,isDisabled:ke}),isSelected:!i&&s===xe},xe));G.push(L)}else{const L={id:"modelSection",content:[]};L.content.push(c.jsx(fo,{value:"",onClick:q,modelSwitcherDenialsBySlug:d,isUpgradeUpsell:!0,renderName:F=>c.jsx(Ua,{icon:_0,isDisabled:F,name:p.formatMessage({id:"mzDzkX",defaultMessage:"ChatGPT Plus"}),description:p.formatMessage({id:"bqTHri",defaultMessage:"Our smartest model & more"})}),isSelected:!1,showNewChatHint:!1},"plusUpgrade")),L.content.push(c.jsx(fo,{value:pa.AUTO,modelSwitcherDenialsBySlug:d,renderName:F=>c.jsx(Ua,{icon:E0,name:p.formatMessage({id:"U9E7Rx",defaultMessage:"ChatGPT"}),description:p.formatMessage({id:"n96qML",defaultMessage:"Great for everyday tasks"}),isDisabled:F}),isSelected:!i&&s===pa.AUTO,showNewChatHint:!0},pa.AUTO)),G.push(L)}const V={id:"otherOptionsSection",content:[]},{selectedCategory:J}=Tm(s,r,o);return m&&(_&&V.content.push(c.jsx(ho,{isSelected:J===Fs.ALPHA,currentModel:t,option:N,modelSwitcherDenialsBySlug:d},N.value)),j&&V.content.push(c.jsx(ho,{currentModel:t,isSelected:J===Fs.EXPERIMENTS,option:A,modelSwitcherDenialsBySlug:d},A.value)),P&&V.content.push(c.jsx(ho,{isSelected:J===Fs.MAINLINE,currentModel:t,option:T,modelSwitcherDenialsBySlug:d},T.value))),u&&V.content.push(c.jsx(rE,{clientThreadId:n},"c")),V.content.length&&G.push(V),b||G.push({id:"temporaryChatSection",content:[c.jsx(oE,{clientThreadId:n},"tempChat")]}),G}function Ua({isDisabled:n,name:e,icon:t,categoryId:s,description:i,extra:r}){return c.jsxs("div",{className:"flex items-center gap-3",children:[c.jsx("span",{className:"flex h-7 w-7 flex-shrink-0 items-center justify-center rounded-full bg-token-main-surface-secondary",children:t?c.jsx(t,{className:"h-4 w-4 text-token-text-primary"}):s&&c.jsx(Dc,{type:"filled",className:te("h-4 w-4",n&&"text-gray-300",!n&&"text-token-text-primary"),categoryId:s})}),c.jsxs("div",{children:[e,c.jsxs("div",{className:te(!n&&"text-token-text-secondary","text-xs"),children:[i,r]})]})]})}function dE({sections:n}){return c.jsx(c.Fragment,{children:n.map((e,t)=>c.jsxs(ic.Fragment,{children:[t!==0?c.jsx(ve.Separator,{}):null,e.content]},e.id))})}function uE({clientThreadId:n,inMobileHeader:e=!1}){const t=hn(n);return t==null?c.jsx(lE,{clientThreadId:n,inMobileHeader:e}):c.jsx(iE,{clientThreadId:n,gizmoId:t,inMobileHeader:e})}const hE=qe({gpt35ShortExplainer:{defaultMessage:"Great for everyday tasks",id:"ModelSwitcher.gpt35ShortExplainer"},modelTunerSmartSelectionTitle:{id:"czjW8I",defaultMessage:"Dynamic"},modelTunerSmartSelectionExplainer:{id:"gp/YH1",defaultMessage:"Optimized for speed and intelligence"},gpt4ShortExplainer:{defaultMessage:"With DALLE, browsing and analysis",id:"ModelSwitcher.gpt4ShortExplainer"},gpt4ShortExplainerWithoutBrowse:{defaultMessage:"With DALLE and analysis",id:"ModelSwitcher.gpt4ShortExplainerWithoutBrowse"},gpt4UpsellExplainer:{id:"ModelSwitcher.gpt4Upsell",defaultMessage:"Our smartest and most capable model. Includes DALLE, browsing and more."},userUpgrade:{id:"ModelSwithcer.upgradeButton",defaultMessage:"Upgrade to Plus"},userUpgradeSignup:{id:"ModelSwitcher.signupUpgradeButton",defaultMessage:"Sign up for ChatGPT Plus"},temporaryChat:{id:"ModelSwitcher.temporaryChat",defaultMessage:"Temporary chat"},shareChat:{id:"ModelSwitcher.shareChat",defaultMessage:"Share chat"}}),fE=We(()=>Ve(()=>import("./jbrorneya2zaabc8.js"),__vite__mapDeps([88,1,2,3,89,90,4,5,91,17,9,7,8,16,92,6,61,27,74,93,73,87,94,95,12,13,14,15])).then(n=>n.GizmoUsingAsOwnerNotice)),pE=({clientThreadId:n})=>{const e=kh(l=>l.activeStageSidebar),t=O.getServerThreadId(n),s=Wy(Ar.WorkspaceShareLinks),{isUnauthenticated:i}=Xt(),r=es(),o=s&&t&&!i&&!r,a=!e;return c.jsx("div",{className:"flex items-center gap-2 pr-1 leading-[0]",children:c.jsx(F0,{showShareButton:o,showProfileDropdown:a,clientThreadId:n})})};function mE({clientThreadId:n,gizmoId:e}){var r;const t=Uy(),{data:s}=Ts(e),i=ts();return c.jsxs(c.Fragment,{children:[c.jsxs(Vy,{children:[c.jsxs("div",{className:"absolute start-1/2 ltr:-translate-x-1/2 rtl:translate-x-1/2",children:[s!=null&&(i==null?void 0:i.isWorkspaceAccount())&&((r=s.gizmo.tags)==null?void 0:r.includes(Gl.WorkspaceDisabled))&&c.jsx(fE,{gizmo:s}),c.jsx(aS,{gizmoId:e,clientThreadId:n})]}),c.jsx(nE,{children:c.jsxs("div",{className:"flex items-center gap-0 overflow-hidden",children:[c.jsx(P0,{clientThreadId:n}),c.jsx(uE,{clientThreadId:n})]})}),c.jsx(pE,{clientThreadId:n})]}),t&&c.jsx(Gy,{})]})}function _m({clientThreadId:n}){const e=hn(n),t=zi();return Nr()?t?null:c.jsx(mE,{gizmoId:e,clientThreadId:n}):c.jsx("div",{className:"h-1.5"})}function gE({clientThreadId:n,currentModelId:e,onRequestCompletion:t,enableV2Homepage:s}){const i=es();let r=c.jsx(i0,{}),o;return i?(o=c.jsx(yE,{}),r=c.jsx(th,{className:"mb-6 h-12 w-12"})):n!=null?(o=s?c.jsx(Uv,{clientThreadId:n,currentModelId:e,onRequestCompletion:t}):c.jsx(r0,{clientThreadId:n}),r=null):o=c.jsx(xE,{}),c.jsxs("div",{className:"flex h-full flex-col items-center justify-center text-token-text-primary",children:[r,o]})}function yE({gizmo:n}){const e=Qu(),t=n?tS(n.tools):!1,s=ts();return c.jsxs(c.Fragment,{children:[c.jsx("div",{className:"mb-5 text-2xl font-semibold",children:c.jsx(U,{...Bs.temporaryChat})}),c.jsxs("div",{className:"max-w-sm text-center text-sm font-normal text-token-text-tertiary",children:[c.jsx(U,{...s!=null&&s.isWorkspaceAccount()?e?Bs.temporaryChatBizMemoryAvailable:Bs.temporaryChatBizMemoryUnavailable:e?Bs.temporaryChatDescriptionMemoryAvailable:Bs.temporaryChatDescriptionMemoryUnavailable}),t&&c.jsx("div",{className:"mt-3",children:c.jsx(U,{...Bs.temporaryChatDescriptionGptActions,values:{link:i=>c.jsx("a",{href:"https://help.openai.com/en/articles/8914046-temporary-chat-faq",target:"_blank",className:"underline",rel:"noreferrer",children:i})}})})]})]})}function xE(){return c.jsx("div",{className:"mb-5 text-2xl font-semibold",children:c.jsx(U,{...Bs.howCanIHelpYouToday})})}function bE({clientThreadId:n,currentModelId:e,onRequestCompletion:t,enableV2Homepage:s}){const i=hn(n),r=Hy(),o=ec(),{data:a}=Ts(i);return(r!=null||i!=null)&&a==null?null:c.jsxs("div",{className:"relative h-full",children:[c.jsx("div",{className:"absolute left-0 right-0",children:c.jsx(_m,{clientThreadId:n})}),a!=null?c.jsx(s0,{gizmo:a,showStarterPrompts:!0,disableStarterPrompts:o}):c.jsx(gE,{clientThreadId:n,currentModelId:e,onRequestCompletion:t,enableV2Homepage:s})]})}const Bs=qe({temporaryChat:{id:"GizmoLanding.temporaryChat",defaultMessage:"Temporary Chat"},temporaryChatBizMemoryAvailable:{id:"g1opBW",defaultMessage:"This chat won't appear in your history and won't use or create memories."},temporaryChatBizMemoryUnavailable:{id:"fQmbtG",defaultMessage:"This chat won't appear your conversation history."},temporaryChatDescriptionMemoryAvailable:{id:"GizmoLanding.temporaryChatDescriptionMemoryAvailable",defaultMessage:"This chat won't appear in history, use or create memories, or be used to train our models. For safety purposes, we may keep a copy for up to 30 days."},temporaryChatDescriptionMemoryUnavailable:{id:"GizmoLanding.temporaryChatDescriptionMemoryUnavailable",defaultMessage:"This chat won't appear in history or be used to train our models. For safety purposes, we may keep a copy of this chat for up to 30 days."},temporaryChatDescriptionGptActions:{id:"GizmoLanding.temporaryChatDescriptionGptActions",defaultMessage:"Any data shared with a third party through GPT actions are subject to the third party's privacy policy. <link>Learn more</link>"},howCanIHelpYouToday:{id:"GizmoLanding.howCanIHelpYouToday",defaultMessage:"How can I help you today?"}});function SE(n){var t,s;const e=(t=n.message.metadata)==null?void 0:t.aggregate_result;return(s=e==null?void 0:e.messages)==null?void 0:s.some(Tf)}function wE(n){const e=n.message.content;return("parts"in e?e.parts.join(""):"").includes("sandbox:")}function kE(n){return n.some(e=>e.messages.some(t=>SE(t)||wE(t)))}function CE({clientThreadId:n}){const e=Gb(n),t=cf(n),s=ei(u=>Ot.getThreadCreateTime(n,u)),i=Bn(n),r=lf(n,i),o=S.useMemo(()=>kE(r),[r]),a=Wb(n),l=Hb(n),d=a||l;return c.jsxs("div",{className:"border-b border-gray-100 px-4 pb-4 pt-3 sm:mb-2 sm:pb-6 sm:pt-8 md:px-0",children:[c.jsx("h1",{className:"text-3xl font-semibold leading-tight text-token-text-primary sm:text-4xl",children:e}),(t!=null||s!=null)&&c.jsxs("div",{className:"pt-3 text-base text-gray-400 sm:pt-4",children:[t!=null&&c.jsx("span",{children:t}),t!=null&&s!=null&&c.jsx("span",{className:"px-2",children:""}),s!=null&&c.jsx(ub,{value:s,month:"long",year:"numeric",day:"numeric"})]}),c.jsx(ME,{shouldShowCodeInterpreterDisclaimer:o,shouldShowPersonalizedDataDisclaimer:d})]})}const ME=({shouldShowCodeInterpreterDisclaimer:n,shouldShowPersonalizedDataDisclaimer:e})=>c.jsxs(c.Fragment,{children:[n&&c.jsx("div",{className:"mt-4",children:c.jsx($c,{icon:gr,children:c.jsx(U,{id:"sharedConversation.advancedDataAnalysisSupportDisclaimer",defaultMessage:"This chat contains files or images produced by Advanced Data Analysis which are not yet visible in Shared Chats."})})}),e&&c.jsx("div",{className:"mt-4",children:c.jsx($c,{icon:gr,children:c.jsx(U,{id:"sharedConversation.personalizedDataDisclaimer",defaultMessage:"This conversation may reflect the link creators personalized data, which isnt shared and can meaningfully change how the model responds."})})})]}),vE=n=>{const e=es();return S.useCallback(t=>{var a,l;qy(t);const{target:s}=t;if(!(s instanceof Element))return;const i=(a=s.closest("[data-message-id]"))==null?void 0:a.getAttribute("data-message-id"),r=(l=document.getSelection())==null?void 0:l.toString(),o=O.getServerThreadId(n);!i||!r||!o||e||Je.submitImplicitMessageFeedback({source:"keyboard",type:"copy",messageId:i,serverThreadId:o,selectedText:r})},[n,e])};function TE({onChangeItemInView:n,onRequestMoreCompletions:e,onChangeRating:t,onRequestCompletion:s,clientThreadId:i,conversationLeafId:r,inlineEmbeddedDisplay:o,initiallyHighlightedMessageId:a,hideHeader:l,renderOnlyTurns:d}){const u=Qt(),p=zi(),m=$y(),[b]=Ky(),g=Es(i),x=ts(),k=Ho(i),M=u.store.useContentAreaDimensions(Ai.Header,V=>V!=null&&V.height?V.height:void 0),N=u.store.useIsHeaderContentAreaPopulated(),A=df(i),{isArchived:T}=A,_=Jv(k.id),j=(g==null?void 0:g.kind)===ot.GizmoMagicCreate?"bg-token-main-surface-primary text-token-text-primary":_,P=uf(i,r),B=Vo(),I=S.useCallback(()=>{m({behavior:"smooth"})},[m]),q=(V=!0)=>[...new Array(P).keys()].map(J=>c.jsx(co,{isFinalTurn:V&&J===P-1,turnIndex:J,clientThreadId:i,conversationLeafId:r,onChangeItemInView:n,onChangeRating:t,onRequestMoreCompletions:e,onRequestCompletion:s,currentModelId:k.id,showInlineEmbeddedDisplay:o,initiallyHighlightedMessageId:a,avatarClassName:j,scrollToBottom:I},J)),G=vE(i),D=B&&!T;return d?c.jsx(c.Fragment,{children:q(!1)}):c.jsxs("div",{onCopy:G,className:te("flex flex-col text-sm",p&&"pt-2",D&&"pb-[120px]",M||D?null:"md:pb-9"),style:{paddingBottom:D?void 0:M},children:[!l&&(p||(x==null?void 0:x.data))&&!o&&c.jsx(_m,{clientThreadId:i}),p&&!o&&c.jsx(cc,{children:c.jsx(CE,{clientThreadId:i})}),q(),!b&&!o&&c.jsx(EE,{className:te(M?null:"bottom-5",D?N?"translate-y-[-50px]":"translate-y-[-10px]":""),style:{bottom:B?"calc(var(--composer-bar_footer-current-height) + var(--composer-bar_current-height))":M},onClick:()=>{at.logEvent("chatgpt_thread_scroll_to_bottom"),m({behavior:"smooth"})},children:c.jsx(N0,{className:"icon-md text-token-text-primary"})})]})}const EE=et.button`cursor-pointer absolute z-10 rounded-full bg-clip-padding border text-token-text-secondary border-token-border-light right-1/2 translate-x-1/2 bg-token-main-surface-primary w-8 h-8 flex items-center justify-center`;function qu(n,e){n.updateNodeMetadata(e.id,{completionSampleFinishTime:Date.now()})}class _E{constructor(e,t,s,i,r,o,a,l,d,u){ie(this,"currentTree");ie(this,"currentNodeId");ie(this,"firstResponse",!0);ie(this,"didCreateFirstCompletionInNewThread",!1);ie(this,"activeBranchLastMessage");ie(this,"messagesToUpdate",{});ie(this,"allIncompleteStreamedMessages",{});ie(this,"responseThreadId");ie(this,"isCompletionBlocked",!1);ie(this,"isEitherFlagged",!1);ie(this,"variantsInStreamInfo");ie(this,"activeBranchNodeId");ie(this,"blurDuringCompletionTracker",new Yy);ie(this,"completionLatencyTracker");ie(this,"debouncedUpdateCompletion",Hl(()=>{this.isCompletionBlocked||O.updateTree(this.clientThreadId,e=>{Object.values(this.messagesToUpdate).forEach(t=>{e.updateNodeMessage(t.id,t)})}),this.messagesToUpdate={}},50,{leading:!0,maxWait:50}));ie(this,"handleResponse",async e=>{if(this.completionLatencyTracker.onResponse(e,this.activeBranchLastMessage,this.responseThreadId),this.responseThreadId===void 0&&"conversationId"in e){const t=e.conversationId;this.responseThreadId=t,Xn(this.clientThreadId)&&O.getServerThreadId(this.clientThreadId)!==t&&(O.setServerIdForNewThread(this.clientThreadId,t),ee.logEvent($.attributeClientThreadToServerThread,{client_thread_id:this.clientThreadId,server_thread_id:t}))}switch(e.type){case"error":this.handleError(e);break;case"num_variants_in_stream":this.bindVariantInfoToTree(e);break;case"moderation":this.handleModeration(e);break;case"url_moderation":this.handleUrlModeration(e);break;case"message":this.handleMessage(e),this.debouncedUpdateCompletion();break;case"done":this.handleDone();break;case"gizmo_inline_review":this.handleGizmoInlineReview(e);break;case"title_generation":this.handleTitleGeneration(e);break;case"conversation_detail_metadata":this.handleConversationDetailMetadata(e);break}});this.queryClient=e,this.clientThreadId=t,this.targetNodeId=s,this.completionType=i,this.model=r,this.eventSource=o,this.navigate=a,this.callModelAgain=d,this.onCompletionFinished=u,this.currentTree=O.getTree(t),this.currentNodeId=s,this.activeBranchLastMessage=this.currentTree.getMessage(this.currentNodeId),this.completionLatencyTracker=new Jy(l)}handleError(e){const t=e.error,s=(t==null?void 0:t.message)||"Something went wrong",i=t instanceof zs&&t.code||"";switch(O.updateTree(this.clientThreadId,r=>{r.updateNodeMessage(this.currentNodeId,this.activeBranchLastMessage),r.updateNodeMetadata(this.currentNodeId,{err:s,errType:"danger",errCode:i,completionSampleFinishTime:Date.now()})}),i){case cn.ContentPolicy:case cn.ContentOrTos:case bo:case Jh:break;default:s!==void 0&&at.logEvent("chatgpt_conversation_error_web",s)}this.blurDuringCompletionTracker.onMessageError(),this.cleanUp(),this.onCompletionFinished(this.responseThreadId),t instanceof zs&&(t==null?void 0:t.code)===bo&&(t!=null&&t.clearsIn)&&(Qy(new Date(Date.now()+t.clearsIn*1e3).toISOString()),setTimeout(()=>{Xy()},t.clearsIn*1e3))}handleGizmoInlineReview(e){O.setPromptGptRating(this.clientThreadId,e.gizmoId)}handleTitleGeneration(e){O.setTitle(this.clientThreadId,e.title,rf.Generated)}handleConversationDetailMetadata(e){const{default_model_slug:t}=e;t&&O.setThreadModelId(this.clientThreadId,t),fr.updateDetails(e)}bindVariantInfoToTree(e){this.variantsInStreamInfo=e,O.updateTree(this.clientThreadId,t=>{const s=t.getParentPromptNode(this.currentNodeId);t.updateNodeMetadata(s.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}handleModeration(e){const{isCompletion:t,messageId:s,conversationId:i,flagged:r,blocked:o,disclaimers:a,metadata:l}=e,d=!!(a!=null&&a.length)&&t;(r||o||d)&&(this.isEitherFlagged=!0,o&&t&&(this.isCompletionBlocked=!0),O.updateTree(this.clientThreadId,u=>{const p=u.messageIdToNodeId(s);o&&u.clearNodeMessageParts(p),u.updateNodeMetadata(p,{...(d&&!!(a!=null&&a.length)&&hb(a,o))??{},...r&&fb,...o&&(l!=null&&l.model_incompatibility?pb:mb),completionSampleFinishTime:Date.now()})}),ee.logEvent(t?o?$.completionBlockedByModeration:$.completionFlaggedByModeration:o?$.promptBlockedByModeration:$.promptFlaggedByModeration,{threadId:i,id:s}))}handleUrlModeration(e){const{conversationId:t,url:s,isSafe:i}=e;i&&O.addThreadSafeUrl(t,s)}handleMessage(e){var r,o,a,l,d,u,p,m,b;let t=!0;const{message:s,conversationId:i}=e;if(this.firstResponse&&!this.currentTree.hasReceivedServerCompletion){if((s==null?void 0:s.author.role)===Ue.System){const g=(r=s.metadata)!=null&&r.parent_id?this.currentTree.getNodeByIdOrMessageId(s.metadata.parent_id):void 0;if((g==null?void 0:g.message.author.role)!==Ue.User){this.currentTree.appendSystemMessageToRoot(s);return}}else if((s==null?void 0:s.author.role)===Ue.User)return;if(this.currentTree.hasNodeOrMessageId(s.id))return}if(this.firstResponse&&((o=s.metadata)!=null&&o.rebase_system_message)){O.updateTree(this.clientThreadId,g=>{var k;if(((k=s.metadata)==null?void 0:k.parent_id)==null)throw Error("Unexpected rebased system message without parent");const x=g.getNodeByIdOrMessageId(this.targetNodeId);g.deleteNode(this.targetNodeId),g.addNode(s.id,s,s.metadata.parent_id,s.author.role),g.addNode(x.id,x.message,s.id,x.message.author.role)});return}if(this.firstResponse){const g=((a=ei.getState().threads[this.clientThreadId])==null?void 0:a.continuingFromSharedConversationId)!=null;O.removeContinuingFromSharedConversationId(this.clientThreadId),this.firstResponse=!1,this.didCreateFirstCompletionInNewThread=!this.currentTree.hasReceivedServerCompletion||g,O.updateTree(this.clientThreadId,k=>{k.updateNodeMessage(this.currentNodeId,s)}),this.didCreateFirstCompletionInNewThread&&Qa.onCreate(this.queryClient);const x={id:this.targetNodeId,threadId:i,completionType:this.completionType,eventSource:this.eventSource,model:this.model};if(this.completionType===On.Next){const k=ei.getState().threads[i],M=(l=k==null?void 0:k.conversationTurns)==null?void 0:l.length,N=(d=k==null?void 0:k.conversationTurns)==null?void 0:d.filter(T=>T.role==Ue.User),A=N&&((u=N[N.length-1])==null?void 0:u.messages[0].message);if((A==null?void 0:A.content.content_type)==un.Text){const T=A.content.parts.join("").length,_=(N==null?void 0:N.length)??0;x.countConversationTurns=M,x.countUserSubmittedMessages=_,x.countLastUserPromptTextMessageLength=T}}ee.logEvent($.generateCompletion,x)}else if(this.completionType!==On.Continue){const g=this.currentTree.containsNodeOrMessageId(s.id),x=(p=s.metadata)==null?void 0:p.parent_id;if(g||(this.debouncedUpdateCompletion.flush(),O.updateTree(this.clientThreadId,k=>{if(x==null)throw new Error(`Received a message with no parentId: ${JSON.stringify(s)}`);k.addNode(s.id,s,x,Ue.Assistant)})),x!=null&&x===this.activeBranchNodeId){const k=this.allIncompleteStreamedMessages[x];k!=null&&(O.updateTree(this.clientThreadId,M=>{qu(M,k)}),delete this.allIncompleteStreamedMessages[x])}if(t=(((m=this.variantsInStreamInfo)==null?void 0:m.num_variants_in_stream)??1)===1||this.activeBranchNodeId==null||this.activeBranchNodeId===s.id||this.currentTree.isAncestorOfNode(this.activeBranchNodeId,s.id),t&&this.activeBranchNodeId!==s.id){this.activeBranchNodeId=s.id,this.currentNodeId=s.id;const k=O.getThreadCurrentLeafId(this.clientThreadId);this.currentTree.messageIdToNodeId(this.currentNodeId)!==this.currentTree.messageIdToNodeId(k)&&O.setThreadCurrentLeafId(this.clientThreadId,this.currentNodeId),x!=null&&O.updateTree(this.clientThreadId,M=>{const N=M.getParentPromptNode(s.id);M.updateNodeMetadata(N.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}}if((s==null?void 0:s.author.role)===Ue.Tool&&(s==null?void 0:s.author.name)==="bio"){const g=(b=s.metadata)==null?void 0:b.gizmo_id;setTimeout(()=>{this.queryClient.invalidateQueries({queryKey:Zy(g)})},5e3)}t&&(this.activeBranchLastMessage=s),this.messagesToUpdate[s.id]=s,this.allIncompleteStreamedMessages[s.id]=s}async handleDone(){var e,t;if(this.isCompletionBlocked||(this.debouncedUpdateCompletion.flush(),this.isEitherFlagged||(this.didCreateFirstCompletionInNewThread&&Qa.onCreateFinished(this.navigate,this.queryClient,this.responseThreadId),this.onCompletionFinished(this.responseThreadId))),O.updateTree(this.clientThreadId,s=>{Object.values(this.allIncompleteStreamedMessages).forEach(i=>{qu(s,i)})}),at.checkGate("187267097")===!0){const s=await Ve(()=>import("./sso-ipuhfmti911l5wbt.js").then(a=>a.F),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69])).then(a=>a).catch(()=>null),i=O.getServerThreadId(this.clientThreadId),r=O.getTitle(this.clientThreadId),o=O.getTree(this.clientThreadId);i&&(s==null||s.addConversation(i,r??"",o,this.currentNodeId))}if(this.blurDuringCompletionTracker.onMessageDone(),this.cleanUp(),((t=(e=this.activeBranchLastMessage)==null?void 0:e.metadata)==null?void 0:t.client_actions)!==void 0){const s=await ex(this.clientThreadId,this.activeBranchLastMessage);s.length>0&&this.callModelAgain(this.currentNodeId,s)}}cleanUp(){setTimeout(()=>{Wo.removeRequest(this.targetNodeId),O.releaseThread(this.clientThreadId)},0)}}const NE=1e3*30,Va=ef.getTracer("completion"),Ga=n=>(n==null?void 0:n.code)==="challenge_required";class Wa extends Error{}function IE(n,e,t,s){const i=async(r=null,o=!1)=>{var D,V,J,W,X,ye;const a=new AbortController,l="threadId"in e?e.threadId:void 0,d="continueFromSharedConversationId"in e?e.continueFromSharedConversationId:void 0,u=Rr(),p={action:e.completionType,messages:e.messages.length>0?e.messages:void 0,conversation_id:l,continue_from_shared_conversation_id:l!=null?void 0:d,parent_message_id:e.parentMessageId,model:e.model,timezone_offset_min:new Date().getTimezoneOffset(),variant_purpose:(D=e.completionMetadata)==null?void 0:D.variantPurpose,suggestions:(V=e.completionMetadata)!=null&&V.suggestions?e.completionMetadata.suggestions.map(L=>o0(L)):void 0,history_and_training_disabled:e.historyDisabled,juice:(J=e.completionMetadata)==null?void 0:J.juice,conversation_mode:(W=e.completionMetadata)==null?void 0:W.conversationMode,force_paragen:e.forceParagen,force_paragen_model_slug:e.forceParagenModel,force_nulligen:e.forceNulligen,force_indepth_feedback:e.forceIndepthFeedback,force_rate_limit:e.forceRateLimit,reset_rate_limits:e.resetRateLimits,disable_system_content_toggling:e.disableSystemContentToggling,websocket_request_id:u,source:(X=e.completionMetadata)==null?void 0:X.source,system_hints:(ye=e.completionMetadata)==null?void 0:ye.systemHints,force_use_sse:!Ss.isWebsocketConnected(),conversation_origin:e.conversationOrigin,force_use_search:e.forceUseSearch},m=Vh(await Uh(n));let b="/backend-api";m&&(b="/backend-anon");const g=`${b}/conversation`;let x=!0,k=!0;const M=m?Xc.getUnauthHeaders().additionalHeaders:await Xc.getAuthedHeaders(),N=gb(e.chatReq,r??e.arkoseToken,e.turnstileToken,e.proofToken,null),A={...M,...tx(),...N};let T,_,j;Va.startActiveSpan("completion.response",L=>{T=Va.startSpan("completion.first_response"),_=Va.startSpan("completion.first_token"),j=L});const P=ef.setSpan(Zc.active(),j);function B(L){if(L.data==="[DONE]")a.abort(),j.end(),t({type:"done"});else if(L.event!=="ping")try{const F=JSON.parse(L.data);if(F.error){const xe=new as(F.error);throw t({type:"error",error:xe}),xe}else"type"in F?F.type==="gizmo_inline_review"?t({type:"gizmo_inline_review",gizmoId:F.gizmo_id}):F.type==="title_generation"?t({type:"title_generation",title:F.title,conversation_id:F.conversation_id}):F.type==="moderation"?t({type:"moderation",conversationId:F.conversation_id,messageId:F.message_id,isCompletion:F.is_completion,flagged:F.moderation_response.flagged,blocked:F.moderation_response.blocked,disclaimers:F.moderation_response.disclaimers,metadata:F.moderation_response.metadata}):F.type==="url_moderation"?t({type:"url_moderation",conversationId:F.conversation_id,messageId:F.message_id,url:F.url_moderation_result.full_url,isSafe:F.url_moderation_result.is_safe}):F.type==="num_variants_in_stream"?t({type:"num_variants_in_stream",num_variants_in_stream:F.num_variants_in_stream,display_treatment:F.display_treatment}):F.type==="conversation_detail_metadata"&&t(F):(t({type:"message",message:F.message,conversationId:F.conversation_id}),k&&(k=!1,T.end()),x&&F.message.author.role==="assistant"&&F.message.content.content_type==="text"&&F.message.content.parts[0]!==""&&(x=!1,_.end()))}catch(F){if(F instanceof zs)throw new as(F.message)}}let I=null,q=setTimeout(()=>{I===!0?ee.logEvent($.asyncResponseWaitTooLong,{}):I===!1&&ee.logEvent($.sseResponseWaitTooLong,{})},NE);return wS(u,B,a.signal),Zc.with(P,()=>nx(g,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...A},body:JSON.stringify(p),signal:a.signal,openWhenHidden:!0,async onopen(L){var re;const F=L.headers.get("content-type")??"",xe=L.headers.get("Cf-Ray")??null;if(L.ok&&F.includes("text/event-stream")){I=!1,s(xe,e.model);return}else if(F.includes("application/json")){const Z=await L.json(),{webSocketUrl:ke,fallbackWebSocketUrl:be,conversationId:le,responseId:he,expiresAt:Oe,websocketRequestId:ce}=SS(Z);if(ke!=null&&le!=null&&he!=null&&ce!=null&&Oe){I=!0,s(xe,e.model);try{await kS(ke,be,Oe,le,he,ce,B,a.signal,q)}catch(z){z instanceof as&&t({type:"error",error:z})}throw new Wa}else{const z=(Z==null?void 0:Z.error)??(Z==null?void 0:Z.detail),Ce=(z==null?void 0:z.message)??z??"Unknown server error";if(z){if(Ga(z))throw new zs(Ce,L.status,z.code);if(L.status>=500)throw new as(Ce);if(((z==null?void 0:z.code)==="expired_session_key"||(z==null?void 0:z.code)==="invalid_api_key"||(z==null?void 0:z.code)==="token_expired")&&typeof window<"u"&&((re=window._oaiHandleSessionExpired)==null||re.call(window,"stream",JSON.stringify(z))),(z==null?void 0:z.code)==="deactivated_workspace"){window.location.href.includes("/workspace/deactivated")||(window.location.href="/workspace/deactivated");return}throw new zs(Ce,L.status,z==null?void 0:z.code,z==null?void 0:z.type,void 0,z==null?void 0:z.clears_in)}}}throw new as(ed)},onmessage:L=>{if(I)throw new as(ed);q&&(clearTimeout(q),q=null),B(L)},onerror(L){let F=L instanceof Error?L:new Error(JSON.stringify(L));throw F instanceof Wa||I||Ga(F)&&!o||(F.message==="Failed to fetch"&&(F=new as(`An error occurred. Either the engine you requested does not exist or there was another issue processing your request. ${Ja}`)),F.message==="network error"&&(F=new zs(`A network error occurred. Please check your connection and try again. ${Ja}`,400)),yb("fetch-error:conversation:new-message",{url:g,message:F==null?void 0:F.message}),t({type:"error",error:F})),F}})).catch(async L=>{if(Ga(L)){if(o)throw new zs("Failed to complete your call, please try again",L.status);{const F=await pr.getEnforcementToken(e.chatReq);return i(F,!0)}}L instanceof Wa||jt.addError(L)}),a};return i()}function AE(n,e,t){const s=$o(),i=Bi(),r=S.useRef(t);r.current=t;const o=S.useCallback(async function({model:a,completionType:l,parentNodeId:d,metadata:u,focusOnNewCompletion:p=!0,completionMetadata:m,chatReq:b,arkoseToken:g,turnstileToken:x,proofToken:k,preflightTime:M,extraStreamParams:N,appendMessages:A,updateTree:T}){var xe,re,Z,ke,be;Dh.publish({kind:"requestCompletion"});const _=O.getTree(n);O.retainThread(n);const j=qb(),P=`${xb}${n}-${j}`,B=`${n}-${j}`;T==null||T();const I=_.getNodeByIdOrMessageId(d),G={gizmo_id:(xe=I.message.metadata)==null?void 0:xe.gizmo_id};(m==null?void 0:m.juice)!=null&&(G.snorkle_status=1),O.updateTree(n,le=>{le.addNode(P,"",d,Ue.Assistant,void 0,G)}),p&&O.setThreadCurrentLeafId(n,P);let D;const V=[];let J=_.getNodeByIdOrMessageId(I.parentId);for(;J!=null&&(((re=J.metadata)==null?void 0:re.isPlaceholderTemplateAssistantWelcomeMessage)===!0||((Z=J.metadata)==null?void 0:Z.isClientCreatedSystemMessage)===!0);){const le=J.message;V.unshift(le);const he=_.getNodeByIdOrMessageId(J.parentId);D=((ke=he.message)==null?void 0:ke.id)??he.id,J=he}if(l===On.Next||l===On.Variant){const le=_.getNodeByIdOrMessageId(I.parentId);if(D??(D=((be=le.message)==null?void 0:be.id)??le.id),V.push(I.message),A){let he=d;O.updateTree(n,Oe=>{for(const ce of A)Oe.insertNodeBefore(P,{id:ce.id,message:ce,parentId:he,children:[]}),he=ce.id}),V.push(...A)}}else D??(D=I.message.id);const W=O.getServerThreadId(n);W===void 0&&Xn(n)&&O.updateInitialThreadDataForNewThread(n,a);async function X(le,he){const Oe=performance.now(),ce=await tc();pr.initializeAndGatherData(ce),yo.initializeAndGatherData(ce),Mo.initializeAndGatherData(ce),O.updateTree(n,Qe=>{for(const Ee of he)Qe.addNode(Ee.id,Ee,le,Ue.Assistant,{completionSampleFinishTime:Date.now()}),le=Ee.id}),O.setThreadCurrentLeafId(n,le);const z=await pr.getEnforcementToken(ce),Ce=await yo.getEnforcementToken(ce),Ye=await Mo.getEnforcementToken(ce);o({model:a,completionType:On.Next,parentNodeId:le,metadata:{},chatReq:ce,arkoseToken:z??null,turnstileToken:Ce??null,proofToken:Ye??null,preflightTime:performance.now()-Oe,extraStreamParams:N})}const ye=new _E(s,n,P,l,a,u.eventSource,i,B,X,(...le)=>r.current(...le)),L=(le,he)=>{sx(B,he,le,M)},F=await IE(s,{conversationOrigin:O.getConversationOrigin(n),model:a,completionType:l,threadId:W,continueFromSharedConversationId:e,historyDisabled:qo(),parentMessageId:D,messages:V,chatReq:b,arkoseToken:g??null,turnstileToken:x??null,proofToken:k??null,completionMetadata:m,...N},ye.handleResponse,L);Wo.addRequest(P,F),Sm.onCompletionRequestStarted(P)},[s,n,e,i]);return o}function RE({clientThreadId:n,currentModelId:e}){const t=Qv(e,cm.CODE_INTERPRETER);jE(t,n)}async function DE({queryKey:[n,e]}){return await Je.getThreadInterpreterState(e).then(t=>(t.time_remaining_ms===0&&t.kernel_started&&ln.warning("This advanced data analysis (beta) chat has timed out. You may continue the conversation, but previous files, links, and code blocks below may not work as expected.",{hasCloseButton:!0,duration:0}),t))}function jE(n,e){const t=zi(),s=O.getServerThreadId(e);return Yl({queryKey:["interpreterState",s],queryFn:DE,enabled:!!(n&&s&&!t),gcTime:0})}const OE=60,PE=({children:n,scrollViewClassName:e,scrollAnchorTopOffset:t=0})=>{const s=S.useRef(null);return c.jsx("div",{className:"h-full",ref:s,children:c.jsx(bb,{children:c.jsx(Q0,{className:"h-full",followButtonClassName:"hidden",initialScrollBehavior:"auto",scrollViewClassName:e,scroller:()=>FE(s,t)?0:1/0,children:n})})})},FE=(n,e)=>{const t=BE(n.current);if(t==null)return!1;const s=t>e,i=t<e-OE;return!s&&!i};function BE(n){if(!n)return null;const e=n.querySelector('[data-scroll-anchor="true"]');if(!e)return null;const t=e.getBoundingClientRect().top,s=n.getBoundingClientRect().top;return t-s}const LE=We(()=>Ve(()=>import("./sn3xcrw3vrcc2hpz.js"),__vite__mapDeps([96,1,2,3,7,4,5,8,9,53,51,52,34,17,73,74,27,61,6,75,54,12,13,14,15,16,24,25,62,23,76])).then(n=>n.OpenDebugSidebarButton)),zE=We(()=>Ve(()=>import("./f3yoq3eqacn2jfld.js"),__vite__mapDeps([97,1,2,3,4,5,68,8])),{ssr:!1}),UE=We(()=>Ve(()=>import("./sso-ipuhfmti911l5wbt.js").then(n=>n.j),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69])).catch(()=>()=>null),{ssr:!1}),VE=We(()=>Ve(()=>import("./sso-ipuhfmti911l5wbt.js").then(n=>n.P),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69])).then(n=>n.default)),GE=We(()=>Ve(()=>import("./sso-ipuhfmti911l5wbt.js").then(n=>n.k),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69])).then(n=>n.CAFeedbackModal).catch(()=>()=>null)),Ms=qe({doNotShareSensitive:{id:"thread.modal.onboarding.title",defaultMessage:"Do not share sensitive materials with this application"},mayProduceInaccurateInformation:{id:"thread.chatgptMayProduceInaccurateInformation-oct-30",defaultMessage:"ChatGPT can make mistakes. Check important info."},mayProduceInaccurateInformationNoAuth:{id:"thread.chatgptMayProduceInaccurateInformationNoAuth-march-27",defaultMessage:"ChatGPT can make mistakes. Check important info. Read our <termsLink>Terms</termsLink> and <privacyLink>Privacy Policy</privacyLink>."},mayProduceInaccurateInformationNoAuthV2:{id:"thread.chatgptMayProduceInaccurateInformationNoAuth-may-06",defaultMessage:"By messaging ChatGPT, you agree to our <termsLink>Terms</termsLink> and have read our <privacyLink>Privacy Policy</privacyLink>."},mayProduceInaccurateInformationNoAuthKorea:{id:"thread.chatgptMayProduceInaccurateInformationNoAuthKorea-may-06",defaultMessage:"By messaging ChatGPT, you agree to our <termsLink>Terms</termsLink> and have read our <privacyLink>Privacy Policy</privacyLink> and its <koreaAddendumLink>Korea addendum</koreaAddendumLink>."},businessDisclaimer:{id:"thread.businessDisclaimer-oct-30",defaultMessage:"{workspaceName} workspace chats aren't used to train our models. ChatGPT can make mistakes."},businessDisclaimerNoName:{id:"thread.businessDisclaimerNoName-oct-30",defaultMessage:"Your workspace chats aren'ts used to train our models. ChatGPT can make mistakes."},outdatedGptDisclaimer:{id:"thread.outdatedGptDisclaimer.0",defaultMessage:"<bold>New version of GPT available</bold> - Continue chatting to use the old version, or start a <link>new chat</link> for the latest version."},somethingWentWrong:{id:"thread.modal.unrecoverableError.title",defaultMessage:"Something went wrong"},tryAgainLater:{id:"thread.modal.unrecoverableError.description",defaultMessage:"We're sorry, but something went wrong. Please try again later."},resetThread:{id:"thread.modal.unrecoverableError.resetThread",defaultMessage:"Reset thread"},sharedConversationReportConversation:{id:"thread.sharedConversation.report",defaultMessage:"Report conversation"},latencyButton:{id:"thread.latencyButton",defaultMessage:"Latency"},archivedConversationDescription:{id:"thread.archivedConversationDescription",defaultMessage:"This conversation is archived. To continue, please unarchive it first."},unarchiveButton:{id:"thread.unarchiveButton",defaultMessage:"Unarchive"}});function WE({clientThreadId:n}){const e=hn(n);return e!=null?c.jsx(HE,{clientThreadId:n,gizmoId:e}):c.jsx(Nm,{clientThreadId:n})}function HE({clientThreadId:n,gizmoId:e}){const t=Ts(e).data,s=ei(r=>Ot.getThreadCreateTime(n,r)),i=(t==null?void 0:t.gizmo.updated_at)!=null?new Date(t.gizmo.updated_at):void 0;return(t==null?void 0:t.gizmo.short_url)==null||i==null||s==null||i<=s?c.jsx(Nm,{clientThreadId:n}):c.jsxs("span",{className:"text-token-text-tertiary",children:[c.jsx(bf,{className:"text-token-secondary mb-1 mr-1 inline-block h-4 w-4 stroke-0"}),c.jsx(U,{...Ms.outdatedGptDisclaimer,values:{link:r=>c.jsx(Eb,{href:tf(t.gizmo.short_url),className:"underline",shallow:!0,children:r}),bold:r=>c.jsx("span",{className:"text-token-secondary font-semibold",children:r})}})]})}function Nm({clientThreadId:n}){const e=wo($l.isBusinessWorkspace),t=wo(u=>u.currentWorkspace),s=t==null?void 0:t.name,{isUnauthenticated:i,isLoading:r}=Xt(),a=hf({clientThreadId:n,role:Ue.User})>0,l=ah(u=>u.hasAcceptedFooterDisclaimer),d=i&&!a&&!l;return r?null:e?c.jsx("span",{children:s!=null?c.jsx(U,{...Ms.businessDisclaimer,values:{workspaceName:s}}):c.jsx(U,{...Ms.businessDisclaimerNoName})}):d?c.jsx(qE,{clientThreadId:n}):c.jsx("span",{children:c.jsx(U,{...Ms.mayProduceInaccurateInformation})})}function qE({clientThreadId:n}){const{country:e}=_b(),t=e==="KR"?Ms.mayProduceInaccurateInformationNoAuthKorea:Ms.mayProduceInaccurateInformationNoAuthV2;return S.useEffect(()=>()=>{hf({clientThreadId:n,role:Ue.User})>0&&px.updateHasAcceptedFooterDisclaimer()},[n]),c.jsx("span",{className:"text-sm",children:c.jsx(U,{...t,values:{privacyLink:s=>c.jsx("a",{href:"https://openai.com/privacy",target:"_blank",className:"text-token-text-primary underline decoration-token-text-primary",onClick:()=>{at.logEvent("chatgpt_footer_disclaimer_privacy_link_clicked"),ee.logEvent($.footerDisclaimerPrivacyLinkClicked)},children:s}),termsLink:s=>c.jsx("a",{href:"https://openai.com/terms",target:"_blank",className:"text-token-text-primary underline decoration-token-text-primary",onClick:()=>{at.logEvent("chatgpt_footer_disclaimer_terms_link_clicked"),ee.logEvent($.footerDisclaimerTermsLinkClicked)},children:s}),koreaAddendumLink:s=>c.jsx("a",{href:"https://openai.com/ko/policies/kr-privacy-policy-addendum",target:"_blank",className:"text-token-text-primary underline decoration-token-text-primary",onClick:()=>{at.logEvent("chatgpt_footer_disclaimer_korea_addendum_link_clicked"),ee.logEvent($.footerDisclaimerKoreaAddendumLinkClicked)},children:s})}})})}function $E({clientThreadId:n}){const e=$o(),t=Dr(n),s=async()=>{t&&(await Je.patchConversation(t,{is_archived:!1}),e.invalidateQueries({queryKey:["conversation",n]}),ei.setState(i=>{const r=i.threads[t];r!=null&&(r.initialThreadData.isArchived=!1)}),jl(e))};return c.jsxs("div",{className:"my-6 flex flex-col items-center justify-center gap-4",children:[c.jsx("div",{className:"px-3 text-center text-sm text-token-text-secondary",children:c.jsx(U,{...Ms.archivedConversationDescription})}),c.jsx("div",{children:c.jsx(It,{disabled:!t,onClick:s,icon:I0,children:c.jsx(U,{...Ms.unarchiveButton})})})]})}function KE(n,e){const t=Xn(n),s=O.getTitle(n);return e&&e.kind===ot.GizmoInteraction&&e.gizmo?t?`ChatGPT - ${e.gizmo.gizmo.display.name}`:s&&`${e.gizmo.gizmo.display.name} - ${s}`:t?"ChatGPT":s}const R_=function({clientThreadId:n,initiallyHighlightedMessageId:e,continueConversationUrl:t,onCompletionFinished:s,preRequestCompletion:i,hideHeader:r,hideMessages:o,hideFooter:a,hideToolsOverlay:l,messagesVerticalAlign:d="top",prependThreadChildren:u,renderEmptyState:p}){var ui,hi,fi;const m=$o(),b=S.useContext(Xh),g=b!=null,x=ts(),k=Li(),M=Nr(),N=Ql(),A=M,T=ur(),_=Zo(n),j=Fi(),P=g&&((hi=(ui=j.query)==null?void 0:ui.shareParams)==null?void 0:hi[1])==="moderate",B=ac(n),I=Bn(n),G=df(n).isArchived;S.useEffect(()=>{B||(Xn(n)?jt.addTiming("chatgpt.web.chatPage.renderNewConversation"):jt.addTiming("chatgpt.web.chatPage.renderExistingConversation"))},[n,B]);const D=$b(n,I),V=uf(n,I),J=cf(n),{setTargetedContent:W}=wh(),X=oc(n),ye=Kb(n),L=Ui(n),F=Fn(L),xe=S.useRef(null);S.useEffect(()=>{async function we(){const Ke=await sf(n,!0);if(F||Ke.async_status!==vo.PENDING)return;const Nn=Ke.update_time??0;mx(new Date,new Date(Nn*1e3))<5?xe.current=window.setTimeout(we,2e3):Je.clearConversationStatus(n)}return!F&&X===vo.PENDING&&we(),()=>{xe.current&&window.clearTimeout(xe.current)}},[X,ye,n,F]);const re=(fi=Qn("90459671"))==null?void 0:fi.value,[Z,ke]=S.useState(),[be,le]=S.useState(),[he,Oe]=S.useState(),[ce,z]=S.useState(),Ce=k==null?void 0:k.includes(Sb),Ye=ix(),Qe=V>=2,Ee=Xn(n)&&!Qe&&eo(_),ae=Xn(n)&&!D&&(eo(_)||(_==null?void 0:_.kind)===ot.GizmoTest),Ge=Jl().id,Be=kx(n)??Ge,{value:Se}=Qn("1410082514"),{value:it}=Qn("4203174056"),lt=jh(Be),tt=Fh()[Be],He=KE(n,_),ft=Es(n),Le=Tr(),Ae=Cf(n),{config:y}=wb("1013114931"),h=y.get("show_follow_ups",!1)&&(x==null?void 0:x.isPersonalAccount()),f=!T.displayingSideBySideFeedback&&h;S.useEffect(()=>{$a()},[]),S.useEffect(()=>{Le||W(void 0)},[n,W,Le]);const w=S.useCallback(pe=>{if(pe==null||(s==null||s(pe),qo())||((ft==null?void 0:ft.kind)===ot.GizmoInteraction&&Db.handleGizmoInteracted(m,ft.gizmo_id),!(Ae||f)))return;const we=O.getThreadCurrentLeafId(pe),Ke=O.getTree(pe).getMessage(we);kb(Ke)||Cb(Ke)||rx(pe,Ke.id,Be)},[m,s,ft,Ae,f,Be]),v=Jb(n),E=AE(n,v,w),R=S.useCallback(()=>{const pe=O.getThreadCurrentLeafId(n);if(pe==null)return;const we=O.getTree(n).getBranchFromLeaf(pe);Wo.abortRequests(we.map(Ke=>Ke.id))},[n]),ne=ii(),{isUnauthenticated:Re}=Xt(),_e=Ph(),ge=S.useCallback(async({type:pe,promptId:Te,requestedModelId:we,eventMetadata:Ke,cancelActiveRequests:Nn,focusOnNewCompletion:is=!0,useDefaultModel:pn,completionMetadata:In,appendMessages:nn,updateTree:Ds})=>{$a(),ih.reset(),Nn&&R();const qi=performance.now();let js=Be;we?js=we:pn&&(js=Ge);const St=Oh({namespace:xo.CompletionRequest,key:Te});St==null||St.logTiming("start_chat_requirements");const rs=await tc();St==null||St.logTiming("fetched_chat_requirements"),rs.force_login&&_e({authType:"login"});const Fr=await pr.getEnforcementToken(rs);St==null||St.logTiming("fetched_arkose_token");const Y=await yo.getEnforcementToken(rs);St==null||St.logTiming("fetched_turnstile_token");const yt=await Mo.getEnforcementToken(rs);St==null||St.logTiming("fetched_p_token"),i==null||i(n,Te),E({model:js,completionType:pe,parentNodeId:Te,metadata:Ke,focusOnNewCompletion:is,completionMetadata:In,chatReq:rs,arkoseToken:Fr??null,turnstileToken:Y??null,proofToken:yt??null,preflightTime:performance.now()-qi,extraStreamParams:{forceParagen:ne.forceParagen,forceParagenModel:ne.forceParagenModel.value,forceNulligen:ne.forceNulligen,forceRateLimit:ne.forceRateLimit,resetRateLimits:ne.resetRateLimits,disableSystemContentToggling:ne.rebaseSystemMessageContent?!0:void 0,forceUseSearch:ne.forceUseSearch??void 0},appendMessages:nn,updateTree:Ds}),Re&&ox.incrementUserMessageCount()},[Ge,Be,i,n,E,ne.forceParagen,ne.forceParagenModel,ne.forceNulligen,ne.forceRateLimit,ne.resetRateLimits,ne.rebaseSystemMessageContent,ne.forceUseSearch,R,_e,Re]),fe=!!(x!=null&&x.features.includes(Ar.SharedWebsocket));S.useEffect(()=>{fe&&Ss.registerIfNotConnected()},[fe]),S.useEffect(()=>{const pe=()=>{if(document.visibilityState==="visible"){if(!fe)return;Ss.registerIfNotConnected()}};return document.addEventListener("visibilitychange",pe),()=>{document.removeEventListener("visibilitychange",pe)}},[fe]);const Me=Dr(n);S.useEffect(()=>{const pe=()=>{Ss.stopConversation(Me)};return window.addEventListener("beforeunload",pe),()=>{window.removeEventListener("beforeunload",pe)}},[Me]),jb({clientThreadId:n,currentLeafId:I,handleRequestCompletion:ge});const fn=S.useCallback((pe,Te,we=!0,Ke="none",Nn)=>{const pn=O.getTree(n).getParentPromptNode(pe).id;ge({type:On.Variant,promptId:pn,eventMetadata:Te,cancelActiveRequests:!1,focusOnNewCompletion:we,useDefaultModel:Nn,completionMetadata:{variantPurpose:Ke,conversationMode:Ot.getConversationMode(n)}})},[ge,n]),Ct=S.useCallback(pe=>{const we=O.getTree(n).getLeafFromNode(pe);O.setThreadCurrentLeafId(n,we.id)},[n]),[Is,En]=S.useState(),ze=S.useCallback(({nodeId:pe,messageId:Te,rating:we})=>{var pn,In;const Ke=O.getServerThreadId(n);ee.logEvent($.thumbRating,{id:Te,threadId:Ke,rating:we,model:Be});const Nn=O.getTree(n),is=Nn.getNodeByIdOrMessageId(pe);if(Ke!==void 0&&(Se&&((pn=is.message.metadata)==null?void 0:pn.snorkle_status)!=null?Je.submitSnorkleFeedback:lt?_t:Je.submitMessageFeedback)({message_id:Te,conversation_id:Ke,rating:we}),O.updateTree(n,nn=>{nn.updateNodeMetadata(pe,{rating:we})}),lt){En(c.jsx(GE,{citations:((In=is.message.metadata)==null?void 0:In.citations)??[],rating:we,conversationId:Ke??"",messageId:Te,onSubmit:()=>{En(void 0)},onCancel:()=>En(void 0),conversationTree:Nn,nodeId:pe},`${pe}-${we}`));return}if(!at.getExperimentValue({experimentName:"101132775",key:"show_new_ui",defaultValue:!1})&&(Oe(pe),z(Te),le(we),we==="thumbsDown"&&A)){const Ds=O.getTree(n).getConversationTurns(pe||"root"),qi=Ds[Ds.length-1];uo(qi)&&fn(pe,{eventSource:"mouse",intent:"comparison"},!1,"comparison")}},[n,Be,A,fn,lt,Se]),{setShowReferralInviteModal:nt}=Kc(pe=>({setShowReferralInviteModal:pe.setShowReferralInviteModal})),st=S.useCallback(()=>{nt(!1)},[nt]),Zt=Kc(pe=>pe.showReferralInviteModal);RE({clientThreadId:n,currentModelId:Be});const ai=pe=>g?c.jsx("div",{className:"h-full overflow-auto bg-token-main-surface-primary",children:pe}):c.jsx(PE,{scrollAnchorTopOffset:r?0:gx,children:d==="bottom"?c.jsxs("div",{className:"flex h-full flex-col",children:[c.jsx("div",{className:"flex-1"}),pe]}):pe}),ss=(pe=!1)=>c.jsx(TE,{onChangeItemInView:Ct,onRequestMoreCompletions:fn,onChangeRating:ze,onRequestCompletion:ge,clientThreadId:n,initiallyHighlightedMessageId:e,inlineEmbeddedDisplay:!1,conversationLeafId:I,hideHeader:r,renderOnlyTurns:pe},n);S.useEffect(()=>{document.title=He??"ChatGPT"},[He]);const li=hn(n),Un=es(),en=ae&&!p&&N&&!li&&!lt&&!Un,Vn=zv(en),tn=en&&Vn,{composerBarSize:As,composerSkeleton:Gn,footerBarSize:Rs,isClippedComposerBar:_n,setComposerBarElement:ci,setFooterBarElement:Wi,ThreadSizeWrapper:Hi}=ax({isArchived:G}),di=_n?{footerBarSize:Rs,composerBarSize:As}:{};return c.jsxs(Hi,{...di,children:[Ce&&c.jsx(zE,{}),it&&c.jsx(VE,{}),c.jsxs(Mb,{children:[He!=null&&c.jsx("title",{children:He}),g&&c.jsxs(c.Fragment,{children:[c.jsx("meta",{property:"og:site_name",content:"ChatGPT"}),c.jsx("meta",{name:"robots",content:b.isIndexable?"index,nofollow":"noindex,nofollow"},"robots"),c.jsx("meta",{property:"og:title",content:He??"Shared Chat on ChatGPT"},"og:title"),c.jsx("meta",{property:"og:description",content:"Shared "+(J!=null?`by ${J} `:"")+"via ChatGPT"},"og:description"),c.jsx("meta",{property:"og:image",content:vb.src},"og:image")]})]}),(_==null?void 0:_.kind)===ot.GizmoInteraction&&_.gizmo&&c.jsx(Yb,{gizmo:_.gizmo}),c.jsx(nc.Provider,{value:ge,children:c.jsxs(lx,{children:[c.jsxs(Cw,{clientThreadId:n,currentModelConfig:tt,className:"composer-parent flex h-full flex-col focus-visible:outline-0",children:[!o&&c.jsx(JE,{className:te(_n&&"masked-content"),style:{"--composer-bar_skeleton":Gn},children:B?null:ae?p??c.jsx(bE,{clientThreadId:n,currentModelId:Be,onRequestCompletion:ge,enableV2Homepage:tn}):Qe?ai(c.jsxs(c.Fragment,{children:[u,ss()]})):null}),c.jsx(YE,{className:te(_n&&"mask-scrollbars absolute bottom-0 z-20"),children:G?c.jsx($E,{clientThreadId:n}):c.jsxs("div",{className:te(_n&&"relative mx-auto flex max-w-3xl flex-1 flex-col"),children:[_n?c.jsx(cx,{skeleton:Gn}):null,g?c.jsx(tE,{clientThreadId:n,isModeratingThread:P,continueConversationUrl:t}):!tn&&c.jsx(Fv,{clientThreadId:n,isNewThread:Ee,setComposerBarElement:ci,showPromptStarters:Ee||!D,currentModelId:Be,onRequestCompletion:ge}),!a&&c.jsx("div",{ref:Wi,className:"relative w-full px-2 py-2 text-center text-xs text-token-text-secondary empty:hidden md:px-[60px]",children:g?c.jsx(dx,{onClickReportSharedConversation:()=>{re?Ri.openModal(hr.ReportConversation):ke(I)}}):eo(_)&&c.jsx(WE,{clientThreadId:n})})]})})]}),!l&&c.jsxs("div",{className:"group absolute bottom-2 end-2 z-20 hidden gap-1 md:flex lg:bottom-3 lg:end-3",children:[Ye?c.jsxs(c.Fragment,{children:[c.jsx(LE,{}),c.jsx(UE,{})]}):null,c.jsx(X0,{})]}),Is,c.jsx(Qb,{serverThreadId:(b==null?void 0:b.serverSharedThreadId)??void 0,clientThreadId:n,isStaticSharedThread:g}),c.jsx(Z1,{clientThreadId:n,currentLeafId:I,currentModelId:Be,onChangeItemInView:Ct,onRequestMoreCompletions:fn,onChangeRating:ze,onRequestCompletion:ge,ratingModalOpen:be,ratingModalNodeId:he,ratingModalCompletionId:ce,setRatingModalOpen:le,sharedConversationReportModalNodeId:Z,setSharedConversationReportModalNodeId:ke}),c.jsx(ux,{}),(k==null?void 0:k.includes(Tb))&&c.jsx(hx,{isOpen:Zt,onClose:st}),c.jsx(fx,{conversationId:n,currentModelId:Be})]})})]})},JE=et.div`grow flex-1 overflow-hidden`,YE=et.div`md:pt-0 dark:border-white/20 md:border-transparent md:dark:border-transparent w-full`;export{x_ as $,ys as A,aa as B,Il as C,ut as D,wi as E,H as F,Hu as G,A_ as H,I_ as I,N_ as J,Ek as K,kE as L,ki as M,TE as N,Rc as O,oi as P,iw as Q,Et as R,Ok as S,Fv as T,Zo as U,w_ as V,PE as W,k_ as X,C_ as Y,uE as Z,aS as _,rm as a,eS as a0,If as a1,co as a2,pk as a3,tp as a4,Lw as a5,Jt as a6,Q as a7,so as a8,pc as a9,_s as b,Kt as c,Fe as d,na as e,Jk as f,Ne as g,sC as h,Xw as i,jn as j,yl as k,QM as l,cv as m,MS as n,FM as o,b_ as p,R_ as q,JT as r,v_ as s,T_ as t,AE as u,vn as v,M_ as w,Mm as x,bm as y,VT as z};
