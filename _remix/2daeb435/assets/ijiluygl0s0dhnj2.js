const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/i92drs6rowd2f4bs.js","assets/hwf9zvd1aw2q6bni.js","assets/o9jymz7vdhi3lqx8.js","assets/root-ln1yae7t.css","assets/k8wo5wv9rjmp61bm.js","assets/gcq6nq5ilw3cni50.js","assets/conversation-small-c8xg50op.css","assets/on5i6wiudhy03n19.js","assets/d43u2na4qorz1obq.js","assets/dwqs41wa5ufncm86.js","assets/g94gjpa24d3dgkvc.js","assets/shared-mk6ngktc.css","assets/iifiuc3nib6ssn9e.js","assets/i2qxjm7ksuhoez8f.js","assets/1tm7s25tu0rcb1ao.js","assets/d2enjwn8b6jly1r9.js","assets/hpsvd424sjrdhlcq.js","assets/2wm59teo35cqbdt1.js","assets/mtj6k2f8ve73w700.js","assets/lzjpn68pe1mv84wv.js","assets/e2kkvbg1i6izzv9a.js","assets/orl0zybyxtbw697s.js","assets/kpo9x19oorjkm66p.js","assets/mqj72pi2q2nphcdc.js","assets/cqk6btirean3jhb2.js","assets/oj1bhdun86139hql.js","assets/eoz02xxdbtlgnzui.js","assets/sso-dlecoq29tbbucwzg.js","assets/c8pe8tpqkw1fjx23.js","assets/et5vszokekahe2km.js","assets/gt0q5h2rq8bab6mk.js","assets/bt4k0k8i77cxp76b.js","assets/dbotdrhrkzcmepf8.js","assets/i8haxpriu70qoghy.js","assets/ctoq8lt2wcc1zt24.js","assets/hlp37ore79yxrotf.js","assets/b4s9ag5fqi92ivok.js","assets/evreryivkx03kiru.js","assets/h00uks2015m2626y.js","assets/jzhnik2dwoiq17kj.js","assets/bn0yn2an269lopsa.js","assets/g5dhaop2jzbfqw8o.js","assets/i5pk7xnq5wd6zbwm.js","assets/ndz9xyu0gzys1ltc.js","assets/mchebjgauimbna10.js","assets/ks31cwicy53kvdgr.js","assets/4dvgwa0oluu8ol5a.js","assets/kqwdyvkaaavvn8k3.js","assets/ilb5ktb37u71728e.js","assets/icw4oecl8vdgiw9h.js","assets/n667hftkiiftqmcp.js","assets/i9492jucznoqt7zq.js","assets/hbi8yge20ub5awhz.js","assets/nhwwej1nq0zrd7sc.js","assets/nhu8fej1h0ggf510.js","assets/lyni056hl6jy3n02.js","assets/d0g8ptgc5gcqjwyj.js","assets/j7phn6jkfp370rph.js","assets/isjdmfmhzv09v01t.js","assets/frhx66adsy7ij3wf.js","assets/gr4xpg7wa57x2uqj.js","assets/hizb1jv4u9gtdqdl.js","assets/b2ql00e3j8xnu33y.js","assets/grt4hlp4k5c4kxar.js","assets/ks402f7dn9mvtrb1.js","assets/ejn53uisfp14bkeb.js","assets/dqoeogg3yjw041er.js","assets/fxolzsu9v2t96ojq.js","assets/kvnjdr94x3wz3db4.js","assets/ooms65c6ollmf9pn.js","assets/iej0cupg2dqkmejt.js","assets/jc7bgpaw0qkg3jjz.js","assets/wx7snc14ve0jovkm.js","assets/flc79b0l9xqcxtxq.js","assets/gjdk1jlcjn7sf5mt.js","assets/sso-46pn026z.css","assets/fivpi7mcjmrk4ygn.js","assets/ixx8cnuni2mmv3rj.js","assets/kz8rnqdvs1s0dz6o.js","assets/gczrpqc7l3i1lmyi.js","assets/rohh4xbqmrtmi7o1.js","assets/d7xkeud1t7ujmb8b.js","assets/gq3s2kqgt70nz8mr.js","assets/fz32q2oa1uqdxjtu.js","assets/llc15xt3hq2xh1tb.js","assets/ii28oytv201d0g2x.js","assets/l1nj0s854oa5h446.js"])))=>i.map(i=>d[i]);
var Io=Object.defineProperty;var To=(t,e,s)=>e in t?Io(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var L=(t,e,s)=>To(t,typeof e!="symbol"?e+"":e,s);import{E as We,a1 as je,bV as qe,fJ as ds,cQ as jo,P as D,y as N,bO as ve,fK as Gn,eK as qn,ah as ze,K as Me,j as a,r as d,I as O,bt as rn,F as oe,c as $,dI as Mo,bL as Ro,fl as Eo,bM as bt,bn as wt,bp as Hn,fL as Vn,fe as us,v as Wn,a2 as Ao,L as xt,J as we,aq as vs,f6 as No,fs as $n,aL as Ss,w as cn,an as Kn,bR as Yn,c0 as ie,bT as Po,H as ms,fg as Do,cI as pe,fM as bs,bA as Zn,a4 as Gt,bY as qt,bX as ye,Q as Fo,S as Lo,T as Oo,N as Bo,av as Jn,d6 as zo,fN as ws,cE as Uo,bw as Kt,U as Xn,aW as Go,dy as qo,ep as ln,aK as Qn,cq as Ho,eo as Vo,eM as Wo,cW as ea,cX as Ht,cY as fs,dT as $o,fO as Ko,aA as Yo,fP as Zo,fQ as Jo,fj as Xo,e1 as Ve,db as Qo,dH as ta,A as sa,fb as yt,d_ as ei,aO as ti,ck as le,d8 as si,fR as ni,fS as ai,u as oi,cv as na,cV as aa,c6 as Yt,aM as ii,aN as ri,cl as ci,bl as Be,fc as li,fT as di,fU as ui,fV as mi,fW as fi,fX as oa,ad as hi,Z as dn,fY as gi,fZ as un,f_ as mn,f$ as pi,g0 as xi}from"./hwf9zvd1aw2q6bni.js";import{iU as yi,iV as he,iW as _i,iX as Ut,iY as Nt,iZ as vi,i_ as ia,aS as Si,a9 as ra,dL as bi,bD as ca,aD as la,eg as wi,gr as ki,ei as ks,i$ as Ci,cM as Zt,j as da,j0 as Ii,j1 as ua,G as Vt,b0 as Ti,ek as Ie,bK as Cs,j2 as Ae,u as Is,A as _t,cn as ji,cq as Mi,a$ as Ri,c4 as Ei,aN as Ai,cm as Ni,hJ as Pi,i1 as Di,j3 as Fi,hX as vt,j4 as ce,j5 as ma,j6 as hs,eh as Li,j7 as Oi,j8 as Bi,j9 as zi,ja as Ui,a_ as fa,jb as Gi,hE as ha,an as ga,jc as qi,eA as Hi,c5 as Jt,iP as Vi,dV as pa,ab as Wi,jd as $i,ia as Ki,je as xa,el as Xt,iT as St,jf as He,iK as tt,jg as as,jh as Yi,a5 as Zi,ji as fn,jj as ya,jk as Wt,jl as Ts,jm as js,jn as _a,jo as va,dQ as Sa,iM as ba,dO as wa,dP as ka,jp as Ji,jq as Xi,iq as Ms,jr as Qi,js as Ca,ir as Rs,jt as Es,ju as Pt,jv as er,jw as tr,jx as sr,iN as $t,J as Ia,jy as nr,jz as ar,jA as or,cz as ir,hq as rr,ho as Ta,hB as cr,hn as lr,jB as ja,jC as dr,cg as ur,ce as mr,jD as fr,jE as hr,jF as gr,em as pr,jG as xr,jH as yr,E as _r,e1 as Ma,jI as vr,jJ as hn,r as gs,hY as Sr,jK as br,aa as wr,U as gn,hZ as ot,h$ as pn,aw as Ra,jL as kr,jM as Cr,jN as Ir,jO as Tr,jP as jr,cK as Ea,dR as Mr,fW as Rr,fv as xn,jQ as Er,jR as Ar,jS as Nr,p as Pr,hd as ps,he as Dr,jT as Fr,fT as As,jU as Lr,cL as Or,ao as yn,jV as Br,am as A,jW as zr,jX as Ur,jY as Gr,hK as qr,jZ as Hr,gm as Vr,gU as Dt,j_ as os,j$ as Wr,gS as $r,gX as Kr,gY as Ns,k0 as Yr,k1 as Zr,C as Jr,k2 as pt,k3 as Xr,k4 as Qr,k5 as ec,k6 as tc,k7 as sc,k8 as Ps,gL as Aa,dS as nc,k9 as ac,ck as oc,ka as ic,kb as rc,l as cc,kc as lc,kd as dc,cr as uc,aq as Na,ke as mc,kf as fc,kg as hc,kh as gc,ki as _n,kj as pc}from"./gcq6nq5ilw3cni50.js";import{r as Ds,g as Ne,T as w,E as Pa,X as xc,b as Qt,e as Da,w as rt,u as ct,d as yc,c as Fa,l as _c,M as vc,j as Sc,Y as bc,Z as wc,A as kc,N as Cc,_ as Ic,i as La,$ as Tc}from"./iifiuc3nib6ssn9e.js";import{a4 as Oa,bu as jc,ad as Ba,bT as Mc,R as Rc,bd as Ec,bU as Ac,X as Fs,aB as Nc,bV as Pc,a2 as Dc,ag as Fc,g as Lc,z as Oc,a5 as Bc}from"./o9jymz7vdhi3lqx8.js";import{u as Ls,C as zc,a as Uc,D as Gc,E as qc}from"./d2enjwn8b6jly1r9.js";import{a as Hc}from"./2wm59teo35cqbdt1.js";import{m as be}from"./on5i6wiudhy03n19.js";import{u as Vc,P as Wc,I as $c}from"./mtj6k2f8ve73w700.js";import{u as za,t as Kc,i as Ua,f as Yc,h as Ga,T as Zc,M as Jc,a as Xc,j as Qc}from"./e2kkvbg1i6izzv9a.js";import{D as X}from"./g94gjpa24d3dgkvc.js";import{d as el,e as tl}from"./orl0zybyxtbw697s.js";import{G as sl}from"./lzjpn68pe1mv84wv.js";import{f as nl,k as al,u as ol,h as il}from"./hpsvd424sjrdhlcq.js";import{H as rl,o as cl,I as ll,J as dl,K as Ft,L as ul,O as ml,W as fl,m as es,q as qa,Q as hl}from"./mqj72pi2q2nphcdc.js";import{a as Os}from"./cqk6btirean3jhb2.js";import{i as Ha,a as gl,g as pl,b as xl,c as yl}from"./1tm7s25tu0rcb1ao.js";import{g as vn}from"./oj1bhdun86139hql.js";import{r as _l}from"./eoz02xxdbtlgnzui.js";var Va=_l();function vl(t){if(typeof t!="string")throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!t)throw new Error("No input");const e=JSON.parse(t),s=e;let n;if(s.type==="system")if(s.event==="connected")n=Object.assign(Object.assign({},e),{kind:"connected"});else if(s.event==="disconnected")n=Object.assign(Object.assign({},e),{kind:"disconnected"});else return null;else if(s.type==="message")if(s.from==="group"){const o=bn(e.data,e.dataType);if(o===null)return null;n=Object.assign(Object.assign({},e),{data:o,kind:"groupData"})}else if(s.from==="server"){const o=bn(e.data,e.dataType);if(o===null)return null;n=Object.assign(Object.assign({},e),{data:o,kind:"serverData"})}else return null;else if(s.type==="ack")n=Object.assign(Object.assign({},e),{kind:"ack"});else return null;return n}function Sl(t){let e;switch(t.kind){case"joinGroup":{e={type:"joinGroup",group:t.group,ackId:t.ackId};break}case"leaveGroup":{e={type:"leaveGroup",group:t.group,ackId:t.ackId};break}case"sendEvent":{e={type:"event",event:t.event,ackId:t.ackId,dataType:t.dataType,data:Sn(t.data,t.dataType)};break}case"sendToGroup":{e={type:"sendToGroup",group:t.group,ackId:t.ackId,dataType:t.dataType,data:Sn(t.data,t.dataType),noEcho:t.noEcho};break}case"sequenceAck":{e={type:"sequenceAck",sequenceId:t.sequenceId};break}default:throw new Error(`Unsupported type: ${t.kind}`)}return JSON.stringify(e)}function Sn(t,e){switch(e){case"text":{if(typeof t!="string")throw new TypeError("Message must be a string.");return t}case"json":return t;case"binary":case"protobuf":{if(t instanceof ArrayBuffer)return Va.Buffer.from(t).toString("base64");throw new TypeError("Message must be a ArrayBuffer")}}}function bn(t,e){if(e==="text"){if(typeof t!="string")throw new TypeError("Message must be a string when dataType is text");return t}else{if(e==="json")return t;if(e==="binary"||e==="protobuf"){const s=Va.Buffer.from(t,"base64");return s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength)}else return null}}class bl{constructor(){this.isReliableSubProtocol=!0,this.name="json.reliable.webpubsub.azure.v1"}parseMessages(e){return vl(e)}writeMessage(e){return Sl(e)}}const wl=()=>new bl;var xe;(function(t){t.Stopped="Stopped",t.Disconnected="Disconnected",t.Connecting="Connecting",t.Connected="Connected",t.Recovering="Recovering"})(xe||(xe={}));class kl{nextAckId(){return this._ackId=this._ackId+1,this._ackId}constructor(e,s){this._quickSequenceAckDiff=300,this._activeTimeoutInMs=2e4,this._emitter=new yi,this._isStopping=!1,this._isInitialConnected=!1,typeof e=="string"?this._credential={getClientAccessUrl:e}:this._credential=e,s==null&&(s={}),this._buildDefaultOptions(s),this._options=s,this._messageRetryPolicy=new wn(this._options.messageRetryOptions),this._reconnectRetryPolicy=new wn(this._options.reconnectRetryOptions),this._protocol=this._options.protocol,this._groupMap=new Map,this._ackMap=new Map,this._sequenceId=new Tl,this._state=xe.Stopped,this._ackId=0}async start(e){if(this._isStopping)throw new Error("Can't start a client during stopping");if(this._state!==xe.Stopped)throw new Error("Client can be only started when it's Stopped");let s;e&&(s=e.abortSignal),this._activeKeepaliveTask||(this._activeKeepaliveTask=this._getActiveKeepaliveTask());try{await this._startCore(s)}catch(n){throw this._changeState(xe.Stopped),this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0),this._isStopping=!1,n}}async _startFromRestarting(e){if(this._state!==xe.Disconnected)throw new Error("Client can be only restarted when it's Disconnected");try{he.verbose("Staring reconnecting."),await this._startCore(e)}catch(s){throw this._changeState(xe.Disconnected),s}}async _startCore(e){if(this._changeState(xe.Connecting),he.info("Staring a new connection"),this._sequenceId.reset(),this._isInitialConnected=!1,this._lastCloseEvent=void 0,this._lastDisconnectedMessage=void 0,this._connectionId=void 0,this._reconnectionToken=void 0,this._uri=void 0,typeof this._credential.getClientAccessUrl=="string"?this._uri=this._credential.getClientAccessUrl:this._uri=await this._credential.getClientAccessUrl({abortSignal:e}),typeof this._uri!="string")throw new Error(`The clientAccessUrl must be a string but currently it's ${typeof this._uri}`);await this._connectCore(this._uri)}stop(){this._state===xe.Stopped||this._isStopping||(this._isStopping=!0,this._wsClient&&this._wsClient.isOpen()?this._wsClient.close():this._isStopping=!1,this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0))}on(e,s){this._emitter.on(e,s)}off(e,s){this._emitter.removeListener(e,s)}_emitEvent(e,s){this._emitter.emit(e,s)}async sendEvent(e,s,n,o){return await this._operationExecuteWithRetry(()=>this._sendEventAttempt(e,s,n,o),o==null?void 0:o.abortSignal)}async _sendEventAttempt(e,s,n,o){var i;if(!((i=o==null?void 0:o.fireAndForget)!==null&&i!==void 0?i:!1))return await this._sendMessageWithAckId(c=>({kind:"sendEvent",dataType:n,data:s,ackId:c,event:e}),o==null?void 0:o.ackId,o==null?void 0:o.abortSignal);const l={kind:"sendEvent",dataType:n,data:s,event:e};return await this._sendMessage(l,o==null?void 0:o.abortSignal),{isDuplicated:!1}}async joinGroup(e,s){return await this._operationExecuteWithRetry(()=>this._joinGroupAttempt(e,s),s==null?void 0:s.abortSignal)}async _joinGroupAttempt(e,s){const n=this._getOrAddGroup(e),o=await this._joinGroupCore(e,s);return n.isJoined=!0,o}async _joinGroupCore(e,s){return await this._sendMessageWithAckId(n=>({group:e,ackId:n,kind:"joinGroup"}),s==null?void 0:s.ackId,s==null?void 0:s.abortSignal)}async leaveGroup(e,s){return await this._operationExecuteWithRetry(()=>this._leaveGroupAttempt(e,s),s==null?void 0:s.abortSignal)}async _leaveGroupAttempt(e,s){const n=this._getOrAddGroup(e),o=await this._sendMessageWithAckId(i=>({group:e,ackId:i,kind:"leaveGroup"}),s==null?void 0:s.ackId,s==null?void 0:s.abortSignal);return n.isJoined=!1,o}async sendToGroup(e,s,n,o){return await this._operationExecuteWithRetry(()=>this._sendToGroupAttempt(e,s,n,o),o==null?void 0:o.abortSignal)}async _sendToGroupAttempt(e,s,n,o){var i,r;const l=(i=o==null?void 0:o.fireAndForget)!==null&&i!==void 0?i:!1,c=(r=o==null?void 0:o.noEcho)!==null&&r!==void 0?r:!1;if(!l)return await this._sendMessageWithAckId(f=>({kind:"sendToGroup",group:e,dataType:n,data:s,ackId:f,noEcho:c}),o==null?void 0:o.ackId,o==null?void 0:o.abortSignal);const u={kind:"sendToGroup",group:e,dataType:n,data:s,noEcho:c};return await this._sendMessage(u,o==null?void 0:o.abortSignal),{isDuplicated:!1}}_getWebSocketClientFactory(){return new _i}async _trySendSequenceAck(){if(!this._protocol.isReliableSubProtocol)return;const[e,s]=this._sequenceId.tryGetSequenceId();if(e&&s){const n={kind:"sequenceAck",sequenceId:s};try{await this._sendMessage(n)}catch{this._sequenceId.tryUpdate(s)}}}_connectCore(e){if(this._isStopping)throw new Error("Can't start a client during stopping");return new Promise((s,n)=>{const o=this._wsClient=this._getWebSocketClientFactory().create(e,this._protocol.name);o.onopen(()=>{if(this._isStopping){try{o.close()}catch{}n(new Error("The client is stopped"))}he.verbose("WebSocket connection has opened"),this._changeState(xe.Connected),this._protocol.isReliableSubProtocol&&(this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),this._sequenceAckTask=new kn(async()=>{await this._trySendSequenceAck()},1e3)),s()}),o.onerror(i=>{this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),n(i)}),o.onclose((i,r)=>{this._state===xe.Connected?(he.verbose("WebSocket closed after open"),this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),he.info(`WebSocket connection closed. Code: ${i}, Reason: ${r}`),this._lastCloseEvent={code:i,reason:r},this._handleConnectionClose.call(this)):(he.verbose("WebSocket closed before open"),n(new Error(`Failed to start WebSocket: ${i}`)))}),o.onmessage(i=>{const r=m=>{if(this._ackMap.has(m.ackId)){const v=this._ackMap.get(m.ackId);this._ackMap.delete(m.ackId);const y=m.error!=null&&m.error.name==="Duplicate";m.success||y?v.resolve({ackId:m.ackId,isDuplicated:y}):v.reject(new Nt("Failed to send message.",{ackId:m.ackId,errorDetail:m.error}))}},l=async m=>{if(this._connectionId=m.connectionId,this._reconnectionToken=m.reconnectionToken,!this._isInitialConnected){if(this._isInitialConnected=!0,this._options.autoRejoinGroups){const v=[];this._groupMap.forEach(y=>{y.isJoined&&v.push((async()=>{try{await this._joinGroupCore(y.name)}catch(h){this._safeEmitRejoinGroupFailed(y.name,h)}})())});try{await Promise.all(v)}catch{}}this._safeEmitConnected(m.connectionId,m.userId)}},c=m=>{this._lastDisconnectedMessage=m},u=m=>{if(m.sequenceId!=null){const v=this._sequenceId.tryUpdate(m.sequenceId);if(v===0)return;v>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitGroupMessage(m)},f=m=>{if(m.sequenceId!=null){const v=this._sequenceId.tryUpdate(m.sequenceId);if(v===0)return;v>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitServerMessage(m)};let g;try{let m;if(Array.isArray(i)?m=Buffer.concat(i):m=i,g=this._protocol.parseMessages(m),g===null)return}catch(m){throw he.warning("An error occurred while parsing the message from service",m),m}Array.isArray(g)||(g=[g]),g.forEach(m=>{try{switch(m.kind){case"ack":{r(m);break}case"connected":{l(m);break}case"disconnected":{c(m);break}case"groupData":{u(m);break}case"serverData":{f(m);break}}}catch(v){he.warning(`An error occurred while handling the message with kind: ${m.kind} from service`,v)}})})})}async _handleConnectionCloseAndNoRecovery(){this._state=xe.Disconnected,this._safeEmitDisconnected(this._connectionId,this._lastDisconnectedMessage),this._options.autoReconnect?await this._autoReconnect():await this._handleConnectionStopped()}async _autoReconnect(){let e=!1,s=0;try{for(;!this._isStopping;)try{await this._startFromRestarting(),e=!0;break}catch(n){he.warning("An attempt to reconnect connection failed.",n),s++;const o=this._reconnectRetryPolicy.nextRetryDelayInMs(s);if(o==null)break;try{he.verbose(`Delay time for reconnect attempt ${s}: ${o}`),await Ut(o)}catch{}}}finally{e||this._handleConnectionStopped()}}_handleConnectionStopped(){this._isStopping=!1,this._state=xe.Stopped,this._safeEmitStopped()}_getActiveKeepaliveTask(){return new kn(async()=>{this._sequenceId.tryUpdate(0)},this._activeTimeoutInMs)}async _sendMessage(e,s){if(!this._wsClient||!this._wsClient.isOpen())throw new Error("The connection is not connected.");const n=this._protocol.writeMessage(e);await this._wsClient.send(n,s)}async _sendMessageWithAckId(e,s,n){s==null&&(s=this.nextAckId());const o=e(s);this._ackMap.has(s)||this._ackMap.set(s,new Il(s));const i=this._ackMap.get(s);try{await this._sendMessage(o,n)}catch(r){this._ackMap.delete(s);let l="";throw r instanceof Error&&(l=r.message),new Nt(l,{ackId:s})}if(n)try{return await vi(i.promise(),n)}catch(r){throw r instanceof Error&&r.name==="AbortError"?new Nt("Cancelled by abortSignal",{ackId:s}):r}return await i.promise()}async _handleConnectionClose(){if(this._ackMap.forEach((o,i)=>{this._ackMap.delete(i)&&o.reject(new Nt("Connection is disconnected before receive ack from the service",{ackId:o.ackId}))}),this._isStopping){he.warning("The client is stopping state. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(this._lastCloseEvent&&this._lastCloseEvent.code===1008){he.warning("The websocket close with status code 1008. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(!this._protocol.isReliableSubProtocol){he.warning("The protocol is not reliable, recovery is not applicable"),this._handleConnectionCloseAndNoRecovery();return}const e=this._buildRecoveryUri();if(!e){he.warning("Connection id or reconnection token is not available"),this._handleConnectionCloseAndNoRecovery();return}let s=!1;this._state=xe.Recovering;const n=ia.timeout(30*1e3);try{for(;!n.aborted||this._isStopping;)try{await this._connectCore.call(this,e),s=!0;return}catch{await Ut(1e3)}}finally{s||(he.warning("Recovery attempts failed more then 30 seconds or the client is stopping"),this._handleConnectionCloseAndNoRecovery())}}_safeEmitConnected(e,s){this._emitEvent("connected",{connectionId:e,userId:s})}_safeEmitDisconnected(e,s){this._emitEvent("disconnected",{connectionId:e,message:s})}_safeEmitGroupMessage(e){this._emitEvent("group-message",{message:e})}_safeEmitServerMessage(e){this._emitEvent("server-message",{message:e})}_safeEmitStopped(){this._emitEvent("stopped",{})}_safeEmitRejoinGroupFailed(e,s){this._emitEvent("rejoin-group-failed",{group:e,error:s})}_buildDefaultOptions(e){return e.autoReconnect==null&&(e.autoReconnect=!0),e.autoRejoinGroups==null&&(e.autoRejoinGroups=!0),e.protocol==null&&(e.protocol=wl()),this._buildMessageRetryOptions(e),this._buildReconnectRetryOptions(e),e}_buildMessageRetryOptions(e){e.messageRetryOptions||(e.messageRetryOptions={}),(e.messageRetryOptions.maxRetries==null||e.messageRetryOptions.maxRetries<0)&&(e.messageRetryOptions.maxRetries=3),(e.messageRetryOptions.retryDelayInMs==null||e.messageRetryOptions.retryDelayInMs<0)&&(e.messageRetryOptions.retryDelayInMs=1e3),(e.messageRetryOptions.maxRetryDelayInMs==null||e.messageRetryOptions.maxRetryDelayInMs<0)&&(e.messageRetryOptions.maxRetryDelayInMs=3e4),e.messageRetryOptions.mode==null&&(e.messageRetryOptions.mode="Fixed")}_buildReconnectRetryOptions(e){e.reconnectRetryOptions||(e.reconnectRetryOptions={}),(e.reconnectRetryOptions.maxRetries==null||e.reconnectRetryOptions.maxRetries<0)&&(e.reconnectRetryOptions.maxRetries=Number.MAX_VALUE),(e.reconnectRetryOptions.retryDelayInMs==null||e.reconnectRetryOptions.retryDelayInMs<0)&&(e.reconnectRetryOptions.retryDelayInMs=1e3),(e.reconnectRetryOptions.maxRetryDelayInMs==null||e.reconnectRetryOptions.maxRetryDelayInMs<0)&&(e.reconnectRetryOptions.maxRetryDelayInMs=3e4),e.reconnectRetryOptions.mode==null&&(e.reconnectRetryOptions.mode="Fixed")}_buildRecoveryUri(){if(this._connectionId&&this._reconnectionToken&&this._uri){const e=new URL(this._uri);return e.searchParams.append("awps_connection_id",this._connectionId),e.searchParams.append("awps_reconnection_token",this._reconnectionToken),e.toString()}return null}_getOrAddGroup(e){return this._groupMap.has(e)||this._groupMap.set(e,new Cl(e)),this._groupMap.get(e)}_changeState(e){he.verbose(`The client state transfer from ${this._state.toString()} to ${e.toString()}`),this._state=e}async _operationExecuteWithRetry(e,s){let n=0;for(;;)try{return await e.call(this)}catch(o){n++;const i=this._messageRetryPolicy.nextRetryDelayInMs(n);if(i==null||(await Ut(i),s!=null&&s.aborted))throw o}}}class wn{constructor(e){this._retryOptions=e,this._maxRetriesToGetMaxDelay=Math.ceil(Math.log2(this._retryOptions.maxRetryDelayInMs)-Math.log2(this._retryOptions.retryDelayInMs)+1)}nextRetryDelayInMs(e){return e>this._retryOptions.maxRetries?null:this._retryOptions.mode==="Fixed"?this._retryOptions.retryDelayInMs:this._calculateExponentialDelay(e)}_calculateExponentialDelay(e){return e>=this._maxRetriesToGetMaxDelay?this._retryOptions.maxRetryDelayInMs:(1<<e-1)*this._retryOptions.retryDelayInMs}}class Cl{constructor(e){this.isJoined=!1,this.name=e}}class Il{constructor(e){this._promise=new Promise((s,n)=>{this._resolve=s,this._reject=n}),this.ackId=e}promise(){return this._promise}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}class Tl{constructor(){this._sequenceId=0,this._isUpdate=!1}tryUpdate(e){if(this._isUpdate=!0,e>this._sequenceId){const s=e-this._sequenceId;return this._sequenceId=e,s}return 0}tryGetSequenceId(){return this._isUpdate?(this._isUpdate=!1,[!0,this._sequenceId]):[!1,null]}reset(){this._sequenceId=0,this._isUpdate=!1}}class kn{constructor(e,s,n){this._func=e,this._abortController=new ia,this._interval=s,this._obj=n,this._start()}abort(){try{this._abortController.abort()}catch{}}async _start(){const e=this._abortController.signal;for(;!e.aborted;)try{await this._func(this._obj)}catch{}finally{await Ut(this._interval)}}}const jl=1e3*60*60,Ml=1e3*30;class Rl{constructor(e,s,n,o=null,i=new Map){L(this,"client");L(this,"handler");L(this,"terminationTimeout",null);L(this,"connectionUrl");L(this,"expiresAt");L(this,"connected",!1);L(this,"websocketRequestId",null);L(this,"conversationId",null);L(this,"secondaryTypeBasedHandlers",new Map);this.connectionUrl=s,this.expiresAt=n,this.client=new kl({getClientAccessUrl:()=>e(this.connectionUrl,this.expiresAt)},{autoReconnect:!0,reconnectRetryOptions:{maxRetries:5,retryDelayInMs:100,maxRetryDelayInMs:1e4,mode:"Exponential"}}),this.handler=o,this.secondaryTypeBasedHandlers=i}async start(){const e=s=>{if(this.secondaryTypeBasedHandlers.has(s.message.data.type)){const n=this.secondaryTypeBasedHandlers.get(s.message.data.type);if(!n)return;n(s.message.data)}else{const n=s.message.data.body,o=atob(n).trim();if(o.startsWith("data: ")){const i=o.replace("data: ",""),r=this.handler;if(!r)return;r({conversationId:s.message.data.conversation_id,responseId:s.message.data.response_id,message:{id:"",event:"",data:i},websocketRequestId:s.message.data.websocket_request_id})}}};this.client.on("group-message",s=>e(s)),this.client.on("server-message",s=>e(s)),this.client.on("connected",()=>{this.connected=!0}),this.client.on("disconnected",()=>{this.connected=!1}),await this.client.start()}addSecondaryTypeHandler(e,s){this.secondaryTypeBasedHandlers.set(e,s)}isConnected(){return this.connected}async stop(e){e&&this.conversationId!==e||this.websocketRequestId&&await We.stopWebsocketConversation(this.websocketRequestId)}setHandler(e,s,n,o){!this.handler&&this.websocketRequestId===n||(this.handler!=null&&this.websocketRequestId!==n&&(jo.warn("[websockets] Overwriting existing handler without silencing. This may indicate a race condition."),D.logEvent(N.asyncHandlerOverwritten,{originalWebsocketRequestId:this.websocketRequestId,newWebsocketRequestId:n,conversationId:e,responseId:s})),this.websocketRequestId=n,this.conversationId=e,this.handler=i=>{(i.websocketRequestId===n||i.conversationId===e&&i.responseId===s)&&o(i.message)})}silence(){this.handler=null}close(){this.client.stop()}scheduleForTermination(e){this.terminationTimeout=setTimeout(()=>{this.close(),e()},jl)}preventTermination(){this.terminationTimeout&&(clearTimeout(this.terminationTimeout),this.terminationTimeout=null)}updateConnectionUrl(e,s){this.connectionUrl=e,this.expiresAt=s}}class El{constructor(){L(this,"activeSocketMap",new Map);L(this,"secondaryTypeBasedHandlers",new Map)}async register(){const e=await We.postRegisterWebsocket();e.wss_url&&(this.getOrCreateSocket(e.wss_url,new Date(e.expires_at),!0),e.fallback_wss_url&&this.getOrCreateSocket(e.fallback_wss_url,new Date(e.expires_at),!1))}async registerIfNotConnected(){if(this.activeSocketMap.size===0){await this.register();return}for(const e of this.activeSocketMap.values())if(!e.isConnected()){await this.register();return}}isWebsocketConnected(){for(const e of this.activeSocketMap.values())if(e.isConnected())return!0;return this.activeSocketMap.size>0&&je.addError("Cannot connect to any websocket."),!1}async getOrCreateSocket(e,s,n){const o=e.split("?")[0];let i;const r=this.activeSocketMap.get(o);if(r&&r.isConnected())r.preventTermination(),r.updateConnectionUrl(e,s),i=r;else{r&&r.close(),i=new Rl(async(l,c)=>{if(new Date<new Date(c.getTime()-5*1e3))return l;const u=await We.postRegisterWebsocket();return n?u.wss_url:u.fallback_wss_url??""},e,s,null,this.secondaryTypeBasedHandlers),this.activeSocketMap.set(o,i);try{await i.start()}catch(l){throw je.addError(new Error("Error occurred while starting websocket: ",{cause:l})),l}}return i}preSetupWebsocket(e,s,n){for(const o of this.activeSocketMap.values())this.setupWebSocketHandler(o,null,null,null,e,s,n)}addSecondaryTypeHandler(e,s){this.secondaryTypeBasedHandlers.set(e,s);for(const n of this.activeSocketMap.values())n.addSecondaryTypeHandler(e,s)}hasSecondaryTypeHandler(e){return this.secondaryTypeBasedHandlers.has(e)}async processWebSocketConversationStream(e,s,n,o,i,r,l,c,u){const f=[this.getOrCreateSocket(e,n,!0)];s&&f.push(this.getOrCreateSocket(s,n,!1));const g=await Promise.allSettled(f),m=g[0].status==="fulfilled"?g[0].value:null,v=g.length>1&&g[1].status==="fulfilled"?g[1].value:null;if((!m||!m.isConnected())&&je.addError(`Cannot connect to primary websocket, websocketRequestId: ${r}, token: ${e.substring(0,e.indexOf("access_token="))}`),(!m||!m.isConnected())&&(!v||!v.isConnected()))throw s&&je.addError(`Cannot connect to fallback websocket, websocketRequestId: ${r}, token: ${s.substring(0,s.indexOf("access_token="))}`),new qe(`An error occurred while connecting to the websocket. ${ds}`);let y=setTimeout(()=>{je.addError(`WebSocket took too long to respond: ${i}, ${o}, ${r}, ${e.substring(0,60)}...${e.slice(-20)}`,{supportsWebSockets:"WebSocket"in window&&window.WebSocket.CLOSING===2})},Ml);const h=T=>(u&&(clearTimeout(u),u=null),y&&(clearTimeout(y),y=null),l(T));m&&this.setupWebSocketHandler(m,e,o,i,r,h,c),v&&s&&this.setupWebSocketHandler(v,s,o,i,r,h,c)}async stopConversation(e){for(const s of this.activeSocketMap.values())await s.stop(e)}setupWebSocketHandler(e,s,n,o,i,r,l){e.setHandler(n,o,i,r),this.secondaryTypeBasedHandlers.forEach((u,f)=>{e.addSecondaryTypeHandler(f,u)});const c=()=>{s?e.scheduleForTermination(()=>{this.activeSocketMap.delete(s.split("?")[0])}):(this.stopConversation(n),e.silence())};l.addEventListener("abort",c)}}const kt=new El;function Al(t){return{webSocketUrl:t.wss_url,fallbackWebSocketUrl:t.fallback_wss_url,conversationId:t.conversation_id,responseId:t.response_id,expiresAt:t.expires_at&&new Date(t.expires_at),websocketRequestId:t.websocket_request_id}}async function Nl(t,e,s){return kt.preSetupWebsocket(t,e,s)}async function Pl(t,e,s,n,o,i,r,l,c){return kt.processWebSocketConversationStream(t,e,s,n,o,i,r,l,c)}function Dl(t){return t==null||[ve.PrimaryAssistant,ve.GizmoInteraction].includes(t.kind)}function Bs(t,e){const s=Ds(t,e),{data:n}=Ls(s!=null&&"gizmo_id"in s?s.gizmo_id:void 0,(s==null?void 0:s.kind)===ve.GizmoTest);if(s!=null)switch(s.kind){case ve.GizmoInteraction:case ve.GizmoMagicCreate:case ve.GizmoTest:return{gizmo:n,...s};case ve.PrimaryAssistant:return s}}function Fl(t,e,s){const o=w.getTree(e).getMessageId(w.getThreadCurrentLeafId(e));We.generateTitle(e,o,s).then(({title:i})=>{w.setTitle(e,i,Pa.Generated),ra(t),D.logEvent(N.renameThread,{threadId:e,content:i,model:s})}).catch(je.addError)}function Ll(t,e,s){const n=()=>{const i=vn(s);t(i)},o=Ne.getGizmoId(s);o!=null?zc(e,o).then(i=>{Si(vn(s,i))}).catch(i=>{je.addError(i),n()}):n()}const xs={onCreate(t,e,s,n){D.logEvent(N.newThread),!n&&Dl(Ne.getConversationMode(e))&&Gn(s).then(o=>{qn(o)||(ra(s),Ll(t,s,e))})},onCreateFinished(t,e,s){var n;if(!(s||!e)&&!ze.checkGate("2562876640")){const o=(n=Ne.getThread(e))==null?void 0:n.initialThreadData.lastModelUsed;o==null&&je.addError("missing lastModelUsed on conversation create finished"),Fl(t,e,o)}}},Cn=Me.div`m-8 flex flex-col items-center`;function In(t){return a.jsx(be.div,{initial:{opacity:0,translateY:20},animate:{opacity:1,translateY:0,transition:{duration:.5,ease:"easeIn"}},...t})}function Ol({clientThreadId:t}){const e=xc(t),s=e==null?void 0:e.gizmoId,{data:n}=Ls(s);return s==null||n==null||!bi(n)?null:a.jsx(Bl,{gizmoId:s})}function Bl({gizmoId:t}){const[e,s]=d.useState(!1),[n,o]=d.useState(!1),i=Uc(t),r=async c=>{s(!0),setTimeout(()=>{o(!0)},5e3),D.logEvent(N.submitInlineRating,{gizmo_id:t,rating:c}),await i.mutateAsync({rating:c})},l=async()=>{o(!0),D.logEvent(N.dismissInlineRating,{gizmo_id:t}),await i.mutateAsync({})};return d.useEffect(()=>{n||D.logEvent(N.showInlineRating,{gizmo_id:t})},[n,t]),n?null:e?a.jsx(Cn,{children:a.jsxs(In,{className:"flex flex-col items-center gap-4",children:[a.jsx("div",{className:"rounded-lg border border-token-border-heavy p-4",children:a.jsxs("div",{className:"flex justify-between gap-2",children:[a.jsx(O,{id:"gizmo.inlineReview.reviewLeft",defaultMessage:"Feedback sent"}),a.jsx(rn,{onClick:()=>{o(!0)}})]})}),a.jsx("div",{className:"text-xs text-token-text-tertiary",children:a.jsx(O,{id:"gizmo.inlineReview.reviewLeftSubtext",defaultMessage:'To update your rating, click "Send Feedback" in the GPT Menu'})})]})}):a.jsx(Cn,{children:a.jsxs(In,{className:"flex flex-col items-center gap-4 rounded-lg border border-token-border-heavy p-4",children:[a.jsxs("div",{className:"flex justify-between gap-2",children:[a.jsx(O,{id:"gizmo.inlineReview.prompt",defaultMessage:"How would you rate this GPT so far?"}),a.jsx(rn,{onClick:l})]}),a.jsx(Hc,{rating:void 0,onRating:r})]})})}function zl(t,e){const s=ca(la.MentionGPTs),n=wi(),[o,i]=d.useState(!1),r=()=>{i(!0),s.markAsViewed()};return d.useImperativeHandle(e,()=>({handleClose:r})),s.eligible&&!s.isLoading&&!n?a.jsx(Ul,{wasDismissed:o,onDismiss:r}):null}function Ul({wasDismissed:t,onDismiss:e}){const s=oe(),{recent:n,pinned:o}=Vc(),i=n&&n.pages.flatMap(r=>r.list.items).length>0||o&&o.items.length>0;return d.useEffect(()=>{i&&D.logEvent(N.mentionsDisplayNux)},[i]),i?a.jsx(ki,{badge:"beta",align:"start",side:"top",arrowPadding:58,show:!t,title:s.formatMessage({id:"mentionGptsAnnouncement.title",defaultMessage:"GPT mentions"}),onDismiss:e,sideOffset:25,theme:"default",description:a.jsx(O,{id:"mentionGptsAnnouncement.description",defaultMessage:"Type {key} to mention a GPT and add it directly into your conversation",values:{key:a.jsx("span",{className:"font-bold",children:"@"})}}),children:a.jsx("div",{className:"absolute sm:left-16"})}):null}const Gl=d.forwardRef(zl);function ql({suggestions:t,composerController:e,onSelect:s,onChange:n}){const o=za(),i=d.useCallback((c,u,f)=>{s==null||s(c,u,f),o(c,u,f)},[s,o]),[r,l]=d.useState(-1);return d.useEffect(()=>{const c=u=>{if(u.key==="ArrowDown"){const f=r===t.length-1?0:r+1;l(f),n==null||n(f,!0,t[f])}else if(u.key==="ArrowUp"){u.preventDefault();const f=r===0?t.length-1:r-1;l(f),n==null||n(f,!0,t[f])}else u.key==="Enter"&&t[r]&&i(t[r],t,r)};return e.subscribe("keydown",c)},[t,r,n,i,e]),d.useEffect(()=>e.subscribe("blur",()=>{l(-1),n==null||n(-1,!1)}),[e,n]),a.jsx(be.ul,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"hidden w-full flex-col p-2.5 group-focus-within:block",children:t.map((c,u)=>a.jsxs(be.li,{initial:{opacity:0,translateY:4},animate:{opacity:1,translateY:0},transition:{delay:u*.03},exit:{opacity:0,translateY:4},className:"w-full",children:[u>0&&a.jsx("div",{className:$("h-[1px] opacity-60",r===u||r===u-1?"mx-2 bg-token-main-surface-secondary":"bg-token-border-light")}),a.jsxs("button",{className:$("inline w-full cursor-pointer items-center justify-start rounded-lg px-2.5 py-3 text-start",r===u?"bg-token-main-surface-secondary":"bg-token-main-surface-primary"),onClick:f=>{f.preventDefault(),i(c,t,u)},onMouseEnter:()=>{l(u),n==null||n(u,!1,c)},onMouseLeave:()=>{l(-1),n==null||n(-1,!1,c)},children:[a.jsx("span",{className:"text-token-text-tertiary",children:c.title}),a.jsx("span",{className:"text-token-text-primary",children:c.body})]})]},c.id??u))})}function Hl({composerController:t}){const{doesUserHaveAnyAccountsWithPlusFeatures:e}=Mo(),s=oe(),n=ks();return a.jsxs("div",{className:$("flex justify-between",!n&&"bg-gradient-to-t from-token-main-surface-primary to-transparent px-4"),children:[a.jsx("div",{className:"flex gap-2",children:a.jsx(Wl,{onClickStyle:o=>{jn(s.formatMessage(o.expandedName??o.name),t)}})}),e&&a.jsx("div",{className:"flex gap-2",children:a.jsx(Vl,{onClickAspectRatio:o=>jn(s.formatMessage(o.expandedName),t)})})]})}function Vl({onClickAspectRatio:t}){const e=oe();return a.jsxs(X.Root,{onOpenChange:s=>{s&&(ze.logEvent(N.dalleOpenAspectRatioDropdown),D.logEvent(N.dalleOpenAspectRatioDropdown))},children:[a.jsxs(ys,{$as:X.Trigger,className:"pr-1.5",children:[a.jsx(O,{id:"dalleControls.aspectRatio",defaultMessage:"Aspect Ratio"}),a.jsx(Oa,{className:"icon-md"})]}),a.jsx(X.Portal,{children:a.jsx(X.Content,{children:Ci.map(s=>a.jsx(X.Item,{onClick:()=>{var n;t(s),ze.logEvent(N.dalleClickAspectRatio,(n=s.name.defaultMessage)==null?void 0:n.toString()),D.logEvent(N.dalleClickAspectRatio,{aspectRatio:s.name.defaultMessage})},icon:s.icon,children:e.formatMessage(s.name)},s.name.id))})})]})}function Wl({onClickStyle:t}){const[e,s]=d.useState(Tn()),n=Ro(),o=Eo(),i=Zt(),r=oe();let l=2;return i||(o?l=5:n&&(l=3)),a.jsxs(a.Fragment,{children:[e.slice(0,l).map(c=>a.jsx(da,{label:a.jsx($l,{style:c}),side:"top",sideOffset:4,customPaddingClassName:"p-1",children:a.jsxs(ys,{$as:"button",type:"button",onClick:()=>{var u;t(c),ze.logEvent(N.dalleClickStyle,(u=c.name.defaultMessage)==null?void 0:u.toString()),D.logEvent(N.dalleClickStyle,{style:c.name.defaultMessage})},children:[a.jsx(jc,{className:"h-4 w-4 text-token-text-tertiary"}),r.formatMessage(c.name)]})},c.name.id)),a.jsx(ys,{$as:"button",type:"button",onClick:()=>{s(Tn()),ze.logEvent(N.dalleShuffleStyles),D.logEvent(N.dalleShuffleStyles)},children:a.jsx(Ii,{className:"icon-sm text-token-text-tertiary"})}),ua.map(c=>a.jsx("img",{src:c.image.src,alt:r.formatMessage(c.name),width:100,height:100,className:"invisible fixed -left-96 -top-96"},c.name.id))]})}function $l({style:t}){const e=oe();return a.jsxs("div",{className:"flex flex-col gap-1",children:[a.jsx("img",{src:t.image.src,alt:e.formatMessage(t.name),width:100,height:100,className:"rounded-md"}),a.jsx("div",{className:"text-xs font-medium",children:e.formatMessage(t.name)})]})}function Tn(){return[...ua].sort(()=>Math.random()-.5)}function Kl(t,e){const s=e.getCurrentText();return s.trim()===""?t:s.endsWith(",")?` ${t.toLocaleLowerCase()}`:s.endsWith(", ")?t.toLocaleLowerCase():`, ${t.toLocaleLowerCase()}`}function jn(t,e){const s=Kl(t,e);e.appendText(s),Vt()}const ys=Me.div`h-7 bg-token-main-surface-primary border border-token-border-light text-xs hover:bg-token-main-surface-secondary hover:text-token-text-primary px-2.5 radix-state-open:bg-token-main-surface-secondary radix-state-open:text-token-text-primary rounded-full flex flex-nowrap gap-0.5 items-center text-token-text-secondary font-normal`,Lt={initial:{opacity:0,y:20,scale:.9},animate:{opacity:1,y:0,scale:1},transition:{delay:.1},exit:{opacity:0,scale:.5,transition:{duration:.2}}},Yl=({suggestions:t,onSelectingSuggestedReply:e})=>a.jsx("div",{className:"absolute bottom-full flex w-full max-w-[100vw] grow gap-2 overflow-auto px-1 pb-1 contain-inline-size sm:mb-0 sm:justify-start sm:px-2 sm:pb-0 md:static md:mb-2 md:max-w-none md:justify-center md:overflow-visible",children:t.slice(0,2).map((s,n)=>a.jsx(be.div,{initial:Lt.initial,animate:Lt.animate,transition:{delay:(n-1)*Lt.transition.delay},exit:Lt.exit,children:a.jsx(wt,{as:"button",color:"secondary",size:"small",onClick:()=>{e(s,t,n)},className:"group whitespace-nowrap md:whitespace-normal",children:a.jsx(Jl,{suggestion:s})},n)},n))});function Zl({suggestions:t,onSelectingSuggestedReply:e,clientThreadId:s}){const n=(t==null?void 0:t.length)>0;d.useEffect(()=>{n&&Kc(t,s)},[n,s]);const{isUnauthenticated:o}=bt();return n?t.every(Ua)?a.jsxs(be.div,{initial:{opacity:0},animate:{opacity:1},transition:{duration:.3},className:"flex flex-col items-center",children:[o&&a.jsx(Ti,{className:"mb-6 h-12 w-12 sm:hidden"}),a.jsx(Yc,{starterPrompts:t,onSelectStarterPrompt:e})]}):t.every(Ga)?a.jsx(Yl,{suggestions:t,onSelectingSuggestedReply:e}):null:null}function Jl({suggestion:t}){return Ga(t)?a.jsx(a.Fragment,{children:t.text}):Ua(t)?a.jsxs("div",{className:"flex flex-col overflow-hidden",children:[t.title&&a.jsx("div",{className:"truncate font-semibold",children:t.title}),a.jsx("div",{className:$("truncate font-normal",t.title?"opacity-50":""),children:t.body})]}):null}function Xl(){const{store:t}=Ie(),e=t.useSharedProps();return e?a.jsx(Ql,{...e}):null}function Ql({clientThreadId:t,suggestions:e}){const s=za();return e===void 0||e.length===0?null:a.jsx("div",{children:a.jsx(ed,{children:a.jsx("div",{className:"grow",children:e!==void 0&&a.jsx(Zl,{suggestions:e,onSelectingSuggestedReply:s,clientThreadId:t})})})})}const ed=Me.div`h-full flex ml-1 md:w-full md:m-auto gap-0 md:gap-2 justify-center`,Wa=({className:t,children:e})=>a.jsx(be.div,{className:t,initial:{opacity:0},animate:{opacity:1},exit:{opacity:0,transition:{duration:.1,delay:0}},transition:{type:"tween",duration:.3,delay:.2},children:e});function td({currentLeafId:t,canContinue:e,onContinueGenerating:s}){const n=d.useCallback(()=>{const i=new Cs;s(t,i),Vt()},[s,t]);let o=null;return e&&(o=a.jsx(sd,{onHandleContinueGenerating:n})),o&&a.jsx("div",{className:"flex h-full w-full items-center justify-end gap-0 py-4 md:gap-2",children:o})}const sd=({onHandleContinueGenerating:t})=>{const e=Hn();return a.jsx(Wa,{children:a.jsxs(wt,{as:"button",color:"secondary",onClick:t,className:"whitespace-nowrap border-0 md:border",children:[a.jsx(Ba,{className:$("-rotate-180",e?"icon-xs":"icon-sm")}),e&&a.jsx(O,{...Ae.continueGenerating})]})})},nd=({clientThreadId:t})=>{const e=Vn(),s=Qt(t),n=Is(s);d.useEffect(()=>{n&&us.dismissBanner()},[n]);const o=e!=null&&e.is_dismissible?()=>us.dismissBanner():void 0;return a.jsx(_t,{children:e&&a.jsx(be.div,{transition:{type:"tween",ease:"easeInOut",duration:.1},initial:{opacity:0,transform:"translateY(8px)"},animate:{opacity:1,transform:"translateY(0px)"},exit:{opacity:0,transform:"translateY(8px)"},children:a.jsx(Wc,{clientThreadId:t,rateLimitInfo:e,onDismiss:o})})})};function ad(t){const e=Qt(t),s=Is(e),n=Vn();return!s&&n!=null}const Oe=window.sessionStorage,_s=Wn(Ao(()=>({memoryFullBannerDismissed:!!(Oe!=null&&Oe.getItem(xt.MemoryFullBannerDismissed))}))),$a={dismissBanner(){_s.setState(t=>{t.memoryFullBannerDismissed=!0}),Oe==null||Oe.setItem(xt.MemoryFullBannerDismissed,"true")},clearDismissedBanner(){_s.setState(t=>{t.memoryFullBannerDismissed=!1}),Oe==null||Oe.removeItem(xt.MemoryFullBannerDismissed)}};function od(t){const e=Da(t),s=ji(),{data:n}=Mi(e,!1,s),o=n!=null,i=o&&n.memoryFullPct>=100,[r,l]=d.useState(!1);d.useEffect(()=>{!i&&o&&(l(!0),$a.clearDismissedBanner())},[i,o]);const c=_s(u=>u.memoryFullBannerDismissed);return i&&r&&!c}function id(){const t=oe(),{openSettings:e}=Ri();return a.jsx(be.div,{initial:{opacity:0},animate:{opacity:1},children:a.jsx(Ei,{title:t.formatMessage(Ot.memoryFullTitle),content:t.formatMessage(Ot.memoryFullTooltip,Ot.memoryFullTooltip.values),primaryCtaText:t.formatMessage(Ot.memoryManageButton),onPrimaryCtaClick:()=>e(Ai.Personalization),onDismiss:()=>$a.dismissBanner()})})}const Ot=we({memoryFullTitle:{id:"yRGU2/",defaultMessage:"Memory is full."},memoryManageButton:{id:"a5A88o",defaultMessage:"Manage"},memoryFullTooltip:{id:"neUc+N",defaultMessage:"New memories won’t be created until you make space. <a>Learn more</a>",values:{a:t=>a.jsx("a",{href:Ni,target:"_blank",rel:"noopener noreferrer",className:"underline",children:t})}}}),rd=()=>{const{shouldShowSkipButton:t}=Pi();return t?a.jsx(Wa,{className:"flex justify-center",children:a.jsx(wt,{as:"button",color:"secondary",onClick:()=>Di.skipParagen(),children:a.jsx(O,{...cd.skip})})}):null},cd=we({skip:{id:"dvcUbp",defaultMessage:"Skip"}}),ld=d.memo(function({className:e}){const{store:s}=Ie(),n=s.useIsHeaderContentAreaPopulated();return a.jsx("div",{className:$(e??"absolute bottom-full left-0 right-0",hs.PromptTextareaHeader),children:a.jsx(Fi,{shouldRender:n,contentArea:vt.Header,children:a.jsxs("div",{className:"flex flex-col gap-3.5 pt-2",children:[a.jsx(dd,{}),a.jsx(ud,{})]})})})});function dd(){const{store:t}=Ie(),e=t.useContentAreaId(vt.HeaderTop);let s;switch(e){case ce.ParagenControls:s=a.jsx(rd,{});break;case ce.ItemActions:s=a.jsx(Xl,{});break;case ce.BannerSignup:s=a.jsx(fd,{});break;case ce.BannerTermsDisclaimer:s=a.jsx(hd,{});break;case ce.PromptTextareaAction:s=a.jsx(gd,{});break;case ce.BannersRateLimit:s=a.jsx(pd,{});break;case ce.BannerSidekickAnnouncement:s=a.jsx(el,{});break;case ce.BannerMemoryFull:s=a.jsx(id,{});break;case ce.Box:s=a.jsxs("div",{className:"flex h-20 w-full items-center justify-center gap-2 bg-red-500 p-2",children:["box",a.jsxs("div",{className:"flex h-full w-full items-center justify-center gap-2 bg-blue-500 p-2",children:["inner",a.jsx("div",{className:"flex h-full w-full items-center justify-center bg-yellow-400 text-center",children:"actual content"})]})]});break;default:s=null;break}return s}function ud(){const{store:t}=Ie(),e=t.useContentAreaId(vt.HeaderBottom);let s;switch(e){case ma.DallePromptControls:s=a.jsx(md,{});break;default:s=null;break}return s}function md(){const{store:t}=Ie(),e=t.useSharedProps(s=>s==null?void 0:s.composerController);return e?a.jsx(Hl,{composerController:e}):null}function fd(){const{store:t}=Ie(),e=t.useSharedProps(o=>o==null?void 0:o.clientThreadId),s=Li(),n=Oi();return e?s?a.jsx(Bi,{threadId:e,showSignUp:n}):a.jsx(zi,{threadId:e,showLogin:n}):null}function hd(){const{store:t}=Ie(),e=t.useSharedProps(s=>s==null?void 0:s.clientThreadId);return e?a.jsx(Ui,{threadId:e}):null}function gd(){const{store:t}=Ie(),e=t.useSharedProps();return e?a.jsx(td,{...e}):null}function pd(){const{store:t}=Ie(),e=t.useSharedProps(s=>s==null?void 0:s.clientThreadId);return e?a.jsx(nd,{clientThreadId:e}):null}function zs(){return $n(Ss.DataAnalysisV2)}function Dm(){const t=fa(),e=vs();return e&&t&&!No(t)&&e.isEnterprise()}function xd(){return $n(Ss.ChartSerialization)}function Fm(t,e){const s=t==="chart"?xt.HasSeenAdaInteractiveChart:xt.HasSeenAdaInteractiveTable,[n,o]=d.useState(cn.getItem(s,{userId:e})??!1),i=d.useCallback(()=>{o(!0),cn.setItem(s,!0,{userId:e})},[s,e]);return[n,i]}function Lm(t){const[e,s]=d.useState([]),n=rt(()=>{const o=w.resolveThreadId(t),i=w.getThreadCurrentLeafId(t);return w.getTree(o).getBranchFromLeaf(i)});return d.useEffect(()=>{const o=Ya(n);o.length!==e.length&&s(o)},[e.length,t,n]),e}function yd(t){return rt(()=>{const e=w.resolveThreadId(t),s=w.getThreadCurrentLeafId(t),o=w.getTree(e).getBranchFromLeaf(s);return Ya(o).length>0})}function Ka(t){var i,r,l,c;const e=((r=(i=t.metadata)==null?void 0:i.aggregate_result)==null?void 0:r.messages.filter(Ha))??[];let s=0;const n=(((l=t.metadata)==null?void 0:l.ada_visualizations)??[]).map(u=>{let f=u;return u.type=="chart"&&(f={...u,fallback_image:e[s++]}),f}),o=(((c=t.metadata)==null?void 0:c.attachments)??[]).filter(u=>ga(u.name)).map(u=>({type:"table",file_id:u.id??"",title:qi(u),file_name:u.name,context_connector_info:u.context_connector_info}));return[...n,...o]}function Ya(t){return t.filter(s=>{var n,o,i,r;return((n=s.message)==null?void 0:n.author.role)==="tool"&&((o=s.message)==null?void 0:o.author.name)==="python"||(((r=(i=s.message)==null?void 0:i.metadata)==null?void 0:r.attachments)??[]).length>0}).flatMap(s=>Ka(s.message))}Wn(t=>({selectedSpreadsheet:null,setSelectedSpreadsheet:e=>t({selectedSpreadsheet:e})}));async function _d(t,e,s){const n=await t.text(),{parse:o}=await ie(async()=>{const{parse:r}=await import("./oeujip5i1ptrxie5.js");return{parse:r}},[]),i=o(n);return{content:{columnNames:i.shift(),columnTypes:i[0].map(()=>"string"),rows:i},file_name:e,download_url:s}}function vd(t){const e=t[0].values.length,s=[];for(let n=0;n<e;n++){const o=t.map(i=>i.values[n]);s.push(o)}return s}function Om(t){return Kn({queryKey:["ada-visualization","chart",t.file_id],queryFn:async()=>{const e=await We.getFileDownloadLink(t.file_id);if(e.status===Yn.Success){const n=await(await fetch(e.download_url)).json();return{content:{chart_type:n.type,title:n.title,labels:n.labels,datasets:n.datasets,x_label:n.x_label,y_label:n.y_label},file_name:e.file_name??"",download_url:e.download_url}}else throw new Error("Failed to download chart json from interpreter")}})}function Bm(t){return Kn({queryKey:["ada-visualization","table",t.file_id],queryFn:async()=>{if(t.file_name&&Gi(t.file_name)){const e=await We.getAdaExcelFileContents(t.file_id);return{content:e.sheets.map(s=>({name:s.name,columnNames:s.columns.map(n=>n.name),columnTypes:s.columns.map(()=>"string"),rows:vd(s.columns)})),download_url:e.download_url,file_name:t.file_name}}else{const e=await We.getFileDownloadLink(t.file_id);if(e.status===Yn.Success){const s=await fetch(e.download_url);return _d(s,e.file_name??"",e.download_url)}else throw new Error("Failed to download from interpreter")}}})}function Sd(t){const e=ha(),s=yd(t),n=zs();return s&&n&&!e.displayingSideBySideFeedback}function bd(t){var e,s;return((s=(e=t.metadata)==null?void 0:e.dalle)==null?void 0:s.prompt)??""}async function wd(t,e,s="image/png"){return new Promise((n,o)=>{t.toBlob(i=>{i!=null?n(new File([i],e,{type:s})):o(new Error("Failed to convert canvas to blob"))},s)})}async function kd(t,e){const s=document.createElement("canvas");s.width=t.width,s.height=t.height;const n=s.getContext("2d");if(n==null)throw new Error("Failed to get 2d context for mask canvas");const o=n.createImageData(t.width,t.height);for(let i=0;i<t.data.length;i+=4)t.data[i+3]!==0?(o.data[i]=0,o.data[i+1]=0,o.data[i+2]=0,o.data[i+3]=255):(o.data[i]=255,o.data[i+1]=255,o.data[i+2]=255,o.data[i+3]=255);return n.putImageData(o,0,0),wd(s,e)}async function Cd(t,e){const n=await(await fetch(t)).blob(),o=document.createElement("a");o.href=URL.createObjectURL(n),o.download=e,o.click(),o.remove()}function Id(t){const e=Wi(new Date,"yyyy-MM-dd HH.mm.ss");let s=t.slice(0,150);return s.endsWith(".")&&(s=s.slice(0,-1)),`DALL·E ${e} - ${s}.webp`}async function zm(t,e,s){var i,r,l,c,u,f,g,m,v,y;const n=bd(t),o=Id(n);await Cd(t.url,o),ze.logEvent("chatgpt_dalle_image_download",null,{sourceOperation:((r=(i=t.metadata)==null?void 0:i.dalle)==null?void 0:r.edit_op)??"none",hasParent:((c=(l=t.metadata)==null?void 0:l.dalle)==null?void 0:c.parent_gen_id)!=null?"true":"false"}),D.logEvent(N.dalleImageDownload,{conversationId:e,messageId:s,generationId:(f=(u=t.metadata)==null?void 0:u.dalle)==null?void 0:f.gen_id,parentGenerationId:(m=(g=t.metadata)==null?void 0:g.dalle)==null?void 0:m.parent_gen_id,fileId:Jt(t.asset_pointer),sourceOperation:(y=(v=t.metadata)==null?void 0:v.dalle)==null?void 0:y.edit_op})}function Td(t){const e=Bs(t),s=Zt(),n=e&&"gizmo"in e?e.gizmo:void 0;return!s&&(n==null?void 0:n.gizmo.id)===Hi}function Um(t,e){var o,i;const s=(i=(o=e.metadata)==null?void 0:o.dalle)==null?void 0:i.gen_id,n=Jt(e.asset_pointer);return n==null||s==null?t:{...t,messageMetadata:{...t.messageMetadata,dalle:{from_client:{operation:{type:"transformation",original_gen_id:s,original_file_id:n}}}}}}async function jd(t,e,s){return new Promise((n,o)=>{Vi(pa(t),t,e,{kind:Po.DalleAgent},{onFileCreated:ms,onFileUploadProgress:ms,onFileUploaded:(i,r)=>n(r),onError:(i,r)=>{o(new Error(`Failed to upload file with reason: ${r}`))}},s)})}async function Gm(t,e,s,n){var r,l;const o=(l=(r=e.metadata)==null?void 0:r.dalle)==null?void 0:l.gen_id,i=Jt(e.asset_pointer);if(i==null||o==null||s==null)return t;try{const c=await kd(s,"mask.png"),u=await jd(c,n,{imageDimensions:{width:e.width,height:e.height}});return{...t,messageMetadata:{...t.messageMetadata,dalle:{from_client:{operation:{type:"inpainting",original_gen_id:o,original_file_id:i,mask_file_id:u}}}}}}catch(c){return je.addError(c),t}}const Md=d.memo(function(e){return Rd(e),Ed(e),Ad(),null});function Rd(t){const{store:e}=Ie(),s=e.useSetSharedProps();d.useLayoutEffect(()=>{s(t)},[t,s])}function Ed(t){const{clientThreadId:e,canContinue:s}=t,{store:n}=Ie(),o=d.useRef({top:n.useContentAreaApi(vt.HeaderTop),bottom:n.useContentAreaApi(vt.HeaderBottom)}).current,i=Dd(t),r=Td(e),{shouldShowBannerSignup:l,shouldShowBannerTermsDisclaimer:c}=Fd(e),u=ad(e),f=tl(t),g=od(e),m=$i();d.useLayoutEffect(()=>{m?o.top.set(ce.ParagenControls):c?o.top.set(ce.BannerTermsDisclaimer):u?o.top.set(ce.BannersRateLimit):f.eligible?o.top.set(ce.BannerSidekickAnnouncement):i?o.top.set(ce.ItemActions):s?o.top.set(ce.PromptTextareaAction):l?o.top.set(ce.BannerSignup):g?o.top.set(ce.BannerMemoryFull):o.top.set(null)},[o,i,s,c,l,u,f,g,m]),d.useLayoutEffect(()=>{r&&o.bottom.set(ma.DallePromptControls)},[o,r])}function Ad(){const{store:t}=Ie();d.useEffect(()=>()=>{t.reset()},[t])}function Nd(t){var o,i;const e=xa(),s=ct(t),n=(i=(o=w.getTree(t).getLastValidNode(s))==null?void 0:o.message)==null?void 0:i.id;return(e==null?void 0:e.messageId)===n?e.suggestions:[]}function Pd(t){return Nd(t).length>0}function Dd(t){const e=Sd(t.clientThreadId),s=Pd(t.clientThreadId);return t.isDisabled?!1:t.isNewThread||e||s}function Fd(t){var g;const{isUnauthenticated:e}=bt(),s=ct(t),{layer:n}=Do("3637408529"),o=n.get("should_show_no_auth_signup_banner",!0),i=Ki(m=>m.bannerDisclaimerClientThreadId),r={shouldShowBannerTermsDisclaimer:!1,shouldShowBannerSignup:!1};if(!t)return r;const l=w.getTree(t),c=l.countMessagesByAuthor(pe.User),u=l.getNodeByIdOrMessageId(s),f=((g=u==null?void 0:u.message)==null?void 0:g.author.role)===pe.Assistant&&bs(u.message);return r.shouldShowBannerTermsDisclaimer=f&&e&&c===1&&(i==null||i===t),r.shouldShowBannerSignup=o&&f&&e&&c>0&&c%5===0,r}function Ld(t,e,s,n,o){const{getGizmoId:i}=Xt(),[r,l]=d.useState();d.useEffect(()=>{i?i().then(f=>l(f)):l(void 0)},[i]);const c=Zn(e);return d.useCallback(f=>{const{docsReferencedByURL:g}=Ne.getThread(t)??{};if(g!=null)for(const m of f){const{id:v,type:y,handler:h}=m,T=`${y}:${v}`,M=g[T],k=St.getState().files.find(p=>p.tempId===v);if(M!=null&&M!=="failed"&&k){Gt.success(s.formatMessage(is.fileAlreadyAttached),{hasCloseButton:!0});continue}switch(h.type){case"fetch":{w.updateReferencedDocState(t,T,"pending"),He.uploadFile(v,new File([],s.formatMessage(is.fileLoading)),tt.None,n,s,{skipUpload:!0,gizmoId:r},o,{contextConnector:y,sourceUrl:m.url,syntheticExtension:null,type:qt.Link}),as.linkMetadataFetchStarted(y),h.tryFetch().then(p=>{if(He.remove(v,"none"),p==null)return null;const{id:S,title:C,connector:P,mimeType:F,url:E,syntheticExtension:R,o365DriveId:ee}=p;as.linkMetadataFetchSucceeded(y,F),w.updateReferencedDocState(t,T,"fetched");let G=C;P===ye.GDRIVE&&(G=R?`${C}.${R}`:C),He.uploadFile(S,new File([],G,{type:F.split(";")[0]}),tt.Retrieval,n,s,{gizmoId:r},o,{contextConnector:P,sourceUrl:E,syntheticExtension:R,type:qt.Link,o365DriveId:ee})}).catch(p=>{as.linkMetadataFetchFailed(y,p),Gt.danger(s.formatMessage(is.fileFetchFailed),{hasCloseButton:!0}),w.updateReferencedDocState(t,T,"failed"),He.remove(v,"none")});break}case"prompt":{c.appendMessageIfNotDismissed({connector:y,type:h.message}),w.updateReferencedDocState(t,T,"prompted");break}}}},[o,t,c,r,s,n])}const is=we({fileLoading:{id:"CCC.fileLoading",defaultMessage:"Loading…"},fileFetchFailed:{id:"CCC.fileFetchFailed",defaultMessage:"Unable to fetch file information"},fileAlreadyAttached:{id:"CCC.fileAlreadyAttached",defaultMessage:"This file is already a part of your message."}}),Za=({clientThreadId:t,rateLimitPopup:e,children:s,highlightTooltip:n=!1})=>{const o=oe(),i=yc(t),r=vs(),[l,c]=d.useState(n),[u,f]=d.useState(!1),g=d.useCallback(()=>{u||c(!0)},[u]),m=d.useCallback(()=>{c(!1),f(!1)},[]),v=d.useCallback(()=>{c(!1),f(!0)},[]);d.useEffect(()=>{c(n)},[n]);const y=T=>{e!=null&&T&&D.logPopoverHover({type:"rate_limit",location:"file_upload",plan_type:(r==null?void 0:r.planType)??"unknown"})},h=!!e;return a.jsx(a.Fragment,{children:h?a.jsxs(Fo,{delayDuration:150,onOpenChange:y,children:[a.jsx(Lo,{children:s}),a.jsx(Oo,{children:a.jsx(Yi,{$as:Bo,side:"top",sideOffset:4,className:"max-w-[260px]",children:a.jsx(Od,{isNewConversation:i,rateLimitPopup:e})})})]}):a.jsx(da,{sideOffset:14,label:o.formatMessage({id:"oUK/GV",defaultMessage:"Attach file"}),className:"flex",open:l||n,side:"top",children:a.jsx("span",{onPointerEnter:g,onPointerLeave:m,onClick:v,children:s})})})},Od=({isNewConversation:t=!1,rateLimitPopup:e})=>{const s=vs(),n=Jn();if(e==null)return null;const{call_to_action:o,description:i}=e,r=i||a.jsx(O,{...Mn.defaultDescription}),l=o==null?void 0:o.includes(zo.GET_PLUS);return a.jsxs("div",{className:"p-2 text-sm text-token-text-primary",children:[a.jsx("div",{children:r}),l?a.jsx(wt,{size:"small",color:"secondary",className:"mt-3",onClick:()=>{Zi(n,"Rate limited file upload popover"),D.logRateLimitGetPlusButtonClicked({type:"file_upload",location:"popover",plan_type:(s==null?void 0:s.planType)??"unknown",is_hard_block:!1,is_new_conversation:t,hard_block_reason:""})},children:a.jsx(O,{...Mn.getPlus})}):null]})},Mn=we({defaultDescription:{id:"U5qAWP",defaultMessage:"You've reached your daily upload limit. Get ChatGPT Plus to unlock more."},getPlus:{id:"TeyLcp",defaultMessage:"Get Plus"}});function Bd({clientThreadId:t,getInputProps:e,openFileDialog:s,uploadType:n,icon:o,highlightTooltip:i=!1}){const r=oe(),l=ws(),c=!!l,u=a.jsx(ya,{className:"mb-1 ml-1.5",disabled:c,onClick:m=>{m.preventDefault(),D.logEvent(N.openFileViewer,{intent:n.toString()}),s()},"aria-label":r.formatMessage({id:"PromptFilePicker.attachFiles",defaultMessage:"Attach files"}),children:o}),f=a.jsx("input",{disabled:c,...e({className:"hidden"})}),g=a.jsxs("div",{className:"flex",children:[u,f]});return a.jsx(Za,{clientThreadId:t,rateLimitPopup:l,highlightTooltip:i,children:g})}function zd({code:t,message:e}){switch(t){case fn.FileTooLarge:return Rn.errorFileTooLarge;case fn.TooManyFiles:return D.logEvent(N.uploadedMaxFilesError),Rn.errorTooManyFiles;default:return e}}const Rn=we({attachImages:{id:"PromptFilePicker.attachImages",defaultMessage:"Attach images"},attachFiles:{id:"PromptFilePicker.attachFiles",defaultMessage:"Attach files"},errorFileTooLarge:{id:"PromptFilePicker.errorFileTooLarge",defaultMessage:"Your file is too large. The maximum file size is {size}MB."},errorTooManyFiles:{id:"PromptFilePicker.errorTooManyFiles",defaultMessage:"You may only upload {maxNum} files at a time."},defaultFileUploadRateLimited:{id:"U5qAWP",defaultMessage:"You've reached your daily upload limit. Get ChatGPT Plus to unlock more."},getPlusButton:{id:"TeyLcp",defaultMessage:"Get Plus"}}),En=we({dragInstructions:{id:"FileDropZone.dragInstructions",defaultMessage:"Add anything"},dragAllAccepted:{id:"FileDropZone.dragAllAccepted",defaultMessage:"Drop any file here to add it to the conversation"}});function qm(t){var p;const{className:e,children:s,clientThreadId:n,currentModelConfig:o}=t,i=oe(),r=Bs(n),l=Wt(o,r),c=l!==tt.None,u=St(S=>S.files),f=(l===tt.Multimodal?Ts:js)-u.length,g=f<=0,{getGizmoId:m}=Xt(),{handleFileAccepted:v}=Xa(i,Wt(o,r),va(o,r),"drag",m,(p=_a(o,r))==null?void 0:p.attachments),y=ws(),h=Sa(ba(o,r)),{getRootProps:T,isDragActive:M}=wa({maxFiles:f,disabled:!c||g||y!=null,noClick:!0,onDropAccepted:v,onDropRejected:S=>Ja(S,i,l),multiple:!0,maxSize:ka,...h}),j=k();function k(){if(!h.accept||Object.keys(h.accept).length===0)return[];const S=[];return Object.values(h.accept).forEach(C=>S.push(...C)),S.sort()}return a.jsxs("div",{...T({className:e}),children:[s,M&&a.jsxs(Ud,{children:[a.jsx(Ji,{}),a.jsx("h3",{children:a.jsx(O,{...En.dragInstructions})}),a.jsx("h4",{className:"w-2/3 text-center",children:j.length>0?j.join(", "):a.jsx(O,{...En.dragAllAccepted})})]})]})}function Ja(t,e,s){const{errors:n}=t[0];n.forEach(o=>{const i=zd(o);typeof i=="string"?Gt.danger(i,{hasCloseButton:!0}):Gt.danger(e.formatMessage(i,{size:Xi,maxNum:s===tt.Multimodal?Ts:js}),{hasCloseButton:!0})})}function Xa(t,e,s,n,o,i){return{handleFileAccepted:d.useCallback(async(l,c)=>{D.logEvent(N.uploadFile,{client:"web",eventSource:n,intent:e.toString()});const u=o!=null?await o():void 0;l.length>0&&l.forEach(f=>{He.uploadFile(pa(f),f,e,s,t,{gizmoId:u},i)})},[n,e,o,s,t,i])}}const Ud=Me.div`absolute inset-0 opacity-80 flex gap-2 flex-col justify-center items-center bg-token-main-surface-primary text-token-text-primary`;function An({entry:t,onClick:e}){const{connectorConfig:s}=Ms();d.useEffect(()=>{if(!open||t.type!==ye.GDRIVE)return;const r=s.get(ye.GDRIVE),l=r==null?void 0:r.access_token;l&&Qi(l)},[s,t.type]);const n=Ca(t.type),o=oe(),i=t.access_token?Nn.uploadFromMessage:Nn.signinWithMessage;return a.jsx(X.Item,{onClick:e,icon:n,children:a.jsxs("div",{className:"flex flex-col",children:[a.jsx(O,{...i,values:{connectorName:Rs(t.type,o)}}),t.type===ye.O365_BUSINESS&&a.jsx("div",{className:"text-s text-token-text-tertiary",children:a.jsx(O,{...Es.includesSharePoint})})]})},t.id)}const Nn=we({signinWithMessage:{id:"ContextConnectorPickerDropdownItem.signInWithMessage",defaultMessage:"Connect to {connectorName}"},uploadFromMessage:{id:"ContextConnectorPickerDropdownItem.uploadWithMessage",defaultMessage:"Add from {connectorName}"}});function Gd({clientThreadId:t,icon:e,setOpen:s,highlightTooltip:n=!1}){const o=ws(),i=!!o,r=oe();return a.jsxs(a.Fragment,{children:[a.jsx(X.Trigger,{className:"m-0 h-0 w-0 border-none bg-transparent p-0"}),a.jsx(Za,{clientThreadId:t,rateLimitPopup:o,highlightTooltip:n,children:a.jsx(ya,{className:"mb-1 ml-1.5","aria-disabled":i,"aria-label":r.formatMessage({id:"tA7CXR",defaultMessage:"Attach files"}),onClick:l=>{l.preventDefault(),i||s(!0)},children:e})})]})}function qd({connectorEntries:t,onOauthRedirect:e}){const s=oe();return a.jsxs(X.Sub,{children:[a.jsx(X.SubMenuTrigger,{icon:Mc,children:a.jsx("div",{className:"line-clamp-1 text-ellipsis",children:a.jsx(O,{...Hd.connectApps})})}),a.jsx(X.Portal,{children:a.jsx(X.SubContent,{children:t.map(n=>a.jsx(X.Item,{onClick:()=>e(n),icon:Ca(n.type),children:a.jsxs("div",{className:"flex flex-col",children:[Rs(n.type,s),n.type===ye.O365_BUSINESS&&a.jsx("div",{className:"text-s text-token-text-tertiary",children:a.jsx(O,{...Es.includesSharePoint})})]})},n.id))})})]})}const Hd=we({connectApps:{id:"ContextConnectorPicker.connectApps",defaultMessage:"Connect apps"}});function Vd({onOauthRedirect:t,connectors:e}){const s=oe();return a.jsxs(X.Sub,{children:[a.jsx(X.SubMenuTrigger,{icon:Rc,children:a.jsx(O,{...Wd.oneDriveSubmenuName})}),a.jsx(X.Portal,{children:a.jsx(X.SubContent,{children:e.map(n=>n?a.jsx(X.Item,{onClick:()=>t(n),children:a.jsxs("div",{className:"flex flex-col",children:[Rs(n.type,s),n.type===ye.O365_BUSINESS&&a.jsx("div",{className:"text-s text-token-text-tertiary",children:a.jsx(O,{...Es.includesSharePoint})})]})},n.id):null)})})]})}const Wd=we({oneDriveSubmenuName:{id:"ContextConnectorPickerOneDriveSubmenu.oneDriveSubmenuName",defaultMessage:"Connect to Microsoft OneDrive"}});function $d(){const{connectorConfig:t}=Ms(),e=Kt(),[s,n]=$t(Ia([...t.values()],u=>!!u.access_token),u=>!!u.access_token),[o,i]=$t(n,u=>u.type===ye.O365_PERSONAL||u.type===ye.O365_BUSINESS),r=!e&&s.length>0,l=!e&&!r&&o.length>1;return{unconnectedConnectors:l?i:n,showUnconnectedInSubmenu:r,showOneDriveInSubmenu:l}}function Kd({clientThreadId:t,icon:e,modelAcceptedMimeTypes:s,modelSupportedImageMimeTypes:n,attachmentsProductFeature:o,onOauthRedirect:i,uploadType:r,getInputProps:l,openFileDialog:c,highlightTooltip:u=!1}){const{currentLocale:f}=Uo(),g=oe(),m=Kt(),{connectorConfig:v,isLoading:y}=Ms(),h=ca(la.ContextConnectors),{getGizmoId:T}=Xt(),[M,j]=d.useState();d.useEffect(()=>{T?T().then(x=>j(x)):j(void 0)},[T]);const k=d.useRef(null),[p,S]=d.useState(!1),C=d.useRef(!1),P=d.useCallback(()=>{var U;const x=(U=k.current)==null?void 0:U.files;Array.from(x??[]).forEach(ge=>Pt.uploadFile(ge,n,g,o))},[n,o,g]),[F,E]=d.useState(null),R=d.useCallback(()=>E(null),[E]),ee=d.useCallback((x,U)=>Pt.uploadPickedFile(x,U,n,s,o,M,g),[n,s,o,M,g]),{openMenu:G,confirmMenuOpened:q}=er();d.useEffect(()=>{G&&(S(!0),q())},[G,q,S]);const K=Xn(),J=d.useCallback(x=>{Pt.doContextConnectorOauthRedirect(K.asPath,x,i,qt.Picker),i()},[i,K.asPath]),H=d.useCallback(x=>{Pt.uploadPickedFile(x,ye.GDRIVE,n,s,o,M,g)},[n,s,o,M,g]),te=d.useCallback(async x=>{const{access_token:U}=x;if(!U){J(x);return}switch(tr(x,qt.Picker),x.type){case ye.GDRIVE:sr(f,x.type,U,ge=>ge.forEach(H));break;case ye.O365_PERSONAL:case ye.O365_BUSINESS:E(x.type);break}},[H,J,E,f]),I=()=>{D.logEvent(N.openFileViewer,{intent:r.toString()}),c()},_=x=>{if(!x&&C.current&&!y)I();else if(x&&ne&&!y){I();return}S(x),x&&(h.eligible&&h.markAsViewed(),D.logEvent(N.composerOpenContextConnectorPicker),C.current=!0,setTimeout(()=>{C.current=!1},250))},[Q,V]=$t(Ia([...v.values()],x=>!!x.access_token),x=>!!x.access_token);Yd(Q,te);const[Z]=$t(V,x=>x.type===ye.O365_PERSONAL||x.type===ye.O365_BUSINESS),{unconnectedConnectors:Y,showUnconnectedInSubmenu:de,showOneDriveInSubmenu:re}=$d(),ne=!Q.length&&!Y.length,B=a.jsxs(a.Fragment,{children:[de&&Y.length>0&&a.jsx(qd,{connectorEntries:Y,onOauthRedirect:x=>J(x)}),!de&&Y.map(x=>a.jsx(An,{entry:x,onClick:()=>te(x)},x.id)),re&&a.jsx(Vd,{connectors:Z,onOauthRedirect:J}),y&&a.jsx(X.Item,{icon:a.jsx(Go,{className:"text-token-text-secondary"})}),(Y.length>0||y)&&a.jsx(X.Separator,{}),Q.map(x=>a.jsx(An,{entry:x,onClick:()=>te(x)},x.id)),a.jsx(X.Item,{onClick:I,icon:Ec,children:a.jsx(O,{...m?Pn.uploadFileMobile:Pn.uploadFile})},"upload")]}),se=a.jsxs("div",{className:"flex flex-col",children:[a.jsx(nr,{type:F,onClose:R,uploadPickedFile:ee}),a.jsx("input",{onChange:P,...l({className:"hidden"})}),a.jsxs(X.Root,{open:p,onOpenChange:_,children:[a.jsx(Gd,{clientThreadId:t,icon:e,setOpen:_,highlightTooltip:u}),a.jsx(X.Portal,{children:a.jsx(X.Content,{size:"large",children:B})})]}),a.jsx(ar,{hasConnectors:!y&&!ne})]});return{dropdownItems:B,mainComponent:se}}function Yd(t,e){const{connector:s,clearParam:n}=or(),o=t.find(i=>i.type===s&&!!i.access_token);d.useEffect(()=>{o&&(e(o),n())},[o,e,n])}function Zd(t){const{mainComponent:e}=Kd(t);return e}const Pn=we({attachFiles:{id:"ContextConnectorPicker.attachFiles",defaultMessage:"Attach files"},uploadFile:{id:"LocalFileDropdownItem.uploadFile",defaultMessage:"Upload from computer"},uploadFileMobile:{id:"LocalFileDropdownItem.uploadFileMobile",defaultMessage:"Upload file"}});function Jd({clientThreadId:t,uploadType:e,modelAcceptedMimeTypes:s,modelSupportedImageMimeTypes:n,attachmentsProductFeature:o,getInputProps:i,openFileDialog:r,onOauthRedirect:l,historyDisabled:c,className:u,highlightTooltip:f}){const{gdriveStatus:g,o365Status:m}=ir(),v=a.jsx(Ac,{className:c?"text-white":f?"text-brand-blue-800":void 0});return a.jsxs("div",{className:$("relative",u),children:[g!=="false"||m!=="false"?a.jsx(Zd,{clientThreadId:t,icon:v,modelAcceptedMimeTypes:s,modelSupportedImageMimeTypes:n,attachmentsProductFeature:o,onOauthRedirect:l,uploadType:e,openFileDialog:r,getInputProps:i,highlightTooltip:f}):a.jsx(Bd,{clientThreadId:t,uploadType:e,openFileDialog:r,getInputProps:i,icon:v,highlightTooltip:f}),f&&a.jsx(be.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:260,damping:20},className:"pointer-events-none absolute bottom-1 left-1.5 h-8 w-8 rounded-full bg-brand-blue-800/20"})]})}const Xd=d.forwardRef(function({type:e,placeholder:s,replyRegions:n,state:o,renderFiles:i,icon:r,onSubmit:l,inputState:c,currentLeafId:u,composerController:f,clientThreadId:g,gizmoId:m},v){const y=ks(),h=rr();return d.useEffect(()=>{f.focus()},[h==null?void 0:h.modelId,f]),a.jsxs("div",{ref:v,className:$("flex w-full flex-col gap-1.5 rounded-[26px] p-1.5 transition-colors",y&&"backdrop-blur-2xl no-transparency:backdrop-blur-none",y&&e!=="temporary"&&"bg-token-composer-surface",!y&&e!=="temporary"&&"bg-[#f4f4f4] dark:bg-token-main-surface-secondary",e==="temporary"&&"dark bg-black"),children:[n.length>0&&a.jsx(su,{replyRegions:n}),a.jsxs("div",{className:"flex items-end gap-1.5 md:gap-2",children:[r,a.jsxs("div",{className:$("flex min-w-0 flex-1 flex-col",!r&&"pl-4"),children:[i,f instanceof Ta?a.jsx(Qd,{composerController:f,currentLeafId:u,placeholder:s,inputState:c}):a.jsx(rl,{composerController:f,placeholder:s})]}),a.jsx(eu,{inputState:c,state:o,onSubmit:l,composerController:f,clientThreadId:g,gizmoId:m})]})]})});function Qd({composerController:t,currentLeafId:e,placeholder:s,inputState:n}){const o=d.useContext(qo);return a.jsxs(a.Fragment,{children:[a.jsx(cr,{id:lr,autoFocus:!0,tabIndex:0,"data-id":e,dir:"auto",ref:i=>{if(!(t instanceof Ta))throw new Error("Expected TextAreaComposerController");i!=null&&(t.textArea=i,t.logPageMount())},rows:1,placeholder:s,disabled:n!=="default",className:$("m-0 resize-none border-0 bg-transparent px-0 text-token-text-primary focus:ring-0 focus-visible:ring-0",n==="disabled"&&"text-center",["max-h-[25dvh]","max-h-52"])}),a.jsx("script",{nonce:o.cspScriptNonce,suppressHydrationWarning:!0,children:"requestAnimationFrame((function(){window.__oai_logTTI?window.__oai_logTTI():window.__oai_SSR_TTI=window.__oai_SSR_TTI??Date.now()}))"})]})}function eu(t){const{isUnauthenticated:e}=bt(),s=St(ja.hasUploadInProgress);if(t.inputState==="disabled")return null;const n=a.jsx(tu,{state:t.state,onSubmit:t.onSubmit});return!e&&!s&&t.state==="disabled"&&t.clientThreadId?a.jsx(dr,{clientThreadId:t.clientThreadId,gizmoId:t.gizmoId,fallback:()=>n}):n}function tu({state:t,onSubmit:e}){const s=t==="streaming"?Pc:Dc,n=oe(),o=n.formatMessage({id:"+yfm/p",defaultMessage:"Stop streaming"}),i=n.formatMessage({id:"xfIykB",defaultMessage:"Send prompt"}),r=ks();return a.jsx("button",{onClick:e,disabled:t==="disabled","aria-label":t==="streaming"?o:i,"data-testid":t==="streaming"?"stop-button":"send-button",className:$("mb-1 me-1 flex h-8 w-8 items-center justify-center rounded-full bg-black text-white transition-colors hover:opacity-70 focus-visible:outline-none focus-visible:outline-black disabled:text-[#f4f4f4] disabled:hover:opacity-100 dark:bg-white dark:text-black dark:focus-visible:outline-white disabled:dark:bg-token-text-quaternary dark:disabled:text-token-main-surface-secondary",r&&"disabled:bg-black disabled:bg-opacity-[0.27]",!r&&"disabled:bg-[#D7D7D7]"),children:a.jsx(s,{className:$(t==="streaming"?"icon-lg":"icon-2xl")})})}function su({replyRegions:t}){return a.jsx("div",{className:"flex flex-col divide-y divide-token-border-light overflow-hidden rounded-b-lg rounded-t-[20px] bg-token-main-surface-primary",children:t.map((e,s)=>{switch(e.type){case"text":return a.jsx(nu,{value:e.value,onRemoveRegion:e.onRemoveRegion},s);case"object":return a.jsx(au,{value:e.value,onRemoveRegion:e.onRemoveRegion},s);case"mention":case"system_hint":return a.jsx(ou,{value:e.value,icon:e.icon,onRemoveRegion:e.onRemoveRegion},s)}})})}function nu({value:t,onRemoveRegion:e}){return a.jsxs(Gs,{className:"text-token-text-secondary",children:[a.jsx(qs,{children:a.jsx(Fs,{className:"icon-lg-heavy"})}),a.jsx(Hs,{children:`“${t}”`}),a.jsx(Us,{onClick:e})]})}function au({value:t,onRemoveRegion:e}){return a.jsxs(Gs,{className:"text-blue-selection",children:[a.jsx(qs,{children:a.jsx(Fs,{className:"icon-lg-heavy"})}),a.jsx(Hs,{className:"font-semibold",children:t}),a.jsx(Us,{onClick:e})]})}function ou({value:t,icon:e,onRemoveRegion:s}){return a.jsxs(Gs,{children:[a.jsx(qs,{className:"mt-0",children:e}),a.jsx(Hs,{className:"font-semibold text-token-text-secondary",children:t}),a.jsx(Us,{onClick:s})]})}function Us({onClick:t}){return a.jsx("button",{onClick:t,className:"flex-shrink-0 text-token-text-secondary",children:a.jsx(Nc,{className:"icon-lg"})})}const Gs=Me.div`flex items-start py-2.5 gap-4 pl-3 pr-1.5 text-sm`,qs=Me.span`flex-shrink-0 mt-0.5 w-6 h-6 flex justify-center items-center`,Hs=Me.span`flex-1 line-clamp-3 py-0.5`;function iu(t){const e=hr(),s=nl(t),n=d.useMemo(()=>!e.isSuccess||!e.data?[]:e.data,[e.data,e.isSuccess]);return d.useMemo(()=>{const i=new Set(s.enabledTools||[]);return n.filter(r=>r.requiredFeatures.length?r.requiredFeatures.every(l=>i.has(l)):!0)},[n,s])}function ru({composerController:t,clientThreadId:e}){const s=Fa(e),n=iu(e),[o,i]=d.useState([]),[r,l]=d.useState(void 0),[c,u]=d.useState(0);d.useEffect(()=>{i(r?n.filter(p=>p.name.toLowerCase().startsWith(r.text.toLowerCase())):[])},[r,n]);const f=t.useState(p=>p.getSystemHints().length>0);d.useEffect(()=>{const p=S=>{l(C=>!C||!S?S:C.text===S.text&&C.range.from===S.range.to&&C.range.to?C:S)};t.view.dispatch(t.view.state.tr.setMeta(ll,{onHintMatch:p}))},[t]);const g=f||!n.length||!o.length||!r;d.useEffect(()=>{g&&u(0)},[g]);const m=o.length,v=d.useCallback(p=>{u(S=>(p(S)%m+m)%m)},[m]),y=o[c],h=({hintToSave:p=y,expectPerfectMatch:S,appendSpace:C=!0})=>{if(!r||!y||S&&p.name.toLowerCase()!==r.text.toLowerCase())return;D.logEvent(N.systemHintSelected,{system_hint:p.systemHint,conversation_id:s??ln});const P=r.text+p.name.slice(r.text.length);ul(t.view,{id:p.systemHint,hint:P},r.range,C),Ft(t.view)},T=d.useRef(h);T.current=h;const M=d.useRef(v);M.current=v;const j=d.useRef(r);j.current=r;const k=t.view;return d.useEffect(()=>(g||dl(k,p=>{p==="up"?M.current(S=>S-1):p==="down"?M.current(S=>S+1):p==="cancel"?(Ft(k),ml(k)):p==="submit"?(T.current({expectPerfectMatch:!1}),Ft(k)):p==="checkMatch"&&T.current({expectPerfectMatch:!0,appendSpace:!1})}),()=>Ft(k)),[g,k]),d.useEffect(()=>{g||D.logEvent(N.systemHintListOpened,{conversation_id:s??ln})},[g]),g?null:a.jsx(ur,{className:"max-w-60",children:o.map((p,S)=>a.jsx("div",{children:a.jsx(mr,{autoFocus:!1,className:"hover:bg-inherit rounded-lg px-1 py-2",spoofHovered:S===c,onMouseOver:()=>u(S),onClick:()=>{h({hintToSave:p,expectPerfectMatch:!1}),t.focus()},children:a.jsx(cu,{title:p.name,description:p.description,icon:a.jsx(fr,{svgString:p.logo,className:"icon-lg text-token-text-secondary"}),checked:!1})})},p.systemHint))})}function cu({title:t,description:e,icon:s,onClick:n,checked:o}){return a.jsxs("div",{className:"inline-flex w-full items-center justify-start gap-1.5 pl-1.5 pr-3",onClick:n,children:[a.jsx("div",{className:"flex h-7 w-7 items-center justify-center gap-2.5",children:s}),a.jsxs("div",{className:"shrink grow basis-0",children:[a.jsx("p",{className:"text-sm font-normal leading-tight text-token-text-primary",children:t}),!!e&&a.jsx("p",{className:"text-[13px] font-normal leading-[18px] text-token-text-secondary",children:e})]}),o&&a.jsx(Fc,{className:$("icon-md text-token-text-primary",{"group-hover:hidden":!o})})]})}function lu({composerController:t,clientThreadId:e}){return t instanceof cl?a.jsx(ru,{composerController:t,clientThreadId:e}):null}const du=1,uu=3e3;function mu({files:t,className:e}){const s=Kt();return a.jsx("div",{className:e,children:t.map(n=>a.jsx(Ea,{width:s?"normal":"wide",onRemoveFileClick:()=>He.remove(n.tempId,"none"),file:n.file,fileId:n.fileId??void 0,contextConnectorInfo:n.contextConnectorInfo,loadingPercentage:n.status===Mr.Uploading?n.progress:void 0},n.tempId))})}function fu({onAbortCompletion:t,onCreateNewCompletion:e,onContinueGenerating:s,currentModelId:n,clientThreadId:o,isNewThread:i,isCompletionInProgress:r,className:l,disabled:c=!1,disabledReason:u,canPause:f=!1,canContinue:g=!1,suggestions:m,isInteractableSharedThread:v,composerContainerRef:y,composerController:h,autocompletions:T,requiresFileUpload:M,onComposerInput:j,onComposerChange:k,onAutocompleteSelect:p,headerClassName:S,hideHeader:C,setComposerBarElement:P,onTaggingDropdownOpen:F,onTaggingDropdownClose:E}){var sn,nn;const R=fa(),{isUnauthenticated:ee}=bt(),G=oe(),q=ct(o),K=Qt(o),J=Xn(),{gizmoEditorData:H,mode:te,getGizmoId:I}=Xt(),_=Qn(),Q=Hn(),V=Ho(),Z=Zt(),Y=Fa(o),de=!!Vo(),re=gr(),ne=!!Wo(),[B,se]=d.useState({}),[x,U]=d.useState(!1),[ge,Pe]=d.useState(!1),De=d.useRef(!1),Ue=al(),ue=n!==null?Ue[n]:void 0;let z=Bs(o),ke=z&&"gizmo"in z?z.gizmo:void 0;const[me,st]=d.useState(null);me!==null&&(z={gizmo:me,gizmo_id:me.gizmo.id,kind:ve.GizmoInteraction},ke=me);const $e=Wt(ue,z);let Ct=!1;pr(z)&&(ke==null?void 0:ke.gizmo.id)===xr&&(Ct=!0);const Ke=!c&&$e!==tt.None&&!Ct&&!ee,Ye=va(ue,z),lt=ba(ue,z);let Ce=St(b=>b.files);const[_e]=d.useState(()=>yr());te==="magic"?Ce=Ce.filter(b=>b.gizmoId!=null):Ce=Ce.filter(b=>b.gizmoId==null);const ae=Ce.length>0,Te=St(ja.hasUploadInProgress),nt=h.useState(b=>!b.isEmpty()),Ze=ae?!Te:nt,Je=($e===tt.Multimodal?Ts:js)-Ce.length,Xe=Je<=0,Re=Ze&&!c&&!r&&!ne,[It,ao]=d.useState(!1),oo=ol(),io=n||oo.id,ro=(sn=Ue[io])==null?void 0:sn.tags,{targetedContent:Tt,setTargetedContent:jt}=_r(),W=Tt!=null&&Tt.isFocusedViewContent&&!Z?void 0:Tt,{rebaseSystemMessageContent:Ws}=Ma();d.useEffect(()=>{vr()}),d.useEffect(()=>{if(!(R!=null&&R.id))return;const b=hn.getAndReset(R==null?void 0:R.id,Y);b&&h.setText(b.inputText)},[R==null?void 0:R.id,Y,h]),d.useEffect(()=>{It!==Re&&(ao(Re),Re&&(ea(!0).then(b=>{Ht.startEnforcement(b),gs.startEnforcement(b),fs.startEnforcement(b)}),_!=null&&_.includes(Ss.SharedWebsocket)&&kt.registerIfNotConnected()))},[Re,It,z==null?void 0:z.kind,_]);const Fe=_a(ue,z),{handleFileAccepted:co}=Xa(G,Wt(ue,z),Ye,"mouse",I,Fe==null?void 0:Fe.attachments),{getInputProps:lo,open:uo}=wa({disabled:c||!Ke||Xe,noClick:!0,onDropAccepted:co,onDropRejected:b=>Ja(b,G,$e),multiple:!0,maxSize:ka,maxFiles:Je,...Sa(lt)}),$s=Zn(_e),Ks=d.useCallback(()=>{h.eraseContent(),$s.clearMessages(),h.resize(du),Sr();for(const b of Ce)He.remove(b.tempId,"none")},[Ce,$s,h]),dt=async(b,fe)=>{var on;if(b==null||b.preventDefault(),c||!Ze&&!fe||!z||Ne.isLoading(o)!==!1)return;const Ee=new Cs;U(!0);const Le=h.getContentToSend(),Qe=Le.content.replace(/[\u{E0000}-\u{E007F}]+/gu,""),Ge=`${q}-nextPrompt`,et=Rr({namespace:xn.CompletionRequest,key:Ge,opts:{expectedTimingLogs:[{name:"prompt_submitted",expectedInMs:3e3}]}}),{content:Co,attachments:an}=Er(Qe,ue,z),ss=[];Ws&&ss.push(Zo(Ws));const ns={...z};"gizmo"in ns&&delete ns.gizmo;const ht=h.getSystemHints();ht.includes(ot.Search)?pn.addPersistedSystemHint(ot.Search):re.has(ot.Search)&&ht.push(ot.Search);let gt={promptId:Ge,content:Co,eventMetadata:{eventSource:b?"mouse":"keyboard"},completionMetadata:{suggestions:m,conversationMode:ns,systemHints:ht},messageMetadata:{...an.length>0&&{attachments:an},...me&&{gizmo_id:me==null?void 0:me.gizmo.id},...B,...ht.length>0&&{system_hints:ht},...!!Le.metadata&&{serialization_metadata:Le.metadata}},appendMessages:ss.length>0?ss:void 0,turnTracker:Ee};gt=Ar(gt),W!=null&&W.createNewCompletionParams&&(gt=await W.createNewCompletionParams(gt)),et.logTiming("request_params_ready"),await e(gt),(on=W==null?void 0:W.onCreateCompletion)==null||on.call(W,{serverThreadId:Y,currentLeafId:q}),(W==null?void 0:W.shouldPersistAcrossMessages)!==!0&&jt(void 0),gn.hideThreadHeader(),Ks(),U(!1),et.logTiming("prompt_submitted"),Nr({namespace:xn.CompletionRequest,key:Ge}),m!==void 0&&(ze.logEvent("chatgpt_prompt_ignore_suggestions"),D.logEvent(N.promptIgnoreSuggestions))},Ys=d.useRef(dt);d.useLayoutEffect(()=>{Ys.current=dt}),d.useEffect(()=>$o.subscribe(Ko.SEND_PROMPT,({prompt:b})=>{h.setText(b),Ys.current(void 0,!0)}),[h]);const mo=b=>{jt(b.targetedReply),b.targetedReply&&(h.focus(),D.logEvent(N.targetedReplyButtonClicked,{conversationId:Y,sourceMessageId:b.messageId}))},Zs=d.useCallback(()=>{var b;(b=W==null?void 0:W.onCleared)==null||b.call(W,{serverThreadId:Y,currentLeafId:q}),jt(void 0),h.focus()},[q,Y,W,jt,h]),Js={Enter:{validator:b=>{const fe=b.isComposing||b.keyCode===229,Ee=ge&&De.current;return Re&&!Ee&&(b.metaKey||(Q||Jo)&&!b.shiftKey&&!fe)},handler:b=>{b.preventDefault(),dt()}},Escape:{validator:b=>!b.isComposing,handler:b=>{f&&r&&(t("",K),D.logEvent(N.pauseCompletion,{threadId:w.getServerThreadId(o),currentLeafId:w.getTree(o).getMessageId(q),eventSource:"keyboard"})),b.target.value===""&&Zs()}}},ut=d.useRef(Js);ut.current=Js;const Xs=d.useRef(null),mt=Gc(ro,z==null?void 0:z.kind),[ts,Mt]=d.useState(!1),Rt=mt&&ts,Qs=h.isReady();d.useEffect(()=>h.subscribe("keydown",b=>{var Le,Qe;h.acceptLegacyKeydown()&&((Le=ut.current[b.key])!=null&&Le.validator(b))&&ut.current[b.key].handler(b);const Ee=h.getCurrentText();if(b.key==="@"){const Ge=h.getSelectionStart(),et=Ee.substring(0,Ge);(!et||/\s$/.test(et)||Ge===0)&&((Qe=Xs.current)==null||Qe.handleClose(),setTimeout(()=>Mt(!0),10))}else ts&&Mt(!1);b.key==="Escape"&&(st(null),Pe(!1))}),[h,Qs,ts]),d.useEffect(()=>{const b=Object.fromEntries(Object.keys(ut.current).map(fe=>[fe,Le=>{const Qe=ut.current[fe];if(!Qe||h.acceptLegacyKeydown())return!1;const{validator:Ge,handler:et}=Qe;return Ge(Le)?(et(Le),!0):!1}]));h.registerKeyHandlers(b)},[h,Qs]),d.useEffect(()=>h.subscribe("paste",b=>{br({event:b,intl:G,clientThreadId:o,conversationMode:z,currentModelConfig:ue,getEditorGizmoId:I,modelSupportedImageMimeTypes:Ye})}),[G,o,z,ue,I,Ye,h]);const fo=b=>{de||st(b),h.trimLeadingText("@"),Vt(),Mt(!1)},ho=Ld(o,_e,G,Ye,Fe==null?void 0:Fe.attachments),go=d.useCallback(()=>{t("",K),D.logEvent(N.pauseCompletion,{threadId:w.getServerThreadId(o),currentLeafId:w.getTree(o).getMessageId(q),eventSource:"mouse"}),Vt()},[t,o,K,q]),en=d.useCallback(()=>{hn.set(R==null?void 0:R.id,Y,h.getCurrentText())},[Y,R==null?void 0:R.id,h]);d.useEffect(()=>{H||x||h.focus()},[x,h]),d.useEffect(()=>{H||He.reset()},[n,H]),d.useEffect(()=>{(!mt&&me||de)&&st(null)},[mt,me,de]);const[po,xo]=(()=>{switch(u){case"workspaceDisallowsGizmo":return[Ae.disallowedByWorkspacePlaceholder,!0];case"feedbackRequired":return[Ae.disabledFeedbackPlaceholder,!0];case"noModelsAvailable":return[Ae.noModelsAvailablePlaceholder,!0];case"requiresPluginsToBeInstalled":return[Ae.requiresPluginsToBeInstalled,!0];case"loadingPlugins":return[Ae.loading,!0];case"noTestGizmoId":return[Ae.noTestGizmoId,!0];default:return v?[Ae.continueSharedConversationPlaceholder,!1]:(W==null?void 0:W.placeholderTextOverride)!=null?[W.placeholderTextOverride,!1]:[Ae.placeholderWithName,!1]}})(),yo=G.formatMessage(po,{name:H!=null?te==="magic"?qc:H.name||"GPT":(ke==null?void 0:ke.gizmo.display.name)??"ChatGPT"});d.useEffect(()=>h.subscribe("input",()=>{wr.getState().isThreadHeaderVisible&&gn.hideThreadHeader(),Pe(!0)}),[h]),d.useEffect(()=>{if(j)return h.subscribe("input",()=>{j==null||j()})},[h,j]),d.useEffect(()=>{if(k)return h.subscribe("change",()=>{k==null||k()})},[h,k]),d.useEffect(()=>h.subscribe("focus",()=>{Pe(!0)}),[h]);const _o={clientThreadId:o,uploadType:$e,modelAcceptedMimeTypes:lt,modelSupportedImageMimeTypes:Ye,attachmentsProductFeature:Fe==null?void 0:Fe.attachments,getInputProps:lo,openFileDialog:uo,historyDisabled:V,onOauthRedirect:en,highlightTooltip:M&&!ae},tn=!c&&!Xe&&Ke&&a.jsx(Jd,{..._o}),vo=ae&&a.jsxs(a.Fragment,{children:[te==="magic"&&a.jsx("div",{className:"m-2 mb-0 rounded-lg bg-token-main-surface-secondary p-2 text-xs text-token-text-secondary",children:a.jsx(O,{...Ae.gizmoKnowledgeWarning})}),a.jsx(mu,{files:Ce,className:"flex flex-nowrap gap-2 overflow-x-auto pb-1.5 pt-[7px]"})]}),So=xo?"disabled":"default",Et=r&&f?"streaming":!Re||x?"disabled":"idle",ft=d.useRef(null),at=d.useRef(null),{layer:bo}=Yo("387752763"),wo=bo.get("enable_slash_commands",!1);d.useEffect(()=>{const b=()=>{ft.current!=null&&je.addAction("composer_state_disabled",{threadId:w.getServerThreadId(o),disabledReason:ft.current})};if(Ze&&Et==="disabled"){let fe="unknown";c?fe=u??"component_disabled_unknown":r?fe="completion_in_progress":ne?fe="thread_hard_blocked":x&&(fe="starting_new_completion_request"),ft.current!==fe&&(at.current&&clearTimeout(at.current),at.current=setTimeout(b,uu)),ft.current=fe}else ft.current=null;return()=>{at.current&&(clearTimeout(at.current),at.current=null)}},[o,Ze,Et,c,u,r,ne,x]);const At=[];if(W!=null&&W.label&&At.push({type:W.type,value:W.label,onRemoveRegion:Zs}),re!=null&&re.has(ot.Search)&&At.push({type:"system_hint",value:G.formatMessage(hu.searchMode),icon:a.jsx(Lc,{className:"icon-md"}),onRemoveRegion:()=>{pn.removePersistedSystemHint(ot.Search),h.focus()}}),me!==null){const b=!!((nn=me.gizmo.tags)!=null&&nn.includes(Ra.FirstParty));At.push({type:"mention",value:me.gizmo.display.name,icon:a.jsx(sl,{isFirstParty:b,src:me.gizmo.display.profile_picture_url,className:"icon-md"}),onRemoveRegion:()=>{st(null),h.focus()}})}d.useEffect(()=>{(!T||T.length===0||!ge)&&(De.current=!1)},[T,ge]);const ko=(b,fe,Ee)=>{De.current=b>=0,fe&&h.setText(Ee?`${Ee.title}${Ee.body}`:"")};return d.useEffect(()=>{Rt?F==null||F():E==null||E()},[Rt,F,E]),a.jsxs(kr.Provider,{value:_e,children:[a.jsx(Cr,{onOauthRedirect:en,children:a.jsx("form",{className:l,onSubmit:dt,children:a.jsxs("div",{className:"relative flex h-full max-w-full flex-1 flex-col",children:[!C&&a.jsx(ld,{className:S}),a.jsxs("div",{ref:y,className:"group relative flex w-full items-center",children:[i&&"from_template_row"in J.query&&a.jsx("button",{type:"button",onClick:()=>{J.push("/",void 0,{shallow:!0})},className:"mr-2 flex h-8 w-8 items-center justify-center text-token-text-tertiary hover:text-token-text-secondary",children:a.jsx(Oc,{className:"icon-lg"})}),mt&&!!Y&&a.jsx(Gl,{ref:Xs}),Rt&&a.jsx("div",{className:$("absolute bottom-16 w-full space-y-2",hs.TagGpt),children:a.jsx($c,{onClick:b=>fo(b),onClose:()=>{Mt(!1),h.focus()}})}),wo&&a.jsx("div",{className:$("absolute bottom-16 space-y-2",hs.TagGpt),children:a.jsx(lu,{composerController:h,clientThreadId:o})}),a.jsx(Xd,{type:V?"temporary":"default",ref:P,replyRegions:At,placeholder:yo,inputState:So,composerController:h,icon:tn,state:Et,onSubmit:Et==="streaming"?go:dt,renderFiles:vo,currentLeafId:q,clientThreadId:o,gizmoId:ke==null?void 0:ke.gizmo.id}),ge&&T&&T.length>0&&!Rt&&h.canShowAutocompletion()&&a.jsx("div",{className:$("absolute left-0 top-full z-10 mt-2 box-border w-full bg-token-main-surface-primary",tn?"px-8":"pl-0"),children:a.jsx(ql,{suggestions:T,composerController:h,onSelect:p,onChange:ko})})]}),a.jsx(Ir,{composerController:h,parsedDocumentHandler:ho})]})})}),a.jsx(Md,{canUseInlineTagging:mt,isDisabled:c,clientThreadId:o,currentLeafId:q,currentRequestId:K,canContinue:g,composerController:h,setPromptInputMetadata:se,suggestions:m,isNewThread:i,onCreateNewCompletion:e,onContinueGenerating:s,onResetState:Ks,conversationMode:z}),z!=null&&Tr.includes(z.kind)&&a.jsx(jr,{onTargetedReply:mo})]})}const hu=we({searchMode:{id:"LSO1pB",defaultMessage:"Search the web"}});function gu(t){const e=d.useContext(Xo);return({id:n,requestedModelId:o,eventMetadata:i,focusOnNewCompletion:r=!0,variantPurpose:l="none",useDefaultModel:c,appendMessages:u,conversationMode:f,juice:g=void 0,turnTracker:m})=>{const y=w.getTree(t).getParentPromptNode(n).id;e({type:Ve.Variant,promptId:y,requestedModelId:o,eventMetadata:i,cancelActiveRequests:!1,focusOnNewCompletion:r,useDefaultModel:c,completionMetadata:{variantPurpose:l,conversationMode:f,juice:g},appendMessages:u,turnTracker:m})}}function pu(t){var o,i,r,l,c;const e=((o=t.message)==null?void 0:o.author.role)===pe.User,s=((i=t.metadata)==null?void 0:i.err)!=null&&((r=t.metadata)==null?void 0:r.errCode)!==yt.ContentPolicy,n=((l=t.metadata)==null?void 0:l.errCode)===yt.ModelIncompatibility;return((c=t.metadata)==null?void 0:c.canRetry)===!1||n?!1:e||s}function Hm(t){return t.composerController?a.jsx(Dn,{...t,composerController:t.composerController}):a.jsx(fl,{children:e=>a.jsx(Dn,{...t,composerController:e})})}function Dn({clientThreadId:t,isNewThread:e,currentModelId:s,showPromptStarters:n,onRequestCompletion:o,composerContainerRef:i,composerController:r,setComposerBarElement:l}){const c=_c(),u=Pr(),f=rt(g=>{const m=Ne.getCurrentNode(t,g);return pu(m)});return!u&&f?a.jsx(xu,{clientThreadId:t}):a.jsxs(a.Fragment,{children:[a.jsx(Ol,{clientThreadId:t}),a.jsx(Zc,{clientThreadId:t,isStaticSharedThread:c,showInlineEmbeddedDisplay:!1,withVerticalPadding:!1,withHorizontalPadding:!0,children:a.jsx(Jc,{children:a.jsx(yu,{composerContainerRef:i,composerController:r,clientThreadId:t,currentModelId:s,isNewThread:e,showPromptStarters:n,setComposerBarElement:l,onRequestCompletion:o})})})]})}function xu({clientThreadId:t}){const e=gu(t),s=rt(i=>{var l;return((l=Ne.getCurrentNode(t,i).metadata)==null?void 0:l.errCode)===ps}),n=Dr(i=>i.isoDate),o=ct(t);return s&&n!=null&&n!==""?null:a.jsxs("div",{children:[a.jsx("div",{className:"mb-3 text-center text-xs",children:a.jsx(O,{...Fn.errorGeneratingResponse})}),a.jsx("div",{className:"flex items-center md:mb-4",children:a.jsx(wt,{as:"button",color:"primary",onClick:()=>{const i=new Cs;e({id:o,eventMetadata:{eventSource:"mouse"},conversationMode:Ne.getConversationMode(t),turnTracker:i})},className:"m-auto",icon:Ba,children:a.jsx(O,{...Fn.regenerateResponse})})})]})}function yu({clientThreadId:t,currentModelId:e,isNewThread:s,onRequestCompletion:n,showPromptStarters:o,composerContainerRef:i,composerController:r,autocompletions:l,requiresFileUpload:c,onComposerInput:u,onComposerChange:f,onAutocompleteSelect:g,headerClassName:m,hideHeader:v,setComposerBarElement:y,onTaggingDropdownClose:h,onTaggingDropdownOpen:T}){var lt,Ce;const M=ct(t),j=Qt(t),k=ha(),{isUnauthenticated:p}=bt(),C=vc(t)===Qo.PENDING,P=Sc({clientThreadId:t,conversationLeafId:M}),F=Is(j),E=(F||C)&&!P,R=ct(t),ee=!p,G=ta(),{isOpen:q,onClose:K}=Fr(),J=d.useCallback((_e,ae)=>{D.logEvent(N.continueCompletion),n({type:Ve.Continue,promptId:_e,eventMetadata:{eventSource:"mouse"},cancelActiveRequests:!1,completionMetadata:{conversationMode:Ne.getConversationMode(t)},turnTracker:ae})},[n,t]),H=sa(),te=d.useCallback(async(_e,ae)=>{var Je;const Te=w.getServerThreadId(t);kt.stopConversation(Te);const nt=w.getTree(t);!nt.hasReceivedServerCompletion&&!G&&((Je=nt.getParent(ae).metadata)==null?void 0:Je.errCode)!==yt.ContentPolicy&&setTimeout(()=>{xs.onCreateFinished(H,Te,G)},500),Te&&ze.checkGate("3922476776")&&await We.stopConversationProcess(Te),As.abortRequest(ae)&&w.updateTree(t,Xe=>{const Re=w.getThreadCurrentLeafId(t);Xe.updateNodeMessageMetadata(Re,{finish_details:{type:"interrupted"}})})},[t,G,H]),I=d.useCallback(async({promptId:_e,content:ae,eventMetadata:Te,completionMetadata:nt,messageMetadata:Ze,appendMessages:Je,turnTracker:Xe})=>{const Re=w.getThreadCurrentLeafId(t);w.updateTree(t,It=>{It.addNode(_e,ae,Re,pe.User,void 0,Ze)}),await n({type:Ve.Next,promptId:_e,eventMetadata:Te,cancelActiveRequests:!0,completionMetadata:nt,appendMessages:Je,turnTracker:Xe})},[t,n]),_=bc(t,M),Q=wc(t,M),V=!P&&(F||C),Z=d.useMemo(()=>V?!1:!_&&Q,[_,Q,V]),Y=V&&e!=="gpt-4-pbrowse",de=kc(t),re=Da(t),ne=Ls(re).data,{promptStarters:B,isSuccess:se}=Xc(s&&!de,t,4),x=xa(),U=(()=>{var _e,ae;if((x==null?void 0:x.messageId)===((ae=(_e=w.getTree(t).getLastValidNode(M))==null?void 0:_e.message)==null?void 0:ae.id))return x==null?void 0:x.suggestions;if(o&&!de&&se&&!ee)return B})(),ge=w.getTree(t),Pe=ge.countMessagesByAuthor(pe.User),De=d.useRef(),Ue=d.useRef();let ue=!1;De.current==Pe&&Ue.current==R?ue=!0:De.current!==Pe&&Ue.current!==R&&(ue=!0,De.current=Pe,Ue.current=R);const z=ge.getNodeByIdOrMessageId(M),ke=ue&&((lt=z==null?void 0:z.message)==null?void 0:lt.author.role)==pe.Assistant&&bs(z.message),me=il(),st=ei(),$e=(()=>{var Te;if(((Te=ne==null?void 0:ne.gizmo.tags)==null?void 0:Te.includes(Ra.WorkspaceDisabled))&&!st)return"workspaceDisallowsGizmo";if(me.size){if(k.displayingSideBySideFeedback&&k.unskippable)return"feedbackRequired"}else return"noModelsAvailable";const ae=Ne.getConversationMode(t);return(ae==null?void 0:ae.kind)===ve.GizmoTest&&ae.gizmo_id==null?"noTestGizmoId":null})(),Ct=Cc(t),Ke=Ds(t),Ye=(Ce=ti("15117983"))==null?void 0:Ce.value;return a.jsxs(a.Fragment,{children:[(s||ke)&&q?a.jsx(Lr,{onClose:K}):null,Ye&&Ke&&Ke.kind===ve.PrimaryAssistant&&Ke.plugin_ids&&Ke.plugin_ids.length>0?a.jsx(_u,{}):a.jsx(fu,{composerContainerRef:i,composerController:r,clientThreadId:t,onCreateNewCompletion:I,onAbortCompletion:te,onContinueGenerating:J,currentModelId:e,isNewThread:s,isCompletionInProgress:E,className:"w-full",canContinue:Z,suggestions:U??[],disabled:!!$e,disabledReason:$e??void 0,canPause:Y,isInteractableSharedThread:Ct,autocompletions:l,requiresFileUpload:c,onComposerInput:u,onComposerChange:f,onAutocompleteSelect:g,headerClassName:m,hideHeader:v,setComposerBarElement:y,onTaggingDropdownClose:h,onTaggingDropdownOpen:T},t)]})}function _u(){return a.jsxs("div",{className:"mx-auto flex max-w-md flex-col items-center justify-center gap-2 rounded-xl border border-token-border-light bg-token-main-surface-primary p-6 shadow-lg",children:[a.jsx("span",{className:"text-token-text-primary",children:a.jsx(O,{id:"PluginsDecrepatedNotice.pluginsDeprecationTitle",defaultMessage:"Conversations with plugins are archived"})}),a.jsx("span",{className:"text-token-text-secondary",children:a.jsx(O,{id:"PluginsDecrepatedNotice.pluginsDeprecationSubtitle",defaultMessage:"Explore GPT Store to find a replacement"})}),a.jsxs("a",{href:"https://chat.openai.com/gpts",className:"text-green-500 hover:cursor-pointer dark:text-green-400",children:[a.jsx(O,{id:"PluginsDecrepatedNotice.pluginsDeprecationGptStoreLink",defaultMessage:"Explore GPTs"}),a.jsx("span",{className:"ml-2",children:a.jsx(O,{id:"PluginsDecrepatedNotice.pluginsDeprecationGptStoreLinkArrow",defaultMessage:"→"})})]})]})}const Fn=we({errorGeneratingResponse:{id:"PromptTextarea.errorGeneratingResponse",defaultMessage:"There was an error generating a response"},regenerateResponse:{id:"PromptTextarea.regenerateResponse",defaultMessage:"Regenerate"}}),vu=le(()=>ie(()=>import("./i92drs6rowd2f4bs.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26])).then(t=>t.default)),Su=le(()=>ie(()=>import("./sso-dlecoq29tbbucwzg.js").then(t=>t.e),__vite__mapDeps([27,1,2,3,24,16,12,5,6,7,28,10,21,22,29,13,25,15,30,31,23,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,19,62,63,64,65,18,66,67,68,69,70,71,72,73,74,4,8,9,11,14,75])).then(t=>t.default).catch(()=>es)),bu=Me.div`flex gap-2 flex-wrap mt-1 max-w-[80%] justify-end`,wu=Me.div`flex flex-col gap-2`,ku=({parts:t,attachments:e,isUserTurn:s,clientThreadId:n})=>{const o=Kt(),i=Os(n),r=zs(),l=si.getImageAssetPointersFromParts(t),c=new Set(l.map(y=>Jt(y.asset_pointer))),f=Zt()||o,g=(e??[]).filter(y=>ga(y.name)),m=(e??[]).filter(y=>y.id==null||c.has(y.id)?!1:r||i?!g.includes(y):!0);return(r||i?(m.length>0||g.length>0)&&s:m.length>0&&s)?a.jsxs(a.Fragment,{children:[a.jsxs(bu,{children:[m.map(y=>a.jsx(Ea,{file:y.name,fileId:y.id,contextConnectorInfo:Or(y.context_connector_info),width:o?"normal":"wide",alwaysShowData:!0},y.id)),i&&g.map(y=>a.jsx(Su,{visualization:yn(y)},y.id))]}),r&&!i&&a.jsx(wu,{className:$(!f&&"w-[80%]"),children:g.map(y=>a.jsx(vu,{clientThreadId:n,visualization:yn(y)},y.id))})]}):null};function Qa(t){return bs(t)&&!ni(t)}const Bt=50,Cu=95;function Iu(t,e){if(t<=e)return t/e*Bt;{const s=Bt,n=Cu-Bt,o=t-e,r=-(Bt/e)/n;return s+n*(1-Math.exp(r*o))}}class Tu{constructor(){L(this,"mostRecentCompletionRequest");L(this,"loggedRequestIds",new Set)}onCompletionRequestStarted(e){this.mostRecentCompletionRequest={requestId:e,timestamp:Date.now()}}onDisplayTextAfterBrowsingSession(e,s){const n=this.mostRecentCompletionRequest;if(n!=null&&!this.loggedRequestIds.has(n.requestId)){const i=w.getThreadConversationTurns(e,s).find(r=>r.messages.some(l=>l.message.id===s));i!=null&&i.messages.some(r=>r.nodeId===n.requestId)&&(D.logEvent(N.browsingTimeToFirstTextToken,{messageId:s,timeMs:Date.now()-n.timestamp}),this.loggedRequestIds.add(n.requestId))}}}const eo=new Tu;function ju(t){var o;const e=t.find(i=>{var r;return((r=i.message.metadata)==null?void 0:r.image_search_results)!==void 0});return(((o=e==null?void 0:e.message.metadata)==null?void 0:o.image_search_results)??[]).slice(0,5)}function Mu({messages:t}){const e=ju(t),s=Br();return e.length===0?null:a.jsx("div",{className:$({"mb-2":!0,"grid grid-flow-col gap-3":e.length>1,"w-1/3":e.length===1}),children:e.filter(({contentUrl:n})=>s.has(n)).map((n,o)=>a.jsx("a",{href:n.hostPageUrl,target:"_blank",rel:"noreferrer",children:a.jsx("img",{src:n.contentUrl,alt:n.name,className:"aspect-square rounded-xl object-cover"})},o))})}const Ru=le(()=>ie(()=>import("./sso-dlecoq29tbbucwzg.js").then(t=>t.f),__vite__mapDeps([27,1,2,3,24,16,12,5,6,7,28,10,21,22,29,13,25,15,30,31,23,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,19,62,63,64,65,18,66,67,68,69,70,71,72,73,74,4,8,9,11,14,75])).then(t=>t.default).catch(()=>es));function to({attachments:t,citations:e,contentReferences:s,className:n,clientThreadId:o,displayParts:i,id:r,isActivelyStreaming:l,isUserTurn:c,turnIndex:u,isFeedbackEnabled:f,messages:g,onRequestMoreCompletions:m,parts:v,prevGroupedMessageType:y,prevGroupedMessages:h,showEditButton:T,onEnterEdit:M,size:j="medium"}){var E,R;const k=Os(o),p=g.length>1,{flagSeverity:S,shouldHideContent:C}=qa(p?void 0:g[0]),P=!v.some(ee=>ee!==""),F=((E=g[0].message.metadata)==null?void 0:E.targeted_reply_label)??((R=g[0].message.metadata)==null?void 0:R.targeted_reply);return d.useEffect(()=>{!P&&y===A.Browsing&&eo.onDisplayTextAfterBrowsingSession(o,g[0].message.id)},[P,g,o,y]),a.jsxs("div",{"data-message-author-role":g[0].message.author.role,"data-message-id":g[0].message.id,dir:"auto",className:$(n,"text-message flex w-full flex-col items-end gap-2 whitespace-normal break-words [.text-message+&]:mt-5"),children:[F&&a.jsxs("div",{className:"mb-1 mt-1 flex items-start gap-1.5 text-sm font-normal text-token-text-tertiary",children:[a.jsx(Fs,{className:"icon-md mt-1 shrink-0"}),a.jsx("p",{className:"mr-5 line-clamp-3",children:F})]}),c&&k&&a.jsx(Ru,{messages:g}),a.jsx(zr,{messages:g}),a.jsx(Eu,{parts:v,attachments:t,isUserTurn:c,turnIndex:u,displayParts:i,isActivelyStreaming:l,shouldHideContent:C,showEditButton:T,onEnterEdit:M,clientThreadId:o,id:r,isEmpty:P,prevGroupedMessageType:y,prevGroupedMessages:h,flagSeverity:S,messages:g,citations:e,contentReferences:s,size:j}),a.jsx(hl,{message:p?void 0:g[0],id:r,isFeedbackEnabled:f,onRequestMoreCompletions:m,clientThreadId:o,isUserTurn:c}),a.jsx(Ur,{isUserTurn:c,message:p?void 0:g[0]}),!c&&!l&&h&&y===A.SearchResult&&a.jsx(Mu,{messages:h})]})}function Eu({clientThreadId:t,id:e,displayParts:s,turnIndex:n,isActivelyStreaming:o,shouldHideContent:i,showEditButton:r=!1,onEnterEdit:l,isEmpty:c,prevGroupedMessageType:u,prevGroupedMessages:f,messages:g,citations:m,contentReferences:v,size:y,isUserTurn:h,parts:T,attachments:M}){var H,te;const j=oe(),k=Gr(s),p=qr(),S=(H=g[0].message.metadata)==null?void 0:H.gizmo_id,C=(te=g[0].message.metadata)==null?void 0:te.serialization_metadata,P=Ic(g[0].message).length,F=d.useMemo(()=>({clientThreadId:t,messageId:e,turnIndex:n}),[t,e,n]),E=Hr(g[0].message),R=!!S&&p.includes(S),ee=d.useCallback(I=>{Vr.open(I,n,e)},[n,e]),G=a.jsx(ku,{parts:T,attachments:M,isUserTurn:h,clientThreadId:t},"files-and-tables"),q=!!(M!=null&&M.length||s.some(I=>I.type==="images")),K=s.map((I,_)=>{var Q;if(I.type==="transcription"){const V=i?null:I.text;let Z=null;return h&&i?Z=a.jsx("span",{className:"italic opacity-30",children:a.jsx(O,{...zt.contentRemoved})}):h&&V!=null?Z=V.trim().length===0?a.jsx("span",{className:"italic opacity-30",children:a.jsx(Dt,{text:j.formatMessage(zt.transcriptUnavailable),customSymbolOffsets:void 0})}):a.jsx("span",{className:"italic opacity-65",children:a.jsx(Dt,{text:`“${V.trim()}”`,customSymbolOffsets:void 0})}):!h&&V!=null&&(Z=a.jsx(Dt,{text:V,customSymbolOffsets:void 0})),a.jsx(os,{containsImagesOrAttachments:q,isUserTurn:h,showEditButton:r,onEnterEdit:l,children:Z},_)}else if(I.type==="text"){const V=i?null:I.text;if(!c&&!i&&!h){const Z=u===A.CodeInterpreter?f==null?void 0:f.map(B=>B.message):void 0,{text:Y,contentReferences:de}=Wr(k,m,v,R),{processedText:re,displayedContentReferences:ne}=$r(Y,de,o?void 0:Z);return a.jsx(Kr.Provider,{value:{analyticsMetadata:F,message:g[0].message,contentReferences:ne,onShowSearchResults:ee,numImageResults:P,isActivelyStreaming:o,useSafeUrls:!0},children:a.jsx(Ns,{clientThreadId:t,messageId:e,size:y,className:$(o&&"result-streaming",E&&"headers-v2"),children:re===""?"&#8203;":re})},_)}else if(c&&o&&!h)return a.jsx("div",{className:"result-streaming",children:a.jsx("div",{children:a.jsx("pre",{})})},_);return a.jsx(os,{containsImagesOrAttachments:q,isUserTurn:h,showEditButton:r,onEnterEdit:l,children:h&&i?a.jsx("span",{className:"italic opacity-30",children:a.jsx(O,{...zt.contentRemoved})}):V?a.jsx(Dt,{text:V,customSymbolOffsets:C==null?void 0:C.custom_symbol_offsets}):null},_)}else if(I.type==="images"){const V=((Q=g[0].message.metadata)==null?void 0:Q.attachments)??[];return a.jsx(Yr,{assets:I.imageAssets,attachments:V},_)}else return null}),J=s.findIndex(I=>I.type==="text");if(J!==-1?K.splice(J,0,G):K.push(G),i&&h)K.length=0,K.push(a.jsx(os,{containsImagesOrAttachments:q,isUserTurn:h,onEnterEdit:ms,children:a.jsx("span",{className:"italic opacity-30",children:a.jsx(O,{...zt.contentRemoved})})}));else if(i&&!h)return null;return a.jsx("div",{className:$("flex w-full flex-col gap-1 empty:hidden",h&&"items-end rtl:items-start",!h&&"first:pt-[3px]"),children:K})}const zt=we({contentRemoved:{id:"textMessage.contentRemoved",defaultMessage:"Content removed"},transcriptUnavailable:{id:"textMessage.transcriptUnavailable",defaultMessage:"Transcript Unavailable"}});function Au(t){var u;const{isActivelyStreaming:e,...s}=t,n=Qn(),o=(n==null?void 0:n.includes("debug"))??!1,i=t.messages[t.messages.length-1].message.id,[r,l]=d.useState([]),c=d.useRef();return c.current===void 0&&(c.current=(n==null?void 0:n.includes(ai))??!1?new Zr(t.parts,l,e,void 0,{debug:o}):new Jr(t.parts,l,e)),d.useEffect(()=>{c.current!=null&&(c.current.onMessagePartsUpdated(t.parts,e),c.current.isBuffering()&&pt.addDelayedRenderingMessage(i))},[t.parts,i,e]),d.useEffect(()=>{c.current!=null&&!c.current.isBuffering()&&pt.removeDelayedRenderingMessage(i)},[r,i]),d.useEffect(()=>()=>pt.removeDelayedRenderingMessage(i),[i]),d.useEffect(()=>()=>{c.current!=null&&(c.current.destroy(),c.current=void 0)},[]),a.jsx(to,{...s,displayParts:r,isActivelyStreaming:e||((u=c.current)==null?void 0:u.isBuffering())})}function Nu({message:t,isCompletionInProgress:e,clientThreadId:s,className:n,isUserTurn:o,turnIndex:i,isFeedbackEnabled:r,prevGroupedMessageType:l,prevGroupedMessages:c,showEditButton:u,onEnterEdit:f,onRequestMoreCompletions:g}){var v,y,h;const m=d.useMemo(()=>"parts"in t.message.content?t.message.content.parts:[na(t.message)],[t]);return a.jsx(Du,{parts:m,messages:[t],isCompletionInProgress:e,className:n,citations:(v=t.message.metadata)==null?void 0:v.citations,contentReferences:(y=t.message.metadata)==null?void 0:y.content_references,attachments:(h=t.message.metadata)==null?void 0:h.attachments,isUserTurn:o,turnIndex:i,id:t.nodeId,isFeedbackEnabled:r,onRequestMoreCompletions:g,clientThreadId:s,showEditButton:u,onEnterEdit:f,prevGroupedMessageType:l,prevGroupedMessages:c})}const Pu=oi.memo(Nu);function Du(t){const e=t.messages.length>1,{flagSeverity:s}=qa(e?void 0:t.messages[0]),n=s!=="danger"&&t.isCompletionInProgress,o=!t.parts.some(r=>r!==""),[i]=d.useState(()=>!t.isUserTurn&&(t.isCompletionInProgress||o));return i?a.jsx(Au,{...t,isActivelyStreaming:n}):a.jsx(to,{...t,displayParts:Xr({isUserTurn:t.isUserTurn,parts:t.parts}),isActivelyStreaming:n})}const Fu=le(()=>ie(()=>import("./fivpi7mcjmrk4ygn.js"),__vite__mapDeps([76,1,2,3])));function so({animationData:t,animationSegmentToPlay:e,animationLoopCounter:s}){const n=d.useRef(null);return d.useEffect(()=>{var o;(o=n.current)==null||o.playSegments(e,!0)},[s]),a.jsx(Fu,{animationData:t,lottieRef:n,loop:!1,autoplay:!1})}function Lu(t){return a.jsx(Ps,{width:"8",height:"9",viewBox:"0 0 8 9",fill:"none",...t,children:a.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M7.66607 0.376042C8.01072 0.605806 8.10385 1.07146 7.87408 1.4161L3.54075 7.9161C3.40573 8.11863 3.18083 8.24304 2.93752 8.24979C2.69421 8.25654 2.46275 8.1448 2.31671 7.95008L0.150044 5.06119C-0.098484 4.72982 -0.0313267 4.25972 0.300044 4.01119C0.631415 3.76266 1.10152 3.82982 1.35004 4.16119L2.88068 6.20204L6.62601 0.584055C6.85577 0.239408 7.32142 0.146278 7.66607 0.376042Z",fill:"currentColor"})})}function Ou(t){return a.jsxs(Ps,{width:"4",height:"12",viewBox:"0 0 4 12",fill:"none",...t,children:[a.jsx("mask",{id:"path-1-inside-1_1975_4008",fill:"currentColor",children:a.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M1 6.5C1 7.05228 1.44772 7.5 2 7.5C2.55228 7.5 3 7.05228 3 6.5V1.5C3 0.947715 2.55228 0.5 2 0.5C1.44772 0.5 1 0.947715 1 1.5L1 6.5ZM0.75 10.25C0.75 10.9404 1.30964 11.5 2 11.5C2.69036 11.5 3.25 10.9404 3.25 10.25C3.25 9.55964 2.69036 9 2 9C1.30964 9 0.75 9.55964 0.75 10.25Z"})}),a.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M1 6.5C1 7.05228 1.44772 7.5 2 7.5C2.55228 7.5 3 7.05228 3 6.5V1.5C3 0.947715 2.55228 0.5 2 0.5C1.44772 0.5 1 0.947715 1 1.5L1 6.5ZM0.75 10.25C0.75 10.9404 1.30964 11.5 2 11.5C2.69036 11.5 3.25 10.9404 3.25 10.25C3.25 9.55964 2.69036 9 2 9C1.30964 9 0.75 9.55964 0.75 10.25Z",fill:"currentColor"}),a.jsx("path",{d:"M1 6.5H-0.25H1ZM1 1.5L-0.25 1.5L-0.25 1.5L1 1.5ZM2 6.25C2.13807 6.25 2.25 6.36193 2.25 6.5H-0.25C-0.25 7.74264 0.757359 8.75 2 8.75V6.25ZM1.75 6.5C1.75 6.36193 1.86193 6.25 2 6.25V8.75C3.24264 8.75 4.25 7.74264 4.25 6.5H1.75ZM1.75 1.5V6.5H4.25V1.5H1.75ZM2 1.75C1.86193 1.75 1.75 1.63807 1.75 1.5H4.25C4.25 0.257359 3.24264 -0.75 2 -0.75V1.75ZM2.25 1.5C2.25 1.63807 2.13807 1.75 2 1.75V-0.75C0.757359 -0.75 -0.25 0.257359 -0.25 1.5L2.25 1.5ZM2.25 6.5L2.25 1.5L-0.25 1.5L-0.25 6.5L2.25 6.5ZM2 10.25H-0.5C-0.5 11.6307 0.619288 12.75 2 12.75V10.25ZM2 10.25V12.75C3.38071 12.75 4.5 11.6307 4.5 10.25H2ZM2 10.25H2H4.5C4.5 8.86929 3.38071 7.75 2 7.75V10.25ZM2 10.25H2V7.75C0.619288 7.75 -0.5 8.86929 -0.5 10.25H2Z",fill:"currentColor",mask:"url(#path-1-inside-1_1975_4008)"})]})}function Bu(t){return a.jsx(Ps,{width:"8",height:"9",viewBox:"0 0 8 9",fill:"none",...t,children:a.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M7.32256 1.48447C7.59011 1.16827 7.55068 0.695034 7.23447 0.427476C6.91827 0.159918 6.44503 0.199354 6.17748 0.515559L4.00002 3.08892L1.82256 0.515559C1.555 0.199354 1.08176 0.159918 0.765559 0.427476C0.449355 0.695034 0.409918 1.16827 0.677476 1.48447L3.01755 4.25002L0.677476 7.01556C0.409918 7.33176 0.449354 7.805 0.765559 8.07256C1.08176 8.34011 1.555 8.30068 1.82256 7.98447L4.00002 5.41111L6.17748 7.98447C6.44503 8.30068 6.91827 8.34011 7.23447 8.07256C7.55068 7.805 7.59011 7.33176 7.32256 7.01556L4.98248 4.25002L7.32256 1.48447Z",fill:"currentColor"})})}function Vm({animationLoopCounter:t}){const{resolvedTheme:e}=aa(),s=e==="dark";return a.jsx(so,{animationData:s?Qr:ec,animationSegmentToPlay:[0,300],animationLoopCounter:t})}function Wm({animationLoopCounter:t}){const{resolvedTheme:e}=aa(),s=e==="dark";return a.jsx(so,{animationData:s?tc:sc,animationSegmentToPlay:[0,400],animationLoopCounter:t})}const zu=2e3,no=.4,Uu=.45,Gu=.2,qu=.1,Hu=.25;var Se=(t=>(t[t.Running=0]="Running",t[t.Finished=1]="Finished",t[t.Error=2]="Error",t[t.Stopped=3]="Stopped",t[t.Paused=4]="Paused",t))(Se||{});function $m({conversationMessages:t,icon:e,status:s,text:n,estimatedToolDurationMs:o,animationLoopDurationMs:i=zu,shouldPersistAfterFinished:r=!1}){const[l,c]=d.useState(s===0?0:s===1&&!r?7:1),[u,f]=d.useState(0);d.useEffect(()=>{s===2?c(8):s===3?c(9):s===4?c(10):s===1?c(l===2?3:7):s===0&&l===10&&(c(2),f(m=>m+1))},[s]);const g=$u(l);return d.useEffect(()=>{const m=t[0].message.id;if(g)return pt.addDelayedRenderingMessage(m),()=>{pt.removeDelayedRenderingMessage(m)}},[g]),Aa(()=>{it(l)&&f(m=>m+1)},i),l===7&&!r?null:a.jsxs("div",{className:"my-2.5 flex items-center gap-2.5",children:[a.jsx(Vu,{icon:e,status:s,uiState:l,estimatedToolDurationMs:o,animationLoopCounter:u,shouldPersistAfterFinished:r,onFillProgressBarAnimationComplete:()=>c(4),onFinishAnimationComplete:()=>{c(5),setTimeout(()=>{c(r?7:6)},qu*1e3)},onHideAnimationComplete:()=>c(7)}),a.jsx(Wu,{text:n,uiState:l,animationLoopCounter:u,onEnterAnimationComplete:()=>c(2)})]})}const Ln=50;function Vu({icon:t,status:e,uiState:s,estimatedToolDurationMs:n,animationLoopCounter:o,shouldPersistAfterFinished:i,onFillProgressBarAnimationComplete:r,onFinishAnimationComplete:l,onHideAnimationComplete:c}){const[u,f]=d.useState(0);Aa(()=>{it(s)?f(j=>j+Ln):s===10&&f(0)},Ln);let g,m,v;it(s)||s===10?(g="running",m=a.jsx(t,{animationLoopCounter:o}),v="bg-transparent"):s===4||s===5||s===7&&i?(g="finished",m=a.jsx(Lu,{}),v="bg-brand-purple"):e===2?(g="error",m=a.jsx(Ou,{}),v="bg-orange-500"):e===3&&(g="stopped",m=a.jsx(Bu,{}),v="bg-gray-300");let y={opacity:0,scale:0,rotate:-180,x:0},h={type:"spring",bounce:.3,duration:Uu},T={opacity:0,scale:.6,rotate:0,x:0};s===0?(y={opacity:0,scale:.5,rotate:-180,x:-8},h={type:"spring",bounce:.3,duration:no}):s===1?y=!1:s===5&&(T={opacity:0,scale:0,rotate:0,x:0},h={type:"spring",bounce:.3,duration:Hu});const M=Iu(u,n);return a.jsx("div",{className:"relative h-5 w-5 shrink-0",children:a.jsx(_t,{onExitComplete:()=>{s===6&&c()},children:g!=null&&a.jsxs(be.div,{className:$("absolute left-0 top-0 flex h-full w-full items-center justify-center rounded-full text-white",v),initial:y,animate:{opacity:1,scale:1,rotate:0,x:0},exit:T,transition:h,onAnimationComplete:()=>{s===4&&l()},children:[m,(it(s)||s===10)&&a.jsx(nc,{percentage:s===3?100:M,thickness:1.5/23,className:"absolute left-1/2 top-1/2 h-[23px] w-[23px] -translate-x-1/2 -translate-y-1/2 text-brand-purple",backgroundStrokeClassName:"stroke-brand-purple/25 dark:stroke-brand-purple/50",transitionDuration:s===3?`${(100-M)/100*Gu}s`:void 0,transitionTimingFunction:s===3?"cubic-bezier(0.55, 0, 1, 1)":void 0,onTransitionEnd:()=>{s===3&&r()}})]},g)})})}function Wu({text:t,uiState:e,animationLoopCounter:s,onEnterAnimationComplete:n}){const[o,i]=d.useState(t);d.useEffect(()=>{e===2&&i(t)},[s]),d.useEffect(()=>{it(e)||i(t)},[e,t]);let r={opacity:0,x:0,y:15},l={type:"spring",bounce:.3,opacity:{duration:.15},y:{duration:.3}};e===0?(r={opacity:0,x:-8,y:0},l={type:"spring",bounce:.3,duration:no,delay:.15}):e===1&&(r=!1);const c=o??void 0;return a.jsx("div",{className:$("relative h-5 w-full leading-5",e===8||e===9?"text-token-text-tertiary":"text-token-text-secondary"),children:a.jsx(_t,{children:c!=null&&a.jsx(be.div,{className:"absolute left-0 top-0 line-clamp-1 overflow-visible",initial:r,animate:{opacity:1,x:0,y:0},exit:{opacity:0,x:0,y:-15},transition:l,onAnimationComplete:()=>{e===0&&n()},children:c},c.toString())})})}function it(t){return t===0||t===2||t===3}function $u(t){return it(t)||t===4||t===5||t===6||t===10}function Vs({highlightedCommand:t,status:e,children:s,showWorkUserSetting:n=!1,hideOnlyIfNotInteractedWith:o=!1}){const i=s!=null,[r]=d.useState(n),[l,c]=d.useState(n),[u,f]=d.useState(!1);return(e===Se.Finished||e===Se.Error)&&(o?r?!1:!u:!1)?null:i?a.jsxs(a.Fragment,{children:[a.jsx(On,{$canShowWork:!0,children:a.jsx(_t,{children:a.jsx(be.button,{onClick:()=>{c(v=>!v),f(!0)},initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},className:$(e===Se.Running&&"loading-shimmer","group absolute left-0 top-0 mr-1.5 h-8 overflow-hidden"),children:a.jsxs("div",{className:"flex items-center justify-start gap-1",children:[a.jsx("span",{children:t}),l?a.jsx(Bc,{className:"icon-md group-hover:visible md:invisible"}):a.jsx(Oa,{className:"icon-md group-hover:visible md:invisible"})]})},t==null?void 0:t.toString())})}),a.jsx(_t,{children:l&&s&&a.jsx(be.div,{initial:"collapsed",animate:"reveal",exit:"collapsed",variants:{collapsed:{translateY:-20,opacity:0,height:0},reveal:{translateY:0,opacity:1,height:"auto"}},transition:{duration:.3,ease:"easeInOut"},className:"overflow-hidden",children:s})})]}):a.jsx(On,{$canShowWork:!1,children:t})}const On=Me.p`first:mt-0 my-1.5 relative h-8
${({$canShowWork:t})=>t?"text-token-text-secondary hover:text-token-text-primary":"text-token-text-secondary"}`,Ku=le(()=>ie(()=>import("./sso-dlecoq29tbbucwzg.js").then(t=>t.e),__vite__mapDeps([27,1,2,3,24,16,12,5,6,7,28,10,21,22,29,13,25,15,30,31,23,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,19,62,63,64,65,18,66,67,68,69,70,71,72,73,74,4,8,9,11,14,75])).then(t=>t.default).catch(()=>es)),Bn=le(()=>ie(()=>import("./i92drs6rowd2f4bs.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26])).then(t=>t.default));function Yu({messages:t,isRequestActive:e,clientThreadId:s}){var T,M,j;const[n,o]=t,i=Qa(n.message),r=(T=o==null?void 0:o.message.metadata)==null?void 0:T.aggregate_result,l=xd(),c=zs(),u=Os(s),f=o!=null&&o.message?Ka(o.message):[],g=((j=(M=o==null?void 0:o.message.metadata)==null?void 0:M.aggregate_result)==null?void 0:j.messages.filter(Ha))??[],v=(f.filter(k=>k.type==="chart")??[]).length!==g.length,y=c&&!v;let h=Se.Running;return(r==null?void 0:r.status)==="success"?h=Se.Finished:o!=null&&o.message.content.content_type!==Yt.ExecutionOutput||r!=null&&r.status!=="running"?h=Se.Error:(i||!e)&&(h=Se.Stopped),a.jsxs(a.Fragment,{children:[a.jsx(Zu,{messages:t,status:h,isRequestActive:e}),y&&f.map((k,p)=>{const{file_id:S,type:C}=k;return u?a.jsx(Ku,{isStreaming:h===Se.Running,visualization:k},S):C==="chart"&&!l?(k.fallback_to_image=!0,a.jsx(zn,{children:a.jsx(Bn,{clientThreadId:s,visualization:k})},p)):a.jsx(zn,{children:a.jsx(Bn,{clientThreadId:s,visualization:k})},p)}),!y&&o!=null&&a.jsx(gl,{message:o.message})]})}const zn=Me.div`mb-3 max-w-[80%]`;function Zu({messages:t,status:e,isRequestActive:s}){var g;const[n,o]=t,i=oe(),r=(g=o==null?void 0:o.message.metadata)==null?void 0:g.aggregate_result,l=Qa(n.message),{data:c,error:u}=ii(ri.ShowExpandedCodeView);let f=i.formatMessage({id:"message.tools.data-analysis.running",defaultMessage:"Analyzing"});if((r==null?void 0:r.status)==="success"?f=i.formatMessage({id:"message.tools.data-analysis.finished",defaultMessage:"Analyzed"}):o!=null&&o.message.content.content_type!==Yt.ExecutionOutput||r!=null&&r.status!=="running"?f=i.formatMessage({id:"message.tools.data-analysis.error",defaultMessage:"Analysis errored"}):(l||!s)&&(f=i.formatMessage({id:"message.tools.data-analysis.stopped",defaultMessage:"Analysis paused"})),c!==void 0||u){const m=pl(n.message)!=null;return a.jsx(Vs,{status:e,highlightedCommand:f,showWorkUserSetting:c??!1,hideOnlyIfNotInteractedWith:!0,children:m?a.jsxs("div",{className:"mb-3 mt-0.5 overflow-hidden rounded-xl bg-black",children:[a.jsx(xl,{message:n.message,FormattedText:Ns}),o!=null&&a.jsx(yl,{message:o.message})]}):null})}return null}function Ju({nextMessage:t,isLastMessage:e,isRequestActive:s}){if(e||(t==null?void 0:t.message.content.content_type)===Yt.Text&&!(t!=null&&t.message.content.parts.some(o=>o.length>0))){const o=s?a.jsx(O,{id:"O+zD9o",defaultMessage:"Searching..."}):a.jsx(O,{id:"fssXGM",defaultMessage:"Error while searching"});return a.jsx(Vs,{highlightedCommand:o,status:s?Se.Running:Se.Error,children:o})}return null}const Xu={strong:t=>{const{node:e,children:s,...n}=t;return a.jsx("strong",{...n,className:$(n.className,"font-medium text-token-text-primary"),children:s})},p:t=>{const{node:e,children:s,...n}=t;return a.jsx("p",{...n,className:$(n.className,"text-base","has-[strong]:mb-1 has-[strong]:mt-3 [&:not(:has(strong))]:mb-3"),children:s})}};function Qu({messages:t,isStreaming:e}){var c,u;const[s,n]=d.useState(""),[o,i]=d.useState(!1),r=t[0].message,l=na(r);return d.useEffect(()=>{var v;const f=/\*\*(.*?)(?:\*\*|\n|$)/g;let g,m="";for(;(g=f.exec(l))!=null;)m=g[1].trim();m?n(m):((v=r.metadata)==null?void 0:v.initial_text)!=null&&n(r.metadata.initial_text)},[l,(c=r.metadata)==null?void 0:c.initial_text]),d.useEffect(()=>{l.length>0&&i(!0)},[l]),a.jsx(Vs,{status:e?Se.Running:Se.Finished,highlightedCommand:e?s:((u=r.metadata)==null?void 0:u.finished_text)??"",children:o?a.jsx("div",{className:"my-4 border-l-2 pl-4",children:a.jsx(Ns,{componentOverrides:Xu,className:"not-prose leading-6",children:l})}):null})}const em=le(()=>ie(()=>import("./sso-dlecoq29tbbucwzg.js").then(t=>t.g),__vite__mapDeps([27,1,2,3,24,16,12,5,6,7,28,10,21,22,29,13,25,15,30,31,23,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,19,62,63,64,65,18,66,67,68,69,70,71,72,73,74,4,8,9,11,14,75])).then(t=>t.default).catch(()=>es)),tm=le(()=>ie(()=>import("./ixx8cnuni2mmv3rj.js"),__vite__mapDeps([77,1,2,3,5,6,12,7,15,16,17,18,19,20,10,21,22,23,24,14,25,26]))),sm=le(()=>ie(()=>import("./kz8rnqdvs1s0dz6o.js"),__vite__mapDeps([78,1,2,3]))),nm=le(()=>ie(()=>import("./gczrpqc7l3i1lmyi.js"),__vite__mapDeps([79,1,2,3,5,6,12,7,15,16,17,18,19,20,10,21,22,23,24,14,25,26]))),am=le(()=>ie(()=>import("./rohh4xbqmrtmi7o1.js"),__vite__mapDeps([80,1,2,3,5,6,12,7])).then(t=>t.TextMessageEditor)),om=le(()=>ie(()=>import("./d7xkeud1t7ujmb8b.js"),__vite__mapDeps([81,1,2,3,5,6,7,12,15,16,17,18,19,20,10,21,22,23,24,14,25,26]))),im=le(()=>ie(()=>import("./gq3s2kqgt70nz8mr.js"),__vite__mapDeps([82,1,2,3,5,6,12,7,15,16,17,18,19,20,10,21,22,23,24,14,25,26]))),rm=le(()=>ie(()=>import("./fz32q2oa1uqdxjtu.js"),__vite__mapDeps([83,1,2,3,5,6,46,25,15,16,12,7,48,17,18,19,20,10,21,22,23,24,14,26])).then(t=>t.BrowsingMessage)),cm=le(()=>ie(()=>import("./llc15xt3hq2xh1tb.js"),__vite__mapDeps([84,1,2,3,46,5,6,12,7,15,16,17,18,19,20,10,21,22,23,24,14,25,26])).then(t=>t.SearchResultMessage)),lm=le(()=>ie(()=>import("./ii28oytv201d0g2x.js"),__vite__mapDeps([85,1,2,3,5,6,15,16,12,7,18,19])).then(t=>t.GizmoContactsMessage)),dm=le(()=>ie(()=>import("./l1nj0s854oa5h446.js"),__vite__mapDeps([86,1,2,3,5,6,15,16,12,7,25,17,18,19,20,10,21,22,23,24,14,26])).then(t=>t.JITPluginMessage));function Km(t){switch(t.type){case A.Text:case A.Debug:return[t.message];case A.MultiText:case A.Browsing:case A.CodeInterpreter:case A.JITPlugin:case A.RetrievalBrowsing:case A.ParallelBrowsing:case A.Dalle:case A.GizmoEditor:case A.SearchResult:case A.GizmoContacts:case A.a8km123:case A.Canmore:case A.SearchGPTQuery:return t.messages;default:throw new Error("Bad")}}function Ym({groupedMessagesToRender:t,allGroupedMessages:e,clientThreadId:s,isEditing:n,isUserTurn:o,isCompletionRequestInProgress:i,isFeedbackEnabled:r,isFinalTurn:l,turnIndex:c,hasActiveRequest:u,showEditButton:f=!1,handleEnterEdit:g,handleExitEdit:m,onChangeItemInView:v,onRequestMoreCompletions:y,onRequestCompletion:h,shouldGrowContainer:T=!0}){const{showDebugConversationTurns:M}=Ma(),j=Ds(s),k=t.map((p,S)=>{var P,F,E,R,ee,G,q,K,J,H,te,I;const C=S===e.length-1;switch(p.type){case A.Text:case A.MultiText:{const _=t[S-1],Q=_==null?void 0:_.type,V=_&&"messages"in _?_.messages:void 0;if(p.type===A.Text){const Z=n?a.jsx(am,{message:p.message,clientThreadId:s,onChangeItemInView:v,onRequestCompletion:h,onRequestMoreCompletions:y,onExitEdit:m,disabled:u}):a.jsx(Pu,{className:"min-h-[20px]",message:p.message,isFeedbackEnabled:r,isCompletionInProgress:C&&i,turnIndex:c,clientThreadId:s,showEditButton:f,onEnterEdit:g,isUserTurn:o,onRequestMoreCompletions:y,prevGroupedMessageType:Q,prevGroupedMessages:V});return a.jsxs(d.Fragment,{children:[Z,a.jsx(ac,{isUserTurn:o,message:p.message.message})]},"group-"+p.message.nodeId)}else return p.type===A.MultiText?a.jsx(nm,{clientThreadId:s,messages:p.messages,isCompletionInProgress:C&&i,isFeedbackEnabled:r,onRequestMoreCompletions:y,prevGroupedMessageType:Q,prevGroupedMessages:V},"multitext-"+(((P=p.messages[0])==null?void 0:P.nodeId)??S)):p.type}case A.Browsing:case A.RetrievalBrowsing:{const _=j!=null&&[ve.GizmoInteraction,ve.GizmoMagicCreate,ve.GizmoTest].includes(j.kind);return a.jsx(rm,{messages:p.messages,isRequestActive:u,isLastMessageInTurn:C,isUsingGizmo:_,isRetrieval:p.type===A.RetrievalBrowsing},"browsing-"+(((F=p.messages[0])==null?void 0:F.nodeId)??S))}case A.SearchGPTQuery:{const _=e[S+1];return a.jsx(Ju,{isRequestActive:u,isLastMessage:C,nextMessage:_&&_.type===A.Text?_.message:void 0},"searchquery-"+(((E=p.messages[0])==null?void 0:E.nodeId)??S))}case A.a8km123:return a.jsx(Qu,{messages:p.messages,isStreaming:C&&i},"sum-"+(((R=p.messages[0])==null?void 0:R.nodeId)??S));case A.ParallelBrowsing:return a.jsx(im,{messages:p.messages},"parallel-"+(((ee=p.messages[0])==null?void 0:ee.nodeId)??S));case A.CodeInterpreter:return a.jsx(Yu,{messages:p.messages,isRequestActive:u,clientThreadId:s},"ada-"+(((G=p.messages[0])==null?void 0:G.nodeId)??S));case A.JITPlugin:return a.jsx(dm,{messages:p.messages,clientThreadId:s,isLastTurnInConversation:l,onRequestCompletion:h},"jit-"+(((q=p.messages[0])==null?void 0:q.nodeId)??S));case A.GizmoContacts:return a.jsx(lm,{messages:p.messages,clientThreadId:s,isLastTurnInConversation:l,onRequestCompletion:h},"gizmo-contacts-"+(((K=p.messages[0])==null?void 0:K.nodeId)??S));case A.Dalle:return a.jsx(om,{messages:p.messages,clientThreadId:s},"dalle-"+(((J=p.messages[0])==null?void 0:J.nodeId)??S));case A.GizmoEditor:return a.jsx(tm,{messages:p.messages},"gizmo-editor-"+(((H=p.messages[0])==null?void 0:H.nodeId)??S));case A.Canmore:return a.jsx(em,{messages:p.messages,isRequestActive:u},"canmore-"+(((te=p.messages[0])==null?void 0:te.nodeId)??S));case A.Debug:return M?a.jsx(sm,{message:p.message},"debug-"+p.message.nodeId):null;case A.SearchResult:return a.jsx(cm,{messages:p.messages},"search-result-"+(((I=p.messages[0])==null?void 0:I.nodeId)??S))}});return a.jsx(mm,{shouldGrowContainer:T,children:k})}function um(){return a.jsx(oc,{type:"danger",children:a.jsx(O,{id:"daIg0P",defaultMessage:"Unable to display this message due to a error."})})}function mm({children:t,shouldGrowContainer:e}){return a.jsx("div",{className:$({"flex max-w-full flex-col":!0,"flex-grow":e}),children:a.jsx(ci,{name:"GroupedMessages",fallback:um,children:t})})}function Un(t,e){t.updateNodeMetadata(e.id,{completionSampleFinishTime:Date.now()})}class fm{constructor(e,s,n,o,i,r,l,c,u,f,g,m){L(this,"currentTree");L(this,"currentNodeId");L(this,"firstResponse",!0);L(this,"didCreateFirstCompletionInNewThread",!1);L(this,"activeBranchLastMessage");L(this,"messagesToUpdate",{});L(this,"allIncompleteStreamedMessages",{});L(this,"responseThreadId");L(this,"isCompletionBlocked",!1);L(this,"isEitherFlagged",!1);L(this,"variantsInStreamInfo");L(this,"activeBranchNodeId");L(this,"blurDuringCompletionTracker",new rc);L(this,"completionLatencyTracker");L(this,"turnTracker");L(this,"debouncedUpdateCompletion",cc(()=>{this.isCompletionBlocked||w.updateTree(this.clientThreadId,e=>{Object.values(this.messagesToUpdate).forEach(s=>{e.updateNodeMessage(s.id,s)})}),this.messagesToUpdate={}},50,{leading:!0,maxWait:50}));L(this,"handleResponse",async e=>{if(this.turnTracker.onUpdateEventCount(),this.completionLatencyTracker.onResponse(e,this.activeBranchLastMessage,this.responseThreadId),this.responseThreadId===void 0&&"conversationId"in e){const s=e.conversationId;this.responseThreadId=s,La(this.clientThreadId)&&w.getServerThreadId(this.clientThreadId)!==s&&(w.setServerIdForNewThread(this.clientThreadId,s),D.logEvent(N.attributeClientThreadToServerThread,{client_thread_id:this.clientThreadId,server_thread_id:s}))}switch(e.type){case"error":this.handleError(e);break;case"num_variants_in_stream":this.bindVariantInfoToTree(e);break;case"moderation":this.handleModeration(e);break;case"url_moderation":this.handleUrlModeration(e);break;case"message":this.handleMessage(e),this.debouncedUpdateCompletion();break;case"done":this.handleDone();break;case"gizmo_inline_review":this.handleGizmoInlineReview(e);break;case"title_generation":this.handleTitleGeneration(e);break;case"conversation_detail_metadata":this.handleConversationDetailMetadata(e);break}});this.queryClient=e,this.clientThreadId=s,this.targetNodeId=n,this.completionType=o,this.model=i,this.eventSource=r,this.navigate=l,this.callModelAgain=u,this.onCompletionFinished=f,this.isHistoryAndTrainingDisabled=m,this.currentTree=w.getTree(s),this.currentNodeId=n,this.activeBranchLastMessage=this.currentTree.getMessage(this.currentNodeId),this.completionLatencyTracker=new ic(c),this.turnTracker=g,this.turnTracker.onCompletionStarted(o,this.model)}handleError(e){const s=e.error,n=(s==null?void 0:s.message)||"Something went wrong",o=s instanceof Be&&s.code||"",i=s instanceof Be&&s.status,r=s instanceof Be?s.canRetry:void 0;let l;switch(i===400||n==="NetworkError when attempting to fetch resource."||n==="The network connection was lost."?l="network_error":n==="Request timed out"?l="timeout":l="request_failed",this.turnTracker.onError({reason:l,message:n,...i&&{status_code:i}}),w.updateTree(this.clientThreadId,c=>{c.updateNodeMessage(this.currentNodeId,this.activeBranchLastMessage),c.updateNodeMetadata(this.currentNodeId,{err:n,errType:"danger",errCode:o,completionSampleFinishTime:Date.now(),canRetry:r})}),o){case yt.ContentPolicy:case yt.ContentOrTos:case ps:case li:break;default:n!==void 0&&ze.logEvent("chatgpt_conversation_error_web",n)}this.blurDuringCompletionTracker.onMessageError(),this.cleanUp(),this.onCompletionFinished(this.responseThreadId),s instanceof Be&&(s==null?void 0:s.code)===ps&&(s!=null&&s.clearsIn)&&(lc(new Date(Date.now()+s.clearsIn*1e3).toISOString()),setTimeout(()=>{dc()},s.clearsIn*1e3))}handleGizmoInlineReview(e){w.setPromptGptRating(this.clientThreadId,e.gizmoId)}handleTitleGeneration(e){w.setTitle(this.clientThreadId,e.title,Pa.Generated)}handleConversationDetailMetadata(e){const{default_model_slug:s}=e;s&&w.setThreadModelId(this.clientThreadId,s),us.updateDetails(e)}bindVariantInfoToTree(e){this.variantsInStreamInfo=e,w.updateTree(this.clientThreadId,s=>{const n=s.getParentPromptNode(this.currentNodeId);s.updateNodeMetadata(n.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}handleModeration(e){const{isCompletion:s,messageId:n,conversationId:o,flagged:i,blocked:r,disclaimers:l,metadata:c}=e,u=!!(l!=null&&l.length)&&s;(i||r||u)&&(this.isEitherFlagged=!0,r&&s&&(this.isCompletionBlocked=!0),w.updateTree(this.clientThreadId,f=>{const g=f.messageIdToNodeId(n);r&&f.clearNodeMessageParts(g),f.updateNodeMetadata(g,{...(u&&!!(l!=null&&l.length)&&di(l,r))??{},...i&&ui,...r&&(c!=null&&c.model_incompatibility?mi:fi),completionSampleFinishTime:Date.now()})}),D.logEvent(s?r?N.completionBlockedByModeration:N.completionFlaggedByModeration:r?N.promptBlockedByModeration:N.promptFlaggedByModeration,{threadId:o,id:n}))}handleUrlModeration(e){const{conversationId:s,url:n,isSafe:o}=e;o&&w.addThreadSafeUrl(s,n)}handleMessage(e){var i,r,l,c,u,f,g,m,v,y,h,T,M;let s=!0;const{message:n,conversationId:o}=e;if((n==null?void 0:n.author.role)===pe.Tool?this.turnTracker.onMessageUpdate((i=n.metadata)==null?void 0:i.model_slug,(r=n.metadata)==null?void 0:r.gizmo_id,n.author.name):this.turnTracker.onMessageUpdate((l=n.metadata)==null?void 0:l.model_slug,(c=n.metadata)==null?void 0:c.gizmo_id,void 0),this.firstResponse&&!this.currentTree.hasReceivedServerCompletion){if((n==null?void 0:n.author.role)===pe.System){const j=(u=n.metadata)!=null&&u.parent_id?this.currentTree.getNodeByIdOrMessageId(n.metadata.parent_id):void 0;if((j==null?void 0:j.message.author.role)!==pe.User){this.currentTree.appendSystemMessageToRoot(n);return}}else if((n==null?void 0:n.author.role)===pe.User)return;if(this.currentTree.hasNodeOrMessageId(n.id))return}if(this.firstResponse&&((f=n.metadata)!=null&&f.rebase_system_message)){w.updateTree(this.clientThreadId,j=>{var p;if(((p=n.metadata)==null?void 0:p.parent_id)==null)throw Error("Unexpected rebased system message without parent");const k=j.getNodeByIdOrMessageId(this.targetNodeId);j.deleteNode(this.targetNodeId),j.addNode(n.id,n,n.metadata.parent_id,n.author.role),j.addNode(k.id,k.message,n.id,k.message.author.role)});return}if(this.firstResponse){const j=((g=rt.getState().threads[this.clientThreadId])==null?void 0:g.continuingFromSharedConversationId)!=null;w.removeContinuingFromSharedConversationId(this.clientThreadId),this.firstResponse=!1,this.didCreateFirstCompletionInNewThread=!this.currentTree.hasReceivedServerCompletion||j,w.updateTree(this.clientThreadId,p=>{p.updateNodeMessage(this.currentNodeId,n)}),this.didCreateFirstCompletionInNewThread&&xs.onCreate(this.navigate,o,this.queryClient,this.isHistoryAndTrainingDisabled);const k={id:this.targetNodeId,threadId:o,completionType:this.completionType,eventSource:this.eventSource,model:this.model};if(this.completionType===Ve.Next){const p=rt.getState().threads[o],S=(m=p==null?void 0:p.conversationTurns)==null?void 0:m.length,C=(v=p==null?void 0:p.conversationTurns)==null?void 0:v.filter(F=>F.role==pe.User),P=C&&((y=C[C.length-1])==null?void 0:y.messages[0].message);if((P==null?void 0:P.content.content_type)==Yt.Text){const F=P.content.parts.join("").length,E=(C==null?void 0:C.length)??0;k.countConversationTurns=S,k.countUserSubmittedMessages=E,k.countLastUserPromptTextMessageLength=F}}D.logEvent(N.generateCompletion,k)}else if(this.completionType!==Ve.Continue){const j=this.currentTree.containsNodeOrMessageId(n.id),k=(h=n.metadata)==null?void 0:h.parent_id;if(j||(this.debouncedUpdateCompletion.flush(),w.updateTree(this.clientThreadId,p=>{if(k==null)throw new Error(`Received a message with no parentId: ${JSON.stringify(n)}`);p.addNode(n.id,n,k,pe.Assistant)})),k!=null&&k===this.activeBranchNodeId){const p=this.allIncompleteStreamedMessages[k];p!=null&&(w.updateTree(this.clientThreadId,S=>{Un(S,p)}),delete this.allIncompleteStreamedMessages[k])}if(s=(((T=this.variantsInStreamInfo)==null?void 0:T.num_variants_in_stream)??1)===1||this.activeBranchNodeId==null||this.activeBranchNodeId===n.id||this.currentTree.isAncestorOfNode(this.activeBranchNodeId,n.id),s&&this.activeBranchNodeId!==n.id){this.activeBranchNodeId=n.id,this.currentNodeId=n.id;const p=w.getThreadCurrentLeafId(this.clientThreadId);this.currentTree.messageIdToNodeId(this.currentNodeId)!==this.currentTree.messageIdToNodeId(p)&&w.setThreadCurrentLeafId(this.clientThreadId,this.currentNodeId),k!=null&&w.updateTree(this.clientThreadId,S=>{const C=S.getParentPromptNode(n.id);S.updateNodeMetadata(C.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}}if((n==null?void 0:n.author.role)===pe.Tool&&(n==null?void 0:n.author.name)==="bio"){const j=(M=n.metadata)==null?void 0:M.gizmo_id;setTimeout(()=>{this.queryClient.invalidateQueries({queryKey:uc(j)})},5e3)}s&&(this.activeBranchLastMessage=n),this.messagesToUpdate[n.id]=n,this.allIncompleteStreamedMessages[n.id]=n}async handleDone(){var e,s;if(this.turnTracker.onMessageDone(),this.isCompletionBlocked||(this.debouncedUpdateCompletion.flush(),this.isEitherFlagged||(this.didCreateFirstCompletionInNewThread&&xs.onCreateFinished(this.queryClient,this.responseThreadId,this.isHistoryAndTrainingDisabled),this.onCompletionFinished(this.responseThreadId))),w.updateTree(this.clientThreadId,n=>{Object.values(this.allIncompleteStreamedMessages).forEach(o=>{Un(n,o)})}),Na.publish({kind:"createConversation",clientThreadId:this.clientThreadId}),this.blurDuringCompletionTracker.onMessageDone(),this.cleanUp(),((s=(e=this.activeBranchLastMessage)==null?void 0:e.metadata)==null?void 0:s.client_actions)!==void 0){const n=await mc(this.clientThreadId,this.activeBranchLastMessage);n.length>0&&this.callModelAgain(this.currentNodeId,n)}}cleanUp(){setTimeout(()=>{As.removeRequest(this.targetNodeId),w.releaseThread(this.clientThreadId)},0)}}const hm=1e3*30,rs=oa.getTracer("completion"),cs=t=>(t==null?void 0:t.code)==="challenge_required";class ls extends Error{}function gm(t,e,s,n){const o=async(i=null,r=!1)=>{var G,q,K,J,H,te;await fc();const l=new AbortController,c="threadId"in e?e.threadId:void 0,u="continueFromSharedConversationId"in e?e.continueFromSharedConversationId:void 0,f=hi(),g={action:e.completionType,messages:e.messages.length>0?e.messages:void 0,conversation_id:c,continue_from_shared_conversation_id:c!=null?void 0:u,parent_message_id:e.parentMessageId,model:e.model,timezone_offset_min:new Date().getTimezoneOffset(),variant_purpose:(G=e.completionMetadata)==null?void 0:G.variantPurpose,suggestions:(q=e.completionMetadata)!=null&&q.suggestions?e.completionMetadata.suggestions.map(I=>Qc(I)):void 0,history_and_training_disabled:e.historyDisabled,juice:(K=e.completionMetadata)==null?void 0:K.juice,conversation_mode:(J=e.completionMetadata)==null?void 0:J.conversationMode,force_paragen:e.forceParagen,force_paragen_model_slug:e.forceParagenModel,force_nulligen:e.forceNulligen,force_indepth_feedback:e.forceIndepthFeedback,force_rate_limit:e.forceRateLimit,reset_rate_limits:e.resetRateLimits,disable_system_content_toggling:e.disableSystemContentToggling,websocket_request_id:f,source:(H=e.completionMetadata)==null?void 0:H.source,system_hints:(te=e.completionMetadata)==null?void 0:te.systemHints,force_use_sse:!kt.isWebsocketConnected(),conversation_origin:e.conversationOrigin,force_use_search:e.forceUseSearch},m=qn(await Gn(t));let v="https://chatgpt.com/backend-api";m&&(v="https://chatgpt.com/backend-anon");const y=`${v}/conversation`;let h=!0,T=!0;const M=m?dn.getUnauthHeaders().additionalHeaders:await dn.getAuthedHeaders(),j=gi(e.chatReq,i??e.arkoseToken,e.turnstileToken,e.proofToken,null),k={...M,...hc(),...j};let p,S,C;rs.startActiveSpan("completion.response",I=>{p=rs.startSpan("completion.first_response"),S=rs.startSpan("completion.first_token"),C=I});const P=oa.setSpan(un.active(),C);function F(I){if(I.data==="[DONE]")l.abort(),C.end(),s({type:"done"}),_n();else if(I.event!=="ping")try{const _=JSON.parse(I.data);if(_.error){const Q=new qe(_.error);throw s({type:"error",error:Q}),Q}else"type"in _?_.type==="gizmo_inline_review"?s({type:"gizmo_inline_review",gizmoId:_.gizmo_id}):_.type==="title_generation"?s({type:"title_generation",title:_.title,conversation_id:_.conversation_id}):_.type==="moderation"?s({type:"moderation",conversationId:_.conversation_id,messageId:_.message_id,isCompletion:_.is_completion,flagged:_.moderation_response.flagged,blocked:_.moderation_response.blocked,disclaimers:_.moderation_response.disclaimers,metadata:_.moderation_response.metadata}):_.type==="url_moderation"?s({type:"url_moderation",conversationId:_.conversation_id,messageId:_.message_id,url:_.url_moderation_result.full_url,isSafe:_.url_moderation_result.is_safe}):_.type==="num_variants_in_stream"?s({type:"num_variants_in_stream",num_variants_in_stream:_.num_variants_in_stream,display_treatment:_.display_treatment}):_.type==="conversation_detail_metadata"&&s(_):(s({type:"message",message:_.message,conversationId:_.conversation_id}),T&&(T=!1,p.end()),h&&_.message.author.role==="assistant"&&_.message.content.content_type==="text"&&_.message.content.parts[0]!==""&&(h=!1,S.end()))}catch(_){if(_ instanceof Be)throw new qe(_.message)}}let E=null,R=setTimeout(()=>{E===!0?(D.logEvent(N.asyncResponseWaitTooLong,{}),e.turnTracker.onError({reason:"timeout",message:"Async Response Took Too Long to Come Back"})):E===!1&&(D.logEvent(N.sseResponseWaitTooLong,{}),e.turnTracker.onError({reason:"timeout",message:"SSE Response Took Too Long to Come Back"}))},hm);return Nl(f,F,l.signal),un.with(P,()=>gc(y,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...k},body:JSON.stringify(g),signal:l.signal,openWhenHidden:!0,async onopen(I){var V;const _=I.headers.get("content-type")??"",Q=I.headers.get("Cf-Ray")??null;if(I.ok&&_.includes("text/event-stream")){E=!1,n(Q,e.model,e.turnTracker);return}else if(_.includes("application/json")){const Z=await I.json(),{webSocketUrl:Y,fallbackWebSocketUrl:de,conversationId:re,responseId:ne,expiresAt:B,websocketRequestId:se}=Al(Z);if(Y!=null&&re!=null&&ne!=null&&se!=null&&B){E=!0,n(Q,e.model,e.turnTracker);try{await Pl(Y,de,B,re,ne,se,F,l.signal,R)}catch(x){x instanceof qe&&s({type:"error",error:x})}throw new ls}else{const x=(Z==null?void 0:Z.error)??(Z==null?void 0:Z.detail),U=(x==null?void 0:x.message)??x??"Unknown server error";if(x){if(cs(x))throw new Be(U,I.status,x.code);if(I.status>=500)throw new qe(U);{if(((x==null?void 0:x.code)==="expired_session_key"||(x==null?void 0:x.code)==="invalid_api_key"||(x==null?void 0:x.code)==="token_expired")&&typeof window<"u"&&((V=window._oaiHandleSessionExpired)==null||V.call(window,"stream",JSON.stringify(x))),(x==null?void 0:x.code)==="deactivated_workspace"){window.location.href.includes("/workspace/deactivated")||(window.location.href="/workspace/deactivated");return}const ge=x==null?void 0:x.can_retry;throw new Be(U,I.status,x==null?void 0:x.code,x==null?void 0:x.type,void 0,x==null?void 0:x.clears_in,ge)}}}}throw new qe(mn)},onmessage:I=>{if(E)throw new qe(mn);R&&(clearTimeout(R),R=null),F(I)},onerror(I){let _=I instanceof Error?I:new Error(JSON.stringify(I));throw _ instanceof ls||E||cs(_)&&!r||(_.message==="Failed to fetch"&&(_=new qe(`An error occurred. Either the engine you requested does not exist or there was another issue processing your request. ${ds}`)),_.message==="network error"&&(_=new Be(`A network error occurred. Please check your connection and try again. ${ds}`,400)),pi("fetch-error:conversation:new-message",{url:y,message:_==null?void 0:_.message}),s({type:"error",error:_}),_n(_)),_}})).catch(async I=>{if(cs(I)){if(r)throw new Be("Failed to complete your call, please try again",I.status);{const _=await Ht.getEnforcementToken(e.chatReq);return o(_,!0)}}I instanceof ls||je.addError(I)}),l};return o()}function Zm(t,e,s){const n=sa(),o=Jn(),i=d.useRef(s),r=ta();i.current=s;const l=d.useCallback(async function({model:c,completionType:u,parentNodeId:f,metadata:g,focusOnNewCompletion:m=!0,completionMetadata:v,chatReq:y,arkoseToken:h,turnstileToken:T,proofToken:M,preflightTime:j,extraStreamParams:k,appendMessages:p,updateTree:S,turnTracker:C}){var Z,Y,de,re,ne;Na.publish({kind:"requestCompletion"});const P=w.getTree(t);w.retainThread(t);const F=Tc(),E=`${xi}${t}-${F}`,R=`${t}-${F}`;S==null||S();const ee=P.getNodeByIdOrMessageId(f),q={gizmo_id:(Z=ee.message.metadata)==null?void 0:Z.gizmo_id};(v==null?void 0:v.juice)!=null&&(q.snorkle_status=1),w.updateTree(t,B=>{B.addNode(E,"",f,pe.Assistant,void 0,q)}),m&&w.setThreadCurrentLeafId(t,E);let K;const J=[];let H=P.getNodeByIdOrMessageId(ee.parentId);for(;H!=null&&(((Y=H.metadata)==null?void 0:Y.isPlaceholderTemplateAssistantWelcomeMessage)===!0||((de=H.metadata)==null?void 0:de.isClientCreatedSystemMessage)===!0);){const B=H.message;J.unshift(B);const se=P.getNodeByIdOrMessageId(H.parentId);K=((re=se.message)==null?void 0:re.id)??se.id,H=se}if(u===Ve.Next||u===Ve.Variant){const B=P.getNodeByIdOrMessageId(ee.parentId);if(K??(K=((ne=B.message)==null?void 0:ne.id)??B.id),J.push(ee.message),p){let se=f;w.updateTree(t,x=>{for(const U of p)x.insertNodeBefore(E,{id:U.id,message:U,parentId:se,children:[]}),se=U.id}),J.push(...p)}}else K??(K=ee.message.id);const te=w.getServerThreadId(t);te===void 0&&La(t)&&w.updateInitialThreadDataForNewThread(t,c);async function I(B,se){const x=performance.now(),U=await ea();Ht.initializeAndGatherData(U),gs.initializeAndGatherData(U),fs.initializeAndGatherData(U),w.updateTree(t,Ue=>{for(const ue of se)Ue.addNode(ue.id,ue,B,pe.Assistant,{completionSampleFinishTime:Date.now()}),B=ue.id}),w.setThreadCurrentLeafId(t,B);const ge=await Ht.getEnforcementToken(U),Pe=await gs.getEnforcementToken(U),De=await fs.getEnforcementToken(U);l({model:c,completionType:Ve.Next,parentNodeId:B,metadata:{},chatReq:U,arkoseToken:ge??null,turnstileToken:Pe??null,proofToken:De??null,preflightTime:performance.now()-x,extraStreamParams:k,turnTracker:C})}const _=new fm(n,t,E,u,c,g.eventSource,o,R,I,(...B)=>i.current(...B),C,r),Q=(B,se,x)=>{B&&x.onReceivedRequestId(B),pc(R,se,B,j)},V=await gm(n,{conversationOrigin:w.getConversationOrigin(t),model:c,completionType:u,threadId:te,continueFromSharedConversationId:e,historyDisabled:r,parentMessageId:K,messages:J,chatReq:y,arkoseToken:h??null,turnstileToken:T??null,proofToken:M??null,completionMetadata:v,...k,turnTracker:C},_.handleResponse,Q);As.addRequest(E,V,C),eo.onCompletionRequestStarted(E)},[t,n,o,e,r]);return l}export{Ja as A,Ym as C,qm as F,Wm as G,yu as P,Hm as T,Bm as a,Dm as b,xd as c,Om as d,Lm as e,Du as f,Ka as g,Se as h,Vs as i,Qa as j,ju as k,$m as l,Vm as m,Ll as n,Fm as o,bd as p,Bs as q,zm as r,Um as s,Gm as t,Zm as u,gu as v,Km as w,Dl as x,Sd as y,kt as z};
//# sourceMappingURL=ijiluygl0s0dhnj2.js.map
