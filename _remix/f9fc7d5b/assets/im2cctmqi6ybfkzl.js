import{r as C,V as H,l as c,be as Xe,X as z,R as Qe,m as Se,aK as _t,e1 as Ot,a0 as Ne,c$ as Pt,d0 as qt,d1 as $t,ec as Ht,f as dt,e as Ut,fH as Ze,d7 as Ke,u as mt,dc as Ft,dT as Bt}from"./ldmgmrz4k1q6ed5n.js";import{dv as Vt,fe as zt,j6 as Gt,O as ht,j7 as ue,j8 as J,c as fe,N as X,fo as O,i2 as de,a2 as Yt,j9 as Me,ja as pt,fr as pe,jb as Wt,jc as Jt,j2 as gt,j1 as Xt,av as _,c4 as Qt,cn as Zt,jd as Kt,je as en,jf as k,jg as tn,hV as vt,jh as nn,ji as sn,e as rn,jj as on,jk as an,jl as un,fd as ln,hE as cn,f9 as fn,hF as dn,fb as mn,dU as hn,jm as pn,jn as gn,jo as be,jp as vn,jq as Cn,jr as yn,fs as Tn,js as xn,jt as et}from"./il8crxbwclaclc75.js";import{C as wn,s as Y,g as En,t as bn,v as Sn,w as Mn,x as In,y as kn}from"./k0iy3jypcij2b2oo.js";import{e as An,C as Dn}from"./lmegw3rjgv3dh1wj.js";import{C as me,B as jn,S as B,H as tt}from"./g3wq8j6v4uohgg5p.js";import{m as W}from"./g93qmzmxf1wr9awg.js";import{D as Nn}from"./kq4fwdq12zsi8lay.js";import{bM as Rn,bE as Ln,Y as _n,bO as On,bP as Pn,az as qn,y as $n}from"./nfw6qo5mkhpyk7ym.js";import{i as Hn}from"./l7vwb921tthnn93e.js";import{l as Un,p as Fn,T as Bn,w as Vn,b as zn}from"./cbyvodb06ds84vgq.js";import{L as Gn,g as Yn,h as Wn,i as Jn}from"./f844xbyapk4dqhm2.js";import{P as Xn}from"./i90uh1dlzveuocly.js";import{q as Qn,a as Zn}from"./idw7sys1c2oa2i6c.js";import{u as Kn}from"./pdk8ihar956hg7zy.js";const es=({isTextdocStreaming:t,isRequestActive:e,value:n,comments:s})=>{const[r,o]=C.useState(!1);return C.useEffect(()=>{t&&r&&(o(!1),me.reset())},[n,s]),C.useEffect(()=>{e||(o(!1),me.reset())},[e]),[r,o]};function ts({onClickRestore:t,onClickResetLatest:e}){const n=H();return c.jsx(W.div,{initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{bounce:0,duration:.24},className:"absolute bottom-0 left-0 z-30 w-full items-center border-t border-gray-100 bg-token-main-surface-primary p-6 shadow-[0_-4px_32px_rgba(0,0,0,0.08)] @container dark:border-token-border-xlight dark:shadow-[0_-4px_32px_rgba(0,0,0,0.12)] lg:border-l",children:c.jsxs("div",{className:"mx-auto flex max-w-[48rem] flex-col flex-wrap justify-center gap-5 @2xl:flex-row @2xl:justify-between",children:[c.jsxs("div",{className:"flex flex-col px-2 text-center @2xl:text-start",children:[c.jsx("span",{className:"text-md text-wrap font-semibold",children:n.formatMessage({id:"gt23pb",defaultMessage:"You are viewing a previous version"})}),c.jsx("span",{className:"text-wrap text-sm text-token-text-secondary",children:n.formatMessage({id:"sAlUJn",defaultMessage:"Restore this version to make edits"})})]}),c.jsxs("div",{className:"flex flex-wrap items-center justify-center gap-4",children:[c.jsx(Xe,{as:"button",color:"primary",onClick:t,children:n.formatMessage({id:"+cddAb",defaultMessage:"Restore this version"})}),c.jsx(Xe,{as:"button",color:"secondary",onClick:e,children:n.formatMessage({id:"qCD3eu",defaultMessage:"Back to latest version"})})]})]})})}const ns={type:"spring",damping:35,stiffness:300},ss=({clientThreadId:t,turn:e})=>{const n=Vt(),s=zt(e.messages);return c.jsxs(W.div,{className:"absolute left-0 right-0 top-0 z-10 -translate-y-full",children:[c.jsx(W.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 bg-vert-light-gradient dark:bg-vert-dark-gradient"}),c.jsx(W.div,{className:"flex items-center px-6 py-2",initial:{opacity:.75,translateX:-50,translateY:"100%"},animate:{opacity:1,translateX:0,translateY:"0"},exit:{opacity:0,translateY:20},transition:ns,children:c.jsx(wn,{clientThreadId:t,onChangeItemInView:z,onRequestCompletion:async r=>z(r),onRequestMoreCompletions:z,groupedMessagesToRender:s,allGroupedMessages:s,isEditing:!1,isUserTurn:!0,turnIndex:0,isCompletionRequestInProgress:!1,isFeedbackEnabled:!1,isFinalTurn:!1,hasActiveRequest:n,showEditButton:!1,handleEnterEdit:z,handleExitEdit:z})})]},"user-message")},rs=({clientThreadId:t})=>{const e=Un(t),n=Fn(t,e),{lastUserTurn:s,lastAssistantTurn:r}=C.useMemo(()=>{let a=null,i=null;for(let l=n.length-1;l>0;l--){const u=n[l];if(!a&&u.role===Qe.User?a=u:!i&&u.role===Qe.Assistant&&(i=u),a&&i)break}return{lastUserTurn:a,lastAssistantTurn:i}},[n]),o=s&&!r?.messages.find(({message:a})=>a.recipient?.startsWith(Gt));return c.jsx(ht,{initial:!1,children:o&&c.jsx(ss,{turn:s,clientThreadId:t})})},os=({isRequestActive:t=!1,clientThreadId:e,onCancel:n,onSubmit:s,onSubmitAccelerator:r,acceleratorActions:o=[]})=>{const[a,i]=C.useState(""),[l,u]=C.useState(!0),f=H(),d=()=>{s?.(a),i("")},g=p=>{const{metaKey:m,shiftKey:h,key:y}=p;y==="Enter"&&a.trim()&&!(h||m)&&(d(),p.preventDefault())};return c.jsxs("div",{className:"relative mb-3 flex max-w-2xl flex-1 justify-center",children:[c.jsx(rs,{clientThreadId:e}),c.jsx("div",{className:"flex flex-auto items-start",children:c.jsx("div",{className:Se("mx-6 flex min-h-12 flex-auto items-center bg-[#f4f4f4] py-1 pl-6 pr-2 dark:bg-token-main-surface-secondary",{"rounded-full":l,"rounded-2xl":!l}),children:c.jsxs("div",{className:"relative flex flex-auto items-center self-stretch",children:[c.jsx(Hn,{placeholder:f.formatMessage({id:"zrUbTJ",defaultMessage:"Ask ChatGPT to edit"}),disabled:t,value:a,className:"w-full resize-none border-0 bg-transparent p-0 text-token-text-primary outline-0 placeholder:text-token-text-secondary focus:ring-0 focus-visible:ring-0",maxRows:4,onChange:({target:{value:p}})=>i(p),onKeyDown:g,onHeightChange:(p,{rowHeight:m})=>u(Math.floor(p/m)<=1)}),a?c.jsx(W.button,{className:Se("dark h-8 w-8 rounded-full bg-token-main-surface-primary text-center dark:bg-token-main-surface-primary",{"self-end":!l}),initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{type:"tween",duration:.1},onMouseDown:()=>d(),children:c.jsx(Rn,{className:"h-8 w-8 text-token-text-primary"})}):(o?.length??0)>0&&c.jsx(jn,{disableHint:!0,isEmbeddedInPromptArea:!0,isRequestActive:t,actions:o,onCancel:n,onSubmit:r,right:0,bottom:4})]})})})]})};function D(){}D.prototype={diff:function(e,n){var s,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},o=r.callback;typeof r=="function"&&(o=r,r={});var a=this;function i(v){return v=a.postProcess(v,r),o?(setTimeout(function(){o(v)},0),!0):v}e=this.castInput(e,r),n=this.castInput(n,r),e=this.removeEmpty(this.tokenize(e,r)),n=this.removeEmpty(this.tokenize(n,r));var l=n.length,u=e.length,f=1,d=l+u;r.maxEditLength!=null&&(d=Math.min(d,r.maxEditLength));var g=(s=r.timeout)!==null&&s!==void 0?s:1/0,p=Date.now()+g,m=[{oldPos:-1,lastComponent:void 0}],h=this.extractCommon(m[0],n,e,0,r);if(m[0].oldPos+1>=u&&h+1>=l)return i(nt(a,m[0].lastComponent,n,e,a.useLongestToken));var y=-1/0,w=1/0;function E(){for(var v=Math.max(y,-f);v<=Math.min(w,f);v+=2){var M=void 0,S=m[v-1],N=m[v+1];S&&(m[v-1]=void 0);var V=!1;if(N){var R=N.oldPos-v;V=N&&0<=R&&R<l}var q=S&&S.oldPos+1<u;if(!V&&!q){m[v]=void 0;continue}if(!q||V&&S.oldPos<N.oldPos?M=a.addToPath(N,!0,!1,0,r):M=a.addToPath(S,!1,!0,1,r),h=a.extractCommon(M,n,e,v,r),M.oldPos+1>=u&&h+1>=l)return i(nt(a,M.lastComponent,n,e,a.useLongestToken));m[v]=M,M.oldPos+1>=u&&(w=Math.min(w,v-1)),h+1>=l&&(y=Math.max(y,v+1))}f++}if(o)(function v(){setTimeout(function(){if(f>d||Date.now()>p)return o();E()||v()},0)})();else for(;f<=d&&Date.now()<=p;){var b=E();if(b)return b}},addToPath:function(e,n,s,r,o){var a=e.lastComponent;return a&&!o.oneChangePerToken&&a.added===n&&a.removed===s?{oldPos:e.oldPos+r,lastComponent:{count:a.count+1,added:n,removed:s,previousComponent:a.previousComponent}}:{oldPos:e.oldPos+r,lastComponent:{count:1,added:n,removed:s,previousComponent:a}}},extractCommon:function(e,n,s,r,o){for(var a=n.length,i=s.length,l=e.oldPos,u=l-r,f=0;u+1<a&&l+1<i&&this.equals(s[l+1],n[u+1],o);)u++,l++,f++,o.oneChangePerToken&&(e.lastComponent={count:1,previousComponent:e.lastComponent,added:!1,removed:!1});return f&&!o.oneChangePerToken&&(e.lastComponent={count:f,previousComponent:e.lastComponent,added:!1,removed:!1}),e.oldPos=l,u},equals:function(e,n,s){return s.comparator?s.comparator(e,n):e===n||s.ignoreCase&&e.toLowerCase()===n.toLowerCase()},removeEmpty:function(e){for(var n=[],s=0;s<e.length;s++)e[s]&&n.push(e[s]);return n},castInput:function(e){return e},tokenize:function(e){return Array.from(e)},join:function(e){return e.join("")},postProcess:function(e){return e}};function nt(t,e,n,s,r){for(var o=[],a;e;)o.push(e),a=e.previousComponent,delete e.previousComponent,e=a;o.reverse();for(var i=0,l=o.length,u=0,f=0;i<l;i++){var d=o[i];if(d.removed)d.value=t.join(s.slice(f,f+d.count)),f+=d.count;else{if(!d.added&&r){var g=n.slice(u,u+d.count);g=g.map(function(p,m){var h=s[f+m];return h.length>p.length?h:p}),d.value=t.join(g)}else d.value=t.join(n.slice(u,u+d.count));u+=d.count,d.added||(f+=d.count)}}return o}function st(t,e){var n;for(n=0;n<t.length&&n<e.length;n++)if(t[n]!=e[n])return t.slice(0,n);return t.slice(0,n)}function rt(t,e){var n;if(!t||!e||t[t.length-1]!=e[e.length-1])return"";for(n=0;n<t.length&&n<e.length;n++)if(t[t.length-(n+1)]!=e[e.length-(n+1)])return t.slice(-n);return t.slice(-n)}function Ie(t,e,n){if(t.slice(0,e.length)!=e)throw Error("string ".concat(JSON.stringify(t)," doesn't start with prefix ").concat(JSON.stringify(e),"; this is a bug"));return n+t.slice(e.length)}function ke(t,e,n){if(!e)return t+n;if(t.slice(-e.length)!=e)throw Error("string ".concat(JSON.stringify(t)," doesn't end with suffix ").concat(JSON.stringify(e),"; this is a bug"));return t.slice(0,-e.length)+n}function G(t,e){return Ie(t,e,"")}function ie(t,e){return ke(t,e,"")}function ot(t,e){return e.slice(0,as(t,e))}function as(t,e){var n=0;t.length>e.length&&(n=t.length-e.length);var s=e.length;t.length<e.length&&(s=t.length);var r=Array(s),o=0;r[0]=0;for(var a=1;a<s;a++){for(e[a]==e[o]?r[a]=r[o]:r[a]=o;o>0&&e[a]!=e[o];)o=r[o];e[a]==e[o]&&o++}o=0;for(var i=n;i<t.length;i++){for(;o>0&&t[i]!=e[o];)o=r[o];t[i]==e[o]&&o++}return o}var he="a-zA-Z0-9_\\u{C0}-\\u{FF}\\u{D8}-\\u{F6}\\u{F8}-\\u{2C6}\\u{2C8}-\\u{2D7}\\u{2DE}-\\u{2FF}\\u{1E00}-\\u{1EFF}",is=new RegExp("[".concat(he,"]+|\\s+|[^").concat(he,"]"),"ug"),ge=new D;ge.equals=function(t,e,n){return n.ignoreCase&&(t=t.toLowerCase(),e=e.toLowerCase()),t.trim()===e.trim()};ge.tokenize=function(t){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n;if(e.intlSegmenter){if(e.intlSegmenter.resolvedOptions().granularity!="word")throw new Error('The segmenter passed must have a granularity of "word"');n=Array.from(e.intlSegmenter.segment(t),function(o){return o.segment})}else n=t.match(is)||[];var s=[],r=null;return n.forEach(function(o){/\s/.test(o)?r==null?s.push(o):s.push(s.pop()+o):/\s/.test(r)?s[s.length-1]==r?s.push(s.pop()+o):s.push(r+o):s.push(o),r=o}),s};ge.join=function(t){return t.map(function(e,n){return n==0?e:e.replace(/^\s+/,"")}).join("")};ge.postProcess=function(t,e){if(!t||e.oneChangePerToken)return t;var n=null,s=null,r=null;return t.forEach(function(o){o.added?s=o:o.removed?r=o:((s||r)&&at(n,r,s,o),n=o,s=null,r=null)}),(s||r)&&at(n,r,s,null),t};function at(t,e,n,s){if(e&&n){var r=e.value.match(/^\s*/)[0],o=e.value.match(/\s*$/)[0],a=n.value.match(/^\s*/)[0],i=n.value.match(/\s*$/)[0];if(t){var l=st(r,a);t.value=ke(t.value,a,l),e.value=G(e.value,l),n.value=G(n.value,l)}if(s){var u=rt(o,i);s.value=Ie(s.value,i,u),e.value=ie(e.value,u),n.value=ie(n.value,u)}}else if(n)t&&(n.value=n.value.replace(/^\s*/,"")),s&&(s.value=s.value.replace(/^\s*/,""));else if(t&&s){var f=s.value.match(/^\s*/)[0],d=e.value.match(/^\s*/)[0],g=e.value.match(/\s*$/)[0],p=st(f,d);e.value=G(e.value,p);var m=rt(G(f,p),g);e.value=ie(e.value,m),s.value=Ie(s.value,f,m),t.value=ke(t.value,f,f.slice(0,f.length-m.length))}else if(s){var h=s.value.match(/^\s*/)[0],y=e.value.match(/\s*$/)[0],w=ot(y,h);e.value=ie(e.value,w)}else if(t){var E=t.value.match(/\s*$/)[0],b=e.value.match(/^\s*/)[0],v=ot(E,b);e.value=G(e.value,v)}}var us=new D;us.tokenize=function(t){var e=new RegExp("(\\r?\\n)|[".concat(he,"]+|[^\\S\\n\\r]+|[^").concat(he,"]"),"ug");return t.match(e)||[]};var ve=new D;ve.tokenize=function(t,e){e.stripTrailingCr&&(t=t.replace(/\r\n/g,`
`));var n=[],s=t.split(/(\n|\r\n)/);s[s.length-1]||s.pop();for(var r=0;r<s.length;r++){var o=s[r];r%2&&!e.newlineIsToken?n[n.length-1]+=o:n.push(o)}return n};ve.equals=function(t,e,n){return n.ignoreWhitespace?((!n.newlineIsToken||!t.includes(`
`))&&(t=t.trim()),(!n.newlineIsToken||!e.includes(`
`))&&(e=e.trim())):n.ignoreNewlineAtEof&&!n.newlineIsToken&&(t.endsWith(`
`)&&(t=t.slice(0,-1)),e.endsWith(`
`)&&(e=e.slice(0,-1))),D.prototype.equals.call(this,t,e,n)};function ls(t,e,n){return ve.diff(t,e,n)}var cs=new D;cs.tokenize=function(t){return t.split(/(\S.+?[.!?])(?=\s+|$)/)};var fs=new D;fs.tokenize=function(t){return t.split(/([{}:;,]|\s+)/)};function Ae(t){"@babel/helpers - typeof";return Ae=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ae(t)}var Q=new D;Q.useLongestToken=!0;Q.tokenize=ve.tokenize;Q.castInput=function(t,e){var n=e.undefinedReplacement,s=e.stringifyReplacer,r=s===void 0?function(o,a){return typeof a>"u"?n:a}:s;return typeof t=="string"?t:JSON.stringify(De(t,null,null,r),r,"  ")};Q.equals=function(t,e,n){return D.prototype.equals.call(Q,t.replace(/,([\r\n])/g,"$1"),e.replace(/,([\r\n])/g,"$1"),n)};function De(t,e,n,s,r){e=e||[],n=n||[],s&&(t=s(r,t));var o;for(o=0;o<e.length;o+=1)if(e[o]===t)return n[o];var a;if(Object.prototype.toString.call(t)==="[object Array]"){for(e.push(t),a=new Array(t.length),n.push(a),o=0;o<t.length;o+=1)a[o]=De(t[o],e,n,s,r);return e.pop(),n.pop(),a}if(t&&t.toJSON&&(t=t.toJSON()),Ae(t)==="object"&&t!==null){e.push(t),a={},n.push(a);var i=[],l;for(l in t)Object.prototype.hasOwnProperty.call(t,l)&&i.push(l);for(i.sort(),o=0;o<i.length;o+=1)l=i[o],a[l]=De(t[l],e,n,s,l);e.pop(),n.pop()}else a=t;return a}var je=new D;je.tokenize=function(t){return t.slice()};je.join=je.removeEmpty=function(t){return t};var le=(t=>(t.ADDED="added",t.REMOVED="removed",t.UNCHANGED="unchanged",t))(le||{});function Re(t){if(t==="")return 0;const e=t.split(`
`).length;return t.endsWith(`
`)?e-1:e}function ds(t,e){return ls(t,e,{newlineIsToken:!0}).map(s=>({count:s.count??Re(s.value),value:s.value,type:s.added?"added":s.removed?"removed":"unchanged"}))}function ms(t){let e="";for(const{type:n,value:s}of t)(n==="added"||n==="unchanged")&&(e+=s);return e}function hs(t,e){const n=Re(e),s=vs(t,n);return{changes:ds(s,e),numLinesDiffed:n}}function ps(t){const e=[...t],n=[],s=[];for(;e.length>0;){const r=e[e.length-1];if(r.type===le.REMOVED)e.pop(),r.type===le.REMOVED&&n.unshift(r);else if(r.type===le.ADDED)e.pop(),s.unshift(r);else break}return{prunedChanges:[...e,...s],prunedRemovedChanges:n}}function gs(t,e){const{changes:n,numLinesDiffed:s}=hs(t,e),{prunedChanges:r,prunedRemovedChanges:o}=ps(n),a=ms(r),i=o.map(u=>u.value).join(`
`),l=Ct(t,s,"start");return{content:a+i+l,numLinesDiffed:Re(a)}}function vs(t,e){if(e<=0)return"";let n=0,s=t.length;for(let r=0;r<t.length;r++)if(t[r]===`
`&&(n++,n===e)){s=r+1;break}return t.substring(0,s)}function Ct(t,e,n="start"){if(e<=0)return t;if(n==="start"){let a=0;for(let i=0;i<t.length;i++)if(t[i]===`
`&&(a++,a===e))return t.substring(i+1);return""}let s=0,r=-1;const o=t.endsWith(`
`)?e+1:e;for(let a=t.length-1;a>=0;a--)if(t[a]===`
`&&(s++,s===o)){r=a;break}return r===-1?"":t.substring(0,r+1)}function Cs(t,e){const n=t?.type??ue.LOADING,s=t?.content??"",r=!!t?.isPartial;if(!J(n)||e==null||!r||t?.isRewriting!==!0)return{content:s,currentlyStreamingLineIndex:null};const o=Ct(s,1,"end");if(o==="")return{content:e.content,currentlyStreamingLineIndex:0};const a=gs(e.content,o);return{content:a.content,currentlyStreamingLineIndex:a.numLinesDiffed}}var ce=(t=>(t.Close="close",t.Loaded="loaded",t.Streaming="streaming",t.Download="download",t))(ce||{});function ys({textdocVersion:t}){const e=H(),n=_t(),[s,r]=C.useState(!1),o=Ot(),a=C.useRef(t?.content??"");C.useEffect(()=>{a.current=t?.content??""},[t]);const i=l=>{s||(o(()=>{O.logButtonClick(de.COPY,{contentLength:a.current.length,textdocType:t?.type}),Yt(a.current,n,l)},0),r(!0),o(()=>r(!1),2e3))};return c.jsx(fe,{label:e.formatMessage(Ts.copy),children:c.jsx(X,{icon:s?Ln:_n,onClick:i})})}const Ts=Ne({copy:{id:"rbIYfo",defaultMessage:"Copy"}});function xs({textdocId:t,version:e,isHistorical:n,isShowingChanges:s,latestVersionInt:r,nextVersion:o,onHoverPrevious:a,textdocType:i}){const l=H(),u=e==null||e===1,f=e!=null&&e>1;return u&&!n?null:c.jsxs("div",{className:"flex items-center gap-1.5",children:[c.jsx(fe,{label:f&&l.formatMessage({id:"PoD5+8",defaultMessage:"Previous version"}),children:c.jsx(X,{disabled:!f,icon:On,onMouseOver:a,onClick:()=>{O.logButtonClick(de.HISTORY_PREVIOUS,{textdocType:i}),t&&e&&f&&Me(t,{beforeVersion:e},s?e-1:void 0)}})}),c.jsx(fe,{label:n&&l.formatMessage({id:"PJ8YVJ",defaultMessage:"Next version"}),children:c.jsx(X,{disabled:!n,icon:Pn,onClick:()=>{O.logButtonClick(de.HISTORY_NEXT,{textdocType:i}),n&&(o?Me(t,{version:o},s?o:void 0):s&&r?pt(t,r,null):pe(t))}})})]})}function ws({textdocId:t,history:e,version:n,isShowingChanges:s}){const r=Wt(),o=H(),a=()=>{e?Me(t,e):pe(t)},i=(n?.versionInt??0)>1,l=()=>{n?.versionInt!=null&&pt(t,n.versionInt,e)},u=()=>{n?.versionInt!=null&&r(t,n.versionInt)};return c.jsx(fe,{label:i&&o.formatMessage(Es.showChanges),children:c.jsx(X,{icon:qn,disabled:!i,onClick:s?a:l,onMouseOver:u,className:s?"enabled:bg-token-main-surface-secondary":void 0})})}const Es=Ne({done:{id:"0MCBfo",defaultMessage:"Done"},showChanges:{id:"3jMGNS",defaultMessage:"Show changes"}}),bs=800,Ss=100,it=100,Ms=({textdocId:t,isHistoricalVersion:e,nextHistoricalTextdocVersion:n,textdocVersion:s,readonlyReason:r,history:o,latestVersionInt:a,hasDebug:i,contentWidth:l,isEmbedded:u,isPersisting:f,isShowChangesFeatureEnabled:d,isShowingChanges:g,hideHistoryActions:p=!1,prefetchHistoricalTextdocVersion:m,restoreHistoricalTextdocVersion:h,setShowDebugView:y,onClose:w})=>{const E=Jt(s?.title??""),[{width:b},v]=gt(),M=l-b-Ss-it>0;return c.jsxs(Y.Header,{children:[c.jsxs("div",{className:"flex flex-1 items-center leading-[0]",children:[c.jsx(Y.CloseButton,{onClick:w}),M&&c.jsx("div",{className:"flex flex-row items-center gap-2.5",children:c.jsx(Y.Title,{style:{maxWidth:l-b-it},children:E||c.jsx("div",{className:"w-52",children:c.jsx(Xn,{lines:1,size:"base",width:100,widthVariance:0})})})}),f&&c.jsx(Xt,{size:12,className:"pl-2 text-token-text-secondary"})]}),c.jsxs("div",{className:"flex select-none items-center gap-2 leading-[0]",ref:v,children:[c.jsxs("div",{className:Se("flex items-center gap-2 transition-opacity duration-500",r===_.Streaming&&"pointer-events-none opacity-0"),children:[i&&l>bs&&c.jsx(X,{icon:$n,onClick:()=>y(S=>!S)}),!p&&c.jsx(xs,{textdocId:t,isHistorical:e,isShowingChanges:g,version:s?.versionInt,nextVersion:n?.versionInt,readonlyReason:r,onHoverPrevious:m,onClickRestore:h,textdocType:s?.type,latestVersionInt:a}),!p&&d&&c.jsx(ws,{textdocId:t,history:o,version:s,isShowingChanges:g}),c.jsx(ys,{textdocVersion:s})]}),!u&&c.jsx(Gn,{})]})]})},Is=/\s/,ks=30;function ut(t,e){const n=t.indexOf(e);return n===-1?!1:t.indexOf(e,n+e.length)===-1}function P(t,e){return Is.test(t[e])}function lt(t,e,n=!1){if(e===0||n&&P(t,e-1))return e;for(;e>0&&P(t,e-1);)e--;for(;e>0&&!P(t,e-1);)e--;return P(t,e)&&e++,e}function ct(t,e,n=!1){if(e===t.length||n&&P(t,e))return e;for(;e<t.length&&P(t,e);)e++;for(;e<t.length&&!P(t,e);)e++;return P(t,e-1)&&e--,e}function As(t,e,n=!0,s=ks){if(t.start<0||t.end>e.length||t.start>t.end)throw new Error("Invalid commentSourceRange provided.");const r=e.substring(t.start,t.end);let o=t.start,a=t.end;n&&(o=lt(e,o,!0),a=ct(e,a,!0));let i=e.substring(o,t.start),l=e.substring(t.end,a),u=`${i}${r}${l}`;if(ut(e,u)&&(s==null||u.length>=s))return{before:i,after:l,allSurrounding:u};let f=o,d=a,g=!0;for(;g&&(s==null||u.length<s);){let p=!1;const m=f>0?lt(e,f):f;m<f&&(f=m,p=!0);const h=d<e.length?ct(e,d):d;if(h>d&&(d=h,p=!0),p){const y=e.substring(f,t.start),w=e.substring(t.end,d),E=`${y}${r}${w}`;if(ut(e,E)&&(s==null||E.length>=s))return{before:y,after:w,allSurrounding:E};i=y,l=w,u=E}else g=!1}return{before:i,after:l,allSurrounding:u}}const Z="# Context",K="# Instructions";function ee(t,e,n){if(e==null||n==null)return`The user is referring to the entire text of "${t}".`;const s=`
## Selected Text
The user has selected this text in "${t}" in particular:
${e}
`.trim();return n.allSurrounding===e?s:`
${s}

## Surrounding Context
Here is the surrounding context:
${n.allSurrounding}
`.trim()}function yt(t,e){return t==null||e==null?"entire document":t===e.allSurrounding?"selected text":"surrounding context"}function Tt(t){return`For the update pattern, create a regex which exactly matches the ${t}. Edit just this string in order to fullfill the user's request. NEVER rewrite the entire document. Instead, ALWAYS edit ONLY the ${t}. The only exception to this rule is if the ${t} includes markdown lists or tables. In that case, fully rewrite the document using ".*" as the regex update pattern.`.trim()}function Ds(t,e,n,s){if(!J(e)&&n&&s){const r=yt(n,s);return`
${Z}
The user requests that you directly edit the document.

${ee(t,n,s)}

${K}
Use the update_textdoc tool to make this edit. ${Tt(r)}`.trim()}return`
${Z}
The user requests that you directly edit the document.

${ee(t,n,s)}

${K}
Use the update_textdoc tool to make this edit. You MUST fully rewrite the entire document by using ".*" as the update regex pattern.`.trim()}function js(t,e,n){return`
${Z}
The user requests that you add comments about some text.

${ee(t,e,n)}

${K}
Do not respond to the user's question directly, just leave comments.`.trim()}function Ns(t,e){return J(t)?e==="entire document"?` If you choose to update the ${e}, you MUST fully rewrite the ${e} by using ".*" as the update regex pattern.`:` If you choose to update the ${e}, you MUST fully rewrite the entire document by using ".*" as the update regex pattern. When you do so, ONLY modify the ${e} and rewrite other sections exactly as is, except for parts that must change based on this update`:e==="entire document"?"":` If you choose to update the ${e}, follow these instructions: ${Tt(e)}`}function Rs(t,e,n,s){const r=yt(n,s),o=Ns(e,r);return`
${Z}
${ee(t,n,s)}

${K}
The user would like you perform one of the following actions:
- Update the ${r} via the \`update_textdoc\` tool.${o}
- Explain the selected text via chat, or answer a general question about the selected text (no tool call required).
- Comment on the ${r} with feedback via the \`comment_textdoc\` tool. This should only be used if the user very explicitly asks for feedback, critique, or comments.

Based on the user's request, choose the appropriate action.
`.trim()}function Ls(t,e,n){return`
${Z}
${ee(t,e,n)}

${K}
The user would like you to create a new textdoc.
`.trim()}function _s(t,e,n,s=null,r=null){switch(n){case B.ASK:return Rs(t,e,s,r);case B.CREATE_TEXTDOC:return Ls(t,s,r);case B.EDIT:return Ds(t,e,s,r);case B.COMMENT:return js(t,s,r)}}function Os(t){const e=Qn(),n=En(t),s=Zn(t)??e.id,r=bn({clientThreadId:t});return async function(o){const a=new Qt,i=Bn.getThreadCurrentLeafId(t),l=performance.now(),u=await Pt(),[f,d,g]=await Promise.all([qt.getEnforcementToken(u),Zt.getEnforcementToken(u),$t.getEnforcementToken(u)]);r({model:s,completionType:Ht.Next,parentNodeId:i,metadata:{eventSource:"mouse"},completionMetadata:{conversationMode:n},chatReq:u,arkoseToken:f??null,turnstileToken:d??null,proofToken:g??null,preflightTime:performance.now()-l,appendMessages:o,turnTracker:a})}}function Ps(t){switch(t){case k.ACCELERATOR:case k.ACCEPT_COMMENT:return!0;case k.ASK_CHATGPT:case k.FULL_SCREEN_SUBMIT:return!1}}function qs(t,e){switch(e){case k.ASK_CHATGPT:case k.ACCEPT_COMMENT:case k.FULL_SCREEN_SUBMIT:return t.formatMessage(Hs.askChatGPT);case k.ACCELERATOR:return}}const $s=(t,e)=>{const n=Os(t),s=H();return C.useCallback(({content:r,sourceRange:o,action:a,userMessageType:i,acceleratorMetadata:l,selectionMetadata:u})=>{if(e?.versionInt==null)return;const{textdocId:f,type:d,versionInt:g,content:p}=e;let m,h=null;o&&(m=p.slice(o.start,o.end),h=As(o,p)),n([Kt([r],{canvas:{textdoc_id:f,textdoc_type:d,version:g,textdoc_content_length:p.length,user_message_type:i,accelerator_metadata:l,selection_metadata:u},is_visually_hidden_from_conversation:Ps(i),targeted_reply:m,targeted_reply_label:qs(s,i),open_in_canvas_view:{type:"canvas_textdoc",id:f}}),en([_s(f,d,a,m,h)],{exclude_after_next_user_message:!0})])},[n,s,e])},Hs=Ne({askChatGPT:{id:"h5ANdM",defaultMessage:"Asked ChatGPT"}});function Us(t){const e=/\[([^\]]+)\]\((https?:\/\/[^\s)]+|www\.[^\s)]+)\)/gi,n=new Set,s=t.matchAll(e);for(const r of s){const o=r[2];try{let a=o;a.startsWith("www.")&&(a="http://"+o),new URL(a),n.add(o)}catch{}}return n}const Fs=async({lastVersion:t,textdocId:e,content:n,comments:s})=>{const r=tn(s,n);return(await dt.safePost("/textdoc/{textdoc_id}",{parameters:{path:{textdoc_id:e}},requestBody:{version:t,content:n,comments:r}})).version},Bs=()=>{const t=C.useRef([]),e=C.useRef(null),{mutateAsync:n,isPending:s}=Ut({mutationKey:["canvas","textdoc","persist"],mutationFn:Fs});return[C.useCallback(async(o,a,i)=>{const l=new AbortController,f=(async()=>{const[m]=t.current;try{await m?.promise}catch(h){O.logError("Saving document",h)}if(!l.signal.aborted)try{const h=Math.max(e.current??0,o.versionInt??vt);let y="";try{Ze(a)?y=a():y=a}catch(v){O.logError("Serializing document",v)}let w=[];try{Ze(i)?w=i():w=i}catch(v){O.logError("Adjusting comments",v)}const{textdocId:E}=o;nn({textdocId:E,basedOnVersionInt:h,content:y,comments:w});const b=await n({textdocId:E,lastVersion:h,content:y,comments:w});sn({textdocId:E,basedOnVersionInt:h,newVersion:b}),e.current=b}catch(h){O.logError("Error saving document",h)}finally{t.current.shift()}})(),d={abort:()=>l.abort(),promise:f},[g,p]=t.current;return p&&(p.abort(),t.current=g?[g]:[]),t.current=g?[g,d]:[d],f},[n]),t,s]},Vs=3e3,zs=t=>{const[e,n,s]=Bs(),r=H(),o=C.useRef(null),a=C.useCallback(rn(e,Vs,{leading:!1}),[e]),i=on(t);return C.useEffect(()=>{if(!i)return;const u=Ke(window,{pagehide:()=>a.flush(),beforeunload:d=>{a.flush(),d.returnValue=r.formatMessage({id:"QZrKwi",defaultMessage:"You have a canvas save in progress."})}}),f=Ke(document,{visibilitychange:()=>a.flush(),keydown:()=>{o.current="keyboard"},mousemove:()=>{o.current!=="mouse"&&a.flush(),o.current="mouse"}});return()=>{o.current=null,f(),u()}},[r,i,a]),C.useEffect(()=>()=>{a.flush()},[t,a]),an(async()=>{await a.flush(),await Promise.allSettled(n.current?.map(({promise:u})=>u)??[])}),[C.useCallback((u,f,d)=>{const{textdocId:g}=u;return un(g),a(u,f,d)},[a]),a.flush,s||i]};function Gs(t,e,n){const s=mt(),r=n!=null&&e!=null,{data:o,error:a,fetchNextPage:i,hasNextPage:l,isFetching:u}=Ft(ft(t,e,r)),f=C.useCallback(async()=>{const m=e!=null;await s.prefetchInfiniteQuery(ft(t,e,m))},[s,t,e]);C.useEffect(()=>{const m=e;return()=>{s.removeQueries({queryKey:xt(t,m),exact:!0})}},[s,t,e]);const[d,g,p]=C.useMemo(()=>{if(o&&n){const m=o.pages.flatMap(y=>y),h=m.findIndex(y=>"beforeVersion"in n?(y.versionInt??vt)<n.beforeVersion:y.versionInt===n.version);if(h!==-1)return[h===m.length-1,m[h],h>0?m[h-1]:null]}return[!0,null,null]},[o,n]);return C.useEffect(()=>{!u&&r&&l&&d&&i()},[u,r,l,d,i]),C.useEffect(()=>{!g&&a&&pe(t)},[g,a,t]),{historicalTextdocVersion:g,nextHistoricalTextdocVersion:p,prefetchHistoricalTextdocVersion:f}}function xt(t,e=null){return["textdocHistory",t,e]}function ft(t,e,n=!0){return{queryKey:xt(t,e),queryFn:({pageParam:s})=>Ys(t,s),initialPageParam:e??void 0,getNextPageParam:s=>{const r=ln(s)?.versionInt;if(r&&r>1)return r},enabled:n,staleTime:1/0,retry:2}}async function Ys(t,e){return e===void 0?[]:(await dt.safeGet("/textdoc/{textdoc_id}/history",{parameters:{path:{textdoc_id:t},query:{before_version:e}}})).previous_doc_states.map(({id:s,version:r,textdoc_type:o,title:a,content:i,updated_at:l,comments:u})=>({textdocId:s,versionInt:r,messageId:null,title:a,type:cn(o),content:i,createdAt:fn(l),comments:dn(u,i)}))}const lr=({isFullScreen:t=!1,isEmbedded:e=!1,hideHeader:n=!1,readonlyReason:s,clientThreadId:r,focusedTextdoc:o,onClose:a,isAnimating:i=!1,width:l})=>{const{textdocId:u,history:f,showChangesAtVersion:d=null}=o,[g,p,m]=zs(u),{targetedContent:h}=mn(),y=Yn(),[w,E]=C.useState(!1),b=Wn(u),v=Jn(),M=Vn(r),S=hn(M),[N,V]=gt(),R=pn(),{data:q}=gn(u,R?d:null),j=b?.versions??[],Le=j[0]?.versionInt,{historicalTextdocVersion:_e,nextHistoricalTextdocVersion:wt,prefetchHistoricalTextdocVersion:Et}=Gs(u,Le,f);C.useEffect(()=>{me.reset()},[u]),C.useEffect(()=>{b?.metadata?.textdocId&&be().sendMessage({type:ce.Loaded})},[b?.metadata?.textdocId]);const Oe=j.length>0?j[j.length-1]:null,Ce=j.length>1?j[j.length-2]:null,Pe=zn(r),{restoreHistoricalTextdocVersion:qe,optimisticRestoredTextdocVersion:bt}=vn(Pe,Oe,_e),U=f!=null,x=U?_e:Oe,te=$s(r,x),St=i||!R?null:q,ne=C.useMemo(()=>i?[]:x?.comments.filter(T=>T.status!==Cn.DISMISSED)??[],[i,x]),se=x?.type??ue.LOADING,$=!!x?.isPartial;C.useEffect(()=>{j.length===0&&!v&&a?.()},[j.length,a,v]);const Mt=!!s&&s!==_.OldVersion,$e=R&&d!=null,ye=$&&!!x?.isRewriting,It=$&&!!x?.isCreation,{content:re,currentlyStreamingLineIndex:He}=q?.contentBefore!=null&&!J(se)?{content:q.contentBefore,currentlyStreamingLineIndex:null}:Cs(x,Ce),kt=Kn(Pe,Array.from(Us(re))),[oe,Te]=es({value:re,isRequestActive:S,isTextdocStreaming:$,comments:ne}),Ue=yn(x),Fe=$||S||oe||m;C.useEffect(()=>{be().sendMessage({type:ce.Streaming,streaming:Fe})},[Fe]);const At=({getSerializedDocument:T,getAdjustedComments:A})=>{x&&g(x,T,A)},Dt=T=>{if(!x)return;const A=T.doc.toString();g(x,A,T.field(An,!1)??[])},Be=(T,A,L,F)=>{Te(!0),te({action:A,content:T,userMessageType:k.ASK_CHATGPT,sourceRange:L,selectionMetadata:{selection_type:F,selection_position_range:L}})},Ve=({id:T})=>{Ue(T,et.DISMISS),me.reset()},ze=async T=>{Te(!0);const{id:A,at:L,content:F}=T;if(await Ue(A,et.ACCEPT)===!1)return Te(!1);te({content:F,userMessageType:k.ACCEPT_COMMENT,sourceRange:L,action:B.EDIT,selectionMetadata:{selection_type:tt.SELECTION,selection_position_range:L}})},xe=(T,A,L)=>{const{action:F}=L;te({action:F,content:A,sourceRange:T,userMessageType:k.ACCELERATOR,acceleratorMetadata:{action:F,id:L.id,prompt:A},selectionMetadata:T!=null?{selection_type:tt.SELECTION,selection_position_range:T}:void 0})},jt=T=>{te({action:B.EDIT,content:T,userMessageType:k.FULL_SCREEN_SUBMIT})},Nt=Bt(),Rt=mt(),Lt=Tn(({resolveTempCommentId:T})=>T),Ge=T=>Lt[T]||T,we=()=>In({clientThreadId:r,currentRequestId:M,queryClient:Rt,isHistoryAndTrainingDisabled:Nt});let I=s;U?I=_.OldVersion:$e?I=_.ShowingChanges:bt!=null?I=_.Restoring:($||S)&&(I=_.Streaming);let ae=null;const Ye=i||I!=null||oe,We=i&&ne.length>0||U||I!=null&&I!==_.Streaming,Je=t||i;let Ee=[];switch(se){case ue.LOADING:ae=c.jsx(kn,{});break;case ue.DOCUMENT:ae=c.jsx(Mn,{value:re,comments:ne,previousValue:Ce?.content,previousComments:Ce?.comments,isRewriting:ye,isAnimatingFromPreview:i,getStableCommentId:Ge,diff:St,isRequestActive:S,isDisabled:I!=null||v,isWaitingForCommentResponse:oe,hideAccelerators:Je,hideToolbar:Ye,hideEditOverlay:i,hideComments:We,readonlyReason:I,canvasContentRect:N,onBlur:p,onSave:p,onChange:At,onCancelRequest:we,targetedContent:h,onAddComment:Be,onAcceptComment:ze,onDismissComment:Ve,onSubmitAccelerator:xe,safeUrls:kt,width:l,modelCursor:$&&!ye?x?.modelCursor:void 0,shouldResetSelection:x?.versionInt===1}),Ee=Nn;break;default:J(se)&&(ae=c.jsx(Sn,{id:"codemirror",getStableCommentId:Ge,language:xn(se),value:re,comments:ne,hideAccelerators:Je,hideComments:We,hideToolbar:Ye,onSubmitAccelerator:xe,currentlyStreamingLineIndex:He??null,readonlyReason:I,isRequestActive:S,isWaitingForCommentResponse:oe,onChange:Dt,onCancelRequest:we,onAddComment:Be,onDismissComment:Ve,onAcceptComment:ze,valueToShowChangesAgainst:R?q?.contentBefore:void 0,modelCursor:$&&He==null?x?.modelCursor:void 0}),Ee=Dn)}return c.jsxs(Y,{children:[!n&&c.jsx(Ms,{textdocId:u,isHistoricalVersion:U,nextHistoricalTextdocVersion:wt,textdocVersion:x,readonlyReason:I,history:f,hasDebug:y,contentWidth:N.width,isEmbedded:e,isPersisting:m,isShowChangesFeatureEnabled:R,isShowingChanges:$e,latestVersionInt:Le,hideHistoryActions:I===_.QueryParam,prefetchHistoricalTextdocVersion:Et,restoreHistoricalTextdocVersion:qe,setShowDebugView:E,onClose:()=>{const T=be();T.isNative&&T.sendMessage({type:ce.Close}),O.logButtonClick(de.CLOSE_TEXTDOC,{textdocType:x?.type}),a?.()}}),c.jsxs(Y.Content,{ref:V,scrollToBottomMode:It?"bottom":"top",shouldScrollToTop:ye,children:[!1,ae]}),c.jsx(ht,{children:U&&!Mt&&c.jsx(ts,{onClickRestore:qe,onClickResetLatest:()=>pe(u)})}),t&&!U&&c.jsx("div",{className:"relative flex items-center justify-center pb-3",children:c.jsx(os,{isRequestActive:S,clientThreadId:r,onSubmitAccelerator:xe,onSubmit:jt,onCancel:we,acceleratorActions:Ee})})]})};export{lr as T};
//# sourceMappingURL=im2cctmqi6ybfkzl.js.map
