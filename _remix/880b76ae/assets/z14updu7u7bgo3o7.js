import{j as K,r as d,h as Y,y as Z,R as k}from"./o1ivbuadejprpakj.js";import{dB as J,dC as Q,dD as U,dE as X,dF as $,dG as W,dH as z,dI as G,dJ as ee,dK as se,cH as te,dL as oe,dM as H,bN as re,dN as ne,dO as ae,dP as ce,dQ as de,dR as P,dS as ie,dT as ue,dU as Te,dV as fe,dW as le,dX as R,dY as me,dZ as pe,d_ as S}from"./i16nwty7q09iq1st.js";import{k as xe}from"./hcdx55t4k5s9h90a.js";import{T as M,i as Ie,o as ge,p as ve}from"./j76lrd6kdu2dvuce.js";const Ee=e=>Y.safeGet("/conversation/{conversation_id}/textdocs",{parameters:{path:{conversation_id:e}}}),Me=async e=>{const o=await Ee(e),r=new Map(o?.map(t=>[t.id,t])),s=[];for(const{id:t,content:a,version:u,textdoc_type:n,title:x,comments:m}of o)s.push({textdocId:t,messageId:null,type:X(n),comments:$(m,a),title:x,content:a,versionInt:u,createdAt:0});return{persistedTextdocVersionById:new Map(s.map(t=>[t.textdocId,t])),persistedTextdocVersions:s,persistedTextdocById:r}};function Ce({clientThreadId:e,isEnabled:o}){const r=M.getServerThreadId(e),{data:s,error:i,isLoading:t,isFetching:a,refetch:u}=K({queryKey:[r,"textdocs"],enabled:!!r&&o,gcTime:0,queryFn:()=>r&&Me(r)});return d.useEffect(()=>{if(!s)return;const{persistedTextdocVersions:n}=s;J(n),Q(n),U(n)},[s]),[{...s,error:i,isLoading:t,isFetching:a},u]}var q=(e=>(e[e.INITIALIZING=0]="INITIALIZING",e[e.READY=1]="READY",e[e.REFETCHING=2]="REFETCHING",e))(q||{});function he({clientThreadId:e,isEnabled:o}){const[{error:r,persistedTextdocVersionById:s=null,isLoading:i,isFetching:t},a]=Ce({clientThreadId:e,isEnabled:o}),u=W();z(()=>{if(!o)return;const x=M.getThreadCurrentLeafId(e),m=M.getThreadConversationTurns(e,x),C=G(m)?.messages??[],T=ee(C);if(T==null)return;const I=T.message.metadata?.canvas?.textdoc_id,h=T.message.metadata?.canvas?.version;I!=null&&h!=null&&u(I,h),a()});let n=0;return s&&t?n=2:s&&!t&&!i&&(n=1),d.useMemo(()=>({status:n,fetchError:r,textdocVersionById:s}),[n,r,s])}const D=e=>{if(!e)return;const{messages:o}=e,r=fe(o??[],({message:i})=>i.author.role===k.System),s=r===-1?o:o?.slice(r+1);if(s&&le(s))return s};function ye({clientThreadId:e,isEnabled:o}){const r=Ie(e),s=ge(e,r),i=ve(e),t=te(i),a=he({isEnabled:o,clientThreadId:e}),u=oe(),[n,x]=d.useState(!0),m=o&&(t||!n||a.status===q.REFETCHING),c=G(s),C=d.useMemo(()=>{if(!c||!H(c))return null;const f=M.getTree(e),{variantIds:y}=c;return y.map(B=>{const O=f.getLeafFromNode(B).id;return G(M.getThreadConversationTurns(e,O))})},[e,c]),T=d.useMemo(()=>!m||!c?null:H(c)?C?.flatMap(D).filter(re):D(c),[m,c,C]),I=!!T,h=d.useMemo(()=>s.slice(0,I?-1:s.length),[s.length,I]),_=ne(h),V=ae(),b=ce(),g=d.useMemo(()=>{let f=de(_);const{textdocVersionById:y,fetchError:B,status:O}=a;return!y||(f=P(f,l=>{l.fetchError=B,l.isFetchingFromPersistence=O===q.REFETCHING;for(const[v,N]of y.entries()){l.allTextdocIdSet[v]=v;const L=u.get(v);let p=L&&(L.versionInt??R)>(N.versionInt??R)?{...N,...L}:N;const w=b.filter(E=>E.textdocId===v&&E.kind===me.REMOVE_COMMENT);let A=p.versionInt;for(const E of w)p=pe(p,E),A=Math.max(A??R,E.versionInt??R);p={...p,versionInt:A},l.textdocById[v]=void 0,S(l,p)}}),!V)?f:P(f,l=>{S(l,V,!1)})},[_,a,u,V,b]),j=d.useMemo(()=>T?.length?ie(t,g,T):null,[T,t,g]),F=ue(t,j,x);return d.useMemo(()=>F?Te(g,F):g,[g,F])}function Ne({clientThreadId:e,children:o}){const r=xe(e),s=ye({clientThreadId:e,isEnabled:r});return Z.jsx(se.Provider,{value:s,children:o})}export{Ne as T};
//# sourceMappingURL=z14updu7u7bgo3o7.js.map
