import{r as T,a3 as U,t as d,aT as Ke,bA as z,R as et,T as ge,ag as zt,e1 as Gt,ad as je,c$ as Wt,d0 as Yt,d1 as Jt,eb as Qt,b as Ct,h as Xt,fv as tt,d8 as nt,a as Tt,dl as Zt,dT as Kt}from"./elatgogjtv7nqe0m.js";import{eA as en,fv as tn,jK as nn,af as yt,jL as he,jM as Q,ju as st,c as ve,N as X,fF as j,j0 as Z,U as sn,jN as Ce,jO as xt,fH as K,jP as on,ir as Et,iD as wt,jA as rn,an as N,bT as an,ck as un,jQ as ln,jR as cn,jS as I,jT as fn,iU as bt,jU as dn,jV as mn,e as hn,jW as pn,jX as gn,jY as vn,fu as Cn,iA as Tn,fr as yn,iB as xn,ft as En,cz as wn,jZ as bn,j_ as Mn,ao as ot,j$ as Sn,k0 as An,k1 as In,k2 as Dn,k3 as rt,iu as G}from"./htp5iqft2rzvr58f.js";import{C as kn,s as Y,g as Ln,t as Nn,v as _n,w as Rn,x as jn,y as On}from"./gt9yt6m8kstbc8qg.js";import{e as Pn,C as Hn}from"./fd0fopp2kbkt06ru.js";import{C as Te,B as qn,S as F,f as $n,H as at}from"./i7lmp86g0sfr67co.js";import{m as J}from"./iudm9ugwilu2skh4.js";import{D as Un}from"./hwq4ihlr13h338d9.js";import{bI as Bn,bv as Fn,_ as Vn,bK as zn,bL as Gn,an as Wn,y as Yn}from"./cr91oy4eihkrvo1z.js";import{i as Jn}from"./i5xse42anbkbyjnb.js";import{i as Qn,s as Xn,T as Zn,B as Kn,d as es}from"./h1jpzm6tqkxt344d.js";import{L as ts,l as ns,m as ss,n as os,o as rs}from"./pa1iyn2idxl19s5v.js";import{P as as}from"./k4jmcc7xi21ufmsx.js";import{q as is,r as us,J as ls}from"./lknunzf857a9nkhn.js";import{u as cs}from"./nr9dsvi4ewyvay85.js";var De=(t=>(t.Close="close",t.Loaded="loaded",t.Streaming="streaming",t.Download="download",t))(De||{});const fs=({isTextdocStreaming:t,isRequestActive:e,value:n,comments:s})=>{const[o,r]=T.useState(!1);return T.useEffect(()=>{t&&o&&(r(!1),Te.reset())},[n,s]),T.useEffect(()=>{e||(r(!1),Te.reset())},[e]),[o,r]};function ds({onClickRestore:t,onClickResetLatest:e}){const n=U();return d.jsx(J.div,{initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{bounce:0,duration:.24},className:"absolute bottom-0 left-0 z-30 w-full items-center border-t border-gray-100 bg-token-main-surface-primary p-6 shadow-[0_-4px_32px_rgba(0,0,0,0.08)] @container dark:border-token-border-xlight dark:shadow-[0_-4px_32px_rgba(0,0,0,0.12)] lg:border-l",children:d.jsxs("div",{className:"mx-auto flex max-w-[48rem] flex-col flex-wrap justify-center gap-5 @2xl:flex-row @2xl:justify-between",children:[d.jsxs("div",{className:"flex flex-col px-2 text-center @2xl:text-start",children:[d.jsx("span",{className:"text-md text-wrap font-semibold",children:n.formatMessage({id:"gt23pb",defaultMessage:"You are viewing a previous version"})}),d.jsx("span",{className:"text-wrap text-sm text-token-text-secondary",children:n.formatMessage({id:"sAlUJn",defaultMessage:"Restore this version to make edits"})})]}),d.jsxs("div",{className:"flex flex-wrap items-center justify-center gap-4",children:[d.jsx(Ke,{as:"button",color:"primary",onClick:t,children:n.formatMessage({id:"+cddAb",defaultMessage:"Restore this version"})}),d.jsx(Ke,{as:"button",color:"secondary",onClick:e,children:n.formatMessage({id:"qCD3eu",defaultMessage:"Back to latest version"})})]})]})})}const ms={type:"spring",damping:35,stiffness:300},hs=({clientThreadId:t,turn:e})=>{const n=en(),s=tn(e.messages);return d.jsxs(J.div,{className:"absolute left-0 right-0 top-0 z-10 -translate-y-full",children:[d.jsx(J.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 bg-vert-light-gradient dark:bg-vert-dark-gradient"}),d.jsx(J.div,{className:"flex items-center px-6 py-2",initial:{opacity:.75,translateX:-50,translateY:"100%"},animate:{opacity:1,translateX:0,translateY:"0"},exit:{opacity:0,translateY:20},transition:ms,children:d.jsx(kn,{clientThreadId:t,onChangeItemInView:z,onRequestCompletion:async o=>z(o),onRequestMoreCompletions:z,groupedMessagesToRender:s,allGroupedMessages:s,isEditing:!1,isUserTurn:!0,turnIndex:0,isCompletionRequestInProgress:!1,isFeedbackEnabled:!1,isFinalTurn:!1,hasActiveRequest:n,showEditButton:!1,handleEnterEdit:z,handleExitEdit:z})})]},"user-message")},ps=({clientThreadId:t})=>{const e=Qn(t),n=Xn(t,e),{lastUserTurn:s,lastAssistantTurn:o}=T.useMemo(()=>{let a=null,i=null;for(let l=n.length-1;l>0;l--){const u=n[l];if(!a&&u.role===et.User?a=u:!i&&u.role===et.Assistant&&(i=u),a&&i)break}return{lastUserTurn:a,lastAssistantTurn:i}},[n]),r=s&&!o?.messages.find(({message:a})=>a.recipient?.startsWith(nn));return d.jsx(yt,{initial:!1,children:r&&d.jsx(hs,{turn:s,clientThreadId:t})})},gs=({isRequestActive:t=!1,clientThreadId:e,onCancel:n,onSubmit:s,onSubmitAccelerator:o,acceleratorActions:r=[]})=>{const[a,i]=T.useState(""),[l,u]=T.useState(!0),f=U(),c=()=>{s?.(a),i("")},p=g=>{const{metaKey:h,shiftKey:m,key:v}=g;v==="Enter"&&a.trim()&&!(m||h)&&(c(),g.preventDefault())};return d.jsxs("div",{className:"relative mb-3 flex max-w-2xl flex-1 justify-center",children:[d.jsx(ps,{clientThreadId:e}),d.jsx("div",{className:"flex flex-auto items-start",children:d.jsx("div",{className:ge("mx-6 flex min-h-12 flex-auto items-center bg-[#f4f4f4] py-1 pl-6 pr-2 dark:bg-token-main-surface-secondary",{"rounded-full":l,"rounded-2xl":!l}),children:d.jsxs("div",{className:"relative flex flex-auto items-center self-stretch",children:[d.jsx(Jn,{placeholder:f.formatMessage({id:"zrUbTJ",defaultMessage:"Ask ChatGPT to edit"}),disabled:t,value:a,className:"w-full resize-none border-0 bg-transparent p-0 text-token-text-primary outline-0 placeholder:text-token-text-secondary focus:ring-0 focus-visible:ring-0",maxRows:4,onChange:({target:{value:g}})=>i(g),onKeyDown:p,onHeightChange:(g,{rowHeight:h})=>u(Math.floor(g/h)<=1)}),a?d.jsx(J.button,{className:ge("dark h-8 w-8 rounded-full bg-token-main-surface-primary text-center dark:bg-token-main-surface-primary",{"self-end":!l}),initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{type:"tween",duration:.1},onMouseDown:()=>c(),children:d.jsx(Bn,{className:"h-8 w-8 text-token-text-primary"})}):(r?.length??0)>0&&d.jsx(qn,{disableHint:!0,isEmbeddedInPromptArea:!0,isRequestActive:t,actions:r,onCancel:n,onSubmit:o,right:0,bottom:4})]})})})]})};function _(){}_.prototype={diff:function(e,n){var s,o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},r=o.callback;typeof o=="function"&&(r=o,o={});var a=this;function i(C){return C=a.postProcess(C,o),r?(setTimeout(function(){r(C)},0),!0):C}e=this.castInput(e,o),n=this.castInput(n,o),e=this.removeEmpty(this.tokenize(e,o)),n=this.removeEmpty(this.tokenize(n,o));var l=n.length,u=e.length,f=1,c=l+u;o.maxEditLength!=null&&(c=Math.min(c,o.maxEditLength));var p=(s=o.timeout)!==null&&s!==void 0?s:1/0,g=Date.now()+p,h=[{oldPos:-1,lastComponent:void 0}],m=this.extractCommon(h[0],n,e,0,o);if(h[0].oldPos+1>=u&&m+1>=l)return i(it(a,h[0].lastComponent,n,e,a.useLongestToken));var v=-1/0,y=1/0;function E(){for(var C=Math.max(v,-f);C<=Math.min(y,f);C+=2){var b=void 0,k=h[C-1],M=h[C+1];k&&(h[C-1]=void 0);var H=!1;if(M){var oe=M.oldPos-C;H=M&&0<=oe&&oe<l}var q=k&&k.oldPos+1<u;if(!H&&!q){h[C]=void 0;continue}if(!q||H&&k.oldPos<M.oldPos?b=a.addToPath(M,!0,!1,0,o):b=a.addToPath(k,!1,!0,1,o),m=a.extractCommon(b,n,e,C,o),b.oldPos+1>=u&&m+1>=l)return i(it(a,b.lastComponent,n,e,a.useLongestToken));h[C]=b,b.oldPos+1>=u&&(y=Math.min(y,C-1)),m+1>=l&&(v=Math.max(v,C+1))}f++}if(r)(function C(){setTimeout(function(){if(f>c||Date.now()>g)return r();E()||C()},0)})();else for(;f<=c&&Date.now()<=g;){var S=E();if(S)return S}},addToPath:function(e,n,s,o,r){var a=e.lastComponent;return a&&!r.oneChangePerToken&&a.added===n&&a.removed===s?{oldPos:e.oldPos+o,lastComponent:{count:a.count+1,added:n,removed:s,previousComponent:a.previousComponent}}:{oldPos:e.oldPos+o,lastComponent:{count:1,added:n,removed:s,previousComponent:a}}},extractCommon:function(e,n,s,o,r){for(var a=n.length,i=s.length,l=e.oldPos,u=l-o,f=0;u+1<a&&l+1<i&&this.equals(s[l+1],n[u+1],r);)u++,l++,f++,r.oneChangePerToken&&(e.lastComponent={count:1,previousComponent:e.lastComponent,added:!1,removed:!1});return f&&!r.oneChangePerToken&&(e.lastComponent={count:f,previousComponent:e.lastComponent,added:!1,removed:!1}),e.oldPos=l,u},equals:function(e,n,s){return s.comparator?s.comparator(e,n):e===n||s.ignoreCase&&e.toLowerCase()===n.toLowerCase()},removeEmpty:function(e){for(var n=[],s=0;s<e.length;s++)e[s]&&n.push(e[s]);return n},castInput:function(e){return e},tokenize:function(e){return Array.from(e)},join:function(e){return e.join("")},postProcess:function(e){return e}};function it(t,e,n,s,o){for(var r=[],a;e;)r.push(e),a=e.previousComponent,delete e.previousComponent,e=a;r.reverse();for(var i=0,l=r.length,u=0,f=0;i<l;i++){var c=r[i];if(c.removed)c.value=t.join(s.slice(f,f+c.count)),f+=c.count;else{if(!c.added&&o){var p=n.slice(u,u+c.count);p=p.map(function(g,h){var m=s[f+h];return m.length>g.length?m:g}),c.value=t.join(p)}else c.value=t.join(n.slice(u,u+c.count));u+=c.count,c.added||(f+=c.count)}}return r}function ut(t,e){var n;for(n=0;n<t.length&&n<e.length;n++)if(t[n]!=e[n])return t.slice(0,n);return t.slice(0,n)}function lt(t,e){var n;if(!t||!e||t[t.length-1]!=e[e.length-1])return"";for(n=0;n<t.length&&n<e.length;n++)if(t[t.length-(n+1)]!=e[e.length-(n+1)])return t.slice(-n);return t.slice(-n)}function ke(t,e,n){if(t.slice(0,e.length)!=e)throw Error("string ".concat(JSON.stringify(t)," doesn't start with prefix ").concat(JSON.stringify(e),"; this is a bug"));return n+t.slice(e.length)}function Le(t,e,n){if(!e)return t+n;if(t.slice(-e.length)!=e)throw Error("string ".concat(JSON.stringify(t)," doesn't end with suffix ").concat(JSON.stringify(e),"; this is a bug"));return t.slice(0,-e.length)+n}function W(t,e){return ke(t,e,"")}function me(t,e){return Le(t,e,"")}function ct(t,e){return e.slice(0,vs(t,e))}function vs(t,e){var n=0;t.length>e.length&&(n=t.length-e.length);var s=e.length;t.length<e.length&&(s=t.length);var o=Array(s),r=0;o[0]=0;for(var a=1;a<s;a++){for(e[a]==e[r]?o[a]=o[r]:o[a]=r;r>0&&e[a]!=e[r];)r=o[r];e[a]==e[r]&&r++}r=0;for(var i=n;i<t.length;i++){for(;r>0&&t[i]!=e[r];)r=o[r];t[i]==e[r]&&r++}return r}var ye="a-zA-Z0-9_\\u{C0}-\\u{FF}\\u{D8}-\\u{F6}\\u{F8}-\\u{2C6}\\u{2C8}-\\u{2D7}\\u{2DE}-\\u{2FF}\\u{1E00}-\\u{1EFF}",Cs=new RegExp("[".concat(ye,"]+|\\s+|[^").concat(ye,"]"),"ug"),xe=new _;xe.equals=function(t,e,n){return n.ignoreCase&&(t=t.toLowerCase(),e=e.toLowerCase()),t.trim()===e.trim()};xe.tokenize=function(t){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n;if(e.intlSegmenter){if(e.intlSegmenter.resolvedOptions().granularity!="word")throw new Error('The segmenter passed must have a granularity of "word"');n=Array.from(e.intlSegmenter.segment(t),function(r){return r.segment})}else n=t.match(Cs)||[];var s=[],o=null;return n.forEach(function(r){/\s/.test(r)?o==null?s.push(r):s.push(s.pop()+r):/\s/.test(o)?s[s.length-1]==o?s.push(s.pop()+r):s.push(o+r):s.push(r),o=r}),s};xe.join=function(t){return t.map(function(e,n){return n==0?e:e.replace(/^\s+/,"")}).join("")};xe.postProcess=function(t,e){if(!t||e.oneChangePerToken)return t;var n=null,s=null,o=null;return t.forEach(function(r){r.added?s=r:r.removed?o=r:((s||o)&&ft(n,o,s,r),n=r,s=null,o=null)}),(s||o)&&ft(n,o,s,null),t};function ft(t,e,n,s){if(e&&n){var o=e.value.match(/^\s*/)[0],r=e.value.match(/\s*$/)[0],a=n.value.match(/^\s*/)[0],i=n.value.match(/\s*$/)[0];if(t){var l=ut(o,a);t.value=Le(t.value,a,l),e.value=W(e.value,l),n.value=W(n.value,l)}if(s){var u=lt(r,i);s.value=ke(s.value,i,u),e.value=me(e.value,u),n.value=me(n.value,u)}}else if(n)t&&(n.value=n.value.replace(/^\s*/,"")),s&&(s.value=s.value.replace(/^\s*/,""));else if(t&&s){var f=s.value.match(/^\s*/)[0],c=e.value.match(/^\s*/)[0],p=e.value.match(/\s*$/)[0],g=ut(f,c);e.value=W(e.value,g);var h=lt(W(f,g),p);e.value=me(e.value,h),s.value=ke(s.value,f,h),t.value=Le(t.value,f,f.slice(0,f.length-h.length))}else if(s){var m=s.value.match(/^\s*/)[0],v=e.value.match(/\s*$/)[0],y=ct(v,m);e.value=me(e.value,y)}else if(t){var E=t.value.match(/\s*$/)[0],S=e.value.match(/^\s*/)[0],C=ct(E,S);e.value=W(e.value,C)}}var Ts=new _;Ts.tokenize=function(t){var e=new RegExp("(\\r?\\n)|[".concat(ye,"]+|[^\\S\\n\\r]+|[^").concat(ye,"]"),"ug");return t.match(e)||[]};var Ee=new _;Ee.tokenize=function(t,e){e.stripTrailingCr&&(t=t.replace(/\r\n/g,`
`));var n=[],s=t.split(/(\n|\r\n)/);s[s.length-1]||s.pop();for(var o=0;o<s.length;o++){var r=s[o];o%2&&!e.newlineIsToken?n[n.length-1]+=r:n.push(r)}return n};Ee.equals=function(t,e,n){return n.ignoreWhitespace?((!n.newlineIsToken||!t.includes(`
`))&&(t=t.trim()),(!n.newlineIsToken||!e.includes(`
`))&&(e=e.trim())):n.ignoreNewlineAtEof&&!n.newlineIsToken&&(t.endsWith(`
`)&&(t=t.slice(0,-1)),e.endsWith(`
`)&&(e=e.slice(0,-1))),_.prototype.equals.call(this,t,e,n)};function ys(t,e,n){return Ee.diff(t,e,n)}var xs=new _;xs.tokenize=function(t){return t.split(/(\S.+?[.!?])(?=\s+|$)/)};var Es=new _;Es.tokenize=function(t){return t.split(/([{}:;,]|\s+)/)};function Ne(t){"@babel/helpers - typeof";return Ne=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ne(t)}var ee=new _;ee.useLongestToken=!0;ee.tokenize=Ee.tokenize;ee.castInput=function(t,e){var n=e.undefinedReplacement,s=e.stringifyReplacer,o=s===void 0?function(r,a){return typeof a>"u"?n:a}:s;return typeof t=="string"?t:JSON.stringify(_e(t,null,null,o),o,"  ")};ee.equals=function(t,e,n){return _.prototype.equals.call(ee,t.replace(/,([\r\n])/g,"$1"),e.replace(/,([\r\n])/g,"$1"),n)};function _e(t,e,n,s,o){e=e||[],n=n||[],s&&(t=s(o,t));var r;for(r=0;r<e.length;r+=1)if(e[r]===t)return n[r];var a;if(Object.prototype.toString.call(t)==="[object Array]"){for(e.push(t),a=new Array(t.length),n.push(a),r=0;r<t.length;r+=1)a[r]=_e(t[r],e,n,s,o);return e.pop(),n.pop(),a}if(t&&t.toJSON&&(t=t.toJSON()),Ne(t)==="object"&&t!==null){e.push(t),a={},n.push(a);var i=[],l;for(l in t)Object.prototype.hasOwnProperty.call(t,l)&&i.push(l);for(i.sort(),r=0;r<i.length;r+=1)l=i[r],a[l]=_e(t[l],e,n,s,l);e.pop(),n.pop()}else a=t;return a}var Re=new _;Re.tokenize=function(t){return t.slice()};Re.join=Re.removeEmpty=function(t){return t};var pe=(t=>(t.ADDED="added",t.REMOVED="removed",t.UNCHANGED="unchanged",t))(pe||{});function Oe(t){if(t==="")return 0;const e=t.split(`
`).length;return t.endsWith(`
`)?e-1:e}function ws(t,e){return ys(t,e,{newlineIsToken:!0}).map(s=>({count:s.count??Oe(s.value),value:s.value,type:s.added?"added":s.removed?"removed":"unchanged"}))}function bs(t){let e="";for(const{type:n,value:s}of t)(n==="added"||n==="unchanged")&&(e+=s);return e}function Ms(t,e){const n=Oe(e),s=Is(t,n);return{changes:ws(s,e),numLinesDiffed:n}}function Ss(t){const e=[...t],n=[],s=[];for(;e.length>0;){const o=e[e.length-1];if(o.type===pe.REMOVED)e.pop(),o.type===pe.REMOVED&&n.unshift(o);else if(o.type===pe.ADDED)e.pop(),s.unshift(o);else break}return{prunedChanges:[...e,...s],prunedRemovedChanges:n}}function As(t,e){const{changes:n,numLinesDiffed:s}=Ms(t,e),{prunedChanges:o,prunedRemovedChanges:r}=Ss(n),a=bs(o),i=r.map(u=>u.value).join(`
`),l=Mt(t,s,"start");return{content:a+i+l,numLinesDiffed:Oe(a)}}function Is(t,e){if(e<=0)return"";let n=0,s=t.length;for(let o=0;o<t.length;o++)if(t[o]===`
`&&(n++,n===e)){s=o+1;break}return t.substring(0,s)}function Mt(t,e,n="start"){if(e<=0)return t;if(n==="start"){let a=0;for(let i=0;i<t.length;i++)if(t[i]===`
`&&(a++,a===e))return t.substring(i+1);return""}let s=0,o=-1;const r=t.endsWith(`
`)?e+1:e;for(let a=t.length-1;a>=0;a--)if(t[a]===`
`&&(s++,s===r)){o=a;break}return o===-1?"":t.substring(0,o+1)}function Ds(t,e){const n=t?.type??he.LOADING,s=t?.content??"",o=!!t?.isPartial;if(!Q(n)||e==null||!o||t?.isRewriting!==!0)return{content:s,currentlyStreamingLineIndex:null};const r=Mt(s,1,"end");if(r==="")return{content:e.content,currentlyStreamingLineIndex:0};const a=As(e.content,r);return{content:a.content,currentlyStreamingLineIndex:a.numLinesDiffed}}function ks(t,e){const n=new Set(t.map(i=>i.id)),s=new Set(e.map(i=>i.id)),o=t.filter(i=>!s.has(i.id)).map(i=>({...i,diffStatus:st.REMOVED})),r=e.filter(i=>!n.has(i.id)).map(i=>({...i,diffStatus:st.ADDED})),a=t.filter(i=>s.has(i.id));return o.concat(r,a)}function Ls({textdocVersion:t}){const e=U(),n=zt(),[s,o]=T.useState(!1),r=Gt(),a=T.useRef(t?.content??"");T.useEffect(()=>{a.current=t?.content??""},[t]);const i=l=>{s||(r(()=>{j.logButtonClick(Z.COPY,{contentLength:a.current.length,textdocType:t?.type}),sn(a.current,n,l)},0),o(!0),r(()=>o(!1),2e3))};return d.jsx(ve,{label:e.formatMessage(Ns.copy),children:d.jsx(X,{icon:s?Fn:Vn,onClick:i})})}const Ns=je({copy:{id:"rbIYfo",defaultMessage:"Copy"}});function _s({textdocId:t,version:e,isHistorical:n,isShowingChanges:s,latestVersionInt:o,nextVersion:r,previousVersion:a,onHoverPrevious:i,textdocType:l}){const u=U(),f=e==null||e===1,c=e!=null&&e>1;return f&&!n?null:d.jsxs("div",{className:"flex items-center gap-1.5",children:[d.jsx(ve,{label:c&&u.formatMessage({id:"PoD5+8",defaultMessage:"Previous version"}),children:d.jsx(X,{disabled:!c,icon:zn,onMouseOver:i,onClick:()=>{j.logButtonClick(Z.HISTORY_PREVIOUS,{textdocType:l,isShowingChanges:s,textdocId:t,versionInt:e}),t&&e&&c&&Ce(t,{beforeVersion:e},s&&a!=null?a:void 0)}})}),d.jsx(ve,{label:n&&u.formatMessage({id:"PJ8YVJ",defaultMessage:"Next version"}),children:d.jsx(X,{disabled:!n,icon:Gn,onClick:()=>{j.logButtonClick(Z.HISTORY_NEXT,{textdocType:l,isShowingChanges:s,textdocId:t,versionInt:e}),n&&(r?Ce(t,{version:r},s?r:void 0):s&&o?xt(t,o,null):K(t))}})})]})}function Rs({textdocId:t,textdocType:e,history:n,version:s,isShowingChanges:o,latestVersionInt:r,onMouseEnter:a}){const i=U(),[l,u]=T.useState(!1),f=()=>{n?Ce(t,n):K(t)},c=(s?.versionInt??0)>1,p=()=>{j.logButtonClick(Z.SHOW_CHANGES,{textdocType:e,textdocId:t,versionInt:s?.versionInt,latestVersionInt:r}),s?.versionInt!=null&&xt(t,s.versionInt,n)},g=()=>{u(!0),a?.()},h=()=>{u(!1)};return d.jsx(ve,{label:c&&i.formatMessage(o?dt.hideChanges:dt.showChanges),children:d.jsx(X,{icon:Wn,disabled:!c,onClick:o?f:p,onMouseEnter:g,onMouseLeave:h,className:ge("transition-colors",{"!bg-blue-400/20 !text-blue-400 transition-colors":l&&o&&c,"!bg-blue-400/15 !text-blue-400 transition-colors":!l&&o&&c})})})}const dt=je({done:{id:"0MCBfo",defaultMessage:"Done"},showChanges:{id:"3jMGNS",defaultMessage:"Show changes"},hideChanges:{id:"HWiQSk",defaultMessage:"Hide changes"}}),js=800,Os=100,mt=100,Ps=({textdocId:t,isHistoricalVersion:e,nextHistoricalTextdocVersion:n,previousHistoricalTextdocVersion:s,textdocVersion:o,readonlyReason:r,history:a,latestVersionInt:i,hasDebug:l,contentWidth:u,isEmbedded:f,isPersisting:c,isShowChangesFeatureEnabled:p,isShowingChanges:g,hideHistoryActions:h=!1,prefetchHistoricalTextdocVersion:m,restoreHistoricalTextdocVersion:v,setShowDebugView:y,onClose:E})=>{const S=on(o?.title??""),[{width:C},b]=Et(),k=u-C-Os-mt>0,M=wt();return d.jsxs(Y.Header,{children:[d.jsxs("div",{className:"flex flex-1 items-center leading-[0]",children:[d.jsx(Y.CloseButton,{onClick:E}),k&&d.jsx("div",{className:"flex flex-row items-center gap-2.5",children:d.jsx(Y.Title,{style:{maxWidth:u-C-mt},children:S||d.jsx("div",{className:"w-52",children:d.jsx(as,{lines:1,size:"base",width:100,widthVariance:0})})})}),c&&d.jsx(rn,{size:12,className:"pl-2 text-token-text-secondary"})]}),d.jsxs("div",{className:"flex select-none items-center gap-2 leading-[0]",ref:b,children:[d.jsxs("div",{className:ge("flex items-center gap-2 transition-opacity duration-500",r===N.Streaming&&"pointer-events-none opacity-0"),children:[l&&u>js&&d.jsx(X,{icon:Yn,onClick:()=>y(H=>!H)}),!h&&d.jsx(_s,{textdocId:t,isHistorical:e,isShowingChanges:g,version:o?.versionInt,previousVersion:s?.versionInt,nextVersion:n?.versionInt,readonlyReason:r,onHoverPrevious:m,onClickRestore:v,textdocType:o?.type,latestVersionInt:i}),!h&&p&&d.jsx(Rs,{textdocId:t,textdocType:o?.type,history:a,version:o,isShowingChanges:g,latestVersionInt:i,onMouseEnter:()=>{o?.versionInt&&M(t,o.versionInt),m()}}),d.jsx(Ls,{textdocVersion:o})]}),!f&&d.jsx(ts,{})]})]})},Hs=/\s/,qs=30;function ht(t,e){const n=t.indexOf(e);return n===-1?!1:t.indexOf(e,n+e.length)===-1}function P(t,e){return Hs.test(t[e])}function pt(t,e,n=!1){if(e===0||n&&P(t,e-1))return e;for(;e>0&&P(t,e-1);)e--;for(;e>0&&!P(t,e-1);)e--;return P(t,e)&&e++,e}function gt(t,e,n=!1){if(e===t.length||n&&P(t,e))return e;for(;e<t.length&&P(t,e);)e++;for(;e<t.length&&!P(t,e);)e++;return P(t,e-1)&&e--,e}function $s(t,e,n=!0,s=qs){if(t.start<0||t.end>e.length||t.start>t.end)throw new Error("Invalid commentSourceRange provided.");const o=e.substring(t.start,t.end);let r=t.start,a=t.end;n&&(r=pt(e,r,!0),a=gt(e,a,!0));let i=e.substring(r,t.start),l=e.substring(t.end,a),u=`${i}${o}${l}`;if(ht(e,u)&&(s==null||u.length>=s))return{before:i,after:l,allSurrounding:u};let f=r,c=a,p=!0;for(;p&&(s==null||u.length<s);){let g=!1;const h=f>0?pt(e,f):f;h<f&&(f=h,g=!0);const m=c<e.length?gt(e,c):c;if(m>c&&(c=m,g=!0),g){const v=e.substring(f,t.start),y=e.substring(t.end,c),E=`${v}${o}${y}`;if(ht(e,E)&&(s==null||E.length>=s))return{before:v,after:y,allSurrounding:E};i=v,l=y,u=E}else p=!1}return{before:i,after:l,allSurrounding:u}}const te="# Context",ne="# Instructions";function se(t,e,n){if(e==null||n==null)return`The user is referring to the entire text of "${t}".`;const s=`
## Selected Text
The user has selected this text in "${t}" in particular:
${e}
`.trim();return n.allSurrounding===e?s:`
${s}

## Surrounding Context
Here is the surrounding context:
${n.allSurrounding}
`.trim()}function St(t,e){return t==null||e==null?"entire document":t===e.allSurrounding?"selected text":"surrounding context"}function At(t){return`For the update pattern, create a regex which exactly matches the ${t}. Edit just this string in order to fullfill the user's request. NEVER rewrite the entire document. Instead, ALWAYS edit ONLY the ${t}. The only exception to this rule is if the ${t} includes markdown lists or tables. In that case, fully rewrite the document using ".*" as the regex update pattern.`.trim()}function Us(t,e,n,s){if(!Q(e)&&n&&s){const o=St(n,s);return`
${te}
The user requests that you directly edit the document.

${se(t,n,s)}

${ne}
Use the update_textdoc tool to make this edit. ${At(o)}`.trim()}return`
${te}
The user requests that you directly edit the document.

${se(t,n,s)}

${ne}
Use the update_textdoc tool to make this edit. You MUST fully rewrite the entire document by using ".*" as the update regex pattern.`.trim()}function Bs(t,e,n){return`
${te}
The user requests that you add comments about some text.

${se(t,e,n)}

${ne}
Do not respond to the user's question directly, just leave comments.`.trim()}function Fs(t,e){return Q(t)?e==="entire document"?` If you choose to update the ${e}, you MUST fully rewrite the ${e} by using ".*" as the update regex pattern.`:` If you choose to update the ${e}, you MUST fully rewrite the entire document by using ".*" as the update regex pattern. When you do so, ONLY modify the ${e} and rewrite other sections exactly as is, except for parts that must change based on this update`:e==="entire document"?"":` If you choose to update the ${e}, follow these instructions: ${At(e)}`}function Vs(t,e,n,s){const o=St(n,s),r=Fs(e,o);return`
${te}
${se(t,n,s)}

${ne}
The user would like you perform one of the following actions:
- Update the ${o} via the \`update_textdoc\` tool.${r}
- Explain the selected text via chat, or answer a general question about the selected text (no tool call required).
- Comment on the ${o} with feedback via the \`comment_textdoc\` tool. This should only be used if the user very explicitly asks for feedback, critique, or comments.

Based on the user's request, choose the appropriate action.
`.trim()}function zs(t,e,n){return`
${te}
${se(t,e,n)}

${ne}
The user would like you to create a new textdoc.
`.trim()}function Gs(t,e,n,s=null,o=null){switch(n){case F.ASK:return Vs(t,e,s,o);case F.CREATE_TEXTDOC:return zs(t,s,o);case F.EDIT:return Us(t,e,s,o);case F.COMMENT:return Bs(t,s,o)}}function Ws(t){const e=is(),n=Ln(t),s=us(t)??e.id,o=Nn({clientThreadId:t});return async function(r){const a=new an,i=Zn.getThreadCurrentLeafId(t),l=performance.now(),u=await Wt(),[f,c,p]=await Promise.all([Yt.getEnforcementToken(u),un.getEnforcementToken(u),Jt.getEnforcementToken(u)]);o({model:s,completionType:Qt.Next,parentNodeId:i,metadata:{eventSource:"mouse"},completionMetadata:{conversationMode:n},chatReq:u,arkoseToken:f??null,turnstileToken:c??null,proofToken:p??null,preflightTime:performance.now()-l,appendMessages:r,turnTracker:a})}}function Ys(t){switch(t){case I.ACCELERATOR:case I.ACCEPT_COMMENT:return!0;case I.ASK_CHATGPT:case I.FULL_SCREEN_SUBMIT:return!1}}function Js(t,e){switch(e){case I.ASK_CHATGPT:case I.ACCEPT_COMMENT:case I.FULL_SCREEN_SUBMIT:return t.formatMessage(Xs.askChatGPT);case I.ACCELERATOR:return}}const Qs=(t,e)=>{const n=Ws(t),s=U(),{tags:o}=ls(t);return T.useCallback(({content:r,sourceRange:a,action:i,userMessageType:l,acceleratorMetadata:u,selectionMetadata:f})=>{if(e?.versionInt==null)return;const{textdocId:c,type:p,versionInt:g,content:h}=e;let m,v=null;a&&a.start!==a.end&&(m=h.slice(a.start,a.end),v=$s(a,h));const y=Gs(c,p,i,m,v),S=ln(y,{exclude_after_next_user_message:!0});n([cn([r],{canvas:{textdoc_id:c,textdoc_type:p,version:g,textdoc_content_length:h.length,user_message_type:l,accelerator_metadata:u,selection_metadata:f},is_visually_hidden_from_conversation:Ys(l),targeted_reply:m,targeted_reply_label:Js(s,l),open_in_canvas_view:{type:"canvas_textdoc",id:c}}),S])},[n,s,e,o])},Xs=je({askChatGPT:{id:"h5ANdM",defaultMessage:"Asked ChatGPT"}});function Zs(t){const e=/\[([^\]]+)\]\((https?:\/\/[^\s)]+|www\.[^\s)]+)\)/gi,n=new Set,s=t.matchAll(e);for(const o of s){const r=o[2];try{let a=r;a.startsWith("www.")&&(a="http://"+r),new URL(a),n.add(r)}catch{}}return n}const Ks=async({lastVersion:t,textdocId:e,content:n,comments:s})=>{const o=fn(s,n);return(await Ct.safePost("/textdoc/{textdoc_id}",{parameters:{path:{textdoc_id:e}},requestBody:{version:t,content:n,comments:o}})).version},eo=()=>{const t=T.useRef([]),e=T.useRef(null),{mutateAsync:n,isPending:s}=Xt({mutationKey:["canvas","textdoc","persist"],mutationFn:Ks});return[T.useCallback(async(r,a,i)=>{const l=new AbortController,f=(async()=>{const[h]=t.current;try{await h?.promise}catch(m){j.logError("Saving document",m)}if(!l.signal.aborted)try{const m=Math.max(e.current??0,r.versionInt??bt);let v="";try{tt(a)?v=a():v=a}catch(C){j.logError("Serializing document",C)}let y=[];try{tt(i)?y=i():y=i}catch(C){j.logError("Adjusting comments",C)}const{textdocId:E}=r;dn({textdocId:E,basedOnVersionInt:m,content:v,comments:y});const S=await n({textdocId:E,lastVersion:m,content:v,comments:y});mn({textdocId:E,basedOnVersionInt:m,newVersion:S}),e.current=S}catch(m){j.logError("Error saving document",m)}finally{t.current.shift()}})(),c={abort:()=>l.abort(),promise:f},[p,g]=t.current;return g&&(g.abort(),t.current=p?[p]:[]),t.current=p?[p,c]:[c],f},[n]),t,s]},to=3e3,no=t=>{const[e,n,s]=eo(),o=U(),r=T.useRef(null),a=T.useCallback(hn(e,to,{leading:!1}),[e]),i=pn(t);return T.useEffect(()=>{if(!i)return;const u=nt(window,{pagehide:()=>a.flush(),beforeunload:c=>{a.flush(),c.returnValue=o.formatMessage({id:"QZrKwi",defaultMessage:"You have a canvas save in progress."})}}),f=nt(document,{visibilitychange:()=>a.flush(),keydown:()=>{r.current="keyboard"},mousemove:()=>{r.current!=="mouse"&&a.flush(),r.current="mouse"}});return()=>{r.current=null,f(),u()}},[o,i,a]),T.useEffect(()=>()=>{a.flush()},[t,a]),gn(async()=>{await a.flush(),await Promise.allSettled(n.current?.map(({promise:u})=>u)??[])}),[T.useCallback((u,f,c)=>{const{textdocId:p}=u;return vn(p),a(u,f,c)},[a]),a.flush,s||i]};function so(t,e,n){const s=Tt(),o=n!=null&&e!=null,{data:r,error:a,fetchNextPage:i,hasNextPage:l,isFetching:u}=Zt(vt(t,e,o)),f=T.useCallback(async()=>{const m=e!=null;await s.prefetchInfiniteQuery(vt(t,e,m))},[s,t,e]);T.useEffect(()=>{const m=e;return()=>{s.removeQueries({queryKey:It(t,m),exact:!0})}},[s,t,e]);const[c,p,g,h]=T.useMemo(()=>{if(r&&n){const v=r.pages.flatMap(E=>E),y=v.findIndex(E=>"beforeVersion"in n?(E.versionInt??bt)<n.beforeVersion:E.versionInt===n.version);if(y!==-1)return[y===v.length-1,v[y],y>0?v[y-1]:null,y<v.length-1?v[y+1]:null]}const m=r?.pages.flatMap(v=>v)??[];return[!0,null,null,m.length===0?null:m[0]]},[r,n]);return T.useEffect(()=>{!u&&o&&l&&c&&i()},[u,o,l,c,i]),T.useEffect(()=>{!p&&a&&K(t)},[p,a,t]),{historicalTextdocVersion:p,nextHistoricalTextdocVersion:g,prefetchHistoricalTextdocVersion:f,previousHistoricalTextdocVersion:h}}function It(t,e=null){return["textdocHistory",t,e]}function vt(t,e,n=!0){return{queryKey:It(t,e),queryFn:({pageParam:s})=>oo(t,s),initialPageParam:e??void 0,getNextPageParam:s=>{const o=Cn(s)?.versionInt;if(o&&o>1)return o},enabled:n,staleTime:1/0,retry:2}}async function oo(t,e){return e===void 0?[]:(await Ct.safeGet("/textdoc/{textdoc_id}/history",{parameters:{path:{textdoc_id:t},query:{before_version:e}}})).previous_doc_states.map(({id:s,version:o,textdoc_type:r,title:a,content:i,updated_at:l,comments:u})=>({textdocId:s,versionInt:o,messageId:null,title:a,type:Tn(r),content:i,createdAt:yn(l),comments:xn(u,i)}))}const Eo=({isFullScreen:t=!1,isEmbedded:e=!1,hideHeader:n=!1,readonlyReason:s,clientThreadId:o,focusedTextdoc:r,onClose:a,isAnimating:i=!1,width:l,hideBottomComposer:u=!1})=>{const{textdocId:f,history:c,showChangesAtVersion:p=null}=r,[g,h,m]=no(f),{targetedContent:v}=En(),y=ns(),[E,S]=T.useState(!1),C=ss(f),b=os(),k=Kn(o),M=wn(k),[H,oe]=Et(),q=bn(),{data:O,isLoading:Dt}=Mn(f,q?p:null),R=C?.versions??[],Pe=R[0]?.versionInt,{historicalTextdocVersion:re,nextHistoricalTextdocVersion:kt,previousHistoricalTextdocVersion:He,prefetchHistoricalTextdocVersion:Lt}=so(f,Pe,c),Nt=wt();T.useEffect(()=>{Te.reset()},[f]),T.useEffect(()=>{C?.metadata?.textdocId&&ot().sendMessage({type:De.Loaded})},[C?.metadata?.textdocId]);const qe=R.length>0?R[R.length-1]:null,we=R.length>1?R[R.length-2]:null,$e=es(o),{restoreHistoricalTextdocVersion:Ue,optimisticRestoredTextdocVersion:_t}=Sn($e,qe,re),V=c!=null,w=V?re:qe,ae=q&&p!=null,ie=Qs(o,w),Be=i||!q?null:O,ue=(()=>{if(i)return[];const x=w?.comments.filter(L=>L.status!==Dn.DISMISSED)??[];return w==null?x:!ae&&re!=null?re.comments:!ae||O==null?x:O.contentBefore!==O.contentAfter?[]:ks(O.commentsBefore,O.commentsAfter)})(),le=w?.type??he.LOADING,$=!!w?.isPartial,Rt=$n(b);T.useEffect(()=>{R.length===0&&!b&&Rt&&a?.()},[R.length,b]);const jt=!!s&&s!==N.OldVersion,be=$&&!!w?.isRewriting,Ot=$&&!!w?.isCreation,{content:ce,currentlyStreamingLineIndex:Fe}=O?.contentBefore!=null&&!Q(le)?{content:O.contentBefore,currentlyStreamingLineIndex:null}:Ds(w,we),Pt=cs($e,Array.from(Zs(ce))),[fe,Me]=fs({value:ce,isRequestActive:M,isTextdocStreaming:$,comments:ue}),Ve=An(w),ze=$||M||fe||m;T.useEffect(()=>{ot().sendMessage({type:De.Streaming,streaming:ze})},[ze]);const Ht=({getSerializedDocument:x,getAdjustedComments:D})=>{w&&g(w,x,D)},qt=x=>{if(!w)return;const D=x.doc.toString();g(w,D,x.field(Pn,!1)??[])},Ge=(x,D,L,B)=>{Me(!0),ie({action:D,content:x,userMessageType:I.ASK_CHATGPT,sourceRange:L,selectionMetadata:{selection_type:B,selection_position_range:L}})},We=({id:x})=>{Ve(x,rt.DISMISS),Te.reset()},Ye=async x=>{Me(!0);const{id:D,at:L,content:B}=x;if(await Ve(D,rt.ACCEPT)===!1)return Me(!1);ie({content:B,userMessageType:I.ACCEPT_COMMENT,sourceRange:L,action:F.EDIT,selectionMetadata:{selection_type:at.SELECTION,selection_position_range:L}})},Se=(x,D,L)=>{const{action:B}=L;ie({action:B,content:D,sourceRange:x,userMessageType:I.ACCELERATOR,acceleratorMetadata:{action:B,id:L.id,prompt:D},selectionMetadata:x!=null?{selection_type:at.SELECTION,selection_position_range:x}:void 0})},$t=x=>{ie({action:F.EDIT,content:x,userMessageType:I.FULL_SCREEN_SUBMIT})},Ut=Kt(),Bt=Tt(),Ft=rs(),Je=x=>Ft?.[x]??x,Ae=()=>jn({clientThreadId:o,currentRequestId:k,queryClient:Bt,isHistoryAndTrainingDisabled:Ut}),Vt=()=>{c?Ce(f,c):K(f)};let A=s;V?A=N.OldVersion:ae?A=N.ShowingChanges:_t!=null?A=N.Restoring:($||M)&&(A=N.Streaming);let de=null;const Qe=i||A!=null||fe,Xe=()=>{if(i&&ue.length>0)return G.ALL_HIDDEN;if(A==null)return G.ENABLED;switch(A){case N.Streaming:return G.ENABLED;case N.ShowingChanges:case N.OldVersion:return G.COMMENTS_READONLY;default:return G.ALL_HIDDEN}},Ze=t||i;let Ie=[];switch(le){case he.LOADING:de=d.jsx(On,{});break;case he.DOCUMENT:de=d.jsx(Rn,{value:ce,comments:ue,previousValue:we?.content,previousComments:we?.comments,isRewriting:be,isAnimatingFromPreview:i,getStableCommentId:Je,diff:Be,isRequestActive:M,isDisabled:A!=null||b,isWaitingForCommentResponse:fe,hideAccelerators:Ze,hideToolbar:Qe,hideEditOverlay:i,commentsMode:Xe(),readonlyReason:A,onBlur:h,onSave:h,onChange:Ht,onCancelRequest:Ae,targetedContent:v,onAddComment:Ge,onAcceptComment:Ye,onDismissComment:We,onSubmitAccelerator:Se,onExitShowChanges:Vt,safeUrls:Pt,width:l,modelCursor:$&&!be?w?.modelCursor:void 0,shouldResetSelection:w?.versionInt===1}),Ie=Un;break;default:Q(le)&&(de=d.jsx(_n,{id:"codemirror",getStableCommentId:Je,language:In(le),value:ce,comments:ue,hideAccelerators:Ze,commentsMode:Xe(),hideToolbar:Qe,onSubmitAccelerator:Se,currentlyStreamingLineIndex:Fe??null,readonlyReason:A,isRequestActive:M,isWaitingForCommentResponse:fe,onChange:qt,onCancelRequest:Ae,onAddComment:Ge,onDismissComment:We,onAcceptComment:Ye,textdocDiff:Be??void 0,modelCursor:$&&Fe==null?w?.modelCursor:void 0}),Ie=Hn)}return d.jsxs(Y,{children:[!n&&d.jsx(Ps,{textdocId:f,isHistoricalVersion:V,nextHistoricalTextdocVersion:kt,previousHistoricalTextdocVersion:He,textdocVersion:w,readonlyReason:A,history:c,hasDebug:y,contentWidth:H.width,isEmbedded:e,isPersisting:m,isShowChangesFeatureEnabled:q,isShowingChanges:ae,latestVersionInt:Pe,hideHistoryActions:A===N.QueryParam,prefetchHistoricalTextdocVersion:()=>{Lt();const x=He?.versionInt;x!=null&&Nt(f,x)},restoreHistoricalTextdocVersion:Ue,setShowDebugView:S,onClose:()=>{j.logButtonClick(Z.CLOSE_TEXTDOC,{textdocType:w?.type}),a?.()}}),d.jsxs(Y.Content,{ref:oe,scrollToBottomMode:Ot?"bottom":"top",shouldScrollToTop:be,isLoading:Dt,children:[!1,de]}),d.jsx(yt,{children:V&&!jt&&d.jsx(ds,{onClickRestore:Ue,onClickResetLatest:()=>K(f)})}),t&&!V&&!u&&d.jsx("div",{className:"relative flex items-center justify-center pb-3",children:d.jsx(gs,{isRequestActive:M,clientThreadId:o,onSubmitAccelerator:Se,onSubmit:$t,onCancel:Ae,acceleratorActions:Ie})})]})};export{De as C,Eo as T};
//# sourceMappingURL=gxmtfp29ecpvnpzs.js.map
