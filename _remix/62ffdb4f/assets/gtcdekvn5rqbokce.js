import{w as Q,L as P,r as d,al as F,be as _,j as U,ah as G,cS as j}from"./ornmk1um6pytkf56.js";import{c as h,d as q,e as J,R as B,g as R,a as E,V as M,b as v,I as K,f as D,h as b,r as W,L as X,i as z,j as g}from"./gokfnbl8hz79p9jm.js";import{p as N}from"./fhj1x6x5mv8ztzvu.js";import{r as Y}from"./jebpfhgxpd46kt5o.js";import{f as Z}from"./r910aebmjwqa8f6g.js";import{j as O,d as ee,T as k}from"./c8zxz05g6fozv2d6.js";import{bA as te}from"./fl6q9z66k3fbh83y.js";import{u as L}from"./h9d8gf8zabmyld3j.js";function $(){const t=Q("716722001").value,e=P("2436427643").value,a=P("1413999995").value;return{av:t,video:e,screenshare:a}}function ae(){oe(),ie(),se(),ne()}function ne(){const{room:t,debug:e}=h(),a=$(),s=a.video||a.av,c=d.useMemo(()=>{const n=["audioinput","audiooutput"];return s&&n.push("videoinput"),n},[s]);d.useEffect(()=>{async function n(){Promise.all(c.map(async o=>{const r=await B.getLocalDevices(o),u=t?.getActiveDevice(o);if(!r.find(m=>m.deviceId===u)){const m=await R(o);let y=null;m?y=m.deviceId:r[0]&&(y=r[0].deviceId),e(`switching ${o} to ${y}`),y&&await t?.switchActiveDevice(o,y)}}))}if(navigator)return navigator.mediaDevices.addEventListener("devicechange",n),()=>{navigator.mediaDevices.removeEventListener("devicechange",n)}},[t,e,c])}function oe(){const{room:t,debug:e}=h(),a=t?.getActiveDevice("audioinput"),s=t?.getActiveDevice("audiooutput");d.useEffect(()=>{async function c(){const n=(await R("audioinput"))?.deviceId,o=(await R("audiooutput"))?.deviceId,r=async()=>{n&&a!==n&&(e("switching audio input to default"),await t?.switchActiveDevice("audioinput",n))},u=async()=>{if(o&&s!==o){e("switching audio output to default");try{await t?.switchActiveDevice("audiooutput",o)}catch(S){e("failed to switch audio output",S)}}};await Promise.all([r(),u()])}c()},[a,s,e,t])}function ie(){const{isVideoEnabled:t,endStartingVideo:e}=q(),{room:a,debug:s}=h(),c=$(),n=c.video||c.av,o=n?a?.getActiveDevice("videoinput"):void 0;d.useEffect(()=>{async function r(){if(t)try{await a?.localParticipant.setCameraEnabled(!0),e(!0)}catch{e(!1)}else await a?.localParticipant.setCameraEnabled(!1)}a&&r()},[t,e,a]),d.useEffect(()=>{async function r(){const u=(await R("videoinput"))?.deviceId;await(async()=>{u&&o!==u&&(s("switching video input to default"),await a?.switchActiveDevice("videoinput",u))})()}n&&r()},[o,s,a,n])}function se(){const{room:t}=h(),{isScreenshareEnabled:e,endStartingScreenshare:a}=J();d.useEffect(()=>{async function s(){if(e)try{await t?.localParticipant.setScreenShareEnabled(!0,{video:{displaySurface:"monitor"}}),a(!0)}catch{a(!1)}else await t?.localParticipant.setScreenShareEnabled(!1)}t&&s()},[t,e,a])}function H(){const{debug:t}=h(),e=E(s=>s.conversationId),a=F();return d.useCallback(async s=>{const c=s,n=e&&!O(e)?e:void 0,o=c??n;if(o){t(`refetch conversationId ${o}`);try{await Z(o,!0)}catch(r){const u="Failed to update conversation";t(u,r),a.danger(u)}}},[e,t,a])}const ce=5e3,re=2e3,de=t=>{const{room:e}=h(),a=E(l=>l.disconnectPending),s=E(l=>l.server.remoteState===M.Speaking),c=E(l=>l.conversationId)??void 0,n=ee(c),o=d.useRef(!1),r=H(),u=_(),S=U();o.current=s||o.current;const m=d.useCallback(async l=>{clearTimeout(a),v.setState(A=>{A.disconnectPending=void 0}),e?.disconnect(),await r(n),v.setState(K);const w=n??l;w&&N(u,S,w),t?.refetchLater&&window.setTimeout(()=>{r(n)},re)},[a,e,r,n,t?.refetchLater,u,S]),y=o.current&&!n,T=d.useCallback(()=>{v.setState(l=>{l.disconnectPending=window.setTimeout(m,ce)})},[m]);return{disconnectPending:a!==void 0,shouldDelayDisconnect:y,delayDisconnect:T,immediateDisconnect:m}};function ue(){const t=U(),{room:e,debug:a,decoder:s}=h(),{disconnectPending:c,immediateDisconnect:n}=de(),o=H(),r=_(),u=d.useRef(!1);d.useEffect(()=>{const S=async f=>{const{new_state:i}=f;v.setState(p=>{p.server.remoteState=i})},m=async f=>{v.setState(i=>{i.server.usage=f})},y=async f=>{v.setState(i=>{i.server.toolUpdate={...f}})},T=async f=>{let i;try{i=JSON.parse(s.decode(f)),a("data recevied",i)}catch(p){a("error parsing data",p);return}switch(v.setState(p=>(p.server.messages.push({...i,timestamp:new Date,source:"remote"}),p)),i.type){case b.StateUpdate:a("state update",i.payload);const{new_state:p,delay_s:V}=i.payload;if(p===M.Listening&&!u.current){u.current=!0,performance.mark("voice_mode.end");const I=performance.measure("voice_mode","voice_mode.start","voice_mode.end").duration.toFixed(0);j.voiceMode.connect({durationMs:I})}p===M.Thinking&&V&&(a(`${e?.name} delay thinking state by ${V} seconds`),S({new_state:M.ListeningIntently,delay_s:V}),await new Promise(I=>setTimeout(I,V*1e3))),S(i.payload);break;case b.ConversationUpdate:{a("conversation update",i.payload);const I=v.getState().conversationId,{conversation_id:C}=i.payload;I&&O(I)&&(k.initThread(I,{kind:G.PrimaryAssistant}),k.setServerIdForNewThread(I,C),v.setState(x=>{x.conversationId=C}),N(te,t,C),Y(t)),await o(C),c&&n(C);break}case b.UsageUpdate:m(i.payload);break;case b.ToolUpdate:y(i.payload);break}},l=(f,i)=>{a("track published",f,i)},w=()=>{a("disconnected"),W()},A=(f,i)=>{i instanceof X&&(a(`Connection quality changed for participant ${i.identity}: ${f}`),v.setState(p=>{p.server.voiceConnectionQuality=f}))};return e?.on(D.DataReceived,T),e?.on(D.TrackPublished,l),e?.on(D.ConnectionQualityChanged,A),e?.on(D.Disconnected,w),()=>{e?.off(D.DataReceived,T),e?.off(D.TrackPublished,l),e?.off(D.ConnectionQualityChanged,A),e?.off(D.Disconnected,w)}},[t,e,o,a,s,r,c,n])}function ve(){le(),fe(),pe(),Se()}function le(){const{room:t}=h();d.useEffect(()=>{v.setState(e=>{e.dev.room=t})},[t])}function fe(){const{room:t}=h(),e=z(t);d.useEffect(()=>{v.setState(a=>{a.server.connectionState=e})},[e])}function pe(){const{room:t,debug:e,encoder:a}=h();d.useEffect(()=>{const s=!!v.getState().server.actions;if(t&&!s){const c=async n=>{e("publishing action",n);const o={type:b.ActionRequest,payload:{action:n}};await t.localParticipant.publishData(a.encode(JSON.stringify(o)),{reliable:!0}),v.setState(r=>{r.server.messages.push({...o,timestamp:new Date,source:"local"})})};v.setState(n=>{n.server.actions={[g.StartListeningIntently]:()=>c(g.StartListeningIntently),[g.StopListeningIntently]:()=>c(g.StopListeningIntently),[g.HaltAllActivity]:()=>c(g.HaltAllActivity),[g.ResumeListening]:()=>c(g.ResumeListening),[g.RelayMessage]:()=>c(g.RelayMessage)}})}},[t,e,a])}function Se(){const t=v(e=>e.isVoiceModeActive);d.useEffect(()=>(L.setState({isVoiceActive:t}),()=>{L.setState({isVoiceActive:!1})}),[t])}const be=d.memo(function(){return ue(),ve(),ae(),null});export{be as V,$ as a,de as u};
//# sourceMappingURL=gtcdekvn5rqbokce.js.map
