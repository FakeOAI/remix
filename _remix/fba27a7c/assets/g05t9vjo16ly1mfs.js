import{r as C,V as $,l as c,bc as Me,X as V,R as Ke,m as Ie,aJ as qt,dX as $t,a0 as Le,Z as Ut,cY as Ht,cZ as Ft,c_ as Bt,e3 as Vt,f as pt,e as zt,fy as et,d1 as tt,u as gt,d7 as Gt,dN as Yt}from"./l5rf55y8gpic9j7j.js";import{e2 as Jt,fd as Wt,iV as Xt,G as vt,iW as ae,iX as me,T as le,N as J,fn as O,hV as ce,Y as Qt,iY as ke,fq as he,iZ as Ct,i_ as Zt,i$ as Kt,j0 as en,ix as yt,iU as tn,as as j,b$ as nn,cf as sn,j1 as rn,j2 as on,j3 as k,j4 as an,hM as Tt,j5 as un,j6 as ln,d as cn,j7 as fn,j8 as dn,j9 as mn,fc as hn,hv as pn,f8 as gn,hw as vn,fa as Cn,dr as yn,ja as Tn,jb as Se,jc as xn,jd as wn,je as En,fr as bn,jf as Sn,jg as nt}from"./c8ww2t9q7rwlhved.js";import{C as Mn,t as G,g as In,v as kn,w as An,x as Dn,y as Nn,z as Rn}from"./hhndevom81hqjije.js";import{e as _n,C as Ln}from"./chfv6vbnigxawfjy.js";import{C as fe,w as jn,S as F,x as st}from"./n7h7w1vm4f0z2mu5.js";import{m as Y}from"./c3evsddbj4url2js.js";import{D as On}from"./md38s2ry2qvejb8x.js";import{bG as Pn,by as qn,Y as $n,bI as Un,bJ as Hn,av as Fn,y as Bn}from"./hxwnvznhtn7zt599.js";import{i as Vn}from"./m0rry74g6mtwf8hx.js";import{r as zn,s as Gn,T as Yn,p as Jn,b as Wn}from"./kfqicesy8adidsoj.js";import{L as Xn,g as Qn,h as Zn,i as Kn}from"./b4ve8i43g8dzy4nm.js";import{P as es}from"./kpq79bmjrg2cdmv0.js";import{J as ts,a as ns}from"./hlx564c7m7nbdo16.js";import{u as ss}from"./o71s28u01641zi2u.js";const rs=({isTextdocStreaming:t,isRequestActive:e,value:n,comments:s})=>{const[r,o]=C.useState(!1);return C.useEffect(()=>{t&&r&&(o(!1),fe.reset())},[n,s]),C.useEffect(()=>{e||(o(!1),fe.reset())},[e]),[r,o]};function os({onClickRestore:t,onClickResetLatest:e}){const n=$();return c.jsx(Y.div,{initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{bounce:0,duration:.24},className:"absolute bottom-0 left-0 z-30 w-full items-center border-t border-gray-100 bg-token-main-surface-primary p-6 shadow-[0_-4px_32px_rgba(0,0,0,0.08)] @container dark:border-token-border-xlight dark:shadow-[0_-4px_32px_rgba(0,0,0,0.12)] lg:border-l",children:c.jsxs("div",{className:"mx-auto flex max-w-[48rem] flex-col flex-wrap justify-center gap-5 @2xl:flex-row @2xl:justify-between",children:[c.jsxs("div",{className:"flex flex-col px-2 text-center @2xl:text-start",children:[c.jsx("span",{className:"text-md text-wrap font-semibold",children:n.formatMessage({id:"gt23pb",defaultMessage:"You are viewing a previous version"})}),c.jsx("span",{className:"text-wrap text-sm text-token-text-secondary",children:n.formatMessage({id:"sAlUJn",defaultMessage:"Restore this version to make edits"})})]}),c.jsxs("div",{className:"flex flex-wrap items-center justify-center gap-4",children:[c.jsx(Me,{as:"button",color:"primary",onClick:t,children:n.formatMessage({id:"+cddAb",defaultMessage:"Restore this version"})}),c.jsx(Me,{as:"button",color:"secondary",onClick:e,children:n.formatMessage({id:"qCD3eu",defaultMessage:"Back to latest version"})})]})]})})}const as={type:"spring",damping:35,stiffness:300},is=({clientThreadId:t,turn:e})=>{const n=Jt(),s=Wt(e.messages);return c.jsxs(Y.div,{className:"absolute left-0 right-0 top-0 z-10 -translate-y-full",children:[c.jsx(Y.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 bg-vert-light-gradient dark:bg-vert-dark-gradient"}),c.jsx(Y.div,{className:"flex items-center px-6 py-2",initial:{opacity:.75,translateX:-50,translateY:"100%"},animate:{opacity:1,translateX:0,translateY:"0"},exit:{opacity:0,translateY:20},transition:as,children:c.jsx(Mn,{clientThreadId:t,onChangeItemInView:V,onRequestCompletion:async r=>V(r),onRequestMoreCompletions:V,groupedMessagesToRender:s,allGroupedMessages:s,isEditing:!1,isUserTurn:!0,turnIndex:0,isCompletionRequestInProgress:!1,isFeedbackEnabled:!1,isFinalTurn:!1,hasActiveRequest:n,showEditButton:!1,handleEnterEdit:V,handleExitEdit:V})})]},"user-message")},us=({clientThreadId:t})=>{const e=zn(t),n=Gn(t,e),{lastUserTurn:s,lastAssistantTurn:r}=C.useMemo(()=>{let a=null,i=null;for(let l=n.length-1;l>0;l--){const u=n[l];if(!a&&u.role===Ke.User?a=u:!i&&u.role===Ke.Assistant&&(i=u),a&&i)break}return{lastUserTurn:a,lastAssistantTurn:i}},[n]),o=s&&!r?.messages.find(({message:a})=>a.recipient?.startsWith(Xt));return c.jsx(vt,{initial:!1,children:o&&c.jsx(is,{turn:s,clientThreadId:t})})},ls=({isRequestActive:t=!1,clientThreadId:e,onCancel:n,onSubmit:s,onSubmitAccelerator:r,acceleratorActions:o=[]})=>{const[a,i]=C.useState(""),[l,u]=C.useState(!0),f=$(),d=()=>{s?.(a),i("")},p=g=>{const{metaKey:m,shiftKey:h,key:y}=g;y==="Enter"&&a.trim()&&!(h||m)&&(d(),g.preventDefault())};return c.jsxs("div",{className:"relative mb-3 flex max-w-2xl flex-1 justify-center",children:[c.jsx(us,{clientThreadId:e}),c.jsx("div",{className:"flex flex-auto items-start",children:c.jsx("div",{className:Ie("mx-6 flex min-h-12 flex-auto items-center bg-[#f4f4f4] py-1 pl-6 pr-2 dark:bg-token-main-surface-secondary",{"rounded-full":l,"rounded-2xl":!l}),children:c.jsxs("div",{className:"relative flex flex-auto items-center self-stretch",children:[c.jsx(Vn,{placeholder:f.formatMessage({id:"zrUbTJ",defaultMessage:"Ask ChatGPT to edit"}),disabled:t,value:a,className:"w-full resize-none border-0 bg-transparent p-0 text-token-text-primary outline-0 placeholder:text-token-text-secondary focus:ring-0 focus-visible:ring-0",maxRows:4,onChange:({target:{value:g}})=>i(g),onKeyDown:p,onHeightChange:(g,{rowHeight:m})=>u(Math.floor(g/m)<=1)}),a?c.jsx(Y.button,{className:Ie("dark h-8 w-8 rounded-full bg-token-main-surface-primary text-center dark:bg-token-main-surface-primary",{"self-end":!l}),initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{type:"tween",duration:.1},onMouseDown:()=>d(),children:c.jsx(Pn,{className:"h-8 w-8 text-token-text-primary"})}):(o?.length??0)>0&&c.jsx(jn,{disableHint:!0,isEmbeddedInPromptArea:!0,isRequestActive:t,actions:o,onCancel:n,onSubmit:r,right:0,bottom:4})]})})})]})};function D(){}D.prototype={diff:function(e,n){var s,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},o=r.callback;typeof r=="function"&&(o=r,r={});var a=this;function i(v){return v=a.postProcess(v,r),o?(setTimeout(function(){o(v)},0),!0):v}e=this.castInput(e,r),n=this.castInput(n,r),e=this.removeEmpty(this.tokenize(e,r)),n=this.removeEmpty(this.tokenize(n,r));var l=n.length,u=e.length,f=1,d=l+u;r.maxEditLength!=null&&(d=Math.min(d,r.maxEditLength));var p=(s=r.timeout)!==null&&s!==void 0?s:1/0,g=Date.now()+p,m=[{oldPos:-1,lastComponent:void 0}],h=this.extractCommon(m[0],n,e,0,r);if(m[0].oldPos+1>=u&&h+1>=l)return i(rt(a,m[0].lastComponent,n,e,a.useLongestToken));var y=-1/0,E=1/0;function x(){for(var v=Math.max(y,-f);v<=Math.min(E,f);v+=2){var S=void 0,M=m[v-1],R=m[v+1];M&&(m[v-1]=void 0);var B=!1;if(R){var _=R.oldPos-v;B=R&&0<=_&&_<l}var K=M&&M.oldPos+1<u;if(!B&&!K){m[v]=void 0;continue}if(!K||B&&M.oldPos<R.oldPos?S=a.addToPath(R,!0,!1,0,r):S=a.addToPath(M,!1,!0,1,r),h=a.extractCommon(S,n,e,v,r),S.oldPos+1>=u&&h+1>=l)return i(rt(a,S.lastComponent,n,e,a.useLongestToken));m[v]=S,S.oldPos+1>=u&&(E=Math.min(E,v-1)),h+1>=l&&(y=Math.max(y,v+1))}f++}if(o)(function v(){setTimeout(function(){if(f>d||Date.now()>g)return o();x()||v()},0)})();else for(;f<=d&&Date.now()<=g;){var b=x();if(b)return b}},addToPath:function(e,n,s,r,o){var a=e.lastComponent;return a&&!o.oneChangePerToken&&a.added===n&&a.removed===s?{oldPos:e.oldPos+r,lastComponent:{count:a.count+1,added:n,removed:s,previousComponent:a.previousComponent}}:{oldPos:e.oldPos+r,lastComponent:{count:1,added:n,removed:s,previousComponent:a}}},extractCommon:function(e,n,s,r,o){for(var a=n.length,i=s.length,l=e.oldPos,u=l-r,f=0;u+1<a&&l+1<i&&this.equals(s[l+1],n[u+1],o);)u++,l++,f++,o.oneChangePerToken&&(e.lastComponent={count:1,previousComponent:e.lastComponent,added:!1,removed:!1});return f&&!o.oneChangePerToken&&(e.lastComponent={count:f,previousComponent:e.lastComponent,added:!1,removed:!1}),e.oldPos=l,u},equals:function(e,n,s){return s.comparator?s.comparator(e,n):e===n||s.ignoreCase&&e.toLowerCase()===n.toLowerCase()},removeEmpty:function(e){for(var n=[],s=0;s<e.length;s++)e[s]&&n.push(e[s]);return n},castInput:function(e){return e},tokenize:function(e){return Array.from(e)},join:function(e){return e.join("")},postProcess:function(e){return e}};function rt(t,e,n,s,r){for(var o=[],a;e;)o.push(e),a=e.previousComponent,delete e.previousComponent,e=a;o.reverse();for(var i=0,l=o.length,u=0,f=0;i<l;i++){var d=o[i];if(d.removed)d.value=t.join(s.slice(f,f+d.count)),f+=d.count;else{if(!d.added&&r){var p=n.slice(u,u+d.count);p=p.map(function(g,m){var h=s[f+m];return h.length>g.length?h:g}),d.value=t.join(p)}else d.value=t.join(n.slice(u,u+d.count));u+=d.count,d.added||(f+=d.count)}}return o}function ot(t,e){var n;for(n=0;n<t.length&&n<e.length;n++)if(t[n]!=e[n])return t.slice(0,n);return t.slice(0,n)}function at(t,e){var n;if(!t||!e||t[t.length-1]!=e[e.length-1])return"";for(n=0;n<t.length&&n<e.length;n++)if(t[t.length-(n+1)]!=e[e.length-(n+1)])return t.slice(-n);return t.slice(-n)}function Ae(t,e,n){if(t.slice(0,e.length)!=e)throw Error("string ".concat(JSON.stringify(t)," doesn't start with prefix ").concat(JSON.stringify(e),"; this is a bug"));return n+t.slice(e.length)}function De(t,e,n){if(!e)return t+n;if(t.slice(-e.length)!=e)throw Error("string ".concat(JSON.stringify(t)," doesn't end with suffix ").concat(JSON.stringify(e),"; this is a bug"));return t.slice(0,-e.length)+n}function z(t,e){return Ae(t,e,"")}function oe(t,e){return De(t,e,"")}function it(t,e){return e.slice(0,cs(t,e))}function cs(t,e){var n=0;t.length>e.length&&(n=t.length-e.length);var s=e.length;t.length<e.length&&(s=t.length);var r=Array(s),o=0;r[0]=0;for(var a=1;a<s;a++){for(e[a]==e[o]?r[a]=r[o]:r[a]=o;o>0&&e[a]!=e[o];)o=r[o];e[a]==e[o]&&o++}o=0;for(var i=n;i<t.length;i++){for(;o>0&&t[i]!=e[o];)o=r[o];t[i]==e[o]&&o++}return o}var de="a-zA-Z0-9_\\u{C0}-\\u{FF}\\u{D8}-\\u{F6}\\u{F8}-\\u{2C6}\\u{2C8}-\\u{2D7}\\u{2DE}-\\u{2FF}\\u{1E00}-\\u{1EFF}",fs=new RegExp("[".concat(de,"]+|\\s+|[^").concat(de,"]"),"ug"),pe=new D;pe.equals=function(t,e,n){return n.ignoreCase&&(t=t.toLowerCase(),e=e.toLowerCase()),t.trim()===e.trim()};pe.tokenize=function(t){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n;if(e.intlSegmenter){if(e.intlSegmenter.resolvedOptions().granularity!="word")throw new Error('The segmenter passed must have a granularity of "word"');n=Array.from(e.intlSegmenter.segment(t),function(o){return o.segment})}else n=t.match(fs)||[];var s=[],r=null;return n.forEach(function(o){/\s/.test(o)?r==null?s.push(o):s.push(s.pop()+o):/\s/.test(r)?s[s.length-1]==r?s.push(s.pop()+o):s.push(r+o):s.push(o),r=o}),s};pe.join=function(t){return t.map(function(e,n){return n==0?e:e.replace(/^\s+/,"")}).join("")};pe.postProcess=function(t,e){if(!t||e.oneChangePerToken)return t;var n=null,s=null,r=null;return t.forEach(function(o){o.added?s=o:o.removed?r=o:((s||r)&&ut(n,r,s,o),n=o,s=null,r=null)}),(s||r)&&ut(n,r,s,null),t};function ut(t,e,n,s){if(e&&n){var r=e.value.match(/^\s*/)[0],o=e.value.match(/\s*$/)[0],a=n.value.match(/^\s*/)[0],i=n.value.match(/\s*$/)[0];if(t){var l=ot(r,a);t.value=De(t.value,a,l),e.value=z(e.value,l),n.value=z(n.value,l)}if(s){var u=at(o,i);s.value=Ae(s.value,i,u),e.value=oe(e.value,u),n.value=oe(n.value,u)}}else if(n)t&&(n.value=n.value.replace(/^\s*/,"")),s&&(s.value=s.value.replace(/^\s*/,""));else if(t&&s){var f=s.value.match(/^\s*/)[0],d=e.value.match(/^\s*/)[0],p=e.value.match(/\s*$/)[0],g=ot(f,d);e.value=z(e.value,g);var m=at(z(f,g),p);e.value=oe(e.value,m),s.value=Ae(s.value,f,m),t.value=De(t.value,f,f.slice(0,f.length-m.length))}else if(s){var h=s.value.match(/^\s*/)[0],y=e.value.match(/\s*$/)[0],E=it(y,h);e.value=oe(e.value,E)}else if(t){var x=t.value.match(/\s*$/)[0],b=e.value.match(/^\s*/)[0],v=it(x,b);e.value=z(e.value,v)}}var ds=new D;ds.tokenize=function(t){var e=new RegExp("(\\r?\\n)|[".concat(de,"]+|[^\\S\\n\\r]+|[^").concat(de,"]"),"ug");return t.match(e)||[]};var ge=new D;ge.tokenize=function(t,e){e.stripTrailingCr&&(t=t.replace(/\r\n/g,`
`));var n=[],s=t.split(/(\n|\r\n)/);s[s.length-1]||s.pop();for(var r=0;r<s.length;r++){var o=s[r];r%2&&!e.newlineIsToken?n[n.length-1]+=o:n.push(o)}return n};ge.equals=function(t,e,n){return n.ignoreWhitespace?((!n.newlineIsToken||!t.includes(`
`))&&(t=t.trim()),(!n.newlineIsToken||!e.includes(`
`))&&(e=e.trim())):n.ignoreNewlineAtEof&&!n.newlineIsToken&&(t.endsWith(`
`)&&(t=t.slice(0,-1)),e.endsWith(`
`)&&(e=e.slice(0,-1))),D.prototype.equals.call(this,t,e,n)};function ms(t,e,n){return ge.diff(t,e,n)}var hs=new D;hs.tokenize=function(t){return t.split(/(\S.+?[.!?])(?=\s+|$)/)};var ps=new D;ps.tokenize=function(t){return t.split(/([{}:;,]|\s+)/)};function Ne(t){"@babel/helpers - typeof";return Ne=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ne(t)}var W=new D;W.useLongestToken=!0;W.tokenize=ge.tokenize;W.castInput=function(t,e){var n=e.undefinedReplacement,s=e.stringifyReplacer,r=s===void 0?function(o,a){return typeof a>"u"?n:a}:s;return typeof t=="string"?t:JSON.stringify(Re(t,null,null,r),r,"  ")};W.equals=function(t,e,n){return D.prototype.equals.call(W,t.replace(/,([\r\n])/g,"$1"),e.replace(/,([\r\n])/g,"$1"),n)};function Re(t,e,n,s,r){e=e||[],n=n||[],s&&(t=s(r,t));var o;for(o=0;o<e.length;o+=1)if(e[o]===t)return n[o];var a;if(Object.prototype.toString.call(t)==="[object Array]"){for(e.push(t),a=new Array(t.length),n.push(a),o=0;o<t.length;o+=1)a[o]=Re(t[o],e,n,s,r);return e.pop(),n.pop(),a}if(t&&t.toJSON&&(t=t.toJSON()),Ne(t)==="object"&&t!==null){e.push(t),a={},n.push(a);var i=[],l;for(l in t)Object.prototype.hasOwnProperty.call(t,l)&&i.push(l);for(i.sort(),o=0;o<i.length;o+=1)l=i[o],a[l]=Re(t[l],e,n,s,l);e.pop(),n.pop()}else a=t;return a}var _e=new D;_e.tokenize=function(t){return t.slice()};_e.join=_e.removeEmpty=function(t){return t};var ie=(t=>(t.ADDED="added",t.REMOVED="removed",t.UNCHANGED="unchanged",t))(ie||{});function je(t){if(t==="")return 0;const e=t.split(`
`).length;return t.endsWith(`
`)?e-1:e}function gs(t,e){return ms(t,e,{newlineIsToken:!0}).map(s=>({count:s.count??je(s.value),value:s.value,type:s.added?"added":s.removed?"removed":"unchanged"}))}function vs(t){let e="";for(const{type:n,value:s}of t)(n==="added"||n==="unchanged")&&(e+=s);return e}function Cs(t,e){const n=je(e),s=xs(t,n);return{changes:gs(s,e),numLinesDiffed:n}}function ys(t){const e=[...t],n=[],s=[];for(;e.length>0;){const r=e[e.length-1];if(r.type===ie.REMOVED)e.pop(),r.type===ie.REMOVED&&n.unshift(r);else if(r.type===ie.ADDED)e.pop(),s.unshift(r);else break}return{prunedChanges:[...e,...s],prunedRemovedChanges:n}}function Ts(t,e){const{changes:n,numLinesDiffed:s}=Cs(t,e),{prunedChanges:r,prunedRemovedChanges:o}=ys(n),a=vs(r),i=o.map(u=>u.value).join(`
`),l=xt(t,s,"start");return{content:a+i+l,numLinesDiffed:je(a)}}function xs(t,e){if(e<=0)return"";let n=0,s=t.length;for(let r=0;r<t.length;r++)if(t[r]===`
`&&(n++,n===e)){s=r+1;break}return t.substring(0,s)}function xt(t,e,n="start"){if(e<=0)return t;if(n==="start"){let a=0;for(let i=0;i<t.length;i++)if(t[i]===`
`&&(a++,a===e))return t.substring(i+1);return""}let s=0,r=-1;const o=t.endsWith(`
`)?e+1:e;for(let a=t.length-1;a>=0;a--)if(t[a]===`
`&&(s++,s===o)){r=a;break}return r===-1?"":t.substring(0,r+1)}function ws(t,e){const n=t?.type??ae.LOADING,s=t?.content??"",r=!!t?.isPartial;if(!me(n)||e==null||!r||t?.isRewriting!==!0)return{content:s,currentlyStreamingLineIndex:null};const o=xt(s,1,"end");if(o==="")return{content:e.content,currentlyStreamingLineIndex:0};const a=Ts(e.content,o);return{content:a.content,currentlyStreamingLineIndex:a.numLinesDiffed}}var ue=(t=>(t.Close="close",t.Loaded="loaded",t.Streaming="streaming",t.Download="download",t))(ue||{});function Es({textdocVersion:t}){const e=$(),n=qt(),[s,r]=C.useState(!1),o=$t(),a=C.useRef(t?.content??"");C.useEffect(()=>{a.current=t?.content??""},[t]);const i=l=>{s||(o(()=>{O.logButtonClick(ce.COPY,{contentLength:a.current.length,textdocType:t?.type}),Qt(a.current,n,l)},0),r(!0),o(()=>r(!1),2e3))};return c.jsx(le,{label:e.formatMessage(bs.copy),children:c.jsx(J,{icon:s?qn:$n,onClick:i})})}const bs=Le({copy:{id:"rbIYfo",defaultMessage:"Copy"}});function Ss({textdocId:t,version:e,isHistorical:n,nextVersion:s,onHoverPrevious:r,textdocType:o}){const a=$(),i=e==null||e===1,l=e!=null&&e>1;return i&&!n?null:c.jsxs("div",{className:"flex items-center gap-1.5",children:[c.jsx(le,{label:l&&a.formatMessage({id:"PoD5+8",defaultMessage:"Previous version"}),children:c.jsx(J,{disabled:!l,icon:Un,onMouseOver:r,onClick:()=>{O.logButtonClick(ce.HISTORY_PREVIOUS,{textdocType:o}),t&&e&&l&&ke(t,{beforeVersion:e})}})}),c.jsx(le,{label:n&&a.formatMessage({id:"PJ8YVJ",defaultMessage:"Next version"}),children:c.jsx(J,{disabled:!n,icon:Hn,onClick:()=>{O.logButtonClick(ce.HISTORY_NEXT,{textdocType:o}),n&&(s?ke(t,{version:s}):he(t))}})})]})}function Ms({textdocId:t,history:e,version:n,isShowingChanges:s}){const{data:r}=Ct(t,n?.versionInt??null),o=Zt(),a=$(),i=r?.textdocEdits??[],l=()=>{e?ke(t,e):he(t)};if(s)return c.jsx(Me,{color:"primary",onClick:l,children:c.jsx(Ut,{...lt.done})});const u=n&&i.length>0,f=()=>{n?.versionInt!=null&&Kt(t,n.versionInt)},d=()=>{n?.versionInt!=null&&o(t,n.versionInt)};return c.jsx(le,{label:u&&a.formatMessage(lt.showChanges),children:c.jsx(J,{icon:Fn,disabled:!u,onClick:f,onMouseOver:d})})}const lt=Le({done:{id:"0MCBfo",defaultMessage:"Done"},showChanges:{id:"3jMGNS",defaultMessage:"Show changes"}}),Is=800,ks=100,ct=100,As=({textdocId:t,isHistoricalVersion:e,nextHistoricalTextdocVersion:n,textdocVersion:s,readonlyReason:r,history:o,hasDebug:a,contentWidth:i,isEmbedded:l,isPersisting:u,isShowChangesFeatureEnabled:f,isShowingChanges:d,hideHistoryActions:p=!1,prefetchHistoricalTextdocVersion:g,restoreHistoricalTextdocVersion:m,setShowDebugView:h,onClose:y})=>{const E=en(s?.title??""),[{width:x},b]=yt(),v=i-x-ks-ct>0;return c.jsxs(G.Header,{children:[c.jsxs("div",{className:"flex flex-1 items-center leading-[0]",children:[c.jsx(G.CloseButton,{onClick:y}),v&&c.jsx("div",{className:"flex flex-row items-center gap-2.5",children:c.jsx(G.Title,{style:{maxWidth:i-x-ct},children:E||c.jsx("div",{className:"w-52",children:c.jsx(es,{lines:1,size:"base",width:100,widthVariance:0})})})}),u&&c.jsx(tn,{size:12,className:"pl-2 text-token-text-secondary"})]}),c.jsxs("div",{className:"flex select-none items-center gap-2 leading-[0]",ref:b,children:[c.jsxs("div",{className:Ie("flex items-center gap-2 transition-opacity duration-500",r===j.Streaming&&"pointer-events-none opacity-0"),children:[a&&i>Is&&c.jsx(J,{icon:Bn,onClick:()=>h(S=>!S)}),!d&&!p&&c.jsx(Ss,{textdocId:t,isHistorical:e,version:s?.versionInt,nextVersion:n?.versionInt,readonlyReason:r,onHoverPrevious:g,onClickRestore:m,textdocType:s?.type}),!p&&f&&c.jsx(Ms,{textdocId:t,history:o,version:s,isShowingChanges:d}),c.jsx(Es,{textdocVersion:s})]}),!l&&!d&&c.jsx(Xn,{})]})]})},Ds=/\s/,Ns=30;function ft(t,e){const n=t.indexOf(e);return n===-1?!1:t.indexOf(e,n+e.length)===-1}function P(t,e){return Ds.test(t[e])}function dt(t,e,n=!1){if(e===0||n&&P(t,e-1))return e;for(;e>0&&P(t,e-1);)e--;for(;e>0&&!P(t,e-1);)e--;return P(t,e)&&e++,e}function mt(t,e,n=!1){if(e===t.length||n&&P(t,e))return e;for(;e<t.length&&P(t,e);)e++;for(;e<t.length&&!P(t,e);)e++;return P(t,e-1)&&e--,e}function Rs(t,e,n=!0,s=Ns){if(t.start<0||t.end>e.length||t.start>t.end)throw new Error("Invalid commentSourceRange provided.");const r=e.substring(t.start,t.end);let o=t.start,a=t.end;n&&(o=dt(e,o,!0),a=mt(e,a,!0));let i=e.substring(o,t.start),l=e.substring(t.end,a),u=`${i}${r}${l}`;if(ft(e,u)&&(s==null||u.length>=s))return{before:i,after:l,allSurrounding:u};let f=o,d=a,p=!0;for(;p&&(s==null||u.length<s);){let g=!1;const m=f>0?dt(e,f):f;m<f&&(f=m,g=!0);const h=d<e.length?mt(e,d):d;if(h>d&&(d=h,g=!0),g){const y=e.substring(f,t.start),E=e.substring(t.end,d),x=`${y}${r}${E}`;if(ft(e,x)&&(s==null||x.length>=s))return{before:y,after:E,allSurrounding:x};i=y,l=E,u=x}else p=!1}return{before:i,after:l,allSurrounding:u}}const X="# Context",Q="# Instructions";function Z(t,e,n){if(e==null||n==null)return`The user is referring to the entire text of "${t}".`;const s=`
## Selected Text
The user has selected this text in "${t}" in particular:
${e}
`.trim();return n.allSurrounding===e?s:`
${s}

## Surrounding Context
Here is the surrounding context:
${n.allSurrounding}
`.trim()}function wt(t,e){return t==null||e==null?"entire document":t===e.allSurrounding?"selected text":"surrounding context"}function Et(t){return`For the update pattern, create a regex which exactly matches the ${t}. Edit just this string in order to fullfill the user's request. NEVER rewrite the entire document. Instead, ALWAYS edit ONLY the ${t}. The only exception to this rule is if the ${t} includes markdown lists or tables. In that case, fully rewrite the document using ".*" as the regex update pattern.`.trim()}function _s(t,e,n,s){if(!me(e)&&n&&s){const r=wt(n,s);return`
${X}
The user requests that you directly edit the document.

${Z(t,n,s)}

${Q}
Use the update_textdoc tool to make this edit. ${Et(r)}`.trim()}return`
${X}
The user requests that you directly edit the document.

${Z(t,n,s)}

${Q}
Use the update_textdoc tool to make this edit. You MUST fully rewrite the entire document by using ".*" as the update regex pattern.`.trim()}function Ls(t,e,n){return`
${X}
The user requests that you add comments about some text.

${Z(t,e,n)}

${Q}
Do not respond to the user's question directly, just leave comments.`.trim()}function js(t,e){return me(t)?e==="entire document"?` If you choose to update the ${e}, you MUST fully rewrite the ${e} by using ".*" as the update regex pattern.`:` If you choose to update the ${e}, you MUST fully rewrite the entire document by using ".*" as the update regex pattern. When you do so, ONLY modify the ${e} and rewrite other sections exactly as is, except for parts that must change based on this update`:e==="entire document"?"":` If you choose to update the ${e}, follow these instructions: ${Et(e)}`}function Os(t,e,n,s){const r=wt(n,s),o=js(e,r);return`
${X}
${Z(t,n,s)}

${Q}
The user would like you perform one of the following actions:
- Update the ${r} via the \`update_textdoc\` tool.${o}
- Explain the selected text via chat, or answer a general question about the selected text (no tool call required).
- Comment on the ${r} with feedback via the \`comment_textdoc\` tool. This should only be used if the user very explicitly asks for feedback, critique, or comments.

Based on the user's request, choose the appropriate action.
`.trim()}function Ps(t,e,n){return`
${X}
${Z(t,e,n)}

${Q}
The user would like you to create a new textdoc.
`.trim()}function qs(t,e,n,s=null,r=null){switch(n){case F.ASK:return Os(t,e,s,r);case F.CREATE_TEXTDOC:return Ps(t,s,r);case F.EDIT:return _s(t,e,s,r);case F.COMMENT:return Ls(t,s,r)}}function $s(t){const e=ts(),n=In(t),s=ns(t)??e.id,r=kn({clientThreadId:t});return async function(o){const a=new nn,i=Yn.getThreadCurrentLeafId(t),l=performance.now(),u=await Ht(),[f,d,p]=await Promise.all([Ft.getEnforcementToken(u),sn.getEnforcementToken(u),Bt.getEnforcementToken(u)]);r({model:s,completionType:Vt.Next,parentNodeId:i,metadata:{eventSource:"mouse"},completionMetadata:{conversationMode:n},chatReq:u,arkoseToken:f??null,turnstileToken:d??null,proofToken:p??null,preflightTime:performance.now()-l,appendMessages:o,turnTracker:a})}}function Us(t){switch(t){case k.ACCELERATOR:case k.ACCEPT_COMMENT:return!0;case k.ASK_CHATGPT:case k.FULL_SCREEN_SUBMIT:return!1}}function Hs(t,e){switch(e){case k.ASK_CHATGPT:case k.ACCEPT_COMMENT:case k.FULL_SCREEN_SUBMIT:return t.formatMessage(Bs.askChatGPT);case k.ACCELERATOR:return}}const Fs=(t,e)=>{const n=$s(t),s=$();return C.useCallback(({content:r,sourceRange:o,action:a,userMessageType:i,acceleratorMetadata:l,selectionMetadata:u})=>{if(e?.versionInt==null)return;const{textdocId:f,type:d,versionInt:p,content:g}=e;let m,h=null;o&&(m=g.slice(o.start,o.end),h=Rs(o,g)),n([rn([r],{canvas:{textdoc_id:f,textdoc_type:d,version:p,textdoc_content_length:g.length,user_message_type:i,accelerator_metadata:l,selection_metadata:u},is_visually_hidden_from_conversation:Us(i),targeted_reply:m,targeted_reply_label:Hs(s,i),open_in_canvas_view:{type:"canvas_textdoc",id:f}}),on([qs(f,d,a,m,h)],{exclude_after_next_user_message:!0})])},[n,s,e])},Bs=Le({askChatGPT:{id:"h5ANdM",defaultMessage:"Asked ChatGPT"}});function Vs(t){const e=/\[([^\]]+)\]\((https?:\/\/[^\s)]+|www\.[^\s)]+)\)/gi,n=new Set,s=t.matchAll(e);for(const r of s){const o=r[2];try{let a=o;a.startsWith("www.")&&(a="http://"+o),new URL(a),n.add(o)}catch{}}return n}const zs=async({lastVersion:t,textdocId:e,content:n,comments:s})=>{const r=an(s,n);return(await pt.safePost("/textdoc/{textdoc_id}",{parameters:{path:{textdoc_id:e}},requestBody:{version:t,content:n,comments:r}})).version},Gs=()=>{const t=C.useRef([]),e=C.useRef(null),{mutateAsync:n,isPending:s}=zt({mutationKey:["canvas","textdoc","persist"],mutationFn:zs});return[C.useCallback(async(o,a,i)=>{const l=new AbortController,f=(async()=>{const[m]=t.current;try{await m?.promise}catch(h){O.logError("Saving document",h)}if(!l.signal.aborted)try{const h=Math.max(e.current??0,o.versionInt??Tt);let y="";try{et(a)?y=a():y=a}catch(v){O.logError("Serializing document",v)}let E=[];try{et(i)?E=i():E=i}catch(v){O.logError("Adjusting comments",v)}const{textdocId:x}=o;un({textdocId:x,basedOnVersionInt:h,content:y,comments:E});const b=await n({textdocId:x,lastVersion:h,content:y,comments:E});ln({textdocId:x,basedOnVersionInt:h,newVersion:b}),e.current=b}catch(h){O.logError("Error saving document",h)}finally{t.current.shift()}})(),d={abort:()=>l.abort(),promise:f},[p,g]=t.current;return g&&(g.abort(),t.current=p?[p]:[]),t.current=p?[p,d]:[d],f},[n]),t,s]},Ys=3e3,Js=t=>{const[e,n,s]=Gs(),r=$(),o=C.useRef(null),a=C.useCallback(cn(e,Ys,{leading:!1}),[e]),i=fn(t);return C.useEffect(()=>{if(!i)return;const u=tt(window,{pagehide:()=>a.flush(),beforeunload:d=>{a.flush(),d.returnValue=r.formatMessage({id:"QZrKwi",defaultMessage:"You have a canvas save in progress."})}}),f=tt(document,{visibilitychange:()=>a.flush(),keydown:()=>{o.current="keyboard"},mousemove:()=>{o.current!=="mouse"&&a.flush(),o.current="mouse"}});return()=>{o.current=null,f(),u()}},[r,i,a]),C.useEffect(()=>()=>{a.flush()},[t,a]),dn(async()=>{await a.flush(),await Promise.allSettled(n.current?.map(({promise:u})=>u)??[])}),[C.useCallback((u,f,d)=>{const{textdocId:p}=u;return mn(p),a(u,f,d)},[a]),a.flush,s||i]};function Ws(t,e,n){const s=gt(),r=n!=null&&e!=null,{data:o,error:a,fetchNextPage:i,hasNextPage:l,isFetching:u}=Gt(ht(t,e,r)),f=C.useCallback(async()=>{const m=e!=null;await s.prefetchInfiniteQuery(ht(t,e,m))},[s,t,e]);C.useEffect(()=>{const m=e;return()=>{s.removeQueries({queryKey:bt(t,m),exact:!0})}},[s,t,e]);const[d,p,g]=C.useMemo(()=>{if(o&&n){const m=o.pages.flatMap(y=>y),h=m.findIndex(y=>"beforeVersion"in n?(y.versionInt??Tt)<n.beforeVersion:y.versionInt===n.version);if(h!==-1)return[h===m.length-1,m[h],h>0?m[h-1]:null]}return[!0,null,null]},[o,n]);return C.useEffect(()=>{!u&&r&&l&&d&&i()},[u,r,l,d,i]),C.useEffect(()=>{!p&&a&&he(t)},[p,a,t]),{historicalTextdocVersion:p,nextHistoricalTextdocVersion:g,prefetchHistoricalTextdocVersion:f}}function bt(t,e=null){return["textdocHistory",t,e]}function ht(t,e,n=!0){return{queryKey:bt(t,e),queryFn:({pageParam:s})=>Xs(t,s),initialPageParam:e??void 0,getNextPageParam:s=>{const r=hn(s)?.versionInt;if(r&&r>1)return r},enabled:n,staleTime:1/0,retry:2}}async function Xs(t,e){return e===void 0?[]:(await pt.safeGet("/textdoc/{textdoc_id}/history",{parameters:{path:{textdoc_id:t},query:{before_version:e}}})).previous_doc_states.map(({id:s,version:r,textdoc_type:o,title:a,content:i,updated_at:l,comments:u})=>({textdocId:s,versionInt:r,messageId:null,title:a,type:pn(o),content:i,createdAt:gn(l),comments:vn(u,i)}))}const dr=({isFullScreen:t=!1,isEmbedded:e=!1,hideHeader:n=!1,readonlyReason:s,clientThreadId:r,focusedTextdoc:o,onClose:a,isAnimating:i=!1,width:l})=>{const{textdocId:u,history:f,showChangesAtVersion:d=null}=o,[p,g,m]=Js(u),{targetedContent:h}=Cn(),y=Qn(),[E,x]=C.useState(!1),b=Zn(u),v=Kn(),S=Jn(r),M=yn(S),[R,B]=yt(),_=Tn(),{data:K}=Ct(u,_?d:null),{textdocEdits:Oe,previousContent:Pe}=K??{},N=b?.versions??[],St=N[0]?.versionInt,{historicalTextdocVersion:qe,nextHistoricalTextdocVersion:Mt,prefetchHistoricalTextdocVersion:It}=Ws(u,St,f);C.useEffect(()=>{fe.reset()},[u]),C.useEffect(()=>{b?.metadata?.textdocId&&Se().sendMessage({type:ue.Loaded})},[b?.metadata?.textdocId]);const $e=N.length>0?N[N.length-1]:null,ve=N.length>1?N[N.length-2]:null,Ue=Wn(r),{restoreHistoricalTextdocVersion:He,optimisticRestoredTextdocVersion:kt}=xn(Ue,$e,qe),U=f!=null,w=U?qe:$e,ee=Fs(r,w),te=C.useMemo(()=>i?[]:w?.comments.filter(T=>T.status!==wn.DISMISSED)??[],[i,w]),Fe=C.useMemo(()=>i||!_?[]:Oe??[],[i,_,Oe]),Ce=w?.type??ae.LOADING,q=!!w?.isPartial;C.useEffect(()=>{N.length===0&&!v&&a?.()},[N.length,a,v]);const At=!!s&&s!==j.OldVersion,ye=_&&d!=null&&Fe.length>0,Te=q&&!!w?.isRewriting,Dt=q&&!!w?.isCreation,{content:ne,currentlyStreamingLineIndex:Be}=Pe!=null?{content:Pe,currentlyStreamingLineIndex:null}:ws(w,ve),Nt=ss(Ue,Array.from(Vs(ne))),[se,xe]=rs({value:ne,isRequestActive:M,isTextdocStreaming:q,comments:te}),Ve=En(w),ze=q||M||se||m;C.useEffect(()=>{Se().sendMessage({type:ue.Streaming,streaming:ze})},[ze]);const Rt=({getSerializedDocument:T,getAdjustedComments:A})=>{w&&p(w,T,A)},_t=T=>{if(!w)return;const A=T.doc.toString();p(w,A,T.field(_n,!1)??[])},Ge=(T,A,L,H)=>{xe(!0),ee({action:A,content:T,userMessageType:k.ASK_CHATGPT,sourceRange:L,selectionMetadata:{selection_type:H,selection_position_range:L}})},Ye=({id:T})=>{Ve(T,nt.DISMISS),fe.reset()},Je=async T=>{xe(!0);const{id:A,at:L,content:H}=T;if(await Ve(A,nt.ACCEPT)===!1)return xe(!1);ee({content:H,userMessageType:k.ACCEPT_COMMENT,sourceRange:L,action:F.EDIT,selectionMetadata:{selection_type:st.SELECTION,selection_position_range:L}})},we=(T,A,L)=>{const{action:H}=L;ee({action:H,content:A,sourceRange:T,userMessageType:k.ACCELERATOR,acceleratorMetadata:{action:H,id:L.id,prompt:A},selectionMetadata:T!=null?{selection_type:st.SELECTION,selection_position_range:T}:void 0})},Lt=T=>{ee({action:F.EDIT,content:T,userMessageType:k.FULL_SCREEN_SUBMIT})},jt=Yt(),Ot=gt(),Pt=bn(({resolveTempCommentId:T})=>T),We=T=>Pt[T]||T,Ee=()=>Nn({clientThreadId:r,currentRequestId:S,queryClient:Ot,isHistoryAndTrainingDisabled:jt});let I=s;U?I=j.OldVersion:ye?I=j.ShowingChanges:kt!=null?I=j.Restoring:(q||M)&&(I=j.Streaming);let re=null;const Xe=i||I!=null||se,Qe=i&&te.length>0||U||I!=null&&I!==j.Streaming,Ze=t||i;let be=[];switch(Ce){case ae.LOADING:re=c.jsx(Rn,{});break;case ae.DOCUMENT:re=c.jsx(Dn,{value:ne,comments:te,previousValue:ve?.content,previousComments:ve?.comments,isRewriting:Te,isAnimatingFromPreview:i,getStableCommentId:We,edits:Fe,isRequestActive:M,isDisabled:I!=null||v,isWaitingForCommentResponse:se,hideAccelerators:Ze,hideToolbar:Xe,hideEditOverlay:i,hideComments:Qe,readonlyReason:I,canvasContentRect:R,onBlur:g,onSave:g,onChange:Rt,onCancelRequest:Ee,targetedContent:h,onAddComment:Ge,onAcceptComment:Je,onDismissComment:Ye,onSubmitAccelerator:we,safeUrls:Nt,width:l,modelCursor:q&&!Te?w?.modelCursor:void 0,shouldResetSelection:w?.versionInt===1}),be=On;break;default:me(Ce)&&(re=c.jsx(An,{id:"codemirror",getStableCommentId:We,language:Sn(Ce),value:ne,comments:te,hideAccelerators:Ze,hideComments:Qe,hideToolbar:Xe,onSubmitAccelerator:we,currentlyStreamingLineIndex:Be??null,readonlyReason:I,isRequestActive:M,isWaitingForCommentResponse:se,onChange:_t,onCancelRequest:Ee,onAddComment:Ge,onDismissComment:Ye,onAcceptComment:Je,modelCursor:q&&Be==null?w?.modelCursor:void 0}),be=Ln)}return c.jsxs(G,{children:[!n&&c.jsx(As,{textdocId:u,isHistoricalVersion:U,nextHistoricalTextdocVersion:Mt,textdocVersion:w,readonlyReason:I,history:f,hasDebug:y,contentWidth:R.width,isEmbedded:e,isPersisting:m,isShowChangesFeatureEnabled:_,isShowingChanges:ye,hideHistoryActions:I===j.QueryParam,prefetchHistoricalTextdocVersion:It,restoreHistoricalTextdocVersion:He,setShowDebugView:x,onClose:()=>{const T=Se();T.isNative&&T.sendMessage({type:ue.Close}),O.logButtonClick(ce.CLOSE_TEXTDOC,{textdocType:w?.type}),a?.()}}),c.jsxs(G.Content,{ref:B,scrollToBottomMode:Dt?"bottom":"top",shouldScrollToTop:Te,children:[!1,re]}),c.jsx(vt,{children:!ye&&U&&!At&&c.jsx(os,{onClickRestore:He,onClickResetLatest:()=>he(u)})}),t&&!U&&c.jsx("div",{className:"relative flex items-center justify-center pb-3",children:c.jsx(ls,{isRequestActive:M,clientThreadId:r,onSubmitAccelerator:we,onSubmit:Lt,onCancel:Ee,acceleratorActions:be})})]})};export{dr as T};
//# sourceMappingURL=g05t9vjo16ly1mfs.js.map
