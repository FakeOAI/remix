const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/m07usroutkhah1u0.js","assets/l5rf55y8gpic9j7j.js","assets/hxwnvznhtn7zt599.js","assets/root-hz90zheb.css","assets/n7h7w1vm4f0z2mu5.js","assets/c8ww2t9q7rwlhved.js","assets/conversation-small-ao874ap7.css","assets/c3evsddbj4url2js.js","assets/chfv6vbnigxawfjy.js","assets/en2i51vra2vf1qjh.js","assets/kprqzagmygdrwwqd.js","assets/m0rry74g6mtwf8hx.js","assets/onqhjclv3raud604.js","assets/is-scrollable-element-i34sjb0l.css","assets/kpq79bmjrg2cdmv0.js","assets/hlx564c7m7nbdo16.js","assets/kfqicesy8adidsoj.js","assets/b4ve8i43g8dzy4nm.js","assets/ggl8ej2y92j1hjpc.js","assets/dhbqxj38yqs19ycp.js","assets/far2w778d506euen.js","assets/i7w5dyo9d6x2grvw.js","assets/m5s574269sxo58qz.js","assets/obmlpvf0eu01tyh4.js","assets/jpgi6tolg12nbn71.js","assets/catcclko34r9lbh0.js","assets/code-composer-ausyy80t.css","assets/lqc4qp0os2rcwzml.js","assets/1eskyaxo0dgicn4m.js","assets/f40hmvpwub4nfgpp.js","assets/oaices9q47ysptft.js","assets/md38s2ry2qvejb8x.js","assets/document-composer-mym9u5r6.css","assets/lp55fc5ebs62yb4c.js","assets/f83east7i5o0uckd.js","assets/n9udapgzfcku06f2.js","assets/l1s67jvcoqoodgca.js","assets/nm04jgpfyxi6pn12.js","assets/ADAVisualizationComponent-mi6em660.css","assets/kv175rft89ldqzz5.js","assets/sso-f0swi54hbsvjzm3m.js","assets/dclj3d13dl35aelb.js","assets/b7m60prnk5qtil33.js","assets/f14md38wl5pb7ijx.js","assets/mwqfmcfvintncrdx.js","assets/n69w6yy1ajbikqf4.js","assets/o9dm4l2ej4j1g8dl.js","assets/gkf32ouwb4u3dq0f.js","assets/itvy5wh5nt29wp0z.js","assets/m93j2j4zzmb2zrza.js","assets/on60qaffewbiuep5.js","assets/kqwdyvkaaavvn8k3.js","assets/qi0vldxr8qcd2lin.js","assets/h6sj1o8omefn1aj9.js","assets/lwfg8nh1ttyqphfr.js","assets/dnxwbcy9379cxggu.js","assets/e9lafxuzyeh4418f.js","assets/nbq2e0loopzrsslr.js","assets/eoyb9avm763jh9j5.js","assets/e7zgzf3lmuv2fwq7.js","assets/kdwbveimqmcf5xvf.js","assets/nhwwej1nq0zrd7sc.js","assets/c61mtkmeauwfo5s9.js","assets/d4pxg9by9mpowohe.js","assets/n4n7co3tqepu36i3.js","assets/ef5n6e0aasjgdj08.js","assets/b0kcluc7c96r2thn.js","assets/n72uqkle11gzevvd.js","assets/bzkcu0fhpth3n2xg.js","assets/jx409ix6237micmb.js","assets/ierzjwwhlps2yvuq.js","assets/fpsiujxgytpt3giz.js","assets/bckjascntxue4hmq.js","assets/hqjgtr2um4fbtpeg.js","assets/i57zj4a850uqt3qf.js","assets/jl750pxg8h9an1ig.js","assets/fbhfgsr9saigj180.js","assets/e4uue5t1r6yb0a4s.js","assets/k2vq92g59amolpop.js","assets/etv6q5l8biiob0ma.js","assets/iej0cupg2dqkmejt.js","assets/k9s7t11o03wrnlqh.js","assets/jk8w36bsokizpx57.js","assets/jz4ylluxgxiwqs0x.js","assets/mgvv5gx1wik0kgq5.js","assets/carousel-bss5aguy.css","assets/lxwugeehor07hyeg.js","assets/feps4vvtkwo000m7.js","assets/d5u8oyxsu6wbgulx.js","assets/n9ztwy2lchvj2ihs.js","assets/ft25cbv8dllh581k.js","assets/ki6571k8kw909eiw.js","assets/dq6qjj77dn032g1y.js","assets/bge05gsnwxenyn06.js","assets/jpiumua1mqiifglp.js","assets/m1hdun6boxotqa0o.js"])))=>i.map(i=>d[i]);
import{k7 as Oa,k8 as Da,iN as Ra,k9 as Aa,T as Ws,N as va,iz as Lr,ix as Ba,ka as Fa,kb as pi,iA as Pa,kc as La,kd as mi,jd as za,iX as zr,jf as ja,as as Va,iW as jr,ke as Js,iU as Ua,kf as qa,fl as Wa,kg as Ja,kh as Ha,ki as $a,kj as Ga,kk as Ka,fn as Ya,hV as Za,ff as Qa,hQ as Xa,hR as el,fh as tl,fi as nl,fb as sl,hX as il,i_ as rl,ja as ol,fk as Z,fj as Nn,hW as bs,j0 as gi,i$ as al,kl as st,km as Ct,E as ll,kn as cl,ko as Ss,kp as dl,kq as hl,b$ as yi,kr as Vr,ay as ul,ks as fl,kt as pl,ku as Ur,kv as ml,d4 as gl,aQ as yl,aO as xl,d9 as kl,da as bl,kw as Sl,kx as wl,ky as Cl,kz as Tl,fg as B,kA as Ml,kB as El,kC as Il,kD as Nl,kE as _l,kF as Ol,kG as Dl,iG as ns,kH as ss,kI as Rl,kJ as Al,iE as vl,iL as Bl,iM as Hs,kK as Fl,iJ as Pl,kL as en,o as qr,kM as Ll,kN as zl,kO as jl,kP as Vl,kQ as Ul,gM as Wr,G as Rn,dR as ql,kR as Jr,c as Wl,bZ as Jl,X as Hl,kS as $l,kT as Gl,bS as Kl,A as Yl,kU as Zl,kV as Ql,d as Xl,kW as ec,kX as tc,kY as nc,kZ as sc,k_ as ic,k$ as rc,cO as oc,l0 as An,l as Hr,l1 as ac,dq as $s,l2 as Gs,l3 as lc,l4 as cc,l5 as dc,l6 as pe,l7 as hc,l8 as _n,l9 as wn,la as uc,lb as $r,lc as fc,ld as pc,le as vt,lf as mc,lg as xi,lh as gc,li as yc,ct as xc,cf as ki,cv as kc,lj as bc,lk as Sc,ll as wc,lm as Cc,j_ as is,ln as Tc,Y as Mc,lo as Ec,lp as Ic}from"./c8ww2t9q7rwlhved.js";import{a1 as bt,r as D,l as x,V as gn,a0 as Ks,aC as xe,aD as fe,m as ee,f3 as Nc,d5 as Hn,Z as oe,fZ as Gr,eq as _c,aG as Be,bc as bi,c as Oc,aM as Dc,fw as Rc,fK as Kr,bP as Yr,L as Si,K as wi,h as Ys,j as rt,aF as Zr,ch as Ac,P as Ve,a as be,D as Se,X as ws,bO as vc,f_ as Bc,a2 as Fc,aZ as Zs,M as $n,bQ as Pc,bR as Lc,cA as zc,f$ as jc,eU as Qr,ao as ln,bH as nt,g0 as Cs,R as dt,e3 as tn,eN as Vc,bI as lt,g1 as Ts,cX as Uc,g2 as Xr,v as qc,eR as Wc,f as Ci,g3 as Jc,g4 as Ti,g5 as Mi,g6 as Hc,cZ as Ms,ad as $c,u as Gc,dN as Kc,cY as Yc,c_ as Ei,b as Zc,dd as Qc,aJ as Xc,a8 as ed,bn as td,d2 as nd,f5 as sd}from"./l5rf55y8gpic9j7j.js";import{B as id,P as vn,a as rd}from"./kpq79bmjrg2cdmv0.js";import{P as od,a as ad,bS as ld,u as cd,e as dd,a7 as hd,a8 as ud}from"./hxwnvznhtn7zt599.js";import{h as fd,j as eo,k as pd,i as md,l as gd,m as yd,e as xd}from"./b4ve8i43g8dzy4nm.js";import{m as gt}from"./c3evsddbj4url2js.js";import{u as kd,J as bd,b as Sd,W as wd,g as Ii,d as Cd,X as Td,Y as Md}from"./hlx564c7m7nbdo16.js";import{l as Qs,d as Bn,T as A,J as Ed,K as Id,a as Es,o as to,i as Xs,L as Nd,M as _d}from"./kfqicesy8adidsoj.js";import{i as no,C as Od,g as Dd,a as Rd,b as Ad}from"./obmlpvf0eu01tyh4.js";import{r as so,s as vd}from"./dhbqxj38yqs19ycp.js";import{g as Bd}from"./jpgi6tolg12nbn71.js";import{T as Fd,u as Pd}from"./catcclko34r9lbh0.js";const Ld=({onScroll:s})=>(Oa(({scrollTop:e})=>{s?.(e)}),null),zd=({shouldScrollToTop:s})=>{const e=Da();return D.useEffect(()=>{s===!0&&e({behavior:"smooth"})},[s,e]),null},jd=()=>{const s=Ra();D.useEffect(()=>{s({behavior:"smooth"})},[s]);const[e]=Aa();return e?null:x.jsx("button",{onClick:()=>s({behavior:"smooth"}),className:"absolute bottom-5 right-1/2 z-10 flex h-8 w-8 translate-x-1/2 cursor-pointer items-center justify-center rounded-full border border-token-border-light bg-token-main-surface-primary bg-clip-padding text-token-text-secondary",children:x.jsx(od,{className:"icon-md text-token-text-primary"})})},Vd=bt.section`w-full h-full flex flex-col popover bg-token-main-surface-primary`,Ud=({children:s,onScroll:e,shouldScrollToTop:t,scrollToBottomMode:n="top"},i)=>x.jsx("main",{className:"flex min-h-0 flex-auto flex-grow flex-col",ref:i,children:x.jsxs(id,{followButtonClassName:"hidden",initialScrollBehavior:"auto",className:"h-full",mode:n,children:[s,n==="bottom"&&x.jsx(jd,{}),x.jsx(Ld,{onScroll:e}),x.jsx(zd,{shouldScrollToTop:t})]})}),qd=D.forwardRef(Ud),Wd=bt.header`flex items-center justify-between p-3 h-14`,Jd=bt.h2`ml-2.5 text-base text-lg text-gray-700 dark:text-token-text-secondary truncate`,Hd=({onClick:s})=>{const e=gn();return x.jsx(Ws,{label:e.formatMessage($d.close),children:x.jsx(va,{icon:ad,onClick:s})})},Wt=({children:s})=>x.jsx(Vd,{children:s});Wt.Title=Jd;Wt.CloseButton=Hd;Wt.Header=Wd;Wt.Content=qd;const $d=Ks({close:{id:"Bix/Kd",defaultMessage:"Close"}}),Gd=xe(()=>fe(()=>import("./m07usroutkhah1u0.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26])).then(s=>s.CodeComposer),{ssr:!1,loading:()=>x.jsx("div",{className:Lr.code,children:x.jsx("div",{className:"h-full w-full px-4",children:x.jsx(vn,{lines:20})})})}),Kd=s=>x.jsx(Gd,{...s}),io=()=>{const[{width:s},e]=Ba(),t=s>=pi+Pa?pi:La;return x.jsx("div",{className:ee(Lr.document,"mt-4"),ref:e,style:{margin:`0 ${Fa}px`},children:x.jsx("div",{style:{width:t},children:x.jsx(vn,{lines:20})})})},Yd=xe(()=>fe(()=>import("./lqc4qp0os2rcwzml.js"),__vite__mapDeps([27,1,2,3,9,5,6,4,7,10,11,12,13,28,16,29,30,18,31,14,15,17,19,20,21,22,23,24,25,32])).then(s=>s.DocumentComposer),{ssr:!1,loading:io}),Zd=s=>x.jsx(Yd,{...s});function ro(s,e,t){for(let n=0;;n++){if(n==s.childCount||n==e.childCount)return s.childCount==e.childCount?null:t;let i=s.child(n),r=e.child(n);if(i==r){t+=i.nodeSize;continue}if(!i.sameMarkup(r))return t;if(i.isText&&i.text!=r.text){for(let o=0;i.text[o]==r.text[o];o++)t++;return t}if(i.content.size||r.content.size){let o=ro(i.content,r.content,t+1);if(o!=null)return o}t+=i.nodeSize}}function oo(s,e,t,n){for(let i=s.childCount,r=e.childCount;;){if(i==0||r==0)return i==r?null:{a:t,b:n};let o=s.child(--i),a=e.child(--r),l=o.nodeSize;if(o==a){t-=l,n-=l;continue}if(!o.sameMarkup(a))return{a:t,b:n};if(o.isText&&o.text!=a.text){let d=0,u=Math.min(o.text.length,a.text.length);for(;d<u&&o.text[o.text.length-d-1]==a.text[a.text.length-d-1];)d++,t--,n--;return{a:t,b:n}}if(o.content.size||a.content.size){let d=oo(o.content,a.content,t-1,n-1);if(d)return d}t-=l,n-=l}}class E{constructor(e,t){if(this.content=e,this.size=t||0,t==null)for(let n=0;n<e.length;n++)this.size+=e[n].nodeSize}nodesBetween(e,t,n,i=0,r){for(let o=0,a=0;a<t;o++){let l=this.content[o],d=a+l.nodeSize;if(d>e&&n(l,i+a,r||null,o)!==!1&&l.content.size){let u=a+1;l.nodesBetween(Math.max(0,e-u),Math.min(l.content.size,t-u),n,i+u)}a=d}}descendants(e){this.nodesBetween(0,this.size,e)}textBetween(e,t,n,i){let r="",o=!0;return this.nodesBetween(e,t,(a,l)=>{let d=a.isText?a.text.slice(Math.max(e,l)-l,t-l):a.isLeaf?i?typeof i=="function"?i(a):i:a.type.spec.leafText?a.type.spec.leafText(a):"":"";a.isBlock&&(a.isLeaf&&d||a.isTextblock)&&n&&(o?o=!1:r+=n),r+=d},0),r}append(e){if(!e.size)return this;if(!this.size)return e;let t=this.lastChild,n=e.firstChild,i=this.content.slice(),r=0;for(t.isText&&t.sameMarkup(n)&&(i[i.length-1]=t.withText(t.text+n.text),r=1);r<e.content.length;r++)i.push(e.content[r]);return new E(i,this.size+e.size)}cut(e,t=this.size){if(e==0&&t==this.size)return this;let n=[],i=0;if(t>e)for(let r=0,o=0;o<t;r++){let a=this.content[r],l=o+a.nodeSize;l>e&&((o<e||l>t)&&(a.isText?a=a.cut(Math.max(0,e-o),Math.min(a.text.length,t-o)):a=a.cut(Math.max(0,e-o-1),Math.min(a.content.size,t-o-1))),n.push(a),i+=a.nodeSize),o=l}return new E(n,i)}cutByIndex(e,t){return e==t?E.empty:e==0&&t==this.content.length?this:new E(this.content.slice(e,t))}replaceChild(e,t){let n=this.content[e];if(n==t)return this;let i=this.content.slice(),r=this.size+t.nodeSize-n.nodeSize;return i[e]=t,new E(i,r)}addToStart(e){return new E([e].concat(this.content),this.size+e.nodeSize)}addToEnd(e){return new E(this.content.concat(e),this.size+e.nodeSize)}eq(e){if(this.content.length!=e.content.length)return!1;for(let t=0;t<this.content.length;t++)if(!this.content[t].eq(e.content[t]))return!1;return!0}get firstChild(){return this.content.length?this.content[0]:null}get lastChild(){return this.content.length?this.content[this.content.length-1]:null}get childCount(){return this.content.length}child(e){let t=this.content[e];if(!t)throw new RangeError("Index "+e+" out of range for "+this);return t}maybeChild(e){return this.content[e]||null}forEach(e){for(let t=0,n=0;t<this.content.length;t++){let i=this.content[t];e(i,n,t),n+=i.nodeSize}}findDiffStart(e,t=0){return ro(this,e,t)}findDiffEnd(e,t=this.size,n=e.size){return oo(this,e,t,n)}findIndex(e,t=-1){if(e==0)return Cn(0,e);if(e==this.size)return Cn(this.content.length,e);if(e>this.size||e<0)throw new RangeError(`Position ${e} outside of fragment (${this})`);for(let n=0,i=0;;n++){let r=this.child(n),o=i+r.nodeSize;if(o>=e)return o==e||t>0?Cn(n+1,o):Cn(n,i);i=o}}toString(){return"<"+this.toStringInner()+">"}toStringInner(){return this.content.join(", ")}toJSON(){return this.content.length?this.content.map(e=>e.toJSON()):null}static fromJSON(e,t){if(!t)return E.empty;if(!Array.isArray(t))throw new RangeError("Invalid input for Fragment.fromJSON");return new E(t.map(e.nodeFromJSON))}static fromArray(e){if(!e.length)return E.empty;let t,n=0;for(let i=0;i<e.length;i++){let r=e[i];n+=r.nodeSize,i&&r.isText&&e[i-1].sameMarkup(r)?(t||(t=e.slice(0,i)),t[t.length-1]=r.withText(t[t.length-1].text+r.text)):t&&t.push(r)}return new E(t||e,n)}static from(e){if(!e)return E.empty;if(e instanceof E)return e;if(Array.isArray(e))return this.fromArray(e);if(e.attrs)return new E([e],e.nodeSize);throw new RangeError("Can not convert "+e+" to a Fragment"+(e.nodesBetween?" (looks like multiple versions of prosemirror-model were loaded)":""))}}E.empty=new E([],0);const rs={index:0,offset:0};function Cn(s,e){return rs.index=s,rs.offset=e,rs}function Fn(s,e){if(s===e)return!0;if(!(s&&typeof s=="object")||!(e&&typeof e=="object"))return!1;let t=Array.isArray(s);if(Array.isArray(e)!=t)return!1;if(t){if(s.length!=e.length)return!1;for(let n=0;n<s.length;n++)if(!Fn(s[n],e[n]))return!1}else{for(let n in s)if(!(n in e)||!Fn(s[n],e[n]))return!1;for(let n in e)if(!(n in s))return!1}return!0}class J{constructor(e,t){this.type=e,this.attrs=t}addToSet(e){let t,n=!1;for(let i=0;i<e.length;i++){let r=e[i];if(this.eq(r))return e;if(this.type.excludes(r.type))t||(t=e.slice(0,i));else{if(r.type.excludes(this.type))return e;!n&&r.type.rank>this.type.rank&&(t||(t=e.slice(0,i)),t.push(this),n=!0),t&&t.push(r)}}return t||(t=e.slice()),n||t.push(this),t}removeFromSet(e){for(let t=0;t<e.length;t++)if(this.eq(e[t]))return e.slice(0,t).concat(e.slice(t+1));return e}isInSet(e){for(let t=0;t<e.length;t++)if(this.eq(e[t]))return!0;return!1}eq(e){return this==e||this.type==e.type&&Fn(this.attrs,e.attrs)}toJSON(){let e={type:this.type.name};for(let t in this.attrs){e.attrs=this.attrs;break}return e}static fromJSON(e,t){if(!t)throw new RangeError("Invalid input for Mark.fromJSON");let n=e.marks[t.type];if(!n)throw new RangeError(`There is no mark type ${t.type} in this schema`);let i=n.create(t.attrs);return n.checkAttrs(i.attrs),i}static sameSet(e,t){if(e==t)return!0;if(e.length!=t.length)return!1;for(let n=0;n<e.length;n++)if(!e[n].eq(t[n]))return!1;return!0}static setFrom(e){if(!e||Array.isArray(e)&&e.length==0)return J.none;if(e instanceof J)return[e];let t=e.slice();return t.sort((n,i)=>n.type.rank-i.type.rank),t}}J.none=[];class Pn extends Error{}class O{constructor(e,t,n){this.content=e,this.openStart=t,this.openEnd=n}get size(){return this.content.size-this.openStart-this.openEnd}insertAt(e,t){let n=lo(this.content,e+this.openStart,t);return n&&new O(n,this.openStart,this.openEnd)}removeBetween(e,t){return new O(ao(this.content,e+this.openStart,t+this.openStart),this.openStart,this.openEnd)}eq(e){return this.content.eq(e.content)&&this.openStart==e.openStart&&this.openEnd==e.openEnd}toString(){return this.content+"("+this.openStart+","+this.openEnd+")"}toJSON(){if(!this.content.size)return null;let e={content:this.content.toJSON()};return this.openStart>0&&(e.openStart=this.openStart),this.openEnd>0&&(e.openEnd=this.openEnd),e}static fromJSON(e,t){if(!t)return O.empty;let n=t.openStart||0,i=t.openEnd||0;if(typeof n!="number"||typeof i!="number")throw new RangeError("Invalid input for Slice.fromJSON");return new O(E.fromJSON(e,t.content),n,i)}static maxOpen(e,t=!0){let n=0,i=0;for(let r=e.firstChild;r&&!r.isLeaf&&(t||!r.type.spec.isolating);r=r.firstChild)n++;for(let r=e.lastChild;r&&!r.isLeaf&&(t||!r.type.spec.isolating);r=r.lastChild)i++;return new O(e,n,i)}}O.empty=new O(E.empty,0,0);function ao(s,e,t){let{index:n,offset:i}=s.findIndex(e),r=s.maybeChild(n),{index:o,offset:a}=s.findIndex(t);if(i==e||r.isText){if(a!=t&&!s.child(o).isText)throw new RangeError("Removing non-flat range");return s.cut(0,e).append(s.cut(t))}if(n!=o)throw new RangeError("Removing non-flat range");return s.replaceChild(n,r.copy(ao(r.content,e-i-1,t-i-1)))}function lo(s,e,t,n){let{index:i,offset:r}=s.findIndex(e),o=s.maybeChild(i);if(r==e||o.isText)return s.cut(0,e).append(t).append(s.cut(e));let a=lo(o.content,e-r-1,t);return a&&s.replaceChild(i,o.copy(a))}function Qd(s,e,t){if(t.openStart>s.depth)throw new Pn("Inserted content deeper than insertion position");if(s.depth-t.openStart!=e.depth-t.openEnd)throw new Pn("Inconsistent open depths");return co(s,e,t,0)}function co(s,e,t,n){let i=s.index(n),r=s.node(n);if(i==e.index(n)&&n<s.depth-t.openStart){let o=co(s,e,t,n+1);return r.copy(r.content.replaceChild(i,o))}else if(t.content.size)if(!t.openStart&&!t.openEnd&&s.depth==n&&e.depth==n){let o=s.parent,a=o.content;return Nt(o,a.cut(0,s.parentOffset).append(t.content).append(a.cut(e.parentOffset)))}else{let{start:o,end:a}=Xd(t,s);return Nt(r,uo(s,o,a,e,n))}else return Nt(r,Ln(s,e,n))}function ho(s,e){if(!e.type.compatibleContent(s.type))throw new Pn("Cannot join "+e.type.name+" onto "+s.type.name)}function Is(s,e,t){let n=s.node(t);return ho(n,e.node(t)),n}function It(s,e){let t=e.length-1;t>=0&&s.isText&&s.sameMarkup(e[t])?e[t]=s.withText(e[t].text+s.text):e.push(s)}function nn(s,e,t,n){let i=(e||s).node(t),r=0,o=e?e.index(t):i.childCount;s&&(r=s.index(t),s.depth>t?r++:s.textOffset&&(It(s.nodeAfter,n),r++));for(let a=r;a<o;a++)It(i.child(a),n);e&&e.depth==t&&e.textOffset&&It(e.nodeBefore,n)}function Nt(s,e){return s.type.checkContent(e),s.copy(e)}function uo(s,e,t,n,i){let r=s.depth>i&&Is(s,e,i+1),o=n.depth>i&&Is(t,n,i+1),a=[];return nn(null,s,i,a),r&&o&&e.index(i)==t.index(i)?(ho(r,o),It(Nt(r,uo(s,e,t,n,i+1)),a)):(r&&It(Nt(r,Ln(s,e,i+1)),a),nn(e,t,i,a),o&&It(Nt(o,Ln(t,n,i+1)),a)),nn(n,null,i,a),new E(a)}function Ln(s,e,t){let n=[];if(nn(null,s,t,n),s.depth>t){let i=Is(s,e,t+1);It(Nt(i,Ln(s,e,t+1)),n)}return nn(e,null,t,n),new E(n)}function Xd(s,e){let t=e.depth-s.openStart,i=e.node(t).copy(s.content);for(let r=t-1;r>=0;r--)i=e.node(r).copy(E.from(i));return{start:i.resolveNoCache(s.openStart+t),end:i.resolveNoCache(i.content.size-s.openEnd-t)}}class cn{constructor(e,t,n){this.pos=e,this.path=t,this.parentOffset=n,this.depth=t.length/3-1}resolveDepth(e){return e==null?this.depth:e<0?this.depth+e:e}get parent(){return this.node(this.depth)}get doc(){return this.node(0)}node(e){return this.path[this.resolveDepth(e)*3]}index(e){return this.path[this.resolveDepth(e)*3+1]}indexAfter(e){return e=this.resolveDepth(e),this.index(e)+(e==this.depth&&!this.textOffset?0:1)}start(e){return e=this.resolveDepth(e),e==0?0:this.path[e*3-1]+1}end(e){return e=this.resolveDepth(e),this.start(e)+this.node(e).content.size}before(e){if(e=this.resolveDepth(e),!e)throw new RangeError("There is no position before the top-level node");return e==this.depth+1?this.pos:this.path[e*3-1]}after(e){if(e=this.resolveDepth(e),!e)throw new RangeError("There is no position after the top-level node");return e==this.depth+1?this.pos:this.path[e*3-1]+this.path[e*3].nodeSize}get textOffset(){return this.pos-this.path[this.path.length-1]}get nodeAfter(){let e=this.parent,t=this.index(this.depth);if(t==e.childCount)return null;let n=this.pos-this.path[this.path.length-1],i=e.child(t);return n?e.child(t).cut(n):i}get nodeBefore(){let e=this.index(this.depth),t=this.pos-this.path[this.path.length-1];return t?this.parent.child(e).cut(0,t):e==0?null:this.parent.child(e-1)}posAtIndex(e,t){t=this.resolveDepth(t);let n=this.path[t*3],i=t==0?0:this.path[t*3-1]+1;for(let r=0;r<e;r++)i+=n.child(r).nodeSize;return i}marks(){let e=this.parent,t=this.index();if(e.content.size==0)return J.none;if(this.textOffset)return e.child(t).marks;let n=e.maybeChild(t-1),i=e.maybeChild(t);if(!n){let a=n;n=i,i=a}let r=n.marks;for(var o=0;o<r.length;o++)r[o].type.spec.inclusive===!1&&(!i||!r[o].isInSet(i.marks))&&(r=r[o--].removeFromSet(r));return r}marksAcross(e){let t=this.parent.maybeChild(this.index());if(!t||!t.isInline)return null;let n=t.marks,i=e.parent.maybeChild(e.index());for(var r=0;r<n.length;r++)n[r].type.spec.inclusive===!1&&(!i||!n[r].isInSet(i.marks))&&(n=n[r--].removeFromSet(n));return n}sharedDepth(e){for(let t=this.depth;t>0;t--)if(this.start(t)<=e&&this.end(t)>=e)return t;return 0}blockRange(e=this,t){if(e.pos<this.pos)return e.blockRange(this);for(let n=this.depth-(this.parent.inlineContent||this.pos==e.pos?1:0);n>=0;n--)if(e.pos<=this.end(n)&&(!t||t(this.node(n))))return new nh(this,e,n);return null}sameParent(e){return this.pos-this.parentOffset==e.pos-e.parentOffset}max(e){return e.pos>this.pos?e:this}min(e){return e.pos<this.pos?e:this}toString(){let e="";for(let t=1;t<=this.depth;t++)e+=(e?"/":"")+this.node(t).type.name+"_"+this.index(t-1);return e+":"+this.parentOffset}static resolve(e,t){if(!(t>=0&&t<=e.content.size))throw new RangeError("Position "+t+" out of range");let n=[],i=0,r=t;for(let o=e;;){let{index:a,offset:l}=o.content.findIndex(r),d=r-l;if(n.push(o,a,i+l),!d||(o=o.child(a),o.isText))break;r=d-1,i+=l+1}return new cn(t,n,r)}static resolveCached(e,t){let n=Ni.get(e);if(n)for(let r=0;r<n.elts.length;r++){let o=n.elts[r];if(o.pos==t)return o}else Ni.set(e,n=new eh);let i=n.elts[n.i]=cn.resolve(e,t);return n.i=(n.i+1)%th,i}}class eh{constructor(){this.elts=[],this.i=0}}const th=12,Ni=new WeakMap;class nh{constructor(e,t,n){this.$from=e,this.$to=t,this.depth=n}get start(){return this.$from.before(this.depth+1)}get end(){return this.$to.after(this.depth+1)}get parent(){return this.$from.node(this.depth)}get startIndex(){return this.$from.index(this.depth)}get endIndex(){return this.$to.indexAfter(this.depth)}}const sh=Object.create(null);class Ke{constructor(e,t,n,i=J.none){this.type=e,this.attrs=t,this.marks=i,this.content=n||E.empty}get nodeSize(){return this.isLeaf?1:2+this.content.size}get childCount(){return this.content.childCount}child(e){return this.content.child(e)}maybeChild(e){return this.content.maybeChild(e)}forEach(e){this.content.forEach(e)}nodesBetween(e,t,n,i=0){this.content.nodesBetween(e,t,n,i,this)}descendants(e){this.nodesBetween(0,this.content.size,e)}get textContent(){return this.isLeaf&&this.type.spec.leafText?this.type.spec.leafText(this):this.textBetween(0,this.content.size,"")}textBetween(e,t,n,i){return this.content.textBetween(e,t,n,i)}get firstChild(){return this.content.firstChild}get lastChild(){return this.content.lastChild}eq(e){return this==e||this.sameMarkup(e)&&this.content.eq(e.content)}sameMarkup(e){return this.hasMarkup(e.type,e.attrs,e.marks)}hasMarkup(e,t,n){return this.type==e&&Fn(this.attrs,t||e.defaultAttrs||sh)&&J.sameSet(this.marks,n||J.none)}copy(e=null){return e==this.content?this:new Ke(this.type,this.attrs,e,this.marks)}mark(e){return e==this.marks?this:new Ke(this.type,this.attrs,this.content,e)}cut(e,t=this.content.size){return e==0&&t==this.content.size?this:this.copy(this.content.cut(e,t))}slice(e,t=this.content.size,n=!1){if(e==t)return O.empty;let i=this.resolve(e),r=this.resolve(t),o=n?0:i.sharedDepth(t),a=i.start(o),d=i.node(o).content.cut(i.pos-a,r.pos-a);return new O(d,i.depth-o,r.depth-o)}replace(e,t,n){return Qd(this.resolve(e),this.resolve(t),n)}nodeAt(e){for(let t=this;;){let{index:n,offset:i}=t.content.findIndex(e);if(t=t.maybeChild(n),!t)return null;if(i==e||t.isText)return t;e-=i+1}}childAfter(e){let{index:t,offset:n}=this.content.findIndex(e);return{node:this.content.maybeChild(t),index:t,offset:n}}childBefore(e){if(e==0)return{node:null,index:0,offset:0};let{index:t,offset:n}=this.content.findIndex(e);if(n<e)return{node:this.content.child(t),index:t,offset:n};let i=this.content.child(t-1);return{node:i,index:t-1,offset:n-i.nodeSize}}resolve(e){return cn.resolveCached(this,e)}resolveNoCache(e){return cn.resolve(this,e)}rangeHasMark(e,t,n){let i=!1;return t>e&&this.nodesBetween(e,t,r=>(n.isInSet(r.marks)&&(i=!0),!i)),i}get isBlock(){return this.type.isBlock}get isTextblock(){return this.type.isTextblock}get inlineContent(){return this.type.inlineContent}get isInline(){return this.type.isInline}get isText(){return this.type.isText}get isLeaf(){return this.type.isLeaf}get isAtom(){return this.type.isAtom}toString(){if(this.type.spec.toDebugString)return this.type.spec.toDebugString(this);let e=this.type.name;return this.content.size&&(e+="("+this.content.toStringInner()+")"),fo(this.marks,e)}contentMatchAt(e){let t=this.type.contentMatch.matchFragment(this.content,0,e);if(!t)throw new Error("Called contentMatchAt on a node with invalid content");return t}canReplace(e,t,n=E.empty,i=0,r=n.childCount){let o=this.contentMatchAt(e).matchFragment(n,i,r),a=o&&o.matchFragment(this.content,t);if(!a||!a.validEnd)return!1;for(let l=i;l<r;l++)if(!this.type.allowsMarks(n.child(l).marks))return!1;return!0}canReplaceWith(e,t,n,i){if(i&&!this.type.allowsMarks(i))return!1;let r=this.contentMatchAt(e).matchType(n),o=r&&r.matchFragment(this.content,t);return o?o.validEnd:!1}canAppend(e){return e.content.size?this.canReplace(this.childCount,this.childCount,e.content):this.type.compatibleContent(e.type)}check(){this.type.checkContent(this.content),this.type.checkAttrs(this.attrs);let e=J.none;for(let t=0;t<this.marks.length;t++){let n=this.marks[t];n.type.checkAttrs(n.attrs),e=n.addToSet(e)}if(!J.sameSet(e,this.marks))throw new RangeError(`Invalid collection of marks for node ${this.type.name}: ${this.marks.map(t=>t.type.name)}`);this.content.forEach(t=>t.check())}toJSON(){let e={type:this.type.name};for(let t in this.attrs){e.attrs=this.attrs;break}return this.content.size&&(e.content=this.content.toJSON()),this.marks.length&&(e.marks=this.marks.map(t=>t.toJSON())),e}static fromJSON(e,t){if(!t)throw new RangeError("Invalid input for Node.fromJSON");let n;if(t.marks){if(!Array.isArray(t.marks))throw new RangeError("Invalid mark data for Node.fromJSON");n=t.marks.map(e.markFromJSON)}if(t.type=="text"){if(typeof t.text!="string")throw new RangeError("Invalid text node in JSON");return e.text(t.text,n)}let i=E.fromJSON(e,t.content),r=e.nodeType(t.type).create(t.attrs,i,n);return r.type.checkAttrs(r.attrs),r}}Ke.prototype.text=void 0;class zn extends Ke{constructor(e,t,n,i){if(super(e,t,null,i),!n)throw new RangeError("Empty text nodes are not allowed");this.text=n}toString(){return this.type.spec.toDebugString?this.type.spec.toDebugString(this):fo(this.marks,JSON.stringify(this.text))}get textContent(){return this.text}textBetween(e,t){return this.text.slice(e,t)}get nodeSize(){return this.text.length}mark(e){return e==this.marks?this:new zn(this.type,this.attrs,this.text,e)}withText(e){return e==this.text?this:new zn(this.type,this.attrs,e,this.marks)}cut(e=0,t=this.text.length){return e==0&&t==this.text.length?this:this.withText(this.text.slice(e,t))}eq(e){return this.sameMarkup(e)&&this.text==e.text}toJSON(){let e=super.toJSON();return e.text=this.text,e}}function fo(s,e){for(let t=s.length-1;t>=0;t--)e=s[t].type.name+"("+e+")";return e}class Dt{constructor(e){this.validEnd=e,this.next=[],this.wrapCache=[]}static parse(e,t){let n=new ih(e,t);if(n.next==null)return Dt.empty;let i=po(n);n.next&&n.err("Unexpected trailing text");let r=hh(dh(i));return uh(r,n),r}matchType(e){for(let t=0;t<this.next.length;t++)if(this.next[t].type==e)return this.next[t].next;return null}matchFragment(e,t=0,n=e.childCount){let i=this;for(let r=t;i&&r<n;r++)i=i.matchType(e.child(r).type);return i}get inlineContent(){return this.next.length!=0&&this.next[0].type.isInline}get defaultType(){for(let e=0;e<this.next.length;e++){let{type:t}=this.next[e];if(!(t.isText||t.hasRequiredAttrs()))return t}return null}compatible(e){for(let t=0;t<this.next.length;t++)for(let n=0;n<e.next.length;n++)if(this.next[t].type==e.next[n].type)return!0;return!1}fillBefore(e,t=!1,n=0){let i=[this];function r(o,a){let l=o.matchFragment(e,n);if(l&&(!t||l.validEnd))return E.from(a.map(d=>d.createAndFill()));for(let d=0;d<o.next.length;d++){let{type:u,next:m}=o.next[d];if(!(u.isText||u.hasRequiredAttrs())&&i.indexOf(m)==-1){i.push(m);let p=r(m,a.concat(u));if(p)return p}}return null}return r(this,[])}findWrapping(e){for(let n=0;n<this.wrapCache.length;n+=2)if(this.wrapCache[n]==e)return this.wrapCache[n+1];let t=this.computeWrapping(e);return this.wrapCache.push(e,t),t}computeWrapping(e){let t=Object.create(null),n=[{match:this,type:null,via:null}];for(;n.length;){let i=n.shift(),r=i.match;if(r.matchType(e)){let o=[];for(let a=i;a.type;a=a.via)o.push(a.type);return o.reverse()}for(let o=0;o<r.next.length;o++){let{type:a,next:l}=r.next[o];!a.isLeaf&&!a.hasRequiredAttrs()&&!(a.name in t)&&(!i.type||l.validEnd)&&(n.push({match:a.contentMatch,type:a,via:i}),t[a.name]=!0)}}return null}get edgeCount(){return this.next.length}edge(e){if(e>=this.next.length)throw new RangeError(`There's no ${e}th edge in this content match`);return this.next[e]}toString(){let e=[];function t(n){e.push(n);for(let i=0;i<n.next.length;i++)e.indexOf(n.next[i].next)==-1&&t(n.next[i].next)}return t(this),e.map((n,i)=>{let r=i+(n.validEnd?"*":" ")+" ";for(let o=0;o<n.next.length;o++)r+=(o?", ":"")+n.next[o].type.name+"->"+e.indexOf(n.next[o].next);return r}).join(`
`)}}Dt.empty=new Dt(!0);class ih{constructor(e,t){this.string=e,this.nodeTypes=t,this.inline=null,this.pos=0,this.tokens=e.split(/\s*(?=\b|\W|$)/),this.tokens[this.tokens.length-1]==""&&this.tokens.pop(),this.tokens[0]==""&&this.tokens.shift()}get next(){return this.tokens[this.pos]}eat(e){return this.next==e&&(this.pos++||!0)}err(e){throw new SyntaxError(e+" (in content expression '"+this.string+"')")}}function po(s){let e=[];do e.push(rh(s));while(s.eat("|"));return e.length==1?e[0]:{type:"choice",exprs:e}}function rh(s){let e=[];do e.push(oh(s));while(s.next&&s.next!=")"&&s.next!="|");return e.length==1?e[0]:{type:"seq",exprs:e}}function oh(s){let e=ch(s);for(;;)if(s.eat("+"))e={type:"plus",expr:e};else if(s.eat("*"))e={type:"star",expr:e};else if(s.eat("?"))e={type:"opt",expr:e};else if(s.eat("{"))e=ah(s,e);else break;return e}function _i(s){/\D/.test(s.next)&&s.err("Expected number, got '"+s.next+"'");let e=Number(s.next);return s.pos++,e}function ah(s,e){let t=_i(s),n=t;return s.eat(",")&&(s.next!="}"?n=_i(s):n=-1),s.eat("}")||s.err("Unclosed braced range"),{type:"range",min:t,max:n,expr:e}}function lh(s,e){let t=s.nodeTypes,n=t[e];if(n)return[n];let i=[];for(let r in t){let o=t[r];o.groups.indexOf(e)>-1&&i.push(o)}return i.length==0&&s.err("No node type or group '"+e+"' found"),i}function ch(s){if(s.eat("(")){let e=po(s);return s.eat(")")||s.err("Missing closing paren"),e}else if(/\W/.test(s.next))s.err("Unexpected token '"+s.next+"'");else{let e=lh(s,s.next).map(t=>(s.inline==null?s.inline=t.isInline:s.inline!=t.isInline&&s.err("Mixing inline and block content"),{type:"name",value:t}));return s.pos++,e.length==1?e[0]:{type:"choice",exprs:e}}}function dh(s){let e=[[]];return i(r(s,0),t()),e;function t(){return e.push([])-1}function n(o,a,l){let d={term:l,to:a};return e[o].push(d),d}function i(o,a){o.forEach(l=>l.to=a)}function r(o,a){if(o.type=="choice")return o.exprs.reduce((l,d)=>l.concat(r(d,a)),[]);if(o.type=="seq")for(let l=0;;l++){let d=r(o.exprs[l],a);if(l==o.exprs.length-1)return d;i(d,a=t())}else if(o.type=="star"){let l=t();return n(a,l),i(r(o.expr,l),l),[n(l)]}else if(o.type=="plus"){let l=t();return i(r(o.expr,a),l),i(r(o.expr,l),l),[n(l)]}else{if(o.type=="opt")return[n(a)].concat(r(o.expr,a));if(o.type=="range"){let l=a;for(let d=0;d<o.min;d++){let u=t();i(r(o.expr,l),u),l=u}if(o.max==-1)i(r(o.expr,l),l);else for(let d=o.min;d<o.max;d++){let u=t();n(l,u),i(r(o.expr,l),u),l=u}return[n(l)]}else{if(o.type=="name")return[n(a,void 0,o.value)];throw new Error("Unknown expr type")}}}}function mo(s,e){return e-s}function Oi(s,e){let t=[];return n(e),t.sort(mo);function n(i){let r=s[i];if(r.length==1&&!r[0].term)return n(r[0].to);t.push(i);for(let o=0;o<r.length;o++){let{term:a,to:l}=r[o];!a&&t.indexOf(l)==-1&&n(l)}}}function hh(s){let e=Object.create(null);return t(Oi(s,0));function t(n){let i=[];n.forEach(o=>{s[o].forEach(({term:a,to:l})=>{if(!a)return;let d;for(let u=0;u<i.length;u++)i[u][0]==a&&(d=i[u][1]);Oi(s,l).forEach(u=>{d||i.push([a,d=[]]),d.indexOf(u)==-1&&d.push(u)})})});let r=e[n.join(",")]=new Dt(n.indexOf(s.length-1)>-1);for(let o=0;o<i.length;o++){let a=i[o][1].sort(mo);r.next.push({type:i[o][0],next:e[a.join(",")]||t(a)})}return r}}function uh(s,e){for(let t=0,n=[s];t<n.length;t++){let i=n[t],r=!i.validEnd,o=[];for(let a=0;a<i.next.length;a++){let{type:l,next:d}=i.next[a];o.push(l.name),r&&!(l.isText||l.hasRequiredAttrs())&&(r=!1),n.indexOf(d)==-1&&n.push(d)}r&&e.err("Only non-generatable nodes ("+o.join(", ")+") in a required position (see https://prosemirror.net/docs/guide/#generatable)")}}function go(s){let e=Object.create(null);for(let t in s){let n=s[t];if(!n.hasDefault)return null;e[t]=n.default}return e}function yo(s,e){let t=Object.create(null);for(let n in s){let i=e&&e[n];if(i===void 0){let r=s[n];if(r.hasDefault)i=r.default;else throw new RangeError("No value supplied for attribute "+n)}t[n]=i}return t}function xo(s,e,t,n){for(let i in e)if(!(i in s))throw new RangeError(`Unsupported attribute ${i} for ${t} of type ${i}`);for(let i in s){let r=s[i];r.validate&&r.validate(e[i])}}function ko(s,e){let t=Object.create(null);if(e)for(let n in e)t[n]=new ph(s,n,e[n]);return t}let Di=class bo{constructor(e,t,n){this.name=e,this.schema=t,this.spec=n,this.markSet=null,this.groups=n.group?n.group.split(" "):[],this.attrs=ko(e,n.attrs),this.defaultAttrs=go(this.attrs),this.contentMatch=null,this.inlineContent=null,this.isBlock=!(n.inline||e=="text"),this.isText=e=="text"}get isInline(){return!this.isBlock}get isTextblock(){return this.isBlock&&this.inlineContent}get isLeaf(){return this.contentMatch==Dt.empty}get isAtom(){return this.isLeaf||!!this.spec.atom}get whitespace(){return this.spec.whitespace||(this.spec.code?"pre":"normal")}hasRequiredAttrs(){for(let e in this.attrs)if(this.attrs[e].isRequired)return!0;return!1}compatibleContent(e){return this==e||this.contentMatch.compatible(e.contentMatch)}computeAttrs(e){return!e&&this.defaultAttrs?this.defaultAttrs:yo(this.attrs,e)}create(e=null,t,n){if(this.isText)throw new Error("NodeType.create can't construct text nodes");return new Ke(this,this.computeAttrs(e),E.from(t),J.setFrom(n))}createChecked(e=null,t,n){return t=E.from(t),this.checkContent(t),new Ke(this,this.computeAttrs(e),t,J.setFrom(n))}createAndFill(e=null,t,n){if(e=this.computeAttrs(e),t=E.from(t),t.size){let o=this.contentMatch.fillBefore(t);if(!o)return null;t=o.append(t)}let i=this.contentMatch.matchFragment(t),r=i&&i.fillBefore(E.empty,!0);return r?new Ke(this,e,t.append(r),J.setFrom(n)):null}validContent(e){let t=this.contentMatch.matchFragment(e);if(!t||!t.validEnd)return!1;for(let n=0;n<e.childCount;n++)if(!this.allowsMarks(e.child(n).marks))return!1;return!0}checkContent(e){if(!this.validContent(e))throw new RangeError(`Invalid content for node ${this.name}: ${e.toString().slice(0,50)}`)}checkAttrs(e){xo(this.attrs,e,"node",this.name)}allowsMarkType(e){return this.markSet==null||this.markSet.indexOf(e)>-1}allowsMarks(e){if(this.markSet==null)return!0;for(let t=0;t<e.length;t++)if(!this.allowsMarkType(e[t].type))return!1;return!0}allowedMarks(e){if(this.markSet==null)return e;let t;for(let n=0;n<e.length;n++)this.allowsMarkType(e[n].type)?t&&t.push(e[n]):t||(t=e.slice(0,n));return t?t.length?t:J.none:e}static compile(e,t){let n=Object.create(null);e.forEach((r,o)=>n[r]=new bo(r,t,o));let i=t.spec.topNode||"doc";if(!n[i])throw new RangeError("Schema is missing its top node type ('"+i+"')");if(!n.text)throw new RangeError("Every schema needs a 'text' type");for(let r in n.text.attrs)throw new RangeError("The text node type should not have attributes");return n}};function fh(s,e,t){let n=t.split("|");return i=>{let r=i===null?"null":typeof i;if(n.indexOf(r)<0)throw new RangeError(`Expected value of type ${n} for attribute ${e} on type ${s}, got ${r}`)}}class ph{constructor(e,t,n){this.hasDefault=Object.prototype.hasOwnProperty.call(n,"default"),this.default=n.default,this.validate=typeof n.validate=="string"?fh(e,t,n.validate):n.validate}get isRequired(){return!this.hasDefault}}class Gn{constructor(e,t,n,i){this.name=e,this.rank=t,this.schema=n,this.spec=i,this.attrs=ko(e,i.attrs),this.excluded=null;let r=go(this.attrs);this.instance=r?new J(this,r):null}create(e=null){return!e&&this.instance?this.instance:new J(this,yo(this.attrs,e))}static compile(e,t){let n=Object.create(null),i=0;return e.forEach((r,o)=>n[r]=new Gn(r,i++,t,o)),n}removeFromSet(e){for(var t=0;t<e.length;t++)e[t].type==this&&(e=e.slice(0,t).concat(e.slice(t+1)),t--);return e}isInSet(e){for(let t=0;t<e.length;t++)if(e[t].type==this)return e[t]}checkAttrs(e){xo(this.attrs,e,"mark",this.name)}excludes(e){return this.excluded.indexOf(e)>-1}}class vm{constructor(e){this.linebreakReplacement=null,this.cached=Object.create(null);let t=this.spec={};for(let i in e)t[i]=e[i];t.nodes=mi.from(e.nodes),t.marks=mi.from(e.marks||{}),this.nodes=Di.compile(this.spec.nodes,this),this.marks=Gn.compile(this.spec.marks,this);let n=Object.create(null);for(let i in this.nodes){if(i in this.marks)throw new RangeError(i+" can not be both a node and a mark");let r=this.nodes[i],o=r.spec.content||"",a=r.spec.marks;if(r.contentMatch=n[o]||(n[o]=Dt.parse(o,this.nodes)),r.inlineContent=r.contentMatch.inlineContent,r.spec.linebreakReplacement){if(this.linebreakReplacement)throw new RangeError("Multiple linebreak nodes defined");if(!r.isInline||!r.isLeaf)throw new RangeError("Linebreak replacement nodes must be inline leaf nodes");this.linebreakReplacement=r}r.markSet=a=="_"?null:a?Ri(this,a.split(" ")):a==""||!r.inlineContent?[]:null}for(let i in this.marks){let r=this.marks[i],o=r.spec.excludes;r.excluded=o==null?[r]:o==""?[]:Ri(this,o.split(" "))}this.nodeFromJSON=this.nodeFromJSON.bind(this),this.markFromJSON=this.markFromJSON.bind(this),this.topNodeType=this.nodes[this.spec.topNode||"doc"],this.cached.wrappings=Object.create(null)}node(e,t=null,n,i){if(typeof e=="string")e=this.nodeType(e);else if(e instanceof Di){if(e.schema!=this)throw new RangeError("Node type from different schema used ("+e.name+")")}else throw new RangeError("Invalid node type: "+e);return e.createChecked(t,n,i)}text(e,t){let n=this.nodes.text;return new zn(n,n.defaultAttrs,e,J.setFrom(t))}mark(e,t){return typeof e=="string"&&(e=this.marks[e]),e.create(t)}nodeFromJSON(e){return Ke.fromJSON(this,e)}markFromJSON(e){return J.fromJSON(this,e)}nodeType(e){let t=this.nodes[e];if(!t)throw new RangeError("Unknown node type: "+e);return t}}function Ri(s,e){let t=[];for(let n=0;n<e.length;n++){let i=e[n],r=s.marks[i],o=r;if(r)t.push(r);else for(let a in s.marks){let l=s.marks[a];(i=="_"||l.spec.group&&l.spec.group.split(" ").indexOf(i)>-1)&&t.push(o=l)}if(!o)throw new SyntaxError("Unknown mark type: '"+e[n]+"'")}return t}function mh(s){return s.tag!=null}function gh(s){return s.style!=null}class dn{constructor(e,t){this.schema=e,this.rules=t,this.tags=[],this.styles=[];let n=this.matchedStyles=[];t.forEach(i=>{if(mh(i))this.tags.push(i);else if(gh(i)){let r=/[^=]*/.exec(i.style)[0];n.indexOf(r)<0&&n.push(r),this.styles.push(i)}}),this.normalizeLists=!this.tags.some(i=>{if(!/^(ul|ol)\b/.test(i.tag)||!i.node)return!1;let r=e.nodes[i.node];return r.contentMatch.matchType(r)})}parse(e,t={}){let n=new vi(this,t,!1);return n.addAll(e,t.from,t.to),n.finish()}parseSlice(e,t={}){let n=new vi(this,t,!0);return n.addAll(e,t.from,t.to),O.maxOpen(n.finish())}matchTag(e,t,n){for(let i=n?this.tags.indexOf(n)+1:0;i<this.tags.length;i++){let r=this.tags[i];if(kh(e,r.tag)&&(r.namespace===void 0||e.namespaceURI==r.namespace)&&(!r.context||t.matchesContext(r.context))){if(r.getAttrs){let o=r.getAttrs(e);if(o===!1)continue;r.attrs=o||void 0}return r}}}matchStyle(e,t,n,i){for(let r=i?this.styles.indexOf(i)+1:0;r<this.styles.length;r++){let o=this.styles[r],a=o.style;if(!(a.indexOf(e)!=0||o.context&&!n.matchesContext(o.context)||a.length>e.length&&(a.charCodeAt(e.length)!=61||a.slice(e.length+1)!=t))){if(o.getAttrs){let l=o.getAttrs(t);if(l===!1)continue;o.attrs=l||void 0}return o}}}static schemaRules(e){let t=[];function n(i){let r=i.priority==null?50:i.priority,o=0;for(;o<t.length;o++){let a=t[o];if((a.priority==null?50:a.priority)<r)break}t.splice(o,0,i)}for(let i in e.marks){let r=e.marks[i].spec.parseDOM;r&&r.forEach(o=>{n(o=Bi(o)),o.mark||o.ignore||o.clearMark||(o.mark=i)})}for(let i in e.nodes){let r=e.nodes[i].spec.parseDOM;r&&r.forEach(o=>{n(o=Bi(o)),o.node||o.ignore||o.mark||(o.node=i)})}return t}static fromSchema(e){return e.cached.domParser||(e.cached.domParser=new dn(e,dn.schemaRules(e)))}}const So={address:!0,article:!0,aside:!0,blockquote:!0,canvas:!0,dd:!0,div:!0,dl:!0,fieldset:!0,figcaption:!0,figure:!0,footer:!0,form:!0,h1:!0,h2:!0,h3:!0,h4:!0,h5:!0,h6:!0,header:!0,hgroup:!0,hr:!0,li:!0,noscript:!0,ol:!0,output:!0,p:!0,pre:!0,section:!0,table:!0,tfoot:!0,ul:!0},yh={head:!0,noscript:!0,object:!0,script:!0,style:!0,title:!0},wo={ol:!0,ul:!0},jn=1,Vn=2,sn=4;function Ai(s,e,t){return e!=null?(e?jn:0)|(e==="full"?Vn:0):s&&s.whitespace=="pre"?jn|Vn:t&~sn}class Tn{constructor(e,t,n,i,r,o,a){this.type=e,this.attrs=t,this.marks=n,this.pendingMarks=i,this.solid=r,this.options=a,this.content=[],this.activeMarks=J.none,this.stashMarks=[],this.match=o||(a&sn?null:e.contentMatch)}findWrapping(e){if(!this.match){if(!this.type)return[];let t=this.type.contentMatch.fillBefore(E.from(e));if(t)this.match=this.type.contentMatch.matchFragment(t);else{let n=this.type.contentMatch,i;return(i=n.findWrapping(e.type))?(this.match=n,i):null}}return this.match.findWrapping(e.type)}finish(e){if(!(this.options&jn)){let n=this.content[this.content.length-1],i;if(n&&n.isText&&(i=/[ \t\r\n\u000c]+$/.exec(n.text))){let r=n;n.text.length==i[0].length?this.content.pop():this.content[this.content.length-1]=r.withText(r.text.slice(0,r.text.length-i[0].length))}}let t=E.from(this.content);return!e&&this.match&&(t=t.append(this.match.fillBefore(E.empty,!0))),this.type?this.type.create(this.attrs,t,this.marks):t}popFromStashMark(e){for(let t=this.stashMarks.length-1;t>=0;t--)if(e.eq(this.stashMarks[t]))return this.stashMarks.splice(t,1)[0]}applyPending(e){for(let t=0,n=this.pendingMarks;t<n.length;t++){let i=n[t];(this.type?this.type.allowsMarkType(i.type):bh(i.type,e))&&!i.isInSet(this.activeMarks)&&(this.activeMarks=i.addToSet(this.activeMarks),this.pendingMarks=i.removeFromSet(this.pendingMarks))}}inlineContext(e){return this.type?this.type.inlineContent:this.content.length?this.content[0].isInline:e.parentNode&&!So.hasOwnProperty(e.parentNode.nodeName.toLowerCase())}}class vi{constructor(e,t,n){this.parser=e,this.options=t,this.isOpen=n,this.open=0;let i=t.topNode,r,o=Ai(null,t.preserveWhitespace,0)|(n?sn:0);i?r=new Tn(i.type,i.attrs,J.none,J.none,!0,t.topMatch||i.type.contentMatch,o):n?r=new Tn(null,null,J.none,J.none,!0,null,o):r=new Tn(e.schema.topNodeType,null,J.none,J.none,!0,null,o),this.nodes=[r],this.find=t.findPositions,this.needsBlock=!1}get top(){return this.nodes[this.open]}addDOM(e){e.nodeType==3?this.addTextNode(e):e.nodeType==1&&this.addElement(e)}withStyleRules(e,t){let n=e.style;if(!n||!n.length)return t();let i=this.readStyles(e.style);if(!i)return;let[r,o]=i,a=this.top;for(let l=0;l<o.length;l++)this.removePendingMark(o[l],a);for(let l=0;l<r.length;l++)this.addPendingMark(r[l]);t();for(let l=0;l<r.length;l++)this.removePendingMark(r[l],a);for(let l=0;l<o.length;l++)this.addPendingMark(o[l])}addTextNode(e){let t=e.nodeValue,n=this.top;if(n.options&Vn||n.inlineContext(e)||/[^ \t\r\n\u000c]/.test(t)){if(n.options&jn)n.options&Vn?t=t.replace(/\r\n?/g,`
`):t=t.replace(/\r?\n|\r/g," ");else if(t=t.replace(/[ \t\r\n\u000c]+/g," "),/^[ \t\r\n\u000c]/.test(t)&&this.open==this.nodes.length-1){let i=n.content[n.content.length-1],r=e.previousSibling;(!i||r&&r.nodeName=="BR"||i.isText&&/[ \t\r\n\u000c]$/.test(i.text))&&(t=t.slice(1))}t&&this.insertNode(this.parser.schema.text(t)),this.findInText(e)}else this.findInside(e)}addElement(e,t){let n=e.nodeName.toLowerCase(),i;wo.hasOwnProperty(n)&&this.parser.normalizeLists&&xh(e);let r=this.options.ruleFromNode&&this.options.ruleFromNode(e)||(i=this.parser.matchTag(e,this,t));if(r?r.ignore:yh.hasOwnProperty(n))this.findInside(e),this.ignoreFallback(e);else if(!r||r.skip||r.closeParent){r&&r.closeParent?this.open=Math.max(0,this.open-1):r&&r.skip.nodeType&&(e=r.skip);let o,a=this.top,l=this.needsBlock;if(So.hasOwnProperty(n))a.content.length&&a.content[0].isInline&&this.open&&(this.open--,a=this.top),o=!0,a.type||(this.needsBlock=!0);else if(!e.firstChild){this.leafFallback(e);return}r&&r.skip?this.addAll(e):this.withStyleRules(e,()=>this.addAll(e)),o&&this.sync(a),this.needsBlock=l}else this.withStyleRules(e,()=>{this.addElementByRule(e,r,r.consuming===!1?i:void 0)})}leafFallback(e){e.nodeName=="BR"&&this.top.type&&this.top.type.inlineContent&&this.addTextNode(e.ownerDocument.createTextNode(`
`))}ignoreFallback(e){e.nodeName=="BR"&&(!this.top.type||!this.top.type.inlineContent)&&this.findPlace(this.parser.schema.text("-"))}readStyles(e){let t=J.none,n=J.none;if(e.length)for(let i=0;i<this.parser.matchedStyles.length;i++){let r=this.parser.matchedStyles[i],o=e.getPropertyValue(r);if(o)for(let a=void 0;;){let l=this.parser.matchStyle(r,o,this,a);if(!l)break;if(l.ignore)return null;if(l.clearMark?this.top.pendingMarks.concat(this.top.activeMarks).forEach(d=>{l.clearMark(d)&&(n=d.addToSet(n))}):t=this.parser.schema.marks[l.mark].create(l.attrs).addToSet(t),l.consuming===!1)a=l;else break}}return[t,n]}addElementByRule(e,t,n){let i,r,o;t.node?(r=this.parser.schema.nodes[t.node],r.isLeaf?this.insertNode(r.create(t.attrs))||this.leafFallback(e):i=this.enter(r,t.attrs||null,t.preserveWhitespace)):(o=this.parser.schema.marks[t.mark].create(t.attrs),this.addPendingMark(o));let a=this.top;if(r&&r.isLeaf)this.findInside(e);else if(n)this.addElement(e,n);else if(t.getContent)this.findInside(e),t.getContent(e,this.parser.schema).forEach(l=>this.insertNode(l));else{let l=e;typeof t.contentElement=="string"?l=e.querySelector(t.contentElement):typeof t.contentElement=="function"?l=t.contentElement(e):t.contentElement&&(l=t.contentElement),this.findAround(e,l,!0),this.addAll(l)}i&&this.sync(a)&&this.open--,o&&this.removePendingMark(o,a)}addAll(e,t,n){let i=t||0;for(let r=t?e.childNodes[t]:e.firstChild,o=n==null?null:e.childNodes[n];r!=o;r=r.nextSibling,++i)this.findAtPoint(e,i),this.addDOM(r);this.findAtPoint(e,i)}findPlace(e){let t,n;for(let i=this.open;i>=0;i--){let r=this.nodes[i],o=r.findWrapping(e);if(o&&(!t||t.length>o.length)&&(t=o,n=r,!o.length)||r.solid)break}if(!t)return!1;this.sync(n);for(let i=0;i<t.length;i++)this.enterInner(t[i],null,!1);return!0}insertNode(e){if(e.isInline&&this.needsBlock&&!this.top.type){let t=this.textblockFromContext();t&&this.enterInner(t)}if(this.findPlace(e)){this.closeExtra();let t=this.top;t.applyPending(e.type),t.match&&(t.match=t.match.matchType(e.type));let n=t.activeMarks;for(let i=0;i<e.marks.length;i++)(!t.type||t.type.allowsMarkType(e.marks[i].type))&&(n=e.marks[i].addToSet(n));return t.content.push(e.mark(n)),!0}return!1}enter(e,t,n){let i=this.findPlace(e.create(t));return i&&this.enterInner(e,t,!0,n),i}enterInner(e,t=null,n=!1,i){this.closeExtra();let r=this.top;r.applyPending(e),r.match=r.match&&r.match.matchType(e);let o=Ai(e,i,r.options);r.options&sn&&r.content.length==0&&(o|=sn),this.nodes.push(new Tn(e,t,r.activeMarks,r.pendingMarks,n,null,o)),this.open++}closeExtra(e=!1){let t=this.nodes.length-1;if(t>this.open){for(;t>this.open;t--)this.nodes[t-1].content.push(this.nodes[t].finish(e));this.nodes.length=this.open+1}}finish(){return this.open=0,this.closeExtra(this.isOpen),this.nodes[0].finish(this.isOpen||this.options.topOpen)}sync(e){for(let t=this.open;t>=0;t--)if(this.nodes[t]==e)return this.open=t,!0;return!1}get currentPos(){this.closeExtra();let e=0;for(let t=this.open;t>=0;t--){let n=this.nodes[t].content;for(let i=n.length-1;i>=0;i--)e+=n[i].nodeSize;t&&e++}return e}findAtPoint(e,t){if(this.find)for(let n=0;n<this.find.length;n++)this.find[n].node==e&&this.find[n].offset==t&&(this.find[n].pos=this.currentPos)}findInside(e){if(this.find)for(let t=0;t<this.find.length;t++)this.find[t].pos==null&&e.nodeType==1&&e.contains(this.find[t].node)&&(this.find[t].pos=this.currentPos)}findAround(e,t,n){if(e!=t&&this.find)for(let i=0;i<this.find.length;i++)this.find[i].pos==null&&e.nodeType==1&&e.contains(this.find[i].node)&&t.compareDocumentPosition(this.find[i].node)&(n?2:4)&&(this.find[i].pos=this.currentPos)}findInText(e){if(this.find)for(let t=0;t<this.find.length;t++)this.find[t].node==e&&(this.find[t].pos=this.currentPos-(e.nodeValue.length-this.find[t].offset))}matchesContext(e){if(e.indexOf("|")>-1)return e.split(/\s*\|\s*/).some(this.matchesContext,this);let t=e.split("/"),n=this.options.context,i=!this.isOpen&&(!n||n.parent.type==this.nodes[0].type),r=-(n?n.depth+1:0)+(i?0:1),o=(a,l)=>{for(;a>=0;a--){let d=t[a];if(d==""){if(a==t.length-1||a==0)continue;for(;l>=r;l--)if(o(a-1,l))return!0;return!1}else{let u=l>0||l==0&&i?this.nodes[l].type:n&&l>=r?n.node(l-r).type:null;if(!u||u.name!=d&&u.groups.indexOf(d)==-1)return!1;l--}}return!0};return o(t.length-1,this.open)}textblockFromContext(){let e=this.options.context;if(e)for(let t=e.depth;t>=0;t--){let n=e.node(t).contentMatchAt(e.indexAfter(t)).defaultType;if(n&&n.isTextblock&&n.defaultAttrs)return n}for(let t in this.parser.schema.nodes){let n=this.parser.schema.nodes[t];if(n.isTextblock&&n.defaultAttrs)return n}}addPendingMark(e){let t=Sh(e,this.top.pendingMarks);t&&this.top.stashMarks.push(t),this.top.pendingMarks=e.addToSet(this.top.pendingMarks)}removePendingMark(e,t){for(let n=this.open;n>=0;n--){let i=this.nodes[n];if(i.pendingMarks.lastIndexOf(e)>-1)i.pendingMarks=e.removeFromSet(i.pendingMarks);else{i.activeMarks=e.removeFromSet(i.activeMarks);let o=i.popFromStashMark(e);o&&i.type&&i.type.allowsMarkType(o.type)&&(i.activeMarks=o.addToSet(i.activeMarks))}if(i==t)break}}}function xh(s){for(let e=s.firstChild,t=null;e;e=e.nextSibling){let n=e.nodeType==1?e.nodeName.toLowerCase():null;n&&wo.hasOwnProperty(n)&&t?(t.appendChild(e),e=t):n=="li"?t=e:n&&(t=null)}}function kh(s,e){return(s.matches||s.msMatchesSelector||s.webkitMatchesSelector||s.mozMatchesSelector).call(s,e)}function Bi(s){let e={};for(let t in s)e[t]=s[t];return e}function bh(s,e){let t=e.schema.nodes;for(let n in t){let i=t[n];if(!i.allowsMarkType(s))continue;let r=[],o=a=>{r.push(a);for(let l=0;l<a.edgeCount;l++){let{type:d,next:u}=a.edge(l);if(d==e||r.indexOf(u)<0&&o(u))return!0}};if(o(i.contentMatch))return!0}}function Sh(s,e){for(let t=0;t<e.length;t++)if(s.eq(e[t]))return e[t]}class Gt{constructor(e,t){this.nodes=e,this.marks=t}serializeFragment(e,t={},n){n||(n=os(t).createDocumentFragment());let i=n,r=[];return e.forEach(o=>{if(r.length||o.marks.length){let a=0,l=0;for(;a<r.length&&l<o.marks.length;){let d=o.marks[l];if(!this.marks[d.type.name]){l++;continue}if(!d.eq(r[a][0])||d.type.spec.spanning===!1)break;a++,l++}for(;a<r.length;)i=r.pop()[1];for(;l<o.marks.length;){let d=o.marks[l++],u=this.serializeMark(d,o.isInline,t);u&&(r.push([d,i]),i.appendChild(u.dom),i=u.contentDOM||u.dom)}}i.appendChild(this.serializeNodeInner(o,t))}),n}serializeNodeInner(e,t){let{dom:n,contentDOM:i}=On(os(t),this.nodes[e.type.name](e),null,e.attrs);if(i){if(e.isLeaf)throw new RangeError("Content hole not allowed in a leaf node spec");this.serializeFragment(e.content,t,i)}return n}serializeNode(e,t={}){let n=this.serializeNodeInner(e,t);for(let i=e.marks.length-1;i>=0;i--){let r=this.serializeMark(e.marks[i],e.isInline,t);r&&((r.contentDOM||r.dom).appendChild(n),n=r.dom)}return n}serializeMark(e,t,n={}){let i=this.marks[e.type.name];return i&&On(os(n),i(e,t),null,e.attrs)}static renderSpec(e,t,n=null,i){return On(e,t,n,i)}static fromSchema(e){return e.cached.domSerializer||(e.cached.domSerializer=new Gt(this.nodesFromSchema(e),this.marksFromSchema(e)))}static nodesFromSchema(e){let t=Fi(e.nodes);return t.text||(t.text=n=>n.text),t}static marksFromSchema(e){return Fi(e.marks)}}function Fi(s){let e={};for(let t in s){let n=s[t].spec.toDOM;n&&(e[t]=n)}return e}function os(s){return s.document||window.document}const Pi=new WeakMap;function wh(s){let e=Pi.get(s);return e===void 0&&Pi.set(s,e=Ch(s)),e}function Ch(s){let e=null;function t(n){if(n&&typeof n=="object")if(Array.isArray(n))if(typeof n[0]=="string")e||(e=[]),e.push(n);else for(let i=0;i<n.length;i++)t(n[i]);else for(let i in n)t(n[i])}return t(s),e}function On(s,e,t,n){if(typeof e=="string")return{dom:s.createTextNode(e)};if(e.nodeType!=null)return{dom:e};if(e.dom&&e.dom.nodeType!=null)return e;let i=e[0],r;if(typeof i!="string")throw new RangeError("Invalid array passed to renderSpec");if(n&&(r=wh(n))&&r.indexOf(e)>-1)throw new RangeError("Using an array from an attribute object as a DOM spec. This may be an attempted cross site scripting attack.");let o=i.indexOf(" ");o>0&&(t=i.slice(0,o),i=i.slice(o+1));let a,l=t?s.createElementNS(t,i):s.createElement(i),d=e[1],u=1;if(d&&typeof d=="object"&&d.nodeType==null&&!Array.isArray(d)){u=2;for(let m in d)if(d[m]!=null){let p=m.indexOf(" ");p>0?l.setAttributeNS(m.slice(0,p),m.slice(p+1),d[m]):l.setAttribute(m,d[m])}}for(let m=u;m<e.length;m++){let p=e[m];if(p===0){if(m<e.length-1||m>u)throw new RangeError("Content hole must be the only child of its parent node");return{dom:l,contentDOM:l}}else{let{dom:k,contentDOM:y}=On(s,p,t,n);if(l.appendChild(k),y){if(a)throw new RangeError("Multiple content holes");a=y}}}return{dom:l,contentDOM:a}}const Co=65535,To=Math.pow(2,16);function Th(s,e){return s+e*To}function Li(s){return s&Co}function Mh(s){return(s-(s&Co))/To}const Mo=1,Eo=2,Dn=4,Io=8;class Ns{constructor(e,t,n){this.pos=e,this.delInfo=t,this.recover=n}get deleted(){return(this.delInfo&Io)>0}get deletedBefore(){return(this.delInfo&(Mo|Dn))>0}get deletedAfter(){return(this.delInfo&(Eo|Dn))>0}get deletedAcross(){return(this.delInfo&Dn)>0}}class De{constructor(e,t=!1){if(this.ranges=e,this.inverted=t,!e.length&&De.empty)return De.empty}recover(e){let t=0,n=Li(e);if(!this.inverted)for(let i=0;i<n;i++)t+=this.ranges[i*3+2]-this.ranges[i*3+1];return this.ranges[n*3]+t+Mh(e)}mapResult(e,t=1){return this._map(e,t,!1)}map(e,t=1){return this._map(e,t,!0)}_map(e,t,n){let i=0,r=this.inverted?2:1,o=this.inverted?1:2;for(let a=0;a<this.ranges.length;a+=3){let l=this.ranges[a]-(this.inverted?i:0);if(l>e)break;let d=this.ranges[a+r],u=this.ranges[a+o],m=l+d;if(e<=m){let p=d?e==l?-1:e==m?1:t:t,k=l+i+(p<0?0:u);if(n)return k;let y=e==(t<0?l:m)?null:Th(a/3,e-l),S=e==l?Eo:e==m?Mo:Dn;return(t<0?e!=l:e!=m)&&(S|=Io),new Ns(k,S,y)}i+=u-d}return n?e+i:new Ns(e+i,0,null)}touches(e,t){let n=0,i=Li(t),r=this.inverted?2:1,o=this.inverted?1:2;for(let a=0;a<this.ranges.length;a+=3){let l=this.ranges[a]-(this.inverted?n:0);if(l>e)break;let d=this.ranges[a+r],u=l+d;if(e<=u&&a==i*3)return!0;n+=this.ranges[a+o]-d}return!1}forEach(e){let t=this.inverted?2:1,n=this.inverted?1:2;for(let i=0,r=0;i<this.ranges.length;i+=3){let o=this.ranges[i],a=o-(this.inverted?r:0),l=o+(this.inverted?0:r),d=this.ranges[i+t],u=this.ranges[i+n];e(a,a+d,l,l+u),r+=u-d}}invert(){return new De(this.ranges,!this.inverted)}toString(){return(this.inverted?"-":"")+JSON.stringify(this.ranges)}static offset(e){return e==0?De.empty:new De(e<0?[0,-e,0]:[0,0,e])}}De.empty=new De([]);class rn{constructor(e=[],t,n=0,i=e.length){this.maps=e,this.mirror=t,this.from=n,this.to=i}slice(e=0,t=this.maps.length){return new rn(this.maps,this.mirror,e,t)}copy(){return new rn(this.maps.slice(),this.mirror&&this.mirror.slice(),this.from,this.to)}appendMap(e,t){this.to=this.maps.push(e),t!=null&&this.setMirror(this.maps.length-1,t)}appendMapping(e){for(let t=0,n=this.maps.length;t<e.maps.length;t++){let i=e.getMirror(t);this.appendMap(e.maps[t],i!=null&&i<t?n+i:void 0)}}getMirror(e){if(this.mirror){for(let t=0;t<this.mirror.length;t++)if(this.mirror[t]==e)return this.mirror[t+(t%2?-1:1)]}}setMirror(e,t){this.mirror||(this.mirror=[]),this.mirror.push(e,t)}appendMappingInverted(e){for(let t=e.maps.length-1,n=this.maps.length+e.maps.length;t>=0;t--){let i=e.getMirror(t);this.appendMap(e.maps[t].invert(),i!=null&&i>t?n-i-1:void 0)}}invert(){let e=new rn;return e.appendMappingInverted(this),e}map(e,t=1){if(this.mirror)return this._map(e,t,!0);for(let n=this.from;n<this.to;n++)e=this.maps[n].map(e,t);return e}mapResult(e,t=1){return this._map(e,t,!1)}_map(e,t,n){let i=0;for(let r=this.from;r<this.to;r++){let o=this.maps[r],a=o.mapResult(e,t);if(a.recover!=null){let l=this.getMirror(r);if(l!=null&&l>r&&l<this.to){r=l,e=this.maps[l].recover(a.recover);continue}}i|=a.delInfo,e=a.pos}return n?e:new Ns(e,i,null)}}const as=Object.create(null);class ke{getMap(){return De.empty}merge(e){return null}static fromJSON(e,t){if(!t||!t.stepType)throw new RangeError("Invalid input for Step.fromJSON");let n=as[t.stepType];if(!n)throw new RangeError(`No step type ${t.stepType} defined`);return n.fromJSON(e,t)}static jsonID(e,t){if(e in as)throw new RangeError("Duplicate use of step JSON ID "+e);return as[e]=t,t.prototype.jsonID=e,t}}class ae{constructor(e,t){this.doc=e,this.failed=t}static ok(e){return new ae(e,null)}static fail(e){return new ae(null,e)}static fromReplace(e,t,n,i){try{return ae.ok(e.replace(t,n,i))}catch(r){if(r instanceof Pn)return ae.fail(r.message);throw r}}}function ei(s,e,t){let n=[];for(let i=0;i<s.childCount;i++){let r=s.child(i);r.content.size&&(r=r.copy(ei(r.content,e,r))),r.isInline&&(r=e(r,t,i)),n.push(r)}return E.fromArray(n)}class ft extends ke{constructor(e,t,n){super(),this.from=e,this.to=t,this.mark=n}apply(e){let t=e.slice(this.from,this.to),n=e.resolve(this.from),i=n.node(n.sharedDepth(this.to)),r=new O(ei(t.content,(o,a)=>!o.isAtom||!a.type.allowsMarkType(this.mark.type)?o:o.mark(this.mark.addToSet(o.marks)),i),t.openStart,t.openEnd);return ae.fromReplace(e,this.from,this.to,r)}invert(){return new Ge(this.from,this.to,this.mark)}map(e){let t=e.mapResult(this.from,1),n=e.mapResult(this.to,-1);return t.deleted&&n.deleted||t.pos>=n.pos?null:new ft(t.pos,n.pos,this.mark)}merge(e){return e instanceof ft&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from?new ft(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark):null}toJSON(){return{stepType:"addMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for AddMarkStep.fromJSON");return new ft(t.from,t.to,e.markFromJSON(t.mark))}}ke.jsonID("addMark",ft);class Ge extends ke{constructor(e,t,n){super(),this.from=e,this.to=t,this.mark=n}apply(e){let t=e.slice(this.from,this.to),n=new O(ei(t.content,i=>i.mark(this.mark.removeFromSet(i.marks)),e),t.openStart,t.openEnd);return ae.fromReplace(e,this.from,this.to,n)}invert(){return new ft(this.from,this.to,this.mark)}map(e){let t=e.mapResult(this.from,1),n=e.mapResult(this.to,-1);return t.deleted&&n.deleted||t.pos>=n.pos?null:new Ge(t.pos,n.pos,this.mark)}merge(e){return e instanceof Ge&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from?new Ge(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark):null}toJSON(){return{stepType:"removeMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for RemoveMarkStep.fromJSON");return new Ge(t.from,t.to,e.markFromJSON(t.mark))}}ke.jsonID("removeMark",Ge);class pt extends ke{constructor(e,t){super(),this.pos=e,this.mark=t}apply(e){let t=e.nodeAt(this.pos);if(!t)return ae.fail("No node at mark step's position");let n=t.type.create(t.attrs,null,this.mark.addToSet(t.marks));return ae.fromReplace(e,this.pos,this.pos+1,new O(E.from(n),0,t.isLeaf?0:1))}invert(e){let t=e.nodeAt(this.pos);if(t){let n=this.mark.addToSet(t.marks);if(n.length==t.marks.length){for(let i=0;i<t.marks.length;i++)if(!t.marks[i].isInSet(n))return new pt(this.pos,t.marks[i]);return new pt(this.pos,this.mark)}}return new Jt(this.pos,this.mark)}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new pt(t.pos,this.mark)}toJSON(){return{stepType:"addNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for AddNodeMarkStep.fromJSON");return new pt(t.pos,e.markFromJSON(t.mark))}}ke.jsonID("addNodeMark",pt);class Jt extends ke{constructor(e,t){super(),this.pos=e,this.mark=t}apply(e){let t=e.nodeAt(this.pos);if(!t)return ae.fail("No node at mark step's position");let n=t.type.create(t.attrs,null,this.mark.removeFromSet(t.marks));return ae.fromReplace(e,this.pos,this.pos+1,new O(E.from(n),0,t.isLeaf?0:1))}invert(e){let t=e.nodeAt(this.pos);return!t||!this.mark.isInSet(t.marks)?this:new pt(this.pos,this.mark)}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new Jt(t.pos,this.mark)}toJSON(){return{stepType:"removeNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for RemoveNodeMarkStep.fromJSON");return new Jt(t.pos,e.markFromJSON(t.mark))}}ke.jsonID("removeNodeMark",Jt);class ge extends ke{constructor(e,t,n,i=!1){super(),this.from=e,this.to=t,this.slice=n,this.structure=i}apply(e){return this.structure&&_s(e,this.from,this.to)?ae.fail("Structure replace would overwrite content"):ae.fromReplace(e,this.from,this.to,this.slice)}getMap(){return new De([this.from,this.to-this.from,this.slice.size])}invert(e){return new ge(this.from,this.from+this.slice.size,e.slice(this.from,this.to))}map(e){let t=e.mapResult(this.from,1),n=e.mapResult(this.to,-1);return t.deletedAcross&&n.deletedAcross?null:new ge(t.pos,Math.max(t.pos,n.pos),this.slice)}merge(e){if(!(e instanceof ge)||e.structure||this.structure)return null;if(this.from+this.slice.size==e.from&&!this.slice.openEnd&&!e.slice.openStart){let t=this.slice.size+e.slice.size==0?O.empty:new O(this.slice.content.append(e.slice.content),this.slice.openStart,e.slice.openEnd);return new ge(this.from,this.to+(e.to-e.from),t,this.structure)}else if(e.to==this.from&&!this.slice.openStart&&!e.slice.openEnd){let t=this.slice.size+e.slice.size==0?O.empty:new O(e.slice.content.append(this.slice.content),e.slice.openStart,this.slice.openEnd);return new ge(e.from,this.to,t,this.structure)}else return null}toJSON(){let e={stepType:"replace",from:this.from,to:this.to};return this.slice.size&&(e.slice=this.slice.toJSON()),this.structure&&(e.structure=!0),e}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for ReplaceStep.fromJSON");return new ge(t.from,t.to,O.fromJSON(e,t.slice),!!t.structure)}}ke.jsonID("replace",ge);class Ue extends ke{constructor(e,t,n,i,r,o,a=!1){super(),this.from=e,this.to=t,this.gapFrom=n,this.gapTo=i,this.slice=r,this.insert=o,this.structure=a}apply(e){if(this.structure&&(_s(e,this.from,this.gapFrom)||_s(e,this.gapTo,this.to)))return ae.fail("Structure gap-replace would overwrite content");let t=e.slice(this.gapFrom,this.gapTo);if(t.openStart||t.openEnd)return ae.fail("Gap is not a flat range");let n=this.slice.insertAt(this.insert,t.content);return n?ae.fromReplace(e,this.from,this.to,n):ae.fail("Content does not fit in gap")}getMap(){return new De([this.from,this.gapFrom-this.from,this.insert,this.gapTo,this.to-this.gapTo,this.slice.size-this.insert])}invert(e){let t=this.gapTo-this.gapFrom;return new Ue(this.from,this.from+this.slice.size+t,this.from+this.insert,this.from+this.insert+t,e.slice(this.from,this.to).removeBetween(this.gapFrom-this.from,this.gapTo-this.from),this.gapFrom-this.from,this.structure)}map(e){let t=e.mapResult(this.from,1),n=e.mapResult(this.to,-1),i=this.from==this.gapFrom?t.pos:e.map(this.gapFrom,-1),r=this.to==this.gapTo?n.pos:e.map(this.gapTo,1);return t.deletedAcross&&n.deletedAcross||i<t.pos||r>n.pos?null:new Ue(t.pos,n.pos,i,r,this.slice,this.insert,this.structure)}toJSON(){let e={stepType:"replaceAround",from:this.from,to:this.to,gapFrom:this.gapFrom,gapTo:this.gapTo,insert:this.insert};return this.slice.size&&(e.slice=this.slice.toJSON()),this.structure&&(e.structure=!0),e}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number"||typeof t.gapFrom!="number"||typeof t.gapTo!="number"||typeof t.insert!="number")throw new RangeError("Invalid input for ReplaceAroundStep.fromJSON");return new Ue(t.from,t.to,t.gapFrom,t.gapTo,O.fromJSON(e,t.slice),t.insert,!!t.structure)}}ke.jsonID("replaceAround",Ue);function _s(s,e,t){let n=s.resolve(e),i=t-e,r=n.depth;for(;i>0&&r>0&&n.indexAfter(r)==n.node(r).childCount;)r--,i--;if(i>0){let o=n.node(r).maybeChild(n.indexAfter(r));for(;i>0;){if(!o||o.isLeaf)return!0;o=o.firstChild,i--}}return!1}function Eh(s,e,t,n){let i=[],r=[],o,a;s.doc.nodesBetween(e,t,(l,d,u)=>{if(!l.isInline)return;let m=l.marks;if(!n.isInSet(m)&&u.type.allowsMarkType(n.type)){let p=Math.max(d,e),k=Math.min(d+l.nodeSize,t),y=n.addToSet(m);for(let S=0;S<m.length;S++)m[S].isInSet(y)||(o&&o.to==p&&o.mark.eq(m[S])?o.to=k:i.push(o=new Ge(p,k,m[S])));a&&a.to==p?a.to=k:r.push(a=new ft(p,k,n))}}),i.forEach(l=>s.step(l)),r.forEach(l=>s.step(l))}function Ih(s,e,t,n){let i=[],r=0;s.doc.nodesBetween(e,t,(o,a)=>{if(!o.isInline)return;r++;let l=null;if(n instanceof Gn){let d=o.marks,u;for(;u=n.isInSet(d);)(l||(l=[])).push(u),d=u.removeFromSet(d)}else n?n.isInSet(o.marks)&&(l=[n]):l=o.marks;if(l&&l.length){let d=Math.min(a+o.nodeSize,t);for(let u=0;u<l.length;u++){let m=l[u],p;for(let k=0;k<i.length;k++){let y=i[k];y.step==r-1&&m.eq(i[k].style)&&(p=y)}p?(p.to=d,p.step=r):i.push({style:m,from:Math.max(a,e),to:d,step:r})}}}),i.forEach(o=>s.step(new Ge(o.from,o.to,o.style)))}function No(s,e,t,n=t.contentMatch,i=!0){let r=s.doc.nodeAt(e),o=[],a=e+1;for(let l=0;l<r.childCount;l++){let d=r.child(l),u=a+d.nodeSize,m=n.matchType(d.type);if(!m)o.push(new ge(a,u,O.empty));else{n=m;for(let p=0;p<d.marks.length;p++)t.allowsMarkType(d.marks[p].type)||s.step(new Ge(a,u,d.marks[p]));if(i&&d.isText&&t.whitespace!="pre"){let p,k=/\r?\n|\r/g,y;for(;p=k.exec(d.text);)y||(y=new O(E.from(t.schema.text(" ",t.allowedMarks(d.marks))),0,0)),o.push(new ge(a+p.index,a+p.index+p[0].length,y))}}a=u}if(!n.validEnd){let l=n.fillBefore(E.empty,!0);s.replace(a,a,new O(l,0,0))}for(let l=o.length-1;l>=0;l--)s.step(o[l])}function Nh(s,e,t){return(e==0||s.canReplace(e,s.childCount))&&(t==s.childCount||s.canReplace(0,t))}function Bm(s){let t=s.parent.content.cutByIndex(s.startIndex,s.endIndex);for(let n=s.depth;;--n){let i=s.$from.node(n),r=s.$from.index(n),o=s.$to.indexAfter(n);if(n<s.depth&&i.canReplace(r,o,t))return n;if(n==0||i.type.spec.isolating||!Nh(i,r,o))break}return null}function _h(s,e,t){let{$from:n,$to:i,depth:r}=e,o=n.before(r+1),a=i.after(r+1),l=o,d=a,u=E.empty,m=0;for(let y=r,S=!1;y>t;y--)S||n.index(y)>0?(S=!0,u=E.from(n.node(y).copy(u)),m++):l--;let p=E.empty,k=0;for(let y=r,S=!1;y>t;y--)S||i.after(y+1)<i.end(y)?(S=!0,p=E.from(i.node(y).copy(p)),k++):d++;s.step(new Ue(l,d,o,a,new O(u.append(p),m,k),u.size-m,!0))}function Fm(s,e,t=null,n=s){let i=Oh(s,e),r=i&&Dh(n,e);return r?i.map(zi).concat({type:e,attrs:t}).concat(r.map(zi)):null}function zi(s){return{type:s,attrs:null}}function Oh(s,e){let{parent:t,startIndex:n,endIndex:i}=s,r=t.contentMatchAt(n).findWrapping(e);if(!r)return null;let o=r.length?r[0]:e;return t.canReplaceWith(n,i,o)?r:null}function Dh(s,e){let{parent:t,startIndex:n,endIndex:i}=s,r=t.child(n),o=e.contentMatch.findWrapping(r.type);if(!o)return null;let l=(o.length?o[o.length-1]:e).contentMatch;for(let d=n;l&&d<i;d++)l=l.matchType(t.child(d).type);return!l||!l.validEnd?null:o}function Rh(s,e,t){let n=E.empty;for(let o=t.length-1;o>=0;o--){if(n.size){let a=t[o].type.contentMatch.matchFragment(n);if(!a||!a.validEnd)throw new RangeError("Wrapper type given to Transform.wrap does not form valid content of its parent wrapper")}n=E.from(t[o].type.create(t[o].attrs,n))}let i=e.start,r=e.end;s.step(new Ue(i,r,i,r,new O(n,0,0),t.length,!0))}function Ah(s,e,t,n,i){if(!n.isTextblock)throw new RangeError("Type given to setBlockType should be a textblock");let r=s.steps.length;s.doc.nodesBetween(e,t,(o,a)=>{if(o.isTextblock&&!o.hasMarkup(n,i)&&Fh(s.doc,s.mapping.slice(r).map(a),n)){let l=null;if(n.schema.linebreakReplacement){let p=n.whitespace=="pre",k=!!n.contentMatch.matchType(n.schema.linebreakReplacement);p&&!k?l=!1:!p&&k&&(l=!0)}l===!1&&Bh(s,o,a,r),No(s,s.mapping.slice(r).map(a,1),n,void 0,l===null);let d=s.mapping.slice(r),u=d.map(a,1),m=d.map(a+o.nodeSize,1);return s.step(new Ue(u,m,u+1,m-1,new O(E.from(n.create(i,null,o.marks)),0,0),1,!0)),l===!0&&vh(s,o,a,r),!1}})}function vh(s,e,t,n){e.forEach((i,r)=>{if(i.isText){let o,a=/\r?\n|\r/g;for(;o=a.exec(i.text);){let l=s.mapping.slice(n).map(t+1+r+o.index);s.replaceWith(l,l+1,e.type.schema.linebreakReplacement.create())}}})}function Bh(s,e,t,n){e.forEach((i,r)=>{if(i.type==i.type.schema.linebreakReplacement){let o=s.mapping.slice(n).map(t+1+r);s.replaceWith(o,o+1,e.type.schema.text(`
`))}})}function Fh(s,e,t){let n=s.resolve(e),i=n.index();return n.parent.canReplaceWith(i,i+1,t)}function Ph(s,e,t,n,i){let r=s.doc.nodeAt(e);if(!r)throw new RangeError("No node at given position");t||(t=r.type);let o=t.create(n,null,i||r.marks);if(r.isLeaf)return s.replaceWith(e,e+r.nodeSize,o);if(!t.validContent(r.content))throw new RangeError("Invalid content for node type "+t.name);s.step(new Ue(e,e+r.nodeSize,e+1,e+r.nodeSize-1,new O(E.from(o),0,0),1,!0))}function Pm(s,e,t=1,n){let i=s.resolve(e),r=i.depth-t,o=n&&n[n.length-1]||i.parent;if(r<0||i.parent.type.spec.isolating||!i.parent.canReplace(i.index(),i.parent.childCount)||!o.type.validContent(i.parent.content.cutByIndex(i.index(),i.parent.childCount)))return!1;for(let d=i.depth-1,u=t-2;d>r;d--,u--){let m=i.node(d),p=i.index(d);if(m.type.spec.isolating)return!1;let k=m.content.cutByIndex(p,m.childCount),y=n&&n[u+1];y&&(k=k.replaceChild(0,y.type.create(y.attrs)));let S=n&&n[u]||m;if(!m.canReplace(p+1,m.childCount)||!S.type.validContent(k))return!1}let a=i.indexAfter(r),l=n&&n[0];return i.node(r).canReplaceWith(a,a,l?l.type:i.node(r+1).type)}function Lh(s,e,t=1,n){let i=s.doc.resolve(e),r=E.empty,o=E.empty;for(let a=i.depth,l=i.depth-t,d=t-1;a>l;a--,d--){r=E.from(i.node(a).copy(r));let u=n&&n[d];o=E.from(u?u.type.create(u.attrs,o):i.node(a).copy(o))}s.step(new ge(e,e,new O(r.append(o),t,t),!0))}function Lm(s,e){let t=s.resolve(e),n=t.index();return zh(t.nodeBefore,t.nodeAfter)&&t.parent.canReplace(n,n+1)}function zh(s,e){return!!(s&&e&&!s.isLeaf&&s.canAppend(e))}function jh(s,e,t){let n=new ge(e-t,e+t,O.empty,!0);s.step(n)}function Vh(s,e,t){let n=s.resolve(e);if(n.parent.canReplaceWith(n.index(),n.index(),t))return e;if(n.parentOffset==0)for(let i=n.depth-1;i>=0;i--){let r=n.index(i);if(n.node(i).canReplaceWith(r,r,t))return n.before(i+1);if(r>0)return null}if(n.parentOffset==n.parent.content.size)for(let i=n.depth-1;i>=0;i--){let r=n.indexAfter(i);if(n.node(i).canReplaceWith(r,r,t))return n.after(i+1);if(r<n.node(i).childCount)return null}return null}function Uh(s,e,t){let n=s.resolve(e);if(!t.content.size)return e;let i=t.content;for(let r=0;r<t.openStart;r++)i=i.firstChild.content;for(let r=1;r<=(t.openStart==0&&t.size?2:1);r++)for(let o=n.depth;o>=0;o--){let a=o==n.depth?0:n.pos<=(n.start(o+1)+n.end(o+1))/2?-1:1,l=n.index(o)+(a>0?1:0),d=n.node(o),u=!1;if(r==1)u=d.canReplace(l,l,i);else{let m=d.contentMatchAt(l).findWrapping(i.firstChild.type);u=m&&d.canReplaceWith(l,l,m[0])}if(u)return a==0?n.pos:a<0?n.before(o+1):n.after(o+1)}return null}function qh(s,e,t=e,n=O.empty){if(e==t&&!n.size)return null;let i=s.resolve(e),r=s.resolve(t);return _o(i,r,n)?new ge(e,t,n):new Wh(i,r,n).fit()}function _o(s,e,t){return!t.openStart&&!t.openEnd&&s.start()==e.start()&&s.parent.canReplace(s.index(),e.index(),t.content)}class Wh{constructor(e,t,n){this.$from=e,this.$to=t,this.unplaced=n,this.frontier=[],this.placed=E.empty;for(let i=0;i<=e.depth;i++){let r=e.node(i);this.frontier.push({type:r.type,match:r.contentMatchAt(e.indexAfter(i))})}for(let i=e.depth;i>0;i--)this.placed=E.from(e.node(i).copy(this.placed))}get depth(){return this.frontier.length-1}fit(){for(;this.unplaced.size;){let d=this.findFittable();d?this.placeNodes(d):this.openMore()||this.dropNode()}let e=this.mustMoveInline(),t=this.placed.size-this.depth-this.$from.depth,n=this.$from,i=this.close(e<0?this.$to:n.doc.resolve(e));if(!i)return null;let r=this.placed,o=n.depth,a=i.depth;for(;o&&a&&r.childCount==1;)r=r.firstChild.content,o--,a--;let l=new O(r,o,a);return e>-1?new Ue(n.pos,e,this.$to.pos,this.$to.end(),l,t):l.size||n.pos!=this.$to.pos?new ge(n.pos,i.pos,l):null}findFittable(){let e=this.unplaced.openStart;for(let t=this.unplaced.content,n=0,i=this.unplaced.openEnd;n<e;n++){let r=t.firstChild;if(t.childCount>1&&(i=0),r.type.spec.isolating&&i<=n){e=n;break}t=r.content}for(let t=1;t<=2;t++)for(let n=t==1?e:this.unplaced.openStart;n>=0;n--){let i,r=null;n?(r=ls(this.unplaced.content,n-1).firstChild,i=r.content):i=this.unplaced.content;let o=i.firstChild;for(let a=this.depth;a>=0;a--){let{type:l,match:d}=this.frontier[a],u,m=null;if(t==1&&(o?d.matchType(o.type)||(m=d.fillBefore(E.from(o),!1)):r&&l.compatibleContent(r.type)))return{sliceDepth:n,frontierDepth:a,parent:r,inject:m};if(t==2&&o&&(u=d.findWrapping(o.type)))return{sliceDepth:n,frontierDepth:a,parent:r,wrap:u};if(r&&d.matchType(r.type))break}}}openMore(){let{content:e,openStart:t,openEnd:n}=this.unplaced,i=ls(e,t);return!i.childCount||i.firstChild.isLeaf?!1:(this.unplaced=new O(e,t+1,Math.max(n,i.size+t>=e.size-n?t+1:0)),!0)}dropNode(){let{content:e,openStart:t,openEnd:n}=this.unplaced,i=ls(e,t);if(i.childCount<=1&&t>0){let r=e.size-t<=t+i.size;this.unplaced=new O(Yt(e,t-1,1),t-1,r?t-1:n)}else this.unplaced=new O(Yt(e,t,1),t,n)}placeNodes({sliceDepth:e,frontierDepth:t,parent:n,inject:i,wrap:r}){for(;this.depth>t;)this.closeFrontierNode();if(r)for(let S=0;S<r.length;S++)this.openFrontierNode(r[S]);let o=this.unplaced,a=n?n.content:o.content,l=o.openStart-e,d=0,u=[],{match:m,type:p}=this.frontier[t];if(i){for(let S=0;S<i.childCount;S++)u.push(i.child(S));m=m.matchFragment(i)}let k=a.size+e-(o.content.size-o.openEnd);for(;d<a.childCount;){let S=a.child(d),C=m.matchType(S.type);if(!C)break;d++,(d>1||l==0||S.content.size)&&(m=C,u.push(Oo(S.mark(p.allowedMarks(S.marks)),d==1?l:0,d==a.childCount?k:-1)))}let y=d==a.childCount;y||(k=-1),this.placed=Zt(this.placed,t,E.from(u)),this.frontier[t].match=m,y&&k<0&&n&&n.type==this.frontier[this.depth].type&&this.frontier.length>1&&this.closeFrontierNode();for(let S=0,C=a;S<k;S++){let N=C.lastChild;this.frontier.push({type:N.type,match:N.contentMatchAt(N.childCount)}),C=N.content}this.unplaced=y?e==0?O.empty:new O(Yt(o.content,e-1,1),e-1,k<0?o.openEnd:e-1):new O(Yt(o.content,e,d),o.openStart,o.openEnd)}mustMoveInline(){if(!this.$to.parent.isTextblock)return-1;let e=this.frontier[this.depth],t;if(!e.type.isTextblock||!cs(this.$to,this.$to.depth,e.type,e.match,!1)||this.$to.depth==this.depth&&(t=this.findCloseLevel(this.$to))&&t.depth==this.depth)return-1;let{depth:n}=this.$to,i=this.$to.after(n);for(;n>1&&i==this.$to.end(--n);)++i;return i}findCloseLevel(e){e:for(let t=Math.min(this.depth,e.depth);t>=0;t--){let{match:n,type:i}=this.frontier[t],r=t<e.depth&&e.end(t+1)==e.pos+(e.depth-(t+1)),o=cs(e,t,i,n,r);if(o){for(let a=t-1;a>=0;a--){let{match:l,type:d}=this.frontier[a],u=cs(e,a,d,l,!0);if(!u||u.childCount)continue e}return{depth:t,fit:o,move:r?e.doc.resolve(e.after(t+1)):e}}}}close(e){let t=this.findCloseLevel(e);if(!t)return null;for(;this.depth>t.depth;)this.closeFrontierNode();t.fit.childCount&&(this.placed=Zt(this.placed,t.depth,t.fit)),e=t.move;for(let n=t.depth+1;n<=e.depth;n++){let i=e.node(n),r=i.type.contentMatch.fillBefore(i.content,!0,e.index(n));this.openFrontierNode(i.type,i.attrs,r)}return e}openFrontierNode(e,t=null,n){let i=this.frontier[this.depth];i.match=i.match.matchType(e),this.placed=Zt(this.placed,this.depth,E.from(e.create(t,n))),this.frontier.push({type:e,match:e.contentMatch})}closeFrontierNode(){let t=this.frontier.pop().match.fillBefore(E.empty,!0);t.childCount&&(this.placed=Zt(this.placed,this.frontier.length,t))}}function Yt(s,e,t){return e==0?s.cutByIndex(t,s.childCount):s.replaceChild(0,s.firstChild.copy(Yt(s.firstChild.content,e-1,t)))}function Zt(s,e,t){return e==0?s.append(t):s.replaceChild(s.childCount-1,s.lastChild.copy(Zt(s.lastChild.content,e-1,t)))}function ls(s,e){for(let t=0;t<e;t++)s=s.firstChild.content;return s}function Oo(s,e,t){if(e<=0)return s;let n=s.content;return e>1&&(n=n.replaceChild(0,Oo(n.firstChild,e-1,n.childCount==1?t-1:0))),e>0&&(n=s.type.contentMatch.fillBefore(n).append(n),t<=0&&(n=n.append(s.type.contentMatch.matchFragment(n).fillBefore(E.empty,!0)))),s.copy(n)}function cs(s,e,t,n,i){let r=s.node(e),o=i?s.indexAfter(e):s.index(e);if(o==r.childCount&&!t.compatibleContent(r.type))return null;let a=n.fillBefore(r.content,!0,o);return a&&!Jh(t,r.content,o)?a:null}function Jh(s,e,t){for(let n=t;n<e.childCount;n++)if(!s.allowsMarks(e.child(n).marks))return!0;return!1}function Hh(s){return s.spec.defining||s.spec.definingForContent}function $h(s,e,t,n){if(!n.size)return s.deleteRange(e,t);let i=s.doc.resolve(e),r=s.doc.resolve(t);if(_o(i,r,n))return s.step(new ge(e,t,n));let o=Ro(i,s.doc.resolve(t));o[o.length-1]==0&&o.pop();let a=-(i.depth+1);o.unshift(a);for(let p=i.depth,k=i.pos-1;p>0;p--,k--){let y=i.node(p).type.spec;if(y.defining||y.definingAsContext||y.isolating)break;o.indexOf(p)>-1?a=p:i.before(p)==k&&o.splice(1,0,-p)}let l=o.indexOf(a),d=[],u=n.openStart;for(let p=n.content,k=0;;k++){let y=p.firstChild;if(d.push(y),k==n.openStart)break;p=y.content}for(let p=u-1;p>=0;p--){let k=d[p],y=Hh(k.type);if(y&&!k.sameMarkup(i.node(Math.abs(a)-1)))u=p;else if(y||!k.type.isTextblock)break}for(let p=n.openStart;p>=0;p--){let k=(p+u+1)%(n.openStart+1),y=d[k];if(y)for(let S=0;S<o.length;S++){let C=o[(S+l)%o.length],N=!0;C<0&&(N=!1,C=-C);let P=i.node(C-1),W=i.index(C-1);if(P.canReplaceWith(W,W,y.type,y.marks))return s.replace(i.before(C),N?r.after(C):t,new O(Do(n.content,0,n.openStart,k),k,n.openEnd))}}let m=s.steps.length;for(let p=o.length-1;p>=0&&(s.replace(e,t,n),!(s.steps.length>m));p--){let k=o[p];k<0||(e=i.before(k),t=r.after(k))}}function Do(s,e,t,n,i){if(e<t){let r=s.firstChild;s=s.replaceChild(0,r.copy(Do(r.content,e+1,t,n,r)))}if(e>n){let r=i.contentMatchAt(0),o=r.fillBefore(s).append(s);s=o.append(r.matchFragment(o).fillBefore(E.empty,!0))}return s}function Gh(s,e,t,n){if(!n.isInline&&e==t&&s.doc.resolve(e).parent.content.size){let i=Vh(s.doc,e,n.type);i!=null&&(e=t=i)}s.replaceRange(e,t,new O(E.from(n),0,0))}function Kh(s,e,t){let n=s.doc.resolve(e),i=s.doc.resolve(t),r=Ro(n,i);for(let o=0;o<r.length;o++){let a=r[o],l=o==r.length-1;if(l&&a==0||n.node(a).type.contentMatch.validEnd)return s.delete(n.start(a),i.end(a));if(a>0&&(l||n.node(a-1).canReplace(n.index(a-1),i.indexAfter(a-1))))return s.delete(n.before(a),i.after(a))}for(let o=1;o<=n.depth&&o<=i.depth;o++)if(e-n.start(o)==n.depth-o&&t>n.end(o)&&i.end(o)-t!=i.depth-o)return s.delete(n.before(o),t);s.delete(e,t)}function Ro(s,e){let t=[],n=Math.min(s.depth,e.depth);for(let i=n;i>=0;i--){let r=s.start(i);if(r<s.pos-(s.depth-i)||e.end(i)>e.pos+(e.depth-i)||s.node(i).type.spec.isolating||e.node(i).type.spec.isolating)break;(r==e.start(i)||i==s.depth&&i==e.depth&&s.parent.inlineContent&&e.parent.inlineContent&&i&&e.start(i-1)==r-1)&&t.push(i)}return t}class Vt extends ke{constructor(e,t,n){super(),this.pos=e,this.attr=t,this.value=n}apply(e){let t=e.nodeAt(this.pos);if(!t)return ae.fail("No node at attribute step's position");let n=Object.create(null);for(let r in t.attrs)n[r]=t.attrs[r];n[this.attr]=this.value;let i=t.type.create(n,null,t.marks);return ae.fromReplace(e,this.pos,this.pos+1,new O(E.from(i),0,t.isLeaf?0:1))}getMap(){return De.empty}invert(e){return new Vt(this.pos,this.attr,e.nodeAt(this.pos).attrs[this.attr])}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new Vt(t.pos,this.attr,this.value)}toJSON(){return{stepType:"attr",pos:this.pos,attr:this.attr,value:this.value}}static fromJSON(e,t){if(typeof t.pos!="number"||typeof t.attr!="string")throw new RangeError("Invalid input for AttrStep.fromJSON");return new Vt(t.pos,t.attr,t.value)}}ke.jsonID("attr",Vt);class hn extends ke{constructor(e,t){super(),this.attr=e,this.value=t}apply(e){let t=Object.create(null);for(let i in e.attrs)t[i]=e.attrs[i];t[this.attr]=this.value;let n=e.type.create(t,e.content,e.marks);return ae.ok(n)}getMap(){return De.empty}invert(e){return new hn(this.attr,e.attrs[this.attr])}map(e){return this}toJSON(){return{stepType:"docAttr",attr:this.attr,value:this.value}}static fromJSON(e,t){if(typeof t.attr!="string")throw new RangeError("Invalid input for DocAttrStep.fromJSON");return new hn(t.attr,t.value)}}ke.jsonID("docAttr",hn);let Ht=class extends Error{};Ht=function s(e){let t=Error.call(this,e);return t.__proto__=s.prototype,t};Ht.prototype=Object.create(Error.prototype);Ht.prototype.constructor=Ht;Ht.prototype.name="TransformError";class Yh{constructor(e){this.doc=e,this.steps=[],this.docs=[],this.mapping=new rn}get before(){return this.docs.length?this.docs[0]:this.doc}step(e){let t=this.maybeStep(e);if(t.failed)throw new Ht(t.failed);return this}maybeStep(e){let t=e.apply(this.doc);return t.failed||this.addStep(e,t.doc),t}get docChanged(){return this.steps.length>0}addStep(e,t){this.docs.push(this.doc),this.steps.push(e),this.mapping.appendMap(e.getMap()),this.doc=t}replace(e,t=e,n=O.empty){let i=qh(this.doc,e,t,n);return i&&this.step(i),this}replaceWith(e,t,n){return this.replace(e,t,new O(E.from(n),0,0))}delete(e,t){return this.replace(e,t,O.empty)}insert(e,t){return this.replaceWith(e,e,t)}replaceRange(e,t,n){return $h(this,e,t,n),this}replaceRangeWith(e,t,n){return Gh(this,e,t,n),this}deleteRange(e,t){return Kh(this,e,t),this}lift(e,t){return _h(this,e,t),this}join(e,t=1){return jh(this,e,t),this}wrap(e,t){return Rh(this,e,t),this}setBlockType(e,t=e,n,i=null){return Ah(this,e,t,n,i),this}setNodeMarkup(e,t,n=null,i){return Ph(this,e,t,n,i),this}setNodeAttribute(e,t,n){return this.step(new Vt(e,t,n)),this}setDocAttribute(e,t){return this.step(new hn(e,t)),this}addNodeMark(e,t){return this.step(new pt(e,t)),this}removeNodeMark(e,t){if(!(t instanceof J)){let n=this.doc.nodeAt(e);if(!n)throw new RangeError("No node at position "+e);if(t=t.isInSet(n.marks),!t)return this}return this.step(new Jt(e,t)),this}split(e,t=1,n){return Lh(this,e,t,n),this}addMark(e,t,n){return Eh(this,e,t,n),this}removeMark(e,t,n){return Ih(this,e,t,n),this}clearIncompatible(e,t,n){return No(this,e,t,n),this}}const ds=Object.create(null);class Y{constructor(e,t,n){this.$anchor=e,this.$head=t,this.ranges=n||[new Zh(e.min(t),e.max(t))]}get anchor(){return this.$anchor.pos}get head(){return this.$head.pos}get from(){return this.$from.pos}get to(){return this.$to.pos}get $from(){return this.ranges[0].$from}get $to(){return this.ranges[0].$to}get empty(){let e=this.ranges;for(let t=0;t<e.length;t++)if(e[t].$from.pos!=e[t].$to.pos)return!1;return!0}content(){return this.$from.doc.slice(this.from,this.to,!0)}replace(e,t=O.empty){let n=t.content.lastChild,i=null;for(let a=0;a<t.openEnd;a++)i=n,n=n.lastChild;let r=e.steps.length,o=this.ranges;for(let a=0;a<o.length;a++){let{$from:l,$to:d}=o[a],u=e.mapping.slice(r);e.replaceRange(u.map(l.pos),u.map(d.pos),a?O.empty:t),a==0&&Ui(e,r,(n?n.isInline:i&&i.isTextblock)?-1:1)}}replaceWith(e,t){let n=e.steps.length,i=this.ranges;for(let r=0;r<i.length;r++){let{$from:o,$to:a}=i[r],l=e.mapping.slice(n),d=l.map(o.pos),u=l.map(a.pos);r?e.deleteRange(d,u):(e.replaceRangeWith(d,u,t),Ui(e,n,t.isInline?-1:1))}}static findFrom(e,t,n=!1){let i=e.parent.inlineContent?new X(e):zt(e.node(0),e.parent,e.pos,e.index(),t,n);if(i)return i;for(let r=e.depth-1;r>=0;r--){let o=t<0?zt(e.node(0),e.node(r),e.before(r+1),e.index(r),t,n):zt(e.node(0),e.node(r),e.after(r+1),e.index(r)+1,t,n);if(o)return o}return null}static near(e,t=1){return this.findFrom(e,t)||this.findFrom(e,-t)||new Ye(e.node(0))}static atStart(e){return zt(e,e,0,0,1)||new Ye(e)}static atEnd(e){return zt(e,e,e.content.size,e.childCount,-1)||new Ye(e)}static fromJSON(e,t){if(!t||!t.type)throw new RangeError("Invalid input for Selection.fromJSON");let n=ds[t.type];if(!n)throw new RangeError(`No selection type ${t.type} defined`);return n.fromJSON(e,t)}static jsonID(e,t){if(e in ds)throw new RangeError("Duplicate use of selection JSON ID "+e);return ds[e]=t,t.prototype.jsonID=e,t}getBookmark(){return X.between(this.$anchor,this.$head).getBookmark()}}Y.prototype.visible=!0;class Zh{constructor(e,t){this.$from=e,this.$to=t}}let ji=!1;function Vi(s){!ji&&!s.parent.inlineContent&&(ji=!0,console.warn("TextSelection endpoint not pointing into a node with inline content ("+s.parent.type.name+")"))}class X extends Y{constructor(e,t=e){Vi(e),Vi(t),super(e,t)}get $cursor(){return this.$anchor.pos==this.$head.pos?this.$head:null}map(e,t){let n=e.resolve(t.map(this.head));if(!n.parent.inlineContent)return Y.near(n);let i=e.resolve(t.map(this.anchor));return new X(i.parent.inlineContent?i:n,n)}replace(e,t=O.empty){if(super.replace(e,t),t==O.empty){let n=this.$from.marksAcross(this.$to);n&&e.ensureMarks(n)}}eq(e){return e instanceof X&&e.anchor==this.anchor&&e.head==this.head}getBookmark(){return new Kn(this.anchor,this.head)}toJSON(){return{type:"text",anchor:this.anchor,head:this.head}}static fromJSON(e,t){if(typeof t.anchor!="number"||typeof t.head!="number")throw new RangeError("Invalid input for TextSelection.fromJSON");return new X(e.resolve(t.anchor),e.resolve(t.head))}static create(e,t,n=t){let i=e.resolve(t);return new this(i,n==t?i:e.resolve(n))}static between(e,t,n){let i=e.pos-t.pos;if((!n||i)&&(n=i>=0?1:-1),!t.parent.inlineContent){let r=Y.findFrom(t,n,!0)||Y.findFrom(t,-n,!0);if(r)t=r.$head;else return Y.near(t,n)}return e.parent.inlineContent||(i==0?e=t:(e=(Y.findFrom(e,-n,!0)||Y.findFrom(e,n,!0)).$anchor,e.pos<t.pos!=i<0&&(e=t))),new X(e,t)}}Y.jsonID("text",X);class Kn{constructor(e,t){this.anchor=e,this.head=t}map(e){return new Kn(e.map(this.anchor),e.map(this.head))}resolve(e){return X.between(e.resolve(this.anchor),e.resolve(this.head))}}class q extends Y{constructor(e){let t=e.nodeAfter,n=e.node(0).resolve(e.pos+t.nodeSize);super(e,n),this.node=t}map(e,t){let{deleted:n,pos:i}=t.mapResult(this.anchor),r=e.resolve(i);return n?Y.near(r):new q(r)}content(){return new O(E.from(this.node),0,0)}eq(e){return e instanceof q&&e.anchor==this.anchor}toJSON(){return{type:"node",anchor:this.anchor}}getBookmark(){return new ti(this.anchor)}static fromJSON(e,t){if(typeof t.anchor!="number")throw new RangeError("Invalid input for NodeSelection.fromJSON");return new q(e.resolve(t.anchor))}static create(e,t){return new q(e.resolve(t))}static isSelectable(e){return!e.isText&&e.type.spec.selectable!==!1}}q.prototype.visible=!1;Y.jsonID("node",q);class ti{constructor(e){this.anchor=e}map(e){let{deleted:t,pos:n}=e.mapResult(this.anchor);return t?new Kn(n,n):new ti(n)}resolve(e){let t=e.resolve(this.anchor),n=t.nodeAfter;return n&&q.isSelectable(n)?new q(t):Y.near(t)}}class Ye extends Y{constructor(e){super(e.resolve(0),e.resolve(e.content.size))}replace(e,t=O.empty){if(t==O.empty){e.delete(0,e.doc.content.size);let n=Y.atStart(e.doc);n.eq(e.selection)||e.setSelection(n)}else super.replace(e,t)}toJSON(){return{type:"all"}}static fromJSON(e){return new Ye(e)}map(e){return new Ye(e)}eq(e){return e instanceof Ye}getBookmark(){return Qh}}Y.jsonID("all",Ye);const Qh={map(){return this},resolve(s){return new Ye(s)}};function zt(s,e,t,n,i,r=!1){if(e.inlineContent)return X.create(s,t);for(let o=n-(i>0?0:1);i>0?o<e.childCount:o>=0;o+=i){let a=e.child(o);if(a.isAtom){if(!r&&q.isSelectable(a))return q.create(s,t-(i<0?a.nodeSize:0))}else{let l=zt(s,a,t+i,i<0?a.childCount:0,i,r);if(l)return l}t+=a.nodeSize*i}return null}function Ui(s,e,t){let n=s.steps.length-1;if(n<e)return;let i=s.steps[n];if(!(i instanceof ge||i instanceof Ue))return;let r=s.mapping.maps[n],o;r.forEach((a,l,d,u)=>{o==null&&(o=u)}),s.setSelection(Y.near(s.doc.resolve(o),t))}const qi=1,Mn=2,Wi=4;class Xh extends Yh{constructor(e){super(e.doc),this.curSelectionFor=0,this.updated=0,this.meta=Object.create(null),this.time=Date.now(),this.curSelection=e.selection,this.storedMarks=e.storedMarks}get selection(){return this.curSelectionFor<this.steps.length&&(this.curSelection=this.curSelection.map(this.doc,this.mapping.slice(this.curSelectionFor)),this.curSelectionFor=this.steps.length),this.curSelection}setSelection(e){if(e.$from.doc!=this.doc)throw new RangeError("Selection passed to setSelection must point at the current document");return this.curSelection=e,this.curSelectionFor=this.steps.length,this.updated=(this.updated|qi)&~Mn,this.storedMarks=null,this}get selectionSet(){return(this.updated&qi)>0}setStoredMarks(e){return this.storedMarks=e,this.updated|=Mn,this}ensureMarks(e){return J.sameSet(this.storedMarks||this.selection.$from.marks(),e)||this.setStoredMarks(e),this}addStoredMark(e){return this.ensureMarks(e.addToSet(this.storedMarks||this.selection.$head.marks()))}removeStoredMark(e){return this.ensureMarks(e.removeFromSet(this.storedMarks||this.selection.$head.marks()))}get storedMarksSet(){return(this.updated&Mn)>0}addStep(e,t){super.addStep(e,t),this.updated=this.updated&~Mn,this.storedMarks=null}setTime(e){return this.time=e,this}replaceSelection(e){return this.selection.replace(this,e),this}replaceSelectionWith(e,t=!0){let n=this.selection;return t&&(e=e.mark(this.storedMarks||(n.empty?n.$from.marks():n.$from.marksAcross(n.$to)||J.none))),n.replaceWith(this,e),this}deleteSelection(){return this.selection.replace(this),this}insertText(e,t,n){let i=this.doc.type.schema;if(t==null)return e?this.replaceSelectionWith(i.text(e),!0):this.deleteSelection();{if(n==null&&(n=t),n=n??t,!e)return this.deleteRange(t,n);let r=this.storedMarks;if(!r){let o=this.doc.resolve(t);r=n==t?o.marks():o.marksAcross(this.doc.resolve(n))}return this.replaceRangeWith(t,n,i.text(e,r)),this.selection.empty||this.setSelection(Y.near(this.selection.$to)),this}}setMeta(e,t){return this.meta[typeof e=="string"?e:e.key]=t,this}getMeta(e){return this.meta[typeof e=="string"?e:e.key]}get isGeneric(){for(let e in this.meta)return!1;return!0}scrollIntoView(){return this.updated|=Wi,this}get scrolledIntoView(){return(this.updated&Wi)>0}}function Ji(s,e){return!e||!s?s:s.bind(e)}class Qt{constructor(e,t,n){this.name=e,this.init=Ji(t.init,n),this.apply=Ji(t.apply,n)}}const eu=[new Qt("doc",{init(s){return s.doc||s.schema.topNodeType.createAndFill()},apply(s){return s.doc}}),new Qt("selection",{init(s,e){return s.selection||Y.atStart(e.doc)},apply(s){return s.selection}}),new Qt("storedMarks",{init(s){return s.storedMarks||null},apply(s,e,t,n){return n.selection.$cursor?s.storedMarks:null}}),new Qt("scrollToSelection",{init(){return 0},apply(s,e){return s.scrolledIntoView?e+1:e}})];class hs{constructor(e,t){this.schema=e,this.plugins=[],this.pluginsByKey=Object.create(null),this.fields=eu.slice(),t&&t.forEach(n=>{if(this.pluginsByKey[n.key])throw new RangeError("Adding different instances of a keyed plugin ("+n.key+")");this.plugins.push(n),this.pluginsByKey[n.key]=n,n.spec.state&&this.fields.push(new Qt(n.key,n.spec.state,n))})}}class Xt{constructor(e){this.config=e}get schema(){return this.config.schema}get plugins(){return this.config.plugins}apply(e){return this.applyTransaction(e).state}filterTransaction(e,t=-1){for(let n=0;n<this.config.plugins.length;n++)if(n!=t){let i=this.config.plugins[n];if(i.spec.filterTransaction&&!i.spec.filterTransaction.call(i,e,this))return!1}return!0}applyTransaction(e){if(!this.filterTransaction(e))return{state:this,transactions:[]};let t=[e],n=this.applyInner(e),i=null;for(;;){let r=!1;for(let o=0;o<this.config.plugins.length;o++){let a=this.config.plugins[o];if(a.spec.appendTransaction){let l=i?i[o].n:0,d=i?i[o].state:this,u=l<t.length&&a.spec.appendTransaction.call(a,l?t.slice(l):t,d,n);if(u&&n.filterTransaction(u,o)){if(u.setMeta("appendedTransaction",e),!i){i=[];for(let m=0;m<this.config.plugins.length;m++)i.push(m<o?{state:n,n:t.length}:{state:this,n:0})}t.push(u),n=n.applyInner(u),r=!0}i&&(i[o]={state:n,n:t.length})}}if(!r)return{state:n,transactions:t}}}applyInner(e){if(!e.before.eq(this.doc))throw new RangeError("Applying a mismatched transaction");let t=new Xt(this.config),n=this.config.fields;for(let i=0;i<n.length;i++){let r=n[i];t[r.name]=r.apply(e,this[r.name],this,t)}return t}get tr(){return new Xh(this)}static create(e){let t=new hs(e.doc?e.doc.type.schema:e.schema,e.plugins),n=new Xt(t);for(let i=0;i<t.fields.length;i++)n[t.fields[i].name]=t.fields[i].init(e,n);return n}reconfigure(e){let t=new hs(this.schema,e.plugins),n=t.fields,i=new Xt(t);for(let r=0;r<n.length;r++){let o=n[r].name;i[o]=this.hasOwnProperty(o)?this[o]:n[r].init(e,i)}return i}toJSON(e){let t={doc:this.doc.toJSON(),selection:this.selection.toJSON()};if(this.storedMarks&&(t.storedMarks=this.storedMarks.map(n=>n.toJSON())),e&&typeof e=="object")for(let n in e){if(n=="doc"||n=="selection")throw new RangeError("The JSON fields `doc` and `selection` are reserved");let i=e[n],r=i.spec.state;r&&r.toJSON&&(t[n]=r.toJSON.call(i,this[i.key]))}return t}static fromJSON(e,t,n){if(!t)throw new RangeError("Invalid input for EditorState.fromJSON");if(!e.schema)throw new RangeError("Required config field 'schema' missing");let i=new hs(e.schema,e.plugins),r=new Xt(i);return i.fields.forEach(o=>{if(o.name=="doc")r.doc=Ke.fromJSON(e.schema,t.doc);else if(o.name=="selection")r.selection=Y.fromJSON(r.doc,t.selection);else if(o.name=="storedMarks")t.storedMarks&&(r.storedMarks=t.storedMarks.map(e.schema.markFromJSON));else{if(n)for(let a in n){let l=n[a],d=l.spec.state;if(l.key==o.name&&d&&d.fromJSON&&Object.prototype.hasOwnProperty.call(t,a)){r[o.name]=d.fromJSON.call(l,e,t[a],r);return}}r[o.name]=o.init(e,r)}}),r}}function Ao(s,e,t){for(let n in s){let i=s[n];i instanceof Function?i=i.bind(e):n=="handleDOMEvents"&&(i=Ao(i,e,{})),t[n]=i}return t}class zm{constructor(e){this.spec=e,this.props={},e.props&&Ao(e.props,this,this.props),this.key=e.key?e.key.key:vo("plugin")}getState(e){return e[this.key]}}const us=Object.create(null);function vo(s){return s in us?s+"$"+ ++us[s]:(us[s]=0,s+"$")}class jm{constructor(e="key"){this.key=vo(e)}get(e){return e.config.pluginsByKey[this.key]}getState(e){return e[this.key]}}const ue=function(s){for(var e=0;;e++)if(s=s.previousSibling,!s)return e},un=function(s){let e=s.assignedSlot||s.parentNode;return e&&e.nodeType==11?e.host:e};let Os=null;const tt=function(s,e,t){let n=Os||(Os=document.createRange());return n.setEnd(s,t??s.nodeValue.length),n.setStart(s,e||0),n},tu=function(){Os=null},Rt=function(s,e,t,n){return t&&(Hi(s,e,t,n,-1)||Hi(s,e,t,n,1))},nu=/^(img|br|input|textarea|hr)$/i;function Hi(s,e,t,n,i){for(;;){if(s==t&&e==n)return!0;if(e==(i<0?0:$e(s))){let r=s.parentNode;if(!r||r.nodeType!=1||yn(s)||nu.test(s.nodeName)||s.contentEditable=="false")return!1;e=ue(s)+(i<0?0:1),s=r}else if(s.nodeType==1){if(s=s.childNodes[e+(i<0?-1:0)],s.contentEditable=="false")return!1;e=i<0?$e(s):0}else return!1}}function $e(s){return s.nodeType==3?s.nodeValue.length:s.childNodes.length}function su(s,e){for(;;){if(s.nodeType==3&&e)return s;if(s.nodeType==1&&e>0){if(s.contentEditable=="false")return null;s=s.childNodes[e-1],e=$e(s)}else if(s.parentNode&&!yn(s))e=ue(s),s=s.parentNode;else return null}}function iu(s,e){for(;;){if(s.nodeType==3&&e<s.nodeValue.length)return s;if(s.nodeType==1&&e<s.childNodes.length){if(s.contentEditable=="false")return null;s=s.childNodes[e],e=0}else if(s.parentNode&&!yn(s))e=ue(s)+1,s=s.parentNode;else return null}}function ru(s,e,t){for(let n=e==0,i=e==$e(s);n||i;){if(s==t)return!0;let r=ue(s);if(s=s.parentNode,!s)return!1;n=n&&r==0,i=i&&r==$e(s)}}function yn(s){let e;for(let t=s;t&&!(e=t.pmViewDesc);t=t.parentNode);return e&&e.node&&e.node.isBlock&&(e.dom==s||e.contentDOM==s)}const Yn=function(s){return s.focusNode&&Rt(s.focusNode,s.focusOffset,s.anchorNode,s.anchorOffset)};function Tt(s,e){let t=document.createEvent("Event");return t.initEvent("keydown",!0,!0),t.keyCode=s,t.key=t.code=e,t}function ou(s){let e=s.activeElement;for(;e&&e.shadowRoot;)e=e.shadowRoot.activeElement;return e}function au(s,e,t){if(s.caretPositionFromPoint)try{let n=s.caretPositionFromPoint(e,t);if(n)return{node:n.offsetNode,offset:n.offset}}catch{}if(s.caretRangeFromPoint){let n=s.caretRangeFromPoint(e,t);if(n)return{node:n.startContainer,offset:n.startOffset}}}const Ze=typeof navigator<"u"?navigator:null,$i=typeof document<"u"?document:null,St=Ze&&Ze.userAgent||"",Ds=/Edge\/(\d+)/.exec(St),Bo=/MSIE \d/.exec(St),Rs=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(St),Ie=!!(Bo||Rs||Ds),yt=Bo?document.documentMode:Rs?+Rs[1]:Ds?+Ds[1]:0,qe=!Ie&&/gecko\/(\d+)/i.test(St);qe&&+(/Firefox\/(\d+)/.exec(St)||[0,0])[1];const As=!Ie&&/Chrome\/(\d+)/.exec(St),ye=!!As,Fo=As?+As[1]:0,we=!Ie&&!!Ze&&/Apple Computer/.test(Ze.vendor),$t=we&&(/Mobile\/\w+/.test(St)||!!Ze&&Ze.maxTouchPoints>2),ve=$t||(Ze?/Mac/.test(Ze.platform):!1),lu=Ze?/Win/.test(Ze.platform):!1,ze=/Android \d/.test(St),xn=!!$i&&"webkitFontSmoothing"in $i.documentElement.style,cu=xn?+(/\bAppleWebKit\/(\d+)/.exec(navigator.userAgent)||[0,0])[1]:0;function du(s){let e=s.defaultView&&s.defaultView.visualViewport;return e?{left:0,right:e.width,top:0,bottom:e.height}:{left:0,right:s.documentElement.clientWidth,top:0,bottom:s.documentElement.clientHeight}}function et(s,e){return typeof s=="number"?s:s[e]}function hu(s){let e=s.getBoundingClientRect(),t=e.width/s.offsetWidth||1,n=e.height/s.offsetHeight||1;return{left:e.left,right:e.left+s.clientWidth*t,top:e.top,bottom:e.top+s.clientHeight*n}}function Gi(s,e,t){let n=s.someProp("scrollThreshold")||0,i=s.someProp("scrollMargin")||5,r=s.dom.ownerDocument;for(let o=t||s.dom;o;o=un(o)){if(o.nodeType!=1)continue;let a=o,l=a==r.body,d=l?du(r):hu(a),u=0,m=0;if(e.top<d.top+et(n,"top")?m=-(d.top-e.top+et(i,"top")):e.bottom>d.bottom-et(n,"bottom")&&(m=e.bottom-e.top>d.bottom-d.top?e.top+et(i,"top")-d.top:e.bottom-d.bottom+et(i,"bottom")),e.left<d.left+et(n,"left")?u=-(d.left-e.left+et(i,"left")):e.right>d.right-et(n,"right")&&(u=e.right-d.right+et(i,"right")),u||m)if(l)r.defaultView.scrollBy(u,m);else{let p=a.scrollLeft,k=a.scrollTop;m&&(a.scrollTop+=m),u&&(a.scrollLeft+=u);let y=a.scrollLeft-p,S=a.scrollTop-k;e={left:e.left-y,top:e.top-S,right:e.right-y,bottom:e.bottom-S}}if(l||/^(fixed|sticky)$/.test(getComputedStyle(o).position))break}}function uu(s){let e=s.dom.getBoundingClientRect(),t=Math.max(0,e.top),n,i;for(let r=(e.left+e.right)/2,o=t+1;o<Math.min(innerHeight,e.bottom);o+=5){let a=s.root.elementFromPoint(r,o);if(!a||a==s.dom||!s.dom.contains(a))continue;let l=a.getBoundingClientRect();if(l.top>=t-20){n=a,i=l.top;break}}return{refDOM:n,refTop:i,stack:Po(s.dom)}}function Po(s){let e=[],t=s.ownerDocument;for(let n=s;n&&(e.push({dom:n,top:n.scrollTop,left:n.scrollLeft}),s!=t);n=un(n));return e}function fu({refDOM:s,refTop:e,stack:t}){let n=s?s.getBoundingClientRect().top:0;Lo(t,n==0?0:n-e)}function Lo(s,e){for(let t=0;t<s.length;t++){let{dom:n,top:i,left:r}=s[t];n.scrollTop!=i+e&&(n.scrollTop=i+e),n.scrollLeft!=r&&(n.scrollLeft=r)}}let Bt=null;function pu(s){if(s.setActive)return s.setActive();if(Bt)return s.focus(Bt);let e=Po(s);s.focus(Bt==null?{get preventScroll(){return Bt={preventScroll:!0},!0}}:void 0),Bt||(Bt=!1,Lo(e,0))}function zo(s,e){let t,n=2e8,i,r=0,o=e.top,a=e.top,l,d;for(let u=s.firstChild,m=0;u;u=u.nextSibling,m++){let p;if(u.nodeType==1)p=u.getClientRects();else if(u.nodeType==3)p=tt(u).getClientRects();else continue;for(let k=0;k<p.length;k++){let y=p[k];if(y.top<=o&&y.bottom>=a){o=Math.max(y.bottom,o),a=Math.min(y.top,a);let S=y.left>e.left?y.left-e.left:y.right<e.left?e.left-y.right:0;if(S<n){t=u,n=S,i=S&&t.nodeType==3?{left:y.right<e.left?y.right:y.left,top:e.top}:e,u.nodeType==1&&S&&(r=m+(e.left>=(y.left+y.right)/2?1:0));continue}}else y.top>e.top&&!l&&y.left<=e.left&&y.right>=e.left&&(l=u,d={left:Math.max(y.left,Math.min(y.right,e.left)),top:y.top});!t&&(e.left>=y.right&&e.top>=y.top||e.left>=y.left&&e.top>=y.bottom)&&(r=m+1)}}return!t&&l&&(t=l,i=d,n=0),t&&t.nodeType==3?mu(t,i):!t||n&&t.nodeType==1?{node:s,offset:r}:zo(t,i)}function mu(s,e){let t=s.nodeValue.length,n=document.createRange();for(let i=0;i<t;i++){n.setEnd(s,i+1),n.setStart(s,i);let r=ct(n,1);if(r.top!=r.bottom&&ni(e,r))return{node:s,offset:i+(e.left>=(r.left+r.right)/2?1:0)}}return{node:s,offset:0}}function ni(s,e){return s.left>=e.left-1&&s.left<=e.right+1&&s.top>=e.top-1&&s.top<=e.bottom+1}function gu(s,e){let t=s.parentNode;return t&&/^li$/i.test(t.nodeName)&&e.left<s.getBoundingClientRect().left?t:s}function yu(s,e,t){let{node:n,offset:i}=zo(e,t),r=-1;if(n.nodeType==1&&!n.firstChild){let o=n.getBoundingClientRect();r=o.left!=o.right&&t.left>(o.left+o.right)/2?1:-1}return s.docView.posFromDOM(n,i,r)}function xu(s,e,t,n){let i=-1;for(let r=e,o=!1;r!=s.dom;){let a=s.docView.nearestDesc(r,!0);if(!a)return null;if(a.dom.nodeType==1&&(a.node.isBlock&&a.parent||!a.contentDOM)){let l=a.dom.getBoundingClientRect();if(a.node.isBlock&&a.parent&&(!o&&l.left>n.left||l.top>n.top?i=a.posBefore:(!o&&l.right<n.left||l.bottom<n.top)&&(i=a.posAfter),o=!0),!a.contentDOM&&i<0&&!a.node.isText)return(a.node.isBlock?n.top<(l.top+l.bottom)/2:n.left<(l.left+l.right)/2)?a.posBefore:a.posAfter}r=a.dom.parentNode}return i>-1?i:s.docView.posFromDOM(e,t,-1)}function jo(s,e,t){let n=s.childNodes.length;if(n&&t.top<t.bottom)for(let i=Math.max(0,Math.min(n-1,Math.floor(n*(e.top-t.top)/(t.bottom-t.top))-2)),r=i;;){let o=s.childNodes[r];if(o.nodeType==1){let a=o.getClientRects();for(let l=0;l<a.length;l++){let d=a[l];if(ni(e,d))return jo(o,e,d)}}if((r=(r+1)%n)==i)break}return s}function ku(s,e){let t=s.dom.ownerDocument,n,i=0,r=au(t,e.left,e.top);r&&({node:n,offset:i}=r);let o=(s.root.elementFromPoint?s.root:t).elementFromPoint(e.left,e.top),a;if(!o||!s.dom.contains(o.nodeType!=1?o.parentNode:o)){let d=s.dom.getBoundingClientRect();if(!ni(e,d)||(o=jo(s.dom,e,d),!o))return null}if(we)for(let d=o;n&&d;d=un(d))d.draggable&&(n=void 0);if(o=gu(o,e),n){if(qe&&n.nodeType==1&&(i=Math.min(i,n.childNodes.length),i<n.childNodes.length)){let u=n.childNodes[i],m;u.nodeName=="IMG"&&(m=u.getBoundingClientRect()).right<=e.left&&m.bottom>e.top&&i++}let d;xn&&i&&n.nodeType==1&&(d=n.childNodes[i-1]).nodeType==1&&d.contentEditable=="false"&&d.getBoundingClientRect().top>=e.top&&i--,n==s.dom&&i==n.childNodes.length-1&&n.lastChild.nodeType==1&&e.top>n.lastChild.getBoundingClientRect().bottom?a=s.state.doc.content.size:(i==0||n.nodeType!=1||n.childNodes[i-1].nodeName!="BR")&&(a=xu(s,n,i,e))}a==null&&(a=yu(s,o,e));let l=s.docView.nearestDesc(o,!0);return{pos:a,inside:l?l.posAtStart-l.border:-1}}function Ki(s){return s.top<s.bottom||s.left<s.right}function ct(s,e){let t=s.getClientRects();if(t.length){let n=t[e<0?0:t.length-1];if(Ki(n))return n}return Array.prototype.find.call(t,Ki)||s.getBoundingClientRect()}const bu=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/;function Vo(s,e,t){let{node:n,offset:i,atom:r}=s.docView.domFromPos(e,t<0?-1:1),o=xn||qe;if(n.nodeType==3)if(o&&(bu.test(n.nodeValue)||(t<0?!i:i==n.nodeValue.length))){let l=ct(tt(n,i,i),t);if(qe&&i&&/\s/.test(n.nodeValue[i-1])&&i<n.nodeValue.length){let d=ct(tt(n,i-1,i-1),-1);if(d.top==l.top){let u=ct(tt(n,i,i+1),-1);if(u.top!=l.top)return Kt(u,u.left<d.left)}}return l}else{let l=i,d=i,u=t<0?1:-1;return t<0&&!i?(d++,u=-1):t>=0&&i==n.nodeValue.length?(l--,u=1):t<0?l--:d++,Kt(ct(tt(n,l,d),u),u<0)}if(!s.state.doc.resolve(e-(r||0)).parent.inlineContent){if(r==null&&i&&(t<0||i==$e(n))){let l=n.childNodes[i-1];if(l.nodeType==1)return fs(l.getBoundingClientRect(),!1)}if(r==null&&i<$e(n)){let l=n.childNodes[i];if(l.nodeType==1)return fs(l.getBoundingClientRect(),!0)}return fs(n.getBoundingClientRect(),t>=0)}if(r==null&&i&&(t<0||i==$e(n))){let l=n.childNodes[i-1],d=l.nodeType==3?tt(l,$e(l)-(o?0:1)):l.nodeType==1&&(l.nodeName!="BR"||!l.nextSibling)?l:null;if(d)return Kt(ct(d,1),!1)}if(r==null&&i<$e(n)){let l=n.childNodes[i];for(;l.pmViewDesc&&l.pmViewDesc.ignoreForCoords;)l=l.nextSibling;let d=l?l.nodeType==3?tt(l,0,o?0:1):l.nodeType==1?l:null:null;if(d)return Kt(ct(d,-1),!0)}return Kt(ct(n.nodeType==3?tt(n):n,-t),t>=0)}function Kt(s,e){if(s.width==0)return s;let t=e?s.left:s.right;return{top:s.top,bottom:s.bottom,left:t,right:t}}function fs(s,e){if(s.height==0)return s;let t=e?s.top:s.bottom;return{top:t,bottom:t,left:s.left,right:s.right}}function Uo(s,e,t){let n=s.state,i=s.root.activeElement;n!=e&&s.updateState(e),i!=s.dom&&s.focus();try{return t()}finally{n!=e&&s.updateState(n),i!=s.dom&&i&&i.focus()}}function Su(s,e,t){let n=e.selection,i=t=="up"?n.$from:n.$to;return Uo(s,e,()=>{let{node:r}=s.docView.domFromPos(i.pos,t=="up"?-1:1);for(;;){let a=s.docView.nearestDesc(r,!0);if(!a)break;if(a.node.isBlock){r=a.contentDOM||a.dom;break}r=a.dom.parentNode}let o=Vo(s,i.pos,1);for(let a=r.firstChild;a;a=a.nextSibling){let l;if(a.nodeType==1)l=a.getClientRects();else if(a.nodeType==3)l=tt(a,0,a.nodeValue.length).getClientRects();else continue;for(let d=0;d<l.length;d++){let u=l[d];if(u.bottom>u.top+1&&(t=="up"?o.top-u.top>(u.bottom-o.top)*2:u.bottom-o.bottom>(o.bottom-u.top)*2))return!1}}return!0})}const wu=/[\u0590-\u08ac]/;function Cu(s,e,t){let{$head:n}=e.selection;if(!n.parent.isTextblock)return!1;let i=n.parentOffset,r=!i,o=i==n.parent.content.size,a=s.domSelection();return!wu.test(n.parent.textContent)||!a.modify?t=="left"||t=="backward"?r:o:Uo(s,e,()=>{let{focusNode:l,focusOffset:d,anchorNode:u,anchorOffset:m}=s.domSelectionRange(),p=a.caretBidiLevel;a.modify("move",t,"character");let k=n.depth?s.docView.domAfterPos(n.before()):s.dom,{focusNode:y,focusOffset:S}=s.domSelectionRange(),C=y&&!k.contains(y.nodeType==1?y:y.parentNode)||l==y&&d==S;try{a.collapse(u,m),l&&(l!=u||d!=m)&&a.extend&&a.extend(l,d)}catch{}return p!=null&&(a.caretBidiLevel=p),C})}let Yi=null,Zi=null,Qi=!1;function Tu(s,e,t){return Yi==e&&Zi==t?Qi:(Yi=e,Zi=t,Qi=t=="up"||t=="down"?Su(s,e,t):Cu(s,e,t))}const Pe=0,Xi=1,Mt=2,Qe=3;class kn{constructor(e,t,n,i){this.parent=e,this.children=t,this.dom=n,this.contentDOM=i,this.dirty=Pe,n.pmViewDesc=this}matchesWidget(e){return!1}matchesMark(e){return!1}matchesNode(e,t,n){return!1}matchesHack(e){return!1}parseRule(){return null}stopEvent(e){return!1}get size(){let e=0;for(let t=0;t<this.children.length;t++)e+=this.children[t].size;return e}get border(){return 0}destroy(){this.parent=void 0,this.dom.pmViewDesc==this&&(this.dom.pmViewDesc=void 0);for(let e=0;e<this.children.length;e++)this.children[e].destroy()}posBeforeChild(e){for(let t=0,n=this.posAtStart;;t++){let i=this.children[t];if(i==e)return n;n+=i.size}}get posBefore(){return this.parent.posBeforeChild(this)}get posAtStart(){return this.parent?this.parent.posBeforeChild(this)+this.border:0}get posAfter(){return this.posBefore+this.size}get posAtEnd(){return this.posAtStart+this.size-2*this.border}localPosFromDOM(e,t,n){if(this.contentDOM&&this.contentDOM.contains(e.nodeType==1?e:e.parentNode))if(n<0){let r,o;if(e==this.contentDOM)r=e.childNodes[t-1];else{for(;e.parentNode!=this.contentDOM;)e=e.parentNode;r=e.previousSibling}for(;r&&!((o=r.pmViewDesc)&&o.parent==this);)r=r.previousSibling;return r?this.posBeforeChild(o)+o.size:this.posAtStart}else{let r,o;if(e==this.contentDOM)r=e.childNodes[t];else{for(;e.parentNode!=this.contentDOM;)e=e.parentNode;r=e.nextSibling}for(;r&&!((o=r.pmViewDesc)&&o.parent==this);)r=r.nextSibling;return r?this.posBeforeChild(o):this.posAtEnd}let i;if(e==this.dom&&this.contentDOM)i=t>ue(this.contentDOM);else if(this.contentDOM&&this.contentDOM!=this.dom&&this.dom.contains(this.contentDOM))i=e.compareDocumentPosition(this.contentDOM)&2;else if(this.dom.firstChild){if(t==0)for(let r=e;;r=r.parentNode){if(r==this.dom){i=!1;break}if(r.previousSibling)break}if(i==null&&t==e.childNodes.length)for(let r=e;;r=r.parentNode){if(r==this.dom){i=!0;break}if(r.nextSibling)break}}return i??n>0?this.posAtEnd:this.posAtStart}nearestDesc(e,t=!1){for(let n=!0,i=e;i;i=i.parentNode){let r=this.getDesc(i),o;if(r&&(!t||r.node))if(n&&(o=r.nodeDOM)&&!(o.nodeType==1?o.contains(e.nodeType==1?e:e.parentNode):o==e))n=!1;else return r}}getDesc(e){let t=e.pmViewDesc;for(let n=t;n;n=n.parent)if(n==this)return t}posFromDOM(e,t,n){for(let i=e;i;i=i.parentNode){let r=this.getDesc(i);if(r)return r.localPosFromDOM(e,t,n)}return-1}descAt(e){for(let t=0,n=0;t<this.children.length;t++){let i=this.children[t],r=n+i.size;if(n==e&&r!=n){for(;!i.border&&i.children.length;)i=i.children[0];return i}if(e<r)return i.descAt(e-n-i.border);n=r}}domFromPos(e,t){if(!this.contentDOM)return{node:this.dom,offset:0,atom:e+1};let n=0,i=0;for(let r=0;n<this.children.length;n++){let o=this.children[n],a=r+o.size;if(a>e||o instanceof Wo){i=e-r;break}r=a}if(i)return this.children[n].domFromPos(i-this.children[n].border,t);for(let r;n&&!(r=this.children[n-1]).size&&r instanceof qo&&r.side>=0;n--);if(t<=0){let r,o=!0;for(;r=n?this.children[n-1]:null,!(!r||r.dom.parentNode==this.contentDOM);n--,o=!1);return r&&t&&o&&!r.border&&!r.domAtom?r.domFromPos(r.size,t):{node:this.contentDOM,offset:r?ue(r.dom)+1:0}}else{let r,o=!0;for(;r=n<this.children.length?this.children[n]:null,!(!r||r.dom.parentNode==this.contentDOM);n++,o=!1);return r&&o&&!r.border&&!r.domAtom?r.domFromPos(0,t):{node:this.contentDOM,offset:r?ue(r.dom):this.contentDOM.childNodes.length}}}parseRange(e,t,n=0){if(this.children.length==0)return{node:this.contentDOM,from:e,to:t,fromOffset:0,toOffset:this.contentDOM.childNodes.length};let i=-1,r=-1;for(let o=n,a=0;;a++){let l=this.children[a],d=o+l.size;if(i==-1&&e<=d){let u=o+l.border;if(e>=u&&t<=d-l.border&&l.node&&l.contentDOM&&this.contentDOM.contains(l.contentDOM))return l.parseRange(e,t,u);e=o;for(let m=a;m>0;m--){let p=this.children[m-1];if(p.size&&p.dom.parentNode==this.contentDOM&&!p.emptyChildAt(1)){i=ue(p.dom)+1;break}e-=p.size}i==-1&&(i=0)}if(i>-1&&(d>t||a==this.children.length-1)){t=d;for(let u=a+1;u<this.children.length;u++){let m=this.children[u];if(m.size&&m.dom.parentNode==this.contentDOM&&!m.emptyChildAt(-1)){r=ue(m.dom);break}t+=m.size}r==-1&&(r=this.contentDOM.childNodes.length);break}o=d}return{node:this.contentDOM,from:e,to:t,fromOffset:i,toOffset:r}}emptyChildAt(e){if(this.border||!this.contentDOM||!this.children.length)return!1;let t=this.children[e<0?0:this.children.length-1];return t.size==0||t.emptyChildAt(e)}domAfterPos(e){let{node:t,offset:n}=this.domFromPos(e,0);if(t.nodeType!=1||n==t.childNodes.length)throw new RangeError("No node after pos "+e);return t.childNodes[n]}setSelection(e,t,n,i=!1){let r=Math.min(e,t),o=Math.max(e,t);for(let p=0,k=0;p<this.children.length;p++){let y=this.children[p],S=k+y.size;if(r>k&&o<S)return y.setSelection(e-k-y.border,t-k-y.border,n,i);k=S}let a=this.domFromPos(e,e?-1:1),l=t==e?a:this.domFromPos(t,t?-1:1),d=n.getSelection(),u=!1;if((qe||we)&&e==t){let{node:p,offset:k}=a;if(p.nodeType==3){if(u=!!(k&&p.nodeValue[k-1]==`
`),u&&k==p.nodeValue.length)for(let y=p,S;y;y=y.parentNode){if(S=y.nextSibling){S.nodeName=="BR"&&(a=l={node:S.parentNode,offset:ue(S)+1});break}let C=y.pmViewDesc;if(C&&C.node&&C.node.isBlock)break}}else{let y=p.childNodes[k-1];u=y&&(y.nodeName=="BR"||y.contentEditable=="false")}}if(qe&&d.focusNode&&d.focusNode!=l.node&&d.focusNode.nodeType==1){let p=d.focusNode.childNodes[d.focusOffset];p&&p.contentEditable=="false"&&(i=!0)}if(!(i||u&&we)&&Rt(a.node,a.offset,d.anchorNode,d.anchorOffset)&&Rt(l.node,l.offset,d.focusNode,d.focusOffset))return;let m=!1;if((d.extend||e==t)&&!u){d.collapse(a.node,a.offset);try{e!=t&&d.extend(l.node,l.offset),m=!0}catch{}}if(!m){if(e>t){let k=a;a=l,l=k}let p=document.createRange();p.setEnd(l.node,l.offset),p.setStart(a.node,a.offset),d.removeAllRanges(),d.addRange(p)}}ignoreMutation(e){return!this.contentDOM&&e.type!="selection"}get contentLost(){return this.contentDOM&&this.contentDOM!=this.dom&&!this.dom.contains(this.contentDOM)}markDirty(e,t){for(let n=0,i=0;i<this.children.length;i++){let r=this.children[i],o=n+r.size;if(n==o?e<=o&&t>=n:e<o&&t>n){let a=n+r.border,l=o-r.border;if(e>=a&&t<=l){this.dirty=e==n||t==o?Mt:Xi,e==a&&t==l&&(r.contentLost||r.dom.parentNode!=this.contentDOM)?r.dirty=Qe:r.markDirty(e-a,t-a);return}else r.dirty=r.dom==r.contentDOM&&r.dom.parentNode==this.contentDOM&&!r.children.length?Mt:Qe}n=o}this.dirty=Mt}markParentsDirty(){let e=1;for(let t=this.parent;t;t=t.parent,e++){let n=e==1?Mt:Xi;t.dirty<n&&(t.dirty=n)}}get domAtom(){return!1}get ignoreForCoords(){return!1}isText(e){return!1}}class qo extends kn{constructor(e,t,n,i){let r,o=t.type.toDOM;if(typeof o=="function"&&(o=o(n,()=>{if(!r)return i;if(r.parent)return r.parent.posBeforeChild(r)})),!t.type.spec.raw){if(o.nodeType!=1){let a=document.createElement("span");a.appendChild(o),o=a}o.contentEditable="false",o.classList.add("ProseMirror-widget")}super(e,[],o,null),this.widget=t,this.widget=t,r=this}matchesWidget(e){return this.dirty==Pe&&e.type.eq(this.widget.type)}parseRule(){return{ignore:!0}}stopEvent(e){let t=this.widget.spec.stopEvent;return t?t(e):!1}ignoreMutation(e){return e.type!="selection"||this.widget.spec.ignoreSelection}destroy(){this.widget.type.destroy(this.dom),super.destroy()}get domAtom(){return!0}get side(){return this.widget.type.side}}class Mu extends kn{constructor(e,t,n,i){super(e,[],t,null),this.textDOM=n,this.text=i}get size(){return this.text.length}localPosFromDOM(e,t){return e!=this.textDOM?this.posAtStart+(t?this.size:0):this.posAtStart+t}domFromPos(e){return{node:this.textDOM,offset:e}}ignoreMutation(e){return e.type==="characterData"&&e.target.nodeValue==e.oldValue}}class At extends kn{constructor(e,t,n,i){super(e,[],n,i),this.mark=t}static create(e,t,n,i){let r=i.nodeViews[t.type.name],o=r&&r(t,i,n);return(!o||!o.dom)&&(o=Gt.renderSpec(document,t.type.spec.toDOM(t,n),null,t.attrs)),new At(e,t,o.dom,o.contentDOM||o.dom)}parseRule(){return this.dirty&Qe||this.mark.type.spec.reparseInView?null:{mark:this.mark.type.name,attrs:this.mark.attrs,contentElement:this.contentDOM}}matchesMark(e){return this.dirty!=Qe&&this.mark.eq(e)}markDirty(e,t){if(super.markDirty(e,t),this.dirty!=Pe){let n=this.parent;for(;!n.node;)n=n.parent;n.dirty<this.dirty&&(n.dirty=this.dirty),this.dirty=Pe}}slice(e,t,n){let i=At.create(this.parent,this.mark,!0,n),r=this.children,o=this.size;t<o&&(r=Fs(r,t,o,n)),e>0&&(r=Fs(r,0,e,n));for(let a=0;a<r.length;a++)r[a].parent=i;return i.children=r,i}}class xt extends kn{constructor(e,t,n,i,r,o,a,l,d){super(e,[],r,o),this.node=t,this.outerDeco=n,this.innerDeco=i,this.nodeDOM=a}static create(e,t,n,i,r,o){let a=r.nodeViews[t.type.name],l,d=a&&a(t,r,()=>{if(!l)return o;if(l.parent)return l.parent.posBeforeChild(l)},n,i),u=d&&d.dom,m=d&&d.contentDOM;if(t.isText){if(!u)u=document.createTextNode(t.text);else if(u.nodeType!=3)throw new RangeError("Text must be rendered as a DOM text node")}else u||({dom:u,contentDOM:m}=Gt.renderSpec(document,t.type.spec.toDOM(t),null,t.attrs));!m&&!t.isText&&u.nodeName!="BR"&&(u.hasAttribute("contenteditable")||(u.contentEditable="false"),t.type.spec.draggable&&(u.draggable=!0));let p=u;return u=$o(u,n,t),d?l=new Eu(e,t,n,i,u,m||null,p,d,r,o+1):t.isText?new Zn(e,t,n,i,u,p,r):new xt(e,t,n,i,u,m||null,p,r,o+1)}parseRule(){if(this.node.type.spec.reparseInView)return null;let e={node:this.node.type.name,attrs:this.node.attrs};if(this.node.type.whitespace=="pre"&&(e.preserveWhitespace="full"),!this.contentDOM)e.getContent=()=>this.node.content;else if(!this.contentLost)e.contentElement=this.contentDOM;else{for(let t=this.children.length-1;t>=0;t--){let n=this.children[t];if(this.dom.contains(n.dom.parentNode)){e.contentElement=n.dom.parentNode;break}}e.contentElement||(e.getContent=()=>E.empty)}return e}matchesNode(e,t,n){return this.dirty==Pe&&e.eq(this.node)&&Bs(t,this.outerDeco)&&n.eq(this.innerDeco)}get size(){return this.node.nodeSize}get border(){return this.node.isLeaf?0:1}updateChildren(e,t){let n=this.node.inlineContent,i=t,r=e.composing?this.localCompositionInfo(e,t):null,o=r&&r.pos>-1?r:null,a=r&&r.pos<0,l=new Nu(this,o&&o.node,e);Du(this.node,this.innerDeco,(d,u,m)=>{d.spec.marks?l.syncToMarks(d.spec.marks,n,e):d.type.side>=0&&!m&&l.syncToMarks(u==this.node.childCount?J.none:this.node.child(u).marks,n,e),l.placeWidget(d,e,i)},(d,u,m,p)=>{l.syncToMarks(d.marks,n,e);let k;l.findNodeMatch(d,u,m,p)||a&&e.state.selection.from>i&&e.state.selection.to<i+d.nodeSize&&(k=l.findIndexWithChild(r.node))>-1&&l.updateNodeAt(d,u,m,k,e)||l.updateNextNode(d,u,m,e,p,i)||l.addNode(d,u,m,e,i),i+=d.nodeSize}),l.syncToMarks([],n,e),this.node.isTextblock&&l.addTextblockHacks(),l.destroyRest(),(l.changed||this.dirty==Mt)&&(o&&this.protectLocalComposition(e,o),Jo(this.contentDOM,this.children,e),$t&&Ru(this.dom))}localCompositionInfo(e,t){let{from:n,to:i}=e.state.selection;if(!(e.state.selection instanceof X)||n<t||i>t+this.node.content.size)return null;let r=e.input.compositionNode;if(!r||!this.dom.contains(r.parentNode))return null;if(this.node.inlineContent){let o=r.nodeValue,a=Au(this.node.content,o,n-t,i-t);return a<0?null:{node:r,pos:a,text:o}}else return{node:r,pos:-1,text:""}}protectLocalComposition(e,{node:t,pos:n,text:i}){if(this.getDesc(t))return;let r=t;for(;r.parentNode!=this.contentDOM;r=r.parentNode){for(;r.previousSibling;)r.parentNode.removeChild(r.previousSibling);for(;r.nextSibling;)r.parentNode.removeChild(r.nextSibling);r.pmViewDesc&&(r.pmViewDesc=void 0)}let o=new Mu(this,r,t,i);e.input.compositionNodes.push(o),this.children=Fs(this.children,n,n+i.length,e,o)}update(e,t,n,i){return this.dirty==Qe||!e.sameMarkup(this.node)?!1:(this.updateInner(e,t,n,i),!0)}updateInner(e,t,n,i){this.updateOuterDeco(t),this.node=e,this.innerDeco=n,this.contentDOM&&this.updateChildren(i,this.posAtStart),this.dirty=Pe}updateOuterDeco(e){if(Bs(e,this.outerDeco))return;let t=this.nodeDOM.nodeType!=1,n=this.dom;this.dom=Ho(this.dom,this.nodeDOM,vs(this.outerDeco,this.node,t),vs(e,this.node,t)),this.dom!=n&&(n.pmViewDesc=void 0,this.dom.pmViewDesc=this),this.outerDeco=e}selectNode(){this.nodeDOM.nodeType==1&&this.nodeDOM.classList.add("ProseMirror-selectednode"),(this.contentDOM||!this.node.type.spec.draggable)&&(this.dom.draggable=!0)}deselectNode(){this.nodeDOM.nodeType==1&&(this.nodeDOM.classList.remove("ProseMirror-selectednode"),(this.contentDOM||!this.node.type.spec.draggable)&&this.dom.removeAttribute("draggable"))}get domAtom(){return this.node.isAtom}}function er(s,e,t,n,i){$o(n,e,s);let r=new xt(void 0,s,e,t,n,n,n,i,0);return r.contentDOM&&r.updateChildren(i,0),r}class Zn extends xt{constructor(e,t,n,i,r,o,a){super(e,t,n,i,r,null,o,a,0)}parseRule(){let e=this.nodeDOM.parentNode;for(;e&&e!=this.dom&&!e.pmIsDeco;)e=e.parentNode;return{skip:e||!0}}update(e,t,n,i){return this.dirty==Qe||this.dirty!=Pe&&!this.inParent()||!e.sameMarkup(this.node)?!1:(this.updateOuterDeco(t),(this.dirty!=Pe||e.text!=this.node.text)&&e.text!=this.nodeDOM.nodeValue&&(this.nodeDOM.nodeValue=e.text,i.trackWrites==this.nodeDOM&&(i.trackWrites=null)),this.node=e,this.dirty=Pe,!0)}inParent(){let e=this.parent.contentDOM;for(let t=this.nodeDOM;t;t=t.parentNode)if(t==e)return!0;return!1}domFromPos(e){return{node:this.nodeDOM,offset:e}}localPosFromDOM(e,t,n){return e==this.nodeDOM?this.posAtStart+Math.min(t,this.node.text.length):super.localPosFromDOM(e,t,n)}ignoreMutation(e){return e.type!="characterData"&&e.type!="selection"}slice(e,t,n){let i=this.node.cut(e,t),r=document.createTextNode(i.text);return new Zn(this.parent,i,this.outerDeco,this.innerDeco,r,r,n)}markDirty(e,t){super.markDirty(e,t),this.dom!=this.nodeDOM&&(e==0||t==this.nodeDOM.nodeValue.length)&&(this.dirty=Qe)}get domAtom(){return!1}isText(e){return this.node.text==e}}class Wo extends kn{parseRule(){return{ignore:!0}}matchesHack(e){return this.dirty==Pe&&this.dom.nodeName==e}get domAtom(){return!0}get ignoreForCoords(){return this.dom.nodeName=="IMG"}}class Eu extends xt{constructor(e,t,n,i,r,o,a,l,d,u){super(e,t,n,i,r,o,a,d,u),this.spec=l}update(e,t,n,i){if(this.dirty==Qe)return!1;if(this.spec.update){let r=this.spec.update(e,t,n);return r&&this.updateInner(e,t,n,i),r}else return!this.contentDOM&&!e.isLeaf?!1:super.update(e,t,n,i)}selectNode(){this.spec.selectNode?this.spec.selectNode():super.selectNode()}deselectNode(){this.spec.deselectNode?this.spec.deselectNode():super.deselectNode()}setSelection(e,t,n,i){this.spec.setSelection?this.spec.setSelection(e,t,n):super.setSelection(e,t,n,i)}destroy(){this.spec.destroy&&this.spec.destroy(),super.destroy()}stopEvent(e){return this.spec.stopEvent?this.spec.stopEvent(e):!1}ignoreMutation(e){return this.spec.ignoreMutation?this.spec.ignoreMutation(e):super.ignoreMutation(e)}}function Jo(s,e,t){let n=s.firstChild,i=!1;for(let r=0;r<e.length;r++){let o=e[r],a=o.dom;if(a.parentNode==s){for(;a!=n;)n=tr(n),i=!0;n=n.nextSibling}else i=!0,s.insertBefore(a,n);if(o instanceof At){let l=n?n.previousSibling:s.lastChild;Jo(o.contentDOM,o.children,t),n=l?l.nextSibling:s.firstChild}}for(;n;)n=tr(n),i=!0;i&&t.trackWrites==s&&(t.trackWrites=null)}const on=function(s){s&&(this.nodeName=s)};on.prototype=Object.create(null);const Et=[new on];function vs(s,e,t){if(s.length==0)return Et;let n=t?Et[0]:new on,i=[n];for(let r=0;r<s.length;r++){let o=s[r].type.attrs;if(o){o.nodeName&&i.push(n=new on(o.nodeName));for(let a in o){let l=o[a];l!=null&&(t&&i.length==1&&i.push(n=new on(e.isInline?"span":"div")),a=="class"?n.class=(n.class?n.class+" ":"")+l:a=="style"?n.style=(n.style?n.style+";":"")+l:a!="nodeName"&&(n[a]=l))}}}return i}function Ho(s,e,t,n){if(t==Et&&n==Et)return e;let i=e;for(let r=0;r<n.length;r++){let o=n[r],a=t[r];if(r){let l;a&&a.nodeName==o.nodeName&&i!=s&&(l=i.parentNode)&&l.nodeName.toLowerCase()==o.nodeName||(l=document.createElement(o.nodeName),l.pmIsDeco=!0,l.appendChild(i),a=Et[0]),i=l}Iu(i,a||Et[0],o)}return i}function Iu(s,e,t){for(let n in e)n!="class"&&n!="style"&&n!="nodeName"&&!(n in t)&&s.removeAttribute(n);for(let n in t)n!="class"&&n!="style"&&n!="nodeName"&&t[n]!=e[n]&&s.setAttribute(n,t[n]);if(e.class!=t.class){let n=e.class?e.class.split(" ").filter(Boolean):[],i=t.class?t.class.split(" ").filter(Boolean):[];for(let r=0;r<n.length;r++)i.indexOf(n[r])==-1&&s.classList.remove(n[r]);for(let r=0;r<i.length;r++)n.indexOf(i[r])==-1&&s.classList.add(i[r]);s.classList.length==0&&s.removeAttribute("class")}if(e.style!=t.style){if(e.style){let n=/\s*([\w\-\xa1-\uffff]+)\s*:(?:"(?:\\.|[^"])*"|'(?:\\.|[^'])*'|\(.*?\)|[^;])*/g,i;for(;i=n.exec(e.style);)s.style.removeProperty(i[1])}t.style&&(s.style.cssText+=t.style)}}function $o(s,e,t){return Ho(s,s,Et,vs(e,t,s.nodeType!=1))}function Bs(s,e){if(s.length!=e.length)return!1;for(let t=0;t<s.length;t++)if(!s[t].type.eq(e[t].type))return!1;return!0}function tr(s){let e=s.nextSibling;return s.parentNode.removeChild(s),e}class Nu{constructor(e,t,n){this.lock=t,this.view=n,this.index=0,this.stack=[],this.changed=!1,this.top=e,this.preMatch=_u(e.node.content,e)}destroyBetween(e,t){if(e!=t){for(let n=e;n<t;n++)this.top.children[n].destroy();this.top.children.splice(e,t-e),this.changed=!0}}destroyRest(){this.destroyBetween(this.index,this.top.children.length)}syncToMarks(e,t,n){let i=0,r=this.stack.length>>1,o=Math.min(r,e.length);for(;i<o&&(i==r-1?this.top:this.stack[i+1<<1]).matchesMark(e[i])&&e[i].type.spec.spanning!==!1;)i++;for(;i<r;)this.destroyRest(),this.top.dirty=Pe,this.index=this.stack.pop(),this.top=this.stack.pop(),r--;for(;r<e.length;){this.stack.push(this.top,this.index+1);let a=-1;for(let l=this.index;l<Math.min(this.index+3,this.top.children.length);l++){let d=this.top.children[l];if(d.matchesMark(e[r])&&!this.isLocked(d.dom)){a=l;break}}if(a>-1)a>this.index&&(this.changed=!0,this.destroyBetween(this.index,a)),this.top=this.top.children[this.index];else{let l=At.create(this.top,e[r],t,n);this.top.children.splice(this.index,0,l),this.top=l,this.changed=!0}this.index=0,r++}}findNodeMatch(e,t,n,i){let r=-1,o;if(i>=this.preMatch.index&&(o=this.preMatch.matches[i-this.preMatch.index]).parent==this.top&&o.matchesNode(e,t,n))r=this.top.children.indexOf(o,this.index);else for(let a=this.index,l=Math.min(this.top.children.length,a+5);a<l;a++){let d=this.top.children[a];if(d.matchesNode(e,t,n)&&!this.preMatch.matched.has(d)){r=a;break}}return r<0?!1:(this.destroyBetween(this.index,r),this.index++,!0)}updateNodeAt(e,t,n,i,r){let o=this.top.children[i];return o.dirty==Qe&&o.dom==o.contentDOM&&(o.dirty=Mt),o.update(e,t,n,r)?(this.destroyBetween(this.index,i),this.index++,!0):!1}findIndexWithChild(e){for(;;){let t=e.parentNode;if(!t)return-1;if(t==this.top.contentDOM){let n=e.pmViewDesc;if(n){for(let i=this.index;i<this.top.children.length;i++)if(this.top.children[i]==n)return i}return-1}e=t}}updateNextNode(e,t,n,i,r,o){for(let a=this.index;a<this.top.children.length;a++){let l=this.top.children[a];if(l instanceof xt){let d=this.preMatch.matched.get(l);if(d!=null&&d!=r)return!1;let u=l.dom,m,p=this.isLocked(u)&&!(e.isText&&l.node&&l.node.isText&&l.nodeDOM.nodeValue==e.text&&l.dirty!=Qe&&Bs(t,l.outerDeco));if(!p&&l.update(e,t,n,i))return this.destroyBetween(this.index,a),l.dom!=u&&(this.changed=!0),this.index++,!0;if(!p&&(m=this.recreateWrapper(l,e,t,n,i,o)))return this.top.children[this.index]=m,m.contentDOM&&(m.dirty=Mt,m.updateChildren(i,o+1),m.dirty=Pe),this.changed=!0,this.index++,!0;break}}return!1}recreateWrapper(e,t,n,i,r,o){if(e.dirty||t.isAtom||!e.children.length||!e.node.content.eq(t.content))return null;let a=xt.create(this.top,t,n,i,r,o);if(a.contentDOM){a.children=e.children,e.children=[];for(let l of a.children)l.parent=a}return e.destroy(),a}addNode(e,t,n,i,r){let o=xt.create(this.top,e,t,n,i,r);o.contentDOM&&o.updateChildren(i,r+1),this.top.children.splice(this.index++,0,o),this.changed=!0}placeWidget(e,t,n){let i=this.index<this.top.children.length?this.top.children[this.index]:null;if(i&&i.matchesWidget(e)&&(e==i.widget||!i.widget.type.toDOM.parentNode))this.index++;else{let r=new qo(this.top,e,t,n);this.top.children.splice(this.index++,0,r),this.changed=!0}}addTextblockHacks(){let e=this.top.children[this.index-1],t=this.top;for(;e instanceof At;)t=e,e=t.children[t.children.length-1];(!e||!(e instanceof Zn)||/\n$/.test(e.node.text)||this.view.requiresGeckoHackNode&&/\s$/.test(e.node.text))&&((we||ye)&&e&&e.dom.contentEditable=="false"&&this.addHackNode("IMG",t),this.addHackNode("BR",this.top))}addHackNode(e,t){if(t==this.top&&this.index<t.children.length&&t.children[this.index].matchesHack(e))this.index++;else{let n=document.createElement(e);e=="IMG"&&(n.className="ProseMirror-separator",n.alt=""),e=="BR"&&(n.className="ProseMirror-trailingBreak");let i=new Wo(this.top,[],n,null);t!=this.top?t.children.push(i):t.children.splice(this.index++,0,i),this.changed=!0}}isLocked(e){return this.lock&&(e==this.lock||e.nodeType==1&&e.contains(this.lock.parentNode))}}function _u(s,e){let t=e,n=t.children.length,i=s.childCount,r=new Map,o=[];e:for(;i>0;){let a;for(;;)if(n){let d=t.children[n-1];if(d instanceof At)t=d,n=d.children.length;else{a=d,n--;break}}else{if(t==e)break e;n=t.parent.children.indexOf(t),t=t.parent}let l=a.node;if(l){if(l!=s.child(i-1))break;--i,r.set(a,i),o.push(a)}}return{index:i,matched:r,matches:o.reverse()}}function Ou(s,e){return s.type.side-e.type.side}function Du(s,e,t,n){let i=e.locals(s),r=0;if(i.length==0){for(let d=0;d<s.childCount;d++){let u=s.child(d);n(u,i,e.forChild(r,u),d),r+=u.nodeSize}return}let o=0,a=[],l=null;for(let d=0;;){let u,m;for(;o<i.length&&i[o].to==r;){let C=i[o++];C.widget&&(u?(m||(m=[u])).push(C):u=C)}if(u)if(m){m.sort(Ou);for(let C=0;C<m.length;C++)t(m[C],d,!!l)}else t(u,d,!!l);let p,k;if(l)k=-1,p=l,l=null;else if(d<s.childCount)k=d,p=s.child(d++);else break;for(let C=0;C<a.length;C++)a[C].to<=r&&a.splice(C--,1);for(;o<i.length&&i[o].from<=r&&i[o].to>r;)a.push(i[o++]);let y=r+p.nodeSize;if(p.isText){let C=y;o<i.length&&i[o].from<C&&(C=i[o].from);for(let N=0;N<a.length;N++)a[N].to<C&&(C=a[N].to);C<y&&(l=p.cut(C-r),p=p.cut(0,C-r),y=C,k=-1)}else for(;o<i.length&&i[o].to<y;)o++;let S=p.isInline&&!p.isLeaf?a.filter(C=>!C.inline):a.slice();n(p,S,e.forChild(r,p),k),r=y}}function Ru(s){if(s.nodeName=="UL"||s.nodeName=="OL"){let e=s.style.cssText;s.style.cssText=e+"; list-style: square !important",window.getComputedStyle(s).listStyle,s.style.cssText=e}}function Au(s,e,t,n){for(let i=0,r=0;i<s.childCount&&r<=n;){let o=s.child(i++),a=r;if(r+=o.nodeSize,!o.isText)continue;let l=o.text;for(;i<s.childCount;){let d=s.child(i++);if(r+=d.nodeSize,!d.isText)break;l+=d.text}if(r>=t){if(r>=n&&l.slice(n-e.length-a,n-a)==e)return n-e.length;let d=a<n?l.lastIndexOf(e,n-a-1):-1;if(d>=0&&d+e.length+a>=t)return a+d;if(t==n&&l.length>=n+e.length-a&&l.slice(n-a,n-a+e.length)==e)return n}}return-1}function Fs(s,e,t,n,i){let r=[];for(let o=0,a=0;o<s.length;o++){let l=s[o],d=a,u=a+=l.size;d>=t||u<=e?r.push(l):(d<e&&r.push(l.slice(0,e-d,n)),i&&(r.push(i),i=void 0),u>t&&r.push(l.slice(t-d,l.size,n)))}return r}function si(s,e=null){let t=s.domSelectionRange(),n=s.state.doc;if(!t.focusNode)return null;let i=s.docView.nearestDesc(t.focusNode),r=i&&i.size==0,o=s.docView.posFromDOM(t.focusNode,t.focusOffset,1);if(o<0)return null;let a=n.resolve(o),l,d;if(Yn(t)){for(l=a;i&&!i.node;)i=i.parent;let u=i.node;if(i&&u.isAtom&&q.isSelectable(u)&&i.parent&&!(u.isInline&&ru(t.focusNode,t.focusOffset,i.dom))){let m=i.posBefore;d=new q(o==m?a:n.resolve(m))}}else{let u=s.docView.posFromDOM(t.anchorNode,t.anchorOffset,1);if(u<0)return null;l=n.resolve(u)}if(!d){let u=e=="pointer"||s.state.selection.head<a.pos&&!r?1:-1;d=ii(s,l,a,u)}return d}function Go(s){return s.editable?s.hasFocus():Yo(s)&&document.activeElement&&document.activeElement.contains(s.dom)}function it(s,e=!1){let t=s.state.selection;if(Ko(s,t),!!Go(s)){if(!e&&s.input.mouseDown&&s.input.mouseDown.allowDefault&&ye){let n=s.domSelectionRange(),i=s.domObserver.currentSelection;if(n.anchorNode&&i.anchorNode&&Rt(n.anchorNode,n.anchorOffset,i.anchorNode,i.anchorOffset)){s.input.mouseDown.delayedSelectionSync=!0,s.domObserver.setCurSelection();return}}if(s.domObserver.disconnectSelection(),s.cursorWrapper)Bu(s);else{let{anchor:n,head:i}=t,r,o;nr&&!(t instanceof X)&&(t.$from.parent.inlineContent||(r=sr(s,t.from)),!t.empty&&!t.$from.parent.inlineContent&&(o=sr(s,t.to))),s.docView.setSelection(n,i,s.root,e),nr&&(r&&ir(r),o&&ir(o)),t.visible?s.dom.classList.remove("ProseMirror-hideselection"):(s.dom.classList.add("ProseMirror-hideselection"),"onselectionchange"in document&&vu(s))}s.domObserver.setCurSelection(),s.domObserver.connectSelection()}}const nr=we||ye&&Fo<63;function sr(s,e){let{node:t,offset:n}=s.docView.domFromPos(e,0),i=n<t.childNodes.length?t.childNodes[n]:null,r=n?t.childNodes[n-1]:null;if(we&&i&&i.contentEditable=="false")return ps(i);if((!i||i.contentEditable=="false")&&(!r||r.contentEditable=="false")){if(i)return ps(i);if(r)return ps(r)}}function ps(s){return s.contentEditable="true",we&&s.draggable&&(s.draggable=!1,s.wasDraggable=!0),s}function ir(s){s.contentEditable="false",s.wasDraggable&&(s.draggable=!0,s.wasDraggable=null)}function vu(s){let e=s.dom.ownerDocument;e.removeEventListener("selectionchange",s.input.hideSelectionGuard);let t=s.domSelectionRange(),n=t.anchorNode,i=t.anchorOffset;e.addEventListener("selectionchange",s.input.hideSelectionGuard=()=>{(t.anchorNode!=n||t.anchorOffset!=i)&&(e.removeEventListener("selectionchange",s.input.hideSelectionGuard),setTimeout(()=>{(!Go(s)||s.state.selection.visible)&&s.dom.classList.remove("ProseMirror-hideselection")},20))})}function Bu(s){let e=s.domSelection(),t=document.createRange(),n=s.cursorWrapper.dom,i=n.nodeName=="IMG";i?t.setEnd(n.parentNode,ue(n)+1):t.setEnd(n,0),t.collapse(!1),e.removeAllRanges(),e.addRange(t),!i&&!s.state.selection.visible&&Ie&&yt<=11&&(n.disabled=!0,n.disabled=!1)}function Ko(s,e){if(e instanceof q){let t=s.docView.descAt(e.from);t!=s.lastSelectedViewDesc&&(rr(s),t&&t.selectNode(),s.lastSelectedViewDesc=t)}else rr(s)}function rr(s){s.lastSelectedViewDesc&&(s.lastSelectedViewDesc.parent&&s.lastSelectedViewDesc.deselectNode(),s.lastSelectedViewDesc=void 0)}function ii(s,e,t,n){return s.someProp("createSelectionBetween",i=>i(s,e,t))||X.between(e,t,n)}function or(s){return s.editable&&!s.hasFocus()?!1:Yo(s)}function Yo(s){let e=s.domSelectionRange();if(!e.anchorNode)return!1;try{return s.dom.contains(e.anchorNode.nodeType==3?e.anchorNode.parentNode:e.anchorNode)&&(s.editable||s.dom.contains(e.focusNode.nodeType==3?e.focusNode.parentNode:e.focusNode))}catch{return!1}}function Fu(s){let e=s.docView.domFromPos(s.state.selection.anchor,0),t=s.domSelectionRange();return Rt(e.node,e.offset,t.anchorNode,t.anchorOffset)}function Ps(s,e){let{$anchor:t,$head:n}=s.selection,i=e>0?t.max(n):t.min(n),r=i.parent.inlineContent?i.depth?s.doc.resolve(e>0?i.after():i.before()):null:i;return r&&Y.findFrom(r,e)}function ht(s,e){return s.dispatch(s.state.tr.setSelection(e).scrollIntoView()),!0}function ar(s,e,t){let n=s.state.selection;if(n instanceof X)if(t.indexOf("s")>-1){let{$head:i}=n,r=i.textOffset?null:e<0?i.nodeBefore:i.nodeAfter;if(!r||r.isText||!r.isLeaf)return!1;let o=s.state.doc.resolve(i.pos+r.nodeSize*(e<0?-1:1));return ht(s,new X(n.$anchor,o))}else if(n.empty){if(s.endOfTextblock(e>0?"forward":"backward")){let i=Ps(s.state,e);return i&&i instanceof q?ht(s,i):!1}else if(!(ve&&t.indexOf("m")>-1)){let i=n.$head,r=i.textOffset?null:e<0?i.nodeBefore:i.nodeAfter,o;if(!r||r.isText)return!1;let a=e<0?i.pos-r.nodeSize:i.pos;return r.isAtom||(o=s.docView.descAt(a))&&!o.contentDOM?q.isSelectable(r)?ht(s,new q(e<0?s.state.doc.resolve(i.pos-r.nodeSize):i)):xn?ht(s,new X(s.state.doc.resolve(e<0?a:a+r.nodeSize))):!1:!1}}else return!1;else{if(n instanceof q&&n.node.isInline)return ht(s,new X(e>0?n.$to:n.$from));{let i=Ps(s.state,e);return i?ht(s,i):!1}}}function Un(s){return s.nodeType==3?s.nodeValue.length:s.childNodes.length}function an(s,e){let t=s.pmViewDesc;return t&&t.size==0&&(e<0||s.nextSibling||s.nodeName!="BR")}function Ft(s,e){return e<0?Pu(s):Lu(s)}function Pu(s){let e=s.domSelectionRange(),t=e.focusNode,n=e.focusOffset;if(!t)return;let i,r,o=!1;for(qe&&t.nodeType==1&&n<Un(t)&&an(t.childNodes[n],-1)&&(o=!0);;)if(n>0){if(t.nodeType!=1)break;{let a=t.childNodes[n-1];if(an(a,-1))i=t,r=--n;else if(a.nodeType==3)t=a,n=t.nodeValue.length;else break}}else{if(Zo(t))break;{let a=t.previousSibling;for(;a&&an(a,-1);)i=t.parentNode,r=ue(a),a=a.previousSibling;if(a)t=a,n=Un(t);else{if(t=t.parentNode,t==s.dom)break;n=0}}}o?Ls(s,t,n):i&&Ls(s,i,r)}function Lu(s){let e=s.domSelectionRange(),t=e.focusNode,n=e.focusOffset;if(!t)return;let i=Un(t),r,o;for(;;)if(n<i){if(t.nodeType!=1)break;let a=t.childNodes[n];if(an(a,1))r=t,o=++n;else break}else{if(Zo(t))break;{let a=t.nextSibling;for(;a&&an(a,1);)r=a.parentNode,o=ue(a)+1,a=a.nextSibling;if(a)t=a,n=0,i=Un(t);else{if(t=t.parentNode,t==s.dom)break;n=i=0}}}r&&Ls(s,r,o)}function Zo(s){let e=s.pmViewDesc;return e&&e.node&&e.node.isBlock}function zu(s,e){for(;s&&e==s.childNodes.length&&!yn(s);)e=ue(s)+1,s=s.parentNode;for(;s&&e<s.childNodes.length;){let t=s.childNodes[e];if(t.nodeType==3)return t;if(t.nodeType==1&&t.contentEditable=="false")break;s=t,e=0}}function ju(s,e){for(;s&&!e&&!yn(s);)e=ue(s),s=s.parentNode;for(;s&&e;){let t=s.childNodes[e-1];if(t.nodeType==3)return t;if(t.nodeType==1&&t.contentEditable=="false")break;s=t,e=s.childNodes.length}}function Ls(s,e,t){if(e.nodeType!=3){let r,o;(o=zu(e,t))?(e=o,t=0):(r=ju(e,t))&&(e=r,t=r.nodeValue.length)}let n=s.domSelection();if(Yn(n)){let r=document.createRange();r.setEnd(e,t),r.setStart(e,t),n.removeAllRanges(),n.addRange(r)}else n.extend&&n.extend(e,t);s.domObserver.setCurSelection();let{state:i}=s;setTimeout(()=>{s.state==i&&it(s)},50)}function lr(s,e){let t=s.state.doc.resolve(e);if(!(ye||lu)&&t.parent.inlineContent){let i=s.coordsAtPos(e);if(e>t.start()){let r=s.coordsAtPos(e-1),o=(r.top+r.bottom)/2;if(o>i.top&&o<i.bottom&&Math.abs(r.left-i.left)>1)return r.left<i.left?"ltr":"rtl"}if(e<t.end()){let r=s.coordsAtPos(e+1),o=(r.top+r.bottom)/2;if(o>i.top&&o<i.bottom&&Math.abs(r.left-i.left)>1)return r.left>i.left?"ltr":"rtl"}}return getComputedStyle(s.dom).direction=="rtl"?"rtl":"ltr"}function cr(s,e,t){let n=s.state.selection;if(n instanceof X&&!n.empty||t.indexOf("s")>-1||ve&&t.indexOf("m")>-1)return!1;let{$from:i,$to:r}=n;if(!i.parent.inlineContent||s.endOfTextblock(e<0?"up":"down")){let o=Ps(s.state,e);if(o&&o instanceof q)return ht(s,o)}if(!i.parent.inlineContent){let o=e<0?i:r,a=n instanceof Ye?Y.near(o,e):Y.findFrom(o,e);return a?ht(s,a):!1}return!1}function dr(s,e){if(!(s.state.selection instanceof X))return!0;let{$head:t,$anchor:n,empty:i}=s.state.selection;if(!t.sameParent(n))return!0;if(!i)return!1;if(s.endOfTextblock(e>0?"forward":"backward"))return!0;let r=!t.textOffset&&(e<0?t.nodeBefore:t.nodeAfter);if(r&&!r.isText){let o=s.state.tr;return e<0?o.delete(t.pos-r.nodeSize,t.pos):o.delete(t.pos,t.pos+r.nodeSize),s.dispatch(o),!0}return!1}function hr(s,e,t){s.domObserver.stop(),e.contentEditable=t,s.domObserver.start()}function Vu(s){if(!we||s.state.selection.$head.parentOffset>0)return!1;let{focusNode:e,focusOffset:t}=s.domSelectionRange();if(e&&e.nodeType==1&&t==0&&e.firstChild&&e.firstChild.contentEditable=="false"){let n=e.firstChild;hr(s,n,"true"),setTimeout(()=>hr(s,n,"false"),20)}return!1}function Uu(s){let e="";return s.ctrlKey&&(e+="c"),s.metaKey&&(e+="m"),s.altKey&&(e+="a"),s.shiftKey&&(e+="s"),e}function qu(s,e){let t=e.keyCode,n=Uu(e);if(t==8||ve&&t==72&&n=="c")return dr(s,-1)||Ft(s,-1);if(t==46&&!e.shiftKey||ve&&t==68&&n=="c")return dr(s,1)||Ft(s,1);if(t==13||t==27)return!0;if(t==37||ve&&t==66&&n=="c"){let i=t==37?lr(s,s.state.selection.from)=="ltr"?-1:1:-1;return ar(s,i,n)||Ft(s,i)}else if(t==39||ve&&t==70&&n=="c"){let i=t==39?lr(s,s.state.selection.from)=="ltr"?1:-1:1;return ar(s,i,n)||Ft(s,i)}else{if(t==38||ve&&t==80&&n=="c")return cr(s,-1,n)||Ft(s,-1);if(t==40||ve&&t==78&&n=="c")return Vu(s)||cr(s,1,n)||Ft(s,1);if(n==(ve?"m":"c")&&(t==66||t==73||t==89||t==90))return!0}return!1}function Qo(s,e){s.someProp("transformCopied",k=>{e=k(e,s)});let t=[],{content:n,openStart:i,openEnd:r}=e;for(;i>1&&r>1&&n.childCount==1&&n.firstChild.childCount==1;){i--,r--;let k=n.firstChild;t.push(k.type.name,k.attrs!=k.type.defaultAttrs?k.attrs:null),n=k.content}let o=s.someProp("clipboardSerializer")||Gt.fromSchema(s.state.schema),a=ia(),l=a.createElement("div");l.appendChild(o.serializeFragment(n,{document:a}));let d=l.firstChild,u,m=0;for(;d&&d.nodeType==1&&(u=sa[d.nodeName.toLowerCase()]);){for(let k=u.length-1;k>=0;k--){let y=a.createElement(u[k]);for(;l.firstChild;)y.appendChild(l.firstChild);l.appendChild(y),m++}d=l.firstChild}d&&d.nodeType==1&&d.setAttribute("data-pm-slice",`${i} ${r}${m?` -${m}`:""} ${JSON.stringify(t)}`);let p=s.someProp("clipboardTextSerializer",k=>k(e,s))||e.content.textBetween(0,e.content.size,`

`);return{dom:l,text:p,slice:e}}function Xo(s,e,t,n,i){let r=i.parent.type.spec.code,o,a;if(!t&&!e)return null;let l=e&&(n||r||!t);if(l){if(s.someProp("transformPastedText",p=>{e=p(e,r||n,s)}),r)return e?new O(E.from(s.state.schema.text(e.replace(/\r\n?/g,`
`))),0,0):O.empty;let m=s.someProp("clipboardTextParser",p=>p(e,i,n,s));if(m)a=m;else{let p=i.marks(),{schema:k}=s.state,y=Gt.fromSchema(k);o=document.createElement("div"),e.split(/(?:\r\n?|\n)+/).forEach(S=>{let C=o.appendChild(document.createElement("p"));S&&C.appendChild(y.serializeNode(k.text(S,p)))})}}else s.someProp("transformPastedHTML",m=>{t=m(t,s)}),o=Hu(t),xn&&$u(o);let d=o&&o.querySelector("[data-pm-slice]"),u=d&&/^(\d+) (\d+)(?: -(\d+))? (.*)/.exec(d.getAttribute("data-pm-slice")||"");if(u&&u[3])for(let m=+u[3];m>0;m--){let p=o.firstChild;for(;p&&p.nodeType!=1;)p=p.nextSibling;if(!p)break;o=p}if(a||(a=(s.someProp("clipboardParser")||s.someProp("domParser")||dn.fromSchema(s.state.schema)).parseSlice(o,{preserveWhitespace:!!(l||u),context:i,ruleFromNode(p){return p.nodeName=="BR"&&!p.nextSibling&&p.parentNode&&!Wu.test(p.parentNode.nodeName)?{ignore:!0}:null}})),u)a=Gu(ur(a,+u[1],+u[2]),u[4]);else if(a=O.maxOpen(Ju(a.content,i),!0),a.openStart||a.openEnd){let m=0,p=0;for(let k=a.content.firstChild;m<a.openStart&&!k.type.spec.isolating;m++,k=k.firstChild);for(let k=a.content.lastChild;p<a.openEnd&&!k.type.spec.isolating;p++,k=k.lastChild);a=ur(a,m,p)}return s.someProp("transformPasted",m=>{a=m(a,s)}),a}const Wu=/^(a|abbr|acronym|b|cite|code|del|em|i|ins|kbd|label|output|q|ruby|s|samp|span|strong|sub|sup|time|u|tt|var)$/i;function Ju(s,e){if(s.childCount<2)return s;for(let t=e.depth;t>=0;t--){let i=e.node(t).contentMatchAt(e.index(t)),r,o=[];if(s.forEach(a=>{if(!o)return;let l=i.findWrapping(a.type),d;if(!l)return o=null;if(d=o.length&&r.length&&ta(l,r,a,o[o.length-1],0))o[o.length-1]=d;else{o.length&&(o[o.length-1]=na(o[o.length-1],r.length));let u=ea(a,l);o.push(u),i=i.matchType(u.type),r=l}}),o)return E.from(o)}return s}function ea(s,e,t=0){for(let n=e.length-1;n>=t;n--)s=e[n].create(null,E.from(s));return s}function ta(s,e,t,n,i){if(i<s.length&&i<e.length&&s[i]==e[i]){let r=ta(s,e,t,n.lastChild,i+1);if(r)return n.copy(n.content.replaceChild(n.childCount-1,r));if(n.contentMatchAt(n.childCount).matchType(i==s.length-1?t.type:s[i+1]))return n.copy(n.content.append(E.from(ea(t,s,i+1))))}}function na(s,e){if(e==0)return s;let t=s.content.replaceChild(s.childCount-1,na(s.lastChild,e-1)),n=s.contentMatchAt(s.childCount).fillBefore(E.empty,!0);return s.copy(t.append(n))}function zs(s,e,t,n,i,r){let o=e<0?s.firstChild:s.lastChild,a=o.content;return s.childCount>1&&(r=0),i<n-1&&(a=zs(a,e,t,n,i+1,r)),i>=t&&(a=e<0?o.contentMatchAt(0).fillBefore(a,r<=i).append(a):a.append(o.contentMatchAt(o.childCount).fillBefore(E.empty,!0))),s.replaceChild(e<0?0:s.childCount-1,o.copy(a))}function ur(s,e,t){return e<s.openStart&&(s=new O(zs(s.content,-1,e,s.openStart,0,s.openEnd),e,s.openEnd)),t<s.openEnd&&(s=new O(zs(s.content,1,t,s.openEnd,0,0),s.openStart,t)),s}const sa={thead:["table"],tbody:["table"],tfoot:["table"],caption:["table"],colgroup:["table"],col:["table","colgroup"],tr:["table","tbody"],td:["table","tbody","tr"],th:["table","tbody","tr"]};let fr=null;function ia(){return fr||(fr=document.implementation.createHTMLDocument("title"))}function Hu(s){let e=/^(\s*<meta [^>]*>)*/.exec(s);e&&(s=s.slice(e[0].length));let t=ia().createElement("div"),n=/<([a-z][^>\s]+)/i.exec(s),i;if((i=n&&sa[n[1].toLowerCase()])&&(s=i.map(r=>"<"+r+">").join("")+s+i.map(r=>"</"+r+">").reverse().join("")),t.innerHTML=s,i)for(let r=0;r<i.length;r++)t=t.querySelector(i[r])||t;return t}function $u(s){let e=s.querySelectorAll(ye?"span:not([class]):not([style])":"span.Apple-converted-space");for(let t=0;t<e.length;t++){let n=e[t];n.childNodes.length==1&&n.textContent==""&&n.parentNode&&n.parentNode.replaceChild(s.ownerDocument.createTextNode(" "),n)}}function Gu(s,e){if(!s.size)return s;let t=s.content.firstChild.type.schema,n;try{n=JSON.parse(e)}catch{return s}let{content:i,openStart:r,openEnd:o}=s;for(let a=n.length-2;a>=0;a-=2){let l=t.nodes[n[a]];if(!l||l.hasRequiredAttrs())break;i=E.from(l.create(n[a+1],i)),r++,o++}return new O(i,r,o)}const Ce={},Te={},Ku={touchstart:!0,touchmove:!0};class Yu{constructor(){this.shiftKey=!1,this.mouseDown=null,this.lastKeyCode=null,this.lastKeyCodeTime=0,this.lastClick={time:0,x:0,y:0,type:""},this.lastSelectionOrigin=null,this.lastSelectionTime=0,this.lastIOSEnter=0,this.lastIOSEnterFallbackTimeout=-1,this.lastFocus=0,this.lastTouch=0,this.lastAndroidDelete=0,this.composing=!1,this.compositionNode=null,this.composingTimeout=-1,this.compositionNodes=[],this.compositionEndedAt=-2e8,this.compositionID=1,this.compositionPendingChanges=0,this.domChangeCount=0,this.eventHandlers=Object.create(null),this.hideSelectionGuard=null}}function Zu(s){for(let e in Ce){let t=Ce[e];s.dom.addEventListener(e,s.input.eventHandlers[e]=n=>{Xu(s,n)&&!ri(s,n)&&(s.editable||!(n.type in Te))&&t(s,n)},Ku[e]?{passive:!0}:void 0)}we&&s.dom.addEventListener("input",()=>null),js(s)}function mt(s,e){s.input.lastSelectionOrigin=e,s.input.lastSelectionTime=Date.now()}function Qu(s){s.domObserver.stop();for(let e in s.input.eventHandlers)s.dom.removeEventListener(e,s.input.eventHandlers[e]);clearTimeout(s.input.composingTimeout),clearTimeout(s.input.lastIOSEnterFallbackTimeout)}function js(s){s.someProp("handleDOMEvents",e=>{for(let t in e)s.input.eventHandlers[t]||s.dom.addEventListener(t,s.input.eventHandlers[t]=n=>ri(s,n))})}function ri(s,e){return s.someProp("handleDOMEvents",t=>{let n=t[e.type];return n?n(s,e)||e.defaultPrevented:!1})}function Xu(s,e){if(!e.bubbles)return!0;if(e.defaultPrevented)return!1;for(let t=e.target;t!=s.dom;t=t.parentNode)if(!t||t.nodeType==11||t.pmViewDesc&&t.pmViewDesc.stopEvent(e))return!1;return!0}function ef(s,e){!ri(s,e)&&Ce[e.type]&&(s.editable||!(e.type in Te))&&Ce[e.type](s,e)}Te.keydown=(s,e)=>{let t=e;if(s.input.shiftKey=t.keyCode==16||t.shiftKey,!oa(s,t)&&(s.input.lastKeyCode=t.keyCode,s.input.lastKeyCodeTime=Date.now(),!(ze&&ye&&t.keyCode==13)))if(t.keyCode!=229&&s.domObserver.forceFlush(),$t&&t.keyCode==13&&!t.ctrlKey&&!t.altKey&&!t.metaKey){let n=Date.now();s.input.lastIOSEnter=n,s.input.lastIOSEnterFallbackTimeout=setTimeout(()=>{s.input.lastIOSEnter==n&&(s.someProp("handleKeyDown",i=>i(s,Tt(13,"Enter"))),s.input.lastIOSEnter=0)},200)}else s.someProp("handleKeyDown",n=>n(s,t))||qu(s,t)?t.preventDefault():mt(s,"key")};Te.keyup=(s,e)=>{e.keyCode==16&&(s.input.shiftKey=!1)};Te.keypress=(s,e)=>{let t=e;if(oa(s,t)||!t.charCode||t.ctrlKey&&!t.altKey||ve&&t.metaKey)return;if(s.someProp("handleKeyPress",i=>i(s,t))){t.preventDefault();return}let n=s.state.selection;if(!(n instanceof X)||!n.$from.sameParent(n.$to)){let i=String.fromCharCode(t.charCode);!/[\r\n]/.test(i)&&!s.someProp("handleTextInput",r=>r(s,n.$from.pos,n.$to.pos,i))&&s.dispatch(s.state.tr.insertText(i).scrollIntoView()),t.preventDefault()}};function Qn(s){return{left:s.clientX,top:s.clientY}}function tf(s,e){let t=e.x-s.clientX,n=e.y-s.clientY;return t*t+n*n<100}function oi(s,e,t,n,i){if(n==-1)return!1;let r=s.state.doc.resolve(n);for(let o=r.depth+1;o>0;o--)if(s.someProp(e,a=>o>r.depth?a(s,t,r.nodeAfter,r.before(o),i,!0):a(s,t,r.node(o),r.before(o),i,!1)))return!0;return!1}function Ut(s,e,t){s.focused||s.focus();let n=s.state.tr.setSelection(e);n.setMeta("pointer",!0),s.dispatch(n)}function nf(s,e){if(e==-1)return!1;let t=s.state.doc.resolve(e),n=t.nodeAfter;return n&&n.isAtom&&q.isSelectable(n)?(Ut(s,new q(t)),!0):!1}function sf(s,e){if(e==-1)return!1;let t=s.state.selection,n,i;t instanceof q&&(n=t.node);let r=s.state.doc.resolve(e);for(let o=r.depth+1;o>0;o--){let a=o>r.depth?r.nodeAfter:r.node(o);if(q.isSelectable(a)){n&&t.$from.depth>0&&o>=t.$from.depth&&r.before(t.$from.depth+1)==t.$from.pos?i=r.before(t.$from.depth):i=r.before(o);break}}return i!=null?(Ut(s,q.create(s.state.doc,i)),!0):!1}function rf(s,e,t,n,i){return oi(s,"handleClickOn",e,t,n)||s.someProp("handleClick",r=>r(s,e,n))||(i?sf(s,t):nf(s,t))}function of(s,e,t,n){return oi(s,"handleDoubleClickOn",e,t,n)||s.someProp("handleDoubleClick",i=>i(s,e,n))}function af(s,e,t,n){return oi(s,"handleTripleClickOn",e,t,n)||s.someProp("handleTripleClick",i=>i(s,e,n))||lf(s,t,n)}function lf(s,e,t){if(t.button!=0)return!1;let n=s.state.doc;if(e==-1)return n.inlineContent?(Ut(s,X.create(n,0,n.content.size)),!0):!1;let i=n.resolve(e);for(let r=i.depth+1;r>0;r--){let o=r>i.depth?i.nodeAfter:i.node(r),a=i.before(r);if(o.inlineContent)Ut(s,X.create(n,a+1,a+1+o.content.size));else if(q.isSelectable(o))Ut(s,q.create(n,a));else continue;return!0}}function ai(s){return qn(s)}const ra=ve?"metaKey":"ctrlKey";Ce.mousedown=(s,e)=>{let t=e;s.input.shiftKey=t.shiftKey;let n=ai(s),i=Date.now(),r="singleClick";i-s.input.lastClick.time<500&&tf(t,s.input.lastClick)&&!t[ra]&&(s.input.lastClick.type=="singleClick"?r="doubleClick":s.input.lastClick.type=="doubleClick"&&(r="tripleClick")),s.input.lastClick={time:i,x:t.clientX,y:t.clientY,type:r};let o=s.posAtCoords(Qn(t));o&&(r=="singleClick"?(s.input.mouseDown&&s.input.mouseDown.done(),s.input.mouseDown=new cf(s,o,t,!!n)):(r=="doubleClick"?of:af)(s,o.pos,o.inside,t)?t.preventDefault():mt(s,"pointer"))};class cf{constructor(e,t,n,i){this.view=e,this.pos=t,this.event=n,this.flushed=i,this.delayedSelectionSync=!1,this.mightDrag=null,this.startDoc=e.state.doc,this.selectNode=!!n[ra],this.allowDefault=n.shiftKey;let r,o;if(t.inside>-1)r=e.state.doc.nodeAt(t.inside),o=t.inside;else{let u=e.state.doc.resolve(t.pos);r=u.parent,o=u.depth?u.before():0}const a=i?null:n.target,l=a?e.docView.nearestDesc(a,!0):null;this.target=l&&l.dom.nodeType==1?l.dom:null;let{selection:d}=e.state;(n.button==0&&r.type.spec.draggable&&r.type.spec.selectable!==!1||d instanceof q&&d.from<=o&&d.to>o)&&(this.mightDrag={node:r,pos:o,addAttr:!!(this.target&&!this.target.draggable),setUneditable:!!(this.target&&qe&&!this.target.hasAttribute("contentEditable"))}),this.target&&this.mightDrag&&(this.mightDrag.addAttr||this.mightDrag.setUneditable)&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&(this.target.draggable=!0),this.mightDrag.setUneditable&&setTimeout(()=>{this.view.input.mouseDown==this&&this.target.setAttribute("contentEditable","false")},20),this.view.domObserver.start()),e.root.addEventListener("mouseup",this.up=this.up.bind(this)),e.root.addEventListener("mousemove",this.move=this.move.bind(this)),mt(e,"pointer")}done(){this.view.root.removeEventListener("mouseup",this.up),this.view.root.removeEventListener("mousemove",this.move),this.mightDrag&&this.target&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&this.target.removeAttribute("draggable"),this.mightDrag.setUneditable&&this.target.removeAttribute("contentEditable"),this.view.domObserver.start()),this.delayedSelectionSync&&setTimeout(()=>it(this.view)),this.view.input.mouseDown=null}up(e){if(this.done(),!this.view.dom.contains(e.target))return;let t=this.pos;this.view.state.doc!=this.startDoc&&(t=this.view.posAtCoords(Qn(e))),this.updateAllowDefault(e),this.allowDefault||!t?mt(this.view,"pointer"):rf(this.view,t.pos,t.inside,e,this.selectNode)?e.preventDefault():e.button==0&&(this.flushed||we&&this.mightDrag&&!this.mightDrag.node.isAtom||ye&&!this.view.state.selection.visible&&Math.min(Math.abs(t.pos-this.view.state.selection.from),Math.abs(t.pos-this.view.state.selection.to))<=2)?(Ut(this.view,Y.near(this.view.state.doc.resolve(t.pos))),e.preventDefault()):mt(this.view,"pointer")}move(e){this.updateAllowDefault(e),mt(this.view,"pointer"),e.buttons==0&&this.done()}updateAllowDefault(e){!this.allowDefault&&(Math.abs(this.event.x-e.clientX)>4||Math.abs(this.event.y-e.clientY)>4)&&(this.allowDefault=!0)}}Ce.touchstart=s=>{s.input.lastTouch=Date.now(),ai(s),mt(s,"pointer")};Ce.touchmove=s=>{s.input.lastTouch=Date.now(),mt(s,"pointer")};Ce.contextmenu=s=>ai(s);function oa(s,e){return s.composing?!0:we&&Math.abs(e.timeStamp-s.input.compositionEndedAt)<500?(s.input.compositionEndedAt=-2e8,!0):!1}const df=ze?5e3:-1;Te.compositionstart=Te.compositionupdate=s=>{if(!s.composing){s.domObserver.flush();let{state:e}=s,t=e.selection.$from;if(e.selection.empty&&(e.storedMarks||!t.textOffset&&t.parentOffset&&t.nodeBefore.marks.some(n=>n.type.spec.inclusive===!1)))s.markCursor=s.state.storedMarks||t.marks(),qn(s,!0),s.markCursor=null;else if(qn(s),qe&&e.selection.empty&&t.parentOffset&&!t.textOffset&&t.nodeBefore.marks.length){let n=s.domSelectionRange();for(let i=n.focusNode,r=n.focusOffset;i&&i.nodeType==1&&r!=0;){let o=r<0?i.lastChild:i.childNodes[r-1];if(!o)break;if(o.nodeType==3){s.domSelection().collapse(o,o.nodeValue.length);break}else i=o,r=-1}}s.input.composing=!0}aa(s,df)};Te.compositionend=(s,e)=>{s.composing&&(s.input.composing=!1,s.input.compositionEndedAt=e.timeStamp,s.input.compositionPendingChanges=s.domObserver.pendingRecords().length?s.input.compositionID:0,s.input.compositionNode=null,s.input.compositionPendingChanges&&Promise.resolve().then(()=>s.domObserver.flush()),s.input.compositionID++,aa(s,20))};function aa(s,e){clearTimeout(s.input.composingTimeout),e>-1&&(s.input.composingTimeout=setTimeout(()=>qn(s),e))}function la(s){for(s.composing&&(s.input.composing=!1,s.input.compositionEndedAt=uf());s.input.compositionNodes.length>0;)s.input.compositionNodes.pop().markParentsDirty()}function hf(s){let e=s.domSelectionRange();if(!e.focusNode)return null;let t=su(e.focusNode,e.focusOffset),n=iu(e.focusNode,e.focusOffset);if(t&&n&&t!=n){let i=n.pmViewDesc,r=s.domObserver.lastChangedTextNode;if(t==r||n==r)return r;if(!i||!i.isText(n.nodeValue))return n;if(s.input.compositionNode==n){let o=t.pmViewDesc;if(!(!o||!o.isText(t.nodeValue)))return n}}return t||n}function uf(){let s=document.createEvent("Event");return s.initEvent("event",!0,!0),s.timeStamp}function qn(s,e=!1){if(!(ze&&s.domObserver.flushingSoon>=0)){if(s.domObserver.forceFlush(),la(s),e||s.docView&&s.docView.dirty){let t=si(s);return t&&!t.eq(s.state.selection)?s.dispatch(s.state.tr.setSelection(t)):s.updateState(s.state),!0}return!1}}function ff(s,e){if(!s.dom.parentNode)return;let t=s.dom.parentNode.appendChild(document.createElement("div"));t.appendChild(e),t.style.cssText="position: fixed; left: -10000px; top: 10px";let n=getSelection(),i=document.createRange();i.selectNodeContents(e),s.dom.blur(),n.removeAllRanges(),n.addRange(i),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t),s.focus()},50)}const fn=Ie&&yt<15||$t&&cu<604;Ce.copy=Te.cut=(s,e)=>{let t=e,n=s.state.selection,i=t.type=="cut";if(n.empty)return;let r=fn?null:t.clipboardData,o=n.content(),{dom:a,text:l}=Qo(s,o);r?(t.preventDefault(),r.clearData(),r.setData("text/html",a.innerHTML),r.setData("text/plain",l)):ff(s,a),i&&s.dispatch(s.state.tr.deleteSelection().scrollIntoView().setMeta("uiEvent","cut"))};function pf(s){return s.openStart==0&&s.openEnd==0&&s.content.childCount==1?s.content.firstChild:null}function mf(s,e){if(!s.dom.parentNode)return;let t=s.input.shiftKey||s.state.selection.$from.parent.type.spec.code,n=s.dom.parentNode.appendChild(document.createElement(t?"textarea":"div"));t||(n.contentEditable="true"),n.style.cssText="position: fixed; left: -10000px; top: 10px",n.focus();let i=s.input.shiftKey&&s.input.lastKeyCode!=45;setTimeout(()=>{s.focus(),n.parentNode&&n.parentNode.removeChild(n),t?pn(s,n.value,null,i,e):pn(s,n.textContent,n.innerHTML,i,e)},50)}function pn(s,e,t,n,i){let r=Xo(s,e,t,n,s.state.selection.$from);if(s.someProp("handlePaste",l=>l(s,i,r||O.empty)))return!0;if(!r)return!1;let o=pf(r),a=o?s.state.tr.replaceSelectionWith(o,n):s.state.tr.replaceSelection(r);return s.dispatch(a.scrollIntoView().setMeta("paste",!0).setMeta("uiEvent","paste")),!0}function ca(s){let e=s.getData("text/plain")||s.getData("Text");if(e)return e;let t=s.getData("text/uri-list");return t?t.replace(/\r?\n/g," "):""}Te.paste=(s,e)=>{let t=e;if(s.composing&&!ze)return;let n=fn?null:t.clipboardData,i=s.input.shiftKey&&s.input.lastKeyCode!=45;n&&pn(s,ca(n),n.getData("text/html"),i,t)?t.preventDefault():mf(s,t)};class da{constructor(e,t,n){this.slice=e,this.move=t,this.node=n}}const ha=ve?"altKey":"ctrlKey";Ce.dragstart=(s,e)=>{let t=e,n=s.input.mouseDown;if(n&&n.done(),!t.dataTransfer)return;let i=s.state.selection,r=i.empty?null:s.posAtCoords(Qn(t)),o;if(!(r&&r.pos>=i.from&&r.pos<=(i instanceof q?i.to-1:i.to))){if(n&&n.mightDrag)o=q.create(s.state.doc,n.mightDrag.pos);else if(t.target&&t.target.nodeType==1){let m=s.docView.nearestDesc(t.target,!0);m&&m.node.type.spec.draggable&&m!=s.docView&&(o=q.create(s.state.doc,m.posBefore))}}let a=(o||s.state.selection).content(),{dom:l,text:d,slice:u}=Qo(s,a);(!t.dataTransfer.files.length||!ye||Fo>120)&&t.dataTransfer.clearData(),t.dataTransfer.setData(fn?"Text":"text/html",l.innerHTML),t.dataTransfer.effectAllowed="copyMove",fn||t.dataTransfer.setData("text/plain",d),s.dragging=new da(u,!t[ha],o)};Ce.dragend=s=>{let e=s.dragging;window.setTimeout(()=>{s.dragging==e&&(s.dragging=null)},50)};Te.dragover=Te.dragenter=(s,e)=>e.preventDefault();Te.drop=(s,e)=>{let t=e,n=s.dragging;if(s.dragging=null,!t.dataTransfer)return;let i=s.posAtCoords(Qn(t));if(!i)return;let r=s.state.doc.resolve(i.pos),o=n&&n.slice;o?s.someProp("transformPasted",y=>{o=y(o,s)}):o=Xo(s,ca(t.dataTransfer),fn?null:t.dataTransfer.getData("text/html"),!1,r);let a=!!(n&&!t[ha]);if(s.someProp("handleDrop",y=>y(s,t,o||O.empty,a))){t.preventDefault();return}if(!o)return;t.preventDefault();let l=o?Uh(s.state.doc,r.pos,o):r.pos;l==null&&(l=r.pos);let d=s.state.tr;if(a){let{node:y}=n;y?y.replace(d):d.deleteSelection()}let u=d.mapping.map(l),m=o.openStart==0&&o.openEnd==0&&o.content.childCount==1,p=d.doc;if(m?d.replaceRangeWith(u,u,o.content.firstChild):d.replaceRange(u,u,o),d.doc.eq(p))return;let k=d.doc.resolve(u);if(m&&q.isSelectable(o.content.firstChild)&&k.nodeAfter&&k.nodeAfter.sameMarkup(o.content.firstChild))d.setSelection(new q(k));else{let y=d.mapping.map(l);d.mapping.maps[d.mapping.maps.length-1].forEach((S,C,N,P)=>y=P),d.setSelection(ii(s,k,d.doc.resolve(y)))}s.focus(),s.dispatch(d.setMeta("uiEvent","drop"))};Ce.focus=s=>{s.input.lastFocus=Date.now(),s.focused||(s.domObserver.stop(),s.dom.classList.add("ProseMirror-focused"),s.domObserver.start(),s.focused=!0,setTimeout(()=>{s.docView&&s.hasFocus()&&!s.domObserver.currentSelection.eq(s.domSelectionRange())&&it(s)},20))};Ce.blur=(s,e)=>{let t=e;s.focused&&(s.domObserver.stop(),s.dom.classList.remove("ProseMirror-focused"),s.domObserver.start(),t.relatedTarget&&s.dom.contains(t.relatedTarget)&&s.domObserver.currentSelection.clear(),s.focused=!1)};Ce.beforeinput=(s,e)=>{if(ye&&ze&&e.inputType=="deleteContentBackward"){s.domObserver.flushSoon();let{domChangeCount:n}=s.input;setTimeout(()=>{if(s.input.domChangeCount!=n||(s.dom.blur(),s.focus(),s.someProp("handleKeyDown",r=>r(s,Tt(8,"Backspace")))))return;let{$cursor:i}=s.state.selection;i&&i.pos>0&&s.dispatch(s.state.tr.delete(i.pos-1,i.pos).scrollIntoView())},50)}};for(let s in Te)Ce[s]=Te[s];function mn(s,e){if(s==e)return!0;for(let t in s)if(s[t]!==e[t])return!1;for(let t in e)if(!(t in s))return!1;return!0}class Wn{constructor(e,t){this.toDOM=e,this.spec=t||_t,this.side=this.spec.side||0}map(e,t,n,i){let{pos:r,deleted:o}=e.mapResult(t.from+i,this.side<0?-1:1);return o?null:new je(r-n,r-n,this)}valid(){return!0}eq(e){return this==e||e instanceof Wn&&(this.spec.key&&this.spec.key==e.spec.key||this.toDOM==e.toDOM&&mn(this.spec,e.spec))}destroy(e){this.spec.destroy&&this.spec.destroy(e)}}class kt{constructor(e,t){this.attrs=e,this.spec=t||_t}map(e,t,n,i){let r=e.map(t.from+i,this.spec.inclusiveStart?-1:1)-n,o=e.map(t.to+i,this.spec.inclusiveEnd?1:-1)-n;return r>=o?null:new je(r,o,this)}valid(e,t){return t.from<t.to}eq(e){return this==e||e instanceof kt&&mn(this.attrs,e.attrs)&&mn(this.spec,e.spec)}static is(e){return e.type instanceof kt}destroy(){}}class li{constructor(e,t){this.attrs=e,this.spec=t||_t}map(e,t,n,i){let r=e.mapResult(t.from+i,1);if(r.deleted)return null;let o=e.mapResult(t.to+i,-1);return o.deleted||o.pos<=r.pos?null:new je(r.pos-n,o.pos-n,this)}valid(e,t){let{index:n,offset:i}=e.content.findIndex(t.from),r;return i==t.from&&!(r=e.child(n)).isText&&i+r.nodeSize==t.to}eq(e){return this==e||e instanceof li&&mn(this.attrs,e.attrs)&&mn(this.spec,e.spec)}destroy(){}}class je{constructor(e,t,n){this.from=e,this.to=t,this.type=n}copy(e,t){return new je(e,t,this.type)}eq(e,t=0){return this.type.eq(e.type)&&this.from+t==e.from&&this.to+t==e.to}map(e,t,n){return this.type.map(e,this,t,n)}static widget(e,t,n){return new je(e,e,new Wn(t,n))}static inline(e,t,n,i){return new je(e,t,new kt(n,i))}static node(e,t,n,i){return new je(e,t,new li(n,i))}get spec(){return this.type.spec}get inline(){return this.type instanceof kt}get widget(){return this.type instanceof Wn}}const jt=[],_t={};class de{constructor(e,t){this.local=e.length?e:jt,this.children=t.length?t:jt}static create(e,t){return t.length?Jn(t,e,0,_t):me}find(e,t,n){let i=[];return this.findInner(e??0,t??1e9,i,0,n),i}findInner(e,t,n,i,r){for(let o=0;o<this.local.length;o++){let a=this.local[o];a.from<=t&&a.to>=e&&(!r||r(a.spec))&&n.push(a.copy(a.from+i,a.to+i))}for(let o=0;o<this.children.length;o+=3)if(this.children[o]<t&&this.children[o+1]>e){let a=this.children[o]+1;this.children[o+2].findInner(e-a,t-a,n,i+a,r)}}map(e,t,n){return this==me||e.maps.length==0?this:this.mapInner(e,t,0,0,n||_t)}mapInner(e,t,n,i,r){let o;for(let a=0;a<this.local.length;a++){let l=this.local[a].map(e,n,i);l&&l.type.valid(t,l)?(o||(o=[])).push(l):r.onRemove&&r.onRemove(this.local[a].spec)}return this.children.length?gf(this.children,o||[],e,t,n,i,r):o?new de(o.sort(Ot),jt):me}add(e,t){return t.length?this==me?de.create(e,t):this.addInner(e,t,0):this}addInner(e,t,n){let i,r=0;e.forEach((a,l)=>{let d=l+n,u;if(u=fa(t,a,d)){for(i||(i=this.children.slice());r<i.length&&i[r]<l;)r+=3;i[r]==l?i[r+2]=i[r+2].addInner(a,u,d+1):i.splice(r,0,l,l+a.nodeSize,Jn(u,a,d+1,_t)),r+=3}});let o=ua(r?pa(t):t,-n);for(let a=0;a<o.length;a++)o[a].type.valid(e,o[a])||o.splice(a--,1);return new de(o.length?this.local.concat(o).sort(Ot):this.local,i||this.children)}remove(e){return e.length==0||this==me?this:this.removeInner(e,0)}removeInner(e,t){let n=this.children,i=this.local;for(let r=0;r<n.length;r+=3){let o,a=n[r]+t,l=n[r+1]+t;for(let u=0,m;u<e.length;u++)(m=e[u])&&m.from>a&&m.to<l&&(e[u]=null,(o||(o=[])).push(m));if(!o)continue;n==this.children&&(n=this.children.slice());let d=n[r+2].removeInner(o,a+1);d!=me?n[r+2]=d:(n.splice(r,3),r-=3)}if(i.length){for(let r=0,o;r<e.length;r++)if(o=e[r])for(let a=0;a<i.length;a++)i[a].eq(o,t)&&(i==this.local&&(i=this.local.slice()),i.splice(a--,1))}return n==this.children&&i==this.local?this:i.length||n.length?new de(i,n):me}forChild(e,t){if(this==me)return this;if(t.isLeaf)return de.empty;let n,i;for(let a=0;a<this.children.length;a+=3)if(this.children[a]>=e){this.children[a]==e&&(n=this.children[a+2]);break}let r=e+1,o=r+t.content.size;for(let a=0;a<this.local.length;a++){let l=this.local[a];if(l.from<o&&l.to>r&&l.type instanceof kt){let d=Math.max(r,l.from)-r,u=Math.min(o,l.to)-r;d<u&&(i||(i=[])).push(l.copy(d,u))}}if(i){let a=new de(i.sort(Ot),jt);return n?new ut([a,n]):a}return n||me}eq(e){if(this==e)return!0;if(!(e instanceof de)||this.local.length!=e.local.length||this.children.length!=e.children.length)return!1;for(let t=0;t<this.local.length;t++)if(!this.local[t].eq(e.local[t]))return!1;for(let t=0;t<this.children.length;t+=3)if(this.children[t]!=e.children[t]||this.children[t+1]!=e.children[t+1]||!this.children[t+2].eq(e.children[t+2]))return!1;return!0}locals(e){return ci(this.localsInner(e))}localsInner(e){if(this==me)return jt;if(e.inlineContent||!this.local.some(kt.is))return this.local;let t=[];for(let n=0;n<this.local.length;n++)this.local[n].type instanceof kt||t.push(this.local[n]);return t}}de.empty=new de([],[]);de.removeOverlap=ci;const me=de.empty;class ut{constructor(e){this.members=e}map(e,t){const n=this.members.map(i=>i.map(e,t,_t));return ut.from(n)}forChild(e,t){if(t.isLeaf)return de.empty;let n=[];for(let i=0;i<this.members.length;i++){let r=this.members[i].forChild(e,t);r!=me&&(r instanceof ut?n=n.concat(r.members):n.push(r))}return ut.from(n)}eq(e){if(!(e instanceof ut)||e.members.length!=this.members.length)return!1;for(let t=0;t<this.members.length;t++)if(!this.members[t].eq(e.members[t]))return!1;return!0}locals(e){let t,n=!0;for(let i=0;i<this.members.length;i++){let r=this.members[i].localsInner(e);if(r.length)if(!t)t=r;else{n&&(t=t.slice(),n=!1);for(let o=0;o<r.length;o++)t.push(r[o])}}return t?ci(n?t:t.sort(Ot)):jt}static from(e){switch(e.length){case 0:return me;case 1:return e[0];default:return new ut(e.every(t=>t instanceof de)?e:e.reduce((t,n)=>t.concat(n instanceof de?n:n.members),[]))}}}function gf(s,e,t,n,i,r,o){let a=s.slice();for(let d=0,u=r;d<t.maps.length;d++){let m=0;t.maps[d].forEach((p,k,y,S)=>{let C=S-y-(k-p);for(let N=0;N<a.length;N+=3){let P=a[N+1];if(P<0||p>P+u-m)continue;let W=a[N]+u-m;k>=W?a[N+1]=p<=W?-2:-1:p>=u&&C&&(a[N]+=C,a[N+1]+=C)}m+=C}),u=t.maps[d].map(u,-1)}let l=!1;for(let d=0;d<a.length;d+=3)if(a[d+1]<0){if(a[d+1]==-2){l=!0,a[d+1]=-1;continue}let u=t.map(s[d]+r),m=u-i;if(m<0||m>=n.content.size){l=!0;continue}let p=t.map(s[d+1]+r,-1),k=p-i,{index:y,offset:S}=n.content.findIndex(m),C=n.maybeChild(y);if(C&&S==m&&S+C.nodeSize==k){let N=a[d+2].mapInner(t,C,u+1,s[d]+r+1,o);N!=me?(a[d]=m,a[d+1]=k,a[d+2]=N):(a[d+1]=-2,l=!0)}else l=!0}if(l){let d=yf(a,s,e,t,i,r,o),u=Jn(d,n,0,o);e=u.local;for(let m=0;m<a.length;m+=3)a[m+1]<0&&(a.splice(m,3),m-=3);for(let m=0,p=0;m<u.children.length;m+=3){let k=u.children[m];for(;p<a.length&&a[p]<k;)p+=3;a.splice(p,0,u.children[m],u.children[m+1],u.children[m+2])}}return new de(e.sort(Ot),a)}function ua(s,e){if(!e||!s.length)return s;let t=[];for(let n=0;n<s.length;n++){let i=s[n];t.push(new je(i.from+e,i.to+e,i.type))}return t}function yf(s,e,t,n,i,r,o){function a(l,d){for(let u=0;u<l.local.length;u++){let m=l.local[u].map(n,i,d);m?t.push(m):o.onRemove&&o.onRemove(l.local[u].spec)}for(let u=0;u<l.children.length;u+=3)a(l.children[u+2],l.children[u]+d+1)}for(let l=0;l<s.length;l+=3)s[l+1]==-1&&a(s[l+2],e[l]+r+1);return t}function fa(s,e,t){if(e.isLeaf)return null;let n=t+e.nodeSize,i=null;for(let r=0,o;r<s.length;r++)(o=s[r])&&o.from>t&&o.to<n&&((i||(i=[])).push(o),s[r]=null);return i}function pa(s){let e=[];for(let t=0;t<s.length;t++)s[t]!=null&&e.push(s[t]);return e}function Jn(s,e,t,n){let i=[],r=!1;e.forEach((a,l)=>{let d=fa(s,a,l+t);if(d){r=!0;let u=Jn(d,a,t+l+1,n);u!=me&&i.push(l,l+a.nodeSize,u)}});let o=ua(r?pa(s):s,-t).sort(Ot);for(let a=0;a<o.length;a++)o[a].type.valid(e,o[a])||(n.onRemove&&n.onRemove(o[a].spec),o.splice(a--,1));return o.length||i.length?new de(o,i):me}function Ot(s,e){return s.from-e.from||s.to-e.to}function ci(s){let e=s;for(let t=0;t<e.length-1;t++){let n=e[t];if(n.from!=n.to)for(let i=t+1;i<e.length;i++){let r=e[i];if(r.from==n.from){r.to!=n.to&&(e==s&&(e=s.slice()),e[i]=r.copy(r.from,n.to),pr(e,i+1,r.copy(n.to,r.to)));continue}else{r.from<n.to&&(e==s&&(e=s.slice()),e[t]=n.copy(n.from,r.from),pr(e,i,n.copy(r.from,n.to)));break}}}return e}function pr(s,e,t){for(;e<s.length&&Ot(t,s[e])>0;)e++;s.splice(e,0,t)}function ms(s){let e=[];return s.someProp("decorations",t=>{let n=t(s.state);n&&n!=me&&e.push(n)}),s.cursorWrapper&&e.push(de.create(s.state.doc,[s.cursorWrapper.deco])),ut.from(e)}const xf={childList:!0,characterData:!0,characterDataOldValue:!0,attributes:!0,attributeOldValue:!0,subtree:!0},kf=Ie&&yt<=11;class bf{constructor(){this.anchorNode=null,this.anchorOffset=0,this.focusNode=null,this.focusOffset=0}set(e){this.anchorNode=e.anchorNode,this.anchorOffset=e.anchorOffset,this.focusNode=e.focusNode,this.focusOffset=e.focusOffset}clear(){this.anchorNode=this.focusNode=null}eq(e){return e.anchorNode==this.anchorNode&&e.anchorOffset==this.anchorOffset&&e.focusNode==this.focusNode&&e.focusOffset==this.focusOffset}}class Sf{constructor(e,t){this.view=e,this.handleDOMChange=t,this.queue=[],this.flushingSoon=-1,this.observer=null,this.currentSelection=new bf,this.onCharData=null,this.suppressingSelectionUpdates=!1,this.lastChangedTextNode=null,this.observer=window.MutationObserver&&new window.MutationObserver(n=>{for(let i=0;i<n.length;i++)this.queue.push(n[i]);Ie&&yt<=11&&n.some(i=>i.type=="childList"&&i.removedNodes.length||i.type=="characterData"&&i.oldValue.length>i.target.nodeValue.length)?this.flushSoon():this.flush()}),kf&&(this.onCharData=n=>{this.queue.push({target:n.target,type:"characterData",oldValue:n.prevValue}),this.flushSoon()}),this.onSelectionChange=this.onSelectionChange.bind(this)}flushSoon(){this.flushingSoon<0&&(this.flushingSoon=window.setTimeout(()=>{this.flushingSoon=-1,this.flush()},20))}forceFlush(){this.flushingSoon>-1&&(window.clearTimeout(this.flushingSoon),this.flushingSoon=-1,this.flush())}start(){this.observer&&(this.observer.takeRecords(),this.observer.observe(this.view.dom,xf)),this.onCharData&&this.view.dom.addEventListener("DOMCharacterDataModified",this.onCharData),this.connectSelection()}stop(){if(this.observer){let e=this.observer.takeRecords();if(e.length){for(let t=0;t<e.length;t++)this.queue.push(e[t]);window.setTimeout(()=>this.flush(),20)}this.observer.disconnect()}this.onCharData&&this.view.dom.removeEventListener("DOMCharacterDataModified",this.onCharData),this.disconnectSelection()}connectSelection(){this.view.dom.ownerDocument.addEventListener("selectionchange",this.onSelectionChange)}disconnectSelection(){this.view.dom.ownerDocument.removeEventListener("selectionchange",this.onSelectionChange)}suppressSelectionUpdates(){this.suppressingSelectionUpdates=!0,setTimeout(()=>this.suppressingSelectionUpdates=!1,50)}onSelectionChange(){if(or(this.view)){if(this.suppressingSelectionUpdates)return it(this.view);if(Ie&&yt<=11&&!this.view.state.selection.empty){let e=this.view.domSelectionRange();if(e.focusNode&&Rt(e.focusNode,e.focusOffset,e.anchorNode,e.anchorOffset))return this.flushSoon()}this.flush()}}setCurSelection(){this.currentSelection.set(this.view.domSelectionRange())}ignoreSelectionChange(e){if(!e.focusNode)return!0;let t=new Set,n;for(let r=e.focusNode;r;r=un(r))t.add(r);for(let r=e.anchorNode;r;r=un(r))if(t.has(r)){n=r;break}let i=n&&this.view.docView.nearestDesc(n);if(i&&i.ignoreMutation({type:"selection",target:n.nodeType==3?n.parentNode:n}))return this.setCurSelection(),!0}pendingRecords(){if(this.observer)for(let e of this.observer.takeRecords())this.queue.push(e);return this.queue}flush(){let{view:e}=this;if(!e.docView||this.flushingSoon>-1)return;let t=this.pendingRecords();t.length&&(this.queue=[]);let n=e.domSelectionRange(),i=!this.suppressingSelectionUpdates&&!this.currentSelection.eq(n)&&or(e)&&!this.ignoreSelectionChange(n),r=-1,o=-1,a=!1,l=[];if(e.editable)for(let u=0;u<t.length;u++){let m=this.registerMutation(t[u],l);m&&(r=r<0?m.from:Math.min(m.from,r),o=o<0?m.to:Math.max(m.to,o),m.typeOver&&(a=!0))}if(qe&&l.length){let u=l.filter(m=>m.nodeName=="BR");if(u.length==2){let[m,p]=u;m.parentNode&&m.parentNode.parentNode==p.parentNode?p.remove():m.remove()}else{let{focusNode:m}=this.currentSelection;for(let p of u){let k=p.parentNode;k&&k.nodeName=="LI"&&(!m||Tf(e,m)!=k)&&p.remove()}}}let d=null;r<0&&i&&e.input.lastFocus>Date.now()-200&&Math.max(e.input.lastTouch,e.input.lastClick.time)<Date.now()-300&&Yn(n)&&(d=si(e))&&d.eq(Y.near(e.state.doc.resolve(0),1))?(e.input.lastFocus=0,it(e),this.currentSelection.set(n),e.scrollToSelection()):(r>-1||i)&&(r>-1&&(e.docView.markDirty(r,o),wf(e)),this.handleDOMChange(r,o,a,l),e.docView&&e.docView.dirty?e.updateState(e.state):this.currentSelection.eq(n)||it(e),this.currentSelection.set(n))}registerMutation(e,t){if(t.indexOf(e.target)>-1)return null;let n=this.view.docView.nearestDesc(e.target);if(e.type=="attributes"&&(n==this.view.docView||e.attributeName=="contenteditable"||e.attributeName=="style"&&!e.oldValue&&!e.target.getAttribute("style"))||!n||n.ignoreMutation(e))return null;if(e.type=="childList"){for(let u=0;u<e.addedNodes.length;u++){let m=e.addedNodes[u];t.push(m),m.nodeType==3&&(this.lastChangedTextNode=m)}if(n.contentDOM&&n.contentDOM!=n.dom&&!n.contentDOM.contains(e.target))return{from:n.posBefore,to:n.posAfter};let i=e.previousSibling,r=e.nextSibling;if(Ie&&yt<=11&&e.addedNodes.length)for(let u=0;u<e.addedNodes.length;u++){let{previousSibling:m,nextSibling:p}=e.addedNodes[u];(!m||Array.prototype.indexOf.call(e.addedNodes,m)<0)&&(i=m),(!p||Array.prototype.indexOf.call(e.addedNodes,p)<0)&&(r=p)}let o=i&&i.parentNode==e.target?ue(i)+1:0,a=n.localPosFromDOM(e.target,o,-1),l=r&&r.parentNode==e.target?ue(r):e.target.childNodes.length,d=n.localPosFromDOM(e.target,l,1);return{from:a,to:d}}else return e.type=="attributes"?{from:n.posAtStart-n.border,to:n.posAtEnd+n.border}:(this.lastChangedTextNode=e.target,{from:n.posAtStart,to:n.posAtEnd,typeOver:e.target.nodeValue==e.oldValue})}}let mr=new WeakMap,gr=!1;function wf(s){if(!mr.has(s)&&(mr.set(s,null),["normal","nowrap","pre-line"].indexOf(getComputedStyle(s.dom).whiteSpace)!==-1)){if(s.requiresGeckoHackNode=qe,gr)return;console.warn("ProseMirror expects the CSS white-space property to be set, preferably to 'pre-wrap'. It is recommended to load style/prosemirror.css from the prosemirror-view package."),gr=!0}}function yr(s,e){let t=e.startContainer,n=e.startOffset,i=e.endContainer,r=e.endOffset,o=s.domAtPos(s.state.selection.anchor);return Rt(o.node,o.offset,i,r)&&([t,n,i,r]=[i,r,t,n]),{anchorNode:t,anchorOffset:n,focusNode:i,focusOffset:r}}function Cf(s,e){if(e.getComposedRanges){let i=e.getComposedRanges(s.root)[0];if(i)return yr(s,i)}let t;function n(i){i.preventDefault(),i.stopImmediatePropagation(),t=i.getTargetRanges()[0]}return s.dom.addEventListener("beforeinput",n,!0),document.execCommand("indent"),s.dom.removeEventListener("beforeinput",n,!0),t?yr(s,t):null}function Tf(s,e){for(let t=e.parentNode;t&&t!=s.dom;t=t.parentNode){let n=s.docView.nearestDesc(t,!0);if(n&&n.node.isBlock)return t}return null}function Mf(s,e,t){let{node:n,fromOffset:i,toOffset:r,from:o,to:a}=s.docView.parseRange(e,t),l=s.domSelectionRange(),d,u=l.anchorNode;if(u&&s.dom.contains(u.nodeType==1?u:u.parentNode)&&(d=[{node:u,offset:l.anchorOffset}],Yn(l)||d.push({node:l.focusNode,offset:l.focusOffset})),ye&&s.input.lastKeyCode===8)for(let C=r;C>i;C--){let N=n.childNodes[C-1],P=N.pmViewDesc;if(N.nodeName=="BR"&&!P){r=C;break}if(!P||P.size)break}let m=s.state.doc,p=s.someProp("domParser")||dn.fromSchema(s.state.schema),k=m.resolve(o),y=null,S=p.parse(n,{topNode:k.parent,topMatch:k.parent.contentMatchAt(k.index()),topOpen:!0,from:i,to:r,preserveWhitespace:k.parent.type.whitespace=="pre"?"full":!0,findPositions:d,ruleFromNode:Ef,context:k});if(d&&d[0].pos!=null){let C=d[0].pos,N=d[1]&&d[1].pos;N==null&&(N=C),y={anchor:C+o,head:N+o}}return{doc:S,sel:y,from:o,to:a}}function Ef(s){let e=s.pmViewDesc;if(e)return e.parseRule();if(s.nodeName=="BR"&&s.parentNode){if(we&&/^(ul|ol)$/i.test(s.parentNode.nodeName)){let t=document.createElement("div");return t.appendChild(document.createElement("li")),{skip:t}}else if(s.parentNode.lastChild==s||we&&/^(tr|table)$/i.test(s.parentNode.nodeName))return{ignore:!0}}else if(s.nodeName=="IMG"&&s.getAttribute("mark-placeholder"))return{ignore:!0};return null}const If=/^(a|abbr|acronym|b|bd[io]|big|br|button|cite|code|data(list)?|del|dfn|em|i|ins|kbd|label|map|mark|meter|output|q|ruby|s|samp|small|span|strong|su[bp]|time|u|tt|var)$/i;function Nf(s,e,t,n,i){let r=s.input.compositionPendingChanges||(s.composing?s.input.compositionID:0);if(s.input.compositionPendingChanges=0,e<0){let _=s.input.lastSelectionTime>Date.now()-50?s.input.lastSelectionOrigin:null,L=si(s,_);if(L&&!s.state.selection.eq(L)){if(ye&&ze&&s.input.lastKeyCode===13&&Date.now()-100<s.input.lastKeyCodeTime&&s.someProp("handleKeyDown",le=>le(s,Tt(13,"Enter"))))return;let ie=s.state.tr.setSelection(L);_=="pointer"?ie.setMeta("pointer",!0):_=="key"&&ie.scrollIntoView(),r&&ie.setMeta("composition",r),s.dispatch(ie)}return}let o=s.state.doc.resolve(e),a=o.sharedDepth(t);e=o.before(a+1),t=s.state.doc.resolve(t).after(a+1);let l=s.state.selection,d=Mf(s,e,t),u=s.state.doc,m=u.slice(d.from,d.to),p,k;s.input.lastKeyCode===8&&Date.now()-100<s.input.lastKeyCodeTime?(p=s.state.selection.to,k="end"):(p=s.state.selection.from,k="start"),s.input.lastKeyCode=null;let y=Df(m.content,d.doc.content,d.from,p,k);if(($t&&s.input.lastIOSEnter>Date.now()-225||ze)&&i.some(_=>_.nodeType==1&&!If.test(_.nodeName))&&(!y||y.endA>=y.endB)&&s.someProp("handleKeyDown",_=>_(s,Tt(13,"Enter")))){s.input.lastIOSEnter=0;return}if(!y)if(n&&l instanceof X&&!l.empty&&l.$head.sameParent(l.$anchor)&&!s.composing&&!(d.sel&&d.sel.anchor!=d.sel.head))y={start:l.from,endA:l.to,endB:l.to};else{if(d.sel){let _=xr(s,s.state.doc,d.sel);if(_&&!_.eq(s.state.selection)){let L=s.state.tr.setSelection(_);r&&L.setMeta("composition",r),s.dispatch(L)}}return}s.input.domChangeCount++,s.state.selection.from<s.state.selection.to&&y.start==y.endB&&s.state.selection instanceof X&&(y.start>s.state.selection.from&&y.start<=s.state.selection.from+2&&s.state.selection.from>=d.from?y.start=s.state.selection.from:y.endA<s.state.selection.to&&y.endA>=s.state.selection.to-2&&s.state.selection.to<=d.to&&(y.endB+=s.state.selection.to-y.endA,y.endA=s.state.selection.to)),Ie&&yt<=11&&y.endB==y.start+1&&y.endA==y.start&&y.start>d.from&&d.doc.textBetween(y.start-d.from-1,y.start-d.from+1)==" "&&(y.start--,y.endA--,y.endB--);let S=d.doc.resolveNoCache(y.start-d.from),C=d.doc.resolveNoCache(y.endB-d.from),N=u.resolve(y.start),P=S.sameParent(C)&&S.parent.inlineContent&&N.end()>=y.endA,W;if(($t&&s.input.lastIOSEnter>Date.now()-225&&(!P||i.some(_=>_.nodeName=="DIV"||_.nodeName=="P"))||!P&&S.pos<d.doc.content.size&&!S.sameParent(C)&&(W=Y.findFrom(d.doc.resolve(S.pos+1),1,!0))&&W.head==C.pos)&&s.someProp("handleKeyDown",_=>_(s,Tt(13,"Enter")))){s.input.lastIOSEnter=0;return}if(s.state.selection.anchor>y.start&&Of(u,y.start,y.endA,S,C)&&s.someProp("handleKeyDown",_=>_(s,Tt(8,"Backspace")))){ze&&ye&&s.domObserver.suppressSelectionUpdates();return}ye&&ze&&y.endB==y.start&&(s.input.lastAndroidDelete=Date.now()),ze&&!P&&S.start()!=C.start()&&C.parentOffset==0&&S.depth==C.depth&&d.sel&&d.sel.anchor==d.sel.head&&d.sel.head==y.endA&&(y.endB-=2,C=d.doc.resolveNoCache(y.endB-d.from),setTimeout(()=>{s.someProp("handleKeyDown",function(_){return _(s,Tt(13,"Enter"))})},20));let K=y.start,M=y.endA,R,H,F;if(P){if(S.pos==C.pos)Ie&&yt<=11&&S.parentOffset==0&&(s.domObserver.suppressSelectionUpdates(),setTimeout(()=>it(s),20)),R=s.state.tr.delete(K,M),H=u.resolve(y.start).marksAcross(u.resolve(y.endA));else if(y.endA==y.endB&&(F=_f(S.parent.content.cut(S.parentOffset,C.parentOffset),N.parent.content.cut(N.parentOffset,y.endA-N.start()))))R=s.state.tr,F.type=="add"?R.addMark(K,M,F.mark):R.removeMark(K,M,F.mark);else if(S.parent.child(S.index()).isText&&S.index()==C.index()-(C.textOffset?0:1)){let _=S.parent.textBetween(S.parentOffset,C.parentOffset);if(s.someProp("handleTextInput",L=>L(s,K,M,_)))return;R=s.state.tr.insertText(_,K,M)}}if(R||(R=s.state.tr.replace(K,M,d.doc.slice(y.start-d.from,y.endB-d.from))),d.sel){let _=xr(s,R.doc,d.sel);_&&!(ye&&ze&&s.composing&&_.empty&&(y.start!=y.endB||s.input.lastAndroidDelete<Date.now()-100)&&(_.head==K||_.head==R.mapping.map(M)-1)||Ie&&_.empty&&_.head==K)&&R.setSelection(_)}H&&R.ensureMarks(H),r&&R.setMeta("composition",r),s.dispatch(R.scrollIntoView())}function xr(s,e,t){return Math.max(t.anchor,t.head)>e.content.size?null:ii(s,e.resolve(t.anchor),e.resolve(t.head))}function _f(s,e){let t=s.firstChild.marks,n=e.firstChild.marks,i=t,r=n,o,a,l;for(let u=0;u<n.length;u++)i=n[u].removeFromSet(i);for(let u=0;u<t.length;u++)r=t[u].removeFromSet(r);if(i.length==1&&r.length==0)a=i[0],o="add",l=u=>u.mark(a.addToSet(u.marks));else if(i.length==0&&r.length==1)a=r[0],o="remove",l=u=>u.mark(a.removeFromSet(u.marks));else return null;let d=[];for(let u=0;u<e.childCount;u++)d.push(l(e.child(u)));if(E.from(d).eq(s))return{mark:a,type:o}}function Of(s,e,t,n,i){if(t-e<=i.pos-n.pos||gs(n,!0,!1)<i.pos)return!1;let r=s.resolve(e);if(!n.parent.isTextblock){let a=r.nodeAfter;return a!=null&&t==e+a.nodeSize}if(r.parentOffset<r.parent.content.size||!r.parent.isTextblock)return!1;let o=s.resolve(gs(r,!0,!0));return!o.parent.isTextblock||o.pos>t||gs(o,!0,!1)<t?!1:n.parent.content.cut(n.parentOffset).eq(o.parent.content)}function gs(s,e,t){let n=s.depth,i=e?s.end():s.pos;for(;n>0&&(e||s.indexAfter(n)==s.node(n).childCount);)n--,i++,e=!1;if(t){let r=s.node(n).maybeChild(s.indexAfter(n));for(;r&&!r.isLeaf;)r=r.firstChild,i++}return i}function Df(s,e,t,n,i){let r=s.findDiffStart(e,t);if(r==null)return null;let{a:o,b:a}=s.findDiffEnd(e,t+s.size,t+e.size);if(i=="end"){let l=Math.max(0,r-Math.min(o,a));n-=o+l-r}if(o<r&&s.size<e.size){let l=n<=r&&n>=o?r-n:0;r-=l,r&&r<e.size&&kr(e.textBetween(r-1,r+1))&&(r+=l?1:-1),a=r+(a-o),o=r}else if(a<r){let l=n<=r&&n>=a?r-n:0;r-=l,r&&r<s.size&&kr(s.textBetween(r-1,r+1))&&(r+=l?1:-1),o=r+(o-a),a=r}return{start:r,endA:o,endB:a}}function kr(s){if(s.length!=2)return!1;let e=s.charCodeAt(0),t=s.charCodeAt(1);return e>=56320&&e<=57343&&t>=55296&&t<=56319}class Vm{constructor(e,t){this._root=null,this.focused=!1,this.trackWrites=null,this.mounted=!1,this.markCursor=null,this.cursorWrapper=null,this.lastSelectedViewDesc=void 0,this.input=new Yu,this.prevDirectPlugins=[],this.pluginViews=[],this.requiresGeckoHackNode=!1,this.dragging=null,this._props=t,this.state=t.state,this.directPlugins=t.plugins||[],this.directPlugins.forEach(Tr),this.dispatch=this.dispatch.bind(this),this.dom=e&&e.mount||document.createElement("div"),e&&(e.appendChild?e.appendChild(this.dom):typeof e=="function"?e(this.dom):e.mount&&(this.mounted=!0)),this.editable=wr(this),Sr(this),this.nodeViews=Cr(this),this.docView=er(this.state.doc,br(this),ms(this),this.dom,this),this.domObserver=new Sf(this,(n,i,r,o)=>Nf(this,n,i,r,o)),this.domObserver.start(),Zu(this),this.updatePluginViews()}get composing(){return this.input.composing}get props(){if(this._props.state!=this.state){let e=this._props;this._props={};for(let t in e)this._props[t]=e[t];this._props.state=this.state}return this._props}update(e){e.handleDOMEvents!=this._props.handleDOMEvents&&js(this);let t=this._props;this._props=e,e.plugins&&(e.plugins.forEach(Tr),this.directPlugins=e.plugins),this.updateStateInner(e.state,t)}setProps(e){let t={};for(let n in this._props)t[n]=this._props[n];t.state=this.state;for(let n in e)t[n]=e[n];this.update(t)}updateState(e){this.updateStateInner(e,this._props)}updateStateInner(e,t){var n;let i=this.state,r=!1,o=!1;e.storedMarks&&this.composing&&(la(this),o=!0),this.state=e;let a=i.plugins!=e.plugins||this._props.plugins!=t.plugins;if(a||this._props.plugins!=t.plugins||this._props.nodeViews!=t.nodeViews){let k=Cr(this);Af(k,this.nodeViews)&&(this.nodeViews=k,r=!0)}(a||t.handleDOMEvents!=this._props.handleDOMEvents)&&js(this),this.editable=wr(this),Sr(this);let l=ms(this),d=br(this),u=i.plugins!=e.plugins&&!i.doc.eq(e.doc)?"reset":e.scrollToSelection>i.scrollToSelection?"to selection":"preserve",m=r||!this.docView.matchesNode(e.doc,d,l);(m||!e.selection.eq(i.selection))&&(o=!0);let p=u=="preserve"&&o&&this.dom.style.overflowAnchor==null&&uu(this);if(o){this.domObserver.stop();let k=m&&(Ie||ye)&&!this.composing&&!i.selection.empty&&!e.selection.empty&&Rf(i.selection,e.selection);if(m){let y=ye?this.trackWrites=this.domSelectionRange().focusNode:null;this.composing&&(this.input.compositionNode=hf(this)),(r||!this.docView.update(e.doc,d,l,this))&&(this.docView.updateOuterDeco(d),this.docView.destroy(),this.docView=er(e.doc,d,l,this.dom,this)),y&&!this.trackWrites&&(k=!0)}k||!(this.input.mouseDown&&this.domObserver.currentSelection.eq(this.domSelectionRange())&&Fu(this))?it(this,k):(Ko(this,e.selection),this.domObserver.setCurSelection()),this.domObserver.start()}this.updatePluginViews(i),!((n=this.dragging)===null||n===void 0)&&n.node&&!i.doc.eq(e.doc)&&this.updateDraggedNode(this.dragging,i),u=="reset"?this.dom.scrollTop=0:u=="to selection"?this.scrollToSelection():p&&fu(p)}scrollToSelection(){let e=this.domSelectionRange().focusNode;if(!this.someProp("handleScrollToSelection",t=>t(this)))if(this.state.selection instanceof q){let t=this.docView.domAfterPos(this.state.selection.from);t.nodeType==1&&Gi(this,t.getBoundingClientRect(),e)}else Gi(this,this.coordsAtPos(this.state.selection.head,1),e)}destroyPluginViews(){let e;for(;e=this.pluginViews.pop();)e.destroy&&e.destroy()}updatePluginViews(e){if(!e||e.plugins!=this.state.plugins||this.directPlugins!=this.prevDirectPlugins){this.prevDirectPlugins=this.directPlugins,this.destroyPluginViews();for(let t=0;t<this.directPlugins.length;t++){let n=this.directPlugins[t];n.spec.view&&this.pluginViews.push(n.spec.view(this))}for(let t=0;t<this.state.plugins.length;t++){let n=this.state.plugins[t];n.spec.view&&this.pluginViews.push(n.spec.view(this))}}else for(let t=0;t<this.pluginViews.length;t++){let n=this.pluginViews[t];n.update&&n.update(this,e)}}updateDraggedNode(e,t){let n=e.node,i=-1;if(this.state.doc.nodeAt(n.from)==n.node)i=n.from;else{let r=n.from+(this.state.doc.content.size-t.doc.content.size);(r>0&&this.state.doc.nodeAt(r))==n.node&&(i=r)}this.dragging=new da(e.slice,e.move,i<0?void 0:q.create(this.state.doc,i))}someProp(e,t){let n=this._props&&this._props[e],i;if(n!=null&&(i=t?t(n):n))return i;for(let o=0;o<this.directPlugins.length;o++){let a=this.directPlugins[o].props[e];if(a!=null&&(i=t?t(a):a))return i}let r=this.state.plugins;if(r)for(let o=0;o<r.length;o++){let a=r[o].props[e];if(a!=null&&(i=t?t(a):a))return i}}hasFocus(){if(Ie){let e=this.root.activeElement;if(e==this.dom)return!0;if(!e||!this.dom.contains(e))return!1;for(;e&&this.dom!=e&&this.dom.contains(e);){if(e.contentEditable=="false")return!1;e=e.parentElement}return!0}return this.root.activeElement==this.dom}focus(){this.domObserver.stop(),this.editable&&pu(this.dom),it(this),this.domObserver.start()}get root(){let e=this._root;if(e==null){for(let t=this.dom.parentNode;t;t=t.parentNode)if(t.nodeType==9||t.nodeType==11&&t.host)return t.getSelection||(Object.getPrototypeOf(t).getSelection=()=>t.ownerDocument.getSelection()),this._root=t}return e||document}updateRoot(){this._root=null}posAtCoords(e){return ku(this,e)}coordsAtPos(e,t=1){return Vo(this,e,t)}domAtPos(e,t=0){return this.docView.domFromPos(e,t)}nodeDOM(e){let t=this.docView.descAt(e);return t?t.nodeDOM:null}posAtDOM(e,t,n=-1){let i=this.docView.posFromDOM(e,t,n);if(i==null)throw new RangeError("DOM position not inside the editor");return i}endOfTextblock(e,t){return Tu(this,t||this.state,e)}pasteHTML(e,t){return pn(this,"",e,!1,t||new ClipboardEvent("paste"))}pasteText(e,t){return pn(this,e,null,!0,t||new ClipboardEvent("paste"))}destroy(){this.docView&&(Qu(this),this.destroyPluginViews(),this.mounted?(this.docView.update(this.state.doc,[],ms(this),this),this.dom.textContent=""):this.dom.parentNode&&this.dom.parentNode.removeChild(this.dom),this.docView.destroy(),this.docView=null,tu())}get isDestroyed(){return this.docView==null}dispatchEvent(e){return ef(this,e)}dispatch(e){let t=this._props.dispatchTransaction;t?t.call(this,e):this.updateState(this.state.apply(e))}domSelectionRange(){let e=this.domSelection();return we&&this.root.nodeType===11&&ou(this.dom.ownerDocument)==this.dom&&Cf(this,e)||e}domSelection(){return this.root.getSelection()}}function br(s){let e=Object.create(null);return e.class="ProseMirror",e.contenteditable=String(s.editable),s.someProp("attributes",t=>{if(typeof t=="function"&&(t=t(s.state)),t)for(let n in t)n=="class"?e.class+=" "+t[n]:n=="style"?e.style=(e.style?e.style+";":"")+t[n]:!e[n]&&n!="contenteditable"&&n!="nodeName"&&(e[n]=String(t[n]))}),e.translate||(e.translate="no"),[je.node(0,s.state.doc.content.size,e)]}function Sr(s){if(s.markCursor){let e=document.createElement("img");e.className="ProseMirror-separator",e.setAttribute("mark-placeholder","true"),e.setAttribute("alt",""),s.cursorWrapper={dom:e,deco:je.widget(s.state.selection.head,e,{raw:!0,marks:s.markCursor})}}else s.cursorWrapper=null}function wr(s){return!s.someProp("editable",e=>e(s.state)===!1)}function Rf(s,e){let t=Math.min(s.$anchor.sharedDepth(s.head),e.$anchor.sharedDepth(e.head));return s.$anchor.start(t)!=e.$anchor.start(t)}function Cr(s){let e=Object.create(null);function t(n){for(let i in n)Object.prototype.hasOwnProperty.call(e,i)||(e[i]=n[i])}return s.someProp("nodeViews",t),s.someProp("markViews",t),e}function Af(s,e){let t=0,n=0;for(let i in s){if(s[i]!=e[i])return!0;t++}for(let i in e)n++;return t!=n}function Tr(s){if(s.spec.state||s.spec.filterTransaction||s.spec.appendTransaction)throw new RangeError("Plugins passed directly to the view must not have a state component")}const vf=({onScroll:s,textdocId:e})=>{const t=fd(e),{windowWidth:n}=Nc(u=>u,{windowWidth:0,windowHeight:0});if(!t)return null;const{versions:i}=t,r=i.length-1,o=i[r],a=o.comments.filter(u=>u.status!==za.DISMISSED),l=!!o?.isPartial;let d=null;switch(o.type){case jr.DOCUMENT:d=x.jsx(Zd,{value:o.content,comments:[],edits:[],isRequestActive:l,isPreview:!0,isDisabled:!0,hideAccelerators:!0,hideComments:!0,hideToolbar:!0,hideEditOverlay:!0,width:n,modelCursor:o.modelCursor});break;default:zr(o.type)&&(d=x.jsx(Kd,{id:"codemirror",currentlyStreamingLineIndex:null,language:ja(o.type),value:o.content,hideComments:!0,hideToolbar:!0,hideAccelerators:!0,comments:a,readonlyReason:Va.Streaming,isRequestActive:l}))}return x.jsx(Wt,{children:x.jsx(Wt.Content,{onScroll:s,children:d})})},Bf=D.memo(vf);function Ff(s,e){switch(s){case"presentation":return x.jsx(Ka,{});case"table":return x.jsx(Ga,{});case"chart":return x.jsx($a,{});case jr.DOCUMENT:return x.jsx(cd,{className:ee("icon-md",{"text-token-text-primary":e,"text-token-text-tertiary":!e})});default:return zr(s)?x.jsx(Ja,{className:ee("icon-md",{"text-token-text-primary":e,"text-token-text-tertiary":!e})}):x.jsx(Ha,{})}}const Vs=({type:s,name:e,isStreaming:t=!1,isFocused:n=!1,onClick:i,textdocId:r,isFetching:o=!1,isCanvasOpen:a=!1,showInlinePreview:l=!1,isMissingFromThread:d=!1})=>{const[u,m]=D.useState(!1),p=gn(),{resolvedTheme:k}=Hn(),y=D.useRef(null),S=k==="dark",C=Js(r),[N,P]=D.useState(!1),W=d,K=()=>{!y.current||W||(Ya.logButtonClick(Za.MESSAGE_ATTACHMENT,{type:s}),Qa(y.current),i?.())},M=t&&x.jsx(Ua,{size:20,className:ee("flex-shrink-0",n?"text-blue-selection":"text-token-text-secondary")}),R=s?x.jsx("span",{className:ee("flex-shrink-0 transition-[filter]",{grayscale:!n&&!u}),children:Ff(s,C&&a)}):x.jsx("div",{className:"flex h-6 w-6 flex-shrink-0 items-center overflow-hidden",children:x.jsx(vn,{lines:1,size:"base",width:100,widthVariance:0})}),[H]=D.useState(()=>qa(100,180,!1)),F=d?x.jsx("span",{className:"min-w-0 truncate",children:p.formatMessage({id:"oZTAp8",defaultMessage:"Unknown title"})}):e?x.jsx("span",{className:"min-w-0 truncate",children:e}):x.jsx("div",{className:"flex h-5 flex-grow items-center overflow-hidden",style:{width:H},children:x.jsx(vn,{lines:1,size:"base",width:100,widthVariance:0})}),_=L=>{P(L>0)};return x.jsxs(gt.div,{role:"button",id:Wa(r),initial:{opacity:t?0:1,scale:t?.9:1},animate:{opacity:1,scale:1},transition:{type:"spring",bounce:0,duration:.72},className:ee("popover relative flex select-none flex-col overflow-hidden border bg-token-main-surface-primary transition-shadow duration-500",W?"cursor-default":"cursor-pointer",{"border-token-text-tertiary font-medium dark:border-gray-600":C&&a,"font-regular":!C,"border-token-border-light":!u&&!C,"border-token-border-medium":u&&!C,"mb-3 flex min-w-0 max-w-full flex-shrink flex-grow-0 items-center justify-between self-start rounded-xl":a||!l,"mb-4 h-96 w-full rounded-2xl":!a&&l}),onMouseEnter:()=>!W&&m(!0),onMouseLeave:()=>m(!1),onClick:K,ref:y,style:{boxShadow:a?C?"0px 2px 6px 0px rgba(0, 0, 0, 0.06)":"0px 2px 6px 0px rgba(0, 0, 0, 0)":l?u||C?"0px 12px 32px 0px rgba(0, 0, 0, 0.064)":"0px 6px 14px 0px rgba(0, 0, 0, 0.04)":"0px 2px 6px 0px rgba(0, 0, 0, 0)"},children:[x.jsxs("div",{className:ee("flex w-full min-w-0 items-center justify-between gap-2 self-start border-token-border-light px-4 transition-colors duration-700",{"border-token-border-light":!u&&!C,"border-token-border-medium":u&&!C,"text-sm font-medium text-token-text-primary":!a&&u&&l,"py-2":a||!l,"py-3":!a&&l,"text-sm font-medium text-token-text-secondary":!a&&!u&&l}),children:[x.jsxs("div",{className:ee("flex min-w-0 items-center",{"gap-2":a||!l,"gap-3.5":!a&&l}),children:[R,F]}),a?x.jsx(gt.span,{animate:M?"show":"initial",variants:{initial:{opacity:0,paddingLeft:0,width:"0"},show:{opacity:1,paddingLeft:2,width:"24px"}},transition:{type:"tween",duration:.18},children:M}):l&&!W?x.jsx(Ws,{label:p.formatMessage({id:"KMbgyZ",defaultMessage:"Open in canvas"}),children:x.jsx(gt.div,{role:"button",animate:{opacity:u?1:.64},transition:{type:"tween",duration:.18},className:"text-token-text-secondary transition-colors",children:x.jsx(ld,{className:"icon-md"})})}):null]}),!a&&l&&r&&x.jsxs(x.Fragment,{children:[x.jsx("div",{className:ee("relative flex min-h-0 flex-auto flex-col overflow-hidden border-t transition-colors",{"border-token-border-light":N,"border-transparent":!N}),children:d?x.jsx("div",{className:"m-auto text-token-text-secondary",children:x.jsx(oe,{id:"DZUSSk",defaultMessage:"Canvas not found"})}):o?x.jsx(io,{}):x.jsx(Bf,{onScroll:_,textdocId:r})}),x.jsx("div",{className:"absolute bottom-0 z-20 h-24 w-full transition-colors",style:{background:`linear-gradient(${S?"rgba(0,0,0,0)":"rgba(255,255,255,0)"}, ${S?"#2f2f2f":"#ffffff"})`}})]})]})},Pf=({messages:s,isRequestActive:e})=>{const t=gn(),n=Xa(s),i=el(s),r=D.useMemo(()=>{if(tl(n?.message))return nl(e,n.message,i?.message??null)},[e,n,i]),o=sl(),a=r?.textdocId??o??void 0,l=eo(a),d=il(),u=Js(a),m=pd(),p=rl(),k=md(),y=gd(),S=ol(),C=yd(_=>{const L=_?.lastCanvasAssistantMessageById;return L==null||a==null?null:L[a]}),N=C===n?.nodeId;if(!r)return null;const P=!k&&!l&&r.status!==Z.STREAMING&&r.status!==Z.WAITING&&y;let W,K;if(r.status!==Z.REDACTED&&r.status!==Z.FAILED&&!P&&a){const _=S&&r.function===Nn.UpdateTextdoc&&r.status===Z.COMPLETE;W=()=>{_&&r.versionInt?al(a,r.versionInt):bs(a)},K=()=>{_&&r.versionInt&&p(a,r.versionInt)}}const M=Lf(r,l);if(r.function===Nn.CreateTextdoc){if(r.status===Z.STREAMING||r.status===Z.WAITING||r.status===Z.COMPLETE){const L=k===!0&&(r.status===Z.STREAMING||r.status===Z.WAITING);return x.jsx(Vs,{showInlinePreview:N||C==null,isMissingFromThread:P,isFetching:L,type:r.type??null,name:M,isFocused:u,isStreaming:r.status===Z.STREAMING,onClick:W,isCanvasOpen:d,textdocId:a})}let _;switch(r.status){case Z.FAILED:_=t.formatMessage({id:"SNarKX",defaultMessage:"Failed to generate"});break;case Z.CANCELED:_=t.formatMessage({id:"1A6W36",defaultMessage:"Stopped generating"});break;case Z.REDACTED:_=x.jsx(Ws,{align:"start",label:t.formatMessage({id:"F6q1k7",defaultMessage:"Removed from shared conversation"}),children:t.formatMessage({id:"BqyYDu",defaultMessage:"Created document"})});break}return x.jsx(Mr,{children:_})}const R=P||r.status===Z.REDACTED,H=m&&!R?M:null,F=x.jsx(Mr,{onClick:W,onMouseOver:K,isStreaming:r.status===Z.STREAMING,children:r.function===Nn.CommentTextdoc?jf(t,r,H):zf(t,r,H)});return N&&!d?x.jsxs("div",{className:"flex flex-col gap-2",children:[x.jsx(Vs,{showInlinePreview:!0,isMissingFromThread:P,isFetching:!1,type:l?.type??null,name:M,isFocused:u,isStreaming:r.status===Z.STREAMING,onClick:a!=null?()=>bs(a):void 0,isCanvasOpen:d,textdocId:a}),F]}):F};function Lf(s,e){return e?.title?gi(e.title):s.function===Nn.CreateTextdoc&&s.title?gi(s.title):null}const Mr=({isStreaming:s=!1,onClick:e,onMouseOver:t,children:n})=>x.jsx("button",{disabled:!e,className:ee(s&&"loading-shimmer","flex min-h-5 w-fit select-none pt-[3px] text-start text-token-text-secondary",e&&"hover:text-token-text-primary"),onClick:e,onMouseOver:t,children:n}),ma=9;function zf(s,e,t){if(e.status===Z.STREAMING)return t?s.formatMessage({id:"W2xN1Z",defaultMessage:"Editing {documentTitle}"},{documentTitle:t}):s.formatMessage({id:"8taq8v",defaultMessage:"Editing"});if(e.status===Z.FAILED)return t?s.formatMessage({id:"UjJKYZ",defaultMessage:"Failed to edit {documentTitle}"},{documentTitle:t}):s.formatMessage({id:"kWUVkg",defaultMessage:"Failed to edit"});if(e.status===Z.CANCELED)return t?s.formatMessage({id:"TmSrCd",defaultMessage:"Stopped editing {documentTitle}"},{documentTitle:t}):s.formatMessage({id:"bYV7xA",defaultMessage:"Stopped editing"});const n=e.updates?.length;return e.status===Z.REDACTED||!n||n>ma?t?s.formatMessage({id:"n+G/ct",defaultMessage:"Edited {documentTitle}"},{documentTitle:t}):s.formatMessage({id:"aegqpL",defaultMessage:"Edited"}):t?s.formatMessage({id:"osYMSb",defaultMessage:"{numEdits, plural, one {Edited {documentTitle}} other {Made {numEdits} edits to {documentTitle}}}"},{numEdits:n,documentTitle:t}):s.formatMessage({id:"xJD3WR",defaultMessage:"{numEdits, plural, one {Edited} other {Made {numEdits} edits}}"},{numEdits:n})}function jf(s,e,t){if(e.status===Z.STREAMING)return t?s.formatMessage({id:"8xQH/P",defaultMessage:"Commenting on {documentTitle}"},{documentTitle:t}):s.formatMessage({id:"5yqLeN",defaultMessage:"Commenting"});if(e.status===Z.FAILED)return t?s.formatMessage({id:"Rl821S",defaultMessage:"Failed to comment on {documentTitle}"},{documentTitle:t}):s.formatMessage({id:"W007jt",defaultMessage:"Failed to comment"});if(e.status===Z.CANCELED)return t?s.formatMessage({id:"bozPdq",defaultMessage:"Stopped commenting on {documentTitle}"},{documentTitle:t}):s.formatMessage({id:"hyBGa7",defaultMessage:"Stopped commenting"});const n=e.comments?.length;return e.status===Z.REDACTED||!n||n>ma?t?s.formatMessage({id:"LXEzK7",defaultMessage:"Commented on {documentTitle}"},{documentTitle:t}):s.formatMessage({id:"KeMYhy",defaultMessage:"Commented"}):t?s.formatMessage({id:"Ql5lPq",defaultMessage:"{numComments, plural, one {Commented on {documentTitle}} other {Added {numComments} comments on {documentTitle}}}"},{numComments:n,documentTitle:t}):s.formatMessage({id:"FHtyJQ",defaultMessage:"{numComments, plural, one {Commented} other {Added {numComments} comments}}"},{numComments:n})}function Vf(s){return s.message.metadata?.finish_details?.type==="content_filter"}function di(s){if(s===void 0)return{flagSeverity:void 0,shouldHideContent:!1,errCode:void 0,errMessage:void 0};const{errType:e,errCode:t,err:n,disclaimers:i}=s,r=Vf(s);return!(i&&i.length>0)&&r?{flagSeverity:"warning",shouldHideContent:!0,errCode:st.ContentOrTos,errMessage:n}:{flagSeverity:e,shouldHideContent:e==="danger"&&(t===st.ContentPolicy||t===st.ModelIncompatibility),disclaimers:i,errCode:t,errMessage:n}}function Uf(s){return x.jsx(Ct,{flag:"danger",isUserTurn:!1,children:x.jsx(oe,{...Oe.somethingWentWrong})})}function qf({message:s,onRequestMoreCompletions:e,clientThreadId:t,id:n,isFeedbackEnabled:i,isUserTurn:r,className:o}){const{errCode:a,errMessage:l,flagSeverity:d}=di(s);switch(a){case st.ContentPolicy:return x.jsx(Ct,{flag:d,isUserTurn:r,className:o,children:x.jsx(Hf,{isFeedbackEnabled:i})});case st.ModelIncompatibility:return x.jsx(Ct,{flag:d,isUserTurn:r,className:o,children:x.jsx(oe,{...Oe.modelIncompatibilityMessage})});case st.ContentOrTos:return x.jsx(Ct,{flag:d,isUserTurn:r,className:o,children:x.jsx(Jf,{isFeedbackEnabled:i})});case Ss:return x.jsx(Wf,{className:o,id:n,onRequestMoreCompletions:e,flag:d,clientThreadId:t,isUserTurn:r});case Gr:return x.jsx(Ct,{flag:d,isUserTurn:r,className:o,children:x.jsx(oe,{...Oe.historyDisabledConversationMissing})});default:return l!==void 0?x.jsx(Ct,{flag:d,isUserTurn:r,className:o,children:x.jsx(ll,{rehypePlugins:[[cl,{target:"_new",rel:"noopener noreferrer"}]],className:"markdown prose w-full break-words dark:prose-invert",children:l})}):null}}function Wf({className:s,id:e,onRequestMoreCompletions:t,flag:n,clientThreadId:i,isUserTurn:r}){const o=dl(S=>S.isoDate),a=hl(o),l=Qs(i??_c),d=l&&l.kind!==Be.PrimaryAssistant,u=kd(),m=bd(),p=D.useCallback(()=>{const S=new yi;t(e,{eventSource:"mouse"},S,!0,"none",!1)},[e,t]),k=D.useCallback(()=>{const S=new yi,C=m.id;u({modelId:C,location:"Model switcher menu item"}),t(e,{eventSource:"mouse"},S,!0,"none",!0)},[t,e,m.id,u]);let y;return d?y=o!=null?x.jsx("span",{children:x.jsx(oe,{...Oe.gptUsageCapExceededCustomFeature,values:{link:Er,formattedTime:a}})}):x.jsx(oe,{...Oe.gptUsageCapExceededExpired}):y=o!=null?x.jsx("span",{children:x.jsx(oe,{...Oe.gptUsageCapExceeded,values:{link:Er,formattedTime:a}})}):x.jsx(oe,{...Oe.gptUsageCapExceededExpired}),x.jsx(Ct,{flag:o!=null?n:void 0,isUserTurn:r,className:s,children:x.jsxs("div",{className:"flex items-center gap-6",children:[y,o==null&&x.jsx(bi,{color:"secondary",className:"flex-shrink-0",onClick:p,children:x.jsx(oe,{...Oe.buttonTryAgain})}),o!=null&&!d&&x.jsx(bi,{color:"secondary",className:"flex-shrink-0",onClick:k,children:x.jsx(oe,{...Oe.buttonUseDefaultModel})})]})})}const Er=s=>x.jsx("a",{href:"https://share.hsforms.com/16d0ZZVM3QZirXnCD_q7u1Q4sk30",target:"_blank",rel:"noreferrer",className:"underline",children:s});function Jf({isFeedbackEnabled:s}){return x.jsxs(x.Fragment,{children:[x.jsx("div",{className:s?"font-semibold":"",children:x.jsx(oe,{...Oe.contentOrTosViolationNoFeedback,values:{contentPolicyLink:ga,termsLink:$f}})}),x.jsx("div",{children:s&&x.jsx(oe,{...Oe.contentPolicyFeedback})})]})}function Hf({isFeedbackEnabled:s}){return x.jsxs(x.Fragment,{children:[x.jsx("div",{className:s?"font-semibold":"",children:x.jsx(oe,{...Oe.contentPolicyViolationNoFeedback,values:{contentPolicyLink:ga}})}),x.jsx("div",{children:s&&x.jsx(oe,{...Oe.contentPolicyFeedback})})]})}const ga=s=>x.jsx(Vr,{target:"_blank",href:"https://openai.com/policies/usage-policies",rel:"noreferrer",children:s}),$f=s=>x.jsx(Vr,{target:"_blank",href:"https://openai.com/policies/terms-of-use",rel:"noreferrer",children:s}),Oe=Ks({contentPolicyFeedback:{id:"TextMessageDisplay.contentPolicyFeedback",defaultMessage:"Did we get it wrong? Please tell us by giving this response a thumbs down."},contentPolicyViolation:{id:"TextMessageDisplay.contentPolicyViolation.2",defaultMessage:"This content may violate our <contentPolicyLink>usage policies</contentPolicyLink>. Did we get it wrong? Please tell us by giving this response a thumbs down."},contentPolicyViolationNoFeedback:{id:"TextMessageDisplay.contentPolicyViolationNoFeedback",defaultMessage:"This content may violate our <contentPolicyLink>usage policies</contentPolicyLink>."},modelIncompatibilityMessage:{id:"cyOWhN",defaultMessage:"Your request was flagged as potentially violating our usage policy. Please try again with a different prompt."},contentOrTosViolation:{id:"TextMessageDisplay.contentOrTosViolation.2",defaultMessage:"This content may violate our <termsLink>Terms of Use</termsLink> or <contentPolicyLink>usage policies</contentPolicyLink>. Did we get it wrong? Please tell us by giving this response a thumbs down."},contentOrTosViolationNoFeedback:{id:"TextMessageDisplay.contentOrTosViolationNoFeedback",defaultMessage:"This content may violate our <termsLink>Terms of Use</termsLink> or <contentPolicyLink>usage policies</contentPolicyLink>."},historyDisabledConversationMissing:{id:"TextMessageDisplay.historyDisabledConversationMissing",defaultMessage:"Sorry, conversations created when Chat History is off expire after 6 hours of inactivity. Please start a new conversation to continue using ChatGPT."},somethingWentWrong:{id:"TextMessageDisplay.somethingWentWrong",defaultMessage:"Something went wrong."},gptUsageCapExceeded:{id:"TextMessageDisplay.gptUsageCapExceeded",defaultMessage:"You've reached the current usage cap for GPT-4. You can continue with the default model now, or try again {formattedTime}. <link>Learn more</link>"},gptUsageCapExceededCustomFeature:{id:"TextMessageDisplay.gptUsageCapExceededCustomFeature",defaultMessage:"You've reached the current usage cap for GPT-4, please try again {formattedTime}. <link>Learn more</link>"},gptUsageCapExceededExpired:{id:"TextMessageDisplay.gptUsageCapExceededExpired",defaultMessage:"You previously reached your usage cap for GPT-4, but you can now try sending your message again"},buttonUseDefaultModel:{id:"TextMessageDisplay.buttonUseDefaultModel",defaultMessage:"Use default model"},buttonTryAgain:{id:"TextMessageDisplay.buttonTryAgain",defaultMessage:"Try again"}}),Gf=({textdocId:s})=>{const e=eo(s),t=Js(e?.textdocId);if(!e)return null;const n=()=>{bs(e?.textdocId)};return x.jsx("div",{children:x.jsx(Vs,{type:e.type,name:e.title,isFocused:t,onClick:n,showInlinePreview:!0})})},Kf=({messages:s})=>{const[e]=s,t=e?.message.metadata?.canvas;return!t||t.user_message_type!=null?null:x.jsx(Gf,{textdocId:t.textdoc_id})};function hi(){return Kr(Yr.DataAnalysisV2)}function Um(){const s=ul(),e=Dc();return e&&s&&!Rc(s)&&e.isEnterprise()}function Yf(){return Kr(Yr.ChartSerialization)}function qm(s,e){const t=s==="chart"?Si.HasSeenAdaInteractiveChart:Si.HasSeenAdaInteractiveTable,[n,i]=D.useState(wi.getItem(t,{userId:e})??!1),r=D.useCallback(()=>{i(!0),wi.setItem(t,!0,{userId:e})},[t,e]);return[n,r]}function Wm(s){const[e,t]=D.useState([]),n=Bn(()=>{const i=A.resolveThreadId(s),r=A.getThreadCurrentLeafId(s);return A.getTree(i).getBranchFromLeaf(r)});return D.useEffect(()=>{const i=xa(n);i.length!==e.length&&t(i)},[e.length,s,n]),e}function Zf(s){return Bn(()=>{const e=A.resolveThreadId(s),t=A.getThreadCurrentLeafId(s),i=A.getTree(e).getBranchFromLeaf(t);return xa(i).length>0})}function ya(s){const e=s.metadata?.aggregate_result?.messages.filter(no)??[];let t=0;const n=(s.metadata?.ada_visualizations??[]).map(r=>{let o=r;return r.type=="chart"&&(o={...r,fallback_image:e[t++]}),o}),i=(s.metadata?.attachments??[]).filter(r=>Ur(r.name)).map(r=>({type:"table",file_id:r.id??"",title:ml(r),file_name:r.name,context_connector_info:r.context_connector_info}));return[...n,...i]}function xa(s){return s.filter(t=>t.message?.author.role==="tool"&&t.message?.author.name==="python"||(t.message?.metadata?.attachments??[]).length>0).flatMap(t=>ya(t.message))}Oc(s=>({selectedSpreadsheet:null,setSelectedSpreadsheet:e=>s({selectedSpreadsheet:e})}));async function Qf(s,e,t){const n=await s.text(),{parse:i}=await fe(async()=>{const{parse:o}=await import("./oeujip5i1ptrxie5.js");return{parse:o}},[]),r=i(n);return{content:{columnNames:r.shift(),columnTypes:r[0].map(()=>"string"),rows:r},file_name:e,download_url:t}}function Xf(s){const e=s[0].values.length,t=[];for(let n=0;n<e;n++){const i=s.map(r=>r.values[n]);t.push(i)}return t}function Jm(s){return Ys({queryKey:["ada-visualization","chart",s.file_id],queryFn:async()=>{const e=await rt.getFileDownloadLink(s.file_id);if(e.status===Zr.Success){const n=await(await fetch(e.download_url)).json();return{content:{chart_type:n.type,title:n.title,labels:n.labels,datasets:n.datasets,x_label:n.x_label,y_label:n.y_label},file_name:e.file_name??"",download_url:e.download_url}}else throw new Error("Failed to download chart json from interpreter")}})}function Hm(s){return Ys({queryKey:["ada-visualization","table",s.file_id],queryFn:async()=>{if(s.file_name&&fl(s.file_name)){const e=await rt.getAdaExcelFileContents(s.file_id);return{content:e.sheets.map(t=>({name:t.name,columnNames:t.columns.map(n=>n.name),columnTypes:t.columns.map(()=>"string"),rows:Xf(t.columns)})),download_url:e.download_url,file_name:s.file_name}}else{const e=await rt.getFileDownloadLink(s.file_id);if(e.status===Zr.Success){const t=await fetch(e.download_url);return Qf(t,e.file_name??"",e.download_url)}else throw new Error("Failed to download from interpreter")}}})}function $m(s){const e=pl(),t=Zf(s),n=hi();return t&&n&&!e.displayingSideBySideFeedback}const ep=xe(()=>fe(()=>import("./lp55fc5ebs62yb4c.js").then(s=>s.A),__vite__mapDeps([33,1,2,3,5,6,7,16,22,23,34,35,36,37,18,38])).then(s=>s.default)),tp=bt.div`flex gap-2 flex-wrap mt-1 max-w-[80%] justify-end`,np=bt.div`flex flex-col gap-2`,sp=({parts:s,attachments:e,isUserTurn:t,clientThreadId:n})=>{const i=Ac(),r=hi(),o=gl.getImageAssetPointersFromParts(s),a=new Set(o.map(k=>yl(k.asset_pointer))),d=xl()||i,u=(e??[]).filter(k=>Ur(k.name)),m=(e??[]).filter(k=>k.id==null||a.has(k.id)?!1:r?!u.includes(k):!0);return(r?(m.length>0||u.length>0)&&t:m.length>0&&t)?x.jsxs(x.Fragment,{children:[x.jsx(tp,{children:m.map(k=>x.jsx(kl,{file:k.name,fileId:k.id,contextConnectorInfo:bl(k.context_connector_info),width:i?"normal":"wide",alwaysShowData:!0},k.id))}),r&&x.jsx(np,{className:ee(!d&&"w-[80%]"),children:u.map(k=>x.jsx(ep,{clientThreadId:n,visualization:Sl(k)},k.id))})]}):null};function ka(s){return wl(s)&&!Cl(s)}const En=50,ip=95;function rp(s,e){if(s<=e)return s/e*En;{const t=En,n=ip-En,i=s-e,o=-(En/e)/n;return t+n*(1-Math.exp(o*i))}}class op{mostRecentCompletionRequest;loggedRequests=new Set;onCompletionRequestStarted(e){this.mostRecentCompletionRequest={requestId:e,timestamp:Date.now()},this.loggedRequests.clear()}logEvent(e,t,n,i,r){const o=this.mostRecentCompletionRequest;if(o!=null&&!this.loggedRequests.has(e)){const l=A.getThreadConversationTurns(t,n).find(d=>d.messages.some(u=>u.message.id===n));l!=null&&l.messages.some(d=>d.nodeId===o.requestId)&&(Ve.logEvent(e,{messageId:n,timeMs:Date.now()-o.timestamp,...i}),r?.(),this.loggedRequests.add(e))}}}const Us=new op;function ap(s){return(s.find(i=>i.message.metadata?.image_search_results!==void 0)?.message.metadata?.image_search_results??[]).slice(0,5)}function lp({messages:s}){const e=ap(s),t=Tl();return e.length===0?null:x.jsx("div",{className:ee({"mb-2":!0,"grid grid-flow-col gap-3":e.length>1,"w-1/3":e.length===1}),children:e.filter(({contentUrl:n})=>t.has(n)).map((n,i)=>x.jsx("a",{href:n.hostPageUrl,target:"_blank",rel:"noreferrer",children:x.jsx("img",{src:n.contentUrl,alt:n.name,className:"aspect-square rounded-xl object-cover"})},i))})}function ba({attachments:s,citations:e,contentReferences:t,className:n,clientThreadId:i,displayParts:r,isCompletionInProgress:o,id:a,isActivelyStreaming:l,isUserTurn:d,turnIndex:u,isFeedbackEnabled:m,messages:p,onRequestMoreCompletions:k,parts:y,prevGroupedMessageType:S,prevGroupedMessages:C,showEditButton:N,onEnterEdit:P,size:W="medium"}){const K=xd(i),M=p.length>1,{flagSeverity:R,shouldHideContent:H}=di(M?void 0:p[0]),F=!y.some(L=>L!==""),_=p[0].message.metadata?.targeted_reply_label??p[0].message.metadata?.targeted_reply;return D.useEffect(()=>{if(!F)switch(S){case B.Browsing:Us.logEvent(be.browsingTimeToFirstTextToken,i,p[0].message.id);break;case B.SearchGPTQuery:{const L=p[0].message,ie=L.metadata?.search_source;Us.logEvent(be.searchToolTimeToFirstTextToken,i,L.id,{search_source:ie},()=>{ie==="instant_query"&&Se.addFirstTiming("chatgpt.web.search.instant-query-ttft")});break}}},[F,p,i,S]),x.jsxs("div",{"data-message-author-role":p[0].message.author.role,"data-message-id":p[0].message.id,dir:"auto",className:ee(n,"text-message flex w-full flex-col items-end gap-2 whitespace-normal break-words [.text-message+&]:mt-5"),children:[_&&x.jsxs("div",{className:"mb-1 ml-6 mt-1 flex items-start gap-1.5 text-sm font-normal text-token-text-tertiary sm:ml-7 lg:ml-8",children:[x.jsx(dd,{className:"icon-md mt-1 shrink-0"}),x.jsx("p",{className:"mr-2 line-clamp-3",children:_})]}),d&&K&&x.jsx(Kf,{messages:p}),x.jsx(Ml,{messages:p}),x.jsx(cp,{parts:y,attachments:s,isUserTurn:d,isCompletionInProgress:o,turnIndex:u,displayParts:r,isActivelyStreaming:l,shouldHideContent:H,showEditButton:N,onEnterEdit:P,clientThreadId:i,id:a,isEmpty:F,prevGroupedMessageType:S,prevGroupedMessages:C,flagSeverity:R,messages:p,citations:e,contentReferences:t,size:W}),x.jsx(qf,{message:M?void 0:p[0],id:a,isFeedbackEnabled:m,onRequestMoreCompletions:k,clientThreadId:i,isUserTurn:d}),x.jsx(El,{isUserTurn:d,message:M?void 0:p[0]}),!d&&!l&&C&&S===B.SearchResult&&x.jsx(lp,{messages:C})]})}function cp({clientThreadId:s,id:e,displayParts:t,isCompletionInProgress:n,turnIndex:i,isActivelyStreaming:r,shouldHideContent:o,showEditButton:a=!1,onEnterEdit:l,isEmpty:d,prevGroupedMessageType:u,prevGroupedMessages:m,messages:p,citations:k,contentReferences:y,size:S,isUserTurn:C,parts:N,attachments:P}){const W=gn(),K=Il(t),[M,R]=D.useState({}),[H,F]=D.useState(!1),_=Nl(),{streamingContext:L}=_l();D.useEffect(()=>{_&&(L.setOnStylesUpdatedCallback(R),L.onStreamingChanged(n),L.setOnResetCallback(()=>F(!1)),n&&(F(!0),R(L.createTopLevelStyles())))},[_,n,L]);const ie=Ol(),le=p[0].message.metadata?.gizmo_id,Re=p[0].message.metadata?.serialization_metadata,Me=Ed(p[0].message).length,Le=D.useMemo(()=>({clientThreadId:s,messageId:e,turnIndex:i}),[s,e,i]),Ne=Dl(p[0].message),_e=!!le&&ie.includes(le),Ae=D.useCallback(re=>{rd.open(re,Le)},[Le]),v=x.jsx(sp,{parts:N,attachments:P,isUserTurn:C,clientThreadId:s},"files-and-tables"),I=!!(P?.length||t.some(re=>re.type==="images"));function U(re,he){const j=u===B.CodeInterpreter?m?.map(wt=>wt.message):void 0,{text:te,contentReferences:ce}=Al(he,k,y,_e),{processedText:V,displayedContentReferences:Je}=vl(te,ce,r?void 0:j);return x.jsx(Bl.Provider,{value:{analyticsMetadata:Le,message:p[0].message,contentReferences:Je,onShowSearchResults:Ae,numImageResults:Me,isActivelyStreaming:r,useSafeUrls:!0},children:x.jsx(Hs,{clientThreadId:s,messageId:e,isStreamingOrProcessing:H,size:S,className:ee(r&&!_&&"result-streaming",Ne&&"headers-v2"),children:V===""?"&#8203;":V})},re)}const $=t.map((re,he)=>{if(re.type==="transcription"){const j=o?null:re.text;let te=null;if(C&&o)te=x.jsx("span",{className:"italic opacity-30",children:x.jsx(oe,{...In.contentRemoved})});else if(C&&j!=null)te=j.trim().length===0?x.jsx("span",{className:"italic opacity-30",children:x.jsx(ns,{text:W.formatMessage(In.transcriptUnavailable),customSymbolOffsets:void 0})}):x.jsx("span",{className:"italic opacity-65",children:x.jsx(ns,{text:`${j.trim()}`,customSymbolOffsets:void 0})});else if(!C&&j!=null)return U(he,j);return x.jsx(ss,{containsImagesOrAttachments:I,isUserTurn:C,showEditButton:a,onEnterEdit:l,children:te},he)}else if(re.type==="text"){const j=o?null:re.text;return!d&&!o&&!C?U(he,K):d&&r&&!C?_?x.jsx("div",{className:"pulsing-dot"},he):x.jsx("div",{className:"result-streaming",children:x.jsx("span",{children:x.jsx("pre",{})})},he):x.jsx(ss,{containsImagesOrAttachments:I,isUserTurn:C,showEditButton:a,onEnterEdit:l,children:C&&o?x.jsx("span",{className:"italic opacity-30",children:x.jsx(oe,{...In.contentRemoved})}):j?x.jsx(ns,{text:j,customSymbolOffsets:Re?.custom_symbol_offsets}):null},he)}else if(re.type==="images"){const j=p[0].message.metadata?.attachments??[];return x.jsx(Rl,{assets:re.imageAssets,attachments:j},he)}else return null}),We=t.findIndex(re=>re.type==="text");if(We!==-1?$.splice(We,0,v):$.push(v),o&&C)$.length=0,$.push(x.jsx(ss,{containsImagesOrAttachments:I,isUserTurn:C,onEnterEdit:ws,children:x.jsx("span",{className:"italic opacity-30",children:x.jsx(oe,{...In.contentRemoved})})}));else if(o&&!C)return null;return x.jsx("div",{className:ee("flex w-full flex-col gap-1 empty:hidden",C&&"items-end rtl:items-start",!C&&"first:pt-[3px]",H&&"streaming-response"),style:M,children:$})}const In=Ks({contentRemoved:{id:"textMessage.contentRemoved",defaultMessage:"Content removed"},transcriptUnavailable:{id:"textMessage.transcriptUnavailable",defaultMessage:"Transcript Unavailable"}});function dp(s){const{isActivelyStreaming:e,...t}=s,n=vc(),i=n?.includes("debug")??!1,r=s.messages[s.messages.length-1].message.id,[o,a]=D.useState([]),l=D.useRef(void 0);return l.current===void 0&&(l.current=n?.includes(Bc)??!1?new Fl(s.parts,a,e,void 0,{debug:i}):new Pl(s.parts,a,e)),D.useEffect(()=>{l.current!=null&&(l.current.onMessagePartsUpdated(s.parts,e),l.current.isBuffering()&&en.addDelayedRenderingMessage(r))},[s.parts,r,e]),D.useEffect(()=>{l.current!=null&&!l.current.isBuffering()&&en.removeDelayedRenderingMessage(r)},[o,r]),D.useEffect(()=>()=>en.removeDelayedRenderingMessage(r),[r]),D.useEffect(()=>()=>{l.current!=null&&(l.current.destroy(),l.current=void 0)},[]),x.jsx(ba,{...t,displayParts:o,isActivelyStreaming:e||l.current?.isBuffering()})}function hp({message:s,isCompletionInProgress:e,clientThreadId:t,className:n,isUserTurn:i,turnIndex:r,isFeedbackEnabled:o,prevGroupedMessageType:a,prevGroupedMessages:l,showEditButton:d,onEnterEdit:u,onRequestMoreCompletions:m}){const p=D.useMemo(()=>"parts"in s.message.content?s.message.content.parts:[qr(s.message)],[s]);return x.jsx(fp,{parts:p,messages:[s],isCompletionInProgress:e,className:n,citations:s.message.metadata?.citations,contentReferences:s.message.metadata?.content_references,attachments:s.message.metadata?.attachments,isUserTurn:i,turnIndex:r,id:s.nodeId,isFeedbackEnabled:o,onRequestMoreCompletions:m,clientThreadId:t,showEditButton:d,onEnterEdit:u,prevGroupedMessageType:a,prevGroupedMessages:l})}const up=Fc.memo(hp);function fp(s){const e=s.messages.length>1,{flagSeverity:t}=di(e?void 0:s.messages[0]),n=t!=="danger"&&s.isCompletionInProgress,i=!s.parts.some(o=>o!==""),[r]=D.useState(()=>!s.isUserTurn&&(s.isCompletionInProgress||i));return r?x.jsx(dp,{...s,isActivelyStreaming:n}):x.jsx(ba,{...s,displayParts:Ll({isUserTurn:s.isUserTurn,parts:s.parts}),isActivelyStreaming:n})}const pp=xe(()=>fe(()=>import("./kv175rft89ldqzz5.js"),__vite__mapDeps([39,1,2,3])));function Sa({animationData:s,animationSegmentToPlay:e,animationLoopCounter:t}){const n=D.useRef(null);return D.useEffect(()=>{n.current?.playSegments(e,!0)},[t]),x.jsx(pp,{animationData:s,lottieRef:n,loop:!1,autoplay:!1})}function mp(s){return x.jsx(Zs,{width:"8",height:"9",viewBox:"0 0 8 9",fill:"none",...s,children:x.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M7.66607 0.376042C8.01072 0.605806 8.10385 1.07146 7.87408 1.4161L3.54075 7.9161C3.40573 8.11863 3.18083 8.24304 2.93752 8.24979C2.69421 8.25654 2.46275 8.1448 2.31671 7.95008L0.150044 5.06119C-0.098484 4.72982 -0.0313267 4.25972 0.300044 4.01119C0.631415 3.76266 1.10152 3.82982 1.35004 4.16119L2.88068 6.20204L6.62601 0.584055C6.85577 0.239408 7.32142 0.146278 7.66607 0.376042Z",fill:"currentColor"})})}function gp(s){return x.jsxs(Zs,{width:"4",height:"12",viewBox:"0 0 4 12",fill:"none",...s,children:[x.jsx("mask",{id:"path-1-inside-1_1975_4008",fill:"currentColor",children:x.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M1 6.5C1 7.05228 1.44772 7.5 2 7.5C2.55228 7.5 3 7.05228 3 6.5V1.5C3 0.947715 2.55228 0.5 2 0.5C1.44772 0.5 1 0.947715 1 1.5L1 6.5ZM0.75 10.25C0.75 10.9404 1.30964 11.5 2 11.5C2.69036 11.5 3.25 10.9404 3.25 10.25C3.25 9.55964 2.69036 9 2 9C1.30964 9 0.75 9.55964 0.75 10.25Z"})}),x.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M1 6.5C1 7.05228 1.44772 7.5 2 7.5C2.55228 7.5 3 7.05228 3 6.5V1.5C3 0.947715 2.55228 0.5 2 0.5C1.44772 0.5 1 0.947715 1 1.5L1 6.5ZM0.75 10.25C0.75 10.9404 1.30964 11.5 2 11.5C2.69036 11.5 3.25 10.9404 3.25 10.25C3.25 9.55964 2.69036 9 2 9C1.30964 9 0.75 9.55964 0.75 10.25Z",fill:"currentColor"}),x.jsx("path",{d:"M1 6.5H-0.25H1ZM1 1.5L-0.25 1.5L-0.25 1.5L1 1.5ZM2 6.25C2.13807 6.25 2.25 6.36193 2.25 6.5H-0.25C-0.25 7.74264 0.757359 8.75 2 8.75V6.25ZM1.75 6.5C1.75 6.36193 1.86193 6.25 2 6.25V8.75C3.24264 8.75 4.25 7.74264 4.25 6.5H1.75ZM1.75 1.5V6.5H4.25V1.5H1.75ZM2 1.75C1.86193 1.75 1.75 1.63807 1.75 1.5H4.25C4.25 0.257359 3.24264 -0.75 2 -0.75V1.75ZM2.25 1.5C2.25 1.63807 2.13807 1.75 2 1.75V-0.75C0.757359 -0.75 -0.25 0.257359 -0.25 1.5L2.25 1.5ZM2.25 6.5L2.25 1.5L-0.25 1.5L-0.25 6.5L2.25 6.5ZM2 10.25H-0.5C-0.5 11.6307 0.619288 12.75 2 12.75V10.25ZM2 10.25V12.75C3.38071 12.75 4.5 11.6307 4.5 10.25H2ZM2 10.25H2H4.5C4.5 8.86929 3.38071 7.75 2 7.75V10.25ZM2 10.25H2V7.75C0.619288 7.75 -0.5 8.86929 -0.5 10.25H2Z",fill:"currentColor",mask:"url(#path-1-inside-1_1975_4008)"})]})}function yp(s){return x.jsx(Zs,{width:"8",height:"9",viewBox:"0 0 8 9",fill:"none",...s,children:x.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M7.32256 1.48447C7.59011 1.16827 7.55068 0.695034 7.23447 0.427476C6.91827 0.159918 6.44503 0.199354 6.17748 0.515559L4.00002 3.08892L1.82256 0.515559C1.555 0.199354 1.08176 0.159918 0.765559 0.427476C0.449355 0.695034 0.409918 1.16827 0.677476 1.48447L3.01755 4.25002L0.677476 7.01556C0.409918 7.33176 0.449354 7.805 0.765559 8.07256C1.08176 8.34011 1.555 8.30068 1.82256 7.98447L4.00002 5.41111L6.17748 7.98447C6.44503 8.30068 6.91827 8.34011 7.23447 8.07256C7.55068 7.805 7.59011 7.33176 7.32256 7.01556L4.98248 4.25002L7.32256 1.48447Z",fill:"currentColor"})})}function Gm({animationLoopCounter:s}){const{resolvedTheme:e}=Hn(),t=e==="dark";return x.jsx(Sa,{animationData:t?zl:jl,animationSegmentToPlay:[0,300],animationLoopCounter:s})}function Km({animationLoopCounter:s}){const{resolvedTheme:e}=Hn(),t=e==="dark";return x.jsx(Sa,{animationData:t?Vl:Ul,animationSegmentToPlay:[0,400],animationLoopCounter:s})}const xp=2e3,wa=.4,kp=.45,bp=.2,Sp=.1,wp=.25;var Fe=(s=>(s[s.Running=0]="Running",s[s.Finished=1]="Finished",s[s.Error=2]="Error",s[s.Stopped=3]="Stopped",s[s.Paused=4]="Paused",s))(Fe||{});function Ym({conversationMessages:s,icon:e,status:t,text:n,estimatedToolDurationMs:i,animationLoopDurationMs:r=xp,shouldPersistAfterFinished:o=!1}){const[a,l]=D.useState(t===0?0:t===1&&!o?7:1),[d,u]=D.useState(0);D.useEffect(()=>{t===2?l(8):t===3?l(9):t===4?l(10):t===1?l(a===2?3:7):t===0&&a===10&&(l(2),u(p=>p+1))},[t]);const m=Mp(a);return D.useEffect(()=>{const p=s[0].message.id;if(m)return en.addDelayedRenderingMessage(p),()=>{en.removeDelayedRenderingMessage(p)}},[m]),Wr(()=>{qt(a)&&u(p=>p+1)},r),a===7&&!o?null:x.jsxs("div",{className:"my-2.5 flex items-center gap-2.5",children:[x.jsx(Cp,{icon:e,status:t,uiState:a,estimatedToolDurationMs:i,animationLoopCounter:d,shouldPersistAfterFinished:o,onFillProgressBarAnimationComplete:()=>l(4),onFinishAnimationComplete:()=>{l(5),setTimeout(()=>{l(o?7:6)},Sp*1e3)},onHideAnimationComplete:()=>l(7)}),x.jsx(Tp,{text:n,uiState:a,animationLoopCounter:d,onEnterAnimationComplete:()=>l(2)})]})}const Ir=50;function Cp({icon:s,status:e,uiState:t,estimatedToolDurationMs:n,animationLoopCounter:i,shouldPersistAfterFinished:r,onFillProgressBarAnimationComplete:o,onFinishAnimationComplete:a,onHideAnimationComplete:l}){const[d,u]=D.useState(0);Wr(()=>{qt(t)?u(P=>P+Ir):t===10&&u(0)},Ir);let m,p,k;qt(t)||t===10?(m="running",p=x.jsx(s,{animationLoopCounter:i}),k="bg-transparent"):t===4||t===5||t===7&&r?(m="finished",p=x.jsx(mp,{}),k="bg-brand-purple"):e===2?(m="error",p=x.jsx(gp,{}),k="bg-orange-500"):e===3&&(m="stopped",p=x.jsx(yp,{}),k="bg-gray-300");let y={opacity:0,scale:0,rotate:-180,x:0},S={type:"spring",bounce:.3,duration:kp},C={opacity:0,scale:.6,rotate:0,x:0};t===0?(y={opacity:0,scale:.5,rotate:-180,x:-8},S={type:"spring",bounce:.3,duration:wa}):t===1?y=!1:t===5&&(C={opacity:0,scale:0,rotate:0,x:0},S={type:"spring",bounce:.3,duration:wp});const N=rp(d,n);return x.jsx("div",{className:"relative h-5 w-5 shrink-0",children:x.jsx(Rn,{onExitComplete:()=>{t===6&&l()},children:m!=null&&x.jsxs(gt.div,{className:ee("absolute left-0 top-0 flex h-full w-full items-center justify-center rounded-full text-white",k),initial:y,animate:{opacity:1,scale:1,rotate:0,x:0},exit:C,transition:S,onAnimationComplete:()=>{t===4&&a()},children:[p,(qt(t)||t===10)&&x.jsx(ql,{percentage:t===3?100:N,thickness:1.5/23,className:"absolute left-1/2 top-1/2 h-[23px] w-[23px] -translate-x-1/2 -translate-y-1/2 text-brand-purple",backgroundStrokeClassName:"stroke-brand-purple/25 dark:stroke-brand-purple/50",transitionDuration:t===3?`${(100-N)/100*bp}s`:void 0,transitionTimingFunction:t===3?"cubic-bezier(0.55, 0, 1, 1)":void 0,onTransitionEnd:()=>{t===3&&o()}})]},m)})})}function Tp({text:s,uiState:e,animationLoopCounter:t,onEnterAnimationComplete:n}){const[i,r]=D.useState(s);D.useEffect(()=>{e===2&&r(s)},[t]),D.useEffect(()=>{qt(e)||r(s)},[e,s]);let o={opacity:0,x:0,y:15},a={type:"spring",bounce:.3,opacity:{duration:.15},y:{duration:.3}};e===0?(o={opacity:0,x:-8,y:0},a={type:"spring",bounce:.3,duration:wa,delay:.15}):e===1&&(o=!1);const l=i??void 0;return x.jsx("div",{className:ee("relative h-5 w-full leading-5",e===8||e===9?"text-token-text-tertiary":"text-token-text-secondary"),children:x.jsx(Rn,{children:l!=null&&x.jsx(gt.div,{className:"absolute left-0 top-0 line-clamp-1 overflow-visible",initial:o,animate:{opacity:1,x:0,y:0},exit:{opacity:0,x:0,y:-15},transition:a,onAnimationComplete:()=>{e===0&&n()},children:l},l.toString())})})}function qt(s){return s===0||s===2||s===3}function Mp(s){return qt(s)||s===4||s===5||s===6||s===10}const Nr=bt.div`group absolute left-0 top-0 mr-1.5 h-8 overflow-hidden mt-1`;function ui({highlightedCommand:s,status:e,children:t,showWorkUserSetting:n=!1,hideOnlyIfNotInteractedWith:i=!1,onOpenAnalytics:r}){const o=t!=null,[a]=D.useState(n),[l,d]=D.useState(n),[u,m]=D.useState(!1),p=e===Fe.Finished||e===Fe.Error,k=i?a?!1:!u:!1,y=e===Fe.Running&&"loading-shimmer";return p&&k?null:o?x.jsxs(x.Fragment,{children:[x.jsx(_r,{$canShowWork:!0,children:x.jsx(Rn,{children:x.jsx(Nr,{children:x.jsx(gt.button,{onClick:()=>{l||r?.(),d(S=>!S),m(!0)},initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},className:ee(y),children:x.jsxs("div",{className:"flex items-center justify-start gap-1",children:[x.jsx("span",{children:s}),l?x.jsx(hd,{className:"icon-md"}):x.jsx(ud,{className:"icon-md"})]})},s?.toString())})})}),x.jsx(Rn,{children:l&&t&&x.jsx(gt.div,{initial:"collapsed",animate:"reveal",exit:"collapsed",variants:{collapsed:{translateY:-20,opacity:0,height:0},reveal:{translateY:0,opacity:1,height:"auto"}},transition:{duration:.3,ease:"easeInOut"},className:"overflow-hidden",children:t})})]}):x.jsx(_r,{$canShowWork:!1,children:x.jsx(Nr,{className:ee(y),children:s})})}const _r=bt.p`first:mt-0 relative h-8
${({$canShowWork:s})=>s?"text-token-text-secondary hover:text-token-text-primary my-1.5":"text-token-text-secondary"}`,Or=xe(()=>fe(()=>import("./lp55fc5ebs62yb4c.js").then(s=>s.A),__vite__mapDeps([33,1,2,3,5,6,7,16,22,23,34,35,36,37,18,38])).then(s=>s.default));function Ep({messages:s,isRequestActive:e,clientThreadId:t}){const[n,i]=s,r=ka(n.message),o=i?.message.metadata?.aggregate_result,a=Yf(),l=hi(),d=i?.message?ya(i.message):[],u=i?.message.metadata?.aggregate_result?.messages.filter(no)??[],p=(d.filter(S=>S.type==="chart")??[]).length!==u.length,k=l&&!p;let y=Fe.Running;return o?.status==="success"?y=Fe.Finished:i!=null&&i.message.content.content_type!==$n.ExecutionOutput||o!=null&&o.status!=="running"?y=Fe.Error:(r||!e)&&(y=Fe.Stopped),x.jsxs(x.Fragment,{children:[x.jsx(Ip,{messages:s,status:y,isRequestActive:e}),k&&d.map((S,C)=>{const{type:N}=S;return N==="chart"&&!a?(S.fallback_to_image=!0,x.jsx(Dr,{children:x.jsx(Or,{clientThreadId:t,visualization:S})},C)):x.jsx(Dr,{children:x.jsx(Or,{clientThreadId:t,visualization:S})},C)}),!k&&i!=null&&x.jsx(Od,{message:i.message})]})}const Dr=bt.div`mb-3 max-w-[80%]`;function Ip({messages:s,status:e,isRequestActive:t}){const[n,i]=s,r=gn(),o=i?.message.metadata?.aggregate_result,a=ka(n.message),{data:l,error:d}=Pc(Lc.ShowExpandedCodeView);let u=r.formatMessage({id:"message.tools.data-analysis.running",defaultMessage:"Analyzing"});if(o?.status==="success"?u=r.formatMessage({id:"message.tools.data-analysis.finished",defaultMessage:"Analyzed"}):i!=null&&i.message.content.content_type!==$n.ExecutionOutput||o!=null&&o.status!=="running"?u=r.formatMessage({id:"message.tools.data-analysis.error",defaultMessage:"Analysis errored"}):(a||!t)&&(u=r.formatMessage({id:"message.tools.data-analysis.stopped",defaultMessage:"Analysis paused"})),l!==void 0||d){const m=Dd(n.message)!=null;return x.jsx(ui,{status:e,highlightedCommand:u,showWorkUserSetting:l??!1,hideOnlyIfNotInteractedWith:!0,children:m?x.jsxs("div",{className:"mb-3 mt-0.5 overflow-hidden rounded-xl bg-black",children:[x.jsx(Rd,{message:n.message,FormattedText:Hs}),i!=null&&x.jsx(Ad,{message:i.message})]}):null})}return null}const Np=3,_p=.1,Rr=[0,.26,.4];function Op({nextMessage:s,isLastMessage:e,isRequestActive:t}){let n=e||!s||s&&!Jr(s.message);const i=Id(s?.message),r=Wl(i.slice(0,Np).map(o=>o.entries[0].url));if(n){const o=t?x.jsxs("div",{className:"flex items-center gap-1",children:[r.map((a,l)=>x.jsx(gt.div,{className:"-ml-1.5 first:ml-0 last:mr-1.5",initial:{width:l===0?0:6,opacity:0},animate:{width:20,opacity:1},transition:{duration:_p,delay:Rr[Math.min(l,Rr.length-1)]},children:x.jsx("div",{className:ee("flex h-5 w-5 items-center overflow-hidden rounded","border-l-2 border-token-main-surface-primary bg-token-main-surface-primary"),children:x.jsx(Jl,{url:a,size:32,minSize:16,className:"icon-md rounded"})})},a)),x.jsx(oe,{id:"jjx8Qg",defaultMessage:"Searching the web"})]}):x.jsx(oe,{id:"fssXGM",defaultMessage:"Error while searching"});return x.jsx(ui,{highlightedCommand:o,status:t?Fe.Running:Fe.Error})}return null}const Dp={strong:s=>{const{node:e,children:t,...n}=s;return x.jsx("strong",{...n,className:ee(n.className,"font-semibold text-token-text-primary"),children:t})},p:s=>{const{node:e,children:t,...n}=s;return x.jsx("p",{...n,className:ee(n.className,"text-base","has-[strong]:mb-1 [&:not(:first-child)]:has-[strong]:mt-3 [&:not(:has(strong))]:mb-3"),children:t})}};function Rp({messages:s,isStreaming:e,clientThreadId:t}){const[n,i]=D.useState(""),[r,o]=D.useState(!1),a=s[0].message,l=a.id,d=A.getServerThreadId(t),u=qr(a);D.useEffect(()=>{const k=/\*\*(.*?)(?:\*\*|\n|$)/g;let y,S="";for(;(y=k.exec(u))!=null;)S=y[1].trim();S?i(S):a.metadata?.initial_text!=null&&i(a.metadata.initial_text)},[u,a.metadata?.initial_text]),D.useEffect(()=>{u.length>0&&o(!0)},[u]);const m=D.useMemo(()=>({client_thread_id:t,message_id:l,conversationId:d}),[t,l,d]);D.useEffect(()=>{r&&Ve.logEvent(be.receivedA8KM123Message,m)},[r]);const p=D.useCallback(()=>{Ve.logEvent(be.openedA8KM123Message,{...m,isStreaming:e})},[m,e]);return x.jsx(ui,{status:e?Fe.Running:Fe.Finished,highlightedCommand:e?n:a.metadata?.finished_text??"",onOpenAnalytics:p,children:r?x.jsx("div",{className:"mb-4 border-l-2 pl-4 dark:border-token-text-secondary",children:x.jsx(Hs,{componentOverrides:Dp,className:"not-prose leading-6",children:u})}):null})}const Ap=xe(()=>fe(()=>import("./sso-f0swi54hbsvjzm3m.js").then(s=>s.J),__vite__mapDeps([40,1,2,3,19,5,6,20,16,7,15,41,22,42,43,44,45,46,14,47,18,48,49,50,51,52,53,54,55,56,12,57,58,25,59,60,61,62,63,64,30,10,65,66,67,24,68,69,70,71,72,17,21,73,74,75,76,77,78,79,80,81,82,83,84,85,36,37])).then(s=>s.JawboneMessage).catch(()=>Uf)),vp=xe(()=>fe(()=>import("./lxwugeehor07hyeg.js"),__vite__mapDeps([86,1,2,3,5,6,14,7,15,16,17,18,19,20,21,22,23,24,25]))),Bp=xe(()=>fe(()=>import("./feps4vvtkwo000m7.js"),__vite__mapDeps([87,1,2,3,5,6]))),Fp=xe(()=>fe(()=>import("./d5u8oyxsu6wbgulx.js"),__vite__mapDeps([88,1,2,3,5,6,14,7,15,16,17,18,19,20,21,22,23,24,25]))),Pp=xe(()=>fe(()=>import("./n9ztwy2lchvj2ihs.js"),__vite__mapDeps([89,1,2,3,5,6,16,7])).then(s=>s.TextMessageEditor)),Lp=xe(()=>fe(()=>import("./ft25cbv8dllh581k.js"),__vite__mapDeps([90,1,2,3,5,6,7,70,16,14,15,17,18,19,20,21,22,23,24,25]))),zp=xe(()=>fe(()=>import("./ki6571k8kw909eiw.js"),__vite__mapDeps([91,1,2,3,5,6,14,7,15,16,17,18,19,20,21,22,23,24,25]))),jp=xe(()=>fe(()=>import("./dq6qjj77dn032g1y.js"),__vite__mapDeps([92,1,2,3,5,6,15,16,7,52,14,17,18,19,20,21,22,23,24,25])).then(s=>s.BrowsingMessage)),Vp=xe(()=>fe(()=>import("./bge05gsnwxenyn06.js"),__vite__mapDeps([93,1,2,3,5,6,14,7,15,16,17,18,19,20,21,22,23,24,25])).then(s=>s.SearchResultMessage)),Up=xe(()=>fe(()=>import("./jpiumua1mqiifglp.js"),__vite__mapDeps([94,1,2,3,5,6,15,16,7,66,67])).then(s=>s.GizmoContactsMessage)),qp=xe(()=>fe(()=>import("./m1hdun6boxotqa0o.js"),__vite__mapDeps([95,1,2,3,5,6,15,16,7,14,17,18,19,20,21,22,23,24,25])).then(s=>s.JITPluginMessage));function Zm(s){switch(s.type){case B.Text:case B.Debug:return[s.message];case B.MultiText:case B.Browsing:case B.CodeInterpreter:case B.JITPlugin:case B.RetrievalBrowsing:case B.ParallelBrowsing:case B.Dalle:case B.GizmoEditor:case B.SearchResult:case B.GizmoContacts:case B.a8km123:case B.f959b8c:case B.Canmore:case B.Jawbone:case B.SearchGPTQuery:return s.messages;default:throw new Error("Bad")}}function Qm({groupedMessagesToRender:s,allGroupedMessages:e,clientThreadId:t,isEditing:n,isUserTurn:i,isCompletionRequestInProgress:r,isFeedbackEnabled:o,isFinalTurn:a,turnIndex:l,hasActiveRequest:d,showEditButton:u=!1,handleEnterEdit:m,handleExitEdit:p,onChangeItemInView:k,onRequestMoreCompletions:y,onRequestCompletion:S,shouldGrowContainer:C=!0}){const{showDebugConversationTurns:N}=Hl(),P=Qs(t),W=e.some(M=>$l.includes(M.type)),K=s.map((M,R)=>{const H=R===e.length-1;switch(M.type){case B.Text:case B.MultiText:{const F=s[R-1],_=F?.type,L=F&&"messages"in F?F.messages:void 0;if(M.type===B.Text){const ie=M?.message&&!Jr(M.message.message),Re=n?x.jsx(Pp,{message:M.message,clientThreadId:t,onChangeItemInView:k,onRequestCompletion:S,onRequestMoreCompletions:y,onExitEdit:p,disabled:d}):W&&ie?null:x.jsx(up,{className:"min-h-8",message:M.message,isFeedbackEnabled:o,isCompletionInProgress:H&&r,turnIndex:l,clientThreadId:t,showEditButton:u,onEnterEdit:m,isUserTurn:i,onRequestMoreCompletions:y,prevGroupedMessageType:_,prevGroupedMessages:L});return x.jsxs(D.Fragment,{children:[Re,x.jsx(Gl,{isUserTurn:i,message:M.message.message})]},"group-"+M.message.nodeId)}else return M.type===B.MultiText?x.jsx(Fp,{clientThreadId:t,messages:M.messages,isCompletionInProgress:H&&r,isFeedbackEnabled:o,onRequestMoreCompletions:y,prevGroupedMessageType:_,prevGroupedMessages:L},"multitext-"+(M.messages[0]?.nodeId??R)):M.type}case B.Browsing:case B.RetrievalBrowsing:{const F=P!=null&&[Be.GizmoInteraction,Be.GizmoMagicCreate,Be.GizmoTest].includes(P.kind);return x.jsx(jp,{messages:M.messages,isRequestActive:d,isLastMessageInTurn:H,isUsingGizmo:F,isRetrieval:M.type===B.RetrievalBrowsing},"browsing-"+(M.messages[0]?.nodeId??R))}case B.SearchGPTQuery:{const F=e[R+1];return x.jsx(Op,{isRequestActive:d,isLastMessage:H,nextMessage:F&&F.type===B.Text?F.message:void 0},"searchquery-"+(M.messages[0]?.nodeId??R))}case B.a8km123:return x.jsx(Rp,{messages:M.messages,isStreaming:H&&r,clientThreadId:t},"sum-"+(M.messages[0]?.nodeId??R));case B.f959b8c:return null;case B.Jawbone:{const F=R+1<e.length?e[R+1]:void 0;return x.jsx(Ap,{nextMessage:F&&F.type===B.Text?F.message:void 0,isLastMessage:H,isRequestActive:d},"jawbone-"+(M.messages[0]?.nodeId??R))}case B.ParallelBrowsing:return x.jsx(zp,{messages:M.messages},"parallel-"+(M.messages[0]?.nodeId??R));case B.CodeInterpreter:return x.jsx(Ep,{messages:M.messages,isRequestActive:d,clientThreadId:t},"ada-"+(M.messages[0]?.nodeId??R));case B.JITPlugin:return x.jsx(qp,{messages:M.messages,clientThreadId:t,isLastTurnInConversation:a,onRequestCompletion:S},"jit-"+(M.messages[0]?.nodeId??R));case B.GizmoContacts:return x.jsx(Up,{messages:M.messages,clientThreadId:t,isLastTurnInConversation:a,onRequestCompletion:S},"gizmo-contacts-"+(M.messages[0]?.nodeId??R));case B.Dalle:return x.jsx(Lp,{messages:M.messages,clientThreadId:t},"dalle-"+(M.messages[0]?.nodeId??R));case B.GizmoEditor:return x.jsx(vp,{messages:M.messages},"gizmo-editor-"+(M.messages[0]?.nodeId??R));case B.Canmore:return x.jsx(Pf,{messages:M.messages,isRequestActive:d},"canmore-"+(M.messages[0]?.nodeId??R));case B.Debug:return N?x.jsx(Bp,{message:M.message},"debug-"+M.message.nodeId):null;case B.SearchResult:return x.jsx(Vp,{messages:M.messages},"search-result-"+(M.messages[0]?.nodeId??R))}});return x.jsx(Jp,{shouldGrowContainer:C,children:K})}function Wp(){return x.jsx(Kl,{type:"danger",children:x.jsx(oe,{id:"daIg0P",defaultMessage:"Unable to display this message due to a error."})})}function Jp({children:s,shouldGrowContainer:e}){return x.jsx("div",{className:ee({"flex max-w-full flex-col":!0,"flex-grow":e}),children:x.jsx(zc,{name:"GroupedMessages",fallback:Wp,children:s})})}function Hp(s){return s==null||[Be.PrimaryAssistant,Be.GizmoInteraction].includes(s.kind)}function Xm(s,e){const t=Qs(s,e),{data:n}=Sd(t!=null&&"gizmo_id"in t?t.gizmo_id:void 0,t?.kind===Be.GizmoTest);if(t!=null)switch(t.kind){case Be.GizmoInteraction:case Be.GizmoMagicCreate:case Be.GizmoTest:return{gizmo:n,...t};case Be.PrimaryAssistant:return t}}function $p(s,e,t){const i=A.getTree(e).getMessageId(A.getThreadCurrentLeafId(e));rt.generateTitle(e,i,t).then(({title:r})=>{A.setTitle(e,r,to.Generated),so(s),Ve.logEvent(be.renameThread,{threadId:e,content:r,model:t})}).catch(Se.addError)}function eg(s,e,t){const n=()=>{const r=Ii(t);s(r)},i=Es.getGizmoId(t);i!=null?wd(e,i).then(r=>{Yl(Ii(t,r))}).catch(r=>{Se.addError(r),n()}):n()}const qs={onCreate(s,e,t,n){Ve.logEvent(be.newThread),!n&&Hp(Es.getConversationMode(e))&&jc(t).then(i=>{Qr(i)||(so(t),s(e))})},onCreateFinished(s,e,t){if(!(t||!e)&&!ln.checkGate("2562876640")){const n=Es.getThread(e)?.initialThreadData.lastModelUsed;n==null&&Se.addError("missing lastModelUsed on conversation create finished"),$p(s,e,n)}}};function Ar(s,e){s.updateNodeMetadata(e.id,{completionSampleFinishTime:Date.now()})}class Gp{constructor(e,t,n,i,r,o,a,l,d,u,m,p){this.queryClient=e,this.clientThreadId=t,this.targetNodeId=n,this.completionType=i,this.model=r,this.eventSource=o,this.onCreate=a,this.callModelAgain=d,this.onCompletionFinished=u,this.isHistoryAndTrainingDisabled=p,this.currentTree=A.getTree(t),this.currentNodeId=n,this.activeBranchLastMessage=this.currentTree.getMessage(this.currentNodeId),this.completionLatencyTracker=new Zl(l),this.turnTracker=m,this.turnTracker.onCompletionStarted(i,this.model)}currentTree;currentNodeId;firstResponse=!0;didCreateFirstCompletionInNewThread=!1;activeBranchLastMessage;messagesToUpdate={};allIncompleteStreamedMessages={};responseThreadId;isCompletionBlocked=!1;isEitherFlagged=!1;variantsInStreamInfo;activeBranchNodeId;blurDuringCompletionTracker=new Ql;completionLatencyTracker;turnTracker;debouncedUpdateCompletion=Xl(()=>{this.isCompletionBlocked||A.updateTree(this.clientThreadId,e=>{Object.values(this.messagesToUpdate).forEach(t=>{e.updateNodeMessage(t.id,t)})}),this.messagesToUpdate={}},50,{leading:!0,maxWait:50});handleResponse=async e=>{if(e.type!=="done"&&this.turnTracker.onUpdateEventCount(),this.completionLatencyTracker.onResponse(e,this.activeBranchLastMessage,this.responseThreadId),this.responseThreadId===void 0&&"conversationId"in e){const t=e.conversationId;this.responseThreadId=t,Xs(this.clientThreadId)&&A.getServerThreadId(this.clientThreadId)!==t&&(A.setServerIdForNewThread(this.clientThreadId,t),Ve.logEvent(be.attributeClientThreadToServerThread,{client_thread_id:this.clientThreadId,server_thread_id:t}))}switch(e.type){case"error":this.handleError(e);break;case"num_variants_in_stream":this.bindVariantInfoToTree(e);break;case"moderation":this.handleModeration(e);break;case"url_moderation":this.handleUrlModeration(e);break;case"message":this.handleMessage(e),this.debouncedUpdateCompletion();break;case"done":this.handleDone();break;case"gizmo_inline_review":this.handleGizmoInlineReview(e);break;case"title_generation":this.handleTitleGeneration(e);break;case"conversation_detail_metadata":this.handleConversationDetailMetadata(e);break}};handleError(e){const t=e.error,n=t?.message||"Something went wrong",i=t instanceof nt&&t.code||"",r=t instanceof nt&&t.status,o=t instanceof nt?t.canRetry:void 0;switch(this.turnTracker.handleRawError(n,r),A.updateTree(this.clientThreadId,a=>{a.updateNodeMessage(this.currentNodeId,this.activeBranchLastMessage),a.updateNodeMetadata(this.currentNodeId,{err:n,errType:"danger",errCode:i,completionSampleFinishTime:Date.now(),canRetry:o})}),i){case st.ContentPolicy:case st.ContentOrTos:case Ss:case Gr:break;default:n!==void 0&&ln.logEvent("chatgpt_conversation_error_web",n)}this.blurDuringCompletionTracker.onMessageError(),this.cleanUp(),this.onCompletionFinished(this.responseThreadId),t instanceof nt&&t?.code===Ss&&t?.clearsIn&&(ec(new Date(Date.now()+t.clearsIn*1e3).toISOString()),setTimeout(()=>{tc()},t.clearsIn*1e3))}handleGizmoInlineReview(e){A.setPromptGptRating(this.clientThreadId,e.gizmoId)}handleTitleGeneration(e){A.setTitle(this.clientThreadId,e.title,to.Generated)}handleConversationDetailMetadata(e){const{default_model_slug:t}=e;t&&A.setThreadModelId(this.clientThreadId,t),Cs.updateDetails(e)}bindVariantInfoToTree(e){this.variantsInStreamInfo=e,A.updateTree(this.clientThreadId,t=>{const n=t.getParentPromptNode(this.currentNodeId);t.updateNodeMetadata(n.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}handleModeration(e){const{isCompletion:t,messageId:n,conversationId:i,flagged:r,blocked:o,disclaimers:a,metadata:l}=e,d=!!a?.length&&t;(r||o||d)&&(this.isEitherFlagged=!0,o&&t&&(this.isCompletionBlocked=!0),A.updateTree(this.clientThreadId,u=>{const m=u.messageIdToNodeId(n);o&&u.clearNodeMessageParts(m),u.updateNodeMetadata(m,{...(d&&!!a?.length&&nc(a,o))??{},...r&&sc,...o&&(l?.model_incompatibility?ic:rc),completionSampleFinishTime:Date.now()})}),Ve.logEvent(t?o?be.completionBlockedByModeration:be.completionFlaggedByModeration:o?be.promptBlockedByModeration:be.promptFlaggedByModeration,{threadId:i,id:n}))}handleUrlModeration(e){const{conversationId:t,url:n,isSafe:i}=e;i&&A.addThreadSafeUrl(t,n)}handleMessage(e){let t=!0;const{message:n,conversationId:i}=e;if(this.turnTracker.onMessageUpdate(n.metadata?.model_slug,n.metadata?.gizmo_id,n.author.name,n.author.role),this.firstResponse&&!this.currentTree.hasReceivedServerCompletion){if(n?.author.role===dt.System){if((n.metadata?.parent_id?this.currentTree.getNodeByIdOrMessageId(n.metadata.parent_id):void 0)?.message.author.role!==dt.User){this.currentTree.appendSystemMessageToRoot(n);return}}else if(n?.author.role===dt.User)return;if(this.currentTree.hasNodeOrMessageId(n.id))return}if(this.firstResponse&&n.metadata?.rebase_system_message){A.updateTree(this.clientThreadId,r=>{if(n.metadata?.parent_id==null)throw Error("Unexpected rebased system message without parent");const o=r.getNodeByIdOrMessageId(this.targetNodeId);r.deleteNode(this.targetNodeId),r.addNode(n.id,n,n.metadata.parent_id,n.author.role),r.addNode(o.id,o.message,n.id,o.message.author.role)});return}if(this.firstResponse){const r=Bn.getState().threads[this.clientThreadId]?.continuingFromSharedConversationId!=null;A.removeContinuingFromSharedConversationId(this.clientThreadId),this.firstResponse=!1,this.didCreateFirstCompletionInNewThread=!this.currentTree.hasReceivedServerCompletion||r,A.updateTree(this.clientThreadId,a=>{a.updateNodeMessage(this.currentNodeId,n)}),this.didCreateFirstCompletionInNewThread&&qs.onCreate(this.onCreate,i,this.queryClient,this.isHistoryAndTrainingDisabled);const o={id:this.targetNodeId,threadId:i,completionType:this.completionType,eventSource:this.eventSource,model:this.model};if(this.completionType===tn.Next){const a=Bn.getState().threads[i],l=a?.conversationTurns?.length,d=a?.conversationTurns?.filter(m=>m.role==dt.User),u=d&&d[d.length-1]?.messages[0].message;if(u?.content.content_type==$n.Text){const m=u.content.parts.join("").length,p=d?.length??0;o.countConversationTurns=l,o.countUserSubmittedMessages=p,o.countLastUserPromptTextMessageLength=m}}Ve.logEvent(be.generateCompletion,o)}else if(this.completionType!==tn.Continue){const r=this.currentTree.containsNodeOrMessageId(n.id),o=n.metadata?.parent_id;if(r||(this.debouncedUpdateCompletion.flush(),A.updateTree(this.clientThreadId,a=>{if(o==null)throw new Error(`Received a message with no parentId: ${JSON.stringify(n)}`);a.addNode(n.id,n,o,dt.Assistant)})),o!=null&&o===this.activeBranchNodeId){const a=this.allIncompleteStreamedMessages[o];a!=null&&(A.updateTree(this.clientThreadId,l=>{Ar(l,a)}),delete this.allIncompleteStreamedMessages[o])}if(t=(this.variantsInStreamInfo?.num_variants_in_stream??1)===1||this.activeBranchNodeId==null||this.activeBranchNodeId===n.id||this.currentTree.isAncestorOfNode(this.activeBranchNodeId,n.id),t&&this.activeBranchNodeId!==n.id){this.activeBranchNodeId=n.id,this.currentNodeId=n.id;const a=A.getThreadCurrentLeafId(this.clientThreadId);this.currentTree.messageIdToNodeId(this.currentNodeId)!==this.currentTree.messageIdToNodeId(a)&&A.setThreadCurrentLeafId(this.clientThreadId,this.currentNodeId),o!=null&&A.updateTree(this.clientThreadId,l=>{const d=l.getParentPromptNode(n.id);l.updateNodeMetadata(d.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}}if(n?.author.role===dt.Tool&&n?.author.name==="bio"){const r=n.metadata?.gizmo_id;setTimeout(()=>{this.queryClient.invalidateQueries({queryKey:oc(r)})},5e3)}t&&(this.activeBranchLastMessage=n),this.messagesToUpdate[n.id]=n,this.allIncompleteStreamedMessages[n.id]=n}async handleDone(){if(this.turnTracker.model_message_update_count>0?this.turnTracker.logCompletion({type:An.Success}):this.turnTracker.logCompletion({type:An.Error,error:{reason:"empty_response",message:"Successful completion ended with no messages"}}),this.isCompletionBlocked||(this.debouncedUpdateCompletion.flush(),this.isEitherFlagged||(this.didCreateFirstCompletionInNewThread&&qs.onCreateFinished(this.queryClient,this.responseThreadId,this.isHistoryAndTrainingDisabled),this.onCompletionFinished(this.responseThreadId))),A.updateTree(this.clientThreadId,e=>{Object.values(this.allIncompleteStreamedMessages).forEach(t=>{Ar(e,t)})}),Hr.publish({kind:"createConversation",clientThreadId:this.clientThreadId}),this.blurDuringCompletionTracker.onMessageDone(),this.cleanUp(),this.activeBranchLastMessage?.metadata?.client_actions!==void 0){const e=await ac(this.clientThreadId,this.activeBranchLastMessage);e.length>0&&this.callModelAgain(this.currentNodeId,e)}}cleanUp(){setTimeout(()=>{vd(this.clientThreadId,Vc.FINISHED),$s.removeRequest(this.targetNodeId),A.releaseThread(this.clientThreadId)},0)}}/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(s){const e=lc,t=cc,n=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;s.Buffer=a,s.SlowBuffer=P,s.INSPECT_MAX_BYTES=50;const i=2147483647;s.kMaxLength=i,a.TYPED_ARRAY_SUPPORT=r(),!a.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function r(){try{const f=new Uint8Array(1),c={foo:function(){return 42}};return Object.setPrototypeOf(c,Uint8Array.prototype),Object.setPrototypeOf(f,c),f.foo()===42}catch{return!1}}Object.defineProperty(a.prototype,"parent",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.buffer}}),Object.defineProperty(a.prototype,"offset",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.byteOffset}});function o(f){if(f>i)throw new RangeError('The value "'+f+'" is invalid for option "size"');const c=new Uint8Array(f);return Object.setPrototypeOf(c,a.prototype),c}function a(f,c,h){if(typeof f=="number"){if(typeof c=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return m(f)}return l(f,c,h)}a.poolSize=8192;function l(f,c,h){if(typeof f=="string")return p(f,c);if(ArrayBuffer.isView(f))return y(f);if(f==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof f);if(He(f,ArrayBuffer)||f&&He(f.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(He(f,SharedArrayBuffer)||f&&He(f.buffer,SharedArrayBuffer)))return S(f,c,h);if(typeof f=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const g=f.valueOf&&f.valueOf();if(g!=null&&g!==f)return a.from(g,c,h);const b=C(f);if(b)return b;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof f[Symbol.toPrimitive]=="function")return a.from(f[Symbol.toPrimitive]("string"),c,h);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof f)}a.from=function(f,c,h){return l(f,c,h)},Object.setPrototypeOf(a.prototype,Uint8Array.prototype),Object.setPrototypeOf(a,Uint8Array);function d(f){if(typeof f!="number")throw new TypeError('"size" argument must be of type number');if(f<0)throw new RangeError('The value "'+f+'" is invalid for option "size"')}function u(f,c,h){return d(f),f<=0?o(f):c!==void 0?typeof h=="string"?o(f).fill(c,h):o(f).fill(c):o(f)}a.alloc=function(f,c,h){return u(f,c,h)};function m(f){return d(f),o(f<0?0:N(f)|0)}a.allocUnsafe=function(f){return m(f)},a.allocUnsafeSlow=function(f){return m(f)};function p(f,c){if((typeof c!="string"||c==="")&&(c="utf8"),!a.isEncoding(c))throw new TypeError("Unknown encoding: "+c);const h=W(f,c)|0;let g=o(h);const b=g.write(f,c);return b!==h&&(g=g.slice(0,b)),g}function k(f){const c=f.length<0?0:N(f.length)|0,h=o(c);for(let g=0;g<c;g+=1)h[g]=f[g]&255;return h}function y(f){if(He(f,Uint8Array)){const c=new Uint8Array(f);return S(c.buffer,c.byteOffset,c.byteLength)}return k(f)}function S(f,c,h){if(c<0||f.byteLength<c)throw new RangeError('"offset" is outside of buffer bounds');if(f.byteLength<c+(h||0))throw new RangeError('"length" is outside of buffer bounds');let g;return c===void 0&&h===void 0?g=new Uint8Array(f):h===void 0?g=new Uint8Array(f,c):g=new Uint8Array(f,c,h),Object.setPrototypeOf(g,a.prototype),g}function C(f){if(a.isBuffer(f)){const c=N(f.length)|0,h=o(c);return h.length===0||f.copy(h,0,0,c),h}if(f.length!==void 0)return typeof f.length!="number"||ts(f.length)?o(0):k(f);if(f.type==="Buffer"&&Array.isArray(f.data))return k(f.data)}function N(f){if(f>=i)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+i.toString(16)+" bytes");return f|0}function P(f){return+f!=f&&(f=0),a.alloc(+f)}a.isBuffer=function(c){return c!=null&&c._isBuffer===!0&&c!==a.prototype},a.compare=function(c,h){if(He(c,Uint8Array)&&(c=a.from(c,c.offset,c.byteLength)),He(h,Uint8Array)&&(h=a.from(h,h.offset,h.byteLength)),!a.isBuffer(c)||!a.isBuffer(h))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(c===h)return 0;let g=c.length,b=h.length;for(let w=0,T=Math.min(g,b);w<T;++w)if(c[w]!==h[w]){g=c[w],b=h[w];break}return g<b?-1:b<g?1:0},a.isEncoding=function(c){switch(String(c).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},a.concat=function(c,h){if(!Array.isArray(c))throw new TypeError('"list" argument must be an Array of Buffers');if(c.length===0)return a.alloc(0);let g;if(h===void 0)for(h=0,g=0;g<c.length;++g)h+=c[g].length;const b=a.allocUnsafe(h);let w=0;for(g=0;g<c.length;++g){let T=c[g];if(He(T,Uint8Array))w+T.length>b.length?(a.isBuffer(T)||(T=a.from(T)),T.copy(b,w)):Uint8Array.prototype.set.call(b,T,w);else if(a.isBuffer(T))T.copy(b,w);else throw new TypeError('"list" argument must be an Array of Buffers');w+=T.length}return b};function W(f,c){if(a.isBuffer(f))return f.length;if(ArrayBuffer.isView(f)||He(f,ArrayBuffer))return f.byteLength;if(typeof f!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof f);const h=f.length,g=arguments.length>2&&arguments[2]===!0;if(!g&&h===0)return 0;let b=!1;for(;;)switch(c){case"ascii":case"latin1":case"binary":return h;case"utf8":case"utf-8":return es(f).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return h*2;case"hex":return h>>>1;case"base64":return fi(f).length;default:if(b)return g?-1:es(f).length;c=(""+c).toLowerCase(),b=!0}}a.byteLength=W;function K(f,c,h){let g=!1;if((c===void 0||c<0)&&(c=0),c>this.length||((h===void 0||h>this.length)&&(h=this.length),h<=0)||(h>>>=0,c>>>=0,h<=c))return"";for(f||(f="utf8");;)switch(f){case"hex":return v(this,c,h);case"utf8":case"utf-8":return Me(this,c,h);case"ascii":return _e(this,c,h);case"latin1":case"binary":return Ae(this,c,h);case"base64":return Re(this,c,h);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return I(this,c,h);default:if(g)throw new TypeError("Unknown encoding: "+f);f=(f+"").toLowerCase(),g=!0}}a.prototype._isBuffer=!0;function M(f,c,h){const g=f[c];f[c]=f[h],f[h]=g}a.prototype.swap16=function(){const c=this.length;if(c%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let h=0;h<c;h+=2)M(this,h,h+1);return this},a.prototype.swap32=function(){const c=this.length;if(c%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let h=0;h<c;h+=4)M(this,h,h+3),M(this,h+1,h+2);return this},a.prototype.swap64=function(){const c=this.length;if(c%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let h=0;h<c;h+=8)M(this,h,h+7),M(this,h+1,h+6),M(this,h+2,h+5),M(this,h+3,h+4);return this},a.prototype.toString=function(){const c=this.length;return c===0?"":arguments.length===0?Me(this,0,c):K.apply(this,arguments)},a.prototype.toLocaleString=a.prototype.toString,a.prototype.equals=function(c){if(!a.isBuffer(c))throw new TypeError("Argument must be a Buffer");return this===c?!0:a.compare(this,c)===0},a.prototype.inspect=function(){let c="";const h=s.INSPECT_MAX_BYTES;return c=this.toString("hex",0,h).replace(/(.{2})/g,"$1 ").trim(),this.length>h&&(c+=" ... "),"<Buffer "+c+">"},n&&(a.prototype[n]=a.prototype.inspect),a.prototype.compare=function(c,h,g,b,w){if(He(c,Uint8Array)&&(c=a.from(c,c.offset,c.byteLength)),!a.isBuffer(c))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof c);if(h===void 0&&(h=0),g===void 0&&(g=c?c.length:0),b===void 0&&(b=0),w===void 0&&(w=this.length),h<0||g>c.length||b<0||w>this.length)throw new RangeError("out of range index");if(b>=w&&h>=g)return 0;if(b>=w)return-1;if(h>=g)return 1;if(h>>>=0,g>>>=0,b>>>=0,w>>>=0,this===c)return 0;let T=w-b,z=g-h;const ne=Math.min(T,z),Q=this.slice(b,w),se=c.slice(h,g);for(let G=0;G<ne;++G)if(Q[G]!==se[G]){T=Q[G],z=se[G];break}return T<z?-1:z<T?1:0};function R(f,c,h,g,b){if(f.length===0)return-1;if(typeof h=="string"?(g=h,h=0):h>2147483647?h=2147483647:h<-2147483648&&(h=-2147483648),h=+h,ts(h)&&(h=b?0:f.length-1),h<0&&(h=f.length+h),h>=f.length){if(b)return-1;h=f.length-1}else if(h<0)if(b)h=0;else return-1;if(typeof c=="string"&&(c=a.from(c,g)),a.isBuffer(c))return c.length===0?-1:H(f,c,h,g,b);if(typeof c=="number")return c=c&255,typeof Uint8Array.prototype.indexOf=="function"?b?Uint8Array.prototype.indexOf.call(f,c,h):Uint8Array.prototype.lastIndexOf.call(f,c,h):H(f,[c],h,g,b);throw new TypeError("val must be string, number or Buffer")}function H(f,c,h,g,b){let w=1,T=f.length,z=c.length;if(g!==void 0&&(g=String(g).toLowerCase(),g==="ucs2"||g==="ucs-2"||g==="utf16le"||g==="utf-16le")){if(f.length<2||c.length<2)return-1;w=2,T/=2,z/=2,h/=2}function ne(se,G){return w===1?se[G]:se.readUInt16BE(G*w)}let Q;if(b){let se=-1;for(Q=h;Q<T;Q++)if(ne(f,Q)===ne(c,se===-1?0:Q-se)){if(se===-1&&(se=Q),Q-se+1===z)return se*w}else se!==-1&&(Q-=Q-se),se=-1}else for(h+z>T&&(h=T-z),Q=h;Q>=0;Q--){let se=!0;for(let G=0;G<z;G++)if(ne(f,Q+G)!==ne(c,G)){se=!1;break}if(se)return Q}return-1}a.prototype.includes=function(c,h,g){return this.indexOf(c,h,g)!==-1},a.prototype.indexOf=function(c,h,g){return R(this,c,h,g,!0)},a.prototype.lastIndexOf=function(c,h,g){return R(this,c,h,g,!1)};function F(f,c,h,g){h=Number(h)||0;const b=f.length-h;g?(g=Number(g),g>b&&(g=b)):g=b;const w=c.length;g>w/2&&(g=w/2);let T;for(T=0;T<g;++T){const z=parseInt(c.substr(T*2,2),16);if(ts(z))return T;f[h+T]=z}return T}function _(f,c,h,g){return Sn(es(c,f.length-h),f,h,g)}function L(f,c,h,g){return Sn(Ea(c),f,h,g)}function ie(f,c,h,g){return Sn(fi(c),f,h,g)}function le(f,c,h,g){return Sn(Ia(c,f.length-h),f,h,g)}a.prototype.write=function(c,h,g,b){if(h===void 0)b="utf8",g=this.length,h=0;else if(g===void 0&&typeof h=="string")b=h,g=this.length,h=0;else if(isFinite(h))h=h>>>0,isFinite(g)?(g=g>>>0,b===void 0&&(b="utf8")):(b=g,g=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const w=this.length-h;if((g===void 0||g>w)&&(g=w),c.length>0&&(g<0||h<0)||h>this.length)throw new RangeError("Attempt to write outside buffer bounds");b||(b="utf8");let T=!1;for(;;)switch(b){case"hex":return F(this,c,h,g);case"utf8":case"utf-8":return _(this,c,h,g);case"ascii":case"latin1":case"binary":return L(this,c,h,g);case"base64":return ie(this,c,h,g);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return le(this,c,h,g);default:if(T)throw new TypeError("Unknown encoding: "+b);b=(""+b).toLowerCase(),T=!0}},a.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function Re(f,c,h){return c===0&&h===f.length?e.fromByteArray(f):e.fromByteArray(f.slice(c,h))}function Me(f,c,h){h=Math.min(f.length,h);const g=[];let b=c;for(;b<h;){const w=f[b];let T=null,z=w>239?4:w>223?3:w>191?2:1;if(b+z<=h){let ne,Q,se,G;switch(z){case 1:w<128&&(T=w);break;case 2:ne=f[b+1],(ne&192)===128&&(G=(w&31)<<6|ne&63,G>127&&(T=G));break;case 3:ne=f[b+1],Q=f[b+2],(ne&192)===128&&(Q&192)===128&&(G=(w&15)<<12|(ne&63)<<6|Q&63,G>2047&&(G<55296||G>57343)&&(T=G));break;case 4:ne=f[b+1],Q=f[b+2],se=f[b+3],(ne&192)===128&&(Q&192)===128&&(se&192)===128&&(G=(w&15)<<18|(ne&63)<<12|(Q&63)<<6|se&63,G>65535&&G<1114112&&(T=G))}}T===null?(T=65533,z=1):T>65535&&(T-=65536,g.push(T>>>10&1023|55296),T=56320|T&1023),g.push(T),b+=z}return Ne(g)}const Le=4096;function Ne(f){const c=f.length;if(c<=Le)return String.fromCharCode.apply(String,f);let h="",g=0;for(;g<c;)h+=String.fromCharCode.apply(String,f.slice(g,g+=Le));return h}function _e(f,c,h){let g="";h=Math.min(f.length,h);for(let b=c;b<h;++b)g+=String.fromCharCode(f[b]&127);return g}function Ae(f,c,h){let g="";h=Math.min(f.length,h);for(let b=c;b<h;++b)g+=String.fromCharCode(f[b]);return g}function v(f,c,h){const g=f.length;(!c||c<0)&&(c=0),(!h||h<0||h>g)&&(h=g);let b="";for(let w=c;w<h;++w)b+=Na[f[w]];return b}function I(f,c,h){const g=f.slice(c,h);let b="";for(let w=0;w<g.length-1;w+=2)b+=String.fromCharCode(g[w]+g[w+1]*256);return b}a.prototype.slice=function(c,h){const g=this.length;c=~~c,h=h===void 0?g:~~h,c<0?(c+=g,c<0&&(c=0)):c>g&&(c=g),h<0?(h+=g,h<0&&(h=0)):h>g&&(h=g),h<c&&(h=c);const b=this.subarray(c,h);return Object.setPrototypeOf(b,a.prototype),b};function U(f,c,h){if(f%1!==0||f<0)throw new RangeError("offset is not uint");if(f+c>h)throw new RangeError("Trying to access beyond buffer length")}a.prototype.readUintLE=a.prototype.readUIntLE=function(c,h,g){c=c>>>0,h=h>>>0,g||U(c,h,this.length);let b=this[c],w=1,T=0;for(;++T<h&&(w*=256);)b+=this[c+T]*w;return b},a.prototype.readUintBE=a.prototype.readUIntBE=function(c,h,g){c=c>>>0,h=h>>>0,g||U(c,h,this.length);let b=this[c+--h],w=1;for(;h>0&&(w*=256);)b+=this[c+--h]*w;return b},a.prototype.readUint8=a.prototype.readUInt8=function(c,h){return c=c>>>0,h||U(c,1,this.length),this[c]},a.prototype.readUint16LE=a.prototype.readUInt16LE=function(c,h){return c=c>>>0,h||U(c,2,this.length),this[c]|this[c+1]<<8},a.prototype.readUint16BE=a.prototype.readUInt16BE=function(c,h){return c=c>>>0,h||U(c,2,this.length),this[c]<<8|this[c+1]},a.prototype.readUint32LE=a.prototype.readUInt32LE=function(c,h){return c=c>>>0,h||U(c,4,this.length),(this[c]|this[c+1]<<8|this[c+2]<<16)+this[c+3]*16777216},a.prototype.readUint32BE=a.prototype.readUInt32BE=function(c,h){return c=c>>>0,h||U(c,4,this.length),this[c]*16777216+(this[c+1]<<16|this[c+2]<<8|this[c+3])},a.prototype.readBigUInt64LE=at(function(c){c=c>>>0,ot(c,"offset");const h=this[c],g=this[c+7];(h===void 0||g===void 0)&&Xe(c,this.length-8);const b=h+this[++c]*2**8+this[++c]*2**16+this[++c]*2**24,w=this[++c]+this[++c]*2**8+this[++c]*2**16+g*2**24;return BigInt(b)+(BigInt(w)<<BigInt(32))}),a.prototype.readBigUInt64BE=at(function(c){c=c>>>0,ot(c,"offset");const h=this[c],g=this[c+7];(h===void 0||g===void 0)&&Xe(c,this.length-8);const b=h*2**24+this[++c]*2**16+this[++c]*2**8+this[++c],w=this[++c]*2**24+this[++c]*2**16+this[++c]*2**8+g;return(BigInt(b)<<BigInt(32))+BigInt(w)}),a.prototype.readIntLE=function(c,h,g){c=c>>>0,h=h>>>0,g||U(c,h,this.length);let b=this[c],w=1,T=0;for(;++T<h&&(w*=256);)b+=this[c+T]*w;return w*=128,b>=w&&(b-=Math.pow(2,8*h)),b},a.prototype.readIntBE=function(c,h,g){c=c>>>0,h=h>>>0,g||U(c,h,this.length);let b=h,w=1,T=this[c+--b];for(;b>0&&(w*=256);)T+=this[c+--b]*w;return w*=128,T>=w&&(T-=Math.pow(2,8*h)),T},a.prototype.readInt8=function(c,h){return c=c>>>0,h||U(c,1,this.length),this[c]&128?(255-this[c]+1)*-1:this[c]},a.prototype.readInt16LE=function(c,h){c=c>>>0,h||U(c,2,this.length);const g=this[c]|this[c+1]<<8;return g&32768?g|4294901760:g},a.prototype.readInt16BE=function(c,h){c=c>>>0,h||U(c,2,this.length);const g=this[c+1]|this[c]<<8;return g&32768?g|4294901760:g},a.prototype.readInt32LE=function(c,h){return c=c>>>0,h||U(c,4,this.length),this[c]|this[c+1]<<8|this[c+2]<<16|this[c+3]<<24},a.prototype.readInt32BE=function(c,h){return c=c>>>0,h||U(c,4,this.length),this[c]<<24|this[c+1]<<16|this[c+2]<<8|this[c+3]},a.prototype.readBigInt64LE=at(function(c){c=c>>>0,ot(c,"offset");const h=this[c],g=this[c+7];(h===void 0||g===void 0)&&Xe(c,this.length-8);const b=this[c+4]+this[c+5]*2**8+this[c+6]*2**16+(g<<24);return(BigInt(b)<<BigInt(32))+BigInt(h+this[++c]*2**8+this[++c]*2**16+this[++c]*2**24)}),a.prototype.readBigInt64BE=at(function(c){c=c>>>0,ot(c,"offset");const h=this[c],g=this[c+7];(h===void 0||g===void 0)&&Xe(c,this.length-8);const b=(h<<24)+this[++c]*2**16+this[++c]*2**8+this[++c];return(BigInt(b)<<BigInt(32))+BigInt(this[++c]*2**24+this[++c]*2**16+this[++c]*2**8+g)}),a.prototype.readFloatLE=function(c,h){return c=c>>>0,h||U(c,4,this.length),t.read(this,c,!0,23,4)},a.prototype.readFloatBE=function(c,h){return c=c>>>0,h||U(c,4,this.length),t.read(this,c,!1,23,4)},a.prototype.readDoubleLE=function(c,h){return c=c>>>0,h||U(c,8,this.length),t.read(this,c,!0,52,8)},a.prototype.readDoubleBE=function(c,h){return c=c>>>0,h||U(c,8,this.length),t.read(this,c,!1,52,8)};function $(f,c,h,g,b,w){if(!a.isBuffer(f))throw new TypeError('"buffer" argument must be a Buffer instance');if(c>b||c<w)throw new RangeError('"value" argument is out of bounds');if(h+g>f.length)throw new RangeError("Index out of range")}a.prototype.writeUintLE=a.prototype.writeUIntLE=function(c,h,g,b){if(c=+c,h=h>>>0,g=g>>>0,!b){const z=Math.pow(2,8*g)-1;$(this,c,h,g,z,0)}let w=1,T=0;for(this[h]=c&255;++T<g&&(w*=256);)this[h+T]=c/w&255;return h+g},a.prototype.writeUintBE=a.prototype.writeUIntBE=function(c,h,g,b){if(c=+c,h=h>>>0,g=g>>>0,!b){const z=Math.pow(2,8*g)-1;$(this,c,h,g,z,0)}let w=g-1,T=1;for(this[h+w]=c&255;--w>=0&&(T*=256);)this[h+w]=c/T&255;return h+g},a.prototype.writeUint8=a.prototype.writeUInt8=function(c,h,g){return c=+c,h=h>>>0,g||$(this,c,h,1,255,0),this[h]=c&255,h+1},a.prototype.writeUint16LE=a.prototype.writeUInt16LE=function(c,h,g){return c=+c,h=h>>>0,g||$(this,c,h,2,65535,0),this[h]=c&255,this[h+1]=c>>>8,h+2},a.prototype.writeUint16BE=a.prototype.writeUInt16BE=function(c,h,g){return c=+c,h=h>>>0,g||$(this,c,h,2,65535,0),this[h]=c>>>8,this[h+1]=c&255,h+2},a.prototype.writeUint32LE=a.prototype.writeUInt32LE=function(c,h,g){return c=+c,h=h>>>0,g||$(this,c,h,4,4294967295,0),this[h+3]=c>>>24,this[h+2]=c>>>16,this[h+1]=c>>>8,this[h]=c&255,h+4},a.prototype.writeUint32BE=a.prototype.writeUInt32BE=function(c,h,g){return c=+c,h=h>>>0,g||$(this,c,h,4,4294967295,0),this[h]=c>>>24,this[h+1]=c>>>16,this[h+2]=c>>>8,this[h+3]=c&255,h+4};function We(f,c,h,g,b){bn(c,g,b,f,h,7);let w=Number(c&BigInt(4294967295));f[h++]=w,w=w>>8,f[h++]=w,w=w>>8,f[h++]=w,w=w>>8,f[h++]=w;let T=Number(c>>BigInt(32)&BigInt(4294967295));return f[h++]=T,T=T>>8,f[h++]=T,T=T>>8,f[h++]=T,T=T>>8,f[h++]=T,h}function re(f,c,h,g,b){bn(c,g,b,f,h,7);let w=Number(c&BigInt(4294967295));f[h+7]=w,w=w>>8,f[h+6]=w,w=w>>8,f[h+5]=w,w=w>>8,f[h+4]=w;let T=Number(c>>BigInt(32)&BigInt(4294967295));return f[h+3]=T,T=T>>8,f[h+2]=T,T=T>>8,f[h+1]=T,T=T>>8,f[h]=T,h+8}a.prototype.writeBigUInt64LE=at(function(c,h=0){return We(this,c,h,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeBigUInt64BE=at(function(c,h=0){return re(this,c,h,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeIntLE=function(c,h,g,b){if(c=+c,h=h>>>0,!b){const ne=Math.pow(2,8*g-1);$(this,c,h,g,ne-1,-ne)}let w=0,T=1,z=0;for(this[h]=c&255;++w<g&&(T*=256);)c<0&&z===0&&this[h+w-1]!==0&&(z=1),this[h+w]=(c/T>>0)-z&255;return h+g},a.prototype.writeIntBE=function(c,h,g,b){if(c=+c,h=h>>>0,!b){const ne=Math.pow(2,8*g-1);$(this,c,h,g,ne-1,-ne)}let w=g-1,T=1,z=0;for(this[h+w]=c&255;--w>=0&&(T*=256);)c<0&&z===0&&this[h+w+1]!==0&&(z=1),this[h+w]=(c/T>>0)-z&255;return h+g},a.prototype.writeInt8=function(c,h,g){return c=+c,h=h>>>0,g||$(this,c,h,1,127,-128),c<0&&(c=255+c+1),this[h]=c&255,h+1},a.prototype.writeInt16LE=function(c,h,g){return c=+c,h=h>>>0,g||$(this,c,h,2,32767,-32768),this[h]=c&255,this[h+1]=c>>>8,h+2},a.prototype.writeInt16BE=function(c,h,g){return c=+c,h=h>>>0,g||$(this,c,h,2,32767,-32768),this[h]=c>>>8,this[h+1]=c&255,h+2},a.prototype.writeInt32LE=function(c,h,g){return c=+c,h=h>>>0,g||$(this,c,h,4,2147483647,-2147483648),this[h]=c&255,this[h+1]=c>>>8,this[h+2]=c>>>16,this[h+3]=c>>>24,h+4},a.prototype.writeInt32BE=function(c,h,g){return c=+c,h=h>>>0,g||$(this,c,h,4,2147483647,-2147483648),c<0&&(c=4294967295+c+1),this[h]=c>>>24,this[h+1]=c>>>16,this[h+2]=c>>>8,this[h+3]=c&255,h+4},a.prototype.writeBigInt64LE=at(function(c,h=0){return We(this,c,h,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),a.prototype.writeBigInt64BE=at(function(c,h=0){return re(this,c,h,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function he(f,c,h,g,b,w){if(h+g>f.length)throw new RangeError("Index out of range");if(h<0)throw new RangeError("Index out of range")}function j(f,c,h,g,b){return c=+c,h=h>>>0,b||he(f,c,h,4),t.write(f,c,h,g,23,4),h+4}a.prototype.writeFloatLE=function(c,h,g){return j(this,c,h,!0,g)},a.prototype.writeFloatBE=function(c,h,g){return j(this,c,h,!1,g)};function te(f,c,h,g,b){return c=+c,h=h>>>0,b||he(f,c,h,8),t.write(f,c,h,g,52,8),h+8}a.prototype.writeDoubleLE=function(c,h,g){return te(this,c,h,!0,g)},a.prototype.writeDoubleBE=function(c,h,g){return te(this,c,h,!1,g)},a.prototype.copy=function(c,h,g,b){if(!a.isBuffer(c))throw new TypeError("argument should be a Buffer");if(g||(g=0),!b&&b!==0&&(b=this.length),h>=c.length&&(h=c.length),h||(h=0),b>0&&b<g&&(b=g),b===g||c.length===0||this.length===0)return 0;if(h<0)throw new RangeError("targetStart out of bounds");if(g<0||g>=this.length)throw new RangeError("Index out of range");if(b<0)throw new RangeError("sourceEnd out of bounds");b>this.length&&(b=this.length),c.length-h<b-g&&(b=c.length-h+g);const w=b-g;return this===c&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(h,g,b):Uint8Array.prototype.set.call(c,this.subarray(g,b),h),w},a.prototype.fill=function(c,h,g,b){if(typeof c=="string"){if(typeof h=="string"?(b=h,h=0,g=this.length):typeof g=="string"&&(b=g,g=this.length),b!==void 0&&typeof b!="string")throw new TypeError("encoding must be a string");if(typeof b=="string"&&!a.isEncoding(b))throw new TypeError("Unknown encoding: "+b);if(c.length===1){const T=c.charCodeAt(0);(b==="utf8"&&T<128||b==="latin1")&&(c=T)}}else typeof c=="number"?c=c&255:typeof c=="boolean"&&(c=Number(c));if(h<0||this.length<h||this.length<g)throw new RangeError("Out of range index");if(g<=h)return this;h=h>>>0,g=g===void 0?this.length:g>>>0,c||(c=0);let w;if(typeof c=="number")for(w=h;w<g;++w)this[w]=c;else{const T=a.isBuffer(c)?c:a.from(c,b),z=T.length;if(z===0)throw new TypeError('The value "'+c+'" is invalid for argument "value"');for(w=0;w<g-h;++w)this[w+h]=T[w%z]}return this};const ce={};function V(f,c,h){ce[f]=class extends h{constructor(){super(),Object.defineProperty(this,"message",{value:c.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${f}]`,this.stack,delete this.name}get code(){return f}set code(b){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:b,writable:!0})}toString(){return`${this.name} [${f}]: ${this.message}`}}}V("ERR_BUFFER_OUT_OF_BOUNDS",function(f){return f?`${f} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),V("ERR_INVALID_ARG_TYPE",function(f,c){return`The "${f}" argument must be of type number. Received type ${typeof c}`},TypeError),V("ERR_OUT_OF_RANGE",function(f,c,h){let g=`The value of "${f}" is out of range.`,b=h;return Number.isInteger(h)&&Math.abs(h)>2**32?b=Je(String(h)):typeof h=="bigint"&&(b=String(h),(h>BigInt(2)**BigInt(32)||h<-(BigInt(2)**BigInt(32)))&&(b=Je(b)),b+="n"),g+=` It must be ${c}. Received ${b}`,g},RangeError);function Je(f){let c="",h=f.length;const g=f[0]==="-"?1:0;for(;h>=g+4;h-=3)c=`_${f.slice(h-3,h)}${c}`;return`${f.slice(0,h)}${c}`}function wt(f,c,h){ot(c,"offset"),(f[c]===void 0||f[c+h]===void 0)&&Xe(c,f.length-(h+1))}function bn(f,c,h,g,b,w){if(f>h||f<c){const T=typeof c=="bigint"?"n":"";let z;throw c===0||c===BigInt(0)?z=`>= 0${T} and < 2${T} ** ${(w+1)*8}${T}`:z=`>= -(2${T} ** ${(w+1)*8-1}${T}) and < 2 ** ${(w+1)*8-1}${T}`,new ce.ERR_OUT_OF_RANGE("value",z,f)}wt(g,b,w)}function ot(f,c){if(typeof f!="number")throw new ce.ERR_INVALID_ARG_TYPE(c,"number",f)}function Xe(f,c,h){throw Math.floor(f)!==f?(ot(f,h),new ce.ERR_OUT_OF_RANGE("offset","an integer",f)):c<0?new ce.ERR_BUFFER_OUT_OF_BOUNDS:new ce.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${c}`,f)}const Ta=/[^+/0-9A-Za-z-_]/g;function Ma(f){if(f=f.split("=")[0],f=f.trim().replace(Ta,""),f.length<2)return"";for(;f.length%4!==0;)f=f+"=";return f}function es(f,c){c=c||1/0;let h;const g=f.length;let b=null;const w=[];for(let T=0;T<g;++T){if(h=f.charCodeAt(T),h>55295&&h<57344){if(!b){if(h>56319){(c-=3)>-1&&w.push(239,191,189);continue}else if(T+1===g){(c-=3)>-1&&w.push(239,191,189);continue}b=h;continue}if(h<56320){(c-=3)>-1&&w.push(239,191,189),b=h;continue}h=(b-55296<<10|h-56320)+65536}else b&&(c-=3)>-1&&w.push(239,191,189);if(b=null,h<128){if((c-=1)<0)break;w.push(h)}else if(h<2048){if((c-=2)<0)break;w.push(h>>6|192,h&63|128)}else if(h<65536){if((c-=3)<0)break;w.push(h>>12|224,h>>6&63|128,h&63|128)}else if(h<1114112){if((c-=4)<0)break;w.push(h>>18|240,h>>12&63|128,h>>6&63|128,h&63|128)}else throw new Error("Invalid code point")}return w}function Ea(f){const c=[];for(let h=0;h<f.length;++h)c.push(f.charCodeAt(h)&255);return c}function Ia(f,c){let h,g,b;const w=[];for(let T=0;T<f.length&&!((c-=2)<0);++T)h=f.charCodeAt(T),g=h>>8,b=h%256,w.push(b),w.push(g);return w}function fi(f){return e.toByteArray(Ma(f))}function Sn(f,c,h,g){let b;for(b=0;b<g&&!(b+h>=c.length||b>=f.length);++b)c[b+h]=f[b];return b}function He(f,c){return f instanceof c||f!=null&&f.constructor!=null&&f.constructor.name!=null&&f.constructor.name===c.name}function ts(f){return f!==f}const Na=function(){const f="0123456789abcdef",c=new Array(256);for(let h=0;h<16;++h){const g=h*16;for(let b=0;b<16;++b)c[g+b]=f[h]+f[b]}return c}();function at(f){return typeof BigInt>"u"?_a:f}function _a(){throw new Error("BigInt not supported")}})(Gs);function Kp(s){if(typeof s!="string")throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!s)throw new Error("No input");const e=JSON.parse(s),t=e;let n;if(t.type==="system")if(t.event==="connected")n=Object.assign(Object.assign({},e),{kind:"connected"});else if(t.event==="disconnected")n=Object.assign(Object.assign({},e),{kind:"disconnected"});else return null;else if(t.type==="message")if(t.from==="group"){const i=Br(e.data,e.dataType);if(i===null)return null;n=Object.assign(Object.assign({},e),{data:i,kind:"groupData"})}else if(t.from==="server"){const i=Br(e.data,e.dataType);if(i===null)return null;n=Object.assign(Object.assign({},e),{data:i,kind:"serverData"})}else return null;else if(t.type==="ack")n=Object.assign(Object.assign({},e),{kind:"ack"});else return null;return n}function Yp(s){let e;switch(s.kind){case"joinGroup":{e={type:"joinGroup",group:s.group,ackId:s.ackId};break}case"leaveGroup":{e={type:"leaveGroup",group:s.group,ackId:s.ackId};break}case"sendEvent":{e={type:"event",event:s.event,ackId:s.ackId,dataType:s.dataType,data:vr(s.data,s.dataType)};break}case"sendToGroup":{e={type:"sendToGroup",group:s.group,ackId:s.ackId,dataType:s.dataType,data:vr(s.data,s.dataType),noEcho:s.noEcho};break}case"sequenceAck":{e={type:"sequenceAck",sequenceId:s.sequenceId};break}default:throw new Error(`Unsupported type: ${s.kind}`)}return JSON.stringify(e)}function vr(s,e){switch(e){case"text":{if(typeof s!="string")throw new TypeError("Message must be a string.");return s}case"json":return s;case"binary":case"protobuf":{if(s instanceof ArrayBuffer)return Gs.Buffer.from(s).toString("base64");throw new TypeError("Message must be a ArrayBuffer")}}}function Br(s,e){if(e==="text"){if(typeof s!="string")throw new TypeError("Message must be a string when dataType is text");return s}else{if(e==="json")return s;if(e==="binary"||e==="protobuf"){const t=Gs.Buffer.from(s,"base64");return t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}else return null}}class Zp{constructor(){this.isReliableSubProtocol=!0,this.name="json.reliable.webpubsub.azure.v1"}parseMessages(e){return Kp(e)}writeMessage(e){return Yp(e)}}const Qp=()=>new Zp;var Ee;(function(s){s.Stopped="Stopped",s.Disconnected="Disconnected",s.Connecting="Connecting",s.Connected="Connected",s.Recovering="Recovering"})(Ee||(Ee={}));class Xp{nextAckId(){return this._ackId=this._ackId+1,this._ackId}constructor(e,t){this._quickSequenceAckDiff=300,this._activeTimeoutInMs=2e4,this._emitter=new dc,this._isStopping=!1,this._isInitialConnected=!1,typeof e=="string"?this._credential={getClientAccessUrl:e}:this._credential=e,t==null&&(t={}),this._buildDefaultOptions(t),this._options=t,this._messageRetryPolicy=new Fr(this._options.messageRetryOptions),this._reconnectRetryPolicy=new Fr(this._options.reconnectRetryOptions),this._protocol=this._options.protocol,this._groupMap=new Map,this._ackMap=new Map,this._sequenceId=new nm,this._state=Ee.Stopped,this._ackId=0}async start(e){if(this._isStopping)throw new Error("Can't start a client during stopping");if(this._state!==Ee.Stopped)throw new Error("Client can be only started when it's Stopped");let t;e&&(t=e.abortSignal),this._activeKeepaliveTask||(this._activeKeepaliveTask=this._getActiveKeepaliveTask());try{await this._startCore(t)}catch(n){throw this._changeState(Ee.Stopped),this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0),this._isStopping=!1,n}}async _startFromRestarting(e){if(this._state!==Ee.Disconnected)throw new Error("Client can be only restarted when it's Disconnected");try{pe.verbose("Staring reconnecting."),await this._startCore(e)}catch(t){throw this._changeState(Ee.Disconnected),t}}async _startCore(e){if(this._changeState(Ee.Connecting),pe.info("Staring a new connection"),this._sequenceId.reset(),this._isInitialConnected=!1,this._lastCloseEvent=void 0,this._lastDisconnectedMessage=void 0,this._connectionId=void 0,this._reconnectionToken=void 0,this._uri=void 0,typeof this._credential.getClientAccessUrl=="string"?this._uri=this._credential.getClientAccessUrl:this._uri=await this._credential.getClientAccessUrl({abortSignal:e}),typeof this._uri!="string")throw new Error(`The clientAccessUrl must be a string but currently it's ${typeof this._uri}`);await this._connectCore(this._uri)}stop(){this._state===Ee.Stopped||this._isStopping||(this._isStopping=!0,this._wsClient&&this._wsClient.isOpen()?this._wsClient.close():this._isStopping=!1,this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0))}on(e,t){this._emitter.on(e,t)}off(e,t){this._emitter.removeListener(e,t)}_emitEvent(e,t){this._emitter.emit(e,t)}async sendEvent(e,t,n,i){return await this._operationExecuteWithRetry(()=>this._sendEventAttempt(e,t,n,i),i?.abortSignal)}async _sendEventAttempt(e,t,n,i){var r;if(!((r=i?.fireAndForget)!==null&&r!==void 0?r:!1))return await this._sendMessageWithAckId(l=>({kind:"sendEvent",dataType:n,data:t,ackId:l,event:e}),i?.ackId,i?.abortSignal);const a={kind:"sendEvent",dataType:n,data:t,event:e};return await this._sendMessage(a,i?.abortSignal),{isDuplicated:!1}}async joinGroup(e,t){return await this._operationExecuteWithRetry(()=>this._joinGroupAttempt(e,t),t?.abortSignal)}async _joinGroupAttempt(e,t){const n=this._getOrAddGroup(e),i=await this._joinGroupCore(e,t);return n.isJoined=!0,i}async _joinGroupCore(e,t){return await this._sendMessageWithAckId(n=>({group:e,ackId:n,kind:"joinGroup"}),t?.ackId,t?.abortSignal)}async leaveGroup(e,t){return await this._operationExecuteWithRetry(()=>this._leaveGroupAttempt(e,t),t?.abortSignal)}async _leaveGroupAttempt(e,t){const n=this._getOrAddGroup(e),i=await this._sendMessageWithAckId(r=>({group:e,ackId:r,kind:"leaveGroup"}),t?.ackId,t?.abortSignal);return n.isJoined=!1,i}async sendToGroup(e,t,n,i){return await this._operationExecuteWithRetry(()=>this._sendToGroupAttempt(e,t,n,i),i?.abortSignal)}async _sendToGroupAttempt(e,t,n,i){var r,o;const a=(r=i?.fireAndForget)!==null&&r!==void 0?r:!1,l=(o=i?.noEcho)!==null&&o!==void 0?o:!1;if(!a)return await this._sendMessageWithAckId(u=>({kind:"sendToGroup",group:e,dataType:n,data:t,ackId:u,noEcho:l}),i?.ackId,i?.abortSignal);const d={kind:"sendToGroup",group:e,dataType:n,data:t,noEcho:l};return await this._sendMessage(d,i?.abortSignal),{isDuplicated:!1}}_getWebSocketClientFactory(){return new hc}async _trySendSequenceAck(){if(!this._protocol.isReliableSubProtocol)return;const[e,t]=this._sequenceId.tryGetSequenceId();if(e&&t){const n={kind:"sequenceAck",sequenceId:t};try{await this._sendMessage(n)}catch{this._sequenceId.tryUpdate(t)}}}_connectCore(e){if(this._isStopping)throw new Error("Can't start a client during stopping");return new Promise((t,n)=>{const i=this._wsClient=this._getWebSocketClientFactory().create(e,this._protocol.name);i.onopen(()=>{if(this._isStopping){try{i.close()}catch{}n(new Error("The client is stopped"))}pe.verbose("WebSocket connection has opened"),this._changeState(Ee.Connected),this._protocol.isReliableSubProtocol&&(this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),this._sequenceAckTask=new Pr(async()=>{await this._trySendSequenceAck()},1e3)),t()}),i.onerror(r=>{this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),n(r)}),i.onclose((r,o)=>{this._state===Ee.Connected?(pe.verbose("WebSocket closed after open"),this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),pe.info(`WebSocket connection closed. Code: ${r}, Reason: ${o}`),this._lastCloseEvent={code:r,reason:o},this._handleConnectionClose.call(this)):(pe.verbose("WebSocket closed before open"),n(new Error(`Failed to start WebSocket: ${r}`)))}),i.onmessage(r=>{const o=p=>{if(this._ackMap.has(p.ackId)){const k=this._ackMap.get(p.ackId);this._ackMap.delete(p.ackId);const y=p.error!=null&&p.error.name==="Duplicate";p.success||y?k.resolve({ackId:p.ackId,isDuplicated:y}):k.reject(new wn("Failed to send message.",{ackId:p.ackId,errorDetail:p.error}))}},a=async p=>{if(this._connectionId=p.connectionId,this._reconnectionToken=p.reconnectionToken,!this._isInitialConnected){if(this._isInitialConnected=!0,this._options.autoRejoinGroups){const k=[];this._groupMap.forEach(y=>{y.isJoined&&k.push((async()=>{try{await this._joinGroupCore(y.name)}catch(S){this._safeEmitRejoinGroupFailed(y.name,S)}})())});try{await Promise.all(k)}catch{}}this._safeEmitConnected(p.connectionId,p.userId)}},l=p=>{this._lastDisconnectedMessage=p},d=p=>{if(p.sequenceId!=null){const k=this._sequenceId.tryUpdate(p.sequenceId);if(k===0)return;k>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitGroupMessage(p)},u=p=>{if(p.sequenceId!=null){const k=this._sequenceId.tryUpdate(p.sequenceId);if(k===0)return;k>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitServerMessage(p)};let m;try{let p;if(Array.isArray(r)?p=Buffer.concat(r):p=r,m=this._protocol.parseMessages(p),m===null)return}catch(p){throw pe.warning("An error occurred while parsing the message from service",p),p}Array.isArray(m)||(m=[m]),m.forEach(p=>{try{switch(p.kind){case"ack":{o(p);break}case"connected":{a(p);break}case"disconnected":{l(p);break}case"groupData":{d(p);break}case"serverData":{u(p);break}}}catch(k){pe.warning(`An error occurred while handling the message with kind: ${p.kind} from service`,k)}})})})}async _handleConnectionCloseAndNoRecovery(){this._state=Ee.Disconnected,this._safeEmitDisconnected(this._connectionId,this._lastDisconnectedMessage),this._options.autoReconnect?await this._autoReconnect():await this._handleConnectionStopped()}async _autoReconnect(){let e=!1,t=0;try{for(;!this._isStopping;)try{await this._startFromRestarting(),e=!0;break}catch(n){pe.warning("An attempt to reconnect connection failed.",n),t++;const i=this._reconnectRetryPolicy.nextRetryDelayInMs(t);if(i==null)break;try{pe.verbose(`Delay time for reconnect attempt ${t}: ${i}`),await _n(i)}catch{}}}finally{e||this._handleConnectionStopped()}}_handleConnectionStopped(){this._isStopping=!1,this._state=Ee.Stopped,this._safeEmitStopped()}_getActiveKeepaliveTask(){return new Pr(async()=>{this._sequenceId.tryUpdate(0)},this._activeTimeoutInMs)}async _sendMessage(e,t){if(!this._wsClient||!this._wsClient.isOpen())throw new Error("The connection is not connected.");const n=this._protocol.writeMessage(e);await this._wsClient.send(n,t)}async _sendMessageWithAckId(e,t,n){t==null&&(t=this.nextAckId());const i=e(t);this._ackMap.has(t)||this._ackMap.set(t,new tm(t));const r=this._ackMap.get(t);try{await this._sendMessage(i,n)}catch(o){this._ackMap.delete(t);let a="";throw o instanceof Error&&(a=o.message),new wn(a,{ackId:t})}if(n)try{return await uc(r.promise(),n)}catch(o){throw o instanceof Error&&o.name==="AbortError"?new wn("Cancelled by abortSignal",{ackId:t}):o}return await r.promise()}async _handleConnectionClose(){if(this._ackMap.forEach((i,r)=>{this._ackMap.delete(r)&&i.reject(new wn("Connection is disconnected before receive ack from the service",{ackId:i.ackId}))}),this._isStopping){pe.warning("The client is stopping state. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(this._lastCloseEvent&&this._lastCloseEvent.code===1008){pe.warning("The websocket close with status code 1008. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(!this._protocol.isReliableSubProtocol){pe.warning("The protocol is not reliable, recovery is not applicable"),this._handleConnectionCloseAndNoRecovery();return}const e=this._buildRecoveryUri();if(!e){pe.warning("Connection id or reconnection token is not available"),this._handleConnectionCloseAndNoRecovery();return}let t=!1;this._state=Ee.Recovering;const n=$r.timeout(30*1e3);try{for(;!n.aborted||this._isStopping;)try{await this._connectCore.call(this,e),t=!0;return}catch{await _n(1e3)}}finally{t||(pe.warning("Recovery attempts failed more then 30 seconds or the client is stopping"),this._handleConnectionCloseAndNoRecovery())}}_safeEmitConnected(e,t){this._emitEvent("connected",{connectionId:e,userId:t})}_safeEmitDisconnected(e,t){this._emitEvent("disconnected",{connectionId:e,message:t})}_safeEmitGroupMessage(e){this._emitEvent("group-message",{message:e})}_safeEmitServerMessage(e){this._emitEvent("server-message",{message:e})}_safeEmitStopped(){this._emitEvent("stopped",{})}_safeEmitRejoinGroupFailed(e,t){this._emitEvent("rejoin-group-failed",{group:e,error:t})}_buildDefaultOptions(e){return e.autoReconnect==null&&(e.autoReconnect=!0),e.autoRejoinGroups==null&&(e.autoRejoinGroups=!0),e.protocol==null&&(e.protocol=Qp()),this._buildMessageRetryOptions(e),this._buildReconnectRetryOptions(e),e}_buildMessageRetryOptions(e){e.messageRetryOptions||(e.messageRetryOptions={}),(e.messageRetryOptions.maxRetries==null||e.messageRetryOptions.maxRetries<0)&&(e.messageRetryOptions.maxRetries=3),(e.messageRetryOptions.retryDelayInMs==null||e.messageRetryOptions.retryDelayInMs<0)&&(e.messageRetryOptions.retryDelayInMs=1e3),(e.messageRetryOptions.maxRetryDelayInMs==null||e.messageRetryOptions.maxRetryDelayInMs<0)&&(e.messageRetryOptions.maxRetryDelayInMs=3e4),e.messageRetryOptions.mode==null&&(e.messageRetryOptions.mode="Fixed")}_buildReconnectRetryOptions(e){e.reconnectRetryOptions||(e.reconnectRetryOptions={}),(e.reconnectRetryOptions.maxRetries==null||e.reconnectRetryOptions.maxRetries<0)&&(e.reconnectRetryOptions.maxRetries=Number.MAX_VALUE),(e.reconnectRetryOptions.retryDelayInMs==null||e.reconnectRetryOptions.retryDelayInMs<0)&&(e.reconnectRetryOptions.retryDelayInMs=1e3),(e.reconnectRetryOptions.maxRetryDelayInMs==null||e.reconnectRetryOptions.maxRetryDelayInMs<0)&&(e.reconnectRetryOptions.maxRetryDelayInMs=3e4),e.reconnectRetryOptions.mode==null&&(e.reconnectRetryOptions.mode="Fixed")}_buildRecoveryUri(){if(this._connectionId&&this._reconnectionToken&&this._uri){const e=new URL(this._uri);return e.searchParams.append("awps_connection_id",this._connectionId),e.searchParams.append("awps_reconnection_token",this._reconnectionToken),e.toString()}return null}_getOrAddGroup(e){return this._groupMap.has(e)||this._groupMap.set(e,new em(e)),this._groupMap.get(e)}_changeState(e){pe.verbose(`The client state transfer from ${this._state.toString()} to ${e.toString()}`),this._state=e}async _operationExecuteWithRetry(e,t){let n=0;for(;;)try{return await e.call(this)}catch(i){n++;const r=this._messageRetryPolicy.nextRetryDelayInMs(n);if(r==null||(await _n(r),t?.aborted))throw i}}}class Fr{constructor(e){this._retryOptions=e,this._maxRetriesToGetMaxDelay=Math.ceil(Math.log2(this._retryOptions.maxRetryDelayInMs)-Math.log2(this._retryOptions.retryDelayInMs)+1)}nextRetryDelayInMs(e){return e>this._retryOptions.maxRetries?null:this._retryOptions.mode==="Fixed"?this._retryOptions.retryDelayInMs:this._calculateExponentialDelay(e)}_calculateExponentialDelay(e){return e>=this._maxRetriesToGetMaxDelay?this._retryOptions.maxRetryDelayInMs:(1<<e-1)*this._retryOptions.retryDelayInMs}}class em{constructor(e){this.isJoined=!1,this.name=e}}class tm{constructor(e){this._promise=new Promise((t,n)=>{this._resolve=t,this._reject=n}),this.ackId=e}promise(){return this._promise}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}class nm{constructor(){this._sequenceId=0,this._isUpdate=!1}tryUpdate(e){if(this._isUpdate=!0,e>this._sequenceId){const t=e-this._sequenceId;return this._sequenceId=e,t}return 0}tryGetSequenceId(){return this._isUpdate?(this._isUpdate=!1,[!0,this._sequenceId]):[!1,null]}reset(){this._sequenceId=0,this._isUpdate=!1}}class Pr{constructor(e,t,n){this._func=e,this._abortController=new $r,this._interval=t,this._obj=n,this._start()}abort(){try{this._abortController.abort()}catch{}}async _start(){const e=this._abortController.signal;for(;!e.aborted;)try{await this._func(this._obj)}catch{}finally{await _n(this._interval)}}}const sm=1e3*60*60,im=1e3*30;class rm{client;handler;terminationTimeout=null;connectionUrl;expiresAt;connected=!1;websocketRequestId=null;conversationId=null;secondaryTypeBasedHandlers=new Map;constructor(e,t,n,i=null,r=new Map){this.connectionUrl=t,this.expiresAt=n,this.client=new Xp({getClientAccessUrl:()=>e(this.connectionUrl,this.expiresAt)},{autoReconnect:!0,reconnectRetryOptions:{maxRetries:5,retryDelayInMs:100,maxRetryDelayInMs:1e4,mode:"Exponential"}}),this.handler=i,this.secondaryTypeBasedHandlers=r}async start(){const e=t=>{if(this.secondaryTypeBasedHandlers.has(t.message.data.type)){const n=this.secondaryTypeBasedHandlers.get(t.message.data.type);if(!n)return;n(t.message.data)}else{const n=t.message.data.body,i=atob(n).trim();if(i.startsWith("data: ")){const r=i.replace("data: ",""),o=this.handler;if(!o)return;o({conversationId:t.message.data.conversation_id,responseId:t.message.data.response_id,message:{id:"",event:"",data:r},websocketRequestId:t.message.data.websocket_request_id})}}};this.client.on("group-message",t=>e(t)),this.client.on("server-message",t=>e(t)),this.client.on("connected",()=>{this.connected=!0}),this.client.on("disconnected",()=>{this.connected=!1}),await this.client.start()}addSecondaryTypeHandler(e,t){this.secondaryTypeBasedHandlers.set(e,t)}isConnected(){return this.connected}async stop(e){e&&this.conversationId!==e||this.websocketRequestId&&await rt.stopWebsocketConversation(this.websocketRequestId)}setHandler(e,t,n,i){!this.handler&&this.websocketRequestId===n||(this.handler!=null&&this.websocketRequestId!==n&&(Uc.warn("[websockets] Overwriting existing handler without silencing. This may indicate a race condition."),Ve.logEvent(be.asyncHandlerOverwritten,{originalWebsocketRequestId:this.websocketRequestId,newWebsocketRequestId:n,conversationId:e,responseId:t})),this.websocketRequestId=n,this.conversationId=e,this.handler=r=>{(r.websocketRequestId===n||r.conversationId===e&&r.responseId===t)&&i(r.message)})}silence(){this.handler=null}close(){this.client.stop()}scheduleForTermination(e){this.terminationTimeout=setTimeout(()=>{this.close(),e()},sm)}preventTermination(){this.terminationTimeout&&(clearTimeout(this.terminationTimeout),this.terminationTimeout=null)}updateConnectionUrl(e,t){this.connectionUrl=e,this.expiresAt=t}}class om{activeSocketMap=new Map;secondaryTypeBasedHandlers=new Map;async register(){const e=await rt.postRegisterWebsocket();e.wss_url&&(this.getOrCreateSocket(e.wss_url,new Date(e.expires_at),!0),e.fallback_wss_url&&this.getOrCreateSocket(e.fallback_wss_url,new Date(e.expires_at),!1))}async registerIfNotConnected(){if(this.activeSocketMap.size===0){await this.register();return}for(const e of this.activeSocketMap.values())if(!e.isConnected()){await this.register();return}}isWebsocketConnected(){for(const e of this.activeSocketMap.values())if(e.isConnected())return!0;return this.activeSocketMap.size>0&&Se.addError("Cannot connect to any websocket."),!1}async getOrCreateSocket(e,t,n){const i=e.split("?")[0];let r;const o=this.activeSocketMap.get(i);if(o&&o.isConnected())o.preventTermination(),o.updateConnectionUrl(e,t),r=o;else{o&&o.close(),r=new rm(async(a,l)=>{if(new Date<new Date(l.getTime()-5*1e3))return a;const d=await rt.postRegisterWebsocket();return n?d.wss_url:d.fallback_wss_url??""},e,t,null,this.secondaryTypeBasedHandlers),this.activeSocketMap.set(i,r);try{await r.start()}catch(a){throw Se.addError(new Error("Error occurred while starting websocket: ",{cause:a})),a}}return r}preSetupWebsocket(e,t,n){for(const i of this.activeSocketMap.values())this.setupWebSocketHandler(i,null,null,null,e,t,n)}addSecondaryTypeHandler(e,t){this.secondaryTypeBasedHandlers.set(e,t);for(const n of this.activeSocketMap.values())n.addSecondaryTypeHandler(e,t)}hasSecondaryTypeHandler(e){return this.secondaryTypeBasedHandlers.has(e)}async processWebSocketConversationStream(e,t,n,i,r,o,a,l,d){const u=[this.getOrCreateSocket(e,n,!0)];t&&u.push(this.getOrCreateSocket(t,n,!1));const m=await Promise.allSettled(u),p=m[0].status==="fulfilled"?m[0].value:null,k=m.length>1&&m[1].status==="fulfilled"?m[1].value:null;if((!p||!p.isConnected())&&Se.addError(`Cannot connect to primary websocket, websocketRequestId: ${o}, token: ${e.substring(0,e.indexOf("access_token="))}`),(!p||!p.isConnected())&&(!k||!k.isConnected()))throw t&&Se.addError(`Cannot connect to fallback websocket, websocketRequestId: ${o}, token: ${t.substring(0,t.indexOf("access_token="))}`),new lt(`An error occurred while connecting to the websocket. ${Ts}`);let y=setTimeout(()=>{Se.addError(`WebSocket took too long to respond: ${r}, ${i}, ${o}, ${e.substring(0,60)}...${e.slice(-20)}`,{supportsWebSockets:"WebSocket"in window&&window.WebSocket.CLOSING===2})},im);const S=C=>(d&&(clearTimeout(d),d=null),y&&(clearTimeout(y),y=null),a(C));p&&this.setupWebSocketHandler(p,e,i,r,o,S,l),k&&t&&this.setupWebSocketHandler(k,t,i,r,o,S,l)}async stopConversation(e){for(const t of this.activeSocketMap.values())await t.stop(e)}setupWebSocketHandler(e,t,n,i,r,o,a){e.setHandler(n,i,r,o),this.secondaryTypeBasedHandlers.forEach((d,u)=>{e.addSecondaryTypeHandler(u,d)});const l=()=>{t?e.scheduleForTermination(()=>{this.activeSocketMap.delete(t.split("?")[0])}):(this.stopConversation(n),e.silence())};a.addEventListener("abort",l)}}const Xn=new om;function am(s){return{webSocketUrl:s.wss_url,fallbackWebSocketUrl:s.fallback_wss_url,conversationId:s.conversation_id,responseId:s.response_id,expiresAt:s.expires_at&&new Date(s.expires_at),websocketRequestId:s.websocket_request_id}}async function lm(s,e,t){return Xn.preSetupWebsocket(s,e,t)}async function cm(s,e,t,n,i,r,o,a,l){return Xn.processWebSocketConversationStream(s,e,t,n,i,r,o,a,l)}const dm="OAI-Echo-Logs",Pt={FOCUS_IN:0,FOCUS_OUT:1,COPY:2,PASTE:3,TOUCH_START:4,TOUCH_END:5},Ca=[];function Lt(s){return()=>{Ca.push({type:s,ts:Math.round(performance.now())})}}const hm={focusin:Lt(Pt.FOCUS_IN),focusout:Lt(Pt.FOCUS_OUT),copy:Lt(Pt.COPY),paste:Lt(Pt.PASTE),touchstart:Lt(Pt.TOUCH_START),touchend:Lt(Pt.TOUCH_END)};function ng(s){const e=s??document.getElementById(Fd);for(const[t,n]of Object.entries(hm))e?.removeEventListener(t,n),e?.addEventListener(t,n)}function um(){return{[dm]:Ca.slice(0,10).map(s=>`${s.type},${s.ts}`).join(",")}}const fm=1e3*30,ys=Xr.getTracer("completion"),xs=s=>s?.code==="challenge_required";class ks extends Error{}function pm(s,e,t,n){const i=async(r=null,o=!1)=>{fc()&&await pc();const a=new AbortController,l="threadId"in e?e.threadId:void 0,d="continueFromSharedConversationId"in e?e.continueFromSharedConversationId:void 0,u=qc(),m=ln.checkGate("1987334402"),p=ln.checkGate("2964350589"),k=[m&&vt.V1,p&&vt.V1_TEST].filter(Boolean),y={action:e.completionType,messages:e.messages.length>0?e.messages:void 0,conversation_id:l,continue_from_shared_conversation_id:l!=null?void 0:d,parent_message_id:e.parentMessageId,model:e.model,timezone_offset_min:new Date().getTimezoneOffset(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,variant_purpose:e.completionMetadata?.variantPurpose,suggestions:e.completionMetadata?.suggestions?e.completionMetadata.suggestions.map(v=>Bd(v)):void 0,history_and_training_disabled:e.historyDisabled,juice:e.completionMetadata?.juice,conversation_mode:e.completionMetadata?.conversationMode,force_paragen:e.forceParagen,force_paragen_model_slug:e.forceParagenModel,force_indepth_feedback:e.forceIndepthFeedback,force_rate_limit:e.forceRateLimit,reset_rate_limits:e.resetRateLimits,disable_system_content_toggling:e.disableSystemContentToggling,websocket_request_id:u,source:e.completionMetadata?.source,system_hints:e.completionMetadata?.systemHints,prefetch_ids:e.completionMetadata?.prefetchIds,force_use_sse:!Xn.isWebsocketConnected(),supported_encodings:k,conversation_origin:e.conversationOrigin,force_use_search:e.forceUseSearch,client_contextual_info:e.contextualInfo};let S,C;const N=Wc(s);Qr(N)?(C="https://chatgpt.com/backend-anon",S=Ci.getUnauthHeaders().additionalHeaders):(C="https://chatgpt.com/backend-api",S=Ci.getAuthedHeadersWithAccessToken(N?.accessToken));const P=`${C}/conversation`;let W=!0,K=!0;const M=Jc(e.chatReq,r??e.arkoseToken,e.turnstileToken,e.proofToken,null),R={...S,...um(),...M};let H,F,_;ys.startActiveSpan("completion.response",v=>{H=ys.startSpan("completion.first_response"),F=ys.startSpan("completion.first_token"),_=v});const L=Xr.setSpan(Ti.active(),_);let ie=null,le=null,Re,Me=!1;function Le(v){if(e.turnTracker.onBytesReceived(v.data),v.data==="[DONE]")a.abort(),_.end(),t({type:"done"}),xi();else if(v.event!=="ping")try{let I=JSON.parse(v.data);if(v.event==="delta_encoding")if(I===vt.V1||I===vt.V1_TEST)ie=I,e.turnTracker.stream_encoding=ie??void 0,le=new gc;else{Se.addError(`[completion-delta] unknown delta encoding: ${I}`);return}else if(v.event==="delta"){if(!le){Se.addError("[completion-delta] delta event before delta_encoding");return}const U=le.applyDelta(I);if(ie===vt.V1_TEST){!Me&&!$c(U,Re)&&(Me=!0,Se.addError("[completion-delta] delta resulted in a different object",{differences:yc(U,Re)}));return}else I=U}else ie===vt.V1_TEST&&!Me&&(Re=I);if(I.error){const U=new lt(I.error);throw t({type:"error",error:U}),U}else"type"in I?I.type==="gizmo_inline_review"?t({type:"gizmo_inline_review",gizmoId:I.gizmo_id}):I.type==="title_generation"?t({type:"title_generation",title:I.title,conversation_id:I.conversation_id}):I.type==="moderation"?t({type:"moderation",conversationId:I.conversation_id,messageId:I.message_id,isCompletion:I.is_completion,flagged:I.moderation_response.flagged,blocked:I.moderation_response.blocked,disclaimers:I.moderation_response.disclaimers,metadata:I.moderation_response.metadata}):I.type==="url_moderation"?t({type:"url_moderation",conversationId:I.conversation_id,messageId:I.message_id,url:I.url_moderation_result.full_url,isSafe:I.url_moderation_result.is_safe}):I.type==="num_variants_in_stream"?t({type:"num_variants_in_stream",num_variants_in_stream:I.num_variants_in_stream,display_treatment:I.display_treatment}):I.type==="conversation_detail_metadata"&&t(I):(t({type:"message",message:I.message,conversationId:I.conversation_id}),K&&(K=!1,H.end()),W&&I.message.author.role==="assistant"&&I.message.content.content_type==="text"&&I.message.content.parts[0]!==""&&(W=!1,F.end()))}catch(I){if(I instanceof nt)throw new lt(I.message)}}let Ne=null,_e=setTimeout(()=>{Ne===!0?(Ve.logEvent(be.asyncResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:An.Error,error:{reason:"timeout",message:"Async Response Took Too Long to Come Back"}})):Ne===!1&&(Ve.logEvent(be.sseResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:An.Error,error:{reason:"timeout",message:"SSE Response Took Too Long to Come Back"}}))},fm);return lm(u,Le,a.signal),Ti.with(L,()=>(e.profiler?.logTiming("fetch_event_source"),mc(P,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...R},body:JSON.stringify(y),signal:a.signal,openWhenHidden:!0,async onopen(v){const I=v.headers.get("content-type")??"",U=v.headers.get("Cf-Ray")??null;if(v.ok&&I.includes("text/event-stream")){Ne=!1,n(U,e.model,e.turnTracker);return}else if(I.includes("application/json")){const $=await v.json(),{webSocketUrl:We,fallbackWebSocketUrl:re,conversationId:he,responseId:j,expiresAt:te,websocketRequestId:ce}=am($);if(We!=null&&he!=null&&j!=null&&ce!=null&&te){Ne=!0,n(U,e.model,e.turnTracker);try{await cm(We,re,te,he,j,ce,Le,a.signal,_e)}catch(V){V instanceof lt&&t({type:"error",error:V})}throw new ks}else{const V=$?.error??$?.detail,Je=V?.message??V??"Unknown server error";if(V){if(xs(V))throw new nt(Je,v.status,V.code);if(v.status>=500)throw new lt(Je);{if((V?.code==="expired_session_key"||V?.code==="invalid_api_key"||V?.code==="token_expired")&&typeof window<"u"&&window._oaiHandleSessionExpired?.("stream",JSON.stringify(V)),V?.code==="deactivated_workspace"){window.location.href.includes("/workspace/deactivated")||(window.location.href="/workspace/deactivated");return}const wt=V?.can_retry;throw new nt(Je,v.status,V?.code,V?.type,void 0,V?.clears_in,wt)}}else Se.addError("Missing completion error field",{json:$,serverRequestId:U})}}else Se.addError("Unexpected completion open message content type",{contentType:I,serverRequestId:U});throw new lt(Mi)},onmessage:v=>{if(Ne)throw new lt(Mi);_e&&(clearTimeout(_e),_e=null),Le(v)},onerror(v){let I=v instanceof Error?v:new Error(JSON.stringify(v));throw I instanceof ks||Ne||xs(I)&&!o||(I.message==="Failed to fetch"&&(I=new lt(`An error occurred. Either the engine you requested does not exist or there was another issue processing your request. ${Ts}`)),I.message==="network error"&&(I=new nt(`A network error occurred. Please check your connection and try again. ${Ts}`,400)),Hc("fetch-error:conversation:new-message",{url:P,message:I?.message}),t({type:"error",error:I}),xi(I)),I}}))).catch(async v=>{if(xs(v)){if(o)throw new nt("Failed to complete your call, please try again",v.status);{const I=await Ms.getEnforcementToken(e.chatReq);return i(I,!0)}}v instanceof ks||(Se.addError(v),e.turnTracker.handleRawError(v.message??"Something went wrong",v.status))}),a};return i()}function sg({clientThreadId:s,continuingFromSharedConversationId:e,onCompletionFinished:t=ws,onCreate:n=ws}){const i=Gc(),{resolvedTheme:r}=Hn(),o=r==="dark",a=D.useRef(t),l=Kc();a.current=t;const d=D.useCallback(async function({model:u,completionType:m,parentNodeId:p,metadata:k,focusOnNewCompletion:y=!0,completionMetadata:S,chatReq:C,arkoseToken:N,turnstileToken:P,proofToken:W,preflightTime:K,extraStreamParams:M,appendMessages:R,updateTree:H,turnTracker:F,profiler:_}){Hr.publish({kind:"requestCompletion"});const L=A.getTree(s);A.retainThread(s);const ie=Nd(),le=`${xc}${s}-${ie}`,Re=`${s}-${ie}`;H?.();const Me=L.getNodeByIdOrMessageId(p),Ne={gizmo_id:Me.message.metadata?.gizmo_id};S?.juice!=null&&(Ne.snorkle_status=1),A.updateTree(s,j=>{j.addNode(le,"",p,dt.Assistant,void 0,Ne)}),y&&A.setThreadCurrentLeafId(s,le);let _e,Ae=[],v=L.getNodeByIdOrMessageId(Me.parentId);for(;v!=null&&(v.metadata?.isPlaceholderTemplateAssistantWelcomeMessage===!0||v.metadata?.isClientCreatedSystemMessage===!0);){const j=v.message;Ae.unshift(j);const te=L.getNodeByIdOrMessageId(v.parentId);_e=te.message?.id??te.id,v=te}if(m===tn.Next||m===tn.Variant){const j=L.getNodeByIdOrMessageId(Me.parentId);if(_e??=j.message?.id??j.id,Ae.push(Me.message),R){let te=p;A.updateTree(s,ce=>{for(const V of R)ce.insertNodeBefore(le,{id:V.id,message:V,parentId:te,children:[]}),te=V.id}),Ae.push(...R)}Ae=mm(Ae,M)}else _e??=Me.message.id;const I=A.getServerThreadId(s);I===void 0&&Xs(s)&&A.updateInitialThreadDataForNewThread(s,u);async function U(j,te){const ce=performance.now(),V=await Yc();Ms.initializeAndGatherData(V),ki.initializeAndGatherData(V),Ei.initializeAndGatherData(V),A.updateTree(s,ot=>{for(const Xe of te)ot.addNode(Xe.id,Xe,j,dt.Assistant,{completionSampleFinishTime:Date.now()}),j=Xe.id}),A.setThreadCurrentLeafId(s,j);const Je=await Ms.getEnforcementToken(V),wt=await ki.getEnforcementToken(V),bn=await Ei.getEnforcementToken(V);d({model:u,completionType:tn.Next,parentNodeId:j,metadata:{},chatReq:V,arkoseToken:Je??null,turnstileToken:wt??null,proofToken:bn??null,preflightTime:performance.now()-ce,extraStreamParams:M,turnTracker:F})}F.updateAttachmentCount(Ae);const $=new Gp(i,s,le,m,u,k.eventSource,n,Re,U,(...j)=>a.current(...j),F,l),We=(j,te,ce)=>{j&&ce.onReceivedRequestId(j),bc(Re,te,j,K)},re={is_dark_mode:o,time_since_loaded:Math.floor(performance.now()/1e3),page_height:window?.innerHeight,page_width:window?.innerWidth,pixel_ratio:window?.devicePixelRatio,screen_height:window?.screen?.height,screen_width:window?.screen?.width},he=await pm(i,{conversationOrigin:A.getConversationOrigin(s),model:u,completionType:m,threadId:I,continueFromSharedConversationId:e,historyDisabled:l,parentMessageId:_e,messages:Ae,chatReq:C,arkoseToken:N??null,turnstileToken:P??null,proofToken:W??null,completionMetadata:S,...M,turnTracker:F,profiler:_,contextualInfo:re},$.handleResponse,We);$s.addRequest(le,he,F),Us.onCompletionRequestStarted(le)},[s,i,n,e,l,o]);return d}const mm=(s,e)=>{let t=s;return e?.forceUseSearch===!1&&s.length>0&&(t=s.map(n=>{const{system_hints:i,...r}=n.metadata||{};return{...n,metadata:{...r,system_hints:i?.filter(o=>o!==kc.Search)}}})),t};function ig(s,e,t,n){let i=Sc.getReadyFiles(s.getState());n?.kind===Be.GizmoMagicCreate?i=i.filter(p=>p.gizmoId!=null):i=i.filter(p=>p.gizmoId==null);let r=e??"";const o=[],a=[],l=wc(t,n),u=Cc(t,n).length>0,m=l===is.Interpreter||l===is.Retrieval||l===is.ContextConnector;return i.forEach(({fileSpec:p})=>{if(m){const k=p.contextConnectorInfo;o.push({id:p.id,size:p.size,name:p.name,context_connector_info:k?{context_connector:k?.contextConnector,source_url:k?.sourceUrl,synthetic_extension:k?.syntheticExtension??null,type:k?.type}:void 0,mime_type:p.mimeType,width:"width"in p?p.width:void 0,height:"height"in p?p.height:void 0,file_token_size:p.fileTokenSize})}u&&"width"in p&&"height"in p&&a.push({content_type:Zc.ImageAssetPointer,asset_pointer:Tc(p.id),size_bytes:p.size,width:p.width,height:p.height})}),a.length>0&&(a.push(e??""),r={content_type:$n.MultimodalText,parts:a}),{content:r,attachments:o}}async function rg({clientThreadId:s,currentRequestId:e,queryClient:t,isHistoryAndTrainingDisabled:n}){const i=A.getServerThreadId(s);Xn.stopConversation(i);const r=A.getTree(s);!r.hasReceivedServerCompletion&&!n&&r.getParent(e).metadata?.errCode!==st.ContentPolicy&&setTimeout(()=>{qs.onCreateFinished(t,i,n)},500),i&&ln.checkGate("3922476776")&&await rt.stopConversationProcess(i),$s.abortRequest(e)&&A.updateTree(s,a=>{const l=A.getThreadCurrentLeafId(s);a.updateNodeMessageMetadata(l,{finish_details:{type:"interrupted"}})})}function gm(s){return`https://chatgpt.com${Cd(s)}`}function og(s,e,t,n){Mc(gm(s),e,t),n&&e.info(n)}function ag(s){return s.some(e=>e.type===Qc.JIT_PLUGIN)}function ym(s){return"gizmo_id"in s?s.gizmo_id??null:null}const xm=s=>["conversation","init",s],km=({clientThreadId:s,conversationMode:e,clientModelId:t},n)=>{const i=ym(e),r=Xs(s)?null:s;return{gcTime:0,refetchOnWindowFocus:!0,refetchOnMount:"always",queryKey:xm(s),queryFn:()=>rt.getConversationDetails({conversationId:r,gizmoId:i,requestedDefaultModel:t}),enabled:!Ec(s)}},bm=s=>(Xc(),Ys(km(s))),Sm=(s,e)=>{const t=(typeof s=="string"?[s]:s)??[];for(const n of t)if(n&&e.has(n))return n;return null},lg=(s,e)=>{const t=Td(),{query:n}=ed(),i=Md(n),{modelId:r=null}=Ic()??{};Pd(s);const o=_d(s)??null,a=[i,o,r],l=Sm(a,t);D.useEffect(()=>{A.initThread(s,e,l),Cs.reset()},[s]);const d=td(),u=D.useCallback(()=>{const y={...n};delete y.model;const S=nd.stringify(y);d({search:S.length>0?`?${S}`:""})},[n,d]),{isLoading:m,data:p}=bm({clientThreadId:s,clientModelId:a.find(y=>!!y)??null,conversationMode:e}),k=sd();D.useEffect(()=>{if(!(!i||m)){if(!t.has(i)||k.find(y=>y.model_slug===i))return u();A.setThreadModelId(s,i)}},[i,k,t,s]),D.useEffect(()=>{if(m||!p)return;const{default_model_slug:y}=p;i&&y&&i!==y&&u(),Cs.updateDetails(p),y&&A.setThreadModelId(s,y)},[m,p])};export{ft as $,Ye as A,og as B,Qm as C,de as D,Vm as E,E as F,Km as G,gm as H,ge as I,$m as J,vm as K,Xt as L,rn as M,q as N,ng as O,zm as P,Xn as Q,Ue as R,Y as S,ui as T,ig as U,ag as V,di as W,Zm as X,Zh as Y,nh as Z,Gt as _,Fe as a,Ge as a0,Uh as a1,Hm as a2,Jm as a3,Um as a4,Yf as a5,qm as a6,O as b,Lm as c,X as d,Pm as e,Fm as f,Xm as g,fp as h,ka as i,ap as j,Wm as k,Bm as l,Ym as m,eg as n,Gm as o,je as p,jm as q,qh as r,Hp as s,Wt as t,lg as u,sg as v,Kd as w,Zd as x,rg as y,io as z};
//# sourceMappingURL=hhndevom81hqjije.js.map
