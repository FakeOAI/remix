import{N as j,r as u,f as J,x as Q,R as Y}from"./c3nnbeco67svv9me.js";import{du as Z,dv as $,dw as k,dx as z,dy as W,dz as X,dA as ee,dB as P,dC as se,dD as te,dE as oe,cG as ne,dF as re,dG as S,bO as ae,dH as ce,dI as de,dJ as ie,dK as ue,dL as Te,dM as w,dN as le,dO as me,dP as fe,dQ as xe,dR as pe,dS as Ie,dT as q,dU as F,dV as ge,dW as ve}from"./ddabru9k2rsup3m3.js";import{a as Ee,T as y,m as Me,n as Ce,o as he}from"./dxoslro1rvwd67ew.js";const ye=e=>J.safeGet("/conversation/{conversation_id}/textdocs",{parameters:{path:{conversation_id:e}}}),Re=async e=>{const o=await ye(e),n=new Map(o?.map(t=>[t.id,t])),s=[];for(const{id:t,content:a,version:l,textdoc_type:r,title:g,comments:p}of o)s.push({textdocId:t,messageId:null,type:z(r),comments:W(p,a),title:g,content:a,versionInt:l,createdAt:0});return{persistedTextdocVersionById:new Map(s.map(t=>[t.textdocId,t])),persistedTextdocVersions:s,persistedTextdocById:n}};function Oe({clientThreadId:e,isEnabled:o}){const n=Ee(()=>y.getServerThreadId(e)),{data:s,error:T,isLoading:t,isFetching:a,refetch:l}=j({queryKey:[n,"textdocs"],enabled:!!n&&o,gcTime:0,queryFn:()=>n&&Re(n)});return u.useEffect(()=>{if(!s)return;const{persistedTextdocVersions:r}=s;Z(r),$(r),k(r)},[s]),[{...s,error:T,isLoading:t,isFetching:a},l]}var _=(e=>(e[e.INITIALIZING=0]="INITIALIZING",e[e.READY=1]="READY",e[e.REFETCHING=2]="REFETCHING",e))(_||{});function Ve({clientThreadId:e,isEnabled:o}){const[{error:n,persistedTextdocVersionById:s=null,isLoading:T,isFetching:t},a]=Oe({clientThreadId:e,isEnabled:o}),l=X();ee(()=>{if(!o)return;const g=y.getThreadCurrentLeafId(e),p=y.getThreadConversationTurns(e,g),R=P(p)?.messages??[],m=se(R);if(m==null)return;const v=m.message.metadata?.canvas?.textdoc_id,O=m.message.metadata?.canvas?.version;v!=null&&O!=null&&l(v,O),a()});let r=0;return s&&t?r=2:s&&!t&&!T&&(r=1),u.useMemo(()=>({status:r,fetchError:n,textdocVersionById:s}),[r,n,s])}const K=e=>{if(!e)return;const{messages:o}=e,n=xe(o??[],({message:T})=>T.author.role===Y.System),s=n===-1?o:o?.slice(n+1);if(s&&pe(s))return s};function Fe({clientThreadId:e,isEnabled:o}){const n=Me(e),s=Ce(e,n),T=he(e),t=ne(T),a=Ve({isEnabled:o,clientThreadId:e}),l=re(),[r,g]=u.useState(!0),p=o&&(t||!r||a.status===_.REFETCHING),c=P(s),R=u.useMemo(()=>{if(!c||!S(c))return null;const I=y.getTree(e),{variantIds:V}=c;return V.map(L=>{const A=I.getLeafFromNode(L).id;return P(y.getThreadConversationTurns(e,A))})},[e,c]),m=u.useMemo(()=>!p||!c?null:S(c)?R?.flatMap(K).filter(ae):K(c),[p,c,R]),v=!!m,O=u.useMemo(()=>s.slice(0,v?-1:s.length),[s.length,v]),b=ce(O),B=de(),D=ie(),H=ue(),E=u.useMemo(()=>{let I=Te(b);const{textdocVersionById:V,fetchError:L,status:A}=a;return I=w(I,d=>{d.fetchError=L,d.isFetchingFromPersistence=A===_.REFETCHING;for(const{pastedAt:f,content:M,metadata:C,tempId:i}of H){const G=d.resolveTempTextdocId[i]??i,{title:h="",type:x=Ie.DOCUMENT}=C??{};q(d,{textdocId:G,title:h,type:x,content:M,createdAt:f,versionInt:0,comments:[],messageId:null})}if(V)for(const[f,M]of V.entries()){d.allTextdocIdSet[f]=f;const C=l.get(f);let i=C&&(C.versionInt??F)>(M.versionInt??F)?{...M,...C}:M;const G=D.filter(x=>x.textdocId===f&&x.kind===ge.REMOVE_COMMENT);let h=i.versionInt;for(const x of G)i=ve(i,x),h=Math.max(h??F,x.versionInt??F);i={...i,versionInt:h},d.textdocById[f]=void 0,q(d,i)}}),B?w(I,d=>{q(d,B,!1)}):I},[H,b,a,l,B,D]),U=u.useMemo(()=>m?.length?le(t,E,m):null,[m,t,E]),N=me(t,U,g);return u.useMemo(()=>N?fe(E,N):E,[E,N])}function Ge({clientThreadId:e,children:o}){const n=te(),s=Fe({clientThreadId:e,isEnabled:n});return Q.jsx(oe.Provider,{value:s,children:o})}export{Ge as T};
//# sourceMappingURL=kmauv941hi5z31ol.js.map
