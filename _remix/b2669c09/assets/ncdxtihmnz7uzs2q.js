const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/sso-ei5cecann8hf7lip.js","assets/ggdh7pjp5xcwrnsg.js","assets/mkisucl9ntf4tsct.js","assets/root-pebmx3ar.css","assets/ga5s79t7codos54i.js","assets/bmls73y1gwdy9wkg.js","assets/conversation-small-cll5buey.css","assets/nrk2wv4lcsm4aots.js","assets/jp106jrxp4bfcof8.js","assets/nn7abvtqye2kbvi4.js","assets/ofl8v1acfagq5bb7.js","assets/byh20kidpgjmgfje.js","assets/bvmv4im6saihms8x.js","assets/ol6oz5ym28raltgk.js","assets/gzoio6oye21kcfa0.js","assets/ke08c2wqynrokvch.js","assets/fgt67ipi88ezbgcx.js","assets/ejj4go3j2v7qycqx.js","assets/md6erb7wpqs3e875.js","assets/lfd0fq17rva569ka.js","assets/i4re4kqybkw3wxby.js","assets/k0hdaumq4i16oh66.js","assets/itghwucfyv5ciib7.js","assets/d7q75hq6pv167xxp.js","assets/hswlyq3gnf595cdl.js","assets/ioh3yma6lma1f2tx.js","assets/l0afo4mv071h7cgi.js","assets/983a0dy92b3ronpv.js","assets/knt5hxene8rncedn.js","assets/kqwdyvkaaavvn8k3.js","assets/i7sx7ij8o6gzefpg.js","assets/ehldfke21qekbfjl.js","assets/ewfb3td5ccdzcp0w.js","assets/e8bqp3omr06sq0w8.js","assets/e9lafxuzyeh4418f.js","assets/p7vs437hsgdk057h.js","assets/nv5rvzmqmr1o6j13.js","assets/ry8yvnh99dahtrha.js","assets/pdjtr02b2s60zfpr.js","assets/mzlnskr7512hkj3p.js","assets/kmnn8dxcidzhcc23.js","assets/ordz4ezukj4qwbp3.js","assets/hqxje1ee4ut99fvd.js","assets/f7pbuz9n7jc1m90v.js","assets/e6nxwob2cmyuoe3j.js","assets/h0llsmg5c6q5ftwg.js","assets/iej0cupg2dqkmejt.js","assets/oucv9dvvdvszwx63.js","assets/bycuy9hbz25j3oc7.js","assets/jk8w36bsokizpx57.js","assets/kmabjs2svu2uh2iv.js","assets/fijmao353nam8uul.js","assets/nb5pqnpjje55idwl.js","assets/o40bqbkoe6gbnp61.js","assets/d3y72ugnrmac5z1v.js"])))=>i.map(i=>d[i]);
import{bF as pt,c as is,ag as ve,fq as as,eD as Fn,bC as jn,bm as Oe,r as v,bq as Le,j as qt,l as Te,a2 as Dn,$ as Xe,P as A,w as Wt,e_ as Pn,fc as Un,a4 as xe,b as B,y as d,a1 as O,n as On,X as Me,an as ke,fE as Et,bb as Ne,bc as cs,fD as ls,T as Ue,W as Ze,O as mt,c8 as us,bh as We,Z as gt,a6 as $t,u as et,aR as yt,a9 as Ln,bV as ds,bT as hs,ar as ct,el as qn,S as oe,bJ as Wn,bd as $n,bi as Gn,bA as kt,bv as fs,aw as ps,av as Pe,cj as Gt,x as ms,e8 as Ht,e9 as Hn,D as we,fF as gs,as as ye,fv as ys,fG as Pt,R as Ce,e7 as Ke,M as _s,ej as zn,ef as Vn,fH as Ut,bK as ws,fI as Kn,v as xs,f as sn,fJ as vs,fK as on,fL as an,fM as Is,fN as Cs,C as Ss,au as bs,dQ as Es,bw as cn,bn as ks,bo as ln,bp as un,a8 as zt,df as Ts,aW as Ms,f9 as Rs,dN as As,fb as Bs,fh as Ns,aU as lt,fj as Fs,bI as js}from"./ggdh7pjp5xcwrnsg.js";import{ak as _t,kD as Ds,kE as Qn,jP as Ps,kF as Us,kG as Os,kH as Ls,V as qs,dp as Jn,ix as Yn,ad as Ws,kI as Xn,jv as Zn,fV as $s,j5 as Gs,jD as er,ex as Hs,bX as wt,kJ as zs,kK as Vs,kL as rt,kM as Ks,kN as tr,kO as Tt,kP as Qs,kQ as Js,b7 as Fe,kR as Ys,kS as Xs,kT as Zs,aL as he,kU as nr,aE as dn,aF as $e,aG as xt,aQ as eo,bf as to,bg as no,aT as ro,aU as rr,aV as ut,aW as Ge,b6 as so,bh as de,kV as me,bi as oo,aX as io,aY as ao,aZ as co,a$ as sr,a_ as lo,aI as uo,b3 as ho,b4 as fo,b8 as po,b9 as mo,kW as go,kX as yo,kY as _o,kZ as wo,bb as hn,k_ as or,bc as xo,b5 as vo,be as Io,k$ as Co,l0 as So,l1 as bo,l2 as ir,l3 as Eo,l4 as ko,l5 as Mt,l6 as To,fc as Mo,y as Vt,r as vt,f as Ro,ho as Kt,d2 as ar,cd as fn,w as cr,aw as Ao,bz as Bo,l7 as No,bm as lr,v as ur,l8 as Fo,bv as jo,l9 as Do,la as Po,h as Uo,jK as pn,jH as mn,lb as Oo,lc as Lo,ld as qo,le as Wo,lf as $o,lg as Go,c$ as Ho,lh as dt,cx as dr,li as zo,fm as Qt,lj as Jt,lk as Vo,ll as Ko,lm as Qo,ln as ue,lo as Jo,lp as it,lq as st,lr as Yo,ls as hr,fr as ce,lt as Xo,lu as Zo,lv as He,lw as ei,lx as gn,ly as ti,lz as ni,cE as ri,cm as yn,cH as si,lA as oi,G as ii,fu as ai,lB as ci,lC as li,lD as ui,lE as di,H as hi,lF as fi,lG as pi,cy as mi,bY as gi,c9 as _n,u as yi,t as _i}from"./bmls73y1gwdy9wkg.js";import{u as Yt,a9 as wi,b_ as fr,a2 as pr,aT as xi,_ as vi,q as Ii,J as Ci,ag as Si,p as bi,b0 as mr,bs as gr,bx as yr,b$ as _r,I as Ei,b6 as Rt,V as wr,aJ as ki,c0 as Ti,bt as Mi,bc as Ri}from"./mkisucl9ntf4tsct.js";import{D as J,B as Ai}from"./ioh3yma6lma1f2tx.js";import{J as xr,M as vr,N as Ir,L as Cr,u as Bi,a as Ni,O as Fi,g as wn,G as ji,f as Di,Q as Pi,K as Ui}from"./ofl8v1acfagq5bb7.js";import{c as Sr,d as br,r as Er,s as kr}from"./f7pbuz9n7jc1m90v.js";import{u as Oi}from"./jkxlt9rtggccetnk.js";import{U as _e,G as qe,a as Li,u as Tr,b as Mr}from"./ol6oz5ym28raltgk.js";import{a as ht,T as E,o as Rr,b as ft,C as Ar,l as Xt,M as qi,N as Wi,O as $i,P as Gi,i as Hi,d as zi}from"./byh20kidpgjmgfje.js";import{i as Vi}from"./gzoio6oye21kcfa0.js";import{T as Ki,a as Qi}from"./n4okdvbrbd9jb2rf.js";const Ji=()=>{const{value:t}=pt("44045625");return t},El=()=>{const{value:t}=pt("3700195277");return t||!1},Br=t=>{const e=xr(t);return Ji()&&!!e?.includes("canmore")},kl=()=>{const{value:t}=pt("711369489");return t||!1};function Yi(){return Fn(jn.DataAnalysisV2)}function Tl(){const t=_t(),e=ve();return e&&t&&!as(t)&&e.isEnterprisey()}function Ml(){return Fn(jn.ChartSerialization)}function Rl(t,e){const s=t==="chart"?Oe.HasSeenAdaInteractiveChart:Oe.HasSeenAdaInteractiveTable,[o,a]=v.useState(Le.getItem(s,{userId:e})??!1),u=v.useCallback(()=>{a(!0),Le.setItem(s,!0,{userId:e})},[s,e]);return[o,u]}function Al(t){const[e,s]=v.useState([]),o=ht(()=>{const a=E.resolveThreadId(t),u=E.getThreadCurrentLeafId(t);return E.getTree(a).getBranchFromLeaf(u)});return v.useEffect(()=>{const a=Nr(o);a.length!==e.length&&s(a)},[e.length,t,o]),e}function Xi(t){return ht(()=>{const e=E.resolveThreadId(t),s=E.getThreadCurrentLeafId(t),a=E.getTree(e).getBranchFromLeaf(s);return Nr(a).length>0})}function Zi(t){const e=t.metadata?.aggregate_result?.messages.filter(Vi)??[];let s=0;const o=(t.metadata?.ada_visualizations??[]).map(u=>{let h=u;return u.type=="chart"&&(h={...u,fallback_image:e[s++]}),h}),a=(t.metadata?.attachments??[]).filter(u=>Ps(u.name)).map(u=>({type:"table",file_id:u.id??"",title:Us(u),file_name:u.name,context_connector_info:u.context_connector_info}));return[...o,...a]}function Nr(t){return t.filter(s=>s.message?.author.role==="tool"&&s.message?.author.name==="python"||(s.message?.metadata?.attachments??[]).length>0).flatMap(s=>Zi(s.message))}is(t=>({selectedSpreadsheet:null,setSelectedSpreadsheet:e=>t({selectedSpreadsheet:e})}));async function ea(t,e,s){const o=await t.text(),{parse:a}=await Xe(async()=>{const{parse:h}=await import("./oeujip5i1ptrxie5.js");return{parse:h}},[]),u=a(o);return{content:{columnNames:u.shift(),columnTypes:u[0].map(()=>"string"),rows:u},file_name:e,download_url:s}}function ta(t){const e=t[0].values.length,s=[];for(let o=0;o<e;o++){const a=t.map(u=>u.values[o]);s.push(a)}return s}function Bl(t){return qt({queryKey:["ada-visualization","chart",t.file_id],queryFn:async()=>{const e=await Te.getFileDownloadLink(t.file_id);if(e.status===Dn.Success){const o=await(await fetch(e.download_url)).json();return{content:{chart_type:o.type,title:o.title,labels:o.labels,datasets:o.datasets,x_label:o.x_label,y_label:o.y_label},file_name:e.file_name??"",download_url:e.download_url}}else throw new Error("Failed to download chart json from interpreter")}})}function Nl(t){return qt({queryKey:["ada-visualization","table",t.file_id],queryFn:async()=>{if(t.file_name&&Ds(t.file_name)){const e=await Te.getAdaExcelFileContents(t.file_id);return{content:e.sheets.map(s=>({name:s.name,columnNames:s.columns.map(o=>o.name),columnTypes:s.columns.map(()=>"string"),rows:ta(s.columns)})),download_url:e.download_url,file_name:t.file_name}}else{const e=await Te.getFileDownloadLink(t.file_id);if(e.status===Dn.Success){const s=await fetch(e.download_url);return ea(s,e.file_name??"",e.download_url)}else throw new Error("Failed to download from interpreter")}}})}function na(t){const e=Qn(),s=Xi(t),o=Yi();return s&&o&&!e.displayingSideBySideFeedback}function Fl(t){return Os(t)&&!Ls(t)}const ot=50,ra=95;function jl(t,e){if(t<=e)return t/e*ot;{const s=ot,o=ra-ot,a=t-e,h=-(ot/e)/o;return s+o*(1-Math.exp(h*a))}}class sa{mostRecentCompletionRequest;loggedRequests=new Set;onCompletionRequestStarted(e){this.mostRecentCompletionRequest={requestId:e,timestamp:Date.now()},this.loggedRequests.clear()}logEvent(e,s,o,a,u){const h=this.mostRecentCompletionRequest;if(h!=null&&!this.loggedRequests.has(e)){const g=E.getThreadConversationTurns(s,o).find(_=>_.messages.some(x=>x.message.id===o));g!=null&&g.messages.some(_=>_.nodeId===h.requestId)&&(A.logEvent(e,{messageId:o,timeMs:Date.now()-h.timestamp,...a}),u?.(),this.loggedRequests.add(e))}}}const oa=new sa;function Dl(t){return(t.find(a=>a.message.metadata?.image_search_results!==void 0)?.message.metadata?.image_search_results??[]).slice(0,5)}const Fr=qs.DesktopBrowserExtensionAnnouncement,ia=5,jr="https://chromewebstore.google.com/detail/searchgpt/ejcfepkfckglbgocfkanmcdngdijcgld";function Pl({onClose:t}){v.useEffect(()=>{A.logEventWithStatsig(B.chatgptBrowserExtensionAnnouncementShown,"chatgpt_browser_extension_announcement_shown")},[]);const{markAsViewed:e}=Jn(Fr),s=v.useCallback(()=>{e(),A.logEventWithStatsig(B.chatgptBrowserExtensionAnnouncementClosed,"chatgpt_browser_extension_announcement_closed"),t&&t()},[e,t]),o=v.useCallback(()=>{A.logEventWithStatsig(B.chatgptBrowserExtensionAnnouncementCTAClicked,"chatgpt_browser_extension_announcement_cta_clicked"),e(),t&&t()},[e,t]);return d.jsx(aa,{downloadUrl:jr,handleCTAClicked:o,handleClose:s})}function aa({downloadUrl:t,handleCTAClicked:e,handleClose:s}){const o=()=>{e(),window.open(t)},a=d.jsxs("div",{className:"flex-grow",children:[d.jsx("div",{className:"mb-0.5 font-semibold",children:d.jsx(O,{id:"uAZwaE",defaultMessage:"Use ChatGPT for every search"})}),d.jsx("span",{className:"text-token-text-secondary",children:d.jsx(O,{id:"+wTq4L",defaultMessage:"Download the Chrome extension to switch your default search engine to ChatGPT, and get instant answers from trusted sources with every search."})})]});return d.jsx(Ws,{onPrimaryCtaClick:o,primaryCtaText:d.jsx(O,{id:"x9mKG0",defaultMessage:"Get Extension"}),onDismiss:s,content:a})}function Ul(t){const{value:e}=Wt("2634628831"),{eligible:s,isLoading:o}=Jn(Fr),a=Pn(()=>document.documentElement.dataset.searchExtension==="1"),u=vr(t.clientThreadId,Un.Search),h=ca();return{eligible:!(!e||a||!s||!u||!Yn()||!h||t.conversationMode?.kind!==xe.PrimaryAssistant),isLoading:o}}function Ol(t){const e=Le.getItem(Oe.SearchSettings)??{};e.hasSearchedMinTimes||(e.searchMessageIds||(e.searchMessageIds=[]),e.searchMessageIds.includes(t)||(e.searchMessageIds.push(t),e.searchMessageIds.length>=ia&&(e.hasSearchedMinTimes=!0,delete e.searchMessageIds),Le.setItem(Oe.SearchSettings,e)))}function ca(){return(Le.getItem(Oe.SearchSettings)??{}).hasSearchedMinTimes===!0}const la=({children:t})=>{const e=Xn();return e?.length?d.jsxs(J.Root,{children:[d.jsx(J.Trigger,{className:"h-10 px-2",children:t}),d.jsx(J.Content,{align:"end",onCloseAutoFocus:s=>s.preventDefault(),children:e.map(s=>d.jsx(ua,{textdocId:s},s))})]}):null},ua=({textdocId:t})=>{const e=On(Zn(t));return d.jsx(J.Item,{icon:Yt,onClick:()=>{$s.logButtonClick(Gs.FILE_DRAWER_ITEM),er(e.textdocId)},children:e.title})},da=()=>{const t=Me(),e=Xn(),s=Hs();if(!e||s)return null;const o=e.length;return o===1?d.jsx(ha,{textdocId:e[0]}):d.jsx(la,{children:d.jsx(ke,{label:t.formatMessage({id:"xX2Zyt",defaultMessage:"Open canvas"}),children:d.jsxs("div",{className:"flex items-center gap-1 text-token-text-secondary",children:[d.jsx(Yt,{className:"icon-xl-heavy"}),o]})})})},ha=({textdocId:t})=>{const e=Me(),s=On(Zn(t));return d.jsx(ke,{label:e.formatMessage({id:"xX2Zyt",defaultMessage:"Open canvas"}),children:d.jsx(wt,{onClick:()=>er(s.textdocId),icon:Yt})})},xn=({clientThreadId:t,children:e})=>Br(t)?d.jsx(zs,{children:e}):e,Dr={...cs},fa=Dr.useInsertionEffect,pa=fa||(t=>t());function Pr(t){const e=v.useRef(()=>{});return pa(()=>{e.current=t}),v.useCallback(function(){for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];return e.current==null?void 0:e.current(...o)},[])}var Ot=typeof document<"u"?v.useLayoutEffect:v.useEffect;let vn=!1,ma=0;const In=()=>"floating-ui-"+Math.random().toString(36).slice(2,6)+ma++;function ga(){const[t,e]=v.useState(()=>vn?In():void 0);return Ot(()=>{t==null&&e(In())},[]),v.useEffect(()=>{vn=!0},[]),t}const ya=Dr.useId,_a=ya||ga;function wa(){const t=new Map;return{emit(e,s){var o;(o=t.get(e))==null||o.forEach(a=>a(s))},on(e,s){t.set(e,[...t.get(e)||[],s])},off(e,s){var o;t.set(e,((o=t.get(e))==null?void 0:o.filter(a=>a!==s))||[])}}}const xa=v.createContext(null),va=v.createContext(null),Ia=()=>{var t;return((t=v.useContext(xa))==null?void 0:t.id)||null},Ca=()=>v.useContext(va),Sa="data-floating-ui-focusable";function ba(t){const{open:e=!1,onOpenChange:s,elements:o}=t,a=_a(),u=v.useRef({}),[h]=v.useState(()=>wa()),c=Ia()!=null,[g,_]=v.useState(o.reference),x=Pr((y,C,b)=>{u.current.openEvent=y?C:void 0,h.emit("openchange",{open:y,event:C,reason:b,nested:c}),s?.(y,C,b)}),I=v.useMemo(()=>({setPositionReference:_}),[]),p=v.useMemo(()=>({reference:g||o.reference||null,floating:o.floating||null,domReference:o.reference}),[g,o.reference,o.floating]);return v.useMemo(()=>({dataRef:u,open:e,onOpenChange:x,elements:p,events:h,floatingId:a,refs:I}),[e,x,p,h,a,I])}function Ea(t){t===void 0&&(t={});const{nodeId:e}=t,s=ba({...t,elements:{reference:null,floating:null,...t.elements}}),o=t.rootContext||s,a=o.elements,[u,h]=v.useState(null),[c,g]=v.useState(null),x=a?.reference||u,I=v.useRef(null),p=Ca();Ot(()=>{x&&(I.current=x)},[x]);const y=Vs({...t,elements:{...a,...c&&{reference:c}}}),C=v.useCallback(R=>{const U=rt(R)?{getBoundingClientRect:()=>R.getBoundingClientRect(),contextElement:R}:R;g(U),y.refs.setReference(U)},[y.refs]),b=v.useCallback(R=>{(rt(R)||R===null)&&(I.current=R,h(R)),(rt(y.refs.reference.current)||y.refs.reference.current===null||R!==null&&!rt(R))&&y.refs.setReference(R)},[y.refs]),k=v.useMemo(()=>({...y.refs,setReference:b,setPositionReference:C,domReference:I}),[y.refs,b,C]),N=v.useMemo(()=>({...y.elements,domReference:x}),[y.elements,x]),j=v.useMemo(()=>({...y,...o,refs:k,elements:N,nodeId:e}),[y,k,N,e,o]);return Ot(()=>{o.dataRef.current.floatingContext=j;const R=p?.nodesRef.current.find(U=>U.id===e);R&&(R.context=j)}),v.useMemo(()=>({...y,context:j,refs:k,elements:N}),[y,k,N,j])}const Cn="active",Sn="selected";function At(t,e,s){const o=new Map,a=s==="item";let u=t;if(a&&t){const{[Cn]:h,[Sn]:c,...g}=t;u=g}return{...s==="floating"&&{tabIndex:-1,[Sa]:""},...u,...e.map(h=>{const c=h?h[s]:null;return typeof c=="function"?t?c(t):null:c}).concat(t).reduce((h,c)=>(c&&Object.entries(c).forEach(g=>{let[_,x]=g;if(!(a&&[Cn,Sn].includes(_)))if(_.indexOf("on")===0){if(o.has(_)||o.set(_,[]),typeof x=="function"){var I;(I=o.get(_))==null||I.push(x),h[_]=function(){for(var p,y=arguments.length,C=new Array(y),b=0;b<y;b++)C[b]=arguments[b];return(p=o.get(_))==null?void 0:p.map(k=>k(...C)).find(k=>k!==void 0)}}}else h[_]=x}),h),{})}}function ka(t){t===void 0&&(t=[]);const e=t.map(c=>c?.reference),s=t.map(c=>c?.floating),o=t.map(c=>c?.item),a=v.useCallback(c=>At(c,t,"reference"),e),u=v.useCallback(c=>At(c,t,"floating"),s),h=v.useCallback(c=>At(c,t,"item"),o);return v.useMemo(()=>({getReferenceProps:a,getFloatingProps:u,getItemProps:h}),[a,u,h])}function bn(t,e){return{...t,rects:{...t.rects,floating:{...t.rects.floating,height:e}}}}const Ta=t=>({name:"inner",options:t,async fn(e){const{listRef:s,overflowRef:o,onFallbackChange:a,offset:u=0,index:h=0,minItemsVisible:c=4,referenceOverflowThreshold:g=0,scrollRef:_,...x}=Ks(t,e),{rects:I,elements:{floating:p}}=e,y=s.current[h],C=_?.current||p,b=p.clientTop||C.clientTop,k=p.clientTop!==0,N=C.clientTop!==0,j=p===C;if(!y)return{};const R={...e,...await tr(-y.offsetTop-p.clientTop-I.reference.height/2-y.offsetHeight/2-u).fn(e)},U=await Et(bn(R,C.scrollHeight+b+p.clientTop),x),q=await Et(R,{...x,elementContext:"reference"}),$=Tt(0,U.top),ne=R.y+$,D=Qs(Tt(0,C.scrollHeight+(k&&j||N?b*2:0)-$-Tt(0,U.bottom)));if(C.style.maxHeight=D+"px",C.scrollTop=$,a){const L=C.scrollHeight>C.offsetHeight&&C.offsetHeight<y.offsetHeight*c-1||q.top>=-g||q.bottom>=-g;Ne.flushSync(()=>a(L))}return o&&(o.current=await Et(bn({...R,y:ne},C.offsetHeight+b+p.clientTop),x)),{y:ne}}});function Ma(t,e){const{open:s,elements:o}=t,{enabled:a=!0,overflowRef:u,scrollRef:h,onChange:c}=e,g=Pr(c),_=v.useRef(!1),x=v.useRef(null),I=v.useRef(null);v.useEffect(()=>{if(!a)return;function y(b){if(b.ctrlKey||!C||u.current==null)return;const k=b.deltaY,N=u.current.top>=-.5,j=u.current.bottom>=-.5,R=C.scrollHeight-C.clientHeight,U=k<0?-1:1,q=k<0?"max":"min";C.scrollHeight<=C.clientHeight||(!N&&k>0||!j&&k<0?(b.preventDefault(),Ne.flushSync(()=>{g($=>$+Math[q](k,R*U))})):/firefox/i.test(Js())&&(C.scrollTop+=k))}const C=h?.current||o.floating;if(s&&C)return C.addEventListener("wheel",y),requestAnimationFrame(()=>{x.current=C.scrollTop,u.current!=null&&(I.current={...u.current})}),()=>{x.current=null,I.current=null,C.removeEventListener("wheel",y)}},[a,s,o.floating,u,h,g]);const p=v.useMemo(()=>({onKeyDown(){_.current=!0},onWheel(){_.current=!1},onPointerMove(){_.current=!1},onScroll(){const y=h?.current||o.floating;if(!(!u.current||!y||!_.current)){if(x.current!==null){const C=y.scrollTop-x.current;(u.current.bottom<-.5&&C<-1||u.current.top<-.5&&C>1)&&Ne.flushSync(()=>g(b=>b+C))}requestAnimationFrame(()=>{x.current=y.scrollTop})}}}),[o.floating,g,u,h]);return v.useMemo(()=>a?{floating:p}:{},[a,p])}let Qe=v.createContext({styles:void 0,setReference:()=>{},setFloating:()=>{},getReferenceProps:()=>({}),getFloatingProps:()=>({}),slot:{}});Qe.displayName="FloatingContext";let Zt=v.createContext(null);Zt.displayName="PlacementContext";function Ra(t){return v.useMemo(()=>t?typeof t=="string"?{to:t}:t:null,[t])}function Aa(){return v.useContext(Qe).setReference}function Ba(){return v.useContext(Qe).getReferenceProps}function Na(){let{getFloatingProps:t,slot:e}=v.useContext(Qe);return v.useCallback((...s)=>Object.assign({},t(...s),{"data-anchor":e.anchor}),[t,e])}function Fa(t=null){t===!1&&(t=null),typeof t=="string"&&(t={to:t});let e=v.useContext(Zt),s=v.useMemo(()=>t,[JSON.stringify(t,(a,u)=>{var h;return(h=u?.outerHTML)!=null?h:u})]);Fe(()=>{e?.(s??null)},[e,s]);let o=v.useContext(Qe);return v.useMemo(()=>[o.setFloating,t?o.styles:{}],[o.setFloating,t,o.styles])}let En=4;function ja({children:t,enabled:e=!0}){let[s,o]=v.useState(null),[a,u]=v.useState(0),h=v.useRef(null),[c,g]=v.useState(null);Da(c);let _=e&&s!==null&&c!==null,{to:x="bottom",gap:I=0,offset:p=0,padding:y=0,inner:C}=Pa(s,c),[b,k="center"]=x.split(" ");Fe(()=>{_&&u(0)},[_]);let{refs:N,floatingStyles:j,context:R}=Ea({open:_,placement:b==="selection"?k==="center"?"bottom":`bottom-${k}`:k==="center"?`${b}`:`${b}-${k}`,strategy:"absolute",transform:!1,middleware:[tr({mainAxis:b==="selection"?0:I,crossAxis:p}),Ys({padding:y}),b!=="selection"&&Xs({padding:y}),b==="selection"&&C?Ta({...C,padding:y,overflowRef:h,offset:a,minItemsVisible:En,referenceOverflowThreshold:y,onFallbackChange(Y){var X,P;if(!Y)return;let W=R.elements.floating;if(!W)return;let K=parseFloat(getComputedStyle(W).scrollPaddingBottom)||0,z=Math.min(En,W.childElementCount),M=0,V=0;for(let G of(P=(X=R.elements.floating)==null?void 0:X.childNodes)!=null?P:[])if(G instanceof HTMLElement){let ie=G.offsetTop,T=ie+G.clientHeight+K,S=W.scrollTop,ae=S+W.clientHeight;if(ie>=S&&T<=ae)z--;else{V=Math.max(0,Math.min(T,ae)-Math.max(ie,S)),M=G.clientHeight;break}}z>=1&&u(G=>{let ie=M*z-V+K;return G>=ie?G:ie})}}):null,Zs({padding:y,apply({availableWidth:Y,availableHeight:X,elements:P}){Object.assign(P.floating.style,{overflow:"auto",maxWidth:`${Y}px`,maxHeight:`min(var(--anchor-max-height, 100vh), ${X}px)`})}})].filter(Boolean),whileElementsMounted:ls}),[U=b,q=k]=R.placement.split("-");b==="selection"&&(U="selection");let $=v.useMemo(()=>({anchor:[U,q].filter(Boolean).join(" ")}),[U,q]),ne=Ma(R,{overflowRef:h,onChange:u}),{getReferenceProps:D,getFloatingProps:L}=ka([ne]),re=he(Y=>{g(Y),N.setFloating(Y)});return v.createElement(Zt.Provider,{value:o},v.createElement(Qe.Provider,{value:{setFloating:re,setReference:N.setReference,styles:j,getReferenceProps:D,getFloatingProps:L,slot:$}},t))}function Da(t){Fe(()=>{if(!t)return;let e=new MutationObserver(()=>{let s=window.getComputedStyle(t).maxHeight,o=parseFloat(s);if(isNaN(o))return;let a=parseInt(s);isNaN(a)||o!==a&&(t.style.maxHeight=`${Math.ceil(o)}px`)});return e.observe(t,{attributes:!0,attributeFilter:["style"]}),()=>{e.disconnect()}},[t])}function Pa(t,e){var s,o,a;let u=Bt((s=t?.gap)!=null?s:"var(--anchor-gap, 0)",e),h=Bt((o=t?.offset)!=null?o:"var(--anchor-offset, 0)",e),c=Bt((a=t?.padding)!=null?a:"var(--anchor-padding, 0)",e);return{...t,gap:u,offset:h,padding:c}}function Bt(t,e,s=void 0){let o=nr(),a=he((g,_)=>{if(g==null)return[s,null];if(typeof g=="number")return[g,null];if(typeof g=="string"){if(!_)return[s,null];let x=kn(g,_);return[x,I=>{let p=Ur(g);{let y=p.map(C=>window.getComputedStyle(_).getPropertyValue(C));o.requestAnimationFrame(function C(){o.nextFrame(C);let b=!1;for(let[N,j]of p.entries()){let R=window.getComputedStyle(_).getPropertyValue(j);if(y[N]!==R){y[N]=R,b=!0;break}}if(!b)return;let k=kn(g,_);x!==k&&(I(k),x=k)})}return o.dispose}]}return[s,null]}),u=v.useMemo(()=>a(t,e)[0],[t,e]),[h=u,c]=v.useState();return Fe(()=>{let[g,_]=a(t,e);if(c(g),!!_)return _(c)},[t,e]),h}function Ur(t){let e=/var\((.*)\)/.exec(t);if(e){let s=e[1].indexOf(",");if(s===-1)return[e[1]];let o=e[1].slice(0,s).trim(),a=e[1].slice(s+1).trim();return a?[o,...Ur(a)]:[o]}return[]}function kn(t,e){let s=document.createElement("div");e.appendChild(s),s.style.setProperty("margin-top","0px","important"),s.style.setProperty("margin-top",t,"important");let o=parseFloat(window.getComputedStyle(s).marginTop)||0;return e.removeChild(s),o}var Ua=(t=>(t[t.Open=0]="Open",t[t.Closed=1]="Closed",t))(Ua||{}),Oa=(t=>(t[t.Pointer=0]="Pointer",t[t.Other=1]="Other",t))(Oa||{}),La=(t=>(t[t.OpenMenu=0]="OpenMenu",t[t.CloseMenu=1]="CloseMenu",t[t.GoToItem=2]="GoToItem",t[t.Search=3]="Search",t[t.ClearSearch=4]="ClearSearch",t[t.RegisterItem=5]="RegisterItem",t[t.UnregisterItem=6]="UnregisterItem",t[t.SetButtonElement=7]="SetButtonElement",t[t.SetItemsElement=8]="SetItemsElement",t))(La||{});function Nt(t,e=s=>s){let s=t.activeItemIndex!==null?t.items[t.activeItemIndex]:null,o=To(e(t.items.slice()),u=>u.dataRef.current.domRef.current),a=s?o.indexOf(s):null;return a===-1&&(a=null),{items:o,activeItemIndex:a}}let qa={1(t){return t.menuState===1?t:{...t,activeItemIndex:null,menuState:1}},0(t){return t.menuState===0?t:{...t,__demoMode:!1,menuState:0}},2:(t,e)=>{var s,o,a,u,h;if(t.menuState===1)return t;let c={...t,searchQuery:"",activationTrigger:(s=e.trigger)!=null?s:1,__demoMode:!1};if(e.focus===me.Nothing)return{...c,activeItemIndex:null};if(e.focus===me.Specific)return{...c,activeItemIndex:t.items.findIndex(x=>x.id===e.id)};if(e.focus===me.Previous){let x=t.activeItemIndex;if(x!==null){let I=t.items[x].dataRef.current.domRef,p=Mt(e,{resolveItems:()=>t.items,resolveActiveIndex:()=>t.activeItemIndex,resolveId:y=>y.id,resolveDisabled:y=>y.dataRef.current.disabled});if(p!==null){let y=t.items[p].dataRef.current.domRef;if(((o=I.current)==null?void 0:o.previousElementSibling)===y.current||((a=y.current)==null?void 0:a.previousElementSibling)===null)return{...c,activeItemIndex:p}}}}else if(e.focus===me.Next){let x=t.activeItemIndex;if(x!==null){let I=t.items[x].dataRef.current.domRef,p=Mt(e,{resolveItems:()=>t.items,resolveActiveIndex:()=>t.activeItemIndex,resolveId:y=>y.id,resolveDisabled:y=>y.dataRef.current.disabled});if(p!==null){let y=t.items[p].dataRef.current.domRef;if(((u=I.current)==null?void 0:u.nextElementSibling)===y.current||((h=y.current)==null?void 0:h.nextElementSibling)===null)return{...c,activeItemIndex:p}}}}let g=Nt(t),_=Mt(e,{resolveItems:()=>g.items,resolveActiveIndex:()=>g.activeItemIndex,resolveId:x=>x.id,resolveDisabled:x=>x.dataRef.current.disabled});return{...c,...g,activeItemIndex:_}},3:(t,e)=>{let s=t.searchQuery!==""?0:1,o=t.searchQuery+e.value.toLowerCase(),a=(t.activeItemIndex!==null?t.items.slice(t.activeItemIndex+s).concat(t.items.slice(0,t.activeItemIndex+s)):t.items).find(h=>{var c;return((c=h.dataRef.current.textValue)==null?void 0:c.startsWith(o))&&!h.dataRef.current.disabled}),u=a?t.items.indexOf(a):-1;return u===-1||u===t.activeItemIndex?{...t,searchQuery:o}:{...t,searchQuery:o,activeItemIndex:u,activationTrigger:1}},4(t){return t.searchQuery===""?t:{...t,searchQuery:"",searchActiveItemIndex:null}},5:(t,e)=>{let s=Nt(t,o=>[...o,{id:e.id,dataRef:e.dataRef}]);return{...t,...s}},6:(t,e)=>{let s=Nt(t,o=>{let a=o.findIndex(u=>u.id===e.id);return a!==-1&&o.splice(a,1),o});return{...t,...s,activationTrigger:1}},7:(t,e)=>t.buttonElement===e.element?t:{...t,buttonElement:e.element},8:(t,e)=>t.itemsElement===e.element?t:{...t,itemsElement:e.element}},en=v.createContext(null);en.displayName="MenuContext";function It(t){let e=v.useContext(en);if(e===null){let s=new Error(`<${t} /> is missing a parent <Menu /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(s,It),s}return e}function Wa(t,e){return rr(e.type,qa,t,e)}let $a=v.Fragment;function Ga(t,e){let{__demoMode:s=!1,...o}=t,a=v.useReducer(Wa,{__demoMode:s,menuState:s?0:1,buttonElement:null,itemsElement:null,items:[],searchQuery:"",activeItemIndex:null,activationTrigger:1}),[{menuState:u,itemsElement:h,buttonElement:c},g]=a,_=xt(e);eo(u===0,[c,h],(y,C)=>{g({type:1}),to(C,no.Loose)||(y.preventDefault(),c?.focus())});let x=he(()=>{g({type:1})}),I=v.useMemo(()=>({open:u===0,close:x}),[u,x]),p={ref:_};return Ue.createElement(ja,null,Ue.createElement(en.Provider,{value:a},Ue.createElement(ro,{value:rr(u,{0:ut.Open,1:ut.Closed})},Ge({ourProps:p,theirProps:o,slot:I,defaultTag:$a,name:"Menu"}))))}let Ha="button";function za(t,e){var s;let o=v.useId(),{id:a=`headlessui-menu-button-${o}`,disabled:u=!1,autoFocus:h=!1,...c}=t,[g,_]=It("Menu.Button"),x=Ba(),I=so(),p=xt(e,Aa(),he(D=>_({type:7,element:D}))),y=he(D=>{switch(D.key){case de.Space:case de.Enter:case de.ArrowDown:D.preventDefault(),D.stopPropagation(),Ne.flushSync(()=>_({type:0})),_({type:2,focus:me.First});break;case de.ArrowUp:D.preventDefault(),D.stopPropagation(),Ne.flushSync(()=>_({type:0})),_({type:2,focus:me.Last});break}}),C=he(D=>{switch(D.key){case de.Space:D.preventDefault();break}}),b=he(D=>{var L;if(oo(D.currentTarget))return D.preventDefault();u||(g.menuState===0?(Ne.flushSync(()=>_({type:1})),(L=g.buttonElement)==null||L.focus({preventScroll:!0})):(D.preventDefault(),_({type:0})))}),{isFocusVisible:k,focusProps:N}=io({autoFocus:h}),{isHovered:j,hoverProps:R}=ao({isDisabled:u}),{pressed:U,pressProps:q}=co({disabled:u}),$=v.useMemo(()=>({open:g.menuState===0,active:U||g.menuState===0,disabled:u,hover:j,focus:k,autofocus:h}),[g,j,k,U,u,h]),ne=sr(x(),{ref:p,id:a,type:lo(t,g.buttonElement),"aria-haspopup":"menu","aria-controls":(s=g.itemsElement)==null?void 0:s.id,"aria-expanded":g.menuState===0,disabled:u||void 0,autoFocus:h,onKeyDown:y,onKeyUp:C,onClick:b},N,R,q);return Ge({mergeRefs:I,ourProps:ne,theirProps:c,slot:$,defaultTag:Ha,name:"Menu.Button"})}let Va="div",Ka=dn.RenderStrategy|dn.Static;function Qa(t,e){var s,o;let a=v.useId(),{id:u=`headlessui-menu-items-${a}`,anchor:h,portal:c=!1,modal:g=!0,transition:_=!1,...x}=t,I=Ra(h),[p,y]=It("Menu.Items"),[C,b]=Fa(I),k=Na(),[N,j]=v.useState(null),R=xt(e,I?C:null,he(M=>y({type:8,element:M})),j),U=uo(p.itemsElement);I&&(c=!0);let q=ho(),[$,ne]=fo(_,N,q!==null?(q&ut.Open)===ut.Open:p.menuState===0);po($,p.buttonElement,()=>{y({type:1})});let D=p.__demoMode?!1:g&&p.menuState===0;mo(D,U);let L=p.__demoMode?!1:g&&p.menuState===0;go(L,{allowed:v.useCallback(()=>[p.buttonElement,p.itemsElement],[p.buttonElement,p.itemsElement])});let re=p.menuState!==0,Y=yo(re,p.buttonElement)?!1:$;v.useEffect(()=>{let M=p.itemsElement;M&&p.menuState===0&&M!==U?.activeElement&&M.focus({preventScroll:!0})},[p.menuState,p.itemsElement,U]),_o(p.menuState===0,{container:p.itemsElement,accept(M){return M.getAttribute("role")==="menuitem"?NodeFilter.FILTER_REJECT:M.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(M){M.setAttribute("role","none")}});let X=nr(),P=he(M=>{var V,G,ie;switch(X.dispose(),M.key){case de.Space:if(p.searchQuery!=="")return M.preventDefault(),M.stopPropagation(),y({type:3,value:M.key});case de.Enter:if(M.preventDefault(),M.stopPropagation(),y({type:1}),p.activeItemIndex!==null){let{dataRef:T}=p.items[p.activeItemIndex];(G=(V=T.current)==null?void 0:V.domRef.current)==null||G.click()}or(p.buttonElement);break;case de.ArrowDown:return M.preventDefault(),M.stopPropagation(),y({type:2,focus:me.Next});case de.ArrowUp:return M.preventDefault(),M.stopPropagation(),y({type:2,focus:me.Previous});case de.Home:case de.PageUp:return M.preventDefault(),M.stopPropagation(),y({type:2,focus:me.First});case de.End:case de.PageDown:return M.preventDefault(),M.stopPropagation(),y({type:2,focus:me.Last});case de.Escape:M.preventDefault(),M.stopPropagation(),Ne.flushSync(()=>y({type:1})),(ie=p.buttonElement)==null||ie.focus({preventScroll:!0});break;case de.Tab:M.preventDefault(),M.stopPropagation(),Ne.flushSync(()=>y({type:1})),wo(p.buttonElement,M.shiftKey?hn.Previous:hn.Next);break;default:M.key.length===1&&(y({type:3,value:M.key}),X.setTimeout(()=>y({type:4}),350));break}}),W=he(M=>{switch(M.key){case de.Space:M.preventDefault();break}}),K=v.useMemo(()=>({open:p.menuState===0}),[p.menuState]),z=sr(I?k():{},{"aria-activedescendant":p.activeItemIndex===null||(s=p.items[p.activeItemIndex])==null?void 0:s.id,"aria-labelledby":(o=p.buttonElement)==null?void 0:o.id,id:u,onKeyDown:P,onKeyUp:W,role:"menu",tabIndex:p.menuState===0?0:void 0,ref:R,style:{...x.style,...b,"--button-width":xo(p.buttonElement,!0).width},...vo(ne)});return Ue.createElement(Io,{enabled:c?t.static||$:!1},Ge({ourProps:z,theirProps:x,slot:K,defaultTag:Va,features:Ka,visible:Y,name:"Menu.Items"}))}let Ja=v.Fragment;function Ya(t,e){let s=v.useId(),{id:o=`headlessui-menu-item-${s}`,disabled:a=!1,...u}=t,[h,c]=It("Menu.Item"),g=h.activeItemIndex!==null?h.items[h.activeItemIndex].id===o:!1,_=v.useRef(null),x=xt(e,_);Fe(()=>{if(!h.__demoMode&&h.menuState===0&&g&&h.activationTrigger!==0)return Co().requestAnimationFrame(()=>{var L,re;(re=(L=_.current)==null?void 0:L.scrollIntoView)==null||re.call(L,{block:"nearest"})})},[h.__demoMode,_,g,h.menuState,h.activationTrigger,h.activeItemIndex]);let I=So(_),p=v.useRef({disabled:a,domRef:_,get textValue(){return I()}});Fe(()=>{p.current.disabled=a},[p,a]),Fe(()=>(c({type:5,id:o,dataRef:p}),()=>c({type:6,id:o})),[p,o]);let y=he(()=>{c({type:1})}),C=he(L=>{if(a)return L.preventDefault();c({type:1}),or(h.buttonElement)}),b=he(()=>{if(a)return c({type:2,focus:me.Nothing});c({type:2,focus:me.Specific,id:o})}),k=bo(),N=he(L=>{k.update(L),!a&&(g||c({type:2,focus:me.Specific,id:o,trigger:0}))}),j=he(L=>{k.wasMoved(L)&&(a||g||c({type:2,focus:me.Specific,id:o,trigger:0}))}),R=he(L=>{k.wasMoved(L)&&(a||g&&c({type:2,focus:me.Nothing}))}),[U,q]=ir(),[$,ne]=Eo(),D=v.useMemo(()=>({active:g,focus:g,disabled:a,close:y}),[g,a,y]);return Ue.createElement(q,null,Ue.createElement(ne,null,Ge({ourProps:{id:o,ref:x,role:"menuitem",tabIndex:a===!0?void 0:-1,"aria-disabled":a===!0?!0:void 0,"aria-labelledby":U,"aria-describedby":$,disabled:void 0,onClick:C,onFocus:b,onPointerEnter:N,onMouseEnter:N,onPointerMove:j,onMouseMove:j,onPointerLeave:R,onMouseLeave:R},theirProps:u,slot:D,defaultTag:Ja,name:"Menu.Item"})))}let Xa="div";function Za(t,e){let[s,o]=ir();return Ue.createElement(o,null,Ge({ourProps:{ref:e,"aria-labelledby":s,role:"group"},theirProps:t,slot:{},defaultTag:Xa,name:"Menu.Section"}))}let ec="header";function tc(t,e){let s=v.useId(),{id:o=`headlessui-menu-heading-${s}`,...a}=t,u=ko();Fe(()=>u.register(o),[o,u.register]);let h={id:o,ref:e,role:"presentation",...u.props};return Ge({ourProps:h,theirProps:a,slot:{},defaultTag:ec,name:"Menu.Heading"})}let nc="div";function rc(t,e){return Ge({ourProps:{ref:e,role:"separator"},theirProps:t,slot:{},defaultTag:nc,name:"Menu.Separator"})}let sc=$e(Ga),oc=$e(za),ic=$e(Qa),ac=$e(Ya),cc=$e(Za),lc=$e(tc),uc=$e(rc),Ye=Object.assign(sc,{Button:oc,Items:ic,Item:ac,Section:cc,Heading:lc,Separator:uc});function dc({show:t,appear:e,children:s}){return d.jsx(Mo,{as:v.Fragment,enter:"transition ease-out duration-200",enterFrom:"opacity-0 translate-y-1",enterTo:"opacity-100 translate-y-0",leave:"transition ease-in duration-150",leaveFrom:"opacity-100 translate-y-0",leaveTo:"opacity-0 translate-y-1",show:t,appear:e,children:s})}function Be({onClick:t,href:e,target:s,children:o,disabled:a,icon:u,testId:h}){return d.jsx(Ye.Item,{disabled:a,children:({active:c})=>d.jsxs(Ct,{onClick:t,href:e,target:s,className:mt({"bg-token-sidebar-surface-secondary":c,"hover:bg-token-sidebar-surface-secondary":!c&&!a}),"data-testid":h,children:[u&&d.jsx(u,{className:"icon-md"}),o]})})}function hc({to:t,children:e,icon:s}){return d.jsx(Ye.Item,{children:({active:o})=>d.jsx(us,{to:t,children:d.jsxs(Ct,{$as:"span",className:mt(o?"bg-token-sidebar-surface-secondary":"cursor-pointer"),children:[s&&d.jsx(s,{className:"icon-md"}),e]})})})}Ze.a`p-2 rounded-md hover:bg-black/10 hover:dark:bg-white/10 cursor-pointer`;const Ct=Ze.a`flex gap-2 rounded p-2.5 text-sm cursor-pointer focus:ring-0 hover:bg-token-main-surface-secondary radix-disabled:pointer-events-none radix-disabled:opacity-50 group items-center`,Ll=Ze(Ct)`border dark:border-white/20 min-h-0 hover:bg-gray-500/10 h-10 rounded-lg border-[rgba(0,0,0,0.1)]`,Lt=Ze.div`h-px bg-token-border-light my-1.5`,ql=Ze(Ct)`${t=>t.$active?"bg-token-sidebar-surface-secondary":"hover:bg-token-sidebar-surface-secondary"}`;function Or({menuItemComponent:t}){const e=ve(),s=We(),o=v.useCallback(()=>{A.logEvent(B.clickSidebarAccountPortalMenuItem),Vt(s,"Sidebar account menu item")},[s]),{value:a}=Wt("1028682714"),u=gt(()=>Xe(()=>import("./sso-ei5cecann8hf7lip.js").then(h=>h.M),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51])).then(h=>h.default));return d.jsxs(d.Fragment,{children:[e?.hasPaidSubscription()&&(a?d.jsx(u,{handleClickCustomerPortal:o,menuItemComponent:t}):d.jsx(t,{onClick:o,icon:wi,children:d.jsx(O,{id:"popoverNavigation.myPlan",defaultMessage:"My plan"})})),e?.canInteractWithGizmos()&&d.jsx(t,{onClick:()=>{A.logEvent(B.accountMenuClickMyGPTs),s(Ir())},icon:fr,children:d.jsx(O,{id:"popoverNavigation.myGpts",defaultMessage:"My GPTs"})}),d.jsx(t,{icon:pr,onClick:()=>{_e.openModal(qe.UserContext),A.logEvent(B.accountMenuClickCustomizeChatGPT)},children:d.jsx(O,{id:"popoverNavigation.chatPreferences.1",defaultMessage:"Customize ChatGPT"})})]})}function Lr({menuItemComponent:t,routedMenuItemComponent:e}){const s=ve(),o=pt("2756095923")?.value&&s?.isEdu()&&s?.isStandardUserOfAccount();return d.jsxs(d.Fragment,{children:[!o&&d.jsx(e,{to:"/admin",icon:xi,children:d.jsx(O,{...Ft.myWorkspaceSettings})}),d.jsx(e,{to:Ir(),onClick:()=>{A.logEvent(B.accountMenuClickMyGPTs)},icon:fr,children:d.jsx(O,{...Ft.myGpts})}),d.jsx(t,{onClick:()=>{_e.openModal(qe.UserContext),A.logEvent(B.accountMenuClickCustomizeChatGPT)},icon:pr,children:d.jsx(O,{...Ft.chatPreferences})})]})}const Ft=$t({myWorkspaceSettings:{id:"workspacePopoverNavigation.myWorkspaceSettings",defaultMessage:"Manage workspace"},chatPreferences:{id:"B4s/Jz",defaultMessage:"Customize ChatGPT"},myGpts:{id:"workspacePopoverNavigation.myGpts",defaultMessage:"My GPTs"}}),fc=gt(()=>Xe(()=>import("./nb5pqnpjje55idwl.js"),__vite__mapDeps([52,1,2,3,13,5,6,12,11,8,53,54,33,34,35,17])));function Wl({onClickSettings:t}){return d.jsxs(Ye,{as:"div",className:"group relative",children:[d.jsx(yc,{}),d.jsx(dc,{children:d.jsx(Ye.Items,{className:"popover absolute bottom-full left-0 z-50 mb-1 w-full overflow-hidden rounded-lg border border-token-border-light bg-token-main-surface-primary p-1.5 shadow-lg outline-none",children:d.jsx(gc,{onClickSettings:t})})})]})}function qr(){const t=!ve()?.isEnterprisey()&&!$n,e=Me(),s=_t(),o=We();return s?d.jsxs("div",{className:"flex items-center justify-between gap-2 py-2 pl-5 pr-4",children:[d.jsx("div",{className:"text-sm text-token-text-secondary",children:s?.email}),t&&d.jsx(ke,{label:e.formatMessage(Ee.addWorkspaceTooltip),side:"right",children:d.jsx("button",{onClick:()=>Vt(o,"profile menu"),children:d.jsx(Ei,{className:"icon-sm text-token-text-primary"})})})]}):null}function pc(){const t=ve();return t==null?d.jsx(d.Fragment,{children:d.jsx("div",{className:"w-full px-3 py-2",children:d.jsx(ct,{})})}):d.jsxs(d.Fragment,{children:[d.jsx(qr,{}),d.jsx("div",{className:"flex h-11 w-full items-center justify-start gap-3 px-3 py-1 text-sm",children:d.jsx($r,{workspace:t,isLoading:!1,currentWorkspaceId:t.id,showCheck:!1})})]})}function Wr({menuItemComponent:t}){const e=vt(),s=et(),{data:o}=yt(),a=ve(),[u,h]=v.useState(!1),c=_t(),g=Me(),_=Ln();if(!a||!o)return null;const x=a.isWorkspaceAccount(),I=o.accountItems.length>1,p=o.accountItems,y=Ro([p.find(b=>b.isPersonalAccount()),...p.filter(b=>!b.isPersonalAccount())]);if(y.sort((b,k)=>b.isPersonalAccount()?1:k.isPersonalAccount()?-1:0),!I)return x?d.jsx(pc,{}):d.jsx(d.Fragment,{children:d.jsx("div",{className:"ml-3 mr-2 py-2 text-sm text-token-text-secondary",children:c?.email})});const C=y.map(b=>d.jsx(t,{disabled:b.isDeactivated(),onClick:()=>{if(b.isDeactivated()||b.id===a?.id)return;h(!0);const{willRedirect:k}=ds(s,b.id,e,g,_);k||hs()},className:"radix-disabled:pointer-events-auto radix-disabled:hover:bg-transparent",children:b.isDeactivated()?d.jsx(mc,{workspace:b,isLoading:u}):d.jsx($r,{workspace:b,isLoading:u,currentWorkspaceId:a?.id})},b.id));return d.jsxs(d.Fragment,{children:[d.jsx(qr,{}),d.jsx(J.Separator,{}),C]})}function $r({workspace:t,isLoading:e,currentWorkspaceId:s,showCheck:o=!0}){const a=t.canAccessWithCurrentSession,u=!e&&o&&t.id===s;return d.jsxs("div",{children:[d.jsxs("div",{className:"flex w-full items-center gap-2.5",children:[d.jsx("span",{className:"flex h-5 w-5 items-center justify-center",children:d.jsx(Kt,{iconSize:"small",workspace:t,className:mt({"flex-shrink-0":!0})})}),d.jsx("div",{className:"line-clamp-1 text-token-text-primary",children:ar(Me(),t)}),e&&d.jsx(ct,{}),u&&d.jsx("span",{className:"text-token-text-primary",children:d.jsx(vi,{className:"icon-sm"})}),!a&&d.jsx("span",{className:"text-token-text-primary",children:d.jsx(Ii,{className:"icon-sm"})})]}),!a&&d.jsx("div",{className:"rowDivClassName",children:d.jsx("small",{className:"text-token-text-secondary",children:d.jsx(O,{...t.ssoConnectionName?Ee.authenticateWithSSOToAccessWorkspace:Ee.authenticateWithoutSSOToAccessWorkspace})})})]})}function mc({workspace:t,isLoading:e}){const s=Me(),o=t.isOwnerOfAccount(),[a,u]=v.useState(!1),h=Oi(t.id);return v.useEffect(()=>{h!=null&&a&&(_e.setPurchaseWorkspaceData({minimumSeats:Math.max(h,fn),existingAccount:t}),u(!1))},[h,a,t]),d.jsxs(d.Fragment,{children:[d.jsxs(ke,{className:"flex w-full flex-1 items-center gap-2.5",label:s.formatMessage(Ee.disabledWorkspaceTooltip),sideOffset:20,side:"right",children:[d.jsx("span",{className:"flex h-5 w-5 items-center justify-center",children:d.jsx(Ci,{className:"icon-sm flex-shrink-0 opacity-30"})}),d.jsx("div",{className:"truncate opacity-30",children:ar(s,t)})]}),e&&d.jsx(ct,{}),!e&&d.jsxs(J.Root,{children:[d.jsx(J.Trigger,{className:"rounded text-center hover:bg-token-main-surface-secondary",children:d.jsx(Si,{className:"icon-sm m-1"})}),d.jsx(J.Portal,{children:d.jsxs(J.Content,{children:[o&&d.jsx(d.Fragment,{children:d.jsx(J.Item,{onClick:()=>{h==null?u(!0):_e.setPurchaseWorkspaceData({minimumSeats:Math.max(h,fn),existingAccount:t})},children:a?d.jsx(ct,{}):d.jsx(O,{id:"navigation.reactivateWorkspace",defaultMessage:"Reactivate workspace"})})}),d.jsx(J.Item,{onClick:()=>{_e.setLeaveWorkspaceData(t)},children:d.jsx(O,{id:"navigation.leaveWorkspace",defaultMessage:"Leave workspace"})})]})})]})]})}function gc({onClickSettings:t}){const{data:e}=yt(),s=ve(),o=cr(),a=Sr(),{openModal:u}=br(),h=qn("3905879930");var c=s?.isTeam()??!1,g=!1;if(c&&(g=h.config.get("enabled",!1)),!s||!e)return null;const _=s.isWorkspaceAccount(),x=!o;return d.jsxs("nav",{children:[d.jsx(Wr,{menuItemComponent:Be}),d.jsx(Lt,{}),_?d.jsx(Lr,{menuItemComponent:Be,routedMenuItemComponent:hc}):d.jsx(Or,{menuItemComponent:Be}),x&&d.jsx(Be,{href:Ao(),target:"_blank",onClick:()=>{A.logEvent(B.clickFaqLink)},icon:bi,children:d.jsx(O,{...Ee.helpAndFaq})}),d.jsx(Be,{onClick:t,icon:mr,testId:"accounts-settings-button",children:d.jsx(O,{...Ee.settings})}),c&&g&&d.jsxs(d.Fragment,{children:[d.jsx(Be,{onClick:()=>{_e.openModal(qe.InviteUsersToWorkspace),A.logEvent(B.accountMemberInviteButton,{location:"dropdown-menu-click"}),oe.logEvent("chatgpt_invite_users_to_workspace",0,{action:"OpenAdminInviteModal",location:"dropdown-menu-click",text:"AddTeammates",step:"OpenModal"})},icon:gr,children:d.jsx(O,{...Ee.addTeammatesButton})}),d.jsx(fc,{workspace:s})]}),a&&d.jsx(_c,{openDownloadModal:u}),d.jsx(Lt,{}),d.jsx(Be,{onClick:()=>{A.logEvent(B.clickLogOut,{eventSource:"mouse"}),Wn()},icon:yr,children:d.jsx(O,{...Ee.logOut})})]})}function yc(){return _t()?d.jsx(wc,{}):null}function _c({openDownloadModal:t}){return d.jsxs("span",{children:[d.jsx(Lt,{}),d.jsx(Be,{icon:_r,onClick:()=>{A.logEvent(B.accountMenuClickDownloadApp),t()},children:d.jsx(O,{...Ee.downloadApp})})]})}function wc(){const{data:t}=yt(),e=ve(),s=Bo(),o=No();if(!e||!t)return null;const a=e.isWorkspaceAccount(),u=t.accountItems.length>1;return d.jsxs(Ye.Button,{className:"flex w-full max-w-[100%] items-center gap-2 rounded-lg p-2 text-sm hover:bg-token-sidebar-surface-secondary group-ui-open:bg-token-sidebar-surface-secondary","data-testid":"accounts-profile-button",children:[d.jsx("div",{className:"flex-shrink-0",children:d.jsx(Kt,{iconSize:"gizmo"})}),d.jsxs("div",{className:"relative -top-px grow -space-y-px truncate text-start text-token-text-primary",children:[d.jsx("div",{dir:"auto",children:o}),a||u?d.jsx("div",{className:"truncate text-xs text-token-text-secondary",dir:"auto",children:s}):null]})]})}const Ee=$t({helpAndFaq:{id:"navigation.helpAndFaq",defaultMessage:"Help & FAQ"},settings:{id:"navigation.settings",defaultMessage:"Settings"},logOut:{id:"navigation.logOut",defaultMessage:"Log out"},accountSwitcherTitle:{id:"navigation.accountSwitcherTitle",defaultMessage:"Workspaces"},defaultWorkspaceTitle:{id:"useWorkspaces.defaultWorkspaceTitle",defaultMessage:"Untitled Workspace"},addWorkspaceTooltip:{id:"navigation.addWorkspaceTooltip",defaultMessage:"Create a Team workspace"},disabledWorkspaceTooltip:{id:"navigation.disabledWorkspaceTooltip",defaultMessage:"This workspace has been deactivated"},downloadApp:{id:"navigation.downloadMacApp",defaultMessage:"Download the macOS app"},authenticateWithSSOToAccessWorkspace:{id:"CV7pdM",defaultMessage:"Authenticate with SSO to access this workspace"},authenticateWithoutSSOToAccessWorkspace:{id:"zfCWFh",defaultMessage:"Authenticate without SSO to access this workspace"},addTeammatesButton:{id:"inviteMemberButton.inviteMemberButton",defaultMessage:"Add Teammates"}});function xc(t){oe.logEvent("chatgpt_web_thread_tap_new_thread"),Le.getItem(Oe.HasSeenNewChatModal)===!0?lr(t):(Le.setItem(Oe.HasSeenNewChatModal,!0),_e.openModal(qe.NoAuthNewChat))}function $l(){return Li(qe.NoAuthNewChat)?d.jsx(vc,{onClose:()=>{_e.closeModal(qe.NoAuthNewChat)}}):null}function vc({onClose:t}){const e=vt(),s=We(),o=Gn("1934819688"),a=o.config.get("is_redesign_enabled",!1),u=o.config.get("secondary_button_type","cancel"),h=ur(kt.signUpButtonText),c=I=>{I.preventDefault(),e({authType:"signup",callback:p=>{oe.logEvent("chatgpt_new_chat_modal_sign_up_link_clicked"),A.logSignUpButtonClicked({location:"New chat modal",provider:p})}})},g=I=>{I.preventDefault(),e({authType:"login",callback:p=>{oe.logEvent("chatgpt_new_chat_modal_log_in_link_clicked"),A.logLogInButtonClicked({location:"New chat modal",provider:p})}})},_=()=>{oe.logEvent("chatgpt_new_chat_modal_cancel_button_clicked"),A.logEvent(B.newChatModalCancelButtonClicked),t()},x=()=>{oe.logEvent("chatgpt_new_chat_modal_new_chat_button_clicked"),A.logNewChatButtonClicked({location:"New Chat Modal New Chat Button"}),lr(s),t()};return v.useEffect(()=>{oe.logEvent("chatgpt_new_chat_modal_shown"),A.logEvent(B.newChatModalShown)},[]),d.jsx(fs,{isOpen:!0,type:"success",onClose:t,noPadding:!0,size:"custom",className:"max-w-sm",children:d.jsxs("div",{className:"flex flex-col justify-center p-6",children:[d.jsxs("div",{className:"mb-2 grid w-full grid-cols-[1fr,auto,1fr] items-center",children:[d.jsx("div",{}),d.jsx("div",{className:"text-xl font-medium",children:d.jsx(O,{id:"d+R7z5",defaultMessage:"Clear current chat?"})}),d.jsx("div",{className:"flex justify-end",children:a?d.jsx(ps,{onClick:t}):null})]}),d.jsx("p",{className:"mb-6 text-center text-token-text-secondary",children:d.jsx(O,{id:"+Olycu",defaultMessage:"To start a new chat, your current conversation will be discarded. <signup>Sign up</signup> or <login>log in</login> to save chats.",values:{signup:I=>d.jsx("a",{href:"#",className:"font-medium text-token-text-primary",onClick:c,children:I}),login:I=>d.jsx("a",{href:"#",className:"font-medium text-token-text-primary",onClick:g,children:I})}})}),d.jsx(Pe,{className:"mb-3",color:a?"primary":"danger",size:"giant",onClick:x,children:d.jsx(O,{id:"cBGbrD",defaultMessage:"Clear chat"})}),u==="cancel"?d.jsx(Pe,{size:"giant",onClick:_,color:"secondary",children:d.jsx(O,{...kt.cancelButtonText})}):null,u==="login"?d.jsx(Pe,{size:"giant",onClick:()=>{e({authType:"login",callback:I=>{A.logLogInButtonClicked({location:"New chat modal",provider:I})}})},color:"ghost",children:d.jsx(O,{...kt.logInButtonText})}):null,u==="signup"?d.jsx(Pe,{size:"giant",onClick:()=>{e({authType:"signup",callback:I=>{A.logSignUpButtonClicked({location:"New chat modal",provider:I})}})},color:"ghost",children:d.jsx(O,{...h})}):null]})})}function Gr({clientThreadId:t,location:e}){const s=et(),{id:o}=Cr(t),a=Bi(!0),u=We(),h=Gt(),c=ms();return v.useCallback(()=>{Ht(Hn(s))?xc(u):h?u({pathname:c.pathname,search:c.search},{state:Fo()}):(a({modelId:o,location:e}),oe.logEvent("chatgpt_web_thread_tap_new_thread"))},[s,e,o,a,u,h,c])}function Ic(t){return t==null||[xe.PrimaryAssistant,xe.GizmoInteraction].includes(t.kind)}function Gl(t,e){const s=Rr(t,e),{data:o}=Ni(s!=null&&"gizmo_id"in s?s.gizmo_id:void 0,s?.kind===xe.GizmoTest);if(s!=null)switch(s.kind){case xe.GizmoInteraction:case xe.GizmoMagicCreate:case xe.GizmoTest:return{gizmo:o,...s};case xe.PrimaryAssistant:return s}}function Cc(t,e,s){const a=E.getTree(e).getMessageId(E.getThreadCurrentLeafId(e));Te.generateTitle(e,a,s).then(({title:u})=>{E.setTitle(e,u,Ar.Generated),Er(t),A.logEvent(B.renameThread,{threadId:e,content:u,model:s})})}function Sc(t,e,s){const o=()=>{const u=wn(s);t(u)},a=ft.getGizmoId(s);a!=null?Fi(e,a).then(u=>{jo(wn(s,u))}).catch(u=>{we.addError(u),o()}):o()}const Tn={onCreate(t,e,s,o){A.logEvent(B.newThread),!o&&Ic(ft.getConversationMode(e))&&gs(s).then(a=>{Ht(a)||(Er(s),t(e))})},onCreateFinished(t,e,s){if(!(s||!e)&&!oe.checkGate("2562876640")){const o=ft.getThread(e)?.initialThreadData.lastModelUsed;o==null&&we.addError("missing lastModelUsed on conversation create finished"),Cc(t,e,o)}}};function Mn(t,e){t.updateNodeMetadata(e.id,{completionSampleFinishTime:Date.now()})}class bc{constructor(e,s,o,a,u,h,c,g,_,x,I,p){this.queryClient=e,this.clientThreadId=s,this.targetNodeId=o,this.completionType=a,this.model=u,this.eventSource=h,this.onCreate=c,this.callModelAgain=_,this.onCompletionFinished=x,this.isHistoryAndTrainingDisabled=p,this.currentTree=E.getTree(s),this.currentNodeId=o,this.activeBranchLastMessage=this.currentTree.getMessage(this.currentNodeId),this.completionLatencyTracker=new Do(g),this.turnTracker=I,this.turnTracker.onCompletionStarted(a,this.model)}currentTree;currentNodeId;firstResponse=!0;didCreateFirstCompletionInNewThread=!1;activeBranchLastMessage;messagesToUpdate={};allIncompleteStreamedMessages={};responseThreadId;isCompletionBlocked=!1;isEitherFlagged=!1;variantsInStreamInfo;activeBranchNodeId;blurDuringCompletionTracker=new Po;completionLatencyTracker;turnTracker;debouncedUpdateCompletion=Uo(()=>{this.isCompletionBlocked||E.updateTree(this.clientThreadId,e=>{Object.values(this.messagesToUpdate).forEach(s=>{e.updateNodeMessage(s.id,s)})}),this.messagesToUpdate={}},50,{leading:!0,maxWait:50});handleResponse=async e=>{if(e.type!=="done"&&this.turnTracker.onUpdateEventCount(),this.completionLatencyTracker.onResponse(e,this.activeBranchLastMessage,this.responseThreadId),this.responseThreadId===void 0&&"conversationId"in e){const s=e.conversationId;this.responseThreadId=s,Xt(this.clientThreadId)&&E.getServerThreadId(this.clientThreadId)!==s&&(E.setServerIdForNewThread(this.clientThreadId,s),A.logEvent(B.attributeClientThreadToServerThread,{client_thread_id:this.clientThreadId,server_thread_id:s}))}switch(e.type){case"error":this.handleError(e);break;case"num_variants_in_stream":this.bindVariantInfoToTree(e);break;case"moderation":this.handleModeration(e);break;case"url_moderation":this.handleUrlModeration(e);break;case"message":this.handleMessage(e),this.debouncedUpdateCompletion();break;case"done":this.handleDone();break;case"gizmo_inline_review":this.handleGizmoInlineReview(e);break;case"title_generation":this.handleTitleGeneration(e);break;case"conversation_detail_metadata":this.handleConversationDetailMetadata(e);break}};handleError(e){const s=e.error,o=s?.message||"Something went wrong",a=s instanceof ye&&s.code||"",u=s instanceof ye&&s.status,h=s instanceof ye?s.detail?.can_retry:void 0;switch(this.turnTracker.handleRawError(o,u),E.updateTree(this.clientThreadId,c=>{c.updateNodeMessage(this.currentNodeId,this.activeBranchLastMessage),c.updateNodeMetadata(this.currentNodeId,{err:o,errType:"danger",errCode:a,completionSampleFinishTime:Date.now(),canRetry:h})}),a){case mn.ContentPolicy:case mn.ContentOrTos:case pn:case ys:break;default:o!==void 0&&oe.logEvent("chatgpt_conversation_error_web",o)}if(this.blurDuringCompletionTracker.onMessageError(),this.cleanUp(),this.onCompletionFinished(this.responseThreadId),s instanceof ye&&s.code===pn){const c=s.detail?.clears_in;c&&(Oo(new Date(Date.now()+c*1e3).toISOString()),setTimeout(()=>{Lo()},c*1e3))}}handleGizmoInlineReview(e){E.setPromptGptRating(this.clientThreadId,e.gizmoId)}handleTitleGeneration(e){E.setTitle(this.clientThreadId,e.title,Ar.Generated)}handleConversationDetailMetadata(e){const{default_model_slug:s}=e;s&&E.setThreadModelId(this.clientThreadId,s),Pt.updateDetails(e)}bindVariantInfoToTree(e){this.variantsInStreamInfo=e,E.updateTree(this.clientThreadId,s=>{const o=s.getParentPromptNode(this.currentNodeId);s.updateNodeMetadata(o.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}handleModeration(e){const{isCompletion:s,messageId:o,conversationId:a,flagged:u,blocked:h,disclaimers:c,metadata:g}=e,_=!!c?.length&&s;(u||h||_)&&(this.isEitherFlagged=!0,h&&s&&(this.isCompletionBlocked=!0),E.updateTree(this.clientThreadId,x=>{const I=x.messageIdToNodeId(o);h&&x.clearNodeMessageParts(I),x.updateNodeMetadata(I,{...(_&&!!c?.length&&qo(c,h))??{},...u&&Wo,...h&&(g?.model_incompatibility?$o:Go),completionSampleFinishTime:Date.now()})}),A.logEvent(s?h?B.completionBlockedByModeration:B.completionFlaggedByModeration:h?B.promptBlockedByModeration:B.promptFlaggedByModeration,{threadId:a,id:o}))}handleUrlModeration(e){const{conversationId:s,url:o,isSafe:a}=e;a&&E.addThreadSafeUrl(s,o)}handleMessage(e){let s=!0;const{message:o,conversationId:a}=e;if(this.turnTracker.onMessageUpdate(o.metadata?.model_slug,o.metadata?.gizmo_id,o.author.name,o.author.role),this.firstResponse&&!this.currentTree.hasReceivedServerCompletion){if(this.currentTree.hasNodeOrMessageId(o.id)&&o.author.role!==Ce.User)return;if(o?.author.role===Ce.System||o?.author.role===Ce.Developer){if((o.metadata?.parent_id?this.currentTree.getNodeByIdOrMessageId(o.metadata.parent_id):void 0)?.message.author.role!==Ce.User){this.currentTree.appendSystemMessageToRoot(o);return}}else if(o?.author.role===Ce.User)return E.updateTree(this.clientThreadId,u=>{u.updateNodeMessage(o.id,o)})}if(this.firstResponse&&o.metadata?.rebase_system_message){E.updateTree(this.clientThreadId,u=>{if(o.metadata?.parent_id==null)throw Error("Unexpected rebased system message without parent");const h=u.getNodeByIdOrMessageId(this.targetNodeId);u.deleteNode(this.targetNodeId),u.addNode(o.id,o,o.metadata.parent_id,o.author.role),u.addNode(h.id,h.message,o.id,h.message.author.role)});return}if(this.firstResponse){const u=ht.getState().threads[this.clientThreadId]?.continuingFromSharedConversationId!=null;E.removeContinuingFromSharedConversationId(this.clientThreadId),this.firstResponse=!1,this.didCreateFirstCompletionInNewThread=!this.currentTree.hasReceivedServerCompletion||u,E.updateTree(this.clientThreadId,c=>{c.updateNodeMessage(this.currentNodeId,o)}),this.didCreateFirstCompletionInNewThread&&Tn.onCreate(this.onCreate,a,this.queryClient,this.isHistoryAndTrainingDisabled);const h={id:this.targetNodeId,threadId:a,completionType:this.completionType,eventSource:this.eventSource,model:this.model};if(this.completionType===Ke.Next){const c=ht.getState().threads[a],g=c?.conversationTurns?.length,_=c?.conversationTurns?.filter(I=>I.role==Ce.User),x=_&&_[_.length-1]?.messages[0].message;if(x?.content.content_type==_s.Text){const I=x.content.parts.join("").length,p=_?.length??0;h.countConversationTurns=g,h.countUserSubmittedMessages=p,h.countLastUserPromptTextMessageLength=I}}A.logEvent(B.generateCompletion,h)}else if(this.completionType!==Ke.Continue){const u=this.currentTree.containsNodeOrMessageId(o.id),h=o.metadata?.parent_id;if(u||(this.debouncedUpdateCompletion.flush(),E.updateTree(this.clientThreadId,c=>{if(h==null)throw new Error(`Received a message with no parentId: ${JSON.stringify(o)}`);c.addNode(o.id,o,h,Ce.Assistant)})),h!=null&&h===this.activeBranchNodeId){const c=this.allIncompleteStreamedMessages[h];c!=null&&(E.updateTree(this.clientThreadId,g=>{Mn(g,c)}),delete this.allIncompleteStreamedMessages[h])}if(s=(this.variantsInStreamInfo?.num_variants_in_stream??1)===1||this.activeBranchNodeId==null||this.activeBranchNodeId===o.id||this.currentTree.isAncestorOfNode(this.activeBranchNodeId,o.id),s&&this.activeBranchNodeId!==o.id){this.activeBranchNodeId=o.id,this.currentNodeId=o.id;const c=E.getThreadCurrentLeafId(this.clientThreadId);this.currentTree.messageIdToNodeId(this.currentNodeId)!==this.currentTree.messageIdToNodeId(c)&&E.setThreadCurrentLeafId(this.clientThreadId,this.currentNodeId),h!=null&&E.updateTree(this.clientThreadId,g=>{const _=g.getParentPromptNode(o.id);g.updateNodeMetadata(_.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}}if(o?.author.role===Ce.Tool&&o?.author.name==="bio"){const u=o.metadata?.gizmo_id;setTimeout(()=>{this.queryClient.invalidateQueries({queryKey:Ho(u)})},5e3)}s&&(this.activeBranchLastMessage=o),this.messagesToUpdate[o.id]=o,this.allIncompleteStreamedMessages[o.id]=o}async handleDone(){if(this.turnTracker.model_message_update_count>0?this.turnTracker.logCompletion({type:dt.Success}):this.turnTracker.logCompletion({type:dt.Error,error:{reason:"empty_response",message:"Successful completion ended with no messages"}}),this.isCompletionBlocked||(this.debouncedUpdateCompletion.flush(),this.isEitherFlagged||(this.didCreateFirstCompletionInNewThread&&Tn.onCreateFinished(this.queryClient,this.responseThreadId,this.isHistoryAndTrainingDisabled),this.onCompletionFinished(this.responseThreadId))),E.updateTree(this.clientThreadId,e=>{Object.values(this.allIncompleteStreamedMessages).forEach(s=>{Mn(e,s)})}),dr.publish({kind:"createConversation",clientThreadId:this.clientThreadId}),this.blurDuringCompletionTracker.onMessageDone(),this.cleanUp(),this.activeBranchLastMessage?.metadata?.client_actions!==void 0){const e=await zo(this.clientThreadId,this.activeBranchLastMessage);e.length>0&&this.callModelAgain(this.currentNodeId,e)}}cleanUp(){setTimeout(()=>{kr(this.clientThreadId,{source:zn.CLIENT,value:Vn.UNREAD}),Qt.removeRequest(this.targetNodeId),E.releaseThread(this.clientThreadId)},0)}}/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(t){const e=Vo,s=Ko,o=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;t.Buffer=c,t.SlowBuffer=j,t.INSPECT_MAX_BYTES=50;const a=2147483647;t.kMaxLength=a,c.TYPED_ARRAY_SUPPORT=u(),!c.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function u(){try{const i=new Uint8Array(1),n={foo:function(){return 42}};return Object.setPrototypeOf(n,Uint8Array.prototype),Object.setPrototypeOf(i,n),i.foo()===42}catch{return!1}}Object.defineProperty(c.prototype,"parent",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.buffer}}),Object.defineProperty(c.prototype,"offset",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.byteOffset}});function h(i){if(i>a)throw new RangeError('The value "'+i+'" is invalid for option "size"');const n=new Uint8Array(i);return Object.setPrototypeOf(n,c.prototype),n}function c(i,n,r){if(typeof i=="number"){if(typeof n=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return I(i)}return g(i,n,r)}c.poolSize=8192;function g(i,n,r){if(typeof i=="string")return p(i,n);if(ArrayBuffer.isView(i))return C(i);if(i==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof i);if(Ie(i,ArrayBuffer)||i&&Ie(i.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(Ie(i,SharedArrayBuffer)||i&&Ie(i.buffer,SharedArrayBuffer)))return b(i,n,r);if(typeof i=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const l=i.valueOf&&i.valueOf();if(l!=null&&l!==i)return c.from(l,n,r);const f=k(i);if(f)return f;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof i[Symbol.toPrimitive]=="function")return c.from(i[Symbol.toPrimitive]("string"),n,r);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof i)}c.from=function(i,n,r){return g(i,n,r)},Object.setPrototypeOf(c.prototype,Uint8Array.prototype),Object.setPrototypeOf(c,Uint8Array);function _(i){if(typeof i!="number")throw new TypeError('"size" argument must be of type number');if(i<0)throw new RangeError('The value "'+i+'" is invalid for option "size"')}function x(i,n,r){return _(i),i<=0?h(i):n!==void 0?typeof r=="string"?h(i).fill(n,r):h(i).fill(n):h(i)}c.alloc=function(i,n,r){return x(i,n,r)};function I(i){return _(i),h(i<0?0:N(i)|0)}c.allocUnsafe=function(i){return I(i)},c.allocUnsafeSlow=function(i){return I(i)};function p(i,n){if((typeof n!="string"||n==="")&&(n="utf8"),!c.isEncoding(n))throw new TypeError("Unknown encoding: "+n);const r=R(i,n)|0;let l=h(r);const f=l.write(i,n);return f!==r&&(l=l.slice(0,f)),l}function y(i){const n=i.length<0?0:N(i.length)|0,r=h(n);for(let l=0;l<n;l+=1)r[l]=i[l]&255;return r}function C(i){if(Ie(i,Uint8Array)){const n=new Uint8Array(i);return b(n.buffer,n.byteOffset,n.byteLength)}return y(i)}function b(i,n,r){if(n<0||i.byteLength<n)throw new RangeError('"offset" is outside of buffer bounds');if(i.byteLength<n+(r||0))throw new RangeError('"length" is outside of buffer bounds');let l;return n===void 0&&r===void 0?l=new Uint8Array(i):r===void 0?l=new Uint8Array(i,n):l=new Uint8Array(i,n,r),Object.setPrototypeOf(l,c.prototype),l}function k(i){if(c.isBuffer(i)){const n=N(i.length)|0,r=h(n);return r.length===0||i.copy(r,0,0,n),r}if(i.length!==void 0)return typeof i.length!="number"||bt(i.length)?h(0):y(i);if(i.type==="Buffer"&&Array.isArray(i.data))return y(i.data)}function N(i){if(i>=a)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+a.toString(16)+" bytes");return i|0}function j(i){return+i!=i&&(i=0),c.alloc(+i)}c.isBuffer=function(n){return n!=null&&n._isBuffer===!0&&n!==c.prototype},c.compare=function(n,r){if(Ie(n,Uint8Array)&&(n=c.from(n,n.offset,n.byteLength)),Ie(r,Uint8Array)&&(r=c.from(r,r.offset,r.byteLength)),!c.isBuffer(n)||!c.isBuffer(r))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(n===r)return 0;let l=n.length,f=r.length;for(let m=0,w=Math.min(l,f);m<w;++m)if(n[m]!==r[m]){l=n[m],f=r[m];break}return l<f?-1:f<l?1:0},c.isEncoding=function(n){switch(String(n).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},c.concat=function(n,r){if(!Array.isArray(n))throw new TypeError('"list" argument must be an Array of Buffers');if(n.length===0)return c.alloc(0);let l;if(r===void 0)for(r=0,l=0;l<n.length;++l)r+=n[l].length;const f=c.allocUnsafe(r);let m=0;for(l=0;l<n.length;++l){let w=n[l];if(Ie(w,Uint8Array))m+w.length>f.length?(c.isBuffer(w)||(w=c.from(w)),w.copy(f,m)):Uint8Array.prototype.set.call(f,w,m);else if(c.isBuffer(w))w.copy(f,m);else throw new TypeError('"list" argument must be an Array of Buffers');m+=w.length}return f};function R(i,n){if(c.isBuffer(i))return i.length;if(ArrayBuffer.isView(i)||Ie(i,ArrayBuffer))return i.byteLength;if(typeof i!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof i);const r=i.length,l=arguments.length>2&&arguments[2]===!0;if(!l&&r===0)return 0;let f=!1;for(;;)switch(n){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":return St(i).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return r*2;case"hex":return r>>>1;case"base64":return rn(i).length;default:if(f)return l?-1:St(i).length;n=(""+n).toLowerCase(),f=!0}}c.byteLength=R;function U(i,n,r){let l=!1;if((n===void 0||n<0)&&(n=0),n>this.length||((r===void 0||r>this.length)&&(r=this.length),r<=0)||(r>>>=0,n>>>=0,r<=n))return"";for(i||(i="utf8");;)switch(i){case"hex":return G(this,n,r);case"utf8":case"utf-8":return W(this,n,r);case"ascii":return M(this,n,r);case"latin1":case"binary":return V(this,n,r);case"base64":return P(this,n,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ie(this,n,r);default:if(l)throw new TypeError("Unknown encoding: "+i);i=(i+"").toLowerCase(),l=!0}}c.prototype._isBuffer=!0;function q(i,n,r){const l=i[n];i[n]=i[r],i[r]=l}c.prototype.swap16=function(){const n=this.length;if(n%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let r=0;r<n;r+=2)q(this,r,r+1);return this},c.prototype.swap32=function(){const n=this.length;if(n%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let r=0;r<n;r+=4)q(this,r,r+3),q(this,r+1,r+2);return this},c.prototype.swap64=function(){const n=this.length;if(n%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let r=0;r<n;r+=8)q(this,r,r+7),q(this,r+1,r+6),q(this,r+2,r+5),q(this,r+3,r+4);return this},c.prototype.toString=function(){const n=this.length;return n===0?"":arguments.length===0?W(this,0,n):U.apply(this,arguments)},c.prototype.toLocaleString=c.prototype.toString,c.prototype.equals=function(n){if(!c.isBuffer(n))throw new TypeError("Argument must be a Buffer");return this===n?!0:c.compare(this,n)===0},c.prototype.inspect=function(){let n="";const r=t.INSPECT_MAX_BYTES;return n=this.toString("hex",0,r).replace(/(.{2})/g,"$1 ").trim(),this.length>r&&(n+=" ... "),"<Buffer "+n+">"},o&&(c.prototype[o]=c.prototype.inspect),c.prototype.compare=function(n,r,l,f,m){if(Ie(n,Uint8Array)&&(n=c.from(n,n.offset,n.byteLength)),!c.isBuffer(n))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof n);if(r===void 0&&(r=0),l===void 0&&(l=n?n.length:0),f===void 0&&(f=0),m===void 0&&(m=this.length),r<0||l>n.length||f<0||m>this.length)throw new RangeError("out of range index");if(f>=m&&r>=l)return 0;if(f>=m)return-1;if(r>=l)return 1;if(r>>>=0,l>>>=0,f>>>=0,m>>>=0,this===n)return 0;let w=m-f,F=l-r;const ee=Math.min(w,F),Q=this.slice(f,m),te=n.slice(r,l);for(let H=0;H<ee;++H)if(Q[H]!==te[H]){w=Q[H],F=te[H];break}return w<F?-1:F<w?1:0};function $(i,n,r,l,f){if(i.length===0)return-1;if(typeof r=="string"?(l=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),r=+r,bt(r)&&(r=f?0:i.length-1),r<0&&(r=i.length+r),r>=i.length){if(f)return-1;r=i.length-1}else if(r<0)if(f)r=0;else return-1;if(typeof n=="string"&&(n=c.from(n,l)),c.isBuffer(n))return n.length===0?-1:ne(i,n,r,l,f);if(typeof n=="number")return n=n&255,typeof Uint8Array.prototype.indexOf=="function"?f?Uint8Array.prototype.indexOf.call(i,n,r):Uint8Array.prototype.lastIndexOf.call(i,n,r):ne(i,[n],r,l,f);throw new TypeError("val must be string, number or Buffer")}function ne(i,n,r,l,f){let m=1,w=i.length,F=n.length;if(l!==void 0&&(l=String(l).toLowerCase(),l==="ucs2"||l==="ucs-2"||l==="utf16le"||l==="utf-16le")){if(i.length<2||n.length<2)return-1;m=2,w/=2,F/=2,r/=2}function ee(te,H){return m===1?te[H]:te.readUInt16BE(H*m)}let Q;if(f){let te=-1;for(Q=r;Q<w;Q++)if(ee(i,Q)===ee(n,te===-1?0:Q-te)){if(te===-1&&(te=Q),Q-te+1===F)return te*m}else te!==-1&&(Q-=Q-te),te=-1}else for(r+F>w&&(r=w-F),Q=r;Q>=0;Q--){let te=!0;for(let H=0;H<F;H++)if(ee(i,Q+H)!==ee(n,H)){te=!1;break}if(te)return Q}return-1}c.prototype.includes=function(n,r,l){return this.indexOf(n,r,l)!==-1},c.prototype.indexOf=function(n,r,l){return $(this,n,r,l,!0)},c.prototype.lastIndexOf=function(n,r,l){return $(this,n,r,l,!1)};function D(i,n,r,l){r=Number(r)||0;const f=i.length-r;l?(l=Number(l),l>f&&(l=f)):l=f;const m=n.length;l>m/2&&(l=m/2);let w;for(w=0;w<l;++w){const F=parseInt(n.substr(w*2,2),16);if(bt(F))return w;i[r+w]=F}return w}function L(i,n,r,l){return nt(St(n,i.length-r),i,r,l)}function re(i,n,r,l){return nt(ns(n),i,r,l)}function Y(i,n,r,l){return nt(rn(n),i,r,l)}function X(i,n,r,l){return nt(rs(n,i.length-r),i,r,l)}c.prototype.write=function(n,r,l,f){if(r===void 0)f="utf8",l=this.length,r=0;else if(l===void 0&&typeof r=="string")f=r,l=this.length,r=0;else if(isFinite(r))r=r>>>0,isFinite(l)?(l=l>>>0,f===void 0&&(f="utf8")):(f=l,l=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const m=this.length-r;if((l===void 0||l>m)&&(l=m),n.length>0&&(l<0||r<0)||r>this.length)throw new RangeError("Attempt to write outside buffer bounds");f||(f="utf8");let w=!1;for(;;)switch(f){case"hex":return D(this,n,r,l);case"utf8":case"utf-8":return L(this,n,r,l);case"ascii":case"latin1":case"binary":return re(this,n,r,l);case"base64":return Y(this,n,r,l);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return X(this,n,r,l);default:if(w)throw new TypeError("Unknown encoding: "+f);f=(""+f).toLowerCase(),w=!0}},c.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function P(i,n,r){return n===0&&r===i.length?e.fromByteArray(i):e.fromByteArray(i.slice(n,r))}function W(i,n,r){r=Math.min(i.length,r);const l=[];let f=n;for(;f<r;){const m=i[f];let w=null,F=m>239?4:m>223?3:m>191?2:1;if(f+F<=r){let ee,Q,te,H;switch(F){case 1:m<128&&(w=m);break;case 2:ee=i[f+1],(ee&192)===128&&(H=(m&31)<<6|ee&63,H>127&&(w=H));break;case 3:ee=i[f+1],Q=i[f+2],(ee&192)===128&&(Q&192)===128&&(H=(m&15)<<12|(ee&63)<<6|Q&63,H>2047&&(H<55296||H>57343)&&(w=H));break;case 4:ee=i[f+1],Q=i[f+2],te=i[f+3],(ee&192)===128&&(Q&192)===128&&(te&192)===128&&(H=(m&15)<<18|(ee&63)<<12|(Q&63)<<6|te&63,H>65535&&H<1114112&&(w=H))}}w===null?(w=65533,F=1):w>65535&&(w-=65536,l.push(w>>>10&1023|55296),w=56320|w&1023),l.push(w),f+=F}return z(l)}const K=4096;function z(i){const n=i.length;if(n<=K)return String.fromCharCode.apply(String,i);let r="",l=0;for(;l<n;)r+=String.fromCharCode.apply(String,i.slice(l,l+=K));return r}function M(i,n,r){let l="";r=Math.min(i.length,r);for(let f=n;f<r;++f)l+=String.fromCharCode(i[f]&127);return l}function V(i,n,r){let l="";r=Math.min(i.length,r);for(let f=n;f<r;++f)l+=String.fromCharCode(i[f]);return l}function G(i,n,r){const l=i.length;(!n||n<0)&&(n=0),(!r||r<0||r>l)&&(r=l);let f="";for(let m=n;m<r;++m)f+=ss[i[m]];return f}function ie(i,n,r){const l=i.slice(n,r);let f="";for(let m=0;m<l.length-1;m+=2)f+=String.fromCharCode(l[m]+l[m+1]*256);return f}c.prototype.slice=function(n,r){const l=this.length;n=~~n,r=r===void 0?l:~~r,n<0?(n+=l,n<0&&(n=0)):n>l&&(n=l),r<0?(r+=l,r<0&&(r=0)):r>l&&(r=l),r<n&&(r=n);const f=this.subarray(n,r);return Object.setPrototypeOf(f,c.prototype),f};function T(i,n,r){if(i%1!==0||i<0)throw new RangeError("offset is not uint");if(i+n>r)throw new RangeError("Trying to access beyond buffer length")}c.prototype.readUintLE=c.prototype.readUIntLE=function(n,r,l){n=n>>>0,r=r>>>0,l||T(n,r,this.length);let f=this[n],m=1,w=0;for(;++w<r&&(m*=256);)f+=this[n+w]*m;return f},c.prototype.readUintBE=c.prototype.readUIntBE=function(n,r,l){n=n>>>0,r=r>>>0,l||T(n,r,this.length);let f=this[n+--r],m=1;for(;r>0&&(m*=256);)f+=this[n+--r]*m;return f},c.prototype.readUint8=c.prototype.readUInt8=function(n,r){return n=n>>>0,r||T(n,1,this.length),this[n]},c.prototype.readUint16LE=c.prototype.readUInt16LE=function(n,r){return n=n>>>0,r||T(n,2,this.length),this[n]|this[n+1]<<8},c.prototype.readUint16BE=c.prototype.readUInt16BE=function(n,r){return n=n>>>0,r||T(n,2,this.length),this[n]<<8|this[n+1]},c.prototype.readUint32LE=c.prototype.readUInt32LE=function(n,r){return n=n>>>0,r||T(n,4,this.length),(this[n]|this[n+1]<<8|this[n+2]<<16)+this[n+3]*16777216},c.prototype.readUint32BE=c.prototype.readUInt32BE=function(n,r){return n=n>>>0,r||T(n,4,this.length),this[n]*16777216+(this[n+1]<<16|this[n+2]<<8|this[n+3])},c.prototype.readBigUInt64LE=Ae(function(n){n=n>>>0,Re(n,"offset");const r=this[n],l=this[n+7];(r===void 0||l===void 0)&&be(n,this.length-8);const f=r+this[++n]*2**8+this[++n]*2**16+this[++n]*2**24,m=this[++n]+this[++n]*2**8+this[++n]*2**16+l*2**24;return BigInt(f)+(BigInt(m)<<BigInt(32))}),c.prototype.readBigUInt64BE=Ae(function(n){n=n>>>0,Re(n,"offset");const r=this[n],l=this[n+7];(r===void 0||l===void 0)&&be(n,this.length-8);const f=r*2**24+this[++n]*2**16+this[++n]*2**8+this[++n],m=this[++n]*2**24+this[++n]*2**16+this[++n]*2**8+l;return(BigInt(f)<<BigInt(32))+BigInt(m)}),c.prototype.readIntLE=function(n,r,l){n=n>>>0,r=r>>>0,l||T(n,r,this.length);let f=this[n],m=1,w=0;for(;++w<r&&(m*=256);)f+=this[n+w]*m;return m*=128,f>=m&&(f-=Math.pow(2,8*r)),f},c.prototype.readIntBE=function(n,r,l){n=n>>>0,r=r>>>0,l||T(n,r,this.length);let f=r,m=1,w=this[n+--f];for(;f>0&&(m*=256);)w+=this[n+--f]*m;return m*=128,w>=m&&(w-=Math.pow(2,8*r)),w},c.prototype.readInt8=function(n,r){return n=n>>>0,r||T(n,1,this.length),this[n]&128?(255-this[n]+1)*-1:this[n]},c.prototype.readInt16LE=function(n,r){n=n>>>0,r||T(n,2,this.length);const l=this[n]|this[n+1]<<8;return l&32768?l|4294901760:l},c.prototype.readInt16BE=function(n,r){n=n>>>0,r||T(n,2,this.length);const l=this[n+1]|this[n]<<8;return l&32768?l|4294901760:l},c.prototype.readInt32LE=function(n,r){return n=n>>>0,r||T(n,4,this.length),this[n]|this[n+1]<<8|this[n+2]<<16|this[n+3]<<24},c.prototype.readInt32BE=function(n,r){return n=n>>>0,r||T(n,4,this.length),this[n]<<24|this[n+1]<<16|this[n+2]<<8|this[n+3]},c.prototype.readBigInt64LE=Ae(function(n){n=n>>>0,Re(n,"offset");const r=this[n],l=this[n+7];(r===void 0||l===void 0)&&be(n,this.length-8);const f=this[n+4]+this[n+5]*2**8+this[n+6]*2**16+(l<<24);return(BigInt(f)<<BigInt(32))+BigInt(r+this[++n]*2**8+this[++n]*2**16+this[++n]*2**24)}),c.prototype.readBigInt64BE=Ae(function(n){n=n>>>0,Re(n,"offset");const r=this[n],l=this[n+7];(r===void 0||l===void 0)&&be(n,this.length-8);const f=(r<<24)+this[++n]*2**16+this[++n]*2**8+this[++n];return(BigInt(f)<<BigInt(32))+BigInt(this[++n]*2**24+this[++n]*2**16+this[++n]*2**8+l)}),c.prototype.readFloatLE=function(n,r){return n=n>>>0,r||T(n,4,this.length),s.read(this,n,!0,23,4)},c.prototype.readFloatBE=function(n,r){return n=n>>>0,r||T(n,4,this.length),s.read(this,n,!1,23,4)},c.prototype.readDoubleLE=function(n,r){return n=n>>>0,r||T(n,8,this.length),s.read(this,n,!0,52,8)},c.prototype.readDoubleBE=function(n,r){return n=n>>>0,r||T(n,8,this.length),s.read(this,n,!1,52,8)};function S(i,n,r,l,f,m){if(!c.isBuffer(i))throw new TypeError('"buffer" argument must be a Buffer instance');if(n>f||n<m)throw new RangeError('"value" argument is out of bounds');if(r+l>i.length)throw new RangeError("Index out of range")}c.prototype.writeUintLE=c.prototype.writeUIntLE=function(n,r,l,f){if(n=+n,r=r>>>0,l=l>>>0,!f){const F=Math.pow(2,8*l)-1;S(this,n,r,l,F,0)}let m=1,w=0;for(this[r]=n&255;++w<l&&(m*=256);)this[r+w]=n/m&255;return r+l},c.prototype.writeUintBE=c.prototype.writeUIntBE=function(n,r,l,f){if(n=+n,r=r>>>0,l=l>>>0,!f){const F=Math.pow(2,8*l)-1;S(this,n,r,l,F,0)}let m=l-1,w=1;for(this[r+m]=n&255;--m>=0&&(w*=256);)this[r+m]=n/w&255;return r+l},c.prototype.writeUint8=c.prototype.writeUInt8=function(n,r,l){return n=+n,r=r>>>0,l||S(this,n,r,1,255,0),this[r]=n&255,r+1},c.prototype.writeUint16LE=c.prototype.writeUInt16LE=function(n,r,l){return n=+n,r=r>>>0,l||S(this,n,r,2,65535,0),this[r]=n&255,this[r+1]=n>>>8,r+2},c.prototype.writeUint16BE=c.prototype.writeUInt16BE=function(n,r,l){return n=+n,r=r>>>0,l||S(this,n,r,2,65535,0),this[r]=n>>>8,this[r+1]=n&255,r+2},c.prototype.writeUint32LE=c.prototype.writeUInt32LE=function(n,r,l){return n=+n,r=r>>>0,l||S(this,n,r,4,4294967295,0),this[r+3]=n>>>24,this[r+2]=n>>>16,this[r+1]=n>>>8,this[r]=n&255,r+4},c.prototype.writeUint32BE=c.prototype.writeUInt32BE=function(n,r,l){return n=+n,r=r>>>0,l||S(this,n,r,4,4294967295,0),this[r]=n>>>24,this[r+1]=n>>>16,this[r+2]=n>>>8,this[r+3]=n&255,r+4};function ae(i,n,r,l,f){tt(n,l,f,i,r,7);let m=Number(n&BigInt(4294967295));i[r++]=m,m=m>>8,i[r++]=m,m=m>>8,i[r++]=m,m=m>>8,i[r++]=m;let w=Number(n>>BigInt(32)&BigInt(4294967295));return i[r++]=w,w=w>>8,i[r++]=w,w=w>>8,i[r++]=w,w=w>>8,i[r++]=w,r}function Se(i,n,r,l,f){tt(n,l,f,i,r,7);let m=Number(n&BigInt(4294967295));i[r+7]=m,m=m>>8,i[r+6]=m,m=m>>8,i[r+5]=m,m=m>>8,i[r+4]=m;let w=Number(n>>BigInt(32)&BigInt(4294967295));return i[r+3]=w,w=w>>8,i[r+2]=w,w=w>>8,i[r+1]=w,w=w>>8,i[r]=w,r+8}c.prototype.writeBigUInt64LE=Ae(function(n,r=0){return ae(this,n,r,BigInt(0),BigInt("0xffffffffffffffff"))}),c.prototype.writeBigUInt64BE=Ae(function(n,r=0){return Se(this,n,r,BigInt(0),BigInt("0xffffffffffffffff"))}),c.prototype.writeIntLE=function(n,r,l,f){if(n=+n,r=r>>>0,!f){const ee=Math.pow(2,8*l-1);S(this,n,r,l,ee-1,-ee)}let m=0,w=1,F=0;for(this[r]=n&255;++m<l&&(w*=256);)n<0&&F===0&&this[r+m-1]!==0&&(F=1),this[r+m]=(n/w>>0)-F&255;return r+l},c.prototype.writeIntBE=function(n,r,l,f){if(n=+n,r=r>>>0,!f){const ee=Math.pow(2,8*l-1);S(this,n,r,l,ee-1,-ee)}let m=l-1,w=1,F=0;for(this[r+m]=n&255;--m>=0&&(w*=256);)n<0&&F===0&&this[r+m+1]!==0&&(F=1),this[r+m]=(n/w>>0)-F&255;return r+l},c.prototype.writeInt8=function(n,r,l){return n=+n,r=r>>>0,l||S(this,n,r,1,127,-128),n<0&&(n=255+n+1),this[r]=n&255,r+1},c.prototype.writeInt16LE=function(n,r,l){return n=+n,r=r>>>0,l||S(this,n,r,2,32767,-32768),this[r]=n&255,this[r+1]=n>>>8,r+2},c.prototype.writeInt16BE=function(n,r,l){return n=+n,r=r>>>0,l||S(this,n,r,2,32767,-32768),this[r]=n>>>8,this[r+1]=n&255,r+2},c.prototype.writeInt32LE=function(n,r,l){return n=+n,r=r>>>0,l||S(this,n,r,4,2147483647,-2147483648),this[r]=n&255,this[r+1]=n>>>8,this[r+2]=n>>>16,this[r+3]=n>>>24,r+4},c.prototype.writeInt32BE=function(n,r,l){return n=+n,r=r>>>0,l||S(this,n,r,4,2147483647,-2147483648),n<0&&(n=4294967295+n+1),this[r]=n>>>24,this[r+1]=n>>>16,this[r+2]=n>>>8,this[r+3]=n&255,r+4},c.prototype.writeBigInt64LE=Ae(function(n,r=0){return ae(this,n,r,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),c.prototype.writeBigInt64BE=Ae(function(n,r=0){return Se(this,n,r,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function je(i,n,r,l,f,m){if(r+l>i.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function Z(i,n,r,l,f){return n=+n,r=r>>>0,f||je(i,n,r,4),s.write(i,n,r,l,23,4),r+4}c.prototype.writeFloatLE=function(n,r,l){return Z(this,n,r,!0,l)},c.prototype.writeFloatBE=function(n,r,l){return Z(this,n,r,!1,l)};function le(i,n,r,l,f){return n=+n,r=r>>>0,f||je(i,n,r,8),s.write(i,n,r,l,52,8),r+8}c.prototype.writeDoubleLE=function(n,r,l){return le(this,n,r,!0,l)},c.prototype.writeDoubleBE=function(n,r,l){return le(this,n,r,!1,l)},c.prototype.copy=function(n,r,l,f){if(!c.isBuffer(n))throw new TypeError("argument should be a Buffer");if(l||(l=0),!f&&f!==0&&(f=this.length),r>=n.length&&(r=n.length),r||(r=0),f>0&&f<l&&(f=l),f===l||n.length===0||this.length===0)return 0;if(r<0)throw new RangeError("targetStart out of bounds");if(l<0||l>=this.length)throw new RangeError("Index out of range");if(f<0)throw new RangeError("sourceEnd out of bounds");f>this.length&&(f=this.length),n.length-r<f-l&&(f=n.length-r+l);const m=f-l;return this===n&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(r,l,f):Uint8Array.prototype.set.call(n,this.subarray(l,f),r),m},c.prototype.fill=function(n,r,l,f){if(typeof n=="string"){if(typeof r=="string"?(f=r,r=0,l=this.length):typeof l=="string"&&(f=l,l=this.length),f!==void 0&&typeof f!="string")throw new TypeError("encoding must be a string");if(typeof f=="string"&&!c.isEncoding(f))throw new TypeError("Unknown encoding: "+f);if(n.length===1){const w=n.charCodeAt(0);(f==="utf8"&&w<128||f==="latin1")&&(n=w)}}else typeof n=="number"?n=n&255:typeof n=="boolean"&&(n=Number(n));if(r<0||this.length<r||this.length<l)throw new RangeError("Out of range index");if(l<=r)return this;r=r>>>0,l=l===void 0?this.length:l>>>0,n||(n=0);let m;if(typeof n=="number")for(m=r;m<l;++m)this[m]=n;else{const w=c.isBuffer(n)?n:c.from(n,f),F=w.length;if(F===0)throw new TypeError('The value "'+n+'" is invalid for argument "value"');for(m=0;m<l-r;++m)this[m+r]=w[m%F]}return this};const fe={};function se(i,n,r){fe[i]=class extends r{constructor(){super(),Object.defineProperty(this,"message",{value:n.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${i}]`,this.stack,delete this.name}get code(){return i}set code(f){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:f,writable:!0})}toString(){return`${this.name} [${i}]: ${this.message}`}}}se("ERR_BUFFER_OUT_OF_BOUNDS",function(i){return i?`${i} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),se("ERR_INVALID_ARG_TYPE",function(i,n){return`The "${i}" argument must be of type number. Received type ${typeof n}`},TypeError),se("ERR_OUT_OF_RANGE",function(i,n,r){let l=`The value of "${i}" is out of range.`,f=r;return Number.isInteger(r)&&Math.abs(r)>2**32?f=De(String(r)):typeof r=="bigint"&&(f=String(r),(r>BigInt(2)**BigInt(32)||r<-(BigInt(2)**BigInt(32)))&&(f=De(f)),f+="n"),l+=` It must be ${n}. Received ${f}`,l},RangeError);function De(i){let n="",r=i.length;const l=i[0]==="-"?1:0;for(;r>=l+4;r-=3)n=`_${i.slice(r-3,r)}${n}`;return`${i.slice(0,r)}${n}`}function pe(i,n,r){Re(n,"offset"),(i[n]===void 0||i[n+r]===void 0)&&be(n,i.length-(r+1))}function tt(i,n,r,l,f,m){if(i>r||i<n){const w=typeof n=="bigint"?"n":"";let F;throw n===0||n===BigInt(0)?F=`>= 0${w} and < 2${w} ** ${(m+1)*8}${w}`:F=`>= -(2${w} ** ${(m+1)*8-1}${w}) and < 2 ** ${(m+1)*8-1}${w}`,new fe.ERR_OUT_OF_RANGE("value",F,i)}pe(l,f,m)}function Re(i,n){if(typeof i!="number")throw new fe.ERR_INVALID_ARG_TYPE(n,"number",i)}function be(i,n,r){throw Math.floor(i)!==i?(Re(i,r),new fe.ERR_OUT_OF_RANGE("offset","an integer",i)):n<0?new fe.ERR_BUFFER_OUT_OF_BOUNDS:new fe.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${n}`,i)}const es=/[^+/0-9A-Za-z-_]/g;function ts(i){if(i=i.split("=")[0],i=i.trim().replace(es,""),i.length<2)return"";for(;i.length%4!==0;)i=i+"=";return i}function St(i,n){n=n||1/0;let r;const l=i.length;let f=null;const m=[];for(let w=0;w<l;++w){if(r=i.charCodeAt(w),r>55295&&r<57344){if(!f){if(r>56319){(n-=3)>-1&&m.push(239,191,189);continue}else if(w+1===l){(n-=3)>-1&&m.push(239,191,189);continue}f=r;continue}if(r<56320){(n-=3)>-1&&m.push(239,191,189),f=r;continue}r=(f-55296<<10|r-56320)+65536}else f&&(n-=3)>-1&&m.push(239,191,189);if(f=null,r<128){if((n-=1)<0)break;m.push(r)}else if(r<2048){if((n-=2)<0)break;m.push(r>>6|192,r&63|128)}else if(r<65536){if((n-=3)<0)break;m.push(r>>12|224,r>>6&63|128,r&63|128)}else if(r<1114112){if((n-=4)<0)break;m.push(r>>18|240,r>>12&63|128,r>>6&63|128,r&63|128)}else throw new Error("Invalid code point")}return m}function ns(i){const n=[];for(let r=0;r<i.length;++r)n.push(i.charCodeAt(r)&255);return n}function rs(i,n){let r,l,f;const m=[];for(let w=0;w<i.length&&!((n-=2)<0);++w)r=i.charCodeAt(w),l=r>>8,f=r%256,m.push(f),m.push(l);return m}function rn(i){return e.toByteArray(ts(i))}function nt(i,n,r,l){let f;for(f=0;f<l&&!(f+r>=n.length||f>=i.length);++f)n[f+r]=i[f];return f}function Ie(i,n){return i instanceof n||i!=null&&i.constructor!=null&&i.constructor.name!=null&&i.constructor.name===n.name}function bt(i){return i!==i}const ss=function(){const i="0123456789abcdef",n=new Array(256);for(let r=0;r<16;++r){const l=r*16;for(let f=0;f<16;++f)n[l+f]=i[r]+i[f]}return n}();function Ae(i){return typeof BigInt>"u"?os:i}function os(){throw new Error("BigInt not supported")}})(Jt);function Ec(t){if(typeof t!="string")throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!t)throw new Error("No input");const e=JSON.parse(t),s=e;let o;if(s.type==="system")if(s.event==="connected")o=Object.assign(Object.assign({},e),{kind:"connected"});else if(s.event==="disconnected")o=Object.assign(Object.assign({},e),{kind:"disconnected"});else return null;else if(s.type==="message")if(s.from==="group"){const a=An(e.data,e.dataType);if(a===null)return null;o=Object.assign(Object.assign({},e),{data:a,kind:"groupData"})}else if(s.from==="server"){const a=An(e.data,e.dataType);if(a===null)return null;o=Object.assign(Object.assign({},e),{data:a,kind:"serverData"})}else return null;else if(s.type==="ack")o=Object.assign(Object.assign({},e),{kind:"ack"});else return null;return o}function kc(t){let e;switch(t.kind){case"joinGroup":{e={type:"joinGroup",group:t.group,ackId:t.ackId};break}case"leaveGroup":{e={type:"leaveGroup",group:t.group,ackId:t.ackId};break}case"sendEvent":{e={type:"event",event:t.event,ackId:t.ackId,dataType:t.dataType,data:Rn(t.data,t.dataType)};break}case"sendToGroup":{e={type:"sendToGroup",group:t.group,ackId:t.ackId,dataType:t.dataType,data:Rn(t.data,t.dataType),noEcho:t.noEcho};break}case"sequenceAck":{e={type:"sequenceAck",sequenceId:t.sequenceId};break}default:throw new Error(`Unsupported type: ${t.kind}`)}return JSON.stringify(e)}function Rn(t,e){switch(e){case"text":{if(typeof t!="string")throw new TypeError("Message must be a string.");return t}case"json":return t;case"binary":case"protobuf":{if(t instanceof ArrayBuffer)return Jt.Buffer.from(t).toString("base64");throw new TypeError("Message must be a ArrayBuffer")}}}function An(t,e){if(e==="text"){if(typeof t!="string")throw new TypeError("Message must be a string when dataType is text");return t}else{if(e==="json")return t;if(e==="binary"||e==="protobuf"){const s=Jt.Buffer.from(t,"base64");return s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength)}else return null}}class Tc{constructor(){this.isReliableSubProtocol=!0,this.name="json.reliable.webpubsub.azure.v1"}parseMessages(e){return Ec(e)}writeMessage(e){return kc(e)}}const Mc=()=>new Tc;var ge;(function(t){t.Stopped="Stopped",t.Disconnected="Disconnected",t.Connecting="Connecting",t.Connected="Connected",t.Recovering="Recovering"})(ge||(ge={}));class Rc{nextAckId(){return this._ackId=this._ackId+1,this._ackId}constructor(e,s){this._quickSequenceAckDiff=300,this._activeTimeoutInMs=2e4,this._emitter=new Qo,this._isStopping=!1,this._isInitialConnected=!1,typeof e=="string"?this._credential={getClientAccessUrl:e}:this._credential=e,s==null&&(s={}),this._buildDefaultOptions(s),this._options=s,this._messageRetryPolicy=new Bn(this._options.messageRetryOptions),this._reconnectRetryPolicy=new Bn(this._options.reconnectRetryOptions),this._protocol=this._options.protocol,this._groupMap=new Map,this._ackMap=new Map,this._sequenceId=new Nc,this._state=ge.Stopped,this._ackId=0}async start(e){if(this._isStopping)throw new Error("Can't start a client during stopping");if(this._state!==ge.Stopped)throw new Error("Client can be only started when it's Stopped");let s;e&&(s=e.abortSignal),this._activeKeepaliveTask||(this._activeKeepaliveTask=this._getActiveKeepaliveTask());try{await this._startCore(s)}catch(o){throw this._changeState(ge.Stopped),this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0),this._isStopping=!1,o}}async _startFromRestarting(e){if(this._state!==ge.Disconnected)throw new Error("Client can be only restarted when it's Disconnected");try{ue.verbose("Staring reconnecting."),await this._startCore(e)}catch(s){throw this._changeState(ge.Disconnected),s}}async _startCore(e){if(this._changeState(ge.Connecting),ue.info("Staring a new connection"),this._sequenceId.reset(),this._isInitialConnected=!1,this._lastCloseEvent=void 0,this._lastDisconnectedMessage=void 0,this._connectionId=void 0,this._reconnectionToken=void 0,this._uri=void 0,typeof this._credential.getClientAccessUrl=="string"?this._uri=this._credential.getClientAccessUrl:this._uri=await this._credential.getClientAccessUrl({abortSignal:e}),typeof this._uri!="string")throw new Error(`The clientAccessUrl must be a string but currently it's ${typeof this._uri}`);await this._connectCore(this._uri)}stop(){this._state===ge.Stopped||this._isStopping||(this._isStopping=!0,this._wsClient&&this._wsClient.isOpen()?this._wsClient.close():this._isStopping=!1,this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0))}on(e,s){this._emitter.on(e,s)}off(e,s){this._emitter.removeListener(e,s)}_emitEvent(e,s){this._emitter.emit(e,s)}async sendEvent(e,s,o,a){return await this._operationExecuteWithRetry(()=>this._sendEventAttempt(e,s,o,a),a?.abortSignal)}async _sendEventAttempt(e,s,o,a){var u;if(!((u=a?.fireAndForget)!==null&&u!==void 0?u:!1))return await this._sendMessageWithAckId(g=>({kind:"sendEvent",dataType:o,data:s,ackId:g,event:e}),a?.ackId,a?.abortSignal);const c={kind:"sendEvent",dataType:o,data:s,event:e};return await this._sendMessage(c,a?.abortSignal),{isDuplicated:!1}}async joinGroup(e,s){return await this._operationExecuteWithRetry(()=>this._joinGroupAttempt(e,s),s?.abortSignal)}async _joinGroupAttempt(e,s){const o=this._getOrAddGroup(e),a=await this._joinGroupCore(e,s);return o.isJoined=!0,a}async _joinGroupCore(e,s){return await this._sendMessageWithAckId(o=>({group:e,ackId:o,kind:"joinGroup"}),s?.ackId,s?.abortSignal)}async leaveGroup(e,s){return await this._operationExecuteWithRetry(()=>this._leaveGroupAttempt(e,s),s?.abortSignal)}async _leaveGroupAttempt(e,s){const o=this._getOrAddGroup(e),a=await this._sendMessageWithAckId(u=>({group:e,ackId:u,kind:"leaveGroup"}),s?.ackId,s?.abortSignal);return o.isJoined=!1,a}async sendToGroup(e,s,o,a){return await this._operationExecuteWithRetry(()=>this._sendToGroupAttempt(e,s,o,a),a?.abortSignal)}async _sendToGroupAttempt(e,s,o,a){var u,h;const c=(u=a?.fireAndForget)!==null&&u!==void 0?u:!1,g=(h=a?.noEcho)!==null&&h!==void 0?h:!1;if(!c)return await this._sendMessageWithAckId(x=>({kind:"sendToGroup",group:e,dataType:o,data:s,ackId:x,noEcho:g}),a?.ackId,a?.abortSignal);const _={kind:"sendToGroup",group:e,dataType:o,data:s,noEcho:g};return await this._sendMessage(_,a?.abortSignal),{isDuplicated:!1}}_getWebSocketClientFactory(){return new Jo}async _trySendSequenceAck(){if(!this._protocol.isReliableSubProtocol)return;const[e,s]=this._sequenceId.tryGetSequenceId();if(e&&s){const o={kind:"sequenceAck",sequenceId:s};try{await this._sendMessage(o)}catch{this._sequenceId.tryUpdate(s)}}}_connectCore(e){if(this._isStopping)throw new Error("Can't start a client during stopping");return new Promise((s,o)=>{const a=this._wsClient=this._getWebSocketClientFactory().create(e,this._protocol.name);a.onopen(()=>{if(this._isStopping){try{a.close()}catch{}o(new Error("The client is stopped"))}ue.verbose("WebSocket connection has opened"),this._changeState(ge.Connected),this._protocol.isReliableSubProtocol&&(this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),this._sequenceAckTask=new Nn(async()=>{await this._trySendSequenceAck()},1e3)),s()}),a.onerror(u=>{this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),o(u)}),a.onclose((u,h)=>{this._state===ge.Connected?(ue.verbose("WebSocket closed after open"),this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),ue.info(`WebSocket connection closed. Code: ${u}, Reason: ${h}`),this._lastCloseEvent={code:u,reason:h},this._handleConnectionClose.call(this)):(ue.verbose("WebSocket closed before open"),o(new Error(`Failed to start WebSocket: ${u}`)))}),a.onmessage(u=>{const h=p=>{if(this._ackMap.has(p.ackId)){const y=this._ackMap.get(p.ackId);this._ackMap.delete(p.ackId);const C=p.error!=null&&p.error.name==="Duplicate";p.success||C?y.resolve({ackId:p.ackId,isDuplicated:C}):y.reject(new st("Failed to send message.",{ackId:p.ackId,errorDetail:p.error}))}},c=async p=>{if(this._connectionId=p.connectionId,this._reconnectionToken=p.reconnectionToken,!this._isInitialConnected){if(this._isInitialConnected=!0,this._options.autoRejoinGroups){const y=[];this._groupMap.forEach(C=>{C.isJoined&&y.push((async()=>{try{await this._joinGroupCore(C.name)}catch(b){this._safeEmitRejoinGroupFailed(C.name,b)}})())});try{await Promise.all(y)}catch{}}this._safeEmitConnected(p.connectionId,p.userId)}},g=p=>{this._lastDisconnectedMessage=p},_=p=>{if(p.sequenceId!=null){const y=this._sequenceId.tryUpdate(p.sequenceId);if(y===0)return;y>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitGroupMessage(p)},x=p=>{if(p.sequenceId!=null){const y=this._sequenceId.tryUpdate(p.sequenceId);if(y===0)return;y>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitServerMessage(p)};let I;try{let p;if(Array.isArray(u)?p=Buffer.concat(u):p=u,I=this._protocol.parseMessages(p),I===null)return}catch(p){throw ue.warning("An error occurred while parsing the message from service",p),p}Array.isArray(I)||(I=[I]),I.forEach(p=>{try{switch(p.kind){case"ack":{h(p);break}case"connected":{c(p);break}case"disconnected":{g(p);break}case"groupData":{_(p);break}case"serverData":{x(p);break}}}catch(y){ue.warning(`An error occurred while handling the message with kind: ${p.kind} from service`,y)}})})})}async _handleConnectionCloseAndNoRecovery(){this._state=ge.Disconnected,this._safeEmitDisconnected(this._connectionId,this._lastDisconnectedMessage),this._options.autoReconnect?await this._autoReconnect():await this._handleConnectionStopped()}async _autoReconnect(){let e=!1,s=0;try{for(;!this._isStopping;)try{await this._startFromRestarting(),e=!0;break}catch(o){ue.warning("An attempt to reconnect connection failed.",o),s++;const a=this._reconnectRetryPolicy.nextRetryDelayInMs(s);if(a==null)break;try{ue.verbose(`Delay time for reconnect attempt ${s}: ${a}`),await it(a)}catch{}}}finally{e||this._handleConnectionStopped()}}_handleConnectionStopped(){this._isStopping=!1,this._state=ge.Stopped,this._safeEmitStopped()}_getActiveKeepaliveTask(){return new Nn(async()=>{this._sequenceId.tryUpdate(0)},this._activeTimeoutInMs)}async _sendMessage(e,s){if(!this._wsClient||!this._wsClient.isOpen())throw new Error("The connection is not connected.");const o=this._protocol.writeMessage(e);await this._wsClient.send(o,s)}async _sendMessageWithAckId(e,s,o){s==null&&(s=this.nextAckId());const a=e(s);this._ackMap.has(s)||this._ackMap.set(s,new Bc(s));const u=this._ackMap.get(s);try{await this._sendMessage(a,o)}catch(h){this._ackMap.delete(s);let c="";throw h instanceof Error&&(c=h.message),new st(c,{ackId:s})}if(o)try{return await Yo(u.promise(),o)}catch(h){throw h instanceof Error&&h.name==="AbortError"?new st("Cancelled by abortSignal",{ackId:s}):h}return await u.promise()}async _handleConnectionClose(){if(this._ackMap.forEach((a,u)=>{this._ackMap.delete(u)&&a.reject(new st("Connection is disconnected before receive ack from the service",{ackId:a.ackId}))}),this._isStopping){ue.warning("The client is stopping state. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(this._lastCloseEvent&&this._lastCloseEvent.code===1008){ue.warning("The websocket close with status code 1008. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(!this._protocol.isReliableSubProtocol){ue.warning("The protocol is not reliable, recovery is not applicable"),this._handleConnectionCloseAndNoRecovery();return}const e=this._buildRecoveryUri();if(!e){ue.warning("Connection id or reconnection token is not available"),this._handleConnectionCloseAndNoRecovery();return}let s=!1;this._state=ge.Recovering;const o=hr.timeout(30*1e3);try{for(;!o.aborted||this._isStopping;)try{await this._connectCore.call(this,e),s=!0;return}catch{await it(1e3)}}finally{s||(ue.warning("Recovery attempts failed more then 30 seconds or the client is stopping"),this._handleConnectionCloseAndNoRecovery())}}_safeEmitConnected(e,s){this._emitEvent("connected",{connectionId:e,userId:s})}_safeEmitDisconnected(e,s){this._emitEvent("disconnected",{connectionId:e,message:s})}_safeEmitGroupMessage(e){this._emitEvent("group-message",{message:e})}_safeEmitServerMessage(e){this._emitEvent("server-message",{message:e})}_safeEmitStopped(){this._emitEvent("stopped",{})}_safeEmitRejoinGroupFailed(e,s){this._emitEvent("rejoin-group-failed",{group:e,error:s})}_buildDefaultOptions(e){return e.autoReconnect==null&&(e.autoReconnect=!0),e.autoRejoinGroups==null&&(e.autoRejoinGroups=!0),e.protocol==null&&(e.protocol=Mc()),this._buildMessageRetryOptions(e),this._buildReconnectRetryOptions(e),e}_buildMessageRetryOptions(e){e.messageRetryOptions||(e.messageRetryOptions={}),(e.messageRetryOptions.maxRetries==null||e.messageRetryOptions.maxRetries<0)&&(e.messageRetryOptions.maxRetries=3),(e.messageRetryOptions.retryDelayInMs==null||e.messageRetryOptions.retryDelayInMs<0)&&(e.messageRetryOptions.retryDelayInMs=1e3),(e.messageRetryOptions.maxRetryDelayInMs==null||e.messageRetryOptions.maxRetryDelayInMs<0)&&(e.messageRetryOptions.maxRetryDelayInMs=3e4),e.messageRetryOptions.mode==null&&(e.messageRetryOptions.mode="Fixed")}_buildReconnectRetryOptions(e){e.reconnectRetryOptions||(e.reconnectRetryOptions={}),(e.reconnectRetryOptions.maxRetries==null||e.reconnectRetryOptions.maxRetries<0)&&(e.reconnectRetryOptions.maxRetries=Number.MAX_VALUE),(e.reconnectRetryOptions.retryDelayInMs==null||e.reconnectRetryOptions.retryDelayInMs<0)&&(e.reconnectRetryOptions.retryDelayInMs=1e3),(e.reconnectRetryOptions.maxRetryDelayInMs==null||e.reconnectRetryOptions.maxRetryDelayInMs<0)&&(e.reconnectRetryOptions.maxRetryDelayInMs=3e4),e.reconnectRetryOptions.mode==null&&(e.reconnectRetryOptions.mode="Fixed")}_buildRecoveryUri(){if(this._connectionId&&this._reconnectionToken&&this._uri){const e=new URL(this._uri);return e.searchParams.append("awps_connection_id",this._connectionId),e.searchParams.append("awps_reconnection_token",this._reconnectionToken),e.toString()}return null}_getOrAddGroup(e){return this._groupMap.has(e)||this._groupMap.set(e,new Ac(e)),this._groupMap.get(e)}_changeState(e){ue.verbose(`The client state transfer from ${this._state.toString()} to ${e.toString()}`),this._state=e}async _operationExecuteWithRetry(e,s){let o=0;for(;;)try{return await e.call(this)}catch(a){o++;const u=this._messageRetryPolicy.nextRetryDelayInMs(o);if(u==null||(await it(u),s?.aborted))throw a}}}class Bn{constructor(e){this._retryOptions=e,this._maxRetriesToGetMaxDelay=Math.ceil(Math.log2(this._retryOptions.maxRetryDelayInMs)-Math.log2(this._retryOptions.retryDelayInMs)+1)}nextRetryDelayInMs(e){return e>this._retryOptions.maxRetries?null:this._retryOptions.mode==="Fixed"?this._retryOptions.retryDelayInMs:this._calculateExponentialDelay(e)}_calculateExponentialDelay(e){return e>=this._maxRetriesToGetMaxDelay?this._retryOptions.maxRetryDelayInMs:(1<<e-1)*this._retryOptions.retryDelayInMs}}class Ac{constructor(e){this.isJoined=!1,this.name=e}}class Bc{constructor(e){this._promise=new Promise((s,o)=>{this._resolve=s,this._reject=o}),this.ackId=e}promise(){return this._promise}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}class Nc{constructor(){this._sequenceId=0,this._isUpdate=!1}tryUpdate(e){if(this._isUpdate=!0,e>this._sequenceId){const s=e-this._sequenceId;return this._sequenceId=e,s}return 0}tryGetSequenceId(){return this._isUpdate?(this._isUpdate=!1,[!0,this._sequenceId]):[!1,null]}reset(){this._sequenceId=0,this._isUpdate=!1}}class Nn{constructor(e,s,o){this._func=e,this._abortController=new hr,this._interval=s,this._obj=o,this._start()}abort(){try{this._abortController.abort()}catch{}}async _start(){const e=this._abortController.signal;for(;!e.aborted;)try{await this._func(this._obj)}catch{}finally{await it(this._interval)}}}const Fc=1e3*60*60,jc=1e3*30;class Dc{client;handler;terminationTimeout=null;connectionUrl;expiresAt;connected=!1;websocketRequestId=null;conversationId=null;secondaryTypeBasedHandlers=new Map;constructor(e,s,o,a=null,u=new Map){this.connectionUrl=s,this.expiresAt=o,this.client=new Rc({getClientAccessUrl:()=>e(this.connectionUrl,this.expiresAt)},{autoReconnect:!0,reconnectRetryOptions:{maxRetries:5,retryDelayInMs:100,maxRetryDelayInMs:1e4,mode:"Exponential"}}),this.handler=a,this.secondaryTypeBasedHandlers=u}async start(){const e=s=>{if(this.secondaryTypeBasedHandlers.has(s.message.data.type)){const o=this.secondaryTypeBasedHandlers.get(s.message.data.type);if(!o)return;o(s.message.data)}else{const o=s.message.data.body,a=atob(o).trim();if(a.startsWith("data: ")){const u=a.replace("data: ",""),h=this.handler;if(!h)return;h({conversationId:s.message.data.conversation_id,responseId:s.message.data.response_id,message:{id:"",event:"",data:u},websocketRequestId:s.message.data.websocket_request_id})}}};this.client.on("group-message",s=>e(s)),this.client.on("server-message",s=>e(s)),this.client.on("connected",()=>{this.connected=!0}),this.client.on("disconnected",()=>{this.connected=!1}),await this.client.start()}addSecondaryTypeHandler(e,s){this.secondaryTypeBasedHandlers.set(e,s)}isConnected(){return this.connected}async stop(e){e&&this.conversationId!==e||this.websocketRequestId&&await Te.stopWebsocketConversation(this.websocketRequestId)}setHandler(e,s,o,a){!this.handler&&this.websocketRequestId===o||(this.handler!=null&&this.websocketRequestId!==o&&(ws.warn("[websockets] Overwriting existing handler without silencing. This may indicate a race condition."),A.logEvent(B.asyncHandlerOverwritten,{originalWebsocketRequestId:this.websocketRequestId,newWebsocketRequestId:o,conversationId:e,responseId:s})),this.websocketRequestId=o,this.conversationId=e,this.handler=u=>{(u.websocketRequestId===o||u.conversationId===e&&u.responseId===s)&&a(u.message)})}silence(){this.handler=null}close(){this.client.stop()}scheduleForTermination(e){this.terminationTimeout=setTimeout(()=>{this.close(),e()},Fc)}preventTermination(){this.terminationTimeout&&(clearTimeout(this.terminationTimeout),this.terminationTimeout=null)}updateConnectionUrl(e,s){this.connectionUrl=e,this.expiresAt=s}}class Pc{activeSocketMap=new Map;secondaryTypeBasedHandlers=new Map;async register(){const e=await Te.postRegisterWebsocket();e.wss_url&&(this.getOrCreateSocket(e.wss_url,new Date(e.expires_at),!0),e.fallback_wss_url&&this.getOrCreateSocket(e.fallback_wss_url,new Date(e.expires_at),!1))}async registerIfNotConnected(){if(this.activeSocketMap.size===0){await this.register();return}for(const e of this.activeSocketMap.values())if(!e.isConnected()){await this.register();return}}isWebsocketConnected(){for(const e of this.activeSocketMap.values())if(e.isConnected())return!0;return this.activeSocketMap.size>0&&we.addError("Cannot connect to any websocket."),!1}async getOrCreateSocket(e,s,o){const a=e.split("?")[0];let u;const h=this.activeSocketMap.get(a);if(h&&h.isConnected())h.preventTermination(),h.updateConnectionUrl(e,s),u=h;else{h&&h.close(),u=new Dc(async(c,g)=>{if(new Date<new Date(g.getTime()-5*1e3))return c;const _=await Te.postRegisterWebsocket();return o?_.wss_url:_.fallback_wss_url??""},e,s,null,this.secondaryTypeBasedHandlers),this.activeSocketMap.set(a,u);try{await u.start()}catch(c){throw we.addError(new Error("Error occurred while starting websocket: ",{cause:c})),c}}return u}preSetupWebsocket(e,s,o){for(const a of this.activeSocketMap.values())this.setupWebSocketHandler(a,null,null,null,e,s,o)}addSecondaryTypeHandler(e,s){this.secondaryTypeBasedHandlers.set(e,s);for(const o of this.activeSocketMap.values())o.addSecondaryTypeHandler(e,s)}hasSecondaryTypeHandler(e){return this.secondaryTypeBasedHandlers.has(e)}async processWebSocketConversationStream(e,s,o,a,u,h,c,g,_){const x=[this.getOrCreateSocket(e,o,!0)];s&&x.push(this.getOrCreateSocket(s,o,!1));const I=await Promise.allSettled(x),p=I[0].status==="fulfilled"?I[0].value:null,y=I.length>1&&I[1].status==="fulfilled"?I[1].value:null;if((!p||!p.isConnected())&&we.addError(`Cannot connect to primary websocket, websocketRequestId: ${h}, token: ${e.substring(0,e.indexOf("access_token="))}`),(!p||!p.isConnected())&&(!y||!y.isConnected()))throw s&&we.addError(`Cannot connect to fallback websocket, websocketRequestId: ${h}, token: ${s.substring(0,s.indexOf("access_token="))}`),ye.createWithErrorMessage("websocket","server",`An error occurred while connecting to the websocket. ${Ut}`);let C=setTimeout(()=>{we.addError(`WebSocket took too long to respond: ${u}, ${a}, ${h}, ${e.substring(0,60)}...${e.slice(-20)}`,{supportsWebSockets:"WebSocket"in window&&window.WebSocket.CLOSING===2})},jc);const b=k=>(_&&(clearTimeout(_),_=null),C&&(clearTimeout(C),C=null),c(k));p&&this.setupWebSocketHandler(p,e,a,u,h,b,g),y&&s&&this.setupWebSocketHandler(y,s,a,u,h,b,g)}async stopConversation(e){for(const s of this.activeSocketMap.values())await s.stop(e)}setupWebSocketHandler(e,s,o,a,u,h,c){e.setHandler(o,a,u,h),this.secondaryTypeBasedHandlers.forEach((_,x)=>{e.addSecondaryTypeHandler(x,_)});const g=()=>{s?e.scheduleForTermination(()=>{this.activeSocketMap.delete(s.split("?")[0])}):(this.stopConversation(o),e.silence())};c.addEventListener("abort",g)}}const tn=new Pc;function Uc(t){return{webSocketUrl:t.wss_url,fallbackWebSocketUrl:t.fallback_wss_url,conversationId:t.conversation_id,responseId:t.response_id,expiresAt:t.expires_at&&new Date(t.expires_at),websocketRequestId:t.websocket_request_id}}async function Oc(t,e,s){return tn.preSetupWebsocket(t,e,s)}async function Lc(t,e,s,o,a,u,h,c,g){return tn.processWebSocketConversationStream(t,e,s,o,a,u,h,c,g)}const Je=t=>{switch(t.type){case ce.Reply:return t.text;case ce.Starter:case ce.Autocomplete:return t.prompt}},qc=t=>t.type===ce.Reply,Hr=t=>t.type===ce.Starter,nn=t=>t.type===ce.Autocomplete,at=t=>nn(t)&&!!t.theme,zl=(t,e,s,o)=>{switch(oe.logEvent("chatgpt_prompt_use_suggestion",nn(t)&&!at(t)?"":Je(t),{id:Hr(t)||at(t)?t.id??"":"",index:`${e}`,type:t.type}),t.type){case ce.Reply:A.logEvent(B.useSuggestedReply,{value:Je(t),prompt_type:ce.Reply,messageId:o});break;case ce.Starter:A.logEvent(B.useStarterPrompt,{value:Je(t),prompt_type:ce.Starter,title:t.title,body:t.body,id:t.id,category:t.category,client_thread_id:s,messageId:o,index:e,theme:t.theme});break;case ce.Autocomplete:{const a=at(t);A.logEvent(B.useAutocomplete,{value:a?Je(t):"",prompt_type:ce.Autocomplete,title:a?t.title:"",body:a?t.body:"",id:a?t.id:"",category:t.category,index:e,messageId:o,client_thread_id:s,theme:t.theme??""});break}}},Vl=(t,e)=>{const s=E.getThreadCurrentLeafId(e),o=E.getTree(e).getMessageId(s);if(oe.logEvent("chatgpt_prompt_show_suggestions",`count_${t.length}`,{type:t[0].type}),t.every(qc))A.logEvent(B.showSuggestedReplies,{prompt_count:t.length,prompt_type:ce.Reply,client_thread_id:e,suggestions:t.map(a=>a.text),message_id:o});else if(t.every(Hr)){const{isAdditional:a}=t[0];A.logEvent(a?B.moreStarterPromptsShown:B.showStarterPrompts,{prompt_count:t.length,prompt_type:ce.Starter,titles:t.map(u=>u.title),bodies:t.map(u=>u.body),ids:t.map(u=>u.id),client_thread_id:e,message_id:o,themes:t.map(u=>u.theme??"")}),a&&A.logEvent(B.expandMoreStarterPrompts,{client_thread_id:e,message_id:o})}else if(t.every(nn)){const a=!!t.find(u=>at(u));A.logEvent(B.showAutocompletePrompts,{prompt_count:t.length,prompt_type:ce.Autocomplete,titles:t.map(u=>a?u.title:""),bodies:t.map(u=>a?u.body:""),ids:t.map(u=>a?u.id:""),client_thread_id:e,message_id:o,themes:t.map(u=>u.theme??"")})}else we.addError("Unhandled suggestion type",{type:t[0].type})},Kl=t=>{const e=E.getThreadCurrentLeafId(t),s=E.getTree(t).getMessageId(e);A.logEvent(B.showExpandMoreStarterPromptsButton,{client_thread_id:t,message_id:s})},Ql=t=>{const e=E.getThreadCurrentLeafId(t),s=E.getTree(t).getMessageId(e);A.logEvent(B.expandMoreStarterPrompts,{client_thread_id:t,message_id:s})},Wc="OAI-Echo-Logs",ze={FOCUS_IN:0,FOCUS_OUT:1,COPY:2,PASTE:3,TOUCH_START:4,TOUCH_END:5},zr=[];function Ve(t){return()=>{zr.push({type:t,ts:Math.round(performance.now())})}}const $c={focusin:Ve(ze.FOCUS_IN),focusout:Ve(ze.FOCUS_OUT),copy:Ve(ze.COPY),paste:Ve(ze.PASTE),touchstart:Ve(ze.TOUCH_START),touchend:Ve(ze.TOUCH_END)};function Jl(t){const e=t??document.getElementById(Ki);for(const[s,o]of Object.entries($c))e?.removeEventListener(s,o),e?.addEventListener(s,o)}function Gc(){return{[Wc]:zr.slice(0,10).map(t=>`${t.type},${t.ts}`).join(",")}}const Hc=1e3*30,jt=Kn.getTracer("completion");class Dt extends Error{}function zc(t,e,s,o){return(async(u=null)=>{Xo()&&await Zo();const h=new AbortController,c="threadId"in e?e.threadId:void 0,g="continueFromSharedConversationId"in e?e.continueFromSharedConversationId:void 0,_=xs(),x=oe.checkGate("1987334402"),I=oe.checkGate("2964350589"),p=[x&&He.V1,I&&He.V1_TEST].filter(Boolean),y={action:e.completionType,messages:e.messages.length>0?e.messages:void 0,conversation_id:c,continue_from_shared_conversation_id:c!=null?void 0:g,parent_message_id:e.parentMessageId,model:e.model,timezone_offset_min:new Date().getTimezoneOffset(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,variant_purpose:e.completionMetadata?.variantPurpose,suggestions:e.completionMetadata?.suggestions?e.completionMetadata.suggestions.map(T=>Je(T)):void 0,chosen_suggestion:e.completionMetadata?.suggestion?{type:e.completionMetadata.suggestion.type,index:e.completionMetadata.suggestionIndex,source:e.completionMetadata?.suggestion.type===ce.Autocomplete?e.completionMetadata.suggestion.source:void 0,user_input:e.completionMetadata?.suggestion.type===ce.Autocomplete?e.completionMetadata.suggestion.userInput:void 0}:void 0,history_and_training_disabled:e.historyDisabled,juice:e.completionMetadata?.juice,conversation_mode:e.completionMetadata?.conversationMode,force_paragen:e.forceParagen,force_paragen_model_slug:e.forceParagenModel,force_indepth_feedback:e.forceIndepthFeedback,force_rate_limit:e.forceRateLimit,reset_rate_limits:e.resetRateLimits,disable_system_content_toggling:e.disableSystemContentToggling,websocket_request_id:_,source:e.completionMetadata?.source,system_hints:e.completionMetadata?.systemHints,prefetch_ids:e.completionMetadata?.prefetchIds,force_use_sse:!tn.isWebsocketConnected(),supported_encodings:p,conversation_origin:e.conversationOrigin,force_use_search:e.forceUseSearch,client_reported_search_source:e.completionMetadata?.searchSource,client_contextual_info:e.contextualInfo,paragen_stream_type_override:e.paragenStreamType==="none"?null:e.paragenStreamType,paragen_cot_summary_display_override:e.paragenCotSummaryDisplay},C=oe.checkGate("1113464293");C&&(y.supports_buffering=!0),e.turnTracker.stream_buffering=C;let b,k;const N=Hn(t);Ht(N)?(k="https://chatgpt.com/backend-anon",b=sn.getUnauthHeaders().additionalHeaders):(k="https://chatgpt.com/backend-api",b=sn.getAuthedHeadersWithAccessToken(N?.accessToken));const j=`${k}/conversation`;let R=!0,U=!0;const q=vs(e.chatReq,u??e.arkoseToken,e.turnstileToken,e.proofToken,null),$={...b,...Gc(),...q};let ne,D,L;jt.startActiveSpan("completion.response",T=>{ne=jt.startSpan("completion.first_response"),D=jt.startSpan("completion.first_token"),L=T});const re=Kn.setSpan(on.active(),L);let Y=null,X=null,P,W=!1,K=!1;function z(){K||(K=!0,s({type:"done"}),gn())}function M(T){if(e.turnTracker.onBytesReceived(T.data),T.data==="[DONE]")h.abort(),L.end(),z();else if(T.event!=="ping")try{let S=JSON.parse(T.data);if(T.event==="delta_encoding")if(S===He.V1||S===He.V1_TEST)Y=S,e.turnTracker.stream_encoding=Y??void 0,X=new ti;else{we.addError(`[completion-delta] unknown delta encoding: ${S}`);return}else if(T.event==="delta"){if(!X){we.addError("[completion-delta] delta event before delta_encoding");return}const ae=X.applyDelta(S);if(Y===He.V1_TEST){!W&&!Ss(ae,P)&&(W=!0,we.addError("[completion-delta] delta resulted in a different object",{differences:ni(ae,P)}));return}else S=ae}else Y===He.V1_TEST&&!W&&(P=S);if(S.error){const ae=ye.createWithErrorMessage(j,"server",S.error);throw s({type:"error",error:ae}),ae}else"type"in S?S.type==="gizmo_inline_review"?s({type:"gizmo_inline_review",gizmoId:S.gizmo_id}):S.type==="title_generation"?s({type:"title_generation",title:S.title,conversation_id:S.conversation_id}):S.type==="moderation"?s({type:"moderation",conversationId:S.conversation_id,messageId:S.message_id,isCompletion:S.is_completion,flagged:S.moderation_response.flagged,blocked:S.moderation_response.blocked,disclaimers:S.moderation_response.disclaimers,metadata:S.moderation_response.metadata}):S.type==="url_moderation"?s({type:"url_moderation",conversationId:S.conversation_id,messageId:S.message_id,url:S.url_moderation_result.full_url,isSafe:S.url_moderation_result.is_safe}):S.type==="num_variants_in_stream"?s({type:"num_variants_in_stream",num_variants_in_stream:S.num_variants_in_stream,display_treatment:S.display_treatment}):S.type==="conversation_detail_metadata"?s(S):S.type==="message_stream_complete"&&z():(s({type:"message",message:S.message,conversationId:S.conversation_id}),U&&(U=!1,ne.end()),R&&S.message.author.role==="assistant"&&S.message.content.content_type==="text"&&S.message.content.parts[0]!==""&&(R=!1,D.end()))}catch(S){if(S instanceof ye)throw S}}let V=null,G=setTimeout(()=>{V===!0?(A.logEvent(B.asyncResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:dt.Error,error:{reason:"timeout",message:"Async Response Took Too Long to Come Back"}})):V===!1&&(A.logEvent(B.sseResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:dt.Error,error:{reason:"timeout",message:"SSE Response Took Too Long to Come Back"}}))},Hc);return Oc(_,M,h.signal),on.with(re,()=>(e.profiler?.logTiming("fetch_event_source"),ei(j,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...$},body:JSON.stringify(y),signal:h.signal,openWhenHidden:!0,async onopen(T){const S=T.headers.get("content-type")??"",ae=T.headers.get("Cf-Ray")??null;if(T.ok&&S.includes("text/event-stream")){V=!1,o(ae,e.model,e.turnTracker);return}else if(S.includes("application/json")){const Se=await T.json(),{webSocketUrl:je,fallbackWebSocketUrl:Z,conversationId:le,responseId:fe,expiresAt:se,websocketRequestId:De}=Uc(Se);if(je!=null&&le!=null&&fe!=null&&De!=null&&se){V=!0,o(ae,e.model,e.turnTracker);try{await Lc(je,Z,se,le,fe,De,M,h.signal,G)}catch(pe){pe instanceof ye&&s({type:"error",error:pe})}throw new Dt}else{const pe=new ye(j,T.status,Se);if(pe.isServerError())throw pe;if((pe?.code==="expired_session_key"||pe?.code==="invalid_api_key"||pe?.code==="token_expired")&&typeof window<"u"&&window._oaiHandleSessionExpired?.("stream",JSON.stringify(pe)),pe?.code==="deactivated_workspace"){window.location.href.includes("/workspace/deactivated")||(window.location.href="/workspace/deactivated");return}throw pe}}else{const Se=await T.text();throw new ye(j,T.status,{detail:{message:an,code:"unexpected_content_type",contentType:S,text:Se?.substring(0,1e3)}})}},onmessage:T=>{if(V)throw ye.createWithErrorMessage(j,"server",an);G&&(clearTimeout(G),G=null),M(T)},onerror(T){let S=T instanceof Error?T:new Error(JSON.stringify(T));throw S instanceof Dt||V||(S.message==="Failed to fetch"&&(S=ye.createWithErrorMessage(j,"server",`An error occurred. Either the engine you requested does not exist or there was another issue processing your request. ${Ut}`)),S.message==="network error"&&(S=ye.createWithErrorMessage(j,"client",`A network error occurred. Please check your connection and try again. ${Ut}`)),Is("fetch-error:conversation:new-message",{url:j,message:S?.message}),s({type:"error",error:S}),gn(S)),S}}))).catch(async T=>{T instanceof Dt||(T instanceof ye?Cs(T):we.addError(T),e.turnTracker.handleRawError(T.message??"Something went wrong",T.status))}),h})()}function Vc({clientThreadId:t,continuingFromSharedConversationId:e,onCompletionFinished:s=cn,onCreate:o=cn}){const a=et(),{resolvedTheme:u}=bs(),h=u==="dark",c=v.useRef(s),g=Es();c.current=s;const _=v.useCallback(async function({model:x,completionType:I,parentNodeId:p,metadata:y,focusOnNewCompletion:C=!0,completionMetadata:b,chatReq:k,arkoseToken:N,turnstileToken:j,proofToken:R,preflightTime:U,extraStreamParams:q,appendMessages:$,updateTree:ne,turnTracker:D,profiler:L}){dr.publish({kind:"requestCompletion"});const re=E.getTree(t);E.retainThread(t);const Y=qi(),X=`${ri}${t}-${Y}`,P=`${t}-${Y}`;ne?.();const W=re.getNodeByIdOrMessageId(p),z={gizmo_id:W.message.metadata?.gizmo_id};b?.juice!=null&&(z.snorkle_status=1),E.updateTree(t,Z=>{Z.addNode(X,"",p,Ce.Assistant,void 0,z)}),C&&E.setThreadCurrentLeafId(t,X);let M,V=[],G=re.getNodeByIdOrMessageId(W.parentId);for(;G!=null&&(G.metadata?.isPlaceholderTemplateAssistantWelcomeMessage===!0||G.metadata?.isClientCreatedSystemMessage===!0);){const Z=G.message;V.unshift(Z);const le=re.getNodeByIdOrMessageId(G.parentId);M=le.message?.id??le.id,G=le}if(I===Ke.Next||I===Ke.Variant){const Z=re.getNodeByIdOrMessageId(W.parentId);if(M??=Z.message?.id??Z.id,V.push(W.message),$){let le=p;E.updateTree(t,fe=>{for(const se of $)fe.insertNodeBefore(X,{id:se.id,message:se,parentId:le,children:[]}),le=se.id}),V.push(...$)}V=Kc(V,q)}else M??=W.message.id;const ie=E.getServerThreadId(t);ie===void 0&&Xt(t)&&E.updateInitialThreadDataForNewThread(t,x);async function T(Z,le){const fe=performance.now(),se=await ks();ln.initializeAndGatherData(se),yn.initializeAndGatherData(se),un.initializeAndGatherData(se),E.updateTree(t,Re=>{for(const be of le)Re.addNode(be.id,be,Z,Ce.Assistant,{completionSampleFinishTime:Date.now()}),Z=be.id}),E.setThreadCurrentLeafId(t,Z);const De=await ln.getEnforcementToken(se),pe=await yn.getEnforcementToken(se),tt=await un.getEnforcementToken(se);_({model:x,completionType:Ke.Next,parentNodeId:Z,metadata:{},chatReq:se,arkoseToken:De??null,turnstileToken:pe??null,proofToken:tt??null,preflightTime:performance.now()-fe,extraStreamParams:q,turnTracker:D})}D.updateAttachmentCount(V);const S=new bc(a,t,X,I,x,y.eventSource,o,P,T,(...Z)=>c.current(...Z),D,g),ae=(Z,le,fe)=>{Z&&fe.onReceivedRequestId(Z),oi(P,le,Z,U)},Se={is_dark_mode:h,time_since_loaded:Math.floor(performance.now()/1e3),page_height:window?.innerHeight,page_width:window?.innerWidth,pixel_ratio:window?.devicePixelRatio,screen_height:window?.screen?.height,screen_width:window?.screen?.width},je=await zc(a,{conversationOrigin:E.getConversationOrigin(t),model:x,completionType:I,threadId:ie,continueFromSharedConversationId:e,historyDisabled:g,parentMessageId:M,messages:V,chatReq:k,arkoseToken:N??null,turnstileToken:j??null,proofToken:R??null,completionMetadata:b,...q,turnTracker:D,profiler:L,contextualInfo:Se},S.handleResponse,ae);kr(t,{source:zn.CLIENT,value:Vn.STREAMING}),Qt.addRequest(X,je,D),oa.onCompletionRequestStarted(X)},[t,a,o,e,g,h]);return _}const Kc=(t,e)=>{let s=t;return e?.forceUseSearch===!1&&t.length>0&&(s=t.map(o=>{const{system_hints:a,...u}=o.metadata||{};return{...o,metadata:{...u,system_hints:a?.filter(h=>h!==si.Search)}}})),s},Qc=gt(()=>Xe(()=>import("./sso-ei5cecann8hf7lip.js").then(t=>t.C),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51])).then(t=>t.CAFeedbackModal).catch(()=>()=>null));function Jc({clientThreadId:t,currentModelId:e,defaultModelId:s,onCompletionFinished:o,onThreadCreated:a,preRequestCompletion:u}){const h=ii(),c=vt(),{isUnauthenticated:g}=zt(),_=Wi(t),x=et(),I=Rr(t),p=ve(),y=na(t),C=Qn(),b=Gt(),{config:k}=Gn("1013114931"),N=k.get("show_follow_ups",!1)&&p?.isPersonalAccount(),j=!C.displayingSideBySideFeedback&&N,R=v.useCallback(P=>{const K=E.getTree(t).getLeafFromNode(P);E.setThreadCurrentLeafId(t,K.id)},[t]),U=ai(e),[q,$]=v.useState(),ne=v.useCallback(({nodeId:P,messageId:W,rating:K})=>{const z=E.getServerThreadId(t);A.logEvent(B.thumbRating,{id:W,threadId:z,rating:K,model:e});const M=E.getTree(t),V=M.getNodeByIdOrMessageId(P);if(z!==void 0&&!U&&Te.submitMessageFeedback({message_id:W,conversation_id:z,rating:K}),E.updateTree(t,G=>{G.updateNodeMetadata(P,{rating:K})}),U){$(d.jsx(Qc,{citations:V.message.metadata?.citations??[],rating:K,conversationId:z??"",messageId:W,onSubmit:()=>{$(void 0)},onCancel:()=>$(void 0),conversationTree:M,nodeId:P},`${P}-${K}`));return}},[t,e,U]),D=v.useCallback(P=>{if(P==null||(o?.(P),b)||(I?.kind===xe.GizmoInteraction&&ji.handleGizmoInteracted(x,I.gizmo_id),!(y||j)))return;const K=E.getThreadCurrentLeafId(P),z=E.getTree(P).getMessage(K);ci(z)||li(z)||ui(P,z.id,e)},[I,e,o,x,y,j,b]),L=Vc({clientThreadId:t,continuingFromSharedConversationId:_,onCompletionFinished:D,onCreate:a}),re=v.useCallback(()=>{const P=E.getThreadCurrentLeafId(t);if(P==null)return;const K=E.getTree(t).getBranchFromLeaf(P);Qt.abortRequests(K.map(z=>z.id))},[t]),Y=v.useCallback(P=>di({cancelRequests:re,clientThreadId:t,currentModelId:e,debugSettings:h,defaultModelId:s,isUnauthenticated:g,navigateToAuth:c,preRequestCompletion:u,requestCompletion:L,...P}),[re,t,e,h,s,g,c,u,L]),X=v.useCallback((P,W,K,z=!0,M="none",V)=>{const ie=E.getTree(t).getParentPromptNode(P).id;Y({type:Ke.Variant,promptId:ie,eventMetadata:W,cancelActiveRequests:!1,focusOnNewCompletion:z,useDefaultModel:V,completionMetadata:{variantPurpose:M,conversationMode:ft.getConversationMode(t)},turnTracker:K})},[t,Y]);return{caModal:q,onRequestCompletion:Y,onRequestMoreCompletions:X,onChangeItemInView:R,onChangeRating:ne,cancelRequests:re}}function Yc(t){return`https://chatgpt.com${Di(t)}`}function Yl(t,e,s,o){hi(Yc(t),e,s),o&&e.info(o,{testId:"copy-gizmo-url-toast"})}function Xl(t){return t.some(e=>e.type===Ts.JIT_PLUGIN)}function Xc(t){return"gizmo_id"in t?t.gizmo_id??null:null}const Zc=t=>["conversation","init",t],el=({clientThreadId:t,conversationMode:e,clientModelId:s},o)=>{const a=Xc(e),u=Xt(t)?null:t;return{gcTime:0,refetchOnWindowFocus:!0,refetchOnMount:"always",queryKey:Zc(t),queryFn:()=>Te.getConversationDetails({conversationId:u,gizmoId:a,requestedDefaultModel:s}),enabled:!fi(t)}},tl=t=>(Ln(),qt(el(t))),nl=(t,e)=>{const s=(typeof t=="string"?[t]:t)??[];for(const o of s)if(o&&e.has(o))return o;return null},rl=(t,e)=>{const s=Pi(),[o,a]=Ms(),u=o.get("model"),{modelId:h=null}=pi()??{};Qi(t);const c=$i(t)??null,g=[u,c,h],_=nl(g,s);v.useEffect(()=>{E.initThread(t,e,_),Pt.reset()},[t]);const x=()=>{a(C=>(C.delete("model"),C))},{isLoading:I,data:p}=tl({clientThreadId:t,clientModelId:g.find(C=>!!C)??null,conversationMode:e}),y=Rs();v.useEffect(()=>{if(!(!u||I)){if(!s.has(u)||y.find(C=>C.model_slug===u))return x();E.setThreadModelId(t,u)}},[u,y,s,t]),v.useEffect(()=>{if(I||!p)return;const{default_model_slug:C}=p;u&&C&&u!==C&&x(),Pt.updateDetails(p),C&&E.setThreadModelId(t,C)},[I,p])};function sl({clientThreadId:t,setClientThreadId:e}){const s=et(),o=mi(),a=o?{kind:xe.GizmoInteraction,gizmo_id:o}:{kind:xe.PrimaryAssistant};rl(t,a);const u=We(),h=Cr(t),c=v.useRef(h);c.current=h;const g=Gi(t),_=v.useCallback(()=>{e?.(As());const p=c.current;u(p.tags.includes(Bs.GPT_4)?"/":`/?model=${p.id}`,{replace:!0})},[e,u]),x=Gr({clientThreadId:t,location:"Model switcher menu item"}),I=v.useCallback(p=>{g||Sc(u,s,p)},[s,u,g]);return{createNewThread:x,onThreadCreated:I,resetThread:_}}function Vr(){return{caModal:null,clientThreadId:"",currentModelId:"",isModelLoaded:!1,isCompanionWindow:!1,conversationLeafId:"",onNewThread:()=>{throw new Error("onNewThread not implemented")},onRequestCompletion:()=>{throw new Error("onRequestCompletion not implemented")},onChangeItemInView:()=>{throw new Error("onChangeItemInView not implemented")},onChangeRating:()=>{throw new Error("onChangeRating not implemented")},onRequestMoreCompletions:()=>{throw new Error("onRequestMoreCompletions not implemented")},resetThread:()=>{throw new Error("resetThread not implemented")}}}const Kr=v.createContext(Vr());function ol(){try{return v.useContext(Kr)}catch{return Vr()}}function Zl({children:t,clientThreadId:e,setClientThreadId:s,prefetchSearch:o}){const{createNewThread:a,onThreadCreated:u,resetThread:h}=sl({clientThreadId:e,setClientThreadId:s}),c=Ui(),g=xr(e),_=Hi(e),x=c.id,I=g??x,p=Ns(),{caModal:y,onRequestCompletion:C,onChangeItemInView:b,onChangeRating:k,onRequestMoreCompletions:N}=Jc({clientThreadId:e,currentModelId:I,defaultModelId:c.id,onThreadCreated:u});return d.jsx(Kr.Provider,{value:{caModal:y,clientThreadId:e,currentModelId:I,isModelLoaded:!!g,isCompanionWindow:p,conversationLeafId:_,onNewThread:a,onRequestCompletion:C,onChangeItemInView:b,onChangeRating:k,onRequestMoreCompletions:N,resetThread:h,prefetchSearch:o},children:t})}const il=gt(()=>Xe(()=>import("./nb5pqnpjje55idwl.js"),__vite__mapDeps([52,1,2,3,13,5,6,12,11,8,53,54,33,34,35,17])));function al({showShareButton:t,showProfileDropdown:e,clientThreadId:s}){const o=zi(s),a=Me(),u=Br(s),{layer:h}=lt("1547743984"),{onNewThread:c}=ol(),g=h.get("show_share_button_text",!1),_=a.formatMessage({id:"GizmoInformation.shareChat",defaultMessage:"Share"}),x=gi(),I=()=>_e.openSharingModal(o),p=a.formatMessage({id:"TO+loE",defaultMessage:"New Chat"});return d.jsxs(d.Fragment,{children:[!1,u&&d.jsx(da,{}),!1,t&&o&&d.jsx(xn,{clientThreadId:s,children:g?d.jsx(Pe,{onClick:I,icon:Rt,label:_,"data-testid":"share-chat-button",color:"secondary",className:"text-token-text-primary",style:{display:"var(--screen-size-hidden-on-compact-mode)"},children:_}):d.jsx(ke,{label:a.formatMessage({id:"CPEfES",defaultMessage:"Share chat"}),children:d.jsx(wt,{"data-testid":"share-chat-button",onClick:()=>_e.openSharingModal(o),icon:Rt})})}),x&&t&&o&&d.jsx(xn,{clientThreadId:s,children:d.jsx(ke,{label:_,children:d.jsx(_n,{style:{display:"var(--screen-size-hidden-on-wide-mode)"},onClick:I,icon:d.jsx(Rt,{}),label:_})})}),x&&d.jsx(ke,{label:p,children:d.jsx(_n,{className:Fs.sidebarIcon,icon:d.jsx(wr,{}),onClick:()=>c(),label:p,style:{display:"var(--screen-size-hidden-on-wide-mode)"}})}),e&&d.jsx(Qr,{clientThreadId:s})]})}function cl({to:t,children:e,icon:s}){const o=We();return d.jsx(J.Item,{icon:s,onSelect:()=>o(t),children:e})}function Qr({clientThreadId:t}){const{isUnauthenticated:e}=zt();return e?d.jsx(pl,{}):d.jsx(Jr,{clientThreadId:t})}function Jr({clientThreadId:t}){const{data:e}=yt(),s=ve(),o=s?.isPlus()??!1,a=s?.isWorkspaceAccount()??!1,{openSettings:u}=yi(),h=Sr(),c=dl(t??"none"),{openModal:g}=br(),{layer:_}=lt("2888142241"),x=qn("3905879930");var I=s?.isTeam()??!1,p=!1;I&&(p=x.config.get("enabled",!1));const{doesUserHaveAnyAccountsWithPlusFeatures:y}=js(),{layer:C}=lt("2670443078");if(!s||!e)return null;const b=e.accountItems.length>1;let k=o;!a&&!o&&y&&C.get("is_gating_fix_enabled",!1)&&(k=y);const N=!a&&!k&&!$n&&_.get("is_upgrade_in_settings",!1);return d.jsxs(Ai,{triggerButton:d.jsx("button",{onClick:()=>{A.logEvent(B.accountOpenProfileMenu),oe.logEvent("chatgpt_account_open_profile_menu")},"data-testid":"profile-button",className:"flex h-10 w-10 items-center justify-center rounded-full hover:bg-token-main-surface-secondary focus-visible:bg-token-main-surface-secondary focus-visible:outline-0",style:{display:"var(--screen-size-hidden-on-compact-mode, flex)"},children:d.jsx(Kt,{iconSize:"medium"})}),children:[b&&d.jsx(Wr,{menuItemComponent:J.Item}),b?d.jsx(J.Separator,{}):null,a?d.jsx(Lr,{menuItemComponent:J.Item,routedMenuItemComponent:cl}):d.jsx(Or,{menuItemComponent:J.Item}),d.jsx(J.Item,{icon:mr,onClick:()=>u(),"data-testid":"settings-menu-item",children:d.jsx(O,{defaultMessage:"Settings",id:"navigation.settings.0"})}),d.jsx(J.Separator,{}),I&&p&&d.jsxs(d.Fragment,{children:[d.jsx(J.Item,{"data-testid":"settings-menu-item-invite-teammates",onClick:()=>{_e.openModal(qe.InviteUsersToWorkspace),A.logEvent(B.accountMemberInviteButton,{eventSource:"mouse",location:"profile_drop_down"}),oe.logEvent("chatgpt_invite_users_to_workspace",0,{action:"OpenAdminInviteModal",location:"dropdown-menu-click",text:"AddTeammates",step:"OpenModal"})},icon:gr,children:d.jsx(O,{...Zr.addTeammatesButton})}),d.jsx(il,{workspace:s})]}),h&&d.jsx(ul,{openDownloadModal:g}),N&&d.jsx(fl,{}),c&&d.jsx(hl,{}),(N||h||c)&&d.jsx(J.Separator,{}),d.jsx(J.Item,{onClick:()=>{A.logEvent(B.clickLogOut,{eventSource:"mouse"}),A.logLogOutButtonClicked({location:"profile_drop_down"}),Wn()},"data-testid":"log-out-menu-item",icon:yr,children:d.jsx(O,{defaultMessage:"Log out",id:"navigation.logOut.0"})})]})}function Yr({onClick:t,className:e,testId:s}){const o=Me(),a=Gt(),u=a?o.formatMessage({id:"yqd/J5",defaultMessage:"Clear chat"}):o.formatMessage({id:"OFyxqj",defaultMessage:"New chat"});return d.jsx(ke,{sideOffset:4,label:u,className:mt("flex",e),children:d.jsx(wt,{onClick:()=>{_e.closePopoverNavSidebar(),t()},icon:a?ki:wr,surfaceContext:"secondary","aria-label":u,"data-testid":s})})}function ll({clientThreadId:t}){const[e]=Tr(a=>[a.activeStageSidebar]),s=Mr(),o=Gr({clientThreadId:t,location:"Navigation actions"});return!s&&!e?null:d.jsxs("div",{className:"flex items-center",children:[d.jsx(Xr,{}),d.jsx(Yr,{onClick:o})]})}function ul({openDownloadModal:t}){return d.jsx("span",{children:d.jsx(J.Item,{icon:_r,onClick:()=>{t(),A.logEvent(B.accountMenuClickDownloadApp)},children:d.jsx(O,{id:"navigation.downloadMacApp",defaultMessage:"Download the macOS app"})})})}const dl=t=>{const{value:e}=Wt("2634628831"),s=Pn(()=>document.documentElement.dataset.searchExtension==="1"),o=vr(t,Un.Search);return!s&&o&&Yn()&&e},hl=()=>d.jsx("span",{children:d.jsx(J.Item,{icon:Ti,onClick:()=>{window.open(jr),A.logEventWithStatsig(B.chatgptBrowserExtensionUserMenuClicked,"chatgpt_browser_extension_user_menu_clicked")},children:d.jsx(O,{id:"E5VPz/",defaultMessage:"Get ChatGPT search extension"})})});function fl(){const t=We(),s=ve()?.wasPaidCustomer()??!1,o=()=>{oe.logEvent("chatgpt_plus_upgrade_in_settings_menu_clicked"),A.logEvent(B.plusUpgradeInSettingsMenuClicked),Vt(t,"Upper right settings menu")};return d.jsx(J.Item,{icon:Mi,onClick:o,children:s?d.jsx(O,{id:"navigation.renewPlus",defaultMessage:"Renew Plus"}):d.jsx(O,{id:"navigation.upgradePlan",defaultMessage:"Upgrade Plan"})})}function Xr(){const t=Me(),[e]=Tr(u=>[u.activeStageSidebar]),s=Mr(),o=cr(),{isUnauthenticated:a}=zt();return!e&&!s||!o||a?null:d.jsx(ke,{label:t.formatMessage({id:"cElEQV",defaultMessage:"Open sidebar"}),className:"flex",children:d.jsx(wt,{"aria-label":t.formatMessage({id:"pV/Etp",defaultMessage:"Open sidebar"}),onClick:_e.toggleNavSidebar,icon:Ri,surfaceContext:"primary"})})}function pl(){const t=vt(),e=_i(),s=ur(Zr.signUpCta),{layer:o}=lt("3637408529"),a=o.get("is_desktop_primary_auth_button_on_right",!1),u=()=>{t({authType:"login",callback:x=>{A.logLogInButtonClicked({location:"Chat header",provider:x})}})},h=()=>{t({authType:"signup",callback:x=>{A.logSignUpButtonClicked({location:"Chat header",provider:x})}})},c=d.jsx(Pe,{onClick:u,color:e?"primary":"secondary",size:"small","data-testid":"login-button",children:d.jsx(O,{id:"B1SN7b",defaultMessage:"Log in"})},"login"),g=d.jsx(Pe,{color:e?"secondary":"primary",onClick:h,size:"small","data-testid":"signup-button",children:d.jsx(O,{...s})},"signup"),_=e?[c,g]:[g,c];return d.jsx("div",{className:"flex items-center justify-center gap-2",children:a?_.reverse():_})}const Zr=$t({signUpCta:{id:"P6cySK",defaultMessage:"Sign up"},addTeammatesButton:{id:"inviteMemberButton.inviteMemberButton",defaultMessage:"Add Teammates"}}),eu=Object.freeze(Object.defineProperty({__proto__:null,ConversationHeaderButtons:al,ExpandDesktopSidebarButton:Xr,LoginOrProfileMenu:Qr,NavigationActions:ll,NewChatAction:Yr,ProfileDropdown:Jr},Symbol.toStringTag,{value:"Module"}));export{al as $,Ml as A,Zi as B,Kr as C,Ol as D,Xr as E,tn as F,Tn as G,kl as H,Vc as I,El as J,Yl as K,Qr as L,ja as M,$l as N,Yc as O,dc as P,Ul as Q,Fa as R,na as S,Jl as T,ql as U,Hr as V,qc as W,Pl as X,Kl as Y,Ql as Z,Ji as _,Gl as a,ll as a0,Xl as a1,Jc as a2,Nl as a3,Bl as a4,Tl as a5,Rl as a6,eu as a7,Na as b,Jr as c,Fl as d,Al as e,ol as f,Dl as g,xc as h,Ic as i,Zl as j,Br as k,Wl as l,Yr as m,Je as n,Vl as o,Ct as p,Sc as q,Ll as r,sl as s,zl as t,rl as u,Yi as v,oa as w,Ra as x,Aa as y,jl as z};
//# sourceMappingURL=ncdxtihmnz7uzs2q.js.map
