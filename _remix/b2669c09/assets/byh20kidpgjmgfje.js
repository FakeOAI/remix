import{af as O,j as k,r as v,y as z,c as q,ee as B,e as G,a4 as I,C as E,R as C,l as H,dJ as j,ef as W,eg as V,eh as X}from"./ggdh7pjp5xcwrnsg.js";import{co as $,cp as Q,cq as K,cr as Y,L as S,M,f as _,cs as J,ct as Z,cu as p,cv as ee,cw as re,cx as b,b as w,H as te,cy as se,cz as ne,ac as ae,bB as oe,cA as de,cB as ue,cC as N,cD as ie,cE as le,cF as ce,cG as he}from"./bmls73y1gwdy9wkg.js";import{m as Te}from"./jp106jrxp4bfcof8.js";function ke(){const{imageResults:e}=me();K([...e.map(r=>F(r))])}const ge=$((...e)=>Q(...e),5e3);function me(e=!1){const r=Y(["image_results","image_try_hard_status","execution_status"]),t=S(M.threadId),s=_(r.toReversed().flatMap(c=>c.image_results?.entries)).map(c=>({...c,thumbnail_url:c.thumbnail_url.replace(/^http:\/\//,"https://"),content_url:c.content_url.replace(/^http:\/\//,"https://")})),n=S(M.hasModelResponseText),o=r.some(c=>J(c));let u=s.length===0&&!n;return t!=null&&e&&!u&&s.length===0&&r[0]?.image_try_hard_status==="not_attempted"&&(ge(t,0),u=!0),e&&r[0]?.image_try_hard_status==="in_progress"&&(u=!0),{imageResults:s,isLoading:u,isErrored:s.length===0&&o}}function ze(){const e=Z(),r=S(M.hasTurnError),t=S(M.hasModelResponseText),s=x(e);return{imageResults:s,isLoading:s.length===0&&!t,isErrored:s.length===0&&r}}function x(e){return _(e.flatMap(r=>r.type==="image_v2"?r.images:[]))}function ve(e,r){const t={};return r?e.forEach(s=>{s.type==="grouped_webpages_v2"&&s.items.forEach(n=>{n.url&&!t[n.url]&&(t[n.url]=n)})}):e.forEach(s=>{s.type==="webpage"||s.type==="webpage_extended"?s.url&&!t[s.url]&&(t[s.url]=s):s.type==="grouped_webpages"&&s.items.forEach(n=>{n.url&&!t[n.url]&&(t[n.url]=n)})}),Object.values(t)}function Ie(e){return O({queryKey:["downloadImage",{imageUrl:e}],queryFn:()=>new Promise((r,t)=>{const s=new Image;s.onload=()=>{r({width:s.width,height:s.height})},s.onerror=()=>{t()},s.src=e}),enabled:e!=null})}function qe(e){return k(Ie(e))}const U={width:474,square:!0};function F(e,r=U){if(e==null)return;const t=new URL(e.thumbnail_url);if(t.hostname.indexOf(".bing.")===-1)return e.thumbnail_url;const s=Math.min(r.width,e.content_size.width),n=r.height??Math.floor(s*e.content_size.height/e.content_size.width);if(t.searchParams.delete("pid"),r.square){const o=Math.min(s,n);t.searchParams.set("w",o.toString()),t.searchParams.set("h",o.toString())}else t.searchParams.set("w",s.toString()),t.searchParams.set("h",n.toString());return t.searchParams.set("c","7"),t.toString()}function Be(e,r=U){return v.useMemo(()=>F(e,r),[e,r])}const fe={type:"spring",stiffness:700,damping:82};function Ge({children:e,className:r}){return z.jsx(Te.div,{animate:{opacity:1},initial:{width:"100%",height:"100%",translateX:0,translateY:0,opacity:0},whileHover:{width:"103%",height:"103%",translateX:"-1.5%",translateY:"-1.5%"},transition:fe,className:r,children:e})}function A(e,r,t){if(t)return t;const s=e[r];return s?.message?.metadata?.model_slug?s.message.metadata.model_slug:s?.parentId?A(e,s.parentId):null}let pe=0;function He(){return pe++}function L(e){return e.startsWith(B)}const Ce=()=>new p,_e=()=>Object.freeze({lastModelUsed:null,createTime:new Date});var Se=(e=>(e.NewChat="NewChat",e.Server="Server",e.User="User",e.Generated="Generated",e.Unknown="Unknown",e))(Se||{});const R={},i=q(G(()=>({threads:{},clientNewThreadIdToServerIdMapping:{},threadRetainCounts:{}}))),d=i.getState,h=i.setState,l={resolveThreadId:(e,r=d())=>r.clientNewThreadIdToServerIdMapping[e]??e,getThread:(e,r=d())=>{const t=l.resolveThreadId(e,r);return r.threads[t]??null},hasThread:(e,r=d())=>{const t=l.resolveThreadId(e,r);return r.threads[t]!=null},isLoading:(e,r=d())=>{const t=l.resolveThreadId(e,r);return r.threads[t]?.isLoading},getConversationMode:(e,r=d())=>{const t=l.resolveThreadId(e,r);return r.threads[t]?.mode},getThreadModelId:(e,r=d())=>l.getThread(e,r)?.modelId??null,getGizmoId(e,r=d()){const t=r.threads[l.resolveThreadId(e,r)];if(t?.mode.kind===I.GizmoInteraction||t?.mode.kind===I.GizmoTest)return t.mode.gizmo_id},getThreadTitleSource(e,r=d()){const t=l.resolveThreadId(e,r),s=r.threads[t];return s!=null?s.titleSource:"Unknown"},getThreadCreateTime(e,r=d()){const t=l.resolveThreadId(e,r);return r.threads[t]?.initialThreadData?.createTime},getCurrentNode(e,r=d()){const t=l.resolveThreadId(e,r),s=r.threads[t]?.currentLeafId??"root";return a.getTree(e).getNodeByIdOrMessageId(s)},isThreadUrlSafe(e,r,t=d()){const s=l.resolveThreadId(e,t);return t.threads[s]?.safeUrls.includes(r)??!1},getRatingPrompt(e,r=d()){const t=l.resolveThreadId(e,r);return r.threads[t]?.promptGptRating},getTurnContentReferences(e,r,t=d()){const s=l.getThread(e,t)?.conversationTurns[r]?.messages;return s?_(s.flatMap(n=>Ae(n.message))):[]},getTurnSearchResults(e,r,t=d()){const s=l.getThread(e,t)?.conversationTurns[r]?.messages;return s?_(s.flatMap(n=>Fe(n.message))):[]},getTurnImageSearchResults(e,r,t=d()){const s=l.getThread(e,t)?.conversationTurns[r]?.messages;return s?_(s.flatMap(n=>Ue(n.message))).map(n=>({...n,thumbnail_url:n.thumbnail_url.replace(/^http:\/\//,"https://"),content_url:n.content_url.replace(/^http:\/\//,"https://")})):[]},getIsArchived(e,r=d()){return l.getThread(e,r)?.initialThreadData?.isArchived??!1},getUpdateTime(e,r=d()){const t=l.getThread(e,r);if(t?.update_time)return t?.update_time;const s=t?.initialThreadData.createTime;return s?s.getTime()/1e3:null}},a={initThread:(e,r,t=null)=>{const s=a.resolveThreadId(e);if(d().threads[s]==null){const n=ue();h(o=>{o.threads[s]={initialThreadData:n,mode:r,modelId:t,tree:new p(p.createTree()),title:null,titleSource:"NewChat",currentLeafId:"root",conversationTurns:[],safeUrls:[],isLoading:!L(s),docsReferencedByURL:{},conversationOrigin:null}})}},setThreadModelId:(e,r)=>{const t=a.resolveThreadId(e);h(s=>{const n=s.threads[t];n!=null&&!n.lockModel&&(n.modelId=r)})},updateConversationMode:(e,r)=>{const t=a.resolveThreadId(e);h(s=>{const n=s.threads[t];n!=null&&(n.mode=r)})},getServerThreadId:e=>L(e)?d().clientNewThreadIdToServerIdMapping[e]:e,setServerIdForNewThread:(e,r)=>{d().clientNewThreadIdToServerIdMapping[e]===void 0&&h(t=>{t.threads[r]=t.threads[e],delete t.threads[e],t.clientNewThreadIdToServerIdMapping[e]=r})},lockThreadModel:e=>{const r=a.resolveThreadId(e);h(t=>{const s=t.threads[r];s&&(s.lockModel=!0)})},initThreadFromServerData:(e,r,t=!1,s=void 0,n=!1)=>{const o=a.resolveThreadId(e);if(!n&&(d().threads[o]==null&&!t||d().threads[o]?.isLoading===!1))return;const u=ee(r),c=u.mapping??p.createTree(),T={lastModelUsed:A(u.mapping,u.initialCurrentLeafId,r.default_model_slug),createTime:"create_time"in r?new Date(r.create_time*1e3):void 0,isArchived:r.is_archived??!1},m=new p(c),g=u.initialCurrentLeafId??u.rootId??"root",f="has_user_editable_context"in r?{hasUserEditableContextFlag:r.has_user_editable_context,authorName:r.author_name,model:"model"in r&&r.model!=null?re(r.model):void 0}:void 0;h(y=>{const P=y.threads[o];y.threads[o]={modelId:P?.modelId??null,initialThreadData:T,mode:r.gizmo_id!=null?{kind:I.GizmoInteraction,gizmo_id:r.gizmo_id}:{kind:I.PrimaryAssistant,plugin_ids:r.plugin_ids},sharedConversationMetadata:f,title:r.title??null,titleSource:"Server",tree:m,currentLeafId:g,isLoading:!1,continuingFromSharedConversationId:s,safeUrls:r.safe_urls??[],conversationTurns:[],docsReferencedByURL:{},conversationOrigin:r.conversation_origin??null,async_status:r.async_status??null,update_time:r.update_time??null}}),b.publish({kind:"createConversation",clientThreadId:e}),a.recomputeConversationTurnsForCurrentLeafId(o,[])},updateInitialThreadDataForNewThread:(e,r)=>{const t=a.resolveThreadId(e);h(s=>{const n=s.threads[t];n!=null&&(n.initialThreadData.lastModelUsed=r)})},getThreadCurrentLeafId:e=>{const r=a.resolveThreadId(e);return d().threads[r]?.currentLeafId??"root"},getThreadSafeUrls:e=>{const r=a.resolveThreadId(e);return d().threads[r]?.safeUrls},addThreadSafeUrl:(e,r)=>{const t=a.resolveThreadId(e);t&&h(s=>{const n=s.threads[t];n?.safeUrls.push(r)})},setThreadCurrentLeafId:(e,r)=>{const t=a.resolveThreadId(e);d().threads[t]!=null&&h(n=>{const o=n.threads[t];if(o==null)return;o.currentLeafId=r;const u=a.computeThreadConversationTurns(t,o.currentLeafId,o.conversationTurns);o.conversationTurns=u})},disableConversationNavigation:e=>{const r=a.resolveThreadId(e);h(t=>{const s=t.threads[r];s&&(s.disableConversationNavigation=!0)})},setTitle:(e,r,t)=>{const s=a.resolveThreadId(e);h(n=>{const o=n.threads[s];o&&(o.title=r,o.titleSource=t)}),b.publish({kind:"updateThreadTitle",conversationId:s})},getTitle:e=>{const r=l.resolveThreadId(e);return d().threads[r]?.title??void 0},getTitleAndSource:e=>({title:a.getTitle(e),titleSource:l.getThreadTitleSource(e)}),getConversationOrigin:e=>{const r=l.resolveThreadId(e);return d().threads[r]?.conversationOrigin??null},setConversationOrigin:(e,r)=>{const t=a.resolveThreadId(e);h(s=>{const n=s.threads[t];n&&(n.conversationOrigin=r)})},deleteNodesByFilter:(e,r)=>{const t=a.getThreadCurrentLeafId(e);a.updateTree(e,s=>{s.deleteNodesByFilter(r).includes(t)&&a.setThreadCurrentLeafId(e,"root")})},updateTree:(e,r)=>{const t=a.resolveThreadId(e);if(!(d().threads[t]!=null)){console.warn("Thread does not exist, cannot update tree: ",t);return}const n=a.getTree(e);r(n);const u=d().threads[t]?.conversationTurns??[];a.recomputeConversationTurnsForCurrentLeafId(t,u)},getTree:e=>{const r=a.resolveThreadId(e);return d().threads[r]?.tree??Ce()},resolveThreadId:e=>l.resolveThreadId(e),recomputeConversationTurnsForCurrentLeafId:(e,r)=>{const t=a.resolveThreadId(e);h(s=>{const n=s.threads[t];if(n==null)return;const o=a.computeThreadConversationTurns(t,n.currentLeafId,r);n.conversationTurns=o})},computeThreadConversationTurns:(e,r,t)=>{const s=a.resolveThreadId(e);return a.getTree(s).getConversationTurns(r).map((c,T)=>{const m=t?.[T];return E(m,c)?m:c})},getThreadConversationTurns:(e,r,t)=>{const s=a.resolveThreadId(e),o=d().threads[s];if(o==null)return[];const u=o.tree,c=u.messageIdToNodeId(o?.currentLeafId??"root"),T=r!=null?u.messageIdToNodeId(r):null;return T!=null&&T!==c?a.computeThreadConversationTurns(s,T,t??[]):d().threads[s]?.conversationTurns??[]},removeContinuingFromSharedConversationId:e=>{const r=a.resolveThreadId(e);h(t=>{const s=t.threads[r];s?.continuingFromSharedConversationId!=null&&delete s.continuingFromSharedConversationId})},updateReferencedDocState:(e,r,t)=>{const s=a.resolveThreadId(e);h(n=>{const o=n.threads[s];o&&(o.docsReferencedByURL[r]=t)})},copyLastMessageToClipboard:(e,r,t,s="mouse")=>{const n=a.getThreadCurrentLeafId(e),o=a.getThreadConversationTurns(e,n);return a.copyMessageToClipboard(e,o.length-1,r,t,s)},copyMessageToClipboard:(e,r,t,s,n="mouse")=>{const o=a.getThreadCurrentLeafId(e),c=a.getThreadConversationTurns(e,o)[r];if(!c)return Promise.reject();const{messages:T}=c,m=T.reduce((g,f)=>!f.err&&f.message.author.role===C.Assistant&&f.message.recipient==="all"?g+(g?`

`:"")+w(f.message):g,"");return te(m,t,s).then(()=>{const g=a.getServerThreadId(e);g&&H.submitImplicitMessageFeedback({messageId:T[0].message.id,type:"copy",serverThreadId:g,selectedText:m,source:n,location:"message"})})},getLastMessgageSystemHints:(e,r)=>{const t=a.resolveThreadId(e);return a.getTree(t).getBranchFromLeaf(r).slice().reverse().find(u=>u.message.author.role===C.User)?.message.metadata?.system_hints??[]},deleteThread:e=>{h(r=>{delete r.threads[e],delete r.clientNewThreadIdToServerIdMapping[e]})},retainThread:e=>{h(r=>{r.threadRetainCounts[e]=(r.threadRetainCounts[e]??0)+1}),clearTimeout(R[e])},releaseThread:e=>{d().threads[e]!=null&&(h(t=>{t.threadRetainCounts[e]=Math.max((t.threadRetainCounts[e]??0)-1,0)}),!(d().threadRetainCounts[e]>0)&&(clearTimeout(R[e]),R[e]=setTimeout(()=>{d().threads[e]!=null&&(d().threadRetainCounts[e]>0||a.deleteThread(e))},3e4)))},setPromptGptRating:(e,r)=>{const t=a.resolveThreadId(e);h(s=>{const n=s.threads[t];n!=null&&(r==null?n.promptGptRating=void 0:n.promptGptRating={gizmoId:r})})}},Me=e=>i(r=>l.getThreadModelId(e,r)),je=e=>Me(e)??ie,We=e=>i(r=>{const t=a.resolveThreadId(e);return!!(r.threads[t]?.disableConversationNavigation??!1)}),Re=e=>i(r=>{if(e!=null)return L(e)?r.clientNewThreadIdToServerIdMapping[e]:e}),Ve=e=>i(r=>{const t=a.resolveThreadId(e);return r.threads[t]?.initialThreadData??_e()}),Xe=(e,r)=>i(t=>{const s=l.getConversationMode(e,t);return r&&(s?.kind===I.GizmoInteraction||s?.kind===I.PrimaryAssistant)?{gizmo_id:r,kind:I.GizmoInteraction}:s}),$e=e=>{const r=se();return i(t=>t.threads[l.resolveThreadId(e,t)]==null?r:l.getGizmoId(e,t))},Qe=e=>i(r=>{const t=a.resolveThreadId(e);return r.threads[t]?.isLoading??!1}),D=e=>i(()=>a.getThreadCurrentLeafId(e)),Ke=(e,r)=>{const t=v.useRef([]);return i(()=>{const s=a.getThreadConversationTurns(e,r,t.current);return t.current=s,s?.length??0})},Ye=(e,r)=>{const t=v.useRef([]);return i(()=>{const s=a.getThreadConversationTurns(e,r,t.current);return t.current=s,s})},Je=(e,r,t)=>{const s=v.useRef([]);return i(()=>{const n=a.getThreadConversationTurns(e,t,s.current);return s.current=n,r>=0&&r<n.length?n[r]:null})},Ze=(e,r)=>{const t=v.useRef([]);return i(()=>{if(r==null)return null;const s=a.getThreadConversationTurns(e,r,t.current);return t.current=s,s.length>0?s[s.length-1]:null})},er=(e,r)=>{const t=v.useRef([]);return i(()=>{const s=a.getThreadConversationTurns(e,r,t.current);t.current=s;let n=0;for(let o=s.length-1;o>=0;o--){const u=s[o];if(u.messages.some(c=>c.message.metadata?.is_indepth_feedback))return!0;if(u.messages.some(c=>c.message.author.role===C.Assistant)&&n++,n>=3)break}return!1})},rr=(e,r)=>i(()=>{const t=a.resolveThreadId(e);return a.getTree(t).getBranchFromLeaf(r).some(o=>o.message.author.role===C.User)}),Le=e=>{const r=D(e);return v.useMemo(()=>{const t=s=>{const n=a.getThreadConversationTurns(e,s,[]),o=n?.length??0,u=n?.[o-1]??null;if(o===0)return s;const c=p.getRequestIdFromConversationTurn(u);if(c.startsWith(le))return c;if(u.variantIds?.length>1){const T=u.messages.map(g=>g.nodeId).find(g=>u.variantIds.indexOf(g)!==-1);if(T==null)return c;const m=(u?.variantIds?.indexOf(T)??0)-1;if(m>=0)return t(u?.variantIds[m])}return c};return t(r)},[r,e])},tr=e=>i(()=>a.getTitle(e)),sr=e=>V(i,()=>a.getTitleAndSource(e),E),nr=e=>i(()=>{const r=a.resolveThreadId(e);return d().threads[r]?.continuingFromSharedConversationId}),ar=e=>i(()=>{const r=a.resolveThreadId(e);return d().threads[r]?.sharedConversationMetadata?.authorName}),or=(e,r)=>i(()=>{const t=a.getTree(e).getNodeByIdOrMessageId(r);if(t==null)throw new Error(`useThreadTreeNode: cannot get tree node for ${r} in thread ${e}`);return t}),dr=(e,r)=>i(()=>a.getTree(e)?.getHasErrorFromNode(r)??!1),ur=(e,r)=>i(()=>a.getTree(e)?.isMessageIncomplete(r)??!1),ye=(e,r)=>i(()=>{const t=a.getTree(e);return t==null?[]:t.getBranchFromLeaf(r).filter(s=>s.message.author.role!==C.Root)}),ir=(e,r)=>ye(e,r).map(t=>t.message),lr=(e,r)=>i(()=>{const t=a.getTree(e);return t==null||r==null?null:t.getLeafFromNode(r)}),cr=(e,r)=>i(()=>{const t=a.getTree(e);return t==null?!1:r.map(n=>t.getLeafFromNode(n)).some(n=>t.getHasErrorFromNode(n.id))}),be=e=>{const t=a.getTree(e).getUserContext();if(t==null)return null;const{message:s}=t,n=s.metadata?.shared_conversation_id??null;if(s.metadata?.user_context_message_data!=null){const{about_user_message:o,about_model_message:u}=s.metadata.user_context_message_data;return{aboutUserMessage:o?.trim()??"",aboutModelMessage:u?.trim()??"",fallback:null,shareId:n}}return{aboutUserMessage:null,aboutModelMessage:null,fallback:w(s),shareId:n}},Ne=e=>i(r=>{const t=a.resolveThreadId(e);return r.threads[t]?.sharedConversationMetadata?.hasUserEditableContextFlag}),hr=e=>!!a.getTree(e).findNode(t=>t.message.content.content_type==="model_editable_context"),Tr=e=>!!a.getTree(e).findNode(t=>(t.message.author.name?.startsWith(`${N}.`)||t.message.recipient?.startsWith(`${N}.`))??!1),gr=e=>{const r=Ne(e);return be(e)!=null||!!r},mr=e=>i(()=>{const r=a.resolveThreadId(e);return d().threads[r]?.continuingFromSharedConversationId!=null}),vr=e=>i(()=>a.getThreadCurrentLeafId(e)==="root"),Ir=e=>{const{conversationId:r}=j(),t=Re(e);return t?r===t:!1},fr=e=>i(()=>{const r=a.resolveThreadId(e);return d().threads[r]?.promptGptRating}),pr=(e,r)=>i(()=>{const t=a.resolveThreadId(e),n=a.getTree(t).getBranchFromLeaf(r);return he(n,o=>o.message.author.role===C.System&&o.message.content.content_type==="system_content")}),Cr=()=>v.useContext(ne)!=null,_r=()=>v.useContext(ae)!=null;function Sr(e){const r=a.getTree(e),t=a.getThreadCurrentLeafId(e);let s=r.getNodeByIdOrMessageId(t);for(;s;){const n=s.message.metadata?.default_model_slug;if(n)return n;if(s.parentId)s=r.getNodeByIdOrMessageId(s.parentId);else return}}function Mr({clientThreadId:e,role:r}){return a.getTree(e).countMessagesByAuthor(r)}function Rr({clientThreadId:e}){const r=D(e),t=Le(e),n=xe(e)===W.STREAMING,o=Ee({clientThreadId:e,conversationLeafId:r});return(ce(t)||n)&&!o}function Ee({clientThreadId:e,conversationLeafId:r}){const t=a.getTree(e);return v.useMemo(()=>t.getNodeByIdOrMessageId(r).message.end_turn,[r,t])}function we(e,r){const t=l.getTurnContentReferences(e,r);return x(t)}function Lr(e,r){const t=we(e,r),s=l.getTurnImageSearchResults(e,r);return oe(t.concat(s),"content_url")}const xe=e=>i(()=>{const r=a.resolveThreadId(e);return d().threads[r]?.async_status}),yr=(e,r)=>{const t=de();return i(()=>{const s=l.getTurnContentReferences(e,r);return ve(s,t)})},br=(e,r)=>i(()=>l.getTurnSearchResults(e,r)),Ue=e=>e?.metadata?.image_results??[],Fe=e=>e?.metadata?.search_result_groups??[];function Nr(e){return a.getConversationOrigin(e)===X.APPLE}const Ae=e=>e?.metadata?.content_references??[];export{lr as $,ye as A,sr as B,Se as C,Ze as D,Ee as E,je as F,tr as G,ar as H,Ie as I,ke as J,Ue as K,Fe as L,He as M,nr as N,Sr as O,We as P,fr as Q,Mr as R,xe as S,a as T,Rr as U,dr as V,ur as W,mr as X,Ae as Y,ve as Z,Tr as _,i as a,Je as a0,pr as a1,er as a2,cr as a3,Nr as a4,Ve as a5,Me as a6,Be as a7,Ge as a8,fe as a9,l as b,Cr as c,Re as d,me as e,ze as f,Lr as g,qe as h,D as i,Ke as j,rr as k,L as l,_r as m,$e as n,Xe as o,Ye as p,Le as q,or as r,gr as s,hr as t,vr as u,Qe as v,Ir as w,yr as x,br as y,ir as z};
//# sourceMappingURL=byh20kidpgjmgfje.js.map
