import{l as e,be as S,Z as u,aH as F,a0 as J,a8 as ie,V as ne,r as D,a1 as re,M as W,R as C,v as oe,ed as le,dj as de,W as me}from"./bkk1etpxp73xgxkk.js";import{ak as ce,di as ue,g as ge,dj as b,dk as fe,c4 as pe,V as q}from"./grdjxd4t00xxfgii.js";import{ab as L,q as xe,C as ye}from"./ho6syd1yt6mfjuy1.js";import{g as je,b as he}from"./go6iqv7kynl41ls2.js";import{T as A,a as _e,e as ve,c as Me,n as we}from"./e2lvmkzz1krdd0vf.js";import{a as P,T as Pe,i as Se}from"./ky3hwvkezt2frybr.js";import"./on8dwna7kjymzk0v.js";import"./okhdof47k0vuhmqv.js";import"./gteko0382k8ggpbf.js";import"./nuovggdyf0grhuwv.js";import"./d1ew373qviaqzay3.js";import"./c7q13bl1gi8tl4t7.js";import"./noj1s37nphyqi49g.js";import"./icc79zmdj63m59x2.js";import"./i3sou16n7aet43d5.js";import"./brhx5v2rxlq0rxdf.js";import"./cvlbu2zjl8gk4d4y.js";import"./kef7p4k14zdf1y4l.js";function Te({action:t,handleUserAction:s,userActionParams:i,displayParams:r}){return t.type==="deny"?e.jsx(S,{color:"secondary",size:"small",onClick:()=>{s({...i,actionData:{type:"deny",...t.deny}})},children:e.jsx(u,{...t.name==="decline"?h.decline:h.deny})}):t.type==="allow"?e.jsx(S,{color:"primary",size:"small",onClick:()=>{s({...i,actionData:{type:"allow",...t.allow}})},children:e.jsx(u,{...t.name==="allow"?h.allow:h.confirm})}):t.type==="always_allow"?e.jsx(S,{color:"secondary",size:"small",onClick:async()=>{s({...i,actionData:{type:"always_allow",...t.always_allow}})},children:e.jsx(u,{...h.alwaysAllow})}):t.type==="oauth_redirect"?e.jsx(S,{color:"primary",size:"small",onClick:()=>{Ne(t.oauth_redirect,i.clientThreadId,i.turnGizmo)},children:e.jsx(u,{...h.signInButton,values:{domain:r.domain}})}):t.type==="contact_gizmo"?e.jsx(S,{color:"secondary",size:"small",onClick:async()=>{s({...i,actionData:{type:"contact_gizmo",...t.contact_gizmo}})},children:e.jsx(u,{...h.allow})}):null}async function Ne(t,s,i){const r=A.getServerThreadId(s),a=_e.getConversationMode(s)?.kind===F.GizmoTest,n=r&&!a?je(r,i):window.location.href;ce.doOAuthRedirect(t.gizmo_id,t.gizmo_action_id,t.domain,n,a)}const h=J({alwaysAllow:{id:"jitPluginMessage.alwaysAllow",defaultMessage:"Always Allow"},allow:{id:"jitPluginMessage.allow",defaultMessage:"Allow"},decline:{id:"jitPluginMessage.decline",defaultMessage:"Decline"},confirm:{id:"jitPluginMessage.confirm",defaultMessage:"Confirm"},deny:{id:"jitPluginMessage.deny",defaultMessage:"Deny"},signInButton:{id:"jitPluginMessage.signInButton",defaultMessage:"Sign in with {domain}"}}),T="openaiFileIdRefs";function et({messages:t,clientThreadId:s,isLastTurnInConversation:i,onRequestCompletion:r}){const a=ie(),[n,...l]=t,d=ne(),o=ve(),c=Me(s),j=n.message.metadata?.gizmo_id??c,g=we(s,j),H=ue(g)&&g.gizmo_id===j,_=he(j,H)?.data,[K,Q]=D.useState(!1),O=ge(n.message.recipient);let k;if(O?.functionName!=null&&_?.tools!=null){for(const m of _.tools)if(Ie(m,O.functionName)){k=m;break}}const U=l.filter(m=>m.message.metadata?.jit_plugin_data?.from_server?.type==="debug"),Y=l.filter(m=>!["debug","send_test"].some(y=>y===m.message.metadata?.jit_plugin_data?.from_server?.type)),{uiState:x,jitPluginData:f,fileAttachments:Z}=ze(n,Y,i),v=f?.from_server?.type!=="denied_by_user"?f?.from_server?.body.domain:k?.metadata?.domain,R=k?.metadata?.privacy_policy_url;if(D.useEffect(()=>{if(g?.kind===F.GizmoInteraction&&$(f?.from_client)?.type!=="oauth_success"&&f?.from_server?.type==="oauth_required"&&a.query.oauth_success){const{oauth_success:m,...y}=a.query;if(m){for(const G of f.from_server.body.actions)if(G.type==="oauth_redirect"){B({assistantMessage:n,allMessages:t,clientThreadId:s,onRequestCompletion:r,actionData:{type:"oauth_success",target_message_id:G.oauth_redirect.target_message_id},conversationMode:g});return}a.replace({pathname:a.pathname,query:y})}}},[g,a,n,t,s,r,f,i]),!_)return null;let M=P.Running,w=v?p.running:p.starting,z={domain:v},N=null;if(x===7)return null;if(x===4||x===5){M=P.Paused,w=p.confirmingSimple;const m={gizmoName:_.gizmo.display.name,domain:v};N=d.formatMessage(p.confirmParamsTitle,m),z={...m,title:y=>e.jsxs("div",{className:"inline-flex items-center gap-1 text-sm",children:[y,e.jsx(L,{className:"icon-sm"})]}),subtitle:y=>e.jsx("div",{className:"text-xs",children:y})}}else x===1?(M=P.Finished,w=p.finished,N=d.formatMessage(p.sentParamsTitle,{gizmoName:_.gizmo.display.name,domain:v}),z={domain:v}):x===2?(M=P.Error,w=p.error):(x===3||x===6)&&(M=P.Stopped,w=x===6?p.declined:p.stopped);const X={assistantMessage:n,allMessages:t,clientThreadId:s,turnGizmo:_,onRequestCompletion:r,conversationMode:g},ee={domain:v},I=f?.from_server?.type!=="denied_by_user"?f?.from_server?.body.actions.map((m,y)=>e.jsx(Te,{action:m,displayParams:ee,handleUserAction:B,userActionParams:X},y)):null,te=w?d.formatMessage(w,z):null,se=re.div`flex gap-2 flex-wrap mt-1 empty:hidden`,V=f?E(f):null,Fe=V?.[T]??[],ae=!!V;return e.jsxs(e.Fragment,{children:[e.jsx(ke,{debugMessages:U}),e.jsx(Pe,{highlightedCommand:te,status:M,showWorkUserSetting:!1,children:ae?e.jsx(De,{privacyPolicyUrl:R,data:f,isPromptingForPermission:M===P.Paused}):null}),e.jsx(se,{children:Z?.map(m=>e.jsx(b,{file:m.name,fileId:m.id,width:"wide",alwaysShowData:!0,showDownloadButton:!0,downloadLink:m.download_url,contextConnectorInfo:fe(m.context_connector_info)},m.id))}),(x===5||x===4)&&I&&!o&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-2 flex gap-2",children:I}),e.jsxs("div",{className:"my-1 flex items-center gap-2 text-sm",children:[e.jsx(xe,{className:"icon-sm"}),e.jsx(u,{...p.confirmingSubtitle})]})]}),N!==null&&e.jsx(Ae,{title:N,privacyPolicyUrl:R,data:f,onClose:()=>Q(!1),isOpen:K,actionButtons:I})]})}function be({messageMetadata:t}){const[s,i]=D.useState(!1);return e.jsxs("div",{className:"my-2 flex flex-col text-sm",children:[e.jsxs("div",{className:"flex flex-row items-center hover:cursor-pointer",onClick:()=>{i(!s)},children:[s?e.jsx(L,{className:"icon-sm"}):e.jsx(ye,{className:"icon-sm"}),e.jsx("div",{className:"font-semibold",children:t.display_message})]}),s&&e.jsx("pre",{children:JSON.stringify(t.data,null,2)})]})}function ke({debugMessages:t}){return t.length===0?null:e.jsx("div",{children:t.map((s,i)=>{const r=s.message.metadata?.jit_plugin_data?.from_server;return r&&r.type==="debug"?e.jsx(be,{messageMetadata:r.body},i):null})})}function ze(t,s,i){if(t.message.metadata?.jit_plugin_data?.from_server?.type==="send_test")return{uiState:7};if(t.message.metadata?.jit_plugin_data?.from_server?.type==="debug")return{uiState:3};if(s.some(a=>a.message.content.content_type===W.SystemError))return{uiState:2};if(Se(t.message))return{uiState:3};for(let a=s.length-1;a>=0;a--){const n=s[a];if(n.message.metadata?.invoked_plugin){const o=[];return s.forEach(c=>{const j=c.message.metadata?.attachments?.filter(g=>g.display_files_from_actions_ext);j&&o.push(...j)}),{uiState:1,jitPluginData:n.message.metadata.jit_plugin_data,fileAttachments:o}}const l=$(n.message.metadata?.jit_plugin_data?.from_client);if(l!=null){if(l?.type==="contact_gizmo")return{uiState:1,jitPluginData:s[a-1]?.message.metadata?.jit_plugin_data};if(l?.type==="deny")return{uiState:6};if(l?.type==="oauth_success")return{uiState:0,jitPluginData:n.message.metadata?.jit_plugin_data};break}const d=n.message.metadata?.jit_plugin_data?.from_server;if(d?.type==="preview"&&i)return{uiState:0,jitPluginData:n.message.metadata?.jit_plugin_data};if(d?.type==="confirm_action"&&i)return{uiState:5,jitPluginData:n.message.metadata?.jit_plugin_data};if(d?.type==="oauth_required"&&i)return{uiState:4,jitPluginData:n.message.metadata?.jit_plugin_data}}const r=s.find(a=>a.message.author.role===C.Tool&&a.message.author.name?.split(".")[0]==="gizmo_contacts");return r?{uiState:1,jitPluginData:r.message.metadata?.jit_plugin_data}:{uiState:i?0:3}}function B({actionData:t,assistantMessage:s,allMessages:i,clientThreadId:r,turnGizmo:a,onRequestCompletion:n,conversationMode:l}){const d={id:oe(),author:{role:C.Tool,name:s.message.recipient},content:{content_type:W.Text,parts:[""]},recipient:"all",metadata:{jit_plugin_data:{from_client:t}}};l=l??{kind:F.PrimaryAssistant},a?.gizmo.id&&(d.metadata.gizmo_id=a.gizmo.id),A.updateTree(r,c=>{c.addNode(d.id,d,i[i.length-1].message.id,C.Tool,{completionSampleFinishTime:Date.now()})}),A.setThreadCurrentLeafId(r,d.id);const o=new pe;n({type:le.Next,promptId:d.id,eventMetadata:{eventSource:"mouse"},cancelActiveRequests:!1,completionMetadata:{conversationMode:l},turnTracker:o})}function Ie(t,s){if(t.type!==de.JIT_PLUGIN||!t.metadata.json_schema)return!1;let i=!1;function r(a){for(const n in a)n==="operationId"&&a[n]===s&&(i=!0),a[n]&&typeof a[n]=="object"&&r(a[n])}return r(t.metadata.json_schema),i}function E(t){if(t.from_server?.type==="confirm_action"||t.from_server?.type==="oauth_required"||t.from_server?.type==="preview")return t.from_server.body.params}function De({data:t,privacyPolicyUrl:s,isPromptingForPermission:i}){const r=t?E(t):null,n=(r?.[T]??[]).map((l,d)=>{const o=l.name.startsWith("dalle-");let c=l.name;return o&&(c=`${c}.webp`),e.jsx(b,{file:c,fileId:l.id},d)});return e.jsxs("div",{className:"mb-4 mt-1 divide-y divide-token-border-light overflow-hidden rounded-xl border border-token-border-light",children:[e.jsxs("div",{className:"flex justify-between bg-token-main-surface-tertiary px-4 py-2 text-sm text-token-text-secondary",children:[i?e.jsx(u,{id:"JITPluginMessage.params.sharing.present",defaultMessage:"The following will be shared:"}):e.jsx(u,{id:"JITPluginMessage.params.sharing.past",defaultMessage:"The following was shared:"}),s&&e.jsx("a",{href:q(s),className:"text-token-text-primary",target:"_blank",rel:"noreferrer",children:e.jsx(u,{...p.privacyPolicyLink})})]}),r&&Object.keys(r).map((l,d)=>l===T?null:e.jsxs("div",{className:"flex items-center space-x-2 px-4 py-2 font-mono",children:[e.jsx("span",{className:"text-token-text-tertiary",children:`${l}:`}),e.jsx("span",{children:JSON.stringify(r[l],null,2)})]},d)),n.length>0&&e.jsx("div",{className:"px-4 py-2",children:n})]})}function Ce({title:t,data:s,privacyPolicyUrl:i,actionButtons:r}){const a=s?E(s):null,n=a?.[T]??[],l=n.filter(o=>!o.mime_type?.startsWith("image/")).map((o,c)=>e.jsx(b,{file:o.name,fileId:o.id},c)),d=n.filter(o=>o.mime_type?.startsWith("image/")).map((o,c)=>{const j=o.name.startsWith("dalle-");let g=o.name;return j&&(g=`${g}.webp`),e.jsx(b,{file:g,fileId:o.id},c)});return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-semibold",children:t}),a&&Object.keys(a).map((o,c)=>o===T?null:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"text-token-text-tertiary",children:o}),e.jsx("div",{children:JSON.stringify(a[o],null,2)})]},c)),d.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-token-text-tertiary",children:e.jsx(u,{id:"jitPluginMessage.paramsModalImages",defaultMessage:"Images"})}),d]}),l.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-token-text-tertiary",children:e.jsx(u,{id:"jitPluginMessage.paramsModalFiles",defaultMessage:"Files"})}),l]}),e.jsxs("div",{className:"flex flex-row items-center justify-between pt-4",children:[r!==null&&e.jsx("div",{className:"space-x-2",children:r}),i&&e.jsx("a",{className:"text-xs font-semibold",href:q(i),children:e.jsx(u,{...p.privacyPolicyLink})})]})]})}function Ae({title:t,data:s,privacyPolicyUrl:i,onClose:r,isOpen:a,actionButtons:n}){return e.jsx(me,{isOpen:a,onClose:r,type:"success",hideSeparator:!0,showCloseButton:!0,size:"normal",title:e.jsx(u,{id:"jitPluginMessage.paramsModalTitle",defaultMessage:"Review action"}),children:e.jsx("div",{className:"relative flex h-full flex-col gap-2 overflow-hidden",children:e.jsx("div",{className:"space-y-2",children:e.jsx(Ce,{title:t,data:s,privacyPolicyUrl:i,actionButtons:n})})})})}function $(t){if(t&&"user_action"in t){const s=t.user_action;t={...t,...s.data},"target_message_id"in t&&s.target_message_id&&(t.target_message_id=s.target_message_id)}return t}const p=J({starting:{id:"jitPluginMessage.starting",defaultMessage:"Starting action"},confirming:{id:"jitPluginMessage.confirmingV4",defaultMessage:"<title>{gizmoName} wants to talk to {domain}</title><subtitle>Only allow sites you trust</subtitle>"},confirmingSimple:{id:"jitPluginMessage.confirming.simple",defaultMessage:"{gizmoName} wants to talk to {domain}"},confirmingSubtitle:{id:"jitPluginMessage.confirming.subtitle",defaultMessage:"Only allow sites you trust."},running:{id:"jitPluginMessage.runningV4",defaultMessage:"Talking to {domain}"},finished:{id:"jitPluginMessage.finishedV4",defaultMessage:"Talked to {domain}"},stopped:{id:"jitPluginMessage.stoppedV4",defaultMessage:"Stopped talking to {domain}"},error:{id:"jitPluginMessage.errorV5",defaultMessage:"Error talking to {domain}"},declined:{id:"jitPluginMessage.declined",defaultMessage:"You declined this action"},ranTest:{id:"jitPluginMessage.ranTest",defaultMessage:"Tested {operationName}"},confirmParamsTitle:{id:"jitPluginMessage.confirmParamsTitleV3",defaultMessage:"{gizmoName} wants to share this info with {domain}"},sentParamsTitle:{id:"jitPluginMessage.sentParamsTitleV2",defaultMessage:"{gizmoName} sent this info to {domain}"},privacyPolicyLink:{id:"jitPluginMessage.privacyPolicyLinkV2",defaultMessage:"Privacy policy"}});export{et as JITPluginMessage};
//# sourceMappingURL=dpm3bba0eor0cedo.js.map
