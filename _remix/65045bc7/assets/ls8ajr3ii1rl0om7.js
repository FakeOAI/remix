import{j as e,bg as O,J as j,bQ as Y,K as re,W as fe,G as pe,r as K,ex as xe,N as ye,ca as le,cQ as Q,bq as _e,e8 as he,dn as je,H as ve}from"./fkn4uxbppg2xucmj.js";import{aL as we,cC as Me,cD as F,cE as Ne,bt as be,J as oe}from"./jxzh1g6rrwhx6lt8.js";import{a2 as de,Y as Se,u as Te}from"./mhy7gzmsliahnmju.js";import{g as Pe,u as ke}from"./ho3mkh5nuatji5et.js";import{T as $,g as ze,l as Ie,e as Ae,r as Ee}from"./gx9qfocjvfutqf3s.js";import{K as I,L as De,N as Oe}from"./i0me1wu8u0keyh2b.js";import"./e1qcn3mqlt5vh1uh.js";import"./f5e5bh9es6ukgb68.js";import"./d903hh6p0gmq1r3t.js";import"./npb8jbiraivsa1lk.js";import"./dbdzkfolrg6wp7z0.js";import"./kk54mi4vshirxi1r.js";import"./lni7ygvqwov3g93s.js";import"./o3w8elc6s1bew7fe.js";import"./mz8znlpqx1wh1b5w.js";import"./cp9ys6mfnq419o62.js";import"./lan23y27pwojw0fp.js";import"./bn63odr6ke38at6z.js";import"./d3su4ka4m6wx9pm5.js";import"./m2omlpujgeh3dqfn.js";import"./ida2tpeosslu02ff.js";import"./i2dxzuhy9g0melrs.js";import"./lf16jwwiju0q63pp.js";import"./hb6iakzp5j457t88.js";import"./hjwgxzihbdj755pm.js";function Ce({action:s,handleUserAction:t,userActionParams:a,displayParams:i}){return s.type==="deny"?e.jsx(O,{color:"secondary",size:"small",onClick:()=>{t({...a,actionData:{type:"deny",...s.deny}})},children:e.jsx(j,{...s.name==="decline"?z.decline:z.deny})}):s.type==="allow"?e.jsx(O,{color:"primary",size:"small",onClick:()=>{t({...a,actionData:{type:"allow",...s.allow}})},children:e.jsx(j,{...s.name==="allow"?z.allow:z.confirm})}):s.type==="always_allow"?e.jsx(O,{color:"secondary",size:"small",onClick:async()=>{t({...a,actionData:{type:"always_allow",...s.always_allow}})},children:e.jsx(j,{...z.alwaysAllow})}):s.type==="oauth_redirect"?e.jsx(O,{color:"primary",size:"small",onClick:()=>{Re(s.oauth_redirect,a.clientThreadId,a.turnGizmo)},children:e.jsx(j,{...z.signInButton,values:{domain:i.domain}})}):s.type==="contact_gizmo"?e.jsx(O,{color:"secondary",size:"small",onClick:async()=>{t({...a,actionData:{type:"contact_gizmo",...s.contact_gizmo}})},children:e.jsx(j,{...z.allow})}):null}async function Re(s,t,a){var o;const i=$.getServerThreadId(t),n=((o=ze.getConversationMode(t))==null?void 0:o.kind)===Y.GizmoTest,r=i&&!n?Pe(i,a):window.location.href;we.doOAuthRedirect(s.gizmo_id,s.gizmo_action_id,s.domain,r,n)}const z=re({alwaysAllow:{id:"jitPluginMessage.alwaysAllow",defaultMessage:"Always Allow"},allow:{id:"jitPluginMessage.allow",defaultMessage:"Allow"},decline:{id:"jitPluginMessage.decline",defaultMessage:"Decline"},confirm:{id:"jitPluginMessage.confirm",defaultMessage:"Confirm"},deny:{id:"jitPluginMessage.deny",defaultMessage:"Deny"},signInButton:{id:"jitPluginMessage.signInButton",defaultMessage:"Sign in with {domain}"}}),C="openaiFileIdRefs";function ys({messages:s,clientThreadId:t,isLastTurnInConversation:a,onRequestCompletion:i}){var U,X,Z,ee,se,te,ae,ie;const n=fe(),[r,...o]=s,u=pe(),d=Ie(),m=Ae(t),b=((U=r.message.metadata)==null?void 0:U.gizmo_id)??m,p=Ee(t,b),R=Me(p)&&p.gizmo_id===b,w=(X=ke(b,R))==null?void 0:X.data,[J,V]=K.useState(!1),S=xe(r.message.recipient);let M;if((S==null?void 0:S.functionName)!=null&&(w==null?void 0:w.tools)!=null){for(const c of w.tools)if(Le(c,S.functionName)){M=c;break}}const B=o.filter(c=>{var h,P,k;return((k=(P=(h=c.message.metadata)==null?void 0:h.jit_plugin_data)==null?void 0:P.from_server)==null?void 0:k.type)==="debug"}),L=o.filter(c=>!["debug","send_test"].some(h=>{var P,k,D;return h===((D=(k=(P=c.message.metadata)==null?void 0:P.jit_plugin_data)==null?void 0:k.from_server)==null?void 0:D.type)})),{uiState:x,jitPluginData:l,fileAttachments:y}=Be(r,L,a),g=((Z=l==null?void 0:l.from_server)==null?void 0:Z.type)!=="denied_by_user"?(ee=l==null?void 0:l.from_server)==null?void 0:ee.body.domain:(se=M==null?void 0:M.metadata)==null?void 0:se.domain,_=(te=M==null?void 0:M.metadata)==null?void 0:te.privacy_policy_url;if(K.useEffect(()=>{var c,h;if((p==null?void 0:p.kind)===Y.GizmoInteraction&&((c=me(l==null?void 0:l.from_client))==null?void 0:c.type)!=="oauth_success"&&((h=l==null?void 0:l.from_server)==null?void 0:h.type)==="oauth_required"&&n.query.oauth_success){const{oauth_success:P,...k}=n.query;if(P){for(const D of l.from_server.body.actions)if(D.type==="oauth_redirect"){ne({assistantMessage:r,allMessages:s,clientThreadId:t,onRequestCompletion:i,actionData:{type:"oauth_success",target_message_id:D.oauth_redirect.target_message_id},conversationMode:p});return}n.replace({pathname:n.pathname,query:k})}}},[p,n,r,s,t,i,l,a]),!w)return null;let f=I.Running,N=g?v.running:v.starting,A={domain:g},T=null;if(x===7)return null;if(x===4||x===5){f=I.Paused,N=v.confirmingSimple;const c={gizmoName:w.gizmo.display.name,domain:g};T=u.formatMessage(v.confirmParamsTitle,c),A={...c,title:h=>e.jsxs("div",{className:"inline-flex items-center gap-1 text-sm",children:[h,e.jsx(de,{className:"icon-sm"})]}),subtitle:h=>e.jsx("div",{className:"text-xs",children:h})}}else x===1?(f=I.Finished,N=v.finished,T=u.formatMessage(v.sentParamsTitle,{gizmoName:w.gizmo.display.name,domain:g}),A={domain:g}):x===2?(f=I.Error,N=v.error):(x===3||x===6)&&(f=I.Stopped,N=x===6?v.declined:v.stopped);const W={assistantMessage:r,allMessages:s,clientThreadId:t,turnGizmo:w,onRequestCompletion:i,conversationMode:p},q={domain:g},E=((ae=l==null?void 0:l.from_server)==null?void 0:ae.type)!=="denied_by_user"?(ie=l==null?void 0:l.from_server)==null?void 0:ie.body.actions.map((c,h)=>e.jsx(Ce,{action:c,displayParams:q,handleUserAction:ne,userActionParams:W},h)):null,ce=N?u.formatMessage(N,A):null,ue=ye.div`flex gap-2 flex-wrap mt-1 empty:hidden`,G=l?H(l):null,Fe=(G==null?void 0:G[C])??[],ge=!!G;return e.jsxs(e.Fragment,{children:[e.jsx(Ve,{debugMessages:B}),e.jsx(De,{highlightedCommand:ce,status:f,showWorkUserSetting:!1,children:ge?e.jsx(We,{privacyPolicyUrl:_,data:l,isPromptingForPermission:f===I.Paused}):null}),e.jsx(ue,{children:y==null?void 0:y.map(c=>e.jsx(F,{file:c.name,fileId:c.id,width:"wide",alwaysShowData:!0,showDownloadButton:!0,downloadLink:c.download_url,contextConnectorInfo:Ne(c.context_connector_info)},c.id))}),(x===5||x===4)&&E&&!d&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-2 flex gap-2",children:E}),e.jsxs("div",{className:"my-1 flex items-center gap-2 text-sm",children:[e.jsx(Se,{className:"icon-sm"}),e.jsx(j,{...v.confirmingSubtitle})]})]}),T!==null&&e.jsx(Ge,{title:T,privacyPolicyUrl:_,data:l,onClose:()=>V(!1),isOpen:J,actionButtons:E})]})}function Je({messageMetadata:s}){const[t,a]=K.useState(!1);return e.jsxs("div",{className:"my-2 flex flex-col text-sm",children:[e.jsxs("div",{className:"flex flex-row items-center hover:cursor-pointer",onClick:()=>{a(!t)},children:[t?e.jsx(de,{className:"icon-sm"}):e.jsx(Te,{className:"icon-sm"}),e.jsx("div",{className:"font-semibold",children:s.display_message})]}),t&&e.jsx("pre",{children:JSON.stringify(s.data,null,2)})]})}function Ve({debugMessages:s}){return s.length===0?null:e.jsx("div",{children:s.map((t,a)=>{var n,r;const i=(r=(n=t.message.metadata)==null?void 0:n.jit_plugin_data)==null?void 0:r.from_server;return i&&i.type==="debug"?e.jsx(Je,{messageMetadata:i.body},a):null})})}function Be(s,t,a){var n,r,o,u,d,m,b,p,R,w,J,V,S,M,B,L,x,l;if(((o=(r=(n=s.message.metadata)==null?void 0:n.jit_plugin_data)==null?void 0:r.from_server)==null?void 0:o.type)==="send_test")return{uiState:7};if(((m=(d=(u=s.message.metadata)==null?void 0:u.jit_plugin_data)==null?void 0:d.from_server)==null?void 0:m.type)==="debug")return{uiState:3};if(t.some(y=>y.message.content.content_type===le.SystemError))return{uiState:2};if(Oe(s.message))return{uiState:3};for(let y=t.length-1;y>=0;y--){const g=t[y];if((b=g.message.metadata)!=null&&b.invoked_plugin){const N=[];return t.forEach(A=>{var W,q;const T=(q=(W=A.message.metadata)==null?void 0:W.attachments)==null?void 0:q.filter(E=>E.display_files_from_actions_ext);T&&N.push(...T)}),{uiState:1,jitPluginData:g.message.metadata.jit_plugin_data,fileAttachments:N}}const _=me((R=(p=g.message.metadata)==null?void 0:p.jit_plugin_data)==null?void 0:R.from_client);if(_!=null){if((_==null?void 0:_.type)==="contact_gizmo")return{uiState:1,jitPluginData:(J=(w=t[y-1])==null?void 0:w.message.metadata)==null?void 0:J.jit_plugin_data};if((_==null?void 0:_.type)==="deny")return{uiState:6};if((_==null?void 0:_.type)==="oauth_success")return{uiState:0,jitPluginData:(V=g.message.metadata)==null?void 0:V.jit_plugin_data};break}const f=(M=(S=g.message.metadata)==null?void 0:S.jit_plugin_data)==null?void 0:M.from_server;if((f==null?void 0:f.type)==="preview"&&a)return{uiState:0,jitPluginData:(B=g.message.metadata)==null?void 0:B.jit_plugin_data};if((f==null?void 0:f.type)==="confirm_action"&&a)return{uiState:5,jitPluginData:(L=g.message.metadata)==null?void 0:L.jit_plugin_data};if((f==null?void 0:f.type)==="oauth_required"&&a)return{uiState:4,jitPluginData:(x=g.message.metadata)==null?void 0:x.jit_plugin_data}}const i=t.find(y=>{var g;return y.message.author.role===Q.Tool&&((g=y.message.author.name)==null?void 0:g.split(".")[0])==="gizmo_contacts"});return i?{uiState:1,jitPluginData:(l=i.message.metadata)==null?void 0:l.jit_plugin_data}:{uiState:a?0:3}}function ne({actionData:s,assistantMessage:t,allMessages:a,clientThreadId:i,turnGizmo:n,onRequestCompletion:r,conversationMode:o}){const u={id:_e(),author:{role:Q.Tool,name:t.message.recipient},content:{content_type:le.Text,parts:[""]},recipient:"all",metadata:{jit_plugin_data:{from_client:s}}};o=o??{kind:Y.PrimaryAssistant},n!=null&&n.gizmo.id&&(u.metadata.gizmo_id=n.gizmo.id),$.updateTree(i,m=>{m.addNode(u.id,u,a[a.length-1].message.id,Q.Tool,{completionSampleFinishTime:Date.now()})}),$.setThreadCurrentLeafId(i,u.id);const d=new be;r({type:he.Next,promptId:u.id,eventMetadata:{eventSource:"mouse"},cancelActiveRequests:!1,completionMetadata:{conversationMode:o},turnTracker:d})}function Le(s,t){if(s.type!==je.JIT_PLUGIN||!s.metadata.json_schema)return!1;let a=!1;function i(n){for(const r in n)r==="operationId"&&n[r]===t&&(a=!0),n[r]&&typeof n[r]=="object"&&i(n[r])}return i(s.metadata.json_schema),a}function H(s){var t,a,i;if(((t=s.from_server)==null?void 0:t.type)==="confirm_action"||((a=s.from_server)==null?void 0:a.type)==="oauth_required"||((i=s.from_server)==null?void 0:i.type)==="preview")return s.from_server.body.params}function We({data:s,privacyPolicyUrl:t,isPromptingForPermission:a}){const i=s?H(s):null,r=((i==null?void 0:i[C])??[]).map((o,u)=>{const d=o.name.startsWith("dalle-");let m=o.name;return d&&(m=`${m}.webp`),e.jsx(F,{file:m,fileId:o.id},u)});return e.jsxs("div",{className:"mb-4 mt-1 divide-y divide-token-border-light overflow-hidden rounded-xl border border-token-border-light",children:[e.jsxs("div",{className:"flex justify-between bg-token-main-surface-tertiary px-4 py-2 text-sm text-token-text-secondary",children:[a?e.jsx(j,{id:"JITPluginMessage.params.sharing.present",defaultMessage:"The following will be shared:"}):e.jsx(j,{id:"JITPluginMessage.params.sharing.past",defaultMessage:"The following was shared:"}),t&&e.jsx("a",{href:oe(t),className:"text-token-text-primary",target:"_blank",rel:"noreferrer",children:e.jsx(j,{...v.privacyPolicyLink})})]}),i&&Object.keys(i).map((o,u)=>o===C?null:e.jsxs("div",{className:"flex items-center space-x-2 px-4 py-2 font-mono",children:[e.jsx("span",{className:"text-token-text-tertiary",children:`${o}:`}),e.jsx("span",{children:JSON.stringify(i[o],null,2)})]},u)),r.length>0&&e.jsx("div",{className:"px-4 py-2",children:r})]})}function qe({title:s,data:t,privacyPolicyUrl:a,actionButtons:i}){const n=t?H(t):null,r=(n==null?void 0:n[C])??[],o=r.filter(d=>{var m;return!((m=d.mime_type)!=null&&m.startsWith("image/"))}).map((d,m)=>e.jsx(F,{file:d.name,fileId:d.id},m)),u=r.filter(d=>{var m;return(m=d.mime_type)==null?void 0:m.startsWith("image/")}).map((d,m)=>{const b=d.name.startsWith("dalle-");let p=d.name;return b&&(p=`${p}.webp`),e.jsx(F,{file:p,fileId:d.id},m)});return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-semibold",children:s}),n&&Object.keys(n).map((d,m)=>d===C?null:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"text-token-text-tertiary",children:d}),e.jsx("div",{children:JSON.stringify(n[d],null,2)})]},m)),u.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-token-text-tertiary",children:e.jsx(j,{id:"jitPluginMessage.paramsModalImages",defaultMessage:"Images"})}),u]}),o.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-token-text-tertiary",children:e.jsx(j,{id:"jitPluginMessage.paramsModalFiles",defaultMessage:"Files"})}),o]}),e.jsxs("div",{className:"flex flex-row items-center justify-between pt-4",children:[i!==null&&e.jsx("div",{className:"space-x-2",children:i}),a&&e.jsx("a",{className:"text-xs font-semibold",href:oe(a),children:e.jsx(j,{...v.privacyPolicyLink})})]})]})}function Ge({title:s,data:t,privacyPolicyUrl:a,onClose:i,isOpen:n,actionButtons:r}){return e.jsx(ve,{isOpen:n,onClose:i,type:"success",hideSeparator:!0,showCloseButton:!0,size:"normal",title:e.jsx(j,{id:"jitPluginMessage.paramsModalTitle",defaultMessage:"Review action"}),children:e.jsx("div",{className:"relative flex h-full flex-col gap-2 overflow-hidden",children:e.jsx("div",{className:"space-y-2",children:e.jsx(qe,{title:s,data:t,privacyPolicyUrl:a,actionButtons:r})})})})}function me(s){if(s&&"user_action"in s){const t=s.user_action;s={...s,...t.data},"target_message_id"in s&&t.target_message_id&&(s.target_message_id=t.target_message_id)}return s}const v=re({starting:{id:"jitPluginMessage.starting",defaultMessage:"Starting action"},confirming:{id:"jitPluginMessage.confirmingV4",defaultMessage:"<title>{gizmoName} wants to talk to {domain}</title><subtitle>Only allow sites you trust</subtitle>"},confirmingSimple:{id:"jitPluginMessage.confirming.simple",defaultMessage:"{gizmoName} wants to talk to {domain}"},confirmingSubtitle:{id:"jitPluginMessage.confirming.subtitle",defaultMessage:"Only allow sites you trust."},running:{id:"jitPluginMessage.runningV4",defaultMessage:"Talking to {domain}"},finished:{id:"jitPluginMessage.finishedV4",defaultMessage:"Talked to {domain}"},stopped:{id:"jitPluginMessage.stoppedV4",defaultMessage:"Stopped talking to {domain}"},error:{id:"jitPluginMessage.errorV5",defaultMessage:"Error talking to {domain}"},declined:{id:"jitPluginMessage.declined",defaultMessage:"You declined this action"},ranTest:{id:"jitPluginMessage.ranTest",defaultMessage:"Tested {operationName}"},confirmParamsTitle:{id:"jitPluginMessage.confirmParamsTitleV3",defaultMessage:"{gizmoName} wants to share this info with {domain}"},sentParamsTitle:{id:"jitPluginMessage.sentParamsTitleV2",defaultMessage:"{gizmoName} sent this info to {domain}"},privacyPolicyLink:{id:"jitPluginMessage.privacyPolicyLinkV2",defaultMessage:"Privacy policy"}});export{ys as JITPluginMessage};
//# sourceMappingURL=ls8ajr3ii1rl0om7.js.map
