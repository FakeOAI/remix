const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/bz2gw14afdl14qwf.js","assets/cenhwbprxai3toix.js","assets/lzqwtbp50roqvxnh.js","assets/root-o2r7uhf3.css","assets/nvw1dral599ors5n.js","assets/bomvf441parvbl6l.js","assets/conversation-small-cll5buey.css","assets/if0s6lpo3mwf7mho.js","assets/i2mam4exf28ww00h.js","assets/excfi9p08rx2yfii.js","assets/eqndo48iafwlks0f.js","assets/emjp11937lws85ye.js","assets/i51i3k321hvaxal9.js","assets/cborgxcam8a7my8h.js","assets/j4pjeew6dlxr95ui.js","assets/h20dz7cyjcptun6e.js","assets/is-scrollable-element-i34sjb0l.css","assets/mej6dcn3epzdp940.js","assets/hn586u5on2jlex6e.js","assets/kp41qb109q7zsu08.js","assets/e3lzzvpbrfw34hi0.js","assets/h0w2cfyxquh3a88t.js","assets/s26g8cj5crlmzrhm.js","assets/jth9gz8y4nfsu03x.js","assets/c657bb6sfxb67al1.js","assets/jyh9xl3syf7yrebg.js","assets/i5dl7qcorvwptxtt.js","assets/j72yt11gyo474tkr.js","assets/d01hwntyf2775ji3.js","assets/kcdclgxeuzpy449e.js","assets/bh0hpeydruybhwyo.js","assets/code-composer-ne11stli.css","assets/oe2m0ns7c5vjyifr.js","assets/izo5544qkgx2yj5u.js","assets/c83e95yczkbasxpf.js","assets/jmi851zx6qdtjhdj.js","assets/f4c5dqtaqqzzhoq0.js","assets/document-composer-ofhzvcxp.css","assets/hb1acr5sgcdia4kr.js","assets/in55pzbopefuboqx.js","assets/nvism2jgbpcti520.js","assets/ADAVisualizationComponent-mi6em660.css","assets/sso-go45p84u2s30azkx.js","assets/leqgnttd8q44vj5y.js","assets/kubcqofgwn62pe93.js","assets/dahwsqfnygv3sm0g.js","assets/fykyl3lv4pekhvc1.js","assets/b83ac0f196zs6vll.js","assets/f3c3o3we96ooalz2.js","assets/itghwucfyv5ciib7.js","assets/f1kyav47b90yvurp.js","assets/gjzr5fp4tn0aic7b.js","assets/nzcqoen16qj23jz4.js","assets/983a0dy92b3ronpv.js","assets/huv477r1pavawgmh.js","assets/kqwdyvkaaavvn8k3.js","assets/gfey6q4vulo3na91.js","assets/hx368ocror60cram.js","assets/osmkyu7tni4wjxir.js","assets/k6gdy2kn0ubkfe1p.js","assets/e9lafxuzyeh4418f.js","assets/mauunnjhemq83vec.js","assets/ckn8eg6rpq4ix2ua.js","assets/lwz843r9of6cwfj1.js","assets/j30ux8h0392339qt.js","assets/jc5ynb5b7d7zj5ef.js","assets/iej0cupg2dqkmejt.js","assets/o2vlpdwqswf7i6ss.js","assets/ce0v7d8k020heh82.js","assets/jk8w36bsokizpx57.js","assets/dmau43v1lisg5o8k.js","assets/lwsvc0prcm5qybau.js","assets/fxwpnfsczjkyx99q.js","assets/g9ajqtukvv4jsver.js","assets/eqinamzym36e09pd.js","assets/d3y72ugnrmac5z1v.js"])))=>i.map(i=>d[i]);
import{y as o,a4 as re,a9 as Fe,r as _,a0 as _e,as as Te,a1 as ot,ab as Qe,ac as He,f4 as qr,ae as T,az as is,fO as cs,fP as Hr,ah as ke,S as de,aA as De,c as zr,$ as je,fp as Vr,eC as ls,bB as us,bj as ze,bn as Ve,u as an,N as Be,af as ds,P as U,d as O,fQ as Kr,fR as Qr,bu as Jt,fq as Yr,fr as Jr,bA as Xr,fS as Zr,a6 as Ge,w as cn,eZ as hs,fc as fs,n as ms,fT as Pt,bb as $e,bc as eo,fy as to,c6 as no,be as Ye,L as so,j as ut,aW as Mt,al as ln,bT as ro,bR as oo,aw as vt,ek as ps,bH as gs,bd as xs,bf as ys,bz as Ut,bt as ao,aB as io,ch as un,x as co,e7 as dn,e8 as _s,at as vs,R as Ie,D as Ee,fU as lo,ax as we,fV as Xt,M as Mn,ey as st,eh as ws,ee as bs,fW as Zt,bI as uo,fX as Cs,v as ho,h as Tn,fY as fo,fZ as jn,f_ as Rn,f$ as mo,g0 as po,C as go,dL as xo,bk as yo,bl as An,bm as Nn,ak as hn,dV as _o,a$ as vo,f9 as wo,dI as bo,fb as Co,f2 as So,aZ as wt,bG as Io,fi as ko}from"./cenhwbprxai3toix.js";import{jF as Eo,bN as Mo,ld as To,le as jo,iJ as Ro,lf as Ao,b_ as dt,jG as Ss,jE as No,lg as Bo,lh as Bn,jJ as Fo,li as Do,kj as Po,dS as Uo,k4 as Oo,k5 as Is,kq as Lo,jH as Fn,a6 as Wo,e9 as ks,lj as Go,jV as $o,g0 as qo,lk as Ho,ll as zo,lm as Vo,ln as Ko,lo as Qo,g2 as Es,jW as Ms,fW as Yo,hQ as Ne,lp as We,jL as Jo,lq as Xo,lr as en,ls as Zo,lt as ea,dp as Dn,lu as fn,lv as ta,ht as mn,hv as na,hu as Ts,hC as pn,aj as Tt,lw as sa,lx as js,ly as Rs,lz as ra,dF as oa,dg as aa,aD as ia,aB as ca,dm as la,dn as ua,lA as da,lB as ha,lC as fa,lD as ma,dX as As,a as pa,fX as tn,lE as ga,lF as xa,lG as ya,lH as _a,lI as va,lJ as wa,lK as ba,iG as Ca,iC as Ot,lL as Lt,lM as Sa,lN as Ia,iA as ka,hL as Ea,iI as Ma,lO as Ta,iF as ja,hG as Wt,b as Ra,lP as Aa,U as Na,dq as Ns,iv as Bs,aa as Ba,lQ as Fs,lR as Fa,lS as mt,lT as Da,lU as Ds,lV as Gt,lW as Pa,lX as Ua,ba as qe,lY as Oa,lZ as La,l_ as Wa,aO as ge,l$ as Ps,aH as Pn,aI as Je,aJ as jt,aT as Ga,bi as $a,bj as qa,aW as Ha,aX as Us,aY as bt,aZ as Xe,b9 as za,bk as pe,m0 as ye,bl as Va,a_ as Ka,a$ as Qa,b0 as Ya,b2 as Os,b1 as Ja,aL as Xa,b6 as Za,b7 as ei,bb as ti,bc as ni,m1 as si,m2 as ri,m3 as oi,m4 as ai,be as Un,m5 as Ls,bf as ii,b8 as ci,bh as li,m6 as ui,m7 as di,m8 as hi,m9 as Ws,ma as fi,mb as mi,mc as $t,md as pi,fk as gi,b$ as ht,z as gn,t as Rt,h as xi,i9 as xn,c$ as Gs,cb as On,x as $s,av as yi,bC as _i,me as vi,bp as qs,w as Hs,mf as wi,mg as zs,f as Vs,e as bi,c as nn,d as Ci,mh as Si,by as Ii,mi as ki,mj as Ei,i as Mi,mk as Ti,ml as ji,mm as Ri,mn as Ai,mo as Ni,mp as Bi,cY as Fi,mq as Ct,c8 as Ks,mr as Di,e$ as yn,ms as _n,mt as Pi,mu as Ui,mv as Oi,mw as me,mx as Li,my as yt,mz as pt,mA as Wi,mB as Qs,ft as fe,mC as Gi,mD as $i,mE as et,mF as qi,mG as Ln,mH as Hi,mI as zi,cB as Vi,ck as Wn,cG as Ki,mJ as Qi,H as Yi,mK as Ji,mL as Xi,mM as Zi,mN as ec,mO as tc,I as nc,mP as sc,mQ as rc,cv as oc,d7 as ac,u as ic,v as cc,mR as Gn,c9 as $n}from"./bomvf441parvbl6l.js";import{Q as lc,S as uc,u as At,b_ as dc,d as hc,a9 as fc,b$ as Ys,a0 as Js,aP as mc,Y as pc,q as gc,J as xc,ae as yc,p as _c,aY as Xs,bq as Zs,bw as er,c0 as tr,I as vc,ab as nr,bk as wc,aa as sr,bl as bc,c1 as Cc,br as Sc,b8 as Ic,aG as kc,V as rr,b2 as qt}from"./lzqwtbp50roqvxnh.js";import{D as ne,B as Ec}from"./hn586u5on2jlex6e.js";import{c as or,d as ar,r as ir,s as cr}from"./kp41qb109q7zsu08.js";import{u as Mc}from"./c657bb6sfxb67al1.js";import{U as be,G as Ke,a as Tc,u as lr,b as ur}from"./jyh9xl3syf7yrebg.js";import{u as dr,K as hr,W as fr,O as mr,J as pr,b as gr,X as jc,g as qn,G as Rc,f as Ac,Y as Nc,E as Bc}from"./s26g8cj5crlmzrhm.js";import{l as vn,a as St,T as j,M as Fc,b as It,v as xr,j as wn,N as Dc,O as Pc,P as Uc,Q as Oc,k as yr,m as Lc,d as Wc}from"./h0w2cfyxquh3a88t.js";import{B as Gc,T as $c,I as qc}from"./j72yt11gyo474tkr.js";import{P as kt}from"./d01hwntyf2775ji3.js";import{m as Et}from"./i2mam4exf28ww00h.js";import{b as Hn}from"./jth9gz8y4nfsu03x.js";import{i as Hc}from"./kcdclgxeuzpy449e.js";import{T as zc,a as Vc}from"./bh0hpeydruybhwyo.js";function Kc({className:t,zIndexKey:e,onClick:s}){return o.jsx(Et.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:re("absolute inset-0",t,Eo[e]),onClick:s})}function Qc({zIndexKey:t,onClick:e}){return o.jsx(Kc,{zIndexKey:t,onClick:e,className:"bg-gray-50/50 dark:bg-black/50"})}const Yc=({onScroll:t})=>(To(({scrollTop:e})=>{t?.(e)}),null),Jc=({shouldScrollToTop:t})=>{const e=jo();return _.useEffect(()=>{t===!0&&e({behavior:"smooth"})},[t,e]),null},Xc=()=>{const t=Ro();_.useEffect(()=>{t({behavior:"smooth"})},[t]);const[e]=Ao();return e?null:o.jsx("button",{onClick:()=>t({behavior:"smooth"}),className:"absolute bottom-5 right-1/2 z-10 flex h-8 w-8 translate-x-1/2 cursor-pointer items-center justify-center rounded-full border border-token-border-light bg-token-main-surface-primary bg-clip-padding text-token-text-secondary",children:o.jsx(lc,{className:"icon-md text-token-text-primary"})})},Zc=Fe.section`w-full h-full flex flex-col popover bg-token-main-surface-primary`,el=({children:t,onScroll:e,shouldScrollToTop:s,scrollToBottomMode:a="top",isLoading:i=!1},l)=>o.jsxs("main",{className:"relative flex min-h-0 flex-auto flex-grow flex-col",ref:l,children:[o.jsx(Mo,{children:i&&o.jsx(Qc,{zIndexKey:"textdocDiffLoadingOverlay"})}),o.jsxs(Gc,{followButtonClassName:"hidden",initialScrollBehavior:"auto",className:"h-full",mode:a,children:[t,a==="bottom"&&o.jsx(Xc,{}),o.jsx(Yc,{onScroll:e}),o.jsx(Jc,{shouldScrollToTop:s})]})]}),tl=_.forwardRef(el),nl=Fe.header`flex items-center justify-between p-3 h-14`,sl=Fe.h2`ml-2.5 text-base text-lg text-gray-700 dark:text-token-text-secondary truncate`,rl=({onClick:t})=>{const e=_e();return o.jsx(Te,{label:e.formatMessage(ol.close),children:o.jsx(dt,{icon:uc,onClick:t})})},rt=({children:t})=>o.jsx(Zc,{children:t});rt.Title=sl;rt.CloseButton=rl;rt.Header=nl;rt.Content=tl;const ol=ot({close:{id:"Bix/Kd",defaultMessage:"Close"}}),al=Qe(()=>He(()=>import("./bz2gw14afdl14qwf.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31])).then(t=>t.CodeComposer),{loading:()=>o.jsx("div",{className:Ss.code,children:o.jsx("div",{className:"h-full w-full px-4",children:o.jsx(kt,{lines:20})})})}),il=t=>o.jsx(al,{...t}),_r=()=>{const[{width:t},e]=No(),s=t>=Bn+Fo?Bn:Do;return o.jsx("div",{className:re(Ss.document,"mt-4"),ref:e,style:{margin:`0 ${Bo}px`},children:o.jsx("div",{style:{width:s},children:o.jsx(kt,{lines:20})})})},cl=Qe(()=>He(()=>import("./oe2m0ns7c5vjyifr.js"),__vite__mapDeps([32,1,2,3,11,5,6,10,4,7,8,12,13,14,15,16,33,21,34,35,36,18,19,20,22,23,24,25,26,27,28,29,30,37])).then(t=>t.DocumentComposer),{loading:_r}),ll=t=>o.jsx(cl,{...t}),ul=({onScroll:t,textdocId:e})=>{const s=Po(e),{windowWidth:a}=qr(p=>p,{windowWidth:0,windowHeight:0});if(!s)return null;const{versions:i}=s,l=Uo(i),h=Oo(l);let u=null;switch(l?.type){case ks.DOCUMENT:u=o.jsx(ll,{value:l.content,comments:[],isRequestActive:h,isPreview:!0,isDisabled:!0,hideAccelerators:!0,commentsMode:Fn.ALL_HIDDEN,hideToolbar:!0,hideEditOverlay:!0,width:a,modelCursor:l.modelCursor});break;default:l&&Is(l.type)&&(u=o.jsx(il,{id:"codemirror",currentlyStreamingLineIndex:null,language:Lo(l.type),value:l.content,commentsMode:Fn.ALL_HIDDEN,hideToolbar:!0,hideAccelerators:!0,comments:[],readonlyReason:Wo.Streaming,isRequestActive:h}))}return o.jsx(rt,{children:o.jsx(rt.Content,{onScroll:t,children:u})})},dl=_.memo(ul);function hl(t,e){switch(t){case"presentation":return o.jsx(Qo,{});case"table":return o.jsx(Ko,{});case"chart":return o.jsx(Vo,{});case ks.DOCUMENT:return o.jsx(At,{className:re("icon-md",{"text-token-text-primary":e,"text-token-text-tertiary":!e})});default:return Is(t)?o.jsx(Ho,{className:re("icon-md",{"text-token-text-primary":e,"text-token-text-tertiary":!e})}):o.jsx(zo,{})}}const fl=({isHovered:t=!1})=>{const e=_e();return o.jsx(Te,{label:e.formatMessage({id:"KMbgyZ",defaultMessage:"Open in canvas"}),children:o.jsx(Et.div,{role:"button",animate:{opacity:t?1:.64},whileHover:{opacity:1},transition:{type:"tween",duration:.18},className:"text-token-text-secondary transition-colors",children:o.jsx(dc,{className:"icon-md"})})})},ml=({isCanvasOpen:t,isFocused:e,isHovered:s,isInlinePreview:a,size:i})=>t?e?"0px 2px 6px 0px rgba(0, 0, 0, 0.06)":"0px 2px 6px 0px rgba(0, 0, 0, 0)":a?s||e?`0px ${i==="large"?12:4}px ${i==="large"?32:10}px 0px rgba(0, 0, 0, 0.064)`:`0px ${i==="large"?6:4}px ${i==="large"?14:4}px 0px rgba(0, 0, 0, 0.04)`:"0px 2px 6px 0px rgba(0, 0, 0, 0)",pl=({textdocId:t,isInlinePreview:e=!1,isStreaming:s=!1,isDisabled:a=!1,isFocused:i=!1,isCanvasOpen:l=!1,marginBottom:h,size:u="large",onClick:p,children:g,name:v,type:w})=>{const f=_.useRef(null),[x,b]=_.useState(!1),[S]=_.useState(()=>Go(100,180,!1)),{resolvedTheme:k}=is(),B=k==="dark",D=w?o.jsx("span",{className:re("flex-shrink-0 transition-[filter]",{grayscale:!i&&!x}),children:hl(w,i&&l)}):o.jsx("div",{className:"flex h-6 w-6 flex-shrink-0 items-center overflow-hidden",children:o.jsx(kt,{lines:1,size:"base",width:100,widthVariance:0})}),I=v?o.jsx("span",{className:"min-w-0 truncate",children:v}):o.jsx("div",{className:"flex h-5 flex-grow items-center overflow-hidden",style:{width:S},children:o.jsx(kt,{lines:1,size:"base",width:100,widthVariance:0})}),M=s&&o.jsx($o,{size:20,className:re("flex-shrink-0",i?"text-blue-selection":"text-token-text-secondary")}),A=()=>{!f.current||a||(Es.logButtonClick(Ms.MESSAGE_ATTACHMENT,{type:w}),Yo(f.current),p?.())},F=u==="large"?100:50,W=`${B?"rgba(0,0,0,0)":"rgba(255,255,255,0)"}, ${B?"#2f2f2f":"#ffffff"}`;return o.jsxs(Et.div,{role:"button",id:qo(t),initial:{opacity:s?0:1,scale:s?.9:1},animate:{opacity:1,scale:1},transition:{type:"spring",bounce:0,duration:.72},className:re("popover relative flex select-none flex-col overflow-hidden border bg-token-main-surface-primary transition-shadow duration-500",a?"cursor-default":"cursor-pointer",{"border-token-text-tertiary font-medium dark:border-gray-600":i&&l,"font-regular":!i,"border-token-border-light":!x&&!i,"border-token-border-medium":x&&!i,"flex min-w-0 max-w-full flex-shrink flex-grow-0 items-center justify-between self-start rounded-xl":l||!e,"w-full rounded-2xl":!l&&e}),onMouseEnter:()=>!a&&b(!0),onMouseLeave:()=>b(!1),onClick:A,ref:f,style:{marginBottom:h,height:l||!e?void 0:u==="large"?"24rem":"10rem",width:u==="small"?"300px":void 0,boxShadow:ml({isCanvasOpen:l,isFocused:i,isHovered:x,isInlinePreview:e,size:u})},children:[o.jsxs("div",{className:re("flex w-full min-w-0 items-center justify-between gap-2 self-start border-token-border-light px-4 transition-colors duration-700",{"border-token-border-light":!x&&!i,"border-token-border-medium":x&&!i,"text-sm font-medium text-token-text-primary":!l&&x&&e,"py-2":l||!e,"py-3":!l&&e,"text-sm font-medium text-token-text-secondary":!l&&!x&&e}),children:[o.jsxs("div",{className:re("flex min-w-0 items-center",{"gap-2":l||!e,"gap-3.5":!l&&e}),children:[D,I]}),l?o.jsx(Et.span,{animate:M?"show":"initial",variants:{initial:{opacity:0,paddingLeft:0,width:"0"},show:{opacity:1,paddingLeft:2,width:"24px"}},transition:{type:"tween",duration:.18},children:M}):e&&!a?o.jsx(fl,{isHovered:x}):null]}),o.jsxs("div",{className:"relative flex min-h-0 w-full flex-1 flex-col self-end",children:[!l&&g,e&&!l&&o.jsx("div",{className:"absolute bottom-0 z-20 h-24 w-full transition-colors",style:{height:F,background:`linear-gradient(${W})`}}),e&&u==="small"&&!l&&o.jsx("div",{className:"absolute bottom-0 right-0 top-0 z-20 transition-colors",style:{width:F,background:`linear-gradient(to right, ${W})`}})]})]})},gl=({type:t,name:e,isStreaming:s=!1,isFocused:a=!1,onClick:i,textdocId:l,isFetching:h=!1,isCanvasOpen:u=!1,isInlinePreview:p=!1,isMissingFromThread:g=!1})=>{const v=_e(),[w,f]=_.useState(!1),x=g,b=k=>{f(k>0)},S=u||!p?12:!u&&p?16:void 0;return o.jsx(pl,{name:g?o.jsx("span",{className:"min-w-0 truncate",children:v.formatMessage({id:"oZTAp8",defaultMessage:"Unknown title"})}):e,isFocused:a,isCanvasOpen:u,textdocId:l,type:t,isDisabled:x,isInlinePreview:p,isStreaming:s,onClick:i,marginBottom:S,children:p&&l&&o.jsx("div",{className:re("relative flex min-h-0 flex-auto flex-col overflow-hidden border-t transition-colors",{"border-token-border-light":w,"border-transparent":!w}),children:g?o.jsx("div",{className:"m-auto text-token-text-secondary",children:o.jsx(T,{id:"DZUSSk",defaultMessage:"Canvas not found"})}):h?o.jsx(_r,{}):o.jsx(dl,{onScroll:b,textdocId:l})})})};function xl(t){return t.message.metadata?.safety_plugin_status_code===123}function yl(t){return t.message.metadata?.finish_details?.type==="content_filter"}function bn(t){if(t===void 0)return{flagSeverity:void 0,shouldHideContent:!1,errCode:void 0,errMessage:void 0};const{errType:e,errCode:s,err:a,disclaimers:i}=t,l=yl(t),h=l&&xl(t),u=i&&i.length>0;return h?{flagSeverity:"warning",shouldHideContent:!0,errCode:Ne.ContentRegurgitation,errMessage:a}:!u&&l?{flagSeverity:"warning",shouldHideContent:!0,errCode:Ne.ContentOrTos,errMessage:a}:{flagSeverity:e,shouldHideContent:e==="danger"&&(s===Ne.ContentPolicy||s===Ne.ModelIncompatibility),disclaimers:i,errCode:s,errMessage:a}}function kh(t){return o.jsx(We,{flag:"danger",isUserTurn:!1,children:o.jsx(T,{...xe.somethingWentWrong})})}function _l({message:t,onRequestMoreCompletions:e,clientThreadId:s,id:a,isFeedbackEnabled:i,isUserTurn:l,className:h}){const{errCode:u,errMessage:p,flagSeverity:g}=bn(t);switch(u){case Ne.ContentPolicy:return o.jsx(We,{flag:g,isUserTurn:l,className:h,children:o.jsx(Cl,{isFeedbackEnabled:i})});case Ne.ModelIncompatibility:return o.jsx(We,{flag:g,isUserTurn:l,className:h,children:o.jsx(T,{...xe.modelIncompatibilityMessage})});case Ne.ContentOrTos:return o.jsx(We,{flag:g,isUserTurn:l,className:h,children:o.jsx(wl,{isFeedbackEnabled:i})});case Ne.ContentRegurgitation:return o.jsx(We,{flag:g,isUserTurn:l,className:h,children:o.jsx(bl,{})});case en:return o.jsx(vl,{className:h,id:a,onRequestMoreCompletions:e,flag:g,clientThreadId:s,isUserTurn:l});case cs:return o.jsx(We,{flag:g,isUserTurn:l,className:h,children:o.jsx(T,{...xe.historyDisabledConversationMissing})});default:return p!==void 0?o.jsx(We,{flag:g,isUserTurn:l,className:h,children:o.jsx(Jo,{rehypePlugins:[[Xo,{target:"_new",rel:"noopener noreferrer"}]],className:"markdown prose w-full break-words dark:prose-invert",children:p})}):null}}function vl({className:t,id:e,onRequestMoreCompletions:s,flag:a,clientThreadId:i,isUserTurn:l}){const h=Zo(S=>S.isoDate),u=ea(h),p=vn(i??Hr),g=p&&p.kind!==ke.PrimaryAssistant,v=dr(),w=hr(),f=_.useCallback(()=>{de.logEvent("chatgpt_regenerate_due_to_rate_limit_button_clicked",void 0,{useDefaultModel:"false",...Hn({clientThreadId:i})});const S=new Dn;s(e,{eventSource:"mouse"},S,!0,"none",!1)},[e,s,i]),x=_.useCallback(()=>{const S=new Dn,k=w.id;de.logEvent("chatgpt_regenerate_due_to_rate_limit_button_clicked",void 0,{useDefaultModel:"true",...Hn({clientThreadId:i})}),v({modelId:k,location:"Model switcher menu item"}),s(e,{eventSource:"mouse"},S,!0,"none",!0)},[s,e,w.id,v,i]);let b;return g?b=h!=null?o.jsx("span",{children:o.jsx(T,{...xe.gptUsageCapExceededCustomFeature,values:{link:zn,formattedTime:u}})}):o.jsx(T,{...xe.gptUsageCapExceededExpired}):b=h!=null?o.jsx("span",{children:o.jsx(T,{...xe.gptUsageCapExceeded,values:{link:zn,formattedTime:u}})}):o.jsx(T,{...xe.gptUsageCapExceededExpired}),o.jsx(We,{flag:h!=null?a:void 0,isUserTurn:l,className:t,children:o.jsxs("div",{className:"flex items-center gap-6",children:[b,h==null&&o.jsx(De,{color:"secondary",className:"flex-shrink-0",onClick:f,children:o.jsx(T,{...xe.buttonTryAgain})}),h!=null&&!g&&o.jsx(De,{color:"secondary",className:"flex-shrink-0",onClick:x,children:o.jsx(T,{...xe.buttonUseDefaultModel})})]})})}const zn=t=>o.jsx("a",{href:"https://share.hsforms.com/16d0ZZVM3QZirXnCD_q7u1Q4sk30",target:"_blank",rel:"noreferrer",className:"underline",children:t});function wl({isFeedbackEnabled:t}){return o.jsxs(o.Fragment,{children:[o.jsx("div",{className:t?"font-semibold":"",children:o.jsx(T,{...xe.contentOrTosViolationNoFeedback,values:{contentPolicyLink:vr,termsLink:Sl}})}),o.jsx("div",{children:t&&o.jsx(T,{...xe.contentPolicyFeedback})})]})}function bl(){return o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"font-semibold",children:o.jsx(T,{...xe.contentRegurgitationViolation})}),o.jsx("div",{children:o.jsx(T,{...xe.readModelSpec,values:{modelSpecLink:Il}})})]})}function Cl({isFeedbackEnabled:t}){return o.jsxs(o.Fragment,{children:[o.jsx("div",{className:t?"font-semibold":"",children:o.jsx(T,{...xe.contentPolicyViolationNoFeedback,values:{contentPolicyLink:vr}})}),o.jsx("div",{children:t&&o.jsx(T,{...xe.contentPolicyFeedback})})]})}const vr=t=>o.jsx(fn,{target:"_blank",href:"https://openai.com/policies/usage-policies",rel:"noreferrer",children:t}),Sl=t=>o.jsx(fn,{target:"_blank",href:"https://openai.com/policies/terms-of-use",rel:"noreferrer",children:t}),Il=t=>o.jsx(fn,{target:"_blank",href:"https://cdn.openai.com/spec/model-spec-2024-05-08.html",rel:"noreferrer",children:t}),xe=ot({contentPolicyFeedback:{id:"TextMessageDisplay.contentPolicyFeedback",defaultMessage:"Did we get it wrong? Please tell us by giving this response a thumbs down."},contentPolicyViolation:{id:"TextMessageDisplay.contentPolicyViolation.2",defaultMessage:"This content may violate our <contentPolicyLink>usage policies</contentPolicyLink>. Did we get it wrong? Please tell us by giving this response a thumbs down."},contentPolicyViolationNoFeedback:{id:"TextMessageDisplay.contentPolicyViolationNoFeedback",defaultMessage:"This content may violate our <contentPolicyLink>usage policies</contentPolicyLink>."},modelIncompatibilityMessage:{id:"cyOWhN",defaultMessage:"Your request was flagged as potentially violating our usage policy. Please try again with a different prompt."},contentOrTosViolation:{id:"TextMessageDisplay.contentOrTosViolation.2",defaultMessage:"This content may violate our <termsLink>Terms of Use</termsLink> or <contentPolicyLink>usage policies</contentPolicyLink>. Did we get it wrong? Please tell us by giving this response a thumbs down."},contentOrTosViolationNoFeedback:{id:"TextMessageDisplay.contentOrTosViolationNoFeedback",defaultMessage:"This content may violate our <termsLink>Terms of Use</termsLink> or <contentPolicyLink>usage policies</contentPolicyLink>."},contentRegurgitationViolation:{id:"kAMQnd",defaultMessage:"ChatGPT isn't designed to provide this type of content."},readModelSpec:{id:"fQ0JYv",defaultMessage:"Read the <modelSpecLink>Model Spec</modelSpecLink> for more on how ChatGPT handles creators' content."},historyDisabledConversationMissing:{id:"TextMessageDisplay.historyDisabledConversationMissing",defaultMessage:"Sorry, conversations created when Chat History is off expire after 6 hours of inactivity. Please start a new conversation to continue using ChatGPT."},somethingWentWrong:{id:"TextMessageDisplay.somethingWentWrong",defaultMessage:"Something went wrong."},gptUsageCapExceeded:{id:"TextMessageDisplay.gptUsageCapExceeded",defaultMessage:"You've reached the current usage cap for GPT-4. You can continue with the default model now, or try again {formattedTime}. <link>Learn more</link>"},gptUsageCapExceededCustomFeature:{id:"TextMessageDisplay.gptUsageCapExceededCustomFeature",defaultMessage:"You've reached the current usage cap for GPT-4, please try again {formattedTime}. <link>Learn more</link>"},gptUsageCapExceededExpired:{id:"TextMessageDisplay.gptUsageCapExceededExpired",defaultMessage:"You previously reached your usage cap for GPT-4, but you can now try sending your message again"},buttonUseDefaultModel:{id:"TextMessageDisplay.buttonUseDefaultModel",defaultMessage:"Use default model"},buttonTryAgain:{id:"TextMessageDisplay.buttonTryAgain",defaultMessage:"Try again"}}),kl=({textdocId:t})=>{const e=ta(p=>p?.resolveTempTextdocId[t]??t),s=mn(e),a=na(e),i=Ts();if(!s)return null;const l=()=>{pn(e)},{title:h,type:u}=s;return o.jsx("div",{className:"flex w-full justify-end",children:o.jsx(gl,{textdocId:e,type:u,name:h,isFocused:a,isCanvasOpen:i,onClick:l,isInlinePreview:!0})})},El=({messages:t})=>{const[e]=t,s=e?.message.metadata?.canvas;return!s||s.user_message_type!=null?null:o.jsx(o.Fragment,{children:s.pasted_textdocs?.map(({tempId:a})=>o.jsx(kl,{textdocId:a},a))})};function wr(){return ls(us.DataAnalysisV2)}function Eh(){const t=Tt(),e=je();return e&&t&&!Vr(t)&&e.isEnterprisey()}function Mh(){return ls(us.ChartSerialization)}function Th(t,e){const s=t==="chart"?ze.HasSeenAdaInteractiveChart:ze.HasSeenAdaInteractiveTable,[a,i]=_.useState(Ve.getItem(s,{userId:e})??!1),l=_.useCallback(()=>{i(!0),Ve.setItem(s,!0,{userId:e})},[s,e]);return[a,l]}function jh(t){const[e,s]=_.useState([]),a=St(()=>{const i=j.resolveThreadId(t),l=j.getThreadCurrentLeafId(t);return j.getTree(i).getBranchFromLeaf(l)});return _.useEffect(()=>{const i=br(a);i.length!==e.length&&s(i)},[e.length,t,a]),e}function Ml(t){return St(()=>{const e=j.resolveThreadId(t),s=j.getThreadCurrentLeafId(t),i=j.getTree(e).getBranchFromLeaf(s);return br(i).length>0})}function Tl(t){const e=t.metadata?.aggregate_result?.messages.filter(Hc)??[];let s=0;const a=(t.metadata?.ada_visualizations??[]).map(l=>{let h=l;return l.type=="chart"&&(h={...l,fallback_image:e[s++]}),h}),i=(t.metadata?.attachments??[]).filter(l=>Rs(l.name)).map(l=>({type:"table",file_id:l.id??"",title:ra(l),file_name:l.name,context_connector_info:l.context_connector_info}));return[...a,...i]}function br(t){return t.filter(s=>s.message?.author.role==="tool"&&s.message?.author.name==="python"||(s.message?.metadata?.attachments??[]).length>0).flatMap(s=>Tl(s.message))}zr(t=>({selectedSpreadsheet:null,setSelectedSpreadsheet:e=>t({selectedSpreadsheet:e})}));async function jl(t,e,s){const a=await t.text(),{parse:i}=await He(async()=>{const{parse:h}=await import("./oeujip5i1ptrxie5.js");return{parse:h}},[]),l=i(a);return{content:{columnNames:l.shift(),columnTypes:l[0].map(()=>"string"),rows:l},file_name:e,download_url:s}}function Rl(t){const e=t[0].values.length,s=[];for(let a=0;a<e;a++){const i=t.map(l=>l.values[a]);s.push(i)}return s}function Rh(t){return an({queryKey:["ada-visualization","chart",t.file_id],queryFn:async()=>{const e=await Be.getFileDownloadLink(t.file_id);if(e.status===ds.Success){const a=await(await fetch(e.download_url)).json();return{content:{chart_type:a.type,title:a.title,labels:a.labels,datasets:a.datasets,x_label:a.x_label,y_label:a.y_label},file_name:e.file_name??"",download_url:e.download_url}}else throw new Error("Failed to download chart json from interpreter")}})}function Ah(t){return an({queryKey:["ada-visualization","table",t.file_id],queryFn:async()=>{if(t.file_name&&sa(t.file_name)){const e=await Be.getAdaExcelFileContents(t.file_id);return{content:e.sheets.map(s=>({name:s.name,columnNames:s.columns.map(a=>a.name),columnTypes:s.columns.map(()=>"string"),rows:Rl(s.columns)})),download_url:e.download_url,file_name:t.file_name}}else{const e=await Be.getFileDownloadLink(t.file_id);if(e.status===ds.Success){const s=await fetch(e.download_url);return jl(s,e.file_name??"",e.download_url)}else throw new Error("Failed to download from interpreter")}}})}function Al(t){const e=js(),s=Ml(t),a=wr();return s&&a&&!e.displayingSideBySideFeedback}const Nl=Qe(()=>He(()=>import("./hb1acr5sgcdia4kr.js").then(t=>t.A),__vite__mapDeps([38,1,2,3,5,6,8,21,26,29,39,40,18,41])).then(t=>t.default)),Bl=Fe.div`flex gap-2 flex-wrap mt-1 max-w-[80%] justify-end`,Fl=Fe.div`flex flex-col gap-2`,Dl=({parts:t,attachments:e,isUserTurn:s,clientThreadId:a})=>{const i=oa(),l=wr(),h=aa.getImageAssetPointersFromParts(t),u=new Set(h.map(x=>ia(x.asset_pointer))),g=ca()||i,v=(e??[]).filter(x=>Rs(x.name)),w=(e??[]).filter(x=>x.id==null||u.has(x.id)?!1:l?!v.includes(x):!0);return(l?(w.length>0||v.length>0)&&s:w.length>0&&s)?o.jsxs(o.Fragment,{children:[o.jsx(Bl,{children:w.map(x=>o.jsx(la,{file:x.name,fileId:x.id,contextConnectorInfo:ua(x.context_connector_info),width:i?"normal":"wide",alwaysShowData:!0},x.id))}),l&&o.jsx(Fl,{className:re(!g&&"w-[80%]"),children:v.map(x=>o.jsx(Nl,{clientThreadId:a,visualization:da(x)},x.id))})]}):null};function Nh(t){return ha(t)&&!fa(t)}const gt=50,Pl=95;function Bh(t,e){if(t<=e)return t/e*gt;{const s=gt,a=Pl-gt,i=t-e,h=-(gt/e)/a;return s+a*(1-Math.exp(h*i))}}class Ul{mostRecentCompletionRequest;loggedRequests=new Set;onCompletionRequestStarted(e){this.mostRecentCompletionRequest={requestId:e,timestamp:Date.now()},this.loggedRequests.clear()}logEvent(e,s,a,i,l){const h=this.mostRecentCompletionRequest;if(h!=null&&!this.loggedRequests.has(e)){const p=j.getThreadConversationTurns(s,a).find(g=>g.messages.some(v=>v.message.id===a));p!=null&&p.messages.some(g=>g.nodeId===h.requestId)&&(U.logEvent(e,{messageId:a,timeMs:Date.now()-h.timestamp,...i}),l?.(),this.loggedRequests.add(e))}}}const sn=new Ul;function Ol(t){return(t.find(i=>i.message.metadata?.image_search_results!==void 0)?.message.metadata?.image_search_results??[]).slice(0,5)}function Ll({messages:t}){const e=Ol(t),s=ma();return e.length===0?null:o.jsx("div",{className:re({"mb-2":!0,"grid grid-flow-col gap-3":e.length>1,"w-1/3":e.length===1}),children:e.filter(({contentUrl:a})=>s.has(a)).map((a,i)=>o.jsx("a",{href:a.hostPageUrl,target:"_blank",rel:"noreferrer",children:o.jsx("img",{src:a.contentUrl,alt:a.name,className:"aspect-square rounded-xl object-cover"})},i))})}function Cr({attachments:t,citations:e,contentReferences:s,className:a,clientThreadId:i,displayParts:l,isCompletionInProgress:h,id:u,isActivelyStreaming:p,isUserTurn:g,turnIndex:v,isFeedbackEnabled:w,messages:f,onRequestMoreCompletions:x,parts:b,prevGroupedMessageType:S,prevGroupedMessages:k,showEditButton:B,onEnterEdit:D,size:I="medium"}){const M=As(),A=f.length>1,{flagSeverity:F,shouldHideContent:W}=bn(A?void 0:f[0]),P=!b.some(q=>q!==""),L=f[0].message.metadata?.targeted_reply_label??f[0].message.metadata?.targeted_reply;return _.useEffect(()=>{const q=f[0].message;if(q.author.metadata?.real_author===`tool:${pa.SEARCHGPT}`&&!P){const J=q.metadata?.search_source;sn.logEvent(O.searchToolRequestTimeToFirstTextToken,i,q.id,{search_source:J},()=>{J===Kr.InstantQuery&&Qr.logEvent(O.searchToolPageLoadTimeToFirstTextToken,{message_id:q.id})})}},[i,P,f]),_.useEffect(()=>{if(!P)switch(S){case tn.Browsing:sn.logEvent(O.browsingTimeToFirstTextToken,i,f[0].message.id);break}},[P,f,i,S]),o.jsxs("div",{"data-message-author-role":f[0].message.author.role,"data-message-id":f[0].message.id,dir:"auto",className:re(a,"text-message flex w-full flex-col items-end gap-2 whitespace-normal break-words [.text-message+&]:mt-5"),"data-message-model-slug":f[0].message.metadata?.model_slug,children:[L&&o.jsxs("div",{className:"mb-1 ml-6 mt-1 flex items-start gap-1.5 text-sm font-normal text-token-text-tertiary sm:ml-7 lg:ml-8",children:[o.jsx(hc,{className:"icon-md mt-1 shrink-0"}),o.jsx("p",{className:"mr-2 line-clamp-3",children:L})]}),g&&M&&o.jsx(El,{messages:f}),o.jsx(ga,{messages:f}),o.jsx(Wl,{parts:b,attachments:t,isUserTurn:g,isCompletionInProgress:h,turnIndex:v,displayParts:l,isActivelyStreaming:p,shouldHideContent:W,showEditButton:B,onEnterEdit:D,clientThreadId:i,id:u,isEmpty:P,prevGroupedMessageType:S,prevGroupedMessages:k,flagSeverity:F,messages:f,citations:e,contentReferences:s,size:I}),o.jsx(_l,{message:A?void 0:f[0],id:u,isFeedbackEnabled:w,onRequestMoreCompletions:x,clientThreadId:i,isUserTurn:g}),o.jsx(xa,{isUserTurn:g,message:A?void 0:f[0]}),!g&&!p&&k&&S===tn.SearchResult&&o.jsx(Ll,{messages:k})]})}function Wl({clientThreadId:t,id:e,displayParts:s,isCompletionInProgress:a,turnIndex:i,isActivelyStreaming:l,shouldHideContent:h,showEditButton:u=!1,onEnterEdit:p,isEmpty:g,prevGroupedMessageType:v,prevGroupedMessages:w,messages:f,citations:x,contentReferences:b,size:S,isUserTurn:k,parts:B,attachments:D}){const I=_e(),M=ya(s),[A,F]=_.useState({}),[W,P]=_.useState(!1),L=_a(),{streamingContext:q}=va();_.useEffect(()=>{L&&(q.setOnStylesUpdatedCallback(F),q.onStreamingChanged(a),q.setOnResetCallback(()=>P(!1)),a&&(P(!0),F(q.createTopLevelStyles())))},[L,a,q]);const J=wa(),ee=f[0].message.metadata?.gizmo_id,G=f[0].message.metadata?.serialization_metadata,z=Fc(f[0].message).length,X=_.useMemo(()=>({clientThreadId:t,messageId:e,turnIndex:i}),[t,e,i]),Q=ba(f[0].message),N=!!ee&&J.includes(ee),Y=_.useCallback(()=>{be.toggleChatThreadFlyout(t,i,e)},[t,i,e]),V=o.jsx(Dl,{parts:B,attachments:D,isUserTurn:k,clientThreadId:t},"files-and-tables"),ce=!!(D?.length||s.some(ue=>ue.type==="images")),R=Ca();function E(ue,H){const K=v===tn.CodeInterpreter?w?.map(Ue=>Ue.message):void 0,{text:le,contentReferences:oe}=Ia(H,x,b,N);let Re=oe;R&&(Re=oe.filter(Ue=>Ue.type!=="attribution"));const{processedText:he,displayedContentReferences:Ze}=ka(le,Re,l?void 0:K,!1,l),Me=f[0].message,Se=Me.metadata?.message_locale;let it=o.jsx(Ea,{clientThreadId:t,messageId:e,isStreamingOrProcessing:W,size:S,className:re(l&&!L&&"result-streaming",Q&&"headers-v2"),children:he===""?"&#8203;":he});if(Se!=null){const Ue=Yr(Se,!1);Ue!=null&&(it=o.jsx(Jr,{locale:Ue,children:it}))}return o.jsx(Ma.Provider,{value:{analyticsMetadata:X,message:Me,contentReferences:Ze,onShowSearchResults:Y,numImageResults:z,isActivelyStreaming:l,useSafeUrls:!0},children:it},ue)}const se=s.map((ue,H)=>{if(ue.type==="transcription"){const K=h?null:ue.text;let le=null;if(k&&h)le=o.jsx("span",{className:"italic opacity-30",children:o.jsx(T,{...xt.contentRemoved})});else if(k&&K!=null)le=K.trim().length===0?o.jsx("span",{className:"italic opacity-30",children:o.jsx(Ot,{text:I.formatMessage(xt.transcriptUnavailable),customSymbolOffsets:void 0})}):o.jsx("span",{className:"italic opacity-65",children:o.jsx(Ot,{text:`“${K.trim()}”`,customSymbolOffsets:void 0})});else if(!k&&K!=null)return E(H,K);return o.jsx(Lt,{containsImagesOrAttachments:ce,isUserTurn:k,showEditButton:u,onEnterEdit:p,children:le},H)}else if(ue.type==="text"){const K=h?null:ue.text;return!g&&!h&&!k?E(H,M):g&&l&&!k?L?o.jsx("div",{className:"pulsing-dot"},H):o.jsx("div",{className:"result-streaming",children:o.jsx("span",{children:o.jsx("pre",{})})},H):o.jsx(Lt,{containsImagesOrAttachments:ce,isUserTurn:k,showEditButton:u,onEnterEdit:p,children:k&&h?o.jsx("span",{className:"italic opacity-30",children:o.jsx(T,{...xt.contentRemoved})}):K?o.jsx(Ot,{text:K,customSymbolOffsets:G?.custom_symbol_offsets}):null},H)}else if(ue.type==="images"){const K=f[0].message.metadata?.attachments??[];return o.jsx(Sa,{assets:ue.imageAssets,attachments:K},H)}else return null}),Ce=s.findIndex(ue=>ue.type==="text");if(Ce!==-1?se.splice(Ce,0,V):se.push(V),h&&k)se.length=0,se.push(o.jsx(Lt,{containsImagesOrAttachments:ce,isUserTurn:k,onEnterEdit:Jt,children:o.jsx("span",{className:"italic opacity-30",children:o.jsx(T,{...xt.contentRemoved})})}));else if(h&&!k)return null;return o.jsx("div",{className:re("flex w-full flex-col gap-1 empty:hidden",k&&"items-end rtl:items-start",!k&&"first:pt-[3px]",W&&"streaming-response"),style:A,children:se})}const xt=ot({contentRemoved:{id:"textMessage.contentRemoved",defaultMessage:"Content removed"},transcriptUnavailable:{id:"textMessage.transcriptUnavailable",defaultMessage:"Transcript Unavailable"}});function Gl(t){const{isActivelyStreaming:e,...s}=t,a=Xr(),i=a?.includes("debug")??!1,l=t.messages[t.messages.length-1].message.id,[h,u]=_.useState([]),p=_.useRef(void 0);return p.current===void 0&&(p.current=a?.includes(Zr)??!1?new Ta(t.parts,u,e,void 0,{debug:i}):new ja(t.parts,u,e)),_.useEffect(()=>{p.current!=null&&(p.current.onMessagePartsUpdated(t.parts,e),p.current.isBuffering()&&Wt.addDelayedRenderingMessage(l))},[t.parts,l,e]),_.useEffect(()=>{p.current!=null&&!p.current.isBuffering()&&Wt.removeDelayedRenderingMessage(l)},[h,l]),_.useEffect(()=>()=>Wt.removeDelayedRenderingMessage(l),[l]),_.useEffect(()=>()=>{p.current!=null&&(p.current.destroy(),p.current=void 0)},[]),o.jsx(Cr,{...s,displayParts:h,isActivelyStreaming:e||p.current?.isBuffering()})}function $l({message:t,isCompletionInProgress:e,clientThreadId:s,className:a,isUserTurn:i,turnIndex:l,isFeedbackEnabled:h,prevGroupedMessageType:u,prevGroupedMessages:p,showEditButton:g,onEnterEdit:v,onRequestMoreCompletions:w}){const f=_.useMemo(()=>"parts"in t.message.content?t.message.content.parts:[Ra(t.message)],[t]);return o.jsx(ql,{parts:f,messages:[t],isCompletionInProgress:e,className:a,citations:t.message.metadata?.citations,contentReferences:t.message.metadata?.content_references,attachments:t.message.metadata?.attachments,isUserTurn:i,turnIndex:l,id:t.nodeId,isFeedbackEnabled:h,onRequestMoreCompletions:w,clientThreadId:s,showEditButton:g,onEnterEdit:v,prevGroupedMessageType:u,prevGroupedMessages:p})}const Vn=Ge.memo($l);function ql(t){const e=t.messages.length>1,{flagSeverity:s}=bn(e?void 0:t.messages[0]),a=s!=="danger"&&t.isCompletionInProgress,i=!t.parts.some(h=>h!==""),[l]=_.useState(()=>!t.isUserTurn&&(t.isCompletionInProgress||i));return l?o.jsx(Gl,{...t,isActivelyStreaming:a}):o.jsx(Cr,{...t,displayParts:Aa({isUserTurn:t.isUserTurn,parts:t.parts}),isActivelyStreaming:a})}const Sr=Na.DesktopBrowserExtensionAnnouncement,Hl=5,Ir="https://chromewebstore.google.com/detail/searchgpt/ejcfepkfckglbgocfkanmcdngdijcgld";function Fh({onClose:t}){_.useEffect(()=>{U.logEventWithStatsig(O.chatgptBrowserExtensionAnnouncementShown,"chatgpt_browser_extension_announcement_shown")},[]);const{markAsViewed:e}=Ns(Sr),s=_.useCallback(()=>{e(),U.logEventWithStatsig(O.chatgptBrowserExtensionAnnouncementClosed,"chatgpt_browser_extension_announcement_closed"),t&&t()},[e,t]),a=_.useCallback(()=>{U.logEventWithStatsig(O.chatgptBrowserExtensionAnnouncementCTAClicked,"chatgpt_browser_extension_announcement_cta_clicked"),e(),t&&t()},[e,t]);return o.jsx(zl,{downloadUrl:Ir,handleCTAClicked:a,handleClose:s})}function zl({downloadUrl:t,handleCTAClicked:e,handleClose:s}){const a=()=>{e(),window.open(t)},i=o.jsxs("div",{className:"flex-grow",children:[o.jsx("div",{className:"mb-0.5 font-semibold",children:o.jsx(T,{id:"uAZwaE",defaultMessage:"Use ChatGPT for every search"})}),o.jsx("span",{className:"text-token-text-secondary",children:o.jsx(T,{id:"+wTq4L",defaultMessage:"Download the Chrome extension to switch your default search engine to ChatGPT, and get instant answers from trusted sources with every search."})})]});return o.jsx(Ba,{onPrimaryCtaClick:a,primaryCtaText:o.jsx(T,{id:"x9mKG0",defaultMessage:"Get Extension"}),onDismiss:s,content:i})}function Dh(t){const{value:e}=cn("2634628831"),{eligible:s,isLoading:a}=Ns(Sr),i=hs(()=>document.documentElement.dataset.searchExtension==="1"),l=fr(t.clientThreadId,fs.Search),h=Vl();return{eligible:!(!e||i||!s||!l||!Bs()||!h||t.conversationMode?.kind!==ke.PrimaryAssistant),isLoading:a}}function Ph(t){const e=Ve.getItem(ze.SearchSettings)??{};e.hasSearchedMinTimes||(e.searchMessageIds||(e.searchMessageIds=[]),e.searchMessageIds.includes(t)||(e.searchMessageIds.push(t),e.searchMessageIds.length>=Hl&&(e.hasSearchedMinTimes=!0,delete e.searchMessageIds),Ve.setItem(ze.SearchSettings,e)))}function Vl(){return(Ve.getItem(ze.SearchSettings)??{}).hasSearchedMinTimes===!0}const Kl=({children:t})=>{const e=Fs();return e?.length?o.jsxs(ne.Root,{children:[o.jsx(ne.Trigger,{className:"h-10 px-2",children:t}),o.jsx(ne.Content,{align:"end",onCloseAutoFocus:s=>s.preventDefault(),children:e.map(s=>o.jsx(Ql,{textdocId:s},s))})]}):null},Ql=({textdocId:t})=>{const e=ms(mn(t));return o.jsx(ne.Item,{icon:At,onClick:()=>{Es.logButtonClick(Ms.FILE_DRAWER_ITEM),pn(e.textdocId)},children:e.title})},Yl=()=>{const t=_e(),e=Fs(),s=Ts();if(!e||s)return null;const a=e.length;return a===1?o.jsx(Jl,{textdocId:e[0]}):o.jsx(Kl,{children:o.jsx(Te,{label:t.formatMessage({id:"xX2Zyt",defaultMessage:"Open canvas"}),children:o.jsxs("div",{className:"flex items-center gap-1 text-token-text-secondary",children:[o.jsx(At,{className:"icon-xl-heavy"}),a]})})})},Jl=({textdocId:t})=>{const e=_e(),s=ms(mn(t));return o.jsx(Te,{label:e.formatMessage({id:"xX2Zyt",defaultMessage:"Open canvas"}),children:o.jsx(dt,{onClick:()=>pn(s.textdocId),icon:At})})},kr={...eo},Xl=kr.useInsertionEffect,Zl=Xl||(t=>t());function Er(t){const e=_.useRef(()=>{});return Zl(()=>{e.current=t}),_.useCallback(function(){for(var s=arguments.length,a=new Array(s),i=0;i<s;i++)a[i]=arguments[i];return e.current==null?void 0:e.current(...a)},[])}var rn=typeof document<"u"?_.useLayoutEffect:_.useEffect;let Kn=!1,eu=0;const Qn=()=>"floating-ui-"+Math.random().toString(36).slice(2,6)+eu++;function tu(){const[t,e]=_.useState(()=>Kn?Qn():void 0);return rn(()=>{t==null&&e(Qn())},[]),_.useEffect(()=>{Kn=!0},[]),t}const nu=kr.useId,su=nu||tu;function ru(){const t=new Map;return{emit(e,s){var a;(a=t.get(e))==null||a.forEach(i=>i(s))},on(e,s){t.set(e,[...t.get(e)||[],s])},off(e,s){var a;t.set(e,((a=t.get(e))==null?void 0:a.filter(i=>i!==s))||[])}}}const ou=_.createContext(null),au=_.createContext(null),iu=()=>{var t;return((t=_.useContext(ou))==null?void 0:t.id)||null},cu=()=>_.useContext(au),lu="data-floating-ui-focusable";function uu(t){const{open:e=!1,onOpenChange:s,elements:a}=t,i=su(),l=_.useRef({}),[h]=_.useState(()=>ru()),u=iu()!=null,[p,g]=_.useState(a.reference),v=Er((x,b,S)=>{l.current.openEvent=x?b:void 0,h.emit("openchange",{open:x,event:b,reason:S,nested:u}),s?.(x,b,S)}),w=_.useMemo(()=>({setPositionReference:g}),[]),f=_.useMemo(()=>({reference:p||a.reference||null,floating:a.floating||null,domReference:a.reference}),[p,a.reference,a.floating]);return _.useMemo(()=>({dataRef:l,open:e,onOpenChange:v,elements:f,events:h,floatingId:i,refs:w}),[e,v,f,h,i,w])}function du(t){t===void 0&&(t={});const{nodeId:e}=t,s=uu({...t,elements:{reference:null,floating:null,...t.elements}}),a=t.rootContext||s,i=a.elements,[l,h]=_.useState(null),[u,p]=_.useState(null),v=i?.reference||l,w=_.useRef(null),f=cu();rn(()=>{v&&(w.current=v)},[v]);const x=Fa({...t,elements:{...i,...u&&{reference:u}}}),b=_.useCallback(I=>{const M=mt(I)?{getBoundingClientRect:()=>I.getBoundingClientRect(),contextElement:I}:I;p(M),x.refs.setReference(M)},[x.refs]),S=_.useCallback(I=>{(mt(I)||I===null)&&(w.current=I,h(I)),(mt(x.refs.reference.current)||x.refs.reference.current===null||I!==null&&!mt(I))&&x.refs.setReference(I)},[x.refs]),k=_.useMemo(()=>({...x.refs,setReference:S,setPositionReference:b,domReference:w}),[x.refs,S,b]),B=_.useMemo(()=>({...x.elements,domReference:v}),[x.elements,v]),D=_.useMemo(()=>({...x,...a,refs:k,elements:B,nodeId:e}),[x,k,B,e,a]);return rn(()=>{a.dataRef.current.floatingContext=D;const I=f?.nodesRef.current.find(M=>M.id===e);I&&(I.context=D)}),_.useMemo(()=>({...x,context:D,refs:k,elements:B}),[x,k,B,D])}const Yn="active",Jn="selected";function Ht(t,e,s){const a=new Map,i=s==="item";let l=t;if(i&&t){const{[Yn]:h,[Jn]:u,...p}=t;l=p}return{...s==="floating"&&{tabIndex:-1,[lu]:""},...l,...e.map(h=>{const u=h?h[s]:null;return typeof u=="function"?t?u(t):null:u}).concat(t).reduce((h,u)=>(u&&Object.entries(u).forEach(p=>{let[g,v]=p;if(!(i&&[Yn,Jn].includes(g)))if(g.indexOf("on")===0){if(a.has(g)||a.set(g,[]),typeof v=="function"){var w;(w=a.get(g))==null||w.push(v),h[g]=function(){for(var f,x=arguments.length,b=new Array(x),S=0;S<x;S++)b[S]=arguments[S];return(f=a.get(g))==null?void 0:f.map(k=>k(...b)).find(k=>k!==void 0)}}}else h[g]=v}),h),{})}}function hu(t){t===void 0&&(t=[]);const e=t.map(u=>u?.reference),s=t.map(u=>u?.floating),a=t.map(u=>u?.item),i=_.useCallback(u=>Ht(u,t,"reference"),e),l=_.useCallback(u=>Ht(u,t,"floating"),s),h=_.useCallback(u=>Ht(u,t,"item"),a);return _.useMemo(()=>({getReferenceProps:i,getFloatingProps:l,getItemProps:h}),[i,l,h])}function Xn(t,e){return{...t,rects:{...t.rects,floating:{...t.rects.floating,height:e}}}}const fu=t=>({name:"inner",options:t,async fn(e){const{listRef:s,overflowRef:a,onFallbackChange:i,offset:l=0,index:h=0,minItemsVisible:u=4,referenceOverflowThreshold:p=0,scrollRef:g,...v}=Da(t,e),{rects:w,elements:{floating:f}}=e,x=s.current[h],b=g?.current||f,S=f.clientTop||b.clientTop,k=f.clientTop!==0,B=b.clientTop!==0,D=f===b;if(!x)return{};const I={...e,...await Ds(-x.offsetTop-f.clientTop-w.reference.height/2-x.offsetHeight/2-l).fn(e)},M=await Pt(Xn(I,b.scrollHeight+S+f.clientTop),v),A=await Pt(I,{...v,elementContext:"reference"}),F=Gt(0,M.top),W=I.y+F,P=Pa(Gt(0,b.scrollHeight+(k&&D||B?S*2:0)-F-Gt(0,M.bottom)));if(b.style.maxHeight=P+"px",b.scrollTop=F,i){const L=b.scrollHeight>b.offsetHeight&&b.offsetHeight<x.offsetHeight*u-1||A.top>=-p||A.bottom>=-p;$e.flushSync(()=>i(L))}return a&&(a.current=await Pt(Xn({...I,y:W},b.offsetHeight+S+f.clientTop),v)),{y:W}}});function mu(t,e){const{open:s,elements:a}=t,{enabled:i=!0,overflowRef:l,scrollRef:h,onChange:u}=e,p=Er(u),g=_.useRef(!1),v=_.useRef(null),w=_.useRef(null);_.useEffect(()=>{if(!i)return;function x(S){if(S.ctrlKey||!b||l.current==null)return;const k=S.deltaY,B=l.current.top>=-.5,D=l.current.bottom>=-.5,I=b.scrollHeight-b.clientHeight,M=k<0?-1:1,A=k<0?"max":"min";b.scrollHeight<=b.clientHeight||(!B&&k>0||!D&&k<0?(S.preventDefault(),$e.flushSync(()=>{p(F=>F+Math[A](k,I*M))})):/firefox/i.test(Ua())&&(b.scrollTop+=k))}const b=h?.current||a.floating;if(s&&b)return b.addEventListener("wheel",x),requestAnimationFrame(()=>{v.current=b.scrollTop,l.current!=null&&(w.current={...l.current})}),()=>{v.current=null,w.current=null,b.removeEventListener("wheel",x)}},[i,s,a.floating,l,h,p]);const f=_.useMemo(()=>({onKeyDown(){g.current=!0},onWheel(){g.current=!1},onPointerMove(){g.current=!1},onScroll(){const x=h?.current||a.floating;if(!(!l.current||!x||!g.current)){if(v.current!==null){const b=x.scrollTop-v.current;(l.current.bottom<-.5&&b<-1||l.current.top<-.5&&b>1)&&$e.flushSync(()=>p(S=>S+b))}requestAnimationFrame(()=>{v.current=x.scrollTop})}}}),[a.floating,p,l,h]);return _.useMemo(()=>i?{floating:f}:{},[i,f])}let at=_.createContext({styles:void 0,setReference:()=>{},setFloating:()=>{},getReferenceProps:()=>({}),getFloatingProps:()=>({}),slot:{}});at.displayName="FloatingContext";let Cn=_.createContext(null);Cn.displayName="PlacementContext";function pu(t){return _.useMemo(()=>t?typeof t=="string"?{to:t}:t:null,[t])}function gu(){return _.useContext(at).setReference}function xu(){return _.useContext(at).getReferenceProps}function yu(){let{getFloatingProps:t,slot:e}=_.useContext(at);return _.useCallback((...s)=>Object.assign({},t(...s),{"data-anchor":e.anchor}),[t,e])}function _u(t=null){t===!1&&(t=null),typeof t=="string"&&(t={to:t});let e=_.useContext(Cn),s=_.useMemo(()=>t,[JSON.stringify(t,(i,l)=>{var h;return(h=l?.outerHTML)!=null?h:l})]);qe(()=>{e?.(s??null)},[e,s]);let a=_.useContext(at);return _.useMemo(()=>[a.setFloating,t?a.styles:{}],[a.setFloating,t,a.styles])}let Zn=4;function vu({children:t,enabled:e=!0}){let[s,a]=_.useState(null),[i,l]=_.useState(0),h=_.useRef(null),[u,p]=_.useState(null);wu(u);let g=e&&s!==null&&u!==null,{to:v="bottom",gap:w=0,offset:f=0,padding:x=0,inner:b}=bu(s,u),[S,k="center"]=v.split(" ");qe(()=>{g&&l(0)},[g]);let{refs:B,floatingStyles:D,context:I}=du({open:g,placement:S==="selection"?k==="center"?"bottom":`bottom-${k}`:k==="center"?`${S}`:`${S}-${k}`,strategy:"absolute",transform:!1,middleware:[Ds({mainAxis:S==="selection"?0:w,crossAxis:f}),Oa({padding:x}),S!=="selection"&&La({padding:x}),S==="selection"&&b?fu({...b,padding:x,overflowRef:h,offset:i,minItemsVisible:Zn,referenceOverflowThreshold:x,onFallbackChange(J){var ee,G;if(!J)return;let z=I.elements.floating;if(!z)return;let X=parseFloat(getComputedStyle(z).scrollPaddingBottom)||0,Q=Math.min(Zn,z.childElementCount),N=0,Y=0;for(let V of(G=(ee=I.elements.floating)==null?void 0:ee.childNodes)!=null?G:[])if(V instanceof HTMLElement){let ce=V.offsetTop,R=ce+V.clientHeight+X,E=z.scrollTop,se=E+z.clientHeight;if(ce>=E&&R<=se)Q--;else{Y=Math.max(0,Math.min(R,se)-Math.max(ce,E)),N=V.clientHeight;break}}Q>=1&&l(V=>{let ce=N*Q-Y+X;return V>=ce?V:ce})}}):null,Wa({padding:x,apply({availableWidth:J,availableHeight:ee,elements:G}){Object.assign(G.floating.style,{overflow:"auto",maxWidth:`${J}px`,maxHeight:`min(var(--anchor-max-height, 100vh), ${ee}px)`})}})].filter(Boolean),whileElementsMounted:to}),[M=S,A=k]=I.placement.split("-");S==="selection"&&(M="selection");let F=_.useMemo(()=>({anchor:[M,A].filter(Boolean).join(" ")}),[M,A]),W=mu(I,{overflowRef:h,onChange:l}),{getReferenceProps:P,getFloatingProps:L}=hu([W]),q=ge(J=>{p(J),B.setFloating(J)});return _.createElement(Cn.Provider,{value:a},_.createElement(at.Provider,{value:{setFloating:q,setReference:B.setReference,styles:D,getReferenceProps:P,getFloatingProps:L,slot:F}},t))}function wu(t){qe(()=>{if(!t)return;let e=new MutationObserver(()=>{let s=window.getComputedStyle(t).maxHeight,a=parseFloat(s);if(isNaN(a))return;let i=parseInt(s);isNaN(i)||a!==i&&(t.style.maxHeight=`${Math.ceil(a)}px`)});return e.observe(t,{attributes:!0,attributeFilter:["style"]}),()=>{e.disconnect()}},[t])}function bu(t,e){var s,a,i;let l=zt((s=t?.gap)!=null?s:"var(--anchor-gap, 0)",e),h=zt((a=t?.offset)!=null?a:"var(--anchor-offset, 0)",e),u=zt((i=t?.padding)!=null?i:"var(--anchor-padding, 0)",e);return{...t,gap:l,offset:h,padding:u}}function zt(t,e,s=void 0){let a=Ps(),i=ge((p,g)=>{if(p==null)return[s,null];if(typeof p=="number")return[p,null];if(typeof p=="string"){if(!g)return[s,null];let v=es(p,g);return[v,w=>{let f=Mr(p);{let x=f.map(b=>window.getComputedStyle(g).getPropertyValue(b));a.requestAnimationFrame(function b(){a.nextFrame(b);let S=!1;for(let[B,D]of f.entries()){let I=window.getComputedStyle(g).getPropertyValue(D);if(x[B]!==I){x[B]=I,S=!0;break}}if(!S)return;let k=es(p,g);v!==k&&(w(k),v=k)})}return a.dispose}]}return[s,null]}),l=_.useMemo(()=>i(t,e)[0],[t,e]),[h=l,u]=_.useState();return qe(()=>{let[p,g]=i(t,e);if(u(p),!!g)return g(u)},[t,e]),h}function Mr(t){let e=/var\((.*)\)/.exec(t);if(e){let s=e[1].indexOf(",");if(s===-1)return[e[1]];let a=e[1].slice(0,s).trim(),i=e[1].slice(s+1).trim();return i?[a,...Mr(i)]:[a]}return[]}function es(t,e){let s=document.createElement("div");e.appendChild(s),s.style.setProperty("margin-top","0px","important"),s.style.setProperty("margin-top",t,"important");let a=parseFloat(window.getComputedStyle(s).marginTop)||0;return e.removeChild(s),a}var Cu=(t=>(t[t.Open=0]="Open",t[t.Closed=1]="Closed",t))(Cu||{}),Su=(t=>(t[t.Pointer=0]="Pointer",t[t.Other=1]="Other",t))(Su||{}),Iu=(t=>(t[t.OpenMenu=0]="OpenMenu",t[t.CloseMenu=1]="CloseMenu",t[t.GoToItem=2]="GoToItem",t[t.Search=3]="Search",t[t.ClearSearch=4]="ClearSearch",t[t.RegisterItem=5]="RegisterItem",t[t.UnregisterItem=6]="UnregisterItem",t[t.SetButtonElement=7]="SetButtonElement",t[t.SetItemsElement=8]="SetItemsElement",t))(Iu||{});function Vt(t,e=s=>s){let s=t.activeItemIndex!==null?t.items[t.activeItemIndex]:null,a=pi(e(t.items.slice()),l=>l.dataRef.current.domRef.current),i=s?a.indexOf(s):null;return i===-1&&(i=null),{items:a,activeItemIndex:i}}let ku={1(t){return t.menuState===1?t:{...t,activeItemIndex:null,menuState:1}},0(t){return t.menuState===0?t:{...t,__demoMode:!1,menuState:0}},2:(t,e)=>{var s,a,i,l,h;if(t.menuState===1)return t;let u={...t,searchQuery:"",activationTrigger:(s=e.trigger)!=null?s:1,__demoMode:!1};if(e.focus===ye.Nothing)return{...u,activeItemIndex:null};if(e.focus===ye.Specific)return{...u,activeItemIndex:t.items.findIndex(v=>v.id===e.id)};if(e.focus===ye.Previous){let v=t.activeItemIndex;if(v!==null){let w=t.items[v].dataRef.current.domRef,f=$t(e,{resolveItems:()=>t.items,resolveActiveIndex:()=>t.activeItemIndex,resolveId:x=>x.id,resolveDisabled:x=>x.dataRef.current.disabled});if(f!==null){let x=t.items[f].dataRef.current.domRef;if(((a=w.current)==null?void 0:a.previousElementSibling)===x.current||((i=x.current)==null?void 0:i.previousElementSibling)===null)return{...u,activeItemIndex:f}}}}else if(e.focus===ye.Next){let v=t.activeItemIndex;if(v!==null){let w=t.items[v].dataRef.current.domRef,f=$t(e,{resolveItems:()=>t.items,resolveActiveIndex:()=>t.activeItemIndex,resolveId:x=>x.id,resolveDisabled:x=>x.dataRef.current.disabled});if(f!==null){let x=t.items[f].dataRef.current.domRef;if(((l=w.current)==null?void 0:l.nextElementSibling)===x.current||((h=x.current)==null?void 0:h.nextElementSibling)===null)return{...u,activeItemIndex:f}}}}let p=Vt(t),g=$t(e,{resolveItems:()=>p.items,resolveActiveIndex:()=>p.activeItemIndex,resolveId:v=>v.id,resolveDisabled:v=>v.dataRef.current.disabled});return{...u,...p,activeItemIndex:g}},3:(t,e)=>{let s=t.searchQuery!==""?0:1,a=t.searchQuery+e.value.toLowerCase(),i=(t.activeItemIndex!==null?t.items.slice(t.activeItemIndex+s).concat(t.items.slice(0,t.activeItemIndex+s)):t.items).find(h=>{var u;return((u=h.dataRef.current.textValue)==null?void 0:u.startsWith(a))&&!h.dataRef.current.disabled}),l=i?t.items.indexOf(i):-1;return l===-1||l===t.activeItemIndex?{...t,searchQuery:a}:{...t,searchQuery:a,activeItemIndex:l,activationTrigger:1}},4(t){return t.searchQuery===""?t:{...t,searchQuery:"",searchActiveItemIndex:null}},5:(t,e)=>{let s=Vt(t,a=>[...a,{id:e.id,dataRef:e.dataRef}]);return{...t,...s}},6:(t,e)=>{let s=Vt(t,a=>{let i=a.findIndex(l=>l.id===e.id);return i!==-1&&a.splice(i,1),a});return{...t,...s,activationTrigger:1}},7:(t,e)=>t.buttonElement===e.element?t:{...t,buttonElement:e.element},8:(t,e)=>t.itemsElement===e.element?t:{...t,itemsElement:e.element}},Sn=_.createContext(null);Sn.displayName="MenuContext";function Nt(t){let e=_.useContext(Sn);if(e===null){let s=new Error(`<${t} /> is missing a parent <Menu /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(s,Nt),s}return e}function Eu(t,e){return Us(e.type,ku,t,e)}let Mu=_.Fragment;function Tu(t,e){let{__demoMode:s=!1,...a}=t,i=_.useReducer(Eu,{__demoMode:s,menuState:s?0:1,buttonElement:null,itemsElement:null,items:[],searchQuery:"",activeItemIndex:null,activationTrigger:1}),[{menuState:l,itemsElement:h,buttonElement:u},p]=i,g=jt(e);Ga(l===0,[u,h],(x,b)=>{p({type:1}),$a(b,qa.Loose)||(x.preventDefault(),u?.focus())});let v=ge(()=>{p({type:1})}),w=_.useMemo(()=>({open:l===0,close:v}),[l,v]),f={ref:g};return Ge.createElement(vu,null,Ge.createElement(Sn.Provider,{value:i},Ge.createElement(Ha,{value:Us(l,{0:bt.Open,1:bt.Closed})},Xe({ourProps:f,theirProps:a,slot:w,defaultTag:Mu,name:"Menu"}))))}let ju="button";function Ru(t,e){var s;let a=_.useId(),{id:i=`headlessui-menu-button-${a}`,disabled:l=!1,autoFocus:h=!1,...u}=t,[p,g]=Nt("Menu.Button"),v=xu(),w=za(),f=jt(e,gu(),ge(P=>g({type:7,element:P}))),x=ge(P=>{switch(P.key){case pe.Space:case pe.Enter:case pe.ArrowDown:P.preventDefault(),P.stopPropagation(),$e.flushSync(()=>g({type:0})),g({type:2,focus:ye.First});break;case pe.ArrowUp:P.preventDefault(),P.stopPropagation(),$e.flushSync(()=>g({type:0})),g({type:2,focus:ye.Last});break}}),b=ge(P=>{switch(P.key){case pe.Space:P.preventDefault();break}}),S=ge(P=>{var L;if(Va(P.currentTarget))return P.preventDefault();l||(p.menuState===0?($e.flushSync(()=>g({type:1})),(L=p.buttonElement)==null||L.focus({preventScroll:!0})):(P.preventDefault(),g({type:0})))}),{isFocusVisible:k,focusProps:B}=Ka({autoFocus:h}),{isHovered:D,hoverProps:I}=Qa({isDisabled:l}),{pressed:M,pressProps:A}=Ya({disabled:l}),F=_.useMemo(()=>({open:p.menuState===0,active:M||p.menuState===0,disabled:l,hover:D,focus:k,autofocus:h}),[p,D,k,M,l,h]),W=Os(v(),{ref:f,id:i,type:Ja(t,p.buttonElement),"aria-haspopup":"menu","aria-controls":(s=p.itemsElement)==null?void 0:s.id,"aria-expanded":p.menuState===0,disabled:l||void 0,autoFocus:h,onKeyDown:x,onKeyUp:b,onClick:S},B,I,A);return Xe({mergeRefs:w,ourProps:W,theirProps:u,slot:F,defaultTag:ju,name:"Menu.Button"})}let Au="div",Nu=Pn.RenderStrategy|Pn.Static;function Bu(t,e){var s,a;let i=_.useId(),{id:l=`headlessui-menu-items-${i}`,anchor:h,portal:u=!1,modal:p=!0,transition:g=!1,...v}=t,w=pu(h),[f,x]=Nt("Menu.Items"),[b,S]=_u(w),k=yu(),[B,D]=_.useState(null),I=jt(e,w?b:null,ge(N=>x({type:8,element:N})),D),M=Xa(f.itemsElement);w&&(u=!0);let A=Za(),[F,W]=ei(g,B,A!==null?(A&bt.Open)===bt.Open:f.menuState===0);ti(F,f.buttonElement,()=>{x({type:1})});let P=f.__demoMode?!1:p&&f.menuState===0;ni(P,M);let L=f.__demoMode?!1:p&&f.menuState===0;si(L,{allowed:_.useCallback(()=>[f.buttonElement,f.itemsElement],[f.buttonElement,f.itemsElement])});let q=f.menuState!==0,J=ri(q,f.buttonElement)?!1:F;_.useEffect(()=>{let N=f.itemsElement;N&&f.menuState===0&&N!==M?.activeElement&&N.focus({preventScroll:!0})},[f.menuState,f.itemsElement,M]),oi(f.menuState===0,{container:f.itemsElement,accept(N){return N.getAttribute("role")==="menuitem"?NodeFilter.FILTER_REJECT:N.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(N){N.setAttribute("role","none")}});let ee=Ps(),G=ge(N=>{var Y,V,ce;switch(ee.dispose(),N.key){case pe.Space:if(f.searchQuery!=="")return N.preventDefault(),N.stopPropagation(),x({type:3,value:N.key});case pe.Enter:if(N.preventDefault(),N.stopPropagation(),x({type:1}),f.activeItemIndex!==null){let{dataRef:R}=f.items[f.activeItemIndex];(V=(Y=R.current)==null?void 0:Y.domRef.current)==null||V.click()}Ls(f.buttonElement);break;case pe.ArrowDown:return N.preventDefault(),N.stopPropagation(),x({type:2,focus:ye.Next});case pe.ArrowUp:return N.preventDefault(),N.stopPropagation(),x({type:2,focus:ye.Previous});case pe.Home:case pe.PageUp:return N.preventDefault(),N.stopPropagation(),x({type:2,focus:ye.First});case pe.End:case pe.PageDown:return N.preventDefault(),N.stopPropagation(),x({type:2,focus:ye.Last});case pe.Escape:N.preventDefault(),N.stopPropagation(),$e.flushSync(()=>x({type:1})),(ce=f.buttonElement)==null||ce.focus({preventScroll:!0});break;case pe.Tab:N.preventDefault(),N.stopPropagation(),$e.flushSync(()=>x({type:1})),ai(f.buttonElement,N.shiftKey?Un.Previous:Un.Next);break;default:N.key.length===1&&(x({type:3,value:N.key}),ee.setTimeout(()=>x({type:4}),350));break}}),z=ge(N=>{switch(N.key){case pe.Space:N.preventDefault();break}}),X=_.useMemo(()=>({open:f.menuState===0}),[f.menuState]),Q=Os(w?k():{},{"aria-activedescendant":f.activeItemIndex===null||(s=f.items[f.activeItemIndex])==null?void 0:s.id,"aria-labelledby":(a=f.buttonElement)==null?void 0:a.id,id:l,onKeyDown:G,onKeyUp:z,role:"menu",tabIndex:f.menuState===0?0:void 0,ref:I,style:{...v.style,...S,"--button-width":ii(f.buttonElement,!0).width},...ci(W)});return Ge.createElement(li,{enabled:u?t.static||F:!1},Xe({ourProps:Q,theirProps:v,slot:X,defaultTag:Au,features:Nu,visible:J,name:"Menu.Items"}))}let Fu=_.Fragment;function Du(t,e){let s=_.useId(),{id:a=`headlessui-menu-item-${s}`,disabled:i=!1,...l}=t,[h,u]=Nt("Menu.Item"),p=h.activeItemIndex!==null?h.items[h.activeItemIndex].id===a:!1,g=_.useRef(null),v=jt(e,g);qe(()=>{if(!h.__demoMode&&h.menuState===0&&p&&h.activationTrigger!==0)return ui().requestAnimationFrame(()=>{var L,q;(q=(L=g.current)==null?void 0:L.scrollIntoView)==null||q.call(L,{block:"nearest"})})},[h.__demoMode,g,p,h.menuState,h.activationTrigger,h.activeItemIndex]);let w=di(g),f=_.useRef({disabled:i,domRef:g,get textValue(){return w()}});qe(()=>{f.current.disabled=i},[f,i]),qe(()=>(u({type:5,id:a,dataRef:f}),()=>u({type:6,id:a})),[f,a]);let x=ge(()=>{u({type:1})}),b=ge(L=>{if(i)return L.preventDefault();u({type:1}),Ls(h.buttonElement)}),S=ge(()=>{if(i)return u({type:2,focus:ye.Nothing});u({type:2,focus:ye.Specific,id:a})}),k=hi(),B=ge(L=>{k.update(L),!i&&(p||u({type:2,focus:ye.Specific,id:a,trigger:0}))}),D=ge(L=>{k.wasMoved(L)&&(i||p||u({type:2,focus:ye.Specific,id:a,trigger:0}))}),I=ge(L=>{k.wasMoved(L)&&(i||p&&u({type:2,focus:ye.Nothing}))}),[M,A]=Ws(),[F,W]=fi(),P=_.useMemo(()=>({active:p,focus:p,disabled:i,close:x}),[p,i,x]);return Ge.createElement(A,null,Ge.createElement(W,null,Xe({ourProps:{id:a,ref:v,role:"menuitem",tabIndex:i===!0?void 0:-1,"aria-disabled":i===!0?!0:void 0,"aria-labelledby":M,"aria-describedby":F,disabled:void 0,onClick:b,onFocus:S,onPointerEnter:B,onMouseEnter:B,onPointerMove:D,onMouseMove:D,onPointerLeave:I,onMouseLeave:I},theirProps:l,slot:P,defaultTag:Fu,name:"Menu.Item"})))}let Pu="div";function Uu(t,e){let[s,a]=Ws();return Ge.createElement(a,null,Xe({ourProps:{ref:e,"aria-labelledby":s,role:"group"},theirProps:t,slot:{},defaultTag:Pu,name:"Menu.Section"}))}let Ou="header";function Lu(t,e){let s=_.useId(),{id:a=`headlessui-menu-heading-${s}`,...i}=t,l=mi();qe(()=>l.register(a),[a,l.register]);let h={id:a,ref:e,role:"presentation",...l.props};return Xe({ourProps:h,theirProps:i,slot:{},defaultTag:Ou,name:"Menu.Heading"})}let Wu="div";function Gu(t,e){return Xe({ourProps:{ref:e,role:"separator"},theirProps:t,slot:{},defaultTag:Wu,name:"Menu.Separator"})}let $u=Je(Tu),qu=Je(Ru),Hu=Je(Bu),zu=Je(Du),Vu=Je(Uu),Ku=Je(Lu),Qu=Je(Gu),lt=Object.assign($u,{Button:qu,Items:Hu,Item:zu,Section:Vu,Heading:Ku,Separator:Qu});function Yu({show:t,appear:e,children:s}){return o.jsx(gi,{as:_.Fragment,enter:"transition ease-out duration-200",enterFrom:"opacity-0 translate-y-1",enterTo:"opacity-100 translate-y-0",leave:"transition ease-in duration-150",leaveFrom:"opacity-100 translate-y-0",leaveTo:"opacity-0 translate-y-1",show:t,appear:e,children:s})}function Le({onClick:t,href:e,target:s,children:a,disabled:i,icon:l,testId:h}){const u=ht();return o.jsx(lt.Item,{disabled:i,children:({active:p})=>o.jsxs(Bt,{onClick:t,href:e,target:s,className:re({"bg-token-sidebar-surface-secondary":p,"hover:bg-token-sidebar-surface-secondary":!p&&!i||u}),"data-testid":h,children:[l&&o.jsx(l,{className:"icon-md"}),a]})})}function Ju({to:t,children:e,icon:s}){return o.jsx(lt.Item,{children:({active:a})=>o.jsx(no,{to:t,children:o.jsxs(Bt,{$as:"span",className:re(a?"bg-token-sidebar-surface-secondary":"cursor-pointer"),children:[s&&o.jsx(s,{className:"icon-md"}),e]})})})}Fe.a`p-2 rounded-md hover:bg-black/10 hover:dark:bg-white/10 cursor-pointer`;const Bt=Fe.a`flex gap-2 rounded p-2.5 text-sm cursor-pointer focus:ring-0 hover:bg-token-main-surface-secondary radix-disabled:pointer-events-none radix-disabled:opacity-50 group items-center`,Uh=Fe(Bt)`border dark:border-white/20 min-h-0 hover:bg-gray-500/10 h-10 rounded-lg border-[rgba(0,0,0,0.1)]`,on=Fe.div`h-px bg-token-border-light my-1.5`,Oh=Fe(Bt)`${t=>t.$active?"bg-token-sidebar-surface-secondary":"hover:bg-token-sidebar-surface-secondary"}`;function Tr({menuItemComponent:t}){const e=je(),s=Ye(),a=_.useCallback(()=>{U.logEvent(O.clickSidebarAccountPortalMenuItem),gn(s,"Sidebar account menu item")},[s]),{value:i}=cn("1028682714"),l=Qe(()=>He(()=>import("./sso-go45p84u2s30azkx.js").then(h=>h.M),__vite__mapDeps([42,1,2,3,43,5,6,21,8,29,27,44,26,45,46,47,48,49,50,51,18,52,28,53,54,55,56,22,23,57,58,59,60,15,61,25,20,62,63,19,64,65,66,67,68,69,70,71,72])).then(h=>h.default));return o.jsxs(o.Fragment,{children:[e?.hasPaidSubscription()&&(i?o.jsx(l,{handleClickCustomerPortal:a,menuItemComponent:t}):o.jsx(t,{onClick:a,icon:fc,children:o.jsx(T,{id:"popoverNavigation.myPlan",defaultMessage:"My plan"})})),e?.canInteractWithGizmos()&&o.jsx(t,{onClick:()=>{U.logEvent(O.accountMenuClickMyGPTs),s(mr())},icon:Ys,children:o.jsx(T,{id:"popoverNavigation.myGpts",defaultMessage:"My GPTs"})}),o.jsx(t,{icon:Js,onClick:()=>{be.openModal(Ke.UserContext),U.logEvent(O.accountMenuClickCustomizeChatGPT)},children:o.jsx(T,{id:"popoverNavigation.chatPreferences.1",defaultMessage:"Customize ChatGPT"})})]})}function jr({menuItemComponent:t,routedMenuItemComponent:e}){const s=je(),a=so("2756095923")?.value&&s?.isEdu()&&s?.isStandardUserOfAccount();return o.jsxs(o.Fragment,{children:[!a&&o.jsx(e,{to:"/admin",icon:mc,children:o.jsx(T,{...Kt.myWorkspaceSettings})}),o.jsx(e,{to:mr(),onClick:()=>{U.logEvent(O.accountMenuClickMyGPTs)},icon:Ys,children:o.jsx(T,{...Kt.myGpts})}),o.jsx(t,{onClick:()=>{be.openModal(Ke.UserContext),U.logEvent(O.accountMenuClickCustomizeChatGPT)},icon:Js,children:o.jsx(T,{...Kt.chatPreferences})})]})}const Kt=ot({myWorkspaceSettings:{id:"workspacePopoverNavigation.myWorkspaceSettings",defaultMessage:"Manage workspace"},chatPreferences:{id:"B4s/Jz",defaultMessage:"Customize ChatGPT"},myGpts:{id:"workspacePopoverNavigation.myGpts",defaultMessage:"My GPTs"}}),Xu=Qe(()=>He(()=>import("./g9ajqtukvv4jsver.js"),__vite__mapDeps([73,1,2,3,25,5,6,23,21,8,74,75,59,60,15,26])));function Lh({onClickSettings:t}){const e=ht();return o.jsxs(lt,{as:"div",className:re(!e&&"group relative"),children:[o.jsx(nd,{}),o.jsx(Yu,{children:o.jsx(lt.Items,{className:re("popover absolute bottom-full z-50 mb-1 overflow-hidden rounded-lg border border-token-border-light bg-token-main-surface-primary p-1.5 shadow-lg outline-none",e&&"left-3 w-[var(--screen-sidebar-popover-min-width)]",!e&&"left-0 w-full"),children:o.jsx(td,{onClickSettings:t})})})]})}function Rr(){const t=!je()?.isEnterprisey()&&!xs,e=_e(),s=Tt(),a=Ye();return s?o.jsxs("div",{className:"flex items-center justify-between gap-2 py-2 pl-5 pr-4",children:[o.jsx("div",{className:"text-sm text-token-text-secondary",children:s?.email}),t&&o.jsx(Te,{label:e.formatMessage(Pe.addWorkspaceTooltip),side:"right",children:o.jsx("button",{onClick:()=>gn(a,"profile menu"),children:o.jsx(vc,{className:"icon-sm text-token-text-primary"})})})]}):null}function Zu(){const t=je();return t==null?o.jsx(o.Fragment,{children:o.jsx("div",{className:"w-full px-3 py-2",children:o.jsx(vt,{})})}):o.jsxs(o.Fragment,{children:[o.jsx(Rr,{}),o.jsx("div",{className:"flex h-11 w-full items-center justify-start gap-3 px-3 py-1 text-sm",children:o.jsx(Nr,{workspace:t,isLoading:!1,currentWorkspaceId:t.id,showCheck:!1})})]})}function Ar({menuItemComponent:t}){const e=Rt(),s=ut(),{data:a}=Mt(),i=je(),[l,h]=_.useState(!1),u=Tt(),p=_e(),g=ln();if(!i||!a)return null;const v=i.isWorkspaceAccount(),w=a.accountItems.length>1,f=a.accountItems,x=xi([f.find(S=>S.isPersonalAccount()),...f.filter(S=>!S.isPersonalAccount())]);if(x.sort((S,k)=>S.isPersonalAccount()?1:k.isPersonalAccount()?-1:0),!w)return v?o.jsx(Zu,{}):o.jsx(o.Fragment,{children:o.jsx("div",{className:"ml-3 mr-2 py-2 text-sm text-token-text-secondary",children:u?.email})});const b=x.map(S=>o.jsx(t,{disabled:S.isDeactivated(),onClick:()=>{if(S.isDeactivated()||S.id===i?.id)return;h(!0);const{willRedirect:k}=ro(s,S.id,e,p,g);k||oo()},className:"radix-disabled:pointer-events-auto radix-disabled:hover:bg-transparent",children:S.isDeactivated()?o.jsx(ed,{workspace:S,isLoading:l}):o.jsx(Nr,{workspace:S,isLoading:l,currentWorkspaceId:i?.id})},S.id));return o.jsxs(o.Fragment,{children:[o.jsx(Rr,{}),o.jsx(ne.Separator,{}),b]})}function Nr({workspace:t,isLoading:e,currentWorkspaceId:s,showCheck:a=!0}){const i=t.canAccessWithCurrentSession,l=!e&&a&&t.id===s;return o.jsxs("div",{children:[o.jsxs("div",{className:"flex w-full items-center gap-2.5",children:[o.jsx("span",{className:"flex h-5 w-5 items-center justify-center",children:o.jsx(xn,{iconSize:"small",workspace:t,className:re({"flex-shrink-0":!0})})}),o.jsx("div",{className:"line-clamp-1 text-token-text-primary",children:Gs(_e(),t)}),e&&o.jsx(vt,{}),l&&o.jsx("span",{className:"text-token-text-primary",children:o.jsx(pc,{className:"icon-sm"})}),!i&&o.jsx("span",{className:"text-token-text-primary",children:o.jsx(gc,{className:"icon-sm"})})]}),!i&&o.jsx("div",{className:"rowDivClassName",children:o.jsx("small",{className:"text-token-text-secondary",children:o.jsx(T,{...t.ssoConnectionName?Pe.authenticateWithSSOToAccessWorkspace:Pe.authenticateWithoutSSOToAccessWorkspace})})})]})}function ed({workspace:t,isLoading:e}){const s=_e(),a=t.isOwnerOfAccount(),[i,l]=_.useState(!1),h=Mc(t.id);return _.useEffect(()=>{h!=null&&i&&(be.setPurchaseWorkspaceData({minimumSeats:Math.max(h,On),existingAccount:t}),l(!1))},[h,i,t]),o.jsxs(o.Fragment,{children:[o.jsxs(Te,{className:"flex w-full flex-1 items-center gap-2.5",label:s.formatMessage(Pe.disabledWorkspaceTooltip),sideOffset:20,side:"right",children:[o.jsx("span",{className:"flex h-5 w-5 items-center justify-center",children:o.jsx(xc,{className:"icon-sm flex-shrink-0 opacity-30"})}),o.jsx("div",{className:"truncate opacity-30",children:Gs(s,t)})]}),e&&o.jsx(vt,{}),!e&&o.jsxs(ne.Root,{children:[o.jsx(ne.Trigger,{className:"rounded text-center hover:bg-token-main-surface-secondary",children:o.jsx(yc,{className:"icon-sm m-1"})}),o.jsx(ne.Portal,{children:o.jsxs(ne.Content,{children:[a&&o.jsx(o.Fragment,{children:o.jsx(ne.Item,{onClick:()=>{h==null?l(!0):be.setPurchaseWorkspaceData({minimumSeats:Math.max(h,On),existingAccount:t})},children:i?o.jsx(vt,{}):o.jsx(T,{id:"navigation.reactivateWorkspace",defaultMessage:"Reactivate workspace"})})}),o.jsx(ne.Item,{onClick:()=>{be.setLeaveWorkspaceData(t)},children:o.jsx(T,{id:"navigation.leaveWorkspace",defaultMessage:"Leave workspace"})})]})})]})]})}function td({onClickSettings:t}){const{data:e}=Mt(),s=je(),a=$s(),i=or(),{openModal:l}=ar(),h=ps("3905879930");var u=s?.isTeam()??!1,p=!1;if(u&&(p=h.config.get("enabled",!1)),!s||!e)return null;const g=s.isWorkspaceAccount(),v=!a;return o.jsxs("nav",{children:[o.jsx(Ar,{menuItemComponent:Le}),o.jsx(on,{}),g?o.jsx(jr,{menuItemComponent:Le,routedMenuItemComponent:Ju}):o.jsx(Tr,{menuItemComponent:Le}),v&&o.jsx(Le,{href:yi(),target:"_blank",onClick:()=>{U.logEvent(O.clickFaqLink)},icon:_c,children:o.jsx(T,{...Pe.helpAndFaq})}),o.jsx(Le,{onClick:t,icon:Xs,testId:"accounts-settings-button",children:o.jsx(T,{...Pe.settings})}),u&&p&&o.jsxs(o.Fragment,{children:[o.jsx(Le,{onClick:()=>{be.openModal(Ke.InviteUsersToWorkspace),U.logEvent(O.accountMemberInviteButton,{location:"dropdown-menu-click"}),de.logEvent("chatgpt_invite_users_to_workspace",0,{action:"OpenAdminInviteModal",location:"dropdown-menu-click",text:"AddTeammates",step:"OpenModal"})},icon:Zs,children:o.jsx(T,{...Pe.addTeammatesButton})}),o.jsx(Xu,{workspace:s})]}),i&&o.jsx(sd,{openDownloadModal:l}),o.jsx(on,{}),o.jsx(Le,{onClick:()=>{U.logEvent(O.clickLogOut,{eventSource:"mouse"}),gs()},icon:er,children:o.jsx(T,{...Pe.logOut})})]})}function nd(){return Tt()?o.jsx(rd,{}):null}function sd({openDownloadModal:t}){return o.jsxs("span",{children:[o.jsx(on,{}),o.jsx(Le,{icon:tr,onClick:()=>{U.logEvent(O.accountMenuClickDownloadApp),t()},children:o.jsx(T,{...Pe.downloadApp})})]})}function rd(){const{data:t}=Mt(),e=je(),s=_i(),a=vi(),i=ht();if(!e||!t)return null;const l=e.isWorkspaceAccount(),h=t.accountItems.length>1;return o.jsxs(lt.Button,{className:re("flex w-full max-w-[100%] items-center gap-2 rounded-lg text-sm group-ui-open:bg-token-sidebar-surface-secondary",i&&"px-2 py-1 hover:bg-token-main-surface-secondary",!i&&"p-2 hover:bg-token-sidebar-surface-secondary"),"data-testid":"accounts-profile-button",children:[o.jsx("div",{className:"flex-shrink-0",children:o.jsx(xn,{iconSize:"gizmo"})}),o.jsxs("div",{className:"relative -top-px grow -space-y-px truncate text-start text-token-text-primary",children:[o.jsx("div",{dir:"auto",children:a}),l||h?o.jsx("div",{className:"truncate text-xs text-token-text-secondary",dir:"auto",children:s}):null]})]})}const Pe=ot({helpAndFaq:{id:"navigation.helpAndFaq",defaultMessage:"Help & FAQ"},settings:{id:"navigation.settings",defaultMessage:"Settings"},logOut:{id:"navigation.logOut",defaultMessage:"Log out"},accountSwitcherTitle:{id:"navigation.accountSwitcherTitle",defaultMessage:"Workspaces"},defaultWorkspaceTitle:{id:"useWorkspaces.defaultWorkspaceTitle",defaultMessage:"Untitled Workspace"},addWorkspaceTooltip:{id:"navigation.addWorkspaceTooltip",defaultMessage:"Create a Team workspace"},disabledWorkspaceTooltip:{id:"navigation.disabledWorkspaceTooltip",defaultMessage:"This workspace has been deactivated"},downloadApp:{id:"navigation.downloadMacApp",defaultMessage:"Download the macOS app"},authenticateWithSSOToAccessWorkspace:{id:"CV7pdM",defaultMessage:"Authenticate with SSO to access this workspace"},authenticateWithoutSSOToAccessWorkspace:{id:"zfCWFh",defaultMessage:"Authenticate without SSO to access this workspace"},addTeammatesButton:{id:"inviteMemberButton.inviteMemberButton",defaultMessage:"Add Teammates"}});function od(t){de.logEvent("chatgpt_web_thread_tap_new_thread"),Ve.getItem(ze.HasSeenNewChatModal)===!0?qs(t):(Ve.setItem(ze.HasSeenNewChatModal,!0),be.openModal(Ke.NoAuthNewChat))}function Wh(){return Tc(Ke.NoAuthNewChat)?o.jsx(ad,{onClose:()=>{be.closeModal(Ke.NoAuthNewChat)}}):null}function ad({onClose:t}){const e=Rt(),s=Ye(),a=ys("1934819688"),i=a.config.get("is_redesign_enabled",!1),l=a.config.get("secondary_button_type","cancel"),h=Hs(Ut.signUpButtonText),u=w=>{w.preventDefault(),e({authType:"signup",callback:f=>{de.logEvent("chatgpt_new_chat_modal_sign_up_link_clicked"),U.logSignUpButtonClicked({location:"New chat modal",provider:f})}})},p=w=>{w.preventDefault(),e({authType:"login",callback:f=>{de.logEvent("chatgpt_new_chat_modal_log_in_link_clicked"),U.logLogInButtonClicked({location:"New chat modal",provider:f})}})},g=()=>{de.logEvent("chatgpt_new_chat_modal_cancel_button_clicked"),U.logEvent(O.newChatModalCancelButtonClicked),t()},v=()=>{de.logEvent("chatgpt_new_chat_modal_new_chat_button_clicked"),U.logNewChatButtonClicked({location:"New Chat Modal New Chat Button"}),qs(s),t()};return _.useEffect(()=>{de.logEvent("chatgpt_new_chat_modal_shown"),U.logEvent(O.newChatModalShown)},[]),o.jsx(ao,{isOpen:!0,type:"success",onClose:t,noPadding:!0,size:"custom",className:"max-w-sm",children:o.jsxs("div",{className:"flex flex-col justify-center p-6",children:[o.jsxs("div",{className:"mb-2 grid w-full grid-cols-[1fr,auto,1fr] items-center",children:[o.jsx("div",{}),o.jsx("div",{className:"text-xl font-medium",children:o.jsx(T,{id:"d+R7z5",defaultMessage:"Clear current chat?"})}),o.jsx("div",{className:"flex justify-end",children:i?o.jsx(io,{onClick:t}):null})]}),o.jsx("p",{className:"mb-6 text-center text-token-text-secondary",children:o.jsx(T,{id:"+Olycu",defaultMessage:"To start a new chat, your current conversation will be discarded. <signup>Sign up</signup> or <login>log in</login> to save chats.",values:{signup:w=>o.jsx("a",{href:"#",className:"font-medium text-token-text-primary",onClick:u,children:w}),login:w=>o.jsx("a",{href:"#",className:"font-medium text-token-text-primary",onClick:p,children:w})}})}),o.jsx(De,{className:"mb-3",color:i?"primary":"danger",size:"giant",onClick:v,children:o.jsx(T,{id:"cBGbrD",defaultMessage:"Clear chat"})}),l==="cancel"?o.jsx(De,{size:"giant",onClick:g,color:"secondary",children:o.jsx(T,{...Ut.cancelButtonText})}):null,l==="login"?o.jsx(De,{size:"giant",onClick:()=>{e({authType:"login",callback:w=>{U.logLogInButtonClicked({location:"New chat modal",provider:w})}})},color:"ghost",children:o.jsx(T,{...Ut.logInButtonText})}):null,l==="signup"?o.jsx(De,{size:"giant",onClick:()=>{e({authType:"signup",callback:w=>{U.logSignUpButtonClicked({location:"New chat modal",provider:w})}})},color:"ghost",children:o.jsx(T,{...h})}):null]})})}function Br({clientThreadId:t,location:e}){const s=ut(),{id:a}=pr(t),i=dr(!0),l=Ye(),h=un(),u=co();return _.useCallback(()=>{dn(_s(s))?od(l):h?l({pathname:u.pathname,search:u.search},{state:wi()}):(i({modelId:a,location:e}),de.logEvent("chatgpt_web_thread_tap_new_thread"))},[s,e,a,i,l,h,u])}const id=["Not relevant","Out of date","Content is wrong"],cd=["Relevant","Up to date","Accurate"];function ld({citationMetadata:t,noBottomBorder:e=!1,sourceFeedback:s,setSourceFeedback:a}){const[i,l]=_.useMemo(()=>{if(t.type!=="file")return["",""];const g=t.name.split(".");return g.length>1?[g.slice(0,-1).join("."),g[g.length-1]]:[t.name,""]},[t]),h=_.useMemo(()=>zs(vs.GDRIVE,l),[l]),u=_.useMemo(()=>{if(t.type==="file"&&t.extra?.cloud_doc_url)try{return new URL(t.extra.cloud_doc_url).hostname}catch{return}},[t]),p=_.useCallback(g=>{a({rating:g,tags:[]})},[a]);return t.type!=="file"?null:o.jsxs(o.Fragment,{children:[o.jsxs("div",{className:"flex flex-row items-center justify-between py-2",children:[o.jsxs("div",{className:"max-width-full mr-2 flex grow flex-row items-center overflow-hidden",children:[o.jsx(h,{className:"mr-2 flex-shrink-0 flex-grow-0"}),o.jsx("a",{href:t.extra?.cloud_doc_url,className:"text-token-primary flex-grow-1 flex-shrink-1 overflow-hidden text-ellipsis whitespace-nowrap text-sm",target:"_blank",rel:"noreferrer",children:i}),u&&o.jsx("div",{className:"ml-2 text-sm text-token-text-secondary",children:u})]}),o.jsxs("div",{className:"flex shrink-0 flex-row items-center",children:[o.jsx("button",{className:"rounded-md p-1 hover:bg-token-main-surface-secondary",children:s?.rating==="thumbsUp"?o.jsx(nr,{className:"icon-md-heavy text-token-text-primary",onClick:()=>p(void 0)}):o.jsx(wc,{className:"icon-md-heavy text-token-text-secondary",onClick:()=>p("thumbsUp")})}),o.jsx("button",{className:"rounded-md p-1 hover:bg-token-main-surface-secondary",children:s?.rating==="thumbsDown"?o.jsx(sr,{className:"icon-md-heavy text-token-text-primary",onClick:()=>p(void 0)}):o.jsx(bc,{className:"icon-md-heavy text-token-text-secondary",onClick:()=>p("thumbsDown")})})]})]}),s?.rating&&o.jsx("div",{className:"mb-4 flex flex-row",children:(s.rating==="thumbsDown"?id:cd).map(g=>o.jsx($c,{className:"mr-2",$selected:s.tags.includes(g),onClick:()=>a({...s,tags:s.tags.includes(g)?s.tags.filter(v=>v!==g):[...s.tags,g]}),children:g},g))}),!e&&o.jsx("div",{className:"w-full border-[0.5px] border-token-border-light"})]})}function ud({documentId:t,title:e,externalUrl:s,noBottomBorder:a=!1,shouldHaveBeenIncluded:i,setShouldHaveBeenIncluded:l}){const[h,u]=_.useMemo(()=>{const v=e.split(".");return v.length>1?[v.slice(0,-1).join("."),v[v.length-1]]:[e,""]},[e]),p=_.useMemo(()=>zs(vs.GDRIVE,u),[u]),g=_.useMemo(()=>{if(s)try{return new URL(s).hostname}catch{return}},[s]);return o.jsxs(o.Fragment,{children:[o.jsxs("div",{className:"flex flex-row items-center justify-between py-2",children:[o.jsxs("div",{className:"max-width-full mr-2 flex grow flex-row items-center overflow-hidden",children:[o.jsx(p,{className:"mr-2 flex-shrink-0 flex-grow-0"}),o.jsx("a",{href:s,className:"text-token-primary flex-grow-1 flex-shrink-1 overflow-hidden text-ellipsis whitespace-nowrap text-sm",target:"_blank",rel:"noreferrer",children:h}),g&&o.jsx("div",{className:"ml-2 text-sm text-token-text-secondary",children:g})]}),o.jsx("div",{className:"flex shrink-0 flex-row items-center px-2",children:o.jsx(Vs,{checked:i,onChange:v=>l?.(v.currentTarget.checked),id:`should-have-been-included-${t}`})})]}),!a&&o.jsx("div",{className:"w-full border-[0.5px] border-token-border-light"})]})}const dd=["Not relevant","Missing sources","Inaccurate information","I don't like it","Don't like the style","Content is wrong","Model being lazy","Used the wrong tool","Should't have used Browser","Used an incorrect fact about me","Didn't follow instructions","Other"],hd=["Good sources","Answered my question","I like it","Other"],fd="considered-source-should-have-been-used";function md({citations:t,rating:e,onSubmit:s,onCancel:a,messageId:i,conversationId:l,nodeId:h,conversationTree:u}){const p=_e(),g=ln(),[v,w]=_.useState(""),[f,x]=_.useState(()=>{const I={};for(const M of t)M.metadata?.type==="file"&&(I[M.metadata.id]={rating:void 0,tags:[],url:M.metadata.extra?.cloud_doc_url});return I}),b=_.useMemo(()=>{const I=new Set,M=[];for(const A of t)!A.metadata||A.metadata.type!=="file"||I.has(A.metadata.id)||(M.push(A.metadata),I.add(A.metadata.id));return M},[t]),[S,k]=_.useState(!0),B=_.useMemo(()=>{const I={hasQuery:!1,lastAssistantMessage:null,lastUserMessage:null,referencedSyncedFiles:[]};if(!u||!h||!u.containsNodeOrMessageId(h))return I;const M=bi(u,{messageId:h,entireConversation:!0});for(const A of M.messages)switch(A.type){case"fetch":case"generic_file_search_tool":case"system":continue;case"result":{A.result.chunks.forEach(F=>{F.documentId&&F.documentId.startsWith("S")&&!I.referencedSyncedFiles.some(W=>W.fileId===F.documentId)&&!b.some(W=>W.type==="file"&&W.id===F.documentId)&&I.referencedSyncedFiles.push({fileId:F.documentId,title:F.title})});continue}case"query":{I.hasQuery=!0;continue}case"visible_text":{if(A.author===Ie.User){if(!I.lastUserMessage){const F=u.getConversationTurns(A.id),W=F[F.length-1].messages,P=W[W.length-1];I.lastUserMessage=P}}else if(A.author===Ie.Assistant&&!I.lastAssistantMessage){const F=u.getConversationTurns(A.id),W=F[F.length-1].messages,P=W[W.length-1];I.lastAssistantMessage=P,I.lastUserMessage=null}continue}}return I},[u,b,h]),D=_.useCallback(async I=>{const M={...I,additionalSources:v,sourcesFeedback:f,consentedToShareConvoLink:S};Be.submitCaMessageFeedback({feedback_format:nn.ALPHA,message_id:i,conversation_id:l,text:M.textFeedback,rating:e,tags:M.tags,tag_choices:M.tagChoices,additional_sources:M.additionalSources,sources_feedback:M.sourcesFeedback,consented_to_share_convo_link:M.consentedToShareConvoLink}),g.success("Thanks for providing feedback!"),s?.(M)},[v,f,S,i,l,e,g,s]);return o.jsxs(qc,{multiple:!0,allowEmptySubmit:!0,onSubmit:D,onCancel:a,tagOptions:(e==="thumbsDown"?dd:hd).map(I=>({label:I,value:I})),modalOnly:!0,modalTitle:o.jsxs("div",{className:"flex items-center gap-2",children:[e==="thumbsDown"?o.jsx(sr,{className:"mb-[-6px]"}):o.jsx(nr,{className:"mb-[-6px]"}),o.jsx(T,{id:"h5nasL",defaultMessage:"Provide feedback"})]}),children:[b.length>0&&o.jsxs(o.Fragment,{children:[o.jsx("h3",{className:"mt-6 text-base font-semibold",children:o.jsx(T,{id:"G6+7UX",defaultMessage:"Sources"})}),o.jsx("div",{children:b.map((I,M)=>I?.type!=="file"?null:o.jsx(ld,{citationMetadata:I,noBottomBorder:M===b.length-1,sourceFeedback:f[I.id],setSourceFeedback:A=>x(F=>({...F,[I.id]:{...A,url:I.extra?.cloud_doc_url}}))},I.id))})]}),B.referencedSyncedFiles.length>0&&o.jsxs(o.Fragment,{children:[o.jsxs("div",{className:"mt-6 flex items-baseline justify-between",children:[o.jsxs("div",{className:"flex-start flex",children:[o.jsx("h3",{className:"text-base font-semibold",children:o.jsx(T,{id:"xvBe/T",defaultMessage:"Considered Sources"})}),o.jsx("p",{className:"ml-2 text-token-text-secondary",children:o.jsx(T,{id:"nX81fN",defaultMessage:"({numSources} sources)",values:{numSources:B.referencedSyncedFiles.length}})})]}),o.jsx("p",{className:"text-sm text-token-text-tertiary",children:o.jsx(T,{id:"0+Uivl",defaultMessage:"Good Source?"})})]}),o.jsx("div",{className:"mt-2 max-h-[200px] overflow-auto",children:B.referencedSyncedFiles.map((I,M)=>{const A=I.fileId.split("--")[1];if(!A)return null;const F=`https://drive.google.com/file/d/${A}`;return o.jsx(ud,{title:I.title,documentId:I.fileId,externalUrl:F,noBottomBorder:M===B.referencedSyncedFiles.length-1,shouldHaveBeenIncluded:!!f[I.fileId],setShouldHaveBeenIncluded:W=>x(P=>{const L={...Object.fromEntries(Object.entries(P).filter(([q])=>q!==I.fileId))};return W&&(L[I.fileId]={tags:[fd],rating:"thumbsUp",url:F}),L})},I.fileId)})})]}),o.jsxs("div",{className:"mt-6",children:[o.jsx("p",{className:"text-sm text-token-text-primary",children:o.jsx(T,{id:"1ApJVo",defaultMessage:"Add any additional sources"})}),o.jsx(Ci,{name:"feedback",className:"mt-2",placeholder:p.formatMessage({id:"CAFeedbackModal.additionalSourcePlaceholder",defaultMessage:"(Optional) Additional sources"}),value:v,onChange:I=>w(I.target.value)})]}),o.jsxs("div",{className:"mt-6",children:[o.jsx("h3",{className:"mb-2 text-base font-semibold",children:o.jsx(T,{id:"9NcQBu",defaultMessage:"Latest Exchange"})}),o.jsx("div",{className:"p-2",children:o.jsxs("div",{className:"mb-4",children:[B.lastUserMessage&&o.jsxs("div",{className:"mb-4",children:[o.jsx("p",{className:"mb-1 pl-4 text-xs text-token-text-secondary",children:o.jsx(T,{id:"QTWrtR",defaultMessage:"Your message"})}),o.jsx("div",{className:"flex justify-start",children:o.jsx("p",{className:"relative max-w-[70%] rounded-3xl bg-[#f4f4f4] px-5 py-2.5 dark:bg-token-main-surface-secondary",children:B.lastUserMessage?o.jsx(Vn,{message:B.lastUserMessage,isCompletionInProgress:!1,clientThreadId:l,isUserTurn:!1,turnIndex:0,isFeedbackEnabled:!1,showEditButton:!1,onEnterEdit:()=>null,onRequestMoreCompletions:()=>null}):null})})]}),o.jsxs("div",{className:"mb-2",children:[o.jsx("p",{className:"mb-1 pl-4 text-xs text-token-text-secondary",children:o.jsx(T,{id:"ZCTm4h",defaultMessage:"ChatGPT's response"})}),o.jsx("div",{className:"relative rounded-lg bg-token-main-surface-secondary p-4 text-sm",children:B.lastAssistantMessage?o.jsx(Vn,{message:B.lastAssistantMessage,isCompletionInProgress:!1,clientThreadId:l,isUserTurn:!1,turnIndex:1,isFeedbackEnabled:!1,showEditButton:!1,onEnterEdit:()=>null,onRequestMoreCompletions:()=>null}):null})]})]})}),o.jsxs("div",{className:"mt-4",children:[o.jsx("h3",{className:"mt-6 text-base font-semibold",children:o.jsx(T,{id:"c95uEW",defaultMessage:"Full conversation"})}),o.jsx("p",{className:"mb-2 mt-1 text-sm text-token-text-secondary",children:o.jsx(T,{id:"3E3ZSm",defaultMessage:"If previous portions of this conversation are important to understand your feedback, we encourage you to include it."})}),o.jsx(Vs,{id:"consented-to-share-entire-convo",label:p.formatMessage({id:"5CC8r8",defaultMessage:"Share Entire Conversation"}),checked:S,onChange:I=>{k(I.currentTarget.checked)}})]})]})]})}const pd=Qe(()=>He(()=>import("./sso-go45p84u2s30azkx.js").then(t=>t.C),__vite__mapDeps([42,1,2,3,43,5,6,21,8,29,27,44,26,45,46,47,48,49,50,51,18,52,28,53,54,55,56,22,23,57,58,59,60,15,61,25,20,62,63,19,64,65,66,67,68,69,70,71,72])).then(t=>t.CADogfoodingFeedbackModal).catch(()=>()=>null));function gd(t){const e=Si();if(!e)return null;switch(e){case nn.ALPHA:return o.jsx(md,{...t});case nn.DOGFOODING:return o.jsx(pd,{...t})}}function xd(t){return t==null||[ke.PrimaryAssistant,ke.GizmoInteraction].includes(t.kind)}function Gh(t,e){const s=vn(t,e),{data:a}=gr(s!=null&&"gizmo_id"in s?s.gizmo_id:void 0,s?.kind===ke.GizmoTest);if(s!=null)switch(s.kind){case ke.GizmoInteraction:case ke.GizmoMagicCreate:case ke.GizmoTest:return{gizmo:a,...s};case ke.PrimaryAssistant:return s}}function yd(t,e,s){const i=j.getTree(e).getMessageId(j.getThreadCurrentLeafId(e));Be.generateTitle(e,i,s).then(({title:l})=>{j.setTitle(e,l,xr.Generated),ir(t),U.logEvent(O.renameThread,{threadId:e,content:l,model:s})})}function _d(t,e,s){const a=()=>{const l=qn(s);t(l)},i=It.getGizmoId(s);i!=null?jc(e,i).then(l=>{Ii(qn(s,l))}).catch(l=>{Ee.addError(l),a()}):a()}const ts={onCreate(t,e,s,a){U.logEvent(O.newThread),!a&&xd(It.getConversationMode(e))&&lo(s).then(i=>{dn(i)||(ir(s),t(e))})},onCreateFinished(t,e,s){if(!(s||!e)&&!de.checkGate("2562876640")){const a=It.getThread(e)?.initialThreadData.lastModelUsed;a==null&&Ee.addError("missing lastModelUsed on conversation create finished"),yd(t,e,a)}}};function ns(t,e){t.updateNodeMetadata(e.id,{completionSampleFinishTime:Date.now()})}class vd{constructor(e,s,a,i,l,h,u,p,g,v,w,f){this.queryClient=e,this.clientThreadId=s,this.targetNodeId=a,this.completionType=i,this.model=l,this.eventSource=h,this.onCreate=u,this.callModelAgain=g,this.onCompletionFinished=v,this.isHistoryAndTrainingDisabled=f,this.currentTree=j.getTree(s),this.currentNodeId=a,this.activeBranchLastMessage=this.currentTree.getMessage(this.currentNodeId),this.completionLatencyTracker=new ki(p),this.turnTracker=w,this.turnTracker.onCompletionStarted(i,this.model)}currentTree;currentNodeId;firstResponse=!0;didCreateFirstCompletionInNewThread=!1;activeBranchLastMessage;messagesToUpdate={};allIncompleteStreamedMessages={};responseThreadId;isCompletionBlocked=!1;isEitherFlagged=!1;variantsInStreamInfo;activeBranchNodeId;blurDuringCompletionTracker=new Ei;completionLatencyTracker;turnTracker;debouncedUpdateCompletion=Mi(()=>{this.isCompletionBlocked||j.updateTree(this.clientThreadId,e=>{Object.values(this.messagesToUpdate).forEach(s=>{e.updateNodeMessage(s.id,s)})}),this.messagesToUpdate={}},50,{leading:!0,maxWait:50});handleResponse=async e=>{if(e.type!=="done"&&this.turnTracker.onUpdateEventCount(),this.completionLatencyTracker.onResponse(e,this.activeBranchLastMessage,this.responseThreadId),this.responseThreadId===void 0&&"conversationId"in e){const s=e.conversationId;this.responseThreadId=s,wn(this.clientThreadId)&&j.getServerThreadId(this.clientThreadId)!==s&&(j.setServerIdForNewThread(this.clientThreadId,s),U.logEvent(O.attributeClientThreadToServerThread,{client_thread_id:this.clientThreadId,server_thread_id:s}))}switch(e.type){case"error":this.handleError(e);break;case"num_variants_in_stream":this.bindVariantInfoToTree(e);break;case"moderation":this.handleModeration(e);break;case"url_moderation":this.handleUrlModeration(e);break;case"message":this.handleMessage(e),this.debouncedUpdateCompletion();break;case"done":this.handleDone();break;case"gizmo_inline_review":this.handleGizmoInlineReview(e);break;case"title_generation":this.handleTitleGeneration(e);break;case"conversation_detail_metadata":this.handleConversationDetailMetadata(e);break}};handleError(e){const s=e.error,a=s?.message||"Something went wrong",i=s instanceof we&&s.code||"",l=s instanceof we&&s.status,h=s instanceof we?s.detail?.can_retry:void 0;switch(this.turnTracker.handleRawError(a,l),j.updateTree(this.clientThreadId,u=>{u.updateNodeMessage(this.currentNodeId,this.activeBranchLastMessage),u.updateNodeMetadata(this.currentNodeId,{err:a,errType:"danger",errCode:i,completionSampleFinishTime:Date.now(),canRetry:h})}),i){case Ne.ContentPolicy:case Ne.ContentOrTos:case en:case cs:break;default:a!==void 0&&de.logEvent("chatgpt_conversation_error_web",a)}if(this.blurDuringCompletionTracker.onMessageError(),this.cleanUp(),this.onCompletionFinished(this.responseThreadId),s instanceof we&&s.code===en){const u=s.detail?.clears_in;u&&(Ti(new Date(Date.now()+u*1e3).toISOString()),setTimeout(()=>{ji()},u*1e3))}}handleGizmoInlineReview(e){j.setPromptGptRating(this.clientThreadId,e.gizmoId)}handleTitleGeneration(e){j.setTitle(this.clientThreadId,e.title,xr.Generated)}handleConversationDetailMetadata(e){const{default_model_slug:s}=e;s&&j.setThreadModelId(this.clientThreadId,s),Xt.updateDetails(e)}bindVariantInfoToTree(e){this.variantsInStreamInfo=e,j.updateTree(this.clientThreadId,s=>{const a=s.getParentPromptNode(this.currentNodeId);s.updateNodeMetadata(a.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}handleModeration(e){const{isCompletion:s,messageId:a,conversationId:i,flagged:l,blocked:h,disclaimers:u,metadata:p}=e,g=!!u?.length&&s;(l||h||g)&&(this.isEitherFlagged=!0,h&&s&&(this.isCompletionBlocked=!0),j.updateTree(this.clientThreadId,v=>{const w=v.messageIdToNodeId(a);h&&v.clearNodeMessageParts(w),v.updateNodeMetadata(w,{...(g&&!!u?.length&&Ri(u,h))??{},...l&&Ai,...h&&(p?.model_incompatibility?Ni:Bi),completionSampleFinishTime:Date.now()})}),U.logEvent(s?h?O.completionBlockedByModeration:O.completionFlaggedByModeration:h?O.promptBlockedByModeration:O.promptFlaggedByModeration,{threadId:i,id:a}))}handleUrlModeration(e){const{conversationId:s,url:a,isSafe:i}=e;i&&j.addThreadSafeUrl(s,a)}handleMessage(e){let s=!0;const{message:a,conversationId:i}=e;if(this.turnTracker.onMessageUpdate(a.metadata?.model_slug,a.metadata?.gizmo_id,a.author.name,a.author.role),this.firstResponse&&!this.currentTree.hasReceivedServerCompletion){if(this.currentTree.hasNodeOrMessageId(a.id))return a?.author.role!==Ie.User?void 0:j.updateTree(this.clientThreadId,l=>{l.updateNodeMessage(a.id,a)});if(a.author.role===Ie.User&&a.content.content_type===Mn.UserEditableContext)return;if((a?.author.role===Ie.System||a?.author.role===Ie.Developer)&&(a.metadata?.parent_id?this.currentTree.getNodeByIdOrMessageId(a.metadata.parent_id):void 0)?.message.author.role!==Ie.User){this.currentTree.appendSystemMessageToRoot(a);return}}if(this.firstResponse&&a.metadata?.rebase_system_message){j.updateTree(this.clientThreadId,l=>{if(a.metadata?.parent_id==null)throw Error("Unexpected rebased system message without parent");const h=l.getNodeByIdOrMessageId(this.targetNodeId);l.deleteNode(this.targetNodeId),l.addNode(a.id,a,a.metadata.parent_id,a.author.role),l.addNode(h.id,h.message,a.id,h.message.author.role)});return}if(this.firstResponse){const l=St.getState().threads[this.clientThreadId]?.continuingFromSharedConversationId!=null;j.removeContinuingFromSharedConversationId(this.clientThreadId),this.firstResponse=!1,this.didCreateFirstCompletionInNewThread=!this.currentTree.hasReceivedServerCompletion||l,j.updateTree(this.clientThreadId,u=>{u.updateNodeMessage(this.currentNodeId,a)}),this.didCreateFirstCompletionInNewThread&&ts.onCreate(this.onCreate,i,this.queryClient,this.isHistoryAndTrainingDisabled);const h={id:this.targetNodeId,threadId:i,completionType:this.completionType,eventSource:this.eventSource,model:this.model};if(this.completionType===st.Next){const u=St.getState().threads[i],p=u?.conversationTurns?.length,g=u?.conversationTurns?.filter(w=>w.role==Ie.User),v=g&&g[g.length-1]?.messages[0].message;if(v?.content.content_type==Mn.Text){const w=v.content.parts.join("").length,f=g?.length??0;h.countConversationTurns=p,h.countUserSubmittedMessages=f,h.countLastUserPromptTextMessageLength=w}}U.logEvent(O.generateCompletion,h)}else if(this.completionType!==st.Continue){const l=this.currentTree.containsNodeOrMessageId(a.id),h=a.metadata?.parent_id;if(l||(this.debouncedUpdateCompletion.flush(),j.updateTree(this.clientThreadId,u=>{if(h==null)throw new Error(`Received a message with no parentId: ${JSON.stringify(a)}`);u.addNode(a.id,a,h,Ie.Assistant)})),h!=null&&h===this.activeBranchNodeId){const u=this.allIncompleteStreamedMessages[h];u!=null&&(j.updateTree(this.clientThreadId,p=>{ns(p,u)}),delete this.allIncompleteStreamedMessages[h])}if(s=(this.variantsInStreamInfo?.num_variants_in_stream??1)===1||this.activeBranchNodeId==null||this.activeBranchNodeId===a.id||this.currentTree.isAncestorOfNode(this.activeBranchNodeId,a.id),s&&this.activeBranchNodeId!==a.id){this.activeBranchNodeId=a.id,this.currentNodeId=a.id;const u=j.getThreadCurrentLeafId(this.clientThreadId);this.currentTree.messageIdToNodeId(this.currentNodeId)!==this.currentTree.messageIdToNodeId(u)&&j.setThreadCurrentLeafId(this.clientThreadId,this.currentNodeId),h!=null&&j.updateTree(this.clientThreadId,p=>{const g=p.getParentPromptNode(a.id);p.updateNodeMetadata(g.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}}if(a?.author.role===Ie.Tool&&a?.author.name==="bio"){const l=a.metadata?.gizmo_id;setTimeout(()=>{this.queryClient.invalidateQueries({queryKey:Fi(l)})},5e3)}s&&(this.activeBranchLastMessage=a),this.messagesToUpdate[a.id]=a,this.allIncompleteStreamedMessages[a.id]=a}async handleDone(){if(this.turnTracker.model_message_update_count>0?this.turnTracker.logCompletion({type:Ct.Success}):this.turnTracker.logCompletion({type:Ct.Error,error:{reason:"empty_response",message:"Successful completion ended with no messages"}}),this.isCompletionBlocked||(this.debouncedUpdateCompletion.flush(),this.isEitherFlagged||(this.didCreateFirstCompletionInNewThread&&ts.onCreateFinished(this.queryClient,this.responseThreadId,this.isHistoryAndTrainingDisabled),this.onCompletionFinished(this.responseThreadId))),j.updateTree(this.clientThreadId,e=>{Object.values(this.allIncompleteStreamedMessages).forEach(s=>{ns(e,s)})}),Ks.publish({kind:"createConversation",clientThreadId:this.clientThreadId}),this.blurDuringCompletionTracker.onMessageDone(),this.cleanUp(),this.activeBranchLastMessage?.metadata?.client_actions!==void 0){const e=await Di(this.clientThreadId,this.activeBranchLastMessage);e.length>0&&this.callModelAgain(this.currentNodeId,e)}}cleanUp(){setTimeout(()=>{cr(this.clientThreadId,{source:ws.CLIENT,value:bs.UNREAD}),yn.removeRequest(this.targetNodeId),j.releaseThread(this.clientThreadId)},0)}}/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(t){const e=Pi,s=Ui,a=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;t.Buffer=u,t.SlowBuffer=D,t.INSPECT_MAX_BYTES=50;const i=2147483647;t.kMaxLength=i,u.TYPED_ARRAY_SUPPORT=l(),!u.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function l(){try{const c=new Uint8Array(1),n={foo:function(){return 42}};return Object.setPrototypeOf(n,Uint8Array.prototype),Object.setPrototypeOf(c,n),c.foo()===42}catch{return!1}}Object.defineProperty(u.prototype,"parent",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.buffer}}),Object.defineProperty(u.prototype,"offset",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.byteOffset}});function h(c){if(c>i)throw new RangeError('The value "'+c+'" is invalid for option "size"');const n=new Uint8Array(c);return Object.setPrototypeOf(n,u.prototype),n}function u(c,n,r){if(typeof c=="number"){if(typeof n=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return w(c)}return p(c,n,r)}u.poolSize=8192;function p(c,n,r){if(typeof c=="string")return f(c,n);if(ArrayBuffer.isView(c))return b(c);if(c==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof c);if(Ae(c,ArrayBuffer)||c&&Ae(c.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(Ae(c,SharedArrayBuffer)||c&&Ae(c.buffer,SharedArrayBuffer)))return S(c,n,r);if(typeof c=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const d=c.valueOf&&c.valueOf();if(d!=null&&d!==c)return u.from(d,n,r);const m=k(c);if(m)return m;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof c[Symbol.toPrimitive]=="function")return u.from(c[Symbol.toPrimitive]("string"),n,r);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof c)}u.from=function(c,n,r){return p(c,n,r)},Object.setPrototypeOf(u.prototype,Uint8Array.prototype),Object.setPrototypeOf(u,Uint8Array);function g(c){if(typeof c!="number")throw new TypeError('"size" argument must be of type number');if(c<0)throw new RangeError('The value "'+c+'" is invalid for option "size"')}function v(c,n,r){return g(c),c<=0?h(c):n!==void 0?typeof r=="string"?h(c).fill(n,r):h(c).fill(n):h(c)}u.alloc=function(c,n,r){return v(c,n,r)};function w(c){return g(c),h(c<0?0:B(c)|0)}u.allocUnsafe=function(c){return w(c)},u.allocUnsafeSlow=function(c){return w(c)};function f(c,n){if((typeof n!="string"||n==="")&&(n="utf8"),!u.isEncoding(n))throw new TypeError("Unknown encoding: "+n);const r=I(c,n)|0;let d=h(r);const m=d.write(c,n);return m!==r&&(d=d.slice(0,m)),d}function x(c){const n=c.length<0?0:B(c.length)|0,r=h(n);for(let d=0;d<n;d+=1)r[d]=c[d]&255;return r}function b(c){if(Ae(c,Uint8Array)){const n=new Uint8Array(c);return S(n.buffer,n.byteOffset,n.byteLength)}return x(c)}function S(c,n,r){if(n<0||c.byteLength<n)throw new RangeError('"offset" is outside of buffer bounds');if(c.byteLength<n+(r||0))throw new RangeError('"length" is outside of buffer bounds');let d;return n===void 0&&r===void 0?d=new Uint8Array(c):r===void 0?d=new Uint8Array(c,n):d=new Uint8Array(c,n,r),Object.setPrototypeOf(d,u.prototype),d}function k(c){if(u.isBuffer(c)){const n=B(c.length)|0,r=h(n);return r.length===0||c.copy(r,0,0,n),r}if(c.length!==void 0)return typeof c.length!="number"||Dt(c.length)?h(0):x(c);if(c.type==="Buffer"&&Array.isArray(c.data))return x(c.data)}function B(c){if(c>=i)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+i.toString(16)+" bytes");return c|0}function D(c){return+c!=c&&(c=0),u.alloc(+c)}u.isBuffer=function(n){return n!=null&&n._isBuffer===!0&&n!==u.prototype},u.compare=function(n,r){if(Ae(n,Uint8Array)&&(n=u.from(n,n.offset,n.byteLength)),Ae(r,Uint8Array)&&(r=u.from(r,r.offset,r.byteLength)),!u.isBuffer(n)||!u.isBuffer(r))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(n===r)return 0;let d=n.length,m=r.length;for(let y=0,C=Math.min(d,m);y<C;++y)if(n[y]!==r[y]){d=n[y],m=r[y];break}return d<m?-1:m<d?1:0},u.isEncoding=function(n){switch(String(n).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},u.concat=function(n,r){if(!Array.isArray(n))throw new TypeError('"list" argument must be an Array of Buffers');if(n.length===0)return u.alloc(0);let d;if(r===void 0)for(r=0,d=0;d<n.length;++d)r+=n[d].length;const m=u.allocUnsafe(r);let y=0;for(d=0;d<n.length;++d){let C=n[d];if(Ae(C,Uint8Array))y+C.length>m.length?(u.isBuffer(C)||(C=u.from(C)),C.copy(m,y)):Uint8Array.prototype.set.call(m,C,y);else if(u.isBuffer(C))C.copy(m,y);else throw new TypeError('"list" argument must be an Array of Buffers');y+=C.length}return m};function I(c,n){if(u.isBuffer(c))return c.length;if(ArrayBuffer.isView(c)||Ae(c,ArrayBuffer))return c.byteLength;if(typeof c!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof c);const r=c.length,d=arguments.length>2&&arguments[2]===!0;if(!d&&r===0)return 0;let m=!1;for(;;)switch(n){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":return Ft(c).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return r*2;case"hex":return r>>>1;case"base64":return En(c).length;default:if(m)return d?-1:Ft(c).length;n=(""+n).toLowerCase(),m=!0}}u.byteLength=I;function M(c,n,r){let d=!1;if((n===void 0||n<0)&&(n=0),n>this.length||((r===void 0||r>this.length)&&(r=this.length),r<=0)||(r>>>=0,n>>>=0,r<=n))return"";for(c||(c="utf8");;)switch(c){case"hex":return V(this,n,r);case"utf8":case"utf-8":return z(this,n,r);case"ascii":return N(this,n,r);case"latin1":case"binary":return Y(this,n,r);case"base64":return G(this,n,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ce(this,n,r);default:if(d)throw new TypeError("Unknown encoding: "+c);c=(c+"").toLowerCase(),d=!0}}u.prototype._isBuffer=!0;function A(c,n,r){const d=c[n];c[n]=c[r],c[r]=d}u.prototype.swap16=function(){const n=this.length;if(n%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let r=0;r<n;r+=2)A(this,r,r+1);return this},u.prototype.swap32=function(){const n=this.length;if(n%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let r=0;r<n;r+=4)A(this,r,r+3),A(this,r+1,r+2);return this},u.prototype.swap64=function(){const n=this.length;if(n%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let r=0;r<n;r+=8)A(this,r,r+7),A(this,r+1,r+6),A(this,r+2,r+5),A(this,r+3,r+4);return this},u.prototype.toString=function(){const n=this.length;return n===0?"":arguments.length===0?z(this,0,n):M.apply(this,arguments)},u.prototype.toLocaleString=u.prototype.toString,u.prototype.equals=function(n){if(!u.isBuffer(n))throw new TypeError("Argument must be a Buffer");return this===n?!0:u.compare(this,n)===0},u.prototype.inspect=function(){let n="";const r=t.INSPECT_MAX_BYTES;return n=this.toString("hex",0,r).replace(/(.{2})/g,"$1 ").trim(),this.length>r&&(n+=" ... "),"<Buffer "+n+">"},a&&(u.prototype[a]=u.prototype.inspect),u.prototype.compare=function(n,r,d,m,y){if(Ae(n,Uint8Array)&&(n=u.from(n,n.offset,n.byteLength)),!u.isBuffer(n))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof n);if(r===void 0&&(r=0),d===void 0&&(d=n?n.length:0),m===void 0&&(m=0),y===void 0&&(y=this.length),r<0||d>n.length||m<0||y>this.length)throw new RangeError("out of range index");if(m>=y&&r>=d)return 0;if(m>=y)return-1;if(r>=d)return 1;if(r>>>=0,d>>>=0,m>>>=0,y>>>=0,this===n)return 0;let C=y-m,$=d-r;const ae=Math.min(C,$),te=this.slice(m,y),ie=n.slice(r,d);for(let Z=0;Z<ae;++Z)if(te[Z]!==ie[Z]){C=te[Z],$=ie[Z];break}return C<$?-1:$<C?1:0};function F(c,n,r,d,m){if(c.length===0)return-1;if(typeof r=="string"?(d=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),r=+r,Dt(r)&&(r=m?0:c.length-1),r<0&&(r=c.length+r),r>=c.length){if(m)return-1;r=c.length-1}else if(r<0)if(m)r=0;else return-1;if(typeof n=="string"&&(n=u.from(n,d)),u.isBuffer(n))return n.length===0?-1:W(c,n,r,d,m);if(typeof n=="number")return n=n&255,typeof Uint8Array.prototype.indexOf=="function"?m?Uint8Array.prototype.indexOf.call(c,n,r):Uint8Array.prototype.lastIndexOf.call(c,n,r):W(c,[n],r,d,m);throw new TypeError("val must be string, number or Buffer")}function W(c,n,r,d,m){let y=1,C=c.length,$=n.length;if(d!==void 0&&(d=String(d).toLowerCase(),d==="ucs2"||d==="ucs-2"||d==="utf16le"||d==="utf-16le")){if(c.length<2||n.length<2)return-1;y=2,C/=2,$/=2,r/=2}function ae(ie,Z){return y===1?ie[Z]:ie.readUInt16BE(Z*y)}let te;if(m){let ie=-1;for(te=r;te<C;te++)if(ae(c,te)===ae(n,ie===-1?0:te-ie)){if(ie===-1&&(ie=te),te-ie+1===$)return ie*y}else ie!==-1&&(te-=te-ie),ie=-1}else for(r+$>C&&(r=C-$),te=r;te>=0;te--){let ie=!0;for(let Z=0;Z<$;Z++)if(ae(c,te+Z)!==ae(n,Z)){ie=!1;break}if(ie)return te}return-1}u.prototype.includes=function(n,r,d){return this.indexOf(n,r,d)!==-1},u.prototype.indexOf=function(n,r,d){return F(this,n,r,d,!0)},u.prototype.lastIndexOf=function(n,r,d){return F(this,n,r,d,!1)};function P(c,n,r,d){r=Number(r)||0;const m=c.length-r;d?(d=Number(d),d>m&&(d=m)):d=m;const y=n.length;d>y/2&&(d=y/2);let C;for(C=0;C<d;++C){const $=parseInt(n.substr(C*2,2),16);if(Dt($))return C;c[r+C]=$}return C}function L(c,n,r,d){return ft(Ft(n,c.length-r),c,r,d)}function q(c,n,r,d){return ft(Lr(n),c,r,d)}function J(c,n,r,d){return ft(En(n),c,r,d)}function ee(c,n,r,d){return ft(Wr(n,c.length-r),c,r,d)}u.prototype.write=function(n,r,d,m){if(r===void 0)m="utf8",d=this.length,r=0;else if(d===void 0&&typeof r=="string")m=r,d=this.length,r=0;else if(isFinite(r))r=r>>>0,isFinite(d)?(d=d>>>0,m===void 0&&(m="utf8")):(m=d,d=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const y=this.length-r;if((d===void 0||d>y)&&(d=y),n.length>0&&(d<0||r<0)||r>this.length)throw new RangeError("Attempt to write outside buffer bounds");m||(m="utf8");let C=!1;for(;;)switch(m){case"hex":return P(this,n,r,d);case"utf8":case"utf-8":return L(this,n,r,d);case"ascii":case"latin1":case"binary":return q(this,n,r,d);case"base64":return J(this,n,r,d);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ee(this,n,r,d);default:if(C)throw new TypeError("Unknown encoding: "+m);m=(""+m).toLowerCase(),C=!0}},u.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function G(c,n,r){return n===0&&r===c.length?e.fromByteArray(c):e.fromByteArray(c.slice(n,r))}function z(c,n,r){r=Math.min(c.length,r);const d=[];let m=n;for(;m<r;){const y=c[m];let C=null,$=y>239?4:y>223?3:y>191?2:1;if(m+$<=r){let ae,te,ie,Z;switch($){case 1:y<128&&(C=y);break;case 2:ae=c[m+1],(ae&192)===128&&(Z=(y&31)<<6|ae&63,Z>127&&(C=Z));break;case 3:ae=c[m+1],te=c[m+2],(ae&192)===128&&(te&192)===128&&(Z=(y&15)<<12|(ae&63)<<6|te&63,Z>2047&&(Z<55296||Z>57343)&&(C=Z));break;case 4:ae=c[m+1],te=c[m+2],ie=c[m+3],(ae&192)===128&&(te&192)===128&&(ie&192)===128&&(Z=(y&15)<<18|(ae&63)<<12|(te&63)<<6|ie&63,Z>65535&&Z<1114112&&(C=Z))}}C===null?(C=65533,$=1):C>65535&&(C-=65536,d.push(C>>>10&1023|55296),C=56320|C&1023),d.push(C),m+=$}return Q(d)}const X=4096;function Q(c){const n=c.length;if(n<=X)return String.fromCharCode.apply(String,c);let r="",d=0;for(;d<n;)r+=String.fromCharCode.apply(String,c.slice(d,d+=X));return r}function N(c,n,r){let d="";r=Math.min(c.length,r);for(let m=n;m<r;++m)d+=String.fromCharCode(c[m]&127);return d}function Y(c,n,r){let d="";r=Math.min(c.length,r);for(let m=n;m<r;++m)d+=String.fromCharCode(c[m]);return d}function V(c,n,r){const d=c.length;(!n||n<0)&&(n=0),(!r||r<0||r>d)&&(r=d);let m="";for(let y=n;y<r;++y)m+=Gr[c[y]];return m}function ce(c,n,r){const d=c.slice(n,r);let m="";for(let y=0;y<d.length-1;y+=2)m+=String.fromCharCode(d[y]+d[y+1]*256);return m}u.prototype.slice=function(n,r){const d=this.length;n=~~n,r=r===void 0?d:~~r,n<0?(n+=d,n<0&&(n=0)):n>d&&(n=d),r<0?(r+=d,r<0&&(r=0)):r>d&&(r=d),r<n&&(r=n);const m=this.subarray(n,r);return Object.setPrototypeOf(m,u.prototype),m};function R(c,n,r){if(c%1!==0||c<0)throw new RangeError("offset is not uint");if(c+n>r)throw new RangeError("Trying to access beyond buffer length")}u.prototype.readUintLE=u.prototype.readUIntLE=function(n,r,d){n=n>>>0,r=r>>>0,d||R(n,r,this.length);let m=this[n],y=1,C=0;for(;++C<r&&(y*=256);)m+=this[n+C]*y;return m},u.prototype.readUintBE=u.prototype.readUIntBE=function(n,r,d){n=n>>>0,r=r>>>0,d||R(n,r,this.length);let m=this[n+--r],y=1;for(;r>0&&(y*=256);)m+=this[n+--r]*y;return m},u.prototype.readUint8=u.prototype.readUInt8=function(n,r){return n=n>>>0,r||R(n,1,this.length),this[n]},u.prototype.readUint16LE=u.prototype.readUInt16LE=function(n,r){return n=n>>>0,r||R(n,2,this.length),this[n]|this[n+1]<<8},u.prototype.readUint16BE=u.prototype.readUInt16BE=function(n,r){return n=n>>>0,r||R(n,2,this.length),this[n]<<8|this[n+1]},u.prototype.readUint32LE=u.prototype.readUInt32LE=function(n,r){return n=n>>>0,r||R(n,4,this.length),(this[n]|this[n+1]<<8|this[n+2]<<16)+this[n+3]*16777216},u.prototype.readUint32BE=u.prototype.readUInt32BE=function(n,r){return n=n>>>0,r||R(n,4,this.length),this[n]*16777216+(this[n+1]<<16|this[n+2]<<8|this[n+3])},u.prototype.readBigUInt64LE=Oe(function(n){n=n>>>0,Me(n,"offset");const r=this[n],d=this[n+7];(r===void 0||d===void 0)&&Se(n,this.length-8);const m=r+this[++n]*2**8+this[++n]*2**16+this[++n]*2**24,y=this[++n]+this[++n]*2**8+this[++n]*2**16+d*2**24;return BigInt(m)+(BigInt(y)<<BigInt(32))}),u.prototype.readBigUInt64BE=Oe(function(n){n=n>>>0,Me(n,"offset");const r=this[n],d=this[n+7];(r===void 0||d===void 0)&&Se(n,this.length-8);const m=r*2**24+this[++n]*2**16+this[++n]*2**8+this[++n],y=this[++n]*2**24+this[++n]*2**16+this[++n]*2**8+d;return(BigInt(m)<<BigInt(32))+BigInt(y)}),u.prototype.readIntLE=function(n,r,d){n=n>>>0,r=r>>>0,d||R(n,r,this.length);let m=this[n],y=1,C=0;for(;++C<r&&(y*=256);)m+=this[n+C]*y;return y*=128,m>=y&&(m-=Math.pow(2,8*r)),m},u.prototype.readIntBE=function(n,r,d){n=n>>>0,r=r>>>0,d||R(n,r,this.length);let m=r,y=1,C=this[n+--m];for(;m>0&&(y*=256);)C+=this[n+--m]*y;return y*=128,C>=y&&(C-=Math.pow(2,8*r)),C},u.prototype.readInt8=function(n,r){return n=n>>>0,r||R(n,1,this.length),this[n]&128?(255-this[n]+1)*-1:this[n]},u.prototype.readInt16LE=function(n,r){n=n>>>0,r||R(n,2,this.length);const d=this[n]|this[n+1]<<8;return d&32768?d|4294901760:d},u.prototype.readInt16BE=function(n,r){n=n>>>0,r||R(n,2,this.length);const d=this[n+1]|this[n]<<8;return d&32768?d|4294901760:d},u.prototype.readInt32LE=function(n,r){return n=n>>>0,r||R(n,4,this.length),this[n]|this[n+1]<<8|this[n+2]<<16|this[n+3]<<24},u.prototype.readInt32BE=function(n,r){return n=n>>>0,r||R(n,4,this.length),this[n]<<24|this[n+1]<<16|this[n+2]<<8|this[n+3]},u.prototype.readBigInt64LE=Oe(function(n){n=n>>>0,Me(n,"offset");const r=this[n],d=this[n+7];(r===void 0||d===void 0)&&Se(n,this.length-8);const m=this[n+4]+this[n+5]*2**8+this[n+6]*2**16+(d<<24);return(BigInt(m)<<BigInt(32))+BigInt(r+this[++n]*2**8+this[++n]*2**16+this[++n]*2**24)}),u.prototype.readBigInt64BE=Oe(function(n){n=n>>>0,Me(n,"offset");const r=this[n],d=this[n+7];(r===void 0||d===void 0)&&Se(n,this.length-8);const m=(r<<24)+this[++n]*2**16+this[++n]*2**8+this[++n];return(BigInt(m)<<BigInt(32))+BigInt(this[++n]*2**24+this[++n]*2**16+this[++n]*2**8+d)}),u.prototype.readFloatLE=function(n,r){return n=n>>>0,r||R(n,4,this.length),s.read(this,n,!0,23,4)},u.prototype.readFloatBE=function(n,r){return n=n>>>0,r||R(n,4,this.length),s.read(this,n,!1,23,4)},u.prototype.readDoubleLE=function(n,r){return n=n>>>0,r||R(n,8,this.length),s.read(this,n,!0,52,8)},u.prototype.readDoubleBE=function(n,r){return n=n>>>0,r||R(n,8,this.length),s.read(this,n,!1,52,8)};function E(c,n,r,d,m,y){if(!u.isBuffer(c))throw new TypeError('"buffer" argument must be a Buffer instance');if(n>m||n<y)throw new RangeError('"value" argument is out of bounds');if(r+d>c.length)throw new RangeError("Index out of range")}u.prototype.writeUintLE=u.prototype.writeUIntLE=function(n,r,d,m){if(n=+n,r=r>>>0,d=d>>>0,!m){const $=Math.pow(2,8*d)-1;E(this,n,r,d,$,0)}let y=1,C=0;for(this[r]=n&255;++C<d&&(y*=256);)this[r+C]=n/y&255;return r+d},u.prototype.writeUintBE=u.prototype.writeUIntBE=function(n,r,d,m){if(n=+n,r=r>>>0,d=d>>>0,!m){const $=Math.pow(2,8*d)-1;E(this,n,r,d,$,0)}let y=d-1,C=1;for(this[r+y]=n&255;--y>=0&&(C*=256);)this[r+y]=n/C&255;return r+d},u.prototype.writeUint8=u.prototype.writeUInt8=function(n,r,d){return n=+n,r=r>>>0,d||E(this,n,r,1,255,0),this[r]=n&255,r+1},u.prototype.writeUint16LE=u.prototype.writeUInt16LE=function(n,r,d){return n=+n,r=r>>>0,d||E(this,n,r,2,65535,0),this[r]=n&255,this[r+1]=n>>>8,r+2},u.prototype.writeUint16BE=u.prototype.writeUInt16BE=function(n,r,d){return n=+n,r=r>>>0,d||E(this,n,r,2,65535,0),this[r]=n>>>8,this[r+1]=n&255,r+2},u.prototype.writeUint32LE=u.prototype.writeUInt32LE=function(n,r,d){return n=+n,r=r>>>0,d||E(this,n,r,4,4294967295,0),this[r+3]=n>>>24,this[r+2]=n>>>16,this[r+1]=n>>>8,this[r]=n&255,r+4},u.prototype.writeUint32BE=u.prototype.writeUInt32BE=function(n,r,d){return n=+n,r=r>>>0,d||E(this,n,r,4,4294967295,0),this[r]=n>>>24,this[r+1]=n>>>16,this[r+2]=n>>>8,this[r+3]=n&255,r+4};function se(c,n,r,d,m){Ze(n,d,m,c,r,7);let y=Number(n&BigInt(4294967295));c[r++]=y,y=y>>8,c[r++]=y,y=y>>8,c[r++]=y,y=y>>8,c[r++]=y;let C=Number(n>>BigInt(32)&BigInt(4294967295));return c[r++]=C,C=C>>8,c[r++]=C,C=C>>8,c[r++]=C,C=C>>8,c[r++]=C,r}function Ce(c,n,r,d,m){Ze(n,d,m,c,r,7);let y=Number(n&BigInt(4294967295));c[r+7]=y,y=y>>8,c[r+6]=y,y=y>>8,c[r+5]=y,y=y>>8,c[r+4]=y;let C=Number(n>>BigInt(32)&BigInt(4294967295));return c[r+3]=C,C=C>>8,c[r+2]=C,C=C>>8,c[r+1]=C,C=C>>8,c[r]=C,r+8}u.prototype.writeBigUInt64LE=Oe(function(n,r=0){return se(this,n,r,BigInt(0),BigInt("0xffffffffffffffff"))}),u.prototype.writeBigUInt64BE=Oe(function(n,r=0){return Ce(this,n,r,BigInt(0),BigInt("0xffffffffffffffff"))}),u.prototype.writeIntLE=function(n,r,d,m){if(n=+n,r=r>>>0,!m){const ae=Math.pow(2,8*d-1);E(this,n,r,d,ae-1,-ae)}let y=0,C=1,$=0;for(this[r]=n&255;++y<d&&(C*=256);)n<0&&$===0&&this[r+y-1]!==0&&($=1),this[r+y]=(n/C>>0)-$&255;return r+d},u.prototype.writeIntBE=function(n,r,d,m){if(n=+n,r=r>>>0,!m){const ae=Math.pow(2,8*d-1);E(this,n,r,d,ae-1,-ae)}let y=d-1,C=1,$=0;for(this[r+y]=n&255;--y>=0&&(C*=256);)n<0&&$===0&&this[r+y+1]!==0&&($=1),this[r+y]=(n/C>>0)-$&255;return r+d},u.prototype.writeInt8=function(n,r,d){return n=+n,r=r>>>0,d||E(this,n,r,1,127,-128),n<0&&(n=255+n+1),this[r]=n&255,r+1},u.prototype.writeInt16LE=function(n,r,d){return n=+n,r=r>>>0,d||E(this,n,r,2,32767,-32768),this[r]=n&255,this[r+1]=n>>>8,r+2},u.prototype.writeInt16BE=function(n,r,d){return n=+n,r=r>>>0,d||E(this,n,r,2,32767,-32768),this[r]=n>>>8,this[r+1]=n&255,r+2},u.prototype.writeInt32LE=function(n,r,d){return n=+n,r=r>>>0,d||E(this,n,r,4,2147483647,-2147483648),this[r]=n&255,this[r+1]=n>>>8,this[r+2]=n>>>16,this[r+3]=n>>>24,r+4},u.prototype.writeInt32BE=function(n,r,d){return n=+n,r=r>>>0,d||E(this,n,r,4,2147483647,-2147483648),n<0&&(n=4294967295+n+1),this[r]=n>>>24,this[r+1]=n>>>16,this[r+2]=n>>>8,this[r+3]=n&255,r+4},u.prototype.writeBigInt64LE=Oe(function(n,r=0){return se(this,n,r,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),u.prototype.writeBigInt64BE=Oe(function(n,r=0){return Ce(this,n,r,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function ue(c,n,r,d,m,y){if(r+d>c.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function H(c,n,r,d,m){return n=+n,r=r>>>0,m||ue(c,n,r,4),s.write(c,n,r,d,23,4),r+4}u.prototype.writeFloatLE=function(n,r,d){return H(this,n,r,!0,d)},u.prototype.writeFloatBE=function(n,r,d){return H(this,n,r,!1,d)};function K(c,n,r,d,m){return n=+n,r=r>>>0,m||ue(c,n,r,8),s.write(c,n,r,d,52,8),r+8}u.prototype.writeDoubleLE=function(n,r,d){return K(this,n,r,!0,d)},u.prototype.writeDoubleBE=function(n,r,d){return K(this,n,r,!1,d)},u.prototype.copy=function(n,r,d,m){if(!u.isBuffer(n))throw new TypeError("argument should be a Buffer");if(d||(d=0),!m&&m!==0&&(m=this.length),r>=n.length&&(r=n.length),r||(r=0),m>0&&m<d&&(m=d),m===d||n.length===0||this.length===0)return 0;if(r<0)throw new RangeError("targetStart out of bounds");if(d<0||d>=this.length)throw new RangeError("Index out of range");if(m<0)throw new RangeError("sourceEnd out of bounds");m>this.length&&(m=this.length),n.length-r<m-d&&(m=n.length-r+d);const y=m-d;return this===n&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(r,d,m):Uint8Array.prototype.set.call(n,this.subarray(d,m),r),y},u.prototype.fill=function(n,r,d,m){if(typeof n=="string"){if(typeof r=="string"?(m=r,r=0,d=this.length):typeof d=="string"&&(m=d,d=this.length),m!==void 0&&typeof m!="string")throw new TypeError("encoding must be a string");if(typeof m=="string"&&!u.isEncoding(m))throw new TypeError("Unknown encoding: "+m);if(n.length===1){const C=n.charCodeAt(0);(m==="utf8"&&C<128||m==="latin1")&&(n=C)}}else typeof n=="number"?n=n&255:typeof n=="boolean"&&(n=Number(n));if(r<0||this.length<r||this.length<d)throw new RangeError("Out of range index");if(d<=r)return this;r=r>>>0,d=d===void 0?this.length:d>>>0,n||(n=0);let y;if(typeof n=="number")for(y=r;y<d;++y)this[y]=n;else{const C=u.isBuffer(n)?n:u.from(n,m),$=C.length;if($===0)throw new TypeError('The value "'+n+'" is invalid for argument "value"');for(y=0;y<d-r;++y)this[y+r]=C[y%$]}return this};const le={};function oe(c,n,r){le[c]=class extends r{constructor(){super(),Object.defineProperty(this,"message",{value:n.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${c}]`,this.stack,delete this.name}get code(){return c}set code(m){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:m,writable:!0})}toString(){return`${this.name} [${c}]: ${this.message}`}}}oe("ERR_BUFFER_OUT_OF_BOUNDS",function(c){return c?`${c} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),oe("ERR_INVALID_ARG_TYPE",function(c,n){return`The "${c}" argument must be of type number. Received type ${typeof n}`},TypeError),oe("ERR_OUT_OF_RANGE",function(c,n,r){let d=`The value of "${c}" is out of range.`,m=r;return Number.isInteger(r)&&Math.abs(r)>2**32?m=Re(String(r)):typeof r=="bigint"&&(m=String(r),(r>BigInt(2)**BigInt(32)||r<-(BigInt(2)**BigInt(32)))&&(m=Re(m)),m+="n"),d+=` It must be ${n}. Received ${m}`,d},RangeError);function Re(c){let n="",r=c.length;const d=c[0]==="-"?1:0;for(;r>=d+4;r-=3)n=`_${c.slice(r-3,r)}${n}`;return`${c.slice(0,r)}${n}`}function he(c,n,r){Me(n,"offset"),(c[n]===void 0||c[n+r]===void 0)&&Se(n,c.length-(r+1))}function Ze(c,n,r,d,m,y){if(c>r||c<n){const C=typeof n=="bigint"?"n":"";let $;throw n===0||n===BigInt(0)?$=`>= 0${C} and < 2${C} ** ${(y+1)*8}${C}`:$=`>= -(2${C} ** ${(y+1)*8-1}${C}) and < 2 ** ${(y+1)*8-1}${C}`,new le.ERR_OUT_OF_RANGE("value",$,c)}he(d,m,y)}function Me(c,n){if(typeof c!="number")throw new le.ERR_INVALID_ARG_TYPE(n,"number",c)}function Se(c,n,r){throw Math.floor(c)!==c?(Me(c,r),new le.ERR_OUT_OF_RANGE("offset","an integer",c)):n<0?new le.ERR_BUFFER_OUT_OF_BOUNDS:new le.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${n}`,c)}const it=/[^+/0-9A-Za-z-_]/g;function Ue(c){if(c=c.split("=")[0],c=c.trim().replace(it,""),c.length<2)return"";for(;c.length%4!==0;)c=c+"=";return c}function Ft(c,n){n=n||1/0;let r;const d=c.length;let m=null;const y=[];for(let C=0;C<d;++C){if(r=c.charCodeAt(C),r>55295&&r<57344){if(!m){if(r>56319){(n-=3)>-1&&y.push(239,191,189);continue}else if(C+1===d){(n-=3)>-1&&y.push(239,191,189);continue}m=r;continue}if(r<56320){(n-=3)>-1&&y.push(239,191,189),m=r;continue}r=(m-55296<<10|r-56320)+65536}else m&&(n-=3)>-1&&y.push(239,191,189);if(m=null,r<128){if((n-=1)<0)break;y.push(r)}else if(r<2048){if((n-=2)<0)break;y.push(r>>6|192,r&63|128)}else if(r<65536){if((n-=3)<0)break;y.push(r>>12|224,r>>6&63|128,r&63|128)}else if(r<1114112){if((n-=4)<0)break;y.push(r>>18|240,r>>12&63|128,r>>6&63|128,r&63|128)}else throw new Error("Invalid code point")}return y}function Lr(c){const n=[];for(let r=0;r<c.length;++r)n.push(c.charCodeAt(r)&255);return n}function Wr(c,n){let r,d,m;const y=[];for(let C=0;C<c.length&&!((n-=2)<0);++C)r=c.charCodeAt(C),d=r>>8,m=r%256,y.push(m),y.push(d);return y}function En(c){return e.toByteArray(Ue(c))}function ft(c,n,r,d){let m;for(m=0;m<d&&!(m+r>=n.length||m>=c.length);++m)n[m+r]=c[m];return m}function Ae(c,n){return c instanceof n||c!=null&&c.constructor!=null&&c.constructor.name!=null&&c.constructor.name===n.name}function Dt(c){return c!==c}const Gr=function(){const c="0123456789abcdef",n=new Array(256);for(let r=0;r<16;++r){const d=r*16;for(let m=0;m<16;++m)n[d+m]=c[r]+c[m]}return n}();function Oe(c){return typeof BigInt>"u"?$r:c}function $r(){throw new Error("BigInt not supported")}})(_n);function wd(t){if(typeof t!="string")throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!t)throw new Error("No input");const e=JSON.parse(t),s=e;let a;if(s.type==="system")if(s.event==="connected")a=Object.assign(Object.assign({},e),{kind:"connected"});else if(s.event==="disconnected")a=Object.assign(Object.assign({},e),{kind:"disconnected"});else return null;else if(s.type==="message")if(s.from==="group"){const i=rs(e.data,e.dataType);if(i===null)return null;a=Object.assign(Object.assign({},e),{data:i,kind:"groupData"})}else if(s.from==="server"){const i=rs(e.data,e.dataType);if(i===null)return null;a=Object.assign(Object.assign({},e),{data:i,kind:"serverData"})}else return null;else if(s.type==="ack")a=Object.assign(Object.assign({},e),{kind:"ack"});else return null;return a}function bd(t){let e;switch(t.kind){case"joinGroup":{e={type:"joinGroup",group:t.group,ackId:t.ackId};break}case"leaveGroup":{e={type:"leaveGroup",group:t.group,ackId:t.ackId};break}case"sendEvent":{e={type:"event",event:t.event,ackId:t.ackId,dataType:t.dataType,data:ss(t.data,t.dataType)};break}case"sendToGroup":{e={type:"sendToGroup",group:t.group,ackId:t.ackId,dataType:t.dataType,data:ss(t.data,t.dataType),noEcho:t.noEcho};break}case"sequenceAck":{e={type:"sequenceAck",sequenceId:t.sequenceId};break}default:throw new Error(`Unsupported type: ${t.kind}`)}return JSON.stringify(e)}function ss(t,e){switch(e){case"text":{if(typeof t!="string")throw new TypeError("Message must be a string.");return t}case"json":return t;case"binary":case"protobuf":{if(t instanceof ArrayBuffer)return _n.Buffer.from(t).toString("base64");throw new TypeError("Message must be a ArrayBuffer")}}}function rs(t,e){if(e==="text"){if(typeof t!="string")throw new TypeError("Message must be a string when dataType is text");return t}else{if(e==="json")return t;if(e==="binary"||e==="protobuf"){const s=_n.Buffer.from(t,"base64");return s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength)}else return null}}class Cd{constructor(){this.isReliableSubProtocol=!0,this.name="json.reliable.webpubsub.azure.v1"}parseMessages(e){return wd(e)}writeMessage(e){return bd(e)}}const Sd=()=>new Cd;var ve;(function(t){t.Stopped="Stopped",t.Disconnected="Disconnected",t.Connecting="Connecting",t.Connected="Connected",t.Recovering="Recovering"})(ve||(ve={}));class Id{nextAckId(){return this._ackId=this._ackId+1,this._ackId}constructor(e,s){this._quickSequenceAckDiff=300,this._activeTimeoutInMs=2e4,this._emitter=new Oi,this._isStopping=!1,this._isInitialConnected=!1,typeof e=="string"?this._credential={getClientAccessUrl:e}:this._credential=e,s==null&&(s={}),this._buildDefaultOptions(s),this._options=s,this._messageRetryPolicy=new os(this._options.messageRetryOptions),this._reconnectRetryPolicy=new os(this._options.reconnectRetryOptions),this._protocol=this._options.protocol,this._groupMap=new Map,this._ackMap=new Map,this._sequenceId=new Md,this._state=ve.Stopped,this._ackId=0}async start(e){if(this._isStopping)throw new Error("Can't start a client during stopping");if(this._state!==ve.Stopped)throw new Error("Client can be only started when it's Stopped");let s;e&&(s=e.abortSignal),this._activeKeepaliveTask||(this._activeKeepaliveTask=this._getActiveKeepaliveTask());try{await this._startCore(s)}catch(a){throw this._changeState(ve.Stopped),this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0),this._isStopping=!1,a}}async _startFromRestarting(e){if(this._state!==ve.Disconnected)throw new Error("Client can be only restarted when it's Disconnected");try{me.verbose("Staring reconnecting."),await this._startCore(e)}catch(s){throw this._changeState(ve.Disconnected),s}}async _startCore(e){if(this._changeState(ve.Connecting),me.info("Staring a new connection"),this._sequenceId.reset(),this._isInitialConnected=!1,this._lastCloseEvent=void 0,this._lastDisconnectedMessage=void 0,this._connectionId=void 0,this._reconnectionToken=void 0,this._uri=void 0,typeof this._credential.getClientAccessUrl=="string"?this._uri=this._credential.getClientAccessUrl:this._uri=await this._credential.getClientAccessUrl({abortSignal:e}),typeof this._uri!="string")throw new Error(`The clientAccessUrl must be a string but currently it's ${typeof this._uri}`);await this._connectCore(this._uri)}stop(){this._state===ve.Stopped||this._isStopping||(this._isStopping=!0,this._wsClient&&this._wsClient.isOpen()?this._wsClient.close():this._isStopping=!1,this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0))}on(e,s){this._emitter.on(e,s)}off(e,s){this._emitter.removeListener(e,s)}_emitEvent(e,s){this._emitter.emit(e,s)}async sendEvent(e,s,a,i){return await this._operationExecuteWithRetry(()=>this._sendEventAttempt(e,s,a,i),i?.abortSignal)}async _sendEventAttempt(e,s,a,i){var l;if(!((l=i?.fireAndForget)!==null&&l!==void 0?l:!1))return await this._sendMessageWithAckId(p=>({kind:"sendEvent",dataType:a,data:s,ackId:p,event:e}),i?.ackId,i?.abortSignal);const u={kind:"sendEvent",dataType:a,data:s,event:e};return await this._sendMessage(u,i?.abortSignal),{isDuplicated:!1}}async joinGroup(e,s){return await this._operationExecuteWithRetry(()=>this._joinGroupAttempt(e,s),s?.abortSignal)}async _joinGroupAttempt(e,s){const a=this._getOrAddGroup(e),i=await this._joinGroupCore(e,s);return a.isJoined=!0,i}async _joinGroupCore(e,s){return await this._sendMessageWithAckId(a=>({group:e,ackId:a,kind:"joinGroup"}),s?.ackId,s?.abortSignal)}async leaveGroup(e,s){return await this._operationExecuteWithRetry(()=>this._leaveGroupAttempt(e,s),s?.abortSignal)}async _leaveGroupAttempt(e,s){const a=this._getOrAddGroup(e),i=await this._sendMessageWithAckId(l=>({group:e,ackId:l,kind:"leaveGroup"}),s?.ackId,s?.abortSignal);return a.isJoined=!1,i}async sendToGroup(e,s,a,i){return await this._operationExecuteWithRetry(()=>this._sendToGroupAttempt(e,s,a,i),i?.abortSignal)}async _sendToGroupAttempt(e,s,a,i){var l,h;const u=(l=i?.fireAndForget)!==null&&l!==void 0?l:!1,p=(h=i?.noEcho)!==null&&h!==void 0?h:!1;if(!u)return await this._sendMessageWithAckId(v=>({kind:"sendToGroup",group:e,dataType:a,data:s,ackId:v,noEcho:p}),i?.ackId,i?.abortSignal);const g={kind:"sendToGroup",group:e,dataType:a,data:s,noEcho:p};return await this._sendMessage(g,i?.abortSignal),{isDuplicated:!1}}_getWebSocketClientFactory(){return new Li}async _trySendSequenceAck(){if(!this._protocol.isReliableSubProtocol)return;const[e,s]=this._sequenceId.tryGetSequenceId();if(e&&s){const a={kind:"sequenceAck",sequenceId:s};try{await this._sendMessage(a)}catch{this._sequenceId.tryUpdate(s)}}}_connectCore(e){if(this._isStopping)throw new Error("Can't start a client during stopping");return new Promise((s,a)=>{const i=this._wsClient=this._getWebSocketClientFactory().create(e,this._protocol.name);i.onopen(()=>{if(this._isStopping){try{i.close()}catch{}a(new Error("The client is stopped"))}me.verbose("WebSocket connection has opened"),this._changeState(ve.Connected),this._protocol.isReliableSubProtocol&&(this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),this._sequenceAckTask=new as(async()=>{await this._trySendSequenceAck()},1e3)),s()}),i.onerror(l=>{this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),a(l)}),i.onclose((l,h)=>{this._state===ve.Connected?(me.verbose("WebSocket closed after open"),this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),me.info(`WebSocket connection closed. Code: ${l}, Reason: ${h}`),this._lastCloseEvent={code:l,reason:h},this._handleConnectionClose.call(this)):(me.verbose("WebSocket closed before open"),a(new Error(`Failed to start WebSocket: ${l}`)))}),i.onmessage(l=>{const h=f=>{if(this._ackMap.has(f.ackId)){const x=this._ackMap.get(f.ackId);this._ackMap.delete(f.ackId);const b=f.error!=null&&f.error.name==="Duplicate";f.success||b?x.resolve({ackId:f.ackId,isDuplicated:b}):x.reject(new pt("Failed to send message.",{ackId:f.ackId,errorDetail:f.error}))}},u=async f=>{if(this._connectionId=f.connectionId,this._reconnectionToken=f.reconnectionToken,!this._isInitialConnected){if(this._isInitialConnected=!0,this._options.autoRejoinGroups){const x=[];this._groupMap.forEach(b=>{b.isJoined&&x.push((async()=>{try{await this._joinGroupCore(b.name)}catch(S){this._safeEmitRejoinGroupFailed(b.name,S)}})())});try{await Promise.all(x)}catch{}}this._safeEmitConnected(f.connectionId,f.userId)}},p=f=>{this._lastDisconnectedMessage=f},g=f=>{if(f.sequenceId!=null){const x=this._sequenceId.tryUpdate(f.sequenceId);if(x===0)return;x>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitGroupMessage(f)},v=f=>{if(f.sequenceId!=null){const x=this._sequenceId.tryUpdate(f.sequenceId);if(x===0)return;x>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitServerMessage(f)};let w;try{let f;if(Array.isArray(l)?f=Buffer.concat(l):f=l,w=this._protocol.parseMessages(f),w===null)return}catch(f){throw me.warning("An error occurred while parsing the message from service",f),f}Array.isArray(w)||(w=[w]),w.forEach(f=>{try{switch(f.kind){case"ack":{h(f);break}case"connected":{u(f);break}case"disconnected":{p(f);break}case"groupData":{g(f);break}case"serverData":{v(f);break}}}catch(x){me.warning(`An error occurred while handling the message with kind: ${f.kind} from service`,x)}})})})}async _handleConnectionCloseAndNoRecovery(){this._state=ve.Disconnected,this._safeEmitDisconnected(this._connectionId,this._lastDisconnectedMessage),this._options.autoReconnect?await this._autoReconnect():await this._handleConnectionStopped()}async _autoReconnect(){let e=!1,s=0;try{for(;!this._isStopping;)try{await this._startFromRestarting(),e=!0;break}catch(a){me.warning("An attempt to reconnect connection failed.",a),s++;const i=this._reconnectRetryPolicy.nextRetryDelayInMs(s);if(i==null)break;try{me.verbose(`Delay time for reconnect attempt ${s}: ${i}`),await yt(i)}catch{}}}finally{e||this._handleConnectionStopped()}}_handleConnectionStopped(){this._isStopping=!1,this._state=ve.Stopped,this._safeEmitStopped()}_getActiveKeepaliveTask(){return new as(async()=>{this._sequenceId.tryUpdate(0)},this._activeTimeoutInMs)}async _sendMessage(e,s){if(!this._wsClient||!this._wsClient.isOpen())throw new Error("The connection is not connected.");const a=this._protocol.writeMessage(e);await this._wsClient.send(a,s)}async _sendMessageWithAckId(e,s,a){s==null&&(s=this.nextAckId());const i=e(s);this._ackMap.has(s)||this._ackMap.set(s,new Ed(s));const l=this._ackMap.get(s);try{await this._sendMessage(i,a)}catch(h){this._ackMap.delete(s);let u="";throw h instanceof Error&&(u=h.message),new pt(u,{ackId:s})}if(a)try{return await Wi(l.promise(),a)}catch(h){throw h instanceof Error&&h.name==="AbortError"?new pt("Cancelled by abortSignal",{ackId:s}):h}return await l.promise()}async _handleConnectionClose(){if(this._ackMap.forEach((i,l)=>{this._ackMap.delete(l)&&i.reject(new pt("Connection is disconnected before receive ack from the service",{ackId:i.ackId}))}),this._isStopping){me.warning("The client is stopping state. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(this._lastCloseEvent&&this._lastCloseEvent.code===1008){me.warning("The websocket close with status code 1008. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(!this._protocol.isReliableSubProtocol){me.warning("The protocol is not reliable, recovery is not applicable"),this._handleConnectionCloseAndNoRecovery();return}const e=this._buildRecoveryUri();if(!e){me.warning("Connection id or reconnection token is not available"),this._handleConnectionCloseAndNoRecovery();return}let s=!1;this._state=ve.Recovering;const a=Qs.timeout(30*1e3);try{for(;!a.aborted||this._isStopping;)try{await this._connectCore.call(this,e),s=!0;return}catch{await yt(1e3)}}finally{s||(me.warning("Recovery attempts failed more then 30 seconds or the client is stopping"),this._handleConnectionCloseAndNoRecovery())}}_safeEmitConnected(e,s){this._emitEvent("connected",{connectionId:e,userId:s})}_safeEmitDisconnected(e,s){this._emitEvent("disconnected",{connectionId:e,message:s})}_safeEmitGroupMessage(e){this._emitEvent("group-message",{message:e})}_safeEmitServerMessage(e){this._emitEvent("server-message",{message:e})}_safeEmitStopped(){this._emitEvent("stopped",{})}_safeEmitRejoinGroupFailed(e,s){this._emitEvent("rejoin-group-failed",{group:e,error:s})}_buildDefaultOptions(e){return e.autoReconnect==null&&(e.autoReconnect=!0),e.autoRejoinGroups==null&&(e.autoRejoinGroups=!0),e.protocol==null&&(e.protocol=Sd()),this._buildMessageRetryOptions(e),this._buildReconnectRetryOptions(e),e}_buildMessageRetryOptions(e){e.messageRetryOptions||(e.messageRetryOptions={}),(e.messageRetryOptions.maxRetries==null||e.messageRetryOptions.maxRetries<0)&&(e.messageRetryOptions.maxRetries=3),(e.messageRetryOptions.retryDelayInMs==null||e.messageRetryOptions.retryDelayInMs<0)&&(e.messageRetryOptions.retryDelayInMs=1e3),(e.messageRetryOptions.maxRetryDelayInMs==null||e.messageRetryOptions.maxRetryDelayInMs<0)&&(e.messageRetryOptions.maxRetryDelayInMs=3e4),e.messageRetryOptions.mode==null&&(e.messageRetryOptions.mode="Fixed")}_buildReconnectRetryOptions(e){e.reconnectRetryOptions||(e.reconnectRetryOptions={}),(e.reconnectRetryOptions.maxRetries==null||e.reconnectRetryOptions.maxRetries<0)&&(e.reconnectRetryOptions.maxRetries=Number.MAX_VALUE),(e.reconnectRetryOptions.retryDelayInMs==null||e.reconnectRetryOptions.retryDelayInMs<0)&&(e.reconnectRetryOptions.retryDelayInMs=1e3),(e.reconnectRetryOptions.maxRetryDelayInMs==null||e.reconnectRetryOptions.maxRetryDelayInMs<0)&&(e.reconnectRetryOptions.maxRetryDelayInMs=3e4),e.reconnectRetryOptions.mode==null&&(e.reconnectRetryOptions.mode="Fixed")}_buildRecoveryUri(){if(this._connectionId&&this._reconnectionToken&&this._uri){const e=new URL(this._uri);return e.searchParams.append("awps_connection_id",this._connectionId),e.searchParams.append("awps_reconnection_token",this._reconnectionToken),e.toString()}return null}_getOrAddGroup(e){return this._groupMap.has(e)||this._groupMap.set(e,new kd(e)),this._groupMap.get(e)}_changeState(e){me.verbose(`The client state transfer from ${this._state.toString()} to ${e.toString()}`),this._state=e}async _operationExecuteWithRetry(e,s){let a=0;for(;;)try{return await e.call(this)}catch(i){a++;const l=this._messageRetryPolicy.nextRetryDelayInMs(a);if(l==null||(await yt(l),s?.aborted))throw i}}}class os{constructor(e){this._retryOptions=e,this._maxRetriesToGetMaxDelay=Math.ceil(Math.log2(this._retryOptions.maxRetryDelayInMs)-Math.log2(this._retryOptions.retryDelayInMs)+1)}nextRetryDelayInMs(e){return e>this._retryOptions.maxRetries?null:this._retryOptions.mode==="Fixed"?this._retryOptions.retryDelayInMs:this._calculateExponentialDelay(e)}_calculateExponentialDelay(e){return e>=this._maxRetriesToGetMaxDelay?this._retryOptions.maxRetryDelayInMs:(1<<e-1)*this._retryOptions.retryDelayInMs}}class kd{constructor(e){this.isJoined=!1,this.name=e}}class Ed{constructor(e){this._promise=new Promise((s,a)=>{this._resolve=s,this._reject=a}),this.ackId=e}promise(){return this._promise}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}class Md{constructor(){this._sequenceId=0,this._isUpdate=!1}tryUpdate(e){if(this._isUpdate=!0,e>this._sequenceId){const s=e-this._sequenceId;return this._sequenceId=e,s}return 0}tryGetSequenceId(){return this._isUpdate?(this._isUpdate=!1,[!0,this._sequenceId]):[!1,null]}reset(){this._sequenceId=0,this._isUpdate=!1}}class as{constructor(e,s,a){this._func=e,this._abortController=new Qs,this._interval=s,this._obj=a,this._start()}abort(){try{this._abortController.abort()}catch{}}async _start(){const e=this._abortController.signal;for(;!e.aborted;)try{await this._func(this._obj)}catch{}finally{await yt(this._interval)}}}const Td=1e3*60*60,jd=1e3*30;class Rd{client;handler;terminationTimeout=null;connectionUrl;expiresAt;connected=!1;websocketRequestId=null;conversationId=null;secondaryTypeBasedHandlers=new Map;constructor(e,s,a,i=null,l=new Map){this.connectionUrl=s,this.expiresAt=a,this.client=new Id({getClientAccessUrl:()=>e(this.connectionUrl,this.expiresAt)},{autoReconnect:!0,reconnectRetryOptions:{maxRetries:5,retryDelayInMs:100,maxRetryDelayInMs:1e4,mode:"Exponential"}}),this.handler=i,this.secondaryTypeBasedHandlers=l}async start(){const e=s=>{if(this.secondaryTypeBasedHandlers.has(s.message.data.type)){const a=this.secondaryTypeBasedHandlers.get(s.message.data.type);if(!a)return;a(s.message.data)}else{const a=s.message.data.body,i=atob(a).trim();if(i.startsWith("data: ")){const l=i.replace("data: ",""),h=this.handler;if(!h)return;h({conversationId:s.message.data.conversation_id,responseId:s.message.data.response_id,message:{id:"",event:"",data:l},websocketRequestId:s.message.data.websocket_request_id})}}};this.client.on("group-message",s=>e(s)),this.client.on("server-message",s=>e(s)),this.client.on("connected",()=>{this.connected=!0}),this.client.on("disconnected",()=>{this.connected=!1}),await this.client.start()}addSecondaryTypeHandler(e,s){this.secondaryTypeBasedHandlers.set(e,s)}isConnected(){return this.connected}async stop(e){e&&this.conversationId!==e||this.websocketRequestId&&await Be.stopWebsocketConversation(this.websocketRequestId)}setHandler(e,s,a,i){!this.handler&&this.websocketRequestId===a||(this.handler!=null&&this.websocketRequestId!==a&&(uo.warn("[websockets] Overwriting existing handler without silencing. This may indicate a race condition."),U.logEvent(O.asyncHandlerOverwritten,{originalWebsocketRequestId:this.websocketRequestId,newWebsocketRequestId:a,conversationId:e,responseId:s})),this.websocketRequestId=a,this.conversationId=e,this.handler=l=>{(l.websocketRequestId===a||l.conversationId===e&&l.responseId===s)&&i(l.message)})}silence(){this.handler=null}close(){this.client.stop()}scheduleForTermination(e){this.terminationTimeout=setTimeout(()=>{this.close(),e()},Td)}preventTermination(){this.terminationTimeout&&(clearTimeout(this.terminationTimeout),this.terminationTimeout=null)}updateConnectionUrl(e,s){this.connectionUrl=e,this.expiresAt=s}}class Ad{activeSocketMap=new Map;secondaryTypeBasedHandlers=new Map;async register(){const e=await Be.postRegisterWebsocket();e.wss_url&&(this.getOrCreateSocket(e.wss_url,new Date(e.expires_at),!0),e.fallback_wss_url&&this.getOrCreateSocket(e.fallback_wss_url,new Date(e.expires_at),!1))}async registerIfNotConnected(){if(this.activeSocketMap.size===0){await this.register();return}for(const e of this.activeSocketMap.values())if(!e.isConnected()){await this.register();return}}isWebsocketConnected(){for(const e of this.activeSocketMap.values())if(e.isConnected())return!0;return this.activeSocketMap.size>0&&Ee.addError("Cannot connect to any websocket."),!1}async getOrCreateSocket(e,s,a){const i=e.split("?")[0];let l;const h=this.activeSocketMap.get(i);if(h&&h.isConnected())h.preventTermination(),h.updateConnectionUrl(e,s),l=h;else{h&&h.close(),l=new Rd(async(u,p)=>{if(new Date<new Date(p.getTime()-5*1e3))return u;const g=await Be.postRegisterWebsocket();return a?g.wss_url:g.fallback_wss_url??""},e,s,null,this.secondaryTypeBasedHandlers),this.activeSocketMap.set(i,l);try{await l.start()}catch(u){throw Ee.addError(new Error("Error occurred while starting websocket: ",{cause:u})),u}}return l}preSetupWebsocket(e,s,a){for(const i of this.activeSocketMap.values())this.setupWebSocketHandler(i,null,null,null,e,s,a)}addSecondaryTypeHandler(e,s){this.secondaryTypeBasedHandlers.set(e,s);for(const a of this.activeSocketMap.values())a.addSecondaryTypeHandler(e,s)}hasSecondaryTypeHandler(e){return this.secondaryTypeBasedHandlers.has(e)}async processWebSocketConversationStream(e,s,a,i,l,h,u,p,g){const v=[this.getOrCreateSocket(e,a,!0)];s&&v.push(this.getOrCreateSocket(s,a,!1));const w=await Promise.allSettled(v),f=w[0].status==="fulfilled"?w[0].value:null,x=w.length>1&&w[1].status==="fulfilled"?w[1].value:null;if((!f||!f.isConnected())&&Ee.addError(`Cannot connect to primary websocket, websocketRequestId: ${h}, token: ${e.substring(0,e.indexOf("access_token="))}`),(!f||!f.isConnected())&&(!x||!x.isConnected()))throw s&&Ee.addError(`Cannot connect to fallback websocket, websocketRequestId: ${h}, token: ${s.substring(0,s.indexOf("access_token="))}`),we.createWithErrorMessage("websocket","server",`An error occurred while connecting to the websocket. ${Zt}`);let b=setTimeout(()=>{Ee.addError(`WebSocket took too long to respond: ${l}, ${i}, ${h}, ${e.substring(0,60)}...${e.slice(-20)}`,{supportsWebSockets:"WebSocket"in window&&window.WebSocket.CLOSING===2})},jd);const S=k=>(g&&(clearTimeout(g),g=null),b&&(clearTimeout(b),b=null),u(k));f&&this.setupWebSocketHandler(f,e,i,l,h,S,p),x&&s&&this.setupWebSocketHandler(x,s,i,l,h,S,p)}async stopConversation(e){for(const s of this.activeSocketMap.values())await s.stop(e)}setupWebSocketHandler(e,s,a,i,l,h,u){e.setHandler(a,i,l,h),this.secondaryTypeBasedHandlers.forEach((g,v)=>{e.addSecondaryTypeHandler(v,g)});const p=()=>{s?e.scheduleForTermination(()=>{this.activeSocketMap.delete(s.split("?")[0])}):(this.stopConversation(a),e.silence())};u.addEventListener("abort",p)}}const In=new Ad;function Nd(t){return{webSocketUrl:t.wss_url,fallbackWebSocketUrl:t.fallback_wss_url,conversationId:t.conversation_id,responseId:t.response_id,expiresAt:t.expires_at&&new Date(t.expires_at),websocketRequestId:t.websocket_request_id}}async function Bd(t,e,s){return In.preSetupWebsocket(t,e,s)}async function Fd(t,e,s,a,i,l,h,u,p){return In.processWebSocketConversationStream(t,e,s,a,i,l,h,u,p)}const ct=t=>{switch(t.type){case fe.Reply:return t.text;case fe.Starter:case fe.Autocomplete:return t.prompt}},Dd=t=>t.type===fe.Reply,Fr=t=>t.type===fe.Starter,kn=t=>t.type===fe.Autocomplete,_t=t=>kn(t)&&!!t.theme,qh=(t,e,s,a)=>{switch(de.logEvent("chatgpt_prompt_use_suggestion",kn(t)&&!_t(t)?"":ct(t),{id:Fr(t)||_t(t)?t.id??"":"",index:`${e}`,type:t.type}),t.type){case fe.Reply:U.logEvent(O.useSuggestedReply,{value:ct(t),prompt_type:fe.Reply,messageId:a});break;case fe.Starter:U.logEvent(O.useStarterPrompt,{value:ct(t),prompt_type:fe.Starter,title:t.title,body:t.body,id:t.id,category:t.category,client_thread_id:s,messageId:a,index:e,theme:t.theme});break;case fe.Autocomplete:{const i=_t(t);U.logEvent(O.useAutocomplete,{value:i?ct(t):"",prompt_type:fe.Autocomplete,title:i?t.title:"",body:i?t.body:"",id:i?t.id:"",category:t.category,index:e,messageId:a,client_thread_id:s,theme:t.theme??""});break}}},Hh=(t,e)=>{const s=j.getThreadCurrentLeafId(e),a=j.getTree(e).getMessageId(s);if(de.logEvent("chatgpt_prompt_show_suggestions",`count_${t.length}`,{type:t[0].type}),t.every(Dd))U.logEvent(O.showSuggestedReplies,{prompt_count:t.length,prompt_type:fe.Reply,client_thread_id:e,suggestions:t.map(i=>i.text),message_id:a});else if(t.every(Fr)){const{isAdditional:i}=t[0];U.logEvent(i?O.moreStarterPromptsShown:O.showStarterPrompts,{prompt_count:t.length,prompt_type:fe.Starter,titles:t.map(l=>l.title),bodies:t.map(l=>l.body),ids:t.map(l=>l.id),client_thread_id:e,message_id:a,themes:t.map(l=>l.theme??"")}),i&&U.logEvent(O.expandMoreStarterPrompts,{client_thread_id:e,message_id:a})}else if(t.every(kn)){const i=!!t.find(l=>_t(l));U.logEvent(O.showAutocompletePrompts,{prompt_count:t.length,prompt_type:fe.Autocomplete,titles:t.map(l=>i?l.title:""),bodies:t.map(l=>i?l.body:""),ids:t.map(l=>i?l.id:""),client_thread_id:e,message_id:a,themes:t.map(l=>l.theme??"")})}else Ee.addError("Unhandled suggestion type",{type:t[0].type})},zh=t=>{const e=j.getThreadCurrentLeafId(t),s=j.getTree(t).getMessageId(e);U.logEvent(O.showExpandMoreStarterPromptsButton,{client_thread_id:t,message_id:s})},Vh=t=>{const e=j.getThreadCurrentLeafId(t),s=j.getTree(t).getMessageId(e);U.logEvent(O.expandMoreStarterPrompts,{client_thread_id:t,message_id:s})},Pd="OAI-Echo-Logs",tt={FOCUS_IN:0,FOCUS_OUT:1,COPY:2,PASTE:3,TOUCH_START:4,TOUCH_END:5},Dr=[];function nt(t){return()=>{Dr.push({type:t,ts:Math.round(performance.now())})}}const Ud={focusin:nt(tt.FOCUS_IN),focusout:nt(tt.FOCUS_OUT),copy:nt(tt.COPY),paste:nt(tt.PASTE),touchstart:nt(tt.TOUCH_START),touchend:nt(tt.TOUCH_END)};function Kh(t){const e=t??document.getElementById(zc);for(const[s,a]of Object.entries(Ud))e?.removeEventListener(s,a),e?.addEventListener(s,a)}function Od(){return{[Pd]:Dr.slice(0,10).map(t=>`${t.type},${t.ts}`).join(",")}}const Ld=1e3*30,Qt=Cs.getTracer("completion");class Yt extends Error{}function Wd(t,e,s,a){return(async(l=null)=>{Gi()&&await $i();const h=new AbortController,u="threadId"in e?e.threadId:void 0,p="continueFromSharedConversationId"in e?e.continueFromSharedConversationId:void 0,g=ho(),v=de.checkGate("1987334402"),w=de.checkGate("2964350589"),f=[v&&et.V1,w&&et.V1_TEST].filter(Boolean),x={action:e.completionType,messages:e.messages.length>0?e.messages:void 0,conversation_id:u,continue_from_shared_conversation_id:u!=null?void 0:p,parent_message_id:e.parentMessageId,model:e.model,timezone_offset_min:new Date().getTimezoneOffset(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,variant_purpose:e.completionMetadata?.variantPurpose,suggestions:e.completionMetadata?.suggestions?e.completionMetadata.suggestions.map(R=>ct(R)):void 0,chosen_suggestion:e.completionMetadata?.suggestion?{type:e.completionMetadata.suggestion.type,index:e.completionMetadata.suggestionIndex,source:e.completionMetadata?.suggestion.type===fe.Autocomplete?e.completionMetadata.suggestion.source:void 0,user_input:e.completionMetadata?.suggestion.type===fe.Autocomplete?e.completionMetadata.suggestion.userInput:void 0}:void 0,history_and_training_disabled:e.historyDisabled,juice:e.completionMetadata?.juice,conversation_mode:e.completionMetadata?.conversationMode,force_paragen:e.forceParagen,force_paragen_model_slug:e.forceParagenModel,force_indepth_feedback:e.forceIndepthFeedback,force_rate_limit:e.forceRateLimit,reset_rate_limits:e.resetRateLimits,disable_system_content_toggling:e.disableSystemContentToggling,websocket_request_id:g,source:e.completionMetadata?.source,system_hints:e.completionMetadata?.systemHints,prefetch_ids:e.completionMetadata?.prefetchIds,force_use_sse:!In.isWebsocketConnected(),supported_encodings:f,conversation_origin:e.conversationOrigin,force_use_search:e.forceUseSearch,client_reported_search_source:e.completionMetadata?.searchSource,client_contextual_info:e.contextualInfo,paragen_stream_type_override:e.paragenStreamType==="none"?null:e.paragenStreamType,paragen_cot_summary_display_override:e.paragenCotSummaryDisplay},b=de.checkGate("1113464293");b&&(x.supports_buffering=!0),e.turnTracker.stream_buffering=b;let S,k;const B=_s(t);dn(B)?(k="https://chatgpt.com/backend-anon",S=Tn.getUnauthHeaders().additionalHeaders):(k="https://chatgpt.com/backend-api",S=Tn.getAuthedHeadersWithAccessToken(B?.accessToken));const D=`${k}/conversation`;let I=!0,M=!0;const A=fo(e.chatReq,l??e.arkoseToken,e.turnstileToken,e.proofToken,null),F={...S,...Od(),...A};let W,P,L;Qt.startActiveSpan("completion.response",R=>{W=Qt.startSpan("completion.first_response"),P=Qt.startSpan("completion.first_token"),L=R});const q=Cs.setSpan(jn.active(),L);let J=null,ee=null,G,z=!1,X=!1;function Q(){X||(X=!0,s({type:"done"}),Ln())}function N(R){if(e.turnTracker.onBytesReceived(R.data),R.data==="[DONE]")h.abort(),L.end(),Q();else if(R.event!=="ping")try{let E=JSON.parse(R.data);if(R.event==="delta_encoding")if(E===et.V1||E===et.V1_TEST)J=E,e.turnTracker.stream_encoding=J??void 0,ee=new Hi;else{Ee.addError(`[completion-delta] unknown delta encoding: ${E}`);return}else if(R.event==="delta"){if(!ee){Ee.addError("[completion-delta] delta event before delta_encoding");return}const se=ee.applyDelta(E);if(J===et.V1_TEST){!z&&!go(se,G)&&(z=!0,Ee.addError("[completion-delta] delta resulted in a different object",{differences:zi(se,G)}));return}else E=se}else J===et.V1_TEST&&!z&&(G=E);if(E.error){const se=we.createWithErrorMessage(D,"server",E.error);throw s({type:"error",error:se}),se}else"type"in E?E.type==="gizmo_inline_review"?s({type:"gizmo_inline_review",gizmoId:E.gizmo_id}):E.type==="title_generation"?s({type:"title_generation",title:E.title,conversation_id:E.conversation_id}):E.type==="moderation"?s({type:"moderation",conversationId:E.conversation_id,messageId:E.message_id,isCompletion:E.is_completion,flagged:E.moderation_response.flagged,blocked:E.moderation_response.blocked,disclaimers:E.moderation_response.disclaimers,metadata:E.moderation_response.metadata}):E.type==="url_moderation"?s({type:"url_moderation",conversationId:E.conversation_id,messageId:E.message_id,url:E.url_moderation_result.full_url,isSafe:E.url_moderation_result.is_safe}):E.type==="num_variants_in_stream"?s({type:"num_variants_in_stream",num_variants_in_stream:E.num_variants_in_stream,display_treatment:E.display_treatment}):E.type==="conversation_detail_metadata"?s(E):E.type==="message_stream_complete"&&Q():(s({type:"message",message:E.message,conversationId:E.conversation_id}),M&&(M=!1,W.end()),I&&E.message.author.role==="assistant"&&E.message.content.content_type==="text"&&E.message.content.parts[0]!==""&&(I=!1,P.end()))}catch(E){if(E instanceof we)throw E}}let Y=null,V=setTimeout(()=>{Y===!0?(U.logEvent(O.asyncResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:Ct.Error,error:{reason:"timeout",message:"Async Response Took Too Long to Come Back"}})):Y===!1&&(U.logEvent(O.sseResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:Ct.Error,error:{reason:"timeout",message:"SSE Response Took Too Long to Come Back"}}))},Ld);return Bd(g,N,h.signal),jn.with(q,()=>(e.profiler?.logTiming("fetch_event_source"),qi(D,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...F},body:JSON.stringify(x),signal:h.signal,openWhenHidden:!0,async onopen(R){const E=R.headers.get("content-type")??"",se=R.headers.get("Cf-Ray")??null;if(R.ok&&E.includes("text/event-stream")){Y=!1,a(se,e.model,e.turnTracker);return}else if(E.includes("application/json")){const Ce=await R.json(),{webSocketUrl:ue,fallbackWebSocketUrl:H,conversationId:K,responseId:le,expiresAt:oe,websocketRequestId:Re}=Nd(Ce);if(ue!=null&&K!=null&&le!=null&&Re!=null&&oe){Y=!0,a(se,e.model,e.turnTracker);try{await Fd(ue,H,oe,K,le,Re,N,h.signal,V)}catch(he){he instanceof we&&s({type:"error",error:he})}throw new Yt}else{const he=new we(D,R.status,Ce);if(he.isServerError())throw he;if((he?.code==="expired_session_key"||he?.code==="invalid_api_key"||he?.code==="token_expired")&&typeof window<"u"&&window._oaiHandleSessionExpired?.("stream",JSON.stringify(he)),he?.code==="deactivated_workspace"){window.location.href.includes("/workspace/deactivated")||(window.location.href="/workspace/deactivated");return}throw he}}else{const Ce=await R.text();throw new we(D,R.status,{detail:{message:Rn,code:"unexpected_content_type",contentType:E,text:Ce?.substring(0,1e3)}})}},onmessage:R=>{if(Y)throw we.createWithErrorMessage(D,"server",Rn);V&&(clearTimeout(V),V=null),N(R)},onerror(R){let E=R instanceof Error?R:new Error(JSON.stringify(R));throw E instanceof Yt||Y||(E.message==="Failed to fetch"&&(E=we.createWithErrorMessage(D,"server",`An error occurred. Either the engine you requested does not exist or there was another issue processing your request. ${Zt}`)),E.message==="network error"&&(E=we.createWithErrorMessage(D,"client",`A network error occurred. Please check your connection and try again. ${Zt}`)),mo("fetch-error:conversation:new-message",{url:D,message:E?.message}),s({type:"error",error:E}),Ln(E)),E}}))).catch(async R=>{R instanceof Yt||(R instanceof we?po(R):Ee.addError(R),e.turnTracker.handleRawError(R.message??"Something went wrong",R.status))}),h})()}function Gd({clientThreadId:t,continuingFromSharedConversationId:e,onCompletionFinished:s=Jt,onCreate:a=Jt}){const i=ut(),{resolvedTheme:l}=is(),h=l==="dark",u=_.useRef(s),p=xo();u.current=s;const g=_.useCallback(async function({model:v,completionType:w,parentNodeId:f,metadata:x,focusOnNewCompletion:b=!0,completionMetadata:S,chatReq:k,arkoseToken:B,turnstileToken:D,proofToken:I,preflightTime:M,extraStreamParams:A,appendMessages:F,updateTree:W,turnTracker:P,profiler:L}){Ks.publish({kind:"requestCompletion"});const q=j.getTree(t);j.retainThread(t);const J=Dc(),ee=`${Vi}${t}-${J}`,G=`${t}-${J}`;W?.();const z=q.getNodeByIdOrMessageId(f),Q={gizmo_id:z.message.metadata?.gizmo_id};S?.juice!=null&&(Q.snorkle_status=1),j.updateTree(t,H=>{H.addNode(ee,"",f,Ie.Assistant,void 0,Q)}),b&&j.setThreadCurrentLeafId(t,ee);let N,Y=[],V=q.getNodeByIdOrMessageId(z.parentId);for(;V!=null&&(V.metadata?.isPlaceholderTemplateAssistantWelcomeMessage===!0||V.metadata?.isClientCreatedSystemMessage===!0);){const H=V.message;Y.unshift(H);const K=q.getNodeByIdOrMessageId(V.parentId);N=K.message?.id??K.id,V=K}if(w===st.Next||w===st.Variant){const H=q.getNodeByIdOrMessageId(z.parentId);if(N??=H.message?.id??H.id,Y.push(z.message),F){let K=f;j.updateTree(t,le=>{for(const oe of F)le.insertNodeBefore(ee,{id:oe.id,message:oe,parentId:K,children:[]}),K=oe.id}),Y.push(...F)}Y=$d(Y,A)}else N??=z.message.id;const ce=j.getServerThreadId(t);ce===void 0&&wn(t)&&j.updateInitialThreadDataForNewThread(t,v);async function R(H,K){const le=performance.now(),oe=await yo();An.initializeAndGatherData(oe),Wn.initializeAndGatherData(oe),Nn.initializeAndGatherData(oe),j.updateTree(t,Me=>{for(const Se of K)Me.addNode(Se.id,Se,H,Ie.Assistant,{completionSampleFinishTime:Date.now()}),H=Se.id}),j.setThreadCurrentLeafId(t,H);const Re=await An.getEnforcementToken(oe),he=await Wn.getEnforcementToken(oe),Ze=await Nn.getEnforcementToken(oe);g({model:v,completionType:st.Next,parentNodeId:H,metadata:{},chatReq:oe,arkoseToken:Re??null,turnstileToken:he??null,proofToken:Ze??null,preflightTime:performance.now()-le,extraStreamParams:A,turnTracker:P})}P.updateAttachmentCount(Y);const E=new vd(i,t,ee,w,v,x.eventSource,a,G,R,(...H)=>u.current(...H),P,p),se=(H,K,le)=>{H&&le.onReceivedRequestId(H),Qi(G,K,H,M)},Ce={is_dark_mode:h,time_since_loaded:Math.floor(performance.now()/1e3),page_height:window?.innerHeight,page_width:window?.innerWidth,pixel_ratio:window?.devicePixelRatio,screen_height:window?.screen?.height,screen_width:window?.screen?.width},ue=await Wd(i,{conversationOrigin:j.getConversationOrigin(t),model:v,completionType:w,threadId:ce,continueFromSharedConversationId:e,historyDisabled:p,parentMessageId:N,messages:Y,chatReq:k,arkoseToken:B??null,turnstileToken:D??null,proofToken:I??null,completionMetadata:S,...A,turnTracker:P,profiler:L,contextualInfo:Ce},E.handleResponse,se);cr(t,{source:ws.CLIENT,value:bs.STREAMING}),yn.addRequest(ee,ue,P),sn.onCompletionRequestStarted(ee)},[t,i,a,e,p,h]);return g}const $d=(t,e)=>{let s=t;return e?.forceUseSearch===!1&&t.length>0&&(s=t.map(a=>{const{system_hints:i,...l}=a.metadata||{};return{...a,metadata:{...l,system_hints:i?.filter(h=>h!==Ki.Search)}}})),s};function qd({clientThreadId:t,currentModelId:e,defaultModelId:s,onCompletionFinished:a,onThreadCreated:i,preRequestCompletion:l}){const h=Yi(),u=Rt(),{isUnauthenticated:p}=hn(),g=Pc(t),v=ut(),w=vn(t),f=je(),x=Al(t),b=js(),S=un(),{config:k}=ys("1013114931"),B=k.get("show_follow_ups",!1)&&f?.isPersonalAccount(),D=!b.displayingSideBySideFeedback&&B,I=_.useCallback(G=>{const X=j.getTree(t).getLeafFromNode(G);j.setThreadCurrentLeafId(t,X.id)},[t]),M=Ji(e),[A,F]=_.useState(),W=_.useCallback(({nodeId:G,messageId:z,rating:X})=>{const Q=j.getServerThreadId(t);U.logEvent(O.thumbRating,{id:z,threadId:Q,rating:X,model:e});const N=j.getTree(t),Y=N.getNodeByIdOrMessageId(G);if(Q!==void 0&&!M&&Be.submitMessageFeedback({message_id:z,conversation_id:Q,rating:X}),j.updateTree(t,V=>{V.updateNodeMetadata(G,{rating:X})}),M){F(o.jsx(gd,{citations:Y.message.metadata?.citations??[],rating:X,conversationId:Q??"",messageId:z,onSubmit:()=>{F(void 0)},onCancel:()=>F(void 0),conversationTree:N,nodeId:G},`${G}-${X}`));return}},[t,e,M]),P=_.useCallback(G=>{if(G==null||(a?.(G),S)||(w?.kind===ke.GizmoInteraction&&Rc.handleGizmoInteracted(v,w.gizmo_id),!(x||D)))return;const X=j.getThreadCurrentLeafId(G),Q=j.getTree(G).getMessage(X);Xi(Q)||Zi(Q)||ec(G,Q.id,e)},[w,e,a,v,x,D,S]),L=Gd({clientThreadId:t,continuingFromSharedConversationId:g,onCompletionFinished:P,onCreate:i}),q=_.useCallback(()=>{const G=j.getThreadCurrentLeafId(t);if(G==null)return;const X=j.getTree(t).getBranchFromLeaf(G);yn.abortRequests(X.map(Q=>Q.id))},[t]),J=_.useCallback(G=>tc({cancelRequests:q,clientThreadId:t,currentModelId:e,debugSettings:h,defaultModelId:s,isUnauthenticated:p,navigateToAuth:u,preRequestCompletion:l,requestCompletion:L,...G}),[q,t,e,h,s,p,u,l,L]),ee=_.useCallback((G,z,X,Q=!0,N="none",Y)=>{const ce=j.getTree(t).getParentPromptNode(G).id;J({type:st.Variant,promptId:ce,eventMetadata:z,cancelActiveRequests:!1,focusOnNewCompletion:Q,useDefaultModel:Y,completionMetadata:{variantPurpose:N,conversationMode:It.getConversationMode(t)},turnTracker:X})},[t,J]);return{caModal:A,onRequestCompletion:J,onRequestMoreCompletions:ee,onChangeItemInView:I,onChangeRating:W,cancelRequests:q}}function Hd(t){return`https://chatgpt.com${Ac(t)}`}function Qh(t,e,s,a){nc(Hd(t),e,s),a&&e.info(a,{testId:"copy-gizmo-url-toast"})}function Yh(t){return t.some(e=>e.type===_o.JIT_PLUGIN)}function zd(t){return"gizmo_id"in t?t.gizmo_id??null:null}const Vd=t=>["conversation","init",t],Kd=({clientThreadId:t,conversationMode:e,clientModelId:s},a)=>{const i=zd(e),l=wn(t)?null:t;return{gcTime:0,refetchOnWindowFocus:!0,refetchOnMount:"always",queryKey:Vd(t),queryFn:()=>Be.getConversationDetails({conversationId:l,gizmoId:i,requestedDefaultModel:s}),enabled:!sc(t)}},Qd=t=>(ln(),an(Kd(t))),Yd=(t,e)=>{const s=(typeof t=="string"?[t]:t)??[];for(const a of s)if(a&&e.has(a))return a;return null},Jd=(t,e)=>{const s=Nc(),[a,i]=vo(),l=a.get("model"),{modelId:h=null}=rc()??{};Vc(t);const u=Uc(t)??null,p=[l,u,h],g=Yd(p,s);_.useEffect(()=>{j.initThread(t,e,g),Xt.reset()},[t]);const v=()=>{i(b=>(b.delete("model"),b))},{isLoading:w,data:f}=Qd({clientThreadId:t,clientModelId:p.find(b=>!!b)??null,conversationMode:e}),x=wo();_.useEffect(()=>{if(!(!l||w)){if(!s.has(l)||x.find(b=>b.model_slug===l))return v();j.setThreadModelId(t,l)}},[l,x,s,t]),_.useEffect(()=>{if(w||!f)return;const{default_model_slug:b}=f;l&&b&&l!==b&&v(),Xt.updateDetails(f),b&&j.setThreadModelId(t,b)},[w,f])};function Xd({clientThreadId:t,setClientThreadId:e}){const s=ut(),a=oc(),i=a?{kind:ke.GizmoInteraction,gizmo_id:a}:{kind:ke.PrimaryAssistant};Jd(t,i);const l=Ye(),h=pr(t),u=_.useRef(h);u.current=h;const p=Oc(t),g=yr(t),{data:v}=gr(g),w=!1,f=_.useCallback(()=>{e?.(bo());const S=u.current;l(S.tags.includes(Co.GPT_4)?"/":`/?model=${S.id}`,{replace:!0})},[e,l]),x=Br({clientThreadId:t,location:"Model switcher menu item"}),b=_.useCallback(S=>{p||_d(l,s,S)},[s,l,p,w,v]);return{createNewThread:x,onThreadCreated:b,resetThread:f}}function Pr(){return{caModal:null,clientThreadId:"",currentModelId:"",isModelLoaded:!1,isInstalledApp:!1,isCompanionWindow:!1,conversationLeafId:"",onNewThread:()=>{throw new Error("onNewThread not implemented")},onRequestCompletion:()=>{throw new Error("onRequestCompletion not implemented")},onChangeItemInView:()=>{throw new Error("onChangeItemInView not implemented")},onChangeRating:()=>{throw new Error("onChangeRating not implemented")},onRequestMoreCompletions:()=>{throw new Error("onRequestMoreCompletions not implemented")},resetThread:()=>{throw new Error("resetThread not implemented")}}}const Ur=_.createContext(Pr());function Zd(){try{return _.useContext(Ur)}catch{return Pr()}}function Jh({children:t,clientThreadId:e,setClientThreadId:s,prefetchSearch:a}){const{createNewThread:i,onThreadCreated:l,resetThread:h}=Xd({clientThreadId:e,setClientThreadId:s}),u=hr(),p=Bc(e),g=Lc(e),v=u.id,w=p??v,f=So(),x=ac(),{caModal:b,onRequestCompletion:S,onChangeItemInView:k,onChangeRating:B,onRequestMoreCompletions:D}=qd({clientThreadId:e,currentModelId:w,defaultModelId:u.id,onThreadCreated:l});return o.jsx(Ur.Provider,{value:{caModal:b,clientThreadId:e,currentModelId:w,isModelLoaded:!!p,isInstalledApp:x,isCompanionWindow:f,conversationLeafId:g,onNewThread:i,onRequestCompletion:S,onChangeItemInView:k,onChangeRating:B,onRequestMoreCompletions:D,resetThread:h,prefetchSearch:a},children:t})}const eh=Qe(()=>He(()=>import("./g9ajqtukvv4jsver.js"),__vite__mapDeps([73,1,2,3,25,5,6,23,21,8,74,75,59,60,15,26])));function Xh({showShareButton:t,showProfileDropdown:e,clientThreadId:s}){const a=Wc(s),i=_e(),l=As(),{layer:h}=wt("1547743984");yr(s);const{onNewThread:u}=Zd(),p=h.get("show_share_button_text",!1),g=i.formatMessage({id:"GizmoInformation.shareChat",defaultMessage:"Share"}),v=ht(),w=()=>be.openSharingModal(a),f=!1,x=i.formatMessage({id:"TO+loE",defaultMessage:"New Chat"});return o.jsxs(o.Fragment,{children:[!1,l&&o.jsx(Yl,{}),!1,t&&a&&o.jsx(Gn,{clientThreadId:s,children:p?o.jsx(De,{onClick:w,icon:qt,label:g,"data-testid":"share-chat-button",color:"secondary",className:"text-token-text-primary",style:{display:"var(--screen-size-hidden-on-compact-mode)",viewTransitionName:"var(--vt_share_chat_wide_button)"},children:g}):o.jsx(Te,{label:i.formatMessage({id:"CPEfES",defaultMessage:"Share chat"}),children:o.jsx(dt,{"data-testid":"share-chat-button",onClick:()=>be.openSharingModal(a),icon:qt,style:{viewTransitionName:"var(--vt_share_chat_compact_button)"}})})}),v&&t&&a&&o.jsx(Gn,{clientThreadId:s,children:o.jsx(Te,{label:g,children:o.jsx($n,{style:{display:"var(--screen-size-hidden-on-wide-mode)",viewTransitionName:"var(--vt_share_chat_compact_button)"},onClick:w,icon:o.jsx(qt,{}),label:g})})}),v&&!f&&o.jsx(Te,{label:x,children:o.jsx($n,{className:ko.sidebarIcon,icon:o.jsx(rr,{}),onClick:()=>u(),label:x,style:{display:"var(--screen-size-hidden-on-wide-mode)"}})}),e&&o.jsx(nh,{clientThreadId:s})]})}function th({to:t,children:e,icon:s}){const a=Ye();return o.jsx(ne.Item,{icon:s,onSelect:()=>a(t),children:e})}function nh({clientThreadId:t}){const{isUnauthenticated:e}=hn();return e?o.jsx(uh,{}):o.jsx(sh,{clientThreadId:t})}function sh({clientThreadId:t}){const{data:e}=Mt(),s=je(),a=s?.isPlus()??!1,i=s?.isWorkspaceAccount()??!1,{openSettings:l}=ic(),h=or(),u=ah(t??"none"),{openModal:p}=ar(),g=ht(),{layer:v}=wt("2888142241"),w=ps("3905879930"),f=_e();var x=s?.isTeam()??!1,b=!1;x&&(b=w.config.get("enabled",!1));const{doesUserHaveAnyAccountsWithPlusFeatures:S}=Io(),{layer:k}=wt("2670443078");if(!s||!e)return null;const B=e.accountItems.length>1;let D=a;!i&&!a&&S&&k.get("is_gating_fix_enabled",!1)&&(D=S);const I=!i&&!D&&!xs&&v.get("is_upgrade_in_settings",!1);return o.jsxs(Ec,{contentClassName:re(g&&"max-w-[256px] min-w-[256px] w-[256px]"),triggerButton:o.jsx("button",{onClick:()=>{U.logEvent(O.accountOpenProfileMenu),de.logEvent("chatgpt_account_open_profile_menu")},"aria-label":f.formatMessage({id:"wz2MQV",defaultMessage:"Open Profile Menu"}),"data-testid":"profile-button",className:"flex h-10 w-10 items-center justify-center rounded-full hover:bg-token-main-surface-secondary focus-visible:bg-token-main-surface-secondary focus-visible:outline-0",style:g?{display:"var(--screen-size-hidden-on-compact-mode, flex)"}:void 0,children:o.jsx(xn,{iconSize:"medium"})}),children:[B&&o.jsx(Ar,{menuItemComponent:ne.Item}),B?o.jsx(ne.Separator,{}):null,i?o.jsx(jr,{menuItemComponent:ne.Item,routedMenuItemComponent:th}):o.jsx(Tr,{menuItemComponent:ne.Item}),o.jsx(ne.Item,{icon:Xs,onClick:()=>l(),"data-testid":"settings-menu-item",children:o.jsx(T,{defaultMessage:"Settings",id:"navigation.settings.0"})}),o.jsx(ne.Separator,{}),x&&b&&o.jsxs(o.Fragment,{children:[o.jsx(ne.Item,{"data-testid":"settings-menu-item-invite-teammates",onClick:()=>{be.openModal(Ke.InviteUsersToWorkspace),U.logEvent(O.accountMemberInviteButton,{eventSource:"mouse",location:"profile_drop_down"}),de.logEvent("chatgpt_invite_users_to_workspace",0,{action:"OpenAdminInviteModal",location:"dropdown-menu-click",text:"AddTeammates",step:"OpenModal"})},icon:Zs,children:o.jsx(T,{...Or.addTeammatesButton})}),o.jsx(eh,{workspace:s})]}),h&&o.jsx(oh,{openDownloadModal:p}),I&&o.jsx(ch,{}),u&&o.jsx(ih,{}),(I||h||u)&&o.jsx(ne.Separator,{}),o.jsx(ne.Item,{onClick:()=>{U.logEvent(O.clickLogOut,{eventSource:"mouse"}),U.logLogOutButtonClicked({location:"profile_drop_down"}),gs()},"data-testid":"log-out-menu-item",icon:er,children:o.jsx(T,{defaultMessage:"Log out",id:"navigation.logOut.0"})})]})}function rh({onClick:t,className:e,testId:s}){const a=_e(),i=un(),l=i?a.formatMessage({id:"yqd/J5",defaultMessage:"Clear chat"}):a.formatMessage({id:"OFyxqj",defaultMessage:"New chat"});return o.jsx(Te,{sideOffset:4,label:l,className:re("flex",e),children:o.jsx(dt,{onClick:()=>{be.closePopoverNavSidebar(),t()},icon:i?kc:rr,surfaceContext:"secondary","aria-label":l,"data-testid":s})})}function Zh({clientThreadId:t}){const[e]=lr(i=>[i.activeStageSidebar]),s=ur(),a=Br({clientThreadId:t,location:"Navigation actions"});return!s&&!e?null:o.jsxs("div",{className:"flex items-center",children:[o.jsx(lh,{}),o.jsx(rh,{onClick:a})]})}function oh({openDownloadModal:t}){return o.jsx("span",{children:o.jsx(ne.Item,{icon:tr,onClick:()=>{t(),U.logEvent(O.accountMenuClickDownloadApp)},children:o.jsx(T,{id:"navigation.downloadMacApp",defaultMessage:"Download the macOS app"})})})}const ah=t=>{const{value:e}=cn("2634628831"),s=hs(()=>document.documentElement.dataset.searchExtension==="1"),a=fr(t,fs.Search);return!s&&a&&Bs()&&e},ih=()=>o.jsx("span",{children:o.jsx(ne.Item,{icon:Cc,onClick:()=>{window.open(Ir),U.logEventWithStatsig(O.chatgptBrowserExtensionUserMenuClicked,"chatgpt_browser_extension_user_menu_clicked")},children:o.jsx(T,{id:"E5VPz/",defaultMessage:"Get ChatGPT search extension"})})});function ch(){const t=Ye(),s=je()?.wasPaidCustomer()??!1,a=()=>{de.logEvent("chatgpt_plus_upgrade_in_settings_menu_clicked"),U.logEvent(O.plusUpgradeInSettingsMenuClicked),gn(t,"Upper right settings menu")};return o.jsx(ne.Item,{icon:Sc,onClick:a,children:s?o.jsx(T,{id:"navigation.renewPlus",defaultMessage:"Renew Plus"}):o.jsx(T,{id:"navigation.upgradePlan",defaultMessage:"Upgrade Plan"})})}function lh(){const t=_e(),[e]=lr(l=>[l.activeStageSidebar]),s=ur(),a=$s(),{isUnauthenticated:i}=hn();return!e&&!s||!a||i?null:o.jsx(Te,{label:t.formatMessage({id:"cElEQV",defaultMessage:"Open sidebar"}),className:"flex",children:o.jsx(dt,{"aria-label":t.formatMessage({id:"pV/Etp",defaultMessage:"Open sidebar"}),onClick:be.toggleNavSidebar,icon:Ic,surfaceContext:"primary"})})}function uh(){const t=Rt(),e=cc(),s=Hs(Or.signUpCta),{layer:a}=wt("3637408529"),i=a.get("is_desktop_primary_auth_button_on_right",!1),l=()=>{t({authType:"login",callback:v=>{U.logLogInButtonClicked({location:"Chat header",provider:v})}})},h=()=>{t({authType:"signup",callback:v=>{U.logSignUpButtonClicked({location:"Chat header",provider:v})}})},u=o.jsx(De,{onClick:l,color:e?"primary":"secondary",size:"small","data-testid":"login-button",children:o.jsx(T,{id:"B1SN7b",defaultMessage:"Log in"})},"login"),p=o.jsx(De,{color:e?"secondary":"primary",onClick:h,size:"small","data-testid":"signup-button",children:o.jsx(T,{...s})},"signup"),g=e?[u,p]:[p,u];return o.jsx("div",{className:"flex items-center justify-center gap-2",children:i?g.reverse():g})}const Or=ot({signUpCta:{id:"P6cySK",defaultMessage:"Sign up"},addTeammatesButton:{id:"inviteMemberButton.inviteMemberButton",defaultMessage:"Add Teammates"}});export{Kh as $,Vn as A,In as B,ld as C,ts as D,lh as E,kh as F,xd as G,Ur as H,Xd as I,rt as J,nh as K,Qc as L,vu as M,Wh as N,Kc as O,Yu as P,Gd as Q,_u as R,il as S,ql as T,Oh as U,ll as V,_r as W,Qh as X,Hd as Y,Dh as Z,Al as _,Gh as a,pl as a0,Fr as a1,Dd as a2,Fh as a3,zh as a4,Vh as a5,Xh as a6,Zh as a7,Yh as a8,bn as a9,qd as aa,Ah as ab,Rh as ac,Eh as ad,Th as ae,yu as b,sh as c,Nh as d,jh as e,Zd as f,Ol as g,od as h,Jh as i,rh as j,ct as k,Hh as l,Bt as m,Uh as n,Lh as o,_d as p,gl as q,Bh as r,Mh as s,qh as t,Jd as u,wr as v,Tl as w,pu as x,gu as y,Ph as z};
//# sourceMappingURL=hn877s1av7risab0.js.map
