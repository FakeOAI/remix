const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/l8890zpgvdiya88u.js","assets/pcnl88zwhe6noauc.js","assets/kvdx8vbzxgcuhkks.js","assets/root-jg4a1j0p.css","assets/o3ih6na0xmna5yjk.js","assets/id6kv7jv9hphxx5c.js","assets/conversation-small-eplmind9.css","assets/jihcmvvrci5c89vd.js","assets/k8vqqakx8rs22uii.js","assets/idxwefzqctd789w4.js","assets/fwqjbfqkaqdakiev.js","assets/sso-bcdhwpqolbad0i57.js","assets/cope4x5u985pzzfq.js","assets/nhwwej1nq0zrd7sc.js","assets/hm0arwtm10tdtoye.js","assets/kfrulc8rmw8yti2n.js","assets/jgmbivmc27v0gy95.js","assets/i7j2ldt4wg0arock.js","assets/lzfm9o29lo4ctp2z.js","assets/ih6aojwf0g2xpubh.js","assets/l0pfbg128o9e0ma3.js","assets/bhlq82b3fmqre7q5.js","assets/d0g8ptgc5gcqjwyj.js","assets/nl736dh34affmv1w.js","assets/d4a74wgdkaeh1wb3.js","assets/isjdmfmhzv09v01t.js","assets/cm2xvftpqu7du6i9.js","assets/i7g2p4d13g5s497l.js","assets/idvh8voo444vwxss.js","assets/o5i8pe93non4qwby.js","assets/faak65mmdu52z98z.js","assets/eo940s0nvc5dnbmw.js","assets/o3dl7eqpabp10k3s.js","assets/c95q2lfgl983d5dr.js","assets/dktbvndgtlfnhoar.js","assets/o798k0u5ncnxlnt0.js","assets/cerihv7z5s1sod9k.js","assets/bgji63r51r2prgt5.js","assets/bv8mx3rikufg3zzf.js","assets/eye0bg574aeyy3fw.js","assets/jkrqknxt91v4qt6e.js","assets/lgmu0abvpbf6hfi8.js","assets/l0gei3wp1c72xc50.js","assets/akyfe4elsmomq6xj.js","assets/ifrnbnjr6tffic6m.js","assets/kmju88jxis055v3t.js","assets/bip32edyx2bpfm0h.js","assets/btuzt2xiyju401nv.js","assets/lowwyp3u84frsz70.js","assets/kqwdyvkaaavvn8k3.js","assets/kyxs77b9yb4bqaow.js","assets/hzdsgy7b9dcel7ne.js","assets/bn4vs8vsfpxxcjys.js","assets/mpu2n9l6ijdlavv7.js","assets/hb1t2ewzycvi9qjo.js","assets/itwdw973wa1gnw5y.js","assets/c19ceiewoi55vmub.js","assets/i3m59wreq6q1bbdh.js","assets/pbc8g6e425vhqh8u.js","assets/h9dznhxp5uzmb7zj.js","assets/iej0cupg2dqkmejt.js","assets/2sgvo0wllvt7o0c3.js","assets/jk8w36bsokizpx57.js","assets/nagy87dlfk5c0y9e.js","assets/fkuv623c7cca0wv1.js","assets/lss4o3erx878gyjq.js","assets/c2op91f2h6e7dc53.js","assets/jzskb03e380n62a3.js","assets/fhm12g6o08f80za3.js","assets/fpo0gc66f7blhhk0.js","assets/eofd623y9l62f0ob.js","assets/278h87de5hv7xied.js","assets/hmwt5t36jhfy6wre.js","assets/cp060pfophoizmey.js","assets/hydbvqta9lco052a.js","assets/shared-mk6ngktc.css","assets/ls9zqvrbl71pkbnj.js","assets/sso-mvyfzo3w.css","assets/ir9q6xv1jnwovbqv.js","assets/en2jgloo23c4qnhf.js","assets/fyn968aj4rhkszd2.js","assets/nvink47uxxhp5kmg.js","assets/g72anc38y5s56kyv.js","assets/gobwpkxgmvivxudj.js","assets/l6jk1i9swempx4do.js","assets/dqmhmfmhkdwd22nz.js","assets/jvg4og0usrmpohwb.js","assets/d0ebhb53k8s99n29.js","assets/ibaqjd7y382nf6hh.js","assets/j053g2xm0sxjqbtu.js","assets/ohs7ejot20dqom7w.js","assets/k91ta071h5gumox6.js","assets/dmv4eqpwgv4egv2h.js","assets/ebmw4bw78wlxkwjq.js","assets/b8dgcwr6ab2zizno.js","assets/krtxdgg9qkokcss7.js","assets/o8vp63k4mm24bt56.js","assets/f15mzw4y6dpi3lkt.js","assets/extpdpdlyuk3qc7r.js","assets/domvb0qlvql4sbca.js","assets/ltr0opt1rtypykzd.js","assets/lj0jyenudce2cwjb.js","assets/evwrwr9uh973qsn1.js","assets/bfh2ch7zx5yqqeeh.js"])))=>i.map(i=>d[i]);
var eg=Object.defineProperty;var $c=n=>{throw TypeError(n)};var tg=(n,e,t)=>e in n?eg(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var X=(n,e,t)=>tg(n,typeof e!="symbol"?e+"":e,t),fa=(n,e,t)=>e.has(n)||$c("Cannot "+t);var b=(n,e,t)=>(fa(n,e,"read from private field"),t?t.call(n):e.get(n)),ge=(n,e,t)=>e.has(n)?$c("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),ee=(n,e,t,s)=>(fa(n,e,"write to private field"),s?s.call(n,t):e.set(n,t),t),Y=(n,e,t)=>(fa(n,e,"access private method"),t);var Hr=(n,e,t,s)=>({set _(i){ee(n,e,i,t)},get _(){return b(n,e,s)}});import{K as ng,i0 as ah,hA as lh,ch as jl,cg as Uo,cj as Vo,j as vs,i1 as sg,i2 as lt,i3 as ig,i4 as ro,i5 as Gr,i6 as rg,i7 as ch,p as og,d4 as ag,bC as Fi,aC as Li,fd as dh,fD as Wo,fe as Ho,i8 as lg,cI as Nr,i9 as cg,ia as uh,a6 as cr,fg as Wt,bK as Ss,ib as xn,u as ks,A as ws,b1 as dg,cM as hh,aM as ug,cf as hg,ic as fh,id as ph,ie as fg,ig as Ei,ih as it,ii as mh,ij as qa,gh as pg,ik as mg,il as gg,im as yg,io as xg,b0 as Er,ip as bg,iq as Ii,a8 as gh,ir as Sg,eo as kg,b$ as Go,hU as wg,dP as yh,r as Cg,is as vg,it as xh,iu as bh,fh as Ir,hY as dr,iv as us,hP as Ys,iw as pa,ix as Mg,s as Rl,iy as Kc,iz as Sh,iA as xo,iB as Dl,iC as Ol,iD as kh,iE as wh,dK as Ch,hR as vh,dI as Mh,dJ as Th,iF as Tg,iG as _g,ht as Pl,iH as Ng,iI as _h,hu as Fl,iJ as Ll,iK as qr,iL as Eg,iM as Ig,iN as Ag,hS as ur,af as Nh,iO as jg,iP as Rg,iQ as Dg,cr as Og,iR as Jc,ed as fn,iS as hr,iT as Pg,iU as Fg,d$ as Lg,e0 as Bg,iV as Eh,iW as zg,iX as Ih,iY as Bl,iZ as Ah,i_ as jh,i$ as Ug,c9 as Vg,c7 as Wg,j0 as Hg,j1 as Gg,fi as qg,j2 as $g,j3 as Kg,a4 as Rh,J as ei,j4 as Jg,j5 as Yc,Z as bo,j6 as $a,j7 as Yg,q as Dh,U as Ai,av as zl,j8 as Qg,j9 as Xg,ja as Zg,jb as ey,jc as ty,cG as Oh,dL as ny,g2 as sy,g1 as So,jd as iy,je as ry,jf as oy,X as Ul,jg as ko,jh as Ph,ji as ay,fZ as qo,jj as ly,v as Vl,ff as Qc,fj as cy,ba as dy,a$ as fr,O as ma,aW as uy,x as hy,jk as Fh,jl as Lh,jm as fy,jn as py,at as my,g0 as Bh,bg as zh,jo as gy,bD as ga,y as yy,gx as xy,gg as by,jp as Sy,d3 as ky,jq as wy,cn as Cy,bZ as vy,e9 as Uh,jr as Wl,js as Fs,M as My,jt as Ty,ju as _y,jv as Vh,o as Ny,jw as Ey,W as oo,aQ as Ka,hI as Iy,cH as Ay,a9 as Xc,jx as jy,a7 as te,jy as Ry,jz as Dy,jA as Oy,jB as Wh,fy as Py,h5 as $r,jC as ya,jD as Fy,h3 as Ly,h8 as By,h9 as Hl,jE as zy,jF as Uy,C as Vy,jG as sr,jH as Wy,jI as Hy,jJ as Gy,jK as qy,jL as $y,gL as Hh,dM as Ky,G as Jy,bB as Yy,jM as Qy,cd as Xy,fO as Zy,fB as ex,jN as Gh,jO as tx,ab as Gl,Y as wo,bp as Co,bR as ql,en as nx,fk as qh,k as sx,jP as ix,jQ as rx,cF as ox,jR as ax,jS as lx,jT as cx,jU as dx,jV as ux,jW as hx,jX as fx,jY as px,e2 as Zc,jZ as mx,ha as gx,j_ as yx,j$ as xx,k0 as bx,k1 as Sx,k2 as kx,ck as wx,k3 as Ja,k4 as Cx,k5 as vx,k6 as Mx,k7 as Tx,k8 as ed,k9 as _x,w as Nx,ka as Ex,kb as Ix,gn as td,kc as Ax,_ as jx,kd as Rx,ke as Dx,kf as Ox,kg as Px,kh as Fx,ki as Lx,kj as Bx}from"./id6kv7jv9hphxx5c.js";import{m as $h,S as $l,T as zx,d as Ms,U as Ux,g as nd,h as Vx,V as Kl,W as Wx,X as Jl,c as Yl,Y as Hx,Z as Gx,_ as qx,$ as $x,a0 as Kx,u as Kh,N as Jh,b as Ar,B as Ql,a1 as Yh,a2 as Jx,a3 as Yx,G as Qx,a as Xx,r as Zx,a4 as eb,f as tb}from"./o3ih6na0xmna5yjk.js";import{a7 as pn,di as nb,u as $o,R as Ee,X as jr,r as y,fN as pr,bo as Rr,de as sb,eY as ib,H as ue,cr as Kn,j as c,N as Ce,a4 as xt,bU as ts,fO as Ya,cU as rb,P as $,A as V,bN as De,fP as Qh,f9 as Xh,bh as $e,O as ze,K as D,bn as Qa,e0 as ti,c as K,bJ as ob,fq as Xl,B as Ht,aH as Zh,bg as ft,bj as ef,fQ as tf,x as nf,a5 as ab,L as ji,ar as Nn,fo as sf,fs as rf,aA as ni,y as sd,bQ as of,b$ as ve,bS as lb,J as kn,ek as Ko,cM as Se,fR as Zl,bC as af,bX as vo,bW as vt,U as cb,V as db,W as ub,Q as hb,cZ as fb,fS as ec,cJ as pb,by as Dr,aN as lf,fT as mb,fk as gb,f2 as yb,dE as cf,fU as tc,ex as Xa,az as Bi,ew as xb,f4 as nc,d4 as sc,d5 as mr,d6 as Mo,dV as bb,fV as Sb,ah as En,fW as kb,fX as wb,fY as ic,e4 as Cn,fc as rc,f0 as df,E as Jo,fZ as zt,e1 as Cb,aD as Cs,ai as Yo,bq as Or,cK as uf,M as xa,I as vb,cl as hf,f_ as Mb,e_ as Tb,f$ as _b,ck as Me,g0 as Nb,w as oc,g1 as id,C as Eb,z as Ib,bk as Ab,g2 as jb,cA as Rb,cp as ac,g3 as Db,c6 as Zt,g4 as ff,cD as Ob,cE as Pb,cH as ir,cF as rd,cG as Fb,g5 as Lb,c$ as pf,g6 as Bb,g7 as zb,cz as Qo,d0 as Xo,bZ as lc,aB as Ub,aC as Vb,aw as Yi,fd as Wb,cW as Qi,eb as To,bH as Ze,eS as Hb,be as Gn,g8 as Gb,g9 as qb,ga as $b,gb as Kb,gc as mf,a2 as od,gd as Jb,ge as ad,gf as ld,gg as Yb,gh as Qb,aG as gf,dk as Xb,gi as Zb,bw as eS,cx as tS,gj as nS,ef as sS,gk as iS,gl as cd,fa as rS,bp as oS,bb as aS}from"./pcnl88zwhe6noauc.js";import{u as lS}from"./lzfm9o29lo4ctp2z.js";import{i as ms,I as cS,T as I,c as cc,q as Ts,f as bt,E as yf,J as dS,b as Pr,e as en,v as Jn,u as Mn,d as zi,g as Fr,K as xf,k as bf,L as uS,M as hS,A as dc,h as Sf,N as fS,O as pS,P as dd,j as ud,Q as mS,a as kf,R as gS,S as yS,U as xS,V as bS,W as wf,r as SS,s as kS,X as Cf,H as vf,Y as wS,Z as CS,_ as vS,$ as Mf}from"./jihcmvvrci5c89vd.js";import{G as MS,T as TS}from"./fwqjbfqkaqdakiev.js";import{t as _o,i as Tf,S as _S,a as _f,u as Nf,T as uc,M as hc,b as Ef,H as NS,c as ES,d as IS,e as AS,G as jS,L as RS,f as DS,g as OS}from"./gobwpkxgmvivxudj.js";import{r as PS}from"./ibaqjd7y382nf6hh.js";import{r as fc,e as FS,f as LS,g as BS,s as zS}from"./jgmbivmc27v0gy95.js";import{U as If,E as gr,a3 as Zo,bs as US,az as Af,bT as VS,R as WS,bh as jf,bU as HS,X as pc,as as GS,bV as qS,aL as $S,bW as ea,a1 as Rf,x as KS,aK as Df,ah as JS,bX as YS,bY as QS,bo as ta,bc as XS,bZ as Of,bQ as ZS,b_ as ek,aH as tk,aq as nk,b$ as sk,u as ik,al as Pf,am as Ff,B as rk,ak as ok,aj as ak,r as lk,bI as ck}from"./kvdx8vbzxgcuhkks.js";import{a as dk}from"./j053g2xm0sxjqbtu.js";import{m as Oe}from"./k8vqqakx8rs22uii.js";import{u as uk,P as hk,I as fk}from"./hb1t2ewzycvi9qjo.js";import{D as ne,B as pk,$ as Lf}from"./cope4x5u985pzzfq.js";import{i as mc,a as mk,g as gk,b as yk,c as xk}from"./ls9zqvrbl71pkbnj.js";import{G as Bf,a as bk}from"./dktbvndgtlfnhoar.js";import{H as Sk}from"./ohs7ejot20dqom7w.js";import{e as kk,f as wk,C as Ck,c as gc}from"./ih6aojwf0g2xpubh.js";import{I as vk,B as Mk}from"./cm2xvftpqu7du6i9.js";import{a as Tk}from"./fkuv623c7cca0wv1.js";function _k(n){return`https://chatgpt.com${$h(n)}`}function oE(n,e){ng(_k(n)),e&&pn.info(e)}function Nk(n){return n.some(e=>e.type===nb.JIT_PLUGIN)}function Ek(n){return"gizmo_id"in n?n.gizmo_id??null:null}const Ik=n=>["conversation","init",n],Ak=({clientThreadId:n,conversationMode:e,clientModelId:t})=>{const s=Ek(e),i=ms(n)?null:n;return{gcTime:0,refetchOnWindowFocus:!0,refetchOnMount:"always",queryKey:Ik(n),queryFn:()=>Ee.getConversationDetails({conversationId:i,gizmoId:s,requestedDefaultModel:t})}},jk=n=>$o(Ak(n)),Rk=(n,e)=>{const t=(typeof n=="string"?[n]:n)??[];for(const s of t)if(s&&e.has(s))return s;return null},aE=(n,e)=>{const t=$l(),{query:s}=jr(),i=zx(s),{modelId:r=null}=ah()??{};lS(n);const o=cS(n)??null,a=[i,o,r],l=Rk(a,t);y.useEffect(()=>{I.initThread(n,e,l),pr.reset()},[n]);const d=Rr(),u=y.useCallback(()=>{const p={...s};delete p.model;const g=sb.stringify(p);d({search:g.length>0?`?${g}`:""})},[s,d]),{isLoading:h,data:f}=jk({clientThreadId:n,clientModelId:a.find(p=>!!p)??null,conversationMode:e}),m=ib();y.useEffect(()=>{if(!(!i||h)){if(!t.has(i)||m.find(p=>p.model_slug===i))return u();I.setThreadModelId(n,i)}},[i,m,t,n]),y.useEffect(()=>{if(h||!f)return;const{default_model_slug:p}=f;i&&p&&i!==p&&u(),pr.updateDetails(f),p&&I.setThreadModelId(n,p)},[h,f])};function ba({label:n,tooltip:e,Icon:t}){return c.jsxs("div",{className:"flex items-center gap-1 text-sm font-semibold opacity-70",children:[t&&c.jsx(t,{className:"icon-sm"}),c.jsx("div",{children:n}),c.jsx(vs,{label:e,children:c.jsx(gr,{className:"icon-sm ml-1"})})]})}function Dk({clientThreadId:n,gizmoId:e}){const t=ue(),s=lh(),i=jl(),r=Uo(),{data:o}=Vo(e,!1,r),a=!!e,l=Kn(),d=cc(n);return r?l&&(!d||a)?c.jsx(ba,{label:t.formatMessage(ui.temporaryChat),tooltip:t.formatMessage(ui.temporaryChatTooltip),Icon:If}):s&&!i&&!l?c.jsx(ba,{label:t.formatMessage(ui.memoryOff),tooltip:t.formatMessage(ui.memoryOffTooltip)}):o&&(o==null?void 0:o.memoryFullPct)>=100?c.jsx(ba,{label:t.formatMessage(ui.memoryFull),tooltip:t.formatMessage(ui.memoryFullTooltip)}):null:null}const ui=Ce({temporaryChat:{id:"ConversationPrivacyIndicator.temporaryChat",defaultMessage:"Temporary Chat"},temporaryChatTooltip:{id:"ConversationPrivacyIndicator.temporaryChatTooltip",defaultMessage:"Temporary Chats won't appear in your history, and ChatGPT won't remember anything you talk about."},memoryOff:{id:"ConversationPrivacyIndicator.memoryOff",defaultMessage:"Memory Off"},memoryOffTooltip:{id:"ConversationPrivacyIndicator.memoryOffTooltip",defaultMessage:"ChatGPT won't remember anything you talk about in this conversation."},memoryFull:{id:"2Eq+5y",defaultMessage:"Memory Full"},memoryFullTooltip:{id:"dNA8jQ",defaultMessage:"ChatGPT's memory is full. You can forget existing memories to make space."}});var zf=PS();function Ok(n){if(typeof n!="string")throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!n)throw new Error("No input");const e=JSON.parse(n),t=e;let s;if(t.type==="system")if(t.event==="connected")s=Object.assign(Object.assign({},e),{kind:"connected"});else if(t.event==="disconnected")s=Object.assign(Object.assign({},e),{kind:"disconnected"});else return null;else if(t.type==="message")if(t.from==="group"){const i=fd(e.data,e.dataType);if(i===null)return null;s=Object.assign(Object.assign({},e),{data:i,kind:"groupData"})}else if(t.from==="server"){const i=fd(e.data,e.dataType);if(i===null)return null;s=Object.assign(Object.assign({},e),{data:i,kind:"serverData"})}else return null;else if(t.type==="ack")s=Object.assign(Object.assign({},e),{kind:"ack"});else return null;return s}function Pk(n){let e;switch(n.kind){case"joinGroup":{e={type:"joinGroup",group:n.group,ackId:n.ackId};break}case"leaveGroup":{e={type:"leaveGroup",group:n.group,ackId:n.ackId};break}case"sendEvent":{e={type:"event",event:n.event,ackId:n.ackId,dataType:n.dataType,data:hd(n.data,n.dataType)};break}case"sendToGroup":{e={type:"sendToGroup",group:n.group,ackId:n.ackId,dataType:n.dataType,data:hd(n.data,n.dataType),noEcho:n.noEcho};break}case"sequenceAck":{e={type:"sequenceAck",sequenceId:n.sequenceId};break}default:throw new Error(`Unsupported type: ${n.kind}`)}return JSON.stringify(e)}function hd(n,e){switch(e){case"text":{if(typeof n!="string")throw new TypeError("Message must be a string.");return n}case"json":return n;case"binary":case"protobuf":{if(n instanceof ArrayBuffer)return zf.Buffer.from(n).toString("base64");throw new TypeError("Message must be a ArrayBuffer")}}}function fd(n,e){if(e==="text"){if(typeof n!="string")throw new TypeError("Message must be a string when dataType is text");return n}else{if(e==="json")return n;if(e==="binary"||e==="protobuf"){const t=zf.Buffer.from(n,"base64");return t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}else return null}}class Fk{constructor(){this.isReliableSubProtocol=!0,this.name="json.reliable.webpubsub.azure.v1"}parseMessages(e){return Ok(e)}writeMessage(e){return Pk(e)}}const Lk=()=>new Fk;var Ct;(function(n){n.Stopped="Stopped",n.Disconnected="Disconnected",n.Connecting="Connecting",n.Connected="Connected",n.Recovering="Recovering"})(Ct||(Ct={}));class Bk{nextAckId(){return this._ackId=this._ackId+1,this._ackId}constructor(e,t){this._quickSequenceAckDiff=300,this._activeTimeoutInMs=2e4,this._emitter=new sg,this._isStopping=!1,this._isInitialConnected=!1,typeof e=="string"?this._credential={getClientAccessUrl:e}:this._credential=e,t==null&&(t={}),this._buildDefaultOptions(t),this._options=t,this._messageRetryPolicy=new pd(this._options.messageRetryOptions),this._reconnectRetryPolicy=new pd(this._options.reconnectRetryOptions),this._protocol=this._options.protocol,this._groupMap=new Map,this._ackMap=new Map,this._sequenceId=new Vk,this._state=Ct.Stopped,this._ackId=0}async start(e){if(this._isStopping)throw new Error("Can't start a client during stopping");if(this._state!==Ct.Stopped)throw new Error("Client can be only started when it's Stopped");let t;e&&(t=e.abortSignal),this._activeKeepaliveTask||(this._activeKeepaliveTask=this._getActiveKeepaliveTask());try{await this._startCore(t)}catch(s){throw this._changeState(Ct.Stopped),this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0),this._isStopping=!1,s}}async _startFromRestarting(e){if(this._state!==Ct.Disconnected)throw new Error("Client can be only restarted when it's Disconnected");try{lt.verbose("Staring reconnecting."),await this._startCore(e)}catch(t){throw this._changeState(Ct.Disconnected),t}}async _startCore(e){if(this._changeState(Ct.Connecting),lt.info("Staring a new connection"),this._sequenceId.reset(),this._isInitialConnected=!1,this._lastCloseEvent=void 0,this._lastDisconnectedMessage=void 0,this._connectionId=void 0,this._reconnectionToken=void 0,this._uri=void 0,typeof this._credential.getClientAccessUrl=="string"?this._uri=this._credential.getClientAccessUrl:this._uri=await this._credential.getClientAccessUrl({abortSignal:e}),typeof this._uri!="string")throw new Error(`The clientAccessUrl must be a string but currently it's ${typeof this._uri}`);await this._connectCore(this._uri)}stop(){this._state===Ct.Stopped||this._isStopping||(this._isStopping=!0,this._wsClient&&this._wsClient.isOpen()?this._wsClient.close():this._isStopping=!1,this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0))}on(e,t){this._emitter.on(e,t)}off(e,t){this._emitter.removeListener(e,t)}_emitEvent(e,t){this._emitter.emit(e,t)}async sendEvent(e,t,s,i){return await this._operationExecuteWithRetry(()=>this._sendEventAttempt(e,t,s,i),i==null?void 0:i.abortSignal)}async _sendEventAttempt(e,t,s,i){var r;if(!((r=i==null?void 0:i.fireAndForget)!==null&&r!==void 0?r:!1))return await this._sendMessageWithAckId(l=>({kind:"sendEvent",dataType:s,data:t,ackId:l,event:e}),i==null?void 0:i.ackId,i==null?void 0:i.abortSignal);const a={kind:"sendEvent",dataType:s,data:t,event:e};return await this._sendMessage(a,i==null?void 0:i.abortSignal),{isDuplicated:!1}}async joinGroup(e,t){return await this._operationExecuteWithRetry(()=>this._joinGroupAttempt(e,t),t==null?void 0:t.abortSignal)}async _joinGroupAttempt(e,t){const s=this._getOrAddGroup(e),i=await this._joinGroupCore(e,t);return s.isJoined=!0,i}async _joinGroupCore(e,t){return await this._sendMessageWithAckId(s=>({group:e,ackId:s,kind:"joinGroup"}),t==null?void 0:t.ackId,t==null?void 0:t.abortSignal)}async leaveGroup(e,t){return await this._operationExecuteWithRetry(()=>this._leaveGroupAttempt(e,t),t==null?void 0:t.abortSignal)}async _leaveGroupAttempt(e,t){const s=this._getOrAddGroup(e),i=await this._sendMessageWithAckId(r=>({group:e,ackId:r,kind:"leaveGroup"}),t==null?void 0:t.ackId,t==null?void 0:t.abortSignal);return s.isJoined=!1,i}async sendToGroup(e,t,s,i){return await this._operationExecuteWithRetry(()=>this._sendToGroupAttempt(e,t,s,i),i==null?void 0:i.abortSignal)}async _sendToGroupAttempt(e,t,s,i){var r,o;const a=(r=i==null?void 0:i.fireAndForget)!==null&&r!==void 0?r:!1,l=(o=i==null?void 0:i.noEcho)!==null&&o!==void 0?o:!1;if(!a)return await this._sendMessageWithAckId(u=>({kind:"sendToGroup",group:e,dataType:s,data:t,ackId:u,noEcho:l}),i==null?void 0:i.ackId,i==null?void 0:i.abortSignal);const d={kind:"sendToGroup",group:e,dataType:s,data:t,noEcho:l};return await this._sendMessage(d,i==null?void 0:i.abortSignal),{isDuplicated:!1}}_getWebSocketClientFactory(){return new ig}async _trySendSequenceAck(){if(!this._protocol.isReliableSubProtocol)return;const[e,t]=this._sequenceId.tryGetSequenceId();if(e&&t){const s={kind:"sequenceAck",sequenceId:t};try{await this._sendMessage(s)}catch{this._sequenceId.tryUpdate(t)}}}_connectCore(e){if(this._isStopping)throw new Error("Can't start a client during stopping");return new Promise((t,s)=>{const i=this._wsClient=this._getWebSocketClientFactory().create(e,this._protocol.name);i.onopen(()=>{if(this._isStopping){try{i.close()}catch{}s(new Error("The client is stopped"))}lt.verbose("WebSocket connection has opened"),this._changeState(Ct.Connected),this._protocol.isReliableSubProtocol&&(this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),this._sequenceAckTask=new md(async()=>{await this._trySendSequenceAck()},1e3)),t()}),i.onerror(r=>{this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),s(r)}),i.onclose((r,o)=>{this._state===Ct.Connected?(lt.verbose("WebSocket closed after open"),this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),lt.info(`WebSocket connection closed. Code: ${r}, Reason: ${o}`),this._lastCloseEvent={code:r,reason:o},this._handleConnectionClose.call(this)):(lt.verbose("WebSocket closed before open"),s(new Error(`Failed to start WebSocket: ${r}`)))}),i.onmessage(r=>{const o=f=>{if(this._ackMap.has(f.ackId)){const m=this._ackMap.get(f.ackId);this._ackMap.delete(f.ackId);const p=f.error!=null&&f.error.name==="Duplicate";f.success||p?m.resolve({ackId:f.ackId,isDuplicated:p}):m.reject(new Gr("Failed to send message.",{ackId:f.ackId,errorDetail:f.error}))}},a=async f=>{if(this._connectionId=f.connectionId,this._reconnectionToken=f.reconnectionToken,!this._isInitialConnected){if(this._isInitialConnected=!0,this._options.autoRejoinGroups){const m=[];this._groupMap.forEach(p=>{p.isJoined&&m.push((async()=>{try{await this._joinGroupCore(p.name)}catch(g){this._safeEmitRejoinGroupFailed(p.name,g)}})())});try{await Promise.all(m)}catch{}}this._safeEmitConnected(f.connectionId,f.userId)}},l=f=>{this._lastDisconnectedMessage=f},d=f=>{if(f.sequenceId!=null){const m=this._sequenceId.tryUpdate(f.sequenceId);if(m===0)return;m>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitGroupMessage(f)},u=f=>{if(f.sequenceId!=null){const m=this._sequenceId.tryUpdate(f.sequenceId);if(m===0)return;m>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitServerMessage(f)};let h;try{let f;if(Array.isArray(r)?f=Buffer.concat(r):f=r,h=this._protocol.parseMessages(f),h===null)return}catch(f){throw lt.warning("An error occurred while parsing the message from service",f),f}Array.isArray(h)||(h=[h]),h.forEach(f=>{try{switch(f.kind){case"ack":{o(f);break}case"connected":{a(f);break}case"disconnected":{l(f);break}case"groupData":{d(f);break}case"serverData":{u(f);break}}}catch(m){lt.warning(`An error occurred while handling the message with kind: ${f.kind} from service`,m)}})})})}async _handleConnectionCloseAndNoRecovery(){this._state=Ct.Disconnected,this._safeEmitDisconnected(this._connectionId,this._lastDisconnectedMessage),this._options.autoReconnect?await this._autoReconnect():await this._handleConnectionStopped()}async _autoReconnect(){let e=!1,t=0;try{for(;!this._isStopping;)try{await this._startFromRestarting(),e=!0;break}catch(s){lt.warning("An attempt to reconnect connection failed.",s),t++;const i=this._reconnectRetryPolicy.nextRetryDelayInMs(t);if(i==null)break;try{lt.verbose(`Delay time for reconnect attempt ${t}: ${i}`),await ro(i)}catch{}}}finally{e||this._handleConnectionStopped()}}_handleConnectionStopped(){this._isStopping=!1,this._state=Ct.Stopped,this._safeEmitStopped()}_getActiveKeepaliveTask(){return new md(async()=>{this._sequenceId.tryUpdate(0)},this._activeTimeoutInMs)}async _sendMessage(e,t){if(!this._wsClient||!this._wsClient.isOpen())throw new Error("The connection is not connected.");const s=this._protocol.writeMessage(e);await this._wsClient.send(s,t)}async _sendMessageWithAckId(e,t,s){t==null&&(t=this.nextAckId());const i=e(t);this._ackMap.has(t)||this._ackMap.set(t,new Uk(t));const r=this._ackMap.get(t);try{await this._sendMessage(i,s)}catch(o){this._ackMap.delete(t);let a="";throw o instanceof Error&&(a=o.message),new Gr(a,{ackId:t})}if(s)try{return await rg(r.promise(),s)}catch(o){throw o instanceof Error&&o.name==="AbortError"?new Gr("Cancelled by abortSignal",{ackId:t}):o}return await r.promise()}async _handleConnectionClose(){if(this._ackMap.forEach((i,r)=>{this._ackMap.delete(r)&&i.reject(new Gr("Connection is disconnected before receive ack from the service",{ackId:i.ackId}))}),this._isStopping){lt.warning("The client is stopping state. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(this._lastCloseEvent&&this._lastCloseEvent.code===1008){lt.warning("The websocket close with status code 1008. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(!this._protocol.isReliableSubProtocol){lt.warning("The protocol is not reliable, recovery is not applicable"),this._handleConnectionCloseAndNoRecovery();return}const e=this._buildRecoveryUri();if(!e){lt.warning("Connection id or reconnection token is not available"),this._handleConnectionCloseAndNoRecovery();return}let t=!1;this._state=Ct.Recovering;const s=ch.timeout(30*1e3);try{for(;!s.aborted||this._isStopping;)try{await this._connectCore.call(this,e),t=!0;return}catch{await ro(1e3)}}finally{t||(lt.warning("Recovery attempts failed more then 30 seconds or the client is stopping"),this._handleConnectionCloseAndNoRecovery())}}_safeEmitConnected(e,t){this._emitEvent("connected",{connectionId:e,userId:t})}_safeEmitDisconnected(e,t){this._emitEvent("disconnected",{connectionId:e,message:t})}_safeEmitGroupMessage(e){this._emitEvent("group-message",{message:e})}_safeEmitServerMessage(e){this._emitEvent("server-message",{message:e})}_safeEmitStopped(){this._emitEvent("stopped",{})}_safeEmitRejoinGroupFailed(e,t){this._emitEvent("rejoin-group-failed",{group:e,error:t})}_buildDefaultOptions(e){return e.autoReconnect==null&&(e.autoReconnect=!0),e.autoRejoinGroups==null&&(e.autoRejoinGroups=!0),e.protocol==null&&(e.protocol=Lk()),this._buildMessageRetryOptions(e),this._buildReconnectRetryOptions(e),e}_buildMessageRetryOptions(e){e.messageRetryOptions||(e.messageRetryOptions={}),(e.messageRetryOptions.maxRetries==null||e.messageRetryOptions.maxRetries<0)&&(e.messageRetryOptions.maxRetries=3),(e.messageRetryOptions.retryDelayInMs==null||e.messageRetryOptions.retryDelayInMs<0)&&(e.messageRetryOptions.retryDelayInMs=1e3),(e.messageRetryOptions.maxRetryDelayInMs==null||e.messageRetryOptions.maxRetryDelayInMs<0)&&(e.messageRetryOptions.maxRetryDelayInMs=3e4),e.messageRetryOptions.mode==null&&(e.messageRetryOptions.mode="Fixed")}_buildReconnectRetryOptions(e){e.reconnectRetryOptions||(e.reconnectRetryOptions={}),(e.reconnectRetryOptions.maxRetries==null||e.reconnectRetryOptions.maxRetries<0)&&(e.reconnectRetryOptions.maxRetries=Number.MAX_VALUE),(e.reconnectRetryOptions.retryDelayInMs==null||e.reconnectRetryOptions.retryDelayInMs<0)&&(e.reconnectRetryOptions.retryDelayInMs=1e3),(e.reconnectRetryOptions.maxRetryDelayInMs==null||e.reconnectRetryOptions.maxRetryDelayInMs<0)&&(e.reconnectRetryOptions.maxRetryDelayInMs=3e4),e.reconnectRetryOptions.mode==null&&(e.reconnectRetryOptions.mode="Fixed")}_buildRecoveryUri(){if(this._connectionId&&this._reconnectionToken&&this._uri){const e=new URL(this._uri);return e.searchParams.append("awps_connection_id",this._connectionId),e.searchParams.append("awps_reconnection_token",this._reconnectionToken),e.toString()}return null}_getOrAddGroup(e){return this._groupMap.has(e)||this._groupMap.set(e,new zk(e)),this._groupMap.get(e)}_changeState(e){lt.verbose(`The client state transfer from ${this._state.toString()} to ${e.toString()}`),this._state=e}async _operationExecuteWithRetry(e,t){let s=0;for(;;)try{return await e.call(this)}catch(i){s++;const r=this._messageRetryPolicy.nextRetryDelayInMs(s);if(r==null||(await ro(r),t!=null&&t.aborted))throw i}}}class pd{constructor(e){this._retryOptions=e,this._maxRetriesToGetMaxDelay=Math.ceil(Math.log2(this._retryOptions.maxRetryDelayInMs)-Math.log2(this._retryOptions.retryDelayInMs)+1)}nextRetryDelayInMs(e){return e>this._retryOptions.maxRetries?null:this._retryOptions.mode==="Fixed"?this._retryOptions.retryDelayInMs:this._calculateExponentialDelay(e)}_calculateExponentialDelay(e){return e>=this._maxRetriesToGetMaxDelay?this._retryOptions.maxRetryDelayInMs:(1<<e-1)*this._retryOptions.retryDelayInMs}}class zk{constructor(e){this.isJoined=!1,this.name=e}}class Uk{constructor(e){this._promise=new Promise((t,s)=>{this._resolve=t,this._reject=s}),this.ackId=e}promise(){return this._promise}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}class Vk{constructor(){this._sequenceId=0,this._isUpdate=!1}tryUpdate(e){if(this._isUpdate=!0,e>this._sequenceId){const t=e-this._sequenceId;return this._sequenceId=e,t}return 0}tryGetSequenceId(){return this._isUpdate?(this._isUpdate=!1,[!0,this._sequenceId]):[!1,null]}reset(){this._sequenceId=0,this._isUpdate=!1}}class md{constructor(e,t,s){this._func=e,this._abortController=new ch,this._interval=t,this._obj=s,this._start()}abort(){try{this._abortController.abort()}catch{}}async _start(){const e=this._abortController.signal;for(;!e.aborted;)try{await this._func(this._obj)}catch{}finally{await ro(this._interval)}}}const Wk=1e3*60*60,Hk=1e3*30;class Gk{constructor(e,t,s,i=null,r=new Map){X(this,"client");X(this,"handler");X(this,"terminationTimeout",null);X(this,"connectionUrl");X(this,"expiresAt");X(this,"connected",!1);X(this,"websocketRequestId",null);X(this,"conversationId",null);X(this,"secondaryTypeBasedHandlers",new Map);this.connectionUrl=t,this.expiresAt=s,this.client=new Bk({getClientAccessUrl:()=>e(this.connectionUrl,this.expiresAt)},{autoReconnect:!0,reconnectRetryOptions:{maxRetries:5,retryDelayInMs:100,maxRetryDelayInMs:1e4,mode:"Exponential"}}),this.handler=i,this.secondaryTypeBasedHandlers=r}async start(){const e=t=>{if(this.secondaryTypeBasedHandlers.has(t.message.data.type)){const s=this.secondaryTypeBasedHandlers.get(t.message.data.type);if(!s)return;s(t.message.data)}else{const s=t.message.data.body,i=atob(s).trim();if(i.startsWith("data: ")){const r=i.replace("data: ",""),o=this.handler;if(!o)return;o({conversationId:t.message.data.conversation_id,responseId:t.message.data.response_id,message:{id:"",event:"",data:r},websocketRequestId:t.message.data.websocket_request_id})}}};this.client.on("group-message",t=>e(t)),this.client.on("server-message",t=>e(t)),this.client.on("connected",()=>{this.connected=!0}),this.client.on("disconnected",()=>{this.connected=!1}),await this.client.start()}addSecondaryTypeHandler(e,t){this.secondaryTypeBasedHandlers.set(e,t)}isConnected(){return this.connected}async stop(e){e&&this.conversationId!==e||this.websocketRequestId&&await Ee.stopWebsocketConversation(this.websocketRequestId)}setHandler(e,t,s,i){!this.handler&&this.websocketRequestId===s||(this.handler!=null&&this.websocketRequestId!==s&&(rb.warn("[websockets] Overwriting existing handler without silencing. This may indicate a race condition."),$.logEvent(V.asyncHandlerOverwritten,{originalWebsocketRequestId:this.websocketRequestId,newWebsocketRequestId:s,conversationId:e,responseId:t})),this.websocketRequestId=s,this.conversationId=e,this.handler=r=>{(r.websocketRequestId===s||r.conversationId===e&&r.responseId===t)&&i(r.message)})}silence(){this.handler=null}close(){this.client.stop()}scheduleForTermination(e){this.terminationTimeout=setTimeout(()=>{this.close(),e()},Wk)}preventTermination(){this.terminationTimeout&&(clearTimeout(this.terminationTimeout),this.terminationTimeout=null)}updateConnectionUrl(e,t){this.connectionUrl=e,this.expiresAt=t}}class qk{constructor(){X(this,"activeSocketMap",new Map);X(this,"secondaryTypeBasedHandlers",new Map)}async register(){const e=await Ee.postRegisterWebsocket();e.wss_url&&(this.getOrCreateSocket(e.wss_url,new Date(e.expires_at),!0),e.fallback_wss_url&&this.getOrCreateSocket(e.fallback_wss_url,new Date(e.expires_at),!1))}async registerIfNotConnected(){if(this.activeSocketMap.size===0){await this.register();return}for(const e of this.activeSocketMap.values())if(!e.isConnected()){await this.register();return}}isWebsocketConnected(){for(const e of this.activeSocketMap.values())if(e.isConnected())return!0;return this.activeSocketMap.size>0&&xt.addError("Cannot connect to any websocket."),!1}async getOrCreateSocket(e,t,s){const i=e.split("?")[0];let r;const o=this.activeSocketMap.get(i);if(o&&o.isConnected())o.preventTermination(),o.updateConnectionUrl(e,t),r=o;else{o&&o.close(),r=new Gk(async(a,l)=>{if(new Date<new Date(l.getTime()-5*1e3))return a;const d=await Ee.postRegisterWebsocket();return s?d.wss_url:d.fallback_wss_url??""},e,t,null,this.secondaryTypeBasedHandlers),this.activeSocketMap.set(i,r);try{await r.start()}catch(a){throw xt.addError(new Error("Error occurred while starting websocket: ",{cause:a})),a}}return r}preSetupWebsocket(e,t,s){for(const i of this.activeSocketMap.values())this.setupWebSocketHandler(i,null,null,null,e,t,s)}addSecondaryTypeHandler(e,t){this.secondaryTypeBasedHandlers.set(e,t);for(const s of this.activeSocketMap.values())s.addSecondaryTypeHandler(e,t)}hasSecondaryTypeHandler(e){return this.secondaryTypeBasedHandlers.has(e)}async processWebSocketConversationStream(e,t,s,i,r,o,a,l,d){const u=[this.getOrCreateSocket(e,s,!0)];t&&u.push(this.getOrCreateSocket(t,s,!1));const h=await Promise.allSettled(u),f=h[0].status==="fulfilled"?h[0].value:null,m=h.length>1&&h[1].status==="fulfilled"?h[1].value:null;if((!f||!f.isConnected())&&xt.addError(`Cannot connect to primary websocket, websocketRequestId: ${o}, token: ${e.substring(0,e.indexOf("access_token="))}`),(!f||!f.isConnected())&&(!m||!m.isConnected()))throw t&&xt.addError(`Cannot connect to fallback websocket, websocketRequestId: ${o}, token: ${t.substring(0,t.indexOf("access_token="))}`),new ts(`An error occurred while connecting to the websocket. ${Ya}`);let p=setTimeout(()=>{xt.addError(`WebSocket took too long to respond: ${r}, ${i}, ${o}, ${e.substring(0,60)}...${e.slice(-20)}`,{supportsWebSockets:"WebSocket"in window&&window.WebSocket.CLOSING===2})},Hk);const g=S=>(d&&(clearTimeout(d),d=null),p&&(clearTimeout(p),p=null),a(S));f&&this.setupWebSocketHandler(f,e,i,r,o,g,l),m&&t&&this.setupWebSocketHandler(m,t,i,r,o,g,l)}async stopConversation(e){for(const t of this.activeSocketMap.values())await t.stop(e)}setupWebSocketHandler(e,t,s,i,r,o,a){e.setHandler(s,i,r,o),this.secondaryTypeBasedHandlers.forEach((d,u)=>{e.addSecondaryTypeHandler(u,d)});const l=()=>{t?e.scheduleForTermination(()=>{this.activeSocketMap.delete(t.split("?")[0])}):(this.stopConversation(s),e.silence())};a.addEventListener("abort",l)}}const gs=new qk;function $k(n){return{webSocketUrl:n.wss_url,fallbackWebSocketUrl:n.fallback_wss_url,conversationId:n.conversation_id,responseId:n.response_id,expiresAt:n.expires_at&&new Date(n.expires_at),websocketRequestId:n.websocket_request_id}}async function Kk(n,e,t){return gs.preSetupWebsocket(n,e,t)}async function Jk(n,e,t,s,i,r,o,a,l){return gs.processWebSocketConversationStream(n,e,t,s,i,r,o,a,l)}function ao(n){return n==null||[De.PrimaryAssistant,De.GizmoInteraction].includes(n.kind)}function na(n,e){const t=Ts(n,e),{data:s}=Ms(t!=null&&"gizmo_id"in t?t.gizmo_id:void 0,(t==null?void 0:t.kind)===De.GizmoTest);if(t!=null)switch(t.kind){case De.GizmoInteraction:case De.GizmoMagicCreate:case De.GizmoTest:return{gizmo:s,...t};case De.PrimaryAssistant:return t}}function Yk(n,e,t){const i=I.getTree(e).getMessageId(I.getThreadCurrentLeafId(e));Ee.generateTitle(e,i,t).then(({title:r})=>{I.setTitle(e,r,yf.Generated),fc(n),$.logEvent(V.renameThread,{threadId:e,content:r,model:t})}).catch(xt.addError)}function Qk(n,e,t){const s=()=>{const r=nd(t);n(r)},i=bt.getGizmoId(t);i!=null?Ux(e,i).then(r=>{og(nd(t,r))}).catch(r=>{xt.addError(r),s()}):s()}const Za={onCreate(n,e,t,s){$.logEvent(V.newThread),!s&&ao(bt.getConversationMode(e))&&Qh(t).then(i=>{Xh(i)||(fc(t),Qk(n,t,e))})},onCreateFinished(n,e,t){var s;if(!(t||!e)&&!$e.checkGate("2562876640")){const i=(s=bt.getThread(e))==null?void 0:s.initialThreadData.lastModelUsed;i==null&&xt.addError("missing lastModelUsed on conversation create finished"),Yk(n,e,i)}}},gd=ze.div`m-8 flex flex-col items-center`;function yd(n){return c.jsx(Oe.div,{initial:{opacity:0,translateY:20},animate:{opacity:1,translateY:0,transition:{duration:.5,ease:"easeIn"}},...n})}function Xk({clientThreadId:n}){const e=dS(n),t=e==null?void 0:e.gizmoId,{data:s}=Ms(t);return t==null||s==null||!ag(s)?null:c.jsx(Zk,{gizmoId:t})}function Zk({gizmoId:n}){const[e,t]=y.useState(!1),[s,i]=y.useState(!1),r=Vx(n),o=async l=>{t(!0),setTimeout(()=>{i(!0)},5e3),$.logEvent(V.submitInlineRating,{gizmo_id:n,rating:l}),await r.mutateAsync({rating:l})},a=async()=>{i(!0),$.logEvent(V.dismissInlineRating,{gizmo_id:n}),await r.mutateAsync({})};return y.useEffect(()=>{s||$.logEvent(V.showInlineRating,{gizmo_id:n})},[s,n]),s?null:e?c.jsx(gd,{children:c.jsxs(yd,{className:"flex flex-col items-center gap-4",children:[c.jsx("div",{className:"rounded-lg border border-token-border-heavy p-4",children:c.jsxs("div",{className:"flex justify-between gap-2",children:[c.jsx(D,{id:"gizmo.inlineReview.reviewLeft",defaultMessage:"Feedback sent"}),c.jsx(Qa,{onClick:()=>{i(!0)}})]})}),c.jsx("div",{className:"text-xs text-token-text-tertiary",children:c.jsx(D,{id:"gizmo.inlineReview.reviewLeftSubtext",defaultMessage:'To update your rating, click "Send Feedback" in the GPT Menu'})})]})}):c.jsx(gd,{children:c.jsxs(yd,{className:"flex flex-col items-center gap-4 rounded-lg border border-token-border-heavy p-4",children:[c.jsxs("div",{className:"flex justify-between gap-2",children:[c.jsx(D,{id:"gizmo.inlineReview.prompt",defaultMessage:"How would you rate this GPT so far?"}),c.jsx(Qa,{onClick:a})]}),c.jsx(dk,{rating:void 0,onRating:o})]})})}function e0(n,e){const t=Fi(Li.MentionGPTs),s=dh(),[i,r]=y.useState(!1),o=()=>{r(!0),t.markAsViewed()};return y.useImperativeHandle(e,()=>({handleClose:o})),t.eligible&&!t.isLoading&&!s?c.jsx(t0,{wasDismissed:i,onDismiss:o}):null}function t0({wasDismissed:n,onDismiss:e}){const t=ue(),{recent:s,pinned:i}=uk(),r=s&&s.pages.flatMap(o=>o.list.items).length>0||i&&i.items.length>0;return y.useEffect(()=>{r&&$.logEvent(V.mentionsDisplayNux)},[r]),r?c.jsx(Wo,{badge:"beta",align:"start",side:"top",arrowPadding:58,show:!n,title:t.formatMessage({id:"mentionGptsAnnouncement.title",defaultMessage:"GPT mentions"}),onDismiss:e,sideOffset:25,theme:"default",description:c.jsx(D,{id:"mentionGptsAnnouncement.description",defaultMessage:"Type {key} to mention a GPT and add it directly into your conversation",values:{key:c.jsx("span",{className:"font-bold",children:"@"})}}),children:c.jsx("div",{className:"absolute sm:left-16"})}):null}const n0=y.forwardRef(e0);function s0({composerController:n}){const{doesUserHaveAnyAccountsWithPlusFeatures:e}=ti(),t=ue(),s=Ho();return c.jsxs("div",{className:K("flex justify-between",!s&&"bg-gradient-to-t from-token-main-surface-primary to-transparent px-4"),children:[c.jsx("div",{className:"flex gap-2",children:c.jsx(r0,{onClickStyle:i=>{bd(t.formatMessage(i.expandedName??i.name),n)}})}),e&&c.jsx("div",{className:"flex gap-2",children:c.jsx(i0,{onClickAspectRatio:i=>bd(t.formatMessage(i.expandedName),n)})})]})}function i0({onClickAspectRatio:n}){const e=ue();return c.jsxs(ne.Root,{onOpenChange:t=>{t&&($e.logEvent(V.dalleOpenAspectRatioDropdown),$.logEvent(V.dalleOpenAspectRatioDropdown))},children:[c.jsxs(el,{$as:ne.Trigger,className:"pr-1.5",children:[c.jsx(D,{id:"dalleControls.aspectRatio",defaultMessage:"Aspect Ratio"}),c.jsx(Zo,{className:"icon-md"})]}),c.jsx(ne.Portal,{children:c.jsx(ne.Content,{children:lg.map(t=>c.jsx(ne.Item,{onClick:()=>{var s;n(t),$e.logEvent(V.dalleClickAspectRatio,(s=t.name.defaultMessage)==null?void 0:s.toString()),$.logEvent(V.dalleClickAspectRatio,{aspectRatio:t.name.defaultMessage})},icon:t.icon,children:e.formatMessage(t.name)},t.name.id))})})]})}function r0({onClickStyle:n}){const[e,t]=y.useState(xd()),s=ob(),i=Xl(),r=Nr(),o=ue();let a=2;return r||(i?a=5:s&&(a=3)),c.jsxs(c.Fragment,{children:[e.slice(0,a).map(l=>c.jsx(vs,{label:c.jsx(o0,{style:l}),side:"top",sideOffset:4,customPaddingClassName:"p-1",children:c.jsxs(el,{$as:"button",type:"button",onClick:()=>{var d;n(l),$e.logEvent(V.dalleClickStyle,(d=l.name.defaultMessage)==null?void 0:d.toString()),$.logEvent(V.dalleClickStyle,{style:l.name.defaultMessage})},children:[c.jsx(US,{className:"h-4 w-4 text-token-text-tertiary"}),o.formatMessage(l.name)]})},l.name.id)),c.jsx(el,{$as:"button",type:"button",onClick:()=>{t(xd()),$e.logEvent(V.dalleShuffleStyles),$.logEvent(V.dalleShuffleStyles)},children:c.jsx(cg,{className:"icon-sm text-token-text-tertiary"})}),uh.map(l=>c.jsx("img",{src:l.image.src,alt:o.formatMessage(l.name),width:100,height:100,className:"invisible fixed -left-96 -top-96"},l.name.id))]})}function o0({style:n}){const e=ue();return c.jsxs("div",{className:"flex flex-col gap-1",children:[c.jsx("img",{src:n.image.src,alt:e.formatMessage(n.name),width:100,height:100,className:"rounded-md"}),c.jsx("div",{className:"text-xs font-medium",children:e.formatMessage(n.name)})]})}function xd(){return[...uh].sort(()=>Math.random()-.5)}function a0(n,e){const t=e.getCurrentText();return t.trim()===""?n:t.endsWith(",")?` ${n.toLocaleLowerCase()}`:t.endsWith(", ")?n.toLocaleLowerCase():`, ${n.toLocaleLowerCase()}`}function bd(n,e){const t=a0(n,e);e.appendText(t),cr()}const el=ze.div`h-7 bg-token-main-surface-primary border border-token-border-light text-xs hover:bg-token-main-surface-secondary hover:text-token-text-primary px-2.5 radix-state-open:bg-token-main-surface-secondary radix-state-open:text-token-text-primary rounded-full flex flex-nowrap gap-0.5 items-center text-token-text-secondary font-normal`,Kr={initial:{opacity:0,y:20,scale:.9},animate:{opacity:1,y:0,scale:1},transition:{delay:.1},exit:{opacity:0,scale:.5,transition:{duration:.2}}},l0=({suggestions:n,onSelectingSuggestedReply:e})=>c.jsx("div",{className:"absolute bottom-full flex w-full max-w-[100vw] grow gap-2 overflow-auto px-1 pb-1 contain-inline-size sm:mb-0 sm:justify-start sm:px-2 sm:pb-0 md:static md:mb-2 md:max-w-none md:justify-center md:overflow-visible",children:n.slice(0,2).map((t,s)=>c.jsx(Oe.div,{initial:Kr.initial,animate:Kr.animate,transition:{delay:(s-1)*Kr.transition.delay},exit:Kr.exit,children:c.jsx(ft,{as:"button",color:"secondary",size:"small",onClick:()=>{e(t,n,s)},className:"group whitespace-nowrap md:whitespace-normal",children:c.jsx(d0,{suggestion:t})},s)},s))});function c0({suggestions:n,onSelectingSuggestedReply:e,clientThreadId:t}){const s=(n==null?void 0:n.length)>0;y.useEffect(()=>{s&&_o(n,t)},[s,t]);const{isUnauthenticated:i}=Ht();return s?n.every(Tf)?c.jsxs(Oe.div,{initial:{opacity:0},animate:{opacity:1},transition:{duration:.3},className:"flex flex-col items-center",children:[i&&c.jsx(Zh,{className:"mb-6 h-12 w-12 sm:hidden"}),c.jsx(_S,{starterPrompts:n,onSelectStarterPrompt:e})]}):n.every(_f)?c.jsx(l0,{suggestions:n,onSelectingSuggestedReply:e}):null:null}function d0({suggestion:n}){return _f(n)?c.jsx(c.Fragment,{children:n.text}):Tf(n)?c.jsxs("div",{className:"flex flex-col overflow-hidden",children:[n.title&&c.jsx("div",{className:"truncate font-semibold",children:n.title}),c.jsx("div",{className:K("truncate font-normal",n.title?"opacity-50":""),children:n.body})]}):null}function u0(){const{store:n}=Wt(),e=n.useSharedProps();return e?c.jsx(h0,{...e}):null}function h0({clientThreadId:n,suggestions:e}){const t=Nf();return e===void 0||e.length===0?null:c.jsx("div",{children:c.jsx(f0,{children:c.jsx("div",{className:"grow",children:e!==void 0&&c.jsx(c0,{suggestions:e,onSelectingSuggestedReply:t,clientThreadId:n})})})})}const f0=ze.div`h-full flex ml-1 md:w-full md:m-auto gap-0 md:gap-2 justify-center`,Uf=({className:n,children:e})=>c.jsx(Oe.div,{className:n,initial:{opacity:0},animate:{opacity:1},exit:{opacity:0,transition:{duration:.1,delay:0}},transition:{type:"tween",duration:.3,delay:.2},children:e});function p0({currentLeafId:n,canContinue:e,onContinueGenerating:t}){const s=y.useCallback(()=>{const r=new Ss;t(n,r),cr()},[t,n]);let i=null;return e&&(i=c.jsx(m0,{onHandleContinueGenerating:s})),i&&c.jsx("div",{className:"flex h-full w-full items-center justify-end gap-0 py-4 md:gap-2",children:i})}const m0=({onHandleContinueGenerating:n})=>{const e=ef();return c.jsx(Uf,{children:c.jsxs(ft,{as:"button",color:"secondary",onClick:n,className:"whitespace-nowrap border-0 md:border",children:[c.jsx(Af,{className:K("-rotate-180",e?"icon-xs":"icon-sm")}),e&&c.jsx(D,{...xn.continueGenerating})]})})},g0=({clientThreadId:n})=>{const e=tf(),t=Pr(n),s=ks(t);y.useEffect(()=>{s&&pr.dismissBanner()},[s]);const i=e!=null&&e.is_dismissible?()=>pr.dismissBanner():void 0;return c.jsx(ws,{children:e&&c.jsx(Oe.div,{transition:{type:"tween",ease:"easeInOut",duration:.1},initial:{opacity:0,transform:"translateY(8px)"},animate:{opacity:1,transform:"translateY(0px)"},exit:{opacity:0,transform:"translateY(8px)"},children:c.jsx(hk,{clientThreadId:n,rateLimitInfo:e,onDismiss:i})})})};function y0(n){const e=Pr(n),t=ks(e),s=tf();return!t&&s!=null}const Vn=window.sessionStorage,tl=nf(ab(()=>({memoryFullBannerDismissed:!!(Vn!=null&&Vn.getItem(ji.MemoryFullBannerDismissed))}))),Vf={dismissBanner(){tl.setState(n=>{n.memoryFullBannerDismissed=!0}),Vn==null||Vn.setItem(ji.MemoryFullBannerDismissed,"true")},clearDismissedBanner(){tl.setState(n=>{n.memoryFullBannerDismissed=!1}),Vn==null||Vn.removeItem(ji.MemoryFullBannerDismissed)}};function x0(n){const e=en(n),t=Uo(),{data:s}=Vo(e,!1,t),i=s!=null,r=i&&s.memoryFullPct>=100,[o,a]=y.useState(!1);y.useEffect(()=>{!r&&i&&(a(!0),Vf.clearDismissedBanner())},[r,i]);const l=tl(d=>d.memoryFullBannerDismissed);return r&&o&&!l}function b0(){const n=ue(),{openSettings:e}=dg();return c.jsx(Oe.div,{initial:{opacity:0},animate:{opacity:1},children:c.jsx(hh,{title:n.formatMessage(Jr.memoryFullTitle),content:n.formatMessage(Jr.memoryFullTooltip,Jr.memoryFullTooltip.values),primaryCtaText:n.formatMessage(Jr.memoryManageButton),onPrimaryCtaClick:()=>e(ug.Personalization),onDismiss:()=>Vf.dismissBanner()})})}const Jr=Ce({memoryFullTitle:{id:"yRGU2/",defaultMessage:"Memory is full."},memoryManageButton:{id:"a5A88o",defaultMessage:"Manage"},memoryFullTooltip:{id:"neUc+N",defaultMessage:"New memories wonâ€™t be created until you make space. <a>Learn more</a>",values:{a:n=>c.jsx("a",{href:hg,target:"_blank",rel:"noopener noreferrer",className:"underline",children:n})}}}),S0=()=>{const{shouldShowSkipButton:n}=fh();return n?c.jsx(Uf,{className:"flex justify-center",children:c.jsx(ft,{as:"button",color:"secondary",onClick:()=>ph.skipParagen(),children:c.jsx(D,{...k0.skip})})}):null},k0=Ce({skip:{id:"dvcUbp",defaultMessage:"Skip"}}),w0=y.memo(function({className:e}){const{store:t}=Wt(),s=t.useIsHeaderContentAreaPopulated();return c.jsx("div",{className:K(e??"absolute bottom-full left-0 right-0",qa.PromptTextareaHeader),children:c.jsx(fg,{shouldRender:s,contentArea:Ei.Header,children:c.jsxs("div",{className:"mb-2 flex flex-col gap-3.5 pt-2",children:[c.jsx(C0,{}),c.jsx(v0,{})]})})})});function C0(){const{store:n}=Wt(),e=n.useContentAreaId(Ei.HeaderTop);let t;switch(e){case it.ParagenControls:t=c.jsx(S0,{});break;case it.ItemActions:t=c.jsx(u0,{});break;case it.BannerSignup:t=c.jsx(T0,{});break;case it.BannerTermsDisclaimer:t=c.jsx(_0,{});break;case it.PromptTextareaAction:t=c.jsx(N0,{});break;case it.BannersRateLimit:t=c.jsx(E0,{});break;case it.BannerSidekickAnnouncement:t=c.jsx(FS,{});break;case it.BannerMemoryFull:t=c.jsx(b0,{});break;case it.Box:t=c.jsxs("div",{className:"flex h-20 w-full items-center justify-center gap-2 bg-red-500 p-2",children:["box",c.jsxs("div",{className:"flex h-full w-full items-center justify-center gap-2 bg-blue-500 p-2",children:["inner",c.jsx("div",{className:"flex h-full w-full items-center justify-center bg-yellow-400 text-center",children:"actual content"})]})]});break;default:t=null;break}return t}function v0(){const{store:n}=Wt(),e=n.useContentAreaId(Ei.HeaderBottom);let t;switch(e){case mh.DallePromptControls:t=c.jsx(M0,{});break;default:t=null;break}return t}function M0(){const{store:n}=Wt(),e=n.useSharedProps(t=>t==null?void 0:t.composerController);return e?c.jsx(s0,{composerController:e}):null}function T0(){const{store:n}=Wt(),e=n.useSharedProps(i=>i==null?void 0:i.clientThreadId),t=pg(),s=mg();return e?t?c.jsx(gg,{threadId:e,showSignUp:s}):c.jsx(yg,{threadId:e,showLogin:s}):null}function _0(){const{store:n}=Wt(),e=n.useSharedProps(t=>t==null?void 0:t.clientThreadId);return e?c.jsx(xg,{threadId:e}):null}function N0(){const{store:n}=Wt(),e=n.useSharedProps();return e?c.jsx(p0,{...e}):null}function E0(){const{store:n}=Wt(),e=n.useSharedProps(t=>t==null?void 0:t.clientThreadId);return e?c.jsx(g0,{clientThreadId:e}):null}function yc(){return rf(ni.DataAnalysisV2)}function lE(){const n=Er(),e=Nn();return e&&n&&!sf(n)&&e.isEnterprise()}function I0(){return rf(ni.ChartSerialization)}function cE(n,e){const t=n==="chart"?ji.HasSeenAdaInteractiveChart:ji.HasSeenAdaInteractiveTable,[s,i]=y.useState(sd.getItem(t,{userId:e})??!1),r=y.useCallback(()=>{i(!0),sd.setItem(t,!0,{userId:e})},[t,e]);return[s,r]}function dE(n){const[e,t]=y.useState([]),s=Jn(()=>{const i=I.resolveThreadId(n),r=I.getThreadCurrentLeafId(n);return I.getTree(i).getBranchFromLeaf(r)});return y.useEffect(()=>{const i=Hf(s);i.length!==e.length&&t(i)},[e.length,n,s]),e}function A0(n){return Jn(()=>{const e=I.resolveThreadId(n),t=I.getThreadCurrentLeafId(n),i=I.getTree(e).getBranchFromLeaf(t);return Hf(i).length>0})}function Wf(n){var r,o,a,l;const e=((o=(r=n.metadata)==null?void 0:r.aggregate_result)==null?void 0:o.messages.filter(mc))??[];let t=0;const s=(((a=n.metadata)==null?void 0:a.ada_visualizations)??[]).map(d=>{let u=d;return d.type=="chart"&&(u={...d,fallback_image:e[t++]}),u}),i=(((l=n.metadata)==null?void 0:l.attachments)??[]).filter(d=>gh(d.name)).map(d=>({type:"table",file_id:d.id??"",title:Sg(d),file_name:d.name,context_connector_info:d.context_connector_info}));return[...s,...i]}function Hf(n){return n.filter(t=>{var s,i,r,o;return((s=t.message)==null?void 0:s.author.role)==="tool"&&((i=t.message)==null?void 0:i.author.name)==="python"||(((o=(r=t.message)==null?void 0:r.metadata)==null?void 0:o.attachments)??[]).length>0}).flatMap(t=>Wf(t.message))}nf(n=>({selectedSpreadsheet:null,setSelectedSpreadsheet:e=>n({selectedSpreadsheet:e})}));async function j0(n,e,t){const s=await n.text(),{parse:i}=await ve(async()=>{const{parse:o}=await import("./oeujip5i1ptrxie5.js");return{parse:o}},[]),r=i(s);return{content:{columnNames:r.shift(),columnTypes:r[0].map(()=>"string"),rows:r},file_name:e,download_url:t}}function R0(n){const e=n[0].values.length,t=[];for(let s=0;s<e;s++){const i=n.map(r=>r.values[s]);t.push(i)}return t}function uE(n){return $o({queryKey:["ada-visualization","chart",n.file_id],queryFn:async()=>{const e=await Ee.getFileDownloadLink(n.file_id);if(e.status===of.Success){const s=await(await fetch(e.download_url)).json();return{content:{chart_type:s.type,title:s.title,labels:s.labels,datasets:s.datasets,x_label:s.x_label,y_label:s.y_label},file_name:e.file_name??"",download_url:e.download_url}}else throw new Error("Failed to download chart json from interpreter")}})}function hE(n){return $o({queryKey:["ada-visualization","table",n.file_id],queryFn:async()=>{if(n.file_name&&bg(n.file_name)){const e=await Ee.getAdaExcelFileContents(n.file_id);return{content:e.sheets.map(t=>({name:t.name,columnNames:t.columns.map(s=>s.name),columnTypes:t.columns.map(()=>"string"),rows:R0(t.columns)})),download_url:e.download_url,file_name:n.file_name}}else{const e=await Ee.getFileDownloadLink(n.file_id);if(e.status===of.Success){const t=await fetch(e.download_url);return j0(t,e.file_name??"",e.download_url)}else throw new Error("Failed to download from interpreter")}}})}function Gf(n){const e=Ii(),t=A0(n),s=yc();return t&&s&&!e.displayingSideBySideFeedback}function D0(n){var e,t;return((t=(e=n.metadata)==null?void 0:e.dalle)==null?void 0:t.prompt)??""}async function O0(n,e,t="image/png"){return new Promise((s,i)=>{n.toBlob(r=>{r!=null?s(new File([r],e,{type:t})):i(new Error("Failed to convert canvas to blob"))},t)})}async function P0(n,e){const t=document.createElement("canvas");t.width=n.width,t.height=n.height;const s=t.getContext("2d");if(s==null)throw new Error("Failed to get 2d context for mask canvas");const i=s.createImageData(n.width,n.height);for(let r=0;r<n.data.length;r+=4)n.data[r+3]!==0?(i.data[r]=0,i.data[r+1]=0,i.data[r+2]=0,i.data[r+3]=255):(i.data[r]=255,i.data[r+1]=255,i.data[r+2]=255,i.data[r+3]=255);return s.putImageData(i,0,0),O0(t,e)}async function F0(n,e){const s=await(await fetch(n)).blob(),i=document.createElement("a");i.href=URL.createObjectURL(s),i.download=e,i.click(),i.remove()}function L0(n){const e=Cg(new Date,"yyyy-MM-dd HH.mm.ss");let t=n.slice(0,150);return t.endsWith(".")&&(t=t.slice(0,-1)),`DALLÂ·E ${e} - ${t}.webp`}async function fE(n,e,t){var r,o,a,l,d,u,h,f,m,p;const s=D0(n),i=L0(s);await F0(n.url,i),$e.logEvent("chatgpt_dalle_image_download",null,{sourceOperation:((o=(r=n.metadata)==null?void 0:r.dalle)==null?void 0:o.edit_op)??"none",hasParent:((l=(a=n.metadata)==null?void 0:a.dalle)==null?void 0:l.parent_gen_id)!=null?"true":"false"}),$.logEvent(V.dalleImageDownload,{conversationId:e,messageId:t,generationId:(u=(d=n.metadata)==null?void 0:d.dalle)==null?void 0:u.gen_id,parentGenerationId:(f=(h=n.metadata)==null?void 0:h.dalle)==null?void 0:f.parent_gen_id,fileId:Go(n.asset_pointer),sourceOperation:(p=(m=n.metadata)==null?void 0:m.dalle)==null?void 0:p.edit_op})}function B0(n){const e=na(n),t=Nr(),s=e&&"gizmo"in e?e.gizmo:void 0;return!t&&(s==null?void 0:s.gizmo.id)===kg}function pE(n,e){var i,r;const t=(r=(i=e.metadata)==null?void 0:i.dalle)==null?void 0:r.gen_id,s=Go(e.asset_pointer);return s==null||t==null?n:{...n,messageMetadata:{...n.messageMetadata,dalle:{from_client:{operation:{type:"transformation",original_gen_id:t,original_file_id:s}}}}}}async function z0(n,e,t){return new Promise((s,i)=>{wg(yh(n),n,e,{kind:lb.DalleAgent},{onFileCreated:kn,onFileUploadProgress:kn,onFileUploaded:(r,o)=>s(o),onError:(r,o)=>{i(new Error(`Failed to upload file with reason: ${o}`))}},t)})}async function mE(n,e,t,s){var o,a;const i=(a=(o=e.metadata)==null?void 0:o.dalle)==null?void 0:a.gen_id,r=Go(e.asset_pointer);if(r==null||i==null||t==null)return n;try{const l=await P0(t,"mask.png"),d=await z0(l,s,{imageDimensions:{width:e.width,height:e.height}});return{...n,messageMetadata:{...n.messageMetadata,dalle:{from_client:{operation:{type:"inpainting",original_gen_id:i,original_file_id:r,mask_file_id:d}}}}}}catch(l){return xt.addError(l),n}}const U0=y.memo(function(e){return V0(e),W0(e),H0(),null});function V0(n){const{store:e}=Wt(),t=e.useSetSharedProps();y.useLayoutEffect(()=>{t(n)},[n,t])}function W0(n){const{clientThreadId:e,canContinue:t}=n,{store:s}=Wt(),i=y.useRef({top:s.useContentAreaApi(Ei.HeaderTop),bottom:s.useContentAreaApi(Ei.HeaderBottom)}).current,r=$0(n),o=B0(e),{shouldShowBannerSignup:a,shouldShowBannerTermsDisclaimer:l}=K0(e),d=y0(e),u=LS(n),h=x0(e),f=vg();y.useLayoutEffect(()=>{f?i.top.set(it.ParagenControls):l?i.top.set(it.BannerTermsDisclaimer):d?i.top.set(it.BannersRateLimit):u.eligible?i.top.set(it.BannerSidekickAnnouncement):r?i.top.set(it.ItemActions):t?i.top.set(it.PromptTextareaAction):a?i.top.set(it.BannerSignup):h?i.top.set(it.BannerMemoryFull):i.top.set(null)},[i,r,t,l,a,d,u,h,f]),y.useLayoutEffect(()=>{o&&i.bottom.set(mh.DallePromptControls)},[i,o])}function H0(){const{store:n}=Wt();y.useEffect(()=>()=>{n.reset()},[n])}function G0(n){var i,r;const e=bh(),t=Mn(n),s=(r=(i=I.getTree(n).getLastValidNode(t))==null?void 0:i.message)==null?void 0:r.id;return(e==null?void 0:e.messageId)===s?e.suggestions:[]}function q0(n){return G0(n).length>0}function $0(n){const e=Gf(n.clientThreadId),t=q0(n.clientThreadId);return n.isDisabled?!1:n.isNewThread||e||t}function K0(n){var h;const{isUnauthenticated:e}=Ht(),t=Mn(n),{layer:s}=Ko("3637408529"),i=s.get("should_show_no_auth_signup_banner",!0),r=xh(f=>f.bannerDisclaimerClientThreadId),o={shouldShowBannerTermsDisclaimer:!1,shouldShowBannerSignup:!1};if(!n)return o;const a=I.getTree(n),l=a.countMessagesByAuthor(Se.User),d=a.getNodeByIdOrMessageId(t),u=((h=d==null?void 0:d.message)==null?void 0:h.author.role)===Se.Assistant&&Zl(d.message);return o.shouldShowBannerTermsDisclaimer=u&&e&&l===1&&(r==null||r===n),o.shouldShowBannerSignup=i&&u&&e&&l>0&&l%5===0,o}function J0(n,e,t,s,i){const{getGizmoId:r}=Ir(),[o,a]=y.useState();y.useEffect(()=>{r?r().then(u=>a(u)):a(void 0)},[r]);const l=af(e);return y.useCallback(u=>{const{docsReferencedByURL:h}=bt.getThread(n)??{};if(h!=null)for(const f of u){const{id:m,type:p,handler:g}=f,S=`${p}:${m}`,x=h[S],C=dr.getState().files.find(k=>k.tempId===m);if(x!=null&&x!=="failed"&&C){pn.success(t.formatMessage(Sa.fileAlreadyAttached),{hasCloseButton:!0});continue}switch(g.type){case"fetch":{I.updateReferencedDocState(n,S,"pending"),us.uploadFile(m,new File([],t.formatMessage(Sa.fileLoading)),Ys.None,s,t,{skipUpload:!0,gizmoId:o},i,{contextConnector:p,sourceUrl:f.url,syntheticExtension:null,type:vo.Link}),pa.linkMetadataFetchStarted(p),g.tryFetch().then(k=>{if(us.remove(m,"none"),k==null)return null;const{id:v,title:T,connector:A,mimeType:L,url:_,syntheticExtension:N,o365DriveId:z}=k;pa.linkMetadataFetchSucceeded(p,L),I.updateReferencedDocState(n,S,"fetched");let j=T;A===vt.GDRIVE&&(j=N?`${T}.${N}`:T),us.uploadFile(v,new File([],j,{type:L.split(";")[0]}),Ys.Retrieval,s,t,{gizmoId:o},i,{contextConnector:A,sourceUrl:_,syntheticExtension:N,type:vo.Link,o365DriveId:z})}).catch(k=>{pa.linkMetadataFetchFailed(p,k),pn.danger(t.formatMessage(Sa.fileFetchFailed),{hasCloseButton:!0}),I.updateReferencedDocState(n,S,"failed"),us.remove(m,"none")});break}case"prompt":{l.appendMessageIfNotDismissed({connector:p,type:g.message}),I.updateReferencedDocState(n,S,"prompted");break}}}},[i,n,l,o,t,s])}const Sa=Ce({fileLoading:{id:"CCC.fileLoading",defaultMessage:"Loadingâ€¦"},fileFetchFailed:{id:"CCC.fileFetchFailed",defaultMessage:"Unable to fetch file information"},fileAlreadyAttached:{id:"CCC.fileAlreadyAttached",defaultMessage:"This file is already a part of your message."}}),qf=({clientThreadId:n,rateLimitPopup:e,children:t,highlightTooltip:s=!1})=>{const i=ue(),r=cc(n),o=Nn(),[a,l]=y.useState(s),[d,u]=y.useState(!1),h=y.useCallback(()=>{d||l(!0)},[d]),f=y.useCallback(()=>{l(!1),u(!1)},[]),m=y.useCallback(()=>{l(!1),u(!0)},[]);y.useEffect(()=>{l(s)},[s]);const p=S=>{e!=null&&S&&$.logPopoverHover({type:"rate_limit",location:"file_upload",plan_type:(o==null?void 0:o.planType)??"unknown"})},g=!!e;return c.jsx(c.Fragment,{children:g?c.jsxs(cb,{delayDuration:150,onOpenChange:p,children:[c.jsx(db,{children:t}),c.jsx(ub,{children:c.jsx(Mg,{$as:hb,side:"top",sideOffset:4,className:"max-w-[260px]",children:c.jsx(Y0,{isNewConversation:r,rateLimitPopup:e})})})]}):c.jsx(vs,{sideOffset:14,label:i.formatMessage({id:"oUK/GV",defaultMessage:"Attach file"}),className:"flex",open:a||s,side:"top",children:c.jsx("span",{onPointerEnter:h,onPointerLeave:f,onClick:m,children:t})})})},Y0=({isNewConversation:n=!1,rateLimitPopup:e})=>{const t=Nn(),s=Rr();if(e==null)return null;const{call_to_action:i,description:r}=e,o=r||c.jsx(D,{...Sd.defaultDescription}),a=i==null?void 0:i.includes(fb.GET_PLUS);return c.jsxs("div",{className:"p-2 text-sm text-token-text-primary",children:[c.jsx("div",{children:o}),a?c.jsx(ft,{size:"small",color:"secondary",className:"mt-3",onClick:()=>{Rl(s,"Rate limited file upload popover"),$.logRateLimitGetPlusButtonClicked({type:"file_upload",location:"popover",plan_type:(t==null?void 0:t.planType)??"unknown",is_hard_block:!1,is_new_conversation:n,hard_block_reason:""})},children:c.jsx(D,{...Sd.getPlus})}):null]})},Sd=Ce({defaultDescription:{id:"U5qAWP",defaultMessage:"You've reached your daily upload limit. Get ChatGPT Plus to unlock more."},getPlus:{id:"TeyLcp",defaultMessage:"Get Plus"}});function Q0({clientThreadId:n,getInputProps:e,openFileDialog:t,uploadType:s,icon:i,highlightTooltip:r=!1}){const o=ue(),a=ec(),l=!!a,d=c.jsx(Sh,{className:"mb-1",disabled:l,onClick:f=>{f.preventDefault(),$.logEvent(V.openFileViewer,{intent:s.toString()}),t()},"aria-label":o.formatMessage({id:"PromptFilePicker.attachFiles",defaultMessage:"Attach files"}),children:i}),u=c.jsx("input",{disabled:l,...e({className:"hidden"})}),h=c.jsxs("div",{className:"flex",children:[d,u]});return c.jsx(qf,{clientThreadId:n,rateLimitPopup:a,highlightTooltip:r,children:h})}function X0({code:n,message:e}){switch(n){case Kc.FileTooLarge:return kd.errorFileTooLarge;case Kc.TooManyFiles:return $.logEvent(V.uploadedMaxFilesError),kd.errorTooManyFiles;default:return e}}const kd=Ce({attachImages:{id:"PromptFilePicker.attachImages",defaultMessage:"Attach images"},attachFiles:{id:"PromptFilePicker.attachFiles",defaultMessage:"Attach files"},errorFileTooLarge:{id:"PromptFilePicker.errorFileTooLarge",defaultMessage:"Your file is too large. The maximum file size is {size}MB."},errorTooManyFiles:{id:"PromptFilePicker.errorTooManyFiles",defaultMessage:"You may only upload {maxNum} files at a time."},defaultFileUploadRateLimited:{id:"U5qAWP",defaultMessage:"You've reached your daily upload limit. Get ChatGPT Plus to unlock more."},getPlusButton:{id:"TeyLcp",defaultMessage:"Get Plus"}}),wd=Ce({dragInstructions:{id:"FileDropZone.dragInstructions",defaultMessage:"Add anything"},dragAllAccepted:{id:"FileDropZone.dragAllAccepted",defaultMessage:"Drop any file here to add it to the conversation"}});function Z0(n){var k;const{className:e,children:t,clientThreadId:s,currentModelConfig:i}=n,r=ue(),o=na(s),a=xo(i,o),l=a!==Ys.None,d=dr(v=>v.files),u=(a===Ys.Multimodal?Dl:Ol)-d.length,h=u<=0,{getGizmoId:f}=Ir(),{handleFileAccepted:m}=Kf(r,xo(i,o),wh(i,o),"drag",f,(k=kh(i,o))==null?void 0:k.attachments),p=ec(),g=Ch(vh(i,o)),{getRootProps:S,isDragActive:x}=Mh({maxFiles:u,disabled:!l||h||p!=null,noClick:!0,onDropAccepted:m,onDropRejected:v=>$f(v,r,a),multiple:!0,maxSize:Th,...g}),w=C();function C(){if(!g.accept||Object.keys(g.accept).length===0)return[];const v=[];return Object.values(g.accept).forEach(T=>v.push(...T)),v.sort()}return c.jsxs("div",{...S({className:e}),children:[t,x&&c.jsxs(ew,{children:[c.jsx(Tg,{}),c.jsx("h3",{children:c.jsx(D,{...wd.dragInstructions})}),c.jsx("h4",{className:"w-2/3 text-center",children:w.length>0?w.join(", "):c.jsx(D,{...wd.dragAllAccepted})})]})]})}function $f(n,e,t){const{errors:s}=n[0];s.forEach(i=>{const r=X0(i);typeof r=="string"?pn.danger(r,{hasCloseButton:!0}):pn.danger(e.formatMessage(r,{size:_g,maxNum:t===Ys.Multimodal?Dl:Ol}),{hasCloseButton:!0})})}function Kf(n,e,t,s,i,r){return{handleFileAccepted:y.useCallback(async(a,l)=>{$.logEvent(V.uploadFile,{client:"web",eventSource:s,intent:e.toString()});const d=i!=null?await i():void 0;a.length>0&&a.forEach(u=>{us.uploadFile(yh(u),u,e,t,n,{gizmoId:d},r)})},[s,e,i,t,n,r])}}const ew=ze.div`absolute inset-0 opacity-80 flex gap-2 flex-col justify-center items-center bg-token-main-surface-primary text-token-text-primary`;function Jf({children:n,className:e,showBackground:t}){return c.jsxs("div",{className:"relative",children:[n,t&&c.jsx(Oe.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:260,damping:20},className:K("pointer-events-none absolute bottom-0 top-0 h-8 w-8 rounded-full",e)})]})}function Cd({entry:n,onClick:e}){const{connectorConfig:t}=Pl();y.useEffect(()=>{if(!open||n.type!==vt.GDRIVE)return;const o=t.get(vt.GDRIVE),a=o==null?void 0:o.access_token;a&&Ng(a)},[t,n.type]);const s=_h(n.type),i=ue(),r=n.access_token?vd.uploadFromMessage:vd.signinWithMessage;return c.jsx(ne.Item,{onClick:e,icon:s,children:c.jsxs("div",{className:"flex flex-col",children:[c.jsx(D,{...r,values:{connectorName:Fl(n.type,i)}}),n.type===vt.O365_BUSINESS&&c.jsx("div",{className:"text-s text-token-text-tertiary",children:c.jsx(D,{...Ll.includesSharePoint})})]})},n.id)}const vd=Ce({signinWithMessage:{id:"ContextConnectorPickerDropdownItem.signInWithMessage",defaultMessage:"Connect to {connectorName}"},uploadFromMessage:{id:"ContextConnectorPickerDropdownItem.uploadWithMessage",defaultMessage:"Add from {connectorName}"}});function tw({clientThreadId:n,icon:e,setOpen:t,highlightTooltip:s=!1}){const i=ec(),r=!!i,o=ue();return c.jsxs(c.Fragment,{children:[c.jsx(ne.Trigger,{className:"m-0 h-0 w-0 border-none bg-transparent p-0"}),c.jsx(qf,{clientThreadId:n,rateLimitPopup:i,highlightTooltip:s,children:c.jsx(Sh,{className:"mb-1","aria-disabled":r,"aria-label":o.formatMessage({id:"tA7CXR",defaultMessage:"Attach files"}),onClick:a=>{a.preventDefault(),r||t(!0)},children:e})})]})}function nw({connectorEntries:n,onOauthRedirect:e}){const t=ue();return c.jsxs(ne.Sub,{children:[c.jsx(ne.SubMenuTrigger,{icon:VS,children:c.jsx("div",{className:"line-clamp-1 text-ellipsis",children:c.jsx(D,{...sw.connectApps})})}),c.jsx(ne.Portal,{children:c.jsx(ne.SubContent,{children:n.map(s=>c.jsx(ne.Item,{onClick:()=>e(s),icon:_h(s.type),children:c.jsxs("div",{className:"flex flex-col",children:[Fl(s.type,t),s.type===vt.O365_BUSINESS&&c.jsx("div",{className:"text-s text-token-text-tertiary",children:c.jsx(D,{...Ll.includesSharePoint})})]})},s.id))})})]})}const sw=Ce({connectApps:{id:"ContextConnectorPicker.connectApps",defaultMessage:"Connect apps"}});function iw({onOauthRedirect:n,connectors:e}){const t=ue();return c.jsxs(ne.Sub,{children:[c.jsx(ne.SubMenuTrigger,{icon:WS,children:c.jsx(D,{...rw.oneDriveSubmenuName})}),c.jsx(ne.Portal,{children:c.jsx(ne.SubContent,{children:e.map(s=>s?c.jsx(ne.Item,{onClick:()=>n(s),children:c.jsxs("div",{className:"flex flex-col",children:[Fl(s.type,t),s.type===vt.O365_BUSINESS&&c.jsx("div",{className:"text-s text-token-text-tertiary",children:c.jsx(D,{...Ll.includesSharePoint})})]})},s.id):null)})})]})}const rw=Ce({oneDriveSubmenuName:{id:"ContextConnectorPickerOneDriveSubmenu.oneDriveSubmenuName",defaultMessage:"Connect to Microsoft OneDrive"}});function ow(){const{connectorConfig:n}=Pl(),e=Dr(),[t,s]=ur(Nh([...n.values()],d=>!!d.access_token),d=>!!d.access_token),[i,r]=ur(s,d=>d.type===vt.O365_PERSONAL||d.type===vt.O365_BUSINESS),o=!e&&t.length>0,a=!e&&!o&&i.length>1;return{unconnectedConnectors:a?r:s,showUnconnectedInSubmenu:o,showOneDriveInSubmenu:a}}function aw({clientThreadId:n,icon:e,modelAcceptedMimeTypes:t,modelSupportedImageMimeTypes:s,attachmentsProductFeature:i,onOauthRedirect:r,uploadType:o,getInputProps:a,openFileDialog:l,highlightTooltip:d=!1}){const{currentLocale:u}=pb(),h=ue(),f=Dr(),{connectorConfig:m,isLoading:p}=Pl(),g=Fi(Li.ContextConnectors),{getGizmoId:S}=Ir(),[x,w]=y.useState();y.useEffect(()=>{S?S().then(E=>w(E)):w(void 0)},[S]);const C=y.useRef(null),[k,v]=y.useState(!1),T=y.useRef(!1),A=y.useCallback(()=>{var fe;const E=(fe=C.current)==null?void 0:fe.files;Array.from(E??[]).forEach(Ue=>qr.uploadFile(Ue,s,h,i))},[s,i,h]),[L,_]=y.useState(null),N=y.useCallback(()=>_(null),[_]),z=y.useCallback((E,fe)=>qr.uploadPickedFile(E,fe,s,t,i,x,h),[s,t,i,x,h]),{openMenu:j,confirmMenuOpened:H}=Eg();y.useEffect(()=>{j&&(v(!0),H())},[j,H,v]);const Q=jr(),B=y.useCallback(E=>{qr.doContextConnectorOauthRedirect(Q.asPath,E,r,vo.Picker),r()},[r,Q.asPath]),U=y.useCallback(E=>{qr.uploadPickedFile(E,vt.GDRIVE,s,t,i,x,h)},[s,t,i,x,h]),O=y.useCallback(async E=>{const{access_token:fe}=E;if(!fe){B(E);return}switch(Ig(E,vo.Picker),E.type){case vt.GDRIVE:Ag(u,E.type,fe,Ue=>Ue.forEach(U));break;case vt.O365_PERSONAL:case vt.O365_BUSINESS:_(E.type);break}},[U,B,_,u]),R=()=>{$.logEvent(V.openFileViewer,{intent:o.toString()}),l()},M=E=>{if(!E&&T.current&&!p)R();else if(E&&xe&&!p){R();return}v(E),E&&(g.eligible&&g.markAsViewed(),$.logEvent(V.composerOpenContextConnectorPicker),T.current=!0,setTimeout(()=>{T.current=!1},250))},[F,J]=ur(Nh([...m.values()],E=>!!E.access_token),E=>!!E.access_token);lw(F,O);const[Z]=ur(J,E=>E.type===vt.O365_PERSONAL||E.type===vt.O365_BUSINESS),{unconnectedConnectors:se,showUnconnectedInSubmenu:he,showOneDriveInSubmenu:Ie}=ow(),xe=!F.length&&!se.length,Pe=c.jsxs(c.Fragment,{children:[he&&se.length>0&&c.jsx(nw,{connectorEntries:se,onOauthRedirect:E=>B(E)}),!he&&se.map(E=>c.jsx(Cd,{entry:E,onClick:()=>O(E)},E.id)),Ie&&c.jsx(iw,{connectors:Z,onOauthRedirect:B}),p&&c.jsx(ne.Item,{icon:c.jsx(lf,{className:"text-token-text-secondary"})}),(se.length>0||p)&&c.jsx(ne.Separator,{}),F.map(E=>c.jsx(Cd,{entry:E,onClick:()=>O(E)},E.id)),c.jsx(ne.Item,{onClick:R,icon:jf,children:c.jsx(D,{...f?Md.uploadFileMobile:Md.uploadFile})},"upload")]}),Ke=c.jsxs("div",{className:"flex flex-col",children:[c.jsx(jg,{type:L,onClose:N,uploadPickedFile:z}),c.jsx("input",{onChange:A,...a({className:"hidden"})}),c.jsxs(ne.Root,{open:k,onOpenChange:M,children:[c.jsx(tw,{clientThreadId:n,icon:e,setOpen:M,highlightTooltip:d}),c.jsx(ne.Portal,{children:c.jsx(ne.Content,{size:"large",children:Pe})})]}),c.jsx(Rg,{hasConnectors:!p&&!xe})]});return{dropdownItems:Pe,mainComponent:Ke}}function lw(n,e){const{connector:t,clearParam:s}=Dg(),i=n.find(r=>r.type===t&&!!r.access_token);y.useEffect(()=>{i&&(e(i),s())},[i,e,s])}function cw(n){const{mainComponent:e}=aw(n);return e}const Md=Ce({attachFiles:{id:"ContextConnectorPicker.attachFiles",defaultMessage:"Attach files"},uploadFile:{id:"LocalFileDropdownItem.uploadFile",defaultMessage:"Upload from computer"},uploadFileMobile:{id:"LocalFileDropdownItem.uploadFileMobile",defaultMessage:"Upload file"}});function dw({clientThreadId:n,uploadType:e,modelAcceptedMimeTypes:t,modelSupportedImageMimeTypes:s,attachmentsProductFeature:i,getInputProps:r,openFileDialog:o,onOauthRedirect:a,historyDisabled:l,className:d,highlightTooltip:u}){const{gdriveStatus:h,o365Status:f}=Og(),m=c.jsx(HS,{className:l?"text-white":u?"text-brand-blue-800":void 0});return c.jsx("div",{className:K("relative",d),children:c.jsx(Jf,{showBackground:u,className:"bg-brand-blue-800/20",children:h!=="false"||f!=="false"?c.jsx(cw,{clientThreadId:n,icon:m,modelAcceptedMimeTypes:t,modelSupportedImageMimeTypes:s,attachmentsProductFeature:i,onOauthRedirect:a,uploadType:e,openFileDialog:o,getInputProps:r,highlightTooltip:u}):c.jsx(Q0,{clientThreadId:n,uploadType:e,openFileDialog:o,getInputProps:r,icon:m,highlightTooltip:u})})})}function Yf(n,e,t){for(let s=0;;s++){if(s==n.childCount||s==e.childCount)return n.childCount==e.childCount?null:t;let i=n.child(s),r=e.child(s);if(i==r){t+=i.nodeSize;continue}if(!i.sameMarkup(r))return t;if(i.isText&&i.text!=r.text){for(let o=0;i.text[o]==r.text[o];o++)t++;return t}if(i.content.size||r.content.size){let o=Yf(i.content,r.content,t+1);if(o!=null)return o}t+=i.nodeSize}}function Qf(n,e,t,s){for(let i=n.childCount,r=e.childCount;;){if(i==0||r==0)return i==r?null:{a:t,b:s};let o=n.child(--i),a=e.child(--r),l=o.nodeSize;if(o==a){t-=l,s-=l;continue}if(!o.sameMarkup(a))return{a:t,b:s};if(o.isText&&o.text!=a.text){let d=0,u=Math.min(o.text.length,a.text.length);for(;d<u&&o.text[o.text.length-d-1]==a.text[a.text.length-d-1];)d++,t--,s--;return{a:t,b:s}}if(o.content.size||a.content.size){let d=Qf(o.content,a.content,t-1,s-1);if(d)return d}t-=l,s-=l}}class P{constructor(e,t){if(this.content=e,this.size=t||0,t==null)for(let s=0;s<e.length;s++)this.size+=e[s].nodeSize}nodesBetween(e,t,s,i=0,r){for(let o=0,a=0;a<t;o++){let l=this.content[o],d=a+l.nodeSize;if(d>e&&s(l,i+a,r||null,o)!==!1&&l.content.size){let u=a+1;l.nodesBetween(Math.max(0,e-u),Math.min(l.content.size,t-u),s,i+u)}a=d}}descendants(e){this.nodesBetween(0,this.size,e)}textBetween(e,t,s,i){let r="",o=!0;return this.nodesBetween(e,t,(a,l)=>{let d=a.isText?a.text.slice(Math.max(e,l)-l,t-l):a.isLeaf?i?typeof i=="function"?i(a):i:a.type.spec.leafText?a.type.spec.leafText(a):"":"";a.isBlock&&(a.isLeaf&&d||a.isTextblock)&&s&&(o?o=!1:r+=s),r+=d},0),r}append(e){if(!e.size)return this;if(!this.size)return e;let t=this.lastChild,s=e.firstChild,i=this.content.slice(),r=0;for(t.isText&&t.sameMarkup(s)&&(i[i.length-1]=t.withText(t.text+s.text),r=1);r<e.content.length;r++)i.push(e.content[r]);return new P(i,this.size+e.size)}cut(e,t=this.size){if(e==0&&t==this.size)return this;let s=[],i=0;if(t>e)for(let r=0,o=0;o<t;r++){let a=this.content[r],l=o+a.nodeSize;l>e&&((o<e||l>t)&&(a.isText?a=a.cut(Math.max(0,e-o),Math.min(a.text.length,t-o)):a=a.cut(Math.max(0,e-o-1),Math.min(a.content.size,t-o-1))),s.push(a),i+=a.nodeSize),o=l}return new P(s,i)}cutByIndex(e,t){return e==t?P.empty:e==0&&t==this.content.length?this:new P(this.content.slice(e,t))}replaceChild(e,t){let s=this.content[e];if(s==t)return this;let i=this.content.slice(),r=this.size+t.nodeSize-s.nodeSize;return i[e]=t,new P(i,r)}addToStart(e){return new P([e].concat(this.content),this.size+e.nodeSize)}addToEnd(e){return new P(this.content.concat(e),this.size+e.nodeSize)}eq(e){if(this.content.length!=e.content.length)return!1;for(let t=0;t<this.content.length;t++)if(!this.content[t].eq(e.content[t]))return!1;return!0}get firstChild(){return this.content.length?this.content[0]:null}get lastChild(){return this.content.length?this.content[this.content.length-1]:null}get childCount(){return this.content.length}child(e){let t=this.content[e];if(!t)throw new RangeError("Index "+e+" out of range for "+this);return t}maybeChild(e){return this.content[e]||null}forEach(e){for(let t=0,s=0;t<this.content.length;t++){let i=this.content[t];e(i,s,t),s+=i.nodeSize}}findDiffStart(e,t=0){return Yf(this,e,t)}findDiffEnd(e,t=this.size,s=e.size){return Qf(this,e,t,s)}findIndex(e,t=-1){if(e==0)return Yr(0,e);if(e==this.size)return Yr(this.content.length,e);if(e>this.size||e<0)throw new RangeError(`Position ${e} outside of fragment (${this})`);for(let s=0,i=0;;s++){let r=this.child(s),o=i+r.nodeSize;if(o>=e)return o==e||t>0?Yr(s+1,o):Yr(s,i);i=o}}toString(){return"<"+this.toStringInner()+">"}toStringInner(){return this.content.join(", ")}toJSON(){return this.content.length?this.content.map(e=>e.toJSON()):null}static fromJSON(e,t){if(!t)return P.empty;if(!Array.isArray(t))throw new RangeError("Invalid input for Fragment.fromJSON");return new P(t.map(e.nodeFromJSON))}static fromArray(e){if(!e.length)return P.empty;let t,s=0;for(let i=0;i<e.length;i++){let r=e[i];s+=r.nodeSize,i&&r.isText&&e[i-1].sameMarkup(r)?(t||(t=e.slice(0,i)),t[t.length-1]=r.withText(t[t.length-1].text+r.text)):t&&t.push(r)}return new P(t||e,s)}static from(e){if(!e)return P.empty;if(e instanceof P)return e;if(Array.isArray(e))return this.fromArray(e);if(e.attrs)return new P([e],e.nodeSize);throw new RangeError("Can not convert "+e+" to a Fragment"+(e.nodesBetween?" (looks like multiple versions of prosemirror-model were loaded)":""))}}P.empty=new P([],0);const ka={index:0,offset:0};function Yr(n,e){return ka.index=n,ka.offset=e,ka}function No(n,e){if(n===e)return!0;if(!(n&&typeof n=="object")||!(e&&typeof e=="object"))return!1;let t=Array.isArray(n);if(Array.isArray(e)!=t)return!1;if(t){if(n.length!=e.length)return!1;for(let s=0;s<n.length;s++)if(!No(n[s],e[s]))return!1}else{for(let s in n)if(!(s in e)||!No(n[s],e[s]))return!1;for(let s in e)if(!(s in n))return!1}return!0}class be{constructor(e,t){this.type=e,this.attrs=t}addToSet(e){let t,s=!1;for(let i=0;i<e.length;i++){let r=e[i];if(this.eq(r))return e;if(this.type.excludes(r.type))t||(t=e.slice(0,i));else{if(r.type.excludes(this.type))return e;!s&&r.type.rank>this.type.rank&&(t||(t=e.slice(0,i)),t.push(this),s=!0),t&&t.push(r)}}return t||(t=e.slice()),s||t.push(this),t}removeFromSet(e){for(let t=0;t<e.length;t++)if(this.eq(e[t]))return e.slice(0,t).concat(e.slice(t+1));return e}isInSet(e){for(let t=0;t<e.length;t++)if(this.eq(e[t]))return!0;return!1}eq(e){return this==e||this.type==e.type&&No(this.attrs,e.attrs)}toJSON(){let e={type:this.type.name};for(let t in this.attrs){e.attrs=this.attrs;break}return e}static fromJSON(e,t){if(!t)throw new RangeError("Invalid input for Mark.fromJSON");let s=e.marks[t.type];if(!s)throw new RangeError(`There is no mark type ${t.type} in this schema`);let i=s.create(t.attrs);return s.checkAttrs(i.attrs),i}static sameSet(e,t){if(e==t)return!0;if(e.length!=t.length)return!1;for(let s=0;s<e.length;s++)if(!e[s].eq(t[s]))return!1;return!0}static setFrom(e){if(!e||Array.isArray(e)&&e.length==0)return be.none;if(e instanceof be)return[e];let t=e.slice();return t.sort((s,i)=>s.type.rank-i.type.rank),t}}be.none=[];class Eo extends Error{}class q{constructor(e,t,s){this.content=e,this.openStart=t,this.openEnd=s}get size(){return this.content.size-this.openStart-this.openEnd}insertAt(e,t){let s=Zf(this.content,e+this.openStart,t);return s&&new q(s,this.openStart,this.openEnd)}removeBetween(e,t){return new q(Xf(this.content,e+this.openStart,t+this.openStart),this.openStart,this.openEnd)}eq(e){return this.content.eq(e.content)&&this.openStart==e.openStart&&this.openEnd==e.openEnd}toString(){return this.content+"("+this.openStart+","+this.openEnd+")"}toJSON(){if(!this.content.size)return null;let e={content:this.content.toJSON()};return this.openStart>0&&(e.openStart=this.openStart),this.openEnd>0&&(e.openEnd=this.openEnd),e}static fromJSON(e,t){if(!t)return q.empty;let s=t.openStart||0,i=t.openEnd||0;if(typeof s!="number"||typeof i!="number")throw new RangeError("Invalid input for Slice.fromJSON");return new q(P.fromJSON(e,t.content),s,i)}static maxOpen(e,t=!0){let s=0,i=0;for(let r=e.firstChild;r&&!r.isLeaf&&(t||!r.type.spec.isolating);r=r.firstChild)s++;for(let r=e.lastChild;r&&!r.isLeaf&&(t||!r.type.spec.isolating);r=r.lastChild)i++;return new q(e,s,i)}}q.empty=new q(P.empty,0,0);function Xf(n,e,t){let{index:s,offset:i}=n.findIndex(e),r=n.maybeChild(s),{index:o,offset:a}=n.findIndex(t);if(i==e||r.isText){if(a!=t&&!n.child(o).isText)throw new RangeError("Removing non-flat range");return n.cut(0,e).append(n.cut(t))}if(s!=o)throw new RangeError("Removing non-flat range");return n.replaceChild(s,r.copy(Xf(r.content,e-i-1,t-i-1)))}function Zf(n,e,t,s){let{index:i,offset:r}=n.findIndex(e),o=n.maybeChild(i);if(r==e||o.isText)return n.cut(0,e).append(t).append(n.cut(e));let a=Zf(o.content,e-r-1,t);return a&&n.replaceChild(i,o.copy(a))}function uw(n,e,t){if(t.openStart>n.depth)throw new Eo("Inserted content deeper than insertion position");if(n.depth-t.openStart!=e.depth-t.openEnd)throw new Eo("Inconsistent open depths");return ep(n,e,t,0)}function ep(n,e,t,s){let i=n.index(s),r=n.node(s);if(i==e.index(s)&&s<n.depth-t.openStart){let o=ep(n,e,t,s+1);return r.copy(r.content.replaceChild(i,o))}else if(t.content.size)if(!t.openStart&&!t.openEnd&&n.depth==s&&e.depth==s){let o=n.parent,a=o.content;return qs(o,a.cut(0,n.parentOffset).append(t.content).append(a.cut(e.parentOffset)))}else{let{start:o,end:a}=hw(t,n);return qs(r,np(n,o,a,e,s))}else return qs(r,Io(n,e,s))}function tp(n,e){if(!e.type.compatibleContent(n.type))throw new Eo("Cannot join "+e.type.name+" onto "+n.type.name)}function nl(n,e,t){let s=n.node(t);return tp(s,e.node(t)),s}function Gs(n,e){let t=e.length-1;t>=0&&n.isText&&n.sameMarkup(e[t])?e[t]=n.withText(e[t].text+n.text):e.push(n)}function rr(n,e,t,s){let i=(e||n).node(t),r=0,o=e?e.index(t):i.childCount;n&&(r=n.index(t),n.depth>t?r++:n.textOffset&&(Gs(n.nodeAfter,s),r++));for(let a=r;a<o;a++)Gs(i.child(a),s);e&&e.depth==t&&e.textOffset&&Gs(e.nodeBefore,s)}function qs(n,e){return n.type.checkContent(e),n.copy(e)}function np(n,e,t,s,i){let r=n.depth>i&&nl(n,e,i+1),o=s.depth>i&&nl(t,s,i+1),a=[];return rr(null,n,i,a),r&&o&&e.index(i)==t.index(i)?(tp(r,o),Gs(qs(r,np(n,e,t,s,i+1)),a)):(r&&Gs(qs(r,Io(n,e,i+1)),a),rr(e,t,i,a),o&&Gs(qs(o,Io(t,s,i+1)),a)),rr(s,null,i,a),new P(a)}function Io(n,e,t){let s=[];if(rr(null,n,t,s),n.depth>t){let i=nl(n,e,t+1);Gs(qs(i,Io(n,e,t+1)),s)}return rr(e,null,t,s),new P(s)}function hw(n,e){let t=e.depth-n.openStart,i=e.node(t).copy(n.content);for(let r=t-1;r>=0;r--)i=e.node(r).copy(P.from(i));return{start:i.resolveNoCache(n.openStart+t),end:i.resolveNoCache(i.content.size-n.openEnd-t)}}class yr{constructor(e,t,s){this.pos=e,this.path=t,this.parentOffset=s,this.depth=t.length/3-1}resolveDepth(e){return e==null?this.depth:e<0?this.depth+e:e}get parent(){return this.node(this.depth)}get doc(){return this.node(0)}node(e){return this.path[this.resolveDepth(e)*3]}index(e){return this.path[this.resolveDepth(e)*3+1]}indexAfter(e){return e=this.resolveDepth(e),this.index(e)+(e==this.depth&&!this.textOffset?0:1)}start(e){return e=this.resolveDepth(e),e==0?0:this.path[e*3-1]+1}end(e){return e=this.resolveDepth(e),this.start(e)+this.node(e).content.size}before(e){if(e=this.resolveDepth(e),!e)throw new RangeError("There is no position before the top-level node");return e==this.depth+1?this.pos:this.path[e*3-1]}after(e){if(e=this.resolveDepth(e),!e)throw new RangeError("There is no position after the top-level node");return e==this.depth+1?this.pos:this.path[e*3-1]+this.path[e*3].nodeSize}get textOffset(){return this.pos-this.path[this.path.length-1]}get nodeAfter(){let e=this.parent,t=this.index(this.depth);if(t==e.childCount)return null;let s=this.pos-this.path[this.path.length-1],i=e.child(t);return s?e.child(t).cut(s):i}get nodeBefore(){let e=this.index(this.depth),t=this.pos-this.path[this.path.length-1];return t?this.parent.child(e).cut(0,t):e==0?null:this.parent.child(e-1)}posAtIndex(e,t){t=this.resolveDepth(t);let s=this.path[t*3],i=t==0?0:this.path[t*3-1]+1;for(let r=0;r<e;r++)i+=s.child(r).nodeSize;return i}marks(){let e=this.parent,t=this.index();if(e.content.size==0)return be.none;if(this.textOffset)return e.child(t).marks;let s=e.maybeChild(t-1),i=e.maybeChild(t);if(!s){let a=s;s=i,i=a}let r=s.marks;for(var o=0;o<r.length;o++)r[o].type.spec.inclusive===!1&&(!i||!r[o].isInSet(i.marks))&&(r=r[o--].removeFromSet(r));return r}marksAcross(e){let t=this.parent.maybeChild(this.index());if(!t||!t.isInline)return null;let s=t.marks,i=e.parent.maybeChild(e.index());for(var r=0;r<s.length;r++)s[r].type.spec.inclusive===!1&&(!i||!s[r].isInSet(i.marks))&&(s=s[r--].removeFromSet(s));return s}sharedDepth(e){for(let t=this.depth;t>0;t--)if(this.start(t)<=e&&this.end(t)>=e)return t;return 0}blockRange(e=this,t){if(e.pos<this.pos)return e.blockRange(this);for(let s=this.depth-(this.parent.inlineContent||this.pos==e.pos?1:0);s>=0;s--)if(e.pos<=this.end(s)&&(!t||t(this.node(s))))return new mw(this,e,s);return null}sameParent(e){return this.pos-this.parentOffset==e.pos-e.parentOffset}max(e){return e.pos>this.pos?e:this}min(e){return e.pos<this.pos?e:this}toString(){let e="";for(let t=1;t<=this.depth;t++)e+=(e?"/":"")+this.node(t).type.name+"_"+this.index(t-1);return e+":"+this.parentOffset}static resolve(e,t){if(!(t>=0&&t<=e.content.size))throw new RangeError("Position "+t+" out of range");let s=[],i=0,r=t;for(let o=e;;){let{index:a,offset:l}=o.content.findIndex(r),d=r-l;if(s.push(o,a,i+l),!d||(o=o.child(a),o.isText))break;r=d-1,i+=l+1}return new yr(t,s,r)}static resolveCached(e,t){let s=Td.get(e);if(s)for(let r=0;r<s.elts.length;r++){let o=s.elts[r];if(o.pos==t)return o}else Td.set(e,s=new fw);let i=s.elts[s.i]=yr.resolve(e,t);return s.i=(s.i+1)%pw,i}}class fw{constructor(){this.elts=[],this.i=0}}const pw=12,Td=new WeakMap;class mw{constructor(e,t,s){this.$from=e,this.$to=t,this.depth=s}get start(){return this.$from.before(this.depth+1)}get end(){return this.$to.after(this.depth+1)}get parent(){return this.$from.node(this.depth)}get startIndex(){return this.$from.index(this.depth)}get endIndex(){return this.$to.indexAfter(this.depth)}}const gw=Object.create(null);class vn{constructor(e,t,s,i=be.none){this.type=e,this.attrs=t,this.marks=i,this.content=s||P.empty}get nodeSize(){return this.isLeaf?1:2+this.content.size}get childCount(){return this.content.childCount}child(e){return this.content.child(e)}maybeChild(e){return this.content.maybeChild(e)}forEach(e){this.content.forEach(e)}nodesBetween(e,t,s,i=0){this.content.nodesBetween(e,t,s,i,this)}descendants(e){this.nodesBetween(0,this.content.size,e)}get textContent(){return this.isLeaf&&this.type.spec.leafText?this.type.spec.leafText(this):this.textBetween(0,this.content.size,"")}textBetween(e,t,s,i){return this.content.textBetween(e,t,s,i)}get firstChild(){return this.content.firstChild}get lastChild(){return this.content.lastChild}eq(e){return this==e||this.sameMarkup(e)&&this.content.eq(e.content)}sameMarkup(e){return this.hasMarkup(e.type,e.attrs,e.marks)}hasMarkup(e,t,s){return this.type==e&&No(this.attrs,t||e.defaultAttrs||gw)&&be.sameSet(this.marks,s||be.none)}copy(e=null){return e==this.content?this:new vn(this.type,this.attrs,e,this.marks)}mark(e){return e==this.marks?this:new vn(this.type,this.attrs,this.content,e)}cut(e,t=this.content.size){return e==0&&t==this.content.size?this:this.copy(this.content.cut(e,t))}slice(e,t=this.content.size,s=!1){if(e==t)return q.empty;let i=this.resolve(e),r=this.resolve(t),o=s?0:i.sharedDepth(t),a=i.start(o),d=i.node(o).content.cut(i.pos-a,r.pos-a);return new q(d,i.depth-o,r.depth-o)}replace(e,t,s){return uw(this.resolve(e),this.resolve(t),s)}nodeAt(e){for(let t=this;;){let{index:s,offset:i}=t.content.findIndex(e);if(t=t.maybeChild(s),!t)return null;if(i==e||t.isText)return t;e-=i+1}}childAfter(e){let{index:t,offset:s}=this.content.findIndex(e);return{node:this.content.maybeChild(t),index:t,offset:s}}childBefore(e){if(e==0)return{node:null,index:0,offset:0};let{index:t,offset:s}=this.content.findIndex(e);if(s<e)return{node:this.content.child(t),index:t,offset:s};let i=this.content.child(t-1);return{node:i,index:t-1,offset:s-i.nodeSize}}resolve(e){return yr.resolveCached(this,e)}resolveNoCache(e){return yr.resolve(this,e)}rangeHasMark(e,t,s){let i=!1;return t>e&&this.nodesBetween(e,t,r=>(s.isInSet(r.marks)&&(i=!0),!i)),i}get isBlock(){return this.type.isBlock}get isTextblock(){return this.type.isTextblock}get inlineContent(){return this.type.inlineContent}get isInline(){return this.type.isInline}get isText(){return this.type.isText}get isLeaf(){return this.type.isLeaf}get isAtom(){return this.type.isAtom}toString(){if(this.type.spec.toDebugString)return this.type.spec.toDebugString(this);let e=this.type.name;return this.content.size&&(e+="("+this.content.toStringInner()+")"),sp(this.marks,e)}contentMatchAt(e){let t=this.type.contentMatch.matchFragment(this.content,0,e);if(!t)throw new Error("Called contentMatchAt on a node with invalid content");return t}canReplace(e,t,s=P.empty,i=0,r=s.childCount){let o=this.contentMatchAt(e).matchFragment(s,i,r),a=o&&o.matchFragment(this.content,t);if(!a||!a.validEnd)return!1;for(let l=i;l<r;l++)if(!this.type.allowsMarks(s.child(l).marks))return!1;return!0}canReplaceWith(e,t,s,i){if(i&&!this.type.allowsMarks(i))return!1;let r=this.contentMatchAt(e).matchType(s),o=r&&r.matchFragment(this.content,t);return o?o.validEnd:!1}canAppend(e){return e.content.size?this.canReplace(this.childCount,this.childCount,e.content):this.type.compatibleContent(e.type)}check(){this.type.checkContent(this.content),this.type.checkAttrs(this.attrs);let e=be.none;for(let t=0;t<this.marks.length;t++){let s=this.marks[t];s.type.checkAttrs(s.attrs),e=s.addToSet(e)}if(!be.sameSet(e,this.marks))throw new RangeError(`Invalid collection of marks for node ${this.type.name}: ${this.marks.map(t=>t.type.name)}`);this.content.forEach(t=>t.check())}toJSON(){let e={type:this.type.name};for(let t in this.attrs){e.attrs=this.attrs;break}return this.content.size&&(e.content=this.content.toJSON()),this.marks.length&&(e.marks=this.marks.map(t=>t.toJSON())),e}static fromJSON(e,t){if(!t)throw new RangeError("Invalid input for Node.fromJSON");let s;if(t.marks){if(!Array.isArray(t.marks))throw new RangeError("Invalid mark data for Node.fromJSON");s=t.marks.map(e.markFromJSON)}if(t.type=="text"){if(typeof t.text!="string")throw new RangeError("Invalid text node in JSON");return e.text(t.text,s)}let i=P.fromJSON(e,t.content),r=e.nodeType(t.type).create(t.attrs,i,s);return r.type.checkAttrs(r.attrs),r}}vn.prototype.text=void 0;class Ao extends vn{constructor(e,t,s,i){if(super(e,t,null,i),!s)throw new RangeError("Empty text nodes are not allowed");this.text=s}toString(){return this.type.spec.toDebugString?this.type.spec.toDebugString(this):sp(this.marks,JSON.stringify(this.text))}get textContent(){return this.text}textBetween(e,t){return this.text.slice(e,t)}get nodeSize(){return this.text.length}mark(e){return e==this.marks?this:new Ao(this.type,this.attrs,this.text,e)}withText(e){return e==this.text?this:new Ao(this.type,this.attrs,e,this.marks)}cut(e=0,t=this.text.length){return e==0&&t==this.text.length?this:this.withText(this.text.slice(e,t))}eq(e){return this.sameMarkup(e)&&this.text==e.text}toJSON(){let e=super.toJSON();return e.text=this.text,e}}function sp(n,e){for(let t=n.length-1;t>=0;t--)e=n[t].type.name+"("+e+")";return e}class Qs{constructor(e){this.validEnd=e,this.next=[],this.wrapCache=[]}static parse(e,t){let s=new yw(e,t);if(s.next==null)return Qs.empty;let i=ip(s);s.next&&s.err("Unexpected trailing text");let r=vw(Cw(i));return Mw(r,s),r}matchType(e){for(let t=0;t<this.next.length;t++)if(this.next[t].type==e)return this.next[t].next;return null}matchFragment(e,t=0,s=e.childCount){let i=this;for(let r=t;i&&r<s;r++)i=i.matchType(e.child(r).type);return i}get inlineContent(){return this.next.length!=0&&this.next[0].type.isInline}get defaultType(){for(let e=0;e<this.next.length;e++){let{type:t}=this.next[e];if(!(t.isText||t.hasRequiredAttrs()))return t}return null}compatible(e){for(let t=0;t<this.next.length;t++)for(let s=0;s<e.next.length;s++)if(this.next[t].type==e.next[s].type)return!0;return!1}fillBefore(e,t=!1,s=0){let i=[this];function r(o,a){let l=o.matchFragment(e,s);if(l&&(!t||l.validEnd))return P.from(a.map(d=>d.createAndFill()));for(let d=0;d<o.next.length;d++){let{type:u,next:h}=o.next[d];if(!(u.isText||u.hasRequiredAttrs())&&i.indexOf(h)==-1){i.push(h);let f=r(h,a.concat(u));if(f)return f}}return null}return r(this,[])}findWrapping(e){for(let s=0;s<this.wrapCache.length;s+=2)if(this.wrapCache[s]==e)return this.wrapCache[s+1];let t=this.computeWrapping(e);return this.wrapCache.push(e,t),t}computeWrapping(e){let t=Object.create(null),s=[{match:this,type:null,via:null}];for(;s.length;){let i=s.shift(),r=i.match;if(r.matchType(e)){let o=[];for(let a=i;a.type;a=a.via)o.push(a.type);return o.reverse()}for(let o=0;o<r.next.length;o++){let{type:a,next:l}=r.next[o];!a.isLeaf&&!a.hasRequiredAttrs()&&!(a.name in t)&&(!i.type||l.validEnd)&&(s.push({match:a.contentMatch,type:a,via:i}),t[a.name]=!0)}}return null}get edgeCount(){return this.next.length}edge(e){if(e>=this.next.length)throw new RangeError(`There's no ${e}th edge in this content match`);return this.next[e]}toString(){let e=[];function t(s){e.push(s);for(let i=0;i<s.next.length;i++)e.indexOf(s.next[i].next)==-1&&t(s.next[i].next)}return t(this),e.map((s,i)=>{let r=i+(s.validEnd?"*":" ")+" ";for(let o=0;o<s.next.length;o++)r+=(o?", ":"")+s.next[o].type.name+"->"+e.indexOf(s.next[o].next);return r}).join(`
`)}}Qs.empty=new Qs(!0);class yw{constructor(e,t){this.string=e,this.nodeTypes=t,this.inline=null,this.pos=0,this.tokens=e.split(/\s*(?=\b|\W|$)/),this.tokens[this.tokens.length-1]==""&&this.tokens.pop(),this.tokens[0]==""&&this.tokens.shift()}get next(){return this.tokens[this.pos]}eat(e){return this.next==e&&(this.pos++||!0)}err(e){throw new SyntaxError(e+" (in content expression '"+this.string+"')")}}function ip(n){let e=[];do e.push(xw(n));while(n.eat("|"));return e.length==1?e[0]:{type:"choice",exprs:e}}function xw(n){let e=[];do e.push(bw(n));while(n.next&&n.next!=")"&&n.next!="|");return e.length==1?e[0]:{type:"seq",exprs:e}}function bw(n){let e=ww(n);for(;;)if(n.eat("+"))e={type:"plus",expr:e};else if(n.eat("*"))e={type:"star",expr:e};else if(n.eat("?"))e={type:"opt",expr:e};else if(n.eat("{"))e=Sw(n,e);else break;return e}function _d(n){/\D/.test(n.next)&&n.err("Expected number, got '"+n.next+"'");let e=Number(n.next);return n.pos++,e}function Sw(n,e){let t=_d(n),s=t;return n.eat(",")&&(n.next!="}"?s=_d(n):s=-1),n.eat("}")||n.err("Unclosed braced range"),{type:"range",min:t,max:s,expr:e}}function kw(n,e){let t=n.nodeTypes,s=t[e];if(s)return[s];let i=[];for(let r in t){let o=t[r];o.groups.indexOf(e)>-1&&i.push(o)}return i.length==0&&n.err("No node type or group '"+e+"' found"),i}function ww(n){if(n.eat("(")){let e=ip(n);return n.eat(")")||n.err("Missing closing paren"),e}else if(/\W/.test(n.next))n.err("Unexpected token '"+n.next+"'");else{let e=kw(n,n.next).map(t=>(n.inline==null?n.inline=t.isInline:n.inline!=t.isInline&&n.err("Mixing inline and block content"),{type:"name",value:t}));return n.pos++,e.length==1?e[0]:{type:"choice",exprs:e}}}function Cw(n){let e=[[]];return i(r(n,0),t()),e;function t(){return e.push([])-1}function s(o,a,l){let d={term:l,to:a};return e[o].push(d),d}function i(o,a){o.forEach(l=>l.to=a)}function r(o,a){if(o.type=="choice")return o.exprs.reduce((l,d)=>l.concat(r(d,a)),[]);if(o.type=="seq")for(let l=0;;l++){let d=r(o.exprs[l],a);if(l==o.exprs.length-1)return d;i(d,a=t())}else if(o.type=="star"){let l=t();return s(a,l),i(r(o.expr,l),l),[s(l)]}else if(o.type=="plus"){let l=t();return i(r(o.expr,a),l),i(r(o.expr,l),l),[s(l)]}else{if(o.type=="opt")return[s(a)].concat(r(o.expr,a));if(o.type=="range"){let l=a;for(let d=0;d<o.min;d++){let u=t();i(r(o.expr,l),u),l=u}if(o.max==-1)i(r(o.expr,l),l);else for(let d=o.min;d<o.max;d++){let u=t();s(l,u),i(r(o.expr,l),u),l=u}return[s(l)]}else{if(o.type=="name")return[s(a,void 0,o.value)];throw new Error("Unknown expr type")}}}}function rp(n,e){return e-n}function Nd(n,e){let t=[];return s(e),t.sort(rp);function s(i){let r=n[i];if(r.length==1&&!r[0].term)return s(r[0].to);t.push(i);for(let o=0;o<r.length;o++){let{term:a,to:l}=r[o];!a&&t.indexOf(l)==-1&&s(l)}}}function vw(n){let e=Object.create(null);return t(Nd(n,0));function t(s){let i=[];s.forEach(o=>{n[o].forEach(({term:a,to:l})=>{if(!a)return;let d;for(let u=0;u<i.length;u++)i[u][0]==a&&(d=i[u][1]);Nd(n,l).forEach(u=>{d||i.push([a,d=[]]),d.indexOf(u)==-1&&d.push(u)})})});let r=e[s.join(",")]=new Qs(s.indexOf(n.length-1)>-1);for(let o=0;o<i.length;o++){let a=i[o][1].sort(rp);r.next.push({type:i[o][0],next:e[a.join(",")]||t(a)})}return r}}function Mw(n,e){for(let t=0,s=[n];t<s.length;t++){let i=s[t],r=!i.validEnd,o=[];for(let a=0;a<i.next.length;a++){let{type:l,next:d}=i.next[a];o.push(l.name),r&&!(l.isText||l.hasRequiredAttrs())&&(r=!1),s.indexOf(d)==-1&&s.push(d)}r&&e.err("Only non-generatable nodes ("+o.join(", ")+") in a required position (see https://prosemirror.net/docs/guide/#generatable)")}}function op(n){let e=Object.create(null);for(let t in n){let s=n[t];if(!s.hasDefault)return null;e[t]=s.default}return e}function ap(n,e){let t=Object.create(null);for(let s in n){let i=e&&e[s];if(i===void 0){let r=n[s];if(r.hasDefault)i=r.default;else throw new RangeError("No value supplied for attribute "+s)}t[s]=i}return t}function lp(n,e,t,s){for(let i in e)if(!(i in n))throw new RangeError(`Unsupported attribute ${i} for ${t} of type ${i}`);for(let i in n){let r=n[i];r.validate&&r.validate(e[i])}}function cp(n,e){let t=Object.create(null);if(e)for(let s in e)t[s]=new _w(n,s,e[s]);return t}let Ed=class dp{constructor(e,t,s){this.name=e,this.schema=t,this.spec=s,this.markSet=null,this.groups=s.group?s.group.split(" "):[],this.attrs=cp(e,s.attrs),this.defaultAttrs=op(this.attrs),this.contentMatch=null,this.inlineContent=null,this.isBlock=!(s.inline||e=="text"),this.isText=e=="text"}get isInline(){return!this.isBlock}get isTextblock(){return this.isBlock&&this.inlineContent}get isLeaf(){return this.contentMatch==Qs.empty}get isAtom(){return this.isLeaf||!!this.spec.atom}get whitespace(){return this.spec.whitespace||(this.spec.code?"pre":"normal")}hasRequiredAttrs(){for(let e in this.attrs)if(this.attrs[e].isRequired)return!0;return!1}compatibleContent(e){return this==e||this.contentMatch.compatible(e.contentMatch)}computeAttrs(e){return!e&&this.defaultAttrs?this.defaultAttrs:ap(this.attrs,e)}create(e=null,t,s){if(this.isText)throw new Error("NodeType.create can't construct text nodes");return new vn(this,this.computeAttrs(e),P.from(t),be.setFrom(s))}createChecked(e=null,t,s){return t=P.from(t),this.checkContent(t),new vn(this,this.computeAttrs(e),t,be.setFrom(s))}createAndFill(e=null,t,s){if(e=this.computeAttrs(e),t=P.from(t),t.size){let o=this.contentMatch.fillBefore(t);if(!o)return null;t=o.append(t)}let i=this.contentMatch.matchFragment(t),r=i&&i.fillBefore(P.empty,!0);return r?new vn(this,e,t.append(r),be.setFrom(s)):null}validContent(e){let t=this.contentMatch.matchFragment(e);if(!t||!t.validEnd)return!1;for(let s=0;s<e.childCount;s++)if(!this.allowsMarks(e.child(s).marks))return!1;return!0}checkContent(e){if(!this.validContent(e))throw new RangeError(`Invalid content for node ${this.name}: ${e.toString().slice(0,50)}`)}checkAttrs(e){lp(this.attrs,e,"node",this.name)}allowsMarkType(e){return this.markSet==null||this.markSet.indexOf(e)>-1}allowsMarks(e){if(this.markSet==null)return!0;for(let t=0;t<e.length;t++)if(!this.allowsMarkType(e[t].type))return!1;return!0}allowedMarks(e){if(this.markSet==null)return e;let t;for(let s=0;s<e.length;s++)this.allowsMarkType(e[s].type)?t&&t.push(e[s]):t||(t=e.slice(0,s));return t?t.length?t:be.none:e}static compile(e,t){let s=Object.create(null);e.forEach((r,o)=>s[r]=new dp(r,t,o));let i=t.spec.topNode||"doc";if(!s[i])throw new RangeError("Schema is missing its top node type ('"+i+"')");if(!s.text)throw new RangeError("Every schema needs a 'text' type");for(let r in s.text.attrs)throw new RangeError("The text node type should not have attributes");return s}};function Tw(n,e,t){let s=t.split("|");return i=>{let r=i===null?"null":typeof i;if(s.indexOf(r)<0)throw new RangeError(`Expected value of type ${s} for attribute ${e} on type ${n}, got ${r}`)}}class _w{constructor(e,t,s){this.hasDefault=Object.prototype.hasOwnProperty.call(s,"default"),this.default=s.default,this.validate=typeof s.validate=="string"?Tw(e,t,s.validate):s.validate}get isRequired(){return!this.hasDefault}}class sa{constructor(e,t,s,i){this.name=e,this.rank=t,this.schema=s,this.spec=i,this.attrs=cp(e,i.attrs),this.excluded=null;let r=op(this.attrs);this.instance=r?new be(this,r):null}create(e=null){return!e&&this.instance?this.instance:new be(this,ap(this.attrs,e))}static compile(e,t){let s=Object.create(null),i=0;return e.forEach((r,o)=>s[r]=new sa(r,i++,t,o)),s}removeFromSet(e){for(var t=0;t<e.length;t++)e[t].type==this&&(e=e.slice(0,t).concat(e.slice(t+1)),t--);return e}isInSet(e){for(let t=0;t<e.length;t++)if(e[t].type==this)return e[t]}checkAttrs(e){lp(this.attrs,e,"mark",this.name)}excludes(e){return this.excluded.indexOf(e)>-1}}class Nw{constructor(e){this.linebreakReplacement=null,this.cached=Object.create(null);let t=this.spec={};for(let i in e)t[i]=e[i];t.nodes=Jc.from(e.nodes),t.marks=Jc.from(e.marks||{}),this.nodes=Ed.compile(this.spec.nodes,this),this.marks=sa.compile(this.spec.marks,this);let s=Object.create(null);for(let i in this.nodes){if(i in this.marks)throw new RangeError(i+" can not be both a node and a mark");let r=this.nodes[i],o=r.spec.content||"",a=r.spec.marks;if(r.contentMatch=s[o]||(s[o]=Qs.parse(o,this.nodes)),r.inlineContent=r.contentMatch.inlineContent,r.spec.linebreakReplacement){if(this.linebreakReplacement)throw new RangeError("Multiple linebreak nodes defined");if(!r.isInline||!r.isLeaf)throw new RangeError("Linebreak replacement nodes must be inline leaf nodes");this.linebreakReplacement=r}r.markSet=a=="_"?null:a?Id(this,a.split(" ")):a==""||!r.inlineContent?[]:null}for(let i in this.marks){let r=this.marks[i],o=r.spec.excludes;r.excluded=o==null?[r]:o==""?[]:Id(this,o.split(" "))}this.nodeFromJSON=this.nodeFromJSON.bind(this),this.markFromJSON=this.markFromJSON.bind(this),this.topNodeType=this.nodes[this.spec.topNode||"doc"],this.cached.wrappings=Object.create(null)}node(e,t=null,s,i){if(typeof e=="string")e=this.nodeType(e);else if(e instanceof Ed){if(e.schema!=this)throw new RangeError("Node type from different schema used ("+e.name+")")}else throw new RangeError("Invalid node type: "+e);return e.createChecked(t,s,i)}text(e,t){let s=this.nodes.text;return new Ao(s,s.defaultAttrs,e,be.setFrom(t))}mark(e,t){return typeof e=="string"&&(e=this.marks[e]),e.create(t)}nodeFromJSON(e){return vn.fromJSON(this,e)}markFromJSON(e){return be.fromJSON(this,e)}nodeType(e){let t=this.nodes[e];if(!t)throw new RangeError("Unknown node type: "+e);return t}}function Id(n,e){let t=[];for(let s=0;s<e.length;s++){let i=e[s],r=n.marks[i],o=r;if(r)t.push(r);else for(let a in n.marks){let l=n.marks[a];(i=="_"||l.spec.group&&l.spec.group.split(" ").indexOf(i)>-1)&&t.push(o=l)}if(!o)throw new SyntaxError("Unknown mark type: '"+e[s]+"'")}return t}function Ew(n){return n.tag!=null}function Iw(n){return n.style!=null}class xr{constructor(e,t){this.schema=e,this.rules=t,this.tags=[],this.styles=[];let s=this.matchedStyles=[];t.forEach(i=>{if(Ew(i))this.tags.push(i);else if(Iw(i)){let r=/[^=]*/.exec(i.style)[0];s.indexOf(r)<0&&s.push(r),this.styles.push(i)}}),this.normalizeLists=!this.tags.some(i=>{if(!/^(ul|ol)\b/.test(i.tag)||!i.node)return!1;let r=e.nodes[i.node];return r.contentMatch.matchType(r)})}parse(e,t={}){let s=new jd(this,t,!1);return s.addAll(e,t.from,t.to),s.finish()}parseSlice(e,t={}){let s=new jd(this,t,!0);return s.addAll(e,t.from,t.to),q.maxOpen(s.finish())}matchTag(e,t,s){for(let i=s?this.tags.indexOf(s)+1:0;i<this.tags.length;i++){let r=this.tags[i];if(Rw(e,r.tag)&&(r.namespace===void 0||e.namespaceURI==r.namespace)&&(!r.context||t.matchesContext(r.context))){if(r.getAttrs){let o=r.getAttrs(e);if(o===!1)continue;r.attrs=o||void 0}return r}}}matchStyle(e,t,s,i){for(let r=i?this.styles.indexOf(i)+1:0;r<this.styles.length;r++){let o=this.styles[r],a=o.style;if(!(a.indexOf(e)!=0||o.context&&!s.matchesContext(o.context)||a.length>e.length&&(a.charCodeAt(e.length)!=61||a.slice(e.length+1)!=t))){if(o.getAttrs){let l=o.getAttrs(t);if(l===!1)continue;o.attrs=l||void 0}return o}}}static schemaRules(e){let t=[];function s(i){let r=i.priority==null?50:i.priority,o=0;for(;o<t.length;o++){let a=t[o];if((a.priority==null?50:a.priority)<r)break}t.splice(o,0,i)}for(let i in e.marks){let r=e.marks[i].spec.parseDOM;r&&r.forEach(o=>{s(o=Rd(o)),o.mark||o.ignore||o.clearMark||(o.mark=i)})}for(let i in e.nodes){let r=e.nodes[i].spec.parseDOM;r&&r.forEach(o=>{s(o=Rd(o)),o.node||o.ignore||o.mark||(o.node=i)})}return t}static fromSchema(e){return e.cached.domParser||(e.cached.domParser=new xr(e,xr.schemaRules(e)))}}const up={address:!0,article:!0,aside:!0,blockquote:!0,canvas:!0,dd:!0,div:!0,dl:!0,fieldset:!0,figcaption:!0,figure:!0,footer:!0,form:!0,h1:!0,h2:!0,h3:!0,h4:!0,h5:!0,h6:!0,header:!0,hgroup:!0,hr:!0,li:!0,noscript:!0,ol:!0,output:!0,p:!0,pre:!0,section:!0,table:!0,tfoot:!0,ul:!0},Aw={head:!0,noscript:!0,object:!0,script:!0,style:!0,title:!0},hp={ol:!0,ul:!0},jo=1,Ro=2,or=4;function Ad(n,e,t){return e!=null?(e?jo:0)|(e==="full"?Ro:0):n&&n.whitespace=="pre"?jo|Ro:t&~or}class Qr{constructor(e,t,s,i,r,o,a){this.type=e,this.attrs=t,this.marks=s,this.pendingMarks=i,this.solid=r,this.options=a,this.content=[],this.activeMarks=be.none,this.stashMarks=[],this.match=o||(a&or?null:e.contentMatch)}findWrapping(e){if(!this.match){if(!this.type)return[];let t=this.type.contentMatch.fillBefore(P.from(e));if(t)this.match=this.type.contentMatch.matchFragment(t);else{let s=this.type.contentMatch,i;return(i=s.findWrapping(e.type))?(this.match=s,i):null}}return this.match.findWrapping(e.type)}finish(e){if(!(this.options&jo)){let s=this.content[this.content.length-1],i;if(s&&s.isText&&(i=/[ \t\r\n\u000c]+$/.exec(s.text))){let r=s;s.text.length==i[0].length?this.content.pop():this.content[this.content.length-1]=r.withText(r.text.slice(0,r.text.length-i[0].length))}}let t=P.from(this.content);return!e&&this.match&&(t=t.append(this.match.fillBefore(P.empty,!0))),this.type?this.type.create(this.attrs,t,this.marks):t}popFromStashMark(e){for(let t=this.stashMarks.length-1;t>=0;t--)if(e.eq(this.stashMarks[t]))return this.stashMarks.splice(t,1)[0]}applyPending(e){for(let t=0,s=this.pendingMarks;t<s.length;t++){let i=s[t];(this.type?this.type.allowsMarkType(i.type):Dw(i.type,e))&&!i.isInSet(this.activeMarks)&&(this.activeMarks=i.addToSet(this.activeMarks),this.pendingMarks=i.removeFromSet(this.pendingMarks))}}inlineContext(e){return this.type?this.type.inlineContent:this.content.length?this.content[0].isInline:e.parentNode&&!up.hasOwnProperty(e.parentNode.nodeName.toLowerCase())}}class jd{constructor(e,t,s){this.parser=e,this.options=t,this.isOpen=s,this.open=0;let i=t.topNode,r,o=Ad(null,t.preserveWhitespace,0)|(s?or:0);i?r=new Qr(i.type,i.attrs,be.none,be.none,!0,t.topMatch||i.type.contentMatch,o):s?r=new Qr(null,null,be.none,be.none,!0,null,o):r=new Qr(e.schema.topNodeType,null,be.none,be.none,!0,null,o),this.nodes=[r],this.find=t.findPositions,this.needsBlock=!1}get top(){return this.nodes[this.open]}addDOM(e){e.nodeType==3?this.addTextNode(e):e.nodeType==1&&this.addElement(e)}withStyleRules(e,t){let s=e.style;if(!s||!s.length)return t();let i=this.readStyles(e.style);if(!i)return;let[r,o]=i,a=this.top;for(let l=0;l<o.length;l++)this.removePendingMark(o[l],a);for(let l=0;l<r.length;l++)this.addPendingMark(r[l]);t();for(let l=0;l<r.length;l++)this.removePendingMark(r[l],a);for(let l=0;l<o.length;l++)this.addPendingMark(o[l])}addTextNode(e){let t=e.nodeValue,s=this.top;if(s.options&Ro||s.inlineContext(e)||/[^ \t\r\n\u000c]/.test(t)){if(s.options&jo)s.options&Ro?t=t.replace(/\r\n?/g,`
`):t=t.replace(/\r?\n|\r/g," ");else if(t=t.replace(/[ \t\r\n\u000c]+/g," "),/^[ \t\r\n\u000c]/.test(t)&&this.open==this.nodes.length-1){let i=s.content[s.content.length-1],r=e.previousSibling;(!i||r&&r.nodeName=="BR"||i.isText&&/[ \t\r\n\u000c]$/.test(i.text))&&(t=t.slice(1))}t&&this.insertNode(this.parser.schema.text(t)),this.findInText(e)}else this.findInside(e)}addElement(e,t){let s=e.nodeName.toLowerCase(),i;hp.hasOwnProperty(s)&&this.parser.normalizeLists&&jw(e);let r=this.options.ruleFromNode&&this.options.ruleFromNode(e)||(i=this.parser.matchTag(e,this,t));if(r?r.ignore:Aw.hasOwnProperty(s))this.findInside(e),this.ignoreFallback(e);else if(!r||r.skip||r.closeParent){r&&r.closeParent?this.open=Math.max(0,this.open-1):r&&r.skip.nodeType&&(e=r.skip);let o,a=this.top,l=this.needsBlock;if(up.hasOwnProperty(s))a.content.length&&a.content[0].isInline&&this.open&&(this.open--,a=this.top),o=!0,a.type||(this.needsBlock=!0);else if(!e.firstChild){this.leafFallback(e);return}r&&r.skip?this.addAll(e):this.withStyleRules(e,()=>this.addAll(e)),o&&this.sync(a),this.needsBlock=l}else this.withStyleRules(e,()=>{this.addElementByRule(e,r,r.consuming===!1?i:void 0)})}leafFallback(e){e.nodeName=="BR"&&this.top.type&&this.top.type.inlineContent&&this.addTextNode(e.ownerDocument.createTextNode(`
`))}ignoreFallback(e){e.nodeName=="BR"&&(!this.top.type||!this.top.type.inlineContent)&&this.findPlace(this.parser.schema.text("-"))}readStyles(e){let t=be.none,s=be.none;if(e.length)for(let i=0;i<this.parser.matchedStyles.length;i++){let r=this.parser.matchedStyles[i],o=e.getPropertyValue(r);if(o)for(let a=void 0;;){let l=this.parser.matchStyle(r,o,this,a);if(!l)break;if(l.ignore)return null;if(l.clearMark?this.top.pendingMarks.concat(this.top.activeMarks).forEach(d=>{l.clearMark(d)&&(s=d.addToSet(s))}):t=this.parser.schema.marks[l.mark].create(l.attrs).addToSet(t),l.consuming===!1)a=l;else break}}return[t,s]}addElementByRule(e,t,s){let i,r,o;t.node?(r=this.parser.schema.nodes[t.node],r.isLeaf?this.insertNode(r.create(t.attrs))||this.leafFallback(e):i=this.enter(r,t.attrs||null,t.preserveWhitespace)):(o=this.parser.schema.marks[t.mark].create(t.attrs),this.addPendingMark(o));let a=this.top;if(r&&r.isLeaf)this.findInside(e);else if(s)this.addElement(e,s);else if(t.getContent)this.findInside(e),t.getContent(e,this.parser.schema).forEach(l=>this.insertNode(l));else{let l=e;typeof t.contentElement=="string"?l=e.querySelector(t.contentElement):typeof t.contentElement=="function"?l=t.contentElement(e):t.contentElement&&(l=t.contentElement),this.findAround(e,l,!0),this.addAll(l)}i&&this.sync(a)&&this.open--,o&&this.removePendingMark(o,a)}addAll(e,t,s){let i=t||0;for(let r=t?e.childNodes[t]:e.firstChild,o=s==null?null:e.childNodes[s];r!=o;r=r.nextSibling,++i)this.findAtPoint(e,i),this.addDOM(r);this.findAtPoint(e,i)}findPlace(e){let t,s;for(let i=this.open;i>=0;i--){let r=this.nodes[i],o=r.findWrapping(e);if(o&&(!t||t.length>o.length)&&(t=o,s=r,!o.length)||r.solid)break}if(!t)return!1;this.sync(s);for(let i=0;i<t.length;i++)this.enterInner(t[i],null,!1);return!0}insertNode(e){if(e.isInline&&this.needsBlock&&!this.top.type){let t=this.textblockFromContext();t&&this.enterInner(t)}if(this.findPlace(e)){this.closeExtra();let t=this.top;t.applyPending(e.type),t.match&&(t.match=t.match.matchType(e.type));let s=t.activeMarks;for(let i=0;i<e.marks.length;i++)(!t.type||t.type.allowsMarkType(e.marks[i].type))&&(s=e.marks[i].addToSet(s));return t.content.push(e.mark(s)),!0}return!1}enter(e,t,s){let i=this.findPlace(e.create(t));return i&&this.enterInner(e,t,!0,s),i}enterInner(e,t=null,s=!1,i){this.closeExtra();let r=this.top;r.applyPending(e),r.match=r.match&&r.match.matchType(e);let o=Ad(e,i,r.options);r.options&or&&r.content.length==0&&(o|=or),this.nodes.push(new Qr(e,t,r.activeMarks,r.pendingMarks,s,null,o)),this.open++}closeExtra(e=!1){let t=this.nodes.length-1;if(t>this.open){for(;t>this.open;t--)this.nodes[t-1].content.push(this.nodes[t].finish(e));this.nodes.length=this.open+1}}finish(){return this.open=0,this.closeExtra(this.isOpen),this.nodes[0].finish(this.isOpen||this.options.topOpen)}sync(e){for(let t=this.open;t>=0;t--)if(this.nodes[t]==e)return this.open=t,!0;return!1}get currentPos(){this.closeExtra();let e=0;for(let t=this.open;t>=0;t--){let s=this.nodes[t].content;for(let i=s.length-1;i>=0;i--)e+=s[i].nodeSize;t&&e++}return e}findAtPoint(e,t){if(this.find)for(let s=0;s<this.find.length;s++)this.find[s].node==e&&this.find[s].offset==t&&(this.find[s].pos=this.currentPos)}findInside(e){if(this.find)for(let t=0;t<this.find.length;t++)this.find[t].pos==null&&e.nodeType==1&&e.contains(this.find[t].node)&&(this.find[t].pos=this.currentPos)}findAround(e,t,s){if(e!=t&&this.find)for(let i=0;i<this.find.length;i++)this.find[i].pos==null&&e.nodeType==1&&e.contains(this.find[i].node)&&t.compareDocumentPosition(this.find[i].node)&(s?2:4)&&(this.find[i].pos=this.currentPos)}findInText(e){if(this.find)for(let t=0;t<this.find.length;t++)this.find[t].node==e&&(this.find[t].pos=this.currentPos-(e.nodeValue.length-this.find[t].offset))}matchesContext(e){if(e.indexOf("|")>-1)return e.split(/\s*\|\s*/).some(this.matchesContext,this);let t=e.split("/"),s=this.options.context,i=!this.isOpen&&(!s||s.parent.type==this.nodes[0].type),r=-(s?s.depth+1:0)+(i?0:1),o=(a,l)=>{for(;a>=0;a--){let d=t[a];if(d==""){if(a==t.length-1||a==0)continue;for(;l>=r;l--)if(o(a-1,l))return!0;return!1}else{let u=l>0||l==0&&i?this.nodes[l].type:s&&l>=r?s.node(l-r).type:null;if(!u||u.name!=d&&u.groups.indexOf(d)==-1)return!1;l--}}return!0};return o(t.length-1,this.open)}textblockFromContext(){let e=this.options.context;if(e)for(let t=e.depth;t>=0;t--){let s=e.node(t).contentMatchAt(e.indexAfter(t)).defaultType;if(s&&s.isTextblock&&s.defaultAttrs)return s}for(let t in this.parser.schema.nodes){let s=this.parser.schema.nodes[t];if(s.isTextblock&&s.defaultAttrs)return s}}addPendingMark(e){let t=Ow(e,this.top.pendingMarks);t&&this.top.stashMarks.push(t),this.top.pendingMarks=e.addToSet(this.top.pendingMarks)}removePendingMark(e,t){for(let s=this.open;s>=0;s--){let i=this.nodes[s];if(i.pendingMarks.lastIndexOf(e)>-1)i.pendingMarks=e.removeFromSet(i.pendingMarks);else{i.activeMarks=e.removeFromSet(i.activeMarks);let o=i.popFromStashMark(e);o&&i.type&&i.type.allowsMarkType(o.type)&&(i.activeMarks=o.addToSet(i.activeMarks))}if(i==t)break}}}function jw(n){for(let e=n.firstChild,t=null;e;e=e.nextSibling){let s=e.nodeType==1?e.nodeName.toLowerCase():null;s&&hp.hasOwnProperty(s)&&t?(t.appendChild(e),e=t):s=="li"?t=e:s&&(t=null)}}function Rw(n,e){return(n.matches||n.msMatchesSelector||n.webkitMatchesSelector||n.mozMatchesSelector).call(n,e)}function Rd(n){let e={};for(let t in n)e[t]=n[t];return e}function Dw(n,e){let t=e.schema.nodes;for(let s in t){let i=t[s];if(!i.allowsMarkType(n))continue;let r=[],o=a=>{r.push(a);for(let l=0;l<a.edgeCount;l++){let{type:d,next:u}=a.edge(l);if(d==e||r.indexOf(u)<0&&o(u))return!0}};if(o(i.contentMatch))return!0}}function Ow(n,e){for(let t=0;t<e.length;t++)if(n.eq(e[t]))return e[t]}class Ui{constructor(e,t){this.nodes=e,this.marks=t}serializeFragment(e,t={},s){s||(s=wa(t).createDocumentFragment());let i=s,r=[];return e.forEach(o=>{if(r.length||o.marks.length){let a=0,l=0;for(;a<r.length&&l<o.marks.length;){let d=o.marks[l];if(!this.marks[d.type.name]){l++;continue}if(!d.eq(r[a][0])||d.type.spec.spanning===!1)break;a++,l++}for(;a<r.length;)i=r.pop()[1];for(;l<o.marks.length;){let d=o.marks[l++],u=this.serializeMark(d,o.isInline,t);u&&(r.push([d,i]),i.appendChild(u.dom),i=u.contentDOM||u.dom)}}i.appendChild(this.serializeNodeInner(o,t))}),s}serializeNodeInner(e,t){let{dom:s,contentDOM:i}=lo(wa(t),this.nodes[e.type.name](e),null,e.attrs);if(i){if(e.isLeaf)throw new RangeError("Content hole not allowed in a leaf node spec");this.serializeFragment(e.content,t,i)}return s}serializeNode(e,t={}){let s=this.serializeNodeInner(e,t);for(let i=e.marks.length-1;i>=0;i--){let r=this.serializeMark(e.marks[i],e.isInline,t);r&&((r.contentDOM||r.dom).appendChild(s),s=r.dom)}return s}serializeMark(e,t,s={}){let i=this.marks[e.type.name];return i&&lo(wa(s),i(e,t),null,e.attrs)}static renderSpec(e,t,s=null,i){return lo(e,t,s,i)}static fromSchema(e){return e.cached.domSerializer||(e.cached.domSerializer=new Ui(this.nodesFromSchema(e),this.marksFromSchema(e)))}static nodesFromSchema(e){let t=Dd(e.nodes);return t.text||(t.text=s=>s.text),t}static marksFromSchema(e){return Dd(e.marks)}}function Dd(n){let e={};for(let t in n){let s=n[t].spec.toDOM;s&&(e[t]=s)}return e}function wa(n){return n.document||window.document}const Od=new WeakMap;function Pw(n){let e=Od.get(n);return e===void 0&&Od.set(n,e=Fw(n)),e}function Fw(n){let e=null;function t(s){if(s&&typeof s=="object")if(Array.isArray(s))if(typeof s[0]=="string")e||(e=[]),e.push(s);else for(let i=0;i<s.length;i++)t(s[i]);else for(let i in s)t(s[i])}return t(n),e}function lo(n,e,t,s){if(typeof e=="string")return{dom:n.createTextNode(e)};if(e.nodeType!=null)return{dom:e};if(e.dom&&e.dom.nodeType!=null)return e;let i=e[0],r;if(typeof i!="string")throw new RangeError("Invalid array passed to renderSpec");if(s&&(r=Pw(s))&&r.indexOf(e)>-1)throw new RangeError("Using an array from an attribute object as a DOM spec. This may be an attempted cross site scripting attack.");let o=i.indexOf(" ");o>0&&(t=i.slice(0,o),i=i.slice(o+1));let a,l=t?n.createElementNS(t,i):n.createElement(i),d=e[1],u=1;if(d&&typeof d=="object"&&d.nodeType==null&&!Array.isArray(d)){u=2;for(let h in d)if(d[h]!=null){let f=h.indexOf(" ");f>0?l.setAttributeNS(h.slice(0,f),h.slice(f+1),d[h]):l.setAttribute(h,d[h])}}for(let h=u;h<e.length;h++){let f=e[h];if(f===0){if(h<e.length-1||h>u)throw new RangeError("Content hole must be the only child of its parent node");return{dom:l,contentDOM:l}}else{let{dom:m,contentDOM:p}=lo(n,f,t,s);if(l.appendChild(m),p){if(a)throw new RangeError("Multiple content holes");a=p}}}return{dom:l,contentDOM:a}}const fp=65535,pp=Math.pow(2,16);function Lw(n,e){return n+e*pp}function Pd(n){return n&fp}function Bw(n){return(n-(n&fp))/pp}const mp=1,gp=2,co=4,yp=8;class sl{constructor(e,t,s){this.pos=e,this.delInfo=t,this.recover=s}get deleted(){return(this.delInfo&yp)>0}get deletedBefore(){return(this.delInfo&(mp|co))>0}get deletedAfter(){return(this.delInfo&(gp|co))>0}get deletedAcross(){return(this.delInfo&co)>0}}class Ft{constructor(e,t=!1){if(this.ranges=e,this.inverted=t,!e.length&&Ft.empty)return Ft.empty}recover(e){let t=0,s=Pd(e);if(!this.inverted)for(let i=0;i<s;i++)t+=this.ranges[i*3+2]-this.ranges[i*3+1];return this.ranges[s*3]+t+Bw(e)}mapResult(e,t=1){return this._map(e,t,!1)}map(e,t=1){return this._map(e,t,!0)}_map(e,t,s){let i=0,r=this.inverted?2:1,o=this.inverted?1:2;for(let a=0;a<this.ranges.length;a+=3){let l=this.ranges[a]-(this.inverted?i:0);if(l>e)break;let d=this.ranges[a+r],u=this.ranges[a+o],h=l+d;if(e<=h){let f=d?e==l?-1:e==h?1:t:t,m=l+i+(f<0?0:u);if(s)return m;let p=e==(t<0?l:h)?null:Lw(a/3,e-l),g=e==l?gp:e==h?mp:co;return(t<0?e!=l:e!=h)&&(g|=yp),new sl(m,g,p)}i+=u-d}return s?e+i:new sl(e+i,0,null)}touches(e,t){let s=0,i=Pd(t),r=this.inverted?2:1,o=this.inverted?1:2;for(let a=0;a<this.ranges.length;a+=3){let l=this.ranges[a]-(this.inverted?s:0);if(l>e)break;let d=this.ranges[a+r],u=l+d;if(e<=u&&a==i*3)return!0;s+=this.ranges[a+o]-d}return!1}forEach(e){let t=this.inverted?2:1,s=this.inverted?1:2;for(let i=0,r=0;i<this.ranges.length;i+=3){let o=this.ranges[i],a=o-(this.inverted?r:0),l=o+(this.inverted?0:r),d=this.ranges[i+t],u=this.ranges[i+s];e(a,a+d,l,l+u),r+=u-d}}invert(){return new Ft(this.ranges,!this.inverted)}toString(){return(this.inverted?"-":"")+JSON.stringify(this.ranges)}static offset(e){return e==0?Ft.empty:new Ft(e<0?[0,-e,0]:[0,0,e])}}Ft.empty=new Ft([]);class ki{constructor(e=[],t,s=0,i=e.length){this.maps=e,this.mirror=t,this.from=s,this.to=i}slice(e=0,t=this.maps.length){return new ki(this.maps,this.mirror,e,t)}copy(){return new ki(this.maps.slice(),this.mirror&&this.mirror.slice(),this.from,this.to)}appendMap(e,t){this.to=this.maps.push(e),t!=null&&this.setMirror(this.maps.length-1,t)}appendMapping(e){for(let t=0,s=this.maps.length;t<e.maps.length;t++){let i=e.getMirror(t);this.appendMap(e.maps[t],i!=null&&i<t?s+i:void 0)}}getMirror(e){if(this.mirror){for(let t=0;t<this.mirror.length;t++)if(this.mirror[t]==e)return this.mirror[t+(t%2?-1:1)]}}setMirror(e,t){this.mirror||(this.mirror=[]),this.mirror.push(e,t)}appendMappingInverted(e){for(let t=e.maps.length-1,s=this.maps.length+e.maps.length;t>=0;t--){let i=e.getMirror(t);this.appendMap(e.maps[t].invert(),i!=null&&i>t?s-i-1:void 0)}}invert(){let e=new ki;return e.appendMappingInverted(this),e}map(e,t=1){if(this.mirror)return this._map(e,t,!0);for(let s=this.from;s<this.to;s++)e=this.maps[s].map(e,t);return e}mapResult(e,t=1){return this._map(e,t,!1)}_map(e,t,s){let i=0;for(let r=this.from;r<this.to;r++){let o=this.maps[r],a=o.mapResult(e,t);if(a.recover!=null){let l=this.getMirror(r);if(l!=null&&l>r&&l<this.to){r=l,e=this.maps[l].recover(a.recover);continue}}i|=a.delInfo,e=a.pos}return s?e:new sl(e,i,null)}}const Ca=Object.create(null);class pt{getMap(){return Ft.empty}merge(e){return null}static fromJSON(e,t){if(!t||!t.stepType)throw new RangeError("Invalid input for Step.fromJSON");let s=Ca[t.stepType];if(!s)throw new RangeError(`No step type ${t.stepType} defined`);return s.fromJSON(e,t)}static jsonID(e,t){if(e in Ca)throw new RangeError("Duplicate use of step JSON ID "+e);return Ca[e]=t,t.prototype.jsonID=e,t}}class qe{constructor(e,t){this.doc=e,this.failed=t}static ok(e){return new qe(e,null)}static fail(e){return new qe(null,e)}static fromReplace(e,t,s,i){try{return qe.ok(e.replace(t,s,i))}catch(r){if(r instanceof Eo)return qe.fail(r.message);throw r}}}function xc(n,e,t){let s=[];for(let i=0;i<n.childCount;i++){let r=n.child(i);r.content.size&&(r=r.copy(xc(r.content,e,r))),r.isInline&&(r=e(r,t,i)),s.push(r)}return P.fromArray(s)}class hs extends pt{constructor(e,t,s){super(),this.from=e,this.to=t,this.mark=s}apply(e){let t=e.slice(this.from,this.to),s=e.resolve(this.from),i=s.node(s.sharedDepth(this.to)),r=new q(xc(t.content,(o,a)=>!o.isAtom||!a.type.allowsMarkType(this.mark.type)?o:o.mark(this.mark.addToSet(o.marks)),i),t.openStart,t.openEnd);return qe.fromReplace(e,this.from,this.to,r)}invert(){return new wn(this.from,this.to,this.mark)}map(e){let t=e.mapResult(this.from,1),s=e.mapResult(this.to,-1);return t.deleted&&s.deleted||t.pos>=s.pos?null:new hs(t.pos,s.pos,this.mark)}merge(e){return e instanceof hs&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from?new hs(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark):null}toJSON(){return{stepType:"addMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for AddMarkStep.fromJSON");return new hs(t.from,t.to,e.markFromJSON(t.mark))}}pt.jsonID("addMark",hs);class wn extends pt{constructor(e,t,s){super(),this.from=e,this.to=t,this.mark=s}apply(e){let t=e.slice(this.from,this.to),s=new q(xc(t.content,i=>i.mark(this.mark.removeFromSet(i.marks)),e),t.openStart,t.openEnd);return qe.fromReplace(e,this.from,this.to,s)}invert(){return new hs(this.from,this.to,this.mark)}map(e){let t=e.mapResult(this.from,1),s=e.mapResult(this.to,-1);return t.deleted&&s.deleted||t.pos>=s.pos?null:new wn(t.pos,s.pos,this.mark)}merge(e){return e instanceof wn&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from?new wn(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark):null}toJSON(){return{stepType:"removeMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for RemoveMarkStep.fromJSON");return new wn(t.from,t.to,e.markFromJSON(t.mark))}}pt.jsonID("removeMark",wn);class fs extends pt{constructor(e,t){super(),this.pos=e,this.mark=t}apply(e){let t=e.nodeAt(this.pos);if(!t)return qe.fail("No node at mark step's position");let s=t.type.create(t.attrs,null,this.mark.addToSet(t.marks));return qe.fromReplace(e,this.pos,this.pos+1,new q(P.from(s),0,t.isLeaf?0:1))}invert(e){let t=e.nodeAt(this.pos);if(t){let s=this.mark.addToSet(t.marks);if(s.length==t.marks.length){for(let i=0;i<t.marks.length;i++)if(!t.marks[i].isInSet(s))return new fs(this.pos,t.marks[i]);return new fs(this.pos,this.mark)}}return new Ri(this.pos,this.mark)}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new fs(t.pos,this.mark)}toJSON(){return{stepType:"addNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for AddNodeMarkStep.fromJSON");return new fs(t.pos,e.markFromJSON(t.mark))}}pt.jsonID("addNodeMark",fs);class Ri extends pt{constructor(e,t){super(),this.pos=e,this.mark=t}apply(e){let t=e.nodeAt(this.pos);if(!t)return qe.fail("No node at mark step's position");let s=t.type.create(t.attrs,null,this.mark.removeFromSet(t.marks));return qe.fromReplace(e,this.pos,this.pos+1,new q(P.from(s),0,t.isLeaf?0:1))}invert(e){let t=e.nodeAt(this.pos);return!t||!this.mark.isInSet(t.marks)?this:new fs(this.pos,this.mark)}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new Ri(t.pos,this.mark)}toJSON(){return{stepType:"removeNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for RemoveNodeMarkStep.fromJSON");return new Ri(t.pos,e.markFromJSON(t.mark))}}pt.jsonID("removeNodeMark",Ri);class ut extends pt{constructor(e,t,s,i=!1){super(),this.from=e,this.to=t,this.slice=s,this.structure=i}apply(e){return this.structure&&il(e,this.from,this.to)?qe.fail("Structure replace would overwrite content"):qe.fromReplace(e,this.from,this.to,this.slice)}getMap(){return new Ft([this.from,this.to-this.from,this.slice.size])}invert(e){return new ut(this.from,this.from+this.slice.size,e.slice(this.from,this.to))}map(e){let t=e.mapResult(this.from,1),s=e.mapResult(this.to,-1);return t.deletedAcross&&s.deletedAcross?null:new ut(t.pos,Math.max(t.pos,s.pos),this.slice)}merge(e){if(!(e instanceof ut)||e.structure||this.structure)return null;if(this.from+this.slice.size==e.from&&!this.slice.openEnd&&!e.slice.openStart){let t=this.slice.size+e.slice.size==0?q.empty:new q(this.slice.content.append(e.slice.content),this.slice.openStart,e.slice.openEnd);return new ut(this.from,this.to+(e.to-e.from),t,this.structure)}else if(e.to==this.from&&!this.slice.openStart&&!e.slice.openEnd){let t=this.slice.size+e.slice.size==0?q.empty:new q(e.slice.content.append(this.slice.content),e.slice.openStart,this.slice.openEnd);return new ut(e.from,this.to,t,this.structure)}else return null}toJSON(){let e={stepType:"replace",from:this.from,to:this.to};return this.slice.size&&(e.slice=this.slice.toJSON()),this.structure&&(e.structure=!0),e}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for ReplaceStep.fromJSON");return new ut(t.from,t.to,q.fromJSON(e,t.slice),!!t.structure)}}pt.jsonID("replace",ut);class Ut extends pt{constructor(e,t,s,i,r,o,a=!1){super(),this.from=e,this.to=t,this.gapFrom=s,this.gapTo=i,this.slice=r,this.insert=o,this.structure=a}apply(e){if(this.structure&&(il(e,this.from,this.gapFrom)||il(e,this.gapTo,this.to)))return qe.fail("Structure gap-replace would overwrite content");let t=e.slice(this.gapFrom,this.gapTo);if(t.openStart||t.openEnd)return qe.fail("Gap is not a flat range");let s=this.slice.insertAt(this.insert,t.content);return s?qe.fromReplace(e,this.from,this.to,s):qe.fail("Content does not fit in gap")}getMap(){return new Ft([this.from,this.gapFrom-this.from,this.insert,this.gapTo,this.to-this.gapTo,this.slice.size-this.insert])}invert(e){let t=this.gapTo-this.gapFrom;return new Ut(this.from,this.from+this.slice.size+t,this.from+this.insert,this.from+this.insert+t,e.slice(this.from,this.to).removeBetween(this.gapFrom-this.from,this.gapTo-this.from),this.gapFrom-this.from,this.structure)}map(e){let t=e.mapResult(this.from,1),s=e.mapResult(this.to,-1),i=this.from==this.gapFrom?t.pos:e.map(this.gapFrom,-1),r=this.to==this.gapTo?s.pos:e.map(this.gapTo,1);return t.deletedAcross&&s.deletedAcross||i<t.pos||r>s.pos?null:new Ut(t.pos,s.pos,i,r,this.slice,this.insert,this.structure)}toJSON(){let e={stepType:"replaceAround",from:this.from,to:this.to,gapFrom:this.gapFrom,gapTo:this.gapTo,insert:this.insert};return this.slice.size&&(e.slice=this.slice.toJSON()),this.structure&&(e.structure=!0),e}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number"||typeof t.gapFrom!="number"||typeof t.gapTo!="number"||typeof t.insert!="number")throw new RangeError("Invalid input for ReplaceAroundStep.fromJSON");return new Ut(t.from,t.to,t.gapFrom,t.gapTo,q.fromJSON(e,t.slice),t.insert,!!t.structure)}}pt.jsonID("replaceAround",Ut);function il(n,e,t){let s=n.resolve(e),i=t-e,r=s.depth;for(;i>0&&r>0&&s.indexAfter(r)==s.node(r).childCount;)r--,i--;if(i>0){let o=s.node(r).maybeChild(s.indexAfter(r));for(;i>0;){if(!o||o.isLeaf)return!0;o=o.firstChild,i--}}return!1}function zw(n,e,t,s){let i=[],r=[],o,a;n.doc.nodesBetween(e,t,(l,d,u)=>{if(!l.isInline)return;let h=l.marks;if(!s.isInSet(h)&&u.type.allowsMarkType(s.type)){let f=Math.max(d,e),m=Math.min(d+l.nodeSize,t),p=s.addToSet(h);for(let g=0;g<h.length;g++)h[g].isInSet(p)||(o&&o.to==f&&o.mark.eq(h[g])?o.to=m:i.push(o=new wn(f,m,h[g])));a&&a.to==f?a.to=m:r.push(a=new hs(f,m,s))}}),i.forEach(l=>n.step(l)),r.forEach(l=>n.step(l))}function Uw(n,e,t,s){let i=[],r=0;n.doc.nodesBetween(e,t,(o,a)=>{if(!o.isInline)return;r++;let l=null;if(s instanceof sa){let d=o.marks,u;for(;u=s.isInSet(d);)(l||(l=[])).push(u),d=u.removeFromSet(d)}else s?s.isInSet(o.marks)&&(l=[s]):l=o.marks;if(l&&l.length){let d=Math.min(a+o.nodeSize,t);for(let u=0;u<l.length;u++){let h=l[u],f;for(let m=0;m<i.length;m++){let p=i[m];p.step==r-1&&h.eq(i[m].style)&&(f=p)}f?(f.to=d,f.step=r):i.push({style:h,from:Math.max(a,e),to:d,step:r})}}}),i.forEach(o=>n.step(new wn(o.from,o.to,o.style)))}function xp(n,e,t,s=t.contentMatch,i=!0){let r=n.doc.nodeAt(e),o=[],a=e+1;for(let l=0;l<r.childCount;l++){let d=r.child(l),u=a+d.nodeSize,h=s.matchType(d.type);if(!h)o.push(new ut(a,u,q.empty));else{s=h;for(let f=0;f<d.marks.length;f++)t.allowsMarkType(d.marks[f].type)||n.step(new wn(a,u,d.marks[f]));if(i&&d.isText&&t.whitespace!="pre"){let f,m=/\r?\n|\r/g,p;for(;f=m.exec(d.text);)p||(p=new q(P.from(t.schema.text(" ",t.allowedMarks(d.marks))),0,0)),o.push(new ut(a+f.index,a+f.index+f[0].length,p))}}a=u}if(!s.validEnd){let l=s.fillBefore(P.empty,!0);n.replace(a,a,new q(l,0,0))}for(let l=o.length-1;l>=0;l--)n.step(o[l])}function Vw(n,e,t){return(e==0||n.canReplace(e,n.childCount))&&(t==n.childCount||n.canReplace(0,t))}function bc(n){let t=n.parent.content.cutByIndex(n.startIndex,n.endIndex);for(let s=n.depth;;--s){let i=n.$from.node(s),r=n.$from.index(s),o=n.$to.indexAfter(s);if(s<n.depth&&i.canReplace(r,o,t))return s;if(s==0||i.type.spec.isolating||!Vw(i,r,o))break}return null}function Ww(n,e,t){let{$from:s,$to:i,depth:r}=e,o=s.before(r+1),a=i.after(r+1),l=o,d=a,u=P.empty,h=0;for(let p=r,g=!1;p>t;p--)g||s.index(p)>0?(g=!0,u=P.from(s.node(p).copy(u)),h++):l--;let f=P.empty,m=0;for(let p=r,g=!1;p>t;p--)g||i.after(p+1)<i.end(p)?(g=!0,f=P.from(i.node(p).copy(f)),m++):d++;n.step(new Ut(l,d,o,a,new q(u.append(f),h,m),u.size-h,!0))}function Hw(n,e,t=null,s=n){let i=Gw(n,e),r=i&&qw(s,e);return r?i.map(Fd).concat({type:e,attrs:t}).concat(r.map(Fd)):null}function Fd(n){return{type:n,attrs:null}}function Gw(n,e){let{parent:t,startIndex:s,endIndex:i}=n,r=t.contentMatchAt(s).findWrapping(e);if(!r)return null;let o=r.length?r[0]:e;return t.canReplaceWith(s,i,o)?r:null}function qw(n,e){let{parent:t,startIndex:s,endIndex:i}=n,r=t.child(s),o=e.contentMatch.findWrapping(r.type);if(!o)return null;let l=(o.length?o[o.length-1]:e).contentMatch;for(let d=s;l&&d<i;d++)l=l.matchType(t.child(d).type);return!l||!l.validEnd?null:o}function $w(n,e,t){let s=P.empty;for(let o=t.length-1;o>=0;o--){if(s.size){let a=t[o].type.contentMatch.matchFragment(s);if(!a||!a.validEnd)throw new RangeError("Wrapper type given to Transform.wrap does not form valid content of its parent wrapper")}s=P.from(t[o].type.create(t[o].attrs,s))}let i=e.start,r=e.end;n.step(new Ut(i,r,i,r,new q(s,0,0),t.length,!0))}function Kw(n,e,t,s,i){if(!s.isTextblock)throw new RangeError("Type given to setBlockType should be a textblock");let r=n.steps.length;n.doc.nodesBetween(e,t,(o,a)=>{if(o.isTextblock&&!o.hasMarkup(s,i)&&Qw(n.doc,n.mapping.slice(r).map(a),s)){let l=null;if(s.schema.linebreakReplacement){let f=s.whitespace=="pre",m=!!s.contentMatch.matchType(s.schema.linebreakReplacement);f&&!m?l=!1:!f&&m&&(l=!0)}l===!1&&Yw(n,o,a,r),xp(n,n.mapping.slice(r).map(a,1),s,void 0,l===null);let d=n.mapping.slice(r),u=d.map(a,1),h=d.map(a+o.nodeSize,1);return n.step(new Ut(u,h,u+1,h-1,new q(P.from(s.create(i,null,o.marks)),0,0),1,!0)),l===!0&&Jw(n,o,a,r),!1}})}function Jw(n,e,t,s){e.forEach((i,r)=>{if(i.isText){let o,a=/\r?\n|\r/g;for(;o=a.exec(i.text);){let l=n.mapping.slice(s).map(t+1+r+o.index);n.replaceWith(l,l+1,e.type.schema.linebreakReplacement.create())}}})}function Yw(n,e,t,s){e.forEach((i,r)=>{if(i.type==i.type.schema.linebreakReplacement){let o=n.mapping.slice(s).map(t+1+r);n.replaceWith(o,o+1,e.type.schema.text(`
`))}})}function Qw(n,e,t){let s=n.resolve(e),i=s.index();return s.parent.canReplaceWith(i,i+1,t)}function Xw(n,e,t,s,i){let r=n.doc.nodeAt(e);if(!r)throw new RangeError("No node at given position");t||(t=r.type);let o=t.create(s,null,i||r.marks);if(r.isLeaf)return n.replaceWith(e,e+r.nodeSize,o);if(!t.validContent(r.content))throw new RangeError("Invalid content for node type "+t.name);n.step(new Ut(e,e+r.nodeSize,e+1,e+r.nodeSize-1,new q(P.from(o),0,0),1,!0))}function uo(n,e,t=1,s){let i=n.resolve(e),r=i.depth-t,o=s&&s[s.length-1]||i.parent;if(r<0||i.parent.type.spec.isolating||!i.parent.canReplace(i.index(),i.parent.childCount)||!o.type.validContent(i.parent.content.cutByIndex(i.index(),i.parent.childCount)))return!1;for(let d=i.depth-1,u=t-2;d>r;d--,u--){let h=i.node(d),f=i.index(d);if(h.type.spec.isolating)return!1;let m=h.content.cutByIndex(f,h.childCount),p=s&&s[u+1];p&&(m=m.replaceChild(0,p.type.create(p.attrs)));let g=s&&s[u]||h;if(!h.canReplace(f+1,h.childCount)||!g.type.validContent(m))return!1}let a=i.indexAfter(r),l=s&&s[0];return i.node(r).canReplaceWith(a,a,l?l.type:i.node(r+1).type)}function Zw(n,e,t=1,s){let i=n.doc.resolve(e),r=P.empty,o=P.empty;for(let a=i.depth,l=i.depth-t,d=t-1;a>l;a--,d--){r=P.from(i.node(a).copy(r));let u=s&&s[d];o=P.from(u?u.type.create(u.attrs,o):i.node(a).copy(o))}n.step(new ut(e,e,new q(r.append(o),t,t),!0))}function bp(n,e){let t=n.resolve(e),s=t.index();return eC(t.nodeBefore,t.nodeAfter)&&t.parent.canReplace(s,s+1)}function eC(n,e){return!!(n&&e&&!n.isLeaf&&n.canAppend(e))}function tC(n,e,t){let s=new ut(e-t,e+t,q.empty,!0);n.step(s)}function nC(n,e,t){let s=n.resolve(e);if(s.parent.canReplaceWith(s.index(),s.index(),t))return e;if(s.parentOffset==0)for(let i=s.depth-1;i>=0;i--){let r=s.index(i);if(s.node(i).canReplaceWith(r,r,t))return s.before(i+1);if(r>0)return null}if(s.parentOffset==s.parent.content.size)for(let i=s.depth-1;i>=0;i--){let r=s.indexAfter(i);if(s.node(i).canReplaceWith(r,r,t))return s.after(i+1);if(r<s.node(i).childCount)return null}return null}function sC(n,e,t){let s=n.resolve(e);if(!t.content.size)return e;let i=t.content;for(let r=0;r<t.openStart;r++)i=i.firstChild.content;for(let r=1;r<=(t.openStart==0&&t.size?2:1);r++)for(let o=s.depth;o>=0;o--){let a=o==s.depth?0:s.pos<=(s.start(o+1)+s.end(o+1))/2?-1:1,l=s.index(o)+(a>0?1:0),d=s.node(o),u=!1;if(r==1)u=d.canReplace(l,l,i);else{let h=d.contentMatchAt(l).findWrapping(i.firstChild.type);u=h&&d.canReplaceWith(l,l,h[0])}if(u)return a==0?s.pos:a<0?s.before(o+1):s.after(o+1)}return null}function Sc(n,e,t=e,s=q.empty){if(e==t&&!s.size)return null;let i=n.resolve(e),r=n.resolve(t);return Sp(i,r,s)?new ut(e,t,s):new iC(i,r,s).fit()}function Sp(n,e,t){return!t.openStart&&!t.openEnd&&n.start()==e.start()&&n.parent.canReplace(n.index(),e.index(),t.content)}class iC{constructor(e,t,s){this.$from=e,this.$to=t,this.unplaced=s,this.frontier=[],this.placed=P.empty;for(let i=0;i<=e.depth;i++){let r=e.node(i);this.frontier.push({type:r.type,match:r.contentMatchAt(e.indexAfter(i))})}for(let i=e.depth;i>0;i--)this.placed=P.from(e.node(i).copy(this.placed))}get depth(){return this.frontier.length-1}fit(){for(;this.unplaced.size;){let d=this.findFittable();d?this.placeNodes(d):this.openMore()||this.dropNode()}let e=this.mustMoveInline(),t=this.placed.size-this.depth-this.$from.depth,s=this.$from,i=this.close(e<0?this.$to:s.doc.resolve(e));if(!i)return null;let r=this.placed,o=s.depth,a=i.depth;for(;o&&a&&r.childCount==1;)r=r.firstChild.content,o--,a--;let l=new q(r,o,a);return e>-1?new Ut(s.pos,e,this.$to.pos,this.$to.end(),l,t):l.size||s.pos!=this.$to.pos?new ut(s.pos,i.pos,l):null}findFittable(){let e=this.unplaced.openStart;for(let t=this.unplaced.content,s=0,i=this.unplaced.openEnd;s<e;s++){let r=t.firstChild;if(t.childCount>1&&(i=0),r.type.spec.isolating&&i<=s){e=s;break}t=r.content}for(let t=1;t<=2;t++)for(let s=t==1?e:this.unplaced.openStart;s>=0;s--){let i,r=null;s?(r=va(this.unplaced.content,s-1).firstChild,i=r.content):i=this.unplaced.content;let o=i.firstChild;for(let a=this.depth;a>=0;a--){let{type:l,match:d}=this.frontier[a],u,h=null;if(t==1&&(o?d.matchType(o.type)||(h=d.fillBefore(P.from(o),!1)):r&&l.compatibleContent(r.type)))return{sliceDepth:s,frontierDepth:a,parent:r,inject:h};if(t==2&&o&&(u=d.findWrapping(o.type)))return{sliceDepth:s,frontierDepth:a,parent:r,wrap:u};if(r&&d.matchType(r.type))break}}}openMore(){let{content:e,openStart:t,openEnd:s}=this.unplaced,i=va(e,t);return!i.childCount||i.firstChild.isLeaf?!1:(this.unplaced=new q(e,t+1,Math.max(s,i.size+t>=e.size-s?t+1:0)),!0)}dropNode(){let{content:e,openStart:t,openEnd:s}=this.unplaced,i=va(e,t);if(i.childCount<=1&&t>0){let r=e.size-t<=t+i.size;this.unplaced=new q(Xi(e,t-1,1),t-1,r?t-1:s)}else this.unplaced=new q(Xi(e,t,1),t,s)}placeNodes({sliceDepth:e,frontierDepth:t,parent:s,inject:i,wrap:r}){for(;this.depth>t;)this.closeFrontierNode();if(r)for(let g=0;g<r.length;g++)this.openFrontierNode(r[g]);let o=this.unplaced,a=s?s.content:o.content,l=o.openStart-e,d=0,u=[],{match:h,type:f}=this.frontier[t];if(i){for(let g=0;g<i.childCount;g++)u.push(i.child(g));h=h.matchFragment(i)}let m=a.size+e-(o.content.size-o.openEnd);for(;d<a.childCount;){let g=a.child(d),S=h.matchType(g.type);if(!S)break;d++,(d>1||l==0||g.content.size)&&(h=S,u.push(kp(g.mark(f.allowedMarks(g.marks)),d==1?l:0,d==a.childCount?m:-1)))}let p=d==a.childCount;p||(m=-1),this.placed=Zi(this.placed,t,P.from(u)),this.frontier[t].match=h,p&&m<0&&s&&s.type==this.frontier[this.depth].type&&this.frontier.length>1&&this.closeFrontierNode();for(let g=0,S=a;g<m;g++){let x=S.lastChild;this.frontier.push({type:x.type,match:x.contentMatchAt(x.childCount)}),S=x.content}this.unplaced=p?e==0?q.empty:new q(Xi(o.content,e-1,1),e-1,m<0?o.openEnd:e-1):new q(Xi(o.content,e,d),o.openStart,o.openEnd)}mustMoveInline(){if(!this.$to.parent.isTextblock)return-1;let e=this.frontier[this.depth],t;if(!e.type.isTextblock||!Ma(this.$to,this.$to.depth,e.type,e.match,!1)||this.$to.depth==this.depth&&(t=this.findCloseLevel(this.$to))&&t.depth==this.depth)return-1;let{depth:s}=this.$to,i=this.$to.after(s);for(;s>1&&i==this.$to.end(--s);)++i;return i}findCloseLevel(e){e:for(let t=Math.min(this.depth,e.depth);t>=0;t--){let{match:s,type:i}=this.frontier[t],r=t<e.depth&&e.end(t+1)==e.pos+(e.depth-(t+1)),o=Ma(e,t,i,s,r);if(o){for(let a=t-1;a>=0;a--){let{match:l,type:d}=this.frontier[a],u=Ma(e,a,d,l,!0);if(!u||u.childCount)continue e}return{depth:t,fit:o,move:r?e.doc.resolve(e.after(t+1)):e}}}}close(e){let t=this.findCloseLevel(e);if(!t)return null;for(;this.depth>t.depth;)this.closeFrontierNode();t.fit.childCount&&(this.placed=Zi(this.placed,t.depth,t.fit)),e=t.move;for(let s=t.depth+1;s<=e.depth;s++){let i=e.node(s),r=i.type.contentMatch.fillBefore(i.content,!0,e.index(s));this.openFrontierNode(i.type,i.attrs,r)}return e}openFrontierNode(e,t=null,s){let i=this.frontier[this.depth];i.match=i.match.matchType(e),this.placed=Zi(this.placed,this.depth,P.from(e.create(t,s))),this.frontier.push({type:e,match:e.contentMatch})}closeFrontierNode(){let t=this.frontier.pop().match.fillBefore(P.empty,!0);t.childCount&&(this.placed=Zi(this.placed,this.frontier.length,t))}}function Xi(n,e,t){return e==0?n.cutByIndex(t,n.childCount):n.replaceChild(0,n.firstChild.copy(Xi(n.firstChild.content,e-1,t)))}function Zi(n,e,t){return e==0?n.append(t):n.replaceChild(n.childCount-1,n.lastChild.copy(Zi(n.lastChild.content,e-1,t)))}function va(n,e){for(let t=0;t<e;t++)n=n.firstChild.content;return n}function kp(n,e,t){if(e<=0)return n;let s=n.content;return e>1&&(s=s.replaceChild(0,kp(s.firstChild,e-1,s.childCount==1?t-1:0))),e>0&&(s=n.type.contentMatch.fillBefore(s).append(s),t<=0&&(s=s.append(n.type.contentMatch.matchFragment(s).fillBefore(P.empty,!0)))),n.copy(s)}function Ma(n,e,t,s,i){let r=n.node(e),o=i?n.indexAfter(e):n.index(e);if(o==r.childCount&&!t.compatibleContent(r.type))return null;let a=s.fillBefore(r.content,!0,o);return a&&!rC(t,r.content,o)?a:null}function rC(n,e,t){for(let s=t;s<e.childCount;s++)if(!n.allowsMarks(e.child(s).marks))return!0;return!1}function oC(n){return n.spec.defining||n.spec.definingForContent}function aC(n,e,t,s){if(!s.size)return n.deleteRange(e,t);let i=n.doc.resolve(e),r=n.doc.resolve(t);if(Sp(i,r,s))return n.step(new ut(e,t,s));let o=Cp(i,n.doc.resolve(t));o[o.length-1]==0&&o.pop();let a=-(i.depth+1);o.unshift(a);for(let f=i.depth,m=i.pos-1;f>0;f--,m--){let p=i.node(f).type.spec;if(p.defining||p.definingAsContext||p.isolating)break;o.indexOf(f)>-1?a=f:i.before(f)==m&&o.splice(1,0,-f)}let l=o.indexOf(a),d=[],u=s.openStart;for(let f=s.content,m=0;;m++){let p=f.firstChild;if(d.push(p),m==s.openStart)break;f=p.content}for(let f=u-1;f>=0;f--){let m=d[f],p=oC(m.type);if(p&&!m.sameMarkup(i.node(Math.abs(a)-1)))u=f;else if(p||!m.type.isTextblock)break}for(let f=s.openStart;f>=0;f--){let m=(f+u+1)%(s.openStart+1),p=d[m];if(p)for(let g=0;g<o.length;g++){let S=o[(g+l)%o.length],x=!0;S<0&&(x=!1,S=-S);let w=i.node(S-1),C=i.index(S-1);if(w.canReplaceWith(C,C,p.type,p.marks))return n.replace(i.before(S),x?r.after(S):t,new q(wp(s.content,0,s.openStart,m),m,s.openEnd))}}let h=n.steps.length;for(let f=o.length-1;f>=0&&(n.replace(e,t,s),!(n.steps.length>h));f--){let m=o[f];m<0||(e=i.before(m),t=r.after(m))}}function wp(n,e,t,s,i){if(e<t){let r=n.firstChild;n=n.replaceChild(0,r.copy(wp(r.content,e+1,t,s,r)))}if(e>s){let r=i.contentMatchAt(0),o=r.fillBefore(n).append(n);n=o.append(r.matchFragment(o).fillBefore(P.empty,!0))}return n}function lC(n,e,t,s){if(!s.isInline&&e==t&&n.doc.resolve(e).parent.content.size){let i=nC(n.doc,e,s.type);i!=null&&(e=t=i)}n.replaceRange(e,t,new q(P.from(s),0,0))}function cC(n,e,t){let s=n.doc.resolve(e),i=n.doc.resolve(t),r=Cp(s,i);for(let o=0;o<r.length;o++){let a=r[o],l=o==r.length-1;if(l&&a==0||s.node(a).type.contentMatch.validEnd)return n.delete(s.start(a),i.end(a));if(a>0&&(l||s.node(a-1).canReplace(s.index(a-1),i.indexAfter(a-1))))return n.delete(s.before(a),i.after(a))}for(let o=1;o<=s.depth&&o<=i.depth;o++)if(e-s.start(o)==s.depth-o&&t>s.end(o)&&i.end(o)-t!=i.depth-o)return n.delete(s.before(o),t);n.delete(e,t)}function Cp(n,e){let t=[],s=Math.min(n.depth,e.depth);for(let i=s;i>=0;i--){let r=n.start(i);if(r<n.pos-(n.depth-i)||e.end(i)>e.pos+(e.depth-i)||n.node(i).type.spec.isolating||e.node(i).type.spec.isolating)break;(r==e.start(i)||i==n.depth&&i==e.depth&&n.parent.inlineContent&&e.parent.inlineContent&&i&&e.start(i-1)==r-1)&&t.push(i)}return t}class wi extends pt{constructor(e,t,s){super(),this.pos=e,this.attr=t,this.value=s}apply(e){let t=e.nodeAt(this.pos);if(!t)return qe.fail("No node at attribute step's position");let s=Object.create(null);for(let r in t.attrs)s[r]=t.attrs[r];s[this.attr]=this.value;let i=t.type.create(s,null,t.marks);return qe.fromReplace(e,this.pos,this.pos+1,new q(P.from(i),0,t.isLeaf?0:1))}getMap(){return Ft.empty}invert(e){return new wi(this.pos,this.attr,e.nodeAt(this.pos).attrs[this.attr])}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new wi(t.pos,this.attr,this.value)}toJSON(){return{stepType:"attr",pos:this.pos,attr:this.attr,value:this.value}}static fromJSON(e,t){if(typeof t.pos!="number"||typeof t.attr!="string")throw new RangeError("Invalid input for AttrStep.fromJSON");return new wi(t.pos,t.attr,t.value)}}pt.jsonID("attr",wi);class br extends pt{constructor(e,t){super(),this.attr=e,this.value=t}apply(e){let t=Object.create(null);for(let i in e.attrs)t[i]=e.attrs[i];t[this.attr]=this.value;let s=e.type.create(t,e.content,e.marks);return qe.ok(s)}getMap(){return Ft.empty}invert(e){return new br(this.attr,e.attrs[this.attr])}map(e){return this}toJSON(){return{stepType:"docAttr",attr:this.attr,value:this.value}}static fromJSON(e,t){if(typeof t.attr!="string")throw new RangeError("Invalid input for DocAttrStep.fromJSON");return new br(t.attr,t.value)}}pt.jsonID("docAttr",br);let Di=class extends Error{};Di=function n(e){let t=Error.call(this,e);return t.__proto__=n.prototype,t};Di.prototype=Object.create(Error.prototype);Di.prototype.constructor=Di;Di.prototype.name="TransformError";class dC{constructor(e){this.doc=e,this.steps=[],this.docs=[],this.mapping=new ki}get before(){return this.docs.length?this.docs[0]:this.doc}step(e){let t=this.maybeStep(e);if(t.failed)throw new Di(t.failed);return this}maybeStep(e){let t=e.apply(this.doc);return t.failed||this.addStep(e,t.doc),t}get docChanged(){return this.steps.length>0}addStep(e,t){this.docs.push(this.doc),this.steps.push(e),this.mapping.appendMap(e.getMap()),this.doc=t}replace(e,t=e,s=q.empty){let i=Sc(this.doc,e,t,s);return i&&this.step(i),this}replaceWith(e,t,s){return this.replace(e,t,new q(P.from(s),0,0))}delete(e,t){return this.replace(e,t,q.empty)}insert(e,t){return this.replaceWith(e,e,t)}replaceRange(e,t,s){return aC(this,e,t,s),this}replaceRangeWith(e,t,s){return lC(this,e,t,s),this}deleteRange(e,t){return cC(this,e,t),this}lift(e,t){return Ww(this,e,t),this}join(e,t=1){return tC(this,e,t),this}wrap(e,t){return $w(this,e,t),this}setBlockType(e,t=e,s,i=null){return Kw(this,e,t,s,i),this}setNodeMarkup(e,t,s=null,i){return Xw(this,e,t,s,i),this}setNodeAttribute(e,t,s){return this.step(new wi(e,t,s)),this}setDocAttribute(e,t){return this.step(new br(e,t)),this}addNodeMark(e,t){return this.step(new fs(e,t)),this}removeNodeMark(e,t){if(!(t instanceof be)){let s=this.doc.nodeAt(e);if(!s)throw new RangeError("No node at position "+e);if(t=t.isInSet(s.marks),!t)return this}return this.step(new Ri(e,t)),this}split(e,t=1,s){return Zw(this,e,t,s),this}addMark(e,t,s){return zw(this,e,t,s),this}removeMark(e,t,s){return Uw(this,e,t,s),this}clearIncompatible(e,t,s){return xp(this,e,t,s),this}}const Ta=Object.create(null);class de{constructor(e,t,s){this.$anchor=e,this.$head=t,this.ranges=s||[new uC(e.min(t),e.max(t))]}get anchor(){return this.$anchor.pos}get head(){return this.$head.pos}get from(){return this.$from.pos}get to(){return this.$to.pos}get $from(){return this.ranges[0].$from}get $to(){return this.ranges[0].$to}get empty(){let e=this.ranges;for(let t=0;t<e.length;t++)if(e[t].$from.pos!=e[t].$to.pos)return!1;return!0}content(){return this.$from.doc.slice(this.from,this.to,!0)}replace(e,t=q.empty){let s=t.content.lastChild,i=null;for(let a=0;a<t.openEnd;a++)i=s,s=s.lastChild;let r=e.steps.length,o=this.ranges;for(let a=0;a<o.length;a++){let{$from:l,$to:d}=o[a],u=e.mapping.slice(r);e.replaceRange(u.map(l.pos),u.map(d.pos),a?q.empty:t),a==0&&zd(e,r,(s?s.isInline:i&&i.isTextblock)?-1:1)}}replaceWith(e,t){let s=e.steps.length,i=this.ranges;for(let r=0;r<i.length;r++){let{$from:o,$to:a}=i[r],l=e.mapping.slice(s),d=l.map(o.pos),u=l.map(a.pos);r?e.deleteRange(d,u):(e.replaceRangeWith(d,u,t),zd(e,s,t.isInline?-1:1))}}static findFrom(e,t,s=!1){let i=e.parent.inlineContent?new ye(e):gi(e.node(0),e.parent,e.pos,e.index(),t,s);if(i)return i;for(let r=e.depth-1;r>=0;r--){let o=t<0?gi(e.node(0),e.node(r),e.before(r+1),e.index(r),t,s):gi(e.node(0),e.node(r),e.after(r+1),e.index(r)+1,t,s);if(o)return o}return null}static near(e,t=1){return this.findFrom(e,t)||this.findFrom(e,-t)||new Vt(e.node(0))}static atStart(e){return gi(e,e,0,0,1)||new Vt(e)}static atEnd(e){return gi(e,e,e.content.size,e.childCount,-1)||new Vt(e)}static fromJSON(e,t){if(!t||!t.type)throw new RangeError("Invalid input for Selection.fromJSON");let s=Ta[t.type];if(!s)throw new RangeError(`No selection type ${t.type} defined`);return s.fromJSON(e,t)}static jsonID(e,t){if(e in Ta)throw new RangeError("Duplicate use of selection JSON ID "+e);return Ta[e]=t,t.prototype.jsonID=e,t}getBookmark(){return ye.between(this.$anchor,this.$head).getBookmark()}}de.prototype.visible=!0;class uC{constructor(e,t){this.$from=e,this.$to=t}}let Ld=!1;function Bd(n){!Ld&&!n.parent.inlineContent&&(Ld=!0,console.warn("TextSelection endpoint not pointing into a node with inline content ("+n.parent.type.name+")"))}class ye extends de{constructor(e,t=e){Bd(e),Bd(t),super(e,t)}get $cursor(){return this.$anchor.pos==this.$head.pos?this.$head:null}map(e,t){let s=e.resolve(t.map(this.head));if(!s.parent.inlineContent)return de.near(s);let i=e.resolve(t.map(this.anchor));return new ye(i.parent.inlineContent?i:s,s)}replace(e,t=q.empty){if(super.replace(e,t),t==q.empty){let s=this.$from.marksAcross(this.$to);s&&e.ensureMarks(s)}}eq(e){return e instanceof ye&&e.anchor==this.anchor&&e.head==this.head}getBookmark(){return new ia(this.anchor,this.head)}toJSON(){return{type:"text",anchor:this.anchor,head:this.head}}static fromJSON(e,t){if(typeof t.anchor!="number"||typeof t.head!="number")throw new RangeError("Invalid input for TextSelection.fromJSON");return new ye(e.resolve(t.anchor),e.resolve(t.head))}static create(e,t,s=t){let i=e.resolve(t);return new this(i,s==t?i:e.resolve(s))}static between(e,t,s){let i=e.pos-t.pos;if((!s||i)&&(s=i>=0?1:-1),!t.parent.inlineContent){let r=de.findFrom(t,s,!0)||de.findFrom(t,-s,!0);if(r)t=r.$head;else return de.near(t,s)}return e.parent.inlineContent||(i==0?e=t:(e=(de.findFrom(e,-s,!0)||de.findFrom(e,s,!0)).$anchor,e.pos<t.pos!=i<0&&(e=t))),new ye(e,t)}}de.jsonID("text",ye);class ia{constructor(e,t){this.anchor=e,this.head=t}map(e){return new ia(e.map(this.anchor),e.map(this.head))}resolve(e){return ye.between(e.resolve(this.anchor),e.resolve(this.head))}}class ie extends de{constructor(e){let t=e.nodeAfter,s=e.node(0).resolve(e.pos+t.nodeSize);super(e,s),this.node=t}map(e,t){let{deleted:s,pos:i}=t.mapResult(this.anchor),r=e.resolve(i);return s?de.near(r):new ie(r)}content(){return new q(P.from(this.node),0,0)}eq(e){return e instanceof ie&&e.anchor==this.anchor}toJSON(){return{type:"node",anchor:this.anchor}}getBookmark(){return new kc(this.anchor)}static fromJSON(e,t){if(typeof t.anchor!="number")throw new RangeError("Invalid input for NodeSelection.fromJSON");return new ie(e.resolve(t.anchor))}static create(e,t){return new ie(e.resolve(t))}static isSelectable(e){return!e.isText&&e.type.spec.selectable!==!1}}ie.prototype.visible=!1;de.jsonID("node",ie);class kc{constructor(e){this.anchor=e}map(e){let{deleted:t,pos:s}=e.mapResult(this.anchor);return t?new ia(s,s):new kc(s)}resolve(e){let t=e.resolve(this.anchor),s=t.nodeAfter;return s&&ie.isSelectable(s)?new ie(t):de.near(t)}}class Vt extends de{constructor(e){super(e.resolve(0),e.resolve(e.content.size))}replace(e,t=q.empty){if(t==q.empty){e.delete(0,e.doc.content.size);let s=de.atStart(e.doc);s.eq(e.selection)||e.setSelection(s)}else super.replace(e,t)}toJSON(){return{type:"all"}}static fromJSON(e){return new Vt(e)}map(e){return new Vt(e)}eq(e){return e instanceof Vt}getBookmark(){return hC}}de.jsonID("all",Vt);const hC={map(){return this},resolve(n){return new Vt(n)}};function gi(n,e,t,s,i,r=!1){if(e.inlineContent)return ye.create(n,t);for(let o=s-(i>0?0:1);i>0?o<e.childCount:o>=0;o+=i){let a=e.child(o);if(a.isAtom){if(!r&&ie.isSelectable(a))return ie.create(n,t-(i<0?a.nodeSize:0))}else{let l=gi(n,a,t+i,i<0?a.childCount:0,i,r);if(l)return l}t+=a.nodeSize*i}return null}function zd(n,e,t){let s=n.steps.length-1;if(s<e)return;let i=n.steps[s];if(!(i instanceof ut||i instanceof Ut))return;let r=n.mapping.maps[s],o;r.forEach((a,l,d,u)=>{o==null&&(o=u)}),n.setSelection(de.near(n.doc.resolve(o),t))}const Ud=1,Xr=2,Vd=4;class fC extends dC{constructor(e){super(e.doc),this.curSelectionFor=0,this.updated=0,this.meta=Object.create(null),this.time=Date.now(),this.curSelection=e.selection,this.storedMarks=e.storedMarks}get selection(){return this.curSelectionFor<this.steps.length&&(this.curSelection=this.curSelection.map(this.doc,this.mapping.slice(this.curSelectionFor)),this.curSelectionFor=this.steps.length),this.curSelection}setSelection(e){if(e.$from.doc!=this.doc)throw new RangeError("Selection passed to setSelection must point at the current document");return this.curSelection=e,this.curSelectionFor=this.steps.length,this.updated=(this.updated|Ud)&~Xr,this.storedMarks=null,this}get selectionSet(){return(this.updated&Ud)>0}setStoredMarks(e){return this.storedMarks=e,this.updated|=Xr,this}ensureMarks(e){return be.sameSet(this.storedMarks||this.selection.$from.marks(),e)||this.setStoredMarks(e),this}addStoredMark(e){return this.ensureMarks(e.addToSet(this.storedMarks||this.selection.$head.marks()))}removeStoredMark(e){return this.ensureMarks(e.removeFromSet(this.storedMarks||this.selection.$head.marks()))}get storedMarksSet(){return(this.updated&Xr)>0}addStep(e,t){super.addStep(e,t),this.updated=this.updated&~Xr,this.storedMarks=null}setTime(e){return this.time=e,this}replaceSelection(e){return this.selection.replace(this,e),this}replaceSelectionWith(e,t=!0){let s=this.selection;return t&&(e=e.mark(this.storedMarks||(s.empty?s.$from.marks():s.$from.marksAcross(s.$to)||be.none))),s.replaceWith(this,e),this}deleteSelection(){return this.selection.replace(this),this}insertText(e,t,s){let i=this.doc.type.schema;if(t==null)return e?this.replaceSelectionWith(i.text(e),!0):this.deleteSelection();{if(s==null&&(s=t),s=s??t,!e)return this.deleteRange(t,s);let r=this.storedMarks;if(!r){let o=this.doc.resolve(t);r=s==t?o.marks():o.marksAcross(this.doc.resolve(s))}return this.replaceRangeWith(t,s,i.text(e,r)),this.selection.empty||this.setSelection(de.near(this.selection.$to)),this}}setMeta(e,t){return this.meta[typeof e=="string"?e:e.key]=t,this}getMeta(e){return this.meta[typeof e=="string"?e:e.key]}get isGeneric(){for(let e in this.meta)return!1;return!0}scrollIntoView(){return this.updated|=Vd,this}get scrolledIntoView(){return(this.updated&Vd)>0}}function Wd(n,e){return!e||!n?n:n.bind(e)}class er{constructor(e,t,s){this.name=e,this.init=Wd(t.init,s),this.apply=Wd(t.apply,s)}}const pC=[new er("doc",{init(n){return n.doc||n.schema.topNodeType.createAndFill()},apply(n){return n.doc}}),new er("selection",{init(n,e){return n.selection||de.atStart(e.doc)},apply(n){return n.selection}}),new er("storedMarks",{init(n){return n.storedMarks||null},apply(n,e,t,s){return s.selection.$cursor?n.storedMarks:null}}),new er("scrollToSelection",{init(){return 0},apply(n,e){return n.scrolledIntoView?e+1:e}})];class _a{constructor(e,t){this.schema=e,this.plugins=[],this.pluginsByKey=Object.create(null),this.fields=pC.slice(),t&&t.forEach(s=>{if(this.pluginsByKey[s.key])throw new RangeError("Adding different instances of a keyed plugin ("+s.key+")");this.plugins.push(s),this.pluginsByKey[s.key]=s,s.spec.state&&this.fields.push(new er(s.key,s.spec.state,s))})}}class xi{constructor(e){this.config=e}get schema(){return this.config.schema}get plugins(){return this.config.plugins}apply(e){return this.applyTransaction(e).state}filterTransaction(e,t=-1){for(let s=0;s<this.config.plugins.length;s++)if(s!=t){let i=this.config.plugins[s];if(i.spec.filterTransaction&&!i.spec.filterTransaction.call(i,e,this))return!1}return!0}applyTransaction(e){if(!this.filterTransaction(e))return{state:this,transactions:[]};let t=[e],s=this.applyInner(e),i=null;for(;;){let r=!1;for(let o=0;o<this.config.plugins.length;o++){let a=this.config.plugins[o];if(a.spec.appendTransaction){let l=i?i[o].n:0,d=i?i[o].state:this,u=l<t.length&&a.spec.appendTransaction.call(a,l?t.slice(l):t,d,s);if(u&&s.filterTransaction(u,o)){if(u.setMeta("appendedTransaction",e),!i){i=[];for(let h=0;h<this.config.plugins.length;h++)i.push(h<o?{state:s,n:t.length}:{state:this,n:0})}t.push(u),s=s.applyInner(u),r=!0}i&&(i[o]={state:s,n:t.length})}}if(!r)return{state:s,transactions:t}}}applyInner(e){if(!e.before.eq(this.doc))throw new RangeError("Applying a mismatched transaction");let t=new xi(this.config),s=this.config.fields;for(let i=0;i<s.length;i++){let r=s[i];t[r.name]=r.apply(e,this[r.name],this,t)}return t}get tr(){return new fC(this)}static create(e){let t=new _a(e.doc?e.doc.type.schema:e.schema,e.plugins),s=new xi(t);for(let i=0;i<t.fields.length;i++)s[t.fields[i].name]=t.fields[i].init(e,s);return s}reconfigure(e){let t=new _a(this.schema,e.plugins),s=t.fields,i=new xi(t);for(let r=0;r<s.length;r++){let o=s[r].name;i[o]=this.hasOwnProperty(o)?this[o]:s[r].init(e,i)}return i}toJSON(e){let t={doc:this.doc.toJSON(),selection:this.selection.toJSON()};if(this.storedMarks&&(t.storedMarks=this.storedMarks.map(s=>s.toJSON())),e&&typeof e=="object")for(let s in e){if(s=="doc"||s=="selection")throw new RangeError("The JSON fields `doc` and `selection` are reserved");let i=e[s],r=i.spec.state;r&&r.toJSON&&(t[s]=r.toJSON.call(i,this[i.key]))}return t}static fromJSON(e,t,s){if(!t)throw new RangeError("Invalid input for EditorState.fromJSON");if(!e.schema)throw new RangeError("Required config field 'schema' missing");let i=new _a(e.schema,e.plugins),r=new xi(i);return i.fields.forEach(o=>{if(o.name=="doc")r.doc=vn.fromJSON(e.schema,t.doc);else if(o.name=="selection")r.selection=de.fromJSON(r.doc,t.selection);else if(o.name=="storedMarks")t.storedMarks&&(r.storedMarks=t.storedMarks.map(e.schema.markFromJSON));else{if(s)for(let a in s){let l=s[a],d=l.spec.state;if(l.key==o.name&&d&&d.fromJSON&&Object.prototype.hasOwnProperty.call(t,a)){r[o.name]=d.fromJSON.call(l,e,t[a],r);return}}r[o.name]=o.init(e,r)}}),r}}function vp(n,e,t){for(let s in n){let i=n[s];i instanceof Function?i=i.bind(e):s=="handleDOMEvents"&&(i=vp(i,e,{})),t[s]=i}return t}class _s{constructor(e){this.spec=e,this.props={},e.props&&vp(e.props,this,this.props),this.key=e.key?e.key.key:Mp("plugin")}getState(e){return e[this.key]}}const Na=Object.create(null);function Mp(n){return n in Na?n+"$"+ ++Na[n]:(Na[n]=0,n+"$")}class si{constructor(e="key"){this.key=Mp(e)}get(e){return e.config.pluginsByKey[this.key]}getState(e){return e[this.key]}}const Tp=new si("transactionEventPlugin"),rl="prosemirrorDispatchTransaction";function Hd(n,e){const{eventTarget:t}=Tp.getState(n.state);return t.addEventListener(rl,e),()=>{t.removeEventListener(rl,e)}}function mC(n){return new _s({key:Tp,state:{init(){return{eventTarget:n}},apply(e,t){return t}}})}const ho=new si("customKeymapPlugin");function gC(n,e){n.dispatch(n.state.tr.setMeta(ho,{handlers:e}))}function yC(n={handlers:{}}){return new _s({key:ho,state:{init(){return{...n}},apply(e,t){const s=e.getMeta(ho);return s?{...t,...s}:t}},props:{handleKeyDown(e,t){const i=ho.getState(e.state).handlers[t.key];return i?i(t):!1}}})}const _p=(n,e)=>n.selection.empty?!1:(e&&e(n.tr.deleteSelection().scrollIntoView()),!0);function xC(n,e){let{$cursor:t}=n.selection;return!t||(e?!e.endOfTextblock("backward",n):t.parentOffset>0)?null:t}const Np=(n,e,t)=>{let s=xC(n,t);if(!s)return!1;let i=Ep(s);if(!i){let o=s.blockRange(),a=o&&bc(o);return a==null?!1:(e&&e(n.tr.lift(o,a).scrollIntoView()),!0)}let r=i.nodeBefore;if(!r.type.spec.isolating&&Dp(n,i,e))return!0;if(s.parent.content.size==0&&(Oi(r,"end")||ie.isSelectable(r))){let o=Sc(n.doc,s.before(),s.after(),q.empty);if(o&&o.slice.size<o.to-o.from){if(e){let a=n.tr.step(o);a.setSelection(Oi(r,"end")?de.findFrom(a.doc.resolve(a.mapping.map(i.pos,-1)),-1):ie.create(a.doc,i.pos-r.nodeSize)),e(a.scrollIntoView())}return!0}}return r.isAtom&&i.depth==s.depth-1?(e&&e(n.tr.delete(i.pos-r.nodeSize,i.pos).scrollIntoView()),!0):!1};function Oi(n,e,t=!1){for(let s=n;s;s=e=="start"?s.firstChild:s.lastChild){if(s.isTextblock)return!0;if(t&&s.childCount!=1)return!1}return!1}const bC=(n,e,t)=>{let{$head:s,empty:i}=n.selection,r=s;if(!i)return!1;if(s.parent.isTextblock){if(t?!t.endOfTextblock("backward",n):s.parentOffset>0)return!1;r=Ep(s)}let o=r&&r.nodeBefore;return!o||!ie.isSelectable(o)?!1:(e&&e(n.tr.setSelection(ie.create(n.doc,r.pos-o.nodeSize)).scrollIntoView()),!0)};function Ep(n){if(!n.parent.type.spec.isolating)for(let e=n.depth-1;e>=0;e--){if(n.index(e)>0)return n.doc.resolve(n.before(e+1));if(n.node(e).type.spec.isolating)break}return null}function SC(n,e){let{$cursor:t}=n.selection;return!t||(e?!e.endOfTextblock("forward",n):t.parentOffset<t.parent.content.size)?null:t}const kC=(n,e,t)=>{let s=SC(n,t);if(!s)return!1;let i=Ip(s);if(!i)return!1;let r=i.nodeAfter;if(Dp(n,i,e))return!0;if(s.parent.content.size==0&&(Oi(r,"start")||ie.isSelectable(r))){let o=Sc(n.doc,s.before(),s.after(),q.empty);if(o&&o.slice.size<o.to-o.from){if(e){let a=n.tr.step(o);a.setSelection(Oi(r,"start")?de.findFrom(a.doc.resolve(a.mapping.map(i.pos)),1):ie.create(a.doc,a.mapping.map(i.pos))),e(a.scrollIntoView())}return!0}}return r.isAtom&&i.depth==s.depth-1?(e&&e(n.tr.delete(i.pos,i.pos+r.nodeSize).scrollIntoView()),!0):!1},wC=(n,e,t)=>{let{$head:s,empty:i}=n.selection,r=s;if(!i)return!1;if(s.parent.isTextblock){if(t?!t.endOfTextblock("forward",n):s.parentOffset<s.parent.content.size)return!1;r=Ip(s)}let o=r&&r.nodeAfter;return!o||!ie.isSelectable(o)?!1:(e&&e(n.tr.setSelection(ie.create(n.doc,r.pos)).scrollIntoView()),!0)};function Ip(n){if(!n.parent.type.spec.isolating)for(let e=n.depth-1;e>=0;e--){let t=n.node(e);if(n.index(e)+1<t.childCount)return n.doc.resolve(n.after(e+1));if(t.type.spec.isolating)break}return null}const CC=(n,e)=>{let{$head:t,$anchor:s}=n.selection;return!t.parent.type.spec.code||!t.sameParent(s)?!1:(e&&e(n.tr.insertText(`
`).scrollIntoView()),!0)};function wc(n){for(let e=0;e<n.edgeCount;e++){let{type:t}=n.edge(e);if(t.isTextblock&&!t.hasRequiredAttrs())return t}return null}const vC=(n,e)=>{let{$head:t,$anchor:s}=n.selection;if(!t.parent.type.spec.code||!t.sameParent(s))return!1;let i=t.node(-1),r=t.indexAfter(-1),o=wc(i.contentMatchAt(r));if(!o||!i.canReplaceWith(r,r,o))return!1;if(e){let a=t.after(),l=n.tr.replaceWith(a,a,o.createAndFill());l.setSelection(de.near(l.doc.resolve(a),1)),e(l.scrollIntoView())}return!0},Ap=(n,e)=>{let t=n.selection,{$from:s,$to:i}=t;if(t instanceof Vt||s.parent.inlineContent||i.parent.inlineContent)return!1;let r=wc(i.parent.contentMatchAt(i.indexAfter()));if(!r||!r.isTextblock)return!1;if(e){let o=(!s.parentOffset&&i.index()<i.parent.childCount?s:i).pos,a=n.tr.insert(o,r.createAndFill());a.setSelection(ye.create(a.doc,o+1)),e(a.scrollIntoView())}return!0},jp=(n,e)=>{let{$cursor:t}=n.selection;if(!t||t.parent.content.size)return!1;if(t.depth>1&&t.after()!=t.end(-1)){let r=t.before();if(uo(n.doc,r))return e&&e(n.tr.split(r).scrollIntoView()),!0}let s=t.blockRange(),i=s&&bc(s);return i==null?!1:(e&&e(n.tr.lift(s,i).scrollIntoView()),!0)};function MC(n){return(e,t)=>{let{$from:s,$to:i}=e.selection;if(e.selection instanceof ie&&e.selection.node.isBlock)return!s.parentOffset||!uo(e.doc,s.pos)?!1:(t&&t(e.tr.split(s.pos).scrollIntoView()),!0);if(!s.parent.isBlock)return!1;if(t){let r=i.parentOffset==i.parent.content.size,o=e.tr;(e.selection instanceof ye||e.selection instanceof Vt)&&o.deleteSelection();let a=s.depth==0?null:wc(s.node(-1).contentMatchAt(s.indexAfter(-1))),l=r&&a?[{type:a}]:void 0,d=uo(o.doc,o.mapping.map(s.pos),1,l);if(!l&&!d&&uo(o.doc,o.mapping.map(s.pos),1,a?[{type:a}]:void 0)&&(a&&(l=[{type:a}]),d=!0),d&&(o.split(o.mapping.map(s.pos),1,l),!r&&!s.parentOffset&&s.parent.type!=a)){let u=o.mapping.map(s.before()),h=o.doc.resolve(u);a&&s.node(-1).canReplaceWith(h.index(),h.index()+1,a)&&o.setNodeMarkup(o.mapping.map(s.before()),a)}t(o.scrollIntoView())}return!0}}const Rp=MC(),TC=(n,e)=>(e&&e(n.tr.setSelection(new Vt(n.doc))),!0);function _C(n,e,t){let s=e.nodeBefore,i=e.nodeAfter,r=e.index();return!s||!i||!s.type.compatibleContent(i.type)?!1:!s.content.size&&e.parent.canReplace(r-1,r)?(t&&t(n.tr.delete(e.pos-s.nodeSize,e.pos).scrollIntoView()),!0):!e.parent.canReplace(r,r+1)||!(i.isTextblock||bp(n.doc,e.pos))?!1:(t&&t(n.tr.clearIncompatible(e.pos,s.type,s.contentMatchAt(s.childCount)).join(e.pos).scrollIntoView()),!0)}function Dp(n,e,t){let s=e.nodeBefore,i=e.nodeAfter,r,o;if(s.type.spec.isolating||i.type.spec.isolating)return!1;if(_C(n,e,t))return!0;let a=e.parent.canReplace(e.index(),e.index()+1);if(a&&(r=(o=s.contentMatchAt(s.childCount)).findWrapping(i.type))&&o.matchType(r[0]||i.type).validEnd){if(t){let h=e.pos+i.nodeSize,f=P.empty;for(let g=r.length-1;g>=0;g--)f=P.from(r[g].create(null,f));f=P.from(s.copy(f));let m=n.tr.step(new Ut(e.pos-1,h,e.pos,h,new q(f,1,0),r.length,!0)),p=h+2*r.length;bp(m.doc,p)&&m.join(p),t(m.scrollIntoView())}return!0}let l=de.findFrom(e,1),d=l&&l.$from.blockRange(l.$to),u=d&&bc(d);if(u!=null&&u>=e.depth)return t&&t(n.tr.lift(d,u).scrollIntoView()),!0;if(a&&Oi(i,"start",!0)&&Oi(s,"end")){let h=s,f=[];for(;f.push(h),!h.isTextblock;)h=h.lastChild;let m=i,p=1;for(;!m.isTextblock;m=m.firstChild)p++;if(h.canReplace(h.childCount,h.childCount,m.content)){if(t){let g=P.empty;for(let x=f.length-1;x>=0;x--)g=P.from(f[x].copy(g));let S=n.tr.step(new Ut(e.pos-f.length,e.pos+i.nodeSize,e.pos+p,e.pos+i.nodeSize-p,new q(g,f.length,0),0,!0));t(S.scrollIntoView())}return!0}}return!1}function Op(n){return function(e,t){let s=e.selection,i=n<0?s.$from:s.$to,r=i.depth;for(;i.node(r).isInline;){if(!r)return!1;r--}return i.node(r).isTextblock?(t&&t(e.tr.setSelection(ye.create(e.doc,n<0?i.start(r):i.end(r)))),!0):!1}}const NC=Op(-1),EC=Op(1);function gE(n,e=null){return function(t,s){let{$from:i,$to:r}=t.selection,o=i.blockRange(r),a=o&&Hw(o,n,e);return a?(s&&s(t.tr.wrap(o,a).scrollIntoView()),!0):!1}}function yE(n,e=null){return function(t,s){let i=!1;for(let r=0;r<t.selection.ranges.length&&!i;r++){let{$from:{pos:o},$to:{pos:a}}=t.selection.ranges[r];t.doc.nodesBetween(o,a,(l,d)=>{if(i)return!1;if(!(!l.isTextblock||l.hasMarkup(n,e)))if(l.type==n)i=!0;else{let u=t.doc.resolve(d),h=u.index();i=u.parent.canReplaceWith(h,h+1,n)}})}if(!i)return!1;if(s){let r=t.tr;for(let o=0;o<t.selection.ranges.length;o++){let{$from:{pos:a},$to:{pos:l}}=t.selection.ranges[o];r.setBlockType(a,l,n,e)}s(r.scrollIntoView())}return!0}}function IC(n,e,t){for(let s=0;s<e.length;s++){let{$from:i,$to:r}=e[s],o=i.depth==0?n.inlineContent&&n.type.allowsMarkType(t):!1;if(n.nodesBetween(i.pos,r.pos,a=>{if(o)return!1;o=a.inlineContent&&a.type.allowsMarkType(t)}),o)return!0}return!1}function xE(n,e=null){return function(t,s){let{empty:i,$cursor:r,ranges:o}=t.selection;if(i&&!r||!IC(t.doc,o,n))return!1;if(s)if(r)n.isInSet(t.storedMarks||r.marks())?s(t.tr.removeStoredMark(n)):s(t.tr.addStoredMark(n.create(e)));else{let a=!1,l=t.tr;for(let d=0;!a&&d<o.length;d++){let{$from:u,$to:h}=o[d];a=t.doc.rangeHasMark(u.pos,h.pos,n)}for(let d=0;d<o.length;d++){let{$from:u,$to:h}=o[d];if(a)l.removeMark(u.pos,h.pos,n);else{let f=u.pos,m=h.pos,p=u.nodeAfter,g=h.nodeBefore,S=p&&p.isText?/^\s*/.exec(p.text)[0].length:0,x=g&&g.isText?/\s*$/.exec(g.text)[0].length:0;f+S<m&&(f+=S,m-=x),l.addMark(f,m,n.create(e))}}s(l.scrollIntoView())}return!0}}function ra(...n){return function(e,t,s){for(let i=0;i<n.length;i++)if(n[i](e,t,s))return!0;return!1}}let Ea=ra(_p,Np,bC),Gd=ra(_p,kC,wC);const Wn={Enter:ra(CC,Ap,jp,Rp),"Mod-Enter":vC,Backspace:Ea,"Mod-Backspace":Ea,"Shift-Backspace":Ea,Delete:Gd,"Mod-Delete":Gd,"Mod-a":TC},Pp={"Ctrl-h":Wn.Backspace,"Alt-Backspace":Wn["Mod-Backspace"],"Ctrl-d":Wn.Delete,"Ctrl-Alt-Backspace":Wn["Mod-Delete"],"Alt-Delete":Wn["Mod-Delete"],"Alt-d":Wn["Mod-Delete"],"Ctrl-a":NC,"Ctrl-e":EC};for(let n in Wn)Pp[n]=Wn[n];const AC=typeof navigator<"u"?/Mac|iP(hone|[oa]d)/.test(navigator.platform):typeof os<"u"&&os.platform?os.platform()=="darwin":!1,jC=AC?Pp:Wn;function Fp(n){let e="",t=!1;const s=[];function i(r){if(t=!1,r.type.name==="paragraph")return r.descendants(o=>i(o)),e+=`
`,t=!0,!1;if(r.type.name==="command_token"){const o=r.textContent;return s.push({symbol:mb.SystemHint,startIndex:e.length,endIndex:e.length+o.length}),e+=o,!1}else r.isText&&r.text!==void 0&&(e+=r.text)}return n.descendants(r=>i(r)),t&&e.endsWith(`
`)&&(e=e.slice(0,-1)),{content:e,metadata:{custom_symbol_offsets:s}}}function RC(n){return Fp(n.state.doc)}const ol=ra(Ap,jp,Rp);async function DC(n,e){const{schema:t}=n.state,s=e.split(`
`);if(n.dispatch(n.state.tr.deleteSelection()),n.dispatch(n.state.tr.insertText(s[0])),s.length>1){ol(n.state,n.dispatch);const i=s.slice(1),r=P.fromArray(i.map(a=>t.nodes.paragraph.create(null,a===""?null:t.text(a)))),o=new q(r,0,0);n.dispatch(n.state.tr.replaceSelection(o)),Np(n.state,n.dispatch,n)}}const zs=new si("menuSelectorPlugin");function bi(n){n.dispatch(n.state.tr.setMeta(zs,{active:!1,onMenuAction:void 0}))}function OC(n,e){n.dispatch(n.state.tr.setMeta(zs,{active:!0,onMenuAction:e}))}function PC(n={submitKeys:["Enter","Tab"],cancelKeys:["Escape"],checkStrictMatchKeys:[]}){return new _s({key:zs,state:{init(){return{...n,active:!1}},apply(e,t){const s=e.getMeta(zs);return s?{...t,...s}:t}},props:{handleKeyDown(e,t){var i,r,o,a,l;const s=zs.getState(e.state);return s.active?s.submitKeys.includes(t.key)?(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),(i=s.onMenuAction)==null||i.call(s,"submit"),bi(e),!0):s.cancelKeys.includes(t.key)?(t.preventDefault(),(r=s.onMenuAction)==null||r.call(s,"cancel"),bi(e),!0):t.key==="ArrowUp"?(t.preventDefault(),(o=s.onMenuAction)==null||o.call(s,"up"),!0):t.key==="ArrowDown"?(t.preventDefault(),(a=s.onMenuAction)==null||a.call(s,"down"),!0):(s.checkStrictMatchKeys.includes(t.key)&&((l=s.onMenuAction)==null||l.call(s,"checkMatch")),!1):!1},handleDOMEvents:{blur:e=>{var s;const t=zs.getState(e.state);(s=t.onMenuAction)==null||s.call(t,"cancel")}}}})}const rt=function(n){for(var e=0;;e++)if(n=n.previousSibling,!n)return e},Sr=function(n){let e=n.assignedSlot||n.parentNode;return e&&e.nodeType==11?e.host:e};let al=null;const Un=function(n,e,t){let s=al||(al=document.createRange());return s.setEnd(n,t??n.nodeValue.length),s.setStart(n,e||0),s},FC=function(){al=null},Xs=function(n,e,t,s){return t&&(qd(n,e,t,s,-1)||qd(n,e,t,s,1))},LC=/^(img|br|input|textarea|hr)$/i;function qd(n,e,t,s,i){for(;;){if(n==t&&e==s)return!0;if(e==(i<0?0:Sn(n))){let r=n.parentNode;if(!r||r.nodeType!=1||Lr(n)||LC.test(n.nodeName)||n.contentEditable=="false")return!1;e=rt(n)+(i<0?0:1),n=r}else if(n.nodeType==1){if(n=n.childNodes[e+(i<0?-1:0)],n.contentEditable=="false")return!1;e=i<0?Sn(n):0}else return!1}}function Sn(n){return n.nodeType==3?n.nodeValue.length:n.childNodes.length}function BC(n,e){for(;;){if(n.nodeType==3&&e)return n;if(n.nodeType==1&&e>0){if(n.contentEditable=="false")return null;n=n.childNodes[e-1],e=Sn(n)}else if(n.parentNode&&!Lr(n))e=rt(n),n=n.parentNode;else return null}}function zC(n,e){for(;;){if(n.nodeType==3&&e<n.nodeValue.length)return n;if(n.nodeType==1&&e<n.childNodes.length){if(n.contentEditable=="false")return null;n=n.childNodes[e],e=0}else if(n.parentNode&&!Lr(n))e=rt(n)+1,n=n.parentNode;else return null}}function UC(n,e,t){for(let s=e==0,i=e==Sn(n);s||i;){if(n==t)return!0;let r=rt(n);if(n=n.parentNode,!n)return!1;s=s&&r==0,i=i&&r==Sn(n)}}function Lr(n){let e;for(let t=n;t&&!(e=t.pmViewDesc);t=t.parentNode);return e&&e.node&&e.node.isBlock&&(e.dom==n||e.contentDOM==n)}const oa=function(n){return n.focusNode&&Xs(n.focusNode,n.focusOffset,n.anchorNode,n.anchorOffset)};function Ls(n,e){let t=document.createEvent("Event");return t.initEvent("keydown",!0,!0),t.keyCode=n,t.key=t.code=e,t}function VC(n){let e=n.activeElement;for(;e&&e.shadowRoot;)e=e.shadowRoot.activeElement;return e}function WC(n,e,t){if(n.caretPositionFromPoint)try{let s=n.caretPositionFromPoint(e,t);if(s)return{node:s.offsetNode,offset:s.offset}}catch{}if(n.caretRangeFromPoint){let s=n.caretRangeFromPoint(e,t);if(s)return{node:s.startContainer,offset:s.startOffset}}}const Tn=typeof navigator<"u"?navigator:null,$d=typeof document<"u"?document:null,Ns=Tn&&Tn.userAgent||"",ll=/Edge\/(\d+)/.exec(Ns),Lp=/MSIE \d/.exec(Ns),cl=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(Ns),Mt=!!(Lp||cl||ll),ys=Lp?document.documentMode:cl?+cl[1]:ll?+ll[1]:0,mn=!Mt&&/gecko\/(\d+)/i.test(Ns);mn&&+(/Firefox\/(\d+)/.exec(Ns)||[0,0])[1];const dl=!Mt&&/Chrome\/(\d+)/.exec(Ns),ht=!!dl,Bp=dl?+dl[1]:0,St=!Mt&&!!Tn&&/Apple Computer/.test(Tn.vendor),Pi=St&&(/Mobile\/\w+/.test(Ns)||!!Tn&&Tn.maxTouchPoints>2),Yt=Pi||(Tn?/Mac/.test(Tn.platform):!1),HC=Tn?/Win/.test(Tn.platform):!1,un=/Android \d/.test(Ns),Br=!!$d&&"webkitFontSmoothing"in $d.documentElement.style,GC=Br?+(/\bAppleWebKit\/(\d+)/.exec(navigator.userAgent)||[0,0])[1]:0;function qC(n){let e=n.defaultView&&n.defaultView.visualViewport;return e?{left:0,right:e.width,top:0,bottom:e.height}:{left:0,right:n.documentElement.clientWidth,top:0,bottom:n.documentElement.clientHeight}}function zn(n,e){return typeof n=="number"?n:n[e]}function $C(n){let e=n.getBoundingClientRect(),t=e.width/n.offsetWidth||1,s=e.height/n.offsetHeight||1;return{left:e.left,right:e.left+n.clientWidth*t,top:e.top,bottom:e.top+n.clientHeight*s}}function Kd(n,e,t){let s=n.someProp("scrollThreshold")||0,i=n.someProp("scrollMargin")||5,r=n.dom.ownerDocument;for(let o=t||n.dom;o;o=Sr(o)){if(o.nodeType!=1)continue;let a=o,l=a==r.body,d=l?qC(r):$C(a),u=0,h=0;if(e.top<d.top+zn(s,"top")?h=-(d.top-e.top+zn(i,"top")):e.bottom>d.bottom-zn(s,"bottom")&&(h=e.bottom-e.top>d.bottom-d.top?e.top+zn(i,"top")-d.top:e.bottom-d.bottom+zn(i,"bottom")),e.left<d.left+zn(s,"left")?u=-(d.left-e.left+zn(i,"left")):e.right>d.right-zn(s,"right")&&(u=e.right-d.right+zn(i,"right")),u||h)if(l)r.defaultView.scrollBy(u,h);else{let f=a.scrollLeft,m=a.scrollTop;h&&(a.scrollTop+=h),u&&(a.scrollLeft+=u);let p=a.scrollLeft-f,g=a.scrollTop-m;e={left:e.left-p,top:e.top-g,right:e.right-p,bottom:e.bottom-g}}if(l||/^(fixed|sticky)$/.test(getComputedStyle(o).position))break}}function KC(n){let e=n.dom.getBoundingClientRect(),t=Math.max(0,e.top),s,i;for(let r=(e.left+e.right)/2,o=t+1;o<Math.min(innerHeight,e.bottom);o+=5){let a=n.root.elementFromPoint(r,o);if(!a||a==n.dom||!n.dom.contains(a))continue;let l=a.getBoundingClientRect();if(l.top>=t-20){s=a,i=l.top;break}}return{refDOM:s,refTop:i,stack:zp(n.dom)}}function zp(n){let e=[],t=n.ownerDocument;for(let s=n;s&&(e.push({dom:s,top:s.scrollTop,left:s.scrollLeft}),n!=t);s=Sr(s));return e}function JC({refDOM:n,refTop:e,stack:t}){let s=n?n.getBoundingClientRect().top:0;Up(t,s==0?0:s-e)}function Up(n,e){for(let t=0;t<n.length;t++){let{dom:s,top:i,left:r}=n[t];s.scrollTop!=i+e&&(s.scrollTop=i+e),s.scrollLeft!=r&&(s.scrollLeft=r)}}let hi=null;function YC(n){if(n.setActive)return n.setActive();if(hi)return n.focus(hi);let e=zp(n);n.focus(hi==null?{get preventScroll(){return hi={preventScroll:!0},!0}}:void 0),hi||(hi=!1,Up(e,0))}function Vp(n,e){let t,s=2e8,i,r=0,o=e.top,a=e.top,l,d;for(let u=n.firstChild,h=0;u;u=u.nextSibling,h++){let f;if(u.nodeType==1)f=u.getClientRects();else if(u.nodeType==3)f=Un(u).getClientRects();else continue;for(let m=0;m<f.length;m++){let p=f[m];if(p.top<=o&&p.bottom>=a){o=Math.max(p.bottom,o),a=Math.min(p.top,a);let g=p.left>e.left?p.left-e.left:p.right<e.left?e.left-p.right:0;if(g<s){t=u,s=g,i=g&&t.nodeType==3?{left:p.right<e.left?p.right:p.left,top:e.top}:e,u.nodeType==1&&g&&(r=h+(e.left>=(p.left+p.right)/2?1:0));continue}}else p.top>e.top&&!l&&p.left<=e.left&&p.right>=e.left&&(l=u,d={left:Math.max(p.left,Math.min(p.right,e.left)),top:p.top});!t&&(e.left>=p.right&&e.top>=p.top||e.left>=p.left&&e.top>=p.bottom)&&(r=h+1)}}return!t&&l&&(t=l,i=d,s=0),t&&t.nodeType==3?QC(t,i):!t||s&&t.nodeType==1?{node:n,offset:r}:Vp(t,i)}function QC(n,e){let t=n.nodeValue.length,s=document.createRange();for(let i=0;i<t;i++){s.setEnd(n,i+1),s.setStart(n,i);let r=ns(s,1);if(r.top!=r.bottom&&Cc(e,r))return{node:n,offset:i+(e.left>=(r.left+r.right)/2?1:0)}}return{node:n,offset:0}}function Cc(n,e){return n.left>=e.left-1&&n.left<=e.right+1&&n.top>=e.top-1&&n.top<=e.bottom+1}function XC(n,e){let t=n.parentNode;return t&&/^li$/i.test(t.nodeName)&&e.left<n.getBoundingClientRect().left?t:n}function ZC(n,e,t){let{node:s,offset:i}=Vp(e,t),r=-1;if(s.nodeType==1&&!s.firstChild){let o=s.getBoundingClientRect();r=o.left!=o.right&&t.left>(o.left+o.right)/2?1:-1}return n.docView.posFromDOM(s,i,r)}function ev(n,e,t,s){let i=-1;for(let r=e,o=!1;r!=n.dom;){let a=n.docView.nearestDesc(r,!0);if(!a)return null;if(a.dom.nodeType==1&&(a.node.isBlock&&a.parent||!a.contentDOM)){let l=a.dom.getBoundingClientRect();if(a.node.isBlock&&a.parent&&(!o&&l.left>s.left||l.top>s.top?i=a.posBefore:(!o&&l.right<s.left||l.bottom<s.top)&&(i=a.posAfter),o=!0),!a.contentDOM&&i<0&&!a.node.isText)return(a.node.isBlock?s.top<(l.top+l.bottom)/2:s.left<(l.left+l.right)/2)?a.posBefore:a.posAfter}r=a.dom.parentNode}return i>-1?i:n.docView.posFromDOM(e,t,-1)}function Wp(n,e,t){let s=n.childNodes.length;if(s&&t.top<t.bottom)for(let i=Math.max(0,Math.min(s-1,Math.floor(s*(e.top-t.top)/(t.bottom-t.top))-2)),r=i;;){let o=n.childNodes[r];if(o.nodeType==1){let a=o.getClientRects();for(let l=0;l<a.length;l++){let d=a[l];if(Cc(e,d))return Wp(o,e,d)}}if((r=(r+1)%s)==i)break}return n}function tv(n,e){let t=n.dom.ownerDocument,s,i=0,r=WC(t,e.left,e.top);r&&({node:s,offset:i}=r);let o=(n.root.elementFromPoint?n.root:t).elementFromPoint(e.left,e.top),a;if(!o||!n.dom.contains(o.nodeType!=1?o.parentNode:o)){let d=n.dom.getBoundingClientRect();if(!Cc(e,d)||(o=Wp(n.dom,e,d),!o))return null}if(St)for(let d=o;s&&d;d=Sr(d))d.draggable&&(s=void 0);if(o=XC(o,e),s){if(mn&&s.nodeType==1&&(i=Math.min(i,s.childNodes.length),i<s.childNodes.length)){let u=s.childNodes[i],h;u.nodeName=="IMG"&&(h=u.getBoundingClientRect()).right<=e.left&&h.bottom>e.top&&i++}let d;Br&&i&&s.nodeType==1&&(d=s.childNodes[i-1]).nodeType==1&&d.contentEditable=="false"&&d.getBoundingClientRect().top>=e.top&&i--,s==n.dom&&i==s.childNodes.length-1&&s.lastChild.nodeType==1&&e.top>s.lastChild.getBoundingClientRect().bottom?a=n.state.doc.content.size:(i==0||s.nodeType!=1||s.childNodes[i-1].nodeName!="BR")&&(a=ev(n,s,i,e))}a==null&&(a=ZC(n,o,e));let l=n.docView.nearestDesc(o,!0);return{pos:a,inside:l?l.posAtStart-l.border:-1}}function Jd(n){return n.top<n.bottom||n.left<n.right}function ns(n,e){let t=n.getClientRects();if(t.length){let s=t[e<0?0:t.length-1];if(Jd(s))return s}return Array.prototype.find.call(t,Jd)||n.getBoundingClientRect()}const nv=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/;function Hp(n,e,t){let{node:s,offset:i,atom:r}=n.docView.domFromPos(e,t<0?-1:1),o=Br||mn;if(s.nodeType==3)if(o&&(nv.test(s.nodeValue)||(t<0?!i:i==s.nodeValue.length))){let l=ns(Un(s,i,i),t);if(mn&&i&&/\s/.test(s.nodeValue[i-1])&&i<s.nodeValue.length){let d=ns(Un(s,i-1,i-1),-1);if(d.top==l.top){let u=ns(Un(s,i,i+1),-1);if(u.top!=l.top)return Ji(u,u.left<d.left)}}return l}else{let l=i,d=i,u=t<0?1:-1;return t<0&&!i?(d++,u=-1):t>=0&&i==s.nodeValue.length?(l--,u=1):t<0?l--:d++,Ji(ns(Un(s,l,d),u),u<0)}if(!n.state.doc.resolve(e-(r||0)).parent.inlineContent){if(r==null&&i&&(t<0||i==Sn(s))){let l=s.childNodes[i-1];if(l.nodeType==1)return Ia(l.getBoundingClientRect(),!1)}if(r==null&&i<Sn(s)){let l=s.childNodes[i];if(l.nodeType==1)return Ia(l.getBoundingClientRect(),!0)}return Ia(s.getBoundingClientRect(),t>=0)}if(r==null&&i&&(t<0||i==Sn(s))){let l=s.childNodes[i-1],d=l.nodeType==3?Un(l,Sn(l)-(o?0:1)):l.nodeType==1&&(l.nodeName!="BR"||!l.nextSibling)?l:null;if(d)return Ji(ns(d,1),!1)}if(r==null&&i<Sn(s)){let l=s.childNodes[i];for(;l.pmViewDesc&&l.pmViewDesc.ignoreForCoords;)l=l.nextSibling;let d=l?l.nodeType==3?Un(l,0,o?0:1):l.nodeType==1?l:null:null;if(d)return Ji(ns(d,-1),!0)}return Ji(ns(s.nodeType==3?Un(s):s,-t),t>=0)}function Ji(n,e){if(n.width==0)return n;let t=e?n.left:n.right;return{top:n.top,bottom:n.bottom,left:t,right:t}}function Ia(n,e){if(n.height==0)return n;let t=e?n.top:n.bottom;return{top:t,bottom:t,left:n.left,right:n.right}}function Gp(n,e,t){let s=n.state,i=n.root.activeElement;s!=e&&n.updateState(e),i!=n.dom&&n.focus();try{return t()}finally{s!=e&&n.updateState(s),i!=n.dom&&i&&i.focus()}}function sv(n,e,t){let s=e.selection,i=t=="up"?s.$from:s.$to;return Gp(n,e,()=>{let{node:r}=n.docView.domFromPos(i.pos,t=="up"?-1:1);for(;;){let a=n.docView.nearestDesc(r,!0);if(!a)break;if(a.node.isBlock){r=a.contentDOM||a.dom;break}r=a.dom.parentNode}let o=Hp(n,i.pos,1);for(let a=r.firstChild;a;a=a.nextSibling){let l;if(a.nodeType==1)l=a.getClientRects();else if(a.nodeType==3)l=Un(a,0,a.nodeValue.length).getClientRects();else continue;for(let d=0;d<l.length;d++){let u=l[d];if(u.bottom>u.top+1&&(t=="up"?o.top-u.top>(u.bottom-o.top)*2:u.bottom-o.bottom>(o.bottom-u.top)*2))return!1}}return!0})}const iv=/[\u0590-\u08ac]/;function rv(n,e,t){let{$head:s}=e.selection;if(!s.parent.isTextblock)return!1;let i=s.parentOffset,r=!i,o=i==s.parent.content.size,a=n.domSelection();return!iv.test(s.parent.textContent)||!a.modify?t=="left"||t=="backward"?r:o:Gp(n,e,()=>{let{focusNode:l,focusOffset:d,anchorNode:u,anchorOffset:h}=n.domSelectionRange(),f=a.caretBidiLevel;a.modify("move",t,"character");let m=s.depth?n.docView.domAfterPos(s.before()):n.dom,{focusNode:p,focusOffset:g}=n.domSelectionRange(),S=p&&!m.contains(p.nodeType==1?p:p.parentNode)||l==p&&d==g;try{a.collapse(u,h),l&&(l!=u||d!=h)&&a.extend&&a.extend(l,d)}catch{}return f!=null&&(a.caretBidiLevel=f),S})}let Yd=null,Qd=null,Xd=!1;function ov(n,e,t){return Yd==e&&Qd==t?Xd:(Yd=e,Qd=t,Xd=t=="up"||t=="down"?sv(n,e,t):rv(n,e,t))}const Xt=0,Zd=1,Us=2,_n=3;class zr{constructor(e,t,s,i){this.parent=e,this.children=t,this.dom=s,this.contentDOM=i,this.dirty=Xt,s.pmViewDesc=this}matchesWidget(e){return!1}matchesMark(e){return!1}matchesNode(e,t,s){return!1}matchesHack(e){return!1}parseRule(){return null}stopEvent(e){return!1}get size(){let e=0;for(let t=0;t<this.children.length;t++)e+=this.children[t].size;return e}get border(){return 0}destroy(){this.parent=void 0,this.dom.pmViewDesc==this&&(this.dom.pmViewDesc=void 0);for(let e=0;e<this.children.length;e++)this.children[e].destroy()}posBeforeChild(e){for(let t=0,s=this.posAtStart;;t++){let i=this.children[t];if(i==e)return s;s+=i.size}}get posBefore(){return this.parent.posBeforeChild(this)}get posAtStart(){return this.parent?this.parent.posBeforeChild(this)+this.border:0}get posAfter(){return this.posBefore+this.size}get posAtEnd(){return this.posAtStart+this.size-2*this.border}localPosFromDOM(e,t,s){if(this.contentDOM&&this.contentDOM.contains(e.nodeType==1?e:e.parentNode))if(s<0){let r,o;if(e==this.contentDOM)r=e.childNodes[t-1];else{for(;e.parentNode!=this.contentDOM;)e=e.parentNode;r=e.previousSibling}for(;r&&!((o=r.pmViewDesc)&&o.parent==this);)r=r.previousSibling;return r?this.posBeforeChild(o)+o.size:this.posAtStart}else{let r,o;if(e==this.contentDOM)r=e.childNodes[t];else{for(;e.parentNode!=this.contentDOM;)e=e.parentNode;r=e.nextSibling}for(;r&&!((o=r.pmViewDesc)&&o.parent==this);)r=r.nextSibling;return r?this.posBeforeChild(o):this.posAtEnd}let i;if(e==this.dom&&this.contentDOM)i=t>rt(this.contentDOM);else if(this.contentDOM&&this.contentDOM!=this.dom&&this.dom.contains(this.contentDOM))i=e.compareDocumentPosition(this.contentDOM)&2;else if(this.dom.firstChild){if(t==0)for(let r=e;;r=r.parentNode){if(r==this.dom){i=!1;break}if(r.previousSibling)break}if(i==null&&t==e.childNodes.length)for(let r=e;;r=r.parentNode){if(r==this.dom){i=!0;break}if(r.nextSibling)break}}return i??s>0?this.posAtEnd:this.posAtStart}nearestDesc(e,t=!1){for(let s=!0,i=e;i;i=i.parentNode){let r=this.getDesc(i),o;if(r&&(!t||r.node))if(s&&(o=r.nodeDOM)&&!(o.nodeType==1?o.contains(e.nodeType==1?e:e.parentNode):o==e))s=!1;else return r}}getDesc(e){let t=e.pmViewDesc;for(let s=t;s;s=s.parent)if(s==this)return t}posFromDOM(e,t,s){for(let i=e;i;i=i.parentNode){let r=this.getDesc(i);if(r)return r.localPosFromDOM(e,t,s)}return-1}descAt(e){for(let t=0,s=0;t<this.children.length;t++){let i=this.children[t],r=s+i.size;if(s==e&&r!=s){for(;!i.border&&i.children.length;)i=i.children[0];return i}if(e<r)return i.descAt(e-s-i.border);s=r}}domFromPos(e,t){if(!this.contentDOM)return{node:this.dom,offset:0,atom:e+1};let s=0,i=0;for(let r=0;s<this.children.length;s++){let o=this.children[s],a=r+o.size;if(a>e||o instanceof $p){i=e-r;break}r=a}if(i)return this.children[s].domFromPos(i-this.children[s].border,t);for(let r;s&&!(r=this.children[s-1]).size&&r instanceof qp&&r.side>=0;s--);if(t<=0){let r,o=!0;for(;r=s?this.children[s-1]:null,!(!r||r.dom.parentNode==this.contentDOM);s--,o=!1);return r&&t&&o&&!r.border&&!r.domAtom?r.domFromPos(r.size,t):{node:this.contentDOM,offset:r?rt(r.dom)+1:0}}else{let r,o=!0;for(;r=s<this.children.length?this.children[s]:null,!(!r||r.dom.parentNode==this.contentDOM);s++,o=!1);return r&&o&&!r.border&&!r.domAtom?r.domFromPos(0,t):{node:this.contentDOM,offset:r?rt(r.dom):this.contentDOM.childNodes.length}}}parseRange(e,t,s=0){if(this.children.length==0)return{node:this.contentDOM,from:e,to:t,fromOffset:0,toOffset:this.contentDOM.childNodes.length};let i=-1,r=-1;for(let o=s,a=0;;a++){let l=this.children[a],d=o+l.size;if(i==-1&&e<=d){let u=o+l.border;if(e>=u&&t<=d-l.border&&l.node&&l.contentDOM&&this.contentDOM.contains(l.contentDOM))return l.parseRange(e,t,u);e=o;for(let h=a;h>0;h--){let f=this.children[h-1];if(f.size&&f.dom.parentNode==this.contentDOM&&!f.emptyChildAt(1)){i=rt(f.dom)+1;break}e-=f.size}i==-1&&(i=0)}if(i>-1&&(d>t||a==this.children.length-1)){t=d;for(let u=a+1;u<this.children.length;u++){let h=this.children[u];if(h.size&&h.dom.parentNode==this.contentDOM&&!h.emptyChildAt(-1)){r=rt(h.dom);break}t+=h.size}r==-1&&(r=this.contentDOM.childNodes.length);break}o=d}return{node:this.contentDOM,from:e,to:t,fromOffset:i,toOffset:r}}emptyChildAt(e){if(this.border||!this.contentDOM||!this.children.length)return!1;let t=this.children[e<0?0:this.children.length-1];return t.size==0||t.emptyChildAt(e)}domAfterPos(e){let{node:t,offset:s}=this.domFromPos(e,0);if(t.nodeType!=1||s==t.childNodes.length)throw new RangeError("No node after pos "+e);return t.childNodes[s]}setSelection(e,t,s,i=!1){let r=Math.min(e,t),o=Math.max(e,t);for(let f=0,m=0;f<this.children.length;f++){let p=this.children[f],g=m+p.size;if(r>m&&o<g)return p.setSelection(e-m-p.border,t-m-p.border,s,i);m=g}let a=this.domFromPos(e,e?-1:1),l=t==e?a:this.domFromPos(t,t?-1:1),d=s.getSelection(),u=!1;if((mn||St)&&e==t){let{node:f,offset:m}=a;if(f.nodeType==3){if(u=!!(m&&f.nodeValue[m-1]==`
`),u&&m==f.nodeValue.length)for(let p=f,g;p;p=p.parentNode){if(g=p.nextSibling){g.nodeName=="BR"&&(a=l={node:g.parentNode,offset:rt(g)+1});break}let S=p.pmViewDesc;if(S&&S.node&&S.node.isBlock)break}}else{let p=f.childNodes[m-1];u=p&&(p.nodeName=="BR"||p.contentEditable=="false")}}if(mn&&d.focusNode&&d.focusNode!=l.node&&d.focusNode.nodeType==1){let f=d.focusNode.childNodes[d.focusOffset];f&&f.contentEditable=="false"&&(i=!0)}if(!(i||u&&St)&&Xs(a.node,a.offset,d.anchorNode,d.anchorOffset)&&Xs(l.node,l.offset,d.focusNode,d.focusOffset))return;let h=!1;if((d.extend||e==t)&&!u){d.collapse(a.node,a.offset);try{e!=t&&d.extend(l.node,l.offset),h=!0}catch{}}if(!h){if(e>t){let m=a;a=l,l=m}let f=document.createRange();f.setEnd(l.node,l.offset),f.setStart(a.node,a.offset),d.removeAllRanges(),d.addRange(f)}}ignoreMutation(e){return!this.contentDOM&&e.type!="selection"}get contentLost(){return this.contentDOM&&this.contentDOM!=this.dom&&!this.dom.contains(this.contentDOM)}markDirty(e,t){for(let s=0,i=0;i<this.children.length;i++){let r=this.children[i],o=s+r.size;if(s==o?e<=o&&t>=s:e<o&&t>s){let a=s+r.border,l=o-r.border;if(e>=a&&t<=l){this.dirty=e==s||t==o?Us:Zd,e==a&&t==l&&(r.contentLost||r.dom.parentNode!=this.contentDOM)?r.dirty=_n:r.markDirty(e-a,t-a);return}else r.dirty=r.dom==r.contentDOM&&r.dom.parentNode==this.contentDOM&&!r.children.length?Us:_n}s=o}this.dirty=Us}markParentsDirty(){let e=1;for(let t=this.parent;t;t=t.parent,e++){let s=e==1?Us:Zd;t.dirty<s&&(t.dirty=s)}}get domAtom(){return!1}get ignoreForCoords(){return!1}isText(e){return!1}}class qp extends zr{constructor(e,t,s,i){let r,o=t.type.toDOM;if(typeof o=="function"&&(o=o(s,()=>{if(!r)return i;if(r.parent)return r.parent.posBeforeChild(r)})),!t.type.spec.raw){if(o.nodeType!=1){let a=document.createElement("span");a.appendChild(o),o=a}o.contentEditable="false",o.classList.add("ProseMirror-widget")}super(e,[],o,null),this.widget=t,this.widget=t,r=this}matchesWidget(e){return this.dirty==Xt&&e.type.eq(this.widget.type)}parseRule(){return{ignore:!0}}stopEvent(e){let t=this.widget.spec.stopEvent;return t?t(e):!1}ignoreMutation(e){return e.type!="selection"||this.widget.spec.ignoreSelection}destroy(){this.widget.type.destroy(this.dom),super.destroy()}get domAtom(){return!0}get side(){return this.widget.type.side}}class av extends zr{constructor(e,t,s,i){super(e,[],t,null),this.textDOM=s,this.text=i}get size(){return this.text.length}localPosFromDOM(e,t){return e!=this.textDOM?this.posAtStart+(t?this.size:0):this.posAtStart+t}domFromPos(e){return{node:this.textDOM,offset:e}}ignoreMutation(e){return e.type==="characterData"&&e.target.nodeValue==e.oldValue}}class Zs extends zr{constructor(e,t,s,i){super(e,[],s,i),this.mark=t}static create(e,t,s,i){let r=i.nodeViews[t.type.name],o=r&&r(t,i,s);return(!o||!o.dom)&&(o=Ui.renderSpec(document,t.type.spec.toDOM(t,s),null,t.attrs)),new Zs(e,t,o.dom,o.contentDOM||o.dom)}parseRule(){return this.dirty&_n||this.mark.type.spec.reparseInView?null:{mark:this.mark.type.name,attrs:this.mark.attrs,contentElement:this.contentDOM}}matchesMark(e){return this.dirty!=_n&&this.mark.eq(e)}markDirty(e,t){if(super.markDirty(e,t),this.dirty!=Xt){let s=this.parent;for(;!s.node;)s=s.parent;s.dirty<this.dirty&&(s.dirty=this.dirty),this.dirty=Xt}}slice(e,t,s){let i=Zs.create(this.parent,this.mark,!0,s),r=this.children,o=this.size;t<o&&(r=fl(r,t,o,s)),e>0&&(r=fl(r,0,e,s));for(let a=0;a<r.length;a++)r[a].parent=i;return i.children=r,i}}class xs extends zr{constructor(e,t,s,i,r,o,a,l,d){super(e,[],r,o),this.node=t,this.outerDeco=s,this.innerDeco=i,this.nodeDOM=a}static create(e,t,s,i,r,o){let a=r.nodeViews[t.type.name],l,d=a&&a(t,r,()=>{if(!l)return o;if(l.parent)return l.parent.posBeforeChild(l)},s,i),u=d&&d.dom,h=d&&d.contentDOM;if(t.isText){if(!u)u=document.createTextNode(t.text);else if(u.nodeType!=3)throw new RangeError("Text must be rendered as a DOM text node")}else u||({dom:u,contentDOM:h}=Ui.renderSpec(document,t.type.spec.toDOM(t),null,t.attrs));!h&&!t.isText&&u.nodeName!="BR"&&(u.hasAttribute("contenteditable")||(u.contentEditable="false"),t.type.spec.draggable&&(u.draggable=!0));let f=u;return u=Yp(u,s,t),d?l=new lv(e,t,s,i,u,h||null,f,d,r,o+1):t.isText?new aa(e,t,s,i,u,f,r):new xs(e,t,s,i,u,h||null,f,r,o+1)}parseRule(){if(this.node.type.spec.reparseInView)return null;let e={node:this.node.type.name,attrs:this.node.attrs};if(this.node.type.whitespace=="pre"&&(e.preserveWhitespace="full"),!this.contentDOM)e.getContent=()=>this.node.content;else if(!this.contentLost)e.contentElement=this.contentDOM;else{for(let t=this.children.length-1;t>=0;t--){let s=this.children[t];if(this.dom.contains(s.dom.parentNode)){e.contentElement=s.dom.parentNode;break}}e.contentElement||(e.getContent=()=>P.empty)}return e}matchesNode(e,t,s){return this.dirty==Xt&&e.eq(this.node)&&hl(t,this.outerDeco)&&s.eq(this.innerDeco)}get size(){return this.node.nodeSize}get border(){return this.node.isLeaf?0:1}updateChildren(e,t){let s=this.node.inlineContent,i=t,r=e.composing?this.localCompositionInfo(e,t):null,o=r&&r.pos>-1?r:null,a=r&&r.pos<0,l=new dv(this,o&&o.node,e);fv(this.node,this.innerDeco,(d,u,h)=>{d.spec.marks?l.syncToMarks(d.spec.marks,s,e):d.type.side>=0&&!h&&l.syncToMarks(u==this.node.childCount?be.none:this.node.child(u).marks,s,e),l.placeWidget(d,e,i)},(d,u,h,f)=>{l.syncToMarks(d.marks,s,e);let m;l.findNodeMatch(d,u,h,f)||a&&e.state.selection.from>i&&e.state.selection.to<i+d.nodeSize&&(m=l.findIndexWithChild(r.node))>-1&&l.updateNodeAt(d,u,h,m,e)||l.updateNextNode(d,u,h,e,f,i)||l.addNode(d,u,h,e,i),i+=d.nodeSize}),l.syncToMarks([],s,e),this.node.isTextblock&&l.addTextblockHacks(),l.destroyRest(),(l.changed||this.dirty==Us)&&(o&&this.protectLocalComposition(e,o),Kp(this.contentDOM,this.children,e),Pi&&pv(this.dom))}localCompositionInfo(e,t){let{from:s,to:i}=e.state.selection;if(!(e.state.selection instanceof ye)||s<t||i>t+this.node.content.size)return null;let r=e.input.compositionNode;if(!r||!this.dom.contains(r.parentNode))return null;if(this.node.inlineContent){let o=r.nodeValue,a=mv(this.node.content,o,s-t,i-t);return a<0?null:{node:r,pos:a,text:o}}else return{node:r,pos:-1,text:""}}protectLocalComposition(e,{node:t,pos:s,text:i}){if(this.getDesc(t))return;let r=t;for(;r.parentNode!=this.contentDOM;r=r.parentNode){for(;r.previousSibling;)r.parentNode.removeChild(r.previousSibling);for(;r.nextSibling;)r.parentNode.removeChild(r.nextSibling);r.pmViewDesc&&(r.pmViewDesc=void 0)}let o=new av(this,r,t,i);e.input.compositionNodes.push(o),this.children=fl(this.children,s,s+i.length,e,o)}update(e,t,s,i){return this.dirty==_n||!e.sameMarkup(this.node)?!1:(this.updateInner(e,t,s,i),!0)}updateInner(e,t,s,i){this.updateOuterDeco(t),this.node=e,this.innerDeco=s,this.contentDOM&&this.updateChildren(i,this.posAtStart),this.dirty=Xt}updateOuterDeco(e){if(hl(e,this.outerDeco))return;let t=this.nodeDOM.nodeType!=1,s=this.dom;this.dom=Jp(this.dom,this.nodeDOM,ul(this.outerDeco,this.node,t),ul(e,this.node,t)),this.dom!=s&&(s.pmViewDesc=void 0,this.dom.pmViewDesc=this),this.outerDeco=e}selectNode(){this.nodeDOM.nodeType==1&&this.nodeDOM.classList.add("ProseMirror-selectednode"),(this.contentDOM||!this.node.type.spec.draggable)&&(this.dom.draggable=!0)}deselectNode(){this.nodeDOM.nodeType==1&&(this.nodeDOM.classList.remove("ProseMirror-selectednode"),(this.contentDOM||!this.node.type.spec.draggable)&&this.dom.removeAttribute("draggable"))}get domAtom(){return this.node.isAtom}}function eu(n,e,t,s,i){Yp(s,e,n);let r=new xs(void 0,n,e,t,s,s,s,i,0);return r.contentDOM&&r.updateChildren(i,0),r}class aa extends xs{constructor(e,t,s,i,r,o,a){super(e,t,s,i,r,null,o,a,0)}parseRule(){let e=this.nodeDOM.parentNode;for(;e&&e!=this.dom&&!e.pmIsDeco;)e=e.parentNode;return{skip:e||!0}}update(e,t,s,i){return this.dirty==_n||this.dirty!=Xt&&!this.inParent()||!e.sameMarkup(this.node)?!1:(this.updateOuterDeco(t),(this.dirty!=Xt||e.text!=this.node.text)&&e.text!=this.nodeDOM.nodeValue&&(this.nodeDOM.nodeValue=e.text,i.trackWrites==this.nodeDOM&&(i.trackWrites=null)),this.node=e,this.dirty=Xt,!0)}inParent(){let e=this.parent.contentDOM;for(let t=this.nodeDOM;t;t=t.parentNode)if(t==e)return!0;return!1}domFromPos(e){return{node:this.nodeDOM,offset:e}}localPosFromDOM(e,t,s){return e==this.nodeDOM?this.posAtStart+Math.min(t,this.node.text.length):super.localPosFromDOM(e,t,s)}ignoreMutation(e){return e.type!="characterData"&&e.type!="selection"}slice(e,t,s){let i=this.node.cut(e,t),r=document.createTextNode(i.text);return new aa(this.parent,i,this.outerDeco,this.innerDeco,r,r,s)}markDirty(e,t){super.markDirty(e,t),this.dom!=this.nodeDOM&&(e==0||t==this.nodeDOM.nodeValue.length)&&(this.dirty=_n)}get domAtom(){return!1}isText(e){return this.node.text==e}}class $p extends zr{parseRule(){return{ignore:!0}}matchesHack(e){return this.dirty==Xt&&this.dom.nodeName==e}get domAtom(){return!0}get ignoreForCoords(){return this.dom.nodeName=="IMG"}}class lv extends xs{constructor(e,t,s,i,r,o,a,l,d,u){super(e,t,s,i,r,o,a,d,u),this.spec=l}update(e,t,s,i){if(this.dirty==_n)return!1;if(this.spec.update){let r=this.spec.update(e,t,s);return r&&this.updateInner(e,t,s,i),r}else return!this.contentDOM&&!e.isLeaf?!1:super.update(e,t,s,i)}selectNode(){this.spec.selectNode?this.spec.selectNode():super.selectNode()}deselectNode(){this.spec.deselectNode?this.spec.deselectNode():super.deselectNode()}setSelection(e,t,s,i){this.spec.setSelection?this.spec.setSelection(e,t,s):super.setSelection(e,t,s,i)}destroy(){this.spec.destroy&&this.spec.destroy(),super.destroy()}stopEvent(e){return this.spec.stopEvent?this.spec.stopEvent(e):!1}ignoreMutation(e){return this.spec.ignoreMutation?this.spec.ignoreMutation(e):super.ignoreMutation(e)}}function Kp(n,e,t){let s=n.firstChild,i=!1;for(let r=0;r<e.length;r++){let o=e[r],a=o.dom;if(a.parentNode==n){for(;a!=s;)s=tu(s),i=!0;s=s.nextSibling}else i=!0,n.insertBefore(a,s);if(o instanceof Zs){let l=s?s.previousSibling:n.lastChild;Kp(o.contentDOM,o.children,t),s=l?l.nextSibling:n.firstChild}}for(;s;)s=tu(s),i=!0;i&&t.trackWrites==n&&(t.trackWrites=null)}const ar=function(n){n&&(this.nodeName=n)};ar.prototype=Object.create(null);const Vs=[new ar];function ul(n,e,t){if(n.length==0)return Vs;let s=t?Vs[0]:new ar,i=[s];for(let r=0;r<n.length;r++){let o=n[r].type.attrs;if(o){o.nodeName&&i.push(s=new ar(o.nodeName));for(let a in o){let l=o[a];l!=null&&(t&&i.length==1&&i.push(s=new ar(e.isInline?"span":"div")),a=="class"?s.class=(s.class?s.class+" ":"")+l:a=="style"?s.style=(s.style?s.style+";":"")+l:a!="nodeName"&&(s[a]=l))}}}return i}function Jp(n,e,t,s){if(t==Vs&&s==Vs)return e;let i=e;for(let r=0;r<s.length;r++){let o=s[r],a=t[r];if(r){let l;a&&a.nodeName==o.nodeName&&i!=n&&(l=i.parentNode)&&l.nodeName.toLowerCase()==o.nodeName||(l=document.createElement(o.nodeName),l.pmIsDeco=!0,l.appendChild(i),a=Vs[0]),i=l}cv(i,a||Vs[0],o)}return i}function cv(n,e,t){for(let s in e)s!="class"&&s!="style"&&s!="nodeName"&&!(s in t)&&n.removeAttribute(s);for(let s in t)s!="class"&&s!="style"&&s!="nodeName"&&t[s]!=e[s]&&n.setAttribute(s,t[s]);if(e.class!=t.class){let s=e.class?e.class.split(" ").filter(Boolean):[],i=t.class?t.class.split(" ").filter(Boolean):[];for(let r=0;r<s.length;r++)i.indexOf(s[r])==-1&&n.classList.remove(s[r]);for(let r=0;r<i.length;r++)s.indexOf(i[r])==-1&&n.classList.add(i[r]);n.classList.length==0&&n.removeAttribute("class")}if(e.style!=t.style){if(e.style){let s=/\s*([\w\-\xa1-\uffff]+)\s*:(?:"(?:\\.|[^"])*"|'(?:\\.|[^'])*'|\(.*?\)|[^;])*/g,i;for(;i=s.exec(e.style);)n.style.removeProperty(i[1])}t.style&&(n.style.cssText+=t.style)}}function Yp(n,e,t){return Jp(n,n,Vs,ul(e,t,n.nodeType!=1))}function hl(n,e){if(n.length!=e.length)return!1;for(let t=0;t<n.length;t++)if(!n[t].type.eq(e[t].type))return!1;return!0}function tu(n){let e=n.nextSibling;return n.parentNode.removeChild(n),e}class dv{constructor(e,t,s){this.lock=t,this.view=s,this.index=0,this.stack=[],this.changed=!1,this.top=e,this.preMatch=uv(e.node.content,e)}destroyBetween(e,t){if(e!=t){for(let s=e;s<t;s++)this.top.children[s].destroy();this.top.children.splice(e,t-e),this.changed=!0}}destroyRest(){this.destroyBetween(this.index,this.top.children.length)}syncToMarks(e,t,s){let i=0,r=this.stack.length>>1,o=Math.min(r,e.length);for(;i<o&&(i==r-1?this.top:this.stack[i+1<<1]).matchesMark(e[i])&&e[i].type.spec.spanning!==!1;)i++;for(;i<r;)this.destroyRest(),this.top.dirty=Xt,this.index=this.stack.pop(),this.top=this.stack.pop(),r--;for(;r<e.length;){this.stack.push(this.top,this.index+1);let a=-1;for(let l=this.index;l<Math.min(this.index+3,this.top.children.length);l++){let d=this.top.children[l];if(d.matchesMark(e[r])&&!this.isLocked(d.dom)){a=l;break}}if(a>-1)a>this.index&&(this.changed=!0,this.destroyBetween(this.index,a)),this.top=this.top.children[this.index];else{let l=Zs.create(this.top,e[r],t,s);this.top.children.splice(this.index,0,l),this.top=l,this.changed=!0}this.index=0,r++}}findNodeMatch(e,t,s,i){let r=-1,o;if(i>=this.preMatch.index&&(o=this.preMatch.matches[i-this.preMatch.index]).parent==this.top&&o.matchesNode(e,t,s))r=this.top.children.indexOf(o,this.index);else for(let a=this.index,l=Math.min(this.top.children.length,a+5);a<l;a++){let d=this.top.children[a];if(d.matchesNode(e,t,s)&&!this.preMatch.matched.has(d)){r=a;break}}return r<0?!1:(this.destroyBetween(this.index,r),this.index++,!0)}updateNodeAt(e,t,s,i,r){let o=this.top.children[i];return o.dirty==_n&&o.dom==o.contentDOM&&(o.dirty=Us),o.update(e,t,s,r)?(this.destroyBetween(this.index,i),this.index++,!0):!1}findIndexWithChild(e){for(;;){let t=e.parentNode;if(!t)return-1;if(t==this.top.contentDOM){let s=e.pmViewDesc;if(s){for(let i=this.index;i<this.top.children.length;i++)if(this.top.children[i]==s)return i}return-1}e=t}}updateNextNode(e,t,s,i,r,o){for(let a=this.index;a<this.top.children.length;a++){let l=this.top.children[a];if(l instanceof xs){let d=this.preMatch.matched.get(l);if(d!=null&&d!=r)return!1;let u=l.dom,h,f=this.isLocked(u)&&!(e.isText&&l.node&&l.node.isText&&l.nodeDOM.nodeValue==e.text&&l.dirty!=_n&&hl(t,l.outerDeco));if(!f&&l.update(e,t,s,i))return this.destroyBetween(this.index,a),l.dom!=u&&(this.changed=!0),this.index++,!0;if(!f&&(h=this.recreateWrapper(l,e,t,s,i,o)))return this.top.children[this.index]=h,h.contentDOM&&(h.dirty=Us,h.updateChildren(i,o+1),h.dirty=Xt),this.changed=!0,this.index++,!0;break}}return!1}recreateWrapper(e,t,s,i,r,o){if(e.dirty||t.isAtom||!e.children.length||!e.node.content.eq(t.content))return null;let a=xs.create(this.top,t,s,i,r,o);if(a.contentDOM){a.children=e.children,e.children=[];for(let l of a.children)l.parent=a}return e.destroy(),a}addNode(e,t,s,i,r){let o=xs.create(this.top,e,t,s,i,r);o.contentDOM&&o.updateChildren(i,r+1),this.top.children.splice(this.index++,0,o),this.changed=!0}placeWidget(e,t,s){let i=this.index<this.top.children.length?this.top.children[this.index]:null;if(i&&i.matchesWidget(e)&&(e==i.widget||!i.widget.type.toDOM.parentNode))this.index++;else{let r=new qp(this.top,e,t,s);this.top.children.splice(this.index++,0,r),this.changed=!0}}addTextblockHacks(){let e=this.top.children[this.index-1],t=this.top;for(;e instanceof Zs;)t=e,e=t.children[t.children.length-1];(!e||!(e instanceof aa)||/\n$/.test(e.node.text)||this.view.requiresGeckoHackNode&&/\s$/.test(e.node.text))&&((St||ht)&&e&&e.dom.contentEditable=="false"&&this.addHackNode("IMG",t),this.addHackNode("BR",this.top))}addHackNode(e,t){if(t==this.top&&this.index<t.children.length&&t.children[this.index].matchesHack(e))this.index++;else{let s=document.createElement(e);e=="IMG"&&(s.className="ProseMirror-separator",s.alt=""),e=="BR"&&(s.className="ProseMirror-trailingBreak");let i=new $p(this.top,[],s,null);t!=this.top?t.children.push(i):t.children.splice(this.index++,0,i),this.changed=!0}}isLocked(e){return this.lock&&(e==this.lock||e.nodeType==1&&e.contains(this.lock.parentNode))}}function uv(n,e){let t=e,s=t.children.length,i=n.childCount,r=new Map,o=[];e:for(;i>0;){let a;for(;;)if(s){let d=t.children[s-1];if(d instanceof Zs)t=d,s=d.children.length;else{a=d,s--;break}}else{if(t==e)break e;s=t.parent.children.indexOf(t),t=t.parent}let l=a.node;if(l){if(l!=n.child(i-1))break;--i,r.set(a,i),o.push(a)}}return{index:i,matched:r,matches:o.reverse()}}function hv(n,e){return n.type.side-e.type.side}function fv(n,e,t,s){let i=e.locals(n),r=0;if(i.length==0){for(let d=0;d<n.childCount;d++){let u=n.child(d);s(u,i,e.forChild(r,u),d),r+=u.nodeSize}return}let o=0,a=[],l=null;for(let d=0;;){let u,h;for(;o<i.length&&i[o].to==r;){let S=i[o++];S.widget&&(u?(h||(h=[u])).push(S):u=S)}if(u)if(h){h.sort(hv);for(let S=0;S<h.length;S++)t(h[S],d,!!l)}else t(u,d,!!l);let f,m;if(l)m=-1,f=l,l=null;else if(d<n.childCount)m=d,f=n.child(d++);else break;for(let S=0;S<a.length;S++)a[S].to<=r&&a.splice(S--,1);for(;o<i.length&&i[o].from<=r&&i[o].to>r;)a.push(i[o++]);let p=r+f.nodeSize;if(f.isText){let S=p;o<i.length&&i[o].from<S&&(S=i[o].from);for(let x=0;x<a.length;x++)a[x].to<S&&(S=a[x].to);S<p&&(l=f.cut(S-r),f=f.cut(0,S-r),p=S,m=-1)}else for(;o<i.length&&i[o].to<p;)o++;let g=f.isInline&&!f.isLeaf?a.filter(S=>!S.inline):a.slice();s(f,g,e.forChild(r,f),m),r=p}}function pv(n){if(n.nodeName=="UL"||n.nodeName=="OL"){let e=n.style.cssText;n.style.cssText=e+"; list-style: square !important",window.getComputedStyle(n).listStyle,n.style.cssText=e}}function mv(n,e,t,s){for(let i=0,r=0;i<n.childCount&&r<=s;){let o=n.child(i++),a=r;if(r+=o.nodeSize,!o.isText)continue;let l=o.text;for(;i<n.childCount;){let d=n.child(i++);if(r+=d.nodeSize,!d.isText)break;l+=d.text}if(r>=t){if(r>=s&&l.slice(s-e.length-a,s-a)==e)return s-e.length;let d=a<s?l.lastIndexOf(e,s-a-1):-1;if(d>=0&&d+e.length+a>=t)return a+d;if(t==s&&l.length>=s+e.length-a&&l.slice(s-a,s-a+e.length)==e)return s}}return-1}function fl(n,e,t,s,i){let r=[];for(let o=0,a=0;o<n.length;o++){let l=n[o],d=a,u=a+=l.size;d>=t||u<=e?r.push(l):(d<e&&r.push(l.slice(0,e-d,s)),i&&(r.push(i),i=void 0),u>t&&r.push(l.slice(t-d,l.size,s)))}return r}function vc(n,e=null){let t=n.domSelectionRange(),s=n.state.doc;if(!t.focusNode)return null;let i=n.docView.nearestDesc(t.focusNode),r=i&&i.size==0,o=n.docView.posFromDOM(t.focusNode,t.focusOffset,1);if(o<0)return null;let a=s.resolve(o),l,d;if(oa(t)){for(l=a;i&&!i.node;)i=i.parent;let u=i.node;if(i&&u.isAtom&&ie.isSelectable(u)&&i.parent&&!(u.isInline&&UC(t.focusNode,t.focusOffset,i.dom))){let h=i.posBefore;d=new ie(o==h?a:s.resolve(h))}}else{let u=n.docView.posFromDOM(t.anchorNode,t.anchorOffset,1);if(u<0)return null;l=s.resolve(u)}if(!d){let u=e=="pointer"||n.state.selection.head<a.pos&&!r?1:-1;d=Mc(n,l,a,u)}return d}function Qp(n){return n.editable?n.hasFocus():Zp(n)&&document.activeElement&&document.activeElement.contains(n.dom)}function qn(n,e=!1){let t=n.state.selection;if(Xp(n,t),!!Qp(n)){if(!e&&n.input.mouseDown&&n.input.mouseDown.allowDefault&&ht){let s=n.domSelectionRange(),i=n.domObserver.currentSelection;if(s.anchorNode&&i.anchorNode&&Xs(s.anchorNode,s.anchorOffset,i.anchorNode,i.anchorOffset)){n.input.mouseDown.delayedSelectionSync=!0,n.domObserver.setCurSelection();return}}if(n.domObserver.disconnectSelection(),n.cursorWrapper)yv(n);else{let{anchor:s,head:i}=t,r,o;nu&&!(t instanceof ye)&&(t.$from.parent.inlineContent||(r=su(n,t.from)),!t.empty&&!t.$from.parent.inlineContent&&(o=su(n,t.to))),n.docView.setSelection(s,i,n.root,e),nu&&(r&&iu(r),o&&iu(o)),t.visible?n.dom.classList.remove("ProseMirror-hideselection"):(n.dom.classList.add("ProseMirror-hideselection"),"onselectionchange"in document&&gv(n))}n.domObserver.setCurSelection(),n.domObserver.connectSelection()}}const nu=St||ht&&Bp<63;function su(n,e){let{node:t,offset:s}=n.docView.domFromPos(e,0),i=s<t.childNodes.length?t.childNodes[s]:null,r=s?t.childNodes[s-1]:null;if(St&&i&&i.contentEditable=="false")return Aa(i);if((!i||i.contentEditable=="false")&&(!r||r.contentEditable=="false")){if(i)return Aa(i);if(r)return Aa(r)}}function Aa(n){return n.contentEditable="true",St&&n.draggable&&(n.draggable=!1,n.wasDraggable=!0),n}function iu(n){n.contentEditable="false",n.wasDraggable&&(n.draggable=!0,n.wasDraggable=null)}function gv(n){let e=n.dom.ownerDocument;e.removeEventListener("selectionchange",n.input.hideSelectionGuard);let t=n.domSelectionRange(),s=t.anchorNode,i=t.anchorOffset;e.addEventListener("selectionchange",n.input.hideSelectionGuard=()=>{(t.anchorNode!=s||t.anchorOffset!=i)&&(e.removeEventListener("selectionchange",n.input.hideSelectionGuard),setTimeout(()=>{(!Qp(n)||n.state.selection.visible)&&n.dom.classList.remove("ProseMirror-hideselection")},20))})}function yv(n){let e=n.domSelection(),t=document.createRange(),s=n.cursorWrapper.dom,i=s.nodeName=="IMG";i?t.setEnd(s.parentNode,rt(s)+1):t.setEnd(s,0),t.collapse(!1),e.removeAllRanges(),e.addRange(t),!i&&!n.state.selection.visible&&Mt&&ys<=11&&(s.disabled=!0,s.disabled=!1)}function Xp(n,e){if(e instanceof ie){let t=n.docView.descAt(e.from);t!=n.lastSelectedViewDesc&&(ru(n),t&&t.selectNode(),n.lastSelectedViewDesc=t)}else ru(n)}function ru(n){n.lastSelectedViewDesc&&(n.lastSelectedViewDesc.parent&&n.lastSelectedViewDesc.deselectNode(),n.lastSelectedViewDesc=void 0)}function Mc(n,e,t,s){return n.someProp("createSelectionBetween",i=>i(n,e,t))||ye.between(e,t,s)}function ou(n){return n.editable&&!n.hasFocus()?!1:Zp(n)}function Zp(n){let e=n.domSelectionRange();if(!e.anchorNode)return!1;try{return n.dom.contains(e.anchorNode.nodeType==3?e.anchorNode.parentNode:e.anchorNode)&&(n.editable||n.dom.contains(e.focusNode.nodeType==3?e.focusNode.parentNode:e.focusNode))}catch{return!1}}function xv(n){let e=n.docView.domFromPos(n.state.selection.anchor,0),t=n.domSelectionRange();return Xs(e.node,e.offset,t.anchorNode,t.anchorOffset)}function pl(n,e){let{$anchor:t,$head:s}=n.selection,i=e>0?t.max(s):t.min(s),r=i.parent.inlineContent?i.depth?n.doc.resolve(e>0?i.after():i.before()):null:i;return r&&de.findFrom(r,e)}function as(n,e){return n.dispatch(n.state.tr.setSelection(e).scrollIntoView()),!0}function au(n,e,t){let s=n.state.selection;if(s instanceof ye)if(t.indexOf("s")>-1){let{$head:i}=s,r=i.textOffset?null:e<0?i.nodeBefore:i.nodeAfter;if(!r||r.isText||!r.isLeaf)return!1;let o=n.state.doc.resolve(i.pos+r.nodeSize*(e<0?-1:1));return as(n,new ye(s.$anchor,o))}else if(s.empty){if(n.endOfTextblock(e>0?"forward":"backward")){let i=pl(n.state,e);return i&&i instanceof ie?as(n,i):!1}else if(!(Yt&&t.indexOf("m")>-1)){let i=s.$head,r=i.textOffset?null:e<0?i.nodeBefore:i.nodeAfter,o;if(!r||r.isText)return!1;let a=e<0?i.pos-r.nodeSize:i.pos;return r.isAtom||(o=n.docView.descAt(a))&&!o.contentDOM?ie.isSelectable(r)?as(n,new ie(e<0?n.state.doc.resolve(i.pos-r.nodeSize):i)):Br?as(n,new ye(n.state.doc.resolve(e<0?a:a+r.nodeSize))):!1:!1}}else return!1;else{if(s instanceof ie&&s.node.isInline)return as(n,new ye(e>0?s.$to:s.$from));{let i=pl(n.state,e);return i?as(n,i):!1}}}function Do(n){return n.nodeType==3?n.nodeValue.length:n.childNodes.length}function lr(n,e){let t=n.pmViewDesc;return t&&t.size==0&&(e<0||n.nextSibling||n.nodeName!="BR")}function fi(n,e){return e<0?bv(n):Sv(n)}function bv(n){let e=n.domSelectionRange(),t=e.focusNode,s=e.focusOffset;if(!t)return;let i,r,o=!1;for(mn&&t.nodeType==1&&s<Do(t)&&lr(t.childNodes[s],-1)&&(o=!0);;)if(s>0){if(t.nodeType!=1)break;{let a=t.childNodes[s-1];if(lr(a,-1))i=t,r=--s;else if(a.nodeType==3)t=a,s=t.nodeValue.length;else break}}else{if(em(t))break;{let a=t.previousSibling;for(;a&&lr(a,-1);)i=t.parentNode,r=rt(a),a=a.previousSibling;if(a)t=a,s=Do(t);else{if(t=t.parentNode,t==n.dom)break;s=0}}}o?ml(n,t,s):i&&ml(n,i,r)}function Sv(n){let e=n.domSelectionRange(),t=e.focusNode,s=e.focusOffset;if(!t)return;let i=Do(t),r,o;for(;;)if(s<i){if(t.nodeType!=1)break;let a=t.childNodes[s];if(lr(a,1))r=t,o=++s;else break}else{if(em(t))break;{let a=t.nextSibling;for(;a&&lr(a,1);)r=a.parentNode,o=rt(a)+1,a=a.nextSibling;if(a)t=a,s=0,i=Do(t);else{if(t=t.parentNode,t==n.dom)break;s=i=0}}}r&&ml(n,r,o)}function em(n){let e=n.pmViewDesc;return e&&e.node&&e.node.isBlock}function kv(n,e){for(;n&&e==n.childNodes.length&&!Lr(n);)e=rt(n)+1,n=n.parentNode;for(;n&&e<n.childNodes.length;){let t=n.childNodes[e];if(t.nodeType==3)return t;if(t.nodeType==1&&t.contentEditable=="false")break;n=t,e=0}}function wv(n,e){for(;n&&!e&&!Lr(n);)e=rt(n),n=n.parentNode;for(;n&&e;){let t=n.childNodes[e-1];if(t.nodeType==3)return t;if(t.nodeType==1&&t.contentEditable=="false")break;n=t,e=n.childNodes.length}}function ml(n,e,t){if(e.nodeType!=3){let r,o;(o=kv(e,t))?(e=o,t=0):(r=wv(e,t))&&(e=r,t=r.nodeValue.length)}let s=n.domSelection();if(oa(s)){let r=document.createRange();r.setEnd(e,t),r.setStart(e,t),s.removeAllRanges(),s.addRange(r)}else s.extend&&s.extend(e,t);n.domObserver.setCurSelection();let{state:i}=n;setTimeout(()=>{n.state==i&&qn(n)},50)}function lu(n,e){let t=n.state.doc.resolve(e);if(!(ht||HC)&&t.parent.inlineContent){let i=n.coordsAtPos(e);if(e>t.start()){let r=n.coordsAtPos(e-1),o=(r.top+r.bottom)/2;if(o>i.top&&o<i.bottom&&Math.abs(r.left-i.left)>1)return r.left<i.left?"ltr":"rtl"}if(e<t.end()){let r=n.coordsAtPos(e+1),o=(r.top+r.bottom)/2;if(o>i.top&&o<i.bottom&&Math.abs(r.left-i.left)>1)return r.left>i.left?"ltr":"rtl"}}return getComputedStyle(n.dom).direction=="rtl"?"rtl":"ltr"}function cu(n,e,t){let s=n.state.selection;if(s instanceof ye&&!s.empty||t.indexOf("s")>-1||Yt&&t.indexOf("m")>-1)return!1;let{$from:i,$to:r}=s;if(!i.parent.inlineContent||n.endOfTextblock(e<0?"up":"down")){let o=pl(n.state,e);if(o&&o instanceof ie)return as(n,o)}if(!i.parent.inlineContent){let o=e<0?i:r,a=s instanceof Vt?de.near(o,e):de.findFrom(o,e);return a?as(n,a):!1}return!1}function du(n,e){if(!(n.state.selection instanceof ye))return!0;let{$head:t,$anchor:s,empty:i}=n.state.selection;if(!t.sameParent(s))return!0;if(!i)return!1;if(n.endOfTextblock(e>0?"forward":"backward"))return!0;let r=!t.textOffset&&(e<0?t.nodeBefore:t.nodeAfter);if(r&&!r.isText){let o=n.state.tr;return e<0?o.delete(t.pos-r.nodeSize,t.pos):o.delete(t.pos,t.pos+r.nodeSize),n.dispatch(o),!0}return!1}function uu(n,e,t){n.domObserver.stop(),e.contentEditable=t,n.domObserver.start()}function Cv(n){if(!St||n.state.selection.$head.parentOffset>0)return!1;let{focusNode:e,focusOffset:t}=n.domSelectionRange();if(e&&e.nodeType==1&&t==0&&e.firstChild&&e.firstChild.contentEditable=="false"){let s=e.firstChild;uu(n,s,"true"),setTimeout(()=>uu(n,s,"false"),20)}return!1}function vv(n){let e="";return n.ctrlKey&&(e+="c"),n.metaKey&&(e+="m"),n.altKey&&(e+="a"),n.shiftKey&&(e+="s"),e}function Mv(n,e){let t=e.keyCode,s=vv(e);if(t==8||Yt&&t==72&&s=="c")return du(n,-1)||fi(n,-1);if(t==46&&!e.shiftKey||Yt&&t==68&&s=="c")return du(n,1)||fi(n,1);if(t==13||t==27)return!0;if(t==37||Yt&&t==66&&s=="c"){let i=t==37?lu(n,n.state.selection.from)=="ltr"?-1:1:-1;return au(n,i,s)||fi(n,i)}else if(t==39||Yt&&t==70&&s=="c"){let i=t==39?lu(n,n.state.selection.from)=="ltr"?1:-1:1;return au(n,i,s)||fi(n,i)}else{if(t==38||Yt&&t==80&&s=="c")return cu(n,-1,s)||fi(n,-1);if(t==40||Yt&&t==78&&s=="c")return Cv(n)||cu(n,1,s)||fi(n,1);if(s==(Yt?"m":"c")&&(t==66||t==73||t==89||t==90))return!0}return!1}function tm(n,e){n.someProp("transformCopied",m=>{e=m(e,n)});let t=[],{content:s,openStart:i,openEnd:r}=e;for(;i>1&&r>1&&s.childCount==1&&s.firstChild.childCount==1;){i--,r--;let m=s.firstChild;t.push(m.type.name,m.attrs!=m.type.defaultAttrs?m.attrs:null),s=m.content}let o=n.someProp("clipboardSerializer")||Ui.fromSchema(n.state.schema),a=am(),l=a.createElement("div");l.appendChild(o.serializeFragment(s,{document:a}));let d=l.firstChild,u,h=0;for(;d&&d.nodeType==1&&(u=om[d.nodeName.toLowerCase()]);){for(let m=u.length-1;m>=0;m--){let p=a.createElement(u[m]);for(;l.firstChild;)p.appendChild(l.firstChild);l.appendChild(p),h++}d=l.firstChild}d&&d.nodeType==1&&d.setAttribute("data-pm-slice",`${i} ${r}${h?` -${h}`:""} ${JSON.stringify(t)}`);let f=n.someProp("clipboardTextSerializer",m=>m(e,n))||e.content.textBetween(0,e.content.size,`

`);return{dom:l,text:f,slice:e}}function nm(n,e,t,s,i){let r=i.parent.type.spec.code,o,a;if(!t&&!e)return null;let l=e&&(s||r||!t);if(l){if(n.someProp("transformPastedText",f=>{e=f(e,r||s,n)}),r)return e?new q(P.from(n.state.schema.text(e.replace(/\r\n?/g,`
`))),0,0):q.empty;let h=n.someProp("clipboardTextParser",f=>f(e,i,s,n));if(h)a=h;else{let f=i.marks(),{schema:m}=n.state,p=Ui.fromSchema(m);o=document.createElement("div"),e.split(/(?:\r\n?|\n)+/).forEach(g=>{let S=o.appendChild(document.createElement("p"));g&&S.appendChild(p.serializeNode(m.text(g,f)))})}}else n.someProp("transformPastedHTML",h=>{t=h(t,n)}),o=Nv(t),Br&&Ev(o);let d=o&&o.querySelector("[data-pm-slice]"),u=d&&/^(\d+) (\d+)(?: -(\d+))? (.*)/.exec(d.getAttribute("data-pm-slice")||"");if(u&&u[3])for(let h=+u[3];h>0;h--){let f=o.firstChild;for(;f&&f.nodeType!=1;)f=f.nextSibling;if(!f)break;o=f}if(a||(a=(n.someProp("clipboardParser")||n.someProp("domParser")||xr.fromSchema(n.state.schema)).parseSlice(o,{preserveWhitespace:!!(l||u),context:i,ruleFromNode(f){return f.nodeName=="BR"&&!f.nextSibling&&f.parentNode&&!Tv.test(f.parentNode.nodeName)?{ignore:!0}:null}})),u)a=Iv(hu(a,+u[1],+u[2]),u[4]);else if(a=q.maxOpen(_v(a.content,i),!0),a.openStart||a.openEnd){let h=0,f=0;for(let m=a.content.firstChild;h<a.openStart&&!m.type.spec.isolating;h++,m=m.firstChild);for(let m=a.content.lastChild;f<a.openEnd&&!m.type.spec.isolating;f++,m=m.lastChild);a=hu(a,h,f)}return n.someProp("transformPasted",h=>{a=h(a,n)}),a}const Tv=/^(a|abbr|acronym|b|cite|code|del|em|i|ins|kbd|label|output|q|ruby|s|samp|span|strong|sub|sup|time|u|tt|var)$/i;function _v(n,e){if(n.childCount<2)return n;for(let t=e.depth;t>=0;t--){let i=e.node(t).contentMatchAt(e.index(t)),r,o=[];if(n.forEach(a=>{if(!o)return;let l=i.findWrapping(a.type),d;if(!l)return o=null;if(d=o.length&&r.length&&im(l,r,a,o[o.length-1],0))o[o.length-1]=d;else{o.length&&(o[o.length-1]=rm(o[o.length-1],r.length));let u=sm(a,l);o.push(u),i=i.matchType(u.type),r=l}}),o)return P.from(o)}return n}function sm(n,e,t=0){for(let s=e.length-1;s>=t;s--)n=e[s].create(null,P.from(n));return n}function im(n,e,t,s,i){if(i<n.length&&i<e.length&&n[i]==e[i]){let r=im(n,e,t,s.lastChild,i+1);if(r)return s.copy(s.content.replaceChild(s.childCount-1,r));if(s.contentMatchAt(s.childCount).matchType(i==n.length-1?t.type:n[i+1]))return s.copy(s.content.append(P.from(sm(t,n,i+1))))}}function rm(n,e){if(e==0)return n;let t=n.content.replaceChild(n.childCount-1,rm(n.lastChild,e-1)),s=n.contentMatchAt(n.childCount).fillBefore(P.empty,!0);return n.copy(t.append(s))}function gl(n,e,t,s,i,r){let o=e<0?n.firstChild:n.lastChild,a=o.content;return n.childCount>1&&(r=0),i<s-1&&(a=gl(a,e,t,s,i+1,r)),i>=t&&(a=e<0?o.contentMatchAt(0).fillBefore(a,r<=i).append(a):a.append(o.contentMatchAt(o.childCount).fillBefore(P.empty,!0))),n.replaceChild(e<0?0:n.childCount-1,o.copy(a))}function hu(n,e,t){return e<n.openStart&&(n=new q(gl(n.content,-1,e,n.openStart,0,n.openEnd),e,n.openEnd)),t<n.openEnd&&(n=new q(gl(n.content,1,t,n.openEnd,0,0),n.openStart,t)),n}const om={thead:["table"],tbody:["table"],tfoot:["table"],caption:["table"],colgroup:["table"],col:["table","colgroup"],tr:["table","tbody"],td:["table","tbody","tr"],th:["table","tbody","tr"]};let fu=null;function am(){return fu||(fu=document.implementation.createHTMLDocument("title"))}function Nv(n){let e=/^(\s*<meta [^>]*>)*/.exec(n);e&&(n=n.slice(e[0].length));let t=am().createElement("div"),s=/<([a-z][^>\s]+)/i.exec(n),i;if((i=s&&om[s[1].toLowerCase()])&&(n=i.map(r=>"<"+r+">").join("")+n+i.map(r=>"</"+r+">").reverse().join("")),t.innerHTML=n,i)for(let r=0;r<i.length;r++)t=t.querySelector(i[r])||t;return t}function Ev(n){let e=n.querySelectorAll(ht?"span:not([class]):not([style])":"span.Apple-converted-space");for(let t=0;t<e.length;t++){let s=e[t];s.childNodes.length==1&&s.textContent=="Â "&&s.parentNode&&s.parentNode.replaceChild(n.ownerDocument.createTextNode(" "),s)}}function Iv(n,e){if(!n.size)return n;let t=n.content.firstChild.type.schema,s;try{s=JSON.parse(e)}catch{return n}let{content:i,openStart:r,openEnd:o}=n;for(let a=s.length-2;a>=0;a-=2){let l=t.nodes[s[a]];if(!l||l.hasRequiredAttrs())break;i=P.from(l.create(s[a+1],i)),r++,o++}return new q(i,r,o)}const kt={},wt={},Av={touchstart:!0,touchmove:!0};class jv{constructor(){this.shiftKey=!1,this.mouseDown=null,this.lastKeyCode=null,this.lastKeyCodeTime=0,this.lastClick={time:0,x:0,y:0,type:""},this.lastSelectionOrigin=null,this.lastSelectionTime=0,this.lastIOSEnter=0,this.lastIOSEnterFallbackTimeout=-1,this.lastFocus=0,this.lastTouch=0,this.lastAndroidDelete=0,this.composing=!1,this.compositionNode=null,this.composingTimeout=-1,this.compositionNodes=[],this.compositionEndedAt=-2e8,this.compositionID=1,this.compositionPendingChanges=0,this.domChangeCount=0,this.eventHandlers=Object.create(null),this.hideSelectionGuard=null}}function Rv(n){for(let e in kt){let t=kt[e];n.dom.addEventListener(e,n.input.eventHandlers[e]=s=>{Ov(n,s)&&!Tc(n,s)&&(n.editable||!(s.type in wt))&&t(n,s)},Av[e]?{passive:!0}:void 0)}St&&n.dom.addEventListener("input",()=>null),yl(n)}function ps(n,e){n.input.lastSelectionOrigin=e,n.input.lastSelectionTime=Date.now()}function Dv(n){n.domObserver.stop();for(let e in n.input.eventHandlers)n.dom.removeEventListener(e,n.input.eventHandlers[e]);clearTimeout(n.input.composingTimeout),clearTimeout(n.input.lastIOSEnterFallbackTimeout)}function yl(n){n.someProp("handleDOMEvents",e=>{for(let t in e)n.input.eventHandlers[t]||n.dom.addEventListener(t,n.input.eventHandlers[t]=s=>Tc(n,s))})}function Tc(n,e){return n.someProp("handleDOMEvents",t=>{let s=t[e.type];return s?s(n,e)||e.defaultPrevented:!1})}function Ov(n,e){if(!e.bubbles)return!0;if(e.defaultPrevented)return!1;for(let t=e.target;t!=n.dom;t=t.parentNode)if(!t||t.nodeType==11||t.pmViewDesc&&t.pmViewDesc.stopEvent(e))return!1;return!0}function Pv(n,e){!Tc(n,e)&&kt[e.type]&&(n.editable||!(e.type in wt))&&kt[e.type](n,e)}wt.keydown=(n,e)=>{let t=e;if(n.input.shiftKey=t.keyCode==16||t.shiftKey,!cm(n,t)&&(n.input.lastKeyCode=t.keyCode,n.input.lastKeyCodeTime=Date.now(),!(un&&ht&&t.keyCode==13)))if(t.keyCode!=229&&n.domObserver.forceFlush(),Pi&&t.keyCode==13&&!t.ctrlKey&&!t.altKey&&!t.metaKey){let s=Date.now();n.input.lastIOSEnter=s,n.input.lastIOSEnterFallbackTimeout=setTimeout(()=>{n.input.lastIOSEnter==s&&(n.someProp("handleKeyDown",i=>i(n,Ls(13,"Enter"))),n.input.lastIOSEnter=0)},200)}else n.someProp("handleKeyDown",s=>s(n,t))||Mv(n,t)?t.preventDefault():ps(n,"key")};wt.keyup=(n,e)=>{e.keyCode==16&&(n.input.shiftKey=!1)};wt.keypress=(n,e)=>{let t=e;if(cm(n,t)||!t.charCode||t.ctrlKey&&!t.altKey||Yt&&t.metaKey)return;if(n.someProp("handleKeyPress",i=>i(n,t))){t.preventDefault();return}let s=n.state.selection;if(!(s instanceof ye)||!s.$from.sameParent(s.$to)){let i=String.fromCharCode(t.charCode);!/[\r\n]/.test(i)&&!n.someProp("handleTextInput",r=>r(n,s.$from.pos,s.$to.pos,i))&&n.dispatch(n.state.tr.insertText(i).scrollIntoView()),t.preventDefault()}};function la(n){return{left:n.clientX,top:n.clientY}}function Fv(n,e){let t=e.x-n.clientX,s=e.y-n.clientY;return t*t+s*s<100}function _c(n,e,t,s,i){if(s==-1)return!1;let r=n.state.doc.resolve(s);for(let o=r.depth+1;o>0;o--)if(n.someProp(e,a=>o>r.depth?a(n,t,r.nodeAfter,r.before(o),i,!0):a(n,t,r.node(o),r.before(o),i,!1)))return!0;return!1}function Ci(n,e,t){n.focused||n.focus();let s=n.state.tr.setSelection(e);s.setMeta("pointer",!0),n.dispatch(s)}function Lv(n,e){if(e==-1)return!1;let t=n.state.doc.resolve(e),s=t.nodeAfter;return s&&s.isAtom&&ie.isSelectable(s)?(Ci(n,new ie(t)),!0):!1}function Bv(n,e){if(e==-1)return!1;let t=n.state.selection,s,i;t instanceof ie&&(s=t.node);let r=n.state.doc.resolve(e);for(let o=r.depth+1;o>0;o--){let a=o>r.depth?r.nodeAfter:r.node(o);if(ie.isSelectable(a)){s&&t.$from.depth>0&&o>=t.$from.depth&&r.before(t.$from.depth+1)==t.$from.pos?i=r.before(t.$from.depth):i=r.before(o);break}}return i!=null?(Ci(n,ie.create(n.state.doc,i)),!0):!1}function zv(n,e,t,s,i){return _c(n,"handleClickOn",e,t,s)||n.someProp("handleClick",r=>r(n,e,s))||(i?Bv(n,t):Lv(n,t))}function Uv(n,e,t,s){return _c(n,"handleDoubleClickOn",e,t,s)||n.someProp("handleDoubleClick",i=>i(n,e,s))}function Vv(n,e,t,s){return _c(n,"handleTripleClickOn",e,t,s)||n.someProp("handleTripleClick",i=>i(n,e,s))||Wv(n,t,s)}function Wv(n,e,t){if(t.button!=0)return!1;let s=n.state.doc;if(e==-1)return s.inlineContent?(Ci(n,ye.create(s,0,s.content.size)),!0):!1;let i=s.resolve(e);for(let r=i.depth+1;r>0;r--){let o=r>i.depth?i.nodeAfter:i.node(r),a=i.before(r);if(o.inlineContent)Ci(n,ye.create(s,a+1,a+1+o.content.size));else if(ie.isSelectable(o))Ci(n,ie.create(s,a));else continue;return!0}}function Nc(n){return Oo(n)}const lm=Yt?"metaKey":"ctrlKey";kt.mousedown=(n,e)=>{let t=e;n.input.shiftKey=t.shiftKey;let s=Nc(n),i=Date.now(),r="singleClick";i-n.input.lastClick.time<500&&Fv(t,n.input.lastClick)&&!t[lm]&&(n.input.lastClick.type=="singleClick"?r="doubleClick":n.input.lastClick.type=="doubleClick"&&(r="tripleClick")),n.input.lastClick={time:i,x:t.clientX,y:t.clientY,type:r};let o=n.posAtCoords(la(t));o&&(r=="singleClick"?(n.input.mouseDown&&n.input.mouseDown.done(),n.input.mouseDown=new Hv(n,o,t,!!s)):(r=="doubleClick"?Uv:Vv)(n,o.pos,o.inside,t)?t.preventDefault():ps(n,"pointer"))};class Hv{constructor(e,t,s,i){this.view=e,this.pos=t,this.event=s,this.flushed=i,this.delayedSelectionSync=!1,this.mightDrag=null,this.startDoc=e.state.doc,this.selectNode=!!s[lm],this.allowDefault=s.shiftKey;let r,o;if(t.inside>-1)r=e.state.doc.nodeAt(t.inside),o=t.inside;else{let u=e.state.doc.resolve(t.pos);r=u.parent,o=u.depth?u.before():0}const a=i?null:s.target,l=a?e.docView.nearestDesc(a,!0):null;this.target=l&&l.dom.nodeType==1?l.dom:null;let{selection:d}=e.state;(s.button==0&&r.type.spec.draggable&&r.type.spec.selectable!==!1||d instanceof ie&&d.from<=o&&d.to>o)&&(this.mightDrag={node:r,pos:o,addAttr:!!(this.target&&!this.target.draggable),setUneditable:!!(this.target&&mn&&!this.target.hasAttribute("contentEditable"))}),this.target&&this.mightDrag&&(this.mightDrag.addAttr||this.mightDrag.setUneditable)&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&(this.target.draggable=!0),this.mightDrag.setUneditable&&setTimeout(()=>{this.view.input.mouseDown==this&&this.target.setAttribute("contentEditable","false")},20),this.view.domObserver.start()),e.root.addEventListener("mouseup",this.up=this.up.bind(this)),e.root.addEventListener("mousemove",this.move=this.move.bind(this)),ps(e,"pointer")}done(){this.view.root.removeEventListener("mouseup",this.up),this.view.root.removeEventListener("mousemove",this.move),this.mightDrag&&this.target&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&this.target.removeAttribute("draggable"),this.mightDrag.setUneditable&&this.target.removeAttribute("contentEditable"),this.view.domObserver.start()),this.delayedSelectionSync&&setTimeout(()=>qn(this.view)),this.view.input.mouseDown=null}up(e){if(this.done(),!this.view.dom.contains(e.target))return;let t=this.pos;this.view.state.doc!=this.startDoc&&(t=this.view.posAtCoords(la(e))),this.updateAllowDefault(e),this.allowDefault||!t?ps(this.view,"pointer"):zv(this.view,t.pos,t.inside,e,this.selectNode)?e.preventDefault():e.button==0&&(this.flushed||St&&this.mightDrag&&!this.mightDrag.node.isAtom||ht&&!this.view.state.selection.visible&&Math.min(Math.abs(t.pos-this.view.state.selection.from),Math.abs(t.pos-this.view.state.selection.to))<=2)?(Ci(this.view,de.near(this.view.state.doc.resolve(t.pos))),e.preventDefault()):ps(this.view,"pointer")}move(e){this.updateAllowDefault(e),ps(this.view,"pointer"),e.buttons==0&&this.done()}updateAllowDefault(e){!this.allowDefault&&(Math.abs(this.event.x-e.clientX)>4||Math.abs(this.event.y-e.clientY)>4)&&(this.allowDefault=!0)}}kt.touchstart=n=>{n.input.lastTouch=Date.now(),Nc(n),ps(n,"pointer")};kt.touchmove=n=>{n.input.lastTouch=Date.now(),ps(n,"pointer")};kt.contextmenu=n=>Nc(n);function cm(n,e){return n.composing?!0:St&&Math.abs(e.timeStamp-n.input.compositionEndedAt)<500?(n.input.compositionEndedAt=-2e8,!0):!1}const Gv=un?5e3:-1;wt.compositionstart=wt.compositionupdate=n=>{if(!n.composing){n.domObserver.flush();let{state:e}=n,t=e.selection.$from;if(e.selection.empty&&(e.storedMarks||!t.textOffset&&t.parentOffset&&t.nodeBefore.marks.some(s=>s.type.spec.inclusive===!1)))n.markCursor=n.state.storedMarks||t.marks(),Oo(n,!0),n.markCursor=null;else if(Oo(n),mn&&e.selection.empty&&t.parentOffset&&!t.textOffset&&t.nodeBefore.marks.length){let s=n.domSelectionRange();for(let i=s.focusNode,r=s.focusOffset;i&&i.nodeType==1&&r!=0;){let o=r<0?i.lastChild:i.childNodes[r-1];if(!o)break;if(o.nodeType==3){n.domSelection().collapse(o,o.nodeValue.length);break}else i=o,r=-1}}n.input.composing=!0}dm(n,Gv)};wt.compositionend=(n,e)=>{n.composing&&(n.input.composing=!1,n.input.compositionEndedAt=e.timeStamp,n.input.compositionPendingChanges=n.domObserver.pendingRecords().length?n.input.compositionID:0,n.input.compositionNode=null,n.input.compositionPendingChanges&&Promise.resolve().then(()=>n.domObserver.flush()),n.input.compositionID++,dm(n,20))};function dm(n,e){clearTimeout(n.input.composingTimeout),e>-1&&(n.input.composingTimeout=setTimeout(()=>Oo(n),e))}function um(n){for(n.composing&&(n.input.composing=!1,n.input.compositionEndedAt=$v());n.input.compositionNodes.length>0;)n.input.compositionNodes.pop().markParentsDirty()}function qv(n){let e=n.domSelectionRange();if(!e.focusNode)return null;let t=BC(e.focusNode,e.focusOffset),s=zC(e.focusNode,e.focusOffset);if(t&&s&&t!=s){let i=s.pmViewDesc,r=n.domObserver.lastChangedTextNode;if(t==r||s==r)return r;if(!i||!i.isText(s.nodeValue))return s;if(n.input.compositionNode==s){let o=t.pmViewDesc;if(!(!o||!o.isText(t.nodeValue)))return s}}return t||s}function $v(){let n=document.createEvent("Event");return n.initEvent("event",!0,!0),n.timeStamp}function Oo(n,e=!1){if(!(un&&n.domObserver.flushingSoon>=0)){if(n.domObserver.forceFlush(),um(n),e||n.docView&&n.docView.dirty){let t=vc(n);return t&&!t.eq(n.state.selection)?n.dispatch(n.state.tr.setSelection(t)):n.updateState(n.state),!0}return!1}}function Kv(n,e){if(!n.dom.parentNode)return;let t=n.dom.parentNode.appendChild(document.createElement("div"));t.appendChild(e),t.style.cssText="position: fixed; left: -10000px; top: 10px";let s=getSelection(),i=document.createRange();i.selectNodeContents(e),n.dom.blur(),s.removeAllRanges(),s.addRange(i),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t),n.focus()},50)}const kr=Mt&&ys<15||Pi&&GC<604;kt.copy=wt.cut=(n,e)=>{let t=e,s=n.state.selection,i=t.type=="cut";if(s.empty)return;let r=kr?null:t.clipboardData,o=s.content(),{dom:a,text:l}=tm(n,o);r?(t.preventDefault(),r.clearData(),r.setData("text/html",a.innerHTML),r.setData("text/plain",l)):Kv(n,a),i&&n.dispatch(n.state.tr.deleteSelection().scrollIntoView().setMeta("uiEvent","cut"))};function Jv(n){return n.openStart==0&&n.openEnd==0&&n.content.childCount==1?n.content.firstChild:null}function Yv(n,e){if(!n.dom.parentNode)return;let t=n.input.shiftKey||n.state.selection.$from.parent.type.spec.code,s=n.dom.parentNode.appendChild(document.createElement(t?"textarea":"div"));t||(s.contentEditable="true"),s.style.cssText="position: fixed; left: -10000px; top: 10px",s.focus();let i=n.input.shiftKey&&n.input.lastKeyCode!=45;setTimeout(()=>{n.focus(),s.parentNode&&s.parentNode.removeChild(s),t?wr(n,s.value,null,i,e):wr(n,s.textContent,s.innerHTML,i,e)},50)}function wr(n,e,t,s,i){let r=nm(n,e,t,s,n.state.selection.$from);if(n.someProp("handlePaste",l=>l(n,i,r||q.empty)))return!0;if(!r)return!1;let o=Jv(r),a=o?n.state.tr.replaceSelectionWith(o,s):n.state.tr.replaceSelection(r);return n.dispatch(a.scrollIntoView().setMeta("paste",!0).setMeta("uiEvent","paste")),!0}function hm(n){let e=n.getData("text/plain")||n.getData("Text");if(e)return e;let t=n.getData("text/uri-list");return t?t.replace(/\r?\n/g," "):""}wt.paste=(n,e)=>{let t=e;if(n.composing&&!un)return;let s=kr?null:t.clipboardData,i=n.input.shiftKey&&n.input.lastKeyCode!=45;s&&wr(n,hm(s),s.getData("text/html"),i,t)?t.preventDefault():Yv(n,t)};class fm{constructor(e,t,s){this.slice=e,this.move=t,this.node=s}}const pm=Yt?"altKey":"ctrlKey";kt.dragstart=(n,e)=>{let t=e,s=n.input.mouseDown;if(s&&s.done(),!t.dataTransfer)return;let i=n.state.selection,r=i.empty?null:n.posAtCoords(la(t)),o;if(!(r&&r.pos>=i.from&&r.pos<=(i instanceof ie?i.to-1:i.to))){if(s&&s.mightDrag)o=ie.create(n.state.doc,s.mightDrag.pos);else if(t.target&&t.target.nodeType==1){let h=n.docView.nearestDesc(t.target,!0);h&&h.node.type.spec.draggable&&h!=n.docView&&(o=ie.create(n.state.doc,h.posBefore))}}let a=(o||n.state.selection).content(),{dom:l,text:d,slice:u}=tm(n,a);(!t.dataTransfer.files.length||!ht||Bp>120)&&t.dataTransfer.clearData(),t.dataTransfer.setData(kr?"Text":"text/html",l.innerHTML),t.dataTransfer.effectAllowed="copyMove",kr||t.dataTransfer.setData("text/plain",d),n.dragging=new fm(u,!t[pm],o)};kt.dragend=n=>{let e=n.dragging;window.setTimeout(()=>{n.dragging==e&&(n.dragging=null)},50)};wt.dragover=wt.dragenter=(n,e)=>e.preventDefault();wt.drop=(n,e)=>{let t=e,s=n.dragging;if(n.dragging=null,!t.dataTransfer)return;let i=n.posAtCoords(la(t));if(!i)return;let r=n.state.doc.resolve(i.pos),o=s&&s.slice;o?n.someProp("transformPasted",p=>{o=p(o,n)}):o=nm(n,hm(t.dataTransfer),kr?null:t.dataTransfer.getData("text/html"),!1,r);let a=!!(s&&!t[pm]);if(n.someProp("handleDrop",p=>p(n,t,o||q.empty,a))){t.preventDefault();return}if(!o)return;t.preventDefault();let l=o?sC(n.state.doc,r.pos,o):r.pos;l==null&&(l=r.pos);let d=n.state.tr;if(a){let{node:p}=s;p?p.replace(d):d.deleteSelection()}let u=d.mapping.map(l),h=o.openStart==0&&o.openEnd==0&&o.content.childCount==1,f=d.doc;if(h?d.replaceRangeWith(u,u,o.content.firstChild):d.replaceRange(u,u,o),d.doc.eq(f))return;let m=d.doc.resolve(u);if(h&&ie.isSelectable(o.content.firstChild)&&m.nodeAfter&&m.nodeAfter.sameMarkup(o.content.firstChild))d.setSelection(new ie(m));else{let p=d.mapping.map(l);d.mapping.maps[d.mapping.maps.length-1].forEach((g,S,x,w)=>p=w),d.setSelection(Mc(n,m,d.doc.resolve(p)))}n.focus(),n.dispatch(d.setMeta("uiEvent","drop"))};kt.focus=n=>{n.input.lastFocus=Date.now(),n.focused||(n.domObserver.stop(),n.dom.classList.add("ProseMirror-focused"),n.domObserver.start(),n.focused=!0,setTimeout(()=>{n.docView&&n.hasFocus()&&!n.domObserver.currentSelection.eq(n.domSelectionRange())&&qn(n)},20))};kt.blur=(n,e)=>{let t=e;n.focused&&(n.domObserver.stop(),n.dom.classList.remove("ProseMirror-focused"),n.domObserver.start(),t.relatedTarget&&n.dom.contains(t.relatedTarget)&&n.domObserver.currentSelection.clear(),n.focused=!1)};kt.beforeinput=(n,e)=>{if(ht&&un&&e.inputType=="deleteContentBackward"){n.domObserver.flushSoon();let{domChangeCount:s}=n.input;setTimeout(()=>{if(n.input.domChangeCount!=s||(n.dom.blur(),n.focus(),n.someProp("handleKeyDown",r=>r(n,Ls(8,"Backspace")))))return;let{$cursor:i}=n.state.selection;i&&i.pos>0&&n.dispatch(n.state.tr.delete(i.pos-1,i.pos).scrollIntoView())},50)}};for(let n in wt)kt[n]=wt[n];function Cr(n,e){if(n==e)return!0;for(let t in n)if(n[t]!==e[t])return!1;for(let t in e)if(!(t in n))return!1;return!0}class Po{constructor(e,t){this.toDOM=e,this.spec=t||$s,this.side=this.spec.side||0}map(e,t,s,i){let{pos:r,deleted:o}=e.mapResult(t.from+i,this.side<0?-1:1);return o?null:new Bt(r-s,r-s,this)}valid(){return!0}eq(e){return this==e||e instanceof Po&&(this.spec.key&&this.spec.key==e.spec.key||this.toDOM==e.toDOM&&Cr(this.spec,e.spec))}destroy(e){this.spec.destroy&&this.spec.destroy(e)}}class bs{constructor(e,t){this.attrs=e,this.spec=t||$s}map(e,t,s,i){let r=e.map(t.from+i,this.spec.inclusiveStart?-1:1)-s,o=e.map(t.to+i,this.spec.inclusiveEnd?1:-1)-s;return r>=o?null:new Bt(r,o,this)}valid(e,t){return t.from<t.to}eq(e){return this==e||e instanceof bs&&Cr(this.attrs,e.attrs)&&Cr(this.spec,e.spec)}static is(e){return e.type instanceof bs}destroy(){}}class Ec{constructor(e,t){this.attrs=e,this.spec=t||$s}map(e,t,s,i){let r=e.mapResult(t.from+i,1);if(r.deleted)return null;let o=e.mapResult(t.to+i,-1);return o.deleted||o.pos<=r.pos?null:new Bt(r.pos-s,o.pos-s,this)}valid(e,t){let{index:s,offset:i}=e.content.findIndex(t.from),r;return i==t.from&&!(r=e.child(s)).isText&&i+r.nodeSize==t.to}eq(e){return this==e||e instanceof Ec&&Cr(this.attrs,e.attrs)&&Cr(this.spec,e.spec)}destroy(){}}class Bt{constructor(e,t,s){this.from=e,this.to=t,this.type=s}copy(e,t){return new Bt(e,t,this.type)}eq(e,t=0){return this.type.eq(e.type)&&this.from+t==e.from&&this.to+t==e.to}map(e,t,s){return this.type.map(e,this,t,s)}static widget(e,t,s){return new Bt(e,e,new Po(t,s))}static inline(e,t,s,i){return new Bt(e,t,new bs(s,i))}static node(e,t,s,i){return new Bt(e,t,new Ec(s,i))}get spec(){return this.type.spec}get inline(){return this.type instanceof bs}get widget(){return this.type instanceof Po}}const yi=[],$s={};class Ge{constructor(e,t){this.local=e.length?e:yi,this.children=t.length?t:yi}static create(e,t){return t.length?Fo(t,e,0,$s):dt}find(e,t,s){let i=[];return this.findInner(e??0,t??1e9,i,0,s),i}findInner(e,t,s,i,r){for(let o=0;o<this.local.length;o++){let a=this.local[o];a.from<=t&&a.to>=e&&(!r||r(a.spec))&&s.push(a.copy(a.from+i,a.to+i))}for(let o=0;o<this.children.length;o+=3)if(this.children[o]<t&&this.children[o+1]>e){let a=this.children[o]+1;this.children[o+2].findInner(e-a,t-a,s,i+a,r)}}map(e,t,s){return this==dt||e.maps.length==0?this:this.mapInner(e,t,0,0,s||$s)}mapInner(e,t,s,i,r){let o;for(let a=0;a<this.local.length;a++){let l=this.local[a].map(e,s,i);l&&l.type.valid(t,l)?(o||(o=[])).push(l):r.onRemove&&r.onRemove(this.local[a].spec)}return this.children.length?Qv(this.children,o||[],e,t,s,i,r):o?new Ge(o.sort(Ks),yi):dt}add(e,t){return t.length?this==dt?Ge.create(e,t):this.addInner(e,t,0):this}addInner(e,t,s){let i,r=0;e.forEach((a,l)=>{let d=l+s,u;if(u=gm(t,a,d)){for(i||(i=this.children.slice());r<i.length&&i[r]<l;)r+=3;i[r]==l?i[r+2]=i[r+2].addInner(a,u,d+1):i.splice(r,0,l,l+a.nodeSize,Fo(u,a,d+1,$s)),r+=3}});let o=mm(r?ym(t):t,-s);for(let a=0;a<o.length;a++)o[a].type.valid(e,o[a])||o.splice(a--,1);return new Ge(o.length?this.local.concat(o).sort(Ks):this.local,i||this.children)}remove(e){return e.length==0||this==dt?this:this.removeInner(e,0)}removeInner(e,t){let s=this.children,i=this.local;for(let r=0;r<s.length;r+=3){let o,a=s[r]+t,l=s[r+1]+t;for(let u=0,h;u<e.length;u++)(h=e[u])&&h.from>a&&h.to<l&&(e[u]=null,(o||(o=[])).push(h));if(!o)continue;s==this.children&&(s=this.children.slice());let d=s[r+2].removeInner(o,a+1);d!=dt?s[r+2]=d:(s.splice(r,3),r-=3)}if(i.length){for(let r=0,o;r<e.length;r++)if(o=e[r])for(let a=0;a<i.length;a++)i[a].eq(o,t)&&(i==this.local&&(i=this.local.slice()),i.splice(a--,1))}return s==this.children&&i==this.local?this:i.length||s.length?new Ge(i,s):dt}forChild(e,t){if(this==dt)return this;if(t.isLeaf)return Ge.empty;let s,i;for(let a=0;a<this.children.length;a+=3)if(this.children[a]>=e){this.children[a]==e&&(s=this.children[a+2]);break}let r=e+1,o=r+t.content.size;for(let a=0;a<this.local.length;a++){let l=this.local[a];if(l.from<o&&l.to>r&&l.type instanceof bs){let d=Math.max(r,l.from)-r,u=Math.min(o,l.to)-r;d<u&&(i||(i=[])).push(l.copy(d,u))}}if(i){let a=new Ge(i.sort(Ks),yi);return s?new cs([a,s]):a}return s||dt}eq(e){if(this==e)return!0;if(!(e instanceof Ge)||this.local.length!=e.local.length||this.children.length!=e.children.length)return!1;for(let t=0;t<this.local.length;t++)if(!this.local[t].eq(e.local[t]))return!1;for(let t=0;t<this.children.length;t+=3)if(this.children[t]!=e.children[t]||this.children[t+1]!=e.children[t+1]||!this.children[t+2].eq(e.children[t+2]))return!1;return!0}locals(e){return Ic(this.localsInner(e))}localsInner(e){if(this==dt)return yi;if(e.inlineContent||!this.local.some(bs.is))return this.local;let t=[];for(let s=0;s<this.local.length;s++)this.local[s].type instanceof bs||t.push(this.local[s]);return t}}Ge.empty=new Ge([],[]);Ge.removeOverlap=Ic;const dt=Ge.empty;class cs{constructor(e){this.members=e}map(e,t){const s=this.members.map(i=>i.map(e,t,$s));return cs.from(s)}forChild(e,t){if(t.isLeaf)return Ge.empty;let s=[];for(let i=0;i<this.members.length;i++){let r=this.members[i].forChild(e,t);r!=dt&&(r instanceof cs?s=s.concat(r.members):s.push(r))}return cs.from(s)}eq(e){if(!(e instanceof cs)||e.members.length!=this.members.length)return!1;for(let t=0;t<this.members.length;t++)if(!this.members[t].eq(e.members[t]))return!1;return!0}locals(e){let t,s=!0;for(let i=0;i<this.members.length;i++){let r=this.members[i].localsInner(e);if(r.length)if(!t)t=r;else{s&&(t=t.slice(),s=!1);for(let o=0;o<r.length;o++)t.push(r[o])}}return t?Ic(s?t:t.sort(Ks)):yi}static from(e){switch(e.length){case 0:return dt;case 1:return e[0];default:return new cs(e.every(t=>t instanceof Ge)?e:e.reduce((t,s)=>t.concat(s instanceof Ge?s:s.members),[]))}}}function Qv(n,e,t,s,i,r,o){let a=n.slice();for(let d=0,u=r;d<t.maps.length;d++){let h=0;t.maps[d].forEach((f,m,p,g)=>{let S=g-p-(m-f);for(let x=0;x<a.length;x+=3){let w=a[x+1];if(w<0||f>w+u-h)continue;let C=a[x]+u-h;m>=C?a[x+1]=f<=C?-2:-1:f>=u&&S&&(a[x]+=S,a[x+1]+=S)}h+=S}),u=t.maps[d].map(u,-1)}let l=!1;for(let d=0;d<a.length;d+=3)if(a[d+1]<0){if(a[d+1]==-2){l=!0,a[d+1]=-1;continue}let u=t.map(n[d]+r),h=u-i;if(h<0||h>=s.content.size){l=!0;continue}let f=t.map(n[d+1]+r,-1),m=f-i,{index:p,offset:g}=s.content.findIndex(h),S=s.maybeChild(p);if(S&&g==h&&g+S.nodeSize==m){let x=a[d+2].mapInner(t,S,u+1,n[d]+r+1,o);x!=dt?(a[d]=h,a[d+1]=m,a[d+2]=x):(a[d+1]=-2,l=!0)}else l=!0}if(l){let d=Xv(a,n,e,t,i,r,o),u=Fo(d,s,0,o);e=u.local;for(let h=0;h<a.length;h+=3)a[h+1]<0&&(a.splice(h,3),h-=3);for(let h=0,f=0;h<u.children.length;h+=3){let m=u.children[h];for(;f<a.length&&a[f]<m;)f+=3;a.splice(f,0,u.children[h],u.children[h+1],u.children[h+2])}}return new Ge(e.sort(Ks),a)}function mm(n,e){if(!e||!n.length)return n;let t=[];for(let s=0;s<n.length;s++){let i=n[s];t.push(new Bt(i.from+e,i.to+e,i.type))}return t}function Xv(n,e,t,s,i,r,o){function a(l,d){for(let u=0;u<l.local.length;u++){let h=l.local[u].map(s,i,d);h?t.push(h):o.onRemove&&o.onRemove(l.local[u].spec)}for(let u=0;u<l.children.length;u+=3)a(l.children[u+2],l.children[u]+d+1)}for(let l=0;l<n.length;l+=3)n[l+1]==-1&&a(n[l+2],e[l]+r+1);return t}function gm(n,e,t){if(e.isLeaf)return null;let s=t+e.nodeSize,i=null;for(let r=0,o;r<n.length;r++)(o=n[r])&&o.from>t&&o.to<s&&((i||(i=[])).push(o),n[r]=null);return i}function ym(n){let e=[];for(let t=0;t<n.length;t++)n[t]!=null&&e.push(n[t]);return e}function Fo(n,e,t,s){let i=[],r=!1;e.forEach((a,l)=>{let d=gm(n,a,l+t);if(d){r=!0;let u=Fo(d,a,t+l+1,s);u!=dt&&i.push(l,l+a.nodeSize,u)}});let o=mm(r?ym(n):n,-t).sort(Ks);for(let a=0;a<o.length;a++)o[a].type.valid(e,o[a])||(s.onRemove&&s.onRemove(o[a].spec),o.splice(a--,1));return o.length||i.length?new Ge(o,i):dt}function Ks(n,e){return n.from-e.from||n.to-e.to}function Ic(n){let e=n;for(let t=0;t<e.length-1;t++){let s=e[t];if(s.from!=s.to)for(let i=t+1;i<e.length;i++){let r=e[i];if(r.from==s.from){r.to!=s.to&&(e==n&&(e=n.slice()),e[i]=r.copy(r.from,s.to),pu(e,i+1,r.copy(s.to,r.to)));continue}else{r.from<s.to&&(e==n&&(e=n.slice()),e[t]=s.copy(s.from,r.from),pu(e,i,s.copy(r.from,s.to)));break}}}return e}function pu(n,e,t){for(;e<n.length&&Ks(t,n[e])>0;)e++;n.splice(e,0,t)}function ja(n){let e=[];return n.someProp("decorations",t=>{let s=t(n.state);s&&s!=dt&&e.push(s)}),n.cursorWrapper&&e.push(Ge.create(n.state.doc,[n.cursorWrapper.deco])),cs.from(e)}const Zv={childList:!0,characterData:!0,characterDataOldValue:!0,attributes:!0,attributeOldValue:!0,subtree:!0},eM=Mt&&ys<=11;class tM{constructor(){this.anchorNode=null,this.anchorOffset=0,this.focusNode=null,this.focusOffset=0}set(e){this.anchorNode=e.anchorNode,this.anchorOffset=e.anchorOffset,this.focusNode=e.focusNode,this.focusOffset=e.focusOffset}clear(){this.anchorNode=this.focusNode=null}eq(e){return e.anchorNode==this.anchorNode&&e.anchorOffset==this.anchorOffset&&e.focusNode==this.focusNode&&e.focusOffset==this.focusOffset}}class nM{constructor(e,t){this.view=e,this.handleDOMChange=t,this.queue=[],this.flushingSoon=-1,this.observer=null,this.currentSelection=new tM,this.onCharData=null,this.suppressingSelectionUpdates=!1,this.lastChangedTextNode=null,this.observer=window.MutationObserver&&new window.MutationObserver(s=>{for(let i=0;i<s.length;i++)this.queue.push(s[i]);Mt&&ys<=11&&s.some(i=>i.type=="childList"&&i.removedNodes.length||i.type=="characterData"&&i.oldValue.length>i.target.nodeValue.length)?this.flushSoon():this.flush()}),eM&&(this.onCharData=s=>{this.queue.push({target:s.target,type:"characterData",oldValue:s.prevValue}),this.flushSoon()}),this.onSelectionChange=this.onSelectionChange.bind(this)}flushSoon(){this.flushingSoon<0&&(this.flushingSoon=window.setTimeout(()=>{this.flushingSoon=-1,this.flush()},20))}forceFlush(){this.flushingSoon>-1&&(window.clearTimeout(this.flushingSoon),this.flushingSoon=-1,this.flush())}start(){this.observer&&(this.observer.takeRecords(),this.observer.observe(this.view.dom,Zv)),this.onCharData&&this.view.dom.addEventListener("DOMCharacterDataModified",this.onCharData),this.connectSelection()}stop(){if(this.observer){let e=this.observer.takeRecords();if(e.length){for(let t=0;t<e.length;t++)this.queue.push(e[t]);window.setTimeout(()=>this.flush(),20)}this.observer.disconnect()}this.onCharData&&this.view.dom.removeEventListener("DOMCharacterDataModified",this.onCharData),this.disconnectSelection()}connectSelection(){this.view.dom.ownerDocument.addEventListener("selectionchange",this.onSelectionChange)}disconnectSelection(){this.view.dom.ownerDocument.removeEventListener("selectionchange",this.onSelectionChange)}suppressSelectionUpdates(){this.suppressingSelectionUpdates=!0,setTimeout(()=>this.suppressingSelectionUpdates=!1,50)}onSelectionChange(){if(ou(this.view)){if(this.suppressingSelectionUpdates)return qn(this.view);if(Mt&&ys<=11&&!this.view.state.selection.empty){let e=this.view.domSelectionRange();if(e.focusNode&&Xs(e.focusNode,e.focusOffset,e.anchorNode,e.anchorOffset))return this.flushSoon()}this.flush()}}setCurSelection(){this.currentSelection.set(this.view.domSelectionRange())}ignoreSelectionChange(e){if(!e.focusNode)return!0;let t=new Set,s;for(let r=e.focusNode;r;r=Sr(r))t.add(r);for(let r=e.anchorNode;r;r=Sr(r))if(t.has(r)){s=r;break}let i=s&&this.view.docView.nearestDesc(s);if(i&&i.ignoreMutation({type:"selection",target:s.nodeType==3?s.parentNode:s}))return this.setCurSelection(),!0}pendingRecords(){if(this.observer)for(let e of this.observer.takeRecords())this.queue.push(e);return this.queue}flush(){let{view:e}=this;if(!e.docView||this.flushingSoon>-1)return;let t=this.pendingRecords();t.length&&(this.queue=[]);let s=e.domSelectionRange(),i=!this.suppressingSelectionUpdates&&!this.currentSelection.eq(s)&&ou(e)&&!this.ignoreSelectionChange(s),r=-1,o=-1,a=!1,l=[];if(e.editable)for(let u=0;u<t.length;u++){let h=this.registerMutation(t[u],l);h&&(r=r<0?h.from:Math.min(h.from,r),o=o<0?h.to:Math.max(h.to,o),h.typeOver&&(a=!0))}if(mn&&l.length){let u=l.filter(h=>h.nodeName=="BR");if(u.length==2){let[h,f]=u;h.parentNode&&h.parentNode.parentNode==f.parentNode?f.remove():h.remove()}else{let{focusNode:h}=this.currentSelection;for(let f of u){let m=f.parentNode;m&&m.nodeName=="LI"&&(!h||rM(e,h)!=m)&&f.remove()}}}let d=null;r<0&&i&&e.input.lastFocus>Date.now()-200&&Math.max(e.input.lastTouch,e.input.lastClick.time)<Date.now()-300&&oa(s)&&(d=vc(e))&&d.eq(de.near(e.state.doc.resolve(0),1))?(e.input.lastFocus=0,qn(e),this.currentSelection.set(s),e.scrollToSelection()):(r>-1||i)&&(r>-1&&(e.docView.markDirty(r,o),sM(e)),this.handleDOMChange(r,o,a,l),e.docView&&e.docView.dirty?e.updateState(e.state):this.currentSelection.eq(s)||qn(e),this.currentSelection.set(s))}registerMutation(e,t){if(t.indexOf(e.target)>-1)return null;let s=this.view.docView.nearestDesc(e.target);if(e.type=="attributes"&&(s==this.view.docView||e.attributeName=="contenteditable"||e.attributeName=="style"&&!e.oldValue&&!e.target.getAttribute("style"))||!s||s.ignoreMutation(e))return null;if(e.type=="childList"){for(let u=0;u<e.addedNodes.length;u++){let h=e.addedNodes[u];t.push(h),h.nodeType==3&&(this.lastChangedTextNode=h)}if(s.contentDOM&&s.contentDOM!=s.dom&&!s.contentDOM.contains(e.target))return{from:s.posBefore,to:s.posAfter};let i=e.previousSibling,r=e.nextSibling;if(Mt&&ys<=11&&e.addedNodes.length)for(let u=0;u<e.addedNodes.length;u++){let{previousSibling:h,nextSibling:f}=e.addedNodes[u];(!h||Array.prototype.indexOf.call(e.addedNodes,h)<0)&&(i=h),(!f||Array.prototype.indexOf.call(e.addedNodes,f)<0)&&(r=f)}let o=i&&i.parentNode==e.target?rt(i)+1:0,a=s.localPosFromDOM(e.target,o,-1),l=r&&r.parentNode==e.target?rt(r):e.target.childNodes.length,d=s.localPosFromDOM(e.target,l,1);return{from:a,to:d}}else return e.type=="attributes"?{from:s.posAtStart-s.border,to:s.posAtEnd+s.border}:(this.lastChangedTextNode=e.target,{from:s.posAtStart,to:s.posAtEnd,typeOver:e.target.nodeValue==e.oldValue})}}let mu=new WeakMap,gu=!1;function sM(n){if(!mu.has(n)&&(mu.set(n,null),["normal","nowrap","pre-line"].indexOf(getComputedStyle(n.dom).whiteSpace)!==-1)){if(n.requiresGeckoHackNode=mn,gu)return;console.warn("ProseMirror expects the CSS white-space property to be set, preferably to 'pre-wrap'. It is recommended to load style/prosemirror.css from the prosemirror-view package."),gu=!0}}function yu(n,e){let t=e.startContainer,s=e.startOffset,i=e.endContainer,r=e.endOffset,o=n.domAtPos(n.state.selection.anchor);return Xs(o.node,o.offset,i,r)&&([t,s,i,r]=[i,r,t,s]),{anchorNode:t,anchorOffset:s,focusNode:i,focusOffset:r}}function iM(n,e){if(e.getComposedRanges){let i=e.getComposedRanges(n.root)[0];if(i)return yu(n,i)}let t;function s(i){i.preventDefault(),i.stopImmediatePropagation(),t=i.getTargetRanges()[0]}return n.dom.addEventListener("beforeinput",s,!0),document.execCommand("indent"),n.dom.removeEventListener("beforeinput",s,!0),t?yu(n,t):null}function rM(n,e){for(let t=e.parentNode;t&&t!=n.dom;t=t.parentNode){let s=n.docView.nearestDesc(t,!0);if(s&&s.node.isBlock)return t}return null}function oM(n,e,t){let{node:s,fromOffset:i,toOffset:r,from:o,to:a}=n.docView.parseRange(e,t),l=n.domSelectionRange(),d,u=l.anchorNode;if(u&&n.dom.contains(u.nodeType==1?u:u.parentNode)&&(d=[{node:u,offset:l.anchorOffset}],oa(l)||d.push({node:l.focusNode,offset:l.focusOffset})),ht&&n.input.lastKeyCode===8)for(let S=r;S>i;S--){let x=s.childNodes[S-1],w=x.pmViewDesc;if(x.nodeName=="BR"&&!w){r=S;break}if(!w||w.size)break}let h=n.state.doc,f=n.someProp("domParser")||xr.fromSchema(n.state.schema),m=h.resolve(o),p=null,g=f.parse(s,{topNode:m.parent,topMatch:m.parent.contentMatchAt(m.index()),topOpen:!0,from:i,to:r,preserveWhitespace:m.parent.type.whitespace=="pre"?"full":!0,findPositions:d,ruleFromNode:aM,context:m});if(d&&d[0].pos!=null){let S=d[0].pos,x=d[1]&&d[1].pos;x==null&&(x=S),p={anchor:S+o,head:x+o}}return{doc:g,sel:p,from:o,to:a}}function aM(n){let e=n.pmViewDesc;if(e)return e.parseRule();if(n.nodeName=="BR"&&n.parentNode){if(St&&/^(ul|ol)$/i.test(n.parentNode.nodeName)){let t=document.createElement("div");return t.appendChild(document.createElement("li")),{skip:t}}else if(n.parentNode.lastChild==n||St&&/^(tr|table)$/i.test(n.parentNode.nodeName))return{ignore:!0}}else if(n.nodeName=="IMG"&&n.getAttribute("mark-placeholder"))return{ignore:!0};return null}const lM=/^(a|abbr|acronym|b|bd[io]|big|br|button|cite|code|data(list)?|del|dfn|em|i|ins|kbd|label|map|mark|meter|output|q|ruby|s|samp|small|span|strong|su[bp]|time|u|tt|var)$/i;function cM(n,e,t,s,i){let r=n.input.compositionPendingChanges||(n.composing?n.input.compositionID:0);if(n.input.compositionPendingChanges=0,e<0){let _=n.input.lastSelectionTime>Date.now()-50?n.input.lastSelectionOrigin:null,N=vc(n,_);if(N&&!n.state.selection.eq(N)){if(ht&&un&&n.input.lastKeyCode===13&&Date.now()-100<n.input.lastKeyCodeTime&&n.someProp("handleKeyDown",j=>j(n,Ls(13,"Enter"))))return;let z=n.state.tr.setSelection(N);_=="pointer"?z.setMeta("pointer",!0):_=="key"&&z.scrollIntoView(),r&&z.setMeta("composition",r),n.dispatch(z)}return}let o=n.state.doc.resolve(e),a=o.sharedDepth(t);e=o.before(a+1),t=n.state.doc.resolve(t).after(a+1);let l=n.state.selection,d=oM(n,e,t),u=n.state.doc,h=u.slice(d.from,d.to),f,m;n.input.lastKeyCode===8&&Date.now()-100<n.input.lastKeyCodeTime?(f=n.state.selection.to,m="end"):(f=n.state.selection.from,m="start"),n.input.lastKeyCode=null;let p=hM(h.content,d.doc.content,d.from,f,m);if((Pi&&n.input.lastIOSEnter>Date.now()-225||un)&&i.some(_=>_.nodeType==1&&!lM.test(_.nodeName))&&(!p||p.endA>=p.endB)&&n.someProp("handleKeyDown",_=>_(n,Ls(13,"Enter")))){n.input.lastIOSEnter=0;return}if(!p)if(s&&l instanceof ye&&!l.empty&&l.$head.sameParent(l.$anchor)&&!n.composing&&!(d.sel&&d.sel.anchor!=d.sel.head))p={start:l.from,endA:l.to,endB:l.to};else{if(d.sel){let _=xu(n,n.state.doc,d.sel);if(_&&!_.eq(n.state.selection)){let N=n.state.tr.setSelection(_);r&&N.setMeta("composition",r),n.dispatch(N)}}return}n.input.domChangeCount++,n.state.selection.from<n.state.selection.to&&p.start==p.endB&&n.state.selection instanceof ye&&(p.start>n.state.selection.from&&p.start<=n.state.selection.from+2&&n.state.selection.from>=d.from?p.start=n.state.selection.from:p.endA<n.state.selection.to&&p.endA>=n.state.selection.to-2&&n.state.selection.to<=d.to&&(p.endB+=n.state.selection.to-p.endA,p.endA=n.state.selection.to)),Mt&&ys<=11&&p.endB==p.start+1&&p.endA==p.start&&p.start>d.from&&d.doc.textBetween(p.start-d.from-1,p.start-d.from+1)==" Â "&&(p.start--,p.endA--,p.endB--);let g=d.doc.resolveNoCache(p.start-d.from),S=d.doc.resolveNoCache(p.endB-d.from),x=u.resolve(p.start),w=g.sameParent(S)&&g.parent.inlineContent&&x.end()>=p.endA,C;if((Pi&&n.input.lastIOSEnter>Date.now()-225&&(!w||i.some(_=>_.nodeName=="DIV"||_.nodeName=="P"))||!w&&g.pos<d.doc.content.size&&!g.sameParent(S)&&(C=de.findFrom(d.doc.resolve(g.pos+1),1,!0))&&C.head==S.pos)&&n.someProp("handleKeyDown",_=>_(n,Ls(13,"Enter")))){n.input.lastIOSEnter=0;return}if(n.state.selection.anchor>p.start&&uM(u,p.start,p.endA,g,S)&&n.someProp("handleKeyDown",_=>_(n,Ls(8,"Backspace")))){un&&ht&&n.domObserver.suppressSelectionUpdates();return}ht&&un&&p.endB==p.start&&(n.input.lastAndroidDelete=Date.now()),un&&!w&&g.start()!=S.start()&&S.parentOffset==0&&g.depth==S.depth&&d.sel&&d.sel.anchor==d.sel.head&&d.sel.head==p.endA&&(p.endB-=2,S=d.doc.resolveNoCache(p.endB-d.from),setTimeout(()=>{n.someProp("handleKeyDown",function(_){return _(n,Ls(13,"Enter"))})},20));let k=p.start,v=p.endA,T,A,L;if(w){if(g.pos==S.pos)Mt&&ys<=11&&g.parentOffset==0&&(n.domObserver.suppressSelectionUpdates(),setTimeout(()=>qn(n),20)),T=n.state.tr.delete(k,v),A=u.resolve(p.start).marksAcross(u.resolve(p.endA));else if(p.endA==p.endB&&(L=dM(g.parent.content.cut(g.parentOffset,S.parentOffset),x.parent.content.cut(x.parentOffset,p.endA-x.start()))))T=n.state.tr,L.type=="add"?T.addMark(k,v,L.mark):T.removeMark(k,v,L.mark);else if(g.parent.child(g.index()).isText&&g.index()==S.index()-(S.textOffset?0:1)){let _=g.parent.textBetween(g.parentOffset,S.parentOffset);if(n.someProp("handleTextInput",N=>N(n,k,v,_)))return;T=n.state.tr.insertText(_,k,v)}}if(T||(T=n.state.tr.replace(k,v,d.doc.slice(p.start-d.from,p.endB-d.from))),d.sel){let _=xu(n,T.doc,d.sel);_&&!(ht&&un&&n.composing&&_.empty&&(p.start!=p.endB||n.input.lastAndroidDelete<Date.now()-100)&&(_.head==k||_.head==T.mapping.map(v)-1)||Mt&&_.empty&&_.head==k)&&T.setSelection(_)}A&&T.ensureMarks(A),r&&T.setMeta("composition",r),n.dispatch(T.scrollIntoView())}function xu(n,e,t){return Math.max(t.anchor,t.head)>e.content.size?null:Mc(n,e.resolve(t.anchor),e.resolve(t.head))}function dM(n,e){let t=n.firstChild.marks,s=e.firstChild.marks,i=t,r=s,o,a,l;for(let u=0;u<s.length;u++)i=s[u].removeFromSet(i);for(let u=0;u<t.length;u++)r=t[u].removeFromSet(r);if(i.length==1&&r.length==0)a=i[0],o="add",l=u=>u.mark(a.addToSet(u.marks));else if(i.length==0&&r.length==1)a=r[0],o="remove",l=u=>u.mark(a.removeFromSet(u.marks));else return null;let d=[];for(let u=0;u<e.childCount;u++)d.push(l(e.child(u)));if(P.from(d).eq(n))return{mark:a,type:o}}function uM(n,e,t,s,i){if(t-e<=i.pos-s.pos||Ra(s,!0,!1)<i.pos)return!1;let r=n.resolve(e);if(!s.parent.isTextblock){let a=r.nodeAfter;return a!=null&&t==e+a.nodeSize}if(r.parentOffset<r.parent.content.size||!r.parent.isTextblock)return!1;let o=n.resolve(Ra(r,!0,!0));return!o.parent.isTextblock||o.pos>t||Ra(o,!0,!1)<t?!1:s.parent.content.cut(s.parentOffset).eq(o.parent.content)}function Ra(n,e,t){let s=n.depth,i=e?n.end():n.pos;for(;s>0&&(e||n.indexAfter(s)==n.node(s).childCount);)s--,i++,e=!1;if(t){let r=n.node(s).maybeChild(n.indexAfter(s));for(;r&&!r.isLeaf;)r=r.firstChild,i++}return i}function hM(n,e,t,s,i){let r=n.findDiffStart(e,t);if(r==null)return null;let{a:o,b:a}=n.findDiffEnd(e,t+n.size,t+e.size);if(i=="end"){let l=Math.max(0,r-Math.min(o,a));s-=o+l-r}if(o<r&&n.size<e.size){let l=s<=r&&s>=o?r-s:0;r-=l,r&&r<e.size&&bu(e.textBetween(r-1,r+1))&&(r+=l?1:-1),a=r+(a-o),o=r}else if(a<r){let l=s<=r&&s>=a?r-s:0;r-=l,r&&r<n.size&&bu(n.textBetween(r-1,r+1))&&(r+=l?1:-1),o=r+(o-a),a=r}return{start:r,endA:o,endB:a}}function bu(n){if(n.length!=2)return!1;let e=n.charCodeAt(0),t=n.charCodeAt(1);return e>=56320&&e<=57343&&t>=55296&&t<=56319}class fM{constructor(e,t){this._root=null,this.focused=!1,this.trackWrites=null,this.mounted=!1,this.markCursor=null,this.cursorWrapper=null,this.lastSelectedViewDesc=void 0,this.input=new jv,this.prevDirectPlugins=[],this.pluginViews=[],this.requiresGeckoHackNode=!1,this.dragging=null,this._props=t,this.state=t.state,this.directPlugins=t.plugins||[],this.directPlugins.forEach(vu),this.dispatch=this.dispatch.bind(this),this.dom=e&&e.mount||document.createElement("div"),e&&(e.appendChild?e.appendChild(this.dom):typeof e=="function"?e(this.dom):e.mount&&(this.mounted=!0)),this.editable=wu(this),ku(this),this.nodeViews=Cu(this),this.docView=eu(this.state.doc,Su(this),ja(this),this.dom,this),this.domObserver=new nM(this,(s,i,r,o)=>cM(this,s,i,r,o)),this.domObserver.start(),Rv(this),this.updatePluginViews()}get composing(){return this.input.composing}get props(){if(this._props.state!=this.state){let e=this._props;this._props={};for(let t in e)this._props[t]=e[t];this._props.state=this.state}return this._props}update(e){e.handleDOMEvents!=this._props.handleDOMEvents&&yl(this);let t=this._props;this._props=e,e.plugins&&(e.plugins.forEach(vu),this.directPlugins=e.plugins),this.updateStateInner(e.state,t)}setProps(e){let t={};for(let s in this._props)t[s]=this._props[s];t.state=this.state;for(let s in e)t[s]=e[s];this.update(t)}updateState(e){this.updateStateInner(e,this._props)}updateStateInner(e,t){var s;let i=this.state,r=!1,o=!1;e.storedMarks&&this.composing&&(um(this),o=!0),this.state=e;let a=i.plugins!=e.plugins||this._props.plugins!=t.plugins;if(a||this._props.plugins!=t.plugins||this._props.nodeViews!=t.nodeViews){let m=Cu(this);mM(m,this.nodeViews)&&(this.nodeViews=m,r=!0)}(a||t.handleDOMEvents!=this._props.handleDOMEvents)&&yl(this),this.editable=wu(this),ku(this);let l=ja(this),d=Su(this),u=i.plugins!=e.plugins&&!i.doc.eq(e.doc)?"reset":e.scrollToSelection>i.scrollToSelection?"to selection":"preserve",h=r||!this.docView.matchesNode(e.doc,d,l);(h||!e.selection.eq(i.selection))&&(o=!0);let f=u=="preserve"&&o&&this.dom.style.overflowAnchor==null&&KC(this);if(o){this.domObserver.stop();let m=h&&(Mt||ht)&&!this.composing&&!i.selection.empty&&!e.selection.empty&&pM(i.selection,e.selection);if(h){let p=ht?this.trackWrites=this.domSelectionRange().focusNode:null;this.composing&&(this.input.compositionNode=qv(this)),(r||!this.docView.update(e.doc,d,l,this))&&(this.docView.updateOuterDeco(d),this.docView.destroy(),this.docView=eu(e.doc,d,l,this.dom,this)),p&&!this.trackWrites&&(m=!0)}m||!(this.input.mouseDown&&this.domObserver.currentSelection.eq(this.domSelectionRange())&&xv(this))?qn(this,m):(Xp(this,e.selection),this.domObserver.setCurSelection()),this.domObserver.start()}this.updatePluginViews(i),!((s=this.dragging)===null||s===void 0)&&s.node&&!i.doc.eq(e.doc)&&this.updateDraggedNode(this.dragging,i),u=="reset"?this.dom.scrollTop=0:u=="to selection"?this.scrollToSelection():f&&JC(f)}scrollToSelection(){let e=this.domSelectionRange().focusNode;if(!this.someProp("handleScrollToSelection",t=>t(this)))if(this.state.selection instanceof ie){let t=this.docView.domAfterPos(this.state.selection.from);t.nodeType==1&&Kd(this,t.getBoundingClientRect(),e)}else Kd(this,this.coordsAtPos(this.state.selection.head,1),e)}destroyPluginViews(){let e;for(;e=this.pluginViews.pop();)e.destroy&&e.destroy()}updatePluginViews(e){if(!e||e.plugins!=this.state.plugins||this.directPlugins!=this.prevDirectPlugins){this.prevDirectPlugins=this.directPlugins,this.destroyPluginViews();for(let t=0;t<this.directPlugins.length;t++){let s=this.directPlugins[t];s.spec.view&&this.pluginViews.push(s.spec.view(this))}for(let t=0;t<this.state.plugins.length;t++){let s=this.state.plugins[t];s.spec.view&&this.pluginViews.push(s.spec.view(this))}}else for(let t=0;t<this.pluginViews.length;t++){let s=this.pluginViews[t];s.update&&s.update(this,e)}}updateDraggedNode(e,t){let s=e.node,i=-1;if(this.state.doc.nodeAt(s.from)==s.node)i=s.from;else{let r=s.from+(this.state.doc.content.size-t.doc.content.size);(r>0&&this.state.doc.nodeAt(r))==s.node&&(i=r)}this.dragging=new fm(e.slice,e.move,i<0?void 0:ie.create(this.state.doc,i))}someProp(e,t){let s=this._props&&this._props[e],i;if(s!=null&&(i=t?t(s):s))return i;for(let o=0;o<this.directPlugins.length;o++){let a=this.directPlugins[o].props[e];if(a!=null&&(i=t?t(a):a))return i}let r=this.state.plugins;if(r)for(let o=0;o<r.length;o++){let a=r[o].props[e];if(a!=null&&(i=t?t(a):a))return i}}hasFocus(){if(Mt){let e=this.root.activeElement;if(e==this.dom)return!0;if(!e||!this.dom.contains(e))return!1;for(;e&&this.dom!=e&&this.dom.contains(e);){if(e.contentEditable=="false")return!1;e=e.parentElement}return!0}return this.root.activeElement==this.dom}focus(){this.domObserver.stop(),this.editable&&YC(this.dom),qn(this),this.domObserver.start()}get root(){let e=this._root;if(e==null){for(let t=this.dom.parentNode;t;t=t.parentNode)if(t.nodeType==9||t.nodeType==11&&t.host)return t.getSelection||(Object.getPrototypeOf(t).getSelection=()=>t.ownerDocument.getSelection()),this._root=t}return e||document}updateRoot(){this._root=null}posAtCoords(e){return tv(this,e)}coordsAtPos(e,t=1){return Hp(this,e,t)}domAtPos(e,t=0){return this.docView.domFromPos(e,t)}nodeDOM(e){let t=this.docView.descAt(e);return t?t.nodeDOM:null}posAtDOM(e,t,s=-1){let i=this.docView.posFromDOM(e,t,s);if(i==null)throw new RangeError("DOM position not inside the editor");return i}endOfTextblock(e,t){return ov(this,t||this.state,e)}pasteHTML(e,t){return wr(this,"",e,!1,t||new ClipboardEvent("paste"))}pasteText(e,t){return wr(this,e,null,!0,t||new ClipboardEvent("paste"))}destroy(){this.docView&&(Dv(this),this.destroyPluginViews(),this.mounted?(this.docView.update(this.state.doc,[],ja(this),this),this.dom.textContent=""):this.dom.parentNode&&this.dom.parentNode.removeChild(this.dom),this.docView.destroy(),this.docView=null,FC())}get isDestroyed(){return this.docView==null}dispatchEvent(e){return Pv(this,e)}dispatch(e){let t=this._props.dispatchTransaction;t?t.call(this,e):this.updateState(this.state.apply(e))}domSelectionRange(){let e=this.domSelection();return St&&this.root.nodeType===11&&VC(this.dom.ownerDocument)==this.dom&&iM(this,e)||e}domSelection(){return this.root.getSelection()}}function Su(n){let e=Object.create(null);return e.class="ProseMirror",e.contenteditable=String(n.editable),n.someProp("attributes",t=>{if(typeof t=="function"&&(t=t(n.state)),t)for(let s in t)s=="class"?e.class+=" "+t[s]:s=="style"?e.style=(e.style?e.style+";":"")+t[s]:!e[s]&&s!="contenteditable"&&s!="nodeName"&&(e[s]=String(t[s]))}),e.translate||(e.translate="no"),[Bt.node(0,n.state.doc.content.size,e)]}function ku(n){if(n.markCursor){let e=document.createElement("img");e.className="ProseMirror-separator",e.setAttribute("mark-placeholder","true"),e.setAttribute("alt",""),n.cursorWrapper={dom:e,deco:Bt.widget(n.state.selection.head,e,{raw:!0,marks:n.markCursor})}}else n.cursorWrapper=null}function wu(n){return!n.someProp("editable",e=>e(n.state)===!1)}function pM(n,e){let t=Math.min(n.$anchor.sharedDepth(n.head),e.$anchor.sharedDepth(e.head));return n.$anchor.start(t)!=e.$anchor.start(t)}function Cu(n){let e=Object.create(null);function t(s){for(let i in s)Object.prototype.hasOwnProperty.call(e,i)||(e[i]=s[i])}return n.someProp("nodeViews",t),n.someProp("markViews",t),e}function mM(n,e){let t=0,s=0;for(let i in n){if(n[i]!=e[i])return!0;t++}for(let i in e)s++;return t!=s}function vu(n){if(n.spec.state||n.spec.filterTransaction||n.spec.appendTransaction)throw new RangeError("Plugins passed directly to the view must not have a state component")}const tr=new si("placeholderPlugin");function gM(n){return new _s({key:tr,state:{init(){return{placeholder:n}},apply(e,t){return e.getMeta(tr)?{placeholder:e.getMeta(tr).placeholder}:t}},props:{decorations(e){var i;const{doc:t}=e;if(t.childCount===1&&((i=t.firstChild)==null?void 0:i.isTextblock)&&t.firstChild.content.size===0){const r=[],{placeholder:o}=tr.getState(e);return e.doc.descendants((a,l)=>{const d=Bt.node(l,l+a.nodeSize,{class:"placeholder","data-placeholder":o});r.push(d)}),Ge.create(t,r)}}}})}const Ac="command_token",yM={group:"inline",inline:!0,atom:!0,content:"text*",attrs:{id:"",hint:""},selectable:!1,draggable:!1,toDOM:n=>["span",{"data-mention-id":n.attrs.id,"data-mention-hint":n.attrs.hint,class:"hint-pill"},n.attrs.hint],parseDOM:[{tag:"span[data-mention-id][data-mention-hint]",getAttrs:n=>{const e=n.getAttribute("data-mention-id"),t=n.getAttribute("data-mention-hint");return{id:e,hint:t}}}]};function xm(n,e){if(n.depth===0)return;const t=n.before(),i=n.doc.textBetween(t,n.pos,`
`,"\0").match(new RegExp(/(^|\s)\/(\w*)$/));if(i&&i.index!==void 0){const r=i[0].startsWith(" ")?i.index+1:i.index,o=i[0].startsWith(" ")?i[0].length-1:i[0].length,a=n.start()+r,l=a+o,d=a===(e==null?void 0:e.from);return{range:{from:a,to:l},queryText:i[2],isDismissed:d}}}const vr=new si("slashCommandPlugin");function xM(n){const t=n.state.selection.$from,s=xm(t,void 0);if(!s)return;const i=n.state.tr;n.dispatch(i.setMeta(vr,{...i.getMeta(vr),dismissedRange:s.range}))}function Mu(){return{queryText:"",active:!1,range:void 0}}function bM(n,e,t,s,i){let r;if(e.id===fn.Search&&i)r=n.state.tr.delete(t.from,t.to),hr.addPersistedSystemHint(fn.Search);else{const o=n.state.schema.nodes[Ac].create({...e},n.state.schema.text(e.hint));r=n.state.tr.replaceWith(t.from,t.to,o),s&&r.insertText(" ",t.from+o.nodeSize)}n.dispatch(r)}function Tu(n){const{active:e,range:t,queryText:s,onHintMatch:i,dismissedRange:r}=n;if(i)return!e||!t||(r==null?void 0:r.from)===t.from?i(void 0):i({text:s,range:t})}function SM(n){const e=[];return n.descendants(t=>{var s;t.type.name===Ac&&typeof((s=t.attrs)==null?void 0:s.id)=="string"&&e.push(t.attrs.id)}),e}function kM(){return new _s({key:vr,state:{init(){return Mu()},apply(n,e){const t=n.getMeta(vr),s=n.selection,i=s.$from,r=xm(i,e.dismissedRange),o={...Mu(),...e,...t};return s.from!==s.to?(Tu(o),o):(o.active=!!r,r&&(o.queryText=r.queryText,o.range=r.range,r.isDismissed&&(r.queryText===""&&e.queryText!==""?o.dismissedRange=void 0:o.dismissedRange=r.range)),Tu(o),o)}}})}class ca extends Pg{constructor(e){super(),this.view=e}isEmpty(){return this.view.state.doc.textContent.trim().length===0}trimLeadingText(e){const s=this.view.state.tr;let i=!1,r=!1;return s.doc.descendants((o,a)=>{var l;i||!o.isText||(i=!0,(l=o.text)!=null&&l.startsWith(e)&&(r=!0,s.insertText(o.text.replace(e,""),a,a+o.text.length)))}),r&&this.view.dispatch(s),r}replaceAll(e,t){const i=this.view.state.tr,r=[];i.doc.descendants((o,a)=>{!o.isText||o.text===void 0||r.push({node:o,pos:a})}),r.reverse(),r.forEach(({node:o,pos:a})=>{!o.isText||o.text===void 0||o.text.includes(e)&&i.insertText(o.text.replaceAll(e,t),a,a+o.text.length)}),this.view.dispatch(i)}appendText(e){this.view.dispatch(this.view.state.tr.insertText(e))}focus(){this.view.focus(),this.view.dispatch(this.view.state.tr.setSelection(ye.atEnd(this.view.state.doc)))}setText(e){const{tr:t,schema:s}=this.view.state,i=e?s.nodes.paragraph.create(null,s.text(e)):s.nodes.paragraph.create();this.view.dispatch(t.replaceWith(0,this.view.state.doc.content.size,i)),this.view.hasFocus()&&this.view.dispatch(this.view.state.tr.setSelection(ye.atEnd(this.view.state.doc)))}getCurrentText(){return this.view.state.doc.textContent}getContentToSend(){return RC(this.view)}resize(){}isReady(){return!!this.view.state.doc}setPlaceholder(e){this.view.dispatch(this.view.state.tr.setMeta(tr,{placeholder:e}))}getSelectionStart(){return this.view.state.selection.ranges[0].$from.pos}isMenuSelectorActive(){return zs.getState(this.view.state).active}registerKeyHandlers(e){gC(this.view,e)}acceptLegacyKeydown(){return!1}subscribe(e,t){var s;if(e==="change"){const i=()=>t(void 0);return Hd(this.view,i)}return(s=this.view.dom)==null||s.addEventListener(e,t),()=>{var i;(i=this.view.dom)==null||i.removeEventListener(e,t)}}useState(e){return y.useSyncExternalStore(t=>Hd(this.view,t),()=>e(this),()=>e(this))}getSystemHints(){const e=SM(this.view.state.tr.doc);return Fg().forEach(s=>{e.includes(s)||e.push(s)}),e.length?[e[0]]:[]}canShowAutocompletion(){return!this.isMenuSelectorActive()&&!this.getSystemHints().length}}const wM=typeof navigator<"u"?/Mac|iP(hone|[oa]d)/.test(navigator.platform):!1;function CM(n){let e=n.split(/-(?!$)/),t=e[e.length-1];t=="Space"&&(t=" ");let s,i,r,o;for(let a=0;a<e.length-1;a++){let l=e[a];if(/^(cmd|meta|m)$/i.test(l))o=!0;else if(/^a(lt)?$/i.test(l))s=!0;else if(/^(c|ctrl|control)$/i.test(l))i=!0;else if(/^s(hift)?$/i.test(l))r=!0;else if(/^mod$/i.test(l))wM?o=!0:i=!0;else throw new Error("Unrecognized modifier name: "+l)}return s&&(t="Alt-"+t),i&&(t="Ctrl-"+t),o&&(t="Meta-"+t),r&&(t="Shift-"+t),t}function vM(n){let e=Object.create(null);for(let t in n)e[CM(t)]=n[t];return e}function Da(n,e,t=!0){return e.altKey&&(n="Alt-"+n),e.ctrlKey&&(n="Ctrl-"+n),e.metaKey&&(n="Meta-"+n),t&&e.shiftKey&&(n="Shift-"+n),n}function xl(n){return new _s({props:{handleKeyDown:bm(n)}})}function bm(n){let e=vM(n);return function(t,s){let i=Lg(s),r,o=e[Da(i,s)];if(o&&o(t.state,t.dispatch,t))return!0;if(i.length==1&&i!=" "){if(s.shiftKey){let a=e[Da(i,s,!1)];if(a&&a(t.state,t.dispatch,t))return!0}if((s.shiftKey||s.altKey||s.metaKey||i.charCodeAt(0)>127)&&(r=Bg[s.keyCode])&&r!=i){let a=e[Da(r,s)];if(a&&a(t.state,t.dispatch,t))return!0}}return!1}}class Be extends de{constructor(e){super(e,e)}map(e,t){let s=e.resolve(t.map(this.head));return Be.valid(s)?new Be(s):de.near(s)}content(){return q.empty}eq(e){return e instanceof Be&&e.head==this.head}toJSON(){return{type:"gapcursor",pos:this.head}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for GapCursor.fromJSON");return new Be(e.resolve(t.pos))}getBookmark(){return new jc(this.anchor)}static valid(e){let t=e.parent;if(t.isTextblock||!MM(e)||!TM(e))return!1;let s=t.type.spec.allowGapCursor;if(s!=null)return s;let i=t.contentMatchAt(e.index()).defaultType;return i&&i.isTextblock}static findGapCursorFrom(e,t,s=!1){e:for(;;){if(!s&&Be.valid(e))return e;let i=e.pos,r=null;for(let o=e.depth;;o--){let a=e.node(o);if(t>0?e.indexAfter(o)<a.childCount:e.index(o)>0){r=a.child(t>0?e.indexAfter(o):e.index(o)-1);break}else if(o==0)return null;i+=t;let l=e.doc.resolve(i);if(Be.valid(l))return l}for(;;){let o=t>0?r.firstChild:r.lastChild;if(!o){if(r.isAtom&&!r.isText&&!ie.isSelectable(r)){e=e.doc.resolve(i+r.nodeSize*t),s=!1;continue e}break}r=o,i+=t;let a=e.doc.resolve(i);if(Be.valid(a))return a}return null}}}Be.prototype.visible=!1;Be.findFrom=Be.findGapCursorFrom;de.jsonID("gapcursor",Be);class jc{constructor(e){this.pos=e}map(e){return new jc(e.map(this.pos))}resolve(e){let t=e.resolve(this.pos);return Be.valid(t)?new Be(t):de.near(t)}}function MM(n){for(let e=n.depth;e>=0;e--){let t=n.index(e),s=n.node(e);if(t==0){if(s.type.spec.isolating)return!0;continue}for(let i=s.child(t-1);;i=i.lastChild){if(i.childCount==0&&!i.inlineContent||i.isAtom||i.type.spec.isolating)return!0;if(i.inlineContent)return!1}}return!0}function TM(n){for(let e=n.depth;e>=0;e--){let t=n.indexAfter(e),s=n.node(e);if(t==s.childCount){if(s.type.spec.isolating)return!0;continue}for(let i=s.child(t);;i=i.firstChild){if(i.childCount==0&&!i.inlineContent||i.isAtom||i.type.spec.isolating)return!0;if(i.inlineContent)return!1}}return!0}function _M(){return new _s({props:{decorations:AM,createSelectionBetween(n,e,t){return e.pos==t.pos&&Be.valid(t)?new Be(t):null},handleClick:EM,handleKeyDown:NM,handleDOMEvents:{beforeinput:IM}}})}const NM=bm({ArrowLeft:Zr("horiz",-1),ArrowRight:Zr("horiz",1),ArrowUp:Zr("vert",-1),ArrowDown:Zr("vert",1)});function Zr(n,e){const t=n=="vert"?e>0?"down":"up":e>0?"right":"left";return function(s,i,r){let o=s.selection,a=e>0?o.$to:o.$from,l=o.empty;if(o instanceof ye){if(!r.endOfTextblock(t)||a.depth==0)return!1;l=!1,a=s.doc.resolve(e>0?a.after():a.before())}let d=Be.findGapCursorFrom(a,e,l);return d?(i&&i(s.tr.setSelection(new Be(d))),!0):!1}}function EM(n,e,t){if(!n||!n.editable)return!1;let s=n.state.doc.resolve(e);if(!Be.valid(s))return!1;let i=n.posAtCoords({left:t.clientX,top:t.clientY});return i&&i.inside>-1&&ie.isSelectable(n.state.doc.nodeAt(i.inside))?!1:(n.dispatch(n.state.tr.setSelection(new Be(s))),!0)}function IM(n,e){if(e.inputType!="insertCompositionText"||!(n.state.selection instanceof Be))return!1;let{$from:t}=n.state.selection,s=t.parent.contentMatchAt(t.index()).findWrapping(n.state.schema.nodes.text);if(!s)return!1;let i=P.empty;for(let o=s.length-1;o>=0;o--)i=P.from(s[o].createAndFill(null,i));let r=n.state.tr.replace(t.pos,t.pos,new q(i,0,0));return r.setSelection(ye.near(r.doc.resolve(t.pos+1))),n.dispatch(r),!1}function AM(n){if(!(n.selection instanceof Be))return null;let e=document.createElement("div");return e.className="ProseMirror-gapcursor",Ge.create(n.doc,[Bt.widget(n.selection.head,e,{key:"gapcursor"})])}const jM=500;class hn{constructor(e,t){this.items=e,this.eventCount=t}popEvent(e,t){if(this.eventCount==0)return null;let s=this.items.length;for(;;s--)if(this.items.get(s-1).selection){--s;break}let i,r;t&&(i=this.remapping(s,this.items.length),r=i.maps.length);let o=e.tr,a,l,d=[],u=[];return this.items.forEach((h,f)=>{if(!h.step){i||(i=this.remapping(s,f+1),r=i.maps.length),r--,u.push(h);return}if(i){u.push(new bn(h.map));let m=h.step.map(i.slice(r)),p;m&&o.maybeStep(m).doc&&(p=o.mapping.maps[o.mapping.maps.length-1],d.push(new bn(p,void 0,void 0,d.length+u.length))),r--,p&&i.appendMap(p,r)}else o.maybeStep(h.step);if(h.selection)return a=i?h.selection.map(i.slice(r)):h.selection,l=new hn(this.items.slice(0,s).append(u.reverse().concat(d)),this.eventCount-1),!1},this.items.length,0),{remaining:l,transform:o,selection:a}}addTransform(e,t,s,i){let r=[],o=this.eventCount,a=this.items,l=!i&&a.length?a.get(a.length-1):null;for(let u=0;u<e.steps.length;u++){let h=e.steps[u].invert(e.docs[u]),f=new bn(e.mapping.maps[u],h,t),m;(m=l&&l.merge(f))&&(f=m,u?r.pop():a=a.slice(0,a.length-1)),r.push(f),t&&(o++,t=void 0),i||(l=f)}let d=o-s.depth;return d>DM&&(a=RM(a,d),o-=d),new hn(a.append(r),o)}remapping(e,t){let s=new ki;return this.items.forEach((i,r)=>{let o=i.mirrorOffset!=null&&r-i.mirrorOffset>=e?s.maps.length-i.mirrorOffset:void 0;s.appendMap(i.map,o)},e,t),s}addMaps(e){return this.eventCount==0?this:new hn(this.items.append(e.map(t=>new bn(t))),this.eventCount)}rebased(e,t){if(!this.eventCount)return this;let s=[],i=Math.max(0,this.items.length-t),r=e.mapping,o=e.steps.length,a=this.eventCount;this.items.forEach(f=>{f.selection&&a--},i);let l=t;this.items.forEach(f=>{let m=r.getMirror(--l);if(m==null)return;o=Math.min(o,m);let p=r.maps[m];if(f.step){let g=e.steps[m].invert(e.docs[m]),S=f.selection&&f.selection.map(r.slice(l+1,m));S&&a++,s.push(new bn(p,g,S))}else s.push(new bn(p))},i);let d=[];for(let f=t;f<o;f++)d.push(new bn(r.maps[f]));let u=this.items.slice(0,i).append(d).append(s),h=new hn(u,a);return h.emptyItemCount()>jM&&(h=h.compress(this.items.length-s.length)),h}emptyItemCount(){let e=0;return this.items.forEach(t=>{t.step||e++}),e}compress(e=this.items.length){let t=this.remapping(0,e),s=t.maps.length,i=[],r=0;return this.items.forEach((o,a)=>{if(a>=e)i.push(o),o.selection&&r++;else if(o.step){let l=o.step.map(t.slice(s)),d=l&&l.getMap();if(s--,d&&t.appendMap(d,s),l){let u=o.selection&&o.selection.map(t.slice(s));u&&r++;let h=new bn(d.invert(),l,u),f,m=i.length-1;(f=i.length&&i[m].merge(h))?i[m]=f:i.push(h)}}else o.map&&s--},this.items.length,0),new hn(Eh.from(i.reverse()),r)}}hn.empty=new hn(Eh.empty,0);function RM(n,e){let t;return n.forEach((s,i)=>{if(s.selection&&e--==0)return t=i,!1}),n.slice(t)}class bn{constructor(e,t,s,i){this.map=e,this.step=t,this.selection=s,this.mirrorOffset=i}merge(e){if(this.step&&e.step&&!e.selection){let t=e.step.merge(this.step);if(t)return new bn(t.getMap().invert(),t,this.selection)}}}class ls{constructor(e,t,s,i,r){this.done=e,this.undone=t,this.prevRanges=s,this.prevTime=i,this.prevComposition=r}}const DM=20;function OM(n,e,t,s){let i=t.getMeta(Js),r;if(i)return i.historyState;t.getMeta(LM)&&(n=new ls(n.done,n.undone,null,0,-1));let o=t.getMeta("appendedTransaction");if(t.steps.length==0)return n;if(o&&o.getMeta(Js))return o.getMeta(Js).redo?new ls(n.done.addTransform(t,void 0,s,fo(e)),n.undone,_u(t.mapping.maps),n.prevTime,n.prevComposition):new ls(n.done,n.undone.addTransform(t,void 0,s,fo(e)),null,n.prevTime,n.prevComposition);if(t.getMeta("addToHistory")!==!1&&!(o&&o.getMeta("addToHistory")===!1)){let a=t.getMeta("composition"),l=n.prevTime==0||!o&&n.prevComposition!=a&&(n.prevTime<(t.time||0)-s.newGroupDelay||!PM(t,n.prevRanges)),d=o?Oa(n.prevRanges,t.mapping):_u(t.mapping.maps);return new ls(n.done.addTransform(t,l?e.selection.getBookmark():void 0,s,fo(e)),hn.empty,d,t.time,a??n.prevComposition)}else return(r=t.getMeta("rebased"))?new ls(n.done.rebased(t,r),n.undone.rebased(t,r),Oa(n.prevRanges,t.mapping),n.prevTime,n.prevComposition):new ls(n.done.addMaps(t.mapping.maps),n.undone.addMaps(t.mapping.maps),Oa(n.prevRanges,t.mapping),n.prevTime,n.prevComposition)}function PM(n,e){if(!e)return!1;if(!n.docChanged)return!0;let t=!1;return n.mapping.maps[0].forEach((s,i)=>{for(let r=0;r<e.length;r+=2)s<=e[r+1]&&i>=e[r]&&(t=!0)}),t}function _u(n){let e=[];for(let t=n.length-1;t>=0&&e.length==0;t--)n[t].forEach((s,i,r,o)=>e.push(r,o));return e}function Oa(n,e){if(!n)return null;let t=[];for(let s=0;s<n.length;s+=2){let i=e.map(n[s],1),r=e.map(n[s+1],-1);i<=r&&t.push(i,r)}return t}function FM(n,e,t){let s=fo(e),i=Js.get(e).spec.config,r=(t?n.undone:n.done).popEvent(e,s);if(!r)return null;let o=r.selection.resolve(r.transform.doc),a=(t?n.done:n.undone).addTransform(r.transform,e.selection.getBookmark(),i,s),l=new ls(t?a:r.remaining,t?r.remaining:a,null,0,-1);return r.transform.setSelection(o).setMeta(Js,{redo:t,historyState:l})}let Pa=!1,Nu=null;function fo(n){let e=n.plugins;if(Nu!=e){Pa=!1,Nu=e;for(let t=0;t<e.length;t++)if(e[t].spec.historyPreserveItems){Pa=!0;break}}return Pa}const Js=new si("history"),LM=new si("closeHistory");function BM(n={}){return n={depth:n.depth||100,newGroupDelay:n.newGroupDelay||500},new _s({key:Js,state:{init(){return new ls(hn.empty,hn.empty,null,0,-1)},apply(e,t,s){return OM(t,s,e,n)}},config:n,props:{handleDOMEvents:{beforeinput(e,t){let s=t.inputType,i=s=="historyUndo"?km:s=="historyRedo"?bl:null;return i?(t.preventDefault(),i(e.state,e.dispatch)):!1}}}})}function Sm(n,e){return(t,s)=>{let i=Js.getState(t);if(!i||(n?i.undone:i.done).eventCount==0)return!1;if(s){let r=FM(i,t,n);r&&s(e?r.scrollIntoView():r)}return!0}}const km=Sm(!1,!0),bl=Sm(!0,!0);function zM(){return xl({"Shift-Enter":(n,e)=>ol(n,e),Enter:(n,e)=>window.innerWidth>gb[yb.Medium]?!1:ol(n,e)})}const UM=["p",0],VM=["br"],WM=new Nw({nodes:{paragraph:{content:"inline*",group:"block",parseDOM:[{tag:"p",preserveWhitespace:"full"}],toDOM(){return UM}},text:{group:"inline"},hard_break:{inline:!0,group:"inline",selectable:!1,parseDOM:[{tag:"br"}],toDOM(){return VM}},[Ac]:yM,doc:{content:"block+"}},marks:{}});function HM(){const n=new EventTarget,e=new fM(null,{state:xi.create({schema:WM,plugins:[BM(),PC({submitKeys:["Enter","Tab"],cancelKeys:["Escape"],checkStrictMatchKeys:[" "]}),gM(""),kM(),zM(),xl({"Mod-z":km,"Mod-y":bl,"Mod-Shift-z":bl}),yC(),xl(jC),mC(n),_M()]}),dispatchTransaction(t){const s=e.state.apply(t);e.updateState(s),t.docChanged&&n.dispatchEvent(new Event(rl))},handlePaste(t,s){var r;const i=(r=s.clipboardData)==null?void 0:r.getData("text/plain");return i===void 0?!1:(DC(t,i),!0)},clipboardTextSerializer(t){return Fp(t.content).content}});return e}function GM(){try{return navigator.userAgent.toLocaleLowerCase().includes("firefox")}catch{return!1}}const qM=[K([zg["prosemirror-parent"],"text-token-text-primary","max-h-[25dvh]","max-h-52","overflow-auto",GM()?"firefox":"default-browser"])],$M=({children:n})=>{const[e]=y.useState(()=>new ca(HM()));return n(e)},KM=({composerController:n,placeholder:e})=>{const t=y.useContext(cf),s=y.useRef(null),i=y.useRef(null),r=y.useRef(!1);return y.useEffect(()=>{if(r.current)return;if(!(n instanceof ca))throw new Error(`Expected instance of ProseMirrorComposerController but got ${n.constructor.name}`);r.current=!0;const o=i.current;if(o!=null){const{value:a,selectionStart:l,selectionEnd:d}=o;n.view.dispatch(n.view.state.tr.insertText(a)),n.view.dispatch(n.view.state.tr.setSelection(ye.create(n.view.state.doc,l+1,d+1))),o.style.display="none",o.value=""}s.current.appendChild(n.view.dom),n.view.dom.id=Ih,n.view.focus()},[n]),y.useEffect(()=>{n.setPlaceholder(e)},[e,n]),y.useEffect(()=>{n.logPageMount()},[]),c.jsxs("div",{ref:s,className:K(qM),children:[c.jsx("textarea",{className:"block h-10 w-full resize-none border-0 bg-transparent px-0 py-2 text-token-text-primary placeholder:text-token-text-secondary",autoFocus:!0,placeholder:e,ref:i}),c.jsx("script",{nonce:t.cspScriptNonce,suppressHydrationWarning:!0,children:"requestAnimationFrame((function(){window.__oai_logTTI?window.__oai_logTTI():window.__oai_SSR_TTI=window.__oai_SSR_TTI??Date.now()}))"})]})},JM=y.forwardRef(function({type:e,placeholder:t,replyRegions:s,state:i,renderFiles:r,leftSideActions:o,onSubmit:a,inputState:l,currentLeafId:d,composerController:u,clientThreadId:h,gizmoId:f},m){const p=Ho(),g=ah();return y.useEffect(()=>{u.focus()},[g==null?void 0:g.modelId,u]),c.jsxs("div",{ref:m,className:K("flex w-full flex-col gap-1.5 rounded-[26px] p-1.5 transition-colors",p&&"backdrop-blur-2xl no-transparency:backdrop-blur-none",p&&e!=="temporary"&&"bg-token-composer-surface",!p&&e!=="temporary"&&"bg-[#f4f4f4] dark:bg-token-main-surface-secondary",e==="temporary"&&"dark bg-black"),children:[c.jsx(ws,{children:s.length>0&&c.jsx(Oe.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0,transition:{duration:.06}},transition:{ease:"easeOut",duration:.1},children:c.jsx(ZM,{replyRegions:s})})}),c.jsxs("div",{className:"flex items-end gap-1.5 pl-4 md:gap-2",children:[!!(o!=null&&o.length)&&c.jsx(Oe.div,{initial:{opacity:0},animate:{opacity:1},transition:{ease:"easeOut",duration:.06},className:"-ml-2.5 flex",children:o},"leftSideActions"),c.jsxs(Oe.div,{layout:!0,transition:{duration:.1},className:K("flex min-w-0 flex-1 flex-col"),children:[r,u instanceof Bl?c.jsx(YM,{composerController:u,currentLeafId:d,placeholder:t,inputState:l}):c.jsx(KM,{composerController:u,placeholder:t})]}),c.jsx(QM,{inputState:l,state:i,onSubmit:a,composerController:u,clientThreadId:h,gizmoId:f})]})]})});function YM({composerController:n,currentLeafId:e,placeholder:t,inputState:s}){const i=y.useContext(cf);return c.jsxs(c.Fragment,{children:[c.jsx(Ah,{id:Ih,autoFocus:!0,tabIndex:0,"data-id":e,dir:"auto",ref:r=>{if(!(n instanceof Bl))throw new Error("Expected TextAreaComposerController");r!=null&&(n.textArea=r,n.logPageMount())},rows:1,placeholder:t,disabled:s!=="default",className:K("m-0 resize-none border-0 bg-transparent px-0 text-token-text-primary focus:ring-0 focus-visible:ring-0",s==="disabled"&&"text-center",["max-h-[25dvh]","max-h-52"])}),c.jsx("script",{nonce:i.cspScriptNonce,suppressHydrationWarning:!0,children:"requestAnimationFrame((function(){window.__oai_logTTI?window.__oai_logTTI():window.__oai_SSR_TTI=window.__oai_SSR_TTI??Date.now()}))"})]})}function QM(n){const{isUnauthenticated:e}=Ht(),t=dr(jh.hasUploadInProgress);if(n.inputState==="disabled")return null;const s=c.jsx(XM,{state:n.state,onSubmit:n.onSubmit});return!e&&!t&&n.state==="disabled"&&n.clientThreadId?c.jsx("div",{className:"w-10",children:c.jsx(Ug,{clientThreadId:n.clientThreadId,gizmoId:n.gizmoId,fallback:()=>s})}):s}function XM({state:n,onSubmit:e}){const t=n==="streaming"?qS:$S,s=ue(),i=s.formatMessage({id:"+yfm/p",defaultMessage:"Stop streaming"}),r=s.formatMessage({id:"xfIykB",defaultMessage:"Send prompt"}),o=Ho();return c.jsx("button",{onClick:e,disabled:n==="disabled","aria-label":n==="streaming"?i:r,"data-testid":n==="streaming"?"stop-button":"send-button",className:K("mb-1 me-1 flex h-8 w-8 items-center justify-center rounded-full bg-black text-white transition-colors hover:opacity-70 focus-visible:outline-none focus-visible:outline-black disabled:text-[#f4f4f4] disabled:hover:opacity-100 dark:bg-white dark:text-black dark:focus-visible:outline-white disabled:dark:bg-token-text-quaternary dark:disabled:text-token-main-surface-secondary",o&&"disabled:bg-black disabled:bg-opacity-[0.27]",!o&&"disabled:bg-[#D7D7D7]"),children:c.jsx(t,{className:K(n==="streaming"?"icon-lg":"icon-2xl")})})}function ZM({replyRegions:n}){return c.jsx("div",{className:"flex flex-col divide-y divide-token-border-light overflow-hidden rounded-b-lg rounded-t-[20px] bg-token-main-surface-primary",children:n.map((e,t)=>{switch(e.type){case"text":return c.jsx(eT,{value:e.value,onRemoveRegion:e.onRemoveRegion},t);case"object":return c.jsx(tT,{value:e.value,onRemoveRegion:e.onRemoveRegion},t);case"mention":case"system_hint":return c.jsx(nT,{value:e.value,icon:e.icon,onRemoveRegion:e.onRemoveRegion},t)}})})}function eT({value:n,onRemoveRegion:e}){return c.jsxs(Dc,{className:"text-token-text-secondary",children:[c.jsx(Oc,{children:c.jsx(pc,{className:"icon-lg-heavy"})}),c.jsx(Pc,{children:`â€œ${n}â€`}),c.jsx(Rc,{onClick:e})]})}function tT({value:n,onRemoveRegion:e}){return c.jsxs(Dc,{className:"text-blue-selection",children:[c.jsx(Oc,{children:c.jsx(pc,{className:"icon-lg-heavy"})}),c.jsx(Pc,{className:"font-semibold",children:n}),c.jsx(Rc,{onClick:e})]})}function nT({value:n,icon:e,onRemoveRegion:t}){return c.jsxs(Dc,{children:[c.jsx(Oc,{className:"mt-0",children:e}),c.jsx(Pc,{className:"font-semibold text-token-text-primary",children:n}),c.jsx(Rc,{onClick:t})]})}function Rc({onClick:n}){return c.jsx("button",{onClick:n,type:"button",className:"flex-shrink-0 text-token-text-secondary",children:c.jsx(GS,{className:"icon-lg"})})}const Dc=ze.div`flex items-start py-2.5 gap-4 pl-3 pr-1.5 text-sm`,Oc=ze.span`flex-shrink-0 mt-0.5 w-6 h-6 flex justify-center items-center`,Pc=ze.span`flex-1 line-clamp-3 py-0.5`;function sT({composerController:n,highlightTooltip:e}){return c.jsx(rT,{highlightTooltip:e,children:c.jsx(Jf,{showBackground:e,className:"bg-brand-purple/20",children:c.jsx("button",{className:"mb-1 flex h-8 w-8 items-center justify-center text-token-text-primary",onClick:()=>{$.logEvent(V.composerSearchButtonClicked),hr.addPersistedSystemHint(fn.Search),/^search\s?$/i.test(n.getCurrentText())&&n.setText(""),n.focus()},children:c.jsx(ea,{className:K(e&&"text-brand-purple-800 dark:text-brand-purple-600")})})})})}function iT(){const n=Fi(Li.hasSeenComposerSearchButtonTooltip);return!n.isLoading&&n.eligible}function rT({children:n,highlightTooltip:e}){const t=iT(),s=ue(),i=Fi(Li.hasSeenComposerSearchButtonTooltip);return t?c.jsx(Wo,{side:"top",show:!0,dismissOnOutsideClick:!0,badge:"none",title:s.formatMessage({id:"xFWazH",defaultMessage:"All the web, now in ChatGPT"}),contentAlign:"center",onDismiss:i.markAsViewed,sideOffset:2,description:s.formatMessage({id:"1CjchM",defaultMessage:"Search the web for instant answers and links to trusted sources"}),children:c.jsx("div",{children:n})}):c.jsx("div",{children:c.jsx(vs,{sideOffset:14,label:s.formatMessage({id:"c+4o2s",defaultMessage:"Search the web"}),side:"top",open:e?!0:void 0,children:n})})}function oT({composerController:n,clientThreadId:e}){const t=zi(e),s=Kl(e,tc.Search),i=Wx(e),[r,o]=y.useState([]),[a,l]=y.useState(void 0),[d,u]=y.useState(0);y.useEffect(()=>{o(a?i.filter(v=>v.name.toLocaleLowerCase().startsWith(a.text.toLocaleLowerCase())||v.systemHint.toLocaleLowerCase().startsWith(a.text.toLocaleLowerCase())):[])},[a]);const h=n.useState(v=>v.getSystemHints().length>0);y.useEffect(()=>{const v=T=>{l(A=>!A||!T?T:A.text===T.text&&A.range.from===T.range.to&&A.range.to?A:T)};n.view.dispatch(n.view.state.tr.setMeta(vr,{onHintMatch:v}))},[n]);const f=h||!i.length||!r.length||!a;y.useEffect(()=>{f&&u(0)},[f]);const m=r.length,p=y.useCallback(v=>{u(T=>(v(T)%m+m)%m)},[m]),g=r[d],S=({hintToSave:v=g,expectPerfectMatch:T,appendSpace:A=!0})=>{if(!a||!g||T&&v.name.toLowerCase()!==a.text.toLowerCase())return;$.logEvent(V.systemHintSelected,{system_hint:v.systemHint,conversation_id:t??Xa});const L=a.text+v.name.slice(a.text.length);bM(n.view,{id:v.systemHint,hint:L},a.range,A,s),bi(n.view)},x=y.useRef(S);x.current=S;const w=y.useRef(p);w.current=p;const C=y.useRef(a);C.current=a;const k=n.view;return y.useEffect(()=>(f||OC(k,v=>{v==="up"?w.current(T=>T-1):v==="down"?w.current(T=>T+1):v==="cancel"?(bi(k),xM(k)):v==="submit"?(x.current({expectPerfectMatch:!1}),bi(k)):v==="checkMatch"&&x.current({expectPerfectMatch:!0,appendSpace:!1})}),()=>bi(k)),[f,k]),y.useEffect(()=>{f||$.logEvent(V.systemHintListOpened,{conversation_id:t??Xa})},[f]),f?null:c.jsx(Vg,{className:"max-w-60",children:r.map((v,T)=>c.jsx("div",{children:c.jsx(Wg,{autoFocus:!1,className:"hover:bg-inherit rounded-lg px-1 py-2",spoofHovered:T===d,onMouseOver:()=>u(T),onClick:()=>{S({hintToSave:v,expectPerfectMatch:!1}),n.focus()},children:c.jsx(aT,{title:v.name,description:v.description,icon:c.jsx(Hg,{svgString:v.logo,className:"icon-lg text-token-text-secondary"}),checked:!1})})},v.systemHint))})}function aT({title:n,description:e,icon:t,onClick:s,checked:i}){return c.jsxs("div",{className:"inline-flex w-full items-center justify-start gap-1.5 pl-1.5 pr-3",onClick:s,children:[c.jsx("div",{className:"flex h-7 w-7 items-center justify-center gap-2.5",children:t}),c.jsxs("div",{className:"shrink grow basis-0",children:[c.jsx("p",{className:"text-sm font-normal leading-tight text-token-text-primary",children:n}),!!e&&c.jsx("p",{className:"text-[13px] font-normal leading-[18px] text-token-text-secondary",children:e})]}),i&&c.jsx(Rf,{className:K("icon-md text-token-text-primary",{"group-hover:hidden":!i})})]})}function lT({composerController:n,clientThreadId:e}){return n instanceof ca?c.jsx(oT,{composerController:n,clientThreadId:e}):null}function cT({suggestions:n,composerController:e,onSelect:t,onChange:s}){const i=Nf(),r=y.useCallback((l,d,u)=>{t==null||t(l,d,u),i(l,d,u)},[t,i]),[o,a]=y.useState(-1);return y.useEffect(()=>{const l=d=>{if(d.key==="ArrowDown"){const u=o===n.length-1?0:o+1;a(u),s==null||s(u,!0,n[u])}else if(d.key==="ArrowUp"){d.preventDefault();const u=o<=0?n.length-1:o-1;a(u),s==null||s(u,!0,n[u])}else d.key==="Enter"&&n[o]&&r(n[o],n,o)};return e.subscribe("keydown",l)},[n,o,s,r,e]),y.useEffect(()=>e.subscribe("blur",()=>{a(-1),s==null||s(-1,!1)}),[e,s]),c.jsx(Oe.ul,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"hidden w-full flex-col p-2.5 group-focus-within:block",children:n.map((l,d)=>c.jsxs(Oe.li,{initial:{opacity:0,translateY:4},animate:{opacity:1,translateY:0},transition:{delay:d*.03},exit:{opacity:0,translateY:4},className:"w-full",children:[d>0&&c.jsx("div",{className:K("h-[1px] opacity-60",o===d||o===d-1?"mx-2 bg-token-main-surface-secondary":"bg-token-border-light")}),c.jsxs("button",{className:K("inline w-full cursor-pointer items-center justify-start rounded-lg px-2.5 py-3 text-start",o===d?"bg-token-main-surface-secondary":"bg-token-main-surface-primary"),onClick:u=>{u.preventDefault(),r(l,n,d)},onMouseEnter:()=>{a(d),s==null||s(d,!1,l)},onMouseLeave:()=>{a(-1),s==null||s(-1,!1,l)},children:[c.jsx("span",{className:"text-token-text-tertiary",children:l.title}),c.jsx("span",{className:"text-token-text-primary",children:l.body})]})]},l.id??d))})}const dT=1,uT=3e3;function hT({files:n,className:e}){const t=Dr();return c.jsx("div",{className:e,children:n.map(s=>c.jsx(Oh,{width:t?"normal":"wide",onRemoveFileClick:()=>us.remove(s.tempId,"none"),file:s.file,fileId:s.fileId??void 0,contextConnectorInfo:s.contextConnectorInfo,loadingPercentage:s.status===ny.Uploading?s.progress:void 0},s.tempId))})}function fT({onAbortCompletion:n,onCreateNewCompletion:e,onContinueGenerating:t,currentModelId:s,clientThreadId:i,isNewThread:r,isCompletionInProgress:o,className:a,disabled:l=!1,disabledReason:d,canPause:u=!1,canContinue:h=!1,suggestions:f,isInteractableSharedThread:m,composerContainerRef:p,composerController:g,autocompletions:S,requiresFileUpload:x,onComposerInput:w,onComposerChange:C,onAutocompleteSelect:k,headerClassName:v,hideHeader:T,setComposerBarElement:A,onTaggingDropdownOpen:L,onTaggingDropdownClose:_}){var Wc,Hc;const N=Er(),{isUnauthenticated:z}=Ht(),j=ue(),H=Mn(i),Q=Pr(i),B=jr(),{gizmoEditorData:U,mode:O,getGizmoId:R}=Ir(),M=Bi(),F=ef(),J=Kn(),Z=Nr(),se=zi(i),he=!!xb(),Ie=Gg(),xe=!!nc(),[Pe,Ke]=y.useState({}),[E,fe]=y.useState(!1),[Ue,pe]=y.useState(!1),Fe=y.useRef(!1),Je=Jl(),ke=s!==null?Je[s]:void 0,ot=Ie.has(fn.Search);let ce=na(i),We=ce&&"gizmo"in ce?ce.gizmo:void 0;const[Ae,le]=y.useState(null);Ae!==null&&(ce={gizmo:Ae,gizmo_id:Ae.gizmo.id,kind:De.GizmoInteraction},We=Ae);const we=xo(ke,ce);let Gt=!1;qg(ce)&&(We==null?void 0:We.gizmo.id)===$g&&(Gt=!0);const In=!l&&we!==Ys.None&&!Gt&&!z,et=wh(ke,ce),Tt=vh(ke,ce);let Te=dr(G=>G.files);const[Le]=y.useState(()=>Kg());O==="magic"?Te=Te.filter(G=>G.gizmoId!=null):Te=Te.filter(G=>G.gizmoId==null);const st=Te.length>0,Ve=dr(jh.hasUploadInProgress),Yn=g.useState(G=>!G.isEmpty()),mt=st?!Ve:Yn,tn=(we===Ys.Multimodal?Dl:Ol)-Te.length,qt=tn<=0,_t=mt&&!l&&!o&&!xe,[Qn,Wi]=y.useState(!1),ii=Yl(),ri=s||ii.id,oi=Kl(i,tc.Search),gn=!l&&oi&&!We&&!ot,Es=(Wc=Je[ri])==null?void 0:Wc.tags,{targetedContent:An,setTargetedContent:jn}=Rh(),me=An!=null&&An.isFocusedViewContent&&!Z?void 0:An,{rebaseSystemMessageContent:Is}=ei();y.useEffect(()=>{Jg()}),y.useEffect(()=>{if(!(N!=null&&N.id))return;const G=Yc.getAndReset(N==null?void 0:N.id,se);G&&g.setText(G.inputText)},[N==null?void 0:N.id,se,g]),y.useEffect(()=>{Qn!==_t&&(Wi(_t),_t&&(sc(!0).then(G=>{mr.startEnforcement(G),bo.startEnforcement(G),Mo.startEnforcement(G)}),M!=null&&M.includes(ni.SharedWebsocket)&&gs.registerIfNotConnected()))},[_t,Qn,ce==null?void 0:ce.kind,M]);const Nt=kh(ke,ce),{handleFileAccepted:ai}=Kf(j,xo(ke,ce),et,"mouse",R,Nt==null?void 0:Nt.attachments),{getInputProps:Xn,open:yn}=Mh({disabled:l||!In||qt,noClick:!0,onDropAccepted:ai,onDropRejected:G=>$f(G,j,we),multiple:!0,maxSize:Th,maxFiles:tn,...Ch(Tt)}),li=af(Le),Rn=y.useCallback(()=>{g.eraseContent(),li.clearMessages(),g.resize(dT),$a();for(const G of Te)us.remove(G.tempId,"none")},[Te,li,g]),Dn=async(G,at)=>{var qc;if(G==null||G.preventDefault(),l||!mt&&!at||!ce||bt.isLoading(i)!==!1)return;const At=new Ss;fe(!0);const Bn=g.getContentToSend(),Rs=Bn.content.replace(/[\u{E0000}-\u{E007F}]+/gu,""),Jt=`${H}-nextPrompt`,Ds=sy({namespace:So.CompletionRequest,key:Jt,opts:{expectedTimingLogs:[{name:"prompt_submitted",expectedInMs:3e3}]}}),{content:Zm,attachments:Gc}=iy(Rs,ke,ce),da=[];Is&&da.push(kb(Is));const ua={...ce};"gizmo"in ua&&delete ua.gizmo;const ha=g.getSystemHints();let Ki={promptId:Jt,content:Zm,eventMetadata:{eventSource:G?"mouse":"keyboard"},completionMetadata:{suggestions:f,conversationMode:ua,systemHints:ha},messageMetadata:{...Gc.length>0&&{attachments:Gc},...Ae&&{gizmo_id:Ae==null?void 0:Ae.gizmo.id},...Pe,...ha.length>0&&{system_hints:ha},...!!Bn.metadata&&{serialization_metadata:Bn.metadata}},appendMessages:da.length>0?da:void 0,turnTracker:At};Ki=ry(Ki),me!=null&&me.createNewCompletionParams&&(Ki=await me.createNewCompletionParams(Ki)),Ds.logTiming("request_params_ready"),await e(Ki),(qc=me==null?void 0:me.onCreateCompletion)==null||qc.call(me,{serverThreadId:se,currentLeafId:H}),(me==null?void 0:me.shouldPersistAcrossMessages)!==!0&&jn(void 0),Ai.hideThreadHeader(),Rn(),fe(!1),Ds.logTiming("prompt_submitted"),oy({namespace:So.CompletionRequest,key:Jt}),f!==void 0&&($e.logEvent("chatgpt_prompt_ignore_suggestions"),$.logEvent(V.promptIgnoreSuggestions))},On=y.useRef(Dn);y.useLayoutEffect(()=>{On.current=Dn}),y.useEffect(()=>bb.subscribe(Sb.SEND_PROMPT,({prompt:G})=>{g.setText(G),On.current(void 0,!0)}),[g]);const Zn=G=>{jn(G.targetedReply),G.targetedReply&&(g.focus(),$.logEvent(V.targetedReplyButtonClicked,{conversationId:se,sourceMessageId:G.messageId}))},oe=y.useCallback(()=>{var G;(G=me==null?void 0:me.onCleared)==null||G.call(me,{serverThreadId:se,currentLeafId:H}),jn(void 0),g.focus()},[H,se,me,jn,g]),Ye={Enter:{validator:G=>{const at=G.isComposing||G.keyCode===229,At=Ue&&Fe.current;return _t&&!At&&(G.metaKey||(F||wb)&&!G.shiftKey&&!at)},handler:G=>{G.preventDefault(),Dn()}},Escape:{validator:G=>!G.isComposing,handler:G=>{u&&o&&(n("",Q),$.logEvent(V.pauseCompletion,{threadId:I.getServerThreadId(i),currentLeafId:I.getTree(i).getMessageId(H),eventSource:"keyboard"})),G.target.value===""&&oe()}}},je=y.useRef(Ye);je.current=Ye;const Qe=y.useRef(null),Et=Hx(Es,ce==null?void 0:ce.kind),[$t,It]=y.useState(!1),[Kt,Pn]=y.useState(!1),Fn=Et&&$t,ci=g.isReady();y.useEffect(()=>g.subscribe("keydown",G=>{var Bn,Rs;g.acceptLegacyKeydown()&&((Bn=je.current[G.key])!=null&&Bn.validator(G))&&je.current[G.key].handler(G);const At=g.getCurrentText();if(G.key==="@"){const Jt=g.getSelectionStart(),Ds=At.substring(0,Jt);(!Ds||/\s$/.test(Ds)||Jt===0)&&((Rs=Qe.current)==null||Rs.handleClose(),setTimeout(()=>It(!0),10))}else $t&&It(!1);if(G.key==="Escape"&&(le(null),pe(!1)),gn){let Jt;G.key==="Backspace"?Jt=At.substring(0,At.length-1):Jt=At+G.key,/^search\s?$/i.test(Jt)?Pn(!0):Kt&&Pn(!1)}}),[g,ci,$t,Kt,gn]),y.useEffect(()=>{const G=Object.fromEntries(Object.keys(je.current).map(at=>[at,Bn=>{const Rs=je.current[at];if(!Rs||g.acceptLegacyKeydown())return!1;const{validator:Jt,handler:Ds}=Rs;return Jt(Bn)?(Ds(Bn),!0):!1}]));g.registerKeyHandlers(G)},[g,ci]),y.useEffect(()=>g.subscribe("paste",G=>{Yg({event:G,intl:j,clientThreadId:i,conversationMode:ce,currentModelConfig:ke,getEditorGizmoId:R,modelSupportedImageMimeTypes:et})}),[j,i,ce,ke,R,et,g]);const As=G=>{he||le(G),g.trimLeadingText("@"),cr(),It(!1)},Hi=J0(i,Le,j,et,Nt==null?void 0:Nt.attachments),es=y.useCallback(()=>{n("",Q),$.logEvent(V.pauseCompletion,{threadId:I.getServerThreadId(i),currentLeafId:I.getTree(i).getMessageId(H),eventSource:"mouse"}),cr()},[n,i,Q,H]),ae=y.useCallback(()=>{Yc.set(N==null?void 0:N.id,se,g.getCurrentText())},[se,N==null?void 0:N.id,g]);y.useEffect(()=>{U||E||g.focus()},[E,g]),y.useEffect(()=>{U||us.reset()},[s,U]),y.useEffect(()=>{(!Et&&Ae||he)&&le(null)},[Et,Ae,he]);const[Re,Ln]=(()=>{switch(d){case"workspaceDisallowsGizmo":return[xn.disallowedByWorkspacePlaceholder,!0];case"feedbackRequired":return[xn.disabledFeedbackPlaceholder,!0];case"noModelsAvailable":return[xn.noModelsAvailablePlaceholder,!0];case"requiresPluginsToBeInstalled":return[xn.requiresPluginsToBeInstalled,!0];case"loadingPlugins":return[xn.loading,!0];case"noTestGizmoId":return[xn.noTestGizmoId,!0];default:return m?[xn.continueSharedConversationPlaceholder,!1]:(me==null?void 0:me.placeholderTextOverride)!=null?[me.placeholderTextOverride,!1]:[xn.placeholderWithName,!1]}})(),Gi=j.formatMessage(Re,{name:U!=null?O==="magic"?Gx:U.name||"GPT":(We==null?void 0:We.gizmo.display.name)??"ChatGPT"});y.useEffect(()=>g.subscribe("input",()=>{Dh.getState().isThreadHeaderVisible&&Ai.hideThreadHeader(),pe(!0)}),[g]),y.useEffect(()=>{if(w)return g.subscribe("input",()=>{w==null||w()})},[g,w]),y.useEffect(()=>{if(C)return g.subscribe("change",()=>{C==null||C()})},[g,C]),y.useEffect(()=>g.subscribe("focus",()=>{pe(!0)}),[g]);const qi={clientThreadId:i,uploadType:we,modelAcceptedMimeTypes:Tt,modelSupportedImageMimeTypes:et,attachmentsProductFeature:Nt==null?void 0:Nt.attachments,getInputProps:Xn,openFileDialog:yn,historyDisabled:J,onOauthRedirect:ae,highlightTooltip:x&&!st},js=[];!l&&!qt&&In&&!ot&&js.push(c.jsx(dw,{...qi},"file-upload-button")),gn&&js.push(c.jsx(sT,{composerController:g,highlightTooltip:Kt},"search-button"));const qm=st&&c.jsxs(c.Fragment,{children:[O==="magic"&&c.jsx("div",{className:"m-2 mb-0 rounded-lg bg-token-main-surface-secondary p-2 text-xs text-token-text-secondary",children:c.jsx(D,{...xn.gizmoKnowledgeWarning})}),c.jsx(hT,{files:Te,className:"flex flex-nowrap gap-2 overflow-x-auto pb-1.5 pt-[7px]"})]}),$m=Ln?"disabled":"default",Vr=o&&u?"streaming":!_t||E?"disabled":"idle",$i=y.useRef(null),di=y.useRef(null),{layer:Km}=En("387752763"),Jm=Km.get("enable_slash_commands",!1),Ym=s&&[qx,$x].includes(s),Qm=Jm&&(ce==null?void 0:ce.kind)===De.PrimaryAssistant&&!ot;y.useEffect(()=>{const G=()=>{$i.current!=null&&xt.addAction("composer_state_disabled",{threadId:I.getServerThreadId(i),disabledReason:$i.current})};if(mt&&Vr==="disabled"){let at="unknown";l?at=d??"component_disabled_unknown":o?at="completion_in_progress":xe?at="thread_hard_blocked":E&&(at="starting_new_completion_request"),$i.current!==at&&(di.current&&clearTimeout(di.current),di.current=setTimeout(G,uT)),$i.current=at}else $i.current=null;return()=>{di.current&&(clearTimeout(di.current),di.current=null)}},[i,mt,Vr,l,d,o,xe,E]);const Wr=[];if(me!=null&&me.label&&Wr.push({type:me.type,value:me.label,onRemoveRegion:oe}),Ie!=null&&Ie.has(fn.Search)&&Wr.push({type:"system_hint",value:j.formatMessage(pT.searchMode),icon:c.jsx("span",{className:"flex h-6 w-6 items-center justify-center rounded-full bg-brand-purple/15",children:c.jsx(ea,{className:"icon-md text-brand-purple-600"})}),onRemoveRegion:()=>{hr.removePersistedSystemHint(fn.Search),g.focus()}}),Ae!==null){const G=!!((Hc=Ae.gizmo.tags)!=null&&Hc.includes(zl.FirstParty));Wr.push({type:"mention",value:Ae.gizmo.display.name,icon:c.jsx(Bf,{isFirstParty:G,src:Ae.gizmo.display.profile_picture_url,className:"icon-md"}),onRemoveRegion:()=>{le(null),g.focus()}})}y.useEffect(()=>{(!S||S.length===0||!Ue)&&(Fe.current=!1)},[S,Ue]);const Xm=(G,at,At)=>{Fe.current=G>=0,at&&g.setText(At?`${At.title}${At.body}`:"")};return y.useEffect(()=>{Fn?L==null||L():_==null||_()},[Fn,L,_]),c.jsxs(Qg.Provider,{value:Le,children:[c.jsx(Xg,{onOauthRedirect:ae,children:c.jsx("form",{className:a,onSubmit:Dn,children:c.jsxs("div",{className:"relative flex h-full max-w-full flex-1 flex-col",children:[!T&&c.jsx(w0,{className:v}),c.jsxs("div",{ref:p,className:"group relative flex w-full items-center",children:[r&&"from_template_row"in B.query&&c.jsx("button",{type:"button",onClick:()=>{B.push("/",void 0,{shallow:!0})},className:"mr-2 flex h-8 w-8 items-center justify-center text-token-text-tertiary hover:text-token-text-secondary",children:c.jsx(KS,{className:"icon-lg"})}),Et&&!!se&&c.jsx(n0,{ref:Qe}),Fn&&c.jsx("div",{className:K("absolute bottom-16 w-full space-y-2",qa.TagGpt),children:c.jsx(fk,{onClick:G=>As(G),onClose:()=>{It(!1),g.focus()}})}),Qm&&c.jsx("div",{className:K("absolute bottom-16 space-y-2",qa.TagGpt),children:c.jsx(lT,{composerController:g,clientThreadId:i})}),c.jsx(JM,{type:J?"temporary":"default",ref:A,replyRegions:Wr,placeholder:Gi,inputState:$m,composerController:g,leftSideActions:js,state:Vr,onSubmit:Vr==="streaming"?es:Dn,renderFiles:qm,currentLeafId:H,clientThreadId:i,gizmoId:We==null?void 0:We.gizmo.id}),Ue&&S&&S.length>0&&!Fn&&g.canShowAutocompletion()&&c.jsx("div",{className:K("absolute left-0 top-full z-10 mt-2 box-border w-full bg-token-main-surface-primary",(js==null?void 0:js.length)>0?`px-${js.length*8}`:"pl-0"),children:c.jsx(cT,{suggestions:S,composerController:g,onSelect:k,onChange:Xm})})]}),c.jsx(Zg,{composerController:g,parsedDocumentHandler:Hi})]})})}),c.jsx(U0,{canUseInlineTagging:Et,isDisabled:l,clientThreadId:i,currentLeafId:H,currentRequestId:Q,canContinue:h,composerController:g,setPromptInputMetadata:Ke,suggestions:f,isNewThread:r,onCreateNewCompletion:e,onContinueGenerating:t,onResetState:Rn,conversationMode:ce}),ce!=null&&!Ym&&ey.includes(ce.kind)&&c.jsx(ty,{onTargetedReply:Zn})]})}const pT=Ce({searchMode:{id:"LSO1pB",defaultMessage:"Search the web"}});function wm(n){const e=y.useContext(ic);return({id:s,requestedModelId:i,eventMetadata:r,focusOnNewCompletion:o=!0,variantPurpose:a="none",useDefaultModel:l,appendMessages:d,conversationMode:u,juice:h=void 0,turnTracker:f,extraStreamParams:m})=>{var x;const g=I.getTree(n).getParentPromptNode(s),S=g.id;e({type:Cn.Variant,promptId:S,requestedModelId:i,eventMetadata:r,cancelActiveRequests:!1,focusOnNewCompletion:o,useDefaultModel:l,completionMetadata:{variantPurpose:a,conversationMode:u,juice:h,systemHints:(x=g.message.metadata)==null?void 0:x.system_hints},appendMessages:d,turnTracker:f,extraStreamParams:m})}}const mT=({children:n})=>{const[e]=y.useState(()=>new Bl);return n(e)},Cm=({children:n})=>{const{layer:e}=En("387752763");return e.get("enable_rich_text_composer",!1)?c.jsx($M,{children:n}):c.jsx(mT,{children:n})};function gT(n){var i,r,o,a,l;const e=((i=n.message)==null?void 0:i.author.role)===Se.User,t=((r=n.metadata)==null?void 0:r.err)!=null&&((o=n.metadata)==null?void 0:o.errCode)!==zt.ContentPolicy,s=((a=n.metadata)==null?void 0:a.errCode)===zt.ModelIncompatibility;return((l=n.metadata)==null?void 0:l.canRetry)===!1||s?!1:e||t}function yT(n){return n.composerController?c.jsx(Eu,{...n,composerController:n.composerController}):c.jsx(Cm,{children:e=>c.jsx(Eu,{...n,composerController:e})})}function xT(n){return n!=null&&(n.tagName==="INPUT"||n.tagName==="TEXTAREA"||n.tagName==="SELECT"||!!n.getAttribute("contenteditable"))}function Eu({clientThreadId:n,isNewThread:e,currentModelId:t,showPromptStarters:s,onRequestCompletion:i,composerContainerRef:r,composerController:o,setComposerBarElement:a}){const l=Fr(),d=Ul();y.useEffect(()=>{function h(f){f.code!=="Space"&&(!f.metaKey||f.key==="v")&&!xT(document.activeElement)&&o.focus()}return window.addEventListener("keypress",h),()=>{window.removeEventListener("keypress",h)}});const u=Jn(h=>{const f=bt.getCurrentNode(n,h);return gT(f)});return!d&&u?c.jsx(bT,{clientThreadId:n}):c.jsxs(c.Fragment,{children:[c.jsx(Xk,{clientThreadId:n}),c.jsx(uc,{clientThreadId:n,isStaticSharedThread:l,showInlineEmbeddedDisplay:!1,withVerticalPadding:!1,withHorizontalPadding:!0,children:c.jsx(hc,{children:c.jsx(vm,{composerContainerRef:r,composerController:o,clientThreadId:n,currentModelId:t,isNewThread:e,showPromptStarters:s,setComposerBarElement:a,onRequestCompletion:i})})})]})}function bT({clientThreadId:n}){const e=wm(n),t=Jn(r=>{var a;return((a=bt.getCurrentNode(n,r).metadata)==null?void 0:a.errCode)===ko}),s=Ph(r=>r.isoDate),i=Mn(n);return t&&s!=null&&s!==""?null:c.jsxs("div",{children:[c.jsx("div",{className:"mb-3 text-center text-xs",children:c.jsx(D,{...Iu.errorGeneratingResponse})}),c.jsx("div",{className:"flex items-center md:mb-4",children:c.jsx(ft,{as:"button",color:"primary",onClick:()=>{const r=new Ss;e({id:i,eventMetadata:{eventSource:"mouse"},conversationMode:bt.getConversationMode(n),turnTracker:r})},className:"m-auto",icon:Af,children:c.jsx(D,{...Iu.regenerateResponse})})})]})}function vm({clientThreadId:n,currentModelId:e,isNewThread:t,onRequestCompletion:s,showPromptStarters:i,composerContainerRef:r,composerController:o,autocompletions:a,requiresFileUpload:l,onComposerInput:d,onComposerChange:u,onAutocompleteSelect:h,headerClassName:f,hideHeader:m,setComposerBarElement:p,onTaggingDropdownClose:g,onTaggingDropdownOpen:S}){var et,Tt;const x=Mn(n),w=Pr(n),C=Ii(),{isUnauthenticated:k}=Ht(),T=xf(n)===rc.PENDING,A=bf({clientThreadId:n,conversationLeafId:x}),L=ks(w),_=(L||T)&&!A,N=Mn(n),z=!k,j=df(),{isOpen:H,onClose:Q}=ay(),B=y.useCallback((Te,Le)=>{$.logEvent(V.continueCompletion),s({type:Cn.Continue,promptId:Te,eventMetadata:{eventSource:"mouse"},cancelActiveRequests:!1,completionMetadata:{conversationMode:bt.getConversationMode(n)},turnTracker:Le})},[s,n]),U=Jo(),O=y.useCallback(async(Te,Le)=>{var mt;const st=I.getServerThreadId(n);gs.stopConversation(st);const Ve=I.getTree(n);!Ve.hasReceivedServerCompletion&&!j&&((mt=Ve.getParent(Le).metadata)==null?void 0:mt.errCode)!==zt.ContentPolicy&&setTimeout(()=>{Za.onCreateFinished(U,st,j)},500),st&&$e.checkGate("3922476776")&&await Ee.stopConversationProcess(st),qo.abortRequest(Le)&&I.updateTree(n,tn=>{const qt=I.getThreadCurrentLeafId(n);tn.updateNodeMessageMetadata(qt,{finish_details:{type:"interrupted"}})})},[n,j,U]),R=y.useCallback(async({promptId:Te,content:Le,eventMetadata:st,completionMetadata:Ve,messageMetadata:Yn,appendMessages:mt,turnTracker:tn})=>{const qt=I.getThreadCurrentLeafId(n);I.updateTree(n,_t=>{_t.addNode(Te,Le,qt,Se.User,void 0,Yn)}),await s({type:Cn.Next,promptId:Te,eventMetadata:st,cancelActiveRequests:!0,completionMetadata:Ve,appendMessages:mt,turnTracker:tn})},[n,s]),M=uS(n,x),F=hS(n,x),J=!A&&(L||T),Z=y.useMemo(()=>J?!1:!M&&F,[M,F,J]),se=J&&e!=="gpt-4-pbrowse",he=dc(n),Ie=en(n),xe=Ms(Ie).data,{promptStarters:Pe,isSuccess:Ke}=Ef(t&&!he,n,4),E=bh(),fe=(()=>{var Te,Le;if((E==null?void 0:E.messageId)===((Le=(Te=I.getTree(n).getLastValidNode(x))==null?void 0:Te.message)==null?void 0:Le.id))return E==null?void 0:E.suggestions;if(i&&!he&&Ke&&!z)return Pe})(),Ue=I.getTree(n),pe=Ue.countMessagesByAuthor(Se.User),Fe=y.useRef(),Je=y.useRef();let ke=!1;Fe.current==pe&&Je.current==N?ke=!0:Fe.current!==pe&&Je.current!==N&&(ke=!0,Fe.current=pe,Je.current=N);const ot=Ue.getNodeByIdOrMessageId(x),ce=ke&&((et=ot==null?void 0:ot.message)==null?void 0:et.author.role)==Se.Assistant&&Zl(ot.message),We=$l(),Ae=Cb(),le=(()=>{var st;if(((st=xe==null?void 0:xe.gizmo.tags)==null?void 0:st.includes(zl.WorkspaceDisabled))&&!Ae)return"workspaceDisallowsGizmo";if(We.size){if(C.displayingSideBySideFeedback&&C.unskippable)return"feedbackRequired"}else return"noModelsAvailable";const Le=bt.getConversationMode(n);return(Le==null?void 0:Le.kind)===De.GizmoTest&&Le.gizmo_id==null?"noTestGizmoId":null})(),we=Sf(n),Gt=Ts(n),In=(Tt=Cs("15117983"))==null?void 0:Tt.value;return c.jsxs(c.Fragment,{children:[(t||ce)&&H?c.jsx(ly,{onClose:Q}):null,In&&Gt&&Gt.kind===De.PrimaryAssistant&&Gt.plugin_ids&&Gt.plugin_ids.length>0?c.jsx(ST,{}):c.jsx(fT,{composerContainerRef:r,composerController:o,clientThreadId:n,onCreateNewCompletion:R,onAbortCompletion:O,onContinueGenerating:B,currentModelId:e,isNewThread:t,isCompletionInProgress:_,className:"w-full",canContinue:Z,suggestions:fe??[],disabled:!!le,disabledReason:le??void 0,canPause:se,isInteractableSharedThread:we,autocompletions:a,requiresFileUpload:l,onComposerInput:d,onComposerChange:u,onAutocompleteSelect:h,headerClassName:f,hideHeader:m,setComposerBarElement:p,onTaggingDropdownClose:g,onTaggingDropdownOpen:S},n)]})}function ST(){return c.jsxs("div",{className:"mx-auto flex max-w-md flex-col items-center justify-center gap-2 rounded-xl border border-token-border-light bg-token-main-surface-primary p-6 shadow-lg",children:[c.jsx("span",{className:"text-token-text-primary",children:c.jsx(D,{id:"PluginsDecrepatedNotice.pluginsDeprecationTitle",defaultMessage:"Conversations with plugins are archived"})}),c.jsx("span",{className:"text-token-text-secondary",children:c.jsx(D,{id:"PluginsDecrepatedNotice.pluginsDeprecationSubtitle",defaultMessage:"Explore GPT Store to find a replacement"})}),c.jsxs("a",{href:"https://chat.openai.com/gpts",className:"text-green-500 hover:cursor-pointer dark:text-green-400",children:[c.jsx(D,{id:"PluginsDecrepatedNotice.pluginsDeprecationGptStoreLink",defaultMessage:"Explore GPTs"}),c.jsx("span",{className:"ml-2",children:c.jsx(D,{id:"PluginsDecrepatedNotice.pluginsDeprecationGptStoreLinkArrow",defaultMessage:"â†’"})})]})]})}const Iu=Ce({errorGeneratingResponse:{id:"PromptTextarea.errorGeneratingResponse",defaultMessage:"There was an error generating a response"},regenerateResponse:{id:"PromptTextarea.regenerateResponse",defaultMessage:"Regenerate"}}),Au=4;function kT(n){const{layer:e}=En("4031588851"),{layer:t}=Ko("4031588851");return n?e.get("enable_new_homepage",!1):t.get("enable_new_homepage",!1)}function wT(){const{layer:n}=Ko("4031588851"),e=n.get("autocomplete_qualified_start_date","2099-09-13T00:00:00Z"),t=Er();return!!t&&t.created*1e3>=new Date(e).getTime()}function CT(n){const{layer:e}=En("4031588851"),{layer:t}=Ko("4031588851");return n?e.get("enable_new_autocomplete_homepage",!1):t.get("enable_new_autocomplete_homepage",!1)}function vT(n){return c.jsx(Cm,{children:e=>c.jsx(MT,{...n,composerController:e})})}function MT({clientThreadId:n,currentModelId:e,onRequestCompletion:t,composerController:s}){const i=ms(n),r=dc(n),o=nc(),a=Dr(),[l,d]=y.useState([]),u=y.useRef(!1),h=Yo("589604007").value,{layer:f}=En("4031588851"),{promptStarters:m,isSuccess:p,isError:g}=Ef(i&&!r,n,a?4:8,h,!0,e),S=!!l.find(B=>!!B.requires_file_upload),x=y.useCallback(B=>{const U=s.getCurrentText();return U&&`${B.title}${B.body}`.toLowerCase().startsWith(U.toLowerCase())},[s]),w=y.useCallback(B=>{const U=s.getCurrentText(),O=B.title+B.body;return x(B)?{...B,title:U,body:O.slice(U.length)}:{...B,title:O,body:""}},[s,x]),C=y.useCallback((B=!1)=>{d(U=>!U.some(x)&&U.length>0?[]:B?U:U.map(w))},[x,w]),k=(B,U,O)=>{const R=`${B.title} `;d([]),s.focus(),s.setText(R),requestAnimationFrame(()=>{const M=((m==null?void 0:m.filter(F=>F.theme===B.theme))??[]).map(F=>({...F,title:`${F.title} `,type:Qc.Autocomplete}));d(M),M.length>0&&_o(M,n),ES(B,O,n)})},v=m==null?void 0:m.reduce((B,U)=>(U.theme&&!B[U.theme]&&(B[U.theme]=U),B),{}),T=[];if(v)for(const B in v)T.push(v[B]);const A=T&&T.length>0,L=!!(p&&A),_=Au-l.filter(x).length,N=f.get("autocomplete_mode","HARDCODED"),z=y.useCallback(Vl(async B=>{const U=s.getCurrentText();if(!U||U.length<2||U.length>80){d([]);return}if(!u.current)try{const R=(await Ee.generateAutocompletions(U,B)).completions.map(M=>({id:Or(),type:Qc.Autocomplete,title:U,body:M.slice(U.length),oneliner:M,prompt:M})).filter(x).map(w);d(M=>{const F=M.filter(x),J=R.filter(Z=>!F.some(se=>se.title===Z.title&&se.body===Z.body)).slice(0,Au-F.length);return[...F,...J]}),R.length>0&&_o(R,n)}catch{}},N==="BING"?150:200),[s,N,w]),j=y.useCallback(()=>{C(),_>0&&z(_)},[z,C,_]);y.useEffect(()=>{u.current&&d([])},[u]);const H=y.useMemo(()=>N==="HARDCODED"?C:j,[N,j,C]),Q=y.useCallback(()=>{s instanceof ca&&C(!0)},[s,C]);return c.jsx(c.Fragment,{children:c.jsx(ws,{children:(g||p)&&c.jsx(c.Fragment,{children:c.jsx(uc,{isStaticSharedThread:!1,showInlineEmbeddedDisplay:!1,withVerticalPadding:!0,withHorizontalPadding:!0,clientThreadId:n,children:c.jsxs(NS,{children:[c.jsx(TT,{}),c.jsx("div",{className:"w-full",children:c.jsx(vm,{clientThreadId:n,isNewThread:i,currentModelId:e,onRequestCompletion:t,showPromptStarters:!1,composerController:s,autocompletions:l,requiresFileUpload:S,onComposerInput:H,onComposerChange:Q,onAutocompleteSelect:(B,U,O)=>{d([U[O]])},onTaggingDropdownClose:()=>{u.current=!1},onTaggingDropdownOpen:()=>{u.current=!0},hideHeader:!0})}),L&&c.jsx(_T,{initial:{opacity:0},animate:{opacity:1},transition:{duration:.3},promptStarters:T,onSelectStarterPrompt:k,isSendBlocked:o,clientThreadId:n,className:"h-8"})]})})})})})}function TT(){const{layer:n}=En("4031588851"),e=n.get("headline_option","HELP_WITH"),s=ue().formatMessage(e==="WHERE_TO_START"?Sl.whereShouldWeStart:Sl.whatCanIHelpWith),[i,r]=y.useState(1),[o,a]=y.useState(!0),l=20;return y.useEffect(()=>{let d;return i<s.length?d=setTimeout(()=>{r(i+1)},l):o&&(d=setTimeout(()=>{a(!1)},500)),()=>clearTimeout(d)},[s,i,o]),c.jsx("div",{className:"text-center",children:c.jsxs("div",{className:"mb-7 inline-flex justify-center text-2xl font-semibold leading-9",children:[c.jsx("h1",{children:s.substring(0,i)}),c.jsx("h1",{className:"result-streaming transition-opacity",style:{opacity:o?1:0},children:c.jsx("span",{})})]})})}function _T({promptStarters:n,onSelectStarterPrompt:e,isSendBlocked:t,clientThreadId:s,...i}){return c.jsx(Oe.div,{...i,children:c.jsx(AT,{starterPrompts:n,onSelectStarterPrompt:e,disabled:t,clientThreadId:s})})}const NT=/\s/;function ET({starterPrompt:n,starterPrompts:e,index:t,disabled:s,onSelectStarterPrompt:i}){const r=n.theme??n.title,o=NT.test(r);return c.jsxs("button",{className:"relative flex items-center gap-1.5 rounded-full border border-token-border-light px-3 py-2 text-start text-[13px] shadow-xxs transition enabled:hover:bg-token-main-surface-secondary disabled:cursor-not-allowed xl:gap-2 xl:text-[14px]",disabled:s,onClick:()=>i(n,e,t),children:[c.jsx(cy,{starterPrompt:n,useV2Colors:!0}),c.jsx("div",{className:K("max-w-full text-balance text-gray-600 dark:text-gray-500",o?"break-word":"break-all"),children:r})]})}function ju({starterPrompts:n,onSelectStarterPrompt:e,disabled:t,clientThreadId:s,children:i}){return y.useEffect(()=>{_o(n,s)},[s]),c.jsxs("ul",{className:"flex max-w-3xl flex-wrap items-stretch justify-center gap-2 xl:mx-3 xl:gap-2.5",children:[n.map((r,o)=>c.jsx(Oe.li,{initial:{opacity:0},animate:{opacity:1},transition:{delay:o*.03},exit:{opacity:0},children:c.jsx(ET,{starterPrompt:r,starterPrompts:n,index:o,disabled:t,onSelectStarterPrompt:e})},r.id??o)),i]})}function IT({clientThreadId:n,onClick:e}){y.useEffect(()=>{IS(n)},[n]);const t=ue();return c.jsx("button",{className:"relative flex max-w-full items-center gap-2 text-balance rounded-full border border-token-border-light px-3 py-2 text-start text-[14px] text-gray-600 shadow-xxs transition enabled:hover:bg-token-main-surface-secondary disabled:cursor-not-allowed dark:text-gray-500",onClick:()=>{AS(n),e()},children:t.formatMessage(Sl.moreStarterPrompts)})}function AT({starterPrompts:n,onSelectStarterPrompt:e,disabled:t,clientThreadId:s}){const[i,r]=y.useState(4),o=4,a=n.slice(0,o),l=n.slice(o,i).map(d=>({...d,isAdditional:!0}));return c.jsxs("div",{className:"mt-7 flex flex-col flex-wrap gap-y-2.5",children:[c.jsx("div",{children:c.jsx(ju,{starterPrompts:a,onSelectStarterPrompt:e,disabled:t,clientThreadId:s,children:n.length>i&&c.jsx(IT,{clientThreadId:s,onClick:()=>{r(n.length)}})})}),l&&l.length>0&&c.jsx(ju,{starterPrompts:l,onSelectStarterPrompt:e,disabled:t,clientThreadId:s})]})}const Sl=Ce({whatCanIHelpWith:{id:"SplashScreenV2.whatCanIHelpWith",defaultMessage:"What can I help with?"},whereShouldWeStart:{id:"SplashScreenV2.whereShouldWeStart",defaultMessage:"Where should we start?"},moreStarterPrompts:{id:"SplashScreenV2.moreStarterPrompts",defaultMessage:"More"}}),pi=Ce({submitRejectModeration:{id:"feedbackModal.moderationReject",defaultMessage:"Block Content"},submitAcceptModeration:{id:"feedbackModal.moderationAccept",defaultMessage:"Allow Content"},thumbsDownPlaceholder:{id:"feedbackModal.thumbsDownPlaceholder",defaultMessage:"What was the issue with the response? How could it be improved?"},copyrightContent:{id:"feedbackModal.copyrightContent",defaultMessage:"This content violates copyright law"},reportOtherContent:{id:"feedbackModal.reportOtherContent",defaultMessage:"I don't like this for some other reason (please describe)"},provideAdditionalFeedback:{id:"feedbackModal.provideAdditionalFeedback",defaultMessage:"Provide additional feedback"}});function jT({onClose:n,clientThreadId:e}){var x;const t=ue(),s=I.getTree(e),i=(x=y.useContext(uf))==null?void 0:x.serverSharedThreadId,r=I.getServerThreadId(e),o=i??r,a=y.useRef([]),l=y.useRef(""),d=y.useRef(null),u=y.useCallback(()=>{var C;const w=(C=d.current)==null?void 0:C.elements;a.current=[...w||[]].filter(k=>k.checked).map(k=>k.id).map(k=>k.replace("feedback-","")),l.current=(w==null?void 0:w["feedback-other"].value)||""},[]),h=y.useCallback((w,C)=>{if(o==null){pn.danger("Moderation NOT logged successfully! serverThreadId is null"),xt.addError("Moderation: serverThreadId is null");return}const k=s.getMessageId(I.getThreadCurrentLeafId(e));Ee.submitSharedConversationReportFeedback({message_id:k,shared_conversation_id:o,text:w,tags:C}).then(()=>{pn.success("Moderation logged successfully")}).catch(v=>{pn.danger("Moderation NOT logged successfully! Please try again"),xt.addError(new Error("Moderation: failed to log",{cause:v}))}),n()},[s,e,n,o]),f=y.useCallback(()=>{u(),a.current.push("moderation-reject"),h(l.current,a.current)},[h,u]),m=y.useCallback(()=>{u(),a.current.push("moderation-accept"),h(l.current,a.current)},[h,u]),p=c.jsxs(c.Fragment,{children:[c.jsx(xa.Button,{title:t.formatMessage(pi.submitRejectModeration),color:"danger",onClick:f}),c.jsx(xa.Button,{title:t.formatMessage(pi.submitAcceptModeration),color:"primary",onClick:m})]}),[g,S]=y.useState([]);return y.useEffect(()=>{Ee.fetchShareModerationCategories().then(w=>{const C=w.moderation_categories;S(Object.keys(C).map(k=>[k,C[k]]))})},[]),c.jsxs(vb,{isOpen:!0,onClose:n,showCloseButton:!0,size:"custom",className:"md:max-w-[672px] lg:max-w-[896px] xl:max-w-6xl",type:"success",title:t.formatMessage(pi.provideAdditionalFeedback),children:[c.jsxs("form",{ref:d,children:[c.jsx(Ah,{id:"feedback-other",placeholder:t.formatMessage(pi.thumbsDownPlaceholder),rows:3,className:"mb-1 mt-4 w-full resize-none rounded-md bg-token-main-surface-primary"}),c.jsxs("div",{className:"mb-4",children:[g.map(([w,C])=>c.jsx(ma,{id:"feedback-"+w,label:C},w)),c.jsx(ma,{id:"feedback-copyright",label:t.formatMessage(pi.copyrightContent)}),c.jsx(ma,{id:"feedback-content-other",label:t.formatMessage(pi.reportOtherContent)})]})]}),c.jsx(xa.Actions,{primaryButton:p})]})}function RT({clientThreadId:n}){return dy(fr.SharedConversationModeration)?c.jsx(jT,{onClose:()=>Ai.closeModal(fr.SharedConversationModeration),clientThreadId:n}):null}const DT=({clientThreadId:n})=>{const e=Nn(),t=en(n),{data:s,isLoading:i}=Ms(t);if(i)return null;const r=e!=null&&e.accountUserId?s?Fa.loggedInCtaGizmo:Fa.loggedInCta:Fa.loggedOutCta,o=e&&s?$h(s):"/";let a=V.sharedConversationLoggedOutClicked;return e&&(e!=null&&e.accountUserId)&&(e.isFree()?a=s?V.sharedConversationFreeGizmoClicked:V.sharedConversationFreeClicked:a=s?V.sharedConversationPaidGizmoClicked:V.sharedConversationPaidClicked),c.jsx("div",{className:"flex flex-col items-center gap-4",children:c.jsx(uy,{href:o,onClickTrackingEventName:a,children:c.jsx(D,{...r,values:{name:s==null?void 0:s.gizmo.display.name}})})})},Fa=Ce({loggedOutCta:{id:"GizmoSharedConversationCTA.loggedOutCta",defaultMessage:"Sign up to chat"},loggedInCtaGizmo:{id:"GizmoSharedConversationCTA.loggedInCtaGizmo",defaultMessage:"Get started with {name}"},loggedInCta:{id:"GizmoSharedConversationCTA.loggedInCta",defaultMessage:"Get started with ChatGPT"}});function OT({clientThreadId:n,isModeratingThread:e,continueConversationUrl:t}){const s=Bi(),i=ue(),{layer:r}=En("2840731323"),o=r.get("is_continue_enabled",!1)||(s==null?void 0:s.includes("debug"));return c.jsxs("div",{className:"relative flex w-full flex-1 flex-col items-center justify-center gap-2 pt-3 empty:hidden sm:flex-row",children:[!o&&c.jsx(DT,{clientThreadId:n}),e&&c.jsx(ft,{onClick:()=>{Ai.openModal(fr.SharedConversationModeration)},children:i.formatMessage({id:"thread.sharedConversation.moderate",defaultMessage:"Moderate conversation"})}),o&&t&&c.jsx(ft,{color:"primary",as:"link",to:t,size:"giant",onClick:()=>{$e.logEvent("chatgpt_continue_shared_conversation_click"),$.logEvent(V.sharedConversationContinueConversationClicked)},children:i.formatMessage({id:"thread.sharedConversation.continue",defaultMessage:"Continue this conversation"})})]})}function PT({children:n}){const e=Fi(Li.AG8PqS2q),{eligible:t,isLoading:s}=BS(),{doesUserHaveAnyAccountsWithPlusFeatures:i}=ti(),r=t&&!s;if(y.useEffect(()=>{r&&$.logEvent(V.gpt4oNUXTooltipShown)},[r]),!r)return c.jsx(c.Fragment,{children:n});const o=()=>{$.logEvent(V.gpt4oNUXTooltipDismissed),e.markAsViewed()};return c.jsx(Wo,{side:"bottom",show:!0,title:c.jsx(D,{...La.title,values:{modelName:"GPTâ€‘4o"}}),onDismiss:o,sideOffset:0,theme:"default",description:c.jsx(D,{...i?La.bodyPaidFinal:La.bodyFreeFinal,values:{modelName:"GPTâ€‘4o",anotherModelName:"GPTâ€‘4"}}),children:n})}const La=Ce({title:{id:"1kewDD",defaultMessage:"Introducing {modelName}"},bodyPaidFinal:{id:"Z6KHqN",defaultMessage:"You can now try our newest model, {modelName}. Itâ€™s faster than {anotherModelName}, better at understanding images, and speaks more languages."},bodyFreeFinal:{id:"w8Y79o",defaultMessage:"You now have limited access to our latest model, {modelName}. Itâ€™s smarter, understands images, can browse the web, and speaks more languages."}}),Fc=({categoryId:n,type:e,className:t})=>{const{data:s,isLoading:i}=Kx(),r=c.jsx("div",{className:t});if(i)return r;const{iconFilledSrc:o,iconOutlineSrc:a}=(s==null?void 0:s[n])??{},l=(e==="filled"?o:a)??"";return c.jsx(hf,{name:"ModelCategoryIcon",fallback:r,children:c.jsx("div",{className:K("[&_svg]:h-full [&_svg]:w-full",t),dangerouslySetInnerHTML:{__html:l}})})};function FT({currentModel:n,categoryOptions:e,className:t,modelSwitcherDenialsBySlug:s}){const i=n==null?void 0:n.id;return c.jsx(ne.Portal,{children:c.jsx(ne.SubContent,{className:t,children:e.map(r=>{const{value:o}=r;return"options"in r?c.jsx(po,{currentModel:n,isSelected:i.startsWith(o),option:r,modelSwitcherDenialsBySlug:s},o):c.jsx(Lo,{isSelected:i===o,value:o,renderName:()=>r.name,modelSwitcherDenialsBySlug:s,showNewChatHint:!1},o)})})})}function po({currentModel:n,option:e,isSelected:t=!1,modelSwitcherDenialsBySlug:s}){const{name:i,options:r,categoryId:o}=e,a=`${i} Models`,l=()=>c.jsx("div",{className:"flex shrink-0 grow justify-between gap-2",children:c.jsxs("div",{className:"flex items-center gap-3",children:[c.jsx(JS,{className:"icon-md w-7 text-token-text-secondary"}),a]})});return c.jsxs(ne.Sub,{children:[c.jsx(ne.SubMenuTrigger,{children:c.jsxs("div",{className:"flex grow justify-between gap-2 overflow-hidden",children:[o?l():i,t&&c.jsx("div",{className:"truncate text-token-text-tertiary",children:n.title})]})}),c.jsx(FT,{currentModel:n,categoryOptions:r,modelSwitcherDenialsBySlug:s})]})}function Lo({value:n,renderName:e,isSelected:t,showNewChatHint:s=!0,onClick:i,modelSwitcherDenialsBySlug:r,isUpgradeUpsell:o=!1}){var f,m;const a=Kh(),l=hy(),d=n?(m=(f=r[n])==null?void 0:f.conversation)==null?void 0:m[0]:null,{layer:u}=En("1846737571"),h=c.jsx(ne.Item,{onClick:()=>{if(i)i();else if(n){const p=n;a({modelId:p,location:"Model switcher menu item"}),l(p)}},className:K("!pr-3",t&&"!opacity-100",d&&"pointer-events-none text-token-text-quaternary"),children:c.jsxs("div",{className:"flex grow items-center justify-between gap-2",children:[c.jsx("div",{children:e(d!=null)}),o&&c.jsx(ft,{color:"secondary",size:"small",className:u.get("is_upgrade_button_blue",!1)?"border-none bg-blue-600 text-white hover:bg-blue-800":"",children:c.jsx(D,{id:"oKo8wt",defaultMessage:"Upgrade"})}),o?c.jsx(c.Fragment,{children:t&&c.jsx(Df,{className:K("icon-md group-hover:invisible",!s&&"block group-hover:hidden")})}):t&&c.jsx(Rf,{className:"icon-md"})]})},n);return d?c.jsx(vs,{isLeftArrow:!0,sideOffset:-10,label:c.jsx(Fh,{modelSwitcherDeny:d}),children:h}):h}var Mm=(n=>(n.BROWSING="browsing_model",n.CODE_INTERPRETER="code_interpreter_model",n.DALLE="dalle_model",n))(Mm||{}),Os=(n=>(n.ALPHA="alpha",n.EXPERIMENTS="experiments",n.MAINLINE="mainline",n))(Os||{});const Ba={browsing_model:{name:c.jsxs("span",{children:["Browse with ",c.jsx(_b,{className:"icon-sm mt-[-3px] inline-block"})," Bing"]})},code_interpreter_model:{name:"Advanced Data Analysis"},dalle_model:{name:"DALLÂ·E 3"}};function LT(n){const e=BT(n??void 0);return Lh(["alpha","experiments","mainline"],e)?"bg-orange-500 text-white":"bg-token-main-surface-primary text-token-text-primary"}function BT(n){const e=Lc();for(const t of e)if(t.options.length>0&&t.options.find(i=>i.value===n))return t.categoryId;return null}function zT(n,e){const{data:t}=Jh();return(t==null?void 0:t.categories.some(i=>i[e]===n))??!1}const UT=n=>my(n,({id:e})=>e.split(":").slice(0,1).join(":"));function Lc(){const{data:n}=Jh(),e=fy(),t=Nn(),s=Mb(t==null?void 0:t.getWorkspaceId()),i=(t==null?void 0:t.isEnterprise())??!1,{modelSwitcherDisclaimer:r}=py(),o=$l();return y.useMemo(()=>{const a=[];if(!n)return a;const{categories:l,groups:d,modelsMap:u}=n;for(const h of l){const{defaultModel:f,categoryId:m,label:p}=h;if(o.has(f)){const g=e===f,S=n.modelsMap[f],x=g?[]:VT(s.data,h,o,n.modelsMap,i);a.push({categoryId:m,value:f,name:p,description:g?r:S.description,options:[vi(S,{name:"Default"}),...x]})}}for(const h of d){const{group:f,label:m,modelIds:p}=h,g=p[0],S=p.map(x=>u[x]).filter(({tags:x})=>!x.includes(Tb.HIDDEN));if(f==="experiments"){const x=UT(S),w=Object.entries(x).map(([C,k])=>{const v=C.split(":").slice(-1)[0];return{key:C,value:v,name:v,options:k.map(T=>{const{title:A}=T;return vi({...T,title:A.replace(v,"")})})}});a.push({categoryId:f,value:g,name:m,options:w})}else a.push({categoryId:f,value:g,name:m,options:S.map(x=>vi(x))})}return a},[n,o,e,s.data,i,r])}function vi(n,e={}){return{value:n.id,name:n.title,...e}}function VT(n,e,t,s,i){const r=[],o=n==null?void 0:n.browsing;if((i&&o||!i)&&e.browsing_model!=null&&t.has(e.browsing_model)){const l=Ba.browsing_model;r.push(vi(s[e.browsing_model],{name:l.name}))}if(e.code_interpreter_model!=null&&t.has(e.code_interpreter_model)){const l=Ba.code_interpreter_model;r.push(vi(s[e.code_interpreter_model],{name:l.name}))}if(e.dalle_model!=null&&t.has(e.dalle_model)){const l=Ba.dalle_model;r.push(vi(s[e.dalle_model],{name:l.name}))}return r}const WT=Me(()=>ve(()=>import("./l8890zpgvdiya88u.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10])).then(n=>n.ThreadHeaderGizmoDropdown)),HT=Me(()=>ve(()=>import("./sso-bcdhwpqolbad0i57.js").then(n=>n.b),__vite__mapDeps([11,1,2,3,5,6,12,7,8,4,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77])).then(n=>n.default)),Ru=ze.button`group flex cursor-pointer items-center gap-1 rounded-lg py-1.5 px-3 text-lg font-semibold hover:bg-token-main-surface-secondary radix-state-open:bg-token-main-surface-secondary text-token-text-secondary overflow-hidden whitespace-nowrap`;function GT({clientThreadId:n}){const e=ue(),t=Kn(),s=cc(n),i=jr(),r=()=>{by(i,s,t,!0)};return c.jsx(ne.Item,{size:"large",className:"!pr-3",onClick:r,icon:If,children:c.jsxs("div",{className:"flex grow items-center justify-between gap-2",children:[c.jsx("div",{className:"flex flex-1 items-center gap-3",children:c.jsx(D,{...XT.temporaryChat})}),c.jsx(yy,{onChange:r,enabled:t,label:e.formatMessage({defaultMessage:"Temporary",id:"temporaryChatToggleLabel"})})]})})}function Tm(n,e,t){let s=n;if(n===id.AUTO){const o=e.filter(({defaultModel:a})=>a!==id.AUTO);o.length===1&&(s=o[0].defaultModel)}const i=e.find(({defaultModel:o})=>o===s);if(i){const{categoryId:o,shortLabel:a}=i;return{selectedCategory:o,modelLabel:a}}const r=t.find(({modelIds:o})=>o.includes(s));if(r){const{group:o,shortLabel:a}=r;return{selectedCategory:o,modelLabel:a}}return{selectedCategory:null,modelLabel:null}}function qT({modelLabel:n}){return c.jsx("span",{className:"text-token-text-secondary",children:n})}function $T({clientThreadId:n,inMobileHeader:e}){const{isLoading:t,categories:s,groups:i}=Ar(),r=Nb(),a=Ql(n).id,l=Lc(),{modelLabel:d}=Tm(a,s,i),u=JT(n,l),h=ue(),{isUnauthenticated:f}=Ht(),m=_m(),p=(!f||!m)&&!r;y.useEffect(()=>{var S;t||(S=Bh({namespace:So.ChatPageLoad}))==null||S.logTiming("render_model_switcher")},[t]);const g=c.jsxs("div",{className:"text-token-text-secondary",children:[xy," ",p?c.jsx("span",{className:"text-token-text-secondary",children:d}):f&&d?c.jsx(qT,{modelLabel:d}):null]});return u.length?t?null:c.jsx(pk,{sideOffset:8,size:"large",triggerButton:c.jsxs(Ru,{"aria-label":d?h.formatMessage({id:"JrtGPQ",defaultMessage:"Model selector, current model is {modelLabel}"},{modelLabel:d}):"",children:[g,c.jsx(Zo,{className:"icon-md text-token-text-tertiary"})]}),onOpenChange:S=>{$.logEvent(V.toggleModelSwitcher,{isOpen:S}),$e.logEvent("toggle_model_switcher",null,{isOpen:String(S)})},contentAlign:e?"center":"start",children:c.jsx(YT,{sections:u})}):c.jsx(Ru,{className:"cursor-default",children:g})}function _m(){return Yo("462735957").value}function KT({category:n,modelSwitcherDenialsBySlug:e,currentGizmoId:t,currentModelId:s,omitIcon:i}){const{defaultModel:r,label:o,categoryId:a,description:l}=n;return c.jsx(Lo,{value:r,modelSwitcherDenialsBySlug:e,renderName:d=>c.jsx(kl,{categoryId:a,name:o,description:l,isDisabled:d,omitIcon:i}),isSelected:!t&&s===r},r)}function JT(n,e){var U,O,R;const t=Ql(n),s=t.id,i=en(n),{categories:r,groups:o}=Ar(),{doesUserHaveAnyAccountsWithPlusFeatures:a}=ti(),l=I.getServerThreadId(n),d=Yh({clientThreadId:n}),u=kk(),h=ue(),f=!l,{isUnauthenticated:m}=Ht(),p=zh(),{layer:g}=En("2723963139"),S=g.get("is_dynamic_model_enabled",!1),x=_m(),w=e.find(({categoryId:M})=>M===Os.ALPHA),C=e.find(({categoryId:M})=>M===Os.EXPERIMENTS),k=e.find(({categoryId:M})=>M===Os.MAINLINE),v=Yo("566128514").value,T=!!((U=w==null?void 0:w.options)!=null&&U.length),A=!!((O=C==null?void 0:C.options)!=null&&O.length),L=!!((R=k==null?void 0:k.options)!=null&&R.length),_=Rr(),N=y.useCallback(()=>{$.logEvent(V.openModalAccountPaymentfromModelPicker,{content:"gizmo-button"}),Rl(_,"Thread header dropdown")},[_]),z=()=>{$e.logEvent("chatgpt_model_switcher_plus_upgrade_button_clicked"),$.logEvent(V.modelSwitcherPlusUpgradeButtonClicked),m?(Eb.setCookie(Ib.ShowPaymentModal,!0,{maxAge:6*60*60}),p({callback:M=>{$.logSignUpButtonClicked({location:"Model switcher GPT-4 upsell",provider:M})}})):N()},j=[],H=c.jsxs("div",{className:"mb-1 flex items-center justify-between px-5 pt-2",children:[c.jsx("span",{className:"text-sm text-token-text-tertiary",children:c.jsx(D,{id:"ilkdMh",defaultMessage:"Model"})}),c.jsx("a",{href:S?"https://help.openai.com/en/articles/9155758-what-is-the-chatgpt-plus-model-selector":"https://help.openai.com/en/articles/7102672-how-can-i-access-gpt-4",target:"_blank",rel:"noreferrer",children:c.jsx(gr,{className:"icon-md h-5 w-5 pl-0.5 text-token-text-tertiary"})})]},"header");if(x&&m){const M={id:"modelSection",content:[]};M.content.push(c.jsx(gy,{},"noAuthUpsell")),j.push(M)}else if(a){const M={id:"modelSection",content:[]};r.length&&M.content.push(H);const F=new Map;r.forEach(J=>{var se;const Z=c.jsx(KT,{category:J,currentGizmoId:i,currentModelId:s,modelSwitcherDenialsBySlug:d,omitIcon:v});J.subcategory?(F.has(J.subcategory)||F.set(J.subcategory,[]),(se=F.get(J.subcategory))==null||se.push(Z)):M.content.push(Z)}),F.forEach((J,Z)=>{const se=r.find(he=>he.subcategory===Z&&he.defaultModel===t.id);M.content.push(c.jsxs(ne.Sub,{children:[c.jsx(ne.SubMenuTrigger,{children:c.jsxs("div",{className:"flex grow justify-between gap-2 overflow-hidden",children:[Z,!!se&&c.jsx("div",{className:"truncate text-token-text-tertiary",children:se.label})]})}),c.jsx(ne.Portal,{children:c.jsx(ne.SubContent,{className:"min-w-72",children:J})})]}))}),j.push(M)}else{const M={id:"modelSection",content:[]};M.content.push(c.jsx(Lo,{value:"",onClick:z,modelSwitcherDenialsBySlug:d,isUpgradeUpsell:!0,renderName:F=>c.jsx(kl,{icon:QS,isDisabled:F,name:h.formatMessage({id:"mzDzkX",defaultMessage:"ChatGPT Plus"}),description:h.formatMessage({id:"bqTHri",defaultMessage:"Our smartest model & more"}),omitIcon:!1}),isSelected:!1,showNewChatHint:!1},"plusUpgrade")),M.content.push(c.jsx(Lo,{value:ga.AUTO,modelSwitcherDenialsBySlug:d,renderName:F=>c.jsx(kl,{icon:YS,name:h.formatMessage({id:"U9E7Rx",defaultMessage:"ChatGPT"}),description:h.formatMessage({id:"n96qML",defaultMessage:"Great for everyday tasks"}),isDisabled:F,omitIcon:!1}),isSelected:!i&&s===ga.AUTO,showNewChatHint:!0},ga.AUTO)),j.push(M)}const Q={id:"otherOptionsSection",content:[]},{selectedCategory:B}=Tm(s,r,o);return f&&(T&&Q.content.push(c.jsx(po,{isSelected:B===Os.ALPHA,currentModel:t,option:w,modelSwitcherDenialsBySlug:d},w.value)),A&&Q.content.push(c.jsx(po,{currentModel:t,isSelected:B===Os.EXPERIMENTS,option:C,modelSwitcherDenialsBySlug:d},C.value)),L&&Q.content.push(c.jsx(po,{isSelected:B===Os.MAINLINE,currentModel:t,option:k,modelSwitcherDenialsBySlug:d},k.value))),u&&Q.content.push(c.jsx(HT,{clientThreadId:n},"c")),Q.content.length&&j.push(Q),m||j.push({id:"temporaryChatSection",content:[c.jsx(GT,{clientThreadId:n},"tempChat")]}),j}function kl({isDisabled:n,name:e,icon:t,categoryId:s,description:i,extra:r,omitIcon:o}){return c.jsxs("div",{className:"flex items-center gap-3",children:[!o&&c.jsx("span",{className:"flex h-7 w-7 flex-shrink-0 items-center justify-center rounded-full bg-token-main-surface-secondary",children:t?c.jsx(t,{className:"h-4 w-4 text-token-text-primary"}):s&&c.jsx(Fc,{type:"filled",className:K("h-4 w-4",n&&"text-gray-300",!n&&"text-token-text-primary"),categoryId:s})}),c.jsxs("div",{children:[e,c.jsxs("div",{className:K(!n&&"text-token-text-secondary","text-xs"),children:[i,r]})]})]})}function YT({sections:n}){return c.jsx(c.Fragment,{children:n.map((e,t)=>c.jsxs(oc.Fragment,{children:[t!==0?c.jsx(ne.Separator,{}):null,e.content]},e.id))})}function QT({clientThreadId:n,inMobileHeader:e=!1}){const t=en(n);return t==null?c.jsx($T,{clientThreadId:n,inMobileHeader:e}):c.jsx(WT,{clientThreadId:n,gizmoId:t,inMobileHeader:e})}const XT=Ce({gpt35ShortExplainer:{defaultMessage:"Great for everyday tasks",id:"ModelSwitcher.gpt35ShortExplainer"},modelTunerSmartSelectionTitle:{id:"czjW8I",defaultMessage:"Dynamic"},modelTunerSmartSelectionExplainer:{id:"gp/YH1",defaultMessage:"Optimized for speed and intelligence"},gpt4ShortExplainer:{defaultMessage:"With DALLÂ·E, browsing and analysis",id:"ModelSwitcher.gpt4ShortExplainer"},gpt4ShortExplainerWithoutBrowse:{defaultMessage:"With DALLÂ·E and analysis",id:"ModelSwitcher.gpt4ShortExplainerWithoutBrowse"},gpt4UpsellExplainer:{id:"ModelSwitcher.gpt4Upsell",defaultMessage:"Our smartest and most capable model. Includes DALLÂ·E, browsing and more."},userUpgrade:{id:"ModelSwithcer.upgradeButton",defaultMessage:"Upgrade to Plus"},userUpgradeSignup:{id:"ModelSwitcher.signupUpgradeButton",defaultMessage:"Sign up for ChatGPT Plus"},temporaryChat:{id:"ModelSwitcher.temporaryChat",defaultMessage:"Temporary chat"},shareChat:{id:"ModelSwitcher.shareChat",defaultMessage:"Share chat"}}),ZT=Me(()=>ve(()=>import("./ir9q6xv1jnwovbqv.js"),__vite__mapDeps([78,1,2,3,79,80,5,6,81,4,7,8,21,82,12,63,34,83,84,10,9,85,86,19,16,17,20])).then(n=>n.GizmoUsingAsOwnerNotice)),e_=({clientThreadId:n})=>{const e=Dh(l=>l.activeStageSidebar),t=I.getServerThreadId(n),s=Cy(ni.WorkspaceShareLinks),{isUnauthenticated:i}=Ht(),r=Kn(),o=s&&t&&!i&&!r,a=!e;return c.jsx("div",{className:"flex items-center gap-2 pr-1 leading-[0]",children:c.jsx(Ck,{showShareButton:o,showProfileDropdown:a,clientThreadId:n})})};function t_({clientThreadId:n,gizmoId:e}){var r;const t=Sy(),{data:s}=Ms(e),i=Nn();return c.jsxs(c.Fragment,{children:[c.jsxs(ky,{className:"max-md:hidden",children:[c.jsxs("div",{className:"absolute start-1/2 ltr:-translate-x-1/2 rtl:translate-x-1/2",children:[s!=null&&(i==null?void 0:i.isWorkspaceAccount())&&((r=s.gizmo.tags)==null?void 0:r.includes(zl.WorkspaceDisabled))&&c.jsx(ZT,{gizmo:s}),c.jsx(Dk,{gizmoId:e,clientThreadId:n})]}),c.jsx(PT,{children:c.jsxs("div",{className:"flex items-center gap-0 overflow-hidden",children:[c.jsx(wk,{clientThreadId:n}),c.jsx(QT,{clientThreadId:n})]})}),c.jsx(e_,{clientThreadId:n})]}),t&&c.jsx(wy,{})]})}function Nm({clientThreadId:n}){const e=en(n);return Fr()?null:c.jsx(t_,{gizmoId:e,clientThreadId:n})}function n_({clientThreadId:n,currentModelId:e,onRequestCompletion:t,enableV2Homepage:s}){const i=Kn();let r=c.jsx(RS,{}),o;return i?(o=c.jsx(s_,{}),r=c.jsx(Zh,{className:"mb-6 h-12 w-12"})):n!=null?(o=s?c.jsx(vT,{clientThreadId:n,currentModelId:e,onRequestCompletion:t}):c.jsx(DS,{clientThreadId:n}),r=null):o=c.jsx(i_,{}),c.jsxs("div",{className:"flex h-full flex-col items-center justify-center text-token-text-primary",children:[r,o]})}function s_({gizmo:n}){const e=lh(),t=n?Nk(n.tools):!1,s=Nn();return c.jsxs(c.Fragment,{children:[c.jsx("div",{className:"mb-5 text-2xl font-semibold",children:c.jsx(D,{...Ps.temporaryChat})}),c.jsxs("div",{className:"max-w-sm text-center text-sm font-normal text-token-text-tertiary",children:[c.jsx(D,{...s!=null&&s.isWorkspaceAccount()?e?Ps.temporaryChatBizMemoryAvailable:Ps.temporaryChatBizMemoryUnavailable:e?Ps.temporaryChatDescriptionMemoryAvailable:Ps.temporaryChatDescriptionMemoryUnavailable}),t&&c.jsx("div",{className:"mt-3",children:c.jsx(D,{...Ps.temporaryChatDescriptionGptActions,values:{link:i=>c.jsx("a",{href:"https://help.openai.com/en/articles/8914046-temporary-chat-faq",target:"_blank",className:"underline",rel:"noreferrer",children:i})}})})]})]})}function i_(){return c.jsx("div",{className:"mb-5 text-2xl font-semibold",children:c.jsx(D,{...Ps.howCanIHelpYouToday})})}function r_({clientThreadId:n,currentModelId:e,onRequestCompletion:t,enableV2Homepage:s}){const i=en(n),r=vy(),o=nc(),{data:a}=Ms(i),l=dh(),d=Ab(()=>navigator.windowControlsOverlay);return(r!=null||i!=null)&&a==null?null:c.jsxs("div",{className:"relative h-full",children:[c.jsx("div",{className:d!=null&&d.visible?K("absolute right-[calc(100dvw-env(titlebar-area-width,100dvw)-env(titlebar-area-x,0))]",l?"left-[env(titlebar-area-x,0)]":"left-0"):"absolute left-0 right-0",children:c.jsx(Nm,{clientThreadId:n})}),a!=null?c.jsx(jS,{gizmo:a,showStarterPrompts:!0,disableStarterPrompts:o}):c.jsx(n_,{clientThreadId:n,currentModelId:e,onRequestCompletion:t,enableV2Homepage:s})]})}const Ps=Ce({temporaryChat:{id:"GizmoLanding.temporaryChat",defaultMessage:"Temporary Chat"},temporaryChatBizMemoryAvailable:{id:"g1opBW",defaultMessage:"This chat won't appear in your history and won't use or create memories."},temporaryChatBizMemoryUnavailable:{id:"fQmbtG",defaultMessage:"This chat won't appear your conversation history."},temporaryChatDescriptionMemoryAvailable:{id:"GizmoLanding.temporaryChatDescriptionMemoryAvailable",defaultMessage:"This chat won't appear in history, use or create memories, or be used to train our models. For safety purposes, we may keep a copy for up to 30 days."},temporaryChatDescriptionMemoryUnavailable:{id:"GizmoLanding.temporaryChatDescriptionMemoryUnavailable",defaultMessage:"This chat won't appear in history or be used to train our models. For safety purposes, we may keep a copy of this chat for up to 30 days."},temporaryChatDescriptionGptActions:{id:"GizmoLanding.temporaryChatDescriptionGptActions",defaultMessage:"Any data shared with a third party through GPT actions are subject to the third party's privacy policy. <link>Learn more</link>"},howCanIHelpYouToday:{id:"GizmoLanding.howCanIHelpYouToday",defaultMessage:"How can I help you today?"}});function Em(n){const t=Mn(n)==="root",s=Pr(n),i=ks(s),{serviceStatus:r}=y.useContext(jb),o=Ii(),{isUnauthenticated:a}=Ht();return!t&&!i&&!(r!=null&&r.oof)&&!o.displayingSideBySideFeedback&&!a}const Im=({clientThreadId:n,message:e})=>{var w,C,k,v,T,A,L,_;const t=Lc(),s=Jl(),i=Fi(Li.ModelSwitcherAutoDowngrade),{categories:r}=Ar({isRegen:!0}),o=Yh({clientThreadId:n}),{doesUserHaveAnyAccountsWithPlusFeatures:a}=ti(),l=Jx()!=null,d=[];for(const N of r){if(Uh(N))continue;const{defaultModel:z,label:j,tagline:H,categoryId:Q,subscriptionLevel:B,subcategory:U}=N,O=(C=(w=o[z])==null?void 0:w.regenerate)==null?void 0:C[0];d.push({label:j,value:z,subtitle:H,icon:c.jsx(Fc,{className:"icon-md h-4 w-4",categoryId:Q,type:"filled"}),modelSwitcherDeny:O,subscriptionLevel:B,subcategory:U})}const u=o_(n,e.nodeId),h=(k=e.message.metadata)==null?void 0:k.model_slug,f=(v=t.find(N=>N.value===h))==null?void 0:v.name,m=h!=null?s[h]:void 0,p=(m==null?void 0:m.enabledTools)||[],g=a_(l,u,h),S=(T=e.message.metadata)==null?void 0:T.model_adjustments,x=a&&i.eligible&&!i.isLoading&&f&&((A=d[0])==null?void 0:A.label)&&f!==((L=d[0])==null?void 0:L.label)&&(S==null?void 0:S.some(N=>N.startsWith("auto:smaller_model")));return{modelOptions:d,modelSlug:h,messageModelEnabledTools:p,animateModelLabelOnRender:g,nuxProps:{shouldRenderNux:x,usedModelName:f,largestModelName:(_=d[0])==null?void 0:_.label,announcement:i}}};function o_(n,e){var o,a;return(a=(o=I.getTree(n).getConversationTurns(e).flatMap(l=>l.messages).filter(l=>l.message.author.role===Se.Assistant&&!Rb(l.message)).reverse()[1])==null?void 0:o.message.metadata)==null?void 0:a.model_slug}function a_(n,e,t){return n&&!e?!0:!!(e&&t!==e)}function l_(){const{doesUserHaveAnyAccountsWithPlusFeatures:n}=ti(),{categories:e}=Ar();return!!n||!!e.find(Uh)}const Si=({modelSwitcherDeny:n,value:e,label:t,subtitle:s,icon:i,onMouseEnter:r,onMouseLeave:o,onSelect:a,messageModelSlug:l,isHovered:d=!1,shouldShowUpsell:u=!1,className:h,includeCheck:f,includeRegenerate:m,justifyIcon:p,wrapIcon:g=!0})=>{const S=Nn(),x=!n,w=!x&&!u,C=Rr(),k=()=>{if(!u){a==null||a();return}$.logEvent(V.openModalAccountPaymentfromMessageModelPicker),$.logRateLimitGetPlusButtonClicked({type:ac.RATE_LIMIT,location:"message_model_switcher_dropdown",plan_type:(S==null?void 0:S.planType)??"unknown",is_hard_block:!1,hard_block_reason:"",is_new_conversation:!1}),Rl(C,"Message model switcher dropdown")};return c.jsx(ne.Item,{onSelect:k,onMouseEnter:()=>x&&(r==null?void 0:r()),onMouseLeave:()=>x&&(o==null?void 0:o()),disabled:w,className:h??"radix-disabled:pointer-events-auto radix-disabled:cursor-not-allowed radix-disabled:hover:bg-transparent",children:c.jsxs(vs,{label:n&&c.jsx(Fh,{modelSwitcherDeny:n}),className:"flex w-full items-center justify-between gap-2",sideOffset:0,children:[c.jsxs("div",{className:K("flex items-center gap-3",p==="right"&&"w-full"),children:[!!i&&(g?c.jsx("span",{className:K("flex h-7 w-7 items-center justify-center rounded-full bg-token-main-surface-secondary",p==="right"&&"order-10 ml-auto"),children:i}):i),c.jsxs("div",{children:[c.jsx("div",{children:t}),c.jsx("div",{className:K({"text-sm text-token-text-secondary":!w},{"text-sm text-token-text-quaternary":w}),children:s})]})]}),u?c.jsx(ft,{color:"secondary",size:"small",children:c.jsx(D,{id:"54fmrA",defaultMessage:"Get Plus"})}):c.jsx(c_,{messageModelSlug:l,isHovered:d,modelSwitcherDeny:n,optionModelSlug:e,includeCheck:f,includeRegenerate:m})]})})},c_=({modelSwitcherDeny:n,optionModelSlug:e,isHovered:t,messageModelSlug:s,includeRegenerate:i=!0,includeCheck:r=!0})=>{let o=null;if(n)switch(n.reason){case ac.RATE_LIMIT:o=XS;break;default:o=gr;break}if(n)return c.jsx(o,{className:"icon-md"});const a=!!i&&c.jsx(ta,{className:K("icon-md hidden text-token-text-tertiary",{"group-hover:block":t})});return s===e&&r?c.jsxs(c.Fragment,{children:[c.jsx(Df,{className:K("icon-md text-token-text-primary",{"group-hover:hidden":t})}),a]}):a};function d_({className:n,clientThreadId:e,message:t,onModelSelect:s,onDropdownChange:i}){var U;const r=ue(),[o,a]=y.useState(null),[l,d]=y.useState(!1),[u,h]=y.useState(!1),f=l_(),m=Em(e),p=en(e),g=Im({clientThreadId:e,message:t}),S=(U=t.message.metadata)==null?void 0:U.model_slug,{modelOptions:x,modelSlug:w,animateModelLabelOnRender:C,nuxProps:k,messageModelEnabledTools:v}=g,T=Wl(t.message),A=v.includes(fn.Search),L=y.useMemo(()=>x.find(O=>O.value==S),[x,S]),{doesUserHaveAnyAccountsWithPlusFeatures:_}=ti(),N=y.useRef(null),z=O=>{O||setTimeout(()=>{N.current&&N.current.blur()},10)};if(y.useEffect(()=>{z(l)},[l]),!f||p)return null;const j=[{key:"use-search",extraStreamParams:{forceUseSearch:!0},label:r.formatMessage(Du.search),icon:c.jsx(ea,{className:"icon-sm"}),condition:A&&!T},{key:"use-no-search",extraStreamParams:{forceUseSearch:!1},label:r.formatMessage(Du.nosearch),icon:c.jsx(Of,{className:"icon-sm"}),condition:A&&T}];let H,Q;k.shouldRenderNux?(H=h_,Q={title:c.jsx(D,{id:"g/+2Hh",defaultMessage:"Optimized your response"}),description:c.jsx(D,{id:"H0Flqm",defaultMessage:"Used {usedModelName} for a faster response that saves your limited {largestModelName} messages",values:{usedModelName:k.usedModelName,largestModelName:k.largestModelName}}),markAsViewed:k.announcement.markAsViewed}):(H=u_,Q={label:m?c.jsx(D,{id:"LBYK9a",defaultMessage:"Change model"}):c.jsx(D,{id:"nygjPN",defaultMessage:"Used {modelName}",values:{modelName:k.usedModelName}})});const B=m&&x.some(O=>Mr(O,_));return c.jsxs(ne.Root,{onOpenChange:O=>{m&&(d(O),i(O),z(O)),O&&$.logEvent(V.conversationOpenMessageModelSelector,{has_get_plus_button:B})},children:[c.jsx(H,{...Q,children:c.jsx(Lf,{ref:N,className:K("cursor-pointer",n),onMouseEnter:()=>h(!0),onMouseLeave:()=>h(!1),children:c.jsx(wl,{modelSlug:w,animateModelLabelOnRender:C,isDropdownOpen:l,isRegenerateEnabled:m,isHovered:u})})}),m&&c.jsxs(ne.Content,{className:"z-30 origin-top-right text-token-text-primary",side:"bottom",align:"start",children:[x.map(O=>{var J;const R=Mr(O,_),{value:M,...F}=O;return c.jsx(Si,{value:M,onSelect:()=>s({requestedModelId:M}),onMouseEnter:()=>a(M),onMouseLeave:()=>a(null),isHovered:o===M,messageModelSlug:(J=t.message.metadata)==null?void 0:J.model_slug,shouldShowUpsell:R,...F},M)}),!!L&&c.jsxs(c.Fragment,{children:[c.jsx(ne.Separator,{}),j.filter(O=>O.condition).map(O=>c.jsx(Si,{onSelect:()=>s({requestedModelId:L.value,extraStreamParams:O.extraStreamParams}),includeRegenerate:!0,onMouseEnter:()=>a(O.key),onMouseLeave:()=>a(null),isHovered:o===O.key,messageModelSlug:S,includeCheck:!1,...L,label:O.label,subtitle:"",icon:O.icon},O.key))]})]})]})}function wl({modelSlug:n,animateModelLabelOnRender:e,isDropdownOpen:t,isRegenerateEnabled:s,isHovered:i,isRegenLabel:r=!1,animateShortLabel:o,omitIcon:a}){const[l,d]=y.useState("initial"),{categories:u}=Ar({isRegen:!!r});y.useEffect(()=>{if(e){const x=setTimeout(()=>d("show"),500),w=setTimeout(()=>d("initial"),2e3);return()=>{clearTimeout(x),clearTimeout(w)}}d("initial")},[e]);const h=u.find(({defaultModel:x})=>x===n),f=n===Yx?{categoryId:"gpt_3.5",shorterLabel:"3.5"}:{},{categoryId:m,shorterLabel:p}=h??f,g={initial:{opacity:0,paddingLeft:0,width:"0"},show:{opacity:1,paddingLeft:2,width:"100%"},visible:{opacity:1,paddingLeft:2,width:"100%",transition:{delay:0,duration:0}}},S=t?"visible":i?"show":l;return c.jsxs(Oe.div,{initial:"initial",animate:S,className:"flex items-center pb-0",children:[!a&&(r?c.jsx(ta,{className:"icon-md"}):m&&c.jsx(Fc,{type:"outline",categoryId:m,className:"icon-md h-4 w-4"})),(s||o)&&c.jsx(Oe.span,{className:"overflow-hidden text-clip whitespace-nowrap text-sm",variants:g,transition:{type:"tween",duration:.18},children:p}),s&&c.jsx(Zo,{className:K("icon-sm",{"text-token-text-quaternary":!i&&!r},{"text-token-text-secondary":i&&!r})})]})}function u_({children:n,label:e}){return c.jsx(vs,{label:e,sideOffset:0,children:n})}function h_({children:n,title:e,description:t,markAsViewed:s}){return c.jsx(Wo,{show:!0,side:"bottom",sideOffset:-4,title:e,description:t,badge:"beta",onDismiss:s,dismissOnOutsideClick:!0,children:n})}function Mr(n,e){const{modelSwitcherDeny:t,subscriptionLevel:s}=n;return!!t&&t.reason===ac.RATE_LIMIT&&s===Db.PLUS&&!e}const Du=Ce({search:{id:"eTV6j1",defaultMessage:"Search the web"},nosearch:{id:"IvLzUk",defaultMessage:"Without web search"}}),f_=y.memo(d_),Ou=ji.IndepthFeedbackDismissedAt;function p_(){const[n,e]=y.useState(()=>{const s=localStorage.getItem(Ou);return s?m_(new Date(s)):!1}),t=y.useCallback(()=>{e(!0),localStorage.setItem(Ou,new Date().toISOString())},[]);return[n,t]}function m_(n){const e=new Date;return n.getFullYear()===e.getFullYear()&&n.getMonth()===e.getMonth()&&n.getDate()===e.getDate()}function g_({clientThreadId:n,conversationLeafId:e,trigger:t,variantIds:s}){const i=s.find(u=>u!==e),r=ei(u=>u.forceIndepthFeedback&&u.forceIndepthFeedbackPrompt),o=$e.getExperimentValue({experimentName:"4146182738",key:t==="paragen"?"enable_indepth_feedback_paragen":"enable_indepth_feedback_thumbsdown",defaultValue:!1,shouldLogExposure:!1}),a=$e.getExperimentValue({experimentName:"4146182738",key:t==="paragen"?"indepth_feedback_paragen_prompt":"indepth_feedback_thumbsdown_prompt",defaultValue:"",shouldLogExposure:!1}),l=i?I.getTree(n).getTextFromNode(i):"NONE";return(r||(o?a:"")).replace("{paragen_losing_response}",l)}function y_({clientThreadId:n,conversationLeafId:e,trigger:t,variantIds:s}){const[i,r]=p_(),o=b_({clientThreadId:n}),a=g_({clientThreadId:n,conversationLeafId:e,trigger:t,variantIds:s}),l=()=>{r(),$.logEventWithStatsig(V.messageIndepthFeedbackDeclined,"chatgpt_indepth_feedback_declined",{trigger:t})},d=()=>{const u=new Ss;o(e,{intent:"indepth_feedback"},a,u),$.logEventWithStatsig(V.messageIndepthFeedbackAccepted,"chatgpt_indepth_feedback_accepted",{trigger:t})};return i||!a?null:c.jsx(hh,{content:c.jsx(D,{...za.indepthFeedbackPrompt}),primaryCtaText:c.jsx(D,{...za.indepthFeedbackAcceptButton}),onPrimaryCtaClick:d,secondaryCtaText:c.jsx(D,{...za.indepthFeedbackRejectButton}),onSecondaryCtaClick:l})}function x_(n){const e=n.rating==="thumbsDown"?"thumbsDown":Lh(["original","new"],n.inlineComparisonRating)?"paragen":void 0,t=ei(i=>i.forceIndepthFeedback);if(!e||t||e==="paragen"||$e.getExperimentValue({experimentName:"4146182738",key:"enable_indepth_feedback_thumbsdown",defaultValue:!1,shouldLogExposure:!0}))return e}function b_({clientThreadId:n}){const e=y.useContext(ic),t=bt.getConversationMode(n);return(i,r,o,a)=>{e({type:Cn.Next,promptId:i,eventMetadata:r,focusOnNewCompletion:!0,cancelActiveRequests:!1,completionMetadata:{conversationMode:t},useDefaultModel:!1,appendMessages:[{id:Or(),author:{role:Se.System},content:{content_type:Zt.Text,parts:[o]},metadata:{is_indepth_feedback:!0,indepth_feedback_prompt:o}}],turnTracker:a})}}const za=Ce({indepthFeedbackPrompt:{id:"qEHwDx",defaultMessage:"Would you like to tell ChatGPT more about your feedback, so it can improve its responses?"},indepthFeedbackAcceptButton:{id:"IeyTQ7",defaultMessage:"Continue"},indepthFeedbackRejectButton:{id:"+o5xmp",defaultMessage:"Not now"},indepthFeedbackRejectAlwaysButton:{id:"Qdko+f",defaultMessage:"Don't ask again"}});function S_({clientThreadId:n,conversationMode:e}){const t=wm(n);return({id:i,eventMetadata:r,turnTracker:o,requestedModelId:a,systemMessage:l,juice:d,extraStreamParams:u})=>{const f=I.getTree(n).getConversationTurns(i),m=f==null?void 0:f[(f==null?void 0:f.length)-1].variantIds,p=(m==null?void 0:m.length)===1&&(u==null?void 0:u.forceUseSearch)===void 0,g=p?{...r,intent:"comparison_implicit"}:r;t({id:i,requestedModelId:a,eventMetadata:g,focusOnNewCompletion:!0,variantPurpose:p?"comparison_implicit":"none",conversationMode:e??bt.getConversationMode(n),useDefaultModel:!1,appendMessages:l?[{id:Or(),author:{role:Se.System},content:{content_type:Zt.Text,parts:[l]},metadata:{exclude_after_next_user_message:!0}}]:void 0,juice:d,turnTracker:o,extraStreamParams:u})}}function k_(n){var e,t;return((t=(e=n.message.metadata)==null?void 0:e.finish_details)==null?void 0:t.type)==="content_filter"}function Vi(n){if(n===void 0)return{flagSeverity:void 0,shouldHideContent:!1,errCode:void 0,errMessage:void 0};const{errType:e,errCode:t,err:s,disclaimers:i}=n,r=k_(n);return!(i&&i.length>0)&&r?{flagSeverity:"warning",shouldHideContent:!1,errCode:zt.ContentOrTos,errMessage:s}:{flagSeverity:e,shouldHideContent:e==="danger"&&(t===zt.ContentPolicy||t===zt.ModelIncompatibility),disclaimers:i,errCode:t,errMessage:s}}function Ur(n){return c.jsx(Fs,{flag:"danger",isUserTurn:!1,children:c.jsx(D,{...Pt.somethingWentWrong})})}function w_({message:n,onRequestMoreCompletions:e,clientThreadId:t,id:s,isFeedbackEnabled:i,isUserTurn:r,className:o}){const{errCode:a,errMessage:l,flagSeverity:d}=Vi(n);switch(a){case zt.ContentPolicy:return c.jsx(Fs,{flag:d,isUserTurn:r,className:o,children:c.jsx(M_,{isFeedbackEnabled:i})});case zt.ModelIncompatibility:return c.jsx(Fs,{flag:d,isUserTurn:r,className:o,children:c.jsx(D,{...Pt.modelIncompatibilityMessage})});case zt.ContentOrTos:return c.jsx(Fs,{flag:d,isUserTurn:r,className:o,children:c.jsx(v_,{isFeedbackEnabled:i})});case ko:return c.jsx(C_,{className:o,id:s,onRequestMoreCompletions:e,flag:d,clientThreadId:t,isUserTurn:r});case ff:return c.jsx(Fs,{flag:d,isUserTurn:r,className:o,children:c.jsx(D,{...Pt.historyDisabledConversationMissing})});default:return l!==void 0?c.jsx(Fs,{flag:d,isUserTurn:r,className:o,children:c.jsx(My,{rehypePlugins:[[Ty,{target:"_new",rel:"noopener noreferrer"}]],className:"markdown prose w-full break-words dark:prose-invert",children:l})}):null}}function C_({className:n,id:e,onRequestMoreCompletions:t,flag:s,clientThreadId:i,isUserTurn:r}){const o=Ph(g=>g.isoDate),a=_y(o),l=Ts(i??Xa),d=l&&l.kind!==De.PrimaryAssistant,u=Kh(),h=Yl(),f=y.useCallback(()=>{const g=new Ss;t(e,{eventSource:"mouse"},g,!0,"none",!1)},[e,t]),m=y.useCallback(()=>{const g=new Ss,S=h.id;u({modelId:S,location:"Model switcher menu item"}),t(e,{eventSource:"mouse"},g,!0,"none",!0)},[t,e,h.id,u]);let p;return d?p=o!=null?c.jsx("span",{children:c.jsx(D,{...Pt.gptUsageCapExceededCustomFeature,values:{link:Pu,formattedTime:a}})}):c.jsx(D,{...Pt.gptUsageCapExceededExpired}):p=o!=null?c.jsx("span",{children:c.jsx(D,{...Pt.gptUsageCapExceeded,values:{link:Pu,formattedTime:a}})}):c.jsx(D,{...Pt.gptUsageCapExceededExpired}),c.jsx(Fs,{flag:o!=null?s:void 0,isUserTurn:r,className:n,children:c.jsxs("div",{className:"flex items-center gap-6",children:[p,o==null&&c.jsx(ft,{color:"secondary",className:"flex-shrink-0",onClick:f,children:c.jsx(D,{...Pt.buttonTryAgain})}),o!=null&&!d&&c.jsx(ft,{color:"secondary",className:"flex-shrink-0",onClick:m,children:c.jsx(D,{...Pt.buttonUseDefaultModel})})]})})}const Pu=n=>c.jsx("a",{href:"https://share.hsforms.com/16d0ZZVM3QZirXnCD_q7u1Q4sk30",target:"_blank",rel:"noreferrer",className:"underline",children:n});function v_({isFeedbackEnabled:n}){return c.jsxs(c.Fragment,{children:[c.jsx("div",{className:n?"font-semibold":"",children:c.jsx(D,{...Pt.contentOrTosViolationNoFeedback,values:{contentPolicyLink:Am,termsLink:T_}})}),c.jsx("div",{children:n&&c.jsx(D,{...Pt.contentPolicyFeedback})})]})}function M_({isFeedbackEnabled:n}){return c.jsxs(c.Fragment,{children:[c.jsx("div",{className:n?"font-semibold":"",children:c.jsx(D,{...Pt.contentPolicyViolationNoFeedback,values:{contentPolicyLink:Am}})}),c.jsx("div",{children:n&&c.jsx(D,{...Pt.contentPolicyFeedback})})]})}const Am=n=>c.jsx(Vh,{target:"_blank",href:"https://openai.com/policies/usage-policies",rel:"noreferrer",children:n}),T_=n=>c.jsx(Vh,{target:"_blank",href:"https://openai.com/policies/terms-of-use",rel:"noreferrer",children:n}),Pt=Ce({contentPolicyFeedback:{id:"TextMessageDisplay.contentPolicyFeedback",defaultMessage:"Did we get it wrong? Please tell us by giving this response a thumbs down."},contentPolicyViolation:{id:"TextMessageDisplay.contentPolicyViolation.2",defaultMessage:"This content may violate our <contentPolicyLink>usage policies</contentPolicyLink>. Did we get it wrong? Please tell us by giving this response a thumbs down."},contentPolicyViolationNoFeedback:{id:"TextMessageDisplay.contentPolicyViolationNoFeedback",defaultMessage:"This content may violate our <contentPolicyLink>usage policies</contentPolicyLink>."},modelIncompatibilityMessage:{id:"cyOWhN",defaultMessage:"Your request was flagged as potentially violating our usage policy. Please try again with a different prompt."},contentOrTosViolation:{id:"TextMessageDisplay.contentOrTosViolation.2",defaultMessage:"This content may violate our <termsLink>Terms of Use</termsLink> or <contentPolicyLink>usage policies</contentPolicyLink>. Did we get it wrong? Please tell us by giving this response a thumbs down."},contentOrTosViolationNoFeedback:{id:"TextMessageDisplay.contentOrTosViolationNoFeedback",defaultMessage:"This content may violate our <termsLink>Terms of Use</termsLink> or <contentPolicyLink>usage policies</contentPolicyLink>."},historyDisabledConversationMissing:{id:"TextMessageDisplay.historyDisabledConversationMissing",defaultMessage:"Sorry, conversations created when Chat History is off expire after 6 hours of inactivity. Please start a new conversation to continue using ChatGPT."},somethingWentWrong:{id:"TextMessageDisplay.somethingWentWrong",defaultMessage:"Something went wrong."},gptUsageCapExceeded:{id:"TextMessageDisplay.gptUsageCapExceeded",defaultMessage:"You've reached the current usage cap for GPT-4. You can continue with the default model now, or try again {formattedTime}. <link>Learn more</link>"},gptUsageCapExceededCustomFeature:{id:"TextMessageDisplay.gptUsageCapExceededCustomFeature",defaultMessage:"You've reached the current usage cap for GPT-4, please try again {formattedTime}. <link>Learn more</link>"},gptUsageCapExceededExpired:{id:"TextMessageDisplay.gptUsageCapExceededExpired",defaultMessage:"You previously reached your usage cap for GPT-4, but you can now try sending your message again"},buttonUseDefaultModel:{id:"TextMessageDisplay.buttonUseDefaultModel",defaultMessage:"Use default model"},buttonTryAgain:{id:"TextMessageDisplay.buttonTryAgain",defaultMessage:"Try again"}}),mi=typeof performance=="object"&&performance&&typeof performance.now=="function"?performance:Date,jm=new Set,Cl=typeof process=="object"&&process?process:{},Rm=(n,e,t,s)=>{typeof Cl.emitWarning=="function"?Cl.emitWarning(n,e,t,s):console.error(`[${t}] ${e}: ${n}`)};let Bo=globalThis.AbortController,Fu=globalThis.AbortSignal;var ih;if(typeof Bo>"u"){Fu=class{constructor(){X(this,"onabort");X(this,"_onabort",[]);X(this,"reason");X(this,"aborted",!1)}addEventListener(s,i){this._onabort.push(i)}},Bo=class{constructor(){X(this,"signal",new Fu);e()}abort(s){var i,r;if(!this.signal.aborted){this.signal.reason=s,this.signal.aborted=!0;for(const o of this.signal._onabort)o(s);(r=(i=this.signal).onabort)==null||r.call(i,s)}}};let n=((ih=Cl.env)==null?void 0:ih.LRU_CACHE_IGNORE_AC_WARNING)!=="1";const e=()=>{n&&(n=!1,Rm("AbortController is not defined. If using lru-cache in node 14, load an AbortController polyfill from the `node-abort-controller` package. A minimal polyfill is provided for use by LRUCache.fetch(), but it should not be relied upon in other contexts (eg, passing it to other APIs that use AbortController/AbortSignal might have undesirable effects). You may disable this with LRU_CACHE_IGNORE_AC_WARNING=1 in the env.","NO_ABORT_CONTROLLER","ENOTSUP",e))}}const __=n=>!jm.has(n),ss=n=>n&&n===Math.floor(n)&&n>0&&isFinite(n),Dm=n=>ss(n)?n<=Math.pow(2,8)?Uint8Array:n<=Math.pow(2,16)?Uint16Array:n<=Math.pow(2,32)?Uint32Array:n<=Number.MAX_SAFE_INTEGER?mo:null:null;class mo extends Array{constructor(e){super(e),this.fill(0)}}var Ti;const Bs=class Bs{constructor(e,t){X(this,"heap");X(this,"length");if(!b(Bs,Ti))throw new TypeError("instantiate Stack using Stack.create(n)");this.heap=new t(e),this.length=0}static create(e){const t=Dm(e);if(!t)return[];ee(Bs,Ti,!0);const s=new Bs(e,t);return ee(Bs,Ti,!1),s}push(e){this.heap[this.length++]=e}pop(){return this.heap[--this.length]}};Ti=new WeakMap,ge(Bs,Ti,!1);let vl=Bs;var rh,oh,nn,jt,sn,rn,_i,Xe,on,He,Ne,re,gt,Rt,ct,tt,an,nt,ln,cn,Dt,dn,ds,yt,W,Tl,Ws,Hn,Tr,Ot,Om,Hs,Ni,_r,is,rs,_l,go,yo,_e,Nl,nr;const Vc=class Vc{constructor(e){ge(this,W);ge(this,nn);ge(this,jt);ge(this,sn);ge(this,rn);ge(this,_i);X(this,"ttl");X(this,"ttlResolution");X(this,"ttlAutopurge");X(this,"updateAgeOnGet");X(this,"updateAgeOnHas");X(this,"allowStale");X(this,"noDisposeOnSet");X(this,"noUpdateTTL");X(this,"maxEntrySize");X(this,"sizeCalculation");X(this,"noDeleteOnFetchRejection");X(this,"noDeleteOnStaleGet");X(this,"allowStaleOnFetchAbort");X(this,"allowStaleOnFetchRejection");X(this,"ignoreFetchAbort");ge(this,Xe);ge(this,on);ge(this,He);ge(this,Ne);ge(this,re);ge(this,gt);ge(this,Rt);ge(this,ct);ge(this,tt);ge(this,an);ge(this,nt);ge(this,ln);ge(this,cn);ge(this,Dt);ge(this,dn);ge(this,ds);ge(this,yt);ge(this,Ws,()=>{});ge(this,Hn,()=>{});ge(this,Tr,()=>{});ge(this,Ot,()=>!1);ge(this,Hs,e=>{});ge(this,Ni,(e,t,s)=>{});ge(this,_r,(e,t,s,i)=>{if(s||i)throw new TypeError("cannot set size without setting maxSize or maxEntrySize on cache");return 0});X(this,rh,"LRUCache");const{max:t=0,ttl:s,ttlResolution:i=1,ttlAutopurge:r,updateAgeOnGet:o,updateAgeOnHas:a,allowStale:l,dispose:d,disposeAfter:u,noDisposeOnSet:h,noUpdateTTL:f,maxSize:m=0,maxEntrySize:p=0,sizeCalculation:g,fetchMethod:S,noDeleteOnFetchRejection:x,noDeleteOnStaleGet:w,allowStaleOnFetchRejection:C,allowStaleOnFetchAbort:k,ignoreFetchAbort:v}=e;if(t!==0&&!ss(t))throw new TypeError("max option must be a nonnegative integer");const T=t?Dm(t):Array;if(!T)throw new Error("invalid max value: "+t);if(ee(this,nn,t),ee(this,jt,m),this.maxEntrySize=p||b(this,jt),this.sizeCalculation=g,this.sizeCalculation){if(!b(this,jt)&&!this.maxEntrySize)throw new TypeError("cannot set sizeCalculation without setting maxSize or maxEntrySize");if(typeof this.sizeCalculation!="function")throw new TypeError("sizeCalculation set to non-function")}if(S!==void 0&&typeof S!="function")throw new TypeError("fetchMethod must be a function if specified");if(ee(this,_i,S),ee(this,ds,!!S),ee(this,He,new Map),ee(this,Ne,new Array(t).fill(void 0)),ee(this,re,new Array(t).fill(void 0)),ee(this,gt,new T(t)),ee(this,Rt,new T(t)),ee(this,ct,0),ee(this,tt,0),ee(this,an,vl.create(t)),ee(this,Xe,0),ee(this,on,0),typeof d=="function"&&ee(this,sn,d),typeof u=="function"?(ee(this,rn,u),ee(this,nt,[])):(ee(this,rn,void 0),ee(this,nt,void 0)),ee(this,dn,!!b(this,sn)),ee(this,yt,!!b(this,rn)),this.noDisposeOnSet=!!h,this.noUpdateTTL=!!f,this.noDeleteOnFetchRejection=!!x,this.allowStaleOnFetchRejection=!!C,this.allowStaleOnFetchAbort=!!k,this.ignoreFetchAbort=!!v,this.maxEntrySize!==0){if(b(this,jt)!==0&&!ss(b(this,jt)))throw new TypeError("maxSize must be a positive integer if specified");if(!ss(this.maxEntrySize))throw new TypeError("maxEntrySize must be a positive integer if specified");Y(this,W,Om).call(this)}if(this.allowStale=!!l,this.noDeleteOnStaleGet=!!w,this.updateAgeOnGet=!!o,this.updateAgeOnHas=!!a,this.ttlResolution=ss(i)||i===0?i:1,this.ttlAutopurge=!!r,this.ttl=s||0,this.ttl){if(!ss(this.ttl))throw new TypeError("ttl must be a positive integer if specified");Y(this,W,Tl).call(this)}if(b(this,nn)===0&&this.ttl===0&&b(this,jt)===0)throw new TypeError("At least one of max, maxSize, or ttl is required");if(!this.ttlAutopurge&&!b(this,nn)&&!b(this,jt)){const A="LRU_CACHE_UNBOUNDED";__(A)&&(jm.add(A),Rm("TTL caching without ttlAutopurge, max, or maxSize can result in unbounded memory consumption.","UnboundedCacheWarning",A,Vc))}}static unsafeExposeInternals(e){return{starts:b(e,cn),ttls:b(e,Dt),sizes:b(e,ln),keyMap:b(e,He),keyList:b(e,Ne),valList:b(e,re),next:b(e,gt),prev:b(e,Rt),get head(){return b(e,ct)},get tail(){return b(e,tt)},free:b(e,an),isBackgroundFetch:t=>{var s;return Y(s=e,W,_e).call(s,t)},backgroundFetch:(t,s,i,r)=>{var o;return Y(o=e,W,yo).call(o,t,s,i,r)},moveToTail:t=>{var s;return Y(s=e,W,nr).call(s,t)},indexes:t=>{var s;return Y(s=e,W,is).call(s,t)},rindexes:t=>{var s;return Y(s=e,W,rs).call(s,t)},isStale:t=>{var s;return b(s=e,Ot).call(s,t)}}}get max(){return b(this,nn)}get maxSize(){return b(this,jt)}get calculatedSize(){return b(this,on)}get size(){return b(this,Xe)}get fetchMethod(){return b(this,_i)}get dispose(){return b(this,sn)}get disposeAfter(){return b(this,rn)}getRemainingTTL(e){return b(this,He).has(e)?1/0:0}*entries(){for(const e of Y(this,W,is).call(this))b(this,re)[e]!==void 0&&b(this,Ne)[e]!==void 0&&!Y(this,W,_e).call(this,b(this,re)[e])&&(yield[b(this,Ne)[e],b(this,re)[e]])}*rentries(){for(const e of Y(this,W,rs).call(this))b(this,re)[e]!==void 0&&b(this,Ne)[e]!==void 0&&!Y(this,W,_e).call(this,b(this,re)[e])&&(yield[b(this,Ne)[e],b(this,re)[e]])}*keys(){for(const e of Y(this,W,is).call(this)){const t=b(this,Ne)[e];t!==void 0&&!Y(this,W,_e).call(this,b(this,re)[e])&&(yield t)}}*rkeys(){for(const e of Y(this,W,rs).call(this)){const t=b(this,Ne)[e];t!==void 0&&!Y(this,W,_e).call(this,b(this,re)[e])&&(yield t)}}*values(){for(const e of Y(this,W,is).call(this))b(this,re)[e]!==void 0&&!Y(this,W,_e).call(this,b(this,re)[e])&&(yield b(this,re)[e])}*rvalues(){for(const e of Y(this,W,rs).call(this))b(this,re)[e]!==void 0&&!Y(this,W,_e).call(this,b(this,re)[e])&&(yield b(this,re)[e])}[(oh=Symbol.iterator,rh=Symbol.toStringTag,oh)](){return this.entries()}find(e,t={}){for(const s of Y(this,W,is).call(this)){const i=b(this,re)[s],r=Y(this,W,_e).call(this,i)?i.__staleWhileFetching:i;if(r!==void 0&&e(r,b(this,Ne)[s],this))return this.get(b(this,Ne)[s],t)}}forEach(e,t=this){for(const s of Y(this,W,is).call(this)){const i=b(this,re)[s],r=Y(this,W,_e).call(this,i)?i.__staleWhileFetching:i;r!==void 0&&e.call(t,r,b(this,Ne)[s],this)}}rforEach(e,t=this){for(const s of Y(this,W,rs).call(this)){const i=b(this,re)[s],r=Y(this,W,_e).call(this,i)?i.__staleWhileFetching:i;r!==void 0&&e.call(t,r,b(this,Ne)[s],this)}}purgeStale(){let e=!1;for(const t of Y(this,W,rs).call(this,{allowStale:!0}))b(this,Ot).call(this,t)&&(this.delete(b(this,Ne)[t]),e=!0);return e}info(e){const t=b(this,He).get(e);if(t===void 0)return;const s=b(this,re)[t],i=Y(this,W,_e).call(this,s)?s.__staleWhileFetching:s;if(i===void 0)return;const r={value:i};if(b(this,Dt)&&b(this,cn)){const o=b(this,Dt)[t],a=b(this,cn)[t];if(o&&a){const l=o-(mi.now()-a);r.ttl=l,r.start=Date.now()}}return b(this,ln)&&(r.size=b(this,ln)[t]),r}dump(){const e=[];for(const t of Y(this,W,is).call(this,{allowStale:!0})){const s=b(this,Ne)[t],i=b(this,re)[t],r=Y(this,W,_e).call(this,i)?i.__staleWhileFetching:i;if(r===void 0||s===void 0)continue;const o={value:r};if(b(this,Dt)&&b(this,cn)){o.ttl=b(this,Dt)[t];const a=mi.now()-b(this,cn)[t];o.start=Math.floor(Date.now()-a)}b(this,ln)&&(o.size=b(this,ln)[t]),e.unshift([s,o])}return e}load(e){this.clear();for(const[t,s]of e){if(s.start){const i=Date.now()-s.start;s.start=mi.now()-i}this.set(t,s.value,s)}}set(e,t,s={}){var f,m,p,g,S;if(t===void 0)return this.delete(e),this;const{ttl:i=this.ttl,start:r,noDisposeOnSet:o=this.noDisposeOnSet,sizeCalculation:a=this.sizeCalculation,status:l}=s;let{noUpdateTTL:d=this.noUpdateTTL}=s;const u=b(this,_r).call(this,e,t,s.size||0,a);if(this.maxEntrySize&&u>this.maxEntrySize)return l&&(l.set="miss",l.maxEntrySizeExceeded=!0),this.delete(e),this;let h=b(this,Xe)===0?void 0:b(this,He).get(e);if(h===void 0)h=b(this,Xe)===0?b(this,tt):b(this,an).length!==0?b(this,an).pop():b(this,Xe)===b(this,nn)?Y(this,W,go).call(this,!1):b(this,Xe),b(this,Ne)[h]=e,b(this,re)[h]=t,b(this,He).set(e,h),b(this,gt)[b(this,tt)]=h,b(this,Rt)[h]=b(this,tt),ee(this,tt,h),Hr(this,Xe)._++,b(this,Ni).call(this,h,u,l),l&&(l.set="add"),d=!1;else{Y(this,W,nr).call(this,h);const x=b(this,re)[h];if(t!==x){if(b(this,ds)&&Y(this,W,_e).call(this,x)){x.__abortController.abort(new Error("replaced"));const{__staleWhileFetching:w}=x;w!==void 0&&!o&&(b(this,dn)&&((f=b(this,sn))==null||f.call(this,w,e,"set")),b(this,yt)&&((m=b(this,nt))==null||m.push([w,e,"set"])))}else o||(b(this,dn)&&((p=b(this,sn))==null||p.call(this,x,e,"set")),b(this,yt)&&((g=b(this,nt))==null||g.push([x,e,"set"])));if(b(this,Hs).call(this,h),b(this,Ni).call(this,h,u,l),b(this,re)[h]=t,l){l.set="replace";const w=x&&Y(this,W,_e).call(this,x)?x.__staleWhileFetching:x;w!==void 0&&(l.oldValue=w)}}else l&&(l.set="update")}if(i!==0&&!b(this,Dt)&&Y(this,W,Tl).call(this),b(this,Dt)&&(d||b(this,Tr).call(this,h,i,r),l&&b(this,Hn).call(this,l,h)),!o&&b(this,yt)&&b(this,nt)){const x=b(this,nt);let w;for(;w=x==null?void 0:x.shift();)(S=b(this,rn))==null||S.call(this,...w)}return this}pop(){var e;try{for(;b(this,Xe);){const t=b(this,re)[b(this,ct)];if(Y(this,W,go).call(this,!0),Y(this,W,_e).call(this,t)){if(t.__staleWhileFetching)return t.__staleWhileFetching}else if(t!==void 0)return t}}finally{if(b(this,yt)&&b(this,nt)){const t=b(this,nt);let s;for(;s=t==null?void 0:t.shift();)(e=b(this,rn))==null||e.call(this,...s)}}}has(e,t={}){const{updateAgeOnHas:s=this.updateAgeOnHas,status:i}=t,r=b(this,He).get(e);if(r!==void 0){const o=b(this,re)[r];if(Y(this,W,_e).call(this,o)&&o.__staleWhileFetching===void 0)return!1;if(b(this,Ot).call(this,r))i&&(i.has="stale",b(this,Hn).call(this,i,r));else return s&&b(this,Ws).call(this,r),i&&(i.has="hit",b(this,Hn).call(this,i,r)),!0}else i&&(i.has="miss");return!1}peek(e,t={}){const{allowStale:s=this.allowStale}=t,i=b(this,He).get(e);if(i===void 0||!s&&b(this,Ot).call(this,i))return;const r=b(this,re)[i];return Y(this,W,_e).call(this,r)?r.__staleWhileFetching:r}async fetch(e,t={}){const{allowStale:s=this.allowStale,updateAgeOnGet:i=this.updateAgeOnGet,noDeleteOnStaleGet:r=this.noDeleteOnStaleGet,ttl:o=this.ttl,noDisposeOnSet:a=this.noDisposeOnSet,size:l=0,sizeCalculation:d=this.sizeCalculation,noUpdateTTL:u=this.noUpdateTTL,noDeleteOnFetchRejection:h=this.noDeleteOnFetchRejection,allowStaleOnFetchRejection:f=this.allowStaleOnFetchRejection,ignoreFetchAbort:m=this.ignoreFetchAbort,allowStaleOnFetchAbort:p=this.allowStaleOnFetchAbort,context:g,forceRefresh:S=!1,status:x,signal:w}=t;if(!b(this,ds))return x&&(x.fetch="get"),this.get(e,{allowStale:s,updateAgeOnGet:i,noDeleteOnStaleGet:r,status:x});const C={allowStale:s,updateAgeOnGet:i,noDeleteOnStaleGet:r,ttl:o,noDisposeOnSet:a,size:l,sizeCalculation:d,noUpdateTTL:u,noDeleteOnFetchRejection:h,allowStaleOnFetchRejection:f,allowStaleOnFetchAbort:p,ignoreFetchAbort:m,status:x,signal:w};let k=b(this,He).get(e);if(k===void 0){x&&(x.fetch="miss");const v=Y(this,W,yo).call(this,e,k,C,g);return v.__returned=v}else{const v=b(this,re)[k];if(Y(this,W,_e).call(this,v)){const N=s&&v.__staleWhileFetching!==void 0;return x&&(x.fetch="inflight",N&&(x.returnedStale=!0)),N?v.__staleWhileFetching:v.__returned=v}const T=b(this,Ot).call(this,k);if(!S&&!T)return x&&(x.fetch="hit"),Y(this,W,nr).call(this,k),i&&b(this,Ws).call(this,k),x&&b(this,Hn).call(this,x,k),v;const A=Y(this,W,yo).call(this,e,k,C,g),_=A.__staleWhileFetching!==void 0&&s;return x&&(x.fetch=T?"stale":"refresh",_&&T&&(x.returnedStale=!0)),_?A.__staleWhileFetching:A.__returned=A}}get(e,t={}){const{allowStale:s=this.allowStale,updateAgeOnGet:i=this.updateAgeOnGet,noDeleteOnStaleGet:r=this.noDeleteOnStaleGet,status:o}=t,a=b(this,He).get(e);if(a!==void 0){const l=b(this,re)[a],d=Y(this,W,_e).call(this,l);return o&&b(this,Hn).call(this,o,a),b(this,Ot).call(this,a)?(o&&(o.get="stale"),d?(o&&s&&l.__staleWhileFetching!==void 0&&(o.returnedStale=!0),s?l.__staleWhileFetching:void 0):(r||this.delete(e),o&&s&&(o.returnedStale=!0),s?l:void 0)):(o&&(o.get="hit"),d?l.__staleWhileFetching:(Y(this,W,nr).call(this,a),i&&b(this,Ws).call(this,a),l))}else o&&(o.get="miss")}delete(e){var s,i,r,o;let t=!1;if(b(this,Xe)!==0){const a=b(this,He).get(e);if(a!==void 0)if(t=!0,b(this,Xe)===1)this.clear();else{b(this,Hs).call(this,a);const l=b(this,re)[a];if(Y(this,W,_e).call(this,l)?l.__abortController.abort(new Error("deleted")):(b(this,dn)||b(this,yt))&&(b(this,dn)&&((s=b(this,sn))==null||s.call(this,l,e,"delete")),b(this,yt)&&((i=b(this,nt))==null||i.push([l,e,"delete"]))),b(this,He).delete(e),b(this,Ne)[a]=void 0,b(this,re)[a]=void 0,a===b(this,tt))ee(this,tt,b(this,Rt)[a]);else if(a===b(this,ct))ee(this,ct,b(this,gt)[a]);else{const d=b(this,Rt)[a];b(this,gt)[d]=b(this,gt)[a];const u=b(this,gt)[a];b(this,Rt)[u]=b(this,Rt)[a]}Hr(this,Xe)._--,b(this,an).push(a)}}if(b(this,yt)&&((r=b(this,nt))!=null&&r.length)){const a=b(this,nt);let l;for(;l=a==null?void 0:a.shift();)(o=b(this,rn))==null||o.call(this,...l)}return t}clear(){var e,t,s;for(const i of Y(this,W,rs).call(this,{allowStale:!0})){const r=b(this,re)[i];if(Y(this,W,_e).call(this,r))r.__abortController.abort(new Error("deleted"));else{const o=b(this,Ne)[i];b(this,dn)&&((e=b(this,sn))==null||e.call(this,r,o,"delete")),b(this,yt)&&((t=b(this,nt))==null||t.push([r,o,"delete"]))}}if(b(this,He).clear(),b(this,re).fill(void 0),b(this,Ne).fill(void 0),b(this,Dt)&&b(this,cn)&&(b(this,Dt).fill(0),b(this,cn).fill(0)),b(this,ln)&&b(this,ln).fill(0),ee(this,ct,0),ee(this,tt,0),b(this,an).length=0,ee(this,on,0),ee(this,Xe,0),b(this,yt)&&b(this,nt)){const i=b(this,nt);let r;for(;r=i==null?void 0:i.shift();)(s=b(this,rn))==null||s.call(this,...r)}}};nn=new WeakMap,jt=new WeakMap,sn=new WeakMap,rn=new WeakMap,_i=new WeakMap,Xe=new WeakMap,on=new WeakMap,He=new WeakMap,Ne=new WeakMap,re=new WeakMap,gt=new WeakMap,Rt=new WeakMap,ct=new WeakMap,tt=new WeakMap,an=new WeakMap,nt=new WeakMap,ln=new WeakMap,cn=new WeakMap,Dt=new WeakMap,dn=new WeakMap,ds=new WeakMap,yt=new WeakMap,W=new WeakSet,Tl=function(){const e=new mo(b(this,nn)),t=new mo(b(this,nn));ee(this,Dt,e),ee(this,cn,t),ee(this,Tr,(r,o,a=mi.now())=>{if(t[r]=o!==0?a:0,e[r]=o,o!==0&&this.ttlAutopurge){const l=setTimeout(()=>{b(this,Ot).call(this,r)&&this.delete(b(this,Ne)[r])},o+1);l.unref&&l.unref()}}),ee(this,Ws,r=>{t[r]=e[r]!==0?mi.now():0}),ee(this,Hn,(r,o)=>{if(e[o]){const a=e[o],l=t[o];if(!a||!l)return;r.ttl=a,r.start=l,r.now=s||i();const d=r.now-l;r.remainingTTL=a-d}});let s=0;const i=()=>{const r=mi.now();if(this.ttlResolution>0){s=r;const o=setTimeout(()=>s=0,this.ttlResolution);o.unref&&o.unref()}return r};this.getRemainingTTL=r=>{const o=b(this,He).get(r);if(o===void 0)return 0;const a=e[o],l=t[o];if(!a||!l)return 1/0;const d=(s||i())-l;return a-d},ee(this,Ot,r=>{const o=t[r],a=e[r];return!!a&&!!o&&(s||i())-o>a})},Ws=new WeakMap,Hn=new WeakMap,Tr=new WeakMap,Ot=new WeakMap,Om=function(){const e=new mo(b(this,nn));ee(this,on,0),ee(this,ln,e),ee(this,Hs,t=>{ee(this,on,b(this,on)-e[t]),e[t]=0}),ee(this,_r,(t,s,i,r)=>{if(Y(this,W,_e).call(this,s))return 0;if(!ss(i))if(r){if(typeof r!="function")throw new TypeError("sizeCalculation must be a function");if(i=r(s,t),!ss(i))throw new TypeError("sizeCalculation return invalid (expect positive integer)")}else throw new TypeError("invalid size value (must be positive integer). When maxSize or maxEntrySize is used, sizeCalculation or size must be set.");return i}),ee(this,Ni,(t,s,i)=>{if(e[t]=s,b(this,jt)){const r=b(this,jt)-e[t];for(;b(this,on)>r;)Y(this,W,go).call(this,!0)}ee(this,on,b(this,on)+e[t]),i&&(i.entrySize=s,i.totalCalculatedSize=b(this,on))})},Hs=new WeakMap,Ni=new WeakMap,_r=new WeakMap,is=function*({allowStale:e=this.allowStale}={}){if(b(this,Xe))for(let t=b(this,tt);!(!Y(this,W,_l).call(this,t)||((e||!b(this,Ot).call(this,t))&&(yield t),t===b(this,ct)));)t=b(this,Rt)[t]},rs=function*({allowStale:e=this.allowStale}={}){if(b(this,Xe))for(let t=b(this,ct);!(!Y(this,W,_l).call(this,t)||((e||!b(this,Ot).call(this,t))&&(yield t),t===b(this,tt)));)t=b(this,gt)[t]},_l=function(e){return e!==void 0&&b(this,He).get(b(this,Ne)[e])===e},go=function(e){var r,o;const t=b(this,ct),s=b(this,Ne)[t],i=b(this,re)[t];return b(this,ds)&&Y(this,W,_e).call(this,i)?i.__abortController.abort(new Error("evicted")):(b(this,dn)||b(this,yt))&&(b(this,dn)&&((r=b(this,sn))==null||r.call(this,i,s,"evict")),b(this,yt)&&((o=b(this,nt))==null||o.push([i,s,"evict"]))),b(this,Hs).call(this,t),e&&(b(this,Ne)[t]=void 0,b(this,re)[t]=void 0,b(this,an).push(t)),b(this,Xe)===1?(ee(this,ct,ee(this,tt,0)),b(this,an).length=0):ee(this,ct,b(this,gt)[t]),b(this,He).delete(s),Hr(this,Xe)._--,t},yo=function(e,t,s,i){const r=t===void 0?void 0:b(this,re)[t];if(Y(this,W,_e).call(this,r))return r;const o=new Bo,{signal:a}=s;a==null||a.addEventListener("abort",()=>o.abort(a.reason),{signal:o.signal});const l={signal:o.signal,options:s,context:i},d=(g,S=!1)=>{const{aborted:x}=o.signal,w=s.ignoreFetchAbort&&g!==void 0;if(s.status&&(x&&!S?(s.status.fetchAborted=!0,s.status.fetchError=o.signal.reason,w&&(s.status.fetchAbortIgnored=!0)):s.status.fetchResolved=!0),x&&!w&&!S)return h(o.signal.reason);const C=m;return b(this,re)[t]===m&&(g===void 0?C.__staleWhileFetching?b(this,re)[t]=C.__staleWhileFetching:this.delete(e):(s.status&&(s.status.fetchUpdated=!0),this.set(e,g,l.options))),g},u=g=>(s.status&&(s.status.fetchRejected=!0,s.status.fetchError=g),h(g)),h=g=>{const{aborted:S}=o.signal,x=S&&s.allowStaleOnFetchAbort,w=x||s.allowStaleOnFetchRejection,C=w||s.noDeleteOnFetchRejection,k=m;if(b(this,re)[t]===m&&(!C||k.__staleWhileFetching===void 0?this.delete(e):x||(b(this,re)[t]=k.__staleWhileFetching)),w)return s.status&&k.__staleWhileFetching!==void 0&&(s.status.returnedStale=!0),k.__staleWhileFetching;if(k.__returned===k)throw g},f=(g,S)=>{var w;const x=(w=b(this,_i))==null?void 0:w.call(this,e,r,l);x&&x instanceof Promise&&x.then(C=>g(C===void 0?void 0:C),S),o.signal.addEventListener("abort",()=>{(!s.ignoreFetchAbort||s.allowStaleOnFetchAbort)&&(g(void 0),s.allowStaleOnFetchAbort&&(g=C=>d(C,!0)))})};s.status&&(s.status.fetchDispatched=!0);const m=new Promise(f).then(d,u),p=Object.assign(m,{__abortController:o,__staleWhileFetching:r,__returned:void 0});return t===void 0?(this.set(e,p,{...l.options,status:void 0}),t=b(this,He).get(e)):b(this,re)[t]=p,p},_e=function(e){if(!b(this,ds))return!1;const t=e;return!!t&&t instanceof Promise&&t.hasOwnProperty("__staleWhileFetching")&&t.__abortController instanceof Bo},Nl=function(e,t){b(this,Rt)[t]=e,b(this,gt)[e]=t},nr=function(e){e!==b(this,tt)&&(e===b(this,ct)?ee(this,ct,b(this,gt)[e]):Y(this,W,Nl).call(this,b(this,Rt)[e],b(this,gt)[e]),Y(this,W,Nl).call(this,b(this,tt),e),ee(this,tt,e))};let Ml=Vc;function N_({conversationId:n,messageId:e}){const[t,s]=y.useState(!1),i=y.useRef({isMediaSourceAvailable:Bc(),mediaSourceFormat:zc()??"n/a",playPromise:null,shouldAbortQueuedPlayback:!1}).current,r=ue(),{voiceName:o}=Ny(),a=`${n}.${e}.${o}`,l=Ob(),d=Pb(p=>{var g;return p.isPlaying&&p.sourceUrl===((g=Qt.get(a))==null?void 0:g.src)}),u=y.useCallback(async()=>{if(!l)return;s(!0);const p={isMediaSourceAvailable:i.isMediaSourceAvailable,format:i.mediaSourceFormat};try{const g=await E_({key:a,message_id:e,conversation_id:n,voice:o,onStreamingError:S=>{ir.readAloud.error(S,p),s(!1),pn.danger(r.formatMessage(Lu.playbackError,{error:S.message}))},onStreamingStart:()=>{s(!1)}});if(i.shouldAbortQueuedPlayback){i.shouldAbortQueuedPlayback=!1;return}l.changeSource(g),i.playPromise=l.play()}catch(g){ir.readAloud.error(g,p),s(!1),pn.danger(r.formatMessage(Lu.playbackError,{error:g.message}))}},[l,a,e,n,o,i,r]),h=y.useCallback(()=>{const p=rd();p&&(i.playPromise?i.playPromise.then(()=>{p.stop(),i.playPromise=null}):p.stop())},[i]),f=y.useCallback(()=>{var g;const p=rd();p&&(p.state.isPlaying&&p.state.sourceUrl===((g=Qt.get(a))==null?void 0:g.src)?h():(ir.readAloud.click({isMediaSourceAvailable:i.isMediaSourceAvailable,format:i.mediaSourceFormat}),u()))},[a,i,u,h]);y.useEffect(()=>{t&&d&&s(!1)},[t,d]);const m=y.useRef(a);return y.useEffect(()=>{m.current=a}),y.useEffect(()=>(i.shouldAbortQueuedPlayback=!1,()=>{var S;const p=Fb();p.isPlaying&&p.sourceUrl===((S=Qt.get(m.current))==null?void 0:S.src)?h():i.shouldAbortQueuedPlayback=!0}),[i,h]),{togglePlayback:f,isPlaying:d,isLoading:t}}async function Pm({message_id:n,conversation_id:e,voice:t}){const s=await Ee.synthesize({message_id:n,conversation_id:e,voice:t,format:zc()}),i=s.headers.get("content-type")??"audio/aac";return{response:s,format:i}}async function E_(n){return Bc()?A_(n):I_(n)}async function I_({key:n,...e}){const t=Qt.get(n);if(t!=null&&t.blob)return t.src;const{response:s,format:i}=await Pm(e),r=await s.arrayBuffer(),o=new Blob([r],{type:i}),a=Fm({key:n,src:URL.createObjectURL(o),format:i,blob:o});return Qt.set(n,a),a.src}async function A_({key:n,onStreamingError:e,onStreamingStart:t,...s}){let i=Qt.get(n);i!=null&&i.streaming&&(Qt.delete(n),i=void 0);let r,o;const a=R_(),l=new a;if(i)r=i,r.src=URL.createObjectURL(l);else{const{format:h,response:f}=await Pm(s);o=f,r=Fm({key:n,src:URL.createObjectURL(l),format:h})}const d=j_(r.id),u={sourceopen:async()=>{var m,p;d("sourceopen");const h=l.addSourceBuffer(r.format),f=async()=>{h.updating&&await new Promise(g=>h.addEventListener("updateend",g,{once:!0}))};if(r.segments.length&&!r.streaming){d("streaming from cache"),r.streaming=!0,t();for(const g of r.segments)h.appendBuffer(g),await f();l.readyState==="open"&&l.endOfStream(),r.streaming=!1,d("done streaming from cache");return}if(o){d("fetching audio");try{const g=(m=o.body)==null?void 0:m.getReader();if(!g)return;for(;((p=Qt.get(n))==null?void 0:p.id)===r.id;){const{done:S,value:x}=await g.read();if(S){d("done streaming"),r.streaming=!1,l.readyState==="open"&&l.endOfStream();break}if(!Array.from(l.sourceBuffers).includes(h)){d("stop streaming, source buffer removed"),r.streaming=!1;break}r.streaming||(d("start streaming"),r.streaming=!0,t()),h.appendBuffer(x),r.segments.push(x),await f()}}catch(g){if(d("error while streaming",g),r.streaming=!1,l.readyState==="open")try{l.endOfStream("network")}catch(S){ir.readAloud.error(S)}Qt.delete(n),e(g)}}},sourceclose:()=>{var h;d("sourceclose"),r.streaming&&(r.streaming=!1,((h=Qt.get(n))==null?void 0:h.id)===r.id&&(d("sourceclosed while streaming, cleaning up cache"),Qt.delete(n)))},sourceended:kn};for(const[h,f]of Object.entries(u))l.addEventListener(h,()=>{try{return f()}catch(m){ir.readAloud.error(m)}});return Qt.set(n,r),r.src}const Lu=Ce({playbackError:{id:"useVoiceReadAloudAudio.playbackError",defaultMessage:"Failed to play message"}}),j_=n=>kn;function R_(){return Bc()?window.MediaSource:null}function Bc(){return!!zc()}function zc(){if("MediaSource"in window){const n=e=>Lb(e)&&MediaSource.isTypeSupported(e);if(n("audio/aac"))return"aac";if(n("audio/mpeg"))return"mp3";if(n("audio/ogg"))return"ogg"}}const Fm=n=>({id:Or(),segments:[],streaming:!1,...n}),Qt=new Ml({max:50,dispose:n=>{URL.revokeObjectURL(n.src)}}),D_=y.memo(function(e){var o;const t=(o=Cs("1923022511"))==null?void 0:o.value,s=zi(e.conversationId),{errCode:i}=Vi(e.message);if(!t||!s||i)return null;const r=pf.getAudioAssetPointers(e.message.message)[0];return r?c.jsx(O_,{audioAssetPointer:r,conversationId:s}):c.jsx(P_,{...e,conversationId:s})});function O_({audioAssetPointer:n,conversationId:e}){const{isLoading:t,isPlaying:s,togglePlayback:i}=Ey({audioAssetPointer:n,conversationId:e});return c.jsx(Lm,{onClick:i,isPlaying:s,isLoading:t,playText:zo.replay,playIcon:ZS})}function P_({conversationId:n,message:e}){const{isLoading:t,isPlaying:s,togglePlayback:i}=N_({conversationId:n,messageId:e.message.id});return c.jsx(Lm,{onClick:i,isPlaying:s,isLoading:t,playText:zo.play,playIcon:ek})}function Lm({onClick:n,isPlaying:e,isLoading:t,playText:s,playIcon:i}){let r,o;const a=ue();return t?(r=lf,o=zo.loading):e?(r=tk,o=zo.stop):(r=i,o=s),c.jsx(oo,{icon:r,label:o?a.formatMessage(o):void 0,disabled:t,onClick:n,style:e||t?{visibility:"visible"}:void 0,testId:"voice-play-turn-action-button"})}const zo={replay:{id:"VoiceReadOutLoudButton.replay",defaultMessage:"Replay",description:"The tooltip for the replay button"},play:{id:"VoiceReadOutLoudButton.play",defaultMessage:"Read Aloud",description:"The tooltip for the read aloud button"},stop:{id:"VoiceReadOutLoudButton.stop",defaultMessage:"Stop",description:"The tooltip for the stop button"},loading:{id:"VoiceReadOutLoudButton.loading",defaultMessage:"Loading",description:"The tooltip for the spinner"}},F_="bg-token-main-surface-primary text-token-text-primary",L_="openai",Bu=["bg-blue-300 text-white"];function B_(n){return Bu[((n==null?void 0:n.charCodeAt(0))??0)%Bu.length]}const eo=({children:n})=>c.jsx("div",{className:"pt-0",children:c.jsx("div",{className:K(y.isValidElement(n)&&n.type===Ka?"gizmo-bot-avatar":"gizmo-shadow-stroke","flex h-8 w-8 items-center justify-center overflow-hidden rounded-full"),children:n})});function El({messages:n,isUserTurn:e,avatarClassName:t,gizmo:s,showInlineEmbeddedDisplay:i=!1}){var m;const r="medium",o=n[0],a=(m=o==null?void 0:o.message.metadata)==null?void 0:m.shared_conversation_id,l=a!=null,d=Er(),{gizmoEditorData:u,mode:h}=Ir();let f=c.jsx(eo,{children:c.jsx(Ka,{className:t??F_,iconName:L_,size:r})});return s?f=c.jsx(eo,{children:c.jsx(bk,{gizmoId:s.gizmo.id,className:"h-full w-full"})}):u!=null&&h==="test"&&(f=c.jsx(Bf,{isFirstParty:!1,src:u.profilePictureUrl,className:"h-8 w-8 first:pt-[3px]"})),c.jsx("div",{children:e?l||i?c.jsx(eo,{children:c.jsx(Ka,{className:B_(a),iconName:"user",size:r})}):c.jsx(eo,{children:c.jsx(Iy,{user:d,size:r})}):f})}const z_=Me(()=>ve(()=>import("./d0ebhb53k8s99n29.js"),__vite__mapDeps([87,1,2,3,72,5,6,8,73,74,12,75,7,21,76,4,18,16,17,10,83,34,63,88,89,54,90,19,20,26,64])).then(n=>n.default)),U_=Me(()=>ve(()=>import("./sso-bcdhwpqolbad0i57.js").then(n=>n.c),__vite__mapDeps([11,1,2,3,5,6,12,7,8,4,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77])).then(n=>n.default).catch(()=>Ur)),V_=ze.div`flex gap-2 flex-wrap mt-1 max-w-[80%] justify-end`,W_=ze.div`flex flex-col gap-2`,H_=({parts:n,attachments:e,isUserTurn:t,clientThreadId:s})=>{const i=Dr(),r=gc(s),o=yc(),a=pf.getImageAssetPointersFromParts(n),l=new Set(a.map(p=>Go(p.asset_pointer))),u=Nr()||i,h=(e??[]).filter(p=>gh(p.name)),f=(e??[]).filter(p=>p.id==null||l.has(p.id)?!1:o||r?!h.includes(p):!0);return(o||r?(f.length>0||h.length>0)&&t:f.length>0&&t)?c.jsxs(c.Fragment,{children:[c.jsxs(V_,{children:[f.map(p=>c.jsx(Oh,{file:p.name,fileId:p.id,contextConnectorInfo:Ay(p.context_connector_info),width:i?"normal":"wide",alwaysShowData:!0},p.id)),r&&h.map(p=>c.jsx(U_,{visualization:Xc(p)},p.id))]}),o&&!r&&c.jsx(W_,{className:K(!u&&"w-[80%]"),children:h.map(p=>c.jsx(z_,{clientThreadId:s,visualization:Xc(p)},p.id))})]}):null};function Bm(n){return Zl(n)&&!Bb(n)}const to=50,G_=95;function q_(n,e){if(n<=e)return n/e*to;{const t=to,s=G_-to,i=n-e,o=-(to/e)/s;return t+s*(1-Math.exp(o*i))}}class $_{constructor(){X(this,"mostRecentCompletionRequest");X(this,"loggedRequestIds",new Set)}onCompletionRequestStarted(e){this.mostRecentCompletionRequest={requestId:e,timestamp:Date.now()}}onDisplayTextAfterBrowsingSession(e,t){const s=this.mostRecentCompletionRequest;if(s!=null&&!this.loggedRequestIds.has(s.requestId)){const r=I.getThreadConversationTurns(e,t).find(o=>o.messages.some(a=>a.message.id===t));r!=null&&r.messages.some(o=>o.nodeId===s.requestId)&&($.logEvent(V.browsingTimeToFirstTextToken,{messageId:t,timeMs:Date.now()-s.timestamp}),this.loggedRequestIds.add(s.requestId))}}}const zm=new $_;function K_(n){var i;const e=n.find(r=>{var o;return((o=r.message.metadata)==null?void 0:o.image_search_results)!==void 0});return(((i=e==null?void 0:e.message.metadata)==null?void 0:i.image_search_results)??[]).slice(0,5)}function J_({messages:n}){const e=K_(n),t=jy();return e.length===0?null:c.jsx("div",{className:K({"mb-2":!0,"grid grid-flow-col gap-3":e.length>1,"w-1/3":e.length===1}),children:e.filter(({contentUrl:s})=>t.has(s)).map((s,i)=>c.jsx("a",{href:s.hostPageUrl,target:"_blank",rel:"noreferrer",children:c.jsx("img",{src:s.contentUrl,alt:s.name,className:"aspect-square rounded-xl object-cover"})},i))})}const Y_=Me(()=>ve(()=>import("./sso-bcdhwpqolbad0i57.js").then(n=>n.d),__vite__mapDeps([11,1,2,3,5,6,12,7,8,4,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77])).then(n=>n.default).catch(()=>Ur));function Um({attachments:n,citations:e,contentReferences:t,className:s,clientThreadId:i,displayParts:r,id:o,isActivelyStreaming:a,isUserTurn:l,turnIndex:d,isFeedbackEnabled:u,messages:h,onRequestMoreCompletions:f,parts:m,prevGroupedMessageType:p,prevGroupedMessages:g,showEditButton:S,onEnterEdit:x,size:w="medium"}){var _,N;const C=gc(i),k=h.length>1,{flagSeverity:v,shouldHideContent:T}=Vi(k?void 0:h[0]),A=!m.some(z=>z!==""),L=((_=h[0].message.metadata)==null?void 0:_.targeted_reply_label)??((N=h[0].message.metadata)==null?void 0:N.targeted_reply);return y.useEffect(()=>{!A&&p===te.Browsing&&zm.onDisplayTextAfterBrowsingSession(i,h[0].message.id)},[A,h,i,p]),c.jsxs("div",{"data-message-author-role":h[0].message.author.role,"data-message-id":h[0].message.id,dir:"auto",className:K(s,"text-message flex w-full flex-col items-end gap-2 whitespace-normal break-words [.text-message+&]:mt-5"),children:[L&&c.jsxs("div",{className:"mb-1 ml-6 mt-1 flex items-start gap-1.5 text-sm font-normal text-token-text-tertiary sm:ml-7 lg:ml-8",children:[c.jsx(pc,{className:"icon-md mt-1 shrink-0"}),c.jsx("p",{className:"mr-2 line-clamp-3",children:L})]}),l&&C&&c.jsx(Y_,{messages:h}),c.jsx(Ry,{messages:h}),c.jsx(Q_,{parts:m,attachments:n,isUserTurn:l,turnIndex:d,displayParts:r,isActivelyStreaming:a,shouldHideContent:T,showEditButton:S,onEnterEdit:x,clientThreadId:i,id:o,isEmpty:A,prevGroupedMessageType:p,prevGroupedMessages:g,flagSeverity:v,messages:h,citations:e,contentReferences:t,size:w}),c.jsx(w_,{message:k?void 0:h[0],id:o,isFeedbackEnabled:u,onRequestMoreCompletions:f,clientThreadId:i,isUserTurn:l}),c.jsx(Dy,{isUserTurn:l,message:k?void 0:h[0]}),!l&&!a&&g&&p===te.SearchResult&&c.jsx(J_,{messages:g})]})}function Q_({clientThreadId:n,id:e,displayParts:t,turnIndex:s,isActivelyStreaming:i,shouldHideContent:r,showEditButton:o=!1,onEnterEdit:a,isEmpty:l,prevGroupedMessageType:d,prevGroupedMessages:u,messages:h,citations:f,contentReferences:m,size:p,isUserTurn:g,parts:S,attachments:x}){var U,O;const w=ue(),C=Oy(t),k=Wh(),v=(U=h[0].message.metadata)==null?void 0:U.gizmo_id,T=(O=h[0].message.metadata)==null?void 0:O.serialization_metadata,A=fS(h[0].message).length,L=y.useMemo(()=>({clientThreadId:n,messageId:e,turnIndex:s}),[n,e,s]),_=Wl(h[0].message),N=!!v&&k.includes(v),z=y.useCallback(R=>{Py.open(R,s,e)},[s,e]),j=c.jsx(H_,{parts:S,attachments:x,isUserTurn:g,clientThreadId:n},"files-and-tables"),H=!!(x!=null&&x.length||t.some(R=>R.type==="images")),Q=t.map((R,M)=>{var F;if(R.type==="transcription"){const J=r?null:R.text;let Z=null;return g&&r?Z=c.jsx("span",{className:"italic opacity-30",children:c.jsx(D,{...no.contentRemoved})}):g&&J!=null?Z=J.trim().length===0?c.jsx("span",{className:"italic opacity-30",children:c.jsx($r,{text:w.formatMessage(no.transcriptUnavailable),customSymbolOffsets:void 0})}):c.jsx("span",{className:"italic opacity-65",children:c.jsx($r,{text:`â€œ${J.trim()}â€`,customSymbolOffsets:void 0})}):!g&&J!=null&&(Z=c.jsx($r,{text:J,customSymbolOffsets:void 0})),c.jsx(ya,{containsImagesOrAttachments:H,isUserTurn:g,showEditButton:o,onEnterEdit:a,children:Z},M)}else if(R.type==="text"){const J=r?null:R.text;if(!l&&!r&&!g){const Z=d===te.CodeInterpreter?u==null?void 0:u.map(Pe=>Pe.message):void 0,{text:se,contentReferences:he}=Fy(C,f,m,N),{processedText:Ie,displayedContentReferences:xe}=Ly(se,he,i?void 0:Z);return c.jsx(By.Provider,{value:{analyticsMetadata:L,message:h[0].message,contentReferences:xe,onShowSearchResults:z,numImageResults:A,isActivelyStreaming:i,useSafeUrls:!0},children:c.jsx(Hl,{clientThreadId:n,messageId:e,size:p,className:K(i&&"result-streaming",_&&"headers-v2"),children:Ie===""?"&#8203;":Ie})},M)}else if(l&&i&&!g)return c.jsx("div",{className:"result-streaming",children:c.jsx("div",{children:c.jsx("pre",{})})},M);return c.jsx(ya,{containsImagesOrAttachments:H,isUserTurn:g,showEditButton:o,onEnterEdit:a,children:g&&r?c.jsx("span",{className:"italic opacity-30",children:c.jsx(D,{...no.contentRemoved})}):J?c.jsx($r,{text:J,customSymbolOffsets:T==null?void 0:T.custom_symbol_offsets}):null},M)}else if(R.type==="images"){const J=((F=h[0].message.metadata)==null?void 0:F.attachments)??[];return c.jsx(zy,{assets:R.imageAssets,attachments:J},M)}else return null}),B=t.findIndex(R=>R.type==="text");if(B!==-1?Q.splice(B,0,j):Q.push(j),r&&g)Q.length=0,Q.push(c.jsx(ya,{containsImagesOrAttachments:H,isUserTurn:g,onEnterEdit:kn,children:c.jsx("span",{className:"italic opacity-30",children:c.jsx(D,{...no.contentRemoved})})}));else if(r&&!g)return null;return c.jsx("div",{className:K("flex w-full flex-col gap-1 empty:hidden",g&&"items-end rtl:items-start",!g&&"first:pt-[3px]"),children:Q})}const no=Ce({contentRemoved:{id:"textMessage.contentRemoved",defaultMessage:"Content removed"},transcriptUnavailable:{id:"textMessage.transcriptUnavailable",defaultMessage:"Transcript Unavailable"}});function X_(n){var d;const{isActivelyStreaming:e,...t}=n,s=Bi(),i=(s==null?void 0:s.includes("debug"))??!1,r=n.messages[n.messages.length-1].message.id,[o,a]=y.useState([]),l=y.useRef();return l.current===void 0&&(l.current=(s==null?void 0:s.includes(zb))??!1?new Uy(n.parts,a,e,void 0,{debug:i}):new Vy(n.parts,a,e)),y.useEffect(()=>{l.current!=null&&(l.current.onMessagePartsUpdated(n.parts,e),l.current.isBuffering()&&sr.addDelayedRenderingMessage(r))},[n.parts,r,e]),y.useEffect(()=>{l.current!=null&&!l.current.isBuffering()&&sr.removeDelayedRenderingMessage(r)},[o,r]),y.useEffect(()=>()=>sr.removeDelayedRenderingMessage(r),[r]),y.useEffect(()=>()=>{l.current!=null&&(l.current.destroy(),l.current=void 0)},[]),c.jsx(Um,{...t,displayParts:o,isActivelyStreaming:e||((d=l.current)==null?void 0:d.isBuffering())})}function Z_({message:n,isCompletionInProgress:e,clientThreadId:t,className:s,isUserTurn:i,turnIndex:r,isFeedbackEnabled:o,prevGroupedMessageType:a,prevGroupedMessages:l,showEditButton:d,onEnterEdit:u,onRequestMoreCompletions:h}){var m,p,g;const f=y.useMemo(()=>"parts"in n.message.content?n.message.content.parts:[Qo(n.message)],[n]);return c.jsx(t1,{parts:f,messages:[n],isCompletionInProgress:e,className:s,citations:(m=n.message.metadata)==null?void 0:m.citations,contentReferences:(p=n.message.metadata)==null?void 0:p.content_references,attachments:(g=n.message.metadata)==null?void 0:g.attachments,isUserTurn:i,turnIndex:r,id:n.nodeId,isFeedbackEnabled:o,onRequestMoreCompletions:h,clientThreadId:t,showEditButton:d,onEnterEdit:u,prevGroupedMessageType:a,prevGroupedMessages:l})}const e1=oc.memo(Z_);function t1(n){const e=n.messages.length>1,{flagSeverity:t}=Vi(e?void 0:n.messages[0]),s=t!=="danger"&&n.isCompletionInProgress,i=!n.parts.some(o=>o!==""),[r]=y.useState(()=>!n.isUserTurn&&(n.isCompletionInProgress||i));return r?c.jsx(X_,{...n,isActivelyStreaming:s}):c.jsx(Um,{...n,displayParts:Wy({isUserTurn:n.isUserTurn,parts:n.parts}),isActivelyStreaming:s})}const n1=Me(()=>ve(()=>import("./k91ta071h5gumox6.js"),__vite__mapDeps([91,1,2,3])));function Vm({animationData:n,animationSegmentToPlay:e,animationLoopCounter:t}){const s=y.useRef(null);return y.useEffect(()=>{var i;(i=s.current)==null||i.playSegments(e,!0)},[t]),c.jsx(n1,{animationData:n,lottieRef:s,loop:!1,autoplay:!1})}function s1(n){return c.jsx(lc,{width:"8",height:"9",viewBox:"0 0 8 9",fill:"none",...n,children:c.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M7.66607 0.376042C8.01072 0.605806 8.10385 1.07146 7.87408 1.4161L3.54075 7.9161C3.40573 8.11863 3.18083 8.24304 2.93752 8.24979C2.69421 8.25654 2.46275 8.1448 2.31671 7.95008L0.150044 5.06119C-0.098484 4.72982 -0.0313267 4.25972 0.300044 4.01119C0.631415 3.76266 1.10152 3.82982 1.35004 4.16119L2.88068 6.20204L6.62601 0.584055C6.85577 0.239408 7.32142 0.146278 7.66607 0.376042Z",fill:"currentColor"})})}function i1(n){return c.jsxs(lc,{width:"4",height:"12",viewBox:"0 0 4 12",fill:"none",...n,children:[c.jsx("mask",{id:"path-1-inside-1_1975_4008",fill:"currentColor",children:c.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M1 6.5C1 7.05228 1.44772 7.5 2 7.5C2.55228 7.5 3 7.05228 3 6.5V1.5C3 0.947715 2.55228 0.5 2 0.5C1.44772 0.5 1 0.947715 1 1.5L1 6.5ZM0.75 10.25C0.75 10.9404 1.30964 11.5 2 11.5C2.69036 11.5 3.25 10.9404 3.25 10.25C3.25 9.55964 2.69036 9 2 9C1.30964 9 0.75 9.55964 0.75 10.25Z"})}),c.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M1 6.5C1 7.05228 1.44772 7.5 2 7.5C2.55228 7.5 3 7.05228 3 6.5V1.5C3 0.947715 2.55228 0.5 2 0.5C1.44772 0.5 1 0.947715 1 1.5L1 6.5ZM0.75 10.25C0.75 10.9404 1.30964 11.5 2 11.5C2.69036 11.5 3.25 10.9404 3.25 10.25C3.25 9.55964 2.69036 9 2 9C1.30964 9 0.75 9.55964 0.75 10.25Z",fill:"currentColor"}),c.jsx("path",{d:"M1 6.5H-0.25H1ZM1 1.5L-0.25 1.5L-0.25 1.5L1 1.5ZM2 6.25C2.13807 6.25 2.25 6.36193 2.25 6.5H-0.25C-0.25 7.74264 0.757359 8.75 2 8.75V6.25ZM1.75 6.5C1.75 6.36193 1.86193 6.25 2 6.25V8.75C3.24264 8.75 4.25 7.74264 4.25 6.5H1.75ZM1.75 1.5V6.5H4.25V1.5H1.75ZM2 1.75C1.86193 1.75 1.75 1.63807 1.75 1.5H4.25C4.25 0.257359 3.24264 -0.75 2 -0.75V1.75ZM2.25 1.5C2.25 1.63807 2.13807 1.75 2 1.75V-0.75C0.757359 -0.75 -0.25 0.257359 -0.25 1.5L2.25 1.5ZM2.25 6.5L2.25 1.5L-0.25 1.5L-0.25 6.5L2.25 6.5ZM2 10.25H-0.5C-0.5 11.6307 0.619288 12.75 2 12.75V10.25ZM2 10.25V12.75C3.38071 12.75 4.5 11.6307 4.5 10.25H2ZM2 10.25H2H4.5C4.5 8.86929 3.38071 7.75 2 7.75V10.25ZM2 10.25H2V7.75C0.619288 7.75 -0.5 8.86929 -0.5 10.25H2Z",fill:"currentColor",mask:"url(#path-1-inside-1_1975_4008)"})]})}function r1(n){return c.jsx(lc,{width:"8",height:"9",viewBox:"0 0 8 9",fill:"none",...n,children:c.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M7.32256 1.48447C7.59011 1.16827 7.55068 0.695034 7.23447 0.427476C6.91827 0.159918 6.44503 0.199354 6.17748 0.515559L4.00002 3.08892L1.82256 0.515559C1.555 0.199354 1.08176 0.159918 0.765559 0.427476C0.449355 0.695034 0.409918 1.16827 0.677476 1.48447L3.01755 4.25002L0.677476 7.01556C0.409918 7.33176 0.449354 7.805 0.765559 8.07256C1.08176 8.34011 1.555 8.30068 1.82256 7.98447L4.00002 5.41111L6.17748 7.98447C6.44503 8.30068 6.91827 8.34011 7.23447 8.07256C7.55068 7.805 7.59011 7.33176 7.32256 7.01556L4.98248 4.25002L7.32256 1.48447Z",fill:"currentColor"})})}function kE({animationLoopCounter:n}){const{resolvedTheme:e}=Xo(),t=e==="dark";return c.jsx(Vm,{animationData:t?Hy:Gy,animationSegmentToPlay:[0,300],animationLoopCounter:n})}function wE({animationLoopCounter:n}){const{resolvedTheme:e}=Xo(),t=e==="dark";return c.jsx(Vm,{animationData:t?qy:$y,animationSegmentToPlay:[0,400],animationLoopCounter:n})}const o1=2e3,Wm=.4,a1=.45,l1=.2,c1=.1,d1=.25;var Lt=(n=>(n[n.Running=0]="Running",n[n.Finished=1]="Finished",n[n.Error=2]="Error",n[n.Stopped=3]="Stopped",n[n.Paused=4]="Paused",n))(Lt||{});function CE({conversationMessages:n,icon:e,status:t,text:s,estimatedToolDurationMs:i,animationLoopDurationMs:r=o1,shouldPersistAfterFinished:o=!1}){const[a,l]=y.useState(t===0?0:t===1&&!o?7:1),[d,u]=y.useState(0);y.useEffect(()=>{t===2?l(8):t===3?l(9):t===4?l(10):t===1?l(a===2?3:7):t===0&&a===10&&(l(2),u(f=>f+1))},[t]);const h=f1(a);return y.useEffect(()=>{const f=n[0].message.id;if(h)return sr.addDelayedRenderingMessage(f),()=>{sr.removeDelayedRenderingMessage(f)}},[h]),Hh(()=>{Mi(a)&&u(f=>f+1)},r),a===7&&!o?null:c.jsxs("div",{className:"my-2.5 flex items-center gap-2.5",children:[c.jsx(u1,{icon:e,status:t,uiState:a,estimatedToolDurationMs:i,animationLoopCounter:d,shouldPersistAfterFinished:o,onFillProgressBarAnimationComplete:()=>l(4),onFinishAnimationComplete:()=>{l(5),setTimeout(()=>{l(o?7:6)},c1*1e3)},onHideAnimationComplete:()=>l(7)}),c.jsx(h1,{text:s,uiState:a,animationLoopCounter:d,onEnterAnimationComplete:()=>l(2)})]})}const zu=50;function u1({icon:n,status:e,uiState:t,estimatedToolDurationMs:s,animationLoopCounter:i,shouldPersistAfterFinished:r,onFillProgressBarAnimationComplete:o,onFinishAnimationComplete:a,onHideAnimationComplete:l}){const[d,u]=y.useState(0);Hh(()=>{Mi(t)?u(w=>w+zu):t===10&&u(0)},zu);let h,f,m;Mi(t)||t===10?(h="running",f=c.jsx(n,{animationLoopCounter:i}),m="bg-transparent"):t===4||t===5||t===7&&r?(h="finished",f=c.jsx(s1,{}),m="bg-brand-purple"):e===2?(h="error",f=c.jsx(i1,{}),m="bg-orange-500"):e===3&&(h="stopped",f=c.jsx(r1,{}),m="bg-gray-300");let p={opacity:0,scale:0,rotate:-180,x:0},g={type:"spring",bounce:.3,duration:a1},S={opacity:0,scale:.6,rotate:0,x:0};t===0?(p={opacity:0,scale:.5,rotate:-180,x:-8},g={type:"spring",bounce:.3,duration:Wm}):t===1?p=!1:t===5&&(S={opacity:0,scale:0,rotate:0,x:0},g={type:"spring",bounce:.3,duration:d1});const x=q_(d,s);return c.jsx("div",{className:"relative h-5 w-5 shrink-0",children:c.jsx(ws,{onExitComplete:()=>{t===6&&l()},children:h!=null&&c.jsxs(Oe.div,{className:K("absolute left-0 top-0 flex h-full w-full items-center justify-center rounded-full text-white",m),initial:p,animate:{opacity:1,scale:1,rotate:0,x:0},exit:S,transition:g,onAnimationComplete:()=>{t===4&&a()},children:[f,(Mi(t)||t===10)&&c.jsx(Ky,{percentage:t===3?100:x,thickness:1.5/23,className:"absolute left-1/2 top-1/2 h-[23px] w-[23px] -translate-x-1/2 -translate-y-1/2 text-brand-purple",backgroundStrokeClassName:"stroke-brand-purple/25 dark:stroke-brand-purple/50",transitionDuration:t===3?`${(100-x)/100*l1}s`:void 0,transitionTimingFunction:t===3?"cubic-bezier(0.55, 0, 1, 1)":void 0,onTransitionEnd:()=>{t===3&&o()}})]},h)})})}function h1({text:n,uiState:e,animationLoopCounter:t,onEnterAnimationComplete:s}){const[i,r]=y.useState(n);y.useEffect(()=>{e===2&&r(n)},[t]),y.useEffect(()=>{Mi(e)||r(n)},[e,n]);let o={opacity:0,x:0,y:15},a={type:"spring",bounce:.3,opacity:{duration:.15},y:{duration:.3}};e===0?(o={opacity:0,x:-8,y:0},a={type:"spring",bounce:.3,duration:Wm,delay:.15}):e===1&&(o=!1);const l=i??void 0;return c.jsx("div",{className:K("relative h-5 w-full leading-5",e===8||e===9?"text-token-text-tertiary":"text-token-text-secondary"),children:c.jsx(ws,{children:l!=null&&c.jsx(Oe.div,{className:"absolute left-0 top-0 line-clamp-1 overflow-visible",initial:o,animate:{opacity:1,x:0,y:0},exit:{opacity:0,x:0,y:-15},transition:a,onAnimationComplete:()=>{e===0&&s()},children:l},l.toString())})})}function Mi(n){return n===0||n===2||n===3}function f1(n){return Mi(n)||n===4||n===5||n===6||n===10}const Uu=ze.div`group absolute left-0 top-0 mr-1.5 h-8 overflow-hidden mt-1`;function Uc({highlightedCommand:n,status:e,children:t,showWorkUserSetting:s=!1,hideOnlyIfNotInteractedWith:i=!1,onOpenAnalytics:r}){const o=t!=null,[a]=y.useState(s),[l,d]=y.useState(s),[u,h]=y.useState(!1),f=e===Lt.Finished||e===Lt.Error,m=i?a?!1:!u:!1,p=e===Lt.Running&&"loading-shimmer";return f&&m?null:o?c.jsxs(c.Fragment,{children:[c.jsx(Vu,{$canShowWork:!0,children:c.jsx(ws,{children:c.jsx(Uu,{children:c.jsx(Oe.button,{onClick:()=>{l||r==null||r(),d(g=>!g),h(!0)},initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},className:K(p),children:c.jsxs("div",{className:"flex items-center justify-start gap-1",children:[c.jsx("span",{children:n}),l?c.jsx(nk,{className:"icon-md"}):c.jsx(Zo,{className:"icon-md"})]})},n==null?void 0:n.toString())})})}),c.jsx(ws,{children:l&&t&&c.jsx(Oe.div,{initial:"collapsed",animate:"reveal",exit:"collapsed",variants:{collapsed:{translateY:-20,opacity:0,height:0},reveal:{translateY:0,opacity:1,height:"auto"}},transition:{duration:.3,ease:"easeInOut"},className:"overflow-hidden",children:t})})]}):c.jsx(Vu,{$canShowWork:!1,children:c.jsx(Uu,{className:K(p),children:n})})}const Vu=ze.p`first:mt-0 my-1.5 relative h-8
${({$canShowWork:n})=>n?"text-token-text-secondary hover:text-token-text-primary":"text-token-text-secondary"}`,p1=Me(()=>ve(()=>import("./sso-bcdhwpqolbad0i57.js").then(n=>n.c),__vite__mapDeps([11,1,2,3,5,6,12,7,8,4,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77])).then(n=>n.default).catch(()=>Ur)),Wu=Me(()=>ve(()=>import("./d0ebhb53k8s99n29.js"),__vite__mapDeps([87,1,2,3,72,5,6,8,73,74,12,75,7,21,76,4,18,16,17,10,83,34,63,88,89,54,90,19,20,26,64])).then(n=>n.default));function m1({messages:n,isRequestActive:e,clientThreadId:t}){var S,x,w;const[s,i]=n,r=Bm(s.message),o=(S=i==null?void 0:i.message.metadata)==null?void 0:S.aggregate_result,a=I0(),l=yc(),d=gc(t),u=i!=null&&i.message?Wf(i.message):[],h=((w=(x=i==null?void 0:i.message.metadata)==null?void 0:x.aggregate_result)==null?void 0:w.messages.filter(mc))??[],m=(u.filter(C=>C.type==="chart")??[]).length!==h.length,p=l&&!m;let g=Lt.Running;return(o==null?void 0:o.status)==="success"?g=Lt.Finished:i!=null&&i.message.content.content_type!==Zt.ExecutionOutput||o!=null&&o.status!=="running"?g=Lt.Error:(r||!e)&&(g=Lt.Stopped),c.jsxs(c.Fragment,{children:[c.jsx(g1,{messages:n,status:g,isRequestActive:e}),p&&u.map((C,k)=>{const{file_id:v,type:T}=C;return d?c.jsx(p1,{isStreaming:g===Lt.Running,visualization:C},v):T==="chart"&&!a?(C.fallback_to_image=!0,c.jsx(Hu,{children:c.jsx(Wu,{clientThreadId:t,visualization:C})},k)):c.jsx(Hu,{children:c.jsx(Wu,{clientThreadId:t,visualization:C})},k)}),!p&&i!=null&&c.jsx(mk,{message:i.message})]})}const Hu=ze.div`mb-3 max-w-[80%]`;function g1({messages:n,status:e,isRequestActive:t}){var h;const[s,i]=n,r=ue(),o=(h=i==null?void 0:i.message.metadata)==null?void 0:h.aggregate_result,a=Bm(s.message),{data:l,error:d}=Ub(Vb.ShowExpandedCodeView);let u=r.formatMessage({id:"message.tools.data-analysis.running",defaultMessage:"Analyzing"});if((o==null?void 0:o.status)==="success"?u=r.formatMessage({id:"message.tools.data-analysis.finished",defaultMessage:"Analyzed"}):i!=null&&i.message.content.content_type!==Zt.ExecutionOutput||o!=null&&o.status!=="running"?u=r.formatMessage({id:"message.tools.data-analysis.error",defaultMessage:"Analysis errored"}):(a||!t)&&(u=r.formatMessage({id:"message.tools.data-analysis.stopped",defaultMessage:"Analysis paused"})),l!==void 0||d){const f=gk(s.message)!=null;return c.jsx(Uc,{status:e,highlightedCommand:u,showWorkUserSetting:l??!1,hideOnlyIfNotInteractedWith:!0,children:f?c.jsxs("div",{className:"mb-3 mt-0.5 overflow-hidden rounded-xl bg-black",children:[c.jsx(yk,{message:s.message,FormattedText:Hl}),i!=null&&c.jsx(xk,{message:i.message})]}):null})}return null}const y1=3,x1=.1,Gu=[0,.6,.9];function b1({nextMessage:n,isLastMessage:e,isRequestActive:t}){let s=e||(n==null?void 0:n.message.content.content_type)===Zt.Text&&!(n!=null&&n.message.content.parts.some(o=>o.length>0));const i=pS(n==null?void 0:n.message),r=Jy(i.slice(0,y1).map(o=>o.entries[0].url));if(s){const o=t?c.jsxs("div",{className:"flex items-center gap-1",children:[r.map((a,l)=>c.jsx(Oe.div,{className:"-ml-1.5 first:ml-0 last:mr-1.5",initial:{width:l===0?0:6,opacity:0},animate:{width:20,opacity:1},transition:{duration:x1,delay:Gu[Math.min(l,Gu.length-1)]},children:c.jsx("div",{className:K("flex h-5 w-5 items-center overflow-hidden rounded","border-l-2 border-token-main-surface-primary bg-token-main-surface-primary"),children:c.jsx(Yy,{url:a,size:32,minSize:16,className:"icon-md rounded"})})},a)),c.jsx(D,{id:"jjx8Qg",defaultMessage:"Searching the web"})]}):c.jsx(D,{id:"fssXGM",defaultMessage:"Error while searching"});return c.jsx(Uc,{highlightedCommand:o,status:t?Lt.Running:Lt.Error})}return null}const S1={strong:n=>{const{node:e,children:t,...s}=n;return c.jsx("strong",{...s,className:K(s.className,"font-semibold text-token-text-primary"),children:t})},p:n=>{const{node:e,children:t,...s}=n;return c.jsx("p",{...s,className:K(s.className,"text-base","has-[strong]:mb-1 [&:not(:first-child)]:has-[strong]:mt-3 [&:not(:has(strong))]:mb-3"),children:t})}};function k1({messages:n,isStreaming:e,clientThreadId:t}){var m,p;const[s,i]=y.useState(""),[r,o]=y.useState(!1),a=n[0].message,l=a.id,d=I.getServerThreadId(t),u=Qo(a);y.useEffect(()=>{var w;const g=/\*\*(.*?)(?:\*\*|\n|$)/g;let S,x="";for(;(S=g.exec(u))!=null;)x=S[1].trim();x?i(x):((w=a.metadata)==null?void 0:w.initial_text)!=null&&i(a.metadata.initial_text)},[u,(m=a.metadata)==null?void 0:m.initial_text]),y.useEffect(()=>{u.length>0&&o(!0)},[u]);const h=y.useMemo(()=>({client_thread_id:t,message_id:l,conversationId:d}),[t,l,d]);y.useEffect(()=>{r&&$.logEvent(V.receivedA8KM123Message,h)},[r]);const f=y.useCallback(()=>{$.logEvent(V.openedA8KM123Message,{...h,isStreaming:e})},[h,e]);return c.jsx(Uc,{status:e?Lt.Running:Lt.Finished,highlightedCommand:e?s:((p=a.metadata)==null?void 0:p.finished_text)??"",onOpenAnalytics:f,children:r?c.jsx("div",{className:"mb-4 border-l-2 pl-4",children:c.jsx(Hl,{componentOverrides:S1,className:"not-prose leading-6",children:u})}):null})}const w1=Me(()=>ve(()=>import("./sso-bcdhwpqolbad0i57.js").then(n=>n.e),__vite__mapDeps([11,1,2,3,5,6,12,7,8,4,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77])).then(n=>n.default).catch(()=>Ur)),C1=Me(()=>ve(()=>import("./sso-bcdhwpqolbad0i57.js").then(n=>n.J),__vite__mapDeps([11,1,2,3,5,6,12,7,8,4,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77])).then(n=>n.JawboneMessage).catch(()=>Ur)),v1=Me(()=>ve(()=>import("./dmv4eqpwgv4egv2h.js"),__vite__mapDeps([92,1,2,3,5,6,4,7,8,18,16,17,10,83,34,63,12,88,89,54,76,90,19,20,21,26,64]))),M1=Me(()=>ve(()=>import("./ebmw4bw78wlxkwjq.js"),__vite__mapDeps([93,1,2,3]))),T1=Me(()=>ve(()=>import("./b8dgcwr6ab2zizno.js"),__vite__mapDeps([94,1,2,3,5,6,4,7,8,18,16,17,10,83,34,63,12,88,89,54,76,90,19,20,21,26,64]))),_1=Me(()=>ve(()=>import("./krtxdgg9qkokcss7.js"),__vite__mapDeps([95,1,2,3,5,6,7,8])).then(n=>n.TextMessageEditor)),N1=Me(()=>ve(()=>import("./o8vp63k4mm24bt56.js"),__vite__mapDeps([96,1,2,3,5,6,8,7,4,18,16,17,10,83,34,63,12,88,89,54,76,90,19,20,21,26,64]))),E1=Me(()=>ve(()=>import("./f15mzw4y6dpi3lkt.js"),__vite__mapDeps([97,1,2,3,5,6,4,7,8,18,16,17,10,83,34,63,12,88,89,54,76,90,19,20,21,26,64]))),I1=Me(()=>ve(()=>import("./extpdpdlyuk3qc7r.js"),__vite__mapDeps([98,1,2,3,5,6,4,7,8,50,18,16,17,10,83,34,63,12,88,89,54,76,90,19,20,21,26,64])).then(n=>n.BrowsingMessage)),A1=Me(()=>ve(()=>import("./domvb0qlvql4sbca.js"),__vite__mapDeps([99,1,2,3,5,6,4,7,8,18,16,17,10,83,34,63,12,88,89,54,76,90,19,20,21,26,64])).then(n=>n.SearchResultMessage)),j1=Me(()=>ve(()=>import("./ltr0opt1rtypykzd.js"),__vite__mapDeps([100,1,2,3,5,6,4,7,8,54,34])).then(n=>n.GizmoContactsMessage)),R1=Me(()=>ve(()=>import("./lj0jyenudce2cwjb.js"),__vite__mapDeps([101,1,2,3,5,6,4,7,8,18,16,17,10,83,34,63,12,88,89,54,76,90,19,20,21,26,64])).then(n=>n.JITPluginMessage));function D1(n){switch(n.type){case te.Text:case te.Debug:return[n.message];case te.MultiText:case te.Browsing:case te.CodeInterpreter:case te.JITPlugin:case te.RetrievalBrowsing:case te.ParallelBrowsing:case te.Dalle:case te.GizmoEditor:case te.SearchResult:case te.GizmoContacts:case te.a8km123:case te.Canmore:case te.Jawbone:case te.SearchGPTQuery:return n.messages;default:throw new Error("Bad")}}function Il({groupedMessagesToRender:n,allGroupedMessages:e,clientThreadId:t,isEditing:s,isUserTurn:i,isCompletionRequestInProgress:r,isFeedbackEnabled:o,isFinalTurn:a,turnIndex:l,hasActiveRequest:d,showEditButton:u=!1,handleEnterEdit:h,handleExitEdit:f,onChangeItemInView:m,onRequestMoreCompletions:p,onRequestCompletion:g,shouldGrowContainer:S=!0}){const{showDebugConversationTurns:x}=ei(),w=Ts(t),C=n.map((k,v)=>{var A,L,_,N,z,j,H,Q,B,U,O,R,M;const T=v===e.length-1;switch(k.type){case te.Text:case te.MultiText:{const F=n[v-1],J=F==null?void 0:F.type,Z=F&&"messages"in F?F.messages:void 0;if(k.type===te.Text){const se=s?c.jsx(_1,{message:k.message,clientThreadId:t,onChangeItemInView:m,onRequestCompletion:g,onRequestMoreCompletions:p,onExitEdit:f,disabled:d}):c.jsx(e1,{className:"min-h-[20px]",message:k.message,isFeedbackEnabled:o,isCompletionInProgress:T&&r,turnIndex:l,clientThreadId:t,showEditButton:u,onEnterEdit:h,isUserTurn:i,onRequestMoreCompletions:p,prevGroupedMessageType:J,prevGroupedMessages:Z});return c.jsxs(y.Fragment,{children:[se,c.jsx(Qy,{isUserTurn:i,message:k.message.message})]},"group-"+k.message.nodeId)}else return k.type===te.MultiText?c.jsx(T1,{clientThreadId:t,messages:k.messages,isCompletionInProgress:T&&r,isFeedbackEnabled:o,onRequestMoreCompletions:p,prevGroupedMessageType:J,prevGroupedMessages:Z},"multitext-"+(((A=k.messages[0])==null?void 0:A.nodeId)??v)):k.type}case te.Browsing:case te.RetrievalBrowsing:{const F=w!=null&&[De.GizmoInteraction,De.GizmoMagicCreate,De.GizmoTest].includes(w.kind);return c.jsx(I1,{messages:k.messages,isRequestActive:d,isLastMessageInTurn:T,isUsingGizmo:F,isRetrieval:k.type===te.RetrievalBrowsing},"browsing-"+(((L=k.messages[0])==null?void 0:L.nodeId)??v))}case te.SearchGPTQuery:{const F=e[v+1];return c.jsx(b1,{isRequestActive:d,isLastMessage:T,nextMessage:F&&F.type===te.Text?F.message:void 0},"searchquery-"+(((_=k.messages[0])==null?void 0:_.nodeId)??v))}case te.a8km123:return c.jsx(k1,{messages:k.messages,isStreaming:T&&r,clientThreadId:t},"sum-"+(((N=k.messages[0])==null?void 0:N.nodeId)??v));case te.Jawbone:{const F=v+1<e.length?e[v+1]:void 0;return c.jsx(C1,{nextMessage:F&&F.type===te.Debug?F.message:void 0,isLastMessage:T,isRequestActive:d},"jawbone-"+(((z=k.messages[0])==null?void 0:z.nodeId)??v))}case te.ParallelBrowsing:return c.jsx(E1,{messages:k.messages},"parallel-"+(((j=k.messages[0])==null?void 0:j.nodeId)??v));case te.CodeInterpreter:return c.jsx(m1,{messages:k.messages,isRequestActive:d,clientThreadId:t},"ada-"+(((H=k.messages[0])==null?void 0:H.nodeId)??v));case te.JITPlugin:return c.jsx(R1,{messages:k.messages,clientThreadId:t,isLastTurnInConversation:a,onRequestCompletion:g},"jit-"+(((Q=k.messages[0])==null?void 0:Q.nodeId)??v));case te.GizmoContacts:return c.jsx(j1,{messages:k.messages,clientThreadId:t,isLastTurnInConversation:a,onRequestCompletion:g},"gizmo-contacts-"+(((B=k.messages[0])==null?void 0:B.nodeId)??v));case te.Dalle:return c.jsx(N1,{messages:k.messages,clientThreadId:t},"dalle-"+(((U=k.messages[0])==null?void 0:U.nodeId)??v));case te.GizmoEditor:return c.jsx(v1,{messages:k.messages},"gizmo-editor-"+(((O=k.messages[0])==null?void 0:O.nodeId)??v));case te.Canmore:return c.jsx(w1,{clientThreadId:t,messages:k.messages,isRequestActive:d},"canmore-"+(((R=k.messages[0])==null?void 0:R.nodeId)??v));case te.Debug:return x?c.jsx(M1,{message:k.message},"debug-"+k.message.nodeId):null;case te.SearchResult:return c.jsx(A1,{messages:k.messages},"search-result-"+(((M=k.messages[0])==null?void 0:M.nodeId)??v))}});return c.jsx(P1,{shouldGrowContainer:S,children:C})}function O1(){return c.jsx(Xy,{type:"danger",children:c.jsx(D,{id:"daIg0P",defaultMessage:"Unable to display this message due to a error."})})}function P1({children:n,shouldGrowContainer:e}){return c.jsx("div",{className:K({"flex max-w-full flex-col":!0,"flex-grow":e}),children:c.jsx(hf,{name:"GroupedMessages",fallback:O1,children:n})})}const so="rounded-lg radix-disabled:pointer-events-auto radix-disabled:cursor-not-allowed";function F1({className:n,clientThreadId:e,message:t,onModelSelect:s,onDropdownChange:i,canRegenerateResponse:r}){var z;const o=Yo("566128514").value,[a,l]=y.useState(null),[d,u]=y.useState(!1),[h,f]=y.useState(!1),m=en(e),p=Im({clientThreadId:e,message:t}),g=(z=t.message.metadata)==null?void 0:z.model_slug,{modelOptions:S,modelSlug:x,animateModelLabelOnRender:w,messageModelEnabledTools:C}=p,k=Wl(t.message),v=C.includes(fn.Search),T=y.useMemo(()=>S.find(j=>j.value===g),[S,g]),A=y.useRef(null),{doesUserHaveAnyAccountsWithPlusFeatures:L}=ti(),_=j=>{j||setTimeout(()=>{A.current&&A.current.blur()},10)};y.useEffect(()=>{_(d)},[d]);const N=r&&S.some(j=>Mr(j,L));return m?null:c.jsxs(ne.Root,{onOpenChange:j=>{r&&(u(j),i(j),_(j)),j&&$.logEvent(V.conversationOpenMessageModelSelector,{has_get_plus_button:N,is_new_regen_dropdown:!0})},children:[r?c.jsx(B1,{label:c.jsx(D,{id:"wDs5sz",defaultMessage:"Switch model"}),children:c.jsx(Lf,{ref:A,className:K("cursor-pointer",n),onMouseEnter:()=>f(!0),onMouseLeave:()=>f(!1),children:c.jsx(wl,{modelSlug:x,animateModelLabelOnRender:w,isDropdownOpen:d,isRegenerateEnabled:r,isHovered:h,isRegenLabel:!0,omitIcon:!1})})}):c.jsx("button",{className:K("cursor-pointer",n),onMouseEnter:()=>f(!0),onMouseLeave:()=>f(!1),children:c.jsx(wl,{modelSlug:x,animateModelLabelOnRender:w,isDropdownOpen:!1,isRegenerateEnabled:!1,isHovered:h,omitIcon:o,animateShortLabel:!0})}),r&&c.jsxs(ne.Content,{className:"z-30 min-w-fit origin-top-right text-token-text-primary",side:"bottom",align:"start",children:[c.jsx(ne.Item,{disabled:!0,className:"pb-0 pt-2",children:c.jsx("span",{className:"text-token-text-secondary",children:c.jsx(D,{id:"bFLh5u",defaultMessage:"Switch model"})})}),c.jsx(L1,{onModelSelect:s,messageModelSlug:g,omitModelIcons:o,modelOptions:S,setHoveredOption:l,hoveredOption:a,retryOption:T,lastResponseUsedSearch:k,modelSupportsSearch:v,doesUserHaveAnyAccountsWithPlusFeatures:L})]})]})}function L1({modelOptions:n,messageModelSlug:e,onModelSelect:t,omitModelIcons:s,setHoveredOption:i,hoveredOption:r,retryOption:o,lastResponseUsedSearch:a,modelSupportsSearch:l,doesUserHaveAnyAccountsWithPlusFeatures:d}){const u=ue(),[h,f]=y.useMemo(()=>ur(n,x=>x.subcategory),[n]),m=y.useMemo(()=>{const x=new Map;return h.forEach(w=>{var k;const C=w.subcategory;C&&(x.has(C)||x.set(C,[]),(k=x.get(C))==null||k.push(w))}),x},[h]),p=K("icon-sm",s&&"order-10 ml-auto text-token-text-tertiary"),g=s?"right":"left",S=[{key:"use-search",extraStreamParams:{forceUseSearch:!0},label:u.formatMessage(Ua.search),icon:c.jsx(ea,{className:"icon-sm"}),condition:l&&!a},{key:"use-no-search",extraStreamParams:{forceUseSearch:!1},label:u.formatMessage(Ua.nosearch),icon:c.jsx(Of,{className:"icon-sm"}),condition:l&&a}];return c.jsxs(c.Fragment,{children:[f.map(x=>{const{value:w,...C}=x;return c.jsx(Si,{value:w,onSelect:()=>t({requestedModelId:w}),includeRegenerate:!1,onMouseEnter:()=>i(w),onMouseLeave:()=>i(null),isHovered:r===w,messageModelSlug:e,includeCheck:!1,shouldShowUpsell:Mr(x,d),className:so,...C,icon:s?c.jsx("span",{className:p}):C.icon,justifyIcon:g,wrapIcon:!s},w)}),[...m.entries()].map(([x,w])=>c.jsxs(ne.Sub,{children:[c.jsx(ne.SubMenuTrigger,{children:c.jsx("div",{className:"flex grow justify-between gap-2 overflow-hidden",children:x})}),c.jsx(ne.Portal,{children:c.jsx(ne.SubContent,{className:"min-w-fit",children:w.map(C=>{const{value:k,...v}=C;return c.jsx(Si,{value:k,onSelect:()=>t({requestedModelId:k}),includeRegenerate:!1,onMouseEnter:()=>i(k),onMouseLeave:()=>i(null),isHovered:r===k,messageModelSlug:e,includeCheck:!1,className:so,...v,icon:null,justifyIcon:g,wrapIcon:!s,shouldShowUpsell:Mr(C,d)},x+"-"+k)})})})]},x)),!!o&&c.jsxs(c.Fragment,{children:[c.jsx(ne.Separator,{}),c.jsx(Si,{onSelect:()=>t({requestedModelId:o.value}),includeRegenerate:!0,onMouseEnter:()=>i(o.value),onMouseLeave:()=>i(null),messageModelSlug:e,includeCheck:!1,className:so,...o,label:u.formatMessage(Ua.tryAgain),subtitle:o.label,icon:c.jsx(ta,{className:p}),justifyIcon:g,wrapIcon:!s},o.value),S.filter(x=>x.condition).map(x=>c.jsx(Si,{onSelect:()=>t({requestedModelId:o.value,extraStreamParams:x.extraStreamParams}),includeRegenerate:!1,onMouseEnter:()=>i(x.key),onMouseLeave:()=>i(null),isHovered:r===x.key,messageModelSlug:e,includeCheck:!1,className:so,...o,label:x.label,subtitle:"",icon:x.icon,justifyIcon:g,wrapIcon:!s},x.key))]})]})}function B1({children:n,label:e}){return c.jsx(vs,{label:e,sideOffset:0,children:n})}const Ua=Ce({tryAgain:{id:"VbsBGW",defaultMessage:"Try again"},search:{id:"eTV6j1",defaultMessage:"Search the web"},nosearch:{id:"IvLzUk",defaultMessage:"Without web search"}}),z1=y.memo(F1);function Al({messages:n,isMemoryEnabled:e,isMemoryFull:t,gizmoId:s,isParagen:i}){const[r,o]=y.useState(!1),[a,l]=y.useState(!1),{eligible:d,isLoading:u}=Zy(),h=e&&!t,f=n.filter((g,S)=>{const x=n[S+1],C=(x==null?void 0:x.message.recipient)==="assistant"&&(x==null?void 0:x.message.author.role)===Se.Tool&&(x==null?void 0:x.message.author.name)==="bio"&&Qo(x.message)==="Model set context updated."||!x&&h;return g.message.author.role===Se.Assistant&&g.message.recipient==="bio"&&C}).flatMap(g=>{const S=g.message.content.content_type;return S===Zt.Text?g.message.content.parts:S===Zt.Code?[g.message.content.text]:[]}).map(U1),m=y.useMemo(()=>f.length>0,[f]);if(y.useEffect(()=>{m&&d&&!u&&Ai.openModal(fr.GlobalMemoryOnboarding)},[m,d,u]),f.length===0)return null;const p=g=>{const S=g??!a;l(S),S&&$.logEvent(V.memoryUpdatePopoverShown,{updateCount:f.length})};return c.jsxs(c.Fragment,{children:[c.jsx("div",{className:"inline-block",onMouseEnter:()=>p(!0),onMouseLeave:()=>p(!1),children:c.jsxs(ex,{open:a,sideOffset:4,side:"bottom",alignAgainstAnchor:"start",size:"none",className:"z-10 min-w-60 max-w-96 text-sm",onOpenChange:g=>p(g),disableAutofocus:!0,triggerButton:c.jsxs("button",{className:K("my-1 flex items-center gap-1 text-sm font-semibold outline-none",a?"text-token-text-secondary":"text-token-text-tertiary"),children:[c.jsx(sk,{className:"mb-[-1px]"}),f.length===1?c.jsx(D,{id:"MemoryActionResult.memoryWriteSingular.1",defaultMessage:"Memory updated"}):c.jsx(D,{id:"MemoryActionResult.memoryWritePlural.1",defaultMessage:"Memories updated"})]}),children:[c.jsx("div",{className:"mb-2 rounded border border-token-border-light bg-token-main-surface-secondary",children:f.map((g,S)=>c.jsx("div",{className:"border-b border-token-border-light px-3 py-2 first-letter:uppercase last:border-b-0",children:g},S))}),i?c.jsx("div",{className:"text-xs text-token-text-tertiary",children:c.jsx(D,{id:"MemoryActionResult.paragenMessage",defaultMessage:"This memory will be saved if you choose this response."})}):c.jsxs("button",{className:"flex w-full items-center justify-between rounded px-3 py-2 font-semibold hover:bg-token-main-surface-secondary",onClick:()=>{o(!0),$.logEvent(V.memoryUpdatePopoverManageButtonClicked,{updateCount:f.length})},children:[c.jsx(D,{id:"MemoryActionResult.manageMemories",defaultMessage:"Manage memories"}),c.jsx(ik,{className:"icon-md -mr-1 text-token-text-tertiary"})]})]})}),r&&c.jsx(Tk,{initialGizmoId:s,onClose:()=>o(!1)})]})}function U1(n){const e=["The user ","The user's ","User ","User's "];for(const t of e)if(n.startsWith(t))return n.slice(t.length);return n}function qu(n,e,t){I.updateTree(n,s=>{s.updateNodeMetadata(e,{inlineComparisonRating:t})})}function $u(n){var s,i;return{is_dark_mode:n==="dark",time_since_loaded:Math.floor(performance.now()/1e3),page_height:window==null?void 0:window.innerHeight,page_width:window==null?void 0:window.innerWidth,pixel_ratio:window==null?void 0:window.devicePixelRatio,screen_height:(s=window==null?void 0:window.screen)==null?void 0:s.height,screen_width:(i=window==null?void 0:window.screen)==null?void 0:i.width}}const Ku=({messages:n})=>{for(const{message:{metadata:e}}of n){const{augmented_paragen_prompt_label:t}=e??{};if(t)return t}};function V1(n){const e=y.useRef({left_visibility_initial:null,left_visibility_max:null,right_visibility_initial:null,right_visibility_max:null});return n.stubSideBySideFeedback?c.jsx(Hm,{setPreferredFeedback:()=>{},leftVariantId:"left-placeholder",rightVariantId:"right-placeholder",leftTurn:null,rightTurn:null,originalTurn:null,hasActiveRequest:!0,visibilityStateRef:e,...n}):c.jsx(W1,{...n,visibilityStateRef:e})}function W1(n){const{clientThreadId:e,variantIds:t,variantsInStreamInfo:s}=n;if(t.length!==2)throw new Error("ConversationTurnSideBySideFeedback requires exactly two variant IDs");const[i]=y.useState(()=>Date.now()),r=Ul(),{resolvedTheme:o}=Xo(),[a,l]=y.useMemo(()=>Gh(t.join(""))()<.5?[0,1]:[1,0],[t[0],t[1]]),d=a<l?"left":"right",u=d==="left"?"right":"left",h=t[a],f=t[l],m=dd(e,h),p=dd(e,f),g=Yi(ud(e,Yi(m).id)),S=Yi(ud(e,Yi(p).id)),x=d==="left"?g:S,w=d==="left"?S:g,C=s.display_treatment==="unskippable",k=C?"unskippable_parallel_2_in_stream:a:1.0":"skippable_parallel_2_in_stream:a:1.5";y.useEffect(()=>(Ii.setState({displayingSideBySideFeedback:!0,unskippable:C}),()=>{Ii.setState({displayingSideBySideFeedback:!1,unskippable:!1})}),[C]),tx();const v=y.useRef({left_visibility_initial:null,left_visibility_max:null,right_visibility_initial:null,right_visibility_max:null});y.useEffect(()=>Wb(Gl,{requestCompletion:()=>{var _,N,z,j;const A=(_=Qi(x.messages))==null?void 0:_.completionSampleFinishTime,L=(N=Qi(w.messages))==null?void 0:N.completionSampleFinishTime;Ee.submitMessageComparisonFeedback({feedback_version:k,original_message_id:(z=x.messages[x.messages.length-1])==null?void 0:z.message.id,new_message_id:(j=w.messages[w.messages.length-1])==null?void 0:j.message.id,rating:"none",conversation_id:I.getServerThreadId(e),text:"",tags:[],completion_comparison_rating:"skip",new_completion_placement:u,feedback_start_time:i,compare_step_start_time:i,original_completion_load_start_time:i,original_completion_load_end_time:A??0,new_completion_load_start_time:i,new_completion_load_end_time:L??0,frontend_submission_time:Date.now(),timezone_offset_min:new Date().getTimezoneOffset(),client_contextual_info:$u(o),...v.current})}}),[g,S,e,i,k,u,x==null?void 0:x.messages,w==null?void 0:w.messages,o]);const T=A=>{var B,U,O,R;const _=I.getTree(e).getLeafFromNode(A);I.setThreadCurrentLeafId(e,_.id);const z=A===h===(d==="left"),j=(B=Qi(x.messages))==null?void 0:B.completionSampleFinishTime,H=(U=Qi(w.messages))==null?void 0:U.completionSampleFinishTime;x.messages.length>0&&qu(e,x.messages[x.messages.length-1].nodeId,z?"original":"new"),w.messages.length>0&&qu(e,w.messages[w.messages.length-1].nodeId,z?"original":"new");let Q;j==null||H==null?Q=z?"partial_load_comparison_original":"partial_load_comparison_new":Q=z?"original":"new",Ee.submitMessageComparisonFeedback({feedback_version:k,original_message_id:(O=x.messages[x.messages.length-1])==null?void 0:O.message.id,new_message_id:(R=w.messages[w.messages.length-1])==null?void 0:R.message.id,rating:"none",conversation_id:I.getServerThreadId(e),text:"",tags:[],completion_comparison_rating:Q,new_completion_placement:u,feedback_start_time:i,compare_step_start_time:i,original_completion_load_start_time:i,original_completion_load_end_time:j??null,new_completion_load_start_time:i,new_completion_load_end_time:H??null,frontend_submission_time:Date.now(),timezone_offset_min:new Date().getTimezoneOffset(),client_contextual_info:$u(o),...v.current})};return c.jsx(Hm,{...n,setPreferredFeedback:T,leftVariantId:h,rightVariantId:f,leftTurn:g,rightTurn:S,hasActiveRequest:r,originalTurn:x,visibilityStateRef:v})}function H1(n){if(!n.length)return!1;const e=n.filter(t=>t.type===te.Text||t.type===te.MultiText).filter(t=>{var s;return t.message.message.status!=="finished_successfully"&&((s=t.message.message.metadata)==null?void 0:s.snorkle_status)!==void 0});return e.length>0&&e.every(t=>{const s=t.message.message.content;return(s==null?void 0:s.content_type)===Zt.Text&&s.parts.join("")===""})}function Hm({setPreferredFeedback:n,leftVariantId:e,rightVariantId:t,leftTurn:s,rightTurn:i,hasActiveRequest:r,originalTurn:o,visibilityStateRef:a,...l}){const{defaultParagenLabel:d,shouldShowParagenLabels:u=!1}=fh(),h=s&&Ku(s)||d,f=i&&Ku(i)||d,m=y.useMemo(()=>(s==null?void 0:s.messages)??[],[s==null?void 0:s.messages]),p=y.useMemo(()=>(i==null?void 0:i.messages)??[],[i==null?void 0:i.messages]),{avatarClassName:g}=l,S=y.useMemo(()=>wo(m),[m]),x=y.useMemo(()=>wo(p),[p]),w=Uo(),C=ei();function k(R){var Z,se;if(!C.showDebugConversationTurns&&!C.forceParagen)return null;let M=R===o?"ORIGINAL":"NEW";const F=R.messages[R.messages.length-1],J=(se=(Z=F==null?void 0:F.message)==null?void 0:Z.metadata)==null?void 0:se.__internal;if(J){const{model_id:he,model_definition_slug:Ie,model_definition_virtual_model_id:xe,alternative_model_selection_rule:Pe,augmented_paragen_prompt_group_id:Ke,augmented_paragen_prompt_id:E,augmented_paragen_prompt:fe}=J;he&&(M+=`
Model ID: ${he}`),Ie&&(M+=`
Model Slug: ${Ie}`),xe&&(M+=`
Virtual Model ID: ${xe}`),Pe&&(M+=`
Alternative Model Rule: ${Pe}`),Ke&&(M+=`
Prompt Group ID: ${Ke}`),E&&(M+=`
Prompt ID: ${E}`),fe&&(M+=`
Prompt: ${fe}`)}return c.jsx("div",{className:"whitespace-pre-wrap text-sm text-red-500",children:M})}const[v,T]=y.useMemo(()=>[S,x].map(R=>H1(R)),[S,x]),A=ks(s?To.getRequestIdFromConversationTurn(s):"")||v,L=ks(i?To.getRequestIdFromConversationTurn(i):"")||T,_=(s==null?void 0:s.role)===Se.User,N=(i==null?void 0:i.role)===Se.User,z=jl(),j=y.useRef(null),H=y.useRef(null),Q=y.useRef(null);y.useEffect(()=>{if(j.current&&H.current&&Q.current){const R=Array(11).fill(0).map((F,J)=>J/10),M=new IntersectionObserver(F=>F.forEach(J=>{J.target===H.current?(a.current.left_visibility_initial==null&&(a.current.left_visibility_initial=J.intersectionRatio),a.current.left_visibility_max=Math.max(a.current.left_visibility_max??0,J.intersectionRatio)):J.target===Q.current&&(a.current.right_visibility_initial==null&&(a.current.right_visibility_initial=J.intersectionRatio),a.current.right_visibility_max=Math.max(a.current.right_visibility_max??0,J.intersectionRatio))}),{root:j.current,threshold:R});return M.observe(H.current),M.observe(Q.current),()=>M.disconnect()}},[a]);const{data:B}=Vo(void 0,!1,w),U=B==null?void 0:B.memoryFullPct,O=typeof U=="number"&&U>=100;return c.jsxs("div",{className:"relative flex flex-col",children:[c.jsx("div",{className:"sticky top-[-1px] z-[1] text-pretty bg-token-main-surface-primary px-6 text-center text-lg md:static",children:c.jsx(D,{id:"JgCHDY",defaultMessage:"Youâ€™re giving feedback on a new version of ChatGPT."})}),c.jsx("div",{className:"text-pretty px-6 pb-5 pt-1 text-center text-sm text-token-text-secondary",children:c.jsx(D,{id:"TK934w",defaultMessage:"Which response do you prefer? Responses may take a moment to load."})}),c.jsx("div",{className:"sticky top-[calc(1.75em-1px)] z-[1] h-3 bg-gradient-to-b from-token-main-surface-primary from-50% to-transparent md:static"}),c.jsx("div",{className:"-mb-2 snap-x snap-mandatory overflow-x-auto px-3 pb-4 md:px-5 lg:px-10",ref:j,children:c.jsx("div",{className:"min-w-fit",children:c.jsxs("div",{className:"mx-auto flex max-w-6xl items-start gap-4 sm:gap-6",children:[c.jsxs(Ju,{elemRef:H,onClick:()=>{n(e)},hasActiveRequest:r,children:[c.jsxs(Qu,{children:[c.jsx(El,{messages:m,isUserTurn:_,avatarClassName:g,showInlineEmbeddedDisplay:!1}),c.jsx(Yu,{children:u?c.jsx("span",{className:"font-bold text-token-text-primary",children:h}):c.jsx(D,{...Xu.responseNumber,values:{responseIndex:1}})})]}),B!=null&&!_&&c.jsx(Al,{messages:m,isMemoryEnabled:z,isMemoryFull:O,isParagen:!0}),c.jsx(Il,{...l,groupedMessagesToRender:S,allGroupedMessages:S,isEditing:!1,isUserTurn:_,isCompletionRequestInProgress:A,hasActiveRequest:r,handleEnterEdit:kn,handleExitEdit:kn,shouldGrowContainer:!1}),!!s&&k(s)]}),c.jsxs(Ju,{elemRef:Q,onClick:()=>{n(t)},hasActiveRequest:r,children:[c.jsxs(Qu,{children:[c.jsx(El,{messages:p,isUserTurn:N,avatarClassName:g,showInlineEmbeddedDisplay:!1}),c.jsx(Yu,{children:u?c.jsx("span",{className:"font-bold text-token-text-primary",children:f}):c.jsx(D,{...Xu.responseNumber,values:{responseIndex:2}})})]}),B!=null&&!N&&c.jsx(Al,{messages:p,isMemoryEnabled:z,isMemoryFull:O,isParagen:!0}),c.jsx(Il,{...l,groupedMessagesToRender:x,allGroupedMessages:x,isEditing:!1,isUserTurn:N,isCompletionRequestInProgress:L,hasActiveRequest:r,handleEnterEdit:kn,handleExitEdit:kn,shouldGrowContainer:!1}),!!i&&k(i)]})]})})})]})}function Ju({elemRef:n,onClick:e,children:t,hasActiveRequest:s}){return c.jsxs("div",{className:"relative flex w-full min-w-[min(450px,80vw)] snap-center flex-col gap-1 truncate rounded-2xl border border-token-main-surface-tertiary bg-white p-5 text-left dark:bg-gray-700",ref:n,children:[t,s?null:c.jsx(ft,{className:"mt-4 self-start",onClick:e,children:c.jsx(D,{id:"U2EAH6",defaultMessage:"I prefer this response"})})]})}const Yu=ze.div`text-sm text-token-text-tertiary font-semibold`,Qu=ze.div`flex gap-4 items-center mb-1`,Xu=Ce({responseNumber:{id:"ConversationTurnTwoUpFeedback.responseNumber",defaultMessage:"Response {responseIndex, number}"},responseChoice:{id:"ConversationTurnTwoUpFeedback.responseChoice",defaultMessage:"Choose this response"}});function G1({clientThreadId:n,messageForRating:e,variantIds:t,conversationTurnMountTime:s}){const[i]=y.useState(()=>e.message.create_time!=null?e.message.create_time*1e3:Date.now()),[r]=y.useState(()=>Date.now());function o(a){var v,T;const l=I.getTree(n),d=t[0]||"",u=(l==null?void 0:l.getConversationTurns(d))||[],h=u[u.length-1],f=(h==null?void 0:h.messages)||[],m=f[f.length-1],p=((v=m==null?void 0:m.message)==null?void 0:v.id)||"",g=t[1]||"",S=(l==null?void 0:l.getConversationTurns(g))||[],x=S[S.length-1],w=(x==null?void 0:x.messages)||[],C=w[w.length-1],k=((T=C==null?void 0:C.message)==null?void 0:T.id)||"";Ee.submitMessageComparisonFeedback({feedback_version:"inline_regen_feedback:a:1.0",original_message_id:p,new_message_id:k,rating:"none",conversation_id:I.getServerThreadId(n),text:"",tags:[],completion_comparison_rating:a,new_completion_placement:"not-applicable",feedback_start_time:s,compare_step_start_time:s,new_completion_load_start_time:i,new_completion_load_end_time:r,frontend_submission_time:Date.now(),timezone_offset_min:new Date().getTimezoneOffset()}),I.updateTree(n,A=>{A.updateNodeMetadata(e.nodeId,{inlineComparisonRating:a})}),I.updateTree(n,A=>{A.updateNodeMetadata(m.nodeId,{inlineComparisonRating:"baseline"})})}return c.jsxs(q1,{children:[c.jsx("h6",{className:"min-w-[150px] grow",children:c.jsx(D,{...io.regenTitle})}),c.jsxs("div",{className:"flex flex-wrap items-end justify-center gap-2",children:[c.jsx(ft,{color:"secondary",onClick:()=>o("new"),children:c.jsx(D,{...io.regenBetterText})}),c.jsx(ft,{color:"secondary",onClick:()=>o("original"),children:c.jsx(D,{...io.regenWorseText})}),c.jsx(ft,{color:"secondary",onClick:()=>o("same"),children:c.jsx(D,{...io.regenSameText})})]}),c.jsx(Qa,{onClick:()=>{I.updateTree(n,a=>{a.updateNodeMetadata(e.nodeId,{inlineComparisonRating:"skip"})})}})]})}const q1=ze.div`flex items-center p-4 rounded-2xl bg-token-main-surface-primary text-token-text-primary text-sm border border-token-border-light gap-5 mt-3`,io=Ce({regenTitle:{id:"ConversationTurnInlineFeedback.regenTitle",defaultMessage:"Was this response better or worse?"},regenBetterText:{id:"ConversationTurnInlineFeedback.regenBetterText",defaultMessage:"Better"},regenWorseText:{id:"ConversationTurnInlineFeedback.regenWorseText",defaultMessage:"Worse"},regenSameText:{id:"ConversationTurnInlineFeedback.regenSameText",defaultMessage:"Same"}}),Zu=({allGroupedMessages:n})=>n.some(e=>[te.Browsing,te.RetrievalBrowsing,te.ParallelBrowsing].includes(e.type)),eh=({allGroupedMessages:n})=>n.some(e=>e.type===te.CodeInterpreter);function $1(n){return!n||!n.instructions?"":typeof n.instructions=="string"?n.instructions:n.instructions.filter(e=>typeof e=="string").join("")}const K1=[{match:Zu,tag:"Shouldn't have searched the web",label:Ze({id:"kL047b",defaultMessage:"Shouldn't have searched the web"})},{match:Zu,tag:"Don't like the source it cited",label:Ze({id:"+ds/Q/",defaultMessage:"Don't like the source it cited"})},{match:eh,tag:"Shouldn't have run code",label:Ze({id:"53w4ay",defaultMessage:"Shouldn't have run code"})},{match:eh,tag:"Couldn't handle my file",label:Ze({id:"EkFTQ5",defaultMessage:"Couldn't handle my file"})},{match:({allGroupedMessages:n})=>n.some(e=>e.type===te.Dalle),tag:"Shouldn't have created an image",label:Ze({id:"S8FRsr",defaultMessage:"Shouldn't have created an image"})},{match:({allGroupedMessages:n})=>n.some(e=>{if(e.type!==te.Text)return!1;const{message:t}=e.message,{content:s}=t;return s.content_type===Zt.Text&&Qo(t).match(/^```[\S]+\n/gm)}),tag:"Code was incorrect",label:Ze({id:"4EBdQk",defaultMessage:"Code was incorrect"})},{match:({systemContent:n})=>$1(n).includes("Personality")??!1,tag:"Too chatty or casual",label:Ze({id:"ATzJKW",defaultMessage:"Too chatty or casual"})},{match:({features:n})=>n.includes(ni.Sunshine),tag:"Shouldn't have used Memory",label:Ze({id:"yfUEiz",defaultMessage:"Shouldn't have used Memory"})},{tag:"Don't like the style",label:Ze({id:"nGxjdj",defaultMessage:"Don't like the style"})},{tag:"Not factually correct",label:Ze({id:"Ke7JtQ",defaultMessage:"Not factually correct"})},{tag:"Didn't fully follow instructions",label:Ze({id:"Rdlt9V",defaultMessage:"Didn't fully follow instructions"})},{tag:"Refused when it shouldn't have",label:Ze({id:"2yRS/Q",defaultMessage:"Refused when it shouldn't have"})},{tag:"Being lazy",label:Ze({id:"14MPmT",defaultMessage:"Being lazy"})},{tag:"Unsafe or problematic",label:Ze({id:"02pXBl",defaultMessage:"Unsafe or problematic"})},{tag:"Other",label:Ze({id:"WiIGE+",defaultMessage:"Other"})}],J1=[{tag:"I disagree with the policy",label:Ze({id:"oKyDLz",defaultMessage:"I disagree with the policy"})},{tag:"This didn't violate the policy",label:Ze({id:"7fUkVF",defaultMessage:"This didn't violate the policy"})},{tag:"I don't understand the policy",label:Ze({id:"4Cdp6N",defaultMessage:"I don't understand the policy"})},{tag:"This didn't take the full context",label:Ze({id:"vnZJDP",defaultMessage:"This didn't take the full context"})}];function Y1(n,e,t){return e.filter(s=>!s.match||s.match(t)).map(s=>({value:s.tag,label:n.formatMessage(s.label)}))}function Q1(n){const e=n[n.length-1];if(!e)return!1;const t="message"in e?e.message:null;if(t){const{errCode:s}=Vi(t);return[zt.ContentPolicy,zt.ContentOrTos].includes(s)}else return!1}function X1({clientThreadId:n,conversationMessage:e,currentModelId:t,allGroupedMessages:s}){const i=ue(),r=Bi()??[],o=e.rating,{value:a}=Cs("1410082514"),l=mS(n,e.message.id),d=(l==null?void 0:l.message.content.content_type)===Zt.SystemContent?l==null?void 0:l.message.content:null,u=y.useCallback(m=>{var x;const p=I.getServerThreadId(n);if(!p||m.tags.length===0&&!m.textFeedback)return;$.logEvent(m.source==="inline"?V.messageFeedbackInlineSubmitted:V.messageFeedbackDialogSubmitted,{id:e.message.id,threadId:p,tags:m.tags,content:m.textFeedback,model:t,rating:o});const S=a&&((x=e.message.metadata)==null?void 0:x.snorkle_status)!=null?Ee.submitSnorkleFeedback:Ee.submitMessageFeedback;o&&S({message_id:e.message.id,conversation_id:p,rating:o,text:m.textFeedback,tags:m.tags,tag_choices:m.tagChoices})},[n,e.message,t,o,a]),h=()=>{$.logEvent(V.messageFeedbackMoreOptionsClicked,{id:e.message.id,threadId:I.getServerThreadId(n),model:t,rating:o})},f=Y1(i,Q1(s)?J1:K1,{allGroupedMessages:s,features:r,currentModelId:t,systemContent:d});return o==="thumbsUp"?null:c.jsx(vk,{tagOptions:f,onSubmit:u,onMoreClicked:h})}const th=[1,2,3,4,10,20,30],Z1=.5;function eN({clientThreadId:n,conversationLeafId:e}){const t=Co(ql.isBusinessWorkspace),s=y.useRef(!1),i=zi(n),r=Ts(n),{isUnauthenticated:o}=Ht(),{value:a}=Cs("1410082514"),l=y.useMemo(()=>{if(!i)return-1;const j=Gh(i);return j()>Z1?-1:th[Math.floor(j()*th.length)]},[i]),d=kf(n,e),u=d[d.length-1],h=y.useMemo(()=>To.getRequestIdFromConversationTurn(u),[u]),f=ks(h),[m,p]=y.useState(null),[g,S]=y.useState(!1),[x,w]=y.useState(!1),[C,k]=y.useState(!1),v=j=>{var Q,B;const H=(B=(Q=Qi(d))==null?void 0:Q.messages[0])==null?void 0:B.message.id;p(j),N(H,j)},T=d.filter(j=>j.role===Se.Assistant).length,A=(u==null?void 0:u.role)===Se.Assistant,L=u==null?void 0:u.messages.some(j=>{var H;return(H=j.message.metadata)==null?void 0:H.is_nulligen}),_=a&&(u==null?void 0:u.messages.some(j=>{var H;return((H=j.message.metadata)==null?void 0:H.snorkle_status)!=null})),N=y.useMemo(()=>Vl((j,H)=>{i&&j&&(_?Ee.submitSnorkleFeedback({conversation_id:i,message_id:j,rating:H}):Ee.submitConversationRating({conversation_id:i,message_id:j,rating:H,shown_at_assistant_turn:l})),$.logEvent(V.conversationRatingSubmitted,{rating:H,showAtAssistantTurn:l,conversationId:i}),S(!0),setTimeout(()=>{w(!0)},1500)},2e3),[i,l,_]),z=T!==l||f||!A||L||!!t||(r==null?void 0:r.kind)!==De.PrimaryAssistant||C||o;return y.useEffect(()=>{!z&&!s.current&&($.logEvent(V.conversationRatingShown,{showAtAssistantTurn:l,conversationId:i}),s.current=!0)},[z]),C||z&&!_?null:c.jsxs("div",{className:"mx-auto",children:[c.jsx(ws,{children:g&&!x&&c.jsx(Oe.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},children:c.jsx(nh,{$padded:!0,children:c.jsx("span",{className:"text-sm text-token-text-tertiary",children:c.jsx(D,{id:"rating.thanks",defaultMessage:"Thanks for your feedback!"})})})},"submitted")}),!g&&c.jsx(Oe.div,{initial:{opacity:0},animate:{opacity:1},transition:{duration:.1},children:c.jsxs(nh,{$padded:!1,children:[c.jsxs("div",{className:"flex items-center justify-center gap-4 px-4 py-3 text-sm text-token-text-secondary",children:[c.jsx(D,{id:"rating.instructions",defaultMessage:"Is this conversation helpful so far?"}),c.jsxs("div",{className:"flex items-center gap-5",children:[c.jsx(Va,{$selected:m==="thumbsUp",onClick:()=>v("thumbsUp"),children:c.jsx(Pf,{className:"icon-md"})}),c.jsx(Va,{$selected:m==="thumbsDown",onClick:()=>v("thumbsDown"),children:c.jsx(Ff,{className:"icon-md"})})]})]}),c.jsx("div",{className:"w-px flex-1 self-stretch bg-token-main-surface-tertiary"}),c.jsx(Va,{className:"p-3",$selected:!1,onClick:()=>k(!0),children:c.jsx(rk,{className:"icon-md text-token-text-secondary hover:text-token-text-primary"})})]})},"rating")]})}const Va=ze.button`
  ${n=>n.$selected?"text-token-text-primary":"text-token-text-secondary"}
  hover:text-token-text-primary
`,nh=ze.div`inline-flex rounded-xl border border-gray-100 dark:border-gray-700
${n=>n.$padded&&"py-3 px-4"}
`;function tN({clientThreadId:n,conversationLeafId:e,canShowIndepthFeedbackType:t,canShowInlineComparisonFeedback:s,canShowInlineMessageFeedback:i,messageForRating:r,allGroupedMessages:o,currentModelId:a,conversationTurnMountTime:l,variantIds:d}){let u=null;return gS(n,e)?null:(t!==void 0?u=c.jsx(y_,{clientThreadId:n,conversationLeafId:e,trigger:t,variantIds:d}):r.rating&&i?u=c.jsx(X1,{clientThreadId:n,conversationMessage:r,allGroupedMessages:o,currentModelId:a}):s?u=c.jsx(G1,{clientThreadId:n,messageForRating:r,variantIds:d,conversationTurnMountTime:l}):u=c.jsx("div",{className:"text-center",children:c.jsx(eN,{clientThreadId:n,conversationLeafId:e})}),c.jsx("div",{className:"mt-3 w-full empty:hidden",children:u}))}const nN=Me(()=>ve(()=>import("./sso-bcdhwpqolbad0i57.js").then(n=>n.f),__vite__mapDeps([11,1,2,3,5,6,12,7,8,4,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77])).then(n=>n.ContextualAnswerCitationCards).catch(()=>()=>null));function sN(n){var es;const{turnIndex:e,conversationLeafId:t,isFinalTurn:s,clientThreadId:i,onChangeItemInView:r,onChangeRating:o,showInlineEmbeddedDisplay:a=!1,currentModelId:l,initiallyHighlightedMessageId:d,avatarClassName:u,scrollToBottom:h}=n,f=ue(),m=Er(),p=!!m&&sf(m),g=Fr(),S=Co(ql.isBusinessWorkspace),x=jl(),w=Uo(),C=Yi(yS(i,e,t)),{messages:k,variantIds:v,variantsInStreamInfo:T}=C,A=wo(k),L=nx();let _=k[k.length-1];for(const ae of A){const Re=D1(ae);if(Re.some(Ln=>L.has(Ln.message.id))){_=Re[Re.length-1];break}}const N=k.slice(0,k.indexOf(_)+1),z=Xl(),[j,H]=y.useState(!1),[Q,B]=y.useState(!1),U=v.findIndex(ae=>N.some(Re=>Re.nodeId===ae)),O=C.role===Se.User,R=Kn(),M=en(i),F=(es=Ms(C.gizmoId??M))==null?void 0:es.data,J=Wh(),Z=F&&J.includes(F.gizmo.id),se=qh(l),he=Ts(i,F==null?void 0:F.gizmo.id),xe=xf(i)===rc.PENDING,{data:Pe}=Vo(F==null?void 0:F.gizmo.id,!1,w),Ke=Pe==null?void 0:Pe.memoryFullPct,E=Ke!==void 0&&Ke>=100,fe=Bi(),{value:Ue}=Cs("1410082514"),{value:pe}=Cs("2291672486"),Fe=N.some(ae=>ae.message.content.content_type===Zt.MultimodalText),{isUnauthenticated:Je}=Ht(),[ke,ot]=y.useState(!1),[ce,We]=y.useState(!1);sx(()=>{C.role==="user"&&h&&h()});const Ae=y.useRef(null);y.useEffect(()=>{var Re;if(d==null)return;C.messages.map(Ln=>Ln.message.id).includes(d)&&((Re=Ae.current)==null||Re.scrollIntoView({behavior:"auto"}))},[d]);const le=k[k.length-1],we=le.rating,Gt=()=>{N.length===1&&($.logEvent(V.editPrompt,{id:N[0].message.id,threadId:I.getServerThreadId(i)}),$e.logEvent("chatgpt_edit_prompt"),H(!0))},In=y.useCallback(()=>{H(!1)},[]),et=y.useCallback(()=>{I.copyMessageToClipboard(i,e)},[i,e]),Tt=ae=>{o({nodeId:le.nodeId,messageId:le.message.id,rating:ae}),$.logEvent(V.messageFeedbackThumbsDownClicked,{id:le.message.id,threadId:I.getServerThreadId(i),model:l,rating:ae}),B(!0)},[Te]=y.useState(()=>Date.now()),Le=y.useMemo(()=>To.getRequestIdFromConversationTurn(C),[C]),st=bf({clientThreadId:i,conversationLeafId:t}),Ve=ks(Le)&&!st,Yn=Ul(),mt=wo(N),{showDebugConversationTurns:tn}=ei(),qt=Sf(i),_t=Em(i),Qn=S_({clientThreadId:i,conversationMode:he}),Wi=Mn(i),ii=y.useCallback(({requestedModelId:ae,systemMessage:Re,juice:Ln,extraStreamParams:Gi})=>{const qi=new Ss;Qn({id:le.nodeId,eventMetadata:{eventSource:"mouse"},turnTracker:qi,requestedModelId:ae,systemMessage:Re,juice:Ln,extraStreamParams:Gi})},[le,Qn]),ri=Ue&&N.some(ae=>{var Re;return((Re=ae.message.metadata)==null?void 0:Re.snorkle_status)!=null}),oi=!g&&!qt&&!R&&!O,gn=oi&&(!S||ri),Es=ix(),An=!Je&&gn&&z&&!Ve&&!xe&&!a&&!j&&(he==null?void 0:he.kind)!==De.GizmoMagicCreate&&U===1&&s&&!le.inlineComparisonRating&&!we&&v.length===2&&!Es&&Date.now()-(le.message.create_time??0)*1e3<1e3*60*10,jn=!Je&&gn&&!Ve&&!xe&&!a&&!j&&(he==null?void 0:he.kind)!==De.GizmoMagicCreate&&l===Qx&&s&&x&&!E&&Date.now()-(le.message.create_time??0)*1e3<1e3*60*10,me=x_(le),Is=_.message.author.role===Se.Assistant?_.message:null;rx({isCompletionRequestInProgress:Ve,isUserTurn:O,message:Is});const Nt=jn?me:void 0,ai=xS(i,v),Xn=ox(he),yn=!Es&&!Xn&&oi&&s&&(T==null?void 0:T.num_variants_in_stream)===2&&!le.inlineComparisonRating&&!ai,li=v.length===2,Rn=yn,Dn=yn&&!li,On=!O&&!a&&!g&&!qt&&!Xn&&!xe&&!Ve,Zn=On&&(!S||ri||se||p)&&!Xn&&!Je&&!R,oe=!g&&!a&&!((Ve||xe)&&s)&&v.length>1&&!j&&!Rn;let Ye=!1;if(O&&N.length===1){const{shouldHideContent:ae}=Vi(N[0]);ae&&(Ye=!0)}const je=O&&!a&&!Xn&&!g&&!Fe&&N.length===1&&!Ye&&!j&&!Je,Qe=ae=>{r(v[ae]),$.logEvent(V.changeNode,{intent:"toggle_between"})};if(!(C.role===Se.Root?!1:C.role===Se.System||N.every(ae=>{var Re;return(Re=ae.message.metadata)==null?void 0:Re.is_visually_hidden_from_conversation})?tn:!0)&&!Rn)return null;const $t=s&&_t&&!pe?c.jsx(oo,{onClick:()=>{const ae=new Ss;Qn({id:Wi,eventMetadata:{eventSource:"mouse"},turnTracker:ae}),cr()},icon:ta,label:f.formatMessage({id:"ConversationTurn.regenerateTooltip",defaultMessage:"Regenerate"}),testId:"regenerate-turn-action-button"}):null,It="h-[30px] rounded-md px-1 text-token-text-secondary hover:bg-token-main-surface-secondary",Kt=pe?c.jsx(z1,{className:It,clientThreadId:i,message:le,onModelSelect:ii,onDropdownChange:ot,canRegenerateResponse:_t}):null,Pn=!O&&!Ye&&!a&&(!s||!Ve)?c.jsx(fx,{onClick:et}):null,Fn=!O&&!a&&(!s||!Ve)&&(le.disclaimers??[]).length===0&&le.nodeId?c.jsx(D_,{conversationId:i,message:le,iconClassName:"icon-md",className:"gap-1.5 rounded-md p-1 text-xs text-token-text-tertiary hover:text-token-text-primary"}):null,ci=!O&&!a&&le&&(!s||!Ve)?c.jsx(px,{message:le,isFinalTurn:s,iconClassName:"icon-md",className:"gap-1.5 rounded-md p-1 text-token-text-tertiary hover:text-token-text-primary"}):null,As=Zn&&!Ve?c.jsxs("div",{className:"flex",children:[!(fe!=null&&fe.includes(ni.ThumbsDownOnly))&&we!=="thumbsDown"&&c.jsx(oo,{onClick:()=>Tt("thumbsUp"),disabled:we==="thumbsUp",icon:we==="thumbsUp"?ok:Pf,label:f.formatMessage({id:"ConversationTurn.goodResponseTooltip",defaultMessage:"Good response"}),testId:"good-response-turn-action-button"},`thumbsUp:${le.nodeId}`),we!=="thumbsUp"&&c.jsx(oo,{onClick:()=>Tt("thumbsDown"),disabled:we==="thumbsDown",icon:we==="thumbsDown"?ak:Ff,label:f.formatMessage({id:"ConversationTurn.badResponseTooltip",defaultMessage:"Bad response"}),testId:"bad-response-turn-action-button"},`thumbsDown:${le.nodeId}`)]}):null,Hi=!pe&&c.jsx(f_,{className:It,clientThreadId:i,message:le,onModelSelect:ii,onDropdownChange:ot});return c.jsxs("article",{className:"w-full text-token-text-primary focus-visible:outline-2 focus-visible:outline-offset-[-4px]",ref:Ae,dir:"auto","data-testid":`conversation-turn-${e}`,"data-scroll-anchor":s,onMouseEnter:()=>We(!0),onMouseLeave:()=>We(!1),children:[c.jsx(ax,{role:C.role}),c.jsx(uc,{clientThreadId:i,showInlineEmbeddedDisplay:a,isStaticSharedThread:g,withVerticalPadding:!0,withHorizontalPadding:!Rn,children:Rn?c.jsx(V1,{isFeedbackEnabled:Zn,variantIds:v,variantsInStreamInfo:T,conversationTurnMountTime:Te,stubSideBySideFeedback:Dn,...n}):c.jsxs(hc,{children:[!O&&c.jsx(rN,{children:c.jsx(El,{messages:N,isUserTurn:O,avatarClassName:u,showInlineEmbeddedDisplay:a,gizmo:F})}),c.jsx("div",{className:K("group/conversation-turn relative flex w-full min-w-0 flex-col",!O&&lx),children:c.jsx("div",{className:"flex-col gap-1 md:gap-3",children:c.jsxs(c.Fragment,{children:[!O&&!g&&c.jsx(Al,{messages:N,isMemoryEnabled:x,isMemoryFull:E,gizmoId:F==null?void 0:F.gizmo.id}),c.jsx(Il,{groupedMessagesToRender:mt,allGroupedMessages:A,...n,isEditing:j,isUserTurn:O,isCompletionRequestInProgress:Ve,isFeedbackEnabled:Zn,isFinalTurn:s,hasActiveRequest:Yn,showEditButton:je,handleEnterEdit:Gt,handleExitEdit:In}),Z&&c.jsx("div",{className:"mb-4",children:c.jsx(cx,{messages:N})}),se&&c.jsx("div",{className:"mb-4",children:c.jsx(nN,{messages:N})}),(On||oe)&&c.jsxs(c.Fragment,{children:[c.jsx("div",{className:K("mt-1 flex gap-3 empty:hidden",O?"mr-1 flex-row-reverse":"-ml-2"),children:c.jsx(dx,{alwaysShow:s,showInline:s||oe,isHovered:ce||ke,pagination:oe&&c.jsx(ux,{showInline:s||oe,currentPage:U,onChangeIndex:Qe,length:v.length,className:K("self-center",v.length>1?"visible":"!invisible")}),actions:On&&c.jsxs(c.Fragment,{children:[Fn,Pn,$t,As,ci,Hi,Kt]})})}),On&&!Ve?c.jsx("div",{className:"pr-2 lg:pr-0",children:c.jsx(hx,{message:le,isFinalTurn:s})}):null,s&&!Ve&&c.jsx(tN,{canShowIndepthFeedbackType:Nt,canShowInlineComparisonFeedback:An,canShowInlineMessageFeedback:Q,clientThreadId:i,conversationLeafId:t,messageForRating:le,allGroupedMessages:A,currentModelId:l,conversationTurnMountTime:Te,variantIds:v})]})]})})})]})})]})}const iN=oc.memo(sN),rN=ze.div`flex-shrink-0 flex flex-col relative items-end`;function oN(n){var t,s;const e=(t=n.message.metadata)==null?void 0:t.aggregate_result;return(s=e==null?void 0:e.messages)==null?void 0:s.some(mc)}function aN(n){const e=n.message.content;return("parts"in e?e.parts.join(""):"").includes("sandbox:")}function lN(n){return n.some(e=>e.messages.some(t=>oN(t)||aN(t)))}function cN({clientThreadId:n}){const e=bS(n),t=wf(n),s=Jn(u=>bt.getThreadCreateTime(n,u)),i=Mn(n),r=kf(n,i),o=y.useMemo(()=>lN(r),[r]),a=SS(n),l=kS(n),d=a||l;return c.jsxs("div",{className:"border-b border-gray-100 px-4 pb-4 pt-3 sm:mb-2 sm:pb-6 sm:pt-8 md:px-0",children:[c.jsx("h1",{className:"text-3xl font-semibold leading-tight text-token-text-primary sm:text-4xl",children:e}),(t!=null||s!=null)&&c.jsxs("div",{className:"pt-3 text-base text-gray-400 sm:pt-4",children:[t!=null&&c.jsx("span",{children:t}),t!=null&&s!=null&&c.jsx("span",{className:"px-2",children:"â€¢"}),s!=null&&c.jsx(Hb,{value:s,month:"long",year:"numeric",day:"numeric"})]}),c.jsx(dN,{shouldShowCodeInterpreterDisclaimer:o,shouldShowPersonalizedDataDisclaimer:d})]})}const dN=({shouldShowCodeInterpreterDisclaimer:n,shouldShowPersonalizedDataDisclaimer:e})=>c.jsxs(c.Fragment,{children:[n&&c.jsx("div",{className:"mt-4",children:c.jsx(Zc,{icon:gr,children:c.jsx(D,{id:"sharedConversation.advancedDataAnalysisSupportDisclaimer",defaultMessage:"This chat contains files or images produced by Advanced Data Analysis which are not yet visible in Shared Chats."})})}),e&&c.jsx("div",{className:"mt-4",children:c.jsx(Zc,{icon:gr,children:c.jsx(D,{id:"sharedConversation.personalizedDataDisclaimer",defaultMessage:"This conversation may reflect the link creatorâ€™s personalized data, which isnâ€™t shared and can meaningfully change how the model responds."})})})]}),uN=n=>{const e=Kn();return y.useCallback(t=>{var a,l;mx(t);const{target:s}=t;if(!(s instanceof Element))return;const i=(a=s.closest("[data-message-id]"))==null?void 0:a.getAttribute("data-message-id"),r=(l=document.getSelection())==null?void 0:l.toString(),o=I.getServerThreadId(n);!i||!r||!o||e||Ee.submitImplicitMessageFeedback({source:"keyboard",type:"copy",messageId:i,serverThreadId:o,selectedText:r})},[n,e])};function hN({onChangeItemInView:n,onRequestMoreCompletions:e,onChangeRating:t,onRequestCompletion:s,clientThreadId:i,conversationLeafId:r,inlineEmbeddedDisplay:o,initiallyHighlightedMessageId:a,hideHeader:l}){const d=Wt(),u=Fr(),h=gx(),[f]=yx(),m=Ts(i),p=Nn(),g=Ql(i),S=d.store.useContentAreaDimensions(Ei.Header,z=>z!=null&&z.height?z.height:void 0),x=d.store.useIsHeaderContentAreaPopulated(),w=Cf(i),{isArchived:C}=w,k=LT(g.id),v=(m==null?void 0:m.kind)===De.GizmoMagicCreate?"bg-token-main-surface-primary text-token-text-primary":k,T=vf(i,r),A=Ho(),L=y.useCallback(()=>{h({behavior:"smooth"})},[h]),_=uN(i),N=A&&!C;return c.jsxs("div",{onCopy:_,className:K("flex flex-col text-sm",u&&"pt-2",N&&"pb-[120px]",S||N?null:"md:pb-9"),style:{paddingBottom:N?void 0:S},children:[!l&&(u||(p==null?void 0:p.data))&&!o&&c.jsx(Nm,{clientThreadId:i}),u&&!o&&c.jsx(hc,{children:c.jsx(cN,{clientThreadId:i})}),[...new Array(T).keys()].map(z=>c.jsx(iN,{isFinalTurn:z===T-1,turnIndex:z,clientThreadId:i,conversationLeafId:r,onChangeItemInView:n,onChangeRating:t,onRequestMoreCompletions:e,onRequestCompletion:s,currentModelId:g.id,showInlineEmbeddedDisplay:o,initiallyHighlightedMessageId:a,avatarClassName:v,scrollToBottom:L},z)),!f&&!o&&c.jsx(fN,{className:K(S?null:"bottom-5",N?x?"translate-y-[-50px]":"translate-y-[-10px]":""),style:{bottom:A?"calc(var(--composer-bar_footer-current-height) + var(--composer-bar_current-height))":S},onClick:()=>{$e.logEvent("chatgpt_thread_scroll_to_bottom"),h({behavior:"smooth"})},children:c.jsx(lk,{className:"icon-md text-token-text-primary"})})]})}const fN=ze.button`cursor-pointer absolute z-10 rounded-full bg-clip-padding border text-token-text-secondary border-token-border-light right-1/2 translate-x-1/2 bg-token-main-surface-primary w-8 h-8 flex items-center justify-center`;function sh(n,e){n.updateNodeMetadata(e.id,{completionSampleFinishTime:Date.now()})}class pN{constructor(e,t,s,i,r,o,a,l,d,u,h,f){X(this,"currentTree");X(this,"currentNodeId");X(this,"firstResponse",!0);X(this,"didCreateFirstCompletionInNewThread",!1);X(this,"activeBranchLastMessage");X(this,"messagesToUpdate",{});X(this,"allIncompleteStreamedMessages",{});X(this,"responseThreadId");X(this,"isCompletionBlocked",!1);X(this,"isEitherFlagged",!1);X(this,"variantsInStreamInfo");X(this,"activeBranchNodeId");X(this,"blurDuringCompletionTracker",new bx);X(this,"completionLatencyTracker");X(this,"turnTracker");X(this,"debouncedUpdateCompletion",Vl(()=>{this.isCompletionBlocked||I.updateTree(this.clientThreadId,e=>{Object.values(this.messagesToUpdate).forEach(t=>{e.updateNodeMessage(t.id,t)})}),this.messagesToUpdate={}},50,{leading:!0,maxWait:50}));X(this,"handleResponse",async e=>{if(this.turnTracker.onUpdateEventCount(),this.completionLatencyTracker.onResponse(e,this.activeBranchLastMessage,this.responseThreadId),this.responseThreadId===void 0&&"conversationId"in e){const t=e.conversationId;this.responseThreadId=t,ms(this.clientThreadId)&&I.getServerThreadId(this.clientThreadId)!==t&&(I.setServerIdForNewThread(this.clientThreadId,t),$.logEvent(V.attributeClientThreadToServerThread,{client_thread_id:this.clientThreadId,server_thread_id:t}))}switch(e.type){case"error":this.handleError(e);break;case"num_variants_in_stream":this.bindVariantInfoToTree(e);break;case"moderation":this.handleModeration(e);break;case"url_moderation":this.handleUrlModeration(e);break;case"message":this.handleMessage(e),this.debouncedUpdateCompletion();break;case"done":this.handleDone();break;case"gizmo_inline_review":this.handleGizmoInlineReview(e);break;case"title_generation":this.handleTitleGeneration(e);break;case"conversation_detail_metadata":this.handleConversationDetailMetadata(e);break}});this.queryClient=e,this.clientThreadId=t,this.targetNodeId=s,this.completionType=i,this.model=r,this.eventSource=o,this.navigate=a,this.callModelAgain=d,this.onCompletionFinished=u,this.isHistoryAndTrainingDisabled=f,this.currentTree=I.getTree(t),this.currentNodeId=s,this.activeBranchLastMessage=this.currentTree.getMessage(this.currentNodeId),this.completionLatencyTracker=new xx(l),this.turnTracker=h,this.turnTracker.onCompletionStarted(i,this.model)}handleError(e){const t=e.error,s=(t==null?void 0:t.message)||"Something went wrong",i=t instanceof Gn&&t.code||"",r=t instanceof Gn&&t.status,o=t instanceof Gn?t.canRetry:void 0;switch(this.turnTracker.handleRawError(s,r),I.updateTree(this.clientThreadId,a=>{a.updateNodeMessage(this.currentNodeId,this.activeBranchLastMessage),a.updateNodeMetadata(this.currentNodeId,{err:s,errType:"danger",errCode:i,completionSampleFinishTime:Date.now(),canRetry:o})}),i){case zt.ContentPolicy:case zt.ContentOrTos:case ko:case ff:break;default:s!==void 0&&$e.logEvent("chatgpt_conversation_error_web",s)}this.blurDuringCompletionTracker.onMessageError(),this.cleanUp(),this.onCompletionFinished(this.responseThreadId),t instanceof Gn&&(t==null?void 0:t.code)===ko&&(t!=null&&t.clearsIn)&&(Sx(new Date(Date.now()+t.clearsIn*1e3).toISOString()),setTimeout(()=>{kx()},t.clearsIn*1e3))}handleGizmoInlineReview(e){I.setPromptGptRating(this.clientThreadId,e.gizmoId)}handleTitleGeneration(e){I.setTitle(this.clientThreadId,e.title,yf.Generated)}handleConversationDetailMetadata(e){const{default_model_slug:t}=e;t&&I.setThreadModelId(this.clientThreadId,t),pr.updateDetails(e)}bindVariantInfoToTree(e){this.variantsInStreamInfo=e,I.updateTree(this.clientThreadId,t=>{const s=t.getParentPromptNode(this.currentNodeId);t.updateNodeMetadata(s.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}handleModeration(e){const{isCompletion:t,messageId:s,conversationId:i,flagged:r,blocked:o,disclaimers:a,metadata:l}=e,d=!!(a!=null&&a.length)&&t;(r||o||d)&&(this.isEitherFlagged=!0,o&&t&&(this.isCompletionBlocked=!0),I.updateTree(this.clientThreadId,u=>{const h=u.messageIdToNodeId(s);o&&u.clearNodeMessageParts(h),u.updateNodeMetadata(h,{...(d&&!!(a!=null&&a.length)&&Gb(a,o))??{},...r&&qb,...o&&(l!=null&&l.model_incompatibility?$b:Kb),completionSampleFinishTime:Date.now()})}),$.logEvent(t?o?V.completionBlockedByModeration:V.completionFlaggedByModeration:o?V.promptBlockedByModeration:V.promptFlaggedByModeration,{threadId:i,id:s}))}handleUrlModeration(e){const{conversationId:t,url:s,isSafe:i}=e;i&&I.addThreadSafeUrl(t,s)}handleMessage(e){var r,o,a,l,d,u,h,f,m,p,g,S,x;let t=!0;const{message:s,conversationId:i}=e;if((s==null?void 0:s.author.role)===Se.Tool?this.turnTracker.onMessageUpdate((r=s.metadata)==null?void 0:r.model_slug,(o=s.metadata)==null?void 0:o.gizmo_id,s.author.name):this.turnTracker.onMessageUpdate((a=s.metadata)==null?void 0:a.model_slug,(l=s.metadata)==null?void 0:l.gizmo_id,void 0),this.firstResponse&&!this.currentTree.hasReceivedServerCompletion){if((s==null?void 0:s.author.role)===Se.System){const w=(d=s.metadata)!=null&&d.parent_id?this.currentTree.getNodeByIdOrMessageId(s.metadata.parent_id):void 0;if((w==null?void 0:w.message.author.role)!==Se.User){this.currentTree.appendSystemMessageToRoot(s);return}}else if((s==null?void 0:s.author.role)===Se.User)return;if(this.currentTree.hasNodeOrMessageId(s.id))return}if(this.firstResponse&&((u=s.metadata)!=null&&u.rebase_system_message)){I.updateTree(this.clientThreadId,w=>{var k;if(((k=s.metadata)==null?void 0:k.parent_id)==null)throw Error("Unexpected rebased system message without parent");const C=w.getNodeByIdOrMessageId(this.targetNodeId);w.deleteNode(this.targetNodeId),w.addNode(s.id,s,s.metadata.parent_id,s.author.role),w.addNode(C.id,C.message,s.id,C.message.author.role)});return}if(this.firstResponse){const w=((h=Jn.getState().threads[this.clientThreadId])==null?void 0:h.continuingFromSharedConversationId)!=null;I.removeContinuingFromSharedConversationId(this.clientThreadId),this.firstResponse=!1,this.didCreateFirstCompletionInNewThread=!this.currentTree.hasReceivedServerCompletion||w,I.updateTree(this.clientThreadId,k=>{k.updateNodeMessage(this.currentNodeId,s)}),this.didCreateFirstCompletionInNewThread&&Za.onCreate(this.navigate,i,this.queryClient,this.isHistoryAndTrainingDisabled);const C={id:this.targetNodeId,threadId:i,completionType:this.completionType,eventSource:this.eventSource,model:this.model};if(this.completionType===Cn.Next){const k=Jn.getState().threads[i],v=(f=k==null?void 0:k.conversationTurns)==null?void 0:f.length,T=(m=k==null?void 0:k.conversationTurns)==null?void 0:m.filter(L=>L.role==Se.User),A=T&&((p=T[T.length-1])==null?void 0:p.messages[0].message);if((A==null?void 0:A.content.content_type)==Zt.Text){const L=A.content.parts.join("").length,_=(T==null?void 0:T.length)??0;C.countConversationTurns=v,C.countUserSubmittedMessages=_,C.countLastUserPromptTextMessageLength=L}}$.logEvent(V.generateCompletion,C)}else if(this.completionType!==Cn.Continue){const w=this.currentTree.containsNodeOrMessageId(s.id),C=(g=s.metadata)==null?void 0:g.parent_id;if(w||(this.debouncedUpdateCompletion.flush(),I.updateTree(this.clientThreadId,k=>{if(C==null)throw new Error(`Received a message with no parentId: ${JSON.stringify(s)}`);k.addNode(s.id,s,C,Se.Assistant)})),C!=null&&C===this.activeBranchNodeId){const k=this.allIncompleteStreamedMessages[C];k!=null&&(I.updateTree(this.clientThreadId,v=>{sh(v,k)}),delete this.allIncompleteStreamedMessages[C])}if(t=(((S=this.variantsInStreamInfo)==null?void 0:S.num_variants_in_stream)??1)===1||this.activeBranchNodeId==null||this.activeBranchNodeId===s.id||this.currentTree.isAncestorOfNode(this.activeBranchNodeId,s.id),t&&this.activeBranchNodeId!==s.id){this.activeBranchNodeId=s.id,this.currentNodeId=s.id;const k=I.getThreadCurrentLeafId(this.clientThreadId);this.currentTree.messageIdToNodeId(this.currentNodeId)!==this.currentTree.messageIdToNodeId(k)&&I.setThreadCurrentLeafId(this.clientThreadId,this.currentNodeId),C!=null&&I.updateTree(this.clientThreadId,v=>{const T=v.getParentPromptNode(s.id);v.updateNodeMetadata(T.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}}if((s==null?void 0:s.author.role)===Se.Tool&&(s==null?void 0:s.author.name)==="bio"){const w=(x=s.metadata)==null?void 0:x.gizmo_id;setTimeout(()=>{this.queryClient.invalidateQueries({queryKey:wx(w)})},5e3)}t&&(this.activeBranchLastMessage=s),this.messagesToUpdate[s.id]=s,this.allIncompleteStreamedMessages[s.id]=s}async handleDone(){var e,t;if(this.turnTracker.logCompletion({type:Ja.Success}),this.isCompletionBlocked||(this.debouncedUpdateCompletion.flush(),this.isEitherFlagged||(this.didCreateFirstCompletionInNewThread&&Za.onCreateFinished(this.queryClient,this.responseThreadId,this.isHistoryAndTrainingDisabled),this.onCompletionFinished(this.responseThreadId))),I.updateTree(this.clientThreadId,s=>{Object.values(this.allIncompleteStreamedMessages).forEach(i=>{sh(s,i)})}),Gl.publish({kind:"createConversation",clientThreadId:this.clientThreadId}),this.blurDuringCompletionTracker.onMessageDone(),this.cleanUp(),((t=(e=this.activeBranchLastMessage)==null?void 0:e.metadata)==null?void 0:t.client_actions)!==void 0){const s=await Cx(this.clientThreadId,this.activeBranchLastMessage);s.length>0&&this.callModelAgain(this.currentNodeId,s)}}cleanUp(){setTimeout(()=>{zS(this.clientThreadId,rc.FINISHED),qo.removeRequest(this.targetNodeId),I.releaseThread(this.clientThreadId)},0)}}const mN=1e3*30,Wa=mf.getTracer("completion"),Ha=n=>(n==null?void 0:n.code)==="challenge_required";class Ga extends Error{}function gN(n,e,t,s){const i=async(r=null,o=!1)=>{var j,H,Q,B,U,O;await vx();const a=new AbortController,l="threadId"in e?e.threadId:void 0,d="continueFromSharedConversationId"in e?e.continueFromSharedConversationId:void 0,u=Or(),h={action:e.completionType,messages:e.messages.length>0?e.messages:void 0,conversation_id:l,continue_from_shared_conversation_id:l!=null?void 0:d,parent_message_id:e.parentMessageId,model:e.model,timezone_offset_min:new Date().getTimezoneOffset(),variant_purpose:(j=e.completionMetadata)==null?void 0:j.variantPurpose,suggestions:(H=e.completionMetadata)!=null&&H.suggestions?e.completionMetadata.suggestions.map(R=>OS(R)):void 0,history_and_training_disabled:e.historyDisabled,juice:(Q=e.completionMetadata)==null?void 0:Q.juice,conversation_mode:(B=e.completionMetadata)==null?void 0:B.conversationMode,force_paragen:e.forceParagen,force_paragen_model_slug:e.forceParagenModel,force_nulligen:e.forceNulligen,force_indepth_feedback:e.forceIndepthFeedback,force_rate_limit:e.forceRateLimit,reset_rate_limits:e.resetRateLimits,disable_system_content_toggling:e.disableSystemContentToggling,websocket_request_id:u,source:(U=e.completionMetadata)==null?void 0:U.source,system_hints:(O=e.completionMetadata)==null?void 0:O.systemHints,force_use_sse:!gs.isWebsocketConnected(),conversation_origin:e.conversationOrigin,force_use_search:e.forceUseSearch,client_contextual_info:e.contextualInfo},f=Xh(await Qh(n));let m="https://chatgpt.com/backend-api";f&&(m="https://chatgpt.com/backend-anon");const p=`${m}/conversation`;let g=!0,S=!0;const x=f?od.getUnauthHeaders().additionalHeaders:await od.getAuthedHeaders(),w=Jb(e.chatReq,r??e.arkoseToken,e.turnstileToken,e.proofToken,null),C={...x,...Mx(),...w};let k,v,T;Wa.startActiveSpan("completion.response",R=>{k=Wa.startSpan("completion.first_response"),v=Wa.startSpan("completion.first_token"),T=R});const A=mf.setSpan(ad.active(),T);function L(R){if(R.data==="[DONE]")a.abort(),T.end(),t({type:"done"}),ed();else if(R.event!=="ping")try{const M=JSON.parse(R.data);if(M.error){const F=new ts(M.error);throw t({type:"error",error:F}),F}else"type"in M?M.type==="gizmo_inline_review"?t({type:"gizmo_inline_review",gizmoId:M.gizmo_id}):M.type==="title_generation"?t({type:"title_generation",title:M.title,conversation_id:M.conversation_id}):M.type==="moderation"?t({type:"moderation",conversationId:M.conversation_id,messageId:M.message_id,isCompletion:M.is_completion,flagged:M.moderation_response.flagged,blocked:M.moderation_response.blocked,disclaimers:M.moderation_response.disclaimers,metadata:M.moderation_response.metadata}):M.type==="url_moderation"?t({type:"url_moderation",conversationId:M.conversation_id,messageId:M.message_id,url:M.url_moderation_result.full_url,isSafe:M.url_moderation_result.is_safe}):M.type==="num_variants_in_stream"?t({type:"num_variants_in_stream",num_variants_in_stream:M.num_variants_in_stream,display_treatment:M.display_treatment}):M.type==="conversation_detail_metadata"&&t(M):(t({type:"message",message:M.message,conversationId:M.conversation_id}),S&&(S=!1,k.end()),g&&M.message.author.role==="assistant"&&M.message.content.content_type==="text"&&M.message.content.parts[0]!==""&&(g=!1,v.end()))}catch(M){if(M instanceof Gn)throw new ts(M.message)}}let _=null,N=setTimeout(()=>{_===!0?($.logEvent(V.asyncResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:Ja.Error,error:{reason:"timeout",message:"Async Response Took Too Long to Come Back"}})):_===!1&&($.logEvent(V.sseResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:Ja.Error,error:{reason:"timeout",message:"SSE Response Took Too Long to Come Back"}}))},mN);return Kk(u,L,a.signal),ad.with(A,()=>Tx(p,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...C},body:JSON.stringify(h),signal:a.signal,openWhenHidden:!0,async onopen(R){var J;const M=R.headers.get("content-type")??"",F=R.headers.get("Cf-Ray")??null;if(R.ok&&M.includes("text/event-stream")){_=!1,s(F,e.model,e.turnTracker);return}else if(M.includes("application/json")){const Z=await R.json(),{webSocketUrl:se,fallbackWebSocketUrl:he,conversationId:Ie,responseId:xe,expiresAt:Pe,websocketRequestId:Ke}=$k(Z);if(se!=null&&Ie!=null&&xe!=null&&Ke!=null&&Pe){_=!0,s(F,e.model,e.turnTracker);try{await Jk(se,he,Pe,Ie,xe,Ke,L,a.signal,N)}catch(E){E instanceof ts&&t({type:"error",error:E})}throw new Ga}else{const E=(Z==null?void 0:Z.error)??(Z==null?void 0:Z.detail),fe=(E==null?void 0:E.message)??E??"Unknown server error";if(E){if(Ha(E))throw new Gn(fe,R.status,E.code);if(R.status>=500)throw new ts(fe);{if(((E==null?void 0:E.code)==="expired_session_key"||(E==null?void 0:E.code)==="invalid_api_key"||(E==null?void 0:E.code)==="token_expired")&&typeof window<"u"&&((J=window._oaiHandleSessionExpired)==null||J.call(window,"stream",JSON.stringify(E))),(E==null?void 0:E.code)==="deactivated_workspace"){window.location.href.includes("/workspace/deactivated")||(window.location.href="/workspace/deactivated");return}const Ue=E==null?void 0:E.can_retry;throw new Gn(fe,R.status,E==null?void 0:E.code,E==null?void 0:E.type,void 0,E==null?void 0:E.clears_in,Ue)}}}}throw new ts(ld)},onmessage:R=>{if(_)throw new ts(ld);N&&(clearTimeout(N),N=null),L(R)},onerror(R){let M=R instanceof Error?R:new Error(JSON.stringify(R));throw M instanceof Ga||_||Ha(M)&&!o||(M.message==="Failed to fetch"&&(M=new ts(`An error occurred. Either the engine you requested does not exist or there was another issue processing your request. ${Ya}`)),M.message==="network error"&&(M=new Gn(`A network error occurred. Please check your connection and try again. ${Ya}`,400)),Yb("fetch-error:conversation:new-message",{url:p,message:M==null?void 0:M.message}),t({type:"error",error:M}),ed(M)),M}})).catch(async R=>{if(Ha(R)){if(o)throw new Gn("Failed to complete your call, please try again",R.status);{const M=await mr.getEnforcementToken(e.chatReq);return i(M,!0)}}R instanceof Ga||(xt.addError(R),e.turnTracker.handleRawError(R.message??"Something went wrong",R.status))}),a};return i()}function yN(n,e,t){const s=Jo(),{resolvedTheme:i}=Xo(),r=i==="dark",o=Rr(),a=y.useRef(t),l=df();a.current=t;const d=y.useCallback(async function({model:u,completionType:h,parentNodeId:f,metadata:m,focusOnNewCompletion:p=!0,completionMetadata:g,chatReq:S,arkoseToken:x,turnstileToken:w,proofToken:C,preflightTime:k,extraStreamParams:v,appendMessages:T,updateTree:A,turnTracker:L}){var Ie,xe,Pe,Ke,E,fe,Ue;Gl.publish({kind:"requestCompletion"});const _=I.getTree(n);I.retainThread(n);const N=wS(),z=`${Qb}${n}-${N}`,j=`${n}-${N}`;A==null||A();const H=_.getNodeByIdOrMessageId(f),B={gizmo_id:(Ie=H.message.metadata)==null?void 0:Ie.gizmo_id};(g==null?void 0:g.juice)!=null&&(B.snorkle_status=1),I.updateTree(n,pe=>{pe.addNode(z,"",f,Se.Assistant,void 0,B)}),p&&I.setThreadCurrentLeafId(n,z);let U,O=[],R=_.getNodeByIdOrMessageId(H.parentId);for(;R!=null&&(((xe=R.metadata)==null?void 0:xe.isPlaceholderTemplateAssistantWelcomeMessage)===!0||((Pe=R.metadata)==null?void 0:Pe.isClientCreatedSystemMessage)===!0);){const pe=R.message;O.unshift(pe);const Fe=_.getNodeByIdOrMessageId(R.parentId);U=((Ke=Fe.message)==null?void 0:Ke.id)??Fe.id,R=Fe}if(h===Cn.Next||h===Cn.Variant){const pe=_.getNodeByIdOrMessageId(H.parentId);if(U??(U=((E=pe.message)==null?void 0:E.id)??pe.id),O.push(H.message),T){let Fe=f;I.updateTree(n,Je=>{for(const ke of T)Je.insertNodeBefore(z,{id:ke.id,message:ke,parentId:Fe,children:[]}),Fe=ke.id}),O.push(...T)}O=xN(O,v)}else U??(U=H.message.id);const M=I.getServerThreadId(n);M===void 0&&ms(n)&&I.updateInitialThreadDataForNewThread(n,u);async function F(pe,Fe){const Je=performance.now(),ke=await sc();mr.initializeAndGatherData(ke),bo.initializeAndGatherData(ke),Mo.initializeAndGatherData(ke),I.updateTree(n,Ae=>{for(const le of Fe)Ae.addNode(le.id,le,pe,Se.Assistant,{completionSampleFinishTime:Date.now()}),pe=le.id}),I.setThreadCurrentLeafId(n,pe);const ot=await mr.getEnforcementToken(ke),ce=await bo.getEnforcementToken(ke),We=await Mo.getEnforcementToken(ke);d({model:u,completionType:Cn.Next,parentNodeId:pe,metadata:{},chatReq:ke,arkoseToken:ot??null,turnstileToken:ce??null,proofToken:We??null,preflightTime:performance.now()-Je,extraStreamParams:v,turnTracker:L})}L.updateAttachmentCount(O);const J=new pN(s,n,z,h,u,m.eventSource,o,j,F,(...pe)=>a.current(...pe),L,l),Z=(pe,Fe,Je)=>{pe&&Je.onReceivedRequestId(pe),_x(j,Fe,pe,k)},se={is_dark_mode:r,time_since_loaded:Math.floor(performance.now()/1e3),page_height:window==null?void 0:window.innerHeight,page_width:window==null?void 0:window.innerWidth,pixel_ratio:window==null?void 0:window.devicePixelRatio,screen_height:(fe=window==null?void 0:window.screen)==null?void 0:fe.height,screen_width:(Ue=window==null?void 0:window.screen)==null?void 0:Ue.width},he=await gN(s,{conversationOrigin:I.getConversationOrigin(n),model:u,completionType:h,threadId:M,continueFromSharedConversationId:e,historyDisabled:l,parentMessageId:U,messages:O,chatReq:S,arkoseToken:x??null,turnstileToken:w??null,proofToken:C??null,completionMetadata:g,...v,turnTracker:L,contextualInfo:se},J.handleResponse,Z);qo.addRequest(z,he,L),zm.onCompletionRequestStarted(z)},[n,s,o,e,l,r]);return d}const xN=(n,e)=>{let t=n;return(e==null?void 0:e.forceUseSearch)===!1&&n.length>0&&(t=n.map(s=>{const{system_hints:i,...r}=s.metadata||{};return{...s,metadata:{...r,system_hints:i==null?void 0:i.filter(o=>o!==fn.Search)}}})),t};function bN({clientThreadId:n,currentModelId:e}){const t=zT(e,Mm.CODE_INTERPRETER);kN(t,n)}async function SN({queryKey:[n,e]}){return await Ee.getThreadInterpreterState(e).then(t=>(t.time_remaining_ms===0&&t.kernel_started&&pn.warning("This advanced data analysis (beta) chat has timed out. You may continue the conversation, but previous files, links, and code blocks below may not work as expected.",{hasCloseButton:!0,duration:0}),t))}function kN(n,e){const t=Fr(),s=I.getServerThreadId(e);return $o({queryKey:["interpreterState",s],queryFn:SN,enabled:!!(n&&s&&!t),gcTime:0})}const wN=60,CN=({children:n,scrollViewClassName:e,scrollAnchorTopOffset:t=0})=>{const s=y.useRef(null);return c.jsx("div",{className:"h-full",ref:s,children:c.jsx(gf,{children:c.jsx(Mk,{className:"h-full",followButtonClassName:"hidden",initialScrollBehavior:"auto",scrollViewClassName:e,scroller:()=>vN(s,t)?0:1/0,children:n})})})},vN=(n,e)=>{const t=MN(n.current);if(t==null)return!1;const s=t>e,i=t<e-wN;return!s&&!i};function MN(n){if(!n)return null;const e=n.querySelector('[data-scroll-anchor="true"]');if(!e)return null;const t=e.getBoundingClientRect().top,s=n.getBoundingClientRect().top;return t-s}const TN=Me(()=>ve(()=>import("./evwrwr9uh973qsn1.js"),__vite__mapDeps([102,1,2,3,7,5,6,8,4,16,17,53,38,52,31,18,10,83,34,63,12,88,89,54,76,90,19,20,21,26,64])).then(n=>n.OpenDebugSidebarButton)),_N=Me(()=>ve(()=>import("./bfh2ch7zx5yqqeeh.js"),__vite__mapDeps([103,1,2,3,5,6,29,8])),{ssr:!1}),NN=Me(()=>ve(()=>import("./sso-bcdhwpqolbad0i57.js").then(n=>n.g),__vite__mapDeps([11,1,2,3,5,6,12,7,8,4,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77])).catch(()=>()=>null),{ssr:!1}),EN=Me(()=>ve(()=>import("./sso-bcdhwpqolbad0i57.js").then(n=>n.P),__vite__mapDeps([11,1,2,3,5,6,12,7,8,4,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77])).then(n=>n.default)),IN=Me(()=>ve(()=>import("./sso-bcdhwpqolbad0i57.js").then(n=>n.j),__vite__mapDeps([11,1,2,3,5,6,12,7,8,4,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77])).then(n=>n.CAFeedbackModal).catch(()=>()=>null)),$n=Ce({doNotShareSensitive:{id:"thread.modal.onboarding.title",defaultMessage:"Do not share sensitive materials with this application"},mayProduceInaccurateInformation:{id:"thread.chatgptMayProduceInaccurateInformation-oct-30",defaultMessage:"ChatGPT can make mistakes. Check important info."},mayProduceInaccurateInformationNoAuth:{id:"thread.chatgptMayProduceInaccurateInformationNoAuth-march-27",defaultMessage:"ChatGPT can make mistakes. Check important info. Read our <termsLink>Terms</termsLink> and <privacyLink>Privacy Policy</privacyLink>."},mayProduceInaccurateInformationNoAuthV2:{id:"thread.chatgptMayProduceInaccurateInformationNoAuth-may-06",defaultMessage:"By messaging ChatGPT, you agree to our <termsLink>Terms</termsLink> and have read our <privacyLink>Privacy Policy</privacyLink>."},mayProduceInaccurateInformationNoAuthKorea:{id:"thread.chatgptMayProduceInaccurateInformationNoAuthKorea-may-06",defaultMessage:"By messaging ChatGPT, you agree to our <termsLink>Terms</termsLink> and have read our <privacyLink>Privacy Policy</privacyLink> and its <koreaAddendumLink>Korea addendum</koreaAddendumLink>."},businessDisclaimer:{id:"thread.businessDisclaimer-oct-30",defaultMessage:"{workspaceName} workspace chats aren't used to train our models. ChatGPT can make mistakes."},businessDisclaimerNoName:{id:"thread.businessDisclaimerNoName-oct-30",defaultMessage:"Your workspace chats aren'ts used to train our models. ChatGPT can make mistakes."},outdatedGptDisclaimer:{id:"thread.outdatedGptDisclaimer.0",defaultMessage:"<bold>New version of GPT available</bold> - Continue chatting to use the old version, or start a <link>new chat</link> for the latest version."},somethingWentWrong:{id:"thread.modal.unrecoverableError.title",defaultMessage:"Something went wrong"},tryAgainLater:{id:"thread.modal.unrecoverableError.description",defaultMessage:"We're sorry, but something went wrong. Please try again later."},resetThread:{id:"thread.modal.unrecoverableError.resetThread",defaultMessage:"Reset thread"},sharedConversationReportConversation:{id:"thread.sharedConversation.report",defaultMessage:"Report conversation"},latencyButton:{id:"thread.latencyButton",defaultMessage:"Latency"},archivedConversationDescription:{id:"thread.archivedConversationDescription",defaultMessage:"This conversation is archived. To continue, please unarchive it first."},unarchiveButton:{id:"thread.unarchiveButton",defaultMessage:"Unarchive"}});function AN({clientThreadId:n}){const e=en(n);return e!=null?c.jsx(jN,{clientThreadId:n,gizmoId:e}):c.jsx(Gm,{clientThreadId:n})}function jN({clientThreadId:n,gizmoId:e}){const t=Ms(e).data,s=Jn(r=>bt.getThreadCreateTime(n,r)),i=(t==null?void 0:t.gizmo.updated_at)!=null?new Date(t.gizmo.updated_at):void 0;return(t==null?void 0:t.gizmo.short_url)==null||i==null||s==null||i<=s?c.jsx(Gm,{clientThreadId:n}):c.jsxs("div",{className:"text-token-text-tertiary",children:[c.jsx(jf,{className:"text-token-secondary mb-1 mr-1 inline-block h-4 w-4 stroke-0"}),c.jsx(D,{...$n.outdatedGptDisclaimer,values:{link:r=>c.jsx(oS,{to:tb(t.gizmo.short_url),className:"underline",children:r}),bold:r=>c.jsx("span",{className:"text-token-secondary font-semibold",children:r})}})]})}function RN({clientThreadId:n}){return xh(t=>t.hasAcceptedFooterDisclaimer)?c.jsx("div",{children:c.jsx(D,{...$n.mayProduceInaccurateInformation})}):c.jsx(DN,{clientThreadId:n})}function Gm({clientThreadId:n}){const e=Co(ql.isBusinessWorkspace),t=Co(l=>l.currentWorkspace),s=t==null?void 0:t.name,{isUnauthenticated:i,isLoading:r}=Ht(),a=Mf({clientThreadId:n,role:Se.User})>0;return r?null:e?c.jsx("div",{children:s!=null?c.jsx(D,{...$n.businessDisclaimer,values:{workspaceName:s}}):c.jsx(D,{...$n.businessDisclaimerNoName})}):i&&!a?c.jsx(gf,{children:c.jsx(RN,{clientThreadId:n})}):c.jsx("div",{children:c.jsx(D,{...$n.mayProduceInaccurateInformation})})}function DN({clientThreadId:n}){const{country:e}=aS(),t=e==="KR"?$n.mayProduceInaccurateInformationNoAuthKorea:$n.mayProduceInaccurateInformationNoAuthV2,{layer:s}=En("3637408529"),i=(s==null?void 0:s.get("should_show_disclaimer_only_once_per_device",!1))??!1;return y.useEffect(()=>()=>{Mf({clientThreadId:n,role:Se.User})>0&&Bx.updateHasAcceptedFooterDisclaimer(i)},[n,i]),c.jsx("span",{className:"text-sm leading-none",children:c.jsx(D,{...t,values:{privacyLink:r=>c.jsx("a",{href:"https://openai.com/privacy",target:"_blank",className:"text-token-text-primary underline decoration-token-text-primary",onClick:()=>{$e.logEvent("chatgpt_footer_disclaimer_privacy_link_clicked"),$.logEvent(V.footerDisclaimerPrivacyLinkClicked)},rel:"noreferrer",children:r}),termsLink:r=>c.jsx("a",{href:"https://openai.com/terms",target:"_blank",className:"text-token-text-primary underline decoration-token-text-primary",onClick:()=>{$e.logEvent("chatgpt_footer_disclaimer_terms_link_clicked"),$.logEvent(V.footerDisclaimerTermsLinkClicked)},rel:"noreferrer",children:r}),koreaAddendumLink:r=>c.jsx("a",{href:"https://openai.com/ko/policies/kr-privacy-policy-addendum",target:"_blank",className:"text-token-text-primary underline decoration-token-text-primary",onClick:()=>{$e.logEvent("chatgpt_footer_disclaimer_korea_addendum_link_clicked"),$.logEvent(V.footerDisclaimerKoreaAddendumLinkClicked)},rel:"noreferrer",children:r})}})})}function ON({clientThreadId:n}){const e=Jo(),t=zi(n),s=async()=>{t&&(await Ee.patchConversation(t,{is_archived:!1}),e.invalidateQueries({queryKey:["conversation",n]}),Jn.setState(i=>{const r=i.threads[t];r!=null&&(r.initialThreadData.isArchived=!1)}),fc(e))};return c.jsxs("div",{className:"my-6 flex flex-col items-center justify-center gap-4",children:[c.jsx("div",{className:"px-3 text-center text-sm text-token-text-secondary",children:c.jsx(D,{...$n.archivedConversationDescription})}),c.jsx("div",{children:c.jsx(ft,{disabled:!t,onClick:s,icon:ck,children:c.jsx(D,{...$n.unarchiveButton})})})]})}function PN(n,e){const t=ms(n),s=I.getTitle(n);return e&&e.kind===De.GizmoInteraction&&e.gizmo?t?`ChatGPT - ${e.gizmo.gizmo.display.name}`:s&&`${e.gizmo.gizmo.display.name} - ${s}`:t?"ChatGPT":s}const vE=function({clientThreadId:n,initiallyHighlightedMessageId:e,continueConversationUrl:t,onCompletionFinished:s,preRequestCompletion:i,hideHeader:r,hideMessages:o,hideFooter:a,hideToolsOverlay:l,messagesVerticalAlign:d="top",prependThreadChildren:u,renderEmptyState:h}){var Zn;const f=Jo(),m=Xb(),p=y.useContext(uf),g=p!=null,S=Nn(),x=Bi(),w=Xl(),C=Ii(),k=na(n),v=jr(),T=g&&((Zn=v.query)==null?void 0:Zn.action)==="moderate",A=dc(n),L=Mn(n),N=Cf(n).isArchived;y.useEffect(()=>{A||(ms(n)?xt.addTiming("chatgpt.web.chatPage.renderNewConversation"):xt.addTiming("chatgpt.web.chatPage.renderExistingConversation"))},[n,A]);const z=CS(n,L),j=vf(n,L),H=wf(n),{setTargetedContent:Q}=Rh(),B=x==null?void 0:x.includes(Zb),U=Nx(),O=j>=2,R=ms(n)&&!O&&ao(k),M=ms(n)&&!z&&(ao(k)||(k==null?void 0:k.kind)===De.GizmoTest),J=Yl().id,Z=Xx(n)??J,{value:se}=Cs("1410082514"),{value:he}=Cs("4203174056"),Ie=Kl(n,tc.Search),xe=qh(Z),Ke=Jl()[Z],E=PN(n,k),fe=Ts(n),Ue=Nr(),pe=Gf(n),{config:Fe}=eS("1013114931"),Je=Fe.get("show_follow_ups",!1)&&(S==null?void 0:S.isPersonalAccount()),ke=!C.displayingSideBySideFeedback&&Je,ot=Kn();y.useEffect(()=>{$a()},[]),y.useEffect(()=>{Ue||Q(void 0),I.getLastMessgageSystemHints(n,L).includes(fn.Search)&&Ie?hr.addPersistedSystemHint(fn.Search):hr.clear()},[n,Q,Ue,L,m.search,Ie]);const ce=y.useCallback(oe=>{if(oe==null||(s==null||s(oe),ot)||((fe==null?void 0:fe.kind)===De.GizmoInteraction&&Zx.handleGizmoInteracted(f,fe.gizmo_id),!(pe||ke)))return;const je=I.getThreadCurrentLeafId(oe),Qe=I.getTree(oe).getMessage(je);tS(Qe)||nS(Qe)||Ex(oe,Qe.id,Z)},[f,s,fe,pe,ke,Z,ot]),We=vS(n),Ae=yN(n,We,ce),le=y.useCallback(()=>{const oe=I.getThreadCurrentLeafId(n);if(oe==null)return;const je=I.getTree(n).getBranchFromLeaf(oe);qo.abortRequests(je.map(Qe=>Qe.id))},[n]),we=ei(),{isUnauthenticated:Gt}=Ht(),In=zh(),et=y.useCallback(async({type:oe,promptId:Ye,requestedModelId:je,eventMetadata:Qe,cancelActiveRequests:Et,focusOnNewCompletion:$t=!0,useDefaultModel:It,completionMetadata:Kt,appendMessages:Pn,updateTree:Fn,turnTracker:ci,extraStreamParams:As})=>{$a(),ph.reset(),Et&&le();const Hi=performance.now();let es=Z;je?es=je:It&&(es=J);const ae=Bh({namespace:So.CompletionRequest,key:Ye});ae==null||ae.logTiming("start_chat_requirements");const Re=await sc();ae==null||ae.logTiming("fetched_chat_requirements"),Re.force_login&&In({authType:"login"});const Ln=await mr.getEnforcementToken(Re);ae==null||ae.logTiming("fetched_arkose_token");const Gi=await bo.getEnforcementToken(Re);ae==null||ae.logTiming("fetched_turnstile_token");const qi=await Mo.getEnforcementToken(Re);ae==null||ae.logTiming("fetched_p_token"),i==null||i(n,Ye),Ae({model:es,completionType:oe,parentNodeId:Ye,metadata:Qe,focusOnNewCompletion:$t,completionMetadata:Kt,chatReq:Re,arkoseToken:Ln??null,turnstileToken:Gi??null,proofToken:qi??null,preflightTime:performance.now()-Hi,extraStreamParams:{forceParagen:we.forceParagen,forceParagenModel:we.forceParagenModel.value,forceNulligen:we.forceNulligen,forceRateLimit:we.forceRateLimit,resetRateLimits:we.resetRateLimits,disableSystemContentToggling:we.rebaseSystemMessageContent?!0:void 0,forceUseSearch:we.forceUseSearch??(As==null?void 0:As.forceUseSearch)},appendMessages:Pn,updateTree:Fn,turnTracker:ci}),Gt&&Ix.incrementUserMessageCount()},[J,Z,i,n,Ae,we.forceParagen,we.forceParagenModel,we.forceNulligen,we.forceRateLimit,we.resetRateLimits,we.rebaseSystemMessageContent,we.forceUseSearch,le,In,Gt]),Tt=!!(S!=null&&S.features.includes(ni.SharedWebsocket));y.useEffect(()=>{Tt&&gs.registerIfNotConnected()},[Tt]),y.useEffect(()=>{const oe=()=>{if(document.visibilityState==="visible"){if(!Tt)return;gs.registerIfNotConnected()}};return document.addEventListener("visibilitychange",oe),()=>{document.removeEventListener("visibilitychange",oe)}},[Tt]);const Te=zi(n);y.useEffect(()=>{const oe=()=>{gs.stopConversation(Te)};return window.addEventListener("beforeunload",oe),()=>{window.removeEventListener("beforeunload",oe)}},[Te]);const Le=eb({clientThreadId:n,currentLeafId:L,handleRequestCompletion:et}),st=y.useCallback((oe,Ye,je,Qe=!0,Et="none",$t)=>{const Kt=I.getTree(n).getParentPromptNode(oe).id;et({type:Cn.Variant,promptId:Kt,eventMetadata:Ye,cancelActiveRequests:!1,focusOnNewCompletion:Qe,useDefaultModel:$t,completionMetadata:{variantPurpose:Et,conversationMode:bt.getConversationMode(n)},turnTracker:je})},[et,n]),Ve=y.useCallback(oe=>{const je=I.getTree(n).getLeafFromNode(oe);I.setThreadCurrentLeafId(n,je.id)},[n]),[Yn,mt]=y.useState(),tn=y.useCallback(({nodeId:oe,messageId:Ye,rating:je})=>{var It,Kt;const Qe=I.getServerThreadId(n);$.logEvent(V.thumbRating,{id:Ye,threadId:Qe,rating:je,model:Z});const Et=I.getTree(n),$t=Et.getNodeByIdOrMessageId(oe);if(Qe!==void 0&&(se&&((It=$t.message.metadata)==null?void 0:It.snorkle_status)!=null?Ee.submitSnorkleFeedback:xe?kn:Ee.submitMessageFeedback)({message_id:Ye,conversation_id:Qe,rating:je}),I.updateTree(n,Pn=>{Pn.updateNodeMetadata(oe,{rating:je})}),xe){mt(c.jsx(IN,{citations:((Kt=$t.message.metadata)==null?void 0:Kt.citations)??[],rating:je,conversationId:Qe??"",messageId:Ye,onSubmit:()=>{mt(void 0)},onCancel:()=>mt(void 0),conversationTree:Et,nodeId:oe},`${oe}-${je}`));return}},[n,Z,xe,se]),{setShowReferralInviteModal:qt}=td(oe=>({setShowReferralInviteModal:oe.setShowReferralInviteModal})),_t=y.useCallback(()=>{qt(!1)},[qt]),Qn=td(oe=>oe.showReferralInviteModal);bN({clientThreadId:n,currentModelId:Z});const Wi=oe=>g?c.jsx("div",{className:"h-full overflow-auto bg-token-main-surface-primary",children:oe}):c.jsx(CN,{scrollAnchorTopOffset:r?0:Lx,children:d==="bottom"?c.jsxs("div",{className:"flex h-full flex-col",children:[c.jsx("div",{className:"flex-1"}),oe]}):oe});y.useEffect(()=>{document.title=E??"ChatGPT"},[E]);const ii=en(n),ri=Kn(),oi=wT(),gn=M&&!h&&w&&!ii&&!xe&&!ri,Es=gn&&oi,An=kT(gn),jn=CT(Es),me=gn&&An||Es&&jn,Is=An||jn,{composerBarSize:Nt,composerSkeleton:ai,footerBarSize:Xn,isClippedComposerBar:yn,setComposerBarElement:li,setFooterBarElement:Rn,ThreadSizeWrapper:Dn}=Ax({isArchived:N}),On=yn?{footerBarSize:Xn,composerBarSize:Nt}:{};return c.jsxs(Dn,{...On,children:[B&&c.jsx(_N,{}),he&&c.jsx(EN,{}),c.jsxs(sS,{children:[E!=null&&c.jsx("title",{children:E}),g&&c.jsxs(c.Fragment,{children:[c.jsx("meta",{property:"og:site_name",content:"ChatGPT"}),c.jsx("meta",{name:"robots",content:p.isIndexable?"index,nofollow":"noindex,nofollow"},"robots"),c.jsx("meta",{property:"og:title",content:E??"Shared Chat on ChatGPT"},"og:title"),c.jsx("meta",{property:"og:description",content:"Shared "+(H!=null?`by ${H} `:"")+"via ChatGPT"},"og:description"),c.jsx("meta",{property:"og:image",content:iS.src},"og:image")]})]}),(k==null?void 0:k.kind)===De.GizmoInteraction&&k.gizmo&&c.jsx(MS,{gizmo:k.gizmo}),c.jsx(ic.Provider,{value:et,children:c.jsxs(jx,{children:[c.jsxs(Z0,{clientThreadId:n,currentModelConfig:Ke,className:"composer-parent flex h-full flex-col focus-visible:outline-0",children:[!o&&c.jsx(FN,{className:K(yn&&"masked-content"),style:{"--composer-bar_skeleton":ai},children:!A&&!Le?M?h??c.jsx(cd,{shouldSSR:!Is,children:c.jsx(r_,{clientThreadId:n,currentModelId:Z,onRequestCompletion:et,enableV2Homepage:me})}):O?Wi(c.jsxs(c.Fragment,{children:[u,c.jsx(hN,{onChangeItemInView:Ve,onRequestMoreCompletions:st,onChangeRating:tn,onRequestCompletion:et,clientThreadId:n,initiallyHighlightedMessageId:e,inlineEmbeddedDisplay:!1,conversationLeafId:L,hideHeader:r},n)]})):null:null}),c.jsx(LN,{className:K(yn&&"mask-scrollbars absolute bottom-0 z-20"),children:N?c.jsx(ON,{clientThreadId:n}):c.jsxs("div",{className:K(yn&&"relative mx-auto flex max-w-3xl flex-1 flex-col"),children:[yn?c.jsx(Rx,{skeleton:ai}):null,g?c.jsx(OT,{clientThreadId:n,isModeratingThread:T,continueConversationUrl:t}):!me&&c.jsx(cd,{shouldSSR:!Is,children:c.jsx(yT,{clientThreadId:n,isNewThread:R,setComposerBarElement:li,showPromptStarters:R||!z,currentModelId:Z,onRequestCompletion:et})}),!a&&c.jsx("div",{ref:Rn,className:"relative w-full px-2 py-2 text-center text-xs text-token-text-secondary empty:hidden md:px-[60px]",children:g?c.jsx(Dx,{onClickReportSharedConversation:()=>{Ai.openModal(fr.ReportConversation)}}):ao(k)&&c.jsx("div",{className:"min-h-4",children:c.jsx(AN,{clientThreadId:n})})})]})})]}),!l&&c.jsxs("div",{className:"group absolute bottom-2 end-2 z-20 hidden gap-1 md:flex lg:bottom-3 lg:end-3",children:[U?c.jsxs(c.Fragment,{children:[c.jsx(TN,{}),c.jsx(NN,{})]}):null,c.jsx(Sk,{})]}),Yn,c.jsx(TS,{serverThreadId:(p==null?void 0:p.serverSharedThreadId)??void 0,clientThreadId:n,isStaticSharedThread:g}),c.jsx(RT,{clientThreadId:n}),c.jsx(Ox,{}),(x==null?void 0:x.includes(rS))&&c.jsx(Px,{isOpen:Qn,onClose:_t}),c.jsx(Fx,{conversationId:n,currentModelId:Z})]})})]})},FN=ze.div`grow flex-1 overflow-hidden`,LN=ze.div`md:pt-0 dark:border-white/20 md:border-transparent md:dark:border-transparent w-full`;export{hN as $,hs as A,aE as B,Il as C,Ge as D,xi as E,Ur as F,Ru as G,vE as H,dE as I,t1 as J,Bm as K,K_ as L,ki as M,sC as N,na as O,si as P,CE as Q,ut as R,uC as S,Uc as T,wE as U,kE as V,CN as W,cE as X,Hw as Y,bp as Z,lN as _,Lt as a,Lc as a0,D0 as a1,fE as a2,pE as a3,mE as a4,QT as a5,Dk as a6,mw as a7,P as a8,Ut as a9,q as aa,uo as ab,bc as ac,oE as ad,_k as ae,$f as af,iN as ag,yT as b,_s as c,Bt as d,ye as e,ra as f,vC as g,jC as h,Nw as i,Cm as j,xl as k,Wf as l,wn as m,Qk as n,de as o,_M as p,BM as q,fM as r,yE as s,xE as t,yN as u,hE as v,gE as w,lE as x,I0 as y,uE as z};
//# sourceMappingURL=k6n3qo2ha5hmjqc2.js.map
