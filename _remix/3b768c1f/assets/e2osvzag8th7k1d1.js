const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/bb8bdhepry4v4att.js","assets/kx5kvg0igqglf8xo.js","assets/cli8x6zszfmaexxv.js","assets/root-ddartmnc.css","assets/bd4152l3nqyzjx1e.js","assets/n0xnu42ro5xj12e5.js","assets/conversation-small-eplmind9.css","assets/kfnpuksrkycemrgh.js","assets/blj952st4lc6a9wz.js","assets/lvgh43b71oae62f0.js","assets/nm04jgpfyxi6pn12.js","assets/bentk5z2xkfujb2z.js","assets/lowbdytu5zy79x9j.js","assets/shared-mk6ngktc.css","assets/ei9mqg0w7s3imcr3.js","assets/gikvl1vwkbgekv0f.js","assets/f7zqs1mewqsxvvfc.js","assets/c1csm9jxlbgpbhue.js","assets/b6x0ypxp3a3jj7cx.js","assets/ci1t1l1sy4j3vkea.js","assets/hak3y6rvfhmuyk7a.js","assets/m3d1mk4p43nozw0q.js","assets/mp5t05df0qqgk6qi.js","assets/gvhedx1z940ws0ku.js","assets/fek4y207m3vot07f.js","assets/m2tjoougbdqrdtzt.js","assets/mxdjh61y3xesdbpe.js","assets/grkj4ermy5wi620u.js","assets/ds6owpzlziucdhg2.js","assets/b8s7c1mhbotcoo3v.js","assets/sso-m465dltvmezan4z2.js","assets/b82de212a0spfynq.js","assets/izchi2tbtbjw9p0h.js","assets/otc9ylb2dp8h7u0k.js","assets/eq3mz4dwxxvc2s6a.js","assets/ipbo83jogmc2va08.js","assets/hx4eij2etje2xaa8.js","assets/lpl1gbnt8svr15i0.js","assets/jshkyv68mp8q03by.js","assets/o3etluibmieklnxx.js","assets/oi9lkdyvi3xl4b0r.js","assets/ia739odua8teo00o.js","assets/kqwdyvkaaavvn8k3.js","assets/gu80y22ii4dy7sva.js","assets/n9pxrwgzlmjlrcsc.js","assets/j3puesntt8tghr70.js","assets/dpemdrx9mvjxxtug.js","assets/hlj9zeh3al0rcy03.js","assets/o2drzv81auvy3uoc.js","assets/fk7vqjt6p46ulrk0.js","assets/eg7c1ahfkv5xrh0r.js","assets/gp7nchea0puhqh2y.js","assets/itaqebqsdis08iut.js","assets/dvij1olmkigff10y.js","assets/e7dzt854572lst61.js","assets/fri41iocyfgxjwee.js","assets/nhwwej1nq0zrd7sc.js","assets/bxcz9y7usj9jlewr.js","assets/om9o5rsqo9vowucd.js","assets/hke4a74nl6rzsurl.js","assets/isjdmfmhzv09v01t.js","assets/hdgpmdni5mp5hbyg.js","assets/ij74yh7euy3m8zyw.js","assets/eawef5lxze5rwpkv.js","assets/nc9bjtwqnubf4esx.js","assets/f7ikscttns8dm5ls.js","assets/d5vbmcojroka4765.js","assets/oeczedvpkci3452m.js","assets/n9axzzwzmkv1usvn.js","assets/nv68ik61ji9akhmm.js","assets/iej0cupg2dqkmejt.js","assets/eg7wfcrmuf0ktl6n.js","assets/jk8w36bsokizpx57.js","assets/abw70xih93bm3xl6.js","assets/ls2aela1lcvso4gc.js","assets/jfcpzofmlyqnqdm6.js","assets/jppb2lvefqhofxvf.js","assets/ej1ds6505f0kiveu.js","assets/m9ewpqye9zagiohg.js","assets/hs6hdinfkom0f5lu.js","assets/ndl1gxz6tl9vi791.js","assets/k7xt1s30nzx5u06w.js","assets/cbuzulxvpny03b7v.js","assets/n9vrl6eqojufxnuz.js","assets/carousel-bss5aguy.css","assets/sso-e9dukfxt.css","assets/i37r6mslsggndhdp.js","assets/nwdgitps5715fjrr.js","assets/hiq2uqvms9k44pw9.js","assets/kv7lcod20q85em5w.js","assets/jyta38vthxkl9at4.js","assets/kkq6ejkwcpz47e34.js","assets/c9pp4qxhkprqxxy5.js","assets/m9wo85w1zzfrhnjm.js","assets/mrkfan8chb2kdpoq.js","assets/nr3txwuk5i1y7ib1.js","assets/dspzz6qecxpomkde.js"])))=>i.map(i=>d[i]);
var Go=Object.defineProperty;var Ho=(t,e,s)=>e in t?Go(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var z=(t,e,s)=>Ho(t,typeof e!="symbol"?e+"":e,s);import{R as Ze,a4 as De,bX as We,g5 as xs,cV as qo,P as O,A as E,bQ as Ce,g6 as ea,fi as ta,ak as He,O as Ae,j as a,r as u,K as U,bz as yn,H as re,e4 as Vo,c as G,bO as Wo,fL as $o,B as wt,aU as Ko,bt as kt,bv as sa,g7 as na,fF as ys,x as aa,a5 as Zo,L as yt,N as Re,as as js,fB as Yo,fR as oa,aN as Ms,y as _n,u as ia,bT as ra,c2 as ce,bV as Jo,J as _t,en as Qo,cN as Se,g8 as Rs,bH as ca,a7 as Vt,b_ as Wt,bZ as ke,U as Xo,V as ei,W as ti,Q as si,ax as ni,dc as ai,g9 as Es,cJ as oi,bD as Jt,X as la,a_ as ii,fc as Ht,dG as ri,fN as da,eH as vn,aM as ua,cs as ci,eG as li,fd as di,c$ as ma,d0 as $t,d1 as _s,eu as ui,ga as mi,aC as fi,gb as hi,fJ as gi,e8 as Ke,fp as fa,f3 as ha,E as ga,fC as vt,e5 as pi,aQ as xi,cm as fe,cK as yi,gc as _i,gd as vi,w as Si,cz as pa,d9 as As,c0 as Ns,c8 as Qt,aO as bi,aP as wi,cn as ki,br as Ge,fD as Ci,ge as Ii,gf as Ti,gg as ji,gh as Mi,gi as xa,ag as Ri,a2 as Sn,gj as Ei,gk as bn,gl as wn,gm as Ai,gn as Ni}from"./kx5kvg0igqglf8xo.js";import{i_ as Pi,i$ as ye,j0 as Di,j1 as qt,j2 as Dt,j3 as Fi,j4 as ya,a7 as Oi,dO as Li,bM as Xt,aC as es,eB as Bi,gu as _a,eC as Ps,j5 as zi,cQ as ts,n as Ds,j6 as Ui,j7 as va,b3 as Kt,eE as Ne,bU as Fs,j8 as Fe,u as Os,A as ct,cs as Gi,cv as Hi,b6 as qi,aY as Vi,aM as Wi,cr as $i,hW as Ki,ia as Zi,j9 as Yi,i7 as St,ja as he,jb as Sa,jc as vs,fM as Ji,jd as Qi,je as Xi,jf as er,jg as tr,b5 as ba,jh as sr,hP as wa,ap as ka,ji as nr,eN as ar,ca as ss,iV as or,e6 as Ca,aa as ir,jj as rr,il as cr,jk as Ia,eG as ns,iZ as bt,jl as $e,iR as tt,jm as us,jn as lr,a3 as dr,jo as kn,jp as Ta,jq as Zt,jr as Ls,js as Bs,jt as ja,ju as Ma,e1 as Ra,iT as Ea,d$ as Aa,e0 as Na,jv as ur,jw as mr,ix as zs,jx as fr,jy as Pa,iy as Us,jz as Gs,jA as Ft,jB as hr,jC as gr,jD as pr,hT as Yt,G as Da,jE as xr,jF as yr,jG as _r,cC as vr,hB as Sr,hA as Fa,eP as br,hz as wr,jH as Oa,jI as kr,hv as Ss,dV as it,cl as Cr,cj as Ir,jJ as Tr,jK as jr,eH as Mr,jL as Rr,jM as Er,B as Ar,ak as La,jN as Nr,jO as Cn,r as bs,i8 as Pr,jP as Dr,a8 as Fr,Y as In,av as Ba,jQ as Or,jR as Lr,jS as Br,jT as zr,jU as Ur,cO as za,e2 as Gr,g9 as Hr,ew as Tn,jV as qr,jW as Vr,jX as Wr,p as $r,hM as Kr,hq as ws,hr as Zr,jY as Yr,g6 as Hs,jZ as Jr,cP as Qr,aq as jn,j_ as Xr,ao as A,j$ as ec,k0 as tc,k1 as sc,id as nc,ie as ac,hX as oc,hQ as ic,gp as rc,hj as Ot,k2 as ms,k3 as cc,hh as lc,hm as dc,hn as qs,k4 as uc,k5 as mc,C as fc,k6 as xt,k7 as hc,k8 as gc,k9 as pc,ka as xc,kb as yc,gZ as Ua,e3 as _c,E as vc,bL as Sc,kc as bc,cp as wc,kd as kc,ke as Cc,x as Ic,kf as Tc,kg as jc,cw as Mc,kh as ks,Z as Ga,ki as Rc,kj as Ec,kk as Ac,kl as Nc,km as Mn,kn as Pc}from"./n0xnu42ro5xj12e5.js";import{q as Vs,d as Oe,T as C,H as Ha,Y as Dc,b as as,f as qa,w as lt,u as dt,e as Fc,c as Va,g as Oc,Q as Lc,k as Bc,Z as zc,_ as Uc,A as Gc,h as Hc,$ as qc,a0 as Vc,i as Wa,a1 as Wc}from"./ei9mqg0w7s3imcr3.js";import{a4 as $a,bA as $c,aa as Ka,c0 as Kc,R as Zc,bi as Yc,c1 as Jc,Z as Ws,ae as Qc,c2 as Xc,aH as el,bS as Za,ag as tl,z as sl,a3 as nl}from"./cli8x6zszfmaexxv.js";import{d as $s,U as al,h as ol,J as Ya,V as il,H as rl,u as cl,W as ll,X as dl,Y as ul,Z as ml,y as fl}from"./c1csm9jxlbgpbhue.js";import{a as hl}from"./b6x0ypxp3a3jj7cx.js";import{m as ge}from"./kfnpuksrkycemrgh.js";import{u as gl,P as pl,I as xl}from"./ci1t1l1sy4j3vkea.js";import{D as X}from"./lowbdytu5zy79x9j.js";import{r as Ja,e as yl,f as _l}from"./m3d1mk4p43nozw0q.js";import{t as vl,i as Qa,f as Sl,h as Xa,u as eo,T as bl,M as wl,a as kl,j as Cl}from"./fek4y207m3vot07f.js";import{G as Il}from"./hak3y6rvfhmuyk7a.js";import{L as Tl,G as jl,O as Ml,Q as Rl,U as Lt,V as El,X as Al,W as Nl,F as Ct,I as to,Y as Pl}from"./m2tjoougbdqrdtzt.js";import{a as Ks}from"./grkj4ermy5wi620u.js";import{i as so,a as Dl,g as Fl,b as Ol,c as Ll}from"./f7zqs1mewqsxvvfc.js";import{s as Bl}from"./gvhedx1z940ws0ku.js";import{g as Rn}from"./ds6owpzlziucdhg2.js";import{r as zl}from"./b8s7c1mhbotcoo3v.js";var no=zl();function Ul(t){if(typeof t!="string")throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!t)throw new Error("No input");const e=JSON.parse(t),s=e;let n;if(s.type==="system")if(s.event==="connected")n=Object.assign(Object.assign({},e),{kind:"connected"});else if(s.event==="disconnected")n=Object.assign(Object.assign({},e),{kind:"disconnected"});else return null;else if(s.type==="message")if(s.from==="group"){const o=An(e.data,e.dataType);if(o===null)return null;n=Object.assign(Object.assign({},e),{data:o,kind:"groupData"})}else if(s.from==="server"){const o=An(e.data,e.dataType);if(o===null)return null;n=Object.assign(Object.assign({},e),{data:o,kind:"serverData"})}else return null;else if(s.type==="ack")n=Object.assign(Object.assign({},e),{kind:"ack"});else return null;return n}function Gl(t){let e;switch(t.kind){case"joinGroup":{e={type:"joinGroup",group:t.group,ackId:t.ackId};break}case"leaveGroup":{e={type:"leaveGroup",group:t.group,ackId:t.ackId};break}case"sendEvent":{e={type:"event",event:t.event,ackId:t.ackId,dataType:t.dataType,data:En(t.data,t.dataType)};break}case"sendToGroup":{e={type:"sendToGroup",group:t.group,ackId:t.ackId,dataType:t.dataType,data:En(t.data,t.dataType),noEcho:t.noEcho};break}case"sequenceAck":{e={type:"sequenceAck",sequenceId:t.sequenceId};break}default:throw new Error(`Unsupported type: ${t.kind}`)}return JSON.stringify(e)}function En(t,e){switch(e){case"text":{if(typeof t!="string")throw new TypeError("Message must be a string.");return t}case"json":return t;case"binary":case"protobuf":{if(t instanceof ArrayBuffer)return no.Buffer.from(t).toString("base64");throw new TypeError("Message must be a ArrayBuffer")}}}function An(t,e){if(e==="text"){if(typeof t!="string")throw new TypeError("Message must be a string when dataType is text");return t}else{if(e==="json")return t;if(e==="binary"||e==="protobuf"){const s=no.Buffer.from(t,"base64");return s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength)}else return null}}class Hl{constructor(){this.isReliableSubProtocol=!0,this.name="json.reliable.webpubsub.azure.v1"}parseMessages(e){return Ul(e)}writeMessage(e){return Gl(e)}}const ql=()=>new Hl;var we;(function(t){t.Stopped="Stopped",t.Disconnected="Disconnected",t.Connecting="Connecting",t.Connected="Connected",t.Recovering="Recovering"})(we||(we={}));class Vl{nextAckId(){return this._ackId=this._ackId+1,this._ackId}constructor(e,s){this._quickSequenceAckDiff=300,this._activeTimeoutInMs=2e4,this._emitter=new Pi,this._isStopping=!1,this._isInitialConnected=!1,typeof e=="string"?this._credential={getClientAccessUrl:e}:this._credential=e,s==null&&(s={}),this._buildDefaultOptions(s),this._options=s,this._messageRetryPolicy=new Nn(this._options.messageRetryOptions),this._reconnectRetryPolicy=new Nn(this._options.reconnectRetryOptions),this._protocol=this._options.protocol,this._groupMap=new Map,this._ackMap=new Map,this._sequenceId=new Kl,this._state=we.Stopped,this._ackId=0}async start(e){if(this._isStopping)throw new Error("Can't start a client during stopping");if(this._state!==we.Stopped)throw new Error("Client can be only started when it's Stopped");let s;e&&(s=e.abortSignal),this._activeKeepaliveTask||(this._activeKeepaliveTask=this._getActiveKeepaliveTask());try{await this._startCore(s)}catch(n){throw this._changeState(we.Stopped),this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0),this._isStopping=!1,n}}async _startFromRestarting(e){if(this._state!==we.Disconnected)throw new Error("Client can be only restarted when it's Disconnected");try{ye.verbose("Staring reconnecting."),await this._startCore(e)}catch(s){throw this._changeState(we.Disconnected),s}}async _startCore(e){if(this._changeState(we.Connecting),ye.info("Staring a new connection"),this._sequenceId.reset(),this._isInitialConnected=!1,this._lastCloseEvent=void 0,this._lastDisconnectedMessage=void 0,this._connectionId=void 0,this._reconnectionToken=void 0,this._uri=void 0,typeof this._credential.getClientAccessUrl=="string"?this._uri=this._credential.getClientAccessUrl:this._uri=await this._credential.getClientAccessUrl({abortSignal:e}),typeof this._uri!="string")throw new Error(`The clientAccessUrl must be a string but currently it's ${typeof this._uri}`);await this._connectCore(this._uri)}stop(){this._state===we.Stopped||this._isStopping||(this._isStopping=!0,this._wsClient&&this._wsClient.isOpen()?this._wsClient.close():this._isStopping=!1,this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0))}on(e,s){this._emitter.on(e,s)}off(e,s){this._emitter.removeListener(e,s)}_emitEvent(e,s){this._emitter.emit(e,s)}async sendEvent(e,s,n,o){return await this._operationExecuteWithRetry(()=>this._sendEventAttempt(e,s,n,o),o==null?void 0:o.abortSignal)}async _sendEventAttempt(e,s,n,o){var i;if(!((i=o==null?void 0:o.fireAndForget)!==null&&i!==void 0?i:!1))return await this._sendMessageWithAckId(l=>({kind:"sendEvent",dataType:n,data:s,ackId:l,event:e}),o==null?void 0:o.ackId,o==null?void 0:o.abortSignal);const c={kind:"sendEvent",dataType:n,data:s,event:e};return await this._sendMessage(c,o==null?void 0:o.abortSignal),{isDuplicated:!1}}async joinGroup(e,s){return await this._operationExecuteWithRetry(()=>this._joinGroupAttempt(e,s),s==null?void 0:s.abortSignal)}async _joinGroupAttempt(e,s){const n=this._getOrAddGroup(e),o=await this._joinGroupCore(e,s);return n.isJoined=!0,o}async _joinGroupCore(e,s){return await this._sendMessageWithAckId(n=>({group:e,ackId:n,kind:"joinGroup"}),s==null?void 0:s.ackId,s==null?void 0:s.abortSignal)}async leaveGroup(e,s){return await this._operationExecuteWithRetry(()=>this._leaveGroupAttempt(e,s),s==null?void 0:s.abortSignal)}async _leaveGroupAttempt(e,s){const n=this._getOrAddGroup(e),o=await this._sendMessageWithAckId(i=>({group:e,ackId:i,kind:"leaveGroup"}),s==null?void 0:s.ackId,s==null?void 0:s.abortSignal);return n.isJoined=!1,o}async sendToGroup(e,s,n,o){return await this._operationExecuteWithRetry(()=>this._sendToGroupAttempt(e,s,n,o),o==null?void 0:o.abortSignal)}async _sendToGroupAttempt(e,s,n,o){var i,r;const c=(i=o==null?void 0:o.fireAndForget)!==null&&i!==void 0?i:!1,l=(r=o==null?void 0:o.noEcho)!==null&&r!==void 0?r:!1;if(!c)return await this._sendMessageWithAckId(f=>({kind:"sendToGroup",group:e,dataType:n,data:s,ackId:f,noEcho:l}),o==null?void 0:o.ackId,o==null?void 0:o.abortSignal);const m={kind:"sendToGroup",group:e,dataType:n,data:s,noEcho:l};return await this._sendMessage(m,o==null?void 0:o.abortSignal),{isDuplicated:!1}}_getWebSocketClientFactory(){return new Di}async _trySendSequenceAck(){if(!this._protocol.isReliableSubProtocol)return;const[e,s]=this._sequenceId.tryGetSequenceId();if(e&&s){const n={kind:"sequenceAck",sequenceId:s};try{await this._sendMessage(n)}catch{this._sequenceId.tryUpdate(s)}}}_connectCore(e){if(this._isStopping)throw new Error("Can't start a client during stopping");return new Promise((s,n)=>{const o=this._wsClient=this._getWebSocketClientFactory().create(e,this._protocol.name);o.onopen(()=>{if(this._isStopping){try{o.close()}catch{}n(new Error("The client is stopped"))}ye.verbose("WebSocket connection has opened"),this._changeState(we.Connected),this._protocol.isReliableSubProtocol&&(this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),this._sequenceAckTask=new Pn(async()=>{await this._trySendSequenceAck()},1e3)),s()}),o.onerror(i=>{this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),n(i)}),o.onclose((i,r)=>{this._state===we.Connected?(ye.verbose("WebSocket closed after open"),this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),ye.info(`WebSocket connection closed. Code: ${i}, Reason: ${r}`),this._lastCloseEvent={code:i,reason:r},this._handleConnectionClose.call(this)):(ye.verbose("WebSocket closed before open"),n(new Error(`Failed to start WebSocket: ${i}`)))}),o.onmessage(i=>{const r=d=>{if(this._ackMap.has(d.ackId)){const v=this._ackMap.get(d.ackId);this._ackMap.delete(d.ackId);const x=d.error!=null&&d.error.name==="Duplicate";d.success||x?v.resolve({ackId:d.ackId,isDuplicated:x}):v.reject(new Dt("Failed to send message.",{ackId:d.ackId,errorDetail:d.error}))}},c=async d=>{if(this._connectionId=d.connectionId,this._reconnectionToken=d.reconnectionToken,!this._isInitialConnected){if(this._isInitialConnected=!0,this._options.autoRejoinGroups){const v=[];this._groupMap.forEach(x=>{x.isJoined&&v.push((async()=>{try{await this._joinGroupCore(x.name)}catch(h){this._safeEmitRejoinGroupFailed(x.name,h)}})())});try{await Promise.all(v)}catch{}}this._safeEmitConnected(d.connectionId,d.userId)}},l=d=>{this._lastDisconnectedMessage=d},m=d=>{if(d.sequenceId!=null){const v=this._sequenceId.tryUpdate(d.sequenceId);if(v===0)return;v>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitGroupMessage(d)},f=d=>{if(d.sequenceId!=null){const v=this._sequenceId.tryUpdate(d.sequenceId);if(v===0)return;v>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitServerMessage(d)};let g;try{let d;if(Array.isArray(i)?d=Buffer.concat(i):d=i,g=this._protocol.parseMessages(d),g===null)return}catch(d){throw ye.warning("An error occurred while parsing the message from service",d),d}Array.isArray(g)||(g=[g]),g.forEach(d=>{try{switch(d.kind){case"ack":{r(d);break}case"connected":{c(d);break}case"disconnected":{l(d);break}case"groupData":{m(d);break}case"serverData":{f(d);break}}}catch(v){ye.warning(`An error occurred while handling the message with kind: ${d.kind} from service`,v)}})})})}async _handleConnectionCloseAndNoRecovery(){this._state=we.Disconnected,this._safeEmitDisconnected(this._connectionId,this._lastDisconnectedMessage),this._options.autoReconnect?await this._autoReconnect():await this._handleConnectionStopped()}async _autoReconnect(){let e=!1,s=0;try{for(;!this._isStopping;)try{await this._startFromRestarting(),e=!0;break}catch(n){ye.warning("An attempt to reconnect connection failed.",n),s++;const o=this._reconnectRetryPolicy.nextRetryDelayInMs(s);if(o==null)break;try{ye.verbose(`Delay time for reconnect attempt ${s}: ${o}`),await qt(o)}catch{}}}finally{e||this._handleConnectionStopped()}}_handleConnectionStopped(){this._isStopping=!1,this._state=we.Stopped,this._safeEmitStopped()}_getActiveKeepaliveTask(){return new Pn(async()=>{this._sequenceId.tryUpdate(0)},this._activeTimeoutInMs)}async _sendMessage(e,s){if(!this._wsClient||!this._wsClient.isOpen())throw new Error("The connection is not connected.");const n=this._protocol.writeMessage(e);await this._wsClient.send(n,s)}async _sendMessageWithAckId(e,s,n){s==null&&(s=this.nextAckId());const o=e(s);this._ackMap.has(s)||this._ackMap.set(s,new $l(s));const i=this._ackMap.get(s);try{await this._sendMessage(o,n)}catch(r){this._ackMap.delete(s);let c="";throw r instanceof Error&&(c=r.message),new Dt(c,{ackId:s})}if(n)try{return await Fi(i.promise(),n)}catch(r){throw r instanceof Error&&r.name==="AbortError"?new Dt("Cancelled by abortSignal",{ackId:s}):r}return await i.promise()}async _handleConnectionClose(){if(this._ackMap.forEach((o,i)=>{this._ackMap.delete(i)&&o.reject(new Dt("Connection is disconnected before receive ack from the service",{ackId:o.ackId}))}),this._isStopping){ye.warning("The client is stopping state. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(this._lastCloseEvent&&this._lastCloseEvent.code===1008){ye.warning("The websocket close with status code 1008. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(!this._protocol.isReliableSubProtocol){ye.warning("The protocol is not reliable, recovery is not applicable"),this._handleConnectionCloseAndNoRecovery();return}const e=this._buildRecoveryUri();if(!e){ye.warning("Connection id or reconnection token is not available"),this._handleConnectionCloseAndNoRecovery();return}let s=!1;this._state=we.Recovering;const n=ya.timeout(30*1e3);try{for(;!n.aborted||this._isStopping;)try{await this._connectCore.call(this,e),s=!0;return}catch{await qt(1e3)}}finally{s||(ye.warning("Recovery attempts failed more then 30 seconds or the client is stopping"),this._handleConnectionCloseAndNoRecovery())}}_safeEmitConnected(e,s){this._emitEvent("connected",{connectionId:e,userId:s})}_safeEmitDisconnected(e,s){this._emitEvent("disconnected",{connectionId:e,message:s})}_safeEmitGroupMessage(e){this._emitEvent("group-message",{message:e})}_safeEmitServerMessage(e){this._emitEvent("server-message",{message:e})}_safeEmitStopped(){this._emitEvent("stopped",{})}_safeEmitRejoinGroupFailed(e,s){this._emitEvent("rejoin-group-failed",{group:e,error:s})}_buildDefaultOptions(e){return e.autoReconnect==null&&(e.autoReconnect=!0),e.autoRejoinGroups==null&&(e.autoRejoinGroups=!0),e.protocol==null&&(e.protocol=ql()),this._buildMessageRetryOptions(e),this._buildReconnectRetryOptions(e),e}_buildMessageRetryOptions(e){e.messageRetryOptions||(e.messageRetryOptions={}),(e.messageRetryOptions.maxRetries==null||e.messageRetryOptions.maxRetries<0)&&(e.messageRetryOptions.maxRetries=3),(e.messageRetryOptions.retryDelayInMs==null||e.messageRetryOptions.retryDelayInMs<0)&&(e.messageRetryOptions.retryDelayInMs=1e3),(e.messageRetryOptions.maxRetryDelayInMs==null||e.messageRetryOptions.maxRetryDelayInMs<0)&&(e.messageRetryOptions.maxRetryDelayInMs=3e4),e.messageRetryOptions.mode==null&&(e.messageRetryOptions.mode="Fixed")}_buildReconnectRetryOptions(e){e.reconnectRetryOptions||(e.reconnectRetryOptions={}),(e.reconnectRetryOptions.maxRetries==null||e.reconnectRetryOptions.maxRetries<0)&&(e.reconnectRetryOptions.maxRetries=Number.MAX_VALUE),(e.reconnectRetryOptions.retryDelayInMs==null||e.reconnectRetryOptions.retryDelayInMs<0)&&(e.reconnectRetryOptions.retryDelayInMs=1e3),(e.reconnectRetryOptions.maxRetryDelayInMs==null||e.reconnectRetryOptions.maxRetryDelayInMs<0)&&(e.reconnectRetryOptions.maxRetryDelayInMs=3e4),e.reconnectRetryOptions.mode==null&&(e.reconnectRetryOptions.mode="Fixed")}_buildRecoveryUri(){if(this._connectionId&&this._reconnectionToken&&this._uri){const e=new URL(this._uri);return e.searchParams.append("awps_connection_id",this._connectionId),e.searchParams.append("awps_reconnection_token",this._reconnectionToken),e.toString()}return null}_getOrAddGroup(e){return this._groupMap.has(e)||this._groupMap.set(e,new Wl(e)),this._groupMap.get(e)}_changeState(e){ye.verbose(`The client state transfer from ${this._state.toString()} to ${e.toString()}`),this._state=e}async _operationExecuteWithRetry(e,s){let n=0;for(;;)try{return await e.call(this)}catch(o){n++;const i=this._messageRetryPolicy.nextRetryDelayInMs(n);if(i==null||(await qt(i),s!=null&&s.aborted))throw o}}}class Nn{constructor(e){this._retryOptions=e,this._maxRetriesToGetMaxDelay=Math.ceil(Math.log2(this._retryOptions.maxRetryDelayInMs)-Math.log2(this._retryOptions.retryDelayInMs)+1)}nextRetryDelayInMs(e){return e>this._retryOptions.maxRetries?null:this._retryOptions.mode==="Fixed"?this._retryOptions.retryDelayInMs:this._calculateExponentialDelay(e)}_calculateExponentialDelay(e){return e>=this._maxRetriesToGetMaxDelay?this._retryOptions.maxRetryDelayInMs:(1<<e-1)*this._retryOptions.retryDelayInMs}}class Wl{constructor(e){this.isJoined=!1,this.name=e}}class $l{constructor(e){this._promise=new Promise((s,n)=>{this._resolve=s,this._reject=n}),this.ackId=e}promise(){return this._promise}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}class Kl{constructor(){this._sequenceId=0,this._isUpdate=!1}tryUpdate(e){if(this._isUpdate=!0,e>this._sequenceId){const s=e-this._sequenceId;return this._sequenceId=e,s}return 0}tryGetSequenceId(){return this._isUpdate?(this._isUpdate=!1,[!0,this._sequenceId]):[!1,null]}reset(){this._sequenceId=0,this._isUpdate=!1}}class Pn{constructor(e,s,n){this._func=e,this._abortController=new ya,this._interval=s,this._obj=n,this._start()}abort(){try{this._abortController.abort()}catch{}}async _start(){const e=this._abortController.signal;for(;!e.aborted;)try{await this._func(this._obj)}catch{}finally{await qt(this._interval)}}}const Zl=1e3*60*60,Yl=1e3*30;class Jl{constructor(e,s,n,o=null,i=new Map){z(this,"client");z(this,"handler");z(this,"terminationTimeout",null);z(this,"connectionUrl");z(this,"expiresAt");z(this,"connected",!1);z(this,"websocketRequestId",null);z(this,"conversationId",null);z(this,"secondaryTypeBasedHandlers",new Map);this.connectionUrl=s,this.expiresAt=n,this.client=new Vl({getClientAccessUrl:()=>e(this.connectionUrl,this.expiresAt)},{autoReconnect:!0,reconnectRetryOptions:{maxRetries:5,retryDelayInMs:100,maxRetryDelayInMs:1e4,mode:"Exponential"}}),this.handler=o,this.secondaryTypeBasedHandlers=i}async start(){const e=s=>{if(this.secondaryTypeBasedHandlers.has(s.message.data.type)){const n=this.secondaryTypeBasedHandlers.get(s.message.data.type);if(!n)return;n(s.message.data)}else{const n=s.message.data.body,o=atob(n).trim();if(o.startsWith("data: ")){const i=o.replace("data: ",""),r=this.handler;if(!r)return;r({conversationId:s.message.data.conversation_id,responseId:s.message.data.response_id,message:{id:"",event:"",data:i},websocketRequestId:s.message.data.websocket_request_id})}}};this.client.on("group-message",s=>e(s)),this.client.on("server-message",s=>e(s)),this.client.on("connected",()=>{this.connected=!0}),this.client.on("disconnected",()=>{this.connected=!1}),await this.client.start()}addSecondaryTypeHandler(e,s){this.secondaryTypeBasedHandlers.set(e,s)}isConnected(){return this.connected}async stop(e){e&&this.conversationId!==e||this.websocketRequestId&&await Ze.stopWebsocketConversation(this.websocketRequestId)}setHandler(e,s,n,o){!this.handler&&this.websocketRequestId===n||(this.handler!=null&&this.websocketRequestId!==n&&(qo.warn("[websockets] Overwriting existing handler without silencing. This may indicate a race condition."),O.logEvent(E.asyncHandlerOverwritten,{originalWebsocketRequestId:this.websocketRequestId,newWebsocketRequestId:n,conversationId:e,responseId:s})),this.websocketRequestId=n,this.conversationId=e,this.handler=i=>{(i.websocketRequestId===n||i.conversationId===e&&i.responseId===s)&&o(i.message)})}silence(){this.handler=null}close(){this.client.stop()}scheduleForTermination(e){this.terminationTimeout=setTimeout(()=>{this.close(),e()},Zl)}preventTermination(){this.terminationTimeout&&(clearTimeout(this.terminationTimeout),this.terminationTimeout=null)}updateConnectionUrl(e,s){this.connectionUrl=e,this.expiresAt=s}}class Ql{constructor(){z(this,"activeSocketMap",new Map);z(this,"secondaryTypeBasedHandlers",new Map)}async register(){const e=await Ze.postRegisterWebsocket();e.wss_url&&(this.getOrCreateSocket(e.wss_url,new Date(e.expires_at),!0),e.fallback_wss_url&&this.getOrCreateSocket(e.fallback_wss_url,new Date(e.expires_at),!1))}async registerIfNotConnected(){if(this.activeSocketMap.size===0){await this.register();return}for(const e of this.activeSocketMap.values())if(!e.isConnected()){await this.register();return}}isWebsocketConnected(){for(const e of this.activeSocketMap.values())if(e.isConnected())return!0;return this.activeSocketMap.size>0&&De.addError("Cannot connect to any websocket."),!1}async getOrCreateSocket(e,s,n){const o=e.split("?")[0];let i;const r=this.activeSocketMap.get(o);if(r&&r.isConnected())r.preventTermination(),r.updateConnectionUrl(e,s),i=r;else{r&&r.close(),i=new Jl(async(c,l)=>{if(new Date<new Date(l.getTime()-5*1e3))return c;const m=await Ze.postRegisterWebsocket();return n?m.wss_url:m.fallback_wss_url??""},e,s,null,this.secondaryTypeBasedHandlers),this.activeSocketMap.set(o,i);try{await i.start()}catch(c){throw De.addError(new Error("Error occurred while starting websocket: ",{cause:c})),c}}return i}preSetupWebsocket(e,s,n){for(const o of this.activeSocketMap.values())this.setupWebSocketHandler(o,null,null,null,e,s,n)}addSecondaryTypeHandler(e,s){this.secondaryTypeBasedHandlers.set(e,s);for(const n of this.activeSocketMap.values())n.addSecondaryTypeHandler(e,s)}hasSecondaryTypeHandler(e){return this.secondaryTypeBasedHandlers.has(e)}async processWebSocketConversationStream(e,s,n,o,i,r,c,l,m){const f=[this.getOrCreateSocket(e,n,!0)];s&&f.push(this.getOrCreateSocket(s,n,!1));const g=await Promise.allSettled(f),d=g[0].status==="fulfilled"?g[0].value:null,v=g.length>1&&g[1].status==="fulfilled"?g[1].value:null;if((!d||!d.isConnected())&&De.addError(`Cannot connect to primary websocket, websocketRequestId: ${r}, token: ${e.substring(0,e.indexOf("access_token="))}`),(!d||!d.isConnected())&&(!v||!v.isConnected()))throw s&&De.addError(`Cannot connect to fallback websocket, websocketRequestId: ${r}, token: ${s.substring(0,s.indexOf("access_token="))}`),new We(`An error occurred while connecting to the websocket. ${xs}`);let x=setTimeout(()=>{De.addError(`WebSocket took too long to respond: ${i}, ${o}, ${r}, ${e.substring(0,60)}...${e.slice(-20)}`,{supportsWebSockets:"WebSocket"in window&&window.WebSocket.CLOSING===2})},Yl);const h=b=>(m&&(clearTimeout(m),m=null),x&&(clearTimeout(x),x=null),c(b));d&&this.setupWebSocketHandler(d,e,o,i,r,h,l),v&&s&&this.setupWebSocketHandler(v,s,o,i,r,h,l)}async stopConversation(e){for(const s of this.activeSocketMap.values())await s.stop(e)}setupWebSocketHandler(e,s,n,o,i,r,c){e.setHandler(n,o,i,r),this.secondaryTypeBasedHandlers.forEach((m,f)=>{e.addSecondaryTypeHandler(f,m)});const l=()=>{s?e.scheduleForTermination(()=>{this.activeSocketMap.delete(s.split("?")[0])}):(this.stopConversation(n),e.silence())};c.addEventListener("abort",l)}}const It=new Ql;function Xl(t){return{webSocketUrl:t.wss_url,fallbackWebSocketUrl:t.fallback_wss_url,conversationId:t.conversation_id,responseId:t.response_id,expiresAt:t.expires_at&&new Date(t.expires_at),websocketRequestId:t.websocket_request_id}}async function ed(t,e,s){return It.preSetupWebsocket(t,e,s)}async function td(t,e,s,n,o,i,r,c,l){return It.processWebSocketConversationStream(t,e,s,n,o,i,r,c,l)}function sd(t){return t==null||[Ce.PrimaryAssistant,Ce.GizmoInteraction].includes(t.kind)}function Zs(t,e){const s=Vs(t,e),{data:n}=$s(s!=null&&"gizmo_id"in s?s.gizmo_id:void 0,(s==null?void 0:s.kind)===Ce.GizmoTest);if(s!=null)switch(s.kind){case Ce.GizmoInteraction:case Ce.GizmoMagicCreate:case Ce.GizmoTest:return{gizmo:n,...s};case Ce.PrimaryAssistant:return s}}function nd(t,e,s){const o=C.getTree(e).getMessageId(C.getThreadCurrentLeafId(e));Ze.generateTitle(e,o,s).then(({title:i})=>{C.setTitle(e,i,Ha.Generated),Ja(t),O.logEvent(E.renameThread,{threadId:e,content:i,model:s})}).catch(De.addError)}function uf(t,e,s){const n=()=>{const i=Rn(s);t(i)},o=Oe.getGizmoId(s);o!=null?al(e,o).then(i=>{Oi(Rn(s,i))}).catch(i=>{De.addError(i),n()}):n()}const Cs={onCreate(t,e,s,n){O.logEvent(E.newThread),!n&&sd(Oe.getConversationMode(e))&&ea(s).then(o=>{ta(o)||(Ja(s),t(e))})},onCreateFinished(t,e,s){var n;if(!(s||!e)&&!He.checkGate("2562876640")){const o=(n=Oe.getThread(e))==null?void 0:n.initialThreadData.lastModelUsed;o==null&&De.addError("missing lastModelUsed on conversation create finished"),nd(t,e,o)}}},Dn=Ae.div`m-8 flex flex-col items-center`;function Fn(t){return a.jsx(ge.div,{initial:{opacity:0,translateY:20},animate:{opacity:1,translateY:0,transition:{duration:.5,ease:"easeIn"}},...t})}function ad({clientThreadId:t}){const e=Dc(t),s=e==null?void 0:e.gizmoId,{data:n}=$s(s);return s==null||n==null||!Li(n)?null:a.jsx(od,{gizmoId:s})}function od({gizmoId:t}){const[e,s]=u.useState(!1),[n,o]=u.useState(!1),i=ol(t),r=async l=>{s(!0),setTimeout(()=>{o(!0)},5e3),O.logEvent(E.submitInlineRating,{gizmo_id:t,rating:l}),await i.mutateAsync({rating:l})},c=async()=>{o(!0),O.logEvent(E.dismissInlineRating,{gizmo_id:t}),await i.mutateAsync({})};return u.useEffect(()=>{n||O.logEvent(E.showInlineRating,{gizmo_id:t})},[n,t]),n?null:e?a.jsx(Dn,{children:a.jsxs(Fn,{className:"flex flex-col items-center gap-4",children:[a.jsx("div",{className:"rounded-lg border border-token-border-heavy p-4",children:a.jsxs("div",{className:"flex justify-between gap-2",children:[a.jsx(U,{id:"gizmo.inlineReview.reviewLeft",defaultMessage:"Feedback sent"}),a.jsx(yn,{onClick:()=>{o(!0)}})]})}),a.jsx("div",{className:"text-xs text-token-text-tertiary",children:a.jsx(U,{id:"gizmo.inlineReview.reviewLeftSubtext",defaultMessage:'To update your rating, click "Send Feedback" in the GPT Menu'})})]})}):a.jsx(Dn,{children:a.jsxs(Fn,{className:"flex flex-col items-center gap-4 rounded-lg border border-token-border-heavy p-4",children:[a.jsxs("div",{className:"flex justify-between gap-2",children:[a.jsx(U,{id:"gizmo.inlineReview.prompt",defaultMessage:"How would you rate this GPT so far?"}),a.jsx(yn,{onClick:c})]}),a.jsx(hl,{rating:void 0,onRating:r})]})})}function id(t,e){const s=Xt(es.MentionGPTs),n=Bi(),[o,i]=u.useState(!1),r=()=>{i(!0),s.markAsViewed()};return u.useImperativeHandle(e,()=>({handleClose:r})),s.eligible&&!s.isLoading&&!n?a.jsx(rd,{wasDismissed:o,onDismiss:r}):null}function rd({wasDismissed:t,onDismiss:e}){const s=re(),{recent:n,pinned:o}=gl(),i=n&&n.pages.flatMap(r=>r.list.items).length>0||o&&o.items.length>0;return u.useEffect(()=>{i&&O.logEvent(E.mentionsDisplayNux)},[i]),i?a.jsx(_a,{badge:"beta",align:"start",side:"top",arrowPadding:58,show:!t,title:s.formatMessage({id:"mentionGptsAnnouncement.title",defaultMessage:"GPT mentions"}),onDismiss:e,sideOffset:25,theme:"default",description:a.jsx(U,{id:"mentionGptsAnnouncement.description",defaultMessage:"Type {key} to mention a GPT and add it directly into your conversation",values:{key:a.jsx("span",{className:"font-bold",children:"@"})}}),children:a.jsx("div",{className:"absolute sm:left-16"})}):null}const cd=u.forwardRef(id);function ld({composerController:t}){const{doesUserHaveAnyAccountsWithPlusFeatures:e}=Vo(),s=re(),n=Ps();return a.jsxs("div",{className:G("flex justify-between",!n&&"bg-gradient-to-t from-token-main-surface-primary to-transparent px-4"),children:[a.jsx("div",{className:"flex gap-2",children:a.jsx(ud,{onClickStyle:o=>{Ln(s.formatMessage(o.expandedName??o.name),t)}})}),e&&a.jsx("div",{className:"flex gap-2",children:a.jsx(dd,{onClickAspectRatio:o=>Ln(s.formatMessage(o.expandedName),t)})})]})}function dd({onClickAspectRatio:t}){const e=re();return a.jsxs(X.Root,{onOpenChange:s=>{s&&(He.logEvent(E.dalleOpenAspectRatioDropdown),O.logEvent(E.dalleOpenAspectRatioDropdown))},children:[a.jsxs(Is,{$as:X.Trigger,className:"pr-1.5",children:[a.jsx(U,{id:"dalleControls.aspectRatio",defaultMessage:"Aspect Ratio"}),a.jsx($a,{className:"icon-md"})]}),a.jsx(X.Portal,{children:a.jsx(X.Content,{children:zi.map(s=>a.jsx(X.Item,{onClick:()=>{var n;t(s),He.logEvent(E.dalleClickAspectRatio,(n=s.name.defaultMessage)==null?void 0:n.toString()),O.logEvent(E.dalleClickAspectRatio,{aspectRatio:s.name.defaultMessage})},icon:s.icon,children:e.formatMessage(s.name)},s.name.id))})})]})}function ud({onClickStyle:t}){const[e,s]=u.useState(On()),n=Wo(),o=$o(),i=ts(),r=re();let c=2;return i||(o?c=5:n&&(c=3)),a.jsxs(a.Fragment,{children:[e.slice(0,c).map(l=>a.jsx(Ds,{label:a.jsx(md,{style:l}),side:"top",sideOffset:4,customPaddingClassName:"p-1",children:a.jsxs(Is,{$as:"button",type:"button",onClick:()=>{var m;t(l),He.logEvent(E.dalleClickStyle,(m=l.name.defaultMessage)==null?void 0:m.toString()),O.logEvent(E.dalleClickStyle,{style:l.name.defaultMessage})},children:[a.jsx($c,{className:"h-4 w-4 text-token-text-tertiary"}),r.formatMessage(l.name)]})},l.name.id)),a.jsx(Is,{$as:"button",type:"button",onClick:()=>{s(On()),He.logEvent(E.dalleShuffleStyles),O.logEvent(E.dalleShuffleStyles)},children:a.jsx(Ui,{className:"icon-sm text-token-text-tertiary"})}),va.map(l=>a.jsx("img",{src:l.image.src,alt:r.formatMessage(l.name),width:100,height:100,className:"invisible fixed -left-96 -top-96"},l.name.id))]})}function md({style:t}){const e=re();return a.jsxs("div",{className:"flex flex-col gap-1",children:[a.jsx("img",{src:t.image.src,alt:e.formatMessage(t.name),width:100,height:100,className:"rounded-md"}),a.jsx("div",{className:"text-xs font-medium",children:e.formatMessage(t.name)})]})}function On(){return[...va].sort(()=>Math.random()-.5)}function fd(t,e){const s=e.getCurrentText();return s.trim()===""?t:s.endsWith(",")?` ${t.toLocaleLowerCase()}`:s.endsWith(", ")?t.toLocaleLowerCase():`, ${t.toLocaleLowerCase()}`}function Ln(t,e){const s=fd(t,e);e.appendText(s),Kt()}const Is=Ae.div`h-7 bg-token-main-surface-primary border border-token-border-light text-xs hover:bg-token-main-surface-secondary hover:text-token-text-primary px-2.5 radix-state-open:bg-token-main-surface-secondary radix-state-open:text-token-text-primary rounded-full flex flex-nowrap gap-0.5 items-center text-token-text-secondary font-normal`,Bt={initial:{opacity:0,y:20,scale:.9},animate:{opacity:1,y:0,scale:1},transition:{delay:.1},exit:{opacity:0,scale:.5,transition:{duration:.2}}},hd=({suggestions:t,onSelectingSuggestedReply:e})=>a.jsx("div",{className:"absolute bottom-full flex w-full max-w-[100vw] grow gap-2 overflow-auto px-1 pb-1 contain-inline-size sm:mb-0 sm:justify-start sm:px-2 sm:pb-0 md:static md:mb-2 md:max-w-none md:justify-center md:overflow-visible",children:t.slice(0,2).map((s,n)=>a.jsx(ge.div,{initial:Bt.initial,animate:Bt.animate,transition:{delay:(n-1)*Bt.transition.delay},exit:Bt.exit,children:a.jsx(kt,{as:"button",color:"secondary",size:"small",onClick:()=>{e(s,t,n)},className:"group whitespace-nowrap md:whitespace-normal",children:a.jsx(pd,{suggestion:s})},n)},n))});function gd({suggestions:t,onSelectingSuggestedReply:e,clientThreadId:s}){const n=(t==null?void 0:t.length)>0;u.useEffect(()=>{n&&vl(t,s)},[n,s]);const{isUnauthenticated:o}=wt();return n?t.every(Qa)?a.jsxs(ge.div,{initial:{opacity:0},animate:{opacity:1},transition:{duration:.3},className:"flex flex-col items-center",children:[o&&a.jsx(Ko,{className:"mb-6 h-12 w-12 sm:hidden"}),a.jsx(Sl,{starterPrompts:t,onSelectStarterPrompt:e})]}):t.every(Xa)?a.jsx(hd,{suggestions:t,onSelectingSuggestedReply:e}):null:null}function pd({suggestion:t}){return Xa(t)?a.jsx(a.Fragment,{children:t.text}):Qa(t)?a.jsxs("div",{className:"flex flex-col overflow-hidden",children:[t.title&&a.jsx("div",{className:"truncate font-semibold",children:t.title}),a.jsx("div",{className:G("truncate font-normal",t.title?"opacity-50":""),children:t.body})]}):null}function xd(){const{store:t}=Ne(),e=t.useSharedProps();return e?a.jsx(yd,{...e}):null}function yd({clientThreadId:t,suggestions:e}){const s=eo();return e===void 0||e.length===0?null:a.jsx("div",{children:a.jsx(_d,{children:a.jsx("div",{className:"grow",children:e!==void 0&&a.jsx(gd,{suggestions:e,onSelectingSuggestedReply:s,clientThreadId:t})})})})}const _d=Ae.div`h-full flex ml-1 md:w-full md:m-auto gap-0 md:gap-2 justify-center`,ao=({className:t,children:e})=>a.jsx(ge.div,{className:t,initial:{opacity:0},animate:{opacity:1},exit:{opacity:0,transition:{duration:.1,delay:0}},transition:{type:"tween",duration:.3,delay:.2},children:e});function vd({currentLeafId:t,canContinue:e,onContinueGenerating:s}){const n=u.useCallback(()=>{const i=new Fs;s(t,i),Kt()},[s,t]);let o=null;return e&&(o=a.jsx(Sd,{onHandleContinueGenerating:n})),o&&a.jsx("div",{className:"flex h-full w-full items-center justify-end gap-0 py-4 md:gap-2",children:o})}const Sd=({onHandleContinueGenerating:t})=>{const e=sa();return a.jsx(ao,{children:a.jsxs(kt,{as:"button",color:"secondary",onClick:t,className:"whitespace-nowrap border-0 md:border",children:[a.jsx(Ka,{className:G("-rotate-180",e?"icon-xs":"icon-sm")}),e&&a.jsx(U,{...Fe.continueGenerating})]})})},bd=({clientThreadId:t})=>{const e=na(),s=as(t),n=Os(s);u.useEffect(()=>{n&&ys.dismissBanner()},[n]);const o=e!=null&&e.is_dismissible?()=>ys.dismissBanner():void 0;return a.jsx(ct,{children:e&&a.jsx(ge.div,{transition:{type:"tween",ease:"easeInOut",duration:.1},initial:{opacity:0,transform:"translateY(8px)"},animate:{opacity:1,transform:"translateY(0px)"},exit:{opacity:0,transform:"translateY(8px)"},children:a.jsx(pl,{clientThreadId:t,rateLimitInfo:e,onDismiss:o})})})};function wd(t){const e=as(t),s=Os(e),n=na();return!s&&n!=null}const Ue=window.sessionStorage,Ts=aa(Zo(()=>({memoryFullBannerDismissed:!!(Ue!=null&&Ue.getItem(yt.MemoryFullBannerDismissed))}))),oo={dismissBanner(){Ts.setState(t=>{t.memoryFullBannerDismissed=!0}),Ue==null||Ue.setItem(yt.MemoryFullBannerDismissed,"true")},clearDismissedBanner(){Ts.setState(t=>{t.memoryFullBannerDismissed=!1}),Ue==null||Ue.removeItem(yt.MemoryFullBannerDismissed)}};function kd(t){const e=qa(t),s=Gi(),{data:n}=Hi(e,!1,s),o=n!=null,i=o&&n.memoryFullPct>=100,[r,c]=u.useState(!1);u.useEffect(()=>{!i&&o&&(c(!0),oo.clearDismissedBanner())},[i,o]);const l=Ts(m=>m.memoryFullBannerDismissed);return i&&r&&!l}function Cd(){const t=re(),{openSettings:e}=qi();return a.jsx(ge.div,{initial:{opacity:0},animate:{opacity:1},children:a.jsx(Vi,{title:t.formatMessage(zt.memoryFullTitle),content:t.formatMessage(zt.memoryFullTooltip,zt.memoryFullTooltip.values),primaryCtaText:t.formatMessage(zt.memoryManageButton),onPrimaryCtaClick:()=>e(Wi.Personalization),onDismiss:()=>oo.dismissBanner()})})}const zt=Re({memoryFullTitle:{id:"yRGU2/",defaultMessage:"Memory is full."},memoryManageButton:{id:"a5A88o",defaultMessage:"Manage"},memoryFullTooltip:{id:"neUc+N",defaultMessage:"New memories won’t be created until you make space. <a>Learn more</a>",values:{a:t=>a.jsx("a",{href:$i,target:"_blank",rel:"noopener noreferrer",className:"underline",children:t})}}}),Id=()=>{const{shouldShowSkipButton:t}=Ki();return t?a.jsx(ao,{className:"flex justify-center",children:a.jsx(kt,{as:"button",color:"secondary",onClick:()=>Zi.skipParagen(),children:a.jsx(U,{...Td.skip})})}):null},Td=Re({skip:{id:"dvcUbp",defaultMessage:"Skip"}}),jd=u.memo(function({className:e}){const{store:s}=Ne(),n=s.useIsHeaderContentAreaPopulated();return a.jsx("div",{className:G(e??"absolute bottom-full left-0 right-0",vs.PromptTextareaHeader),children:a.jsx(Yi,{shouldRender:n,contentArea:St.Header,children:a.jsxs("div",{className:"mb-2 flex flex-col gap-3.5 pt-2",children:[a.jsx(Md,{}),a.jsx(Rd,{})]})})})});function Md(){const{store:t}=Ne(),e=t.useContentAreaId(St.HeaderTop);let s;switch(e){case he.ParagenControls:s=a.jsx(Id,{});break;case he.ItemActions:s=a.jsx(xd,{});break;case he.BannerSignup:s=a.jsx(Ad,{});break;case he.BannerTermsDisclaimer:s=a.jsx(Nd,{});break;case he.PromptTextareaAction:s=a.jsx(Pd,{});break;case he.BannersRateLimit:s=a.jsx(Dd,{});break;case he.BannerSidekickAnnouncement:s=a.jsx(yl,{});break;case he.BannerMemoryFull:s=a.jsx(Cd,{});break;case he.Box:s=a.jsxs("div",{className:"flex h-20 w-full items-center justify-center gap-2 bg-red-500 p-2",children:["box",a.jsxs("div",{className:"flex h-full w-full items-center justify-center gap-2 bg-blue-500 p-2",children:["inner",a.jsx("div",{className:"flex h-full w-full items-center justify-center bg-yellow-400 text-center",children:"actual content"})]})]});break;default:s=null;break}return s}function Rd(){const{store:t}=Ne(),e=t.useContentAreaId(St.HeaderBottom);let s;switch(e){case Sa.DallePromptControls:s=a.jsx(Ed,{});break;default:s=null;break}return s}function Ed(){const{store:t}=Ne(),e=t.useSharedProps(s=>s==null?void 0:s.composerController);return e?a.jsx(ld,{composerController:e}):null}function Ad(){const{store:t}=Ne(),e=t.useSharedProps(o=>o==null?void 0:o.clientThreadId),s=Ji(),n=Qi();return e?s?a.jsx(Xi,{threadId:e,showSignUp:n}):a.jsx(er,{threadId:e,showLogin:n}):null}function Nd(){const{store:t}=Ne(),e=t.useSharedProps(s=>s==null?void 0:s.clientThreadId);return e?a.jsx(tr,{threadId:e}):null}function Pd(){const{store:t}=Ne(),e=t.useSharedProps();return e?a.jsx(vd,{...e}):null}function Dd(){const{store:t}=Ne(),e=t.useSharedProps(s=>s==null?void 0:s.clientThreadId);return e?a.jsx(bd,{clientThreadId:e}):null}function Ys(){return oa(Ms.DataAnalysisV2)}function mf(){const t=ba(),e=js();return e&&t&&!Yo(t)&&e.isEnterprise()}function Fd(){return oa(Ms.ChartSerialization)}function ff(t,e){const s=t==="chart"?yt.HasSeenAdaInteractiveChart:yt.HasSeenAdaInteractiveTable,[n,o]=u.useState(_n.getItem(s,{userId:e})??!1),i=u.useCallback(()=>{o(!0),_n.setItem(s,!0,{userId:e})},[s,e]);return[n,i]}function hf(t){const[e,s]=u.useState([]),n=lt(()=>{const o=C.resolveThreadId(t),i=C.getThreadCurrentLeafId(t);return C.getTree(o).getBranchFromLeaf(i)});return u.useEffect(()=>{const o=ro(n);o.length!==e.length&&s(o)},[e.length,t,n]),e}function Od(t){return lt(()=>{const e=C.resolveThreadId(t),s=C.getThreadCurrentLeafId(t),o=C.getTree(e).getBranchFromLeaf(s);return ro(o).length>0})}function io(t){var i,r,c,l;const e=((r=(i=t.metadata)==null?void 0:i.aggregate_result)==null?void 0:r.messages.filter(so))??[];let s=0;const n=(((c=t.metadata)==null?void 0:c.ada_visualizations)??[]).map(m=>{let f=m;return m.type=="chart"&&(f={...m,fallback_image:e[s++]}),f}),o=(((l=t.metadata)==null?void 0:l.attachments)??[]).filter(m=>ka(m.name)).map(m=>({type:"table",file_id:m.id??"",title:nr(m),file_name:m.name,context_connector_info:m.context_connector_info}));return[...n,...o]}function ro(t){return t.filter(s=>{var n,o,i,r;return((n=s.message)==null?void 0:n.author.role)==="tool"&&((o=s.message)==null?void 0:o.author.name)==="python"||(((r=(i=s.message)==null?void 0:i.metadata)==null?void 0:r.attachments)??[]).length>0}).flatMap(s=>io(s.message))}aa(t=>({selectedSpreadsheet:null,setSelectedSpreadsheet:e=>t({selectedSpreadsheet:e})}));async function Ld(t,e,s){const n=await t.text(),{parse:o}=await ce(async()=>{const{parse:r}=await import("./oeujip5i1ptrxie5.js");return{parse:r}},[]),i=o(n);return{content:{columnNames:i.shift(),columnTypes:i[0].map(()=>"string"),rows:i},file_name:e,download_url:s}}function Bd(t){const e=t[0].values.length,s=[];for(let n=0;n<e;n++){const o=t.map(i=>i.values[n]);s.push(o)}return s}function gf(t){return ia({queryKey:["ada-visualization","chart",t.file_id],queryFn:async()=>{const e=await Ze.getFileDownloadLink(t.file_id);if(e.status===ra.Success){const n=await(await fetch(e.download_url)).json();return{content:{chart_type:n.type,title:n.title,labels:n.labels,datasets:n.datasets,x_label:n.x_label,y_label:n.y_label},file_name:e.file_name??"",download_url:e.download_url}}else throw new Error("Failed to download chart json from interpreter")}})}function pf(t){return ia({queryKey:["ada-visualization","table",t.file_id],queryFn:async()=>{if(t.file_name&&sr(t.file_name)){const e=await Ze.getAdaExcelFileContents(t.file_id);return{content:e.sheets.map(s=>({name:s.name,columnNames:s.columns.map(n=>n.name),columnTypes:s.columns.map(()=>"string"),rows:Bd(s.columns)})),download_url:e.download_url,file_name:t.file_name}}else{const e=await Ze.getFileDownloadLink(t.file_id);if(e.status===ra.Success){const s=await fetch(e.download_url);return Ld(s,e.file_name??"",e.download_url)}else throw new Error("Failed to download from interpreter")}}})}function zd(t){const e=wa(),s=Od(t),n=Ys();return s&&n&&!e.displayingSideBySideFeedback}function Ud(t){var e,s;return((s=(e=t.metadata)==null?void 0:e.dalle)==null?void 0:s.prompt)??""}async function Gd(t,e,s="image/png"){return new Promise((n,o)=>{t.toBlob(i=>{i!=null?n(new File([i],e,{type:s})):o(new Error("Failed to convert canvas to blob"))},s)})}async function Hd(t,e){const s=document.createElement("canvas");s.width=t.width,s.height=t.height;const n=s.getContext("2d");if(n==null)throw new Error("Failed to get 2d context for mask canvas");const o=n.createImageData(t.width,t.height);for(let i=0;i<t.data.length;i+=4)t.data[i+3]!==0?(o.data[i]=0,o.data[i+1]=0,o.data[i+2]=0,o.data[i+3]=255):(o.data[i]=255,o.data[i+1]=255,o.data[i+2]=255,o.data[i+3]=255);return n.putImageData(o,0,0),Gd(s,e)}async function qd(t,e){const n=await(await fetch(t)).blob(),o=document.createElement("a");o.href=URL.createObjectURL(n),o.download=e,o.click(),o.remove()}function Vd(t){const e=ir(new Date,"yyyy-MM-dd HH.mm.ss");let s=t.slice(0,150);return s.endsWith(".")&&(s=s.slice(0,-1)),`DALL·E ${e} - ${s}.webp`}async function xf(t,e,s){var i,r,c,l,m,f,g,d,v,x;const n=Ud(t),o=Vd(n);await qd(t.url,o),He.logEvent("chatgpt_dalle_image_download",null,{sourceOperation:((r=(i=t.metadata)==null?void 0:i.dalle)==null?void 0:r.edit_op)??"none",hasParent:((l=(c=t.metadata)==null?void 0:c.dalle)==null?void 0:l.parent_gen_id)!=null?"true":"false"}),O.logEvent(E.dalleImageDownload,{conversationId:e,messageId:s,generationId:(f=(m=t.metadata)==null?void 0:m.dalle)==null?void 0:f.gen_id,parentGenerationId:(d=(g=t.metadata)==null?void 0:g.dalle)==null?void 0:d.parent_gen_id,fileId:ss(t.asset_pointer),sourceOperation:(x=(v=t.metadata)==null?void 0:v.dalle)==null?void 0:x.edit_op})}function Wd(t){const e=Zs(t),s=ts(),n=e&&"gizmo"in e?e.gizmo:void 0;return!s&&(n==null?void 0:n.gizmo.id)===ar}function yf(t,e){var o,i;const s=(i=(o=e.metadata)==null?void 0:o.dalle)==null?void 0:i.gen_id,n=ss(e.asset_pointer);return n==null||s==null?t:{...t,messageMetadata:{...t.messageMetadata,dalle:{from_client:{operation:{type:"transformation",original_gen_id:s,original_file_id:n}}}}}}async function $d(t,e,s){return new Promise((n,o)=>{or(Ca(t),t,e,{kind:Jo.DalleAgent},{onFileCreated:_t,onFileUploadProgress:_t,onFileUploaded:(i,r)=>n(r),onError:(i,r)=>{o(new Error(`Failed to upload file with reason: ${r}`))}},s)})}async function _f(t,e,s,n){var r,c;const o=(c=(r=e.metadata)==null?void 0:r.dalle)==null?void 0:c.gen_id,i=ss(e.asset_pointer);if(i==null||o==null||s==null)return t;try{const l=await Hd(s,"mask.png"),m=await $d(l,n,{imageDimensions:{width:e.width,height:e.height}});return{...t,messageMetadata:{...t.messageMetadata,dalle:{from_client:{operation:{type:"inpainting",original_gen_id:o,original_file_id:i,mask_file_id:m}}}}}}catch(l){return De.addError(l),t}}const Kd=u.memo(function(e){return Zd(e),Yd(e),Jd(),null});function Zd(t){const{store:e}=Ne(),s=e.useSetSharedProps();u.useLayoutEffect(()=>{s(t)},[t,s])}function Yd(t){const{clientThreadId:e,canContinue:s}=t,{store:n}=Ne(),o=u.useRef({top:n.useContentAreaApi(St.HeaderTop),bottom:n.useContentAreaApi(St.HeaderBottom)}).current,i=eu(t),r=Wd(e),{shouldShowBannerSignup:c,shouldShowBannerTermsDisclaimer:l}=tu(e),m=wd(e),f=_l(t),g=kd(e),d=rr();u.useLayoutEffect(()=>{d?o.top.set(he.ParagenControls):l?o.top.set(he.BannerTermsDisclaimer):m?o.top.set(he.BannersRateLimit):f.eligible?o.top.set(he.BannerSidekickAnnouncement):i?o.top.set(he.ItemActions):s?o.top.set(he.PromptTextareaAction):c?o.top.set(he.BannerSignup):g?o.top.set(he.BannerMemoryFull):o.top.set(null)},[o,i,s,l,c,m,f,g,d]),u.useLayoutEffect(()=>{r&&o.bottom.set(Sa.DallePromptControls)},[o,r])}function Jd(){const{store:t}=Ne();u.useEffect(()=>()=>{t.reset()},[t])}function Qd(t){var o,i;const e=Ia(),s=dt(t),n=(i=(o=C.getTree(t).getLastValidNode(s))==null?void 0:o.message)==null?void 0:i.id;return(e==null?void 0:e.messageId)===n?e.suggestions:[]}function Xd(t){return Qd(t).length>0}function eu(t){const e=zd(t.clientThreadId),s=Xd(t.clientThreadId);return t.isDisabled?!1:t.isNewThread||e||s}function tu(t){var g;const{isUnauthenticated:e}=wt(),s=dt(t),{layer:n}=Qo("3637408529"),o=n.get("should_show_no_auth_signup_banner",!0),i=cr(d=>d.bannerDisclaimerClientThreadId),r={shouldShowBannerTermsDisclaimer:!1,shouldShowBannerSignup:!1};if(!t)return r;const c=C.getTree(t),l=c.countMessagesByAuthor(Se.User),m=c.getNodeByIdOrMessageId(s),f=((g=m==null?void 0:m.message)==null?void 0:g.author.role)===Se.Assistant&&Rs(m.message);return r.shouldShowBannerTermsDisclaimer=f&&e&&l===1&&(i==null||i===t),r.shouldShowBannerSignup=o&&f&&e&&l>0&&l%5===0,r}function su(t,e,s,n,o){const{getGizmoId:i}=ns(),[r,c]=u.useState();u.useEffect(()=>{i?i().then(f=>c(f)):c(void 0)},[i]);const l=ca(e);return u.useCallback(f=>{const{docsReferencedByURL:g}=Oe.getThread(t)??{};if(g!=null)for(const d of f){const{id:v,type:x,handler:h}=d,b=`${x}:${v}`,M=g[b],T=bt.getState().files.find(y=>y.tempId===v);if(M!=null&&M!=="failed"&&T){Vt.success(s.formatMessage(fs.fileAlreadyAttached),{hasCloseButton:!0});continue}switch(h.type){case"fetch":{C.updateReferencedDocState(t,b,"pending"),$e.uploadFile(v,new File([],s.formatMessage(fs.fileLoading)),tt.None,n,s,{skipUpload:!0,gizmoId:r},o,{contextConnector:x,sourceUrl:d.url,syntheticExtension:null,type:Wt.Link}),us.linkMetadataFetchStarted(x),h.tryFetch().then(y=>{if($e.remove(v,"none"),y==null)return null;const{id:_,title:k,connector:D,mimeType:N,url:P,syntheticExtension:R,o365DriveId:J}=y;us.linkMetadataFetchSucceeded(x,N),C.updateReferencedDocState(t,b,"fetched");let L=k;D===ke.GDRIVE&&(L=R?`${k}.${R}`:k),$e.uploadFile(_,new File([],L,{type:N.split(";")[0]}),tt.Retrieval,n,s,{gizmoId:r},o,{contextConnector:D,sourceUrl:P,syntheticExtension:R,type:Wt.Link,o365DriveId:J})}).catch(y=>{us.linkMetadataFetchFailed(x,y),Vt.danger(s.formatMessage(fs.fileFetchFailed),{hasCloseButton:!0}),C.updateReferencedDocState(t,b,"failed"),$e.remove(v,"none")});break}case"prompt":{l.appendMessageIfNotDismissed({connector:x,type:h.message}),C.updateReferencedDocState(t,b,"prompted");break}}}},[o,t,l,r,s,n])}const fs=Re({fileLoading:{id:"CCC.fileLoading",defaultMessage:"Loading…"},fileFetchFailed:{id:"CCC.fileFetchFailed",defaultMessage:"Unable to fetch file information"},fileAlreadyAttached:{id:"CCC.fileAlreadyAttached",defaultMessage:"This file is already a part of your message."}}),co=({clientThreadId:t,rateLimitPopup:e,children:s,highlightTooltip:n=!1})=>{const o=re(),i=Fc(t),r=js(),[c,l]=u.useState(n),[m,f]=u.useState(!1),g=u.useCallback(()=>{m||l(!0)},[m]),d=u.useCallback(()=>{l(!1),f(!1)},[]),v=u.useCallback(()=>{l(!1),f(!0)},[]);u.useEffect(()=>{l(n)},[n]);const x=b=>{e!=null&&b&&O.logPopoverHover({type:"rate_limit",location:"file_upload",plan_type:(r==null?void 0:r.planType)??"unknown"})},h=!!e;return a.jsx(a.Fragment,{children:h?a.jsxs(Xo,{delayDuration:150,onOpenChange:x,children:[a.jsx(ei,{children:s}),a.jsx(ti,{children:a.jsx(lr,{$as:si,side:"top",sideOffset:4,className:"max-w-[260px]",children:a.jsx(nu,{isNewConversation:i,rateLimitPopup:e})})})]}):a.jsx(Ds,{sideOffset:14,label:o.formatMessage({id:"oUK/GV",defaultMessage:"Attach file"}),className:"flex",open:c||n,side:"top",children:a.jsx("span",{onPointerEnter:g,onPointerLeave:d,onClick:v,children:s})})})},nu=({isNewConversation:t=!1,rateLimitPopup:e})=>{const s=js(),n=ni();if(e==null)return null;const{call_to_action:o,description:i}=e,r=i||a.jsx(U,{...Bn.defaultDescription}),c=o==null?void 0:o.includes(ai.GET_PLUS);return a.jsxs("div",{className:"p-2 text-sm text-token-text-primary",children:[a.jsx("div",{children:r}),c?a.jsx(kt,{size:"small",color:"secondary",className:"mt-3",onClick:()=>{dr(n,"Rate limited file upload popover"),O.logRateLimitGetPlusButtonClicked({type:"file_upload",location:"popover",plan_type:(s==null?void 0:s.planType)??"unknown",is_hard_block:!1,is_new_conversation:t,hard_block_reason:""})},children:a.jsx(U,{...Bn.getPlus})}):null]})},Bn=Re({defaultDescription:{id:"U5qAWP",defaultMessage:"You've reached your daily upload limit. Get ChatGPT Plus to unlock more."},getPlus:{id:"TeyLcp",defaultMessage:"Get Plus"}});function au({clientThreadId:t,getInputProps:e,openFileDialog:s,uploadType:n,icon:o,highlightTooltip:i=!1}){const r=re(),c=Es(),l=!!c,m=a.jsx(Ta,{className:"mb-1",disabled:l,onClick:d=>{d.preventDefault(),O.logEvent(E.openFileViewer,{intent:n.toString()}),s()},"aria-label":r.formatMessage({id:"PromptFilePicker.attachFiles",defaultMessage:"Attach files"}),children:o}),f=a.jsx("input",{disabled:l,...e({className:"hidden"})}),g=a.jsxs("div",{className:"flex",children:[m,f]});return a.jsx(co,{clientThreadId:t,rateLimitPopup:c,highlightTooltip:i,children:g})}function ou({code:t,message:e}){switch(t){case kn.FileTooLarge:return zn.errorFileTooLarge;case kn.TooManyFiles:return O.logEvent(E.uploadedMaxFilesError),zn.errorTooManyFiles;default:return e}}const zn=Re({attachImages:{id:"PromptFilePicker.attachImages",defaultMessage:"Attach images"},attachFiles:{id:"PromptFilePicker.attachFiles",defaultMessage:"Attach files"},errorFileTooLarge:{id:"PromptFilePicker.errorFileTooLarge",defaultMessage:"Your file is too large. The maximum file size is {size}MB."},errorTooManyFiles:{id:"PromptFilePicker.errorTooManyFiles",defaultMessage:"You may only upload {maxNum} files at a time."},defaultFileUploadRateLimited:{id:"U5qAWP",defaultMessage:"You've reached your daily upload limit. Get ChatGPT Plus to unlock more."},getPlusButton:{id:"TeyLcp",defaultMessage:"Get Plus"}}),Un=Re({dragInstructions:{id:"FileDropZone.dragInstructions",defaultMessage:"Add anything"},dragAllAccepted:{id:"FileDropZone.dragAllAccepted",defaultMessage:"Drop any file here to add it to the conversation"}});function vf(t){var y;const{className:e,children:s,clientThreadId:n,currentModelConfig:o}=t,i=re(),r=Zs(n),c=Zt(o,r),l=c!==tt.None,m=bt(_=>_.files),f=(c===tt.Multimodal?Ls:Bs)-m.length,g=f<=0,{getGizmoId:d}=ns(),{handleFileAccepted:v}=uo(i,Zt(o,r),Ma(o,r),"drag",d,(y=ja(o,r))==null?void 0:y.attachments),x=Es(),h=Ra(Ea(o,r)),{getRootProps:b,isDragActive:M}=Aa({maxFiles:f,disabled:!l||g||x!=null,noClick:!0,onDropAccepted:v,onDropRejected:_=>lo(_,i,c),multiple:!0,maxSize:Na,...h}),I=T();function T(){if(!h.accept||Object.keys(h.accept).length===0)return[];const _=[];return Object.values(h.accept).forEach(k=>_.push(...k)),_.sort()}return a.jsxs("div",{...b({className:e}),children:[s,M&&a.jsxs(iu,{children:[a.jsx(ur,{}),a.jsx("h3",{children:a.jsx(U,{...Un.dragInstructions})}),a.jsx("h4",{className:"w-2/3 text-center",children:I.length>0?I.join(", "):a.jsx(U,{...Un.dragAllAccepted})})]})]})}function lo(t,e,s){const{errors:n}=t[0];n.forEach(o=>{const i=ou(o);typeof i=="string"?Vt.danger(i,{hasCloseButton:!0}):Vt.danger(e.formatMessage(i,{size:mr,maxNum:s===tt.Multimodal?Ls:Bs}),{hasCloseButton:!0})})}function uo(t,e,s,n,o,i){return{handleFileAccepted:u.useCallback(async(c,l)=>{O.logEvent(E.uploadFile,{client:"web",eventSource:n,intent:e.toString()});const m=o!=null?await o():void 0;c.length>0&&c.forEach(f=>{$e.uploadFile(Ca(f),f,e,s,t,{gizmoId:m},i)})},[n,e,o,s,t,i])}}const iu=Ae.div`absolute inset-0 opacity-80 flex gap-2 flex-col justify-center items-center bg-token-main-surface-primary text-token-text-primary`;function mo({children:t,className:e,showBackground:s}){return a.jsxs("div",{className:"relative",children:[t,s&&a.jsx(ge.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:260,damping:20},className:G("pointer-events-none absolute bottom-0 top-0 h-8 w-8 rounded-full",e)})]})}function Gn({entry:t,onClick:e}){const{connectorConfig:s}=zs();u.useEffect(()=>{if(!open||t.type!==ke.GDRIVE)return;const r=s.get(ke.GDRIVE),c=r==null?void 0:r.access_token;c&&fr(c)},[s,t.type]);const n=Pa(t.type),o=re(),i=t.access_token?Hn.uploadFromMessage:Hn.signinWithMessage;return a.jsx(X.Item,{onClick:e,icon:n,children:a.jsxs("div",{className:"flex flex-col",children:[a.jsx(U,{...i,values:{connectorName:Us(t.type,o)}}),t.type===ke.O365_BUSINESS&&a.jsx("div",{className:"text-s text-token-text-tertiary",children:a.jsx(U,{...Gs.includesSharePoint})})]})},t.id)}const Hn=Re({signinWithMessage:{id:"ContextConnectorPickerDropdownItem.signInWithMessage",defaultMessage:"Connect to {connectorName}"},uploadFromMessage:{id:"ContextConnectorPickerDropdownItem.uploadWithMessage",defaultMessage:"Add from {connectorName}"}});function ru({clientThreadId:t,icon:e,setOpen:s,highlightTooltip:n=!1}){const o=Es(),i=!!o,r=re();return a.jsxs(a.Fragment,{children:[a.jsx(X.Trigger,{className:"m-0 h-0 w-0 border-none bg-transparent p-0"}),a.jsx(co,{clientThreadId:t,rateLimitPopup:o,highlightTooltip:n,children:a.jsx(Ta,{className:"mb-1","aria-disabled":i,"aria-label":r.formatMessage({id:"tA7CXR",defaultMessage:"Attach files"}),onClick:c=>{c.preventDefault(),i||s(!0)},children:e})})]})}function cu({connectorEntries:t,onOauthRedirect:e}){const s=re();return a.jsxs(X.Sub,{children:[a.jsx(X.SubMenuTrigger,{icon:Kc,children:a.jsx("div",{className:"line-clamp-1 text-ellipsis",children:a.jsx(U,{...lu.connectApps})})}),a.jsx(X.Portal,{children:a.jsx(X.SubContent,{children:t.map(n=>a.jsx(X.Item,{onClick:()=>e(n),icon:Pa(n.type),children:a.jsxs("div",{className:"flex flex-col",children:[Us(n.type,s),n.type===ke.O365_BUSINESS&&a.jsx("div",{className:"text-s text-token-text-tertiary",children:a.jsx(U,{...Gs.includesSharePoint})})]})},n.id))})})]})}const lu=Re({connectApps:{id:"ContextConnectorPicker.connectApps",defaultMessage:"Connect apps"}});function du({onOauthRedirect:t,connectors:e}){const s=re();return a.jsxs(X.Sub,{children:[a.jsx(X.SubMenuTrigger,{icon:Zc,children:a.jsx(U,{...uu.oneDriveSubmenuName})}),a.jsx(X.Portal,{children:a.jsx(X.SubContent,{children:e.map(n=>n?a.jsx(X.Item,{onClick:()=>t(n),children:a.jsxs("div",{className:"flex flex-col",children:[Us(n.type,s),n.type===ke.O365_BUSINESS&&a.jsx("div",{className:"text-s text-token-text-tertiary",children:a.jsx(U,{...Gs.includesSharePoint})})]})},n.id):null)})})]})}const uu=Re({oneDriveSubmenuName:{id:"ContextConnectorPickerOneDriveSubmenu.oneDriveSubmenuName",defaultMessage:"Connect to Microsoft OneDrive"}});function mu(){const{connectorConfig:t}=zs(),e=Jt(),[s,n]=Yt(Da([...t.values()],m=>!!m.access_token),m=>!!m.access_token),[o,i]=Yt(n,m=>m.type===ke.O365_PERSONAL||m.type===ke.O365_BUSINESS),r=!e&&!Ht&&s.length>0,c=!e&&!Ht&&!r&&o.length>1;return{unconnectedConnectors:Ht?[]:c?i:n,showUnconnectedInSubmenu:r,showOneDriveInSubmenu:c}}function fu({clientThreadId:t,icon:e,modelAcceptedMimeTypes:s,modelSupportedImageMimeTypes:n,attachmentsProductFeature:o,onOauthRedirect:i,uploadType:r,getInputProps:c,openFileDialog:l,highlightTooltip:m=!1}){const{currentLocale:f}=oi(),g=re(),d=Jt(),{connectorConfig:v,isLoading:x}=zs(),h=Xt(es.ContextConnectors),{getGizmoId:b}=ns(),[M,I]=u.useState();u.useEffect(()=>{b?b().then(p=>I(p)):I(void 0)},[b]);const T=u.useRef(null),[y,_]=u.useState(!1),k=u.useRef(!1),D=u.useCallback(()=>{var se;const p=(se=T.current)==null?void 0:se.files;Array.from(p??[]).forEach(de=>Ft.uploadFile(de,n,g,o))},[n,o,g]),[N,P]=u.useState(null),R=u.useCallback(()=>P(null),[P]),J=u.useCallback((p,se)=>Ft.uploadPickedFile(p,se,n,s,o,M,g),[n,s,o,M,g]),{openMenu:L,confirmMenuOpened:H}=hr();u.useEffect(()=>{L&&(_(!0),H())},[L,H,_]);const le=la(),ae=u.useCallback(p=>{Ft.doContextConnectorOauthRedirect(le.asPath,p,i,Wt.Picker),i()},[i,le.asPath]),Z=u.useCallback(p=>{Ft.uploadPickedFile(p,ke.GDRIVE,n,s,o,M,g)},[n,s,o,M,g]),K=u.useCallback(async p=>{const{access_token:se}=p;if(!se){ae(p);return}switch(gr(p,Wt.Picker),p.type){case ke.GDRIVE:pr(f,p.type,se,de=>de.forEach(Z));break;case ke.O365_PERSONAL:case ke.O365_BUSINESS:P(p.type);break}},[Z,ae,P,f]),j=()=>{O.logEvent(E.openFileViewer,{intent:r.toString()}),l()},S=p=>{if(!p&&k.current&&!x)j();else if(p&&Q&&!x){j();return}_(p),p&&(h.eligible&&h.markAsViewed(),O.logEvent(E.composerOpenContextConnectorPicker),k.current=!0,setTimeout(()=>{k.current=!1},250))},[F,ee]=Yt(Da([...v.values()],p=>!!p.access_token),p=>!!p.access_token);hu(F,K);const[ne]=Yt(ee,p=>p.type===ke.O365_PERSONAL||p.type===ke.O365_BUSINESS),{unconnectedConnectors:V,showUnconnectedInSubmenu:pe,showOneDriveInSubmenu:W}=mu(),Q=!F.length&&!V.length,_e=a.jsxs(a.Fragment,{children:[pe&&V.length>0&&a.jsx(cu,{connectorEntries:V,onOauthRedirect:p=>ae(p)}),!pe&&V.map(p=>a.jsx(Gn,{entry:p,onClick:()=>K(p)},p.id)),W&&a.jsx(du,{connectors:ne,onOauthRedirect:ae}),x&&a.jsx(X.Item,{icon:a.jsx(ii,{className:"text-token-text-secondary"})}),(V.length>0||x)&&a.jsx(X.Separator,{}),F.map(p=>a.jsx(Gn,{entry:p,onClick:()=>K(p)},p.id)),a.jsx(X.Item,{onClick:j,icon:Yc,children:a.jsx(U,{...d?qn.uploadFileMobile:qn.uploadFile})},"upload")]}),te=a.jsxs("div",{className:"flex flex-col",children:[a.jsx(xr,{type:N,onClose:R,uploadPickedFile:J}),a.jsx("input",{onChange:D,...c({className:"hidden"})}),a.jsxs(X.Root,{open:y,onOpenChange:S,children:[a.jsx(ru,{clientThreadId:t,icon:e,setOpen:S,highlightTooltip:m}),a.jsx(X.Portal,{children:a.jsx(X.Content,{size:"large",children:_e})})]}),a.jsx(yr,{hasConnectors:!x&&!Q})]});return{dropdownItems:_e,mainComponent:te}}function hu(t,e){const{connector:s,clearParam:n}=_r(),o=t.find(i=>i.type===s&&!!i.access_token);u.useEffect(()=>{o&&(e(o),n())},[o,e,n])}function gu(t){const{mainComponent:e}=fu(t);return e}const qn=Re({attachFiles:{id:"ContextConnectorPicker.attachFiles",defaultMessage:"Attach files"},uploadFile:{id:"LocalFileDropdownItem.uploadFile",defaultMessage:"Upload from computer"},uploadFileMobile:{id:"LocalFileDropdownItem.uploadFileMobile",defaultMessage:"Upload file"}});function pu({clientThreadId:t,uploadType:e,modelAcceptedMimeTypes:s,modelSupportedImageMimeTypes:n,attachmentsProductFeature:o,getInputProps:i,openFileDialog:r,onOauthRedirect:c,historyDisabled:l,className:m,highlightTooltip:f}){const{gdriveStatus:g,o365Status:d}=vr(),v=a.jsx(Jc,{className:l?"text-white":f?"text-brand-blue-800":void 0});return a.jsx("div",{className:G("relative",m),children:a.jsx(mo,{showBackground:f,className:"bg-brand-blue-800/20",children:g!=="false"||d!=="false"?a.jsx(gu,{clientThreadId:t,icon:v,modelAcceptedMimeTypes:s,modelSupportedImageMimeTypes:n,attachmentsProductFeature:o,onOauthRedirect:c,uploadType:e,openFileDialog:r,getInputProps:i,highlightTooltip:f}):a.jsx(au,{clientThreadId:t,uploadType:e,openFileDialog:r,getInputProps:i,icon:v,highlightTooltip:f})})})}const xu=u.forwardRef(function({type:e,placeholder:s,replyRegions:n,state:o,renderFiles:i,leftSideActions:r,onSubmit:c,inputState:l,currentLeafId:m,composerController:f,clientThreadId:g,gizmoId:d},v){const x=Ps(),h=Sr();return u.useEffect(()=>{f.focus()},[h==null?void 0:h.modelId,f]),a.jsxs("div",{ref:v,className:G("flex w-full flex-col gap-1.5 rounded-[26px] p-1.5 transition-colors",x&&"backdrop-blur-2xl no-transparency:backdrop-blur-none",x&&e!=="temporary"&&"bg-token-composer-surface",!x&&e!=="temporary"&&"bg-[#f4f4f4] dark:bg-token-main-surface-secondary",e==="temporary"&&"dark bg-black"),children:[a.jsx(ct,{children:n.length>0&&a.jsx(ge.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0,transition:{duration:.06}},transition:{ease:"easeOut",duration:.1},children:a.jsx(Su,{replyRegions:n})})}),a.jsxs("div",{className:"flex items-end gap-1.5 pl-4 md:gap-2",children:[!!(r!=null&&r.length)&&a.jsx(ge.div,{initial:{opacity:0},animate:{opacity:1},transition:{ease:"easeOut",duration:.06},className:"-ml-2.5 flex",children:r},"leftSideActions"),a.jsxs(ge.div,{layout:!0,transition:{duration:.1},className:G("flex min-w-0 flex-1 flex-col"),children:[i,f instanceof Fa?a.jsx(yu,{composerController:f,currentLeafId:m,placeholder:s,inputState:l}):a.jsx(Tl,{composerController:f,placeholder:s})]}),a.jsx(_u,{inputState:l,state:o,onSubmit:c,composerController:f,clientThreadId:g,gizmoId:d})]})]})});function yu({composerController:t,currentLeafId:e,placeholder:s,inputState:n}){const o=u.useContext(ri);return a.jsxs(a.Fragment,{children:[a.jsx(br,{id:wr,autoFocus:!0,tabIndex:0,"data-id":e,dir:"auto",ref:i=>{if(!(t instanceof Fa))throw new Error("Expected TextAreaComposerController");i!=null&&(t.textArea=i,t.logPageMount())},rows:1,placeholder:s,disabled:n!=="default",className:G("m-0 resize-none border-0 bg-transparent px-0 text-token-text-primary focus:ring-0 focus-visible:ring-0",n==="disabled"&&"text-center",["max-h-[25dvh]","max-h-52"])}),a.jsx("script",{nonce:o.cspScriptNonce,suppressHydrationWarning:!0,children:"requestAnimationFrame((function(){window.__oai_logTTI?window.__oai_logTTI():window.__oai_SSR_TTI=window.__oai_SSR_TTI??Date.now()}))"})]})}function _u(t){const{isUnauthenticated:e}=wt(),s=bt(Oa.hasUploadInProgress);if(t.inputState==="disabled")return null;const n=a.jsx(vu,{state:t.state,onSubmit:t.onSubmit});return!e&&!s&&t.state==="disabled"&&t.clientThreadId?a.jsx("div",{className:"min-w-8",children:a.jsx(kr,{clientThreadId:t.clientThreadId,gizmoId:t.gizmoId,fallback:()=>n})}):n}function vu({state:t,onSubmit:e}){const s=t==="streaming"?Xc:el,n=re(),o=n.formatMessage({id:"+yfm/p",defaultMessage:"Stop streaming"}),i=n.formatMessage({id:"xfIykB",defaultMessage:"Send prompt"}),r=Ps();return a.jsx("button",{onClick:e,disabled:t==="disabled","aria-label":t==="streaming"?o:i,"data-testid":t==="streaming"?"stop-button":"send-button",className:G("mb-1 me-1 flex h-8 w-8 items-center justify-center rounded-full bg-black text-white transition-colors hover:opacity-70 focus-visible:outline-none focus-visible:outline-black disabled:text-[#f4f4f4] disabled:hover:opacity-100 dark:bg-white dark:text-black dark:focus-visible:outline-white disabled:dark:bg-token-text-quaternary dark:disabled:text-token-main-surface-secondary",r&&"disabled:bg-black disabled:bg-opacity-[0.27]",!r&&"disabled:bg-[#D7D7D7]"),children:a.jsx(s,{className:G(t==="streaming"?"icon-lg":"icon-2xl")})})}function Su({replyRegions:t}){return a.jsx("div",{className:"flex flex-col divide-y divide-token-border-light overflow-hidden rounded-b-lg rounded-t-[20px] bg-token-main-surface-primary",children:t.map((e,s)=>{switch(e.type){case"text":return a.jsx(bu,{value:e.value,onRemoveRegion:e.onRemoveRegion},s);case"object":return a.jsx(wu,{value:e.value,onRemoveRegion:e.onRemoveRegion},s);case"mention":case"system_hint":return a.jsx(ku,{value:e.value,icon:e.icon,onRemoveRegion:e.onRemoveRegion},s)}})})}function bu({value:t,onRemoveRegion:e}){return a.jsxs(Qs,{className:"text-token-text-secondary",children:[a.jsx(Xs,{children:a.jsx(Ws,{className:"icon-lg-heavy"})}),a.jsx(en,{children:`“${t}”`}),a.jsx(Js,{onClick:e})]})}function wu({value:t,onRemoveRegion:e}){return a.jsxs(Qs,{className:"text-blue-selection",children:[a.jsx(Xs,{children:a.jsx(Ws,{className:"icon-lg-heavy"})}),a.jsx(en,{className:"font-semibold",children:t}),a.jsx(Js,{onClick:e})]})}function ku({value:t,icon:e,onRemoveRegion:s}){return a.jsxs(Qs,{children:[a.jsx(Xs,{className:"mt-0",children:e}),a.jsx(en,{className:"font-semibold text-token-text-primary",children:t}),a.jsx(Js,{onClick:s})]})}function Js({onClick:t}){return a.jsx("button",{onClick:t,type:"button",className:"flex-shrink-0 text-token-text-secondary",children:a.jsx(Qc,{className:"icon-lg"})})}const Qs=Ae.div`flex items-start py-2.5 gap-3 pl-3 pr-1.5 text-sm`,Xs=Ae.span`flex-shrink-0 mt-0.5 w-7 h-6 flex justify-center items-center`,en=Ae.span`flex-1 line-clamp-3 py-0.5`;function Cu({composerController:t,highlightTooltip:e}){return a.jsx(Tu,{highlightTooltip:e,children:a.jsx(mo,{showBackground:e,className:"bg-brand-purple/20",children:a.jsx("button",{className:"mb-1 flex h-8 w-8 items-center justify-center text-token-text-primary",onClick:()=>{O.logEvent(E.composerSearchButtonClicked),Ss.addPersistedSystemHint(it.Search),/^search\s?$/i.test(t.getCurrentText())&&t.setText(""),t.replaceSlashCommandTokensWithText(),t.focus()},children:a.jsx(Za,{className:G(e&&"text-brand-purple-800 dark:text-brand-purple-600")})})})})}function Iu(){const t=Xt(es.hasSeenComposerSearchButtonTooltip);return!t.isLoading&&t.eligible}function Tu({children:t,highlightTooltip:e}){const s=Iu(),n=re(),o=Xt(es.hasSeenComposerSearchButtonTooltip);return s?a.jsx(_a,{side:"top",show:!0,dismissOnOutsideClick:!0,badge:"none",title:n.formatMessage({id:"WhBf/L",defaultMessage:"The web is now in ChatGPT"}),contentAlign:"center",onDismiss:o.markAsViewed,sideOffset:2,className:"!max-w-2xs",description:n.formatMessage({id:"INHpvZ",defaultMessage:"Search the web for instant answers and links to trusted sources."}),children:a.jsx("div",{children:t})}):a.jsx("div",{children:a.jsx(Ds,{sideOffset:14,label:n.formatMessage({id:"c+4o2s",defaultMessage:"Search the web"}),side:"top",open:e?!0:void 0,onOpenChange:i=>{i&&O.logEvent(E.composerSearchButtonHovered)},children:t})})}function ju({composerController:t,clientThreadId:e}){const s=Va(e),n=Ya(e,da.Search),o=il(e),[i,r]=u.useState([]),[c,l]=u.useState(void 0),[m,f]=u.useState(0);u.useEffect(()=>{r(c?o.filter(_=>_.name.toLocaleLowerCase().startsWith(c.text.toLocaleLowerCase())||_.systemHint.toLocaleLowerCase().startsWith(c.text.toLocaleLowerCase())):[])},[c]);const g=t.useState(_=>_.getSystemHints().length>0);u.useEffect(()=>{const _=k=>{l(D=>!D||!k?k:D.text===k.text&&D.range.from===k.range.to&&D.range.to?D:k)};t.view.dispatch(t.view.state.tr.setMeta(Ml,{onHintMatch:_}))},[t]);const d=g||!o.length||!i.length||!c;u.useEffect(()=>{d&&f(0)},[d]);const v=i.length,x=u.useCallback(_=>{f(k=>(_(k)%v+v)%v)},[v]),h=i[m],b=({hintToSave:_=h,expectPerfectMatch:k,appendSpace:D=!0})=>{if(!c||!h||k&&_.name.toLowerCase()!==c.text.toLowerCase())return;O.logEvent(E.systemHintSelected,{system_hint:_.systemHint,conversation_id:s??vn});const N=c.text+_.name.slice(c.text.length);El(t.view,{id:_.systemHint,hint:N},c.range,D,n),Lt(t.view)},M=u.useRef(b);M.current=b;const I=u.useRef(x);I.current=x;const T=u.useRef(c);T.current=c;const y=t.view;return u.useEffect(()=>(d||Rl(y,_=>{_==="up"?I.current(k=>k-1):_==="down"?I.current(k=>k+1):_==="cancel"?(Lt(y),Al(y)):_==="submit"?(M.current({expectPerfectMatch:!1}),Lt(y)):_==="checkMatch"&&M.current({expectPerfectMatch:!0,appendSpace:!1})}),()=>Lt(y)),[d,y]),u.useEffect(()=>{d||O.logEvent(E.systemHintListOpened,{conversation_id:s??vn})},[d]),d?null:a.jsx(Cr,{className:"max-w-60",onMouseDown:_=>{_.preventDefault()},children:i.map((_,k)=>a.jsx("div",{onMouseOver:()=>f(k),onClick:()=>{b({hintToSave:_,expectPerfectMatch:!1}),t.focus()},children:a.jsx(Ir,{autoFocus:!1,className:"hover:bg-inherit rounded-lg px-1 py-2",spoofHovered:k===m,children:a.jsx(Mu,{title:_.name,description:_.description,icon:a.jsx(Tr,{svgString:_.logo,className:"icon-lg text-token-text-secondary"}),checked:!1})})},_.systemHint))})}function Mu({title:t,description:e,icon:s,checked:n}){return a.jsxs("div",{className:"inline-flex w-full items-center justify-start gap-1.5 pl-1.5 pr-3",children:[a.jsx("div",{className:"flex h-7 w-7 items-center justify-center gap-2.5",children:s}),a.jsxs("div",{className:"shrink grow basis-0",children:[a.jsx("p",{className:"text-sm font-normal leading-tight text-token-text-primary",children:t}),!!e&&a.jsx("p",{className:"text-[13px] font-normal leading-[18px] text-token-text-secondary",children:e})]}),n&&a.jsx(tl,{className:G("icon-md text-token-text-primary",{"group-hover:hidden":!n})})]})}function Ru({composerController:t,clientThreadId:e}){return t instanceof jl?a.jsx(ju,{composerController:t,clientThreadId:e}):null}function Eu({suggestions:t,composerController:e,onSelect:s,onChange:n}){const o=eo(),i=u.useCallback((l,m,f)=>{s==null||s(l,m,f),o(l,m,f)},[s,o]),[r,c]=u.useState(-1);return u.useEffect(()=>{const l=m=>{if(m.key==="ArrowDown"){const f=r===t.length-1?0:r+1;c(f),n==null||n(f,!0,t[f])}else if(m.key==="ArrowUp"){m.preventDefault();const f=r<=0?t.length-1:r-1;c(f),n==null||n(f,!0,t[f])}else m.key==="Enter"&&t[r]&&i(t[r],t,r)};return e.subscribe("keydown",l)},[t,r,n,i,e]),u.useEffect(()=>e.subscribe("blur",()=>{c(-1),n==null||n(-1,!1)}),[e,n]),a.jsx(ge.ul,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"hidden w-full flex-col p-2.5 group-focus-within:block",children:t.map((l,m)=>a.jsxs(ge.li,{initial:{opacity:0,translateY:4},animate:{opacity:1,translateY:0},transition:{delay:m*.03},exit:{opacity:0,translateY:4},className:"w-full",children:[m>0&&a.jsx("div",{className:G("h-[1px] opacity-60",r===m||r===m-1?"mx-2 bg-token-main-surface-secondary":"bg-token-border-light")}),a.jsxs("button",{className:G("inline w-full cursor-pointer items-center justify-start rounded-lg px-2.5 py-3 text-start",r===m?"bg-token-main-surface-secondary":"bg-token-main-surface-primary"),onClick:f=>{f.preventDefault(),i(l,t,m)},onMouseEnter:()=>{c(m),n==null||n(m,!1,l)},onMouseLeave:()=>{c(-1),n==null||n(-1,!1,l)},children:[a.jsx("span",{className:"text-token-text-tertiary",children:l.title}),a.jsx("span",{className:"text-token-text-primary",children:l.body})]})]},l.id??m))})}const Au=1,Nu=3e3;function Pu({files:t,className:e}){const s=Jt();return a.jsx("div",{className:e,children:t.map(n=>a.jsx(za,{width:s?"normal":"wide",onRemoveFileClick:()=>$e.remove(n.tempId,"none"),file:n.file,fileId:n.fileId??void 0,contextConnectorInfo:n.contextConnectorInfo,loadingPercentage:n.status===Gr.Uploading?n.progress:void 0},n.tempId))})}function Du({onAbortCompletion:t,onCreateNewCompletion:e,onContinueGenerating:s,currentModelId:n,clientThreadId:o,isNewThread:i,isCompletionInProgress:r,className:c,disabled:l=!1,disabledReason:m,canPause:f=!1,canContinue:g=!1,suggestions:d,isInteractableSharedThread:v,composerContainerRef:x,composerController:h,autocompletions:b,requiresFileUpload:M,onComposerInput:I,onComposerChange:T,onAutocompleteSelect:y,headerClassName:_,hideHeader:k,setComposerBarElement:D,onTaggingDropdownOpen:N,onTaggingDropdownClose:P}){var hn,gn;const R=ba(),{isUnauthenticated:J}=wt(),L=re(),H=dt(o),le=as(o),ae=la(),{gizmoEditorData:Z,mode:K,getGizmoId:j}=ns(),S=ua(),F=sa(),ee=ci(),ne=ts(),V=Va(o),pe=!!li(),W=jr(),Q=!!di(),[_e,te]=u.useState({}),[p,se]=u.useState(!1),[de,q]=u.useState(!1),oe=u.useRef(!1),be=rl(),Y=n!==null?be[n]:void 0,Ie=W.has(it.Search);let B=Zs(o),ve=B&&"gizmo"in B?B.gizmo:void 0;const[ue,Pe]=u.useState(null);ue!==null&&(B={gizmo:ue,gizmo_id:ue.gizmo.id,kind:Ce.GizmoInteraction},ve=ue);const st=Zt(Y,B);let Ye=!1;Mr(B)&&(ve==null?void 0:ve.gizmo.id)===Rr&&(Ye=!0);const Tt=!l&&st!==tt.None&&!Ye&&!J,qe=Ma(Y,B),ut=Ea(Y,B);let ie=bt(w=>w.files);const[me]=u.useState(()=>Er());K==="magic"?ie=ie.filter(w=>w.gizmoId!=null):ie=ie.filter(w=>w.gizmoId==null);const Te=ie.length>0,nt=bt(Oa.hasUploadInProgress),jt=h.useState(w=>!w.isEmpty()),Le=Te?!nt:jt,Je=(st===tt.Multimodal?Ls:Bs)-ie.length,at=Je<=0,Ve=Le&&!l&&!r&&!Q,[sn,yo]=u.useState(!1),_o=cl(),vo=n||_o.id,So=Ya(o,da.Search),os=!l&&So&&!ve&&!Ie,bo=(hn=be[vo])==null?void 0:hn.tags,{targetedContent:Mt,setTargetedContent:Rt}=Ar(),$=Mt!=null&&Mt.isFocusedViewContent&&!ne?void 0:Mt,{rebaseSystemMessageContent:nn}=La();u.useEffect(()=>{Nr()}),u.useEffect(()=>{if(!(R!=null&&R.id))return;const w=Cn.getAndReset(R==null?void 0:R.id,V);w&&h.setText(w.inputText)},[R==null?void 0:R.id,V,h]),u.useEffect(()=>{sn!==Ve&&(yo(Ve),Ve&&(ma(!0).then(w=>{$t.startEnforcement(w),bs.startEnforcement(w),_s.startEnforcement(w)}),S!=null&&S.includes(Ms.SharedWebsocket)&&It.registerIfNotConnected()))},[Ve,sn,B==null?void 0:B.kind,S]);const Be=ja(Y,B),{handleFileAccepted:wo}=uo(L,Zt(Y,B),qe,"mouse",j,Be==null?void 0:Be.attachments),{getInputProps:ko,open:Co}=Aa({disabled:l||!Tt||at,noClick:!0,onDropAccepted:wo,onDropRejected:w=>lo(w,L,st),multiple:!0,maxSize:Na,maxFiles:Je,...Ra(ut)}),an=ca(me),on=u.useCallback(()=>{h.eraseContent(),an.clearMessages(),h.resize(Au),Pr();for(const w of ie)$e.remove(w.tempId,"none")},[ie,an,h]),mt=async(w,xe)=>{var xn;if(w==null||w.preventDefault(),l||!Le&&!xe||!B||Oe.isLoading(o)!==!1)return;const je=new Fs;se(!0);const ze=h.getContentToSend(),Xe=ze.content.replace(/[\u{E0000}-\u{E007F}]+/gu,""),Ee=`${H}-nextPrompt`,et=Hr({namespace:Tn.CompletionRequest,key:Ee,opts:{expectedTimingLogs:[{name:"prompt_submitted",expectedInMs:3e3}]}}),{content:Uo,attachments:pn}=qr(Xe,Y,B),cs=[];nn&&cs.push(hi(nn));const ls={...B};"gizmo"in ls&&delete ls.gizmo;const ds=h.getSystemHints();let pt={promptId:Ee,content:Uo,eventMetadata:{eventSource:w?"mouse":"keyboard"},completionMetadata:{suggestions:d,conversationMode:ls,systemHints:ds},messageMetadata:{...pn.length>0&&{attachments:pn},...ue&&{gizmo_id:ue==null?void 0:ue.gizmo.id},..._e,...ds.length>0&&{system_hints:ds},...!!ze.metadata&&{serialization_metadata:ze.metadata}},appendMessages:cs.length>0?cs:void 0,turnTracker:je};pt=Vr(pt),$!=null&&$.createNewCompletionParams&&(pt=await $.createNewCompletionParams(pt)),et.logTiming("request_params_ready"),await e(pt),(xn=$==null?void 0:$.onCreateCompletion)==null||xn.call($,{serverThreadId:V,currentLeafId:H}),($==null?void 0:$.shouldPersistAcrossMessages)!==!0&&Rt(void 0),In.hideThreadHeader(),on(),se(!1),et.logTiming("prompt_submitted"),Wr({namespace:Tn.CompletionRequest,key:Ee}),d!==void 0&&(He.logEvent("chatgpt_prompt_ignore_suggestions"),O.logEvent(E.promptIgnoreSuggestions))},rn=u.useRef(mt);u.useLayoutEffect(()=>{rn.current=mt}),u.useEffect(()=>ui.subscribe(mi.SEND_PROMPT,({prompt:w})=>{h.setText(w),rn.current(void 0,!0)}),[h]);const Io=w=>{Rt(w.targetedReply),w.targetedReply&&(h.focus(),O.logEvent(E.targetedReplyButtonClicked,{conversationId:V,sourceMessageId:w.messageId}))},cn=u.useCallback(()=>{var w;(w=$==null?void 0:$.onCleared)==null||w.call($,{serverThreadId:V,currentLeafId:H}),Rt(void 0),h.focus()},[H,V,$,Rt,h]),ln={Enter:{validator:w=>{const xe=w.isComposing||w.keyCode===229,je=de&&oe.current;return Ve&&!je&&(w.metaKey||(F||Ht)&&!w.shiftKey&&!xe)},handler:w=>{w.preventDefault(),mt()}},Escape:{validator:w=>!w.isComposing,handler:w=>{f&&r&&(t("",le),O.logEvent(E.pauseCompletion,{threadId:C.getServerThreadId(o),currentLeafId:C.getTree(o).getMessageId(H),eventSource:"keyboard"})),w.target.value===""&&cn()}}},ft=u.useRef(ln);ft.current=ln;const dn=u.useRef(null),ht=ll(bo,B==null?void 0:B.kind),[is,Et]=u.useState(!1),[rs,un]=u.useState(!1),At=ht&&is,mn=h.isReady();u.useEffect(()=>h.subscribe("keydown",w=>{var ze,Xe;h.acceptLegacyKeydown()&&((ze=ft.current[w.key])!=null&&ze.validator(w))&&ft.current[w.key].handler(w);const je=h.getCurrentText();if(w.key==="@"){const Ee=h.getSelectionStart(),et=je.substring(0,Ee);(!et||/\s$/.test(et)||Ee===0)&&((Xe=dn.current)==null||Xe.handleClose(),setTimeout(()=>Et(!0),10))}else is&&Et(!1);if(w.key==="Escape"&&(Pe(null),q(!1)),os){let Ee;w.key==="Backspace"?Ee=je.substring(0,je.length-1):Ee=je+w.key,/^search\s?$/i.test(Ee)?un(!0):rs&&un(!1)}Ie&&w.key==="Escape"&&Ss.removePersistedSystemHint(it.Search)}),[h,mn,is,rs,os,Ie]),u.useEffect(()=>{const w=Object.fromEntries(Object.keys(ft.current).map(xe=>[xe,ze=>{const Xe=ft.current[xe];if(!Xe||h.acceptLegacyKeydown())return!1;const{validator:Ee,handler:et}=Xe;return Ee(ze)?(et(ze),!0):!1}]));h.registerKeyHandlers(w)},[h,mn]),u.useEffect(()=>h.subscribe("paste",w=>{Dr({event:w,intl:L,clientThreadId:o,conversationMode:B,currentModelConfig:Y,getEditorGizmoId:j,modelSupportedImageMimeTypes:qe})}),[L,o,B,Y,j,qe,h]);const To=w=>{pe||Pe(w),h.trimLeadingText("@"),Kt(),Et(!1)},jo=su(o,me,L,qe,Be==null?void 0:Be.attachments),Mo=u.useCallback(()=>{t("",le),O.logEvent(E.pauseCompletion,{threadId:C.getServerThreadId(o),currentLeafId:C.getTree(o).getMessageId(H),eventSource:"mouse"}),Kt()},[t,o,le,H]),fn=u.useCallback(()=>{Cn.set(R==null?void 0:R.id,V,h.getCurrentText())},[V,R==null?void 0:R.id,h]);u.useEffect(()=>{Z||p||h.focus()},[p,h]),u.useEffect(()=>{Z||$e.reset()},[n,Z]),u.useEffect(()=>{(!ht&&ue||pe)&&Pe(null)},[ht,ue,pe]);const[Ro,Eo]=(()=>{switch(m){case"workspaceDisallowsGizmo":return[Fe.disallowedByWorkspacePlaceholder,!0];case"feedbackRequired":return[Fe.disabledFeedbackPlaceholder,!0];case"noModelsAvailable":return[Fe.noModelsAvailablePlaceholder,!0];case"requiresPluginsToBeInstalled":return[Fe.requiresPluginsToBeInstalled,!0];case"loadingPlugins":return[Fe.loading,!0];case"noTestGizmoId":return[Fe.noTestGizmoId,!0];default:return v?[Fe.continueSharedConversationPlaceholder,!1]:($==null?void 0:$.placeholderTextOverride)!=null?[$.placeholderTextOverride,!1]:[Fe.placeholderWithName,!1]}})(),Ao=L.formatMessage(Ro,{name:Z!=null?K==="magic"?dl:Z.name||"GPT":(ve==null?void 0:ve.gizmo.display.name)??"ChatGPT"});u.useEffect(()=>h.subscribe("input",()=>{Fr.getState().isThreadHeaderVisible&&In.hideThreadHeader(),q(!0)}),[h]),u.useEffect(()=>{if(I)return h.subscribe("input",()=>{I==null||I()})},[h,I]),u.useEffect(()=>{if(T)return h.subscribe("change",()=>{T==null||T()})},[h,T]),u.useEffect(()=>h.subscribe("focus",()=>{q(!0)}),[h]);const No={clientThreadId:o,uploadType:st,modelAcceptedMimeTypes:ut,modelSupportedImageMimeTypes:qe,attachmentsProductFeature:Be==null?void 0:Be.attachments,getInputProps:ko,openFileDialog:Co,historyDisabled:ee,onOauthRedirect:fn,highlightTooltip:M&&!Te},Qe=[];!l&&!at&&Tt&&!Ie&&Qe.push(a.jsx(pu,{...No},"file-upload-button")),os&&Qe.push(a.jsx(Cu,{composerController:h,highlightTooltip:rs},"search-button"));const Po=Te&&a.jsxs(a.Fragment,{children:[K==="magic"&&a.jsx("div",{className:"m-2 mb-0 rounded-lg bg-token-main-surface-secondary p-2 text-xs text-token-text-secondary",children:a.jsx(U,{...Fe.gizmoKnowledgeWarning})}),a.jsx(Pu,{files:ie,className:"flex flex-nowrap gap-2 overflow-x-auto pb-1.5 pt-[7px]"})]}),Do=Eo?"disabled":"default",Nt=r&&f?"streaming":!(Ve||Ie)||p?"disabled":"idle",gt=u.useRef(null),ot=u.useRef(null),{layer:Fo}=fi("387752763"),Oo=Fo.get("enable_slash_commands",!1),Lo=n&&[ul,ml].includes(n),Bo=Oo&&(B==null?void 0:B.kind)===Ce.PrimaryAssistant&&!Ie;u.useEffect(()=>{const w=()=>{gt.current!=null&&De.addAction("composer_state_disabled",{threadId:C.getServerThreadId(o),disabledReason:gt.current})};if(Le&&Nt==="disabled"){let xe="unknown";l?xe=m??"component_disabled_unknown":r?xe="completion_in_progress":Q?xe="thread_hard_blocked":p&&(xe="starting_new_completion_request"),gt.current!==xe&&(ot.current&&clearTimeout(ot.current),ot.current=setTimeout(w,Nu)),gt.current=xe}else gt.current=null;return()=>{ot.current&&(clearTimeout(ot.current),ot.current=null)}},[o,Le,Nt,l,m,r,Q,p]);const Pt=[];if($!=null&&$.label&&Pt.push({type:$.type,value:$.label,onRemoveRegion:cn}),W!=null&&W.has(it.Search)&&Pt.push({type:"system_hint",value:L.formatMessage(Fu.searchMode),icon:a.jsx("span",{className:"flex h-7 w-7 items-center justify-center rounded-full bg-brand-purple/15",children:a.jsx(Za,{className:"h-[20px] w-[20px] shrink-0 text-[#814CFF]"})}),onRemoveRegion:()=>{Ss.removePersistedSystemHint(it.Search),h.focus()}}),ue!==null){const w=!!((gn=ue.gizmo.tags)!=null&&gn.includes(Ba.FirstParty));Pt.push({type:"mention",value:ue.gizmo.display.name,icon:a.jsx(Il,{isFirstParty:w,src:ue.gizmo.display.profile_picture_url,className:"icon-md"}),onRemoveRegion:()=>{Pe(null),h.focus()}})}u.useEffect(()=>{(!b||b.length===0||!de)&&(oe.current=!1)},[b,de]);const zo=(w,xe,je)=>{oe.current=w>=0,xe&&h.setText(je?`${je.title}${je.body}`:"")};return u.useEffect(()=>{At?N==null||N():P==null||P()},[At,N,P]),a.jsxs(Or.Provider,{value:me,children:[a.jsx(Lr,{onOauthRedirect:fn,children:a.jsx("form",{className:c,onSubmit:mt,children:a.jsxs("div",{className:"relative flex h-full max-w-full flex-1 flex-col",children:[!k&&a.jsx(jd,{className:_}),a.jsxs("div",{ref:x,className:"group relative flex w-full items-center",children:[i&&"from_template_row"in ae.query&&a.jsx("button",{type:"button",onClick:()=>{ae.push("/",void 0,{shallow:!0})},className:"mr-2 flex h-8 w-8 items-center justify-center text-token-text-tertiary hover:text-token-text-secondary",children:a.jsx(sl,{className:"icon-lg"})}),ht&&!!V&&a.jsx(cd,{ref:dn}),At&&a.jsx("div",{className:G("absolute bottom-16 w-full space-y-2",vs.TagGpt),children:a.jsx(xl,{onClick:w=>To(w),onClose:()=>{Et(!1),h.focus()}})}),Bo&&a.jsx("div",{className:G("absolute bottom-16 space-y-2",vs.TagGpt),children:a.jsx(Ru,{composerController:h,clientThreadId:o})}),a.jsx(xu,{type:ee?"temporary":"default",ref:D,replyRegions:Pt,placeholder:Ao,inputState:Do,composerController:h,leftSideActions:Qe,state:Nt,onSubmit:Nt==="streaming"?Mo:mt,renderFiles:Po,currentLeafId:H,clientThreadId:o,gizmoId:ve==null?void 0:ve.gizmo.id}),de&&b&&b.length>0&&!At&&h.canShowAutocompletion()&&a.jsx("div",{className:G("absolute left-0 top-full z-10 mt-2 box-border w-full bg-token-main-surface-primary",(Qe==null?void 0:Qe.length)>0?`px-${Qe.length*8}`:"pl-0"),children:a.jsx(Eu,{suggestions:b,composerController:h,onSelect:y,onChange:zo})})]}),a.jsx(Br,{composerController:h,parsedDocumentHandler:jo})]})})}),a.jsx(Kd,{canUseInlineTagging:ht,isDisabled:l,clientThreadId:o,currentLeafId:H,currentRequestId:le,canContinue:g,composerController:h,setPromptInputMetadata:te,suggestions:d,isNewThread:i,onCreateNewCompletion:e,onContinueGenerating:s,onResetState:on,conversationMode:B}),B!=null&&!Lo&&zr.includes(B.kind)&&a.jsx(Ur,{onTargetedReply:Io})]})}const Fu=Re({searchMode:{id:"LSO1pB",defaultMessage:"Search the web"}});function Ou(t){const e=u.useContext(gi);return({id:n,requestedModelId:o,eventMetadata:i,focusOnNewCompletion:r=!0,variantPurpose:c="none",useDefaultModel:l,appendMessages:m,conversationMode:f,juice:g=void 0,turnTracker:d,extraStreamParams:v})=>{var M;const h=C.getTree(t).getParentPromptNode(n),b=h.id;e({type:Ke.Variant,promptId:b,requestedModelId:o,eventMetadata:i,cancelActiveRequests:!1,focusOnNewCompletion:r,useDefaultModel:l,completionMetadata:{variantPurpose:c,conversationMode:f,juice:g,systemHints:(M=h.message.metadata)==null?void 0:M.system_hints},appendMessages:m,turnTracker:d,extraStreamParams:v})}}function Lu(t){var o,i,r,c,l;const e=((o=t.message)==null?void 0:o.author.role)===Se.User,s=((i=t.metadata)==null?void 0:i.err)!=null&&((r=t.metadata)==null?void 0:r.errCode)!==vt.ContentPolicy,n=((c=t.metadata)==null?void 0:c.errCode)===vt.ModelIncompatibility;return((l=t.metadata)==null?void 0:l.canRetry)===!1||n?!1:e||s}function Sf(t){return t.composerController?a.jsx(Vn,{...t,composerController:t.composerController}):a.jsx(Nl,{children:e=>a.jsx(Vn,{...t,composerController:e})})}function Vn({clientThreadId:t,isNewThread:e,currentModelId:s,showPromptStarters:n,onRequestCompletion:o,composerContainerRef:i,composerController:r,setComposerBarElement:c}){const l=Oc(),m=$r(),f=lt(g=>{const d=Oe.getCurrentNode(t,g);return Lu(d)});return Kr(r),!m&&f?a.jsx(Bu,{clientThreadId:t}):a.jsxs(a.Fragment,{children:[a.jsx(ad,{clientThreadId:t}),a.jsx(bl,{clientThreadId:t,isStaticSharedThread:l,showInlineEmbeddedDisplay:!1,withVerticalPadding:!1,withHorizontalPadding:!0,children:a.jsx(wl,{children:a.jsx(zu,{composerContainerRef:i,composerController:r,clientThreadId:t,currentModelId:s,isNewThread:e,showPromptStarters:n,setComposerBarElement:c,onRequestCompletion:o})})})]})}function Bu({clientThreadId:t}){const e=Ou(t),s=lt(i=>{var c;return((c=Oe.getCurrentNode(t,i).metadata)==null?void 0:c.errCode)===ws}),n=Zr(i=>i.isoDate),o=dt(t);return s&&n!=null&&n!==""?null:a.jsxs("div",{children:[a.jsx("div",{className:"mb-3 text-center text-xs",children:a.jsx(U,{...Wn.errorGeneratingResponse})}),a.jsx("div",{className:"flex items-center md:mb-4",children:a.jsx(kt,{as:"button",color:"primary",onClick:()=>{const i=new Fs;e({id:o,eventMetadata:{eventSource:"mouse"},conversationMode:Oe.getConversationMode(t),turnTracker:i})},className:"m-auto",icon:Ka,children:a.jsx(U,{...Wn.regenerateResponse})})})]})}function zu({clientThreadId:t,currentModelId:e,isNewThread:s,onRequestCompletion:n,showPromptStarters:o,composerContainerRef:i,composerController:r,autocompletions:c,requiresFileUpload:l,onComposerInput:m,onComposerChange:f,onAutocompleteSelect:g,headerClassName:d,hideHeader:v,setComposerBarElement:x,onTaggingDropdownClose:h,onTaggingDropdownOpen:b}){var qe,ut;const M=dt(t),I=as(t),T=wa(),{isUnauthenticated:y}=wt(),k=Lc(t)===fa.PENDING,D=Bc({clientThreadId:t,conversationLeafId:M}),N=Os(I),P=(N||k)&&!D,R=dt(t),J=!y,L=ha(),{isOpen:H,onClose:le}=Yr(),ae=u.useCallback((ie,me)=>{O.logEvent(E.continueCompletion),n({type:Ke.Continue,promptId:ie,eventMetadata:{eventSource:"mouse"},cancelActiveRequests:!1,completionMetadata:{conversationMode:Oe.getConversationMode(t)},turnTracker:me})},[n,t]),Z=ga(),K=u.useCallback(async(ie,me)=>{var Le;const Te=C.getServerThreadId(t);It.stopConversation(Te);const nt=C.getTree(t);!nt.hasReceivedServerCompletion&&!L&&((Le=nt.getParent(me).metadata)==null?void 0:Le.errCode)!==vt.ContentPolicy&&setTimeout(()=>{Cs.onCreateFinished(Z,Te,L)},500),Te&&He.checkGate("3922476776")&&await Ze.stopConversationProcess(Te),Hs.abortRequest(me)&&C.updateTree(t,Je=>{const at=C.getThreadCurrentLeafId(t);Je.updateNodeMessageMetadata(at,{finish_details:{type:"interrupted"}})})},[t,L,Z]),j=u.useCallback(async({promptId:ie,content:me,eventMetadata:Te,completionMetadata:nt,messageMetadata:jt,appendMessages:Le,turnTracker:Je})=>{const at=C.getThreadCurrentLeafId(t);C.updateTree(t,Ve=>{Ve.addNode(ie,me,at,Se.User,void 0,jt)}),await n({type:Ke.Next,promptId:ie,eventMetadata:Te,cancelActiveRequests:!0,completionMetadata:nt,appendMessages:Le,turnTracker:Je})},[t,n]),S=zc(t,M),F=Uc(t,M),ee=!D&&(N||k),ne=u.useMemo(()=>ee?!1:!S&&F,[S,F,ee]),V=ee&&e!=="gpt-4-pbrowse",pe=Gc(t),W=qa(t),Q=$s(W).data,{promptStarters:_e,isSuccess:te}=kl(s&&!pe,t,4),p=Ia(),se=(()=>{var ie,me;if((p==null?void 0:p.messageId)===((me=(ie=C.getTree(t).getLastValidNode(M))==null?void 0:ie.message)==null?void 0:me.id))return p==null?void 0:p.suggestions;if(o&&!pe&&te&&!J)return _e})(),de=C.getTree(t),q=de.countMessagesByAuthor(Se.User),oe=u.useRef(),be=u.useRef();let Y=!1;oe.current==q&&be.current==R?Y=!0:oe.current!==q&&be.current!==R&&(Y=!0,oe.current=q,be.current=R);const Ie=de.getNodeByIdOrMessageId(M),B=Y&&((qe=Ie==null?void 0:Ie.message)==null?void 0:qe.author.role)==Se.Assistant&&Rs(Ie.message),ve=fl(),ue=pi(),Pe=(()=>{var Te;if(((Te=Q==null?void 0:Q.gizmo.tags)==null?void 0:Te.includes(Ba.WorkspaceDisabled))&&!ue)return"workspaceDisallowsGizmo";if(ve.size){if(T.displayingSideBySideFeedback&&T.unskippable)return"feedbackRequired"}else return"noModelsAvailable";const me=Oe.getConversationMode(t);return(me==null?void 0:me.kind)===Ce.GizmoTest&&me.gizmo_id==null?"noTestGizmoId":null})(),st=Hc(t),Ye=Vs(t),Tt=(ut=xi("15117983"))==null?void 0:ut.value;return a.jsxs(a.Fragment,{children:[(s||B)&&H?a.jsx(Jr,{onClose:le}):null,Tt&&Ye&&Ye.kind===Ce.PrimaryAssistant&&Ye.plugin_ids&&Ye.plugin_ids.length>0?a.jsx(Uu,{}):a.jsx(Du,{composerContainerRef:i,composerController:r,clientThreadId:t,onCreateNewCompletion:j,onAbortCompletion:K,onContinueGenerating:ae,currentModelId:e,isNewThread:s,isCompletionInProgress:P,className:"w-full",canContinue:ne,suggestions:se??[],disabled:!!Pe,disabledReason:Pe??void 0,canPause:V,isInteractableSharedThread:st,autocompletions:c,requiresFileUpload:l,onComposerInput:m,onComposerChange:f,onAutocompleteSelect:g,headerClassName:d,hideHeader:v,setComposerBarElement:x,onTaggingDropdownClose:h,onTaggingDropdownOpen:b},t)]})}function Uu(){return a.jsxs("div",{className:"mx-auto flex max-w-md flex-col items-center justify-center gap-2 rounded-xl border border-token-border-light bg-token-main-surface-primary p-6 shadow-lg",children:[a.jsx("span",{className:"text-token-text-primary",children:a.jsx(U,{id:"PluginsDecrepatedNotice.pluginsDeprecationTitle",defaultMessage:"Conversations with plugins are archived"})}),a.jsx("span",{className:"text-token-text-secondary",children:a.jsx(U,{id:"PluginsDecrepatedNotice.pluginsDeprecationSubtitle",defaultMessage:"Explore GPT Store to find a replacement"})}),a.jsxs("a",{href:"https://chat.openai.com/gpts",className:"text-green-500 hover:cursor-pointer dark:text-green-400",children:[a.jsx(U,{id:"PluginsDecrepatedNotice.pluginsDeprecationGptStoreLink",defaultMessage:"Explore GPTs"}),a.jsx("span",{className:"ml-2",children:a.jsx(U,{id:"PluginsDecrepatedNotice.pluginsDeprecationGptStoreLinkArrow",defaultMessage:"→"})})]})]})}const Wn=Re({errorGeneratingResponse:{id:"PromptTextarea.errorGeneratingResponse",defaultMessage:"There was an error generating a response"},regenerateResponse:{id:"PromptTextarea.regenerateResponse",defaultMessage:"Regenerate"}}),Gu=fe(()=>ce(()=>import("./bb8bdhepry4v4att.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29])).then(t=>t.default)),Hu=fe(()=>ce(()=>import("./sso-m465dltvmezan4z2.js").then(t=>t.j),__vite__mapDeps([30,1,2,3,31,5,6,15,32,33,34,35,36,37,12,38,7,14,39,40,41,42,43,28,17,44,45,46,47,48,20,23,26,49,21,22,50,51,27,52,53,54,55,56,57,58,59,60,25,61,62,63,64,65,19,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,9,10,4,8,11,13,16,85])).then(t=>t.default).catch(()=>Ct)),qu=Ae.div`flex gap-2 flex-wrap mt-1 max-w-[80%] justify-end`,Vu=Ae.div`flex flex-col gap-2`,Wu=({parts:t,attachments:e,isUserTurn:s,clientThreadId:n})=>{const o=Jt(),i=Ks(n),r=Ys(),c=yi.getImageAssetPointersFromParts(t),l=new Set(c.map(x=>ss(x.asset_pointer))),f=ts()||o,g=(e??[]).filter(x=>ka(x.name)),d=(e??[]).filter(x=>x.id==null||l.has(x.id)?!1:r||i?!g.includes(x):!0);return(r||i?(d.length>0||g.length>0)&&s:d.length>0&&s)?a.jsxs(a.Fragment,{children:[a.jsxs(qu,{children:[d.map(x=>a.jsx(za,{file:x.name,fileId:x.id,contextConnectorInfo:Qr(x.context_connector_info),width:o?"normal":"wide",alwaysShowData:!0},x.id)),i&&g.map(x=>a.jsx(Hu,{visualization:jn(x)},x.id))]}),r&&!i&&a.jsx(Vu,{className:G(!f&&"w-[80%]"),children:g.map(x=>a.jsx(Gu,{clientThreadId:n,visualization:jn(x)},x.id))})]}):null};function fo(t){return Rs(t)&&!_i(t)}const Ut=50,$u=95;function Ku(t,e){if(t<=e)return t/e*Ut;{const s=Ut,n=$u-Ut,o=t-e,r=-(Ut/e)/n;return s+n*(1-Math.exp(r*o))}}class Zu{constructor(){z(this,"mostRecentCompletionRequest");z(this,"loggedRequestIds",new Set)}onCompletionRequestStarted(e){this.mostRecentCompletionRequest={requestId:e,timestamp:Date.now()}}onDisplayTextAfterBrowsingSession(e,s){const n=this.mostRecentCompletionRequest;if(n!=null&&!this.loggedRequestIds.has(n.requestId)){const i=C.getThreadConversationTurns(e,s).find(r=>r.messages.some(c=>c.message.id===s));i!=null&&i.messages.some(r=>r.nodeId===n.requestId)&&(O.logEvent(E.browsingTimeToFirstTextToken,{messageId:s,timeMs:Date.now()-n.timestamp}),this.loggedRequestIds.add(n.requestId))}}}const ho=new Zu;function Yu(t){var o;const e=t.find(i=>{var r;return((r=i.message.metadata)==null?void 0:r.image_search_results)!==void 0});return(((o=e==null?void 0:e.message.metadata)==null?void 0:o.image_search_results)??[]).slice(0,5)}function Ju({messages:t}){const e=Yu(t),s=Xr();return e.length===0?null:a.jsx("div",{className:G({"mb-2":!0,"grid grid-flow-col gap-3":e.length>1,"w-1/3":e.length===1}),children:e.filter(({contentUrl:n})=>s.has(n)).map((n,o)=>a.jsx("a",{href:n.hostPageUrl,target:"_blank",rel:"noreferrer",children:a.jsx("img",{src:n.contentUrl,alt:n.name,className:"aspect-square rounded-xl object-cover"})},o))})}const Qu=fe(()=>ce(()=>import("./sso-m465dltvmezan4z2.js").then(t=>t.k),__vite__mapDeps([30,1,2,3,31,5,6,15,32,33,34,35,36,37,12,38,7,14,39,40,41,42,43,28,17,44,45,46,47,48,20,23,26,49,21,22,50,51,27,52,53,54,55,56,57,58,59,60,25,61,62,63,64,65,19,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,9,10,4,8,11,13,16,85])).then(t=>t.default).catch(()=>Ct));function go({attachments:t,citations:e,contentReferences:s,className:n,clientThreadId:o,displayParts:i,isCompletionInProgress:r,id:c,isActivelyStreaming:l,isUserTurn:m,turnIndex:f,isFeedbackEnabled:g,messages:d,onRequestMoreCompletions:v,parts:x,prevGroupedMessageType:h,prevGroupedMessages:b,showEditButton:M,onEnterEdit:I,size:T="medium"}){var R,J;const y=Ks(o),_=d.length>1,{flagSeverity:k,shouldHideContent:D}=to(_?void 0:d[0]),N=!x.some(L=>L!==""),P=((R=d[0].message.metadata)==null?void 0:R.targeted_reply_label)??((J=d[0].message.metadata)==null?void 0:J.targeted_reply);return u.useEffect(()=>{!N&&h===A.Browsing&&ho.onDisplayTextAfterBrowsingSession(o,d[0].message.id)},[N,d,o,h]),a.jsxs("div",{"data-message-author-role":d[0].message.author.role,"data-message-id":d[0].message.id,dir:"auto",className:G(n,"text-message flex w-full flex-col items-end gap-2 whitespace-normal break-words [.text-message+&]:mt-5"),children:[P&&a.jsxs("div",{className:"mb-1 ml-6 mt-1 flex items-start gap-1.5 text-sm font-normal text-token-text-tertiary sm:ml-7 lg:ml-8",children:[a.jsx(Ws,{className:"icon-md mt-1 shrink-0"}),a.jsx("p",{className:"mr-2 line-clamp-3",children:P})]}),m&&y&&a.jsx(Qu,{messages:d}),a.jsx(ec,{messages:d}),a.jsx(Xu,{parts:x,attachments:t,isUserTurn:m,isCompletionInProgress:r,turnIndex:f,displayParts:i,isActivelyStreaming:l,shouldHideContent:D,showEditButton:M,onEnterEdit:I,clientThreadId:o,id:c,isEmpty:N,prevGroupedMessageType:h,prevGroupedMessages:b,flagSeverity:k,messages:d,citations:e,contentReferences:s,size:T}),a.jsx(Pl,{message:_?void 0:d[0],id:c,isFeedbackEnabled:g,onRequestMoreCompletions:v,clientThreadId:o,isUserTurn:m}),a.jsx(tc,{isUserTurn:m,message:_?void 0:d[0]}),!m&&!l&&b&&h===A.SearchResult&&a.jsx(Ju,{messages:b})]})}function Xu({clientThreadId:t,id:e,displayParts:s,isCompletionInProgress:n,turnIndex:o,isActivelyStreaming:i,shouldHideContent:r,showEditButton:c=!1,onEnterEdit:l,isEmpty:m,prevGroupedMessageType:f,prevGroupedMessages:g,messages:d,citations:v,contentReferences:x,size:h,isUserTurn:b,parts:M,attachments:I}){var V,pe;const T=re(),y=sc(s),[_,k]=u.useState({}),[D,N]=u.useState(!1),P=nc(),{streamingContext:R}=ac();u.useEffect(()=>{P&&(R.setOnStylesUpdatedCallback(k),R.onStreamingChanged(n),R.setOnResetCallback(()=>N(!1)),n&&(N(!0),k(R.createTopLevelStyles())))},[P,n,R]);const J=oc(),L=(V=d[0].message.metadata)==null?void 0:V.gizmo_id,H=(pe=d[0].message.metadata)==null?void 0:pe.serialization_metadata,le=qc(d[0].message).length,ae=u.useMemo(()=>({clientThreadId:t,messageId:e,turnIndex:o}),[t,e,o]),Z=ic(d[0].message),K=!!L&&J.includes(L),j=u.useCallback(W=>{rc.open(W,o,e)},[o,e]),S=a.jsx(Wu,{parts:M,attachments:I,isUserTurn:b,clientThreadId:t},"files-and-tables"),F=!!(I!=null&&I.length||s.some(W=>W.type==="images")),ee=s.map((W,Q)=>{var _e;if(W.type==="transcription"){const te=r?null:W.text;let p=null;return b&&r?p=a.jsx("span",{className:"italic opacity-30",children:a.jsx(U,{...Gt.contentRemoved})}):b&&te!=null?p=te.trim().length===0?a.jsx("span",{className:"italic opacity-30",children:a.jsx(Ot,{text:T.formatMessage(Gt.transcriptUnavailable),customSymbolOffsets:void 0})}):a.jsx("span",{className:"italic opacity-65",children:a.jsx(Ot,{text:`“${te.trim()}”`,customSymbolOffsets:void 0})}):!b&&te!=null&&(p=a.jsx(Ot,{text:te,customSymbolOffsets:void 0})),a.jsx(ms,{containsImagesOrAttachments:F,isUserTurn:b,showEditButton:c,onEnterEdit:l,children:p},Q)}else if(W.type==="text"){const te=r?null:W.text;if(!m&&!r&&!b){const p=f===A.CodeInterpreter?g==null?void 0:g.map(be=>be.message):void 0,{text:se,contentReferences:de}=cc(y,v,x,K),{processedText:q,displayedContentReferences:oe}=lc(se,de,i?void 0:p);return a.jsx(dc.Provider,{value:{analyticsMetadata:ae,message:d[0].message,contentReferences:oe,onShowSearchResults:j,numImageResults:le,isActivelyStreaming:i,useSafeUrls:!0},children:a.jsx(qs,{clientThreadId:t,messageId:e,isStreamingOrProcessing:D,size:h,className:G(i&&!P&&"result-streaming",Z&&"headers-v2"),children:q===""?"&#8203;":q})},Q)}else if(m&&i&&!b)return P?a.jsx("div",{className:"pulsing-dot"},Q):a.jsx("div",{className:"result-streaming",children:a.jsx("div",{children:a.jsx("pre",{})})},Q);return a.jsx(ms,{containsImagesOrAttachments:F,isUserTurn:b,showEditButton:c,onEnterEdit:l,children:b&&r?a.jsx("span",{className:"italic opacity-30",children:a.jsx(U,{...Gt.contentRemoved})}):te?a.jsx(Ot,{text:te,customSymbolOffsets:H==null?void 0:H.custom_symbol_offsets}):null},Q)}else if(W.type==="images"){const te=((_e=d[0].message.metadata)==null?void 0:_e.attachments)??[];return a.jsx(uc,{assets:W.imageAssets,attachments:te},Q)}else return null}),ne=s.findIndex(W=>W.type==="text");if(ne!==-1?ee.splice(ne,0,S):ee.push(S),r&&b)ee.length=0,ee.push(a.jsx(ms,{containsImagesOrAttachments:F,isUserTurn:b,onEnterEdit:_t,children:a.jsx("span",{className:"italic opacity-30",children:a.jsx(U,{...Gt.contentRemoved})})}));else if(r&&!b)return null;return a.jsx("div",{className:G("flex w-full flex-col gap-1 empty:hidden",b&&"items-end rtl:items-start",!b&&"first:pt-[3px]",D&&"streaming-response"),style:_,children:ee})}const Gt=Re({contentRemoved:{id:"textMessage.contentRemoved",defaultMessage:"Content removed"},transcriptUnavailable:{id:"textMessage.transcriptUnavailable",defaultMessage:"Transcript Unavailable"}});function em(t){var m;const{isActivelyStreaming:e,...s}=t,n=ua(),o=(n==null?void 0:n.includes("debug"))??!1,i=t.messages[t.messages.length-1].message.id,[r,c]=u.useState([]),l=u.useRef();return l.current===void 0&&(l.current=(n==null?void 0:n.includes(vi))??!1?new mc(t.parts,c,e,void 0,{debug:o}):new fc(t.parts,c,e)),u.useEffect(()=>{l.current!=null&&(l.current.onMessagePartsUpdated(t.parts,e),l.current.isBuffering()&&xt.addDelayedRenderingMessage(i))},[t.parts,i,e]),u.useEffect(()=>{l.current!=null&&!l.current.isBuffering()&&xt.removeDelayedRenderingMessage(i)},[r,i]),u.useEffect(()=>()=>xt.removeDelayedRenderingMessage(i),[i]),u.useEffect(()=>()=>{l.current!=null&&(l.current.destroy(),l.current=void 0)},[]),a.jsx(go,{...s,displayParts:r,isActivelyStreaming:e||((m=l.current)==null?void 0:m.isBuffering())})}function tm({message:t,isCompletionInProgress:e,clientThreadId:s,className:n,isUserTurn:o,turnIndex:i,isFeedbackEnabled:r,prevGroupedMessageType:c,prevGroupedMessages:l,showEditButton:m,onEnterEdit:f,onRequestMoreCompletions:g}){var v,x,h;const d=u.useMemo(()=>"parts"in t.message.content?t.message.content.parts:[pa(t.message)],[t]);return a.jsx(nm,{parts:d,messages:[t],isCompletionInProgress:e,className:n,citations:(v=t.message.metadata)==null?void 0:v.citations,contentReferences:(x=t.message.metadata)==null?void 0:x.content_references,attachments:(h=t.message.metadata)==null?void 0:h.attachments,isUserTurn:o,turnIndex:i,id:t.nodeId,isFeedbackEnabled:r,onRequestMoreCompletions:g,clientThreadId:s,showEditButton:m,onEnterEdit:f,prevGroupedMessageType:c,prevGroupedMessages:l})}const sm=Si.memo(tm);function nm(t){const e=t.messages.length>1,{flagSeverity:s}=to(e?void 0:t.messages[0]),n=s!=="danger"&&t.isCompletionInProgress,o=!t.parts.some(r=>r!==""),[i]=u.useState(()=>!t.isUserTurn&&(t.isCompletionInProgress||o));return i?a.jsx(em,{...t,isActivelyStreaming:n}):a.jsx(go,{...t,displayParts:hc({isUserTurn:t.isUserTurn,parts:t.parts}),isActivelyStreaming:n})}const am=fe(()=>ce(()=>import("./i37r6mslsggndhdp.js"),__vite__mapDeps([86,1,2,3])));function po({animationData:t,animationSegmentToPlay:e,animationLoopCounter:s}){const n=u.useRef(null);return u.useEffect(()=>{var o;(o=n.current)==null||o.playSegments(e,!0)},[s]),a.jsx(am,{animationData:t,lottieRef:n,loop:!1,autoplay:!1})}function om(t){return a.jsx(Ns,{width:"8",height:"9",viewBox:"0 0 8 9",fill:"none",...t,children:a.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M7.66607 0.376042C8.01072 0.605806 8.10385 1.07146 7.87408 1.4161L3.54075 7.9161C3.40573 8.11863 3.18083 8.24304 2.93752 8.24979C2.69421 8.25654 2.46275 8.1448 2.31671 7.95008L0.150044 5.06119C-0.098484 4.72982 -0.0313267 4.25972 0.300044 4.01119C0.631415 3.76266 1.10152 3.82982 1.35004 4.16119L2.88068 6.20204L6.62601 0.584055C6.85577 0.239408 7.32142 0.146278 7.66607 0.376042Z",fill:"currentColor"})})}function im(t){return a.jsxs(Ns,{width:"4",height:"12",viewBox:"0 0 4 12",fill:"none",...t,children:[a.jsx("mask",{id:"path-1-inside-1_1975_4008",fill:"currentColor",children:a.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M1 6.5C1 7.05228 1.44772 7.5 2 7.5C2.55228 7.5 3 7.05228 3 6.5V1.5C3 0.947715 2.55228 0.5 2 0.5C1.44772 0.5 1 0.947715 1 1.5L1 6.5ZM0.75 10.25C0.75 10.9404 1.30964 11.5 2 11.5C2.69036 11.5 3.25 10.9404 3.25 10.25C3.25 9.55964 2.69036 9 2 9C1.30964 9 0.75 9.55964 0.75 10.25Z"})}),a.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M1 6.5C1 7.05228 1.44772 7.5 2 7.5C2.55228 7.5 3 7.05228 3 6.5V1.5C3 0.947715 2.55228 0.5 2 0.5C1.44772 0.5 1 0.947715 1 1.5L1 6.5ZM0.75 10.25C0.75 10.9404 1.30964 11.5 2 11.5C2.69036 11.5 3.25 10.9404 3.25 10.25C3.25 9.55964 2.69036 9 2 9C1.30964 9 0.75 9.55964 0.75 10.25Z",fill:"currentColor"}),a.jsx("path",{d:"M1 6.5H-0.25H1ZM1 1.5L-0.25 1.5L-0.25 1.5L1 1.5ZM2 6.25C2.13807 6.25 2.25 6.36193 2.25 6.5H-0.25C-0.25 7.74264 0.757359 8.75 2 8.75V6.25ZM1.75 6.5C1.75 6.36193 1.86193 6.25 2 6.25V8.75C3.24264 8.75 4.25 7.74264 4.25 6.5H1.75ZM1.75 1.5V6.5H4.25V1.5H1.75ZM2 1.75C1.86193 1.75 1.75 1.63807 1.75 1.5H4.25C4.25 0.257359 3.24264 -0.75 2 -0.75V1.75ZM2.25 1.5C2.25 1.63807 2.13807 1.75 2 1.75V-0.75C0.757359 -0.75 -0.25 0.257359 -0.25 1.5L2.25 1.5ZM2.25 6.5L2.25 1.5L-0.25 1.5L-0.25 6.5L2.25 6.5ZM2 10.25H-0.5C-0.5 11.6307 0.619288 12.75 2 12.75V10.25ZM2 10.25V12.75C3.38071 12.75 4.5 11.6307 4.5 10.25H2ZM2 10.25H2H4.5C4.5 8.86929 3.38071 7.75 2 7.75V10.25ZM2 10.25H2V7.75C0.619288 7.75 -0.5 8.86929 -0.5 10.25H2Z",fill:"currentColor",mask:"url(#path-1-inside-1_1975_4008)"})]})}function rm(t){return a.jsx(Ns,{width:"8",height:"9",viewBox:"0 0 8 9",fill:"none",...t,children:a.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M7.32256 1.48447C7.59011 1.16827 7.55068 0.695034 7.23447 0.427476C6.91827 0.159918 6.44503 0.199354 6.17748 0.515559L4.00002 3.08892L1.82256 0.515559C1.555 0.199354 1.08176 0.159918 0.765559 0.427476C0.449355 0.695034 0.409918 1.16827 0.677476 1.48447L3.01755 4.25002L0.677476 7.01556C0.409918 7.33176 0.449354 7.805 0.765559 8.07256C1.08176 8.34011 1.555 8.30068 1.82256 7.98447L4.00002 5.41111L6.17748 7.98447C6.44503 8.30068 6.91827 8.34011 7.23447 8.07256C7.55068 7.805 7.59011 7.33176 7.32256 7.01556L4.98248 4.25002L7.32256 1.48447Z",fill:"currentColor"})})}function bf({animationLoopCounter:t}){const{resolvedTheme:e}=As(),s=e==="dark";return a.jsx(po,{animationData:s?gc:pc,animationSegmentToPlay:[0,300],animationLoopCounter:t})}function wf({animationLoopCounter:t}){const{resolvedTheme:e}=As(),s=e==="dark";return a.jsx(po,{animationData:s?xc:yc,animationSegmentToPlay:[0,400],animationLoopCounter:t})}const cm=2e3,xo=.4,lm=.45,dm=.2,um=.1,mm=.25;var Me=(t=>(t[t.Running=0]="Running",t[t.Finished=1]="Finished",t[t.Error=2]="Error",t[t.Stopped=3]="Stopped",t[t.Paused=4]="Paused",t))(Me||{});function kf({conversationMessages:t,icon:e,status:s,text:n,estimatedToolDurationMs:o,animationLoopDurationMs:i=cm,shouldPersistAfterFinished:r=!1}){const[c,l]=u.useState(s===0?0:s===1&&!r?7:1),[m,f]=u.useState(0);u.useEffect(()=>{s===2?l(8):s===3?l(9):s===4?l(10):s===1?l(c===2?3:7):s===0&&c===10&&(l(2),f(d=>d+1))},[s]);const g=gm(c);return u.useEffect(()=>{const d=t[0].message.id;if(g)return xt.addDelayedRenderingMessage(d),()=>{xt.removeDelayedRenderingMessage(d)}},[g]),Ua(()=>{rt(c)&&f(d=>d+1)},i),c===7&&!r?null:a.jsxs("div",{className:"my-2.5 flex items-center gap-2.5",children:[a.jsx(fm,{icon:e,status:s,uiState:c,estimatedToolDurationMs:o,animationLoopCounter:m,shouldPersistAfterFinished:r,onFillProgressBarAnimationComplete:()=>l(4),onFinishAnimationComplete:()=>{l(5),setTimeout(()=>{l(r?7:6)},um*1e3)},onHideAnimationComplete:()=>l(7)}),a.jsx(hm,{text:n,uiState:c,animationLoopCounter:m,onEnterAnimationComplete:()=>l(2)})]})}const $n=50;function fm({icon:t,status:e,uiState:s,estimatedToolDurationMs:n,animationLoopCounter:o,shouldPersistAfterFinished:i,onFillProgressBarAnimationComplete:r,onFinishAnimationComplete:c,onHideAnimationComplete:l}){const[m,f]=u.useState(0);Ua(()=>{rt(s)?f(I=>I+$n):s===10&&f(0)},$n);let g,d,v;rt(s)||s===10?(g="running",d=a.jsx(t,{animationLoopCounter:o}),v="bg-transparent"):s===4||s===5||s===7&&i?(g="finished",d=a.jsx(om,{}),v="bg-brand-purple"):e===2?(g="error",d=a.jsx(im,{}),v="bg-orange-500"):e===3&&(g="stopped",d=a.jsx(rm,{}),v="bg-gray-300");let x={opacity:0,scale:0,rotate:-180,x:0},h={type:"spring",bounce:.3,duration:lm},b={opacity:0,scale:.6,rotate:0,x:0};s===0?(x={opacity:0,scale:.5,rotate:-180,x:-8},h={type:"spring",bounce:.3,duration:xo}):s===1?x=!1:s===5&&(b={opacity:0,scale:0,rotate:0,x:0},h={type:"spring",bounce:.3,duration:mm});const M=Ku(m,n);return a.jsx("div",{className:"relative h-5 w-5 shrink-0",children:a.jsx(ct,{onExitComplete:()=>{s===6&&l()},children:g!=null&&a.jsxs(ge.div,{className:G("absolute left-0 top-0 flex h-full w-full items-center justify-center rounded-full text-white",v),initial:x,animate:{opacity:1,scale:1,rotate:0,x:0},exit:b,transition:h,onAnimationComplete:()=>{s===4&&c()},children:[d,(rt(s)||s===10)&&a.jsx(_c,{percentage:s===3?100:M,thickness:1.5/23,className:"absolute left-1/2 top-1/2 h-[23px] w-[23px] -translate-x-1/2 -translate-y-1/2 text-brand-purple",backgroundStrokeClassName:"stroke-brand-purple/25 dark:stroke-brand-purple/50",transitionDuration:s===3?`${(100-M)/100*dm}s`:void 0,transitionTimingFunction:s===3?"cubic-bezier(0.55, 0, 1, 1)":void 0,onTransitionEnd:()=>{s===3&&r()}})]},g)})})}function hm({text:t,uiState:e,animationLoopCounter:s,onEnterAnimationComplete:n}){const[o,i]=u.useState(t);u.useEffect(()=>{e===2&&i(t)},[s]),u.useEffect(()=>{rt(e)||i(t)},[e,t]);let r={opacity:0,x:0,y:15},c={type:"spring",bounce:.3,opacity:{duration:.15},y:{duration:.3}};e===0?(r={opacity:0,x:-8,y:0},c={type:"spring",bounce:.3,duration:xo,delay:.15}):e===1&&(r=!1);const l=o??void 0;return a.jsx("div",{className:G("relative h-5 w-full leading-5",e===8||e===9?"text-token-text-tertiary":"text-token-text-secondary"),children:a.jsx(ct,{children:l!=null&&a.jsx(ge.div,{className:"absolute left-0 top-0 line-clamp-1 overflow-visible",initial:r,animate:{opacity:1,x:0,y:0},exit:{opacity:0,x:0,y:-15},transition:c,onAnimationComplete:()=>{e===0&&n()},children:l},l.toString())})})}function rt(t){return t===0||t===2||t===3}function gm(t){return rt(t)||t===4||t===5||t===6||t===10}const Kn=Ae.div`group absolute left-0 top-0 mr-1.5 h-8 overflow-hidden mt-1`;function tn({highlightedCommand:t,status:e,children:s,showWorkUserSetting:n=!1,hideOnlyIfNotInteractedWith:o=!1,onOpenAnalytics:i}){const r=s!=null,[c]=u.useState(n),[l,m]=u.useState(n),[f,g]=u.useState(!1),d=e===Me.Finished||e===Me.Error,v=o?c?!1:!f:!1,x=e===Me.Running&&"loading-shimmer";return d&&v?null:r?a.jsxs(a.Fragment,{children:[a.jsx(Zn,{$canShowWork:!0,children:a.jsx(ct,{children:a.jsx(Kn,{children:a.jsx(ge.button,{onClick:()=>{l||i==null||i(),m(h=>!h),g(!0)},initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},className:G(x),children:a.jsxs("div",{className:"flex items-center justify-start gap-1",children:[a.jsx("span",{children:t}),l?a.jsx(nl,{className:"icon-md"}):a.jsx($a,{className:"icon-md"})]})},t==null?void 0:t.toString())})})}),a.jsx(ct,{children:l&&s&&a.jsx(ge.div,{initial:"collapsed",animate:"reveal",exit:"collapsed",variants:{collapsed:{translateY:-20,opacity:0,height:0},reveal:{translateY:0,opacity:1,height:"auto"}},transition:{duration:.3,ease:"easeInOut"},className:"overflow-hidden",children:s})})]}):a.jsx(Zn,{$canShowWork:!1,children:a.jsx(Kn,{className:G(x),children:t})})}const Zn=Ae.p`first:mt-0 my-1.5 relative h-8
${({$canShowWork:t})=>t?"text-token-text-secondary hover:text-token-text-primary":"text-token-text-secondary"}`,pm=fe(()=>ce(()=>import("./sso-m465dltvmezan4z2.js").then(t=>t.j),__vite__mapDeps([30,1,2,3,31,5,6,15,32,33,34,35,36,37,12,38,7,14,39,40,41,42,43,28,17,44,45,46,47,48,20,23,26,49,21,22,50,51,27,52,53,54,55,56,57,58,59,60,25,61,62,63,64,65,19,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,9,10,4,8,11,13,16,85])).then(t=>t.default).catch(()=>Ct)),Yn=fe(()=>ce(()=>import("./bb8bdhepry4v4att.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29])).then(t=>t.default));function xm({messages:t,isRequestActive:e,clientThreadId:s}){var b,M,I;const[n,o]=t,i=fo(n.message),r=(b=o==null?void 0:o.message.metadata)==null?void 0:b.aggregate_result,c=Fd(),l=Ys(),m=Ks(s),f=o!=null&&o.message?io(o.message):[],g=((I=(M=o==null?void 0:o.message.metadata)==null?void 0:M.aggregate_result)==null?void 0:I.messages.filter(so))??[],v=(f.filter(T=>T.type==="chart")??[]).length!==g.length,x=l&&!v;let h=Me.Running;return(r==null?void 0:r.status)==="success"?h=Me.Finished:o!=null&&o.message.content.content_type!==Qt.ExecutionOutput||r!=null&&r.status!=="running"?h=Me.Error:(i||!e)&&(h=Me.Stopped),a.jsxs(a.Fragment,{children:[a.jsx(ym,{messages:t,status:h,isRequestActive:e}),x&&f.map((T,y)=>{const{file_id:_,type:k}=T;return m?a.jsx(pm,{isStreaming:h===Me.Running,visualization:T},_):k==="chart"&&!c?(T.fallback_to_image=!0,a.jsx(Jn,{children:a.jsx(Yn,{clientThreadId:s,visualization:T})},y)):a.jsx(Jn,{children:a.jsx(Yn,{clientThreadId:s,visualization:T})},y)}),!x&&o!=null&&a.jsx(Dl,{message:o.message})]})}const Jn=Ae.div`mb-3 max-w-[80%]`;function ym({messages:t,status:e,isRequestActive:s}){var g;const[n,o]=t,i=re(),r=(g=o==null?void 0:o.message.metadata)==null?void 0:g.aggregate_result,c=fo(n.message),{data:l,error:m}=bi(wi.ShowExpandedCodeView);let f=i.formatMessage({id:"message.tools.data-analysis.running",defaultMessage:"Analyzing"});if((r==null?void 0:r.status)==="success"?f=i.formatMessage({id:"message.tools.data-analysis.finished",defaultMessage:"Analyzed"}):o!=null&&o.message.content.content_type!==Qt.ExecutionOutput||r!=null&&r.status!=="running"?f=i.formatMessage({id:"message.tools.data-analysis.error",defaultMessage:"Analysis errored"}):(c||!s)&&(f=i.formatMessage({id:"message.tools.data-analysis.stopped",defaultMessage:"Analysis paused"})),l!==void 0||m){const d=Fl(n.message)!=null;return a.jsx(tn,{status:e,highlightedCommand:f,showWorkUserSetting:l??!1,hideOnlyIfNotInteractedWith:!0,children:d?a.jsxs("div",{className:"mb-3 mt-0.5 overflow-hidden rounded-xl bg-black",children:[a.jsx(Ol,{message:n.message,FormattedText:qs}),o!=null&&a.jsx(Ll,{message:o.message})]}):null})}return null}const _m=3,vm=.1,Qn=[0,.6,.9];function Sm({nextMessage:t,isLastMessage:e,isRequestActive:s}){let n=e||(t==null?void 0:t.message.content.content_type)===Qt.Text&&!(t!=null&&t.message.content.parts.some(r=>r.length>0));const o=Vc(t==null?void 0:t.message),i=vc(o.slice(0,_m).map(r=>r.entries[0].url));if(n){const r=s?a.jsxs("div",{className:"flex items-center gap-1",children:[i.map((c,l)=>a.jsx(ge.div,{className:"-ml-1.5 first:ml-0 last:mr-1.5",initial:{width:l===0?0:6,opacity:0},animate:{width:20,opacity:1},transition:{duration:vm,delay:Qn[Math.min(l,Qn.length-1)]},children:a.jsx("div",{className:G("flex h-5 w-5 items-center overflow-hidden rounded","border-l-2 border-token-main-surface-primary bg-token-main-surface-primary"),children:a.jsx(Sc,{url:c,size:32,minSize:16,className:"icon-md rounded"})})},c)),a.jsx(U,{id:"jjx8Qg",defaultMessage:"Searching the web"})]}):a.jsx(U,{id:"fssXGM",defaultMessage:"Error while searching"});return a.jsx(tn,{highlightedCommand:r,status:s?Me.Running:Me.Error})}return null}const bm={strong:t=>{const{node:e,children:s,...n}=t;return a.jsx("strong",{...n,className:G(n.className,"font-semibold text-token-text-primary"),children:s})},p:t=>{const{node:e,children:s,...n}=t;return a.jsx("p",{...n,className:G(n.className,"text-base","has-[strong]:mb-1 [&:not(:first-child)]:has-[strong]:mt-3 [&:not(:has(strong))]:mb-3"),children:s})}};function wm({messages:t,isStreaming:e,clientThreadId:s}){var v,x;const[n,o]=u.useState(""),[i,r]=u.useState(!1),c=t[0].message,l=c.id,m=C.getServerThreadId(s),f=pa(c);u.useEffect(()=>{var I;const h=/\*\*(.*?)(?:\*\*|\n|$)/g;let b,M="";for(;(b=h.exec(f))!=null;)M=b[1].trim();M?o(M):((I=c.metadata)==null?void 0:I.initial_text)!=null&&o(c.metadata.initial_text)},[f,(v=c.metadata)==null?void 0:v.initial_text]),u.useEffect(()=>{f.length>0&&r(!0)},[f]);const g=u.useMemo(()=>({client_thread_id:s,message_id:l,conversationId:m}),[s,l,m]);u.useEffect(()=>{i&&O.logEvent(E.receivedA8KM123Message,g)},[i]);const d=u.useCallback(()=>{O.logEvent(E.openedA8KM123Message,{...g,isStreaming:e})},[g,e]);return a.jsx(tn,{status:e?Me.Running:Me.Finished,highlightedCommand:e?n:((x=c.metadata)==null?void 0:x.finished_text)??"",onOpenAnalytics:d,children:i?a.jsx("div",{className:"mb-4 border-l-2 pl-4 dark:border-token-text-secondary",children:a.jsx(qs,{componentOverrides:bm,className:"not-prose leading-6",children:f})}):null})}const km=fe(()=>ce(()=>import("./sso-m465dltvmezan4z2.js").then(t=>t.l),__vite__mapDeps([30,1,2,3,31,5,6,15,32,33,34,35,36,37,12,38,7,14,39,40,41,42,43,28,17,44,45,46,47,48,20,23,26,49,21,22,50,51,27,52,53,54,55,56,57,58,59,60,25,61,62,63,64,65,19,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,9,10,4,8,11,13,16,85])).then(t=>t.default).catch(()=>Ct)),Cm=fe(()=>ce(()=>import("./sso-m465dltvmezan4z2.js").then(t=>t.J),__vite__mapDeps([30,1,2,3,31,5,6,15,32,33,34,35,36,37,12,38,7,14,39,40,41,42,43,28,17,44,45,46,47,48,20,23,26,49,21,22,50,51,27,52,53,54,55,56,57,58,59,60,25,61,62,63,64,65,19,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,9,10,4,8,11,13,16,85])).then(t=>t.JawboneMessage).catch(()=>Ct)),Im=fe(()=>ce(()=>import("./nwdgitps5715fjrr.js"),__vite__mapDeps([87,1,2,3,5,6,14,7,17,18,19,20,12,21,22,23,24,25,26,27,16,28,29]))),Tm=fe(()=>ce(()=>import("./hiq2uqvms9k44pw9.js"),__vite__mapDeps([88,1,2,3]))),jm=fe(()=>ce(()=>import("./kv7lcod20q85em5w.js"),__vite__mapDeps([89,1,2,3,5,6,14,7,17,18,19,20,12,21,22,23,24,25,26,27,16,28,29]))),Mm=fe(()=>ce(()=>import("./jyta38vthxkl9at4.js"),__vite__mapDeps([90,1,2,3,5,6,14,7])).then(t=>t.TextMessageEditor)),Rm=fe(()=>ce(()=>import("./kkq6ejkwcpz47e34.js"),__vite__mapDeps([91,1,2,3,5,6,7,14,17,18,19,20,12,21,22,23,24,25,26,27,16,28,29]))),Em=fe(()=>ce(()=>import("./c9pp4qxhkprqxxy5.js"),__vite__mapDeps([92,1,2,3,5,6,14,7,17,18,19,20,12,21,22,23,24,25,26,27,16,28,29]))),Am=fe(()=>ce(()=>import("./m9wo85w1zzfrhnjm.js"),__vite__mapDeps([93,1,2,3,5,6,28,17,14,7,43,18,19,20,12,21,22,23,24,25,26,27,16,29])).then(t=>t.BrowsingMessage)),Nm=fe(()=>ce(()=>import("./mrkfan8chb2kdpoq.js"),__vite__mapDeps([94,1,2,3,5,6,14,7,17,18,19,20,12,21,22,23,24,25,26,27,16,28,29])).then(t=>t.SearchResultMessage)),Pm=fe(()=>ce(()=>import("./nr3txwuk5i1y7ib1.js"),__vite__mapDeps([95,1,2,3,5,6,17,14,7,19,20])).then(t=>t.GizmoContactsMessage)),Dm=fe(()=>ce(()=>import("./dspzz6qecxpomkde.js"),__vite__mapDeps([96,1,2,3,5,6,17,14,7,28,18,19,20,12,21,22,23,24,25,26,27,16,29])).then(t=>t.JITPluginMessage));function Cf(t){switch(t.type){case A.Text:case A.Debug:return[t.message];case A.MultiText:case A.Browsing:case A.CodeInterpreter:case A.JITPlugin:case A.RetrievalBrowsing:case A.ParallelBrowsing:case A.Dalle:case A.GizmoEditor:case A.SearchResult:case A.GizmoContacts:case A.a8km123:case A.Canmore:case A.Jawbone:case A.SearchGPTQuery:return t.messages;default:throw new Error("Bad")}}function If({groupedMessagesToRender:t,allGroupedMessages:e,clientThreadId:s,isEditing:n,isUserTurn:o,isCompletionRequestInProgress:i,isFeedbackEnabled:r,isFinalTurn:c,turnIndex:l,hasActiveRequest:m,showEditButton:f=!1,handleEnterEdit:g,handleExitEdit:d,onChangeItemInView:v,onRequestMoreCompletions:x,onRequestCompletion:h,shouldGrowContainer:b=!0}){const{showDebugConversationTurns:M}=La(),I=Vs(s),T=t.map((y,_)=>{var D,N,P,R,J,L,H,le,ae,Z,K,j,S;const k=_===e.length-1;switch(y.type){case A.Text:case A.MultiText:{const F=t[_-1],ee=F==null?void 0:F.type,ne=F&&"messages"in F?F.messages:void 0;if(y.type===A.Text){const V=n?a.jsx(Mm,{message:y.message,clientThreadId:s,onChangeItemInView:v,onRequestCompletion:h,onRequestMoreCompletions:x,onExitEdit:d,disabled:m}):a.jsx(sm,{className:"min-h-[20px]",message:y.message,isFeedbackEnabled:r,isCompletionInProgress:k&&i,turnIndex:l,clientThreadId:s,showEditButton:f,onEnterEdit:g,isUserTurn:o,onRequestMoreCompletions:x,prevGroupedMessageType:ee,prevGroupedMessages:ne});return a.jsxs(u.Fragment,{children:[V,a.jsx(bc,{isUserTurn:o,message:y.message.message})]},"group-"+y.message.nodeId)}else return y.type===A.MultiText?a.jsx(jm,{clientThreadId:s,messages:y.messages,isCompletionInProgress:k&&i,isFeedbackEnabled:r,onRequestMoreCompletions:x,prevGroupedMessageType:ee,prevGroupedMessages:ne},"multitext-"+(((D=y.messages[0])==null?void 0:D.nodeId)??_)):y.type}case A.Browsing:case A.RetrievalBrowsing:{const F=I!=null&&[Ce.GizmoInteraction,Ce.GizmoMagicCreate,Ce.GizmoTest].includes(I.kind);return a.jsx(Am,{messages:y.messages,isRequestActive:m,isLastMessageInTurn:k,isUsingGizmo:F,isRetrieval:y.type===A.RetrievalBrowsing},"browsing-"+(((N=y.messages[0])==null?void 0:N.nodeId)??_))}case A.SearchGPTQuery:{const F=e[_+1];return a.jsx(Sm,{isRequestActive:m,isLastMessage:k,nextMessage:F&&F.type===A.Text?F.message:void 0},"searchquery-"+(((P=y.messages[0])==null?void 0:P.nodeId)??_))}case A.a8km123:return a.jsx(wm,{messages:y.messages,isStreaming:k&&i,clientThreadId:s},"sum-"+(((R=y.messages[0])==null?void 0:R.nodeId)??_));case A.Jawbone:{const F=_+1<e.length?e[_+1]:void 0;return a.jsx(Cm,{nextMessage:F&&F.type===A.Debug?F.message:void 0,isLastMessage:k,isRequestActive:m},"jawbone-"+(((J=y.messages[0])==null?void 0:J.nodeId)??_))}case A.ParallelBrowsing:return a.jsx(Em,{messages:y.messages},"parallel-"+(((L=y.messages[0])==null?void 0:L.nodeId)??_));case A.CodeInterpreter:return a.jsx(xm,{messages:y.messages,isRequestActive:m,clientThreadId:s},"ada-"+(((H=y.messages[0])==null?void 0:H.nodeId)??_));case A.JITPlugin:return a.jsx(Dm,{messages:y.messages,clientThreadId:s,isLastTurnInConversation:c,onRequestCompletion:h},"jit-"+(((le=y.messages[0])==null?void 0:le.nodeId)??_));case A.GizmoContacts:return a.jsx(Pm,{messages:y.messages,clientThreadId:s,isLastTurnInConversation:c,onRequestCompletion:h},"gizmo-contacts-"+(((ae=y.messages[0])==null?void 0:ae.nodeId)??_));case A.Dalle:return a.jsx(Rm,{messages:y.messages,clientThreadId:s},"dalle-"+(((Z=y.messages[0])==null?void 0:Z.nodeId)??_));case A.GizmoEditor:return a.jsx(Im,{messages:y.messages},"gizmo-editor-"+(((K=y.messages[0])==null?void 0:K.nodeId)??_));case A.Canmore:return a.jsx(km,{clientThreadId:s,messages:y.messages,isRequestActive:m},"canmore-"+(((j=y.messages[0])==null?void 0:j.nodeId)??_));case A.Debug:return M?a.jsx(Tm,{message:y.message},"debug-"+y.message.nodeId):null;case A.SearchResult:return a.jsx(Nm,{messages:y.messages},"search-result-"+(((S=y.messages[0])==null?void 0:S.nodeId)??_))}});return a.jsx(Om,{shouldGrowContainer:b,children:T})}function Fm(){return a.jsx(wc,{type:"danger",children:a.jsx(U,{id:"daIg0P",defaultMessage:"Unable to display this message due to a error."})})}function Om({children:t,shouldGrowContainer:e}){return a.jsx("div",{className:G({"flex max-w-full flex-col":!0,"flex-grow":e}),children:a.jsx(ki,{name:"GroupedMessages",fallback:Fm,children:t})})}function Xn(t,e){t.updateNodeMetadata(e.id,{completionSampleFinishTime:Date.now()})}class Lm{constructor(e,s,n,o,i,r,c,l,m,f,g,d){z(this,"currentTree");z(this,"currentNodeId");z(this,"firstResponse",!0);z(this,"didCreateFirstCompletionInNewThread",!1);z(this,"activeBranchLastMessage");z(this,"messagesToUpdate",{});z(this,"allIncompleteStreamedMessages",{});z(this,"responseThreadId");z(this,"isCompletionBlocked",!1);z(this,"isEitherFlagged",!1);z(this,"variantsInStreamInfo");z(this,"activeBranchNodeId");z(this,"blurDuringCompletionTracker",new Cc);z(this,"completionLatencyTracker");z(this,"turnTracker");z(this,"debouncedUpdateCompletion",Ic(()=>{this.isCompletionBlocked||C.updateTree(this.clientThreadId,e=>{Object.values(this.messagesToUpdate).forEach(s=>{e.updateNodeMessage(s.id,s)})}),this.messagesToUpdate={}},50,{leading:!0,maxWait:50}));z(this,"handleResponse",async e=>{if(this.turnTracker.onUpdateEventCount(),this.completionLatencyTracker.onResponse(e,this.activeBranchLastMessage,this.responseThreadId),this.responseThreadId===void 0&&"conversationId"in e){const s=e.conversationId;this.responseThreadId=s,Wa(this.clientThreadId)&&C.getServerThreadId(this.clientThreadId)!==s&&(C.setServerIdForNewThread(this.clientThreadId,s),O.logEvent(E.attributeClientThreadToServerThread,{client_thread_id:this.clientThreadId,server_thread_id:s}))}switch(e.type){case"error":this.handleError(e);break;case"num_variants_in_stream":this.bindVariantInfoToTree(e);break;case"moderation":this.handleModeration(e);break;case"url_moderation":this.handleUrlModeration(e);break;case"message":this.handleMessage(e),this.debouncedUpdateCompletion();break;case"done":this.handleDone();break;case"gizmo_inline_review":this.handleGizmoInlineReview(e);break;case"title_generation":this.handleTitleGeneration(e);break;case"conversation_detail_metadata":this.handleConversationDetailMetadata(e);break}});this.queryClient=e,this.clientThreadId=s,this.targetNodeId=n,this.completionType=o,this.model=i,this.eventSource=r,this.onCreate=c,this.callModelAgain=m,this.onCompletionFinished=f,this.isHistoryAndTrainingDisabled=d,this.currentTree=C.getTree(s),this.currentNodeId=n,this.activeBranchLastMessage=this.currentTree.getMessage(this.currentNodeId),this.completionLatencyTracker=new kc(l),this.turnTracker=g,this.turnTracker.onCompletionStarted(o,this.model)}handleError(e){const s=e.error,n=(s==null?void 0:s.message)||"Something went wrong",o=s instanceof Ge&&s.code||"",i=s instanceof Ge&&s.status,r=s instanceof Ge?s.canRetry:void 0;switch(this.turnTracker.handleRawError(n,i),C.updateTree(this.clientThreadId,c=>{c.updateNodeMessage(this.currentNodeId,this.activeBranchLastMessage),c.updateNodeMetadata(this.currentNodeId,{err:n,errType:"danger",errCode:o,completionSampleFinishTime:Date.now(),canRetry:r})}),o){case vt.ContentPolicy:case vt.ContentOrTos:case ws:case Ci:break;default:n!==void 0&&He.logEvent("chatgpt_conversation_error_web",n)}this.blurDuringCompletionTracker.onMessageError(),this.cleanUp(),this.onCompletionFinished(this.responseThreadId),s instanceof Ge&&(s==null?void 0:s.code)===ws&&(s!=null&&s.clearsIn)&&(Tc(new Date(Date.now()+s.clearsIn*1e3).toISOString()),setTimeout(()=>{jc()},s.clearsIn*1e3))}handleGizmoInlineReview(e){C.setPromptGptRating(this.clientThreadId,e.gizmoId)}handleTitleGeneration(e){C.setTitle(this.clientThreadId,e.title,Ha.Generated)}handleConversationDetailMetadata(e){const{default_model_slug:s}=e;s&&C.setThreadModelId(this.clientThreadId,s),ys.updateDetails(e)}bindVariantInfoToTree(e){this.variantsInStreamInfo=e,C.updateTree(this.clientThreadId,s=>{const n=s.getParentPromptNode(this.currentNodeId);s.updateNodeMetadata(n.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}handleModeration(e){const{isCompletion:s,messageId:n,conversationId:o,flagged:i,blocked:r,disclaimers:c,metadata:l}=e,m=!!(c!=null&&c.length)&&s;(i||r||m)&&(this.isEitherFlagged=!0,r&&s&&(this.isCompletionBlocked=!0),C.updateTree(this.clientThreadId,f=>{const g=f.messageIdToNodeId(n);r&&f.clearNodeMessageParts(g),f.updateNodeMetadata(g,{...(m&&!!(c!=null&&c.length)&&Ii(c,r))??{},...i&&Ti,...r&&(l!=null&&l.model_incompatibility?ji:Mi),completionSampleFinishTime:Date.now()})}),O.logEvent(s?r?E.completionBlockedByModeration:E.completionFlaggedByModeration:r?E.promptBlockedByModeration:E.promptFlaggedByModeration,{threadId:o,id:n}))}handleUrlModeration(e){const{conversationId:s,url:n,isSafe:o}=e;o&&C.addThreadSafeUrl(s,n)}handleMessage(e){var i,r,c,l,m,f,g,d,v,x,h,b,M;let s=!0;const{message:n,conversationId:o}=e;if((n==null?void 0:n.author.role)===Se.Tool?this.turnTracker.onMessageUpdate((i=n.metadata)==null?void 0:i.model_slug,(r=n.metadata)==null?void 0:r.gizmo_id,n.author.name):this.turnTracker.onMessageUpdate((c=n.metadata)==null?void 0:c.model_slug,(l=n.metadata)==null?void 0:l.gizmo_id,void 0),this.firstResponse&&!this.currentTree.hasReceivedServerCompletion){if((n==null?void 0:n.author.role)===Se.System){const I=(m=n.metadata)!=null&&m.parent_id?this.currentTree.getNodeByIdOrMessageId(n.metadata.parent_id):void 0;if((I==null?void 0:I.message.author.role)!==Se.User){this.currentTree.appendSystemMessageToRoot(n);return}}else if((n==null?void 0:n.author.role)===Se.User)return;if(this.currentTree.hasNodeOrMessageId(n.id))return}if(this.firstResponse&&((f=n.metadata)!=null&&f.rebase_system_message)){C.updateTree(this.clientThreadId,I=>{var y;if(((y=n.metadata)==null?void 0:y.parent_id)==null)throw Error("Unexpected rebased system message without parent");const T=I.getNodeByIdOrMessageId(this.targetNodeId);I.deleteNode(this.targetNodeId),I.addNode(n.id,n,n.metadata.parent_id,n.author.role),I.addNode(T.id,T.message,n.id,T.message.author.role)});return}if(this.firstResponse){const I=((g=lt.getState().threads[this.clientThreadId])==null?void 0:g.continuingFromSharedConversationId)!=null;C.removeContinuingFromSharedConversationId(this.clientThreadId),this.firstResponse=!1,this.didCreateFirstCompletionInNewThread=!this.currentTree.hasReceivedServerCompletion||I,C.updateTree(this.clientThreadId,y=>{y.updateNodeMessage(this.currentNodeId,n)}),this.didCreateFirstCompletionInNewThread&&Cs.onCreate(this.onCreate,o,this.queryClient,this.isHistoryAndTrainingDisabled);const T={id:this.targetNodeId,threadId:o,completionType:this.completionType,eventSource:this.eventSource,model:this.model};if(this.completionType===Ke.Next){const y=lt.getState().threads[o],_=(d=y==null?void 0:y.conversationTurns)==null?void 0:d.length,k=(v=y==null?void 0:y.conversationTurns)==null?void 0:v.filter(N=>N.role==Se.User),D=k&&((x=k[k.length-1])==null?void 0:x.messages[0].message);if((D==null?void 0:D.content.content_type)==Qt.Text){const N=D.content.parts.join("").length,P=(k==null?void 0:k.length)??0;T.countConversationTurns=_,T.countUserSubmittedMessages=P,T.countLastUserPromptTextMessageLength=N}}O.logEvent(E.generateCompletion,T)}else if(this.completionType!==Ke.Continue){const I=this.currentTree.containsNodeOrMessageId(n.id),T=(h=n.metadata)==null?void 0:h.parent_id;if(I||(this.debouncedUpdateCompletion.flush(),C.updateTree(this.clientThreadId,y=>{if(T==null)throw new Error(`Received a message with no parentId: ${JSON.stringify(n)}`);y.addNode(n.id,n,T,Se.Assistant)})),T!=null&&T===this.activeBranchNodeId){const y=this.allIncompleteStreamedMessages[T];y!=null&&(C.updateTree(this.clientThreadId,_=>{Xn(_,y)}),delete this.allIncompleteStreamedMessages[T])}if(s=(((b=this.variantsInStreamInfo)==null?void 0:b.num_variants_in_stream)??1)===1||this.activeBranchNodeId==null||this.activeBranchNodeId===n.id||this.currentTree.isAncestorOfNode(this.activeBranchNodeId,n.id),s&&this.activeBranchNodeId!==n.id){this.activeBranchNodeId=n.id,this.currentNodeId=n.id;const y=C.getThreadCurrentLeafId(this.clientThreadId);this.currentTree.messageIdToNodeId(this.currentNodeId)!==this.currentTree.messageIdToNodeId(y)&&C.setThreadCurrentLeafId(this.clientThreadId,this.currentNodeId),T!=null&&C.updateTree(this.clientThreadId,_=>{const k=_.getParentPromptNode(n.id);_.updateNodeMetadata(k.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}}if((n==null?void 0:n.author.role)===Se.Tool&&(n==null?void 0:n.author.name)==="bio"){const I=(M=n.metadata)==null?void 0:M.gizmo_id;setTimeout(()=>{this.queryClient.invalidateQueries({queryKey:Mc(I)})},5e3)}s&&(this.activeBranchLastMessage=n),this.messagesToUpdate[n.id]=n,this.allIncompleteStreamedMessages[n.id]=n}async handleDone(){var e,s;if(this.turnTracker.logCompletion({type:ks.Success}),this.isCompletionBlocked||(this.debouncedUpdateCompletion.flush(),this.isEitherFlagged||(this.didCreateFirstCompletionInNewThread&&Cs.onCreateFinished(this.queryClient,this.responseThreadId,this.isHistoryAndTrainingDisabled),this.onCompletionFinished(this.responseThreadId))),C.updateTree(this.clientThreadId,n=>{Object.values(this.allIncompleteStreamedMessages).forEach(o=>{Xn(n,o)})}),Ga.publish({kind:"createConversation",clientThreadId:this.clientThreadId}),this.blurDuringCompletionTracker.onMessageDone(),this.cleanUp(),((s=(e=this.activeBranchLastMessage)==null?void 0:e.metadata)==null?void 0:s.client_actions)!==void 0){const n=await Rc(this.clientThreadId,this.activeBranchLastMessage);n.length>0&&this.callModelAgain(this.currentNodeId,n)}}cleanUp(){setTimeout(()=>{Bl(this.clientThreadId,fa.FINISHED),Hs.removeRequest(this.targetNodeId),C.releaseThread(this.clientThreadId)},0)}}const Bm=1e3*30,hs=xa.getTracer("completion"),gs=t=>(t==null?void 0:t.code)==="challenge_required";class ps extends Error{}function zm(t,e,s,n){const o=async(i=null,r=!1)=>{var L,H,le,ae,Z,K;await Ec();const c=new AbortController,l="threadId"in e?e.threadId:void 0,m="continueFromSharedConversationId"in e?e.continueFromSharedConversationId:void 0,f=Ri(),g={action:e.completionType,messages:e.messages.length>0?e.messages:void 0,conversation_id:l,continue_from_shared_conversation_id:l!=null?void 0:m,parent_message_id:e.parentMessageId,model:e.model,timezone_offset_min:new Date().getTimezoneOffset(),variant_purpose:(L=e.completionMetadata)==null?void 0:L.variantPurpose,suggestions:(H=e.completionMetadata)!=null&&H.suggestions?e.completionMetadata.suggestions.map(j=>Cl(j)):void 0,history_and_training_disabled:e.historyDisabled,juice:(le=e.completionMetadata)==null?void 0:le.juice,conversation_mode:(ae=e.completionMetadata)==null?void 0:ae.conversationMode,force_paragen:e.forceParagen,force_paragen_model_slug:e.forceParagenModel,force_nulligen:e.forceNulligen,force_indepth_feedback:e.forceIndepthFeedback,force_rate_limit:e.forceRateLimit,reset_rate_limits:e.resetRateLimits,disable_system_content_toggling:e.disableSystemContentToggling,websocket_request_id:f,source:(Z=e.completionMetadata)==null?void 0:Z.source,system_hints:(K=e.completionMetadata)==null?void 0:K.systemHints,force_use_sse:!It.isWebsocketConnected(),conversation_origin:e.conversationOrigin,force_use_search:e.forceUseSearch,client_contextual_info:e.contextualInfo},d=ta(await ea(t));let v="https://chatgpt.com/backend-api";d&&(v="https://chatgpt.com/backend-anon");const x=`${v}/conversation`;let h=!0,b=!0;const M=d?Sn.getUnauthHeaders().additionalHeaders:await Sn.getAuthedHeaders(),I=Ei(e.chatReq,i??e.arkoseToken,e.turnstileToken,e.proofToken,null),T={...M,...Ac(),...I};let y,_,k;hs.startActiveSpan("completion.response",j=>{y=hs.startSpan("completion.first_response"),_=hs.startSpan("completion.first_token"),k=j});const D=xa.setSpan(bn.active(),k);function N(j){if(j.data==="[DONE]")c.abort(),k.end(),s({type:"done"}),Mn();else if(j.event!=="ping")try{const S=JSON.parse(j.data);if(S.error){const F=new We(S.error);throw s({type:"error",error:F}),F}else"type"in S?S.type==="gizmo_inline_review"?s({type:"gizmo_inline_review",gizmoId:S.gizmo_id}):S.type==="title_generation"?s({type:"title_generation",title:S.title,conversation_id:S.conversation_id}):S.type==="moderation"?s({type:"moderation",conversationId:S.conversation_id,messageId:S.message_id,isCompletion:S.is_completion,flagged:S.moderation_response.flagged,blocked:S.moderation_response.blocked,disclaimers:S.moderation_response.disclaimers,metadata:S.moderation_response.metadata}):S.type==="url_moderation"?s({type:"url_moderation",conversationId:S.conversation_id,messageId:S.message_id,url:S.url_moderation_result.full_url,isSafe:S.url_moderation_result.is_safe}):S.type==="num_variants_in_stream"?s({type:"num_variants_in_stream",num_variants_in_stream:S.num_variants_in_stream,display_treatment:S.display_treatment}):S.type==="conversation_detail_metadata"&&s(S):(s({type:"message",message:S.message,conversationId:S.conversation_id}),b&&(b=!1,y.end()),h&&S.message.author.role==="assistant"&&S.message.content.content_type==="text"&&S.message.content.parts[0]!==""&&(h=!1,_.end()))}catch(S){if(S instanceof Ge)throw new We(S.message)}}let P=null,R=setTimeout(()=>{P===!0?(O.logEvent(E.asyncResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:ks.Error,error:{reason:"timeout",message:"Async Response Took Too Long to Come Back"}})):P===!1&&(O.logEvent(E.sseResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:ks.Error,error:{reason:"timeout",message:"SSE Response Took Too Long to Come Back"}}))},Bm);return ed(f,N,c.signal),bn.with(D,()=>Nc(x,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...T},body:JSON.stringify(g),signal:c.signal,openWhenHidden:!0,async onopen(j){var ee;const S=j.headers.get("content-type")??"",F=j.headers.get("Cf-Ray")??null;if(j.ok&&S.includes("text/event-stream")){P=!1,n(F,e.model,e.turnTracker);return}else if(S.includes("application/json")){const ne=await j.json(),{webSocketUrl:V,fallbackWebSocketUrl:pe,conversationId:W,responseId:Q,expiresAt:_e,websocketRequestId:te}=Xl(ne);if(V!=null&&W!=null&&Q!=null&&te!=null&&_e){P=!0,n(F,e.model,e.turnTracker);try{await td(V,pe,_e,W,Q,te,N,c.signal,R)}catch(p){p instanceof We&&s({type:"error",error:p})}throw new ps}else{const p=(ne==null?void 0:ne.error)??(ne==null?void 0:ne.detail),se=(p==null?void 0:p.message)??p??"Unknown server error";if(p){if(gs(p))throw new Ge(se,j.status,p.code);if(j.status>=500)throw new We(se);{if(((p==null?void 0:p.code)==="expired_session_key"||(p==null?void 0:p.code)==="invalid_api_key"||(p==null?void 0:p.code)==="token_expired")&&typeof window<"u"&&((ee=window._oaiHandleSessionExpired)==null||ee.call(window,"stream",JSON.stringify(p))),(p==null?void 0:p.code)==="deactivated_workspace"){window.location.href.includes("/workspace/deactivated")||(window.location.href="/workspace/deactivated");return}const de=p==null?void 0:p.can_retry;throw new Ge(se,j.status,p==null?void 0:p.code,p==null?void 0:p.type,void 0,p==null?void 0:p.clears_in,de)}}}}throw new We(wn)},onmessage:j=>{if(P)throw new We(wn);R&&(clearTimeout(R),R=null),N(j)},onerror(j){let S=j instanceof Error?j:new Error(JSON.stringify(j));throw S instanceof ps||P||gs(S)&&!r||(S.message==="Failed to fetch"&&(S=new We(`An error occurred. Either the engine you requested does not exist or there was another issue processing your request. ${xs}`)),S.message==="network error"&&(S=new Ge(`A network error occurred. Please check your connection and try again. ${xs}`,400)),Ai("fetch-error:conversation:new-message",{url:x,message:S==null?void 0:S.message}),s({type:"error",error:S}),Mn(S)),S}})).catch(async j=>{if(gs(j)){if(r)throw new Ge("Failed to complete your call, please try again",j.status);{const S=await $t.getEnforcementToken(e.chatReq);return o(S,!0)}}j instanceof ps||(De.addError(j),e.turnTracker.handleRawError(j.message??"Something went wrong",j.status))}),c};return o()}function Tf({clientThreadId:t,continuingFromSharedConversationId:e,onCompletionFinished:s=_t,onCreate:n=_t}){const o=ga(),{resolvedTheme:i}=As(),r=i==="dark",c=u.useRef(s),l=ha();c.current=s;const m=u.useCallback(async function({model:f,completionType:g,parentNodeId:d,metadata:v,focusOnNewCompletion:x=!0,completionMetadata:h,chatReq:b,arkoseToken:M,turnstileToken:I,proofToken:T,preflightTime:y,extraStreamParams:_,appendMessages:k,updateTree:D,turnTracker:N}){var W,Q,_e,te,p,se,de;Ga.publish({kind:"requestCompletion"});const P=C.getTree(t);C.retainThread(t);const R=Wc(),J=`${Ni}${t}-${R}`,L=`${t}-${R}`;D==null||D();const H=P.getNodeByIdOrMessageId(d),ae={gizmo_id:(W=H.message.metadata)==null?void 0:W.gizmo_id};(h==null?void 0:h.juice)!=null&&(ae.snorkle_status=1),C.updateTree(t,q=>{q.addNode(J,"",d,Se.Assistant,void 0,ae)}),x&&C.setThreadCurrentLeafId(t,J);let Z,K=[],j=P.getNodeByIdOrMessageId(H.parentId);for(;j!=null&&(((Q=j.metadata)==null?void 0:Q.isPlaceholderTemplateAssistantWelcomeMessage)===!0||((_e=j.metadata)==null?void 0:_e.isClientCreatedSystemMessage)===!0);){const q=j.message;K.unshift(q);const oe=P.getNodeByIdOrMessageId(j.parentId);Z=((te=oe.message)==null?void 0:te.id)??oe.id,j=oe}if(g===Ke.Next||g===Ke.Variant){const q=P.getNodeByIdOrMessageId(H.parentId);if(Z??(Z=((p=q.message)==null?void 0:p.id)??q.id),K.push(H.message),k){let oe=d;C.updateTree(t,be=>{for(const Y of k)be.insertNodeBefore(J,{id:Y.id,message:Y,parentId:oe,children:[]}),oe=Y.id}),K.push(...k)}K=Um(K,_)}else Z??(Z=H.message.id);const S=C.getServerThreadId(t);S===void 0&&Wa(t)&&C.updateInitialThreadDataForNewThread(t,f);async function F(q,oe){const be=performance.now(),Y=await ma();$t.initializeAndGatherData(Y),bs.initializeAndGatherData(Y),_s.initializeAndGatherData(Y),C.updateTree(t,ue=>{for(const Pe of oe)ue.addNode(Pe.id,Pe,q,Se.Assistant,{completionSampleFinishTime:Date.now()}),q=Pe.id}),C.setThreadCurrentLeafId(t,q);const Ie=await $t.getEnforcementToken(Y),B=await bs.getEnforcementToken(Y),ve=await _s.getEnforcementToken(Y);m({model:f,completionType:Ke.Next,parentNodeId:q,metadata:{},chatReq:Y,arkoseToken:Ie??null,turnstileToken:B??null,proofToken:ve??null,preflightTime:performance.now()-be,extraStreamParams:_,turnTracker:N})}N.updateAttachmentCount(K);const ee=new Lm(o,t,J,g,f,v.eventSource,n,L,F,(...q)=>c.current(...q),N,l),ne=(q,oe,be)=>{q&&be.onReceivedRequestId(q),Pc(L,oe,q,y)},V={is_dark_mode:r,time_since_loaded:Math.floor(performance.now()/1e3),page_height:window==null?void 0:window.innerHeight,page_width:window==null?void 0:window.innerWidth,pixel_ratio:window==null?void 0:window.devicePixelRatio,screen_height:(se=window==null?void 0:window.screen)==null?void 0:se.height,screen_width:(de=window==null?void 0:window.screen)==null?void 0:de.width},pe=await zm(o,{conversationOrigin:C.getConversationOrigin(t),model:f,completionType:g,threadId:S,continueFromSharedConversationId:e,historyDisabled:l,parentMessageId:Z,messages:K,chatReq:b,arkoseToken:M??null,turnstileToken:I??null,proofToken:T??null,completionMetadata:h,..._,turnTracker:N,contextualInfo:V},ee.handleResponse,ne);Hs.addRequest(J,pe,N),ho.onCompletionRequestStarted(J)},[t,o,n,e,l,r]);return m}const Um=(t,e)=>{let s=t;return(e==null?void 0:e.forceUseSearch)===!1&&t.length>0&&(s=t.map(n=>{const{system_hints:o,...i}=n.metadata||{};return{...n,metadata:{...i,system_hints:o==null?void 0:o.filter(r=>r!==it.Search)}}})),s};export{lo as A,If as C,vf as F,wf as G,zu as P,Sf as T,tn as a,Me as b,pf as c,mf as d,Fd as e,gf as f,io as g,hf as h,nm as i,fo as j,Yu as k,Zs as l,kf as m,uf as n,bf as o,ff as p,Ud as q,xf as r,yf as s,_f as t,Tf as u,Ou as v,Cf as w,sd as x,zd as y,It as z};
//# sourceMappingURL=e2osvzag8th7k1d1.js.map
