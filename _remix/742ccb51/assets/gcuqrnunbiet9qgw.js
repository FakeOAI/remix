const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/bt3c2fgrsug2x0bp.js","assets/hzfabz2o8ombe5jw.js","assets/e50u68bunhmm6ifm.js","assets/root-vof5cayc.css","assets/b1szi5jvhen4gvnt.js","assets/fk2on43rkvczq1b9.js","assets/conversation-small-eplmind9.css","assets/hq883kjug2canm9r.js","assets/mqp3qnuxehs7tnfk.js","assets/dh0f8516gl7ic2m5.js","assets/jyem616os9v6pvci.js","assets/shared-mk6ngktc.css","assets/iing67ocwnwqhcj6.js","assets/fn9vn6zf2cy4gvb8.js","assets/kidi4l5ce906yp53.js","assets/irzndtt8vp8asixn.js","assets/irlfwpllnqf5cc7o.js","assets/gljffeltmjrphbu7.js","assets/p40rplitvwe5wrs5.js","assets/ofosodv3ao9jq0q5.js","assets/oikdp1odqae9j9am.js","assets/f9zbh5kr0w936l1j.js","assets/blijo2l4axfx8qll.js","assets/palr457pmwp2eo4q.js","assets/oxp2by0qo126nz59.js","assets/hpzh4a2s0lujy0x2.js","assets/e78lqi6zd0w8e9e2.js","assets/oee1jj3teyc36auu.js","assets/sso-da2v16cola0b6d9b.js","assets/cx9iqieff3d5lozo.js","assets/dd6uhnn1vl27vlhq.js","assets/im28ivob0v4ras8n.js","assets/cbixnm84ireosly0.js","assets/ca6pihfn4nzu2hr0.js","assets/ljqk1ti0cdzpv7jp.js","assets/l20xuoh86vt5ltp3.js","assets/jrcn5pgxy87monl2.js","assets/fryg4d75k4u8c8g2.js","assets/ewcgetmyikugir9f.js","assets/eityua6nlv5j6zok.js","assets/kqwdyvkaaavvn8k3.js","assets/c1vhlymatzbrjjbv.js","assets/eci6p55lfimvbrx2.js","assets/cs1pbjud5beqmvob.js","assets/frmfbpruf1qisqhy.js","assets/m2sizihdyfg2gu3v.js","assets/00nn36n4egzr2nxv.js","assets/e6o3332cngm3w6wm.js","assets/l74dsvahvjko7x2l.js","assets/hxhkjo1bo8kdzzw0.js","assets/bp4id39vxnfirfjf.js","assets/ichnffdslcmsb0or.js","assets/0qw1jhy087yufhi6.js","assets/jkonglxztpn5ee12.js","assets/nhwwej1nq0zrd7sc.js","assets/e3ygs2v36ydwizmu.js","assets/9zpogk6h5akl73bx.js","assets/nx3l3hp1lv6ydgza.js","assets/isjdmfmhzv09v01t.js","assets/nknjtrw58f7sj49v.js","assets/knl1rcx3vtbv6j5b.js","assets/dddo62xabqbk9f31.js","assets/k4ajx5lgdjzcvr8x.js","assets/d2bzhwoj671nm961.js","assets/jtn6511x7p3193oe.js","assets/m4twnw270ztnlmiz.js","assets/3hvo7nk5lthtt35t.js","assets/g2v6xabl9buinz5s.js","assets/oupfz0i0b4mb7gjz.js","assets/iej0cupg2dqkmejt.js","assets/o691e2lbzvmjn1c6.js","assets/jk8w36bsokizpx57.js","assets/hlqnx05o8mk1fkdn.js","assets/jyu8zm911rprort0.js","assets/j1p0cnz4usckac9e.js","assets/ig8f6p5ucsumlhm4.js","assets/iz2mhlbiobeqe8he.js","assets/b2tciqdnf8m38qqo.js","assets/jpqsqnjtzaisfhgh.js","assets/ekec56inzvbn2coh.js","assets/clwolutsbvhxp28s.js","assets/zf6i5c345fifunq4.js","assets/sso-jmjhjxeo.css","assets/f5txz0bld0khrrji.js","assets/e013ogehxv76gvgq.js","assets/fedk582gxsh2zonc.js","assets/m7xadjibsu4du6rj.js","assets/gcyuzmphyovbrxct.js","assets/is13ttzunr7mpqnq.js","assets/mfi3wq24ucy8dkxn.js","assets/m8b5safipgf8vpm8.js","assets/owafx93funvtwfq9.js","assets/mx0nwxmshmrykz4d.js","assets/lhetph3t4j1sfvip.js"])))=>i.map(i=>d[i]);
var Go=Object.defineProperty;var Ho=(t,e,s)=>e in t?Go(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var B=(t,e,s)=>Ho(t,typeof e!="symbol"?e+"":e,s);import{R as Ze,a4 as De,bX as We,g0 as gs,cV as qo,P as O,A,bQ as we,g1 as Xn,fc as ea,ak as He,O as Ee,j as a,r as d,K as z,bz as xn,H as ae,e5 as Vo,c as U,bO as Wo,fF as $o,B as St,aU as Ko,bt as wt,bv as ta,g2 as sa,fz as ps,x as na,a5 as Zo,L as yt,N as Te,as as Ts,fv as Jo,fM as aa,aN as js,y as yn,u as oa,bT as ia,c2 as oe,bV as Yo,J as xs,ep as Qo,cN as _e,g3 as Ms,bH as ra,a7 as Ht,b_ as qt,bZ as Se,U as Xo,V as ei,W as ti,Q as si,ax as ca,dc as ni,g4 as Rs,cJ as ai,bD as Zt,X as la,a_ as oi,dF as ii,fH as da,eF as _n,aM as ua,cs as ri,eE as ci,f8 as li,cZ as ma,c_ as Vt,c$ as ys,d_ as di,g5 as ui,aC as mi,g6 as fi,g7 as hi,fD as gi,e9 as Ke,fj as fa,e$ as ha,E as ga,fw as _t,e6 as pi,aQ as xi,cm as de,cK as yi,g8 as _i,g9 as vi,w as bi,cz as pa,d9 as Es,c0 as As,c8 as Jt,aO as Si,aP as wi,cn as ki,br as Ge,fx as Ci,ga as Ii,gb as Ti,gc as ji,gd as Mi,ge as xa,ag as Ri,a2 as vn,gf as Ei,gg as bn,gh as Sn,gi as Ai,gj as Ni}from"./hzfabz2o8ombe5jw.js";import{iY as Pi,iZ as pe,i_ as Di,i$ as Gt,j0 as Pt,j1 as Fi,j2 as ya,a9 as Oi,dM as Li,bJ as Yt,aE as Qt,eA as Bi,gr as _a,eB as Ns,j3 as zi,cQ as Xt,n as Ps,j4 as Ui,j5 as va,F as Wt,eD as Ae,bR as Ds,j6 as Fe,u as Fs,A as ct,cq as Gi,ct as Hi,b3 as qi,bT as Vi,aO as Wi,cp as $i,hV as Ki,i9 as Zi,j7 as Ji,i6 as vt,j8 as me,j9 as ba,ja as _s,fJ as Yi,jb as Qi,jc as Xi,jd as er,je as tr,b2 as Sa,jf as sr,hO as wa,ar as ka,jg as nr,eL as ar,c8 as es,iT as or,e4 as Ca,ac as ir,jh as rr,ij as cr,ji as Ia,eE as ts,iX as bt,jj as $e,iP as tt,jk as ls,jl as lr,a5 as dr,jm as wn,jn as Ta,jo as $t,jp as Os,jq as Ls,jr as ja,js as Ma,d$ as Ra,iR as Ea,dZ as Aa,d_ as Na,jt as ur,ju as mr,iv as Bs,jv as fr,jw as Pa,iw as zs,jx as Us,jy as Dt,jz as hr,jA as gr,jB as pr,hS as Kt,I as Da,jC as xr,jD as yr,jE as _r,cA as vr,hz as br,hy as Fa,hL as Sr,hx as wr,jF as Oa,jG as kr,hs as vs,dT as it,cj as Cr,ch as Ir,jH as Tr,jI as jr,eF as Mr,jJ as Rr,jK as Er,E as Ar,am as La,jL as Nr,jM as kn,w as bs,i7 as Pr,jN as Dr,aa as Fr,U as Cn,ax as Ba,jO as Or,jP as Lr,jQ as Br,jR as zr,jS as Ur,cO as za,e0 as Gr,g6 as Hr,ev as In,jT as qr,jU as Vr,jV as Wr,s as $r,hK as Kr,hn as Ss,ho as Zr,jW as Jr,g3 as Gs,jX as Yr,cP as Qr,as as Tn,jY as Xr,aq as E,jZ as ec,j_ as tc,j$ as sc,hW as nc,hP as ac,gm as oc,hg as Ft,k0 as ds,k1 as ic,he as rc,hj as cc,hk as Hs,k2 as lc,k3 as dc,C as uc,k4 as xt,k5 as mc,k6 as fc,k7 as hc,k8 as gc,k9 as pc,gW as Ua,e1 as xc,G as yc,bI as _c,ka as vc,cn as bc,kb as Sc,kc as wc,B as kc,kd as Cc,ke as Ic,cu as Tc,kf as ws,a0 as Ga,kg as jc,kh as Mc,ki as Rc,kj as Ec,kk as jn,kl as Ac}from"./fk2on43rkvczq1b9.js";import{q as qs,d as Oe,T as k,E as Ha,Y as Nc,b as ss,f as qa,w as lt,u as dt,e as Pc,c as Va,g as Dc,N as Fc,k as Oc,Z as Lc,_ as Bc,A as zc,h as Uc,$ as Gc,a0 as Hc,i as Wa,a1 as qc}from"./iing67ocwnwqhcj6.js";import{a2 as $a,bx as Vc,aa as Ka,bZ as Wc,R as $c,bg as Kc,b_ as Zc,Z as Vs,ae as Jc,b$ as Yc,aJ as Qc,bP as Za,ag as Xc,z as el,a5 as tl}from"./e50u68bunhmm6ifm.js";import{d as Ws,U as sl,h as nl,J as Ja,V as al,H as ol,u as il,W as rl,X as cl,Y as ll,Z as dl,y as ul}from"./irzndtt8vp8asixn.js";import{a as ml}from"./irlfwpllnqf5cc7o.js";import{m as fe}from"./hq883kjug2canm9r.js";import{u as fl,P as hl,I as gl}from"./gljffeltmjrphbu7.js";import{D as Q}from"./jyem616os9v6pvci.js";import{r as Ya,e as pl,f as xl}from"./ofosodv3ao9jq0q5.js";import{t as yl,i as Qa,f as _l,h as Xa,u as eo,T as vl,M as bl,a as Sl,j as wl}from"./blijo2l4axfx8qll.js";import{G as kl}from"./p40rplitvwe5wrs5.js";import{K as Cl,C as Il,L as Tl,O as jl,Q as Ot,U as Ml,V as Rl,W as El,F as kt,H as to,X as Al}from"./palr457pmwp2eo4q.js";import{a as $s}from"./hpzh4a2s0lujy0x2.js";import{i as so,a as Nl,g as Pl,b as Dl,c as Fl}from"./kidi4l5ce906yp53.js";import{s as Ol}from"./f9zbh5kr0w936l1j.js";import{g as Mn}from"./e78lqi6zd0w8e9e2.js";import{r as Ll}from"./oee1jj3teyc36auu.js";var no=Ll();function Bl(t){if(typeof t!="string")throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!t)throw new Error("No input");const e=JSON.parse(t),s=e;let n;if(s.type==="system")if(s.event==="connected")n=Object.assign(Object.assign({},e),{kind:"connected"});else if(s.event==="disconnected")n=Object.assign(Object.assign({},e),{kind:"disconnected"});else return null;else if(s.type==="message")if(s.from==="group"){const o=En(e.data,e.dataType);if(o===null)return null;n=Object.assign(Object.assign({},e),{data:o,kind:"groupData"})}else if(s.from==="server"){const o=En(e.data,e.dataType);if(o===null)return null;n=Object.assign(Object.assign({},e),{data:o,kind:"serverData"})}else return null;else if(s.type==="ack")n=Object.assign(Object.assign({},e),{kind:"ack"});else return null;return n}function zl(t){let e;switch(t.kind){case"joinGroup":{e={type:"joinGroup",group:t.group,ackId:t.ackId};break}case"leaveGroup":{e={type:"leaveGroup",group:t.group,ackId:t.ackId};break}case"sendEvent":{e={type:"event",event:t.event,ackId:t.ackId,dataType:t.dataType,data:Rn(t.data,t.dataType)};break}case"sendToGroup":{e={type:"sendToGroup",group:t.group,ackId:t.ackId,dataType:t.dataType,data:Rn(t.data,t.dataType),noEcho:t.noEcho};break}case"sequenceAck":{e={type:"sequenceAck",sequenceId:t.sequenceId};break}default:throw new Error(`Unsupported type: ${t.kind}`)}return JSON.stringify(e)}function Rn(t,e){switch(e){case"text":{if(typeof t!="string")throw new TypeError("Message must be a string.");return t}case"json":return t;case"binary":case"protobuf":{if(t instanceof ArrayBuffer)return no.Buffer.from(t).toString("base64");throw new TypeError("Message must be a ArrayBuffer")}}}function En(t,e){if(e==="text"){if(typeof t!="string")throw new TypeError("Message must be a string when dataType is text");return t}else{if(e==="json")return t;if(e==="binary"||e==="protobuf"){const s=no.Buffer.from(t,"base64");return s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength)}else return null}}class Ul{constructor(){this.isReliableSubProtocol=!0,this.name="json.reliable.webpubsub.azure.v1"}parseMessages(e){return Bl(e)}writeMessage(e){return zl(e)}}const Gl=()=>new Ul;var be;(function(t){t.Stopped="Stopped",t.Disconnected="Disconnected",t.Connecting="Connecting",t.Connected="Connected",t.Recovering="Recovering"})(be||(be={}));class Hl{nextAckId(){return this._ackId=this._ackId+1,this._ackId}constructor(e,s){this._quickSequenceAckDiff=300,this._activeTimeoutInMs=2e4,this._emitter=new Pi,this._isStopping=!1,this._isInitialConnected=!1,typeof e=="string"?this._credential={getClientAccessUrl:e}:this._credential=e,s==null&&(s={}),this._buildDefaultOptions(s),this._options=s,this._messageRetryPolicy=new An(this._options.messageRetryOptions),this._reconnectRetryPolicy=new An(this._options.reconnectRetryOptions),this._protocol=this._options.protocol,this._groupMap=new Map,this._ackMap=new Map,this._sequenceId=new Wl,this._state=be.Stopped,this._ackId=0}async start(e){if(this._isStopping)throw new Error("Can't start a client during stopping");if(this._state!==be.Stopped)throw new Error("Client can be only started when it's Stopped");let s;e&&(s=e.abortSignal),this._activeKeepaliveTask||(this._activeKeepaliveTask=this._getActiveKeepaliveTask());try{await this._startCore(s)}catch(n){throw this._changeState(be.Stopped),this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0),this._isStopping=!1,n}}async _startFromRestarting(e){if(this._state!==be.Disconnected)throw new Error("Client can be only restarted when it's Disconnected");try{pe.verbose("Staring reconnecting."),await this._startCore(e)}catch(s){throw this._changeState(be.Disconnected),s}}async _startCore(e){if(this._changeState(be.Connecting),pe.info("Staring a new connection"),this._sequenceId.reset(),this._isInitialConnected=!1,this._lastCloseEvent=void 0,this._lastDisconnectedMessage=void 0,this._connectionId=void 0,this._reconnectionToken=void 0,this._uri=void 0,typeof this._credential.getClientAccessUrl=="string"?this._uri=this._credential.getClientAccessUrl:this._uri=await this._credential.getClientAccessUrl({abortSignal:e}),typeof this._uri!="string")throw new Error(`The clientAccessUrl must be a string but currently it's ${typeof this._uri}`);await this._connectCore(this._uri)}stop(){this._state===be.Stopped||this._isStopping||(this._isStopping=!0,this._wsClient&&this._wsClient.isOpen()?this._wsClient.close():this._isStopping=!1,this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0))}on(e,s){this._emitter.on(e,s)}off(e,s){this._emitter.removeListener(e,s)}_emitEvent(e,s){this._emitter.emit(e,s)}async sendEvent(e,s,n,o){return await this._operationExecuteWithRetry(()=>this._sendEventAttempt(e,s,n,o),o==null?void 0:o.abortSignal)}async _sendEventAttempt(e,s,n,o){var i;if(!((i=o==null?void 0:o.fireAndForget)!==null&&i!==void 0?i:!1))return await this._sendMessageWithAckId(c=>({kind:"sendEvent",dataType:n,data:s,ackId:c,event:e}),o==null?void 0:o.ackId,o==null?void 0:o.abortSignal);const l={kind:"sendEvent",dataType:n,data:s,event:e};return await this._sendMessage(l,o==null?void 0:o.abortSignal),{isDuplicated:!1}}async joinGroup(e,s){return await this._operationExecuteWithRetry(()=>this._joinGroupAttempt(e,s),s==null?void 0:s.abortSignal)}async _joinGroupAttempt(e,s){const n=this._getOrAddGroup(e),o=await this._joinGroupCore(e,s);return n.isJoined=!0,o}async _joinGroupCore(e,s){return await this._sendMessageWithAckId(n=>({group:e,ackId:n,kind:"joinGroup"}),s==null?void 0:s.ackId,s==null?void 0:s.abortSignal)}async leaveGroup(e,s){return await this._operationExecuteWithRetry(()=>this._leaveGroupAttempt(e,s),s==null?void 0:s.abortSignal)}async _leaveGroupAttempt(e,s){const n=this._getOrAddGroup(e),o=await this._sendMessageWithAckId(i=>({group:e,ackId:i,kind:"leaveGroup"}),s==null?void 0:s.ackId,s==null?void 0:s.abortSignal);return n.isJoined=!1,o}async sendToGroup(e,s,n,o){return await this._operationExecuteWithRetry(()=>this._sendToGroupAttempt(e,s,n,o),o==null?void 0:o.abortSignal)}async _sendToGroupAttempt(e,s,n,o){var i,r;const l=(i=o==null?void 0:o.fireAndForget)!==null&&i!==void 0?i:!1,c=(r=o==null?void 0:o.noEcho)!==null&&r!==void 0?r:!1;if(!l)return await this._sendMessageWithAckId(h=>({kind:"sendToGroup",group:e,dataType:n,data:s,ackId:h,noEcho:c}),o==null?void 0:o.ackId,o==null?void 0:o.abortSignal);const u={kind:"sendToGroup",group:e,dataType:n,data:s,noEcho:c};return await this._sendMessage(u,o==null?void 0:o.abortSignal),{isDuplicated:!1}}_getWebSocketClientFactory(){return new Di}async _trySendSequenceAck(){if(!this._protocol.isReliableSubProtocol)return;const[e,s]=this._sequenceId.tryGetSequenceId();if(e&&s){const n={kind:"sequenceAck",sequenceId:s};try{await this._sendMessage(n)}catch{this._sequenceId.tryUpdate(s)}}}_connectCore(e){if(this._isStopping)throw new Error("Can't start a client during stopping");return new Promise((s,n)=>{const o=this._wsClient=this._getWebSocketClientFactory().create(e,this._protocol.name);o.onopen(()=>{if(this._isStopping){try{o.close()}catch{}n(new Error("The client is stopped"))}pe.verbose("WebSocket connection has opened"),this._changeState(be.Connected),this._protocol.isReliableSubProtocol&&(this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),this._sequenceAckTask=new Nn(async()=>{await this._trySendSequenceAck()},1e3)),s()}),o.onerror(i=>{this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),n(i)}),o.onclose((i,r)=>{this._state===be.Connected?(pe.verbose("WebSocket closed after open"),this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),pe.info(`WebSocket connection closed. Code: ${i}, Reason: ${r}`),this._lastCloseEvent={code:i,reason:r},this._handleConnectionClose.call(this)):(pe.verbose("WebSocket closed before open"),n(new Error(`Failed to start WebSocket: ${i}`)))}),o.onmessage(i=>{const r=m=>{if(this._ackMap.has(m.ackId)){const _=this._ackMap.get(m.ackId);this._ackMap.delete(m.ackId);const p=m.error!=null&&m.error.name==="Duplicate";m.success||p?_.resolve({ackId:m.ackId,isDuplicated:p}):_.reject(new Pt("Failed to send message.",{ackId:m.ackId,errorDetail:m.error}))}},l=async m=>{if(this._connectionId=m.connectionId,this._reconnectionToken=m.reconnectionToken,!this._isInitialConnected){if(this._isInitialConnected=!0,this._options.autoRejoinGroups){const _=[];this._groupMap.forEach(p=>{p.isJoined&&_.push((async()=>{try{await this._joinGroupCore(p.name)}catch(f){this._safeEmitRejoinGroupFailed(p.name,f)}})())});try{await Promise.all(_)}catch{}}this._safeEmitConnected(m.connectionId,m.userId)}},c=m=>{this._lastDisconnectedMessage=m},u=m=>{if(m.sequenceId!=null){const _=this._sequenceId.tryUpdate(m.sequenceId);if(_===0)return;_>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitGroupMessage(m)},h=m=>{if(m.sequenceId!=null){const _=this._sequenceId.tryUpdate(m.sequenceId);if(_===0)return;_>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitServerMessage(m)};let g;try{let m;if(Array.isArray(i)?m=Buffer.concat(i):m=i,g=this._protocol.parseMessages(m),g===null)return}catch(m){throw pe.warning("An error occurred while parsing the message from service",m),m}Array.isArray(g)||(g=[g]),g.forEach(m=>{try{switch(m.kind){case"ack":{r(m);break}case"connected":{l(m);break}case"disconnected":{c(m);break}case"groupData":{u(m);break}case"serverData":{h(m);break}}}catch(_){pe.warning(`An error occurred while handling the message with kind: ${m.kind} from service`,_)}})})})}async _handleConnectionCloseAndNoRecovery(){this._state=be.Disconnected,this._safeEmitDisconnected(this._connectionId,this._lastDisconnectedMessage),this._options.autoReconnect?await this._autoReconnect():await this._handleConnectionStopped()}async _autoReconnect(){let e=!1,s=0;try{for(;!this._isStopping;)try{await this._startFromRestarting(),e=!0;break}catch(n){pe.warning("An attempt to reconnect connection failed.",n),s++;const o=this._reconnectRetryPolicy.nextRetryDelayInMs(s);if(o==null)break;try{pe.verbose(`Delay time for reconnect attempt ${s}: ${o}`),await Gt(o)}catch{}}}finally{e||this._handleConnectionStopped()}}_handleConnectionStopped(){this._isStopping=!1,this._state=be.Stopped,this._safeEmitStopped()}_getActiveKeepaliveTask(){return new Nn(async()=>{this._sequenceId.tryUpdate(0)},this._activeTimeoutInMs)}async _sendMessage(e,s){if(!this._wsClient||!this._wsClient.isOpen())throw new Error("The connection is not connected.");const n=this._protocol.writeMessage(e);await this._wsClient.send(n,s)}async _sendMessageWithAckId(e,s,n){s==null&&(s=this.nextAckId());const o=e(s);this._ackMap.has(s)||this._ackMap.set(s,new Vl(s));const i=this._ackMap.get(s);try{await this._sendMessage(o,n)}catch(r){this._ackMap.delete(s);let l="";throw r instanceof Error&&(l=r.message),new Pt(l,{ackId:s})}if(n)try{return await Fi(i.promise(),n)}catch(r){throw r instanceof Error&&r.name==="AbortError"?new Pt("Cancelled by abortSignal",{ackId:s}):r}return await i.promise()}async _handleConnectionClose(){if(this._ackMap.forEach((o,i)=>{this._ackMap.delete(i)&&o.reject(new Pt("Connection is disconnected before receive ack from the service",{ackId:o.ackId}))}),this._isStopping){pe.warning("The client is stopping state. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(this._lastCloseEvent&&this._lastCloseEvent.code===1008){pe.warning("The websocket close with status code 1008. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(!this._protocol.isReliableSubProtocol){pe.warning("The protocol is not reliable, recovery is not applicable"),this._handleConnectionCloseAndNoRecovery();return}const e=this._buildRecoveryUri();if(!e){pe.warning("Connection id or reconnection token is not available"),this._handleConnectionCloseAndNoRecovery();return}let s=!1;this._state=be.Recovering;const n=ya.timeout(30*1e3);try{for(;!n.aborted||this._isStopping;)try{await this._connectCore.call(this,e),s=!0;return}catch{await Gt(1e3)}}finally{s||(pe.warning("Recovery attempts failed more then 30 seconds or the client is stopping"),this._handleConnectionCloseAndNoRecovery())}}_safeEmitConnected(e,s){this._emitEvent("connected",{connectionId:e,userId:s})}_safeEmitDisconnected(e,s){this._emitEvent("disconnected",{connectionId:e,message:s})}_safeEmitGroupMessage(e){this._emitEvent("group-message",{message:e})}_safeEmitServerMessage(e){this._emitEvent("server-message",{message:e})}_safeEmitStopped(){this._emitEvent("stopped",{})}_safeEmitRejoinGroupFailed(e,s){this._emitEvent("rejoin-group-failed",{group:e,error:s})}_buildDefaultOptions(e){return e.autoReconnect==null&&(e.autoReconnect=!0),e.autoRejoinGroups==null&&(e.autoRejoinGroups=!0),e.protocol==null&&(e.protocol=Gl()),this._buildMessageRetryOptions(e),this._buildReconnectRetryOptions(e),e}_buildMessageRetryOptions(e){e.messageRetryOptions||(e.messageRetryOptions={}),(e.messageRetryOptions.maxRetries==null||e.messageRetryOptions.maxRetries<0)&&(e.messageRetryOptions.maxRetries=3),(e.messageRetryOptions.retryDelayInMs==null||e.messageRetryOptions.retryDelayInMs<0)&&(e.messageRetryOptions.retryDelayInMs=1e3),(e.messageRetryOptions.maxRetryDelayInMs==null||e.messageRetryOptions.maxRetryDelayInMs<0)&&(e.messageRetryOptions.maxRetryDelayInMs=3e4),e.messageRetryOptions.mode==null&&(e.messageRetryOptions.mode="Fixed")}_buildReconnectRetryOptions(e){e.reconnectRetryOptions||(e.reconnectRetryOptions={}),(e.reconnectRetryOptions.maxRetries==null||e.reconnectRetryOptions.maxRetries<0)&&(e.reconnectRetryOptions.maxRetries=Number.MAX_VALUE),(e.reconnectRetryOptions.retryDelayInMs==null||e.reconnectRetryOptions.retryDelayInMs<0)&&(e.reconnectRetryOptions.retryDelayInMs=1e3),(e.reconnectRetryOptions.maxRetryDelayInMs==null||e.reconnectRetryOptions.maxRetryDelayInMs<0)&&(e.reconnectRetryOptions.maxRetryDelayInMs=3e4),e.reconnectRetryOptions.mode==null&&(e.reconnectRetryOptions.mode="Fixed")}_buildRecoveryUri(){if(this._connectionId&&this._reconnectionToken&&this._uri){const e=new URL(this._uri);return e.searchParams.append("awps_connection_id",this._connectionId),e.searchParams.append("awps_reconnection_token",this._reconnectionToken),e.toString()}return null}_getOrAddGroup(e){return this._groupMap.has(e)||this._groupMap.set(e,new ql(e)),this._groupMap.get(e)}_changeState(e){pe.verbose(`The client state transfer from ${this._state.toString()} to ${e.toString()}`),this._state=e}async _operationExecuteWithRetry(e,s){let n=0;for(;;)try{return await e.call(this)}catch(o){n++;const i=this._messageRetryPolicy.nextRetryDelayInMs(n);if(i==null||(await Gt(i),s!=null&&s.aborted))throw o}}}class An{constructor(e){this._retryOptions=e,this._maxRetriesToGetMaxDelay=Math.ceil(Math.log2(this._retryOptions.maxRetryDelayInMs)-Math.log2(this._retryOptions.retryDelayInMs)+1)}nextRetryDelayInMs(e){return e>this._retryOptions.maxRetries?null:this._retryOptions.mode==="Fixed"?this._retryOptions.retryDelayInMs:this._calculateExponentialDelay(e)}_calculateExponentialDelay(e){return e>=this._maxRetriesToGetMaxDelay?this._retryOptions.maxRetryDelayInMs:(1<<e-1)*this._retryOptions.retryDelayInMs}}class ql{constructor(e){this.isJoined=!1,this.name=e}}class Vl{constructor(e){this._promise=new Promise((s,n)=>{this._resolve=s,this._reject=n}),this.ackId=e}promise(){return this._promise}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}class Wl{constructor(){this._sequenceId=0,this._isUpdate=!1}tryUpdate(e){if(this._isUpdate=!0,e>this._sequenceId){const s=e-this._sequenceId;return this._sequenceId=e,s}return 0}tryGetSequenceId(){return this._isUpdate?(this._isUpdate=!1,[!0,this._sequenceId]):[!1,null]}reset(){this._sequenceId=0,this._isUpdate=!1}}class Nn{constructor(e,s,n){this._func=e,this._abortController=new ya,this._interval=s,this._obj=n,this._start()}abort(){try{this._abortController.abort()}catch{}}async _start(){const e=this._abortController.signal;for(;!e.aborted;)try{await this._func(this._obj)}catch{}finally{await Gt(this._interval)}}}const $l=1e3*60*60,Kl=1e3*30;class Zl{constructor(e,s,n,o=null,i=new Map){B(this,"client");B(this,"handler");B(this,"terminationTimeout",null);B(this,"connectionUrl");B(this,"expiresAt");B(this,"connected",!1);B(this,"websocketRequestId",null);B(this,"conversationId",null);B(this,"secondaryTypeBasedHandlers",new Map);this.connectionUrl=s,this.expiresAt=n,this.client=new Hl({getClientAccessUrl:()=>e(this.connectionUrl,this.expiresAt)},{autoReconnect:!0,reconnectRetryOptions:{maxRetries:5,retryDelayInMs:100,maxRetryDelayInMs:1e4,mode:"Exponential"}}),this.handler=o,this.secondaryTypeBasedHandlers=i}async start(){const e=s=>{if(this.secondaryTypeBasedHandlers.has(s.message.data.type)){const n=this.secondaryTypeBasedHandlers.get(s.message.data.type);if(!n)return;n(s.message.data)}else{const n=s.message.data.body,o=atob(n).trim();if(o.startsWith("data: ")){const i=o.replace("data: ",""),r=this.handler;if(!r)return;r({conversationId:s.message.data.conversation_id,responseId:s.message.data.response_id,message:{id:"",event:"",data:i},websocketRequestId:s.message.data.websocket_request_id})}}};this.client.on("group-message",s=>e(s)),this.client.on("server-message",s=>e(s)),this.client.on("connected",()=>{this.connected=!0}),this.client.on("disconnected",()=>{this.connected=!1}),await this.client.start()}addSecondaryTypeHandler(e,s){this.secondaryTypeBasedHandlers.set(e,s)}isConnected(){return this.connected}async stop(e){e&&this.conversationId!==e||this.websocketRequestId&&await Ze.stopWebsocketConversation(this.websocketRequestId)}setHandler(e,s,n,o){!this.handler&&this.websocketRequestId===n||(this.handler!=null&&this.websocketRequestId!==n&&(qo.warn("[websockets] Overwriting existing handler without silencing. This may indicate a race condition."),O.logEvent(A.asyncHandlerOverwritten,{originalWebsocketRequestId:this.websocketRequestId,newWebsocketRequestId:n,conversationId:e,responseId:s})),this.websocketRequestId=n,this.conversationId=e,this.handler=i=>{(i.websocketRequestId===n||i.conversationId===e&&i.responseId===s)&&o(i.message)})}silence(){this.handler=null}close(){this.client.stop()}scheduleForTermination(e){this.terminationTimeout=setTimeout(()=>{this.close(),e()},$l)}preventTermination(){this.terminationTimeout&&(clearTimeout(this.terminationTimeout),this.terminationTimeout=null)}updateConnectionUrl(e,s){this.connectionUrl=e,this.expiresAt=s}}class Jl{constructor(){B(this,"activeSocketMap",new Map);B(this,"secondaryTypeBasedHandlers",new Map)}async register(){const e=await Ze.postRegisterWebsocket();e.wss_url&&(this.getOrCreateSocket(e.wss_url,new Date(e.expires_at),!0),e.fallback_wss_url&&this.getOrCreateSocket(e.fallback_wss_url,new Date(e.expires_at),!1))}async registerIfNotConnected(){if(this.activeSocketMap.size===0){await this.register();return}for(const e of this.activeSocketMap.values())if(!e.isConnected()){await this.register();return}}isWebsocketConnected(){for(const e of this.activeSocketMap.values())if(e.isConnected())return!0;return this.activeSocketMap.size>0&&De.addError("Cannot connect to any websocket."),!1}async getOrCreateSocket(e,s,n){const o=e.split("?")[0];let i;const r=this.activeSocketMap.get(o);if(r&&r.isConnected())r.preventTermination(),r.updateConnectionUrl(e,s),i=r;else{r&&r.close(),i=new Zl(async(l,c)=>{if(new Date<new Date(c.getTime()-5*1e3))return l;const u=await Ze.postRegisterWebsocket();return n?u.wss_url:u.fallback_wss_url??""},e,s,null,this.secondaryTypeBasedHandlers),this.activeSocketMap.set(o,i);try{await i.start()}catch(l){throw De.addError(new Error("Error occurred while starting websocket: ",{cause:l})),l}}return i}preSetupWebsocket(e,s,n){for(const o of this.activeSocketMap.values())this.setupWebSocketHandler(o,null,null,null,e,s,n)}addSecondaryTypeHandler(e,s){this.secondaryTypeBasedHandlers.set(e,s);for(const n of this.activeSocketMap.values())n.addSecondaryTypeHandler(e,s)}hasSecondaryTypeHandler(e){return this.secondaryTypeBasedHandlers.has(e)}async processWebSocketConversationStream(e,s,n,o,i,r,l,c,u){const h=[this.getOrCreateSocket(e,n,!0)];s&&h.push(this.getOrCreateSocket(s,n,!1));const g=await Promise.allSettled(h),m=g[0].status==="fulfilled"?g[0].value:null,_=g.length>1&&g[1].status==="fulfilled"?g[1].value:null;if((!m||!m.isConnected())&&De.addError(`Cannot connect to primary websocket, websocketRequestId: ${r}, token: ${e.substring(0,e.indexOf("access_token="))}`),(!m||!m.isConnected())&&(!_||!_.isConnected()))throw s&&De.addError(`Cannot connect to fallback websocket, websocketRequestId: ${r}, token: ${s.substring(0,s.indexOf("access_token="))}`),new We(`An error occurred while connecting to the websocket. ${gs}`);let p=setTimeout(()=>{De.addError(`WebSocket took too long to respond: ${i}, ${o}, ${r}, ${e.substring(0,60)}...${e.slice(-20)}`,{supportsWebSockets:"WebSocket"in window&&window.WebSocket.CLOSING===2})},Kl);const f=I=>(u&&(clearTimeout(u),u=null),p&&(clearTimeout(p),p=null),l(I));m&&this.setupWebSocketHandler(m,e,o,i,r,f,c),_&&s&&this.setupWebSocketHandler(_,s,o,i,r,f,c)}async stopConversation(e){for(const s of this.activeSocketMap.values())await s.stop(e)}setupWebSocketHandler(e,s,n,o,i,r,l){e.setHandler(n,o,i,r),this.secondaryTypeBasedHandlers.forEach((u,h)=>{e.addSecondaryTypeHandler(h,u)});const c=()=>{s?e.scheduleForTermination(()=>{this.activeSocketMap.delete(s.split("?")[0])}):(this.stopConversation(n),e.silence())};l.addEventListener("abort",c)}}const Ct=new Jl;function Yl(t){return{webSocketUrl:t.wss_url,fallbackWebSocketUrl:t.fallback_wss_url,conversationId:t.conversation_id,responseId:t.response_id,expiresAt:t.expires_at&&new Date(t.expires_at),websocketRequestId:t.websocket_request_id}}async function Ql(t,e,s){return Ct.preSetupWebsocket(t,e,s)}async function Xl(t,e,s,n,o,i,r,l,c){return Ct.processWebSocketConversationStream(t,e,s,n,o,i,r,l,c)}function ed(t){return t==null||[we.PrimaryAssistant,we.GizmoInteraction].includes(t.kind)}function Ks(t,e){const s=qs(t,e),{data:n}=Ws(s!=null&&"gizmo_id"in s?s.gizmo_id:void 0,(s==null?void 0:s.kind)===we.GizmoTest);if(s!=null)switch(s.kind){case we.GizmoInteraction:case we.GizmoMagicCreate:case we.GizmoTest:return{gizmo:n,...s};case we.PrimaryAssistant:return s}}function td(t,e,s){const o=k.getTree(e).getMessageId(k.getThreadCurrentLeafId(e));Ze.generateTitle(e,o,s).then(({title:i})=>{k.setTitle(e,i,Ha.Generated),Ya(t),O.logEvent(A.renameThread,{threadId:e,content:i,model:s})}).catch(De.addError)}function sd(t,e,s){const n=()=>{const i=Mn(s);t(i)},o=Oe.getGizmoId(s);o!=null?sl(e,o).then(i=>{Oi(Mn(s,i))}).catch(i=>{De.addError(i),n()}):n()}const ks={onCreate(t,e,s,n){O.logEvent(A.newThread),!n&&ed(Oe.getConversationMode(e))&&Xn(s).then(o=>{ea(o)||(Ya(s),sd(t,s,e))})},onCreateFinished(t,e,s){var n;if(!(s||!e)&&!He.checkGate("2562876640")){const o=(n=Oe.getThread(e))==null?void 0:n.initialThreadData.lastModelUsed;o==null&&De.addError("missing lastModelUsed on conversation create finished"),td(t,e,o)}}},Pn=Ee.div`m-8 flex flex-col items-center`;function Dn(t){return a.jsx(fe.div,{initial:{opacity:0,translateY:20},animate:{opacity:1,translateY:0,transition:{duration:.5,ease:"easeIn"}},...t})}function nd({clientThreadId:t}){const e=Nc(t),s=e==null?void 0:e.gizmoId,{data:n}=Ws(s);return s==null||n==null||!Li(n)?null:a.jsx(ad,{gizmoId:s})}function ad({gizmoId:t}){const[e,s]=d.useState(!1),[n,o]=d.useState(!1),i=nl(t),r=async c=>{s(!0),setTimeout(()=>{o(!0)},5e3),O.logEvent(A.submitInlineRating,{gizmo_id:t,rating:c}),await i.mutateAsync({rating:c})},l=async()=>{o(!0),O.logEvent(A.dismissInlineRating,{gizmo_id:t}),await i.mutateAsync({})};return d.useEffect(()=>{n||O.logEvent(A.showInlineRating,{gizmo_id:t})},[n,t]),n?null:e?a.jsx(Pn,{children:a.jsxs(Dn,{className:"flex flex-col items-center gap-4",children:[a.jsx("div",{className:"rounded-lg border border-token-border-heavy p-4",children:a.jsxs("div",{className:"flex justify-between gap-2",children:[a.jsx(z,{id:"gizmo.inlineReview.reviewLeft",defaultMessage:"Feedback sent"}),a.jsx(xn,{onClick:()=>{o(!0)}})]})}),a.jsx("div",{className:"text-xs text-token-text-tertiary",children:a.jsx(z,{id:"gizmo.inlineReview.reviewLeftSubtext",defaultMessage:'To update your rating, click "Send Feedback" in the GPT Menu'})})]})}):a.jsx(Pn,{children:a.jsxs(Dn,{className:"flex flex-col items-center gap-4 rounded-lg border border-token-border-heavy p-4",children:[a.jsxs("div",{className:"flex justify-between gap-2",children:[a.jsx(z,{id:"gizmo.inlineReview.prompt",defaultMessage:"How would you rate this GPT so far?"}),a.jsx(xn,{onClick:l})]}),a.jsx(ml,{rating:void 0,onRating:r})]})})}function od(t,e){const s=Yt(Qt.MentionGPTs),n=Bi(),[o,i]=d.useState(!1),r=()=>{i(!0),s.markAsViewed()};return d.useImperativeHandle(e,()=>({handleClose:r})),s.eligible&&!s.isLoading&&!n?a.jsx(id,{wasDismissed:o,onDismiss:r}):null}function id({wasDismissed:t,onDismiss:e}){const s=ae(),{recent:n,pinned:o}=fl(),i=n&&n.pages.flatMap(r=>r.list.items).length>0||o&&o.items.length>0;return d.useEffect(()=>{i&&O.logEvent(A.mentionsDisplayNux)},[i]),i?a.jsx(_a,{badge:"beta",align:"start",side:"top",arrowPadding:58,show:!t,title:s.formatMessage({id:"mentionGptsAnnouncement.title",defaultMessage:"GPT mentions"}),onDismiss:e,sideOffset:25,theme:"default",description:a.jsx(z,{id:"mentionGptsAnnouncement.description",defaultMessage:"Type {key} to mention a GPT and add it directly into your conversation",values:{key:a.jsx("span",{className:"font-bold",children:"@"})}}),children:a.jsx("div",{className:"absolute sm:left-16"})}):null}const rd=d.forwardRef(od);function cd({composerController:t}){const{doesUserHaveAnyAccountsWithPlusFeatures:e}=Vo(),s=ae(),n=Ns();return a.jsxs("div",{className:U("flex justify-between",!n&&"bg-gradient-to-t from-token-main-surface-primary to-transparent px-4"),children:[a.jsx("div",{className:"flex gap-2",children:a.jsx(dd,{onClickStyle:o=>{On(s.formatMessage(o.expandedName??o.name),t)}})}),e&&a.jsx("div",{className:"flex gap-2",children:a.jsx(ld,{onClickAspectRatio:o=>On(s.formatMessage(o.expandedName),t)})})]})}function ld({onClickAspectRatio:t}){const e=ae();return a.jsxs(Q.Root,{onOpenChange:s=>{s&&(He.logEvent(A.dalleOpenAspectRatioDropdown),O.logEvent(A.dalleOpenAspectRatioDropdown))},children:[a.jsxs(Cs,{$as:Q.Trigger,className:"pr-1.5",children:[a.jsx(z,{id:"dalleControls.aspectRatio",defaultMessage:"Aspect Ratio"}),a.jsx($a,{className:"icon-md"})]}),a.jsx(Q.Portal,{children:a.jsx(Q.Content,{children:zi.map(s=>a.jsx(Q.Item,{onClick:()=>{var n;t(s),He.logEvent(A.dalleClickAspectRatio,(n=s.name.defaultMessage)==null?void 0:n.toString()),O.logEvent(A.dalleClickAspectRatio,{aspectRatio:s.name.defaultMessage})},icon:s.icon,children:e.formatMessage(s.name)},s.name.id))})})]})}function dd({onClickStyle:t}){const[e,s]=d.useState(Fn()),n=Wo(),o=$o(),i=Xt(),r=ae();let l=2;return i||(o?l=5:n&&(l=3)),a.jsxs(a.Fragment,{children:[e.slice(0,l).map(c=>a.jsx(Ps,{label:a.jsx(ud,{style:c}),side:"top",sideOffset:4,customPaddingClassName:"p-1",children:a.jsxs(Cs,{$as:"button",type:"button",onClick:()=>{var u;t(c),He.logEvent(A.dalleClickStyle,(u=c.name.defaultMessage)==null?void 0:u.toString()),O.logEvent(A.dalleClickStyle,{style:c.name.defaultMessage})},children:[a.jsx(Vc,{className:"h-4 w-4 text-token-text-tertiary"}),r.formatMessage(c.name)]})},c.name.id)),a.jsx(Cs,{$as:"button",type:"button",onClick:()=>{s(Fn()),He.logEvent(A.dalleShuffleStyles),O.logEvent(A.dalleShuffleStyles)},children:a.jsx(Ui,{className:"icon-sm text-token-text-tertiary"})}),va.map(c=>a.jsx("img",{src:c.image.src,alt:r.formatMessage(c.name),width:100,height:100,className:"invisible fixed -left-96 -top-96"},c.name.id))]})}function ud({style:t}){const e=ae();return a.jsxs("div",{className:"flex flex-col gap-1",children:[a.jsx("img",{src:t.image.src,alt:e.formatMessage(t.name),width:100,height:100,className:"rounded-md"}),a.jsx("div",{className:"text-xs font-medium",children:e.formatMessage(t.name)})]})}function Fn(){return[...va].sort(()=>Math.random()-.5)}function md(t,e){const s=e.getCurrentText();return s.trim()===""?t:s.endsWith(",")?` ${t.toLocaleLowerCase()}`:s.endsWith(", ")?t.toLocaleLowerCase():`, ${t.toLocaleLowerCase()}`}function On(t,e){const s=md(t,e);e.appendText(s),Wt()}const Cs=Ee.div`h-7 bg-token-main-surface-primary border border-token-border-light text-xs hover:bg-token-main-surface-secondary hover:text-token-text-primary px-2.5 radix-state-open:bg-token-main-surface-secondary radix-state-open:text-token-text-primary rounded-full flex flex-nowrap gap-0.5 items-center text-token-text-secondary font-normal`,Lt={initial:{opacity:0,y:20,scale:.9},animate:{opacity:1,y:0,scale:1},transition:{delay:.1},exit:{opacity:0,scale:.5,transition:{duration:.2}}},fd=({suggestions:t,onSelectingSuggestedReply:e})=>a.jsx("div",{className:"absolute bottom-full flex w-full max-w-[100vw] grow gap-2 overflow-auto px-1 pb-1 contain-inline-size sm:mb-0 sm:justify-start sm:px-2 sm:pb-0 md:static md:mb-2 md:max-w-none md:justify-center md:overflow-visible",children:t.slice(0,2).map((s,n)=>a.jsx(fe.div,{initial:Lt.initial,animate:Lt.animate,transition:{delay:(n-1)*Lt.transition.delay},exit:Lt.exit,children:a.jsx(wt,{as:"button",color:"secondary",size:"small",onClick:()=>{e(s,t,n)},className:"group whitespace-nowrap md:whitespace-normal",children:a.jsx(gd,{suggestion:s})},n)},n))});function hd({suggestions:t,onSelectingSuggestedReply:e,clientThreadId:s}){const n=(t==null?void 0:t.length)>0;d.useEffect(()=>{n&&yl(t,s)},[n,s]);const{isUnauthenticated:o}=St();return n?t.every(Qa)?a.jsxs(fe.div,{initial:{opacity:0},animate:{opacity:1},transition:{duration:.3},className:"flex flex-col items-center",children:[o&&a.jsx(Ko,{className:"mb-6 h-12 w-12 sm:hidden"}),a.jsx(_l,{starterPrompts:t,onSelectStarterPrompt:e})]}):t.every(Xa)?a.jsx(fd,{suggestions:t,onSelectingSuggestedReply:e}):null:null}function gd({suggestion:t}){return Xa(t)?a.jsx(a.Fragment,{children:t.text}):Qa(t)?a.jsxs("div",{className:"flex flex-col overflow-hidden",children:[t.title&&a.jsx("div",{className:"truncate font-semibold",children:t.title}),a.jsx("div",{className:U("truncate font-normal",t.title?"opacity-50":""),children:t.body})]}):null}function pd(){const{store:t}=Ae(),e=t.useSharedProps();return e?a.jsx(xd,{...e}):null}function xd({clientThreadId:t,suggestions:e}){const s=eo();return e===void 0||e.length===0?null:a.jsx("div",{children:a.jsx(yd,{children:a.jsx("div",{className:"grow",children:e!==void 0&&a.jsx(hd,{suggestions:e,onSelectingSuggestedReply:s,clientThreadId:t})})})})}const yd=Ee.div`h-full flex ml-1 md:w-full md:m-auto gap-0 md:gap-2 justify-center`,ao=({className:t,children:e})=>a.jsx(fe.div,{className:t,initial:{opacity:0},animate:{opacity:1},exit:{opacity:0,transition:{duration:.1,delay:0}},transition:{type:"tween",duration:.3,delay:.2},children:e});function _d({currentLeafId:t,canContinue:e,onContinueGenerating:s}){const n=d.useCallback(()=>{const i=new Ds;s(t,i),Wt()},[s,t]);let o=null;return e&&(o=a.jsx(vd,{onHandleContinueGenerating:n})),o&&a.jsx("div",{className:"flex h-full w-full items-center justify-end gap-0 py-4 md:gap-2",children:o})}const vd=({onHandleContinueGenerating:t})=>{const e=ta();return a.jsx(ao,{children:a.jsxs(wt,{as:"button",color:"secondary",onClick:t,className:"whitespace-nowrap border-0 md:border",children:[a.jsx(Ka,{className:U("-rotate-180",e?"icon-xs":"icon-sm")}),e&&a.jsx(z,{...Fe.continueGenerating})]})})},bd=({clientThreadId:t})=>{const e=sa(),s=ss(t),n=Fs(s);d.useEffect(()=>{n&&ps.dismissBanner()},[n]);const o=e!=null&&e.is_dismissible?()=>ps.dismissBanner():void 0;return a.jsx(ct,{children:e&&a.jsx(fe.div,{transition:{type:"tween",ease:"easeInOut",duration:.1},initial:{opacity:0,transform:"translateY(8px)"},animate:{opacity:1,transform:"translateY(0px)"},exit:{opacity:0,transform:"translateY(8px)"},children:a.jsx(hl,{clientThreadId:t,rateLimitInfo:e,onDismiss:o})})})};function Sd(t){const e=ss(t),s=Fs(e),n=sa();return!s&&n!=null}const Ue=window.sessionStorage,Is=na(Zo(()=>({memoryFullBannerDismissed:!!(Ue!=null&&Ue.getItem(yt.MemoryFullBannerDismissed))}))),oo={dismissBanner(){Is.setState(t=>{t.memoryFullBannerDismissed=!0}),Ue==null||Ue.setItem(yt.MemoryFullBannerDismissed,"true")},clearDismissedBanner(){Is.setState(t=>{t.memoryFullBannerDismissed=!1}),Ue==null||Ue.removeItem(yt.MemoryFullBannerDismissed)}};function wd(t){const e=qa(t),s=Gi(),{data:n}=Hi(e,!1,s),o=n!=null,i=o&&n.memoryFullPct>=100,[r,l]=d.useState(!1);d.useEffect(()=>{!i&&o&&(l(!0),oo.clearDismissedBanner())},[i,o]);const c=Is(u=>u.memoryFullBannerDismissed);return i&&r&&!c}function kd(){const t=ae(),{openSettings:e}=qi();return a.jsx(fe.div,{initial:{opacity:0},animate:{opacity:1},children:a.jsx(Vi,{title:t.formatMessage(Bt.memoryFullTitle),content:t.formatMessage(Bt.memoryFullTooltip,Bt.memoryFullTooltip.values),primaryCtaText:t.formatMessage(Bt.memoryManageButton),onPrimaryCtaClick:()=>e(Wi.Personalization),onDismiss:()=>oo.dismissBanner()})})}const Bt=Te({memoryFullTitle:{id:"yRGU2/",defaultMessage:"Memory is full."},memoryManageButton:{id:"a5A88o",defaultMessage:"Manage"},memoryFullTooltip:{id:"neUc+N",defaultMessage:"New memories won’t be created until you make space. <a>Learn more</a>",values:{a:t=>a.jsx("a",{href:$i,target:"_blank",rel:"noopener noreferrer",className:"underline",children:t})}}}),Cd=()=>{const{shouldShowSkipButton:t}=Ki();return t?a.jsx(ao,{className:"flex justify-center",children:a.jsx(wt,{as:"button",color:"secondary",onClick:()=>Zi.skipParagen(),children:a.jsx(z,{...Id.skip})})}):null},Id=Te({skip:{id:"dvcUbp",defaultMessage:"Skip"}}),Td=d.memo(function({className:e}){const{store:s}=Ae(),n=s.useIsHeaderContentAreaPopulated();return a.jsx("div",{className:U(e??"absolute bottom-full left-0 right-0",_s.PromptTextareaHeader),children:a.jsx(Ji,{shouldRender:n,contentArea:vt.Header,children:a.jsxs("div",{className:"mb-2 flex flex-col gap-3.5 pt-2",children:[a.jsx(jd,{}),a.jsx(Md,{})]})})})});function jd(){const{store:t}=Ae(),e=t.useContentAreaId(vt.HeaderTop);let s;switch(e){case me.ParagenControls:s=a.jsx(Cd,{});break;case me.ItemActions:s=a.jsx(pd,{});break;case me.BannerSignup:s=a.jsx(Ed,{});break;case me.BannerTermsDisclaimer:s=a.jsx(Ad,{});break;case me.PromptTextareaAction:s=a.jsx(Nd,{});break;case me.BannersRateLimit:s=a.jsx(Pd,{});break;case me.BannerSidekickAnnouncement:s=a.jsx(pl,{});break;case me.BannerMemoryFull:s=a.jsx(kd,{});break;case me.Box:s=a.jsxs("div",{className:"flex h-20 w-full items-center justify-center gap-2 bg-red-500 p-2",children:["box",a.jsxs("div",{className:"flex h-full w-full items-center justify-center gap-2 bg-blue-500 p-2",children:["inner",a.jsx("div",{className:"flex h-full w-full items-center justify-center bg-yellow-400 text-center",children:"actual content"})]})]});break;default:s=null;break}return s}function Md(){const{store:t}=Ae(),e=t.useContentAreaId(vt.HeaderBottom);let s;switch(e){case ba.DallePromptControls:s=a.jsx(Rd,{});break;default:s=null;break}return s}function Rd(){const{store:t}=Ae(),e=t.useSharedProps(s=>s==null?void 0:s.composerController);return e?a.jsx(cd,{composerController:e}):null}function Ed(){const{store:t}=Ae(),e=t.useSharedProps(o=>o==null?void 0:o.clientThreadId),s=Yi(),n=Qi();return e?s?a.jsx(Xi,{threadId:e,showSignUp:n}):a.jsx(er,{threadId:e,showLogin:n}):null}function Ad(){const{store:t}=Ae(),e=t.useSharedProps(s=>s==null?void 0:s.clientThreadId);return e?a.jsx(tr,{threadId:e}):null}function Nd(){const{store:t}=Ae(),e=t.useSharedProps();return e?a.jsx(_d,{...e}):null}function Pd(){const{store:t}=Ae(),e=t.useSharedProps(s=>s==null?void 0:s.clientThreadId);return e?a.jsx(bd,{clientThreadId:e}):null}function Zs(){return aa(js.DataAnalysisV2)}function rf(){const t=Sa(),e=Ts();return e&&t&&!Jo(t)&&e.isEnterprise()}function Dd(){return aa(js.ChartSerialization)}function cf(t,e){const s=t==="chart"?yt.HasSeenAdaInteractiveChart:yt.HasSeenAdaInteractiveTable,[n,o]=d.useState(yn.getItem(s,{userId:e})??!1),i=d.useCallback(()=>{o(!0),yn.setItem(s,!0,{userId:e})},[s,e]);return[n,i]}function lf(t){const[e,s]=d.useState([]),n=lt(()=>{const o=k.resolveThreadId(t),i=k.getThreadCurrentLeafId(t);return k.getTree(o).getBranchFromLeaf(i)});return d.useEffect(()=>{const o=ro(n);o.length!==e.length&&s(o)},[e.length,t,n]),e}function Fd(t){return lt(()=>{const e=k.resolveThreadId(t),s=k.getThreadCurrentLeafId(t),o=k.getTree(e).getBranchFromLeaf(s);return ro(o).length>0})}function io(t){var i,r,l,c;const e=((r=(i=t.metadata)==null?void 0:i.aggregate_result)==null?void 0:r.messages.filter(so))??[];let s=0;const n=(((l=t.metadata)==null?void 0:l.ada_visualizations)??[]).map(u=>{let h=u;return u.type=="chart"&&(h={...u,fallback_image:e[s++]}),h}),o=(((c=t.metadata)==null?void 0:c.attachments)??[]).filter(u=>ka(u.name)).map(u=>({type:"table",file_id:u.id??"",title:nr(u),file_name:u.name,context_connector_info:u.context_connector_info}));return[...n,...o]}function ro(t){return t.filter(s=>{var n,o,i,r;return((n=s.message)==null?void 0:n.author.role)==="tool"&&((o=s.message)==null?void 0:o.author.name)==="python"||(((r=(i=s.message)==null?void 0:i.metadata)==null?void 0:r.attachments)??[]).length>0}).flatMap(s=>io(s.message))}na(t=>({selectedSpreadsheet:null,setSelectedSpreadsheet:e=>t({selectedSpreadsheet:e})}));async function Od(t,e,s){const n=await t.text(),{parse:o}=await oe(async()=>{const{parse:r}=await import("./oeujip5i1ptrxie5.js");return{parse:r}},[]),i=o(n);return{content:{columnNames:i.shift(),columnTypes:i[0].map(()=>"string"),rows:i},file_name:e,download_url:s}}function Ld(t){const e=t[0].values.length,s=[];for(let n=0;n<e;n++){const o=t.map(i=>i.values[n]);s.push(o)}return s}function df(t){return oa({queryKey:["ada-visualization","chart",t.file_id],queryFn:async()=>{const e=await Ze.getFileDownloadLink(t.file_id);if(e.status===ia.Success){const n=await(await fetch(e.download_url)).json();return{content:{chart_type:n.type,title:n.title,labels:n.labels,datasets:n.datasets,x_label:n.x_label,y_label:n.y_label},file_name:e.file_name??"",download_url:e.download_url}}else throw new Error("Failed to download chart json from interpreter")}})}function uf(t){return oa({queryKey:["ada-visualization","table",t.file_id],queryFn:async()=>{if(t.file_name&&sr(t.file_name)){const e=await Ze.getAdaExcelFileContents(t.file_id);return{content:e.sheets.map(s=>({name:s.name,columnNames:s.columns.map(n=>n.name),columnTypes:s.columns.map(()=>"string"),rows:Ld(s.columns)})),download_url:e.download_url,file_name:t.file_name}}else{const e=await Ze.getFileDownloadLink(t.file_id);if(e.status===ia.Success){const s=await fetch(e.download_url);return Od(s,e.file_name??"",e.download_url)}else throw new Error("Failed to download from interpreter")}}})}function Bd(t){const e=wa(),s=Fd(t),n=Zs();return s&&n&&!e.displayingSideBySideFeedback}function zd(t){var e,s;return((s=(e=t.metadata)==null?void 0:e.dalle)==null?void 0:s.prompt)??""}async function Ud(t,e,s="image/png"){return new Promise((n,o)=>{t.toBlob(i=>{i!=null?n(new File([i],e,{type:s})):o(new Error("Failed to convert canvas to blob"))},s)})}async function Gd(t,e){const s=document.createElement("canvas");s.width=t.width,s.height=t.height;const n=s.getContext("2d");if(n==null)throw new Error("Failed to get 2d context for mask canvas");const o=n.createImageData(t.width,t.height);for(let i=0;i<t.data.length;i+=4)t.data[i+3]!==0?(o.data[i]=0,o.data[i+1]=0,o.data[i+2]=0,o.data[i+3]=255):(o.data[i]=255,o.data[i+1]=255,o.data[i+2]=255,o.data[i+3]=255);return n.putImageData(o,0,0),Ud(s,e)}async function Hd(t,e){const n=await(await fetch(t)).blob(),o=document.createElement("a");o.href=URL.createObjectURL(n),o.download=e,o.click(),o.remove()}function qd(t){const e=ir(new Date,"yyyy-MM-dd HH.mm.ss");let s=t.slice(0,150);return s.endsWith(".")&&(s=s.slice(0,-1)),`DALL·E ${e} - ${s}.webp`}async function mf(t,e,s){var i,r,l,c,u,h,g,m,_,p;const n=zd(t),o=qd(n);await Hd(t.url,o),He.logEvent("chatgpt_dalle_image_download",null,{sourceOperation:((r=(i=t.metadata)==null?void 0:i.dalle)==null?void 0:r.edit_op)??"none",hasParent:((c=(l=t.metadata)==null?void 0:l.dalle)==null?void 0:c.parent_gen_id)!=null?"true":"false"}),O.logEvent(A.dalleImageDownload,{conversationId:e,messageId:s,generationId:(h=(u=t.metadata)==null?void 0:u.dalle)==null?void 0:h.gen_id,parentGenerationId:(m=(g=t.metadata)==null?void 0:g.dalle)==null?void 0:m.parent_gen_id,fileId:es(t.asset_pointer),sourceOperation:(p=(_=t.metadata)==null?void 0:_.dalle)==null?void 0:p.edit_op})}function Vd(t){const e=Ks(t),s=Xt(),n=e&&"gizmo"in e?e.gizmo:void 0;return!s&&(n==null?void 0:n.gizmo.id)===ar}function ff(t,e){var o,i;const s=(i=(o=e.metadata)==null?void 0:o.dalle)==null?void 0:i.gen_id,n=es(e.asset_pointer);return n==null||s==null?t:{...t,messageMetadata:{...t.messageMetadata,dalle:{from_client:{operation:{type:"transformation",original_gen_id:s,original_file_id:n}}}}}}async function Wd(t,e,s){return new Promise((n,o)=>{or(Ca(t),t,e,{kind:Yo.DalleAgent},{onFileCreated:xs,onFileUploadProgress:xs,onFileUploaded:(i,r)=>n(r),onError:(i,r)=>{o(new Error(`Failed to upload file with reason: ${r}`))}},s)})}async function hf(t,e,s,n){var r,l;const o=(l=(r=e.metadata)==null?void 0:r.dalle)==null?void 0:l.gen_id,i=es(e.asset_pointer);if(i==null||o==null||s==null)return t;try{const c=await Gd(s,"mask.png"),u=await Wd(c,n,{imageDimensions:{width:e.width,height:e.height}});return{...t,messageMetadata:{...t.messageMetadata,dalle:{from_client:{operation:{type:"inpainting",original_gen_id:o,original_file_id:i,mask_file_id:u}}}}}}catch(c){return De.addError(c),t}}const $d=d.memo(function(e){return Kd(e),Zd(e),Jd(),null});function Kd(t){const{store:e}=Ae(),s=e.useSetSharedProps();d.useLayoutEffect(()=>{s(t)},[t,s])}function Zd(t){const{clientThreadId:e,canContinue:s}=t,{store:n}=Ae(),o=d.useRef({top:n.useContentAreaApi(vt.HeaderTop),bottom:n.useContentAreaApi(vt.HeaderBottom)}).current,i=Xd(t),r=Vd(e),{shouldShowBannerSignup:l,shouldShowBannerTermsDisclaimer:c}=eu(e),u=Sd(e),h=xl(t),g=wd(e),m=rr();d.useLayoutEffect(()=>{m?o.top.set(me.ParagenControls):c?o.top.set(me.BannerTermsDisclaimer):u?o.top.set(me.BannersRateLimit):h.eligible?o.top.set(me.BannerSidekickAnnouncement):i?o.top.set(me.ItemActions):s?o.top.set(me.PromptTextareaAction):l?o.top.set(me.BannerSignup):g?o.top.set(me.BannerMemoryFull):o.top.set(null)},[o,i,s,c,l,u,h,g,m]),d.useLayoutEffect(()=>{r&&o.bottom.set(ba.DallePromptControls)},[o,r])}function Jd(){const{store:t}=Ae();d.useEffect(()=>()=>{t.reset()},[t])}function Yd(t){var o,i;const e=Ia(),s=dt(t),n=(i=(o=k.getTree(t).getLastValidNode(s))==null?void 0:o.message)==null?void 0:i.id;return(e==null?void 0:e.messageId)===n?e.suggestions:[]}function Qd(t){return Yd(t).length>0}function Xd(t){const e=Bd(t.clientThreadId),s=Qd(t.clientThreadId);return t.isDisabled?!1:t.isNewThread||e||s}function eu(t){var g;const{isUnauthenticated:e}=St(),s=dt(t),{layer:n}=Qo("3637408529"),o=n.get("should_show_no_auth_signup_banner",!0),i=cr(m=>m.bannerDisclaimerClientThreadId),r={shouldShowBannerTermsDisclaimer:!1,shouldShowBannerSignup:!1};if(!t)return r;const l=k.getTree(t),c=l.countMessagesByAuthor(_e.User),u=l.getNodeByIdOrMessageId(s),h=((g=u==null?void 0:u.message)==null?void 0:g.author.role)===_e.Assistant&&Ms(u.message);return r.shouldShowBannerTermsDisclaimer=h&&e&&c===1&&(i==null||i===t),r.shouldShowBannerSignup=o&&h&&e&&c>0&&c%5===0,r}function tu(t,e,s,n,o){const{getGizmoId:i}=ts(),[r,l]=d.useState();d.useEffect(()=>{i?i().then(h=>l(h)):l(void 0)},[i]);const c=ra(e);return d.useCallback(h=>{const{docsReferencedByURL:g}=Oe.getThread(t)??{};if(g!=null)for(const m of h){const{id:_,type:p,handler:f}=m,I=`${p}:${_}`,M=g[I],j=bt.getState().files.find(x=>x.tempId===_);if(M!=null&&M!=="failed"&&j){Ht.success(s.formatMessage(us.fileAlreadyAttached),{hasCloseButton:!0});continue}switch(f.type){case"fetch":{k.updateReferencedDocState(t,I,"pending"),$e.uploadFile(_,new File([],s.formatMessage(us.fileLoading)),tt.None,n,s,{skipUpload:!0,gizmoId:r},o,{contextConnector:p,sourceUrl:m.url,syntheticExtension:null,type:qt.Link}),ls.linkMetadataFetchStarted(p),f.tryFetch().then(x=>{if($e.remove(_,"none"),x==null)return null;const{id:v,title:w,connector:N,mimeType:P,url:F,syntheticExtension:R,o365DriveId:X}=x;ls.linkMetadataFetchSucceeded(p,P),k.updateReferencedDocState(t,I,"fetched");let H=w;N===Se.GDRIVE&&(H=R?`${w}.${R}`:w),$e.uploadFile(v,new File([],H,{type:P.split(";")[0]}),tt.Retrieval,n,s,{gizmoId:r},o,{contextConnector:N,sourceUrl:F,syntheticExtension:R,type:qt.Link,o365DriveId:X})}).catch(x=>{ls.linkMetadataFetchFailed(p,x),Ht.danger(s.formatMessage(us.fileFetchFailed),{hasCloseButton:!0}),k.updateReferencedDocState(t,I,"failed"),$e.remove(_,"none")});break}case"prompt":{c.appendMessageIfNotDismissed({connector:p,type:f.message}),k.updateReferencedDocState(t,I,"prompted");break}}}},[o,t,c,r,s,n])}const us=Te({fileLoading:{id:"CCC.fileLoading",defaultMessage:"Loading…"},fileFetchFailed:{id:"CCC.fileFetchFailed",defaultMessage:"Unable to fetch file information"},fileAlreadyAttached:{id:"CCC.fileAlreadyAttached",defaultMessage:"This file is already a part of your message."}}),co=({clientThreadId:t,rateLimitPopup:e,children:s,highlightTooltip:n=!1})=>{const o=ae(),i=Pc(t),r=Ts(),[l,c]=d.useState(n),[u,h]=d.useState(!1),g=d.useCallback(()=>{u||c(!0)},[u]),m=d.useCallback(()=>{c(!1),h(!1)},[]),_=d.useCallback(()=>{c(!1),h(!0)},[]);d.useEffect(()=>{c(n)},[n]);const p=I=>{e!=null&&I&&O.logPopoverHover({type:"rate_limit",location:"file_upload",plan_type:(r==null?void 0:r.planType)??"unknown"})},f=!!e;return a.jsx(a.Fragment,{children:f?a.jsxs(Xo,{delayDuration:150,onOpenChange:p,children:[a.jsx(ei,{children:s}),a.jsx(ti,{children:a.jsx(lr,{$as:si,side:"top",sideOffset:4,className:"max-w-[260px]",children:a.jsx(su,{isNewConversation:i,rateLimitPopup:e})})})]}):a.jsx(Ps,{sideOffset:14,label:o.formatMessage({id:"oUK/GV",defaultMessage:"Attach file"}),className:"flex",open:l||n,side:"top",children:a.jsx("span",{onPointerEnter:g,onPointerLeave:m,onClick:_,children:s})})})},su=({isNewConversation:t=!1,rateLimitPopup:e})=>{const s=Ts(),n=ca();if(e==null)return null;const{call_to_action:o,description:i}=e,r=i||a.jsx(z,{...Ln.defaultDescription}),l=o==null?void 0:o.includes(ni.GET_PLUS);return a.jsxs("div",{className:"p-2 text-sm text-token-text-primary",children:[a.jsx("div",{children:r}),l?a.jsx(wt,{size:"small",color:"secondary",className:"mt-3",onClick:()=>{dr(n,"Rate limited file upload popover"),O.logRateLimitGetPlusButtonClicked({type:"file_upload",location:"popover",plan_type:(s==null?void 0:s.planType)??"unknown",is_hard_block:!1,is_new_conversation:t,hard_block_reason:""})},children:a.jsx(z,{...Ln.getPlus})}):null]})},Ln=Te({defaultDescription:{id:"U5qAWP",defaultMessage:"You've reached your daily upload limit. Get ChatGPT Plus to unlock more."},getPlus:{id:"TeyLcp",defaultMessage:"Get Plus"}});function nu({clientThreadId:t,getInputProps:e,openFileDialog:s,uploadType:n,icon:o,highlightTooltip:i=!1}){const r=ae(),l=Rs(),c=!!l,u=a.jsx(Ta,{className:"mb-1",disabled:c,onClick:m=>{m.preventDefault(),O.logEvent(A.openFileViewer,{intent:n.toString()}),s()},"aria-label":r.formatMessage({id:"PromptFilePicker.attachFiles",defaultMessage:"Attach files"}),children:o}),h=a.jsx("input",{disabled:c,...e({className:"hidden"})}),g=a.jsxs("div",{className:"flex",children:[u,h]});return a.jsx(co,{clientThreadId:t,rateLimitPopup:l,highlightTooltip:i,children:g})}function au({code:t,message:e}){switch(t){case wn.FileTooLarge:return Bn.errorFileTooLarge;case wn.TooManyFiles:return O.logEvent(A.uploadedMaxFilesError),Bn.errorTooManyFiles;default:return e}}const Bn=Te({attachImages:{id:"PromptFilePicker.attachImages",defaultMessage:"Attach images"},attachFiles:{id:"PromptFilePicker.attachFiles",defaultMessage:"Attach files"},errorFileTooLarge:{id:"PromptFilePicker.errorFileTooLarge",defaultMessage:"Your file is too large. The maximum file size is {size}MB."},errorTooManyFiles:{id:"PromptFilePicker.errorTooManyFiles",defaultMessage:"You may only upload {maxNum} files at a time."},defaultFileUploadRateLimited:{id:"U5qAWP",defaultMessage:"You've reached your daily upload limit. Get ChatGPT Plus to unlock more."},getPlusButton:{id:"TeyLcp",defaultMessage:"Get Plus"}}),zn=Te({dragInstructions:{id:"FileDropZone.dragInstructions",defaultMessage:"Add anything"},dragAllAccepted:{id:"FileDropZone.dragAllAccepted",defaultMessage:"Drop any file here to add it to the conversation"}});function gf(t){var x;const{className:e,children:s,clientThreadId:n,currentModelConfig:o}=t,i=ae(),r=Ks(n),l=$t(o,r),c=l!==tt.None,u=bt(v=>v.files),h=(l===tt.Multimodal?Os:Ls)-u.length,g=h<=0,{getGizmoId:m}=ts(),{handleFileAccepted:_}=uo(i,$t(o,r),Ma(o,r),"drag",m,(x=ja(o,r))==null?void 0:x.attachments),p=Rs(),f=Ra(Ea(o,r)),{getRootProps:I,isDragActive:M}=Aa({maxFiles:h,disabled:!c||g||p!=null,noClick:!0,onDropAccepted:_,onDropRejected:v=>lo(v,i,l),multiple:!0,maxSize:Na,...f}),T=j();function j(){if(!f.accept||Object.keys(f.accept).length===0)return[];const v=[];return Object.values(f.accept).forEach(w=>v.push(...w)),v.sort()}return a.jsxs("div",{...I({className:e}),children:[s,M&&a.jsxs(ou,{children:[a.jsx(ur,{}),a.jsx("h3",{children:a.jsx(z,{...zn.dragInstructions})}),a.jsx("h4",{className:"w-2/3 text-center",children:T.length>0?T.join(", "):a.jsx(z,{...zn.dragAllAccepted})})]})]})}function lo(t,e,s){const{errors:n}=t[0];n.forEach(o=>{const i=au(o);typeof i=="string"?Ht.danger(i,{hasCloseButton:!0}):Ht.danger(e.formatMessage(i,{size:mr,maxNum:s===tt.Multimodal?Os:Ls}),{hasCloseButton:!0})})}function uo(t,e,s,n,o,i){return{handleFileAccepted:d.useCallback(async(l,c)=>{O.logEvent(A.uploadFile,{client:"web",eventSource:n,intent:e.toString()});const u=o!=null?await o():void 0;l.length>0&&l.forEach(h=>{$e.uploadFile(Ca(h),h,e,s,t,{gizmoId:u},i)})},[n,e,o,s,t,i])}}const ou=Ee.div`absolute inset-0 opacity-80 flex gap-2 flex-col justify-center items-center bg-token-main-surface-primary text-token-text-primary`;function mo({children:t,className:e,showBackground:s}){return a.jsxs("div",{className:"relative",children:[t,s&&a.jsx(fe.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:260,damping:20},className:U("pointer-events-none absolute bottom-0 top-0 h-8 w-8 rounded-full",e)})]})}function Un({entry:t,onClick:e}){const{connectorConfig:s}=Bs();d.useEffect(()=>{if(!open||t.type!==Se.GDRIVE)return;const r=s.get(Se.GDRIVE),l=r==null?void 0:r.access_token;l&&fr(l)},[s,t.type]);const n=Pa(t.type),o=ae(),i=t.access_token?Gn.uploadFromMessage:Gn.signinWithMessage;return a.jsx(Q.Item,{onClick:e,icon:n,children:a.jsxs("div",{className:"flex flex-col",children:[a.jsx(z,{...i,values:{connectorName:zs(t.type,o)}}),t.type===Se.O365_BUSINESS&&a.jsx("div",{className:"text-s text-token-text-tertiary",children:a.jsx(z,{...Us.includesSharePoint})})]})},t.id)}const Gn=Te({signinWithMessage:{id:"ContextConnectorPickerDropdownItem.signInWithMessage",defaultMessage:"Connect to {connectorName}"},uploadFromMessage:{id:"ContextConnectorPickerDropdownItem.uploadWithMessage",defaultMessage:"Add from {connectorName}"}});function iu({clientThreadId:t,icon:e,setOpen:s,highlightTooltip:n=!1}){const o=Rs(),i=!!o,r=ae();return a.jsxs(a.Fragment,{children:[a.jsx(Q.Trigger,{className:"m-0 h-0 w-0 border-none bg-transparent p-0"}),a.jsx(co,{clientThreadId:t,rateLimitPopup:o,highlightTooltip:n,children:a.jsx(Ta,{className:"mb-1","aria-disabled":i,"aria-label":r.formatMessage({id:"tA7CXR",defaultMessage:"Attach files"}),onClick:l=>{l.preventDefault(),i||s(!0)},children:e})})]})}function ru({connectorEntries:t,onOauthRedirect:e}){const s=ae();return a.jsxs(Q.Sub,{children:[a.jsx(Q.SubMenuTrigger,{icon:Wc,children:a.jsx("div",{className:"line-clamp-1 text-ellipsis",children:a.jsx(z,{...cu.connectApps})})}),a.jsx(Q.Portal,{children:a.jsx(Q.SubContent,{children:t.map(n=>a.jsx(Q.Item,{onClick:()=>e(n),icon:Pa(n.type),children:a.jsxs("div",{className:"flex flex-col",children:[zs(n.type,s),n.type===Se.O365_BUSINESS&&a.jsx("div",{className:"text-s text-token-text-tertiary",children:a.jsx(z,{...Us.includesSharePoint})})]})},n.id))})})]})}const cu=Te({connectApps:{id:"ContextConnectorPicker.connectApps",defaultMessage:"Connect apps"}});function lu({onOauthRedirect:t,connectors:e}){const s=ae();return a.jsxs(Q.Sub,{children:[a.jsx(Q.SubMenuTrigger,{icon:$c,children:a.jsx(z,{...du.oneDriveSubmenuName})}),a.jsx(Q.Portal,{children:a.jsx(Q.SubContent,{children:e.map(n=>n?a.jsx(Q.Item,{onClick:()=>t(n),children:a.jsxs("div",{className:"flex flex-col",children:[zs(n.type,s),n.type===Se.O365_BUSINESS&&a.jsx("div",{className:"text-s text-token-text-tertiary",children:a.jsx(z,{...Us.includesSharePoint})})]})},n.id):null)})})]})}const du=Te({oneDriveSubmenuName:{id:"ContextConnectorPickerOneDriveSubmenu.oneDriveSubmenuName",defaultMessage:"Connect to Microsoft OneDrive"}});function uu(){const{connectorConfig:t}=Bs(),e=Zt(),[s,n]=Kt(Da([...t.values()],u=>!!u.access_token),u=>!!u.access_token),[o,i]=Kt(n,u=>u.type===Se.O365_PERSONAL||u.type===Se.O365_BUSINESS),r=!e&&s.length>0,l=!e&&!r&&o.length>1;return{unconnectedConnectors:l?i:n,showUnconnectedInSubmenu:r,showOneDriveInSubmenu:l}}function mu({clientThreadId:t,icon:e,modelAcceptedMimeTypes:s,modelSupportedImageMimeTypes:n,attachmentsProductFeature:o,onOauthRedirect:i,uploadType:r,getInputProps:l,openFileDialog:c,highlightTooltip:u=!1}){const{currentLocale:h}=ai(),g=ae(),m=Zt(),{connectorConfig:_,isLoading:p}=Bs(),f=Yt(Qt.ContextConnectors),{getGizmoId:I}=ts(),[M,T]=d.useState();d.useEffect(()=>{I?I().then(y=>T(y)):T(void 0)},[I]);const j=d.useRef(null),[x,v]=d.useState(!1),w=d.useRef(!1),N=d.useCallback(()=>{var se;const y=(se=j.current)==null?void 0:se.files;Array.from(y??[]).forEach(he=>Dt.uploadFile(he,n,g,o))},[n,o,g]),[P,F]=d.useState(null),R=d.useCallback(()=>F(null),[F]),X=d.useCallback((y,se)=>Dt.uploadPickedFile(y,se,n,s,o,M,g),[n,s,o,M,g]),{openMenu:H,confirmMenuOpened:G}=hr();d.useEffect(()=>{H&&(v(!0),G())},[H,G,v]);const ee=la(),te=d.useCallback(y=>{Dt.doContextConnectorOauthRedirect(ee.asPath,y,i,qt.Picker),i()},[i,ee.asPath]),K=d.useCallback(y=>{Dt.uploadPickedFile(y,Se.GDRIVE,n,s,o,M,g)},[n,s,o,M,g]),$=d.useCallback(async y=>{const{access_token:se}=y;if(!se){te(y);return}switch(gr(y,qt.Picker),y.type){case Se.GDRIVE:pr(h,y.type,se,he=>he.forEach(K));break;case Se.O365_PERSONAL:case Se.O365_BUSINESS:F(y.type);break}},[K,te,F,h]),C=()=>{O.logEvent(A.openFileViewer,{intent:r.toString()}),c()},b=y=>{if(!y&&w.current&&!p)C();else if(y&&ie&&!p){C();return}v(y),y&&(f.eligible&&f.markAsViewed(),O.logEvent(A.composerOpenContextConnectorPicker),w.current=!0,setTimeout(()=>{w.current=!1},250))},[D,q]=Kt(Da([..._.values()],y=>!!y.access_token),y=>!!y.access_token);fu(D,$);const[Z]=Kt(q,y=>y.type===Se.O365_PERSONAL||y.type===Se.O365_BUSINESS),{unconnectedConnectors:V,showUnconnectedInSubmenu:xe,showOneDriveInSubmenu:ue}=uu(),ie=!D.length&&!V.length,ve=a.jsxs(a.Fragment,{children:[xe&&V.length>0&&a.jsx(ru,{connectorEntries:V,onOauthRedirect:y=>te(y)}),!xe&&V.map(y=>a.jsx(Un,{entry:y,onClick:()=>$(y)},y.id)),ue&&a.jsx(lu,{connectors:Z,onOauthRedirect:te}),p&&a.jsx(Q.Item,{icon:a.jsx(oi,{className:"text-token-text-secondary"})}),(V.length>0||p)&&a.jsx(Q.Separator,{}),D.map(y=>a.jsx(Un,{entry:y,onClick:()=>$(y)},y.id)),a.jsx(Q.Item,{onClick:C,icon:Kc,children:a.jsx(z,{...m?Hn.uploadFileMobile:Hn.uploadFile})},"upload")]}),Ne=a.jsxs("div",{className:"flex flex-col",children:[a.jsx(xr,{type:P,onClose:R,uploadPickedFile:X}),a.jsx("input",{onChange:N,...l({className:"hidden"})}),a.jsxs(Q.Root,{open:x,onOpenChange:b,children:[a.jsx(iu,{clientThreadId:t,icon:e,setOpen:b,highlightTooltip:u}),a.jsx(Q.Portal,{children:a.jsx(Q.Content,{size:"large",children:ve})})]}),a.jsx(yr,{hasConnectors:!p&&!ie})]});return{dropdownItems:ve,mainComponent:Ne}}function fu(t,e){const{connector:s,clearParam:n}=_r(),o=t.find(i=>i.type===s&&!!i.access_token);d.useEffect(()=>{o&&(e(o),n())},[o,e,n])}function hu(t){const{mainComponent:e}=mu(t);return e}const Hn=Te({attachFiles:{id:"ContextConnectorPicker.attachFiles",defaultMessage:"Attach files"},uploadFile:{id:"LocalFileDropdownItem.uploadFile",defaultMessage:"Upload from computer"},uploadFileMobile:{id:"LocalFileDropdownItem.uploadFileMobile",defaultMessage:"Upload file"}});function gu({clientThreadId:t,uploadType:e,modelAcceptedMimeTypes:s,modelSupportedImageMimeTypes:n,attachmentsProductFeature:o,getInputProps:i,openFileDialog:r,onOauthRedirect:l,historyDisabled:c,className:u,highlightTooltip:h}){const{gdriveStatus:g,o365Status:m}=vr(),_=a.jsx(Zc,{className:c?"text-white":h?"text-brand-blue-800":void 0});return a.jsx("div",{className:U("relative",u),children:a.jsx(mo,{showBackground:h,className:"bg-brand-blue-800/20",children:g!=="false"||m!=="false"?a.jsx(hu,{clientThreadId:t,icon:_,modelAcceptedMimeTypes:s,modelSupportedImageMimeTypes:n,attachmentsProductFeature:o,onOauthRedirect:l,uploadType:e,openFileDialog:r,getInputProps:i,highlightTooltip:h}):a.jsx(nu,{clientThreadId:t,uploadType:e,openFileDialog:r,getInputProps:i,icon:_,highlightTooltip:h})})})}const pu=d.forwardRef(function({type:e,placeholder:s,replyRegions:n,state:o,renderFiles:i,leftSideActions:r,onSubmit:l,inputState:c,currentLeafId:u,composerController:h,clientThreadId:g,gizmoId:m},_){const p=Ns(),f=br();return d.useEffect(()=>{h.focus()},[f==null?void 0:f.modelId,h]),a.jsxs("div",{ref:_,className:U("flex w-full flex-col gap-1.5 rounded-[26px] p-1.5 transition-colors",p&&"backdrop-blur-2xl no-transparency:backdrop-blur-none",p&&e!=="temporary"&&"bg-token-composer-surface",!p&&e!=="temporary"&&"bg-[#f4f4f4] dark:bg-token-main-surface-secondary",e==="temporary"&&"dark bg-black"),children:[a.jsx(ct,{children:n.length>0&&a.jsx(fe.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0,transition:{duration:.06}},transition:{ease:"easeOut",duration:.1},children:a.jsx(vu,{replyRegions:n})})}),a.jsxs("div",{className:"flex items-end gap-1.5 pl-4 md:gap-2",children:[!!(r!=null&&r.length)&&a.jsx(fe.div,{initial:{opacity:0},animate:{opacity:1},transition:{ease:"easeOut",duration:.06},className:"-ml-2.5 flex",children:r},"leftSideActions"),a.jsxs(fe.div,{layout:!0,transition:{duration:.1},className:U("flex min-w-0 flex-1 flex-col"),children:[i,h instanceof Fa?a.jsx(xu,{composerController:h,currentLeafId:u,placeholder:s,inputState:c}):a.jsx(Cl,{composerController:h,placeholder:s})]}),a.jsx(yu,{inputState:c,state:o,onSubmit:l,composerController:h,clientThreadId:g,gizmoId:m})]})]})});function xu({composerController:t,currentLeafId:e,placeholder:s,inputState:n}){const o=d.useContext(ii);return a.jsxs(a.Fragment,{children:[a.jsx(Sr,{id:wr,autoFocus:!0,tabIndex:0,"data-id":e,dir:"auto",ref:i=>{if(!(t instanceof Fa))throw new Error("Expected TextAreaComposerController");i!=null&&(t.textArea=i,t.logPageMount())},rows:1,placeholder:s,disabled:n!=="default",className:U("m-0 resize-none border-0 bg-transparent px-0 text-token-text-primary focus:ring-0 focus-visible:ring-0",n==="disabled"&&"text-center",["max-h-[25dvh]","max-h-52"])}),a.jsx("script",{nonce:o.cspScriptNonce,suppressHydrationWarning:!0,children:"requestAnimationFrame((function(){window.__oai_logTTI?window.__oai_logTTI():window.__oai_SSR_TTI=window.__oai_SSR_TTI??Date.now()}))"})]})}function yu(t){const{isUnauthenticated:e}=St(),s=bt(Oa.hasUploadInProgress);if(t.inputState==="disabled")return null;const n=a.jsx(_u,{state:t.state,onSubmit:t.onSubmit});return!e&&!s&&t.state==="disabled"&&t.clientThreadId?a.jsx("div",{className:"w-10",children:a.jsx(kr,{clientThreadId:t.clientThreadId,gizmoId:t.gizmoId,fallback:()=>n})}):n}function _u({state:t,onSubmit:e}){const s=t==="streaming"?Yc:Qc,n=ae(),o=n.formatMessage({id:"+yfm/p",defaultMessage:"Stop streaming"}),i=n.formatMessage({id:"xfIykB",defaultMessage:"Send prompt"}),r=Ns();return a.jsx("button",{onClick:e,disabled:t==="disabled","aria-label":t==="streaming"?o:i,"data-testid":t==="streaming"?"stop-button":"send-button",className:U("mb-1 me-1 flex h-8 w-8 items-center justify-center rounded-full bg-black text-white transition-colors hover:opacity-70 focus-visible:outline-none focus-visible:outline-black disabled:text-[#f4f4f4] disabled:hover:opacity-100 dark:bg-white dark:text-black dark:focus-visible:outline-white disabled:dark:bg-token-text-quaternary dark:disabled:text-token-main-surface-secondary",r&&"disabled:bg-black disabled:bg-opacity-[0.27]",!r&&"disabled:bg-[#D7D7D7]"),children:a.jsx(s,{className:U(t==="streaming"?"icon-lg":"icon-2xl")})})}function vu({replyRegions:t}){return a.jsx("div",{className:"flex flex-col divide-y divide-token-border-light overflow-hidden rounded-b-lg rounded-t-[20px] bg-token-main-surface-primary",children:t.map((e,s)=>{switch(e.type){case"text":return a.jsx(bu,{value:e.value,onRemoveRegion:e.onRemoveRegion},s);case"object":return a.jsx(Su,{value:e.value,onRemoveRegion:e.onRemoveRegion},s);case"mention":case"system_hint":return a.jsx(wu,{value:e.value,icon:e.icon,onRemoveRegion:e.onRemoveRegion},s)}})})}function bu({value:t,onRemoveRegion:e}){return a.jsxs(Ys,{className:"text-token-text-secondary",children:[a.jsx(Qs,{children:a.jsx(Vs,{className:"icon-lg-heavy"})}),a.jsx(Xs,{children:`“${t}”`}),a.jsx(Js,{onClick:e})]})}function Su({value:t,onRemoveRegion:e}){return a.jsxs(Ys,{className:"text-blue-selection",children:[a.jsx(Qs,{children:a.jsx(Vs,{className:"icon-lg-heavy"})}),a.jsx(Xs,{className:"font-semibold",children:t}),a.jsx(Js,{onClick:e})]})}function wu({value:t,icon:e,onRemoveRegion:s}){return a.jsxs(Ys,{children:[a.jsx(Qs,{className:"mt-0",children:e}),a.jsx(Xs,{className:"font-semibold text-token-text-primary",children:t}),a.jsx(Js,{onClick:s})]})}function Js({onClick:t}){return a.jsx("button",{onClick:t,type:"button",className:"flex-shrink-0 text-token-text-secondary",children:a.jsx(Jc,{className:"icon-lg"})})}const Ys=Ee.div`flex items-start py-2.5 gap-3 pl-3 pr-1.5 text-sm`,Qs=Ee.span`flex-shrink-0 mt-0.5 w-7 h-6 flex justify-center items-center`,Xs=Ee.span`flex-1 line-clamp-3 py-0.5`;function ku({composerController:t,highlightTooltip:e}){return a.jsx(Iu,{highlightTooltip:e,children:a.jsx(mo,{showBackground:e,className:"bg-brand-purple/20",children:a.jsx("button",{className:"mb-1 flex h-8 w-8 items-center justify-center text-token-text-primary",onClick:()=>{O.logEvent(A.composerSearchButtonClicked),vs.addPersistedSystemHint(it.Search),/^search\s?$/i.test(t.getCurrentText())&&t.setText(""),t.focus()},children:a.jsx(Za,{className:U(e&&"text-brand-purple-800 dark:text-brand-purple-600")})})})})}function Cu(){const t=Yt(Qt.hasSeenComposerSearchButtonTooltip);return!t.isLoading&&t.eligible}function Iu({children:t,highlightTooltip:e}){const s=Cu(),n=ae(),o=Yt(Qt.hasSeenComposerSearchButtonTooltip);return s?a.jsx(_a,{side:"top",show:!0,dismissOnOutsideClick:!0,badge:"none",title:n.formatMessage({id:"WhBf/L",defaultMessage:"The web is now in ChatGPT"}),contentAlign:"center",onDismiss:o.markAsViewed,sideOffset:2,className:"!max-w-2xs",description:n.formatMessage({id:"INHpvZ",defaultMessage:"Search the web for instant answers and links to trusted sources."}),children:a.jsx("div",{children:t})}):a.jsx("div",{children:a.jsx(Ps,{sideOffset:14,label:n.formatMessage({id:"c+4o2s",defaultMessage:"Search the web"}),side:"top",open:e?!0:void 0,children:t})})}function Tu({composerController:t,clientThreadId:e}){const s=Va(e),n=Ja(e,da.Search),o=al(e),[i,r]=d.useState([]),[l,c]=d.useState(void 0),[u,h]=d.useState(0);d.useEffect(()=>{r(l?o.filter(v=>v.name.toLocaleLowerCase().startsWith(l.text.toLocaleLowerCase())||v.systemHint.toLocaleLowerCase().startsWith(l.text.toLocaleLowerCase())):[])},[l]);const g=t.useState(v=>v.getSystemHints().length>0);d.useEffect(()=>{const v=w=>{c(N=>!N||!w?w:N.text===w.text&&N.range.from===w.range.to&&N.range.to?N:w)};t.view.dispatch(t.view.state.tr.setMeta(Tl,{onHintMatch:v}))},[t]);const m=g||!o.length||!i.length||!l;d.useEffect(()=>{m&&h(0)},[m]);const _=i.length,p=d.useCallback(v=>{h(w=>(v(w)%_+_)%_)},[_]),f=i[u],I=({hintToSave:v=f,expectPerfectMatch:w,appendSpace:N=!0})=>{if(!l||!f||w&&v.name.toLowerCase()!==l.text.toLowerCase())return;O.logEvent(A.systemHintSelected,{system_hint:v.systemHint,conversation_id:s??_n});const P=l.text+v.name.slice(l.text.length);Ml(t.view,{id:v.systemHint,hint:P},l.range,N,n),Ot(t.view)},M=d.useRef(I);M.current=I;const T=d.useRef(p);T.current=p;const j=d.useRef(l);j.current=l;const x=t.view;return d.useEffect(()=>(m||jl(x,v=>{v==="up"?T.current(w=>w-1):v==="down"?T.current(w=>w+1):v==="cancel"?(Ot(x),Rl(x)):v==="submit"?(M.current({expectPerfectMatch:!1}),Ot(x)):v==="checkMatch"&&M.current({expectPerfectMatch:!0,appendSpace:!1})}),()=>Ot(x)),[m,x]),d.useEffect(()=>{m||O.logEvent(A.systemHintListOpened,{conversation_id:s??_n})},[m]),m?null:a.jsx(Cr,{className:"max-w-60",children:i.map((v,w)=>a.jsx("div",{children:a.jsx(Ir,{autoFocus:!1,className:"hover:bg-inherit rounded-lg px-1 py-2",spoofHovered:w===u,onMouseOver:()=>h(w),onClick:()=>{I({hintToSave:v,expectPerfectMatch:!1}),t.focus()},children:a.jsx(ju,{title:v.name,description:v.description,icon:a.jsx(Tr,{svgString:v.logo,className:"icon-lg text-token-text-secondary"}),checked:!1})})},v.systemHint))})}function ju({title:t,description:e,icon:s,onClick:n,checked:o}){return a.jsxs("div",{className:"inline-flex w-full items-center justify-start gap-1.5 pl-1.5 pr-3",onClick:n,children:[a.jsx("div",{className:"flex h-7 w-7 items-center justify-center gap-2.5",children:s}),a.jsxs("div",{className:"shrink grow basis-0",children:[a.jsx("p",{className:"text-sm font-normal leading-tight text-token-text-primary",children:t}),!!e&&a.jsx("p",{className:"text-[13px] font-normal leading-[18px] text-token-text-secondary",children:e})]}),o&&a.jsx(Xc,{className:U("icon-md text-token-text-primary",{"group-hover:hidden":!o})})]})}function Mu({composerController:t,clientThreadId:e}){return t instanceof Il?a.jsx(Tu,{composerController:t,clientThreadId:e}):null}function Ru({suggestions:t,composerController:e,onSelect:s,onChange:n}){const o=eo(),i=d.useCallback((c,u,h)=>{s==null||s(c,u,h),o(c,u,h)},[s,o]),[r,l]=d.useState(-1);return d.useEffect(()=>{const c=u=>{if(u.key==="ArrowDown"){const h=r===t.length-1?0:r+1;l(h),n==null||n(h,!0,t[h])}else if(u.key==="ArrowUp"){u.preventDefault();const h=r<=0?t.length-1:r-1;l(h),n==null||n(h,!0,t[h])}else u.key==="Enter"&&t[r]&&i(t[r],t,r)};return e.subscribe("keydown",c)},[t,r,n,i,e]),d.useEffect(()=>e.subscribe("blur",()=>{l(-1),n==null||n(-1,!1)}),[e,n]),a.jsx(fe.ul,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"hidden w-full flex-col p-2.5 group-focus-within:block",children:t.map((c,u)=>a.jsxs(fe.li,{initial:{opacity:0,translateY:4},animate:{opacity:1,translateY:0},transition:{delay:u*.03},exit:{opacity:0,translateY:4},className:"w-full",children:[u>0&&a.jsx("div",{className:U("h-[1px] opacity-60",r===u||r===u-1?"mx-2 bg-token-main-surface-secondary":"bg-token-border-light")}),a.jsxs("button",{className:U("inline w-full cursor-pointer items-center justify-start rounded-lg px-2.5 py-3 text-start",r===u?"bg-token-main-surface-secondary":"bg-token-main-surface-primary"),onClick:h=>{h.preventDefault(),i(c,t,u)},onMouseEnter:()=>{l(u),n==null||n(u,!1,c)},onMouseLeave:()=>{l(-1),n==null||n(-1,!1,c)},children:[a.jsx("span",{className:"text-token-text-tertiary",children:c.title}),a.jsx("span",{className:"text-token-text-primary",children:c.body})]})]},c.id??u))})}const Eu=1,Au=3e3;function Nu({files:t,className:e}){const s=Zt();return a.jsx("div",{className:e,children:t.map(n=>a.jsx(za,{width:s?"normal":"wide",onRemoveFileClick:()=>$e.remove(n.tempId,"none"),file:n.file,fileId:n.fileId??void 0,contextConnectorInfo:n.contextConnectorInfo,loadingPercentage:n.status===Gr.Uploading?n.progress:void 0},n.tempId))})}function Pu({onAbortCompletion:t,onCreateNewCompletion:e,onContinueGenerating:s,currentModelId:n,clientThreadId:o,isNewThread:i,isCompletionInProgress:r,className:l,disabled:c=!1,disabledReason:u,canPause:h=!1,canContinue:g=!1,suggestions:m,isInteractableSharedThread:_,composerContainerRef:p,composerController:f,autocompletions:I,requiresFileUpload:M,onComposerInput:T,onComposerChange:j,onAutocompleteSelect:x,headerClassName:v,hideHeader:w,setComposerBarElement:N,onTaggingDropdownOpen:P,onTaggingDropdownClose:F}){var fn,hn;const R=Sa(),{isUnauthenticated:X}=St(),H=ae(),G=dt(o),ee=ss(o),te=la(),{gizmoEditorData:K,mode:$,getGizmoId:C}=ts(),b=ua(),D=ta(),q=ri(),Z=Xt(),V=Va(o),xe=!!ci(),ue=jr(),ie=!!li(),[ve,Ne]=d.useState({}),[y,se]=d.useState(!1),[he,J]=d.useState(!1),re=d.useRef(!1),je=ol(),Y=n!==null?je[n]:void 0,Me=ue.has(it.Search);let L=Ks(o),ye=L&&"gizmo"in L?L.gizmo:void 0;const[ce,Pe]=d.useState(null);ce!==null&&(L={gizmo:ce,gizmo_id:ce.gizmo.id,kind:we.GizmoInteraction},ye=ce);const st=$t(Y,L);let Je=!1;Mr(L)&&(ye==null?void 0:ye.gizmo.id)===Rr&&(Je=!0);const It=!c&&st!==tt.None&&!Je&&!X,qe=Ma(Y,L),ut=Ea(Y,L);let ne=bt(S=>S.files);const[le]=d.useState(()=>Er());$==="magic"?ne=ne.filter(S=>S.gizmoId!=null):ne=ne.filter(S=>S.gizmoId==null);const ke=ne.length>0,nt=bt(Oa.hasUploadInProgress),Tt=f.useState(S=>!S.isEmpty()),Le=ke?!nt:Tt,Ye=(st===tt.Multimodal?Os:Ls)-ne.length,at=Ye<=0,Ve=Le&&!c&&!r&&!ie,[tn,yo]=d.useState(!1),_o=il(),vo=n||_o.id,bo=Ja(o,da.Search),ns=!c&&bo&&!ye&&!Me,So=(fn=je[vo])==null?void 0:fn.tags,{targetedContent:jt,setTargetedContent:Mt}=Ar(),W=jt!=null&&jt.isFocusedViewContent&&!Z?void 0:jt,{rebaseSystemMessageContent:sn}=La();d.useEffect(()=>{Nr()}),d.useEffect(()=>{if(!(R!=null&&R.id))return;const S=kn.getAndReset(R==null?void 0:R.id,V);S&&f.setText(S.inputText)},[R==null?void 0:R.id,V,f]),d.useEffect(()=>{tn!==Ve&&(yo(Ve),Ve&&(ma(!0).then(S=>{Vt.startEnforcement(S),bs.startEnforcement(S),ys.startEnforcement(S)}),b!=null&&b.includes(js.SharedWebsocket)&&Ct.registerIfNotConnected()))},[Ve,tn,L==null?void 0:L.kind,b]);const Be=ja(Y,L),{handleFileAccepted:wo}=uo(H,$t(Y,L),qe,"mouse",C,Be==null?void 0:Be.attachments),{getInputProps:ko,open:Co}=Aa({disabled:c||!It||at,noClick:!0,onDropAccepted:wo,onDropRejected:S=>lo(S,H,st),multiple:!0,maxSize:Na,maxFiles:Ye,...Ra(ut)}),nn=ra(le),an=d.useCallback(()=>{f.eraseContent(),nn.clearMessages(),f.resize(Eu),Pr();for(const S of ne)$e.remove(S.tempId,"none")},[ne,nn,f]),mt=async(S,ge)=>{var pn;if(S==null||S.preventDefault(),c||!Le&&!ge||!L||Oe.isLoading(o)!==!1)return;const Ce=new Ds;se(!0);const ze=f.getContentToSend(),Xe=ze.content.replace(/[\u{E0000}-\u{E007F}]+/gu,""),Re=`${G}-nextPrompt`,et=Hr({namespace:In.CompletionRequest,key:Re,opts:{expectedTimingLogs:[{name:"prompt_submitted",expectedInMs:3e3}]}}),{content:Uo,attachments:gn}=qr(Xe,Y,L),is=[];sn&&is.push(fi(sn));const rs={...L};"gizmo"in rs&&delete rs.gizmo;const cs=f.getSystemHints();let pt={promptId:Re,content:Uo,eventMetadata:{eventSource:S?"mouse":"keyboard"},completionMetadata:{suggestions:m,conversationMode:rs,systemHints:cs},messageMetadata:{...gn.length>0&&{attachments:gn},...ce&&{gizmo_id:ce==null?void 0:ce.gizmo.id},...ve,...cs.length>0&&{system_hints:cs},...!!ze.metadata&&{serialization_metadata:ze.metadata}},appendMessages:is.length>0?is:void 0,turnTracker:Ce};pt=Vr(pt),W!=null&&W.createNewCompletionParams&&(pt=await W.createNewCompletionParams(pt)),et.logTiming("request_params_ready"),await e(pt),(pn=W==null?void 0:W.onCreateCompletion)==null||pn.call(W,{serverThreadId:V,currentLeafId:G}),(W==null?void 0:W.shouldPersistAcrossMessages)!==!0&&Mt(void 0),Cn.hideThreadHeader(),an(),se(!1),et.logTiming("prompt_submitted"),Wr({namespace:In.CompletionRequest,key:Re}),m!==void 0&&(He.logEvent("chatgpt_prompt_ignore_suggestions"),O.logEvent(A.promptIgnoreSuggestions))},on=d.useRef(mt);d.useLayoutEffect(()=>{on.current=mt}),d.useEffect(()=>di.subscribe(ui.SEND_PROMPT,({prompt:S})=>{f.setText(S),on.current(void 0,!0)}),[f]);const Io=S=>{Mt(S.targetedReply),S.targetedReply&&(f.focus(),O.logEvent(A.targetedReplyButtonClicked,{conversationId:V,sourceMessageId:S.messageId}))},rn=d.useCallback(()=>{var S;(S=W==null?void 0:W.onCleared)==null||S.call(W,{serverThreadId:V,currentLeafId:G}),Mt(void 0),f.focus()},[G,V,W,Mt,f]),cn={Enter:{validator:S=>{const ge=S.isComposing||S.keyCode===229,Ce=he&&re.current;return Ve&&!Ce&&(S.metaKey||(D||hi)&&!S.shiftKey&&!ge)},handler:S=>{S.preventDefault(),mt()}},Escape:{validator:S=>!S.isComposing,handler:S=>{h&&r&&(t("",ee),O.logEvent(A.pauseCompletion,{threadId:k.getServerThreadId(o),currentLeafId:k.getTree(o).getMessageId(G),eventSource:"keyboard"})),S.target.value===""&&rn()}}},ft=d.useRef(cn);ft.current=cn;const ln=d.useRef(null),ht=rl(So,L==null?void 0:L.kind),[as,Rt]=d.useState(!1),[os,dn]=d.useState(!1),Et=ht&&as,un=f.isReady();d.useEffect(()=>f.subscribe("keydown",S=>{var ze,Xe;f.acceptLegacyKeydown()&&((ze=ft.current[S.key])!=null&&ze.validator(S))&&ft.current[S.key].handler(S);const Ce=f.getCurrentText();if(S.key==="@"){const Re=f.getSelectionStart(),et=Ce.substring(0,Re);(!et||/\s$/.test(et)||Re===0)&&((Xe=ln.current)==null||Xe.handleClose(),setTimeout(()=>Rt(!0),10))}else as&&Rt(!1);if(S.key==="Escape"&&(Pe(null),J(!1)),ns){let Re;S.key==="Backspace"?Re=Ce.substring(0,Ce.length-1):Re=Ce+S.key,/^search\s?$/i.test(Re)?dn(!0):os&&dn(!1)}Me&&S.key==="Escape"&&vs.removePersistedSystemHint(it.Search)}),[f,un,as,os,ns,Me]),d.useEffect(()=>{const S=Object.fromEntries(Object.keys(ft.current).map(ge=>[ge,ze=>{const Xe=ft.current[ge];if(!Xe||f.acceptLegacyKeydown())return!1;const{validator:Re,handler:et}=Xe;return Re(ze)?(et(ze),!0):!1}]));f.registerKeyHandlers(S)},[f,un]),d.useEffect(()=>f.subscribe("paste",S=>{Dr({event:S,intl:H,clientThreadId:o,conversationMode:L,currentModelConfig:Y,getEditorGizmoId:C,modelSupportedImageMimeTypes:qe})}),[H,o,L,Y,C,qe,f]);const To=S=>{xe||Pe(S),f.trimLeadingText("@"),Wt(),Rt(!1)},jo=tu(o,le,H,qe,Be==null?void 0:Be.attachments),Mo=d.useCallback(()=>{t("",ee),O.logEvent(A.pauseCompletion,{threadId:k.getServerThreadId(o),currentLeafId:k.getTree(o).getMessageId(G),eventSource:"mouse"}),Wt()},[t,o,ee,G]),mn=d.useCallback(()=>{kn.set(R==null?void 0:R.id,V,f.getCurrentText())},[V,R==null?void 0:R.id,f]);d.useEffect(()=>{K||y||f.focus()},[y,f]),d.useEffect(()=>{K||$e.reset()},[n,K]),d.useEffect(()=>{(!ht&&ce||xe)&&Pe(null)},[ht,ce,xe]);const[Ro,Eo]=(()=>{switch(u){case"workspaceDisallowsGizmo":return[Fe.disallowedByWorkspacePlaceholder,!0];case"feedbackRequired":return[Fe.disabledFeedbackPlaceholder,!0];case"noModelsAvailable":return[Fe.noModelsAvailablePlaceholder,!0];case"requiresPluginsToBeInstalled":return[Fe.requiresPluginsToBeInstalled,!0];case"loadingPlugins":return[Fe.loading,!0];case"noTestGizmoId":return[Fe.noTestGizmoId,!0];default:return _?[Fe.continueSharedConversationPlaceholder,!1]:(W==null?void 0:W.placeholderTextOverride)!=null?[W.placeholderTextOverride,!1]:[Fe.placeholderWithName,!1]}})(),Ao=H.formatMessage(Ro,{name:K!=null?$==="magic"?cl:K.name||"GPT":(ye==null?void 0:ye.gizmo.display.name)??"ChatGPT"});d.useEffect(()=>f.subscribe("input",()=>{Fr.getState().isThreadHeaderVisible&&Cn.hideThreadHeader(),J(!0)}),[f]),d.useEffect(()=>{if(T)return f.subscribe("input",()=>{T==null||T()})},[f,T]),d.useEffect(()=>{if(j)return f.subscribe("change",()=>{j==null||j()})},[f,j]),d.useEffect(()=>f.subscribe("focus",()=>{J(!0)}),[f]);const No={clientThreadId:o,uploadType:st,modelAcceptedMimeTypes:ut,modelSupportedImageMimeTypes:qe,attachmentsProductFeature:Be==null?void 0:Be.attachments,getInputProps:ko,openFileDialog:Co,historyDisabled:q,onOauthRedirect:mn,highlightTooltip:M&&!ke},Qe=[];!c&&!at&&It&&!Me&&Qe.push(a.jsx(gu,{...No},"file-upload-button")),ns&&Qe.push(a.jsx(ku,{composerController:f,highlightTooltip:os},"search-button"));const Po=ke&&a.jsxs(a.Fragment,{children:[$==="magic"&&a.jsx("div",{className:"m-2 mb-0 rounded-lg bg-token-main-surface-secondary p-2 text-xs text-token-text-secondary",children:a.jsx(z,{...Fe.gizmoKnowledgeWarning})}),a.jsx(Nu,{files:ne,className:"flex flex-nowrap gap-2 overflow-x-auto pb-1.5 pt-[7px]"})]}),Do=Eo?"disabled":"default",At=r&&h?"streaming":!Ve||y?"disabled":"idle",gt=d.useRef(null),ot=d.useRef(null),{layer:Fo}=mi("387752763"),Oo=Fo.get("enable_slash_commands",!1),Lo=n&&[ll,dl].includes(n),Bo=Oo&&(L==null?void 0:L.kind)===we.PrimaryAssistant&&!Me;d.useEffect(()=>{const S=()=>{gt.current!=null&&De.addAction("composer_state_disabled",{threadId:k.getServerThreadId(o),disabledReason:gt.current})};if(Le&&At==="disabled"){let ge="unknown";c?ge=u??"component_disabled_unknown":r?ge="completion_in_progress":ie?ge="thread_hard_blocked":y&&(ge="starting_new_completion_request"),gt.current!==ge&&(ot.current&&clearTimeout(ot.current),ot.current=setTimeout(S,Au)),gt.current=ge}else gt.current=null;return()=>{ot.current&&(clearTimeout(ot.current),ot.current=null)}},[o,Le,At,c,u,r,ie,y]);const Nt=[];if(W!=null&&W.label&&Nt.push({type:W.type,value:W.label,onRemoveRegion:rn}),ue!=null&&ue.has(it.Search)&&Nt.push({type:"system_hint",value:H.formatMessage(Du.searchMode),icon:a.jsx("span",{className:"flex h-7 w-7 items-center justify-center rounded-full bg-brand-purple/15",children:a.jsx(Za,{className:"h-[20px] w-[20px] shrink-0 text-brand-purple-600"})}),onRemoveRegion:()=>{vs.removePersistedSystemHint(it.Search),f.focus()}}),ce!==null){const S=!!((hn=ce.gizmo.tags)!=null&&hn.includes(Ba.FirstParty));Nt.push({type:"mention",value:ce.gizmo.display.name,icon:a.jsx(kl,{isFirstParty:S,src:ce.gizmo.display.profile_picture_url,className:"icon-md"}),onRemoveRegion:()=>{Pe(null),f.focus()}})}d.useEffect(()=>{(!I||I.length===0||!he)&&(re.current=!1)},[I,he]);const zo=(S,ge,Ce)=>{re.current=S>=0,ge&&f.setText(Ce?`${Ce.title}${Ce.body}`:"")};return d.useEffect(()=>{Et?P==null||P():F==null||F()},[Et,P,F]),a.jsxs(Or.Provider,{value:le,children:[a.jsx(Lr,{onOauthRedirect:mn,children:a.jsx("form",{className:l,onSubmit:mt,children:a.jsxs("div",{className:"relative flex h-full max-w-full flex-1 flex-col",children:[!w&&a.jsx(Td,{className:v}),a.jsxs("div",{ref:p,className:"group relative flex w-full items-center",children:[i&&"from_template_row"in te.query&&a.jsx("button",{type:"button",onClick:()=>{te.push("/",void 0,{shallow:!0})},className:"mr-2 flex h-8 w-8 items-center justify-center text-token-text-tertiary hover:text-token-text-secondary",children:a.jsx(el,{className:"icon-lg"})}),ht&&!!V&&a.jsx(rd,{ref:ln}),Et&&a.jsx("div",{className:U("absolute bottom-16 w-full space-y-2",_s.TagGpt),children:a.jsx(gl,{onClick:S=>To(S),onClose:()=>{Rt(!1),f.focus()}})}),Bo&&a.jsx("div",{className:U("absolute bottom-16 space-y-2",_s.TagGpt),children:a.jsx(Mu,{composerController:f,clientThreadId:o})}),a.jsx(pu,{type:q?"temporary":"default",ref:N,replyRegions:Nt,placeholder:Ao,inputState:Do,composerController:f,leftSideActions:Qe,state:At,onSubmit:At==="streaming"?Mo:mt,renderFiles:Po,currentLeafId:G,clientThreadId:o,gizmoId:ye==null?void 0:ye.gizmo.id}),he&&I&&I.length>0&&!Et&&f.canShowAutocompletion()&&a.jsx("div",{className:U("absolute left-0 top-full z-10 mt-2 box-border w-full bg-token-main-surface-primary",(Qe==null?void 0:Qe.length)>0?`px-${Qe.length*8}`:"pl-0"),children:a.jsx(Ru,{suggestions:I,composerController:f,onSelect:x,onChange:zo})})]}),a.jsx(Br,{composerController:f,parsedDocumentHandler:jo})]})})}),a.jsx($d,{canUseInlineTagging:ht,isDisabled:c,clientThreadId:o,currentLeafId:G,currentRequestId:ee,canContinue:g,composerController:f,setPromptInputMetadata:Ne,suggestions:m,isNewThread:i,onCreateNewCompletion:e,onContinueGenerating:s,onResetState:an,conversationMode:L}),L!=null&&!Lo&&zr.includes(L.kind)&&a.jsx(Ur,{onTargetedReply:Io})]})}const Du=Te({searchMode:{id:"LSO1pB",defaultMessage:"Search the web"}});function Fu(t){const e=d.useContext(gi);return({id:n,requestedModelId:o,eventMetadata:i,focusOnNewCompletion:r=!0,variantPurpose:l="none",useDefaultModel:c,appendMessages:u,conversationMode:h,juice:g=void 0,turnTracker:m,extraStreamParams:_})=>{var M;const f=k.getTree(t).getParentPromptNode(n),I=f.id;e({type:Ke.Variant,promptId:I,requestedModelId:o,eventMetadata:i,cancelActiveRequests:!1,focusOnNewCompletion:r,useDefaultModel:c,completionMetadata:{variantPurpose:l,conversationMode:h,juice:g,systemHints:(M=f.message.metadata)==null?void 0:M.system_hints},appendMessages:u,turnTracker:m,extraStreamParams:_})}}function Ou(t){var o,i,r,l,c;const e=((o=t.message)==null?void 0:o.author.role)===_e.User,s=((i=t.metadata)==null?void 0:i.err)!=null&&((r=t.metadata)==null?void 0:r.errCode)!==_t.ContentPolicy,n=((l=t.metadata)==null?void 0:l.errCode)===_t.ModelIncompatibility;return((c=t.metadata)==null?void 0:c.canRetry)===!1||n?!1:e||s}function pf(t){return t.composerController?a.jsx(qn,{...t,composerController:t.composerController}):a.jsx(El,{children:e=>a.jsx(qn,{...t,composerController:e})})}function qn({clientThreadId:t,isNewThread:e,currentModelId:s,showPromptStarters:n,onRequestCompletion:o,composerContainerRef:i,composerController:r,setComposerBarElement:l}){const c=Dc(),u=$r(),h=lt(g=>{const m=Oe.getCurrentNode(t,g);return Ou(m)});return Kr(r),!u&&h?a.jsx(Lu,{clientThreadId:t}):a.jsxs(a.Fragment,{children:[a.jsx(nd,{clientThreadId:t}),a.jsx(vl,{clientThreadId:t,isStaticSharedThread:c,showInlineEmbeddedDisplay:!1,withVerticalPadding:!1,withHorizontalPadding:!0,children:a.jsx(bl,{children:a.jsx(Bu,{composerContainerRef:i,composerController:r,clientThreadId:t,currentModelId:s,isNewThread:e,showPromptStarters:n,setComposerBarElement:l,onRequestCompletion:o})})})]})}function Lu({clientThreadId:t}){const e=Fu(t),s=lt(i=>{var l;return((l=Oe.getCurrentNode(t,i).metadata)==null?void 0:l.errCode)===Ss}),n=Zr(i=>i.isoDate),o=dt(t);return s&&n!=null&&n!==""?null:a.jsxs("div",{children:[a.jsx("div",{className:"mb-3 text-center text-xs",children:a.jsx(z,{...Vn.errorGeneratingResponse})}),a.jsx("div",{className:"flex items-center md:mb-4",children:a.jsx(wt,{as:"button",color:"primary",onClick:()=>{const i=new Ds;e({id:o,eventMetadata:{eventSource:"mouse"},conversationMode:Oe.getConversationMode(t),turnTracker:i})},className:"m-auto",icon:Ka,children:a.jsx(z,{...Vn.regenerateResponse})})})]})}function Bu({clientThreadId:t,currentModelId:e,isNewThread:s,onRequestCompletion:n,showPromptStarters:o,composerContainerRef:i,composerController:r,autocompletions:l,requiresFileUpload:c,onComposerInput:u,onComposerChange:h,onAutocompleteSelect:g,headerClassName:m,hideHeader:_,setComposerBarElement:p,onTaggingDropdownClose:f,onTaggingDropdownOpen:I}){var qe,ut;const M=dt(t),T=ss(t),j=wa(),{isUnauthenticated:x}=St(),w=Fc(t)===fa.PENDING,N=Oc({clientThreadId:t,conversationLeafId:M}),P=Fs(T),F=(P||w)&&!N,R=dt(t),X=!x,H=ha(),{isOpen:G,onClose:ee}=Jr(),te=d.useCallback((ne,le)=>{O.logEvent(A.continueCompletion),n({type:Ke.Continue,promptId:ne,eventMetadata:{eventSource:"mouse"},cancelActiveRequests:!1,completionMetadata:{conversationMode:Oe.getConversationMode(t)},turnTracker:le})},[n,t]),K=ga(),$=d.useCallback(async(ne,le)=>{var Le;const ke=k.getServerThreadId(t);Ct.stopConversation(ke);const nt=k.getTree(t);!nt.hasReceivedServerCompletion&&!H&&((Le=nt.getParent(le).metadata)==null?void 0:Le.errCode)!==_t.ContentPolicy&&setTimeout(()=>{ks.onCreateFinished(K,ke,H)},500),ke&&He.checkGate("3922476776")&&await Ze.stopConversationProcess(ke),Gs.abortRequest(le)&&k.updateTree(t,Ye=>{const at=k.getThreadCurrentLeafId(t);Ye.updateNodeMessageMetadata(at,{finish_details:{type:"interrupted"}})})},[t,H,K]),C=d.useCallback(async({promptId:ne,content:le,eventMetadata:ke,completionMetadata:nt,messageMetadata:Tt,appendMessages:Le,turnTracker:Ye})=>{const at=k.getThreadCurrentLeafId(t);k.updateTree(t,Ve=>{Ve.addNode(ne,le,at,_e.User,void 0,Tt)}),await n({type:Ke.Next,promptId:ne,eventMetadata:ke,cancelActiveRequests:!0,completionMetadata:nt,appendMessages:Le,turnTracker:Ye})},[t,n]),b=Lc(t,M),D=Bc(t,M),q=!N&&(P||w),Z=d.useMemo(()=>q?!1:!b&&D,[b,D,q]),V=q&&e!=="gpt-4-pbrowse",xe=zc(t),ue=qa(t),ie=Ws(ue).data,{promptStarters:ve,isSuccess:Ne}=Sl(s&&!xe,t,4),y=Ia(),se=(()=>{var ne,le;if((y==null?void 0:y.messageId)===((le=(ne=k.getTree(t).getLastValidNode(M))==null?void 0:ne.message)==null?void 0:le.id))return y==null?void 0:y.suggestions;if(o&&!xe&&Ne&&!X)return ve})(),he=k.getTree(t),J=he.countMessagesByAuthor(_e.User),re=d.useRef(),je=d.useRef();let Y=!1;re.current==J&&je.current==R?Y=!0:re.current!==J&&je.current!==R&&(Y=!0,re.current=J,je.current=R);const Me=he.getNodeByIdOrMessageId(M),L=Y&&((qe=Me==null?void 0:Me.message)==null?void 0:qe.author.role)==_e.Assistant&&Ms(Me.message),ye=ul(),ce=pi(),Pe=(()=>{var ke;if(((ke=ie==null?void 0:ie.gizmo.tags)==null?void 0:ke.includes(Ba.WorkspaceDisabled))&&!ce)return"workspaceDisallowsGizmo";if(ye.size){if(j.displayingSideBySideFeedback&&j.unskippable)return"feedbackRequired"}else return"noModelsAvailable";const le=Oe.getConversationMode(t);return(le==null?void 0:le.kind)===we.GizmoTest&&le.gizmo_id==null?"noTestGizmoId":null})(),st=Uc(t),Je=qs(t),It=(ut=xi("15117983"))==null?void 0:ut.value;return a.jsxs(a.Fragment,{children:[(s||L)&&G?a.jsx(Yr,{onClose:ee}):null,It&&Je&&Je.kind===we.PrimaryAssistant&&Je.plugin_ids&&Je.plugin_ids.length>0?a.jsx(zu,{}):a.jsx(Pu,{composerContainerRef:i,composerController:r,clientThreadId:t,onCreateNewCompletion:C,onAbortCompletion:$,onContinueGenerating:te,currentModelId:e,isNewThread:s,isCompletionInProgress:F,className:"w-full",canContinue:Z,suggestions:se??[],disabled:!!Pe,disabledReason:Pe??void 0,canPause:V,isInteractableSharedThread:st,autocompletions:l,requiresFileUpload:c,onComposerInput:u,onComposerChange:h,onAutocompleteSelect:g,headerClassName:m,hideHeader:_,setComposerBarElement:p,onTaggingDropdownClose:f,onTaggingDropdownOpen:I},t)]})}function zu(){return a.jsxs("div",{className:"mx-auto flex max-w-md flex-col items-center justify-center gap-2 rounded-xl border border-token-border-light bg-token-main-surface-primary p-6 shadow-lg",children:[a.jsx("span",{className:"text-token-text-primary",children:a.jsx(z,{id:"PluginsDecrepatedNotice.pluginsDeprecationTitle",defaultMessage:"Conversations with plugins are archived"})}),a.jsx("span",{className:"text-token-text-secondary",children:a.jsx(z,{id:"PluginsDecrepatedNotice.pluginsDeprecationSubtitle",defaultMessage:"Explore GPT Store to find a replacement"})}),a.jsxs("a",{href:"https://chat.openai.com/gpts",className:"text-green-500 hover:cursor-pointer dark:text-green-400",children:[a.jsx(z,{id:"PluginsDecrepatedNotice.pluginsDeprecationGptStoreLink",defaultMessage:"Explore GPTs"}),a.jsx("span",{className:"ml-2",children:a.jsx(z,{id:"PluginsDecrepatedNotice.pluginsDeprecationGptStoreLinkArrow",defaultMessage:"→"})})]})]})}const Vn=Te({errorGeneratingResponse:{id:"PromptTextarea.errorGeneratingResponse",defaultMessage:"There was an error generating a response"},regenerateResponse:{id:"PromptTextarea.regenerateResponse",defaultMessage:"Regenerate"}}),Uu=de(()=>oe(()=>import("./bt3c2fgrsug2x0bp.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27])).then(t=>t.default)),Gu=de(()=>oe(()=>import("./sso-da2v16cola0b6d9b.js").then(t=>t.j),__vite__mapDeps([28,1,2,3,29,5,6,13,30,31,32,33,34,35,10,36,7,12,37,38,39,40,41,26,15,42,43,44,45,46,18,21,24,47,19,20,48,49,25,50,51,52,53,54,55,56,57,58,23,59,60,61,62,63,17,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,4,8,9,11,14,82])).then(t=>t.default).catch(()=>kt)),Hu=Ee.div`flex gap-2 flex-wrap mt-1 max-w-[80%] justify-end`,qu=Ee.div`flex flex-col gap-2`,Vu=({parts:t,attachments:e,isUserTurn:s,clientThreadId:n})=>{const o=Zt(),i=$s(n),r=Zs(),l=yi.getImageAssetPointersFromParts(t),c=new Set(l.map(p=>es(p.asset_pointer))),h=Xt()||o,g=(e??[]).filter(p=>ka(p.name)),m=(e??[]).filter(p=>p.id==null||c.has(p.id)?!1:r||i?!g.includes(p):!0);return(r||i?(m.length>0||g.length>0)&&s:m.length>0&&s)?a.jsxs(a.Fragment,{children:[a.jsxs(Hu,{children:[m.map(p=>a.jsx(za,{file:p.name,fileId:p.id,contextConnectorInfo:Qr(p.context_connector_info),width:o?"normal":"wide",alwaysShowData:!0},p.id)),i&&g.map(p=>a.jsx(Gu,{visualization:Tn(p)},p.id))]}),r&&!i&&a.jsx(qu,{className:U(!h&&"w-[80%]"),children:g.map(p=>a.jsx(Uu,{clientThreadId:n,visualization:Tn(p)},p.id))})]}):null};function fo(t){return Ms(t)&&!_i(t)}const zt=50,Wu=95;function $u(t,e){if(t<=e)return t/e*zt;{const s=zt,n=Wu-zt,o=t-e,r=-(zt/e)/n;return s+n*(1-Math.exp(r*o))}}class Ku{constructor(){B(this,"mostRecentCompletionRequest");B(this,"loggedRequestIds",new Set)}onCompletionRequestStarted(e){this.mostRecentCompletionRequest={requestId:e,timestamp:Date.now()}}onDisplayTextAfterBrowsingSession(e,s){const n=this.mostRecentCompletionRequest;if(n!=null&&!this.loggedRequestIds.has(n.requestId)){const i=k.getThreadConversationTurns(e,s).find(r=>r.messages.some(l=>l.message.id===s));i!=null&&i.messages.some(r=>r.nodeId===n.requestId)&&(O.logEvent(A.browsingTimeToFirstTextToken,{messageId:s,timeMs:Date.now()-n.timestamp}),this.loggedRequestIds.add(n.requestId))}}}const ho=new Ku;function Zu(t){var o;const e=t.find(i=>{var r;return((r=i.message.metadata)==null?void 0:r.image_search_results)!==void 0});return(((o=e==null?void 0:e.message.metadata)==null?void 0:o.image_search_results)??[]).slice(0,5)}function Ju({messages:t}){const e=Zu(t),s=Xr();return e.length===0?null:a.jsx("div",{className:U({"mb-2":!0,"grid grid-flow-col gap-3":e.length>1,"w-1/3":e.length===1}),children:e.filter(({contentUrl:n})=>s.has(n)).map((n,o)=>a.jsx("a",{href:n.hostPageUrl,target:"_blank",rel:"noreferrer",children:a.jsx("img",{src:n.contentUrl,alt:n.name,className:"aspect-square rounded-xl object-cover"})},o))})}const Yu=de(()=>oe(()=>import("./sso-da2v16cola0b6d9b.js").then(t=>t.k),__vite__mapDeps([28,1,2,3,29,5,6,13,30,31,32,33,34,35,10,36,7,12,37,38,39,40,41,26,15,42,43,44,45,46,18,21,24,47,19,20,48,49,25,50,51,52,53,54,55,56,57,58,23,59,60,61,62,63,17,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,4,8,9,11,14,82])).then(t=>t.default).catch(()=>kt));function go({attachments:t,citations:e,contentReferences:s,className:n,clientThreadId:o,displayParts:i,id:r,isActivelyStreaming:l,isUserTurn:c,turnIndex:u,isFeedbackEnabled:h,messages:g,onRequestMoreCompletions:m,parts:_,prevGroupedMessageType:p,prevGroupedMessages:f,showEditButton:I,onEnterEdit:M,size:T="medium"}){var F,R;const j=$s(o),x=g.length>1,{flagSeverity:v,shouldHideContent:w}=to(x?void 0:g[0]),N=!_.some(X=>X!==""),P=((F=g[0].message.metadata)==null?void 0:F.targeted_reply_label)??((R=g[0].message.metadata)==null?void 0:R.targeted_reply);return d.useEffect(()=>{!N&&p===E.Browsing&&ho.onDisplayTextAfterBrowsingSession(o,g[0].message.id)},[N,g,o,p]),a.jsxs("div",{"data-message-author-role":g[0].message.author.role,"data-message-id":g[0].message.id,dir:"auto",className:U(n,"text-message flex w-full flex-col items-end gap-2 whitespace-normal break-words [.text-message+&]:mt-5"),children:[P&&a.jsxs("div",{className:"mb-1 ml-6 mt-1 flex items-start gap-1.5 text-sm font-normal text-token-text-tertiary sm:ml-7 lg:ml-8",children:[a.jsx(Vs,{className:"icon-md mt-1 shrink-0"}),a.jsx("p",{className:"mr-2 line-clamp-3",children:P})]}),c&&j&&a.jsx(Yu,{messages:g}),a.jsx(ec,{messages:g}),a.jsx(Qu,{parts:_,attachments:t,isUserTurn:c,turnIndex:u,displayParts:i,isActivelyStreaming:l,shouldHideContent:w,showEditButton:I,onEnterEdit:M,clientThreadId:o,id:r,isEmpty:N,prevGroupedMessageType:p,prevGroupedMessages:f,flagSeverity:v,messages:g,citations:e,contentReferences:s,size:T}),a.jsx(Al,{message:x?void 0:g[0],id:r,isFeedbackEnabled:h,onRequestMoreCompletions:m,clientThreadId:o,isUserTurn:c}),a.jsx(tc,{isUserTurn:c,message:x?void 0:g[0]}),!c&&!l&&f&&p===E.SearchResult&&a.jsx(Ju,{messages:f})]})}function Qu({clientThreadId:t,id:e,displayParts:s,turnIndex:n,isActivelyStreaming:o,shouldHideContent:i,showEditButton:r=!1,onEnterEdit:l,isEmpty:c,prevGroupedMessageType:u,prevGroupedMessages:h,messages:g,citations:m,contentReferences:_,size:p,isUserTurn:f,parts:I,attachments:M}){var K,$;const T=ae(),j=sc(s),x=nc(),v=(K=g[0].message.metadata)==null?void 0:K.gizmo_id,w=($=g[0].message.metadata)==null?void 0:$.serialization_metadata,N=Gc(g[0].message).length,P=d.useMemo(()=>({clientThreadId:t,messageId:e,turnIndex:n}),[t,e,n]),F=ac(g[0].message),R=!!v&&x.includes(v),X=d.useCallback(C=>{oc.open(C,n,e)},[n,e]),H=a.jsx(Vu,{parts:I,attachments:M,isUserTurn:f,clientThreadId:t},"files-and-tables"),G=!!(M!=null&&M.length||s.some(C=>C.type==="images")),ee=s.map((C,b)=>{var D;if(C.type==="transcription"){const q=i?null:C.text;let Z=null;return f&&i?Z=a.jsx("span",{className:"italic opacity-30",children:a.jsx(z,{...Ut.contentRemoved})}):f&&q!=null?Z=q.trim().length===0?a.jsx("span",{className:"italic opacity-30",children:a.jsx(Ft,{text:T.formatMessage(Ut.transcriptUnavailable),customSymbolOffsets:void 0})}):a.jsx("span",{className:"italic opacity-65",children:a.jsx(Ft,{text:`“${q.trim()}”`,customSymbolOffsets:void 0})}):!f&&q!=null&&(Z=a.jsx(Ft,{text:q,customSymbolOffsets:void 0})),a.jsx(ds,{containsImagesOrAttachments:G,isUserTurn:f,showEditButton:r,onEnterEdit:l,children:Z},b)}else if(C.type==="text"){const q=i?null:C.text;if(!c&&!i&&!f){const Z=u===E.CodeInterpreter?h==null?void 0:h.map(ve=>ve.message):void 0,{text:V,contentReferences:xe}=ic(j,m,_,R),{processedText:ue,displayedContentReferences:ie}=rc(V,xe,o?void 0:Z);return a.jsx(cc.Provider,{value:{analyticsMetadata:P,message:g[0].message,contentReferences:ie,onShowSearchResults:X,numImageResults:N,isActivelyStreaming:o,useSafeUrls:!0},children:a.jsx(Hs,{clientThreadId:t,messageId:e,size:p,className:U(o&&"result-streaming",F&&"headers-v2"),children:ue===""?"&#8203;":ue})},b)}else if(c&&o&&!f)return a.jsx("div",{className:"result-streaming",children:a.jsx("div",{children:a.jsx("pre",{})})},b);return a.jsx(ds,{containsImagesOrAttachments:G,isUserTurn:f,showEditButton:r,onEnterEdit:l,children:f&&i?a.jsx("span",{className:"italic opacity-30",children:a.jsx(z,{...Ut.contentRemoved})}):q?a.jsx(Ft,{text:q,customSymbolOffsets:w==null?void 0:w.custom_symbol_offsets}):null},b)}else if(C.type==="images"){const q=((D=g[0].message.metadata)==null?void 0:D.attachments)??[];return a.jsx(lc,{assets:C.imageAssets,attachments:q},b)}else return null}),te=s.findIndex(C=>C.type==="text");if(te!==-1?ee.splice(te,0,H):ee.push(H),i&&f)ee.length=0,ee.push(a.jsx(ds,{containsImagesOrAttachments:G,isUserTurn:f,onEnterEdit:xs,children:a.jsx("span",{className:"italic opacity-30",children:a.jsx(z,{...Ut.contentRemoved})})}));else if(i&&!f)return null;return a.jsx("div",{className:U("flex w-full flex-col gap-1 empty:hidden",f&&"items-end rtl:items-start",!f&&"first:pt-[3px]"),children:ee})}const Ut=Te({contentRemoved:{id:"textMessage.contentRemoved",defaultMessage:"Content removed"},transcriptUnavailable:{id:"textMessage.transcriptUnavailable",defaultMessage:"Transcript Unavailable"}});function Xu(t){var u;const{isActivelyStreaming:e,...s}=t,n=ua(),o=(n==null?void 0:n.includes("debug"))??!1,i=t.messages[t.messages.length-1].message.id,[r,l]=d.useState([]),c=d.useRef();return c.current===void 0&&(c.current=(n==null?void 0:n.includes(vi))??!1?new dc(t.parts,l,e,void 0,{debug:o}):new uc(t.parts,l,e)),d.useEffect(()=>{c.current!=null&&(c.current.onMessagePartsUpdated(t.parts,e),c.current.isBuffering()&&xt.addDelayedRenderingMessage(i))},[t.parts,i,e]),d.useEffect(()=>{c.current!=null&&!c.current.isBuffering()&&xt.removeDelayedRenderingMessage(i)},[r,i]),d.useEffect(()=>()=>xt.removeDelayedRenderingMessage(i),[i]),d.useEffect(()=>()=>{c.current!=null&&(c.current.destroy(),c.current=void 0)},[]),a.jsx(go,{...s,displayParts:r,isActivelyStreaming:e||((u=c.current)==null?void 0:u.isBuffering())})}function em({message:t,isCompletionInProgress:e,clientThreadId:s,className:n,isUserTurn:o,turnIndex:i,isFeedbackEnabled:r,prevGroupedMessageType:l,prevGroupedMessages:c,showEditButton:u,onEnterEdit:h,onRequestMoreCompletions:g}){var _,p,f;const m=d.useMemo(()=>"parts"in t.message.content?t.message.content.parts:[pa(t.message)],[t]);return a.jsx(sm,{parts:m,messages:[t],isCompletionInProgress:e,className:n,citations:(_=t.message.metadata)==null?void 0:_.citations,contentReferences:(p=t.message.metadata)==null?void 0:p.content_references,attachments:(f=t.message.metadata)==null?void 0:f.attachments,isUserTurn:o,turnIndex:i,id:t.nodeId,isFeedbackEnabled:r,onRequestMoreCompletions:g,clientThreadId:s,showEditButton:u,onEnterEdit:h,prevGroupedMessageType:l,prevGroupedMessages:c})}const tm=bi.memo(em);function sm(t){const e=t.messages.length>1,{flagSeverity:s}=to(e?void 0:t.messages[0]),n=s!=="danger"&&t.isCompletionInProgress,o=!t.parts.some(r=>r!==""),[i]=d.useState(()=>!t.isUserTurn&&(t.isCompletionInProgress||o));return i?a.jsx(Xu,{...t,isActivelyStreaming:n}):a.jsx(go,{...t,displayParts:mc({isUserTurn:t.isUserTurn,parts:t.parts}),isActivelyStreaming:n})}const nm=de(()=>oe(()=>import("./f5txz0bld0khrrji.js"),__vite__mapDeps([83,1,2,3])));function po({animationData:t,animationSegmentToPlay:e,animationLoopCounter:s}){const n=d.useRef(null);return d.useEffect(()=>{var o;(o=n.current)==null||o.playSegments(e,!0)},[s]),a.jsx(nm,{animationData:t,lottieRef:n,loop:!1,autoplay:!1})}function am(t){return a.jsx(As,{width:"8",height:"9",viewBox:"0 0 8 9",fill:"none",...t,children:a.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M7.66607 0.376042C8.01072 0.605806 8.10385 1.07146 7.87408 1.4161L3.54075 7.9161C3.40573 8.11863 3.18083 8.24304 2.93752 8.24979C2.69421 8.25654 2.46275 8.1448 2.31671 7.95008L0.150044 5.06119C-0.098484 4.72982 -0.0313267 4.25972 0.300044 4.01119C0.631415 3.76266 1.10152 3.82982 1.35004 4.16119L2.88068 6.20204L6.62601 0.584055C6.85577 0.239408 7.32142 0.146278 7.66607 0.376042Z",fill:"currentColor"})})}function om(t){return a.jsxs(As,{width:"4",height:"12",viewBox:"0 0 4 12",fill:"none",...t,children:[a.jsx("mask",{id:"path-1-inside-1_1975_4008",fill:"currentColor",children:a.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M1 6.5C1 7.05228 1.44772 7.5 2 7.5C2.55228 7.5 3 7.05228 3 6.5V1.5C3 0.947715 2.55228 0.5 2 0.5C1.44772 0.5 1 0.947715 1 1.5L1 6.5ZM0.75 10.25C0.75 10.9404 1.30964 11.5 2 11.5C2.69036 11.5 3.25 10.9404 3.25 10.25C3.25 9.55964 2.69036 9 2 9C1.30964 9 0.75 9.55964 0.75 10.25Z"})}),a.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M1 6.5C1 7.05228 1.44772 7.5 2 7.5C2.55228 7.5 3 7.05228 3 6.5V1.5C3 0.947715 2.55228 0.5 2 0.5C1.44772 0.5 1 0.947715 1 1.5L1 6.5ZM0.75 10.25C0.75 10.9404 1.30964 11.5 2 11.5C2.69036 11.5 3.25 10.9404 3.25 10.25C3.25 9.55964 2.69036 9 2 9C1.30964 9 0.75 9.55964 0.75 10.25Z",fill:"currentColor"}),a.jsx("path",{d:"M1 6.5H-0.25H1ZM1 1.5L-0.25 1.5L-0.25 1.5L1 1.5ZM2 6.25C2.13807 6.25 2.25 6.36193 2.25 6.5H-0.25C-0.25 7.74264 0.757359 8.75 2 8.75V6.25ZM1.75 6.5C1.75 6.36193 1.86193 6.25 2 6.25V8.75C3.24264 8.75 4.25 7.74264 4.25 6.5H1.75ZM1.75 1.5V6.5H4.25V1.5H1.75ZM2 1.75C1.86193 1.75 1.75 1.63807 1.75 1.5H4.25C4.25 0.257359 3.24264 -0.75 2 -0.75V1.75ZM2.25 1.5C2.25 1.63807 2.13807 1.75 2 1.75V-0.75C0.757359 -0.75 -0.25 0.257359 -0.25 1.5L2.25 1.5ZM2.25 6.5L2.25 1.5L-0.25 1.5L-0.25 6.5L2.25 6.5ZM2 10.25H-0.5C-0.5 11.6307 0.619288 12.75 2 12.75V10.25ZM2 10.25V12.75C3.38071 12.75 4.5 11.6307 4.5 10.25H2ZM2 10.25H2H4.5C4.5 8.86929 3.38071 7.75 2 7.75V10.25ZM2 10.25H2V7.75C0.619288 7.75 -0.5 8.86929 -0.5 10.25H2Z",fill:"currentColor",mask:"url(#path-1-inside-1_1975_4008)"})]})}function im(t){return a.jsx(As,{width:"8",height:"9",viewBox:"0 0 8 9",fill:"none",...t,children:a.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M7.32256 1.48447C7.59011 1.16827 7.55068 0.695034 7.23447 0.427476C6.91827 0.159918 6.44503 0.199354 6.17748 0.515559L4.00002 3.08892L1.82256 0.515559C1.555 0.199354 1.08176 0.159918 0.765559 0.427476C0.449355 0.695034 0.409918 1.16827 0.677476 1.48447L3.01755 4.25002L0.677476 7.01556C0.409918 7.33176 0.449354 7.805 0.765559 8.07256C1.08176 8.34011 1.555 8.30068 1.82256 7.98447L4.00002 5.41111L6.17748 7.98447C6.44503 8.30068 6.91827 8.34011 7.23447 8.07256C7.55068 7.805 7.59011 7.33176 7.32256 7.01556L4.98248 4.25002L7.32256 1.48447Z",fill:"currentColor"})})}function xf({animationLoopCounter:t}){const{resolvedTheme:e}=Es(),s=e==="dark";return a.jsx(po,{animationData:s?fc:hc,animationSegmentToPlay:[0,300],animationLoopCounter:t})}function yf({animationLoopCounter:t}){const{resolvedTheme:e}=Es(),s=e==="dark";return a.jsx(po,{animationData:s?gc:pc,animationSegmentToPlay:[0,400],animationLoopCounter:t})}const rm=2e3,xo=.4,cm=.45,lm=.2,dm=.1,um=.25;var Ie=(t=>(t[t.Running=0]="Running",t[t.Finished=1]="Finished",t[t.Error=2]="Error",t[t.Stopped=3]="Stopped",t[t.Paused=4]="Paused",t))(Ie||{});function _f({conversationMessages:t,icon:e,status:s,text:n,estimatedToolDurationMs:o,animationLoopDurationMs:i=rm,shouldPersistAfterFinished:r=!1}){const[l,c]=d.useState(s===0?0:s===1&&!r?7:1),[u,h]=d.useState(0);d.useEffect(()=>{s===2?c(8):s===3?c(9):s===4?c(10):s===1?c(l===2?3:7):s===0&&l===10&&(c(2),h(m=>m+1))},[s]);const g=hm(l);return d.useEffect(()=>{const m=t[0].message.id;if(g)return xt.addDelayedRenderingMessage(m),()=>{xt.removeDelayedRenderingMessage(m)}},[g]),Ua(()=>{rt(l)&&h(m=>m+1)},i),l===7&&!r?null:a.jsxs("div",{className:"my-2.5 flex items-center gap-2.5",children:[a.jsx(mm,{icon:e,status:s,uiState:l,estimatedToolDurationMs:o,animationLoopCounter:u,shouldPersistAfterFinished:r,onFillProgressBarAnimationComplete:()=>c(4),onFinishAnimationComplete:()=>{c(5),setTimeout(()=>{c(r?7:6)},dm*1e3)},onHideAnimationComplete:()=>c(7)}),a.jsx(fm,{text:n,uiState:l,animationLoopCounter:u,onEnterAnimationComplete:()=>c(2)})]})}const Wn=50;function mm({icon:t,status:e,uiState:s,estimatedToolDurationMs:n,animationLoopCounter:o,shouldPersistAfterFinished:i,onFillProgressBarAnimationComplete:r,onFinishAnimationComplete:l,onHideAnimationComplete:c}){const[u,h]=d.useState(0);Ua(()=>{rt(s)?h(T=>T+Wn):s===10&&h(0)},Wn);let g,m,_;rt(s)||s===10?(g="running",m=a.jsx(t,{animationLoopCounter:o}),_="bg-transparent"):s===4||s===5||s===7&&i?(g="finished",m=a.jsx(am,{}),_="bg-brand-purple"):e===2?(g="error",m=a.jsx(om,{}),_="bg-orange-500"):e===3&&(g="stopped",m=a.jsx(im,{}),_="bg-gray-300");let p={opacity:0,scale:0,rotate:-180,x:0},f={type:"spring",bounce:.3,duration:cm},I={opacity:0,scale:.6,rotate:0,x:0};s===0?(p={opacity:0,scale:.5,rotate:-180,x:-8},f={type:"spring",bounce:.3,duration:xo}):s===1?p=!1:s===5&&(I={opacity:0,scale:0,rotate:0,x:0},f={type:"spring",bounce:.3,duration:um});const M=$u(u,n);return a.jsx("div",{className:"relative h-5 w-5 shrink-0",children:a.jsx(ct,{onExitComplete:()=>{s===6&&c()},children:g!=null&&a.jsxs(fe.div,{className:U("absolute left-0 top-0 flex h-full w-full items-center justify-center rounded-full text-white",_),initial:p,animate:{opacity:1,scale:1,rotate:0,x:0},exit:I,transition:f,onAnimationComplete:()=>{s===4&&l()},children:[m,(rt(s)||s===10)&&a.jsx(xc,{percentage:s===3?100:M,thickness:1.5/23,className:"absolute left-1/2 top-1/2 h-[23px] w-[23px] -translate-x-1/2 -translate-y-1/2 text-brand-purple",backgroundStrokeClassName:"stroke-brand-purple/25 dark:stroke-brand-purple/50",transitionDuration:s===3?`${(100-M)/100*lm}s`:void 0,transitionTimingFunction:s===3?"cubic-bezier(0.55, 0, 1, 1)":void 0,onTransitionEnd:()=>{s===3&&r()}})]},g)})})}function fm({text:t,uiState:e,animationLoopCounter:s,onEnterAnimationComplete:n}){const[o,i]=d.useState(t);d.useEffect(()=>{e===2&&i(t)},[s]),d.useEffect(()=>{rt(e)||i(t)},[e,t]);let r={opacity:0,x:0,y:15},l={type:"spring",bounce:.3,opacity:{duration:.15},y:{duration:.3}};e===0?(r={opacity:0,x:-8,y:0},l={type:"spring",bounce:.3,duration:xo,delay:.15}):e===1&&(r=!1);const c=o??void 0;return a.jsx("div",{className:U("relative h-5 w-full leading-5",e===8||e===9?"text-token-text-tertiary":"text-token-text-secondary"),children:a.jsx(ct,{children:c!=null&&a.jsx(fe.div,{className:"absolute left-0 top-0 line-clamp-1 overflow-visible",initial:r,animate:{opacity:1,x:0,y:0},exit:{opacity:0,x:0,y:-15},transition:l,onAnimationComplete:()=>{e===0&&n()},children:c},c.toString())})})}function rt(t){return t===0||t===2||t===3}function hm(t){return rt(t)||t===4||t===5||t===6||t===10}const $n=Ee.div`group absolute left-0 top-0 mr-1.5 h-8 overflow-hidden mt-1`;function en({highlightedCommand:t,status:e,children:s,showWorkUserSetting:n=!1,hideOnlyIfNotInteractedWith:o=!1,onOpenAnalytics:i}){const r=s!=null,[l]=d.useState(n),[c,u]=d.useState(n),[h,g]=d.useState(!1),m=e===Ie.Finished||e===Ie.Error,_=o?l?!1:!h:!1,p=e===Ie.Running&&"loading-shimmer";return m&&_?null:r?a.jsxs(a.Fragment,{children:[a.jsx(Kn,{$canShowWork:!0,children:a.jsx(ct,{children:a.jsx($n,{children:a.jsx(fe.button,{onClick:()=>{c||i==null||i(),u(f=>!f),g(!0)},initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},className:U(p),children:a.jsxs("div",{className:"flex items-center justify-start gap-1",children:[a.jsx("span",{children:t}),c?a.jsx(tl,{className:"icon-md"}):a.jsx($a,{className:"icon-md"})]})},t==null?void 0:t.toString())})})}),a.jsx(ct,{children:c&&s&&a.jsx(fe.div,{initial:"collapsed",animate:"reveal",exit:"collapsed",variants:{collapsed:{translateY:-20,opacity:0,height:0},reveal:{translateY:0,opacity:1,height:"auto"}},transition:{duration:.3,ease:"easeInOut"},className:"overflow-hidden",children:s})})]}):a.jsx(Kn,{$canShowWork:!1,children:a.jsx($n,{className:U(p),children:t})})}const Kn=Ee.p`first:mt-0 my-1.5 relative h-8
${({$canShowWork:t})=>t?"text-token-text-secondary hover:text-token-text-primary":"text-token-text-secondary"}`,gm=de(()=>oe(()=>import("./sso-da2v16cola0b6d9b.js").then(t=>t.j),__vite__mapDeps([28,1,2,3,29,5,6,13,30,31,32,33,34,35,10,36,7,12,37,38,39,40,41,26,15,42,43,44,45,46,18,21,24,47,19,20,48,49,25,50,51,52,53,54,55,56,57,58,23,59,60,61,62,63,17,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,4,8,9,11,14,82])).then(t=>t.default).catch(()=>kt)),Zn=de(()=>oe(()=>import("./bt3c2fgrsug2x0bp.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27])).then(t=>t.default));function pm({messages:t,isRequestActive:e,clientThreadId:s}){var I,M,T;const[n,o]=t,i=fo(n.message),r=(I=o==null?void 0:o.message.metadata)==null?void 0:I.aggregate_result,l=Dd(),c=Zs(),u=$s(s),h=o!=null&&o.message?io(o.message):[],g=((T=(M=o==null?void 0:o.message.metadata)==null?void 0:M.aggregate_result)==null?void 0:T.messages.filter(so))??[],_=(h.filter(j=>j.type==="chart")??[]).length!==g.length,p=c&&!_;let f=Ie.Running;return(r==null?void 0:r.status)==="success"?f=Ie.Finished:o!=null&&o.message.content.content_type!==Jt.ExecutionOutput||r!=null&&r.status!=="running"?f=Ie.Error:(i||!e)&&(f=Ie.Stopped),a.jsxs(a.Fragment,{children:[a.jsx(xm,{messages:t,status:f,isRequestActive:e}),p&&h.map((j,x)=>{const{file_id:v,type:w}=j;return u?a.jsx(gm,{isStreaming:f===Ie.Running,visualization:j},v):w==="chart"&&!l?(j.fallback_to_image=!0,a.jsx(Jn,{children:a.jsx(Zn,{clientThreadId:s,visualization:j})},x)):a.jsx(Jn,{children:a.jsx(Zn,{clientThreadId:s,visualization:j})},x)}),!p&&o!=null&&a.jsx(Nl,{message:o.message})]})}const Jn=Ee.div`mb-3 max-w-[80%]`;function xm({messages:t,status:e,isRequestActive:s}){var g;const[n,o]=t,i=ae(),r=(g=o==null?void 0:o.message.metadata)==null?void 0:g.aggregate_result,l=fo(n.message),{data:c,error:u}=Si(wi.ShowExpandedCodeView);let h=i.formatMessage({id:"message.tools.data-analysis.running",defaultMessage:"Analyzing"});if((r==null?void 0:r.status)==="success"?h=i.formatMessage({id:"message.tools.data-analysis.finished",defaultMessage:"Analyzed"}):o!=null&&o.message.content.content_type!==Jt.ExecutionOutput||r!=null&&r.status!=="running"?h=i.formatMessage({id:"message.tools.data-analysis.error",defaultMessage:"Analysis errored"}):(l||!s)&&(h=i.formatMessage({id:"message.tools.data-analysis.stopped",defaultMessage:"Analysis paused"})),c!==void 0||u){const m=Pl(n.message)!=null;return a.jsx(en,{status:e,highlightedCommand:h,showWorkUserSetting:c??!1,hideOnlyIfNotInteractedWith:!0,children:m?a.jsxs("div",{className:"mb-3 mt-0.5 overflow-hidden rounded-xl bg-black",children:[a.jsx(Dl,{message:n.message,FormattedText:Hs}),o!=null&&a.jsx(Fl,{message:o.message})]}):null})}return null}const ym=3,_m=.1,Yn=[0,.6,.9];function vm({nextMessage:t,isLastMessage:e,isRequestActive:s}){let n=e||(t==null?void 0:t.message.content.content_type)===Jt.Text&&!(t!=null&&t.message.content.parts.some(r=>r.length>0));const o=Hc(t==null?void 0:t.message),i=yc(o.slice(0,ym).map(r=>r.entries[0].url));if(n){const r=s?a.jsxs("div",{className:"flex items-center gap-1",children:[i.map((l,c)=>a.jsx(fe.div,{className:"-ml-1.5 first:ml-0 last:mr-1.5",initial:{width:c===0?0:6,opacity:0},animate:{width:20,opacity:1},transition:{duration:_m,delay:Yn[Math.min(c,Yn.length-1)]},children:a.jsx("div",{className:U("flex h-5 w-5 items-center overflow-hidden rounded","border-l-2 border-token-main-surface-primary bg-token-main-surface-primary"),children:a.jsx(_c,{url:l,size:32,minSize:16,className:"icon-md rounded"})})},l)),a.jsx(z,{id:"jjx8Qg",defaultMessage:"Searching the web"})]}):a.jsx(z,{id:"fssXGM",defaultMessage:"Error while searching"});return a.jsx(en,{highlightedCommand:r,status:s?Ie.Running:Ie.Error})}return null}const bm={strong:t=>{const{node:e,children:s,...n}=t;return a.jsx("strong",{...n,className:U(n.className,"font-semibold text-token-text-primary"),children:s})},p:t=>{const{node:e,children:s,...n}=t;return a.jsx("p",{...n,className:U(n.className,"text-base","has-[strong]:mb-1 [&:not(:first-child)]:has-[strong]:mt-3 [&:not(:has(strong))]:mb-3"),children:s})}};function Sm({messages:t,isStreaming:e,clientThreadId:s}){var _,p;const[n,o]=d.useState(""),[i,r]=d.useState(!1),l=t[0].message,c=l.id,u=k.getServerThreadId(s),h=pa(l);d.useEffect(()=>{var T;const f=/\*\*(.*?)(?:\*\*|\n|$)/g;let I,M="";for(;(I=f.exec(h))!=null;)M=I[1].trim();M?o(M):((T=l.metadata)==null?void 0:T.initial_text)!=null&&o(l.metadata.initial_text)},[h,(_=l.metadata)==null?void 0:_.initial_text]),d.useEffect(()=>{h.length>0&&r(!0)},[h]);const g=d.useMemo(()=>({client_thread_id:s,message_id:c,conversationId:u}),[s,c,u]);d.useEffect(()=>{i&&O.logEvent(A.receivedA8KM123Message,g)},[i]);const m=d.useCallback(()=>{O.logEvent(A.openedA8KM123Message,{...g,isStreaming:e})},[g,e]);return a.jsx(en,{status:e?Ie.Running:Ie.Finished,highlightedCommand:e?n:((p=l.metadata)==null?void 0:p.finished_text)??"",onOpenAnalytics:m,children:i?a.jsx("div",{className:"mb-4 border-l-2 pl-4 dark:border-token-text-secondary",children:a.jsx(Hs,{componentOverrides:bm,className:"not-prose leading-6",children:h})}):null})}const wm=de(()=>oe(()=>import("./sso-da2v16cola0b6d9b.js").then(t=>t.l),__vite__mapDeps([28,1,2,3,29,5,6,13,30,31,32,33,34,35,10,36,7,12,37,38,39,40,41,26,15,42,43,44,45,46,18,21,24,47,19,20,48,49,25,50,51,52,53,54,55,56,57,58,23,59,60,61,62,63,17,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,4,8,9,11,14,82])).then(t=>t.default).catch(()=>kt)),km=de(()=>oe(()=>import("./sso-da2v16cola0b6d9b.js").then(t=>t.J),__vite__mapDeps([28,1,2,3,29,5,6,13,30,31,32,33,34,35,10,36,7,12,37,38,39,40,41,26,15,42,43,44,45,46,18,21,24,47,19,20,48,49,25,50,51,52,53,54,55,56,57,58,23,59,60,61,62,63,17,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,4,8,9,11,14,82])).then(t=>t.JawboneMessage).catch(()=>kt)),Cm=de(()=>oe(()=>import("./e013ogehxv76gvgq.js"),__vite__mapDeps([84,1,2,3,5,6,12,7,15,16,17,18,10,19,20,21,22,23,24,25,14,26,27]))),Im=de(()=>oe(()=>import("./fedk582gxsh2zonc.js"),__vite__mapDeps([85,1,2,3]))),Tm=de(()=>oe(()=>import("./m7xadjibsu4du6rj.js"),__vite__mapDeps([86,1,2,3,5,6,12,7,15,16,17,18,10,19,20,21,22,23,24,25,14,26,27]))),jm=de(()=>oe(()=>import("./gcyuzmphyovbrxct.js"),__vite__mapDeps([87,1,2,3,5,6,12,7])).then(t=>t.TextMessageEditor)),Mm=de(()=>oe(()=>import("./is13ttzunr7mpqnq.js"),__vite__mapDeps([88,1,2,3,5,6,7,12,15,16,17,18,10,19,20,21,22,23,24,25,14,26,27]))),Rm=de(()=>oe(()=>import("./mfi3wq24ucy8dkxn.js"),__vite__mapDeps([89,1,2,3,5,6,12,7,15,16,17,18,10,19,20,21,22,23,24,25,14,26,27]))),Em=de(()=>oe(()=>import("./m8b5safipgf8vpm8.js"),__vite__mapDeps([90,1,2,3,5,6,26,15,12,7,41,16,17,18,10,19,20,21,22,23,24,25,14,27])).then(t=>t.BrowsingMessage)),Am=de(()=>oe(()=>import("./owafx93funvtwfq9.js"),__vite__mapDeps([91,1,2,3,5,6,12,7,15,16,17,18,10,19,20,21,22,23,24,25,14,26,27])).then(t=>t.SearchResultMessage)),Nm=de(()=>oe(()=>import("./mx0nwxmshmrykz4d.js"),__vite__mapDeps([92,1,2,3,5,6,15,12,7,17,18])).then(t=>t.GizmoContactsMessage)),Pm=de(()=>oe(()=>import("./lhetph3t4j1sfvip.js"),__vite__mapDeps([93,1,2,3,5,6,15,12,7,26,16,17,18,10,19,20,21,22,23,24,25,14,27])).then(t=>t.JITPluginMessage));function vf(t){switch(t.type){case E.Text:case E.Debug:return[t.message];case E.MultiText:case E.Browsing:case E.CodeInterpreter:case E.JITPlugin:case E.RetrievalBrowsing:case E.ParallelBrowsing:case E.Dalle:case E.GizmoEditor:case E.SearchResult:case E.GizmoContacts:case E.a8km123:case E.Canmore:case E.Jawbone:case E.SearchGPTQuery:return t.messages;default:throw new Error("Bad")}}function bf({groupedMessagesToRender:t,allGroupedMessages:e,clientThreadId:s,isEditing:n,isUserTurn:o,isCompletionRequestInProgress:i,isFeedbackEnabled:r,isFinalTurn:l,turnIndex:c,hasActiveRequest:u,showEditButton:h=!1,handleEnterEdit:g,handleExitEdit:m,onChangeItemInView:_,onRequestMoreCompletions:p,onRequestCompletion:f,shouldGrowContainer:I=!0}){const{showDebugConversationTurns:M}=La(),T=qs(s),j=t.map((x,v)=>{var N,P,F,R,X,H,G,ee,te,K,$,C,b;const w=v===e.length-1;switch(x.type){case E.Text:case E.MultiText:{const D=t[v-1],q=D==null?void 0:D.type,Z=D&&"messages"in D?D.messages:void 0;if(x.type===E.Text){const V=n?a.jsx(jm,{message:x.message,clientThreadId:s,onChangeItemInView:_,onRequestCompletion:f,onRequestMoreCompletions:p,onExitEdit:m,disabled:u}):a.jsx(tm,{className:"min-h-[20px]",message:x.message,isFeedbackEnabled:r,isCompletionInProgress:w&&i,turnIndex:c,clientThreadId:s,showEditButton:h,onEnterEdit:g,isUserTurn:o,onRequestMoreCompletions:p,prevGroupedMessageType:q,prevGroupedMessages:Z});return a.jsxs(d.Fragment,{children:[V,a.jsx(vc,{isUserTurn:o,message:x.message.message})]},"group-"+x.message.nodeId)}else return x.type===E.MultiText?a.jsx(Tm,{clientThreadId:s,messages:x.messages,isCompletionInProgress:w&&i,isFeedbackEnabled:r,onRequestMoreCompletions:p,prevGroupedMessageType:q,prevGroupedMessages:Z},"multitext-"+(((N=x.messages[0])==null?void 0:N.nodeId)??v)):x.type}case E.Browsing:case E.RetrievalBrowsing:{const D=T!=null&&[we.GizmoInteraction,we.GizmoMagicCreate,we.GizmoTest].includes(T.kind);return a.jsx(Em,{messages:x.messages,isRequestActive:u,isLastMessageInTurn:w,isUsingGizmo:D,isRetrieval:x.type===E.RetrievalBrowsing},"browsing-"+(((P=x.messages[0])==null?void 0:P.nodeId)??v))}case E.SearchGPTQuery:{const D=e[v+1];return a.jsx(vm,{isRequestActive:u,isLastMessage:w,nextMessage:D&&D.type===E.Text?D.message:void 0},"searchquery-"+(((F=x.messages[0])==null?void 0:F.nodeId)??v))}case E.a8km123:return a.jsx(Sm,{messages:x.messages,isStreaming:w&&i,clientThreadId:s},"sum-"+(((R=x.messages[0])==null?void 0:R.nodeId)??v));case E.Jawbone:{const D=v+1<e.length?e[v+1]:void 0;return a.jsx(km,{nextMessage:D&&D.type===E.Debug?D.message:void 0,isLastMessage:w,isRequestActive:u},"jawbone-"+(((X=x.messages[0])==null?void 0:X.nodeId)??v))}case E.ParallelBrowsing:return a.jsx(Rm,{messages:x.messages},"parallel-"+(((H=x.messages[0])==null?void 0:H.nodeId)??v));case E.CodeInterpreter:return a.jsx(pm,{messages:x.messages,isRequestActive:u,clientThreadId:s},"ada-"+(((G=x.messages[0])==null?void 0:G.nodeId)??v));case E.JITPlugin:return a.jsx(Pm,{messages:x.messages,clientThreadId:s,isLastTurnInConversation:l,onRequestCompletion:f},"jit-"+(((ee=x.messages[0])==null?void 0:ee.nodeId)??v));case E.GizmoContacts:return a.jsx(Nm,{messages:x.messages,clientThreadId:s,isLastTurnInConversation:l,onRequestCompletion:f},"gizmo-contacts-"+(((te=x.messages[0])==null?void 0:te.nodeId)??v));case E.Dalle:return a.jsx(Mm,{messages:x.messages,clientThreadId:s},"dalle-"+(((K=x.messages[0])==null?void 0:K.nodeId)??v));case E.GizmoEditor:return a.jsx(Cm,{messages:x.messages},"gizmo-editor-"+((($=x.messages[0])==null?void 0:$.nodeId)??v));case E.Canmore:return a.jsx(wm,{clientThreadId:s,messages:x.messages,isRequestActive:u},"canmore-"+(((C=x.messages[0])==null?void 0:C.nodeId)??v));case E.Debug:return M?a.jsx(Im,{message:x.message},"debug-"+x.message.nodeId):null;case E.SearchResult:return a.jsx(Am,{messages:x.messages},"search-result-"+(((b=x.messages[0])==null?void 0:b.nodeId)??v))}});return a.jsx(Fm,{shouldGrowContainer:I,children:j})}function Dm(){return a.jsx(bc,{type:"danger",children:a.jsx(z,{id:"daIg0P",defaultMessage:"Unable to display this message due to a error."})})}function Fm({children:t,shouldGrowContainer:e}){return a.jsx("div",{className:U({"flex max-w-full flex-col":!0,"flex-grow":e}),children:a.jsx(ki,{name:"GroupedMessages",fallback:Dm,children:t})})}function Qn(t,e){t.updateNodeMetadata(e.id,{completionSampleFinishTime:Date.now()})}class Om{constructor(e,s,n,o,i,r,l,c,u,h,g,m){B(this,"currentTree");B(this,"currentNodeId");B(this,"firstResponse",!0);B(this,"didCreateFirstCompletionInNewThread",!1);B(this,"activeBranchLastMessage");B(this,"messagesToUpdate",{});B(this,"allIncompleteStreamedMessages",{});B(this,"responseThreadId");B(this,"isCompletionBlocked",!1);B(this,"isEitherFlagged",!1);B(this,"variantsInStreamInfo");B(this,"activeBranchNodeId");B(this,"blurDuringCompletionTracker",new wc);B(this,"completionLatencyTracker");B(this,"turnTracker");B(this,"debouncedUpdateCompletion",kc(()=>{this.isCompletionBlocked||k.updateTree(this.clientThreadId,e=>{Object.values(this.messagesToUpdate).forEach(s=>{e.updateNodeMessage(s.id,s)})}),this.messagesToUpdate={}},50,{leading:!0,maxWait:50}));B(this,"handleResponse",async e=>{if(this.turnTracker.onUpdateEventCount(),this.completionLatencyTracker.onResponse(e,this.activeBranchLastMessage,this.responseThreadId),this.responseThreadId===void 0&&"conversationId"in e){const s=e.conversationId;this.responseThreadId=s,Wa(this.clientThreadId)&&k.getServerThreadId(this.clientThreadId)!==s&&(k.setServerIdForNewThread(this.clientThreadId,s),O.logEvent(A.attributeClientThreadToServerThread,{client_thread_id:this.clientThreadId,server_thread_id:s}))}switch(e.type){case"error":this.handleError(e);break;case"num_variants_in_stream":this.bindVariantInfoToTree(e);break;case"moderation":this.handleModeration(e);break;case"url_moderation":this.handleUrlModeration(e);break;case"message":this.handleMessage(e),this.debouncedUpdateCompletion();break;case"done":this.handleDone();break;case"gizmo_inline_review":this.handleGizmoInlineReview(e);break;case"title_generation":this.handleTitleGeneration(e);break;case"conversation_detail_metadata":this.handleConversationDetailMetadata(e);break}});this.queryClient=e,this.clientThreadId=s,this.targetNodeId=n,this.completionType=o,this.model=i,this.eventSource=r,this.navigate=l,this.callModelAgain=u,this.onCompletionFinished=h,this.isHistoryAndTrainingDisabled=m,this.currentTree=k.getTree(s),this.currentNodeId=n,this.activeBranchLastMessage=this.currentTree.getMessage(this.currentNodeId),this.completionLatencyTracker=new Sc(c),this.turnTracker=g,this.turnTracker.onCompletionStarted(o,this.model)}handleError(e){const s=e.error,n=(s==null?void 0:s.message)||"Something went wrong",o=s instanceof Ge&&s.code||"",i=s instanceof Ge&&s.status,r=s instanceof Ge?s.canRetry:void 0;switch(this.turnTracker.handleRawError(n,i),k.updateTree(this.clientThreadId,l=>{l.updateNodeMessage(this.currentNodeId,this.activeBranchLastMessage),l.updateNodeMetadata(this.currentNodeId,{err:n,errType:"danger",errCode:o,completionSampleFinishTime:Date.now(),canRetry:r})}),o){case _t.ContentPolicy:case _t.ContentOrTos:case Ss:case Ci:break;default:n!==void 0&&He.logEvent("chatgpt_conversation_error_web",n)}this.blurDuringCompletionTracker.onMessageError(),this.cleanUp(),this.onCompletionFinished(this.responseThreadId),s instanceof Ge&&(s==null?void 0:s.code)===Ss&&(s!=null&&s.clearsIn)&&(Cc(new Date(Date.now()+s.clearsIn*1e3).toISOString()),setTimeout(()=>{Ic()},s.clearsIn*1e3))}handleGizmoInlineReview(e){k.setPromptGptRating(this.clientThreadId,e.gizmoId)}handleTitleGeneration(e){k.setTitle(this.clientThreadId,e.title,Ha.Generated)}handleConversationDetailMetadata(e){const{default_model_slug:s}=e;s&&k.setThreadModelId(this.clientThreadId,s),ps.updateDetails(e)}bindVariantInfoToTree(e){this.variantsInStreamInfo=e,k.updateTree(this.clientThreadId,s=>{const n=s.getParentPromptNode(this.currentNodeId);s.updateNodeMetadata(n.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}handleModeration(e){const{isCompletion:s,messageId:n,conversationId:o,flagged:i,blocked:r,disclaimers:l,metadata:c}=e,u=!!(l!=null&&l.length)&&s;(i||r||u)&&(this.isEitherFlagged=!0,r&&s&&(this.isCompletionBlocked=!0),k.updateTree(this.clientThreadId,h=>{const g=h.messageIdToNodeId(n);r&&h.clearNodeMessageParts(g),h.updateNodeMetadata(g,{...(u&&!!(l!=null&&l.length)&&Ii(l,r))??{},...i&&Ti,...r&&(c!=null&&c.model_incompatibility?ji:Mi),completionSampleFinishTime:Date.now()})}),O.logEvent(s?r?A.completionBlockedByModeration:A.completionFlaggedByModeration:r?A.promptBlockedByModeration:A.promptFlaggedByModeration,{threadId:o,id:n}))}handleUrlModeration(e){const{conversationId:s,url:n,isSafe:o}=e;o&&k.addThreadSafeUrl(s,n)}handleMessage(e){var i,r,l,c,u,h,g,m,_,p,f,I,M;let s=!0;const{message:n,conversationId:o}=e;if((n==null?void 0:n.author.role)===_e.Tool?this.turnTracker.onMessageUpdate((i=n.metadata)==null?void 0:i.model_slug,(r=n.metadata)==null?void 0:r.gizmo_id,n.author.name):this.turnTracker.onMessageUpdate((l=n.metadata)==null?void 0:l.model_slug,(c=n.metadata)==null?void 0:c.gizmo_id,void 0),this.firstResponse&&!this.currentTree.hasReceivedServerCompletion){if((n==null?void 0:n.author.role)===_e.System){const T=(u=n.metadata)!=null&&u.parent_id?this.currentTree.getNodeByIdOrMessageId(n.metadata.parent_id):void 0;if((T==null?void 0:T.message.author.role)!==_e.User){this.currentTree.appendSystemMessageToRoot(n);return}}else if((n==null?void 0:n.author.role)===_e.User)return;if(this.currentTree.hasNodeOrMessageId(n.id))return}if(this.firstResponse&&((h=n.metadata)!=null&&h.rebase_system_message)){k.updateTree(this.clientThreadId,T=>{var x;if(((x=n.metadata)==null?void 0:x.parent_id)==null)throw Error("Unexpected rebased system message without parent");const j=T.getNodeByIdOrMessageId(this.targetNodeId);T.deleteNode(this.targetNodeId),T.addNode(n.id,n,n.metadata.parent_id,n.author.role),T.addNode(j.id,j.message,n.id,j.message.author.role)});return}if(this.firstResponse){const T=((g=lt.getState().threads[this.clientThreadId])==null?void 0:g.continuingFromSharedConversationId)!=null;k.removeContinuingFromSharedConversationId(this.clientThreadId),this.firstResponse=!1,this.didCreateFirstCompletionInNewThread=!this.currentTree.hasReceivedServerCompletion||T,k.updateTree(this.clientThreadId,x=>{x.updateNodeMessage(this.currentNodeId,n)}),this.didCreateFirstCompletionInNewThread&&ks.onCreate(this.navigate,o,this.queryClient,this.isHistoryAndTrainingDisabled);const j={id:this.targetNodeId,threadId:o,completionType:this.completionType,eventSource:this.eventSource,model:this.model};if(this.completionType===Ke.Next){const x=lt.getState().threads[o],v=(m=x==null?void 0:x.conversationTurns)==null?void 0:m.length,w=(_=x==null?void 0:x.conversationTurns)==null?void 0:_.filter(P=>P.role==_e.User),N=w&&((p=w[w.length-1])==null?void 0:p.messages[0].message);if((N==null?void 0:N.content.content_type)==Jt.Text){const P=N.content.parts.join("").length,F=(w==null?void 0:w.length)??0;j.countConversationTurns=v,j.countUserSubmittedMessages=F,j.countLastUserPromptTextMessageLength=P}}O.logEvent(A.generateCompletion,j)}else if(this.completionType!==Ke.Continue){const T=this.currentTree.containsNodeOrMessageId(n.id),j=(f=n.metadata)==null?void 0:f.parent_id;if(T||(this.debouncedUpdateCompletion.flush(),k.updateTree(this.clientThreadId,x=>{if(j==null)throw new Error(`Received a message with no parentId: ${JSON.stringify(n)}`);x.addNode(n.id,n,j,_e.Assistant)})),j!=null&&j===this.activeBranchNodeId){const x=this.allIncompleteStreamedMessages[j];x!=null&&(k.updateTree(this.clientThreadId,v=>{Qn(v,x)}),delete this.allIncompleteStreamedMessages[j])}if(s=(((I=this.variantsInStreamInfo)==null?void 0:I.num_variants_in_stream)??1)===1||this.activeBranchNodeId==null||this.activeBranchNodeId===n.id||this.currentTree.isAncestorOfNode(this.activeBranchNodeId,n.id),s&&this.activeBranchNodeId!==n.id){this.activeBranchNodeId=n.id,this.currentNodeId=n.id;const x=k.getThreadCurrentLeafId(this.clientThreadId);this.currentTree.messageIdToNodeId(this.currentNodeId)!==this.currentTree.messageIdToNodeId(x)&&k.setThreadCurrentLeafId(this.clientThreadId,this.currentNodeId),j!=null&&k.updateTree(this.clientThreadId,v=>{const w=v.getParentPromptNode(n.id);v.updateNodeMetadata(w.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}}if((n==null?void 0:n.author.role)===_e.Tool&&(n==null?void 0:n.author.name)==="bio"){const T=(M=n.metadata)==null?void 0:M.gizmo_id;setTimeout(()=>{this.queryClient.invalidateQueries({queryKey:Tc(T)})},5e3)}s&&(this.activeBranchLastMessage=n),this.messagesToUpdate[n.id]=n,this.allIncompleteStreamedMessages[n.id]=n}async handleDone(){var e,s;if(this.turnTracker.logCompletion({type:ws.Success}),this.isCompletionBlocked||(this.debouncedUpdateCompletion.flush(),this.isEitherFlagged||(this.didCreateFirstCompletionInNewThread&&ks.onCreateFinished(this.queryClient,this.responseThreadId,this.isHistoryAndTrainingDisabled),this.onCompletionFinished(this.responseThreadId))),k.updateTree(this.clientThreadId,n=>{Object.values(this.allIncompleteStreamedMessages).forEach(o=>{Qn(n,o)})}),Ga.publish({kind:"createConversation",clientThreadId:this.clientThreadId}),this.blurDuringCompletionTracker.onMessageDone(),this.cleanUp(),((s=(e=this.activeBranchLastMessage)==null?void 0:e.metadata)==null?void 0:s.client_actions)!==void 0){const n=await jc(this.clientThreadId,this.activeBranchLastMessage);n.length>0&&this.callModelAgain(this.currentNodeId,n)}}cleanUp(){setTimeout(()=>{Ol(this.clientThreadId,fa.FINISHED),Gs.removeRequest(this.targetNodeId),k.releaseThread(this.clientThreadId)},0)}}const Lm=1e3*30,ms=xa.getTracer("completion"),fs=t=>(t==null?void 0:t.code)==="challenge_required";class hs extends Error{}function Bm(t,e,s,n){const o=async(i=null,r=!1)=>{var H,G,ee,te,K,$;await Mc();const l=new AbortController,c="threadId"in e?e.threadId:void 0,u="continueFromSharedConversationId"in e?e.continueFromSharedConversationId:void 0,h=Ri(),g={action:e.completionType,messages:e.messages.length>0?e.messages:void 0,conversation_id:c,continue_from_shared_conversation_id:c!=null?void 0:u,parent_message_id:e.parentMessageId,model:e.model,timezone_offset_min:new Date().getTimezoneOffset(),variant_purpose:(H=e.completionMetadata)==null?void 0:H.variantPurpose,suggestions:(G=e.completionMetadata)!=null&&G.suggestions?e.completionMetadata.suggestions.map(C=>wl(C)):void 0,history_and_training_disabled:e.historyDisabled,juice:(ee=e.completionMetadata)==null?void 0:ee.juice,conversation_mode:(te=e.completionMetadata)==null?void 0:te.conversationMode,force_paragen:e.forceParagen,force_paragen_model_slug:e.forceParagenModel,force_nulligen:e.forceNulligen,force_indepth_feedback:e.forceIndepthFeedback,force_rate_limit:e.forceRateLimit,reset_rate_limits:e.resetRateLimits,disable_system_content_toggling:e.disableSystemContentToggling,websocket_request_id:h,source:(K=e.completionMetadata)==null?void 0:K.source,system_hints:($=e.completionMetadata)==null?void 0:$.systemHints,force_use_sse:!Ct.isWebsocketConnected(),conversation_origin:e.conversationOrigin,force_use_search:e.forceUseSearch,client_contextual_info:e.contextualInfo},m=ea(await Xn(t));let _="https://chatgpt.com/backend-api";m&&(_="https://chatgpt.com/backend-anon");const p=`${_}/conversation`;let f=!0,I=!0;const M=m?vn.getUnauthHeaders().additionalHeaders:await vn.getAuthedHeaders(),T=Ei(e.chatReq,i??e.arkoseToken,e.turnstileToken,e.proofToken,null),j={...M,...Rc(),...T};let x,v,w;ms.startActiveSpan("completion.response",C=>{x=ms.startSpan("completion.first_response"),v=ms.startSpan("completion.first_token"),w=C});const N=xa.setSpan(bn.active(),w);function P(C){if(C.data==="[DONE]")l.abort(),w.end(),s({type:"done"}),jn();else if(C.event!=="ping")try{const b=JSON.parse(C.data);if(b.error){const D=new We(b.error);throw s({type:"error",error:D}),D}else"type"in b?b.type==="gizmo_inline_review"?s({type:"gizmo_inline_review",gizmoId:b.gizmo_id}):b.type==="title_generation"?s({type:"title_generation",title:b.title,conversation_id:b.conversation_id}):b.type==="moderation"?s({type:"moderation",conversationId:b.conversation_id,messageId:b.message_id,isCompletion:b.is_completion,flagged:b.moderation_response.flagged,blocked:b.moderation_response.blocked,disclaimers:b.moderation_response.disclaimers,metadata:b.moderation_response.metadata}):b.type==="url_moderation"?s({type:"url_moderation",conversationId:b.conversation_id,messageId:b.message_id,url:b.url_moderation_result.full_url,isSafe:b.url_moderation_result.is_safe}):b.type==="num_variants_in_stream"?s({type:"num_variants_in_stream",num_variants_in_stream:b.num_variants_in_stream,display_treatment:b.display_treatment}):b.type==="conversation_detail_metadata"&&s(b):(s({type:"message",message:b.message,conversationId:b.conversation_id}),I&&(I=!1,x.end()),f&&b.message.author.role==="assistant"&&b.message.content.content_type==="text"&&b.message.content.parts[0]!==""&&(f=!1,v.end()))}catch(b){if(b instanceof Ge)throw new We(b.message)}}let F=null,R=setTimeout(()=>{F===!0?(O.logEvent(A.asyncResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:ws.Error,error:{reason:"timeout",message:"Async Response Took Too Long to Come Back"}})):F===!1&&(O.logEvent(A.sseResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:ws.Error,error:{reason:"timeout",message:"SSE Response Took Too Long to Come Back"}}))},Lm);return Ql(h,P,l.signal),bn.with(N,()=>Ec(p,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...j},body:JSON.stringify(g),signal:l.signal,openWhenHidden:!0,async onopen(C){var q;const b=C.headers.get("content-type")??"",D=C.headers.get("Cf-Ray")??null;if(C.ok&&b.includes("text/event-stream")){F=!1,n(D,e.model,e.turnTracker);return}else if(b.includes("application/json")){const Z=await C.json(),{webSocketUrl:V,fallbackWebSocketUrl:xe,conversationId:ue,responseId:ie,expiresAt:ve,websocketRequestId:Ne}=Yl(Z);if(V!=null&&ue!=null&&ie!=null&&Ne!=null&&ve){F=!0,n(D,e.model,e.turnTracker);try{await Xl(V,xe,ve,ue,ie,Ne,P,l.signal,R)}catch(y){y instanceof We&&s({type:"error",error:y})}throw new hs}else{const y=(Z==null?void 0:Z.error)??(Z==null?void 0:Z.detail),se=(y==null?void 0:y.message)??y??"Unknown server error";if(y){if(fs(y))throw new Ge(se,C.status,y.code);if(C.status>=500)throw new We(se);{if(((y==null?void 0:y.code)==="expired_session_key"||(y==null?void 0:y.code)==="invalid_api_key"||(y==null?void 0:y.code)==="token_expired")&&typeof window<"u"&&((q=window._oaiHandleSessionExpired)==null||q.call(window,"stream",JSON.stringify(y))),(y==null?void 0:y.code)==="deactivated_workspace"){window.location.href.includes("/workspace/deactivated")||(window.location.href="/workspace/deactivated");return}const he=y==null?void 0:y.can_retry;throw new Ge(se,C.status,y==null?void 0:y.code,y==null?void 0:y.type,void 0,y==null?void 0:y.clears_in,he)}}}}throw new We(Sn)},onmessage:C=>{if(F)throw new We(Sn);R&&(clearTimeout(R),R=null),P(C)},onerror(C){let b=C instanceof Error?C:new Error(JSON.stringify(C));throw b instanceof hs||F||fs(b)&&!r||(b.message==="Failed to fetch"&&(b=new We(`An error occurred. Either the engine you requested does not exist or there was another issue processing your request. ${gs}`)),b.message==="network error"&&(b=new Ge(`A network error occurred. Please check your connection and try again. ${gs}`,400)),Ai("fetch-error:conversation:new-message",{url:p,message:b==null?void 0:b.message}),s({type:"error",error:b}),jn(b)),b}})).catch(async C=>{if(fs(C)){if(r)throw new Ge("Failed to complete your call, please try again",C.status);{const b=await Vt.getEnforcementToken(e.chatReq);return o(b,!0)}}C instanceof hs||(De.addError(C),e.turnTracker.handleRawError(C.message??"Something went wrong",C.status))}),l};return o()}function Sf(t,e,s){const n=ga(),{resolvedTheme:o}=Es(),i=o==="dark",r=ca(),l=d.useRef(s),c=ha();l.current=s;const u=d.useCallback(async function({model:h,completionType:g,parentNodeId:m,metadata:_,focusOnNewCompletion:p=!0,completionMetadata:f,chatReq:I,arkoseToken:M,turnstileToken:T,proofToken:j,preflightTime:x,extraStreamParams:v,appendMessages:w,updateTree:N,turnTracker:P}){var ue,ie,ve,Ne,y,se,he;Ga.publish({kind:"requestCompletion"});const F=k.getTree(t);k.retainThread(t);const R=qc(),X=`${Ni}${t}-${R}`,H=`${t}-${R}`;N==null||N();const G=F.getNodeByIdOrMessageId(m),te={gizmo_id:(ue=G.message.metadata)==null?void 0:ue.gizmo_id};(f==null?void 0:f.juice)!=null&&(te.snorkle_status=1),k.updateTree(t,J=>{J.addNode(X,"",m,_e.Assistant,void 0,te)}),p&&k.setThreadCurrentLeafId(t,X);let K,$=[],C=F.getNodeByIdOrMessageId(G.parentId);for(;C!=null&&(((ie=C.metadata)==null?void 0:ie.isPlaceholderTemplateAssistantWelcomeMessage)===!0||((ve=C.metadata)==null?void 0:ve.isClientCreatedSystemMessage)===!0);){const J=C.message;$.unshift(J);const re=F.getNodeByIdOrMessageId(C.parentId);K=((Ne=re.message)==null?void 0:Ne.id)??re.id,C=re}if(g===Ke.Next||g===Ke.Variant){const J=F.getNodeByIdOrMessageId(G.parentId);if(K??(K=((y=J.message)==null?void 0:y.id)??J.id),$.push(G.message),w){let re=m;k.updateTree(t,je=>{for(const Y of w)je.insertNodeBefore(X,{id:Y.id,message:Y,parentId:re,children:[]}),re=Y.id}),$.push(...w)}$=zm($,v)}else K??(K=G.message.id);const b=k.getServerThreadId(t);b===void 0&&Wa(t)&&k.updateInitialThreadDataForNewThread(t,h);async function D(J,re){const je=performance.now(),Y=await ma();Vt.initializeAndGatherData(Y),bs.initializeAndGatherData(Y),ys.initializeAndGatherData(Y),k.updateTree(t,ce=>{for(const Pe of re)ce.addNode(Pe.id,Pe,J,_e.Assistant,{completionSampleFinishTime:Date.now()}),J=Pe.id}),k.setThreadCurrentLeafId(t,J);const Me=await Vt.getEnforcementToken(Y),L=await bs.getEnforcementToken(Y),ye=await ys.getEnforcementToken(Y);u({model:h,completionType:Ke.Next,parentNodeId:J,metadata:{},chatReq:Y,arkoseToken:Me??null,turnstileToken:L??null,proofToken:ye??null,preflightTime:performance.now()-je,extraStreamParams:v,turnTracker:P})}P.updateAttachmentCount($);const q=new Om(n,t,X,g,h,_.eventSource,r,H,D,(...J)=>l.current(...J),P,c),Z=(J,re,je)=>{J&&je.onReceivedRequestId(J),Ac(H,re,J,x)},V={is_dark_mode:i,time_since_loaded:Math.floor(performance.now()/1e3),page_height:window==null?void 0:window.innerHeight,page_width:window==null?void 0:window.innerWidth,pixel_ratio:window==null?void 0:window.devicePixelRatio,screen_height:(se=window==null?void 0:window.screen)==null?void 0:se.height,screen_width:(he=window==null?void 0:window.screen)==null?void 0:he.width},xe=await Bm(n,{conversationOrigin:k.getConversationOrigin(t),model:h,completionType:g,threadId:b,continueFromSharedConversationId:e,historyDisabled:c,parentMessageId:K,messages:$,chatReq:I,arkoseToken:M??null,turnstileToken:T??null,proofToken:j??null,completionMetadata:f,...v,turnTracker:P,contextualInfo:V},q.handleResponse,Z);Gs.addRequest(X,xe,P),ho.onCompletionRequestStarted(X)},[t,n,r,e,c,i]);return u}const zm=(t,e)=>{let s=t;return(e==null?void 0:e.forceUseSearch)===!1&&t.length>0&&(s=t.map(n=>{const{system_hints:o,...i}=n.metadata||{};return{...n,metadata:{...i,system_hints:o==null?void 0:o.filter(r=>r!==it.Search)}}})),s};export{lo as A,bf as C,gf as F,yf as G,Bu as P,pf as T,en as a,Ie as b,uf as c,rf as d,Dd as e,df as f,io as g,lf as h,sm as i,fo as j,Zu as k,Ks as l,_f as m,sd as n,xf as o,cf as p,zd as q,mf as r,ff as s,hf as t,Sf as u,Fu as v,vf as w,ed as x,Bd as y,Ct as z};
//# sourceMappingURL=gcuqrnunbiet9qgw.js.map
