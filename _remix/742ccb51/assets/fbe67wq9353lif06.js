const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/g7epg7f10livwb2u.js","assets/hzfabz2o8ombe5jw.js","assets/e50u68bunhmm6ifm.js","assets/root-vof5cayc.css","assets/jpqsqnjtzaisfhgh.js","assets/fk2on43rkvczq1b9.js","assets/conversation-small-eplmind9.css","assets/l20xuoh86vt5ltp3.js","assets/jyem616os9v6pvci.js","assets/cx9iqieff3d5lozo.js","assets/fn9vn6zf2cy4gvb8.js","assets/dd6uhnn1vl27vlhq.js","assets/im28ivob0v4ras8n.js","assets/jrcn5pgxy87monl2.js","assets/jtn6511x7p3193oe.js","assets/bs8ni352v8p5x5z5.js"])))=>i.map(i=>d[i]);
import{j as e,r as d,O as k,c8 as V,a7 as z,bt as I,cN as R,c as oe,cz as Q,bz as le,cm as X,c2 as Y,H as Z,aM as ee,I as F,K as ie,N as ce,f2 as f,cK as P,f3 as de,E as se,bP as ue}from"./hzfabz2o8ombe5jw.js";import{x as me,T as p,y as xe}from"./iing67ocwnwqhcj6.js";import"./irzndtt8vp8asixn.js";import{ek as B,el as q,am as b,c7 as ge,B as be,n as te,W as C,U as fe,ai as he,aj as pe,ak as G,al as J,p as ve,em as je,en as ae}from"./fk2on43rkvczq1b9.js";import"./f9zbh5kr0w936l1j.js";import{c as ye}from"./d2bzhwoj671nm961.js";import{S as Se,c as Ce}from"./frmfbpruf1qisqhy.js";import{C as we}from"./m2sizihdyfg2gu3v.js";import{C as Ne}from"./jpqsqnjtzaisfhgh.js";import{aa as ke,az as ne,a1 as _e,P as De}from"./e50u68bunhmm6ifm.js";import{u as Me}from"./9zpogk6h5akl73bx.js";import"./hq883kjug2canm9r.js";import"./hpzh4a2s0lujy0x2.js";import"./jyem616os9v6pvci.js";import"./ljqk1ti0cdzpv7jp.js";function Te({children:s,sidebarOpen:n,onClose:l}){return e.jsx(B.Root,{show:n,as:d.Fragment,children:e.jsxs(q,{as:"div",className:"relative z-10",onClose:l,children:[e.jsx("div",{className:"fixed inset-0"}),e.jsx("div",{className:"fixed inset-0 overflow-hidden",children:e.jsx("div",{className:"absolute inset-0 overflow-hidden",children:e.jsx("div",{className:"pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-10",children:e.jsx(B.Child,{as:d.Fragment,enter:"transform transition ease-in-out duration-100 sm:duration-300",enterFrom:"translate-x-full",enterTo:"translate-x-0",leave:"transform transition ease-in-out duration-300 sm:duration-500",leaveFrom:"translate-x-0",leaveTo:"translate-x-full",children:e.jsx(q.Panel,{className:"pointer-events-auto w-screen max-w-md border-l border-gray-100 dark:border-gray-700",children:e.jsx("div",{className:"h-full overflow-y-auto bg-token-main-surface-primary shadow-xl",children:s})})})})})})]})})}function Fe({clientThreadId:s}){const{rebaseSystemMessageContent:n,showDebugConversationTurns:l}=b(),[a,r]=d.useState(()=>n?JSON.stringify(n,null,2):void 0),[o,c]=d.useState(!!n),t=me(s,p.getThreadCurrentLeafId(s)),i=ge(t,x=>x.content.content_type===V.SystemContent),u=(i==null?void 0:i.content)??null,v=()=>{r(u?JSON.stringify(u,null,2):"")},g=d.useMemo(()=>be(x=>{try{x?b.setState({rebaseSystemMessageContent:{...JSON.parse(x),content_type:V.SystemContent}}):b.setState({rebaseSystemMessageContent:null}),z.closeAll()}catch{z.danger("The System Message is not valid JSON")}},500),[]);return d.useEffect(()=>{o?g(a):(g.cancel(),b.setState({rebaseSystemMessageContent:null}))},[g,o,a]),e.jsxs("div",{className:"flex flex-col gap-3 px-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(te,{label:"Enable to apply this system message to the current conversation.",children:e.jsx(C,{id:"enabled",label:"Enabled",checked:o,onChange:x=>c(x.currentTarget.checked)})}),e.jsx(C,{id:"show-internal-conversation-turns",label:"Conversation debug mode",checked:l,onChange:()=>{b.setState({showDebugConversationTurns:!l})}})]}),e.jsx(I,{disabled:!u,className:"mt-2",onClick:v,size:"small",children:"Load active system message"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm",children:"System Message"}),e.jsx(Pe,{disabled:!o,placeholder:u?"Press `Load active system message` to pre-populate this":"Start a conversation and then press `Load active system message` to pre-populate this",className:"min-h-[75vh] rounded-md border border-gray-400 p-1 font-mono",value:a,onChange:x=>r(x.target.value)})]})]})}const Pe=k.textarea`w-full rounded-lg border border-token-border-light bg-token-main-surface-primary text-sm text-token-text-primary focus:border-token-text-primary focus:shadow-none focus:outline-none focus:ring-token-text-primary disabled:bg-token-main-surface-tertiary`;function Re({clientThreadId:s}){const[n,l]=d.useState([]),a=p.getThreadCurrentLeafId(s),r=p.getThreadConversationTurns(s,a),o=t=>{const u=p.getTree(s).getLeafFromNode(t);p.setThreadCurrentLeafId(s,u.id)},c=t=>{l(i=>[...i,a]),o(t)};return e.jsxs(e.Fragment,{children:[n.length>0&&e.jsxs(I,{className:"absolute left-2 top-2",color:"secondary",onClick:()=>{const t=n[n.length-1];o(t),l(i=>i.slice(0,-1))},children:[e.jsx(ke,{className:"icon-sm"}),"Go back to ",n[n.length-1]]}),e.jsx("div",{className:"flex flex-col items-center gap-4 overflow-auto p-4 text-xs",children:r.map((t,i)=>{const u=t.messages[0].nodeId,v=p.getTree(s),g=i!==0?v.getParent(u):null,x=g!=null?g.children.findIndex(m=>u===m):0,j=g!=null?g.children:[],y=j.slice(0,x),S=j.slice(x+1);let h;switch(t.role){case R.User:h="bg-blue-500";break;case R.Assistant:h="bg-gray-600";break;default:h="bg-gray-400";break}return e.jsxs("div",{className:oe("relative p-2",h),children:[e.jsx("div",{className:"absolute bottom-0 left-0 -ml-2 flex -translate-x-full gap-2 pl-2",children:y.map(m=>e.jsx(K,{variantId:m,onChangeItemInView:c},m))}),e.jsx("div",{className:"absolute left-full top-0 ml-2 flex gap-2 pr-2",children:S.map(m=>e.jsx(K,{variantId:m,onChangeItemInView:c},m))}),e.jsx("div",{className:"flex flex-col gap-2",children:t.messages.map(m=>e.jsxs("div",{className:"h-14 w-32 truncate bg-gray-200 p-1 text-black",children:[e.jsx("div",{className:"font-semibold",children:m.nodeId}),e.jsx("div",{className:"italic text-token-text-tertiary",children:m.message.author.role}),e.jsx("div",{children:Q(m.message)})]},m.nodeId))})]},i)})})]})}function K({variantId:s,onChangeItemInView:n}){return e.jsx("button",{className:"w-32 truncate bg-gray-400 p-2 text-black opacity-50 hover:opacity-100",onClick:()=>{n(s)},children:e.jsx("span",{className:"bg-gray-200 p-2",children:s})},s)}const Ie=X(()=>Y(()=>import("./g7epg7f10livwb2u.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14])).then(s=>s.DebugModalContents),{ssr:!1}),Le=X(()=>Y(()=>import("./bs8ni352v8p5x5z5.js"),__vite__mapDeps([15,1,2,3,5,6])).then(s=>s.FramesViewer),{ssr:!1});function ls(){return e.jsx("button",{"data-testid":"open-debug-sidebar-button",className:"flex h-6 w-6 items-center justify-center rounded-full border border-token-border-light text-xs text-token-text-secondary",onClick:()=>{fe.setActiveSidebar("debug")},children:e.jsx(ne,{className:"icon-xs"})})}function Ae({children:s,title:n,icon:l,isOpen:a,slideOver:r,onClose:o}){const c=e.jsxs(Be,{children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 text-lg font-semibold text-gray-900 dark:text-white",children:[e.jsx(l,{className:"icon-sm"}),n]}),e.jsx("div",{className:"mr-2 mt-2 flex h-7 items-center",children:e.jsx(le,{onClick:o})})]}),s]});return r?e.jsx(Te,{sidebarOpen:a,onClose:o,children:c}):a?c:null}function Ee({nodes:s,setDebugNodeIndex:n,setFrameSrc:l,conversationId:a}){const r=s.map((o,c)=>{var U;const t=o.message,{role:i,name:u}=t.author,v=u&&u!==i,g=f(t,"metadata.__internal.model_id"),x=f(t,"metadata.__internal.agent.settings.completion_api.engine"),j=f(t,"metadata.__internal.model_experiment_name"),y=f(t,"metadata.__internal.model_experiment_treatment"),S=f(t,"metadata.__internal.normalized_model_side"),h=f(t,"metadata.__internal.alternative_model_selection_rule"),m=f(t,"metadata.__internal.model_experiment_group_name"),w=f(t,"metadata.__internal.model_experiment_group_params"),_=f(t,"metadata.__internal.model_experiment_override"),A=f(t,"metadata.__internal.model_experiment_eval_seq"),D=(U=f(t,"metadata.__internal.raw_tokens"))==null?void 0:U.length,E=f(t,"metadata.request_id"),O=P.getAudio(t),$=P.getAudioAssetPointers(t),re=P.getFrameAssetPointers(t);return e.jsxs(Ge,{role:"button",onClick:()=>n(c),children:[e.jsxs("div",{className:"text-xs font-semibold uppercase text-token-text-tertiary",children:[i,v&&` (${u})`,t.recipient&&" -> ",de(t)]}),(t.author.role!==R.System||E)&&e.jsxs("div",{className:"text-xs text-token-text-tertiary",children:[e.jsxs("div",{children:["ID: ",t.id]}),o.id!==t.id&&e.jsxs("div",{children:["UI Node ID: ",o.id]}),e.jsxs("div",{children:["Req ID: ",E||"Reload page to see ID"]})]}),e.jsx("div",{className:"line-clamp-6",children:Q(t)}),(D||g||x||j||y||S||h||m||w||_||A)&&e.jsxs("div",{className:"mt-4 w-full self-start rounded-xl bg-blue-200 px-3 py-0.5 text-xs text-black",children:[D!==void 0&&e.jsxs("div",{children:[e.jsx("b",{children:"Tokens Count:"})," ",D]}),g&&e.jsxs("div",{children:[e.jsx("b",{children:"Model ID:"})," ",g]}),x&&e.jsxs("div",{children:[e.jsx("b",{children:"Engine:"})," ",x]}),j&&e.jsxs("div",{children:[e.jsx("b",{children:"Experiment:"})," ",j]}),y&&e.jsxs("div",{children:[e.jsx("b",{children:"Treatment:"})," ",y]}),S&&e.jsxs("div",{children:[e.jsx("b",{children:"Normalized Side:"})," ",S]}),h&&e.jsxs("div",{children:[e.jsx("b",{children:"Alternative Model Rule:"})," ",h]}),m&&e.jsxs("div",{children:[e.jsx("b",{children:"Group Name:"})," ",m]}),w&&e.jsxs("div",{children:[e.jsx("b",{children:"Group Params:"}),e.jsx("div",{children:JSON.stringify(w,null,2)})]}),_&&e.jsxs("div",{children:[e.jsx("b",{children:"Above Params are Overridden By:"})," ",_]}),A&&e.jsxs("div",{children:[e.jsx("b",{children:"Experiment Eval Seq:"})," click to see"]})]}),O.length||$.length?e.jsxs("div",{className:"mt-4 flex flex-col flex-nowrap gap-2",children:[e.jsx(ze,{frameAssets:re,setFrameSrc:l},c),O.map((M,T)=>e.jsx(N,{audio:M,conversationId:a},T)),$.map((M,T)=>e.jsx(N,{assetPointer:M,conversationId:a},T))]}):null]},t.id)});return e.jsx(qe,{children:r})}const H=s=>e.jsx(Ce.Input,{...s,inputClassName:"focus:ring-0"});function Oe(){const s=b(),l=Me().map(a=>({label:a.name,options:a.options.map(r=>({label:`${r.value} (${r.name})`,value:r.value}))}));return e.jsxs("div",{className:"mt-2 flex flex-col justify-around gap-3 px-4 py-1 text-xs font-semibold",children:[e.jsx(C,{id:"force-paragen",label:"Force Parallel Gen",checked:s.forceParagen,onChange:()=>{b.setState({forceParagen:!s.forceParagen})}}),e.jsx(we,{options:l,name:"force-paragen-model",className:"shadow-none dark:text-gray-800",isDisabled:!s.forceParagen,isLoading:l.length===0,value:s.forceParagenModel,isClearable:!0,isMulti:!1,components:{Input:H},onChange:a=>{b.setState({forceParagenModel:a??je})}}),e.jsx(C,{id:"force-paragen",label:"Force Nulligen",checked:s.forceNulligen,onChange:()=>{b.setState({forceNulligen:!s.forceNulligen})}}),e.jsx("div",{id:"force-use-search-label",children:"Force Use Search:"}),e.jsx(Se,{id:"force-use-search",options:[{label:"Default",value:"default"},{label:"Force",value:"true"},{label:"Disable",value:"false"}],name:"force-use-search",className:"shadow-none dark:text-gray-800",value:s.forceUseSearch==null?{value:"default",label:"Default"}:s.forceUseSearch?{value:"true",label:"Force"}:{value:"false",label:"Disable"},isMulti:!1,components:{Input:H},onChange:a=>{b.setState({forceUseSearch:((a==null?void 0:a.value)??"default")==="default"?null:(a==null?void 0:a.value)==="true"})}}),e.jsx(C,{id:"force-indepth-feedback",label:"Force Indepth Feedback with prompt:",checked:s.forceIndepthFeedback,onChange:()=>{b.setState({forceIndepthFeedback:!s.forceIndepthFeedback})}}),e.jsx(ye,{id:"force-indepth-feedback-prompt",value:s.forceIndepthFeedbackPrompt,disabled:!s.forceIndepthFeedback,className:"font-weight-normal font-mono text-xs",onChange:a=>{b.setState({forceIndepthFeedbackPrompt:a.target.value})}}),e.jsx(C,{id:"force-rate-limit",label:"Force Rate Limit",checked:s.forceRateLimit,onChange:()=>{b.setState({forceRateLimit:!s.forceRateLimit})}}),e.jsx(C,{id:"reset-rate-limit",label:"Reset Rate Limits",checked:s.resetRateLimits,onChange:()=>{b.setState({resetRateLimits:!s.resetRateLimits})}}),e.jsx(te,{label:"Enabling this will show debug conversation messages in the chat",children:e.jsx(C,{id:"show-internal-conversation-turns",label:"Conversation debug mode",checked:s.showDebugConversationTurns,onChange:()=>{b.setState({showDebugConversationTurns:!s.showDebugConversationTurns})}})})]})}const W=k.div`px-3 pb-2 text-xs font-semibold uppercase border-b-2 ${({$isSelected:s})=>s?"border-black dark:border-white":"border-transparent"}`;function is({clientThreadId:s,isOpen:n,slideOver:l,onClose:a}){const r=Z(),o=ee(),[c,t]=d.useState("conversation");return o!=null&&o.includes("debug")?e.jsx(Ae,{icon:ne,title:r.formatMessage(L.debugTitle),isOpen:n,slideOver:l,onClose:a,children:e.jsxs(he,{orientation:"vertical",defaultValue:c,onValueChange:i=>t(i),children:[e.jsxs(pe,{className:"flex items-center justify-center gap-2 px-4 py-1 text-xs font-semibold",children:[e.jsx(G,{value:"conversation",children:e.jsx(W,{$isSelected:c==="conversation",children:"Conversation"})}),e.jsx(G,{value:"system-message-editor",className:"p-4",children:e.jsx(W,{$isSelected:c==="system-message-editor",children:"System Message Editor"})})]}),e.jsx(J,{value:"conversation",children:e.jsx($e,{clientThreadId:s})}),e.jsx(J,{value:"system-message-editor",children:e.jsx(Fe,{clientThreadId:s})})]})}):null}function $e({clientThreadId:s}){var y,S,h,m;const n=Z(),l=p.getThreadCurrentLeafId(s),a=xe(s,l),[r,o]=d.useState(),c=ee(),t=d.useCallback(()=>{o(void 0)},[]),i=d.useCallback(()=>{const w=p.getTree(s);ve(w.getTextFromThread(l))},[l,s]),[u,v]=d.useState(!1),[g,x]=d.useState(void 0);return c!=null&&c.includes("debug")?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-2 flex items-center justify-around px-4 py-1 text-xs font-semibold uppercase",children:e.jsx(Ve,{clientThreadId:s,messages:a.map(w=>w.message)})}),!1,e.jsxs("div",{className:"flex items-center justify-around gap-2 px-4 py-1 text-xs font-semibold uppercase",children:[e.jsx("div",{children:e.jsx(Ne,{onCopy:i,buttonText:n.formatMessage(L.copyText)})}),e.jsxs("button",{className:"flex items-center justify-center gap-2",onClick:()=>v(!0),children:[e.jsx(_e,{className:"icon-sm rotate-90"}),"View tree"]})]}),e.jsx(Oe,{}),e.jsx(Ee,{nodes:a,setDebugNodeIndex:o,setFrameSrc:x,conversationId:p.getServerThreadId(s)}),r!==void 0&&e.jsx(F,{type:"success",size:"fullscreen",noPadding:!0,isOpen:!0,onClose:t,children:e.jsx(Ie,{threadId:(S=(y=a[r].message.metadata)==null?void 0:y.__internal)==null?void 0:S.sonic_thread_id,threadUserId:(m=(h=a[r].message.metadata)==null?void 0:h.__internal)==null?void 0:m.sonic_user_id,onClose:t,message:a[r].message})},`DebugMessageModal-${r}`),u&&e.jsx(F,{isOpen:!0,onClose:()=>v(!1),type:"success",size:"custom",noPadding:!0,children:e.jsx(Re,{clientThreadId:s})},"DebugTreeViewer"),g&&e.jsx(F,{size:"normal",isOpen:!0,onClose:()=>x(void 0),type:"success",children:e.jsx("img",{src:g,alt:"debug image"})},"DebugFrameViewer")]}):null}function Ue(s,n){const l=JSON.stringify({conversation_id:p.getServerThreadId(s),messages:n},null,2),a=new Blob([l],{type:"application/json"}),r=URL.createObjectURL(a),o=document.createElement("a");o.href=r,o.download=`messages-${p.getServerThreadId(s)}.json`,o.click(),URL.revokeObjectURL(r)}function Ve({clientThreadId:s,messages:n}){const l=d.useCallback(()=>{Ue(s,n)},[s,n]);return e.jsx(I,{onClick:l,color:"primary",size:"small",icon:De,children:e.jsx(ie,{...L.downloadRawConversation})})}function ze(s){const[n,l]=d.useState([]),a=se(),{frameAssets:r}=s;return d.useEffect(()=>{async function o(){const c=r.map(async({image_asset_pointer:t,timestamp:i})=>{const u={asset:t};return{src:(await ae.fetch(a,u)).url,timestamp:i}});return Promise.all(c)}r.length>0&&o().then(l)},[r,a]),e.jsx(Le,{frames:n,setFrameSrc:s.setFrameSrc})}function N(s){const n=N.useAssetPointerSource(s.assetPointer,s.conversationId),l=N.useAudioSource(s.audio),a=n??l,o=ue("3230069703").config.value.expirySeconds,[c,t]=d.useState(Date.now()),i=d.useRef(null);return d.useEffect(()=>{const u=setInterval(()=>{i.current&&i.current.currentTime>0&&!i.current.paused&&!i.current.ended&&i.current.readyState>2||t(Date.now())},o*1e3);return()=>clearInterval(u)},[o]),a?e.jsx("audio",{ref:i,controls:!0,src:a,className:"w-full"},c):null}N.useAssetPointerSource=(s,n)=>{const[l,a]=d.useState(null),r=se();return d.useEffect(()=>{s&&ae.fetch(r,{asset:s,conversationId:n}).then(o=>{a(o.url)})},[r,s,n]),l};N.useAudioSource=s=>{const[n,l]=d.useState(null);return d.useEffect(()=>{if(s){const a=atob(s.payload),r=new Uint8Array(a.length);for(let t=0;t<a.length;t++)r[t]=a.charCodeAt(t);const o=new Blob([r],{type:`audio/${s.format}`}),c=URL.createObjectURL(o);return l(c),()=>{URL.revokeObjectURL(c)}}},[s]),n};const Be=k.div`overflow-y-auto h-full md:w-[250px] lg:w-[300px] xl:w-[350px] 2xl:w-[400px] md:border-l md:border-gray-100 md:dark:border-gray-700 popover bg-token-main-surface-primary`,qe=k.pre`whitespace-pre-wrap text-sm`,Ge=k.div`px-6 py-4 flex flex-col gap-1 hover:bg-gray-50 dark:hover:bg-gray-500/10 cursor-pointer border-b dark:border-white/10 border-gray-200`,L=ce({debugTitle:{id:"DebugSidebar.debugTitle",defaultMessage:"Debug"},copyText:{id:"DebugSidebar.copyText",defaultMessage:"Copy text"},downloadRawConversation:{id:"DebugSidebar.downloadRawConversation",defaultMessage:"Download raw conversation"},uploadRawConversation:{id:"DebugSidebar.uploadRawConversation",defaultMessage:"Upload conversation dump"},closeSidebar:{id:"DebugSidebar.closeSidebar",defaultMessage:"Close sidebar"}});export{$e as DebugConversation,is as DebugConversationSidebar,ls as OpenDebugSidebarButton,Ae as default,Ue as downloadMessages};
//# sourceMappingURL=fbe67wq9353lif06.js.map
