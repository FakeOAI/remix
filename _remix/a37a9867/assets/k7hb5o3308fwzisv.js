const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/o4mxqethlawcesjf.js","assets/mmal6p4kl22zfrfg.js","assets/esia9ah6q4vsupvt.js","assets/root-lzc0gvpq.css","assets/x9i51t0kn9u6rqnk.js","assets/i8crxwujeo3n60om.js","assets/conversation-small-cll5buey.css","assets/n6hph5et3w5xvb01.js","assets/pbffjd4sant9qggz.js","assets/g1390g40b3sagq0y.js","assets/b8qrfl4dn6046u9u.js","assets/ieq6yz5y5r1pdcic.js","assets/di7pi9i09i1gca8g.js","assets/dk4zocp2lhr21b9t.js","assets/jbk4c1t5ws64ay8r.js","assets/dsn2osneeha2irha.js","assets/is-scrollable-element-i34sjb0l.css","assets/bp4oeatmzfmly8bp.js","assets/f5g3yf6rejksa6rn.js","assets/iziiga9sc3emkx6a.js","assets/ewaqnxa4l26dslc9.js","assets/a44b3m5ml1mx5nn4.js","assets/meoz9lbdxu4dt41d.js","assets/lwk11n9qbjlycof7.js","assets/k88ys7sf9o5flgyw.js","assets/jyusxtzzgs4ihqfz.js","assets/lcjgntdwka0pcoze.js","assets/bmhn0o3is180q73k.js","assets/m8lgth2hdwftjzpg.js","assets/mw4mmmapv415l2ql.js","assets/otbog8ic1x0jilh3.js","assets/code-composer-ne11stli.css","assets/mu26cr1ciw2f2p0s.js","assets/idlwqe5bsqje5pjh.js","assets/gt4zg5qyxeamvoo9.js","assets/c2od6pp1aqjfcuj0.js","assets/h97dwdgw7tt66odt.js","assets/document-composer-ofhzvcxp.css","assets/c0sp2kx2jl0wnpqp.js","assets/d6ddmg1fz8o9f372.js","assets/d403smr834009uxr.js","assets/ADAVisualizationComponent-mi6em660.css","assets/sso-i9n8wk17y9r2hc8j.js","assets/ft3cxhhgdgc7cldr.js","assets/kgwdm996ods314k3.js","assets/nrppvsvvhm1h6kl2.js","assets/r1obzlba33qw6f45.js","assets/ifi6r8mtf48nwt39.js","assets/itghwucfyv5ciib7.js","assets/gtdh4y0tcknk3nss.js","assets/ih59ahwoy2u2enkb.js","assets/d3sdpomrz31j22wa.js","assets/983a0dy92b3ronpv.js","assets/x4zvbpdson10vdc1.js","assets/kqwdyvkaaavvn8k3.js","assets/mck4i86deuqt3e79.js","assets/f2f1x0gxzjyts534.js","assets/jfvrzt2lfsgos6e0.js","assets/nr8xnpwfgt2c8kb4.js","assets/e9lafxuzyeh4418f.js","assets/k10f86qjl2zau2o2.js","assets/mcabpsyr5i658ozc.js","assets/o690o1zkkh0iingt.js","assets/fbhbhap15n2ybrok.js","assets/m4txjtjm8m1s6uyu.js","assets/o6w9okc5vn9scj4w.js","assets/lmh6u4cd3xl9crhl.js","assets/fwdwa0kv6nwta6rw.js","assets/gs8o2bb6o56rsr7i.js","assets/dfvfjpcshyn3uqws.js","assets/fhhsgn4hg6gpu4zs.js","assets/c7msnf6gkmps7cem.js","assets/cpqdof8hy4kt10iy.js","assets/lwx6mlihgwy52536.js","assets/ctivjadtk92henja.js","assets/nwj1vq1qra0xgp2r.js","assets/iej0cupg2dqkmejt.js","assets/hduvd2yn1x9fcfil.js","assets/bsb95162x99e4fe7.js","assets/jk8w36bsokizpx57.js","assets/k4pvkri4w9ic2aso.js","assets/frjk0j2nmxpuhpdo.js","assets/d3y72ugnrmac5z1v.js"])))=>i.map(i=>d[i]);
import{y as o,a4 as oe,a9 as De,r as y,a0 as ye,as as Me,a1 as ot,ab as Ye,ac as He,f4 as $r,ae as R,az as is,fQ as cs,fR as qr,ah as Ee,S as ue,aA as Oe,c as Hr,$ as je,fq as zr,eB as ls,bB as us,bj as Ve,bn as Ke,u as cn,N as Fe,af as ds,P as O,d as U,fS as Vr,fT as Kr,bu as Xt,D as Ce,fr as Qr,fs as Yr,bA as Jr,fU as Xr,a6 as We,w as ln,eV as hs,fc as fs,n as ms,fV as Ot,bb as $e,bc as Zr,fz as eo,c6 as to,be as Je,L as no,j as ut,aW as Mt,al as un,bT as so,bR as ro,aw as wt,eh as ps,bH as gs,bf as xs,bz as Ut,bt as oo,aB as ao,ch as dn,x as io,e6 as hn,e7 as ys,at as _s,R as Ie,fW as co,ax as ve,fX as Zt,M as Tn,eu as st,dL as vs,ed as ws,fY as en,bI as lo,fZ as bs,v as uo,h as Mn,f_ as ho,f$ as jn,g0 as Rn,g1 as fo,g2 as mo,C as po,dM as go,bk as xo,bl as An,bm as Nn,ak as fn,dT as yo,a$ as _o,f9 as vo,dI as wo,fb as bo,f2 as Co,aZ as bt,bG as So,fi as Io}from"./mmal6p4kl22zfrfg.js";import{iQ as Eo,bE as ko,lg as To,lh as Mo,iJ as jo,li as Ro,bR as dt,iR as Cs,iP as Ao,lj as No,lk as Bn,g7 as Bo,g6 as Fo,kl as Do,dO as Po,k6 as Oo,k7 as Ss,ks as Uo,iS as Fn,Z as Lo,e5 as Is,ll as Go,j3 as Wo,fZ as $o,lm as qo,ln as Ho,lo as zo,lp as Vo,lq as Ko,f$ as Es,j4 as ks,fT as Qo,lr as Yo,ht as mn,hv as Jo,hu as Ts,hC as pn,hQ as Be,ls as ze,iV as Xo,lt as Zo,lu as tn,lv as ea,lw as ta,de as Dn,lx as gn,ab as jt,ly as na,lz as Ms,lA as js,lB as sa,dB as ra,d5 as oa,as as aa,aq as ia,dc as ca,dd as la,lC as ua,lD as da,lE as ha,lF as fa,dT as Rs,l8 as ma,fU as nn,lG as pa,lH as ga,lI as xa,lJ as ya,lK as _a,lL as va,lM as wa,iG as ba,iC as Lt,lN as Gt,lO as Ca,lP as Sa,iA as Ia,lQ as Ea,hL as ka,iI as Ta,lR as Ma,iF as ja,hG as Wt,bC as Ra,lS as Aa,L as Na,df as As,iv as Ns,a2 as Ba,lT as Bs,lU as Fa,lV as pt,lW as Da,lX as Fs,lY as $t,lZ as Pa,l_ as Oa,a$ as qe,l$ as Ua,m0 as La,m1 as Ga,aD as pe,m2 as Ds,aw as Pn,ax as Xe,ay as Rt,aI as Wa,b7 as $a,b8 as qa,aL as Ha,aM as Ps,aN as Ct,aO as Ze,a_ as za,b9 as me,m3 as xe,ba as Va,aP as Ka,aQ as Qa,aR as Ya,aT as Os,aS as Ja,aA as Xa,aX as Za,aY as ei,b0 as ti,b1 as ni,m4 as si,m5 as ri,m6 as oi,m7 as ai,b3 as On,m8 as Us,b4 as ii,aZ as ci,b6 as li,m9 as ui,ma as di,mb as hi,mc as Ls,md as fi,me as mi,mf as qt,mg as pi,ff as gi,bS as ht,r as xn,u as At,c as xi,i9 as yn,cN as Gs,c2 as Un,q as Ws,ak as yi,bs as _i,mh as vi,be as $s,o as qs,mi as wi,mj as Hs,a as zs,e as bi,C as sn,T as Ci,mk as Si,bn as Ii,ml as Ei,mm as ki,d as Ti,mn as Mi,mo as ji,mp as Ri,mq as Ai,mr as Ni,ms as Bi,cJ as Fi,mt as St,b$ as Vs,mu as Di,eS as _n,mv as vn,mw as Pi,mx as Oi,my as Ui,mz as fe,mA as Li,mB as _t,mC as gt,mD as Gi,mE as Ks,fq as he,mF as Wi,mG as $i,mH as et,mI as qi,mJ as Ln,mK as Hi,mL as zi,cs as Vi,cb as Gn,fn as Ki,mM as Qi,z as Yi,mN as Ji,mO as Xi,mP as Zi,mQ as ec,mR as tc,A as nc,mS as sc,mT as rc,cm as oc,cV as ac,fL as ic,aj as cc,n as lc,mU as Wn,c0 as $n}from"./i8crxwujeo3n60om.js";import{R as uc,b as dc,f as Nt,bT as hc,d as fc,a6 as mc,bZ as Qs,a4 as Ys,aH as pc,a0 as gc,r as xc,K as yc,ab as _c,q as vc,aU as Js,bm as Xs,bs as Zs,b_ as er,J as wc,a8 as tr,bg as bc,a7 as nr,bh as Cc,X as Sc,bn as Ic,b4 as Ec,aC as kc,W as sr,a_ as Ht}from"./esia9ah6q4vsupvt.js";import{D as re,B as Tc}from"./f5g3yf6rejksa6rn.js";import{d as rr,e as or,r as ar,s as ir,T as Mc}from"./iziiga9sc3emkx6a.js";import{u as jc}from"./k88ys7sf9o5flgyw.js";import{U as be,G as Qe,u as Rc,c as cr,a as lr}from"./jyusxtzzgs4ihqfz.js";import{u as ur,K as dr,W as hr,N as fr,J as mr,b as pr,X as Ac,t as qn,G as Nc,f as Bc,Y as Fc,E as Dc}from"./meoz9lbdxu4dt41d.js";import{l as wn,b as It,T as j,M as Pc,i as Bt,c as Et,v as gr,N as Oc,O as Uc,P as Lc,Q as Gc,k as xr,m as Wc,d as $c}from"./a44b3m5ml1mx5nn4.js";import{B as qc,T as Hc,I as zc}from"./bmhn0o3is180q73k.js";import{P as kt}from"./m8lgth2hdwftjzpg.js";import{m as Tt}from"./pbffjd4sant9qggz.js";import{b as Hn}from"./lwk11n9qbjlycof7.js";import{i as Vc}from"./mw4mmmapv415l2ql.js";import{u as Kc}from"./otbog8ic1x0jilh3.js";function Qc({className:t,zIndexKey:e,onClick:s}){return o.jsx(Tt.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:oe("absolute inset-0",t,Eo[e]),onClick:s})}function Yc({zIndexKey:t,onClick:e}){return o.jsx(Qc,{zIndexKey:t,onClick:e,className:"bg-gray-50/50 dark:bg-black/50"})}const Jc=({onScroll:t})=>(To(({scrollTop:e})=>{t?.(e)}),null),Xc=({shouldScrollToTop:t})=>{const e=Mo();return y.useEffect(()=>{t===!0&&e({behavior:"smooth"})},[t,e]),null},Zc=()=>{const t=jo();y.useEffect(()=>{t({behavior:"smooth"})},[t]);const[e]=Ro();return e?null:o.jsx("button",{onClick:()=>t({behavior:"smooth"}),className:"absolute bottom-5 right-1/2 z-10 flex h-8 w-8 translate-x-1/2 cursor-pointer items-center justify-center rounded-full border border-token-border-light bg-token-main-surface-primary bg-clip-padding text-token-text-secondary",children:o.jsx(uc,{className:"icon-md text-token-text-primary"})})},el=De.section`w-full h-full flex flex-col popover bg-token-main-surface-primary`,tl=({children:t,onScroll:e,shouldScrollToTop:s,scrollToBottomMode:a="top",isLoading:i=!1},l)=>o.jsxs("main",{className:"relative flex min-h-0 flex-auto flex-grow flex-col",ref:l,children:[o.jsx(ko,{children:i&&o.jsx(Yc,{zIndexKey:"textdocDiffLoadingOverlay"})}),o.jsxs(qc,{followButtonClassName:"hidden",initialScrollBehavior:"auto",className:"h-full",mode:a,children:[t,a==="bottom"&&o.jsx(Zc,{}),o.jsx(Jc,{onScroll:e}),o.jsx(Xc,{shouldScrollToTop:s})]})]}),nl=y.forwardRef(tl),sl=De.header`flex items-center justify-between p-3 h-14`,rl=De.h2`ml-2.5 text-base text-lg text-gray-700 dark:text-token-text-secondary truncate`,ol=({onClick:t})=>{const e=ye();return o.jsx(Me,{label:e.formatMessage(al.close),children:o.jsx(dt,{icon:dc,onClick:t})})},rt=({children:t})=>o.jsx(el,{children:t});rt.Title=rl;rt.CloseButton=ol;rt.Header=sl;rt.Content=nl;const al=ot({close:{id:"Bix/Kd",defaultMessage:"Close"}}),il=Ye(()=>He(()=>import("./o4mxqethlawcesjf.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31])).then(t=>t.CodeComposer),{loading:()=>o.jsx("div",{className:Cs.code,children:o.jsx("div",{className:"h-full w-full px-4",children:o.jsx(kt,{lines:20})})})}),cl=t=>o.jsx(il,{...t}),yr=()=>{const[{width:t},e]=Ao(),s=t>=Bn+Bo?Bn:Fo;return o.jsx("div",{className:oe(Cs.document,"mt-4"),ref:e,style:{margin:`0 ${No}px`},children:o.jsx("div",{style:{width:s},children:o.jsx(kt,{lines:20})})})},ll=Ye(()=>He(()=>import("./mu26cr1ciw2f2p0s.js"),__vite__mapDeps([32,1,2,3,11,5,6,10,4,7,8,12,13,14,15,16,33,21,34,35,36,18,19,20,22,23,24,25,26,27,28,29,30,37])).then(t=>t.DocumentComposer),{loading:yr}),ul=t=>o.jsx(ll,{...t}),dl=({onScroll:t,textdocId:e})=>{const s=Do(e),{windowWidth:a}=$r(p=>p,{windowWidth:0,windowHeight:0});if(!s)return null;const{versions:i}=s,l=Po(i),h=Oo(l);let u=null;switch(l?.type){case Is.DOCUMENT:u=o.jsx(ul,{value:l.content,comments:[],isRequestActive:h,isPreview:!0,isDisabled:!0,hideAccelerators:!0,commentsMode:Fn.ALL_HIDDEN,hideToolbar:!0,hideEditOverlay:!0,width:a,modelCursor:l.modelCursor});break;default:l&&Ss(l.type)&&(u=o.jsx(cl,{id:"codemirror",currentlyStreamingLineIndex:null,language:Uo(l.type),value:l.content,commentsMode:Fn.ALL_HIDDEN,hideToolbar:!0,hideAccelerators:!0,comments:[],readonlyReason:Lo.Streaming,isRequestActive:h}))}return o.jsx(rt,{children:o.jsx(rt.Content,{onScroll:t,children:u})})},hl=y.memo(dl);function fl(t,e){switch(t){case"presentation":return o.jsx(Ko,{});case"table":return o.jsx(Vo,{});case"chart":return o.jsx(zo,{});case Is.DOCUMENT:return o.jsx(Nt,{className:oe("icon-md",{"text-token-text-primary":e,"text-token-text-tertiary":!e})});default:return Ss(t)?o.jsx(qo,{className:oe("icon-md",{"text-token-text-primary":e,"text-token-text-tertiary":!e})}):o.jsx(Ho,{})}}const ml=({isHovered:t=!1})=>{const e=ye();return o.jsx(Me,{label:e.formatMessage({id:"KMbgyZ",defaultMessage:"Open in canvas"}),children:o.jsx(Tt.div,{role:"button",animate:{opacity:t?1:.64},whileHover:{opacity:1},transition:{type:"tween",duration:.18},className:"text-token-text-secondary transition-colors",children:o.jsx(hc,{className:"icon-md"})})})},pl=({isCanvasOpen:t,isFocused:e,isHovered:s,isInlinePreview:a,size:i})=>t?e?"0px 2px 6px 0px rgba(0, 0, 0, 0.06)":"0px 2px 6px 0px rgba(0, 0, 0, 0)":a?s||e?`0px ${i==="large"?12:4}px ${i==="large"?32:10}px 0px rgba(0, 0, 0, 0.064)`:`0px ${i==="large"?6:4}px ${i==="large"?14:4}px 0px rgba(0, 0, 0, 0.04)`:"0px 2px 6px 0px rgba(0, 0, 0, 0)",gl=({textdocId:t,isInlinePreview:e=!1,isStreaming:s=!1,isDisabled:a=!1,isFocused:i=!1,isCanvasOpen:l=!1,marginBottom:h,size:u="large",onClick:p,children:g,name:v,type:w})=>{const f=y.useRef(null),[x,b]=y.useState(!1),[S]=y.useState(()=>Go(100,180,!1)),{resolvedTheme:E}=is(),B=E==="dark",D=w?o.jsx("span",{className:oe("flex-shrink-0 transition-[filter]",{grayscale:!i&&!x}),children:fl(w,i&&l)}):o.jsx("div",{className:"flex h-6 w-6 flex-shrink-0 items-center overflow-hidden",children:o.jsx(kt,{lines:1,size:"base",width:100,widthVariance:0})}),I=v?o.jsx("span",{className:"min-w-0 truncate",children:v}):o.jsx("div",{className:"flex h-5 flex-grow items-center overflow-hidden",style:{width:S},children:o.jsx(kt,{lines:1,size:"base",width:100,widthVariance:0})}),T=s&&o.jsx(Wo,{size:20,className:oe("flex-shrink-0",i?"text-blue-selection":"text-token-text-secondary")}),A=()=>{!f.current||a||(Es.logButtonClick(ks.MESSAGE_ATTACHMENT,{type:w}),Qo(f.current),p?.())},F=u==="large"?100:50,L=`${B?"rgba(0,0,0,0)":"rgba(255,255,255,0)"}, ${B?"#2f2f2f":"#ffffff"}`;return o.jsxs(Tt.div,{role:"button",id:$o(t),initial:{opacity:s?0:1,scale:s?.9:1},animate:{opacity:1,scale:1},transition:{type:"spring",bounce:0,duration:.72},className:oe("popover relative flex select-none flex-col overflow-hidden border bg-token-main-surface-primary transition-shadow duration-500",a?"cursor-default":"cursor-pointer",{"border-token-text-tertiary font-medium dark:border-gray-600":i&&l,"font-regular":!i,"border-token-border-light":!x&&!i,"border-token-border-medium":x&&!i,"flex min-w-0 max-w-full flex-shrink flex-grow-0 items-center justify-between self-start rounded-xl":l||!e,"w-full rounded-2xl":!l&&e}),onMouseEnter:()=>!a&&b(!0),onMouseLeave:()=>b(!1),onClick:A,ref:f,style:{marginBottom:h,height:l||!e?void 0:u==="large"?"24rem":"10rem",width:u==="small"?"300px":void 0,boxShadow:pl({isCanvasOpen:l,isFocused:i,isHovered:x,isInlinePreview:e,size:u})},children:[o.jsxs("div",{className:oe("flex w-full min-w-0 items-center justify-between gap-2 self-start border-token-border-light px-4 transition-colors duration-700",{"border-token-border-light":!x&&!i,"border-token-border-medium":x&&!i,"text-sm font-medium text-token-text-primary":!l&&x&&e,"py-2":l||!e,"py-3":!l&&e,"text-sm font-medium text-token-text-secondary":!l&&!x&&e}),children:[o.jsxs("div",{className:oe("flex min-w-0 items-center",{"gap-2":l||!e,"gap-3.5":!l&&e}),children:[D,I]}),l?o.jsx(Tt.span,{animate:T?"show":"initial",variants:{initial:{opacity:0,paddingLeft:0,width:"0"},show:{opacity:1,paddingLeft:2,width:"24px"}},transition:{type:"tween",duration:.18},children:T}):e&&!a?o.jsx(ml,{isHovered:x}):null]}),o.jsxs("div",{className:"relative flex min-h-0 w-full flex-1 flex-col self-end",children:[!l&&g,e&&!l&&o.jsx("div",{className:"absolute bottom-0 z-20 h-24 w-full transition-colors",style:{height:F,background:`linear-gradient(${L})`}}),e&&u==="small"&&!l&&o.jsx("div",{className:"absolute bottom-0 right-0 top-0 z-20 transition-colors",style:{width:F,background:`linear-gradient(to right, ${L})`}})]})]})},xl=({type:t,name:e,isStreaming:s=!1,isFocused:a=!1,onClick:i,textdocId:l,isFetching:h=!1,isCanvasOpen:u=!1,isInlinePreview:p=!1,isMissingFromThread:g=!1})=>{const v=ye(),[w,f]=y.useState(!1),x=g,b=E=>{f(E>0)},S=u||!p?12:!u&&p?16:void 0;return o.jsx(gl,{name:g?o.jsx("span",{className:"min-w-0 truncate",children:v.formatMessage({id:"oZTAp8",defaultMessage:"Unknown title"})}):e,isFocused:a,isCanvasOpen:u,textdocId:l,type:t,isDisabled:x,isInlinePreview:p,isStreaming:s,onClick:i,marginBottom:S,children:p&&l&&o.jsx("div",{className:oe("relative flex min-h-0 flex-auto flex-col overflow-hidden border-t transition-colors",{"border-token-border-light":w,"border-transparent":!w}),children:g?o.jsx("div",{className:"m-auto text-token-text-secondary",children:o.jsx(R,{id:"DZUSSk",defaultMessage:"Canvas not found"})}):h?o.jsx(yr,{}):o.jsx(hl,{onScroll:b,textdocId:l})})})},yl=({textdocId:t})=>{const e=Yo(p=>p?.resolveTempTextdocId[t]??t),s=mn(e),a=Jo(e),i=Ts();if(!s)return null;const l=()=>{pn(e)},{title:h,type:u}=s;return o.jsx("div",{className:"flex w-full justify-end",children:o.jsx(xl,{textdocId:e,type:u,name:h,isFocused:a,isCanvasOpen:i,onClick:l,isInlinePreview:!0})})},_l=({messages:t})=>{const[e]=t,s=e?.message.metadata?.canvas;return!s||s.user_message_type!=null?null:o.jsx(o.Fragment,{children:s.pasted_textdocs?.map(({tempId:a})=>o.jsx(yl,{textdocId:a},a))})};function vl(t){return t.message.metadata?.safety_plugin_status_code===123}function wl(t){return t.message.metadata?.finish_details?.type==="content_filter"}function bn(t){if(t===void 0)return{flagSeverity:void 0,shouldHideContent:!1,errCode:void 0,errMessage:void 0};const{errType:e,errCode:s,err:a,disclaimers:i}=t,l=wl(t),h=l&&vl(t),u=i&&i.length>0;return h?{flagSeverity:"warning",shouldHideContent:!0,errCode:Be.ContentRegurgitation,errMessage:a}:!u&&l?{flagSeverity:"warning",shouldHideContent:!0,errCode:Be.ContentOrTos,errMessage:a}:{flagSeverity:e,shouldHideContent:e==="danger"&&(s===Be.ContentPolicy||s===Be.ModelIncompatibility),disclaimers:i,errCode:s,errMessage:a}}function bl({message:t,onRequestMoreCompletions:e,clientThreadId:s,id:a,isFeedbackEnabled:i,isUserTurn:l,className:h}){const{errCode:u,errMessage:p,flagSeverity:g}=bn(t);switch(u){case Be.ContentPolicy:return o.jsx(ze,{flag:g,isUserTurn:l,className:h,children:o.jsx(El,{isFeedbackEnabled:i})});case Be.ModelIncompatibility:return o.jsx(ze,{flag:g,isUserTurn:l,className:h,children:o.jsx(R,{...we.modelIncompatibilityMessage})});case Be.ContentOrTos:return o.jsx(ze,{flag:g,isUserTurn:l,className:h,children:o.jsx(Sl,{isFeedbackEnabled:i})});case Be.ContentRegurgitation:return o.jsx(ze,{flag:g,isUserTurn:l,className:h,children:o.jsx(Il,{})});case tn:return o.jsx(Cl,{className:h,id:a,onRequestMoreCompletions:e,flag:g,clientThreadId:s,isUserTurn:l});case cs:return o.jsx(ze,{flag:g,isUserTurn:l,className:h,children:o.jsx(R,{...we.historyDisabledConversationMissing})});default:return p!==void 0?o.jsx(ze,{flag:g,isUserTurn:l,className:h,children:o.jsx(Xo,{rehypePlugins:[[Zo,{target:"_new",rel:"noopener noreferrer"}]],className:"markdown prose w-full break-words dark:prose-invert",children:p})}):null}}function Cl({className:t,id:e,onRequestMoreCompletions:s,flag:a,clientThreadId:i,isUserTurn:l}){const h=ea(S=>S.isoDate),u=ta(h),p=wn(i??qr),g=p&&p.kind!==Ee.PrimaryAssistant,v=ur(),w=dr(),f=y.useCallback(()=>{ue.logEvent("chatgpt_regenerate_due_to_rate_limit_button_clicked",void 0,{useDefaultModel:"false",...Hn({clientThreadId:i})});const S=new Dn;s(e,{eventSource:"mouse"},S,!0,"none",!1)},[e,s,i]),x=y.useCallback(()=>{const S=new Dn,E=w.id;ue.logEvent("chatgpt_regenerate_due_to_rate_limit_button_clicked",void 0,{useDefaultModel:"true",...Hn({clientThreadId:i})}),v({modelId:E,location:"Model switcher menu item"}),s(e,{eventSource:"mouse"},S,!0,"none",!0)},[s,e,w.id,v,i]);let b;return g?b=h!=null?o.jsx("span",{children:o.jsx(R,{...we.gptUsageCapExceededCustomFeature,values:{link:zn,formattedTime:u}})}):o.jsx(R,{...we.gptUsageCapExceededExpired}):b=h!=null?o.jsx("span",{children:o.jsx(R,{...we.gptUsageCapExceeded,values:{link:zn,formattedTime:u}})}):o.jsx(R,{...we.gptUsageCapExceededExpired}),o.jsx(ze,{flag:h!=null?a:void 0,isUserTurn:l,className:t,children:o.jsxs("div",{className:"flex items-center gap-6",children:[b,h==null&&o.jsx(Oe,{color:"secondary",className:"flex-shrink-0",onClick:f,children:o.jsx(R,{...we.buttonTryAgain})}),h!=null&&!g&&o.jsx(Oe,{color:"secondary",className:"flex-shrink-0",onClick:x,children:o.jsx(R,{...we.buttonUseDefaultModel})})]})})}const zn=t=>o.jsx("a",{href:"https://share.hsforms.com/16d0ZZVM3QZirXnCD_q7u1Q4sk30",target:"_blank",rel:"noreferrer",className:"underline",children:t});function Sl({isFeedbackEnabled:t}){return o.jsxs(o.Fragment,{children:[o.jsx("div",{className:t?"font-semibold":"",children:o.jsx(R,{...we.contentOrTosViolationNoFeedback,values:{contentPolicyLink:_r,termsLink:kl}})}),o.jsx("div",{children:t&&o.jsx(R,{...we.contentPolicyFeedback})})]})}function Il(){return o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"font-semibold",children:o.jsx(R,{...we.contentRegurgitationViolation})}),o.jsx("div",{children:o.jsx(R,{...we.readModelSpec,values:{modelSpecLink:Tl}})})]})}function El({isFeedbackEnabled:t}){return o.jsxs(o.Fragment,{children:[o.jsx("div",{className:t?"font-semibold":"",children:o.jsx(R,{...we.contentPolicyViolationNoFeedback,values:{contentPolicyLink:_r}})}),o.jsx("div",{children:t&&o.jsx(R,{...we.contentPolicyFeedback})})]})}const _r=t=>o.jsx(gn,{target:"_blank",href:"https://openai.com/policies/usage-policies",rel:"noreferrer",children:t}),kl=t=>o.jsx(gn,{target:"_blank",href:"https://openai.com/policies/terms-of-use",rel:"noreferrer",children:t}),Tl=t=>o.jsx(gn,{target:"_blank",href:"https://cdn.openai.com/spec/model-spec-2024-05-08.html",rel:"noreferrer",children:t}),we=ot({contentPolicyFeedback:{id:"TextMessageDisplay.contentPolicyFeedback",defaultMessage:"Did we get it wrong? Please tell us by giving this response a thumbs down."},contentPolicyViolation:{id:"TextMessageDisplay.contentPolicyViolation.2",defaultMessage:"This content may violate our <contentPolicyLink>usage policies</contentPolicyLink>. Did we get it wrong? Please tell us by giving this response a thumbs down."},contentPolicyViolationNoFeedback:{id:"TextMessageDisplay.contentPolicyViolationNoFeedback",defaultMessage:"This content may violate our <contentPolicyLink>usage policies</contentPolicyLink>."},modelIncompatibilityMessage:{id:"cyOWhN",defaultMessage:"Your request was flagged as potentially violating our usage policy. Please try again with a different prompt."},contentOrTosViolation:{id:"TextMessageDisplay.contentOrTosViolation.2",defaultMessage:"This content may violate our <termsLink>Terms of Use</termsLink> or <contentPolicyLink>usage policies</contentPolicyLink>. Did we get it wrong? Please tell us by giving this response a thumbs down."},contentOrTosViolationNoFeedback:{id:"TextMessageDisplay.contentOrTosViolationNoFeedback",defaultMessage:"This content may violate our <termsLink>Terms of Use</termsLink> or <contentPolicyLink>usage policies</contentPolicyLink>."},contentRegurgitationViolation:{id:"kAMQnd",defaultMessage:"ChatGPT isn't designed to provide this type of content."},readModelSpec:{id:"fQ0JYv",defaultMessage:"Read the <modelSpecLink>Model Spec</modelSpecLink> for more on how ChatGPT handles creators' content."},historyDisabledConversationMissing:{id:"TextMessageDisplay.historyDisabledConversationMissing",defaultMessage:"Sorry, conversations created when Chat History is off expire after 6 hours of inactivity. Please start a new conversation to continue using ChatGPT."},somethingWentWrong:{id:"TextMessageDisplay.somethingWentWrong",defaultMessage:"Something went wrong."},gptUsageCapExceeded:{id:"TextMessageDisplay.gptUsageCapExceeded",defaultMessage:"You've reached the current usage cap for GPT-4. You can continue with the default model now, or try again {formattedTime}. <link>Learn more</link>"},gptUsageCapExceededCustomFeature:{id:"TextMessageDisplay.gptUsageCapExceededCustomFeature",defaultMessage:"You've reached the current usage cap for GPT-4, please try again {formattedTime}. <link>Learn more</link>"},gptUsageCapExceededExpired:{id:"TextMessageDisplay.gptUsageCapExceededExpired",defaultMessage:"You previously reached your usage cap for GPT-4, but you can now try sending your message again"},buttonUseDefaultModel:{id:"TextMessageDisplay.buttonUseDefaultModel",defaultMessage:"Use default model"},buttonTryAgain:{id:"TextMessageDisplay.buttonTryAgain",defaultMessage:"Try again"}});function vr(){return ls(us.DataAnalysisV2)}function kh(){const t=jt(),e=je();return e&&t&&!zr(t)&&e.isEnterprisey()}function Th(){return ls(us.ChartSerialization)}function Mh(t,e){const s=t==="chart"?Ve.HasSeenAdaInteractiveChart:Ve.HasSeenAdaInteractiveTable,[a,i]=y.useState(Ke.getItem(s,{userId:e})??!1),l=y.useCallback(()=>{i(!0),Ke.setItem(s,!0,{userId:e})},[s,e]);return[a,l]}function jh(t){const[e,s]=y.useState([]),a=It(()=>{const i=j.resolveThreadId(t),l=j.getThreadCurrentLeafId(t);return j.getTree(i).getBranchFromLeaf(l)});return y.useEffect(()=>{const i=wr(a);i.length!==e.length&&s(i)},[e.length,t,a]),e}function Ml(t){return It(()=>{const e=j.resolveThreadId(t),s=j.getThreadCurrentLeafId(t),i=j.getTree(e).getBranchFromLeaf(s);return wr(i).length>0})}function jl(t){const e=t.metadata?.aggregate_result?.messages.filter(Vc)??[];let s=0;const a=(t.metadata?.ada_visualizations??[]).map(l=>{let h=l;return l.type=="chart"&&(h={...l,fallback_image:e[s++]}),h}),i=(t.metadata?.attachments??[]).filter(l=>js(l.name)).map(l=>({type:"table",file_id:l.id??"",title:sa(l),file_name:l.name,context_connector_info:l.context_connector_info}));return[...a,...i]}function wr(t){return t.filter(s=>s.message?.author.role==="tool"&&s.message?.author.name==="python"||(s.message?.metadata?.attachments??[]).length>0).flatMap(s=>jl(s.message))}Hr(t=>({selectedSpreadsheet:null,setSelectedSpreadsheet:e=>t({selectedSpreadsheet:e})}));async function Rl(t,e,s){const a=await t.text(),{parse:i}=await He(async()=>{const{parse:h}=await import("./oeujip5i1ptrxie5.js");return{parse:h}},[]),l=i(a);return{content:{columnNames:l.shift(),columnTypes:l[0].map(()=>"string"),rows:l},file_name:e,download_url:s}}function Al(t){const e=t[0].values.length,s=[];for(let a=0;a<e;a++){const i=t.map(l=>l.values[a]);s.push(i)}return s}function Rh(t){return cn({queryKey:["ada-visualization","chart",t.file_id],queryFn:async()=>{const e=await Fe.getFileDownloadLink(t.file_id);if(e.status===ds.Success){const a=await(await fetch(e.download_url)).json();return{content:{chart_type:a.type,title:a.title,labels:a.labels,datasets:a.datasets,x_label:a.x_label,y_label:a.y_label},file_name:e.file_name??"",download_url:e.download_url}}else throw new Error("Failed to download chart json from interpreter")}})}function Ah(t){return cn({queryKey:["ada-visualization","table",t.file_id],queryFn:async()=>{if(t.file_name&&na(t.file_name)){const e=await Fe.getAdaExcelFileContents(t.file_id);return{content:e.sheets.map(s=>({name:s.name,columnNames:s.columns.map(a=>a.name),columnTypes:s.columns.map(()=>"string"),rows:Al(s.columns)})),download_url:e.download_url,file_name:t.file_name}}else{const e=await Fe.getFileDownloadLink(t.file_id);if(e.status===ds.Success){const s=await fetch(e.download_url);return Rl(s,e.file_name??"",e.download_url)}else throw new Error("Failed to download from interpreter")}}})}function Nl(t){const e=Ms(),s=Ml(t),a=vr();return s&&a&&!e.displayingSideBySideFeedback}const Bl=Ye(()=>He(()=>import("./c0sp2kx2jl0wnpqp.js").then(t=>t.A),__vite__mapDeps([38,1,2,3,5,6,8,21,26,29,39,40,18,41])).then(t=>t.default)),Fl=De.div`flex gap-2 flex-wrap mt-1 max-w-[80%] justify-end`,Dl=De.div`flex flex-col gap-2`,Pl=({parts:t,attachments:e,isUserTurn:s,clientThreadId:a})=>{const i=ra(),l=vr(),h=oa.getImageAssetPointersFromParts(t),u=new Set(h.map(x=>aa(x.asset_pointer))),g=ia()||i,v=(e??[]).filter(x=>js(x.name)),w=(e??[]).filter(x=>x.id==null||u.has(x.id)?!1:l?!v.includes(x):!0);return(l?(w.length>0||v.length>0)&&s:w.length>0&&s)?o.jsxs(o.Fragment,{children:[o.jsx(Fl,{children:w.map(x=>o.jsx(ca,{file:x.name,fileId:x.id,contextConnectorInfo:la(x.context_connector_info),width:i?"normal":"wide",alwaysShowData:!0},x.id))}),l&&o.jsx(Dl,{className:oe(!g&&"w-[80%]"),children:v.map(x=>o.jsx(Bl,{clientThreadId:a,visualization:ua(x)},x.id))})]}):null};function Nh(t){return da(t)&&!ha(t)}const xt=50,Ol=95;function Bh(t,e){if(t<=e)return t/e*xt;{const s=xt,a=Ol-xt,i=t-e,h=-(xt/e)/a;return s+a*(1-Math.exp(h*i))}}class Ul{mostRecentCompletionRequest;loggedRequests=new Set;onCompletionRequestStarted(e){this.mostRecentCompletionRequest={requestId:e,timestamp:Date.now()},this.loggedRequests.clear()}logEvent(e,s,a,i,l){const h=this.mostRecentCompletionRequest;if(h!=null&&!this.loggedRequests.has(e)){const p=j.getThreadConversationTurns(s,a).find(g=>g.messages.some(v=>v.message.id===a));p!=null&&p.messages.some(g=>g.nodeId===h.requestId)&&(O.logEvent(e,{messageId:a,timeMs:Date.now()-h.timestamp,...i}),l?.(),this.loggedRequests.add(e))}}}const rn=new Ul;function Ll(t){return(t.find(i=>i.message.metadata?.image_search_results!==void 0)?.message.metadata?.image_search_results??[]).slice(0,5)}function Gl({messages:t}){const e=Ll(t),s=fa();return e.length===0?null:o.jsx("div",{className:oe({"mb-2":!0,"grid grid-flow-col gap-3":e.length>1,"w-1/3":e.length===1}),children:e.filter(({contentUrl:a})=>s.has(a)).map((a,i)=>o.jsx("a",{href:a.hostPageUrl,target:"_blank",rel:"noreferrer",children:o.jsx("img",{src:a.contentUrl,alt:a.name,className:"aspect-square rounded-xl object-cover"})},i))})}function br({attachments:t,citations:e,contentReferences:s,className:a,clientThreadId:i,displayParts:l,isCompletionInProgress:h,id:u,isActivelyStreaming:p,isUserTurn:g,turnIndex:v,isFeedbackEnabled:w,messages:f,onRequestMoreCompletions:x,parts:b,prevGroupedMessageType:S,prevGroupedMessages:E,showEditButton:B,onEnterEdit:D,size:I="medium"}){const T=Rs(),A=f.length>1,{flagSeverity:F,shouldHideContent:L}=bn(A?void 0:f[0]),P=!b.some(H=>H!==""),G=f[0].message.metadata?.targeted_reply_label??f[0].message.metadata?.targeted_reply;return y.useEffect(()=>{const H=f[0].message;if(H.author.metadata?.real_author===`tool:${ma.SEARCHGPT}`&&!P){const z=H.metadata?.search_source;rn.logEvent(U.searchToolRequestTimeToFirstTextToken,i,H.id,{search_source:z},()=>{z===Vr.InstantQuery&&Kr.logEvent(U.searchToolPageLoadTimeToFirstTextToken,{message_id:H.id})})}},[i,P,f]),y.useEffect(()=>{if(!P)switch(S){case nn.Browsing:rn.logEvent(U.browsingTimeToFirstTextToken,i,f[0].message.id);break}},[P,f,i,S]),o.jsxs("div",{"data-message-author-role":f[0].message.author.role,"data-message-id":f[0].message.id,dir:"auto",className:oe(a,"text-message flex w-full flex-col items-end gap-2 whitespace-normal break-words [.text-message+&]:mt-5"),"data-message-model-slug":f[0].message.metadata?.model_slug,children:[G&&o.jsxs("div",{className:"mb-1 ml-6 mt-1 flex items-start gap-1.5 text-sm font-normal text-token-text-tertiary sm:ml-7 lg:ml-8",children:[o.jsx(fc,{className:"icon-md mt-1 shrink-0"}),o.jsx("p",{className:"mr-2 line-clamp-3",children:G})]}),g&&T&&o.jsx(_l,{messages:f}),o.jsx(pa,{messages:f}),o.jsx(Wl,{parts:b,attachments:t,isUserTurn:g,isCompletionInProgress:h,turnIndex:v,displayParts:l,isActivelyStreaming:p,shouldHideContent:L,showEditButton:B,onEnterEdit:D,clientThreadId:i,id:u,isEmpty:P,prevGroupedMessageType:S,prevGroupedMessages:E,flagSeverity:F,messages:f,citations:e,contentReferences:s,size:I}),o.jsx(bl,{message:A?void 0:f[0],id:u,isFeedbackEnabled:w,onRequestMoreCompletions:x,clientThreadId:i,isUserTurn:g}),o.jsx(ga,{isUserTurn:g,message:A?void 0:f[0]}),!g&&!p&&E&&S===nn.SearchResult&&o.jsx(Gl,{messages:E})]})}function Wl({clientThreadId:t,id:e,displayParts:s,isCompletionInProgress:a,turnIndex:i,isActivelyStreaming:l,shouldHideContent:h,showEditButton:u=!1,onEnterEdit:p,isEmpty:g,prevGroupedMessageType:v,prevGroupedMessages:w,messages:f,citations:x,contentReferences:b,size:S,isUserTurn:E,parts:B,attachments:D}){const I=ye(),T=y.useRef(!1),A=xa(s),[F,L]=y.useState({}),[P,G]=y.useState(!1),H=ya(),{streamingContext:z}=_a();y.useEffect(()=>{H&&(z.setOnStylesUpdatedCallback(L),z.onStreamingChanged(a),z.setOnResetCallback(()=>G(!1)),a&&(G(!0),L(z.createTopLevelStyles())))},[H,a,z]);const te=va(),W=f[0].message.metadata?.gizmo_id,V=f[0].message.metadata?.serialization_metadata,X=Pc(f[0].message).length,Q=y.useMemo(()=>({clientThreadId:t,messageId:e,turnIndex:i}),[t,e,i]),N=wa(f[0].message),Y=!!W&&te.includes(W),K=y.useCallback(()=>{be.toggleChatThreadFlyout(t,i,e)},[t,i,e]),ce=o.jsx(Pl,{parts:B,attachments:D,isUserTurn:E,clientThreadId:t},"files-and-tables"),M=!!(D?.length||s.some(q=>q.type==="images")),k=ba();function le(q,ee){const J=v===nn.CodeInterpreter?w?.map(Ae=>Ae.message):void 0,{text:ne,contentReferences:ke}=Sa(ee,x,b,Y);let de=ke;k&&(de=ke.filter(Ae=>Ae.type!=="attribution"));const{processedText:Pe,displayedContentReferences:Te}=Ia(ne,de,l?void 0:J,!1,l);Pe.includes(Ea)&&!T.current&&(T.current=!0,Ce.addError(new Error("Failed replaceTextWithDirectives"),{text:Pe,displayedContentReferences:Te}));const Se=f[0].message,ft=Se.metadata?.message_locale;let it=o.jsx(ka,{clientThreadId:t,messageId:e,isStreamingOrProcessing:P,size:S,className:oe(l&&!H&&"result-streaming",N&&"headers-v2"),children:Pe===""?"&#8203;":Pe});if(ft!=null){const Ae=Qr(ft,!1);Ae!=null&&(it=o.jsx(Yr,{locale:Ae,children:it}))}return o.jsx(Ta.Provider,{value:{analyticsMetadata:Q,message:Se,contentReferences:Te,onShowSearchResults:K,numImageResults:X,isActivelyStreaming:l,useSafeUrls:!0},children:it},q)}const ge=s.map((q,ee)=>{if(q.type==="transcription"){const J=h?null:q.text;let ne=null;if(E&&h)ne=o.jsx("span",{className:"italic opacity-30",children:o.jsx(R,{...yt.contentRemoved})});else if(E&&J!=null)ne=J.trim().length===0?o.jsx("span",{className:"italic opacity-30",children:o.jsx(Lt,{text:I.formatMessage(yt.transcriptUnavailable),customSymbolOffsets:void 0})}):o.jsx("span",{className:"italic opacity-65",children:o.jsx(Lt,{text:`“${J.trim()}”`,customSymbolOffsets:void 0})});else if(!E&&J!=null)return le(ee,J);return o.jsx(Gt,{containsImagesOrAttachments:M,isUserTurn:E,showEditButton:u,onEnterEdit:p,children:ne},ee)}else if(q.type==="text"){const J=h?null:q.text;return!g&&!h&&!E?le(ee,A):g&&l&&!E?H?o.jsx("div",{className:"pulsing-dot"},ee):o.jsx("div",{className:"result-streaming",children:o.jsx("span",{children:o.jsx("pre",{})})},ee):o.jsx(Gt,{containsImagesOrAttachments:M,isUserTurn:E,showEditButton:u,onEnterEdit:p,children:E&&h?o.jsx("span",{className:"italic opacity-30",children:o.jsx(R,{...yt.contentRemoved})}):J?o.jsx(Lt,{text:J,customSymbolOffsets:V?.custom_symbol_offsets}):null},ee)}else if(q.type==="images"){const J=f[0].message.metadata?.attachments??[];return o.jsx(Ca,{assets:q.imageAssets,attachments:J},ee)}else return null}),Re=s.findIndex(q=>q.type==="text");if(Re!==-1?ge.splice(Re,0,ce):ge.push(ce),h&&E)ge.length=0,ge.push(o.jsx(Gt,{containsImagesOrAttachments:M,isUserTurn:E,onEnterEdit:Xt,children:o.jsx("span",{className:"italic opacity-30",children:o.jsx(R,{...yt.contentRemoved})})}));else if(h&&!E)return null;return o.jsx("div",{className:oe("flex w-full flex-col gap-1 empty:hidden",E&&"items-end rtl:items-start",!E&&"first:pt-[3px]",P&&"streaming-response"),style:F,children:ge})}const yt=ot({contentRemoved:{id:"textMessage.contentRemoved",defaultMessage:"Content removed"},transcriptUnavailable:{id:"textMessage.transcriptUnavailable",defaultMessage:"Transcript Unavailable"}});function $l(t){const{isActivelyStreaming:e,...s}=t,a=Jr(),i=a?.includes("debug")??!1,l=t.messages[t.messages.length-1].message.id,[h,u]=y.useState([]),p=y.useRef(void 0);return p.current===void 0&&(p.current=a?.includes(Xr)??!1?new Ma(t.parts,u,e,void 0,{debug:i}):new ja(t.parts,u,e)),y.useEffect(()=>{p.current!=null&&(p.current.onMessagePartsUpdated(t.parts,e),p.current.isBuffering()&&Wt.addDelayedRenderingMessage(l))},[t.parts,l,e]),y.useEffect(()=>{p.current!=null&&!p.current.isBuffering()&&Wt.removeDelayedRenderingMessage(l)},[h,l]),y.useEffect(()=>()=>Wt.removeDelayedRenderingMessage(l),[l]),y.useEffect(()=>()=>{p.current!=null&&(p.current.destroy(),p.current=void 0)},[]),o.jsx(br,{...s,displayParts:h,isActivelyStreaming:e||p.current?.isBuffering()})}function ql({message:t,isCompletionInProgress:e,clientThreadId:s,className:a,isUserTurn:i,turnIndex:l,isFeedbackEnabled:h,prevGroupedMessageType:u,prevGroupedMessages:p,showEditButton:g,onEnterEdit:v,onRequestMoreCompletions:w}){const f=y.useMemo(()=>"parts"in t.message.content?t.message.content.parts:[Ra(t.message)],[t]);return o.jsx(Hl,{parts:f,messages:[t],isCompletionInProgress:e,className:a,citations:t.message.metadata?.citations,contentReferences:t.message.metadata?.content_references,attachments:t.message.metadata?.attachments,isUserTurn:i,turnIndex:l,id:t.nodeId,isFeedbackEnabled:h,onRequestMoreCompletions:w,clientThreadId:s,showEditButton:g,onEnterEdit:v,prevGroupedMessageType:u,prevGroupedMessages:p})}const Vn=We.memo(ql);function Hl(t){const e=t.messages.length>1,{flagSeverity:s}=bn(e?void 0:t.messages[0]),a=s!=="danger"&&t.isCompletionInProgress,i=!t.parts.some(h=>h!==""),[l]=y.useState(()=>!t.isUserTurn&&(t.isCompletionInProgress||i));return l?o.jsx($l,{...t,isActivelyStreaming:a}):o.jsx(br,{...t,displayParts:Aa({isUserTurn:t.isUserTurn,parts:t.parts}),isActivelyStreaming:a})}const Cr=Na.DesktopBrowserExtensionAnnouncement,zl=5,Sr="https://chromewebstore.google.com/detail/searchgpt/ejcfepkfckglbgocfkanmcdngdijcgld";function Fh({onClose:t}){y.useEffect(()=>{O.logEventWithStatsig(U.chatgptBrowserExtensionAnnouncementShown,"chatgpt_browser_extension_announcement_shown")},[]);const{markAsViewed:e}=As(Cr),s=y.useCallback(()=>{e(),O.logEventWithStatsig(U.chatgptBrowserExtensionAnnouncementClosed,"chatgpt_browser_extension_announcement_closed"),t&&t()},[e,t]),a=y.useCallback(()=>{O.logEventWithStatsig(U.chatgptBrowserExtensionAnnouncementCTAClicked,"chatgpt_browser_extension_announcement_cta_clicked"),e(),t&&t()},[e,t]);return o.jsx(Vl,{downloadUrl:Sr,handleCTAClicked:a,handleClose:s})}function Vl({downloadUrl:t,handleCTAClicked:e,handleClose:s}){const a=()=>{e(),window.open(t)},i=o.jsxs("div",{className:"flex-grow",children:[o.jsx("div",{className:"mb-0.5 font-semibold",children:o.jsx(R,{id:"uAZwaE",defaultMessage:"Use ChatGPT for every search"})}),o.jsx("span",{className:"text-token-text-secondary",children:o.jsx(R,{id:"+wTq4L",defaultMessage:"Download the Chrome extension to switch your default search engine to ChatGPT, and get instant answers from trusted sources with every search."})})]});return o.jsx(Ba,{onPrimaryCtaClick:a,primaryCtaText:o.jsx(R,{id:"x9mKG0",defaultMessage:"Get Extension"}),onDismiss:s,content:i})}function Dh(t){const{value:e}=ln("2634628831"),{eligible:s,isLoading:a}=As(Cr),i=hs(()=>document.documentElement.dataset.searchExtension==="1"),l=hr(t.clientThreadId,fs.Search),h=Kl();return{eligible:!(!e||i||!s||!l||!Ns()||!h||Bt(t.clientThreadId)||t.conversationMode?.kind!==Ee.PrimaryAssistant),isLoading:a}}function Ph(t){const e=Ke.getItem(Ve.SearchSettings)??{};e.hasSearchedMinTimes||(e.searchMessageIds||(e.searchMessageIds=[]),e.searchMessageIds.includes(t)||(e.searchMessageIds.push(t),e.searchMessageIds.length>=zl&&(e.hasSearchedMinTimes=!0,delete e.searchMessageIds),Ke.setItem(Ve.SearchSettings,e)))}function Kl(){return(Ke.getItem(Ve.SearchSettings)??{}).hasSearchedMinTimes===!0}const Ql=({children:t})=>{const e=Bs();return e?.length?o.jsxs(re.Root,{children:[o.jsx(re.Trigger,{className:"h-10 px-2",children:t}),o.jsx(re.Content,{align:"end",onCloseAutoFocus:s=>s.preventDefault(),children:e.map(s=>o.jsx(Yl,{textdocId:s},s))})]}):null},Yl=({textdocId:t})=>{const e=ms(mn(t));return o.jsx(re.Item,{icon:Nt,onClick:()=>{Es.logButtonClick(ks.FILE_DRAWER_ITEM),pn(e.textdocId)},children:e.title})},Jl=()=>{const t=ye(),e=Bs(),s=Ts();if(!e||s)return null;const a=e.length;return a===1?o.jsx(Xl,{textdocId:e[0]}):o.jsx(Ql,{children:o.jsx(Me,{label:t.formatMessage({id:"xX2Zyt",defaultMessage:"Open canvas"}),children:o.jsxs("div",{className:"flex items-center gap-1 text-token-text-secondary",children:[o.jsx(Nt,{className:"icon-xl-heavy"}),a]})})})},Xl=({textdocId:t})=>{const e=ye(),s=ms(mn(t));return o.jsx(Me,{label:e.formatMessage({id:"xX2Zyt",defaultMessage:"Open canvas"}),children:o.jsx(dt,{onClick:()=>pn(s.textdocId),icon:Nt})})},Ir={...Zr},Zl=Ir.useInsertionEffect,eu=Zl||(t=>t());function Er(t){const e=y.useRef(()=>{});return eu(()=>{e.current=t}),y.useCallback(function(){for(var s=arguments.length,a=new Array(s),i=0;i<s;i++)a[i]=arguments[i];return e.current==null?void 0:e.current(...a)},[])}var on=typeof document<"u"?y.useLayoutEffect:y.useEffect;let Kn=!1,tu=0;const Qn=()=>"floating-ui-"+Math.random().toString(36).slice(2,6)+tu++;function nu(){const[t,e]=y.useState(()=>Kn?Qn():void 0);return on(()=>{t==null&&e(Qn())},[]),y.useEffect(()=>{Kn=!0},[]),t}const su=Ir.useId,ru=su||nu;function ou(){const t=new Map;return{emit(e,s){var a;(a=t.get(e))==null||a.forEach(i=>i(s))},on(e,s){t.set(e,[...t.get(e)||[],s])},off(e,s){var a;t.set(e,((a=t.get(e))==null?void 0:a.filter(i=>i!==s))||[])}}}const au=y.createContext(null),iu=y.createContext(null),cu=()=>{var t;return((t=y.useContext(au))==null?void 0:t.id)||null},lu=()=>y.useContext(iu),uu="data-floating-ui-focusable";function du(t){const{open:e=!1,onOpenChange:s,elements:a}=t,i=ru(),l=y.useRef({}),[h]=y.useState(()=>ou()),u=cu()!=null,[p,g]=y.useState(a.reference),v=Er((x,b,S)=>{l.current.openEvent=x?b:void 0,h.emit("openchange",{open:x,event:b,reason:S,nested:u}),s?.(x,b,S)}),w=y.useMemo(()=>({setPositionReference:g}),[]),f=y.useMemo(()=>({reference:p||a.reference||null,floating:a.floating||null,domReference:a.reference}),[p,a.reference,a.floating]);return y.useMemo(()=>({dataRef:l,open:e,onOpenChange:v,elements:f,events:h,floatingId:i,refs:w}),[e,v,f,h,i,w])}function hu(t){t===void 0&&(t={});const{nodeId:e}=t,s=du({...t,elements:{reference:null,floating:null,...t.elements}}),a=t.rootContext||s,i=a.elements,[l,h]=y.useState(null),[u,p]=y.useState(null),v=i?.reference||l,w=y.useRef(null),f=lu();on(()=>{v&&(w.current=v)},[v]);const x=Fa({...t,elements:{...i,...u&&{reference:u}}}),b=y.useCallback(I=>{const T=pt(I)?{getBoundingClientRect:()=>I.getBoundingClientRect(),contextElement:I}:I;p(T),x.refs.setReference(T)},[x.refs]),S=y.useCallback(I=>{(pt(I)||I===null)&&(w.current=I,h(I)),(pt(x.refs.reference.current)||x.refs.reference.current===null||I!==null&&!pt(I))&&x.refs.setReference(I)},[x.refs]),E=y.useMemo(()=>({...x.refs,setReference:S,setPositionReference:b,domReference:w}),[x.refs,S,b]),B=y.useMemo(()=>({...x.elements,domReference:v}),[x.elements,v]),D=y.useMemo(()=>({...x,...a,refs:E,elements:B,nodeId:e}),[x,E,B,e,a]);return on(()=>{a.dataRef.current.floatingContext=D;const I=f?.nodesRef.current.find(T=>T.id===e);I&&(I.context=D)}),y.useMemo(()=>({...x,context:D,refs:E,elements:B}),[x,E,B,D])}const Yn="active",Jn="selected";function zt(t,e,s){const a=new Map,i=s==="item";let l=t;if(i&&t){const{[Yn]:h,[Jn]:u,...p}=t;l=p}return{...s==="floating"&&{tabIndex:-1,[uu]:""},...l,...e.map(h=>{const u=h?h[s]:null;return typeof u=="function"?t?u(t):null:u}).concat(t).reduce((h,u)=>(u&&Object.entries(u).forEach(p=>{let[g,v]=p;if(!(i&&[Yn,Jn].includes(g)))if(g.indexOf("on")===0){if(a.has(g)||a.set(g,[]),typeof v=="function"){var w;(w=a.get(g))==null||w.push(v),h[g]=function(){for(var f,x=arguments.length,b=new Array(x),S=0;S<x;S++)b[S]=arguments[S];return(f=a.get(g))==null?void 0:f.map(E=>E(...b)).find(E=>E!==void 0)}}}else h[g]=v}),h),{})}}function fu(t){t===void 0&&(t=[]);const e=t.map(u=>u?.reference),s=t.map(u=>u?.floating),a=t.map(u=>u?.item),i=y.useCallback(u=>zt(u,t,"reference"),e),l=y.useCallback(u=>zt(u,t,"floating"),s),h=y.useCallback(u=>zt(u,t,"item"),a);return y.useMemo(()=>({getReferenceProps:i,getFloatingProps:l,getItemProps:h}),[i,l,h])}function Xn(t,e){return{...t,rects:{...t.rects,floating:{...t.rects.floating,height:e}}}}const mu=t=>({name:"inner",options:t,async fn(e){const{listRef:s,overflowRef:a,onFallbackChange:i,offset:l=0,index:h=0,minItemsVisible:u=4,referenceOverflowThreshold:p=0,scrollRef:g,...v}=Da(t,e),{rects:w,elements:{floating:f}}=e,x=s.current[h],b=g?.current||f,S=f.clientTop||b.clientTop,E=f.clientTop!==0,B=b.clientTop!==0,D=f===b;if(!x)return{};const I={...e,...await Fs(-x.offsetTop-f.clientTop-w.reference.height/2-x.offsetHeight/2-l).fn(e)},T=await Ot(Xn(I,b.scrollHeight+S+f.clientTop),v),A=await Ot(I,{...v,elementContext:"reference"}),F=$t(0,T.top),L=I.y+F,P=Pa($t(0,b.scrollHeight+(E&&D||B?S*2:0)-F-$t(0,T.bottom)));if(b.style.maxHeight=P+"px",b.scrollTop=F,i){const G=b.scrollHeight>b.offsetHeight&&b.offsetHeight<x.offsetHeight*u-1||A.top>=-p||A.bottom>=-p;$e.flushSync(()=>i(G))}return a&&(a.current=await Ot(Xn({...I,y:L},b.offsetHeight+S+f.clientTop),v)),{y:L}}});function pu(t,e){const{open:s,elements:a}=t,{enabled:i=!0,overflowRef:l,scrollRef:h,onChange:u}=e,p=Er(u),g=y.useRef(!1),v=y.useRef(null),w=y.useRef(null);y.useEffect(()=>{if(!i)return;function x(S){if(S.ctrlKey||!b||l.current==null)return;const E=S.deltaY,B=l.current.top>=-.5,D=l.current.bottom>=-.5,I=b.scrollHeight-b.clientHeight,T=E<0?-1:1,A=E<0?"max":"min";b.scrollHeight<=b.clientHeight||(!B&&E>0||!D&&E<0?(S.preventDefault(),$e.flushSync(()=>{p(F=>F+Math[A](E,I*T))})):/firefox/i.test(Oa())&&(b.scrollTop+=E))}const b=h?.current||a.floating;if(s&&b)return b.addEventListener("wheel",x),requestAnimationFrame(()=>{v.current=b.scrollTop,l.current!=null&&(w.current={...l.current})}),()=>{v.current=null,w.current=null,b.removeEventListener("wheel",x)}},[i,s,a.floating,l,h,p]);const f=y.useMemo(()=>({onKeyDown(){g.current=!0},onWheel(){g.current=!1},onPointerMove(){g.current=!1},onScroll(){const x=h?.current||a.floating;if(!(!l.current||!x||!g.current)){if(v.current!==null){const b=x.scrollTop-v.current;(l.current.bottom<-.5&&b<-1||l.current.top<-.5&&b>1)&&$e.flushSync(()=>p(S=>S+b))}requestAnimationFrame(()=>{v.current=x.scrollTop})}}}),[a.floating,p,l,h]);return y.useMemo(()=>i?{floating:f}:{},[i,f])}let at=y.createContext({styles:void 0,setReference:()=>{},setFloating:()=>{},getReferenceProps:()=>({}),getFloatingProps:()=>({}),slot:{}});at.displayName="FloatingContext";let Cn=y.createContext(null);Cn.displayName="PlacementContext";function gu(t){return y.useMemo(()=>t?typeof t=="string"?{to:t}:t:null,[t])}function xu(){return y.useContext(at).setReference}function yu(){return y.useContext(at).getReferenceProps}function _u(){let{getFloatingProps:t,slot:e}=y.useContext(at);return y.useCallback((...s)=>Object.assign({},t(...s),{"data-anchor":e.anchor}),[t,e])}function vu(t=null){t===!1&&(t=null),typeof t=="string"&&(t={to:t});let e=y.useContext(Cn),s=y.useMemo(()=>t,[JSON.stringify(t,(i,l)=>{var h;return(h=l?.outerHTML)!=null?h:l})]);qe(()=>{e?.(s??null)},[e,s]);let a=y.useContext(at);return y.useMemo(()=>[a.setFloating,t?a.styles:{}],[a.setFloating,t,a.styles])}let Zn=4;function wu({children:t,enabled:e=!0}){let[s,a]=y.useState(null),[i,l]=y.useState(0),h=y.useRef(null),[u,p]=y.useState(null);bu(u);let g=e&&s!==null&&u!==null,{to:v="bottom",gap:w=0,offset:f=0,padding:x=0,inner:b}=Cu(s,u),[S,E="center"]=v.split(" ");qe(()=>{g&&l(0)},[g]);let{refs:B,floatingStyles:D,context:I}=hu({open:g,placement:S==="selection"?E==="center"?"bottom":`bottom-${E}`:E==="center"?`${S}`:`${S}-${E}`,strategy:"absolute",transform:!1,middleware:[Fs({mainAxis:S==="selection"?0:w,crossAxis:f}),Ua({padding:x}),S!=="selection"&&La({padding:x}),S==="selection"&&b?mu({...b,padding:x,overflowRef:h,offset:i,minItemsVisible:Zn,referenceOverflowThreshold:x,onFallbackChange(z){var te,W;if(!z)return;let V=I.elements.floating;if(!V)return;let X=parseFloat(getComputedStyle(V).scrollPaddingBottom)||0,Q=Math.min(Zn,V.childElementCount),N=0,Y=0;for(let K of(W=(te=I.elements.floating)==null?void 0:te.childNodes)!=null?W:[])if(K instanceof HTMLElement){let ce=K.offsetTop,M=ce+K.clientHeight+X,k=V.scrollTop,le=k+V.clientHeight;if(ce>=k&&M<=le)Q--;else{Y=Math.max(0,Math.min(M,le)-Math.max(ce,k)),N=K.clientHeight;break}}Q>=1&&l(K=>{let ce=N*Q-Y+X;return K>=ce?K:ce})}}):null,Ga({padding:x,apply({availableWidth:z,availableHeight:te,elements:W}){Object.assign(W.floating.style,{overflow:"auto",maxWidth:`${z}px`,maxHeight:`min(var(--anchor-max-height, 100vh), ${te}px)`})}})].filter(Boolean),whileElementsMounted:eo}),[T=S,A=E]=I.placement.split("-");S==="selection"&&(T="selection");let F=y.useMemo(()=>({anchor:[T,A].filter(Boolean).join(" ")}),[T,A]),L=pu(I,{overflowRef:h,onChange:l}),{getReferenceProps:P,getFloatingProps:G}=fu([L]),H=pe(z=>{p(z),B.setFloating(z)});return y.createElement(Cn.Provider,{value:a},y.createElement(at.Provider,{value:{setFloating:H,setReference:B.setReference,styles:D,getReferenceProps:P,getFloatingProps:G,slot:F}},t))}function bu(t){qe(()=>{if(!t)return;let e=new MutationObserver(()=>{let s=window.getComputedStyle(t).maxHeight,a=parseFloat(s);if(isNaN(a))return;let i=parseInt(s);isNaN(i)||a!==i&&(t.style.maxHeight=`${Math.ceil(a)}px`)});return e.observe(t,{attributes:!0,attributeFilter:["style"]}),()=>{e.disconnect()}},[t])}function Cu(t,e){var s,a,i;let l=Vt((s=t?.gap)!=null?s:"var(--anchor-gap, 0)",e),h=Vt((a=t?.offset)!=null?a:"var(--anchor-offset, 0)",e),u=Vt((i=t?.padding)!=null?i:"var(--anchor-padding, 0)",e);return{...t,gap:l,offset:h,padding:u}}function Vt(t,e,s=void 0){let a=Ds(),i=pe((p,g)=>{if(p==null)return[s,null];if(typeof p=="number")return[p,null];if(typeof p=="string"){if(!g)return[s,null];let v=es(p,g);return[v,w=>{let f=kr(p);{let x=f.map(b=>window.getComputedStyle(g).getPropertyValue(b));a.requestAnimationFrame(function b(){a.nextFrame(b);let S=!1;for(let[B,D]of f.entries()){let I=window.getComputedStyle(g).getPropertyValue(D);if(x[B]!==I){x[B]=I,S=!0;break}}if(!S)return;let E=es(p,g);v!==E&&(w(E),v=E)})}return a.dispose}]}return[s,null]}),l=y.useMemo(()=>i(t,e)[0],[t,e]),[h=l,u]=y.useState();return qe(()=>{let[p,g]=i(t,e);if(u(p),!!g)return g(u)},[t,e]),h}function kr(t){let e=/var\((.*)\)/.exec(t);if(e){let s=e[1].indexOf(",");if(s===-1)return[e[1]];let a=e[1].slice(0,s).trim(),i=e[1].slice(s+1).trim();return i?[a,...kr(i)]:[a]}return[]}function es(t,e){let s=document.createElement("div");e.appendChild(s),s.style.setProperty("margin-top","0px","important"),s.style.setProperty("margin-top",t,"important");let a=parseFloat(window.getComputedStyle(s).marginTop)||0;return e.removeChild(s),a}var Su=(t=>(t[t.Open=0]="Open",t[t.Closed=1]="Closed",t))(Su||{}),Iu=(t=>(t[t.Pointer=0]="Pointer",t[t.Other=1]="Other",t))(Iu||{}),Eu=(t=>(t[t.OpenMenu=0]="OpenMenu",t[t.CloseMenu=1]="CloseMenu",t[t.GoToItem=2]="GoToItem",t[t.Search=3]="Search",t[t.ClearSearch=4]="ClearSearch",t[t.RegisterItem=5]="RegisterItem",t[t.UnregisterItem=6]="UnregisterItem",t[t.SetButtonElement=7]="SetButtonElement",t[t.SetItemsElement=8]="SetItemsElement",t))(Eu||{});function Kt(t,e=s=>s){let s=t.activeItemIndex!==null?t.items[t.activeItemIndex]:null,a=pi(e(t.items.slice()),l=>l.dataRef.current.domRef.current),i=s?a.indexOf(s):null;return i===-1&&(i=null),{items:a,activeItemIndex:i}}let ku={1(t){return t.menuState===1?t:{...t,activeItemIndex:null,menuState:1}},0(t){return t.menuState===0?t:{...t,__demoMode:!1,menuState:0}},2:(t,e)=>{var s,a,i,l,h;if(t.menuState===1)return t;let u={...t,searchQuery:"",activationTrigger:(s=e.trigger)!=null?s:1,__demoMode:!1};if(e.focus===xe.Nothing)return{...u,activeItemIndex:null};if(e.focus===xe.Specific)return{...u,activeItemIndex:t.items.findIndex(v=>v.id===e.id)};if(e.focus===xe.Previous){let v=t.activeItemIndex;if(v!==null){let w=t.items[v].dataRef.current.domRef,f=qt(e,{resolveItems:()=>t.items,resolveActiveIndex:()=>t.activeItemIndex,resolveId:x=>x.id,resolveDisabled:x=>x.dataRef.current.disabled});if(f!==null){let x=t.items[f].dataRef.current.domRef;if(((a=w.current)==null?void 0:a.previousElementSibling)===x.current||((i=x.current)==null?void 0:i.previousElementSibling)===null)return{...u,activeItemIndex:f}}}}else if(e.focus===xe.Next){let v=t.activeItemIndex;if(v!==null){let w=t.items[v].dataRef.current.domRef,f=qt(e,{resolveItems:()=>t.items,resolveActiveIndex:()=>t.activeItemIndex,resolveId:x=>x.id,resolveDisabled:x=>x.dataRef.current.disabled});if(f!==null){let x=t.items[f].dataRef.current.domRef;if(((l=w.current)==null?void 0:l.nextElementSibling)===x.current||((h=x.current)==null?void 0:h.nextElementSibling)===null)return{...u,activeItemIndex:f}}}}let p=Kt(t),g=qt(e,{resolveItems:()=>p.items,resolveActiveIndex:()=>p.activeItemIndex,resolveId:v=>v.id,resolveDisabled:v=>v.dataRef.current.disabled});return{...u,...p,activeItemIndex:g}},3:(t,e)=>{let s=t.searchQuery!==""?0:1,a=t.searchQuery+e.value.toLowerCase(),i=(t.activeItemIndex!==null?t.items.slice(t.activeItemIndex+s).concat(t.items.slice(0,t.activeItemIndex+s)):t.items).find(h=>{var u;return((u=h.dataRef.current.textValue)==null?void 0:u.startsWith(a))&&!h.dataRef.current.disabled}),l=i?t.items.indexOf(i):-1;return l===-1||l===t.activeItemIndex?{...t,searchQuery:a}:{...t,searchQuery:a,activeItemIndex:l,activationTrigger:1}},4(t){return t.searchQuery===""?t:{...t,searchQuery:"",searchActiveItemIndex:null}},5:(t,e)=>{let s=Kt(t,a=>[...a,{id:e.id,dataRef:e.dataRef}]);return{...t,...s}},6:(t,e)=>{let s=Kt(t,a=>{let i=a.findIndex(l=>l.id===e.id);return i!==-1&&a.splice(i,1),a});return{...t,...s,activationTrigger:1}},7:(t,e)=>t.buttonElement===e.element?t:{...t,buttonElement:e.element},8:(t,e)=>t.itemsElement===e.element?t:{...t,itemsElement:e.element}},Sn=y.createContext(null);Sn.displayName="MenuContext";function Ft(t){let e=y.useContext(Sn);if(e===null){let s=new Error(`<${t} /> is missing a parent <Menu /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(s,Ft),s}return e}function Tu(t,e){return Ps(e.type,ku,t,e)}let Mu=y.Fragment;function ju(t,e){let{__demoMode:s=!1,...a}=t,i=y.useReducer(Tu,{__demoMode:s,menuState:s?0:1,buttonElement:null,itemsElement:null,items:[],searchQuery:"",activeItemIndex:null,activationTrigger:1}),[{menuState:l,itemsElement:h,buttonElement:u},p]=i,g=Rt(e);Wa(l===0,[u,h],(x,b)=>{p({type:1}),$a(b,qa.Loose)||(x.preventDefault(),u?.focus())});let v=pe(()=>{p({type:1})}),w=y.useMemo(()=>({open:l===0,close:v}),[l,v]),f={ref:g};return We.createElement(wu,null,We.createElement(Sn.Provider,{value:i},We.createElement(Ha,{value:Ps(l,{0:Ct.Open,1:Ct.Closed})},Ze({ourProps:f,theirProps:a,slot:w,defaultTag:Mu,name:"Menu"}))))}let Ru="button";function Au(t,e){var s;let a=y.useId(),{id:i=`headlessui-menu-button-${a}`,disabled:l=!1,autoFocus:h=!1,...u}=t,[p,g]=Ft("Menu.Button"),v=yu(),w=za(),f=Rt(e,xu(),pe(P=>g({type:7,element:P}))),x=pe(P=>{switch(P.key){case me.Space:case me.Enter:case me.ArrowDown:P.preventDefault(),P.stopPropagation(),$e.flushSync(()=>g({type:0})),g({type:2,focus:xe.First});break;case me.ArrowUp:P.preventDefault(),P.stopPropagation(),$e.flushSync(()=>g({type:0})),g({type:2,focus:xe.Last});break}}),b=pe(P=>{switch(P.key){case me.Space:P.preventDefault();break}}),S=pe(P=>{var G;if(Va(P.currentTarget))return P.preventDefault();l||(p.menuState===0?($e.flushSync(()=>g({type:1})),(G=p.buttonElement)==null||G.focus({preventScroll:!0})):(P.preventDefault(),g({type:0})))}),{isFocusVisible:E,focusProps:B}=Ka({autoFocus:h}),{isHovered:D,hoverProps:I}=Qa({isDisabled:l}),{pressed:T,pressProps:A}=Ya({disabled:l}),F=y.useMemo(()=>({open:p.menuState===0,active:T||p.menuState===0,disabled:l,hover:D,focus:E,autofocus:h}),[p,D,E,T,l,h]),L=Os(v(),{ref:f,id:i,type:Ja(t,p.buttonElement),"aria-haspopup":"menu","aria-controls":(s=p.itemsElement)==null?void 0:s.id,"aria-expanded":p.menuState===0,disabled:l||void 0,autoFocus:h,onKeyDown:x,onKeyUp:b,onClick:S},B,I,A);return Ze({mergeRefs:w,ourProps:L,theirProps:u,slot:F,defaultTag:Ru,name:"Menu.Button"})}let Nu="div",Bu=Pn.RenderStrategy|Pn.Static;function Fu(t,e){var s,a;let i=y.useId(),{id:l=`headlessui-menu-items-${i}`,anchor:h,portal:u=!1,modal:p=!0,transition:g=!1,...v}=t,w=gu(h),[f,x]=Ft("Menu.Items"),[b,S]=vu(w),E=_u(),[B,D]=y.useState(null),I=Rt(e,w?b:null,pe(N=>x({type:8,element:N})),D),T=Xa(f.itemsElement);w&&(u=!0);let A=Za(),[F,L]=ei(g,B,A!==null?(A&Ct.Open)===Ct.Open:f.menuState===0);ti(F,f.buttonElement,()=>{x({type:1})});let P=f.__demoMode?!1:p&&f.menuState===0;ni(P,T);let G=f.__demoMode?!1:p&&f.menuState===0;si(G,{allowed:y.useCallback(()=>[f.buttonElement,f.itemsElement],[f.buttonElement,f.itemsElement])});let H=f.menuState!==0,z=ri(H,f.buttonElement)?!1:F;y.useEffect(()=>{let N=f.itemsElement;N&&f.menuState===0&&N!==T?.activeElement&&N.focus({preventScroll:!0})},[f.menuState,f.itemsElement,T]),oi(f.menuState===0,{container:f.itemsElement,accept(N){return N.getAttribute("role")==="menuitem"?NodeFilter.FILTER_REJECT:N.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(N){N.setAttribute("role","none")}});let te=Ds(),W=pe(N=>{var Y,K,ce;switch(te.dispose(),N.key){case me.Space:if(f.searchQuery!=="")return N.preventDefault(),N.stopPropagation(),x({type:3,value:N.key});case me.Enter:if(N.preventDefault(),N.stopPropagation(),x({type:1}),f.activeItemIndex!==null){let{dataRef:M}=f.items[f.activeItemIndex];(K=(Y=M.current)==null?void 0:Y.domRef.current)==null||K.click()}Us(f.buttonElement);break;case me.ArrowDown:return N.preventDefault(),N.stopPropagation(),x({type:2,focus:xe.Next});case me.ArrowUp:return N.preventDefault(),N.stopPropagation(),x({type:2,focus:xe.Previous});case me.Home:case me.PageUp:return N.preventDefault(),N.stopPropagation(),x({type:2,focus:xe.First});case me.End:case me.PageDown:return N.preventDefault(),N.stopPropagation(),x({type:2,focus:xe.Last});case me.Escape:N.preventDefault(),N.stopPropagation(),$e.flushSync(()=>x({type:1})),(ce=f.buttonElement)==null||ce.focus({preventScroll:!0});break;case me.Tab:N.preventDefault(),N.stopPropagation(),$e.flushSync(()=>x({type:1})),ai(f.buttonElement,N.shiftKey?On.Previous:On.Next);break;default:N.key.length===1&&(x({type:3,value:N.key}),te.setTimeout(()=>x({type:4}),350));break}}),V=pe(N=>{switch(N.key){case me.Space:N.preventDefault();break}}),X=y.useMemo(()=>({open:f.menuState===0}),[f.menuState]),Q=Os(w?E():{},{"aria-activedescendant":f.activeItemIndex===null||(s=f.items[f.activeItemIndex])==null?void 0:s.id,"aria-labelledby":(a=f.buttonElement)==null?void 0:a.id,id:l,onKeyDown:W,onKeyUp:V,role:"menu",tabIndex:f.menuState===0?0:void 0,ref:I,style:{...v.style,...S,"--button-width":ii(f.buttonElement,!0).width},...ci(L)});return We.createElement(li,{enabled:u?t.static||F:!1},Ze({ourProps:Q,theirProps:v,slot:X,defaultTag:Nu,features:Bu,visible:z,name:"Menu.Items"}))}let Du=y.Fragment;function Pu(t,e){let s=y.useId(),{id:a=`headlessui-menu-item-${s}`,disabled:i=!1,...l}=t,[h,u]=Ft("Menu.Item"),p=h.activeItemIndex!==null?h.items[h.activeItemIndex].id===a:!1,g=y.useRef(null),v=Rt(e,g);qe(()=>{if(!h.__demoMode&&h.menuState===0&&p&&h.activationTrigger!==0)return ui().requestAnimationFrame(()=>{var G,H;(H=(G=g.current)==null?void 0:G.scrollIntoView)==null||H.call(G,{block:"nearest"})})},[h.__demoMode,g,p,h.menuState,h.activationTrigger,h.activeItemIndex]);let w=di(g),f=y.useRef({disabled:i,domRef:g,get textValue(){return w()}});qe(()=>{f.current.disabled=i},[f,i]),qe(()=>(u({type:5,id:a,dataRef:f}),()=>u({type:6,id:a})),[f,a]);let x=pe(()=>{u({type:1})}),b=pe(G=>{if(i)return G.preventDefault();u({type:1}),Us(h.buttonElement)}),S=pe(()=>{if(i)return u({type:2,focus:xe.Nothing});u({type:2,focus:xe.Specific,id:a})}),E=hi(),B=pe(G=>{E.update(G),!i&&(p||u({type:2,focus:xe.Specific,id:a,trigger:0}))}),D=pe(G=>{E.wasMoved(G)&&(i||p||u({type:2,focus:xe.Specific,id:a,trigger:0}))}),I=pe(G=>{E.wasMoved(G)&&(i||p&&u({type:2,focus:xe.Nothing}))}),[T,A]=Ls(),[F,L]=fi(),P=y.useMemo(()=>({active:p,focus:p,disabled:i,close:x}),[p,i,x]);return We.createElement(A,null,We.createElement(L,null,Ze({ourProps:{id:a,ref:v,role:"menuitem",tabIndex:i===!0?void 0:-1,"aria-disabled":i===!0?!0:void 0,"aria-labelledby":T,"aria-describedby":F,disabled:void 0,onClick:b,onFocus:S,onPointerEnter:B,onMouseEnter:B,onPointerMove:D,onMouseMove:D,onPointerLeave:I,onMouseLeave:I},theirProps:l,slot:P,defaultTag:Du,name:"Menu.Item"})))}let Ou="div";function Uu(t,e){let[s,a]=Ls();return We.createElement(a,null,Ze({ourProps:{ref:e,"aria-labelledby":s,role:"group"},theirProps:t,slot:{},defaultTag:Ou,name:"Menu.Section"}))}let Lu="header";function Gu(t,e){let s=y.useId(),{id:a=`headlessui-menu-heading-${s}`,...i}=t,l=mi();qe(()=>l.register(a),[a,l.register]);let h={id:a,ref:e,role:"presentation",...l.props};return Ze({ourProps:h,theirProps:i,slot:{},defaultTag:Lu,name:"Menu.Heading"})}let Wu="div";function $u(t,e){return Ze({ourProps:{ref:e,role:"separator"},theirProps:t,slot:{},defaultTag:Wu,name:"Menu.Separator"})}let qu=Xe(ju),Hu=Xe(Au),zu=Xe(Fu),Vu=Xe(Pu),Ku=Xe(Uu),Qu=Xe(Gu),Yu=Xe($u),lt=Object.assign(qu,{Button:Hu,Items:zu,Item:Vu,Section:Ku,Heading:Qu,Separator:Yu});function Ju({show:t,appear:e,children:s}){return o.jsx(gi,{as:y.Fragment,enter:"transition ease-out duration-200",enterFrom:"opacity-0 translate-y-1",enterTo:"opacity-100 translate-y-0",leave:"transition ease-in duration-150",leaveFrom:"opacity-100 translate-y-0",leaveTo:"opacity-0 translate-y-1",show:t,appear:e,children:s})}function Ge({onClick:t,href:e,target:s,children:a,disabled:i,icon:l,testId:h}){const u=ht();return o.jsx(lt.Item,{disabled:i,children:({active:p})=>o.jsxs(Dt,{onClick:t,href:e,target:s,className:oe({"bg-token-sidebar-surface-secondary":p,"hover:bg-token-sidebar-surface-secondary":!p&&!i||u}),"data-testid":h,children:[l&&o.jsx(l,{className:"icon-md"}),a]})})}function Xu({to:t,children:e,icon:s}){return o.jsx(lt.Item,{children:({active:a})=>o.jsx(to,{to:t,children:o.jsxs(Dt,{$as:"span",className:oe(a?"bg-token-sidebar-surface-secondary":"cursor-pointer"),children:[s&&o.jsx(s,{className:"icon-md"}),e]})})})}De.a`p-2 rounded-md hover:bg-black/10 hover:dark:bg-white/10 cursor-pointer`;const Dt=De.a`flex gap-2 rounded p-2.5 text-sm cursor-pointer focus:ring-0 hover:bg-token-main-surface-secondary radix-disabled:pointer-events-none radix-disabled:opacity-50 group items-center`,Oh=De(Dt)`border dark:border-white/20 min-h-0 hover:bg-gray-500/10 h-10 rounded-lg border-[rgba(0,0,0,0.1)]`,an=De.div`h-px bg-token-border-light my-1.5`,Uh=De(Dt)`${t=>t.$active?"bg-token-sidebar-surface-secondary":"hover:bg-token-sidebar-surface-secondary"}`;function Tr({menuItemComponent:t}){const e=je(),s=Je(),a=y.useCallback(()=>{O.logEvent(U.clickSidebarAccountPortalMenuItem),xn(s,"Sidebar account menu item")},[s]),{value:i}=ln("1028682714"),l=Ye(()=>He(()=>import("./sso-i9n8wk17y9r2hc8j.js").then(h=>h.M),__vite__mapDeps([42,1,2,3,5,6,27,8,43,26,44,45,46,47,48,49,50,18,51,21,28,52,53,54,55,22,23,56,57,58,59,15,60,61,62,25,7,35,12,63,64,19,20,65,66,29,67,68,69,70,71,72,73,74,75,76,77,78,79])).then(h=>h.default));return o.jsxs(o.Fragment,{children:[e?.hasPaidSubscription()&&(i?o.jsx(l,{handleClickCustomerPortal:a,menuItemComponent:t}):o.jsx(t,{onClick:a,icon:mc,children:o.jsx(R,{id:"popoverNavigation.myPlan",defaultMessage:"My plan"})})),e?.canInteractWithGizmos()&&o.jsx(t,{onClick:()=>{O.logEvent(U.accountMenuClickMyGPTs),s(fr())},icon:Qs,children:o.jsx(R,{id:"popoverNavigation.myGpts",defaultMessage:"My GPTs"})}),o.jsx(t,{icon:Ys,onClick:()=>{be.openModal(Qe.UserContext),O.logEvent(U.accountMenuClickCustomizeChatGPT)},children:o.jsx(R,{id:"popoverNavigation.chatPreferences.1",defaultMessage:"Customize ChatGPT"})})]})}function Mr({menuItemComponent:t,routedMenuItemComponent:e}){const s=je(),a=no("2756095923")?.value&&s?.isEdu()&&s?.isStandardUserOfAccount();return o.jsxs(o.Fragment,{children:[!a&&o.jsx(e,{to:"/admin",icon:pc,children:o.jsx(R,{...Qt.myWorkspaceSettings})}),o.jsx(e,{to:fr(),onClick:()=>{O.logEvent(U.accountMenuClickMyGPTs)},icon:Qs,children:o.jsx(R,{...Qt.myGpts})}),o.jsx(t,{onClick:()=>{be.openModal(Qe.UserContext),O.logEvent(U.accountMenuClickCustomizeChatGPT)},icon:Ys,children:o.jsx(R,{...Qt.chatPreferences})})]})}const Qt=ot({myWorkspaceSettings:{id:"workspacePopoverNavigation.myWorkspaceSettings",defaultMessage:"Manage workspace"},chatPreferences:{id:"B4s/Jz",defaultMessage:"Customize ChatGPT"},myGpts:{id:"workspacePopoverNavigation.myGpts",defaultMessage:"My GPTs"}}),Zu=Ye(()=>He(()=>import("./k4pvkri4w9ic2aso.js"),__vite__mapDeps([80,1,2,3,25,23,21,5,6,8,81,82,58,59,15,26])));function Lh({onClickSettings:t}){const e=ht();return o.jsxs(lt,{as:"div",className:oe(!e&&"group relative"),children:[o.jsx(sd,{}),o.jsx(Ju,{children:o.jsx(lt.Items,{className:oe("popover absolute bottom-full z-50 mb-1 overflow-hidden rounded-lg border border-token-border-light bg-token-main-surface-primary p-1.5 shadow-lg outline-none",e&&"left-3 w-[var(--screen-sidebar-popover-min-width)]",!e&&"left-0 w-full"),children:o.jsx(nd,{onClickSettings:t})})})]})}function jr(){const t=!je()?.isEnterprisey(),e=ye(),s=jt(),a=Je();return s?o.jsxs("div",{className:"flex items-center justify-between gap-2 py-2 pl-5 pr-4",children:[o.jsx("div",{className:"text-sm text-token-text-secondary",children:s?.email}),t&&o.jsx(Me,{label:e.formatMessage(Ue.addWorkspaceTooltip),side:"right",children:o.jsx("button",{onClick:()=>xn(a,"profile menu"),children:o.jsx(wc,{className:"icon-sm text-token-text-primary"})})})]}):null}function ed(){const t=je();return t==null?o.jsx(o.Fragment,{children:o.jsx("div",{className:"w-full px-3 py-2",children:o.jsx(wt,{})})}):o.jsxs(o.Fragment,{children:[o.jsx(jr,{}),o.jsx("div",{className:"flex h-11 w-full items-center justify-start gap-3 px-3 py-1 text-sm",children:o.jsx(Ar,{workspace:t,isLoading:!1,currentWorkspaceId:t.id,showCheck:!1})})]})}function Rr({menuItemComponent:t}){const e=At(),s=ut(),{data:a}=Mt(),i=je(),[l,h]=y.useState(!1),u=jt(),p=ye(),g=un();if(!i||!a)return null;const v=i.isWorkspaceAccount(),w=a.accountItems.length>1,f=a.accountItems,x=xi([f.find(S=>S.isPersonalAccount()),...f.filter(S=>!S.isPersonalAccount())]);if(x.sort((S,E)=>S.isPersonalAccount()?1:E.isPersonalAccount()?-1:0),!w)return v?o.jsx(ed,{}):o.jsx(o.Fragment,{children:o.jsx("div",{className:"ml-3 mr-2 py-2 text-sm text-token-text-secondary",children:u?.email})});const b=x.map(S=>o.jsx(t,{disabled:S.isDeactivated(),onClick:()=>{if(S.isDeactivated()||S.id===i?.id)return;h(!0);const{willRedirect:E}=so(s,S.id,e,p,g);E||ro()},className:"radix-disabled:pointer-events-auto radix-disabled:hover:bg-transparent",children:S.isDeactivated()?o.jsx(td,{workspace:S,isLoading:l}):o.jsx(Ar,{workspace:S,isLoading:l,currentWorkspaceId:i?.id})},S.id));return o.jsxs(o.Fragment,{children:[o.jsx(jr,{}),o.jsx(re.Separator,{}),b]})}function Ar({workspace:t,isLoading:e,currentWorkspaceId:s,showCheck:a=!0}){const i=t.canAccessWithCurrentSession,l=!e&&a&&t.id===s;return o.jsxs("div",{children:[o.jsxs("div",{className:"flex w-full items-center gap-2.5",children:[o.jsx("span",{className:"flex h-5 w-5 items-center justify-center",children:o.jsx(yn,{iconSize:"small",workspace:t,className:oe({"flex-shrink-0":!0})})}),o.jsx("div",{className:"line-clamp-1 text-token-text-primary",children:Gs(ye(),t)}),e&&o.jsx(wt,{}),l&&o.jsx("span",{className:"text-token-text-primary",children:o.jsx(gc,{className:"icon-sm"})}),!i&&o.jsx("span",{className:"text-token-text-primary",children:o.jsx(xc,{className:"icon-sm"})})]}),!i&&o.jsx("div",{className:"rowDivClassName",children:o.jsx("small",{className:"text-token-text-secondary",children:o.jsx(R,{...t.ssoConnectionName?Ue.authenticateWithSSOToAccessWorkspace:Ue.authenticateWithoutSSOToAccessWorkspace})})})]})}function td({workspace:t,isLoading:e}){const s=ye(),a=t.isOwnerOfAccount(),[i,l]=y.useState(!1),h=jc(t.id);return y.useEffect(()=>{h!=null&&i&&(be.setPurchaseWorkspaceData({minimumSeats:Math.max(h,Un),existingAccount:t}),l(!1))},[h,i,t]),o.jsxs(o.Fragment,{children:[o.jsxs(Me,{className:"flex w-full flex-1 items-center gap-2.5",label:s.formatMessage(Ue.disabledWorkspaceTooltip),sideOffset:20,side:"right",children:[o.jsx("span",{className:"flex h-5 w-5 items-center justify-center",children:o.jsx(yc,{className:"icon-sm flex-shrink-0 opacity-30"})}),o.jsx("div",{className:"truncate opacity-30",children:Gs(s,t)})]}),e&&o.jsx(wt,{}),!e&&o.jsxs(re.Root,{children:[o.jsx(re.Trigger,{className:"rounded text-center hover:bg-token-main-surface-secondary",children:o.jsx(_c,{className:"icon-sm m-1"})}),o.jsx(re.Portal,{children:o.jsxs(re.Content,{children:[a&&o.jsx(o.Fragment,{children:o.jsx(re.Item,{onClick:()=>{h==null?l(!0):be.setPurchaseWorkspaceData({minimumSeats:Math.max(h,Un),existingAccount:t})},children:i?o.jsx(wt,{}):o.jsx(R,{id:"navigation.reactivateWorkspace",defaultMessage:"Reactivate workspace"})})}),o.jsx(re.Item,{onClick:()=>{be.setLeaveWorkspaceData(t)},children:o.jsx(R,{id:"navigation.leaveWorkspace",defaultMessage:"Leave workspace"})})]})})]})]})}function nd({onClickSettings:t}){const{data:e}=Mt(),s=je(),a=Ws(),i=rr(),{openModal:l}=or(),h=ps("3905879930");var u=s?.isTeam()??!1,p=!1;if(u&&(p=h.config.get("enabled",!1)),!s||!e)return null;const g=s.isWorkspaceAccount(),v=!a;return o.jsxs("nav",{children:[o.jsx(Rr,{menuItemComponent:Ge}),o.jsx(an,{}),g?o.jsx(Mr,{menuItemComponent:Ge,routedMenuItemComponent:Xu}):o.jsx(Tr,{menuItemComponent:Ge}),v&&o.jsx(Ge,{href:yi(),target:"_blank",onClick:()=>{O.logEvent(U.clickFaqLink)},icon:vc,children:o.jsx(R,{...Ue.helpAndFaq})}),o.jsx(Ge,{onClick:t,icon:Js,testId:"accounts-settings-button",children:o.jsx(R,{...Ue.settings})}),u&&p&&o.jsxs(o.Fragment,{children:[o.jsx(Ge,{onClick:()=>{be.openModal(Qe.InviteUsersToWorkspace),O.logEvent(U.accountMemberInviteButton,{location:"dropdown-menu-click"}),ue.logEvent("chatgpt_invite_users_to_workspace",0,{action:"OpenAdminInviteModal",location:"dropdown-menu-click",text:"AddTeammates",step:"OpenModal"})},icon:Xs,children:o.jsx(R,{...Ue.addTeammatesButton})}),o.jsx(Zu,{workspace:s})]}),i&&o.jsx(rd,{openDownloadModal:l}),o.jsx(an,{}),o.jsx(Ge,{onClick:()=>{O.logEvent(U.clickLogOut,{eventSource:"mouse"}),gs()},icon:Zs,children:o.jsx(R,{...Ue.logOut})})]})}function sd(){return jt()?o.jsx(od,{}):null}function rd({openDownloadModal:t}){return o.jsxs("span",{children:[o.jsx(an,{}),o.jsx(Ge,{icon:er,onClick:()=>{O.logEvent(U.accountMenuClickDownloadApp),t()},children:o.jsx(R,{...Ue.downloadApp})})]})}function od(){const{data:t}=Mt(),e=je(),s=_i(),a=vi(),i=ht();if(!e||!t)return null;const l=e.isWorkspaceAccount(),h=t.accountItems.length>1;return o.jsxs(lt.Button,{className:oe("flex w-full max-w-[100%] items-center gap-2 rounded-lg text-sm group-ui-open:bg-token-sidebar-surface-secondary",i&&"px-2 py-1.5 hover:bg-token-main-surface-secondary",!i&&"p-2 hover:bg-token-sidebar-surface-secondary"),"data-testid":"accounts-profile-button",children:[o.jsx("div",{className:"flex-shrink-0",children:o.jsx(yn,{iconSize:"gizmo"})}),o.jsxs("div",{className:"relative -top-px grow -space-y-px truncate text-start text-token-text-primary",children:[o.jsx("div",{dir:"auto",children:a}),l||h?o.jsx("div",{className:"truncate text-xs text-token-text-secondary",dir:"auto",children:s}):null]})]})}const Ue=ot({helpAndFaq:{id:"navigation.helpAndFaq",defaultMessage:"Help & FAQ"},settings:{id:"navigation.settings",defaultMessage:"Settings"},logOut:{id:"navigation.logOut",defaultMessage:"Log out"},accountSwitcherTitle:{id:"navigation.accountSwitcherTitle",defaultMessage:"Workspaces"},defaultWorkspaceTitle:{id:"useWorkspaces.defaultWorkspaceTitle",defaultMessage:"Untitled Workspace"},addWorkspaceTooltip:{id:"navigation.addWorkspaceTooltip",defaultMessage:"Create a Team workspace"},disabledWorkspaceTooltip:{id:"navigation.disabledWorkspaceTooltip",defaultMessage:"This workspace has been deactivated"},downloadApp:{id:"navigation.downloadMacApp",defaultMessage:"Download the macOS app"},authenticateWithSSOToAccessWorkspace:{id:"CV7pdM",defaultMessage:"Authenticate with SSO to access this workspace"},authenticateWithoutSSOToAccessWorkspace:{id:"zfCWFh",defaultMessage:"Authenticate without SSO to access this workspace"},addTeammatesButton:{id:"inviteMemberButton.inviteMemberButton",defaultMessage:"Add Teammates"}});function ad(t){ue.logEvent("chatgpt_web_thread_tap_new_thread"),Ke.getItem(Ve.HasSeenNewChatModal)===!0?$s(t):(Ke.setItem(Ve.HasSeenNewChatModal,!0),be.openModal(Qe.NoAuthNewChat))}function Gh(){return Rc(Qe.NoAuthNewChat)?o.jsx(id,{onClose:()=>{be.closeModal(Qe.NoAuthNewChat)}}):null}function id({onClose:t}){const e=At(),s=Je(),a=xs("1934819688"),i=a.config.get("is_redesign_enabled",!1),l=a.config.get("secondary_button_type","cancel"),h=qs(Ut.signUpButtonText),u=w=>{w.preventDefault(),e({authType:"signup",callback:f=>{ue.logEvent("chatgpt_new_chat_modal_sign_up_link_clicked"),O.logSignUpButtonClicked({location:"New chat modal",provider:f})}})},p=w=>{w.preventDefault(),e({authType:"login",callback:f=>{ue.logEvent("chatgpt_new_chat_modal_log_in_link_clicked"),O.logLogInButtonClicked({location:"New chat modal",provider:f})}})},g=()=>{ue.logEvent("chatgpt_new_chat_modal_cancel_button_clicked"),O.logEvent(U.newChatModalCancelButtonClicked),t()},v=()=>{ue.logEvent("chatgpt_new_chat_modal_new_chat_button_clicked"),O.logNewChatButtonClicked({location:"New Chat Modal New Chat Button"}),$s(s),t()};return y.useEffect(()=>{ue.logEvent("chatgpt_new_chat_modal_shown"),O.logEvent(U.newChatModalShown)},[]),o.jsx(oo,{isOpen:!0,type:"success",onClose:t,noPadding:!0,size:"custom",className:"max-w-sm",children:o.jsxs("div",{className:"flex flex-col justify-center p-6",children:[o.jsxs("div",{className:"mb-2 grid w-full grid-cols-[1fr,auto,1fr] items-center",children:[o.jsx("div",{}),o.jsx("div",{className:"text-xl font-medium",children:o.jsx(R,{id:"d+R7z5",defaultMessage:"Clear current chat?"})}),o.jsx("div",{className:"flex justify-end",children:i?o.jsx(ao,{onClick:t}):null})]}),o.jsx("p",{className:"mb-6 text-center text-token-text-secondary",children:o.jsx(R,{id:"+Olycu",defaultMessage:"To start a new chat, your current conversation will be discarded. <signup>Sign up</signup> or <login>log in</login> to save chats.",values:{signup:w=>o.jsx("a",{href:"#",className:"font-medium text-token-text-primary",onClick:u,children:w}),login:w=>o.jsx("a",{href:"#",className:"font-medium text-token-text-primary",onClick:p,children:w})}})}),o.jsx(Oe,{className:"mb-3",color:i?"primary":"danger",size:"giant",onClick:v,children:o.jsx(R,{id:"cBGbrD",defaultMessage:"Clear chat"})}),l==="cancel"?o.jsx(Oe,{size:"giant",onClick:g,color:"secondary",children:o.jsx(R,{...Ut.cancelButtonText})}):null,l==="login"?o.jsx(Oe,{size:"giant",onClick:()=>{e({authType:"login",callback:w=>{O.logLogInButtonClicked({location:"New chat modal",provider:w})}})},color:"ghost",children:o.jsx(R,{...Ut.logInButtonText})}):null,l==="signup"?o.jsx(Oe,{size:"giant",onClick:()=>{e({authType:"signup",callback:w=>{O.logSignUpButtonClicked({location:"New chat modal",provider:w})}})},color:"ghost",children:o.jsx(R,{...h})}):null]})})}function Nr({clientThreadId:t,location:e}){const s=ut(),{id:a}=mr(t),i=ur(!0),l=Je(),h=dn(),u=io();return y.useCallback(()=>{hn(ys(s))?ad(l):h?l({pathname:u.pathname,search:u.search},{state:wi()}):(i({modelId:a,location:e}),ue.logEvent("chatgpt_web_thread_tap_new_thread"))},[s,e,a,i,l,h,u])}const cd=["Not relevant","Out of date","Content is wrong"],ld=["Relevant","Up to date","Accurate"];function ud({citationMetadata:t,noBottomBorder:e=!1,sourceFeedback:s,setSourceFeedback:a}){const[i,l]=y.useMemo(()=>{if(t.type!=="file")return["",""];const g=t.name.split(".");return g.length>1?[g.slice(0,-1).join("."),g[g.length-1]]:[t.name,""]},[t]),h=y.useMemo(()=>Hs(_s.GDRIVE,l),[l]),u=y.useMemo(()=>{if(t.type==="file"&&t.extra?.cloud_doc_url)try{return new URL(t.extra.cloud_doc_url).hostname}catch{return}},[t]),p=y.useCallback(g=>{a({rating:g,tags:[]})},[a]);return t.type!=="file"?null:o.jsxs(o.Fragment,{children:[o.jsxs("div",{className:"flex flex-row items-center justify-between py-2",children:[o.jsxs("div",{className:"max-width-full mr-2 flex grow flex-row items-center overflow-hidden",children:[o.jsx(h,{className:"mr-2 flex-shrink-0 flex-grow-0"}),o.jsx("a",{href:t.extra?.cloud_doc_url,className:"text-token-primary flex-grow-1 flex-shrink-1 overflow-hidden text-ellipsis whitespace-nowrap text-sm",target:"_blank",rel:"noreferrer",children:i}),u&&o.jsx("div",{className:"ml-2 text-sm text-token-text-secondary",children:u})]}),o.jsxs("div",{className:"flex shrink-0 flex-row items-center",children:[o.jsx("button",{className:"rounded-md p-1 hover:bg-token-main-surface-secondary",children:s?.rating==="thumbsUp"?o.jsx(tr,{className:"icon-md-heavy text-token-text-primary",onClick:()=>p(void 0)}):o.jsx(bc,{className:"icon-md-heavy text-token-text-secondary",onClick:()=>p("thumbsUp")})}),o.jsx("button",{className:"rounded-md p-1 hover:bg-token-main-surface-secondary",children:s?.rating==="thumbsDown"?o.jsx(nr,{className:"icon-md-heavy text-token-text-primary",onClick:()=>p(void 0)}):o.jsx(Cc,{className:"icon-md-heavy text-token-text-secondary",onClick:()=>p("thumbsDown")})})]})]}),s?.rating&&o.jsx("div",{className:"mb-4 flex flex-row",children:(s.rating==="thumbsDown"?cd:ld).map(g=>o.jsx(Hc,{className:"mr-2",$selected:s.tags.includes(g),onClick:()=>a({...s,tags:s.tags.includes(g)?s.tags.filter(v=>v!==g):[...s.tags,g]}),children:g},g))}),!e&&o.jsx("div",{className:"w-full border-[0.5px] border-token-border-light"})]})}function dd({documentId:t,title:e,externalUrl:s,noBottomBorder:a=!1,shouldHaveBeenIncluded:i,setShouldHaveBeenIncluded:l}){const[h,u]=y.useMemo(()=>{const v=e.split(".");return v.length>1?[v.slice(0,-1).join("."),v[v.length-1]]:[e,""]},[e]),p=y.useMemo(()=>Hs(_s.GDRIVE,u),[u]),g=y.useMemo(()=>{if(s)try{return new URL(s).hostname}catch{return}},[s]);return o.jsxs(o.Fragment,{children:[o.jsxs("div",{className:"flex flex-row items-center justify-between py-2",children:[o.jsxs("div",{className:"max-width-full mr-2 flex grow flex-row items-center overflow-hidden",children:[o.jsx(p,{className:"mr-2 flex-shrink-0 flex-grow-0"}),o.jsx("a",{href:s,className:"text-token-primary flex-grow-1 flex-shrink-1 overflow-hidden text-ellipsis whitespace-nowrap text-sm",target:"_blank",rel:"noreferrer",children:h}),g&&o.jsx("div",{className:"ml-2 text-sm text-token-text-secondary",children:g})]}),o.jsx("div",{className:"flex shrink-0 flex-row items-center px-2",children:o.jsx(zs,{checked:i,onChange:v=>l?.(v.currentTarget.checked),id:`should-have-been-included-${t}`})})]}),!a&&o.jsx("div",{className:"w-full border-[0.5px] border-token-border-light"})]})}const hd=["Not relevant","Missing sources","Inaccurate information","I don't like it","Don't like the style","Content is wrong","Model being lazy","Used the wrong tool","Should't have used Browser","Used an incorrect fact about me","Didn't follow instructions","Other"],fd=["Good sources","Answered my question","I like it","Other"],md="considered-source-should-have-been-used";function pd({citations:t,rating:e,onSubmit:s,onCancel:a,messageId:i,conversationId:l,nodeId:h,conversationTree:u}){const p=ye(),g=un(),[v,w]=y.useState(""),[f,x]=y.useState(()=>{const I={};for(const T of t)T.metadata?.type==="file"&&(I[T.metadata.id]={rating:void 0,tags:[],url:T.metadata.extra?.cloud_doc_url});return I}),b=y.useMemo(()=>{const I=new Set,T=[];for(const A of t)!A.metadata||A.metadata.type!=="file"||I.has(A.metadata.id)||(T.push(A.metadata),I.add(A.metadata.id));return T},[t]),[S,E]=y.useState(!0),B=y.useMemo(()=>{const I={hasQuery:!1,lastAssistantMessage:null,lastUserMessage:null,referencedSyncedFiles:[]};if(!u||!h||!u.containsNodeOrMessageId(h))return I;const T=bi(u,{messageId:h,entireConversation:!0});for(const A of T.messages)switch(A.type){case"fetch":case"generic_file_search_tool":case"system":continue;case"result":{A.result.chunks.forEach(F=>{F.documentId&&F.documentId.startsWith("S")&&!I.referencedSyncedFiles.some(L=>L.fileId===F.documentId)&&!b.some(L=>L.type==="file"&&L.id===F.documentId)&&I.referencedSyncedFiles.push({fileId:F.documentId,title:F.title})});continue}case"query":{I.hasQuery=!0;continue}case"visible_text":{if(A.author===Ie.User){if(!I.lastUserMessage){const F=u.getConversationTurns(A.id),L=F[F.length-1].messages,P=L[L.length-1];I.lastUserMessage=P}}else if(A.author===Ie.Assistant&&!I.lastAssistantMessage){const F=u.getConversationTurns(A.id),L=F[F.length-1].messages,P=L[L.length-1];I.lastAssistantMessage=P,I.lastUserMessage=null}continue}}return I},[u,b,h]),D=y.useCallback(async I=>{const T={...I,additionalSources:v,sourcesFeedback:f,consentedToShareConvoLink:S};Fe.submitCaMessageFeedback({feedback_format:sn.ALPHA,message_id:i,conversation_id:l,text:T.textFeedback,rating:e,tags:T.tags,tag_choices:T.tagChoices,additional_sources:T.additionalSources,sources_feedback:T.sourcesFeedback,consented_to_share_convo_link:T.consentedToShareConvoLink}),g.success("Thanks for providing feedback!"),s?.(T)},[v,f,S,i,l,e,g,s]);return o.jsxs(zc,{multiple:!0,allowEmptySubmit:!0,onSubmit:D,onCancel:a,tagOptions:(e==="thumbsDown"?hd:fd).map(I=>({label:I,value:I})),modalOnly:!0,modalTitle:o.jsxs("div",{className:"flex items-center gap-2",children:[e==="thumbsDown"?o.jsx(nr,{className:"mb-[-6px]"}):o.jsx(tr,{className:"mb-[-6px]"}),o.jsx(R,{id:"h5nasL",defaultMessage:"Provide feedback"})]}),children:[b.length>0&&o.jsxs(o.Fragment,{children:[o.jsx("h3",{className:"mt-6 text-base font-semibold",children:o.jsx(R,{id:"G6+7UX",defaultMessage:"Sources"})}),o.jsx("div",{children:b.map((I,T)=>I?.type!=="file"?null:o.jsx(ud,{citationMetadata:I,noBottomBorder:T===b.length-1,sourceFeedback:f[I.id],setSourceFeedback:A=>x(F=>({...F,[I.id]:{...A,url:I.extra?.cloud_doc_url}}))},I.id))})]}),B.referencedSyncedFiles.length>0&&o.jsxs(o.Fragment,{children:[o.jsxs("div",{className:"mt-6 flex items-baseline justify-between",children:[o.jsxs("div",{className:"flex-start flex",children:[o.jsx("h3",{className:"text-base font-semibold",children:o.jsx(R,{id:"xvBe/T",defaultMessage:"Considered Sources"})}),o.jsx("p",{className:"ml-2 text-token-text-secondary",children:o.jsx(R,{id:"nX81fN",defaultMessage:"({numSources} sources)",values:{numSources:B.referencedSyncedFiles.length}})})]}),o.jsx("p",{className:"text-sm text-token-text-tertiary",children:o.jsx(R,{id:"0+Uivl",defaultMessage:"Good Source?"})})]}),o.jsx("div",{className:"mt-2 max-h-[200px] overflow-auto",children:B.referencedSyncedFiles.map((I,T)=>{const A=I.fileId.split("--")[1];if(!A)return null;const F=`https://drive.google.com/file/d/${A}`;return o.jsx(dd,{title:I.title,documentId:I.fileId,externalUrl:F,noBottomBorder:T===B.referencedSyncedFiles.length-1,shouldHaveBeenIncluded:!!f[I.fileId],setShouldHaveBeenIncluded:L=>x(P=>{const G={...Object.fromEntries(Object.entries(P).filter(([H])=>H!==I.fileId))};return L&&(G[I.fileId]={tags:[md],rating:"thumbsUp",url:F}),G})},I.fileId)})})]}),o.jsxs("div",{className:"mt-6",children:[o.jsx("p",{className:"text-sm text-token-text-primary",children:o.jsx(R,{id:"1ApJVo",defaultMessage:"Add any additional sources"})}),o.jsx(Ci,{name:"feedback",className:"mt-2",placeholder:p.formatMessage({id:"CAFeedbackModal.additionalSourcePlaceholder",defaultMessage:"(Optional) Additional sources"}),value:v,onChange:I=>w(I.target.value)})]}),o.jsxs("div",{className:"mt-6",children:[o.jsx("h3",{className:"mb-2 text-base font-semibold",children:o.jsx(R,{id:"9NcQBu",defaultMessage:"Latest Exchange"})}),o.jsx("div",{className:"p-2",children:o.jsxs("div",{className:"mb-4",children:[B.lastUserMessage&&o.jsxs("div",{className:"mb-4",children:[o.jsx("p",{className:"mb-1 pl-4 text-xs text-token-text-secondary",children:o.jsx(R,{id:"QTWrtR",defaultMessage:"Your message"})}),o.jsx("div",{className:"flex justify-start",children:o.jsx("p",{className:"relative max-w-[70%] rounded-3xl bg-[#f4f4f4] px-5 py-2.5 dark:bg-token-main-surface-secondary",children:B.lastUserMessage?o.jsx(Vn,{message:B.lastUserMessage,isCompletionInProgress:!1,clientThreadId:l,isUserTurn:!1,turnIndex:0,isFeedbackEnabled:!1,showEditButton:!1,onEnterEdit:()=>null,onRequestMoreCompletions:()=>null}):null})})]}),o.jsxs("div",{className:"mb-2",children:[o.jsx("p",{className:"mb-1 pl-4 text-xs text-token-text-secondary",children:o.jsx(R,{id:"ZCTm4h",defaultMessage:"ChatGPT's response"})}),o.jsx("div",{className:"relative rounded-lg bg-token-main-surface-secondary p-4 text-sm",children:B.lastAssistantMessage?o.jsx(Vn,{message:B.lastAssistantMessage,isCompletionInProgress:!1,clientThreadId:l,isUserTurn:!1,turnIndex:1,isFeedbackEnabled:!1,showEditButton:!1,onEnterEdit:()=>null,onRequestMoreCompletions:()=>null}):null})]})]})}),o.jsxs("div",{className:"mt-4",children:[o.jsx("h3",{className:"mt-6 text-base font-semibold",children:o.jsx(R,{id:"c95uEW",defaultMessage:"Full conversation"})}),o.jsx("p",{className:"mb-2 mt-1 text-sm text-token-text-secondary",children:o.jsx(R,{id:"3E3ZSm",defaultMessage:"If previous portions of this conversation are important to understand your feedback, we encourage you to include it."})}),o.jsx(zs,{id:"consented-to-share-entire-convo",label:p.formatMessage({id:"5CC8r8",defaultMessage:"Share Entire Conversation"}),checked:S,onChange:I=>{E(I.currentTarget.checked)}})]})]})]})}const gd=Ye(()=>He(()=>import("./sso-i9n8wk17y9r2hc8j.js").then(t=>t.C),__vite__mapDeps([42,1,2,3,5,6,27,8,43,26,44,45,46,47,48,49,50,18,51,21,28,52,53,54,55,22,23,56,57,58,59,15,60,61,62,25,7,35,12,63,64,19,20,65,66,29,67,68,69,70,71,72,73,74,75,76,77,78,79])).then(t=>t.CADogfoodingFeedbackModal).catch(()=>()=>null));function xd(t){const e=Si();if(!e)return null;switch(e){case sn.ALPHA:return o.jsx(pd,{...t});case sn.DOGFOODING:return o.jsx(gd,{...t})}}function yd(t){return t==null||[Ee.PrimaryAssistant,Ee.GizmoInteraction].includes(t.kind)}function Wh(t,e){const s=wn(t,e),{data:a}=pr(s!=null&&"gizmo_id"in s?s.gizmo_id:void 0,s?.kind===Ee.GizmoTest);if(s!=null)switch(s.kind){case Ee.GizmoInteraction:case Ee.GizmoMagicCreate:case Ee.GizmoTest:return{gizmo:a,...s};case Ee.PrimaryAssistant:return s}}function _d(t,e,s){const i=j.getTree(e).getMessageId(j.getThreadCurrentLeafId(e));Fe.generateTitle(e,i,s).then(({title:l})=>{j.setTitle(e,l,gr.Generated),ar(t),O.logEvent(U.renameThread,{threadId:e,content:l,model:s})})}function vd(t,e,s){const a=()=>{const l=qn(s);t(l)},i=Et.getGizmoId(s);i!=null?Ac(e,i).then(l=>{Ii(qn(s,l))}).catch(l=>{Ce.addError(l),a()}):a()}const ts={onCreate(t,e,s,a){O.logEvent(U.newThread),!a&&yd(Et.getConversationMode(e))&&co(s).then(i=>{hn(i)||(ar(s),t(e))})},onCreateFinished(t,e,s){if(!(s||!e)&&!ue.checkGate("2562876640")){const a=Et.getThread(e)?.initialThreadData.lastModelUsed;a==null&&Ce.addError("missing lastModelUsed on conversation create finished"),_d(t,e,a)}}};function ns(t,e){t.updateNodeMetadata(e.id,{completionSampleFinishTime:Date.now()})}class wd{constructor(e,s,a,i,l,h,u,p,g,v,w,f){this.queryClient=e,this.clientThreadId=s,this.targetNodeId=a,this.completionType=i,this.model=l,this.eventSource=h,this.onCreate=u,this.callModelAgain=g,this.onCompletionFinished=v,this.isHistoryAndTrainingDisabled=f,this.currentTree=j.getTree(s),this.currentNodeId=a,this.activeBranchLastMessage=this.currentTree.getMessage(this.currentNodeId),this.completionLatencyTracker=new Ei(p),this.turnTracker=w,this.turnTracker.onCompletionStarted(i,this.model)}currentTree;currentNodeId;firstResponse=!0;didCreateFirstCompletionInNewThread=!1;activeBranchLastMessage;messagesToUpdate={};allIncompleteStreamedMessages={};responseThreadId;isCompletionBlocked=!1;isEitherFlagged=!1;variantsInStreamInfo;activeBranchNodeId;blurDuringCompletionTracker=new ki;completionLatencyTracker;turnTracker;debouncedUpdateCompletion=Ti(()=>{this.isCompletionBlocked||j.updateTree(this.clientThreadId,e=>{Object.values(this.messagesToUpdate).forEach(s=>{e.updateNodeMessage(s.id,s)})}),this.messagesToUpdate={}},50,{leading:!0,maxWait:50});handleResponse=async e=>{if(e.type!=="done"&&this.turnTracker.onUpdateEventCount(),this.completionLatencyTracker.onResponse(e,this.activeBranchLastMessage,this.responseThreadId),this.responseThreadId===void 0&&"conversationId"in e){const s=e.conversationId;this.responseThreadId=s,Bt(this.clientThreadId)&&j.getServerThreadId(this.clientThreadId)!==s&&(j.setServerIdForNewThread(this.clientThreadId,s),O.logEvent(U.attributeClientThreadToServerThread,{client_thread_id:this.clientThreadId,server_thread_id:s}))}switch(e.type){case"error":this.handleError(e);break;case"num_variants_in_stream":this.bindVariantInfoToTree(e);break;case"moderation":this.handleModeration(e);break;case"url_moderation":this.handleUrlModeration(e);break;case"message":this.handleMessage(e),this.debouncedUpdateCompletion();break;case"done":this.handleDone();break;case"gizmo_inline_review":this.handleGizmoInlineReview(e);break;case"title_generation":this.handleTitleGeneration(e);break;case"conversation_detail_metadata":this.handleConversationDetailMetadata(e);break}};handleError(e){const s=e.error,a=s?.message||"Something went wrong",i=s instanceof ve&&s.code||"",l=s instanceof ve&&s.status,h=s instanceof ve?s.detail?.can_retry:void 0;switch(this.turnTracker.handleRawError(a,l),j.updateTree(this.clientThreadId,u=>{u.updateNodeMessage(this.currentNodeId,this.activeBranchLastMessage),u.updateNodeMetadata(this.currentNodeId,{err:a,errType:"danger",errCode:i,completionSampleFinishTime:Date.now(),canRetry:h})}),i){case Be.ContentPolicy:case Be.ContentOrTos:case tn:case cs:break;default:a!==void 0&&ue.logEvent("chatgpt_conversation_error_web",a)}if(this.blurDuringCompletionTracker.onMessageError(),this.cleanUp(),this.onCompletionFinished(this.responseThreadId),s instanceof ve&&s.code===tn){const u=s.detail?.clears_in;u&&(Mi(new Date(Date.now()+u*1e3).toISOString()),setTimeout(()=>{ji()},u*1e3))}}handleGizmoInlineReview(e){j.setPromptGptRating(this.clientThreadId,e.gizmoId)}handleTitleGeneration(e){j.setTitle(this.clientThreadId,e.title,gr.Generated)}handleConversationDetailMetadata(e){const{default_model_slug:s}=e;s&&j.setThreadModelId(this.clientThreadId,s),Zt.updateDetails(e)}bindVariantInfoToTree(e){this.variantsInStreamInfo=e,j.updateTree(this.clientThreadId,s=>{const a=s.getParentPromptNode(this.currentNodeId);s.updateNodeMetadata(a.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}handleModeration(e){const{isCompletion:s,messageId:a,conversationId:i,flagged:l,blocked:h,disclaimers:u,metadata:p}=e,g=!!u?.length&&s;(l||h||g)&&(this.isEitherFlagged=!0,h&&s&&(this.isCompletionBlocked=!0),j.updateTree(this.clientThreadId,v=>{const w=v.messageIdToNodeId(a);h&&v.clearNodeMessageParts(w),v.updateNodeMetadata(w,{...(g&&!!u?.length&&Ri(u,h))??{},...l&&Ai,...h&&(p?.model_incompatibility?Ni:Bi),completionSampleFinishTime:Date.now()})}),O.logEvent(s?h?U.completionBlockedByModeration:U.completionFlaggedByModeration:h?U.promptBlockedByModeration:U.promptFlaggedByModeration,{threadId:i,id:a}))}handleUrlModeration(e){const{conversationId:s,url:a,isSafe:i}=e;i&&j.addThreadSafeUrl(s,a)}handleMessage(e){let s=!0;const{message:a,conversationId:i}=e;if(this.turnTracker.onMessageUpdate(a.metadata?.model_slug,a.metadata?.gizmo_id,a.author.name,a.author.role),this.firstResponse&&!this.currentTree.hasReceivedServerCompletion){if(this.currentTree.hasNodeOrMessageId(a.id))return a?.author.role!==Ie.User?void 0:j.updateTree(this.clientThreadId,l=>{l.updateNodeMessage(a.id,a)});if(a.author.role===Ie.User&&a.content.content_type===Tn.UserEditableContext)return;if((a?.author.role===Ie.System||a?.author.role===Ie.Developer)&&(a.metadata?.parent_id?this.currentTree.getNodeByIdOrMessageId(a.metadata.parent_id):void 0)?.message.author.role!==Ie.User){this.currentTree.appendSystemMessageToRoot(a);return}}if(this.firstResponse&&a.metadata?.rebase_system_message){j.updateTree(this.clientThreadId,l=>{if(a.metadata?.parent_id==null)throw Error("Unexpected rebased system message without parent");const h=l.getNodeByIdOrMessageId(this.targetNodeId);l.deleteNode(this.targetNodeId),l.addNode(a.id,a,a.metadata.parent_id,a.author.role),l.addNode(h.id,h.message,a.id,h.message.author.role)});return}if(this.firstResponse){const l=It.getState().threads[this.clientThreadId]?.continuingFromSharedConversationId!=null;j.removeContinuingFromSharedConversationId(this.clientThreadId),this.firstResponse=!1,this.didCreateFirstCompletionInNewThread=!this.currentTree.hasReceivedServerCompletion||l,j.updateTree(this.clientThreadId,u=>{u.updateNodeMessage(this.currentNodeId,a)}),this.didCreateFirstCompletionInNewThread&&ts.onCreate(this.onCreate,i,this.queryClient,this.isHistoryAndTrainingDisabled);const h={id:this.targetNodeId,threadId:i,completionType:this.completionType,eventSource:this.eventSource,model:this.model};if(this.completionType===st.Next){const u=It.getState().threads[i],p=u?.conversationTurns?.length,g=u?.conversationTurns?.filter(w=>w.role==Ie.User),v=g&&g[g.length-1]?.messages[0].message;if(v?.content.content_type==Tn.Text){const w=v.content.parts.join("").length,f=g?.length??0;h.countConversationTurns=p,h.countUserSubmittedMessages=f,h.countLastUserPromptTextMessageLength=w}}O.logEvent(U.generateCompletion,h)}else if(this.completionType!==st.Continue){const l=this.currentTree.containsNodeOrMessageId(a.id),h=a.metadata?.parent_id;if(l||(this.debouncedUpdateCompletion.flush(),j.updateTree(this.clientThreadId,u=>{if(h==null)throw new Error(`Received a message with no parentId: ${JSON.stringify(a)}`);u.addNode(a.id,a,h,Ie.Assistant)})),h!=null&&h===this.activeBranchNodeId){const u=this.allIncompleteStreamedMessages[h];u!=null&&(j.updateTree(this.clientThreadId,p=>{ns(p,u)}),delete this.allIncompleteStreamedMessages[h])}if(s=(this.variantsInStreamInfo?.num_variants_in_stream??1)===1||this.activeBranchNodeId==null||this.activeBranchNodeId===a.id||this.currentTree.isAncestorOfNode(this.activeBranchNodeId,a.id),s&&this.activeBranchNodeId!==a.id){this.activeBranchNodeId=a.id,this.currentNodeId=a.id;const u=j.getThreadCurrentLeafId(this.clientThreadId);this.currentTree.messageIdToNodeId(this.currentNodeId)!==this.currentTree.messageIdToNodeId(u)&&j.setThreadCurrentLeafId(this.clientThreadId,this.currentNodeId),h!=null&&j.updateTree(this.clientThreadId,p=>{const g=p.getParentPromptNode(a.id);p.updateNodeMetadata(g.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}}if(a?.author.role===Ie.Tool&&a?.author.name==="bio"){const l=a.metadata?.gizmo_id;setTimeout(()=>{this.queryClient.invalidateQueries({queryKey:Fi(l)})},5e3)}s&&(this.activeBranchLastMessage=a),this.messagesToUpdate[a.id]=a,this.allIncompleteStreamedMessages[a.id]=a}async handleDone(){if(this.turnTracker.model_message_update_count>0?this.turnTracker.logCompletion({type:St.Success}):this.turnTracker.logCompletion({type:St.Error,error:{reason:"empty_response",message:"Successful completion ended with no messages"}}),this.isCompletionBlocked||(this.debouncedUpdateCompletion.flush(),this.isEitherFlagged||(this.didCreateFirstCompletionInNewThread&&ts.onCreateFinished(this.queryClient,this.responseThreadId,this.isHistoryAndTrainingDisabled),this.onCompletionFinished(this.responseThreadId))),j.updateTree(this.clientThreadId,e=>{Object.values(this.allIncompleteStreamedMessages).forEach(s=>{ns(e,s)})}),Vs.publish({kind:"createConversation",clientThreadId:this.clientThreadId}),this.blurDuringCompletionTracker.onMessageDone(),this.cleanUp(),this.activeBranchLastMessage?.metadata?.client_actions!==void 0){const e=await Di(this.clientThreadId,this.activeBranchLastMessage);e.length>0&&this.callModelAgain(this.currentNodeId,e)}}cleanUp(){setTimeout(()=>{ir(this.clientThreadId,{source:vs.CLIENT,value:ws.UNREAD}),_n.removeRequest(this.targetNodeId),j.releaseThread(this.clientThreadId)},0)}}/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(t){const e=Pi,s=Oi,a=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;t.Buffer=u,t.SlowBuffer=D,t.INSPECT_MAX_BYTES=50;const i=2147483647;t.kMaxLength=i,u.TYPED_ARRAY_SUPPORT=l(),!u.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function l(){try{const c=new Uint8Array(1),n={foo:function(){return 42}};return Object.setPrototypeOf(n,Uint8Array.prototype),Object.setPrototypeOf(c,n),c.foo()===42}catch{return!1}}Object.defineProperty(u.prototype,"parent",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.buffer}}),Object.defineProperty(u.prototype,"offset",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.byteOffset}});function h(c){if(c>i)throw new RangeError('The value "'+c+'" is invalid for option "size"');const n=new Uint8Array(c);return Object.setPrototypeOf(n,u.prototype),n}function u(c,n,r){if(typeof c=="number"){if(typeof n=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return w(c)}return p(c,n,r)}u.poolSize=8192;function p(c,n,r){if(typeof c=="string")return f(c,n);if(ArrayBuffer.isView(c))return b(c);if(c==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof c);if(Ne(c,ArrayBuffer)||c&&Ne(c.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(Ne(c,SharedArrayBuffer)||c&&Ne(c.buffer,SharedArrayBuffer)))return S(c,n,r);if(typeof c=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const d=c.valueOf&&c.valueOf();if(d!=null&&d!==c)return u.from(d,n,r);const m=E(c);if(m)return m;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof c[Symbol.toPrimitive]=="function")return u.from(c[Symbol.toPrimitive]("string"),n,r);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof c)}u.from=function(c,n,r){return p(c,n,r)},Object.setPrototypeOf(u.prototype,Uint8Array.prototype),Object.setPrototypeOf(u,Uint8Array);function g(c){if(typeof c!="number")throw new TypeError('"size" argument must be of type number');if(c<0)throw new RangeError('The value "'+c+'" is invalid for option "size"')}function v(c,n,r){return g(c),c<=0?h(c):n!==void 0?typeof r=="string"?h(c).fill(n,r):h(c).fill(n):h(c)}u.alloc=function(c,n,r){return v(c,n,r)};function w(c){return g(c),h(c<0?0:B(c)|0)}u.allocUnsafe=function(c){return w(c)},u.allocUnsafeSlow=function(c){return w(c)};function f(c,n){if((typeof n!="string"||n==="")&&(n="utf8"),!u.isEncoding(n))throw new TypeError("Unknown encoding: "+n);const r=I(c,n)|0;let d=h(r);const m=d.write(c,n);return m!==r&&(d=d.slice(0,m)),d}function x(c){const n=c.length<0?0:B(c.length)|0,r=h(n);for(let d=0;d<n;d+=1)r[d]=c[d]&255;return r}function b(c){if(Ne(c,Uint8Array)){const n=new Uint8Array(c);return S(n.buffer,n.byteOffset,n.byteLength)}return x(c)}function S(c,n,r){if(n<0||c.byteLength<n)throw new RangeError('"offset" is outside of buffer bounds');if(c.byteLength<n+(r||0))throw new RangeError('"length" is outside of buffer bounds');let d;return n===void 0&&r===void 0?d=new Uint8Array(c):r===void 0?d=new Uint8Array(c,n):d=new Uint8Array(c,n,r),Object.setPrototypeOf(d,u.prototype),d}function E(c){if(u.isBuffer(c)){const n=B(c.length)|0,r=h(n);return r.length===0||c.copy(r,0,0,n),r}if(c.length!==void 0)return typeof c.length!="number"||Pt(c.length)?h(0):x(c);if(c.type==="Buffer"&&Array.isArray(c.data))return x(c.data)}function B(c){if(c>=i)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+i.toString(16)+" bytes");return c|0}function D(c){return+c!=c&&(c=0),u.alloc(+c)}u.isBuffer=function(n){return n!=null&&n._isBuffer===!0&&n!==u.prototype},u.compare=function(n,r){if(Ne(n,Uint8Array)&&(n=u.from(n,n.offset,n.byteLength)),Ne(r,Uint8Array)&&(r=u.from(r,r.offset,r.byteLength)),!u.isBuffer(n)||!u.isBuffer(r))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(n===r)return 0;let d=n.length,m=r.length;for(let _=0,C=Math.min(d,m);_<C;++_)if(n[_]!==r[_]){d=n[_],m=r[_];break}return d<m?-1:m<d?1:0},u.isEncoding=function(n){switch(String(n).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},u.concat=function(n,r){if(!Array.isArray(n))throw new TypeError('"list" argument must be an Array of Buffers');if(n.length===0)return u.alloc(0);let d;if(r===void 0)for(r=0,d=0;d<n.length;++d)r+=n[d].length;const m=u.allocUnsafe(r);let _=0;for(d=0;d<n.length;++d){let C=n[d];if(Ne(C,Uint8Array))_+C.length>m.length?(u.isBuffer(C)||(C=u.from(C)),C.copy(m,_)):Uint8Array.prototype.set.call(m,C,_);else if(u.isBuffer(C))C.copy(m,_);else throw new TypeError('"list" argument must be an Array of Buffers');_+=C.length}return m};function I(c,n){if(u.isBuffer(c))return c.length;if(ArrayBuffer.isView(c)||Ne(c,ArrayBuffer))return c.byteLength;if(typeof c!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof c);const r=c.length,d=arguments.length>2&&arguments[2]===!0;if(!d&&r===0)return 0;let m=!1;for(;;)switch(n){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":return Ae(c).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return r*2;case"hex":return r>>>1;case"base64":return kn(c).length;default:if(m)return d?-1:Ae(c).length;n=(""+n).toLowerCase(),m=!0}}u.byteLength=I;function T(c,n,r){let d=!1;if((n===void 0||n<0)&&(n=0),n>this.length||((r===void 0||r>this.length)&&(r=this.length),r<=0)||(r>>>=0,n>>>=0,r<=n))return"";for(c||(c="utf8");;)switch(c){case"hex":return K(this,n,r);case"utf8":case"utf-8":return V(this,n,r);case"ascii":return N(this,n,r);case"latin1":case"binary":return Y(this,n,r);case"base64":return W(this,n,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ce(this,n,r);default:if(d)throw new TypeError("Unknown encoding: "+c);c=(c+"").toLowerCase(),d=!0}}u.prototype._isBuffer=!0;function A(c,n,r){const d=c[n];c[n]=c[r],c[r]=d}u.prototype.swap16=function(){const n=this.length;if(n%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let r=0;r<n;r+=2)A(this,r,r+1);return this},u.prototype.swap32=function(){const n=this.length;if(n%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let r=0;r<n;r+=4)A(this,r,r+3),A(this,r+1,r+2);return this},u.prototype.swap64=function(){const n=this.length;if(n%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let r=0;r<n;r+=8)A(this,r,r+7),A(this,r+1,r+6),A(this,r+2,r+5),A(this,r+3,r+4);return this},u.prototype.toString=function(){const n=this.length;return n===0?"":arguments.length===0?V(this,0,n):T.apply(this,arguments)},u.prototype.toLocaleString=u.prototype.toString,u.prototype.equals=function(n){if(!u.isBuffer(n))throw new TypeError("Argument must be a Buffer");return this===n?!0:u.compare(this,n)===0},u.prototype.inspect=function(){let n="";const r=t.INSPECT_MAX_BYTES;return n=this.toString("hex",0,r).replace(/(.{2})/g,"$1 ").trim(),this.length>r&&(n+=" ... "),"<Buffer "+n+">"},a&&(u.prototype[a]=u.prototype.inspect),u.prototype.compare=function(n,r,d,m,_){if(Ne(n,Uint8Array)&&(n=u.from(n,n.offset,n.byteLength)),!u.isBuffer(n))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof n);if(r===void 0&&(r=0),d===void 0&&(d=n?n.length:0),m===void 0&&(m=0),_===void 0&&(_=this.length),r<0||d>n.length||m<0||_>this.length)throw new RangeError("out of range index");if(m>=_&&r>=d)return 0;if(m>=_)return-1;if(r>=d)return 1;if(r>>>=0,d>>>=0,m>>>=0,_>>>=0,this===n)return 0;let C=_-m,$=d-r;const ae=Math.min(C,$),se=this.slice(m,_),ie=n.slice(r,d);for(let Z=0;Z<ae;++Z)if(se[Z]!==ie[Z]){C=se[Z],$=ie[Z];break}return C<$?-1:$<C?1:0};function F(c,n,r,d,m){if(c.length===0)return-1;if(typeof r=="string"?(d=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),r=+r,Pt(r)&&(r=m?0:c.length-1),r<0&&(r=c.length+r),r>=c.length){if(m)return-1;r=c.length-1}else if(r<0)if(m)r=0;else return-1;if(typeof n=="string"&&(n=u.from(n,d)),u.isBuffer(n))return n.length===0?-1:L(c,n,r,d,m);if(typeof n=="number")return n=n&255,typeof Uint8Array.prototype.indexOf=="function"?m?Uint8Array.prototype.indexOf.call(c,n,r):Uint8Array.prototype.lastIndexOf.call(c,n,r):L(c,[n],r,d,m);throw new TypeError("val must be string, number or Buffer")}function L(c,n,r,d,m){let _=1,C=c.length,$=n.length;if(d!==void 0&&(d=String(d).toLowerCase(),d==="ucs2"||d==="ucs-2"||d==="utf16le"||d==="utf-16le")){if(c.length<2||n.length<2)return-1;_=2,C/=2,$/=2,r/=2}function ae(ie,Z){return _===1?ie[Z]:ie.readUInt16BE(Z*_)}let se;if(m){let ie=-1;for(se=r;se<C;se++)if(ae(c,se)===ae(n,ie===-1?0:se-ie)){if(ie===-1&&(ie=se),se-ie+1===$)return ie*_}else ie!==-1&&(se-=se-ie),ie=-1}else for(r+$>C&&(r=C-$),se=r;se>=0;se--){let ie=!0;for(let Z=0;Z<$;Z++)if(ae(c,se+Z)!==ae(n,Z)){ie=!1;break}if(ie)return se}return-1}u.prototype.includes=function(n,r,d){return this.indexOf(n,r,d)!==-1},u.prototype.indexOf=function(n,r,d){return F(this,n,r,d,!0)},u.prototype.lastIndexOf=function(n,r,d){return F(this,n,r,d,!1)};function P(c,n,r,d){r=Number(r)||0;const m=c.length-r;d?(d=Number(d),d>m&&(d=m)):d=m;const _=n.length;d>_/2&&(d=_/2);let C;for(C=0;C<d;++C){const $=parseInt(n.substr(C*2,2),16);if(Pt($))return C;c[r+C]=$}return C}function G(c,n,r,d){return mt(Ae(n,c.length-r),c,r,d)}function H(c,n,r,d){return mt(Ur(n),c,r,d)}function z(c,n,r,d){return mt(kn(n),c,r,d)}function te(c,n,r,d){return mt(Lr(n,c.length-r),c,r,d)}u.prototype.write=function(n,r,d,m){if(r===void 0)m="utf8",d=this.length,r=0;else if(d===void 0&&typeof r=="string")m=r,d=this.length,r=0;else if(isFinite(r))r=r>>>0,isFinite(d)?(d=d>>>0,m===void 0&&(m="utf8")):(m=d,d=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const _=this.length-r;if((d===void 0||d>_)&&(d=_),n.length>0&&(d<0||r<0)||r>this.length)throw new RangeError("Attempt to write outside buffer bounds");m||(m="utf8");let C=!1;for(;;)switch(m){case"hex":return P(this,n,r,d);case"utf8":case"utf-8":return G(this,n,r,d);case"ascii":case"latin1":case"binary":return H(this,n,r,d);case"base64":return z(this,n,r,d);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return te(this,n,r,d);default:if(C)throw new TypeError("Unknown encoding: "+m);m=(""+m).toLowerCase(),C=!0}},u.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function W(c,n,r){return n===0&&r===c.length?e.fromByteArray(c):e.fromByteArray(c.slice(n,r))}function V(c,n,r){r=Math.min(c.length,r);const d=[];let m=n;for(;m<r;){const _=c[m];let C=null,$=_>239?4:_>223?3:_>191?2:1;if(m+$<=r){let ae,se,ie,Z;switch($){case 1:_<128&&(C=_);break;case 2:ae=c[m+1],(ae&192)===128&&(Z=(_&31)<<6|ae&63,Z>127&&(C=Z));break;case 3:ae=c[m+1],se=c[m+2],(ae&192)===128&&(se&192)===128&&(Z=(_&15)<<12|(ae&63)<<6|se&63,Z>2047&&(Z<55296||Z>57343)&&(C=Z));break;case 4:ae=c[m+1],se=c[m+2],ie=c[m+3],(ae&192)===128&&(se&192)===128&&(ie&192)===128&&(Z=(_&15)<<18|(ae&63)<<12|(se&63)<<6|ie&63,Z>65535&&Z<1114112&&(C=Z))}}C===null?(C=65533,$=1):C>65535&&(C-=65536,d.push(C>>>10&1023|55296),C=56320|C&1023),d.push(C),m+=$}return Q(d)}const X=4096;function Q(c){const n=c.length;if(n<=X)return String.fromCharCode.apply(String,c);let r="",d=0;for(;d<n;)r+=String.fromCharCode.apply(String,c.slice(d,d+=X));return r}function N(c,n,r){let d="";r=Math.min(c.length,r);for(let m=n;m<r;++m)d+=String.fromCharCode(c[m]&127);return d}function Y(c,n,r){let d="";r=Math.min(c.length,r);for(let m=n;m<r;++m)d+=String.fromCharCode(c[m]);return d}function K(c,n,r){const d=c.length;(!n||n<0)&&(n=0),(!r||r<0||r>d)&&(r=d);let m="";for(let _=n;_<r;++_)m+=Gr[c[_]];return m}function ce(c,n,r){const d=c.slice(n,r);let m="";for(let _=0;_<d.length-1;_+=2)m+=String.fromCharCode(d[_]+d[_+1]*256);return m}u.prototype.slice=function(n,r){const d=this.length;n=~~n,r=r===void 0?d:~~r,n<0?(n+=d,n<0&&(n=0)):n>d&&(n=d),r<0?(r+=d,r<0&&(r=0)):r>d&&(r=d),r<n&&(r=n);const m=this.subarray(n,r);return Object.setPrototypeOf(m,u.prototype),m};function M(c,n,r){if(c%1!==0||c<0)throw new RangeError("offset is not uint");if(c+n>r)throw new RangeError("Trying to access beyond buffer length")}u.prototype.readUintLE=u.prototype.readUIntLE=function(n,r,d){n=n>>>0,r=r>>>0,d||M(n,r,this.length);let m=this[n],_=1,C=0;for(;++C<r&&(_*=256);)m+=this[n+C]*_;return m},u.prototype.readUintBE=u.prototype.readUIntBE=function(n,r,d){n=n>>>0,r=r>>>0,d||M(n,r,this.length);let m=this[n+--r],_=1;for(;r>0&&(_*=256);)m+=this[n+--r]*_;return m},u.prototype.readUint8=u.prototype.readUInt8=function(n,r){return n=n>>>0,r||M(n,1,this.length),this[n]},u.prototype.readUint16LE=u.prototype.readUInt16LE=function(n,r){return n=n>>>0,r||M(n,2,this.length),this[n]|this[n+1]<<8},u.prototype.readUint16BE=u.prototype.readUInt16BE=function(n,r){return n=n>>>0,r||M(n,2,this.length),this[n]<<8|this[n+1]},u.prototype.readUint32LE=u.prototype.readUInt32LE=function(n,r){return n=n>>>0,r||M(n,4,this.length),(this[n]|this[n+1]<<8|this[n+2]<<16)+this[n+3]*16777216},u.prototype.readUint32BE=u.prototype.readUInt32BE=function(n,r){return n=n>>>0,r||M(n,4,this.length),this[n]*16777216+(this[n+1]<<16|this[n+2]<<8|this[n+3])},u.prototype.readBigUInt64LE=Le(function(n){n=n>>>0,Te(n,"offset");const r=this[n],d=this[n+7];(r===void 0||d===void 0)&&Se(n,this.length-8);const m=r+this[++n]*2**8+this[++n]*2**16+this[++n]*2**24,_=this[++n]+this[++n]*2**8+this[++n]*2**16+d*2**24;return BigInt(m)+(BigInt(_)<<BigInt(32))}),u.prototype.readBigUInt64BE=Le(function(n){n=n>>>0,Te(n,"offset");const r=this[n],d=this[n+7];(r===void 0||d===void 0)&&Se(n,this.length-8);const m=r*2**24+this[++n]*2**16+this[++n]*2**8+this[++n],_=this[++n]*2**24+this[++n]*2**16+this[++n]*2**8+d;return(BigInt(m)<<BigInt(32))+BigInt(_)}),u.prototype.readIntLE=function(n,r,d){n=n>>>0,r=r>>>0,d||M(n,r,this.length);let m=this[n],_=1,C=0;for(;++C<r&&(_*=256);)m+=this[n+C]*_;return _*=128,m>=_&&(m-=Math.pow(2,8*r)),m},u.prototype.readIntBE=function(n,r,d){n=n>>>0,r=r>>>0,d||M(n,r,this.length);let m=r,_=1,C=this[n+--m];for(;m>0&&(_*=256);)C+=this[n+--m]*_;return _*=128,C>=_&&(C-=Math.pow(2,8*r)),C},u.prototype.readInt8=function(n,r){return n=n>>>0,r||M(n,1,this.length),this[n]&128?(255-this[n]+1)*-1:this[n]},u.prototype.readInt16LE=function(n,r){n=n>>>0,r||M(n,2,this.length);const d=this[n]|this[n+1]<<8;return d&32768?d|4294901760:d},u.prototype.readInt16BE=function(n,r){n=n>>>0,r||M(n,2,this.length);const d=this[n+1]|this[n]<<8;return d&32768?d|4294901760:d},u.prototype.readInt32LE=function(n,r){return n=n>>>0,r||M(n,4,this.length),this[n]|this[n+1]<<8|this[n+2]<<16|this[n+3]<<24},u.prototype.readInt32BE=function(n,r){return n=n>>>0,r||M(n,4,this.length),this[n]<<24|this[n+1]<<16|this[n+2]<<8|this[n+3]},u.prototype.readBigInt64LE=Le(function(n){n=n>>>0,Te(n,"offset");const r=this[n],d=this[n+7];(r===void 0||d===void 0)&&Se(n,this.length-8);const m=this[n+4]+this[n+5]*2**8+this[n+6]*2**16+(d<<24);return(BigInt(m)<<BigInt(32))+BigInt(r+this[++n]*2**8+this[++n]*2**16+this[++n]*2**24)}),u.prototype.readBigInt64BE=Le(function(n){n=n>>>0,Te(n,"offset");const r=this[n],d=this[n+7];(r===void 0||d===void 0)&&Se(n,this.length-8);const m=(r<<24)+this[++n]*2**16+this[++n]*2**8+this[++n];return(BigInt(m)<<BigInt(32))+BigInt(this[++n]*2**24+this[++n]*2**16+this[++n]*2**8+d)}),u.prototype.readFloatLE=function(n,r){return n=n>>>0,r||M(n,4,this.length),s.read(this,n,!0,23,4)},u.prototype.readFloatBE=function(n,r){return n=n>>>0,r||M(n,4,this.length),s.read(this,n,!1,23,4)},u.prototype.readDoubleLE=function(n,r){return n=n>>>0,r||M(n,8,this.length),s.read(this,n,!0,52,8)},u.prototype.readDoubleBE=function(n,r){return n=n>>>0,r||M(n,8,this.length),s.read(this,n,!1,52,8)};function k(c,n,r,d,m,_){if(!u.isBuffer(c))throw new TypeError('"buffer" argument must be a Buffer instance');if(n>m||n<_)throw new RangeError('"value" argument is out of bounds');if(r+d>c.length)throw new RangeError("Index out of range")}u.prototype.writeUintLE=u.prototype.writeUIntLE=function(n,r,d,m){if(n=+n,r=r>>>0,d=d>>>0,!m){const $=Math.pow(2,8*d)-1;k(this,n,r,d,$,0)}let _=1,C=0;for(this[r]=n&255;++C<d&&(_*=256);)this[r+C]=n/_&255;return r+d},u.prototype.writeUintBE=u.prototype.writeUIntBE=function(n,r,d,m){if(n=+n,r=r>>>0,d=d>>>0,!m){const $=Math.pow(2,8*d)-1;k(this,n,r,d,$,0)}let _=d-1,C=1;for(this[r+_]=n&255;--_>=0&&(C*=256);)this[r+_]=n/C&255;return r+d},u.prototype.writeUint8=u.prototype.writeUInt8=function(n,r,d){return n=+n,r=r>>>0,d||k(this,n,r,1,255,0),this[r]=n&255,r+1},u.prototype.writeUint16LE=u.prototype.writeUInt16LE=function(n,r,d){return n=+n,r=r>>>0,d||k(this,n,r,2,65535,0),this[r]=n&255,this[r+1]=n>>>8,r+2},u.prototype.writeUint16BE=u.prototype.writeUInt16BE=function(n,r,d){return n=+n,r=r>>>0,d||k(this,n,r,2,65535,0),this[r]=n>>>8,this[r+1]=n&255,r+2},u.prototype.writeUint32LE=u.prototype.writeUInt32LE=function(n,r,d){return n=+n,r=r>>>0,d||k(this,n,r,4,4294967295,0),this[r+3]=n>>>24,this[r+2]=n>>>16,this[r+1]=n>>>8,this[r]=n&255,r+4},u.prototype.writeUint32BE=u.prototype.writeUInt32BE=function(n,r,d){return n=+n,r=r>>>0,d||k(this,n,r,4,4294967295,0),this[r]=n>>>24,this[r+1]=n>>>16,this[r+2]=n>>>8,this[r+3]=n&255,r+4};function le(c,n,r,d,m){Pe(n,d,m,c,r,7);let _=Number(n&BigInt(4294967295));c[r++]=_,_=_>>8,c[r++]=_,_=_>>8,c[r++]=_,_=_>>8,c[r++]=_;let C=Number(n>>BigInt(32)&BigInt(4294967295));return c[r++]=C,C=C>>8,c[r++]=C,C=C>>8,c[r++]=C,C=C>>8,c[r++]=C,r}function ge(c,n,r,d,m){Pe(n,d,m,c,r,7);let _=Number(n&BigInt(4294967295));c[r+7]=_,_=_>>8,c[r+6]=_,_=_>>8,c[r+5]=_,_=_>>8,c[r+4]=_;let C=Number(n>>BigInt(32)&BigInt(4294967295));return c[r+3]=C,C=C>>8,c[r+2]=C,C=C>>8,c[r+1]=C,C=C>>8,c[r]=C,r+8}u.prototype.writeBigUInt64LE=Le(function(n,r=0){return le(this,n,r,BigInt(0),BigInt("0xffffffffffffffff"))}),u.prototype.writeBigUInt64BE=Le(function(n,r=0){return ge(this,n,r,BigInt(0),BigInt("0xffffffffffffffff"))}),u.prototype.writeIntLE=function(n,r,d,m){if(n=+n,r=r>>>0,!m){const ae=Math.pow(2,8*d-1);k(this,n,r,d,ae-1,-ae)}let _=0,C=1,$=0;for(this[r]=n&255;++_<d&&(C*=256);)n<0&&$===0&&this[r+_-1]!==0&&($=1),this[r+_]=(n/C>>0)-$&255;return r+d},u.prototype.writeIntBE=function(n,r,d,m){if(n=+n,r=r>>>0,!m){const ae=Math.pow(2,8*d-1);k(this,n,r,d,ae-1,-ae)}let _=d-1,C=1,$=0;for(this[r+_]=n&255;--_>=0&&(C*=256);)n<0&&$===0&&this[r+_+1]!==0&&($=1),this[r+_]=(n/C>>0)-$&255;return r+d},u.prototype.writeInt8=function(n,r,d){return n=+n,r=r>>>0,d||k(this,n,r,1,127,-128),n<0&&(n=255+n+1),this[r]=n&255,r+1},u.prototype.writeInt16LE=function(n,r,d){return n=+n,r=r>>>0,d||k(this,n,r,2,32767,-32768),this[r]=n&255,this[r+1]=n>>>8,r+2},u.prototype.writeInt16BE=function(n,r,d){return n=+n,r=r>>>0,d||k(this,n,r,2,32767,-32768),this[r]=n>>>8,this[r+1]=n&255,r+2},u.prototype.writeInt32LE=function(n,r,d){return n=+n,r=r>>>0,d||k(this,n,r,4,2147483647,-2147483648),this[r]=n&255,this[r+1]=n>>>8,this[r+2]=n>>>16,this[r+3]=n>>>24,r+4},u.prototype.writeInt32BE=function(n,r,d){return n=+n,r=r>>>0,d||k(this,n,r,4,2147483647,-2147483648),n<0&&(n=4294967295+n+1),this[r]=n>>>24,this[r+1]=n>>>16,this[r+2]=n>>>8,this[r+3]=n&255,r+4},u.prototype.writeBigInt64LE=Le(function(n,r=0){return le(this,n,r,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),u.prototype.writeBigInt64BE=Le(function(n,r=0){return ge(this,n,r,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function Re(c,n,r,d,m,_){if(r+d>c.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function q(c,n,r,d,m){return n=+n,r=r>>>0,m||Re(c,n,r,4),s.write(c,n,r,d,23,4),r+4}u.prototype.writeFloatLE=function(n,r,d){return q(this,n,r,!0,d)},u.prototype.writeFloatBE=function(n,r,d){return q(this,n,r,!1,d)};function ee(c,n,r,d,m){return n=+n,r=r>>>0,m||Re(c,n,r,8),s.write(c,n,r,d,52,8),r+8}u.prototype.writeDoubleLE=function(n,r,d){return ee(this,n,r,!0,d)},u.prototype.writeDoubleBE=function(n,r,d){return ee(this,n,r,!1,d)},u.prototype.copy=function(n,r,d,m){if(!u.isBuffer(n))throw new TypeError("argument should be a Buffer");if(d||(d=0),!m&&m!==0&&(m=this.length),r>=n.length&&(r=n.length),r||(r=0),m>0&&m<d&&(m=d),m===d||n.length===0||this.length===0)return 0;if(r<0)throw new RangeError("targetStart out of bounds");if(d<0||d>=this.length)throw new RangeError("Index out of range");if(m<0)throw new RangeError("sourceEnd out of bounds");m>this.length&&(m=this.length),n.length-r<m-d&&(m=n.length-r+d);const _=m-d;return this===n&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(r,d,m):Uint8Array.prototype.set.call(n,this.subarray(d,m),r),_},u.prototype.fill=function(n,r,d,m){if(typeof n=="string"){if(typeof r=="string"?(m=r,r=0,d=this.length):typeof d=="string"&&(m=d,d=this.length),m!==void 0&&typeof m!="string")throw new TypeError("encoding must be a string");if(typeof m=="string"&&!u.isEncoding(m))throw new TypeError("Unknown encoding: "+m);if(n.length===1){const C=n.charCodeAt(0);(m==="utf8"&&C<128||m==="latin1")&&(n=C)}}else typeof n=="number"?n=n&255:typeof n=="boolean"&&(n=Number(n));if(r<0||this.length<r||this.length<d)throw new RangeError("Out of range index");if(d<=r)return this;r=r>>>0,d=d===void 0?this.length:d>>>0,n||(n=0);let _;if(typeof n=="number")for(_=r;_<d;++_)this[_]=n;else{const C=u.isBuffer(n)?n:u.from(n,m),$=C.length;if($===0)throw new TypeError('The value "'+n+'" is invalid for argument "value"');for(_=0;_<d-r;++_)this[_+r]=C[_%$]}return this};const J={};function ne(c,n,r){J[c]=class extends r{constructor(){super(),Object.defineProperty(this,"message",{value:n.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${c}]`,this.stack,delete this.name}get code(){return c}set code(m){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:m,writable:!0})}toString(){return`${this.name} [${c}]: ${this.message}`}}}ne("ERR_BUFFER_OUT_OF_BOUNDS",function(c){return c?`${c} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),ne("ERR_INVALID_ARG_TYPE",function(c,n){return`The "${c}" argument must be of type number. Received type ${typeof n}`},TypeError),ne("ERR_OUT_OF_RANGE",function(c,n,r){let d=`The value of "${c}" is out of range.`,m=r;return Number.isInteger(r)&&Math.abs(r)>2**32?m=ke(String(r)):typeof r=="bigint"&&(m=String(r),(r>BigInt(2)**BigInt(32)||r<-(BigInt(2)**BigInt(32)))&&(m=ke(m)),m+="n"),d+=` It must be ${n}. Received ${m}`,d},RangeError);function ke(c){let n="",r=c.length;const d=c[0]==="-"?1:0;for(;r>=d+4;r-=3)n=`_${c.slice(r-3,r)}${n}`;return`${c.slice(0,r)}${n}`}function de(c,n,r){Te(n,"offset"),(c[n]===void 0||c[n+r]===void 0)&&Se(n,c.length-(r+1))}function Pe(c,n,r,d,m,_){if(c>r||c<n){const C=typeof n=="bigint"?"n":"";let $;throw n===0||n===BigInt(0)?$=`>= 0${C} and < 2${C} ** ${(_+1)*8}${C}`:$=`>= -(2${C} ** ${(_+1)*8-1}${C}) and < 2 ** ${(_+1)*8-1}${C}`,new J.ERR_OUT_OF_RANGE("value",$,c)}de(d,m,_)}function Te(c,n){if(typeof c!="number")throw new J.ERR_INVALID_ARG_TYPE(n,"number",c)}function Se(c,n,r){throw Math.floor(c)!==c?(Te(c,r),new J.ERR_OUT_OF_RANGE("offset","an integer",c)):n<0?new J.ERR_BUFFER_OUT_OF_BOUNDS:new J.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${n}`,c)}const ft=/[^+/0-9A-Za-z-_]/g;function it(c){if(c=c.split("=")[0],c=c.trim().replace(ft,""),c.length<2)return"";for(;c.length%4!==0;)c=c+"=";return c}function Ae(c,n){n=n||1/0;let r;const d=c.length;let m=null;const _=[];for(let C=0;C<d;++C){if(r=c.charCodeAt(C),r>55295&&r<57344){if(!m){if(r>56319){(n-=3)>-1&&_.push(239,191,189);continue}else if(C+1===d){(n-=3)>-1&&_.push(239,191,189);continue}m=r;continue}if(r<56320){(n-=3)>-1&&_.push(239,191,189),m=r;continue}r=(m-55296<<10|r-56320)+65536}else m&&(n-=3)>-1&&_.push(239,191,189);if(m=null,r<128){if((n-=1)<0)break;_.push(r)}else if(r<2048){if((n-=2)<0)break;_.push(r>>6|192,r&63|128)}else if(r<65536){if((n-=3)<0)break;_.push(r>>12|224,r>>6&63|128,r&63|128)}else if(r<1114112){if((n-=4)<0)break;_.push(r>>18|240,r>>12&63|128,r>>6&63|128,r&63|128)}else throw new Error("Invalid code point")}return _}function Ur(c){const n=[];for(let r=0;r<c.length;++r)n.push(c.charCodeAt(r)&255);return n}function Lr(c,n){let r,d,m;const _=[];for(let C=0;C<c.length&&!((n-=2)<0);++C)r=c.charCodeAt(C),d=r>>8,m=r%256,_.push(m),_.push(d);return _}function kn(c){return e.toByteArray(it(c))}function mt(c,n,r,d){let m;for(m=0;m<d&&!(m+r>=n.length||m>=c.length);++m)n[m+r]=c[m];return m}function Ne(c,n){return c instanceof n||c!=null&&c.constructor!=null&&c.constructor.name!=null&&c.constructor.name===n.name}function Pt(c){return c!==c}const Gr=function(){const c="0123456789abcdef",n=new Array(256);for(let r=0;r<16;++r){const d=r*16;for(let m=0;m<16;++m)n[d+m]=c[r]+c[m]}return n}();function Le(c){return typeof BigInt>"u"?Wr:c}function Wr(){throw new Error("BigInt not supported")}})(vn);function bd(t){if(typeof t!="string")throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!t)throw new Error("No input");const e=JSON.parse(t),s=e;let a;if(s.type==="system")if(s.event==="connected")a=Object.assign(Object.assign({},e),{kind:"connected"});else if(s.event==="disconnected")a=Object.assign(Object.assign({},e),{kind:"disconnected"});else return null;else if(s.type==="message")if(s.from==="group"){const i=rs(e.data,e.dataType);if(i===null)return null;a=Object.assign(Object.assign({},e),{data:i,kind:"groupData"})}else if(s.from==="server"){const i=rs(e.data,e.dataType);if(i===null)return null;a=Object.assign(Object.assign({},e),{data:i,kind:"serverData"})}else return null;else if(s.type==="ack")a=Object.assign(Object.assign({},e),{kind:"ack"});else return null;return a}function Cd(t){let e;switch(t.kind){case"joinGroup":{e={type:"joinGroup",group:t.group,ackId:t.ackId};break}case"leaveGroup":{e={type:"leaveGroup",group:t.group,ackId:t.ackId};break}case"sendEvent":{e={type:"event",event:t.event,ackId:t.ackId,dataType:t.dataType,data:ss(t.data,t.dataType)};break}case"sendToGroup":{e={type:"sendToGroup",group:t.group,ackId:t.ackId,dataType:t.dataType,data:ss(t.data,t.dataType),noEcho:t.noEcho};break}case"sequenceAck":{e={type:"sequenceAck",sequenceId:t.sequenceId};break}default:throw new Error(`Unsupported type: ${t.kind}`)}return JSON.stringify(e)}function ss(t,e){switch(e){case"text":{if(typeof t!="string")throw new TypeError("Message must be a string.");return t}case"json":return t;case"binary":case"protobuf":{if(t instanceof ArrayBuffer)return vn.Buffer.from(t).toString("base64");throw new TypeError("Message must be a ArrayBuffer")}}}function rs(t,e){if(e==="text"){if(typeof t!="string")throw new TypeError("Message must be a string when dataType is text");return t}else{if(e==="json")return t;if(e==="binary"||e==="protobuf"){const s=vn.Buffer.from(t,"base64");return s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength)}else return null}}class Sd{constructor(){this.isReliableSubProtocol=!0,this.name="json.reliable.webpubsub.azure.v1"}parseMessages(e){return bd(e)}writeMessage(e){return Cd(e)}}const Id=()=>new Sd;var _e;(function(t){t.Stopped="Stopped",t.Disconnected="Disconnected",t.Connecting="Connecting",t.Connected="Connected",t.Recovering="Recovering"})(_e||(_e={}));class Ed{nextAckId(){return this._ackId=this._ackId+1,this._ackId}constructor(e,s){this._quickSequenceAckDiff=300,this._activeTimeoutInMs=2e4,this._emitter=new Ui,this._isStopping=!1,this._isInitialConnected=!1,typeof e=="string"?this._credential={getClientAccessUrl:e}:this._credential=e,s==null&&(s={}),this._buildDefaultOptions(s),this._options=s,this._messageRetryPolicy=new os(this._options.messageRetryOptions),this._reconnectRetryPolicy=new os(this._options.reconnectRetryOptions),this._protocol=this._options.protocol,this._groupMap=new Map,this._ackMap=new Map,this._sequenceId=new Md,this._state=_e.Stopped,this._ackId=0}async start(e){if(this._isStopping)throw new Error("Can't start a client during stopping");if(this._state!==_e.Stopped)throw new Error("Client can be only started when it's Stopped");let s;e&&(s=e.abortSignal),this._activeKeepaliveTask||(this._activeKeepaliveTask=this._getActiveKeepaliveTask());try{await this._startCore(s)}catch(a){throw this._changeState(_e.Stopped),this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0),this._isStopping=!1,a}}async _startFromRestarting(e){if(this._state!==_e.Disconnected)throw new Error("Client can be only restarted when it's Disconnected");try{fe.verbose("Staring reconnecting."),await this._startCore(e)}catch(s){throw this._changeState(_e.Disconnected),s}}async _startCore(e){if(this._changeState(_e.Connecting),fe.info("Staring a new connection"),this._sequenceId.reset(),this._isInitialConnected=!1,this._lastCloseEvent=void 0,this._lastDisconnectedMessage=void 0,this._connectionId=void 0,this._reconnectionToken=void 0,this._uri=void 0,typeof this._credential.getClientAccessUrl=="string"?this._uri=this._credential.getClientAccessUrl:this._uri=await this._credential.getClientAccessUrl({abortSignal:e}),typeof this._uri!="string")throw new Error(`The clientAccessUrl must be a string but currently it's ${typeof this._uri}`);await this._connectCore(this._uri)}stop(){this._state===_e.Stopped||this._isStopping||(this._isStopping=!0,this._wsClient&&this._wsClient.isOpen()?this._wsClient.close():this._isStopping=!1,this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0))}on(e,s){this._emitter.on(e,s)}off(e,s){this._emitter.removeListener(e,s)}_emitEvent(e,s){this._emitter.emit(e,s)}async sendEvent(e,s,a,i){return await this._operationExecuteWithRetry(()=>this._sendEventAttempt(e,s,a,i),i?.abortSignal)}async _sendEventAttempt(e,s,a,i){var l;if(!((l=i?.fireAndForget)!==null&&l!==void 0?l:!1))return await this._sendMessageWithAckId(p=>({kind:"sendEvent",dataType:a,data:s,ackId:p,event:e}),i?.ackId,i?.abortSignal);const u={kind:"sendEvent",dataType:a,data:s,event:e};return await this._sendMessage(u,i?.abortSignal),{isDuplicated:!1}}async joinGroup(e,s){return await this._operationExecuteWithRetry(()=>this._joinGroupAttempt(e,s),s?.abortSignal)}async _joinGroupAttempt(e,s){const a=this._getOrAddGroup(e),i=await this._joinGroupCore(e,s);return a.isJoined=!0,i}async _joinGroupCore(e,s){return await this._sendMessageWithAckId(a=>({group:e,ackId:a,kind:"joinGroup"}),s?.ackId,s?.abortSignal)}async leaveGroup(e,s){return await this._operationExecuteWithRetry(()=>this._leaveGroupAttempt(e,s),s?.abortSignal)}async _leaveGroupAttempt(e,s){const a=this._getOrAddGroup(e),i=await this._sendMessageWithAckId(l=>({group:e,ackId:l,kind:"leaveGroup"}),s?.ackId,s?.abortSignal);return a.isJoined=!1,i}async sendToGroup(e,s,a,i){return await this._operationExecuteWithRetry(()=>this._sendToGroupAttempt(e,s,a,i),i?.abortSignal)}async _sendToGroupAttempt(e,s,a,i){var l,h;const u=(l=i?.fireAndForget)!==null&&l!==void 0?l:!1,p=(h=i?.noEcho)!==null&&h!==void 0?h:!1;if(!u)return await this._sendMessageWithAckId(v=>({kind:"sendToGroup",group:e,dataType:a,data:s,ackId:v,noEcho:p}),i?.ackId,i?.abortSignal);const g={kind:"sendToGroup",group:e,dataType:a,data:s,noEcho:p};return await this._sendMessage(g,i?.abortSignal),{isDuplicated:!1}}_getWebSocketClientFactory(){return new Li}async _trySendSequenceAck(){if(!this._protocol.isReliableSubProtocol)return;const[e,s]=this._sequenceId.tryGetSequenceId();if(e&&s){const a={kind:"sequenceAck",sequenceId:s};try{await this._sendMessage(a)}catch{this._sequenceId.tryUpdate(s)}}}_connectCore(e){if(this._isStopping)throw new Error("Can't start a client during stopping");return new Promise((s,a)=>{const i=this._wsClient=this._getWebSocketClientFactory().create(e,this._protocol.name);i.onopen(()=>{if(this._isStopping){try{i.close()}catch{}a(new Error("The client is stopped"))}fe.verbose("WebSocket connection has opened"),this._changeState(_e.Connected),this._protocol.isReliableSubProtocol&&(this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),this._sequenceAckTask=new as(async()=>{await this._trySendSequenceAck()},1e3)),s()}),i.onerror(l=>{this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),a(l)}),i.onclose((l,h)=>{this._state===_e.Connected?(fe.verbose("WebSocket closed after open"),this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),fe.info(`WebSocket connection closed. Code: ${l}, Reason: ${h}`),this._lastCloseEvent={code:l,reason:h},this._handleConnectionClose.call(this)):(fe.verbose("WebSocket closed before open"),a(new Error(`Failed to start WebSocket: ${l}`)))}),i.onmessage(l=>{const h=f=>{if(this._ackMap.has(f.ackId)){const x=this._ackMap.get(f.ackId);this._ackMap.delete(f.ackId);const b=f.error!=null&&f.error.name==="Duplicate";f.success||b?x.resolve({ackId:f.ackId,isDuplicated:b}):x.reject(new gt("Failed to send message.",{ackId:f.ackId,errorDetail:f.error}))}},u=async f=>{if(this._connectionId=f.connectionId,this._reconnectionToken=f.reconnectionToken,!this._isInitialConnected){if(this._isInitialConnected=!0,this._options.autoRejoinGroups){const x=[];this._groupMap.forEach(b=>{b.isJoined&&x.push((async()=>{try{await this._joinGroupCore(b.name)}catch(S){this._safeEmitRejoinGroupFailed(b.name,S)}})())});try{await Promise.all(x)}catch{}}this._safeEmitConnected(f.connectionId,f.userId)}},p=f=>{this._lastDisconnectedMessage=f},g=f=>{if(f.sequenceId!=null){const x=this._sequenceId.tryUpdate(f.sequenceId);if(x===0)return;x>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitGroupMessage(f)},v=f=>{if(f.sequenceId!=null){const x=this._sequenceId.tryUpdate(f.sequenceId);if(x===0)return;x>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitServerMessage(f)};let w;try{let f;if(Array.isArray(l)?f=Buffer.concat(l):f=l,w=this._protocol.parseMessages(f),w===null)return}catch(f){throw fe.warning("An error occurred while parsing the message from service",f),f}Array.isArray(w)||(w=[w]),w.forEach(f=>{try{switch(f.kind){case"ack":{h(f);break}case"connected":{u(f);break}case"disconnected":{p(f);break}case"groupData":{g(f);break}case"serverData":{v(f);break}}}catch(x){fe.warning(`An error occurred while handling the message with kind: ${f.kind} from service`,x)}})})})}async _handleConnectionCloseAndNoRecovery(){this._state=_e.Disconnected,this._safeEmitDisconnected(this._connectionId,this._lastDisconnectedMessage),this._options.autoReconnect?await this._autoReconnect():await this._handleConnectionStopped()}async _autoReconnect(){let e=!1,s=0;try{for(;!this._isStopping;)try{await this._startFromRestarting(),e=!0;break}catch(a){fe.warning("An attempt to reconnect connection failed.",a),s++;const i=this._reconnectRetryPolicy.nextRetryDelayInMs(s);if(i==null)break;try{fe.verbose(`Delay time for reconnect attempt ${s}: ${i}`),await _t(i)}catch{}}}finally{e||this._handleConnectionStopped()}}_handleConnectionStopped(){this._isStopping=!1,this._state=_e.Stopped,this._safeEmitStopped()}_getActiveKeepaliveTask(){return new as(async()=>{this._sequenceId.tryUpdate(0)},this._activeTimeoutInMs)}async _sendMessage(e,s){if(!this._wsClient||!this._wsClient.isOpen())throw new Error("The connection is not connected.");const a=this._protocol.writeMessage(e);await this._wsClient.send(a,s)}async _sendMessageWithAckId(e,s,a){s==null&&(s=this.nextAckId());const i=e(s);this._ackMap.has(s)||this._ackMap.set(s,new Td(s));const l=this._ackMap.get(s);try{await this._sendMessage(i,a)}catch(h){this._ackMap.delete(s);let u="";throw h instanceof Error&&(u=h.message),new gt(u,{ackId:s})}if(a)try{return await Gi(l.promise(),a)}catch(h){throw h instanceof Error&&h.name==="AbortError"?new gt("Cancelled by abortSignal",{ackId:s}):h}return await l.promise()}async _handleConnectionClose(){if(this._ackMap.forEach((i,l)=>{this._ackMap.delete(l)&&i.reject(new gt("Connection is disconnected before receive ack from the service",{ackId:i.ackId}))}),this._isStopping){fe.warning("The client is stopping state. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(this._lastCloseEvent&&this._lastCloseEvent.code===1008){fe.warning("The websocket close with status code 1008. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(!this._protocol.isReliableSubProtocol){fe.warning("The protocol is not reliable, recovery is not applicable"),this._handleConnectionCloseAndNoRecovery();return}const e=this._buildRecoveryUri();if(!e){fe.warning("Connection id or reconnection token is not available"),this._handleConnectionCloseAndNoRecovery();return}let s=!1;this._state=_e.Recovering;const a=Ks.timeout(30*1e3);try{for(;!a.aborted||this._isStopping;)try{await this._connectCore.call(this,e),s=!0;return}catch{await _t(1e3)}}finally{s||(fe.warning("Recovery attempts failed more then 30 seconds or the client is stopping"),this._handleConnectionCloseAndNoRecovery())}}_safeEmitConnected(e,s){this._emitEvent("connected",{connectionId:e,userId:s})}_safeEmitDisconnected(e,s){this._emitEvent("disconnected",{connectionId:e,message:s})}_safeEmitGroupMessage(e){this._emitEvent("group-message",{message:e})}_safeEmitServerMessage(e){this._emitEvent("server-message",{message:e})}_safeEmitStopped(){this._emitEvent("stopped",{})}_safeEmitRejoinGroupFailed(e,s){this._emitEvent("rejoin-group-failed",{group:e,error:s})}_buildDefaultOptions(e){return e.autoReconnect==null&&(e.autoReconnect=!0),e.autoRejoinGroups==null&&(e.autoRejoinGroups=!0),e.protocol==null&&(e.protocol=Id()),this._buildMessageRetryOptions(e),this._buildReconnectRetryOptions(e),e}_buildMessageRetryOptions(e){e.messageRetryOptions||(e.messageRetryOptions={}),(e.messageRetryOptions.maxRetries==null||e.messageRetryOptions.maxRetries<0)&&(e.messageRetryOptions.maxRetries=3),(e.messageRetryOptions.retryDelayInMs==null||e.messageRetryOptions.retryDelayInMs<0)&&(e.messageRetryOptions.retryDelayInMs=1e3),(e.messageRetryOptions.maxRetryDelayInMs==null||e.messageRetryOptions.maxRetryDelayInMs<0)&&(e.messageRetryOptions.maxRetryDelayInMs=3e4),e.messageRetryOptions.mode==null&&(e.messageRetryOptions.mode="Fixed")}_buildReconnectRetryOptions(e){e.reconnectRetryOptions||(e.reconnectRetryOptions={}),(e.reconnectRetryOptions.maxRetries==null||e.reconnectRetryOptions.maxRetries<0)&&(e.reconnectRetryOptions.maxRetries=Number.MAX_VALUE),(e.reconnectRetryOptions.retryDelayInMs==null||e.reconnectRetryOptions.retryDelayInMs<0)&&(e.reconnectRetryOptions.retryDelayInMs=1e3),(e.reconnectRetryOptions.maxRetryDelayInMs==null||e.reconnectRetryOptions.maxRetryDelayInMs<0)&&(e.reconnectRetryOptions.maxRetryDelayInMs=3e4),e.reconnectRetryOptions.mode==null&&(e.reconnectRetryOptions.mode="Fixed")}_buildRecoveryUri(){if(this._connectionId&&this._reconnectionToken&&this._uri){const e=new URL(this._uri);return e.searchParams.append("awps_connection_id",this._connectionId),e.searchParams.append("awps_reconnection_token",this._reconnectionToken),e.toString()}return null}_getOrAddGroup(e){return this._groupMap.has(e)||this._groupMap.set(e,new kd(e)),this._groupMap.get(e)}_changeState(e){fe.verbose(`The client state transfer from ${this._state.toString()} to ${e.toString()}`),this._state=e}async _operationExecuteWithRetry(e,s){let a=0;for(;;)try{return await e.call(this)}catch(i){a++;const l=this._messageRetryPolicy.nextRetryDelayInMs(a);if(l==null||(await _t(l),s?.aborted))throw i}}}class os{constructor(e){this._retryOptions=e,this._maxRetriesToGetMaxDelay=Math.ceil(Math.log2(this._retryOptions.maxRetryDelayInMs)-Math.log2(this._retryOptions.retryDelayInMs)+1)}nextRetryDelayInMs(e){return e>this._retryOptions.maxRetries?null:this._retryOptions.mode==="Fixed"?this._retryOptions.retryDelayInMs:this._calculateExponentialDelay(e)}_calculateExponentialDelay(e){return e>=this._maxRetriesToGetMaxDelay?this._retryOptions.maxRetryDelayInMs:(1<<e-1)*this._retryOptions.retryDelayInMs}}class kd{constructor(e){this.isJoined=!1,this.name=e}}class Td{constructor(e){this._promise=new Promise((s,a)=>{this._resolve=s,this._reject=a}),this.ackId=e}promise(){return this._promise}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}class Md{constructor(){this._sequenceId=0,this._isUpdate=!1}tryUpdate(e){if(this._isUpdate=!0,e>this._sequenceId){const s=e-this._sequenceId;return this._sequenceId=e,s}return 0}tryGetSequenceId(){return this._isUpdate?(this._isUpdate=!1,[!0,this._sequenceId]):[!1,null]}reset(){this._sequenceId=0,this._isUpdate=!1}}class as{constructor(e,s,a){this._func=e,this._abortController=new Ks,this._interval=s,this._obj=a,this._start()}abort(){try{this._abortController.abort()}catch{}}async _start(){const e=this._abortController.signal;for(;!e.aborted;)try{await this._func(this._obj)}catch{}finally{await _t(this._interval)}}}const jd=1e3*60*60,Rd=1e3*30;class Ad{client;handler;terminationTimeout=null;connectionUrl;expiresAt;connected=!1;websocketRequestId=null;conversationId=null;secondaryTypeBasedHandlers=new Map;constructor(e,s,a,i=null,l=new Map){this.connectionUrl=s,this.expiresAt=a,this.client=new Ed({getClientAccessUrl:()=>e(this.connectionUrl,this.expiresAt)},{autoReconnect:!0,reconnectRetryOptions:{maxRetries:5,retryDelayInMs:100,maxRetryDelayInMs:1e4,mode:"Exponential"}}),this.handler=i,this.secondaryTypeBasedHandlers=l}async start(){const e=s=>{if(this.secondaryTypeBasedHandlers.has(s.message.data.type)){const a=this.secondaryTypeBasedHandlers.get(s.message.data.type);if(!a)return;a(s.message.data)}else{const a=s.message.data.body,i=atob(a).trim();if(i.startsWith("data: ")){const l=i.replace("data: ",""),h=this.handler;if(!h)return;h({conversationId:s.message.data.conversation_id,responseId:s.message.data.response_id,message:{id:"",event:"",data:l},websocketRequestId:s.message.data.websocket_request_id})}}};this.client.on("group-message",s=>e(s)),this.client.on("server-message",s=>e(s)),this.client.on("connected",()=>{this.connected=!0}),this.client.on("disconnected",()=>{this.connected=!1}),await this.client.start()}addSecondaryTypeHandler(e,s){this.secondaryTypeBasedHandlers.set(e,s)}isConnected(){return this.connected}async stop(e){e&&this.conversationId!==e||this.websocketRequestId&&await Fe.stopWebsocketConversation(this.websocketRequestId)}setHandler(e,s,a,i){!this.handler&&this.websocketRequestId===a||(this.handler!=null&&this.websocketRequestId!==a&&(lo.warn("[websockets] Overwriting existing handler without silencing. This may indicate a race condition."),O.logEvent(U.asyncHandlerOverwritten,{originalWebsocketRequestId:this.websocketRequestId,newWebsocketRequestId:a,conversationId:e,responseId:s})),this.websocketRequestId=a,this.conversationId=e,this.handler=l=>{(l.websocketRequestId===a||l.conversationId===e&&l.responseId===s)&&i(l.message)})}silence(){this.handler=null}close(){this.client.stop()}scheduleForTermination(e){this.terminationTimeout=setTimeout(()=>{this.close(),e()},jd)}preventTermination(){this.terminationTimeout&&(clearTimeout(this.terminationTimeout),this.terminationTimeout=null)}updateConnectionUrl(e,s){this.connectionUrl=e,this.expiresAt=s}}class Nd{activeSocketMap=new Map;secondaryTypeBasedHandlers=new Map;async register(){const e=await Fe.postRegisterWebsocket();e.wss_url&&(this.getOrCreateSocket(e.wss_url,new Date(e.expires_at),!0),e.fallback_wss_url&&this.getOrCreateSocket(e.fallback_wss_url,new Date(e.expires_at),!1))}async registerIfNotConnected(){if(this.activeSocketMap.size===0){await this.register();return}for(const e of this.activeSocketMap.values())if(!e.isConnected()){await this.register();return}}isWebsocketConnected(){for(const e of this.activeSocketMap.values())if(e.isConnected())return!0;return this.activeSocketMap.size>0&&Ce.addError("Cannot connect to any websocket."),!1}async getOrCreateSocket(e,s,a){const i=e.split("?")[0];let l;const h=this.activeSocketMap.get(i);if(h&&h.isConnected())h.preventTermination(),h.updateConnectionUrl(e,s),l=h;else{h&&h.close(),l=new Ad(async(u,p)=>{if(new Date<new Date(p.getTime()-5*1e3))return u;const g=await Fe.postRegisterWebsocket();return a?g.wss_url:g.fallback_wss_url??""},e,s,null,this.secondaryTypeBasedHandlers),this.activeSocketMap.set(i,l);try{await l.start()}catch(u){throw Ce.addError(new Error("Error occurred while starting websocket: ",{cause:u})),u}}return l}preSetupWebsocket(e,s,a){for(const i of this.activeSocketMap.values())this.setupWebSocketHandler(i,null,null,null,e,s,a)}addSecondaryTypeHandler(e,s){this.secondaryTypeBasedHandlers.set(e,s);for(const a of this.activeSocketMap.values())a.addSecondaryTypeHandler(e,s)}hasSecondaryTypeHandler(e){return this.secondaryTypeBasedHandlers.has(e)}async processWebSocketConversationStream(e,s,a,i,l,h,u,p,g){const v=[this.getOrCreateSocket(e,a,!0)];s&&v.push(this.getOrCreateSocket(s,a,!1));const w=await Promise.allSettled(v),f=w[0].status==="fulfilled"?w[0].value:null,x=w.length>1&&w[1].status==="fulfilled"?w[1].value:null;if((!f||!f.isConnected())&&Ce.addError(`Cannot connect to primary websocket, websocketRequestId: ${h}, token: ${e.substring(0,e.indexOf("access_token="))}`),(!f||!f.isConnected())&&(!x||!x.isConnected()))throw s&&Ce.addError(`Cannot connect to fallback websocket, websocketRequestId: ${h}, token: ${s.substring(0,s.indexOf("access_token="))}`),ve.createWithErrorMessage("websocket","server",`An error occurred while connecting to the websocket. ${en}`);let b=setTimeout(()=>{Ce.addError(`WebSocket took too long to respond: ${l}, ${i}, ${h}, ${e.substring(0,60)}...${e.slice(-20)}`,{supportsWebSockets:"WebSocket"in window&&window.WebSocket.CLOSING===2})},Rd);const S=E=>(g&&(clearTimeout(g),g=null),b&&(clearTimeout(b),b=null),u(E));f&&this.setupWebSocketHandler(f,e,i,l,h,S,p),x&&s&&this.setupWebSocketHandler(x,s,i,l,h,S,p)}async stopConversation(e){for(const s of this.activeSocketMap.values())await s.stop(e)}setupWebSocketHandler(e,s,a,i,l,h,u){e.setHandler(a,i,l,h),this.secondaryTypeBasedHandlers.forEach((g,v)=>{e.addSecondaryTypeHandler(v,g)});const p=()=>{s?e.scheduleForTermination(()=>{this.activeSocketMap.delete(s.split("?")[0])}):(this.stopConversation(a),e.silence())};u.addEventListener("abort",p)}}const In=new Nd;function Bd(t){return{webSocketUrl:t.wss_url,fallbackWebSocketUrl:t.fallback_wss_url,conversationId:t.conversation_id,responseId:t.response_id,expiresAt:t.expires_at&&new Date(t.expires_at),websocketRequestId:t.websocket_request_id}}async function Fd(t,e,s){return In.preSetupWebsocket(t,e,s)}async function Dd(t,e,s,a,i,l,h,u,p){return In.processWebSocketConversationStream(t,e,s,a,i,l,h,u,p)}const ct=t=>{if(t.type===he.Starter&&t.category==="onboarding")return"";switch(t.type){case he.Reply:return t.text;case he.Starter:case he.Autocomplete:return t.prompt}},Pd=t=>t.type===he.Reply,Br=t=>t.type===he.Starter,En=t=>t.type===he.Autocomplete,vt=t=>En(t)&&!!t.theme,qh=(t,e,s,a)=>{switch(ue.logEvent("chatgpt_prompt_use_suggestion",En(t)&&!vt(t)?"":ct(t),{id:Br(t)||vt(t)?t.id??"":"",index:`${e}`,type:t.type}),t.type){case he.Reply:O.logEvent(U.useSuggestedReply,{value:ct(t),prompt_type:he.Reply,messageId:a});break;case he.Starter:O.logEvent(U.useStarterPrompt,{value:ct(t),prompt_type:he.Starter,title:t.title,body:t.body,id:t.id,category:t.category,client_thread_id:s,messageId:a,index:e,theme:t.theme});break;case he.Autocomplete:{const i=vt(t);O.logEvent(U.useAutocomplete,{value:i?ct(t):"",prompt_type:he.Autocomplete,title:i?t.title:"",body:i?t.body:"",id:i?t.id:"",category:t.category,index:e,messageId:a,client_thread_id:s,theme:t.theme??""});break}}},Hh=(t,e)=>{const s=j.getThreadCurrentLeafId(e),a=j.getTree(e).getMessageId(s);if(ue.logEvent("chatgpt_prompt_show_suggestions",`count_${t.length}`,{type:t[0].type}),t.every(Pd))O.logEvent(U.showSuggestedReplies,{prompt_count:t.length,prompt_type:he.Reply,client_thread_id:e,suggestions:t.map(i=>i.text),message_id:a});else if(t.every(Br)){const{isAdditional:i}=t[0];O.logEvent(i?U.moreStarterPromptsShown:U.showStarterPrompts,{prompt_count:t.length,prompt_type:he.Starter,titles:t.map(l=>l.title),bodies:t.map(l=>l.body),ids:t.map(l=>l.id),client_thread_id:e,message_id:a,themes:t.map(l=>l.theme??"")}),i&&O.logEvent(U.expandMoreStarterPrompts,{client_thread_id:e,message_id:a})}else if(t.every(En)){const i=!!t.find(l=>vt(l));O.logEvent(U.showAutocompletePrompts,{prompt_count:t.length,prompt_type:he.Autocomplete,titles:t.map(l=>i?l.title:""),bodies:t.map(l=>i?l.body:""),ids:t.map(l=>i?l.id:""),client_thread_id:e,message_id:a,themes:t.map(l=>l.theme??"")})}else Ce.addError("Unhandled suggestion type",{type:t[0].type})},zh=t=>{const e=j.getThreadCurrentLeafId(t),s=j.getTree(t).getMessageId(e);O.logEvent(U.showExpandMoreStarterPromptsButton,{client_thread_id:t,message_id:s})},Vh=t=>{const e=j.getThreadCurrentLeafId(t),s=j.getTree(t).getMessageId(e);O.logEvent(U.expandMoreStarterPrompts,{client_thread_id:t,message_id:s})},Od="OAI-Echo-Logs",tt={FOCUS_IN:0,FOCUS_OUT:1,COPY:2,PASTE:3,TOUCH_START:4,TOUCH_END:5},Fr=[];function nt(t){return()=>{Fr.push({type:t,ts:Math.round(performance.now())})}}const Ud={focusin:nt(tt.FOCUS_IN),focusout:nt(tt.FOCUS_OUT),copy:nt(tt.COPY),paste:nt(tt.PASTE),touchstart:nt(tt.TOUCH_START),touchend:nt(tt.TOUCH_END)};function Kh(t){const e=t??document.getElementById(Mc);for(const[s,a]of Object.entries(Ud))e?.removeEventListener(s,a),e?.addEventListener(s,a)}function Ld(){return{[Od]:Fr.slice(0,10).map(t=>`${t.type},${t.ts}`).join(",")}}const Gd=1e3*30,Yt=bs.getTracer("completion");class Jt extends Error{}function Wd(t,e,s,a){return(async(l=null)=>{Wi()&&await $i();const h=new AbortController,u="threadId"in e?e.threadId:void 0,p="continueFromSharedConversationId"in e?e.continueFromSharedConversationId:void 0,g=uo(),v=ue.checkGate("1987334402"),w=ue.checkGate("2964350589"),f=[v&&et.V1,w&&et.V1_TEST].filter(Boolean),x={action:e.completionType,messages:e.messages.length>0?e.messages:void 0,conversation_id:u,continue_from_shared_conversation_id:u!=null?void 0:p,parent_message_id:e.parentMessageId,model:e.model,timezone_offset_min:new Date().getTimezoneOffset(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,variant_purpose:e.completionMetadata?.variantPurpose,suggestions:e.completionMetadata?.suggestions?e.completionMetadata.suggestions.map(M=>ct(M)):void 0,chosen_suggestion:e.completionMetadata?.suggestion?{type:e.completionMetadata.suggestion.type,index:e.completionMetadata.suggestionIndex,source:e.completionMetadata?.suggestion.type===he.Autocomplete?e.completionMetadata.suggestion.source:void 0,user_input:e.completionMetadata?.suggestion.type===he.Autocomplete?e.completionMetadata.suggestion.userInput:void 0}:void 0,history_and_training_disabled:e.historyDisabled,juice:e.completionMetadata?.juice,conversation_mode:e.completionMetadata?.conversationMode,force_paragen:e.forceParagen,force_paragen_model_slug:e.forceParagenModel,force_indepth_feedback:e.forceIndepthFeedback,force_rate_limit:e.forceRateLimit,reset_rate_limits:e.resetRateLimits,disable_system_content_toggling:e.disableSystemContentToggling,websocket_request_id:g,source:e.completionMetadata?.source,system_hints:e.completionMetadata?.systemHints,prefetch_ids:e.completionMetadata?.prefetchIds,force_use_sse:!In.isWebsocketConnected(),supported_encodings:f,conversation_origin:e.conversationOrigin,force_use_search:e.forceUseSearch,client_reported_search_source:e.completionMetadata?.searchSource,client_contextual_info:e.contextualInfo,paragen_stream_type_override:e.paragenStreamType==="none"?null:e.paragenStreamType,paragen_cot_summary_display_override:e.paragenCotSummaryDisplay},b=ue.checkGate("1113464293");b&&(x.supports_buffering=!0),e.turnTracker.stream_buffering=b;let S,E;const B=ys(t);hn(B)?(E="https://chatgpt.com/backend-anon",S=Mn.getUnauthHeaders().additionalHeaders):(E="https://chatgpt.com/backend-api",S=Mn.getAuthedHeadersWithAccessToken(B?.accessToken));const D=`${E}/conversation`;let I=!0,T=!0;const A=ho(e.chatReq,l??e.arkoseToken,e.turnstileToken,e.proofToken,null),F={...S,...Ld(),...A};let L,P,G;Yt.startActiveSpan("completion.response",M=>{L=Yt.startSpan("completion.first_response"),P=Yt.startSpan("completion.first_token"),G=M});const H=bs.setSpan(jn.active(),G);let z=null,te=null,W,V=!1,X=!1;function Q(){X||(X=!0,s({type:"done"}),Ln())}function N(M){if(e.turnTracker.onBytesReceived(M.data),M.data==="[DONE]")h.abort(),G.end(),Q();else if(M.event!=="ping")try{let k=JSON.parse(M.data);if(M.event==="delta_encoding")if(k===et.V1||k===et.V1_TEST)z=k,e.turnTracker.stream_encoding=z??void 0,te=new Hi;else{Ce.addError(`[completion-delta] unknown delta encoding: ${k}`);return}else if(M.event==="delta"){if(!te){Ce.addError("[completion-delta] delta event before delta_encoding");return}const le=te.applyDelta(k);if(z===et.V1_TEST){!V&&!po(le,W)&&(V=!0,Ce.addError("[completion-delta] delta resulted in a different object",{differences:zi(le,W)}));return}else k=le}else z===et.V1_TEST&&!V&&(W=k);if(k.error){const le=ve.createWithErrorMessage(D,"server",k.error);throw s({type:"error",error:le}),le}else"type"in k?k.type==="gizmo_inline_review"?s({type:"gizmo_inline_review",gizmoId:k.gizmo_id}):k.type==="title_generation"?s({type:"title_generation",title:k.title,conversation_id:k.conversation_id}):k.type==="moderation"?s({type:"moderation",conversationId:k.conversation_id,messageId:k.message_id,isCompletion:k.is_completion,flagged:k.moderation_response.flagged,blocked:k.moderation_response.blocked,disclaimers:k.moderation_response.disclaimers,metadata:k.moderation_response.metadata}):k.type==="url_moderation"?s({type:"url_moderation",conversationId:k.conversation_id,messageId:k.message_id,url:k.url_moderation_result.full_url,isSafe:k.url_moderation_result.is_safe}):k.type==="num_variants_in_stream"?s({type:"num_variants_in_stream",num_variants_in_stream:k.num_variants_in_stream,display_treatment:k.display_treatment}):k.type==="conversation_detail_metadata"?s(k):k.type==="message_stream_complete"&&Q():(s({type:"message",message:k.message,conversationId:k.conversation_id}),T&&(T=!1,L.end()),I&&k.message.author.role==="assistant"&&k.message.content.content_type==="text"&&k.message.content.parts[0]!==""&&(I=!1,P.end()))}catch(k){if(k instanceof ve)throw k}}let Y=null,K=setTimeout(()=>{Y===!0?(O.logEvent(U.asyncResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:St.Error,error:{reason:"timeout",message:"Async Response Took Too Long to Come Back"}})):Y===!1&&(O.logEvent(U.sseResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:St.Error,error:{reason:"timeout",message:"SSE Response Took Too Long to Come Back"}}))},Gd);return Fd(g,N,h.signal),jn.with(H,()=>(e.profiler?.logTiming("fetch_event_source"),qi(D,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...F},body:JSON.stringify(x),signal:h.signal,openWhenHidden:!0,async onopen(M){const k=M.headers.get("content-type")??"",le=M.headers.get("Cf-Ray")??null;if(M.ok&&k.includes("text/event-stream")){Y=!1,a(le,e.model,e.turnTracker);return}else if(k.includes("application/json")){const ge=await M.json(),{webSocketUrl:Re,fallbackWebSocketUrl:q,conversationId:ee,responseId:J,expiresAt:ne,websocketRequestId:ke}=Bd(ge);if(Re!=null&&ee!=null&&J!=null&&ke!=null&&ne){Y=!0,a(le,e.model,e.turnTracker);try{await Dd(Re,q,ne,ee,J,ke,N,h.signal,K)}catch(de){de instanceof ve&&s({type:"error",error:de})}throw new Jt}else{const de=new ve(D,M.status,ge);if(de.isServerError())throw de;if((de?.code==="expired_session_key"||de?.code==="invalid_api_key"||de?.code==="token_expired")&&typeof window<"u"&&window._oaiHandleSessionExpired?.("stream",JSON.stringify(de)),de?.code==="deactivated_workspace"){window.location.href.includes("/workspace/deactivated")||(window.location.href="/workspace/deactivated");return}throw de}}else{const ge=await M.text();throw new ve(D,M.status,{detail:{message:Rn,code:"unexpected_content_type",contentType:k,text:ge?.substring(0,1e3)}})}},onmessage:M=>{if(Y)throw ve.createWithErrorMessage(D,"server",Rn);K&&(clearTimeout(K),K=null),N(M)},onerror(M){let k=M instanceof Error?M:new Error(JSON.stringify(M));throw k instanceof Jt||Y||(k.message==="Failed to fetch"&&(k=ve.createWithErrorMessage(D,"server",`An error occurred. Either the engine you requested does not exist or there was another issue processing your request. ${en}`)),k.message==="network error"&&(k=ve.createWithErrorMessage(D,"client",`A network error occurred. Please check your connection and try again. ${en}`)),fo("fetch-error:conversation:new-message",{url:D,message:k?.message}),s({type:"error",error:k}),Ln(k)),k}}))).catch(async M=>{M instanceof Jt||(M instanceof ve?mo(M):Ce.addError(M),e.turnTracker.handleRawError(M.message??"Something went wrong",M.status))}),h})()}function $d({clientThreadId:t,continuingFromSharedConversationId:e,onCompletionFinished:s=Xt,onCreate:a=Xt}){const i=ut(),{resolvedTheme:l}=is(),h=l==="dark",u=y.useRef(s),p=go();u.current=s;const g=y.useCallback(async function({model:v,completionType:w,parentNodeId:f,metadata:x,focusOnNewCompletion:b=!0,completionMetadata:S,chatReq:E,arkoseToken:B,turnstileToken:D,proofToken:I,preflightTime:T,extraStreamParams:A,appendMessages:F,updateTree:L,turnTracker:P,profiler:G}){Vs.publish({kind:"requestCompletion"});const H=j.getTree(t);j.retainThread(t);const z=Oc(),te=`${Vi}${t}-${z}`,W=`${t}-${z}`;L?.();const V=H.getNodeByIdOrMessageId(f),Q={gizmo_id:V.message.metadata?.gizmo_id};S?.juice!=null&&(Q.snorkle_status=1),j.updateTree(t,q=>{q.addNode(te,"",f,Ie.Assistant,void 0,Q)}),b&&j.setThreadCurrentLeafId(t,te);let N,Y=[],K=H.getNodeByIdOrMessageId(V.parentId);for(;K!=null&&(K.metadata?.isPlaceholderTemplateAssistantWelcomeMessage===!0||K.metadata?.isClientCreatedSystemMessage===!0);){const q=K.message;Y.unshift(q);const ee=H.getNodeByIdOrMessageId(K.parentId);N=ee.message?.id??ee.id,K=ee}if(w===st.Next||w===st.Variant){const q=H.getNodeByIdOrMessageId(V.parentId);if(N??=q.message?.id??q.id,Y.push(V.message),F){let ee=f;j.updateTree(t,J=>{for(const ne of F)J.insertNodeBefore(te,{id:ne.id,message:ne,parentId:ee,children:[]}),ee=ne.id}),Y.push(...F)}Y=qd(Y,A)}else N??=V.message.id;const ce=j.getServerThreadId(t);ce===void 0&&Bt(t)&&j.updateInitialThreadDataForNewThread(t,v);async function M(q,ee){const J=performance.now(),ne=await xo();An.initializeAndGatherData(ne),Gn.initializeAndGatherData(ne),Nn.initializeAndGatherData(ne),j.updateTree(t,Te=>{for(const Se of ee)Te.addNode(Se.id,Se,q,Ie.Assistant,{completionSampleFinishTime:Date.now()}),q=Se.id}),j.setThreadCurrentLeafId(t,q);const ke=await An.getEnforcementToken(ne),de=await Gn.getEnforcementToken(ne),Pe=await Nn.getEnforcementToken(ne);g({model:v,completionType:st.Next,parentNodeId:q,metadata:{},chatReq:ne,arkoseToken:ke??null,turnstileToken:de??null,proofToken:Pe??null,preflightTime:performance.now()-J,extraStreamParams:A,turnTracker:P})}P.updateAttachmentCount(Y);const k=new wd(i,t,te,w,v,x.eventSource,a,W,M,(...q)=>u.current(...q),P,p),le=(q,ee,J)=>{q&&J.onReceivedRequestId(q),Qi(W,ee,q,T)},ge={is_dark_mode:h,time_since_loaded:Math.floor(performance.now()/1e3),page_height:window?.innerHeight,page_width:window?.innerWidth,pixel_ratio:window?.devicePixelRatio,screen_height:window?.screen?.height,screen_width:window?.screen?.width},Re=await Wd(i,{conversationOrigin:j.getConversationOrigin(t),model:v,completionType:w,threadId:ce,continueFromSharedConversationId:e,historyDisabled:p,parentMessageId:N,messages:Y,chatReq:E,arkoseToken:B??null,turnstileToken:D??null,proofToken:I??null,completionMetadata:S,...A,turnTracker:P,profiler:G,contextualInfo:ge},k.handleResponse,le);ir(t,{source:vs.CLIENT,value:ws.STREAMING}),_n.addRequest(te,Re,P),rn.onCompletionRequestStarted(te)},[t,i,a,e,p,h]);return g}const qd=(t,e)=>{let s=t;return e?.forceUseSearch===!1&&t.length>0&&(s=t.map(a=>{const{system_hints:i,...l}=a.metadata||{};return{...a,metadata:{...l,system_hints:i?.filter(h=>h!==Ki.Search)}}})),s};function Hd({clientThreadId:t,currentModelId:e,defaultModelId:s,onCompletionFinished:a,onThreadCreated:i,preRequestCompletion:l}){const h=Yi(),u=At(),{isUnauthenticated:p}=fn(),g=Uc(t),v=ut(),w=wn(t),f=je(),x=Nl(t),b=Ms(),S=dn(),{config:E}=xs("1013114931"),B=E.get("show_follow_ups",!1)&&f?.isPersonalAccount(),D=!b.displayingSideBySideFeedback&&B,I=y.useCallback(W=>{const X=j.getTree(t).getLeafFromNode(W);j.setThreadCurrentLeafId(t,X.id)},[t]),T=Ji(e),[A,F]=y.useState(),L=y.useCallback(({nodeId:W,messageId:V,rating:X})=>{const Q=j.getServerThreadId(t);O.logEvent(U.thumbRating,{id:V,threadId:Q,rating:X,model:e});const N=j.getTree(t),Y=N.getNodeByIdOrMessageId(W);if(Q!==void 0&&!T&&Fe.submitMessageFeedback({message_id:V,conversation_id:Q,rating:X}),j.updateTree(t,K=>{K.updateNodeMetadata(W,{rating:X})}),T){F(o.jsx(xd,{citations:Y.message.metadata?.citations??[],rating:X,conversationId:Q??"",messageId:V,onSubmit:()=>{F(void 0)},onCancel:()=>F(void 0),conversationTree:N,nodeId:W},`${W}-${X}`));return}},[t,e,T]),P=y.useCallback(W=>{if(W==null||(a?.(W),S)||(w?.kind===Ee.GizmoInteraction&&Nc.handleGizmoInteracted(v,w.gizmo_id),!(x||D)))return;const X=j.getThreadCurrentLeafId(W),Q=j.getTree(W).getMessage(X);Xi(Q)||Zi(Q)||ec(W,Q.id,e)},[w,e,a,v,x,D,S]),G=$d({clientThreadId:t,continuingFromSharedConversationId:g,onCompletionFinished:P,onCreate:i}),H=y.useCallback(()=>{const W=j.getThreadCurrentLeafId(t);if(W==null)return;const X=j.getTree(t).getBranchFromLeaf(W);_n.abortRequests(X.map(Q=>Q.id))},[t]),z=y.useCallback(W=>tc({cancelRequests:H,clientThreadId:t,currentModelId:e,debugSettings:h,defaultModelId:s,isUnauthenticated:p,navigateToAuth:u,preRequestCompletion:l,requestCompletion:G,...W}),[H,t,e,h,s,p,u,l,G]),te=y.useCallback((W,V,X,Q=!0,N="none",Y)=>{const ce=j.getTree(t).getParentPromptNode(W).id;z({type:st.Variant,promptId:ce,eventMetadata:V,cancelActiveRequests:!1,focusOnNewCompletion:Q,useDefaultModel:Y,completionMetadata:{variantPurpose:N,conversationMode:Et.getConversationMode(t)},turnTracker:X})},[t,z]);return{caModal:A,onRequestCompletion:z,onRequestMoreCompletions:te,onChangeItemInView:I,onChangeRating:L,cancelRequests:H}}function zd(t){return`https://chatgpt.com${Bc(t)}`}function Qh(t,e,s,a){nc(zd(t),e,s),a&&e.info(a,{testId:"copy-gizmo-url-toast"})}function Yh(t){return t.some(e=>e.type===yo.JIT_PLUGIN)}function Vd(t){return"gizmo_id"in t?t.gizmo_id??null:null}const Kd=t=>["conversation","init",t],Qd=({clientThreadId:t,conversationMode:e,clientModelId:s},a)=>{const i=Vd(e),l=Bt(t)?null:t;return{gcTime:0,refetchOnWindowFocus:!0,refetchOnMount:"always",queryKey:Kd(t),queryFn:()=>Fe.getConversationDetails({conversationId:l,gizmoId:i,requestedDefaultModel:s}),enabled:!sc(t)}},Yd=t=>(un(),cn(Qd(t))),Jd=(t,e)=>{const s=(typeof t=="string"?[t]:t)??[];for(const a of s)if(a&&e.has(a))return a;return null},Xd=(t,e)=>{const s=Fc(),[a,i]=_o(),l=a.get("model"),{modelId:h=null}=rc()??{};Kc(t);const u=Lc(t)??null,p=[l,u,h],g=Jd(p,s);y.useEffect(()=>{j.initThread(t,e,g),Zt.reset()},[t]);const v=()=>{i(b=>(b.delete("model"),b))},{isLoading:w,data:f}=Yd({clientThreadId:t,clientModelId:p.find(b=>!!b)??null,conversationMode:e}),x=vo();y.useEffect(()=>{if(!(!l||w)){if(!s.has(l)||x.find(b=>b.model_slug===l))return v();j.setThreadModelId(t,l)}},[l,x,s,t]),y.useEffect(()=>{if(w||!f)return;const{default_model_slug:b}=f;l&&b&&l!==b&&v(),Zt.updateDetails(f),b&&j.setThreadModelId(t,b)},[w,f])};function Zd({clientThreadId:t,setClientThreadId:e}){const s=ut(),a=oc(),i=a?{kind:Ee.GizmoInteraction,gizmo_id:a}:{kind:Ee.PrimaryAssistant};Xd(t,i);const l=Je(),h=mr(t),u=y.useRef(h);u.current=h;const p=Gc(t),g=xr(t),{data:v}=pr(g),w=!1,f=y.useCallback(()=>{e?.(wo());const S=u.current;l(S.tags.includes(bo.GPT_4)?"/":`/?model=${S.id}`,{replace:!0})},[e,l]),x=Nr({clientThreadId:t,location:"Model switcher menu item"}),b=y.useCallback(S=>{p||vd(l,s,S)},[s,l,p,w,v]);return{createNewThread:x,onThreadCreated:b,resetThread:f}}function Dr(){return{caModal:null,clientThreadId:"",focusedObject:null,currentModelId:"",isModelLoaded:!1,isInstalledApp:!1,isCompanionWindow:!1,conversationLeafId:"",onNewThread:()=>{throw new Error("onNewThread not implemented")},onRequestCompletion:()=>{throw new Error("onRequestCompletion not implemented")},onChangeItemInView:()=>{throw new Error("onChangeItemInView not implemented")},onChangeRating:()=>{throw new Error("onChangeRating not implemented")},onRequestMoreCompletions:()=>{throw new Error("onRequestMoreCompletions not implemented")},resetThread:()=>{throw new Error("resetThread not implemented")}}}const Pr=y.createContext(Dr());function eh(){try{return y.useContext(Pr)}catch{return Dr()}}function Jh({children:t,clientThreadId:e,setClientThreadId:s,prefetchSearch:a}){const{createNewThread:i,onThreadCreated:l,resetThread:h}=Zd({clientThreadId:e,setClientThreadId:s}),u=dr(),p=Dc(e),g=Wc(e),v=u.id,w=p??v,f=Co(),x=ac(),b=ic(),{caModal:S,onRequestCompletion:E,onChangeItemInView:B,onChangeRating:D,onRequestMoreCompletions:I}=Hd({clientThreadId:e,currentModelId:w,defaultModelId:u.id,onThreadCreated:l});return o.jsx(Pr.Provider,{value:{caModal:S,clientThreadId:e,currentModelId:w,isModelLoaded:!!p,isInstalledApp:x,isCompanionWindow:f,focusedObject:b,conversationLeafId:g,onNewThread:i,onRequestCompletion:E,onChangeItemInView:B,onChangeRating:D,onRequestMoreCompletions:I,resetThread:h,prefetchSearch:a},children:t})}const th=Ye(()=>He(()=>import("./k4pvkri4w9ic2aso.js"),__vite__mapDeps([80,1,2,3,25,23,21,5,6,8,81,82,58,59,15,26])));function Xh({showShareButton:t,showProfileDropdown:e,clientThreadId:s}){const a=$c(s),i=ye(),l=Rs(),{layer:h}=bt("1547743984");xr(s);const{onNewThread:u}=eh(),p=h.get("show_share_button_text",!1),g=i.formatMessage({id:"GizmoInformation.shareChat",defaultMessage:"Share"}),v=ht(),w=()=>be.openSharingModal(a),f=!1,x=i.formatMessage({id:"TO+loE",defaultMessage:"New Chat"});return o.jsxs(o.Fragment,{children:[!1,l&&o.jsx(Jl,{}),!1,t&&a&&o.jsx(Wn,{clientThreadId:s,children:p?o.jsx(Oe,{onClick:w,icon:Ht,label:g,"data-testid":"share-chat-button",color:"secondary",className:"text-token-text-primary",style:{display:"var(--screen-size-hidden-on-compact-mode)",viewTransitionName:"var(--vt_share_chat_wide_button)"},children:g}):o.jsx(Me,{label:i.formatMessage({id:"CPEfES",defaultMessage:"Share chat"}),children:o.jsx(dt,{"data-testid":"share-chat-button",onClick:()=>be.openSharingModal(a),icon:Ht,style:{viewTransitionName:"var(--vt_share_chat_compact_button)"}})})}),v&&t&&a&&o.jsx(Wn,{clientThreadId:s,children:o.jsx(Me,{label:g,children:o.jsx($n,{style:{display:"var(--screen-size-hidden-on-wide-mode)",viewTransitionName:"var(--vt_share_chat_compact_button)"},onClick:w,icon:o.jsx(Ht,{}),label:g})})}),v&&!f&&o.jsx(Me,{label:x,children:o.jsx("div",{style:{display:"var(--sidebar_is_open_and_pinned, none)"},children:o.jsx($n,{className:Io.sidebarIcon,icon:o.jsx(sr,{}),onClick:()=>u(),label:x,style:{display:"var(--screen-size-hidden-on-wide-mode)"}})})}),e&&o.jsx(sh,{clientThreadId:s})]})}function nh({to:t,children:e,icon:s}){const a=Je();return o.jsx(re.Item,{icon:s,onSelect:()=>a(t),children:e})}function sh({clientThreadId:t}){const{isUnauthenticated:e}=fn();return e?o.jsx(dh,{}):o.jsx(rh,{clientThreadId:t})}function rh({clientThreadId:t}){const{data:e}=Mt(),s=je(),a=s?.isPlus()??!1,i=s?.isWorkspaceAccount()??!1,{openSettings:l}=cc(),h=rr(),u=ih(t??"none"),{openModal:p}=or(),g=ht(),{layer:v}=bt("2888142241"),w=ps("3905879930"),f=ye();var x=s?.isTeam()??!1,b=!1;x&&(b=w.config.get("enabled",!1));const{doesUserHaveAnyAccountsWithPlusFeatures:S}=So(),{layer:E}=bt("2670443078");if(!s||!e)return null;const B=e.accountItems.length>1;let D=a;!i&&!a&&S&&E.get("is_gating_fix_enabled",!1)&&(D=S);const I=!i&&!D&&v.get("is_upgrade_in_settings",!1);return o.jsxs(Tc,{contentClassName:oe(g&&"max-w-[256px] min-w-[256px] w-[256px]"),triggerButton:o.jsx("button",{onClick:()=>{O.logEvent(U.accountOpenProfileMenu),ue.logEvent("chatgpt_account_open_profile_menu")},"aria-label":f.formatMessage({id:"wz2MQV",defaultMessage:"Open Profile Menu"}),"data-testid":"profile-button",className:"flex h-10 w-10 items-center justify-center rounded-full hover:bg-token-main-surface-secondary focus-visible:bg-token-main-surface-secondary focus-visible:outline-0",style:g?{display:"var(--screen-size-hidden-on-compact-mode, flex)"}:void 0,children:o.jsx(yn,{iconSize:"medium"})}),children:[B&&o.jsx(Rr,{menuItemComponent:re.Item}),B?o.jsx(re.Separator,{}):null,i?o.jsx(Mr,{menuItemComponent:re.Item,routedMenuItemComponent:nh}):o.jsx(Tr,{menuItemComponent:re.Item}),o.jsx(re.Item,{icon:Js,onClick:()=>l(),"data-testid":"settings-menu-item",children:o.jsx(R,{defaultMessage:"Settings",id:"navigation.settings.0"})}),o.jsx(re.Separator,{}),x&&b&&o.jsxs(o.Fragment,{children:[o.jsx(re.Item,{"data-testid":"settings-menu-item-invite-teammates",onClick:()=>{be.openModal(Qe.InviteUsersToWorkspace),O.logEvent(U.accountMemberInviteButton,{eventSource:"mouse",location:"profile_drop_down"}),ue.logEvent("chatgpt_invite_users_to_workspace",0,{action:"OpenAdminInviteModal",location:"dropdown-menu-click",text:"AddTeammates",step:"OpenModal"})},icon:Xs,children:o.jsx(R,{...Or.addTeammatesButton})}),o.jsx(th,{workspace:s})]}),h&&o.jsx(ah,{openDownloadModal:p}),I&&o.jsx(lh,{}),u&&o.jsx(ch,{}),(I||h||u)&&o.jsx(re.Separator,{}),o.jsx(re.Item,{onClick:()=>{O.logEvent(U.clickLogOut,{eventSource:"mouse"}),O.logLogOutButtonClicked({location:"profile_drop_down"}),gs()},"data-testid":"log-out-menu-item",icon:Zs,children:o.jsx(R,{defaultMessage:"Log out",id:"navigation.logOut.0"})})]})}function oh({onClick:t,className:e,testId:s}){const a=ye(),i=dn(),l=i?a.formatMessage({id:"yqd/J5",defaultMessage:"Clear chat"}):a.formatMessage({id:"OFyxqj",defaultMessage:"New chat"});return o.jsx(Me,{sideOffset:4,label:l,className:oe("flex",e),children:o.jsx(dt,{onClick:()=>{be.closePopoverNavSidebar(),t()},icon:i?kc:sr,surfaceContext:"secondary","aria-label":l,"data-testid":s})})}function Zh({clientThreadId:t}){const[e]=cr(i=>[i.activeStageSidebar]),s=lr(),a=Nr({clientThreadId:t,location:"Navigation actions"});return!s&&!e?null:o.jsxs("div",{className:"flex items-center",children:[o.jsx(uh,{}),o.jsx(oh,{onClick:a})]})}function ah({openDownloadModal:t}){return o.jsx("span",{children:o.jsx(re.Item,{icon:er,onClick:()=>{t(),O.logEvent(U.accountMenuClickDownloadApp)},children:o.jsx(R,{id:"navigation.downloadMacApp",defaultMessage:"Download the macOS app"})})})}const ih=t=>{const{value:e}=ln("2634628831"),s=hs(()=>document.documentElement.dataset.searchExtension==="1"),a=hr(t,fs.Search);return!s&&a&&Ns()&&e},ch=()=>o.jsx("span",{children:o.jsx(re.Item,{icon:Sc,onClick:()=>{window.open(Sr),O.logEventWithStatsig(U.chatgptBrowserExtensionUserMenuClicked,"chatgpt_browser_extension_user_menu_clicked")},children:o.jsx(R,{id:"E5VPz/",defaultMessage:"Get ChatGPT search extension"})})});function lh(){const t=Je(),s=je()?.wasPaidCustomer()??!1,a=()=>{ue.logEvent("chatgpt_plus_upgrade_in_settings_menu_clicked"),O.logEvent(U.plusUpgradeInSettingsMenuClicked),xn(t,"Upper right settings menu")};return o.jsx(re.Item,{icon:Ic,onClick:a,children:s?o.jsx(R,{id:"navigation.renewPlus",defaultMessage:"Renew Plus"}):o.jsx(R,{id:"navigation.upgradePlan",defaultMessage:"Upgrade Plan"})})}function uh(){const t=ye(),[e]=cr(l=>[l.activeStageSidebar]),s=lr(),a=Ws(),{isUnauthenticated:i}=fn();return!e&&!s||!a||i?null:o.jsx(Me,{label:t.formatMessage({id:"cElEQV",defaultMessage:"Open sidebar"}),className:"flex",children:o.jsx(dt,{"aria-label":t.formatMessage({id:"pV/Etp",defaultMessage:"Open sidebar"}),onClick:be.toggleNavSidebar,icon:Ec,surfaceContext:"primary"})})}function dh(){const t=At(),e=lc(),s=qs(Or.signUpCta),{layer:a}=bt("3637408529"),i=a.get("is_desktop_primary_auth_button_on_right",!1),l=()=>{t({authType:"login",callback:v=>{O.logLogInButtonClicked({location:"Chat header",provider:v})}})},h=()=>{t({authType:"signup",callback:v=>{O.logSignUpButtonClicked({location:"Chat header",provider:v})}})},u=o.jsx(Oe,{onClick:l,color:e?"primary":"secondary",size:"small","data-testid":"login-button",children:o.jsx(R,{id:"B1SN7b",defaultMessage:"Log in"})},"login"),p=o.jsx(Oe,{color:e?"secondary":"primary",onClick:h,size:"small","data-testid":"signup-button",children:o.jsx(R,{...s})},"signup"),g=e?[u,p]:[p,u];return o.jsx("div",{className:"flex items-center justify-center gap-2",children:i?g.reverse():g})}const Or=ot({signUpCta:{id:"P6cySK",defaultMessage:"Sign up"},addTeammatesButton:{id:"inviteMemberButton.inviteMemberButton",defaultMessage:"Add Teammates"}});export{gl as $,Vn as A,In as B,ud as C,ts as D,uh as E,yd as F,Pr as G,Zd as H,rt as I,sh as J,$d as K,Yc as L,wu as M,Gh as N,Qc as O,Ju as P,cl as Q,vu as R,ul as S,Hl as T,Uh as U,yr as V,Qh as W,zd as X,Dh as Y,Nl as Z,Kh as _,Wh as a,Br as a0,Pd as a1,Fh as a2,zh as a3,Vh as a4,Xh as a5,Zh as a6,Yh as a7,bn as a8,Hd as a9,Ah as aa,Rh as ab,kh as ac,Mh as ad,_u as b,rh as c,Nh as d,jh as e,eh as f,Ll as g,ad as h,Jh as i,oh as j,ct as k,Hh as l,Dt as m,Oh as n,Lh as o,vd as p,xl as q,Bh as r,Th as s,qh as t,Xd as u,vr as v,jl as w,gu as x,xu as y,Ph as z};
//# sourceMappingURL=k7hb5o3308fwzisv.js.map
