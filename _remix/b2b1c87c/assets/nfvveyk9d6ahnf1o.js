const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/di4w8mhygh05jclj.js","assets/d4leej2qw3qpt1pk.js","assets/okxdn8hddblnp0ou.js","assets/root-eakuwlaq.css","assets/fi1eifnoy9tspxqm.js","assets/fz81i3fl330y5ew1.js","assets/conversation-small-eplmind9.css","assets/f2il2wfcdnz6iwbp.js","assets/kp4k2v7si1wz6dgb.js","assets/fn9y0pxu5hqktfmw.js","assets/mfpofkv0qdfmmagx.js","assets/is-scrollable-element-i34sjb0l.css","assets/ftyo1ydzzolwv3v6.js","assets/blb377wa0lv0gl05.js","assets/hyhugnup8jw7vymu.js","assets/c03cyiw531bfxkuh.js","assets/dywhugbdhvsxyyf5.js","assets/c6czee0ptvr50b6w.js","assets/ohxwppau79l98jz8.js","assets/nek0ozgkk626juis.js","assets/g6n33634fp88d2bg.js","assets/goojceouqjho7tc9.js","assets/jj9lp929lmdlnrht.js","assets/kd847zqymupw3yev.js","assets/code-composer-ausyy80t.css","assets/fk256ulgod2d482d.js","assets/mfrovjzsc3yawiw6.js","assets/omv76i1fiqjc3j0r.js","assets/irnny8s0apugp4gr.js","assets/document-composer-mym9u5r6.css","assets/g0qdp7qa568rqza7.js","assets/4e3zcddd66l56fc6.js","assets/g2ogs9oa3sb9y4ze.js","assets/n6iq8n6xr4ogpzm6.js","assets/nm04jgpfyxi6pn12.js","assets/iglrwjlxdh3icpw1.js","assets/shared-mk6ngktc.css","assets/goycyquo3djiwxwd.js","assets/sso-fjuqtgpha7i6x4xz.js","assets/d880uio2c3i9bnko.js","assets/fbejqq6xkkp9hmt5.js","assets/c13vup0gu3tk1kv4.js","assets/mky160t22to6y8z4.js","assets/g0ggnvciiiient2f.js","assets/k9b8ibmd34l2s7rd.js","assets/ifo1gwo96o35yr3m.js","assets/f491s4vcra306afi.js","assets/j5x20e3cnotdgagr.js","assets/j3aajcd1uncdq2rn.js","assets/kqwdyvkaaavvn8k3.js","assets/b970v26y0yx4oukl.js","assets/dymswf7pjm0wqy6r.js","assets/iazfttlgqgykzfz8.js","assets/f10yhb39esjv47gm.js","assets/e9lafxuzyeh4418f.js","assets/osllr6oq6akbkz8a.js","assets/nhwwej1nq0zrd7sc.js","assets/fjtjienn2n0zl6dg.js","assets/k9a54ncastppazlb.js","assets/6e9lp14n6vjshqtq.js","assets/d4t0vtbfqthmj7np.js","assets/9icnhfjc3wq4r4fn.js","assets/gcg3s799tx64lwzh.js","assets/g3ajm57p2xx770mv.js","assets/cctl8b8dlflw1lz8.js","assets/d22uwtmjvc8us5j2.js","assets/fk7wy2tezzqjl8gq.js","assets/kt44bkoo8dfxkuwr.js","assets/jesyc5hq0xl7nzpo.js","assets/lb6o9fdebdcca1rq.js","assets/fsmgl5eztdhnfu5c.js","assets/ejh88k8ctwkfva9x.js","assets/itpwdhausyf7xf4n.js","assets/mp1yjamy0e9l6nax.js","assets/hcrrbo4eq4gpr4et.js","assets/hv3qp4mvbheda0p7.js","assets/b9h9wk677xnlcnw9.js","assets/iej0cupg2dqkmejt.js","assets/d384fviu7zav49xw.js","assets/jk8w36bsokizpx57.js","assets/g3b9e2shfou6ou4d.js","assets/dah69ezv8syoxajs.js","assets/carousel-bss5aguy.css","assets/glb0ttf4q7286cw1.js","assets/dk5wzkmw29stdxh7.js","assets/g5k1tdwslualrsxd.js","assets/njxl8rloy69l92h2.js","assets/ggpt85ykxz9xv6kf.js","assets/g26qricaohxyll21.js","assets/bck3j7xja3lu93x3.js","assets/ojn3miceavy70dcb.js","assets/oasw20yvrsgthiuf.js","assets/eo413091ei8e08hn.js"])))=>i.map(i=>d[i]);
var Da=Object.defineProperty;var Ra=(i,e,t)=>e in i?Da(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var H=(i,e,t)=>Ra(i,typeof e!="symbol"?e+"":e,t);import{jC as Aa,jD as va,iH as Ba,jE as Fa,T as Gi,N as Pa,it as Vr,gQ as La,jF as ja,jG as ys,iu as za,jH as Va,jI as xs,h4 as Ua,gO as Ur,h8 as qa,as as Wa,gN as qr,jJ as Ki,eL as Ha,jK as Ja,hM as $a,jL as Ga,jM as Ka,jN as Ya,jO as Qa,jP as Za,eN as Xa,eO as el,hF as tl,gA as nl,gB as il,hI as sl,hJ as rl,hD as ol,gD as al,jQ as ll,g_ as cl,hL as Q,hK as Dn,gC as Ti,gP as ks,jR as dl,jS as ct,jT as Et,x as hl,jU as ul,jV as Mi,jW as fl,jX as pl,bi as bs,jY as Wr,aF as ml,jZ as gl,j_ as yl,hG as Hr,j$ as xl,cp as kl,aW as bl,aU as wl,cu as Sl,cv as Cl,hH as Tl,k0 as Ml,k1 as El,k2 as Il,gz as z,k3 as Nl,k4 as _l,k5 as Ol,k6 as Dl,k7 as Rl,k8 as Al,k9 as vl,ew as Bl,iA as Tn,ka as ai,kb as Fl,iy as Pl,iF as Ll,iG as Yi,kc as jl,kd as zl,iD as Vl,ke as rn,H as Jr,kf as Ul,kg as ql,kh as Wl,ki as Hl,kj as Jl,g1 as $r,A as Bn,dA as $l,kk as Gr,c as Gl,bg as Kl,V as Yl,kl as Ql,km as Zl,cc as Xl,v as ec,kn as tc,ko as nc,d as ic,kp as sc,kq as rc,kr as oc,ks as ac,kt as lc,ku as cc,c9 as dc,kv as Ei,E as Kr,kw as hc,dg as Qi,kx as Zi,ky as uc,kz as fc,kA as pc,kB as ge,kC as mc,kD as Rn,kE as Mn,kF as gc,kG as Yr,kH as yc,kI as xc,kJ as ws,kK as kc,bQ as bc,bC as Ss,bS as wc,kL as Sc,kM as Cc,kN as Tc,kO as Mc,jt as li,kP as Ec,W as Ic,kQ as Nc,kR as _c}from"./fz81i3fl330y5ew1.js";import{a7 as Tt,r as B,l as x,a1 as kn,a6 as Xi,aF as be,aG as ue,m as ne,fc as Oc,d5 as Gn,a5 as re,fO as Qr,ep as Dc,aJ as je,b5 as Cs,c as Rc,aP as Ac,fm as vc,fz as Zr,bP as Xr,O as Ts,Q as Ms,aw as es,Z as ht,aI as eo,cF as Bc,P as $e,V as _e,a3 as Ii,bO as Fc,fP as Pc,N as Lc,a$ as ts,M as Kn,bQ as jc,bR as zc,cB as Vc,D as He,fQ as to,eU as no,S as Yn,bF as lt,fR as Ni,R as ot,d_ as on,eN as Uc,bG as ft,fS as _i,d0 as qc,fT as io,v as Wc,e as Es,fU as Hc,fV as Is,fW as Ns,fX as Jc,cI as Oi,u as $c,dL as Gc,cH as Kc,cJ as _s,a as Yc,dc as Qc,aM as Zc,ad as Xc,bq as ed,d2 as td,e_ as nd}from"./d4leej2qw3qpt1pk.js";import{B as id,P as Fn}from"./ftyo1ydzzolwv3v6.js";import{a3 as sd,k as rd,b3 as od,J as ad,o as ld,al as cd,am as dd}from"./okxdn8hddblnp0ou.js";import{e as hd,h as so,i as ud,f as fd,j as pd,b as md}from"./blb377wa0lv0gl05.js";import{m as bt}from"./f2il2wfcdnz6iwbp.js";import{u as gd,J as yd,b as xd,U as kd,g as Os,d as bd,V as wd,W as Sd}from"./dywhugbdhvsxyyf5.js";import{l as ns,d as Pn,T as P,K as Cd,L as Td,b as Di,n as ro,i as is,M as Md,N as Ed}from"./hyhugnup8jw7vymu.js";import{i as oo,a as Id,g as Nd,b as _d,c as Od}from"./goojceouqjho7tc9.js";import{r as ao,s as Dd}from"./c6czee0ptvr50b6w.js";import{g as Rd}from"./jj9lp929lmdlnrht.js";import{T as Ad,u as vd}from"./kd847zqymupw3yev.js";const Bd=({onScroll:i})=>(Aa(({scrollTop:e})=>{i==null||i(e)}),null),Fd=({shouldScrollToTop:i})=>{const e=va();return B.useEffect(()=>{i===!0&&e({behavior:"smooth"})},[i,e]),null},Pd=()=>{const i=Ba();B.useEffect(()=>{i({behavior:"smooth"})},[i]);const[e]=Fa();return e?null:x.jsx("button",{onClick:()=>i({behavior:"smooth"}),className:"absolute bottom-5 right-1/2 z-10 flex h-8 w-8 translate-x-1/2 cursor-pointer items-center justify-center rounded-full border border-token-border-light bg-token-main-surface-primary bg-clip-padding text-token-text-secondary",children:x.jsx(sd,{className:"icon-md text-token-text-primary"})})},Ld=Tt.section`w-full h-full flex flex-col popover bg-token-main-surface-primary`,jd=({children:i,onScroll:e,shouldScrollToTop:t,scrollToBottomMode:n="top"},s)=>x.jsx("main",{className:"flex min-h-0 flex-auto flex-grow flex-col",ref:s,children:x.jsxs(id,{followButtonClassName:"hidden",initialScrollBehavior:"auto",className:"h-full",mode:n,children:[i,n==="bottom"&&x.jsx(Pd,{}),x.jsx(Bd,{onScroll:e}),x.jsx(Fd,{shouldScrollToTop:t})]})}),zd=B.forwardRef(jd),Vd=Tt.header`flex items-center justify-between p-3 h-14`,Ud=Tt.h2`ml-2.5 text-base text-lg text-gray-700 dark:text-token-text-secondary truncate`,qd=({onClick:i})=>{const e=kn();return x.jsx(Gi,{label:e.formatMessage(Wd.close),children:x.jsx(Pa,{icon:rd,onClick:i})})},$t=({children:i})=>x.jsx(Ld,{children:i});$t.Title=Ud;$t.CloseButton=qd;$t.Header=Vd;$t.Content=zd;const Wd=Xi({close:{id:"Bix/Kd",defaultMessage:"Close"}}),Hd=be(()=>ue(()=>import("./di4w8mhygh05jclj.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24])).then(i=>i.CodeComposer),{ssr:!1,loading:()=>x.jsx("div",{className:Vr.code,children:x.jsx("div",{className:"h-full w-full px-4",children:x.jsx(Fn,{lines:20})})})}),Jd=i=>x.jsx(Hd,{...i}),lo=()=>{const[{width:i},e]=La(),t=i>=ys+za?ys:Va;return x.jsx("div",{className:ne(Vr.document,"mt-4"),ref:e,style:{margin:`0 ${ja}px`},children:x.jsx("div",{style:{width:t},children:x.jsx(Fn,{lines:20})})})},$d=be(()=>ue(()=>import("./fk256ulgod2d482d.js"),__vite__mapDeps([25,1,2,3,9,5,6,4,7,10,11,26,14,27,28,15,12,13,16,17,18,19,20,21,22,23,29])).then(i=>i.DocumentComposer),{ssr:!1,loading:lo}),Gd=i=>x.jsx($d,{...i});function co(i,e,t){for(let n=0;;n++){if(n==i.childCount||n==e.childCount)return i.childCount==e.childCount?null:t;let s=i.child(n),r=e.child(n);if(s==r){t+=s.nodeSize;continue}if(!s.sameMarkup(r))return t;if(s.isText&&s.text!=r.text){for(let o=0;s.text[o]==r.text[o];o++)t++;return t}if(s.content.size||r.content.size){let o=co(s.content,r.content,t+1);if(o!=null)return o}t+=s.nodeSize}}function ho(i,e,t,n){for(let s=i.childCount,r=e.childCount;;){if(s==0||r==0)return s==r?null:{a:t,b:n};let o=i.child(--s),a=e.child(--r),l=o.nodeSize;if(o==a){t-=l,n-=l;continue}if(!o.sameMarkup(a))return{a:t,b:n};if(o.isText&&o.text!=a.text){let d=0,u=Math.min(o.text.length,a.text.length);for(;d<u&&o.text[o.text.length-d-1]==a.text[a.text.length-d-1];)d++,t--,n--;return{a:t,b:n}}if(o.content.size||a.content.size){let d=ho(o.content,a.content,t-1,n-1);if(d)return d}t-=l,n-=l}}class _{constructor(e,t){if(this.content=e,this.size=t||0,t==null)for(let n=0;n<e.length;n++)this.size+=e[n].nodeSize}nodesBetween(e,t,n,s=0,r){for(let o=0,a=0;a<t;o++){let l=this.content[o],d=a+l.nodeSize;if(d>e&&n(l,s+a,r||null,o)!==!1&&l.content.size){let u=a+1;l.nodesBetween(Math.max(0,e-u),Math.min(l.content.size,t-u),n,s+u)}a=d}}descendants(e){this.nodesBetween(0,this.size,e)}textBetween(e,t,n,s){let r="",o=!0;return this.nodesBetween(e,t,(a,l)=>{let d=a.isText?a.text.slice(Math.max(e,l)-l,t-l):a.isLeaf?s?typeof s=="function"?s(a):s:a.type.spec.leafText?a.type.spec.leafText(a):"":"";a.isBlock&&(a.isLeaf&&d||a.isTextblock)&&n&&(o?o=!1:r+=n),r+=d},0),r}append(e){if(!e.size)return this;if(!this.size)return e;let t=this.lastChild,n=e.firstChild,s=this.content.slice(),r=0;for(t.isText&&t.sameMarkup(n)&&(s[s.length-1]=t.withText(t.text+n.text),r=1);r<e.content.length;r++)s.push(e.content[r]);return new _(s,this.size+e.size)}cut(e,t=this.size){if(e==0&&t==this.size)return this;let n=[],s=0;if(t>e)for(let r=0,o=0;o<t;r++){let a=this.content[r],l=o+a.nodeSize;l>e&&((o<e||l>t)&&(a.isText?a=a.cut(Math.max(0,e-o),Math.min(a.text.length,t-o)):a=a.cut(Math.max(0,e-o-1),Math.min(a.content.size,t-o-1))),n.push(a),s+=a.nodeSize),o=l}return new _(n,s)}cutByIndex(e,t){return e==t?_.empty:e==0&&t==this.content.length?this:new _(this.content.slice(e,t))}replaceChild(e,t){let n=this.content[e];if(n==t)return this;let s=this.content.slice(),r=this.size+t.nodeSize-n.nodeSize;return s[e]=t,new _(s,r)}addToStart(e){return new _([e].concat(this.content),this.size+e.nodeSize)}addToEnd(e){return new _(this.content.concat(e),this.size+e.nodeSize)}eq(e){if(this.content.length!=e.content.length)return!1;for(let t=0;t<this.content.length;t++)if(!this.content[t].eq(e.content[t]))return!1;return!0}get firstChild(){return this.content.length?this.content[0]:null}get lastChild(){return this.content.length?this.content[this.content.length-1]:null}get childCount(){return this.content.length}child(e){let t=this.content[e];if(!t)throw new RangeError("Index "+e+" out of range for "+this);return t}maybeChild(e){return this.content[e]||null}forEach(e){for(let t=0,n=0;t<this.content.length;t++){let s=this.content[t];e(s,n,t),n+=s.nodeSize}}findDiffStart(e,t=0){return co(this,e,t)}findDiffEnd(e,t=this.size,n=e.size){return ho(this,e,t,n)}findIndex(e,t=-1){if(e==0)return En(0,e);if(e==this.size)return En(this.content.length,e);if(e>this.size||e<0)throw new RangeError(`Position ${e} outside of fragment (${this})`);for(let n=0,s=0;;n++){let r=this.child(n),o=s+r.nodeSize;if(o>=e)return o==e||t>0?En(n+1,o):En(n,s);s=o}}toString(){return"<"+this.toStringInner()+">"}toStringInner(){return this.content.join(", ")}toJSON(){return this.content.length?this.content.map(e=>e.toJSON()):null}static fromJSON(e,t){if(!t)return _.empty;if(!Array.isArray(t))throw new RangeError("Invalid input for Fragment.fromJSON");return new _(t.map(e.nodeFromJSON))}static fromArray(e){if(!e.length)return _.empty;let t,n=0;for(let s=0;s<e.length;s++){let r=e[s];n+=r.nodeSize,s&&r.isText&&e[s-1].sameMarkup(r)?(t||(t=e.slice(0,s)),t[t.length-1]=r.withText(t[t.length-1].text+r.text)):t&&t.push(r)}return new _(t||e,n)}static from(e){if(!e)return _.empty;if(e instanceof _)return e;if(Array.isArray(e))return this.fromArray(e);if(e.attrs)return new _([e],e.nodeSize);throw new RangeError("Can not convert "+e+" to a Fragment"+(e.nodesBetween?" (looks like multiple versions of prosemirror-model were loaded)":""))}}_.empty=new _([],0);const ci={index:0,offset:0};function En(i,e){return ci.index=i,ci.offset=e,ci}function Ln(i,e){if(i===e)return!0;if(!(i&&typeof i=="object")||!(e&&typeof e=="object"))return!1;let t=Array.isArray(i);if(Array.isArray(e)!=t)return!1;if(t){if(i.length!=e.length)return!1;for(let n=0;n<i.length;n++)if(!Ln(i[n],e[n]))return!1}else{for(let n in i)if(!(n in e)||!Ln(i[n],e[n]))return!1;for(let n in e)if(!(n in i))return!1}return!0}class J{constructor(e,t){this.type=e,this.attrs=t}addToSet(e){let t,n=!1;for(let s=0;s<e.length;s++){let r=e[s];if(this.eq(r))return e;if(this.type.excludes(r.type))t||(t=e.slice(0,s));else{if(r.type.excludes(this.type))return e;!n&&r.type.rank>this.type.rank&&(t||(t=e.slice(0,s)),t.push(this),n=!0),t&&t.push(r)}}return t||(t=e.slice()),n||t.push(this),t}removeFromSet(e){for(let t=0;t<e.length;t++)if(this.eq(e[t]))return e.slice(0,t).concat(e.slice(t+1));return e}isInSet(e){for(let t=0;t<e.length;t++)if(this.eq(e[t]))return!0;return!1}eq(e){return this==e||this.type==e.type&&Ln(this.attrs,e.attrs)}toJSON(){let e={type:this.type.name};for(let t in this.attrs){e.attrs=this.attrs;break}return e}static fromJSON(e,t){if(!t)throw new RangeError("Invalid input for Mark.fromJSON");let n=e.marks[t.type];if(!n)throw new RangeError(`There is no mark type ${t.type} in this schema`);let s=n.create(t.attrs);return n.checkAttrs(s.attrs),s}static sameSet(e,t){if(e==t)return!0;if(e.length!=t.length)return!1;for(let n=0;n<e.length;n++)if(!e[n].eq(t[n]))return!1;return!0}static setFrom(e){if(!e||Array.isArray(e)&&e.length==0)return J.none;if(e instanceof J)return[e];let t=e.slice();return t.sort((n,s)=>n.type.rank-s.type.rank),t}}J.none=[];class jn extends Error{}class v{constructor(e,t,n){this.content=e,this.openStart=t,this.openEnd=n}get size(){return this.content.size-this.openStart-this.openEnd}insertAt(e,t){let n=fo(this.content,e+this.openStart,t);return n&&new v(n,this.openStart,this.openEnd)}removeBetween(e,t){return new v(uo(this.content,e+this.openStart,t+this.openStart),this.openStart,this.openEnd)}eq(e){return this.content.eq(e.content)&&this.openStart==e.openStart&&this.openEnd==e.openEnd}toString(){return this.content+"("+this.openStart+","+this.openEnd+")"}toJSON(){if(!this.content.size)return null;let e={content:this.content.toJSON()};return this.openStart>0&&(e.openStart=this.openStart),this.openEnd>0&&(e.openEnd=this.openEnd),e}static fromJSON(e,t){if(!t)return v.empty;let n=t.openStart||0,s=t.openEnd||0;if(typeof n!="number"||typeof s!="number")throw new RangeError("Invalid input for Slice.fromJSON");return new v(_.fromJSON(e,t.content),n,s)}static maxOpen(e,t=!0){let n=0,s=0;for(let r=e.firstChild;r&&!r.isLeaf&&(t||!r.type.spec.isolating);r=r.firstChild)n++;for(let r=e.lastChild;r&&!r.isLeaf&&(t||!r.type.spec.isolating);r=r.lastChild)s++;return new v(e,n,s)}}v.empty=new v(_.empty,0,0);function uo(i,e,t){let{index:n,offset:s}=i.findIndex(e),r=i.maybeChild(n),{index:o,offset:a}=i.findIndex(t);if(s==e||r.isText){if(a!=t&&!i.child(o).isText)throw new RangeError("Removing non-flat range");return i.cut(0,e).append(i.cut(t))}if(n!=o)throw new RangeError("Removing non-flat range");return i.replaceChild(n,r.copy(uo(r.content,e-s-1,t-s-1)))}function fo(i,e,t,n){let{index:s,offset:r}=i.findIndex(e),o=i.maybeChild(s);if(r==e||o.isText)return i.cut(0,e).append(t).append(i.cut(e));let a=fo(o.content,e-r-1,t);return a&&i.replaceChild(s,o.copy(a))}function Kd(i,e,t){if(t.openStart>i.depth)throw new jn("Inserted content deeper than insertion position");if(i.depth-t.openStart!=e.depth-t.openEnd)throw new jn("Inconsistent open depths");return po(i,e,t,0)}function po(i,e,t,n){let s=i.index(n),r=i.node(n);if(s==e.index(n)&&n<i.depth-t.openStart){let o=po(i,e,t,n+1);return r.copy(r.content.replaceChild(s,o))}else if(t.content.size)if(!t.openStart&&!t.openEnd&&i.depth==n&&e.depth==n){let o=i.parent,a=o.content;return Dt(o,a.cut(0,i.parentOffset).append(t.content).append(a.cut(e.parentOffset)))}else{let{start:o,end:a}=Yd(t,i);return Dt(r,go(i,o,a,e,n))}else return Dt(r,zn(i,e,n))}function mo(i,e){if(!e.type.compatibleContent(i.type))throw new jn("Cannot join "+e.type.name+" onto "+i.type.name)}function Ri(i,e,t){let n=i.node(t);return mo(n,e.node(t)),n}function Ot(i,e){let t=e.length-1;t>=0&&i.isText&&i.sameMarkup(e[t])?e[t]=i.withText(e[t].text+i.text):e.push(i)}function an(i,e,t,n){let s=(e||i).node(t),r=0,o=e?e.index(t):s.childCount;i&&(r=i.index(t),i.depth>t?r++:i.textOffset&&(Ot(i.nodeAfter,n),r++));for(let a=r;a<o;a++)Ot(s.child(a),n);e&&e.depth==t&&e.textOffset&&Ot(e.nodeBefore,n)}function Dt(i,e){return i.type.checkContent(e),i.copy(e)}function go(i,e,t,n,s){let r=i.depth>s&&Ri(i,e,s+1),o=n.depth>s&&Ri(t,n,s+1),a=[];return an(null,i,s,a),r&&o&&e.index(s)==t.index(s)?(mo(r,o),Ot(Dt(r,go(i,e,t,n,s+1)),a)):(r&&Ot(Dt(r,zn(i,e,s+1)),a),an(e,t,s,a),o&&Ot(Dt(o,zn(t,n,s+1)),a)),an(n,null,s,a),new _(a)}function zn(i,e,t){let n=[];if(an(null,i,t,n),i.depth>t){let s=Ri(i,e,t+1);Ot(Dt(s,zn(i,e,t+1)),n)}return an(e,null,t,n),new _(n)}function Yd(i,e){let t=e.depth-i.openStart,s=e.node(t).copy(i.content);for(let r=t-1;r>=0;r--)s=e.node(r).copy(_.from(s));return{start:s.resolveNoCache(i.openStart+t),end:s.resolveNoCache(s.content.size-i.openEnd-t)}}class un{constructor(e,t,n){this.pos=e,this.path=t,this.parentOffset=n,this.depth=t.length/3-1}resolveDepth(e){return e==null?this.depth:e<0?this.depth+e:e}get parent(){return this.node(this.depth)}get doc(){return this.node(0)}node(e){return this.path[this.resolveDepth(e)*3]}index(e){return this.path[this.resolveDepth(e)*3+1]}indexAfter(e){return e=this.resolveDepth(e),this.index(e)+(e==this.depth&&!this.textOffset?0:1)}start(e){return e=this.resolveDepth(e),e==0?0:this.path[e*3-1]+1}end(e){return e=this.resolveDepth(e),this.start(e)+this.node(e).content.size}before(e){if(e=this.resolveDepth(e),!e)throw new RangeError("There is no position before the top-level node");return e==this.depth+1?this.pos:this.path[e*3-1]}after(e){if(e=this.resolveDepth(e),!e)throw new RangeError("There is no position after the top-level node");return e==this.depth+1?this.pos:this.path[e*3-1]+this.path[e*3].nodeSize}get textOffset(){return this.pos-this.path[this.path.length-1]}get nodeAfter(){let e=this.parent,t=this.index(this.depth);if(t==e.childCount)return null;let n=this.pos-this.path[this.path.length-1],s=e.child(t);return n?e.child(t).cut(n):s}get nodeBefore(){let e=this.index(this.depth),t=this.pos-this.path[this.path.length-1];return t?this.parent.child(e).cut(0,t):e==0?null:this.parent.child(e-1)}posAtIndex(e,t){t=this.resolveDepth(t);let n=this.path[t*3],s=t==0?0:this.path[t*3-1]+1;for(let r=0;r<e;r++)s+=n.child(r).nodeSize;return s}marks(){let e=this.parent,t=this.index();if(e.content.size==0)return J.none;if(this.textOffset)return e.child(t).marks;let n=e.maybeChild(t-1),s=e.maybeChild(t);if(!n){let a=n;n=s,s=a}let r=n.marks;for(var o=0;o<r.length;o++)r[o].type.spec.inclusive===!1&&(!s||!r[o].isInSet(s.marks))&&(r=r[o--].removeFromSet(r));return r}marksAcross(e){let t=this.parent.maybeChild(this.index());if(!t||!t.isInline)return null;let n=t.marks,s=e.parent.maybeChild(e.index());for(var r=0;r<n.length;r++)n[r].type.spec.inclusive===!1&&(!s||!n[r].isInSet(s.marks))&&(n=n[r--].removeFromSet(n));return n}sharedDepth(e){for(let t=this.depth;t>0;t--)if(this.start(t)<=e&&this.end(t)>=e)return t;return 0}blockRange(e=this,t){if(e.pos<this.pos)return e.blockRange(this);for(let n=this.depth-(this.parent.inlineContent||this.pos==e.pos?1:0);n>=0;n--)if(e.pos<=this.end(n)&&(!t||t(this.node(n))))return new Xd(this,e,n);return null}sameParent(e){return this.pos-this.parentOffset==e.pos-e.parentOffset}max(e){return e.pos>this.pos?e:this}min(e){return e.pos<this.pos?e:this}toString(){let e="";for(let t=1;t<=this.depth;t++)e+=(e?"/":"")+this.node(t).type.name+"_"+this.index(t-1);return e+":"+this.parentOffset}static resolve(e,t){if(!(t>=0&&t<=e.content.size))throw new RangeError("Position "+t+" out of range");let n=[],s=0,r=t;for(let o=e;;){let{index:a,offset:l}=o.content.findIndex(r),d=r-l;if(n.push(o,a,s+l),!d||(o=o.child(a),o.isText))break;r=d-1,s+=l+1}return new un(t,n,r)}static resolveCached(e,t){let n=Ds.get(e);if(n)for(let r=0;r<n.elts.length;r++){let o=n.elts[r];if(o.pos==t)return o}else Ds.set(e,n=new Qd);let s=n.elts[n.i]=un.resolve(e,t);return n.i=(n.i+1)%Zd,s}}class Qd{constructor(){this.elts=[],this.i=0}}const Zd=12,Ds=new WeakMap;class Xd{constructor(e,t,n){this.$from=e,this.$to=t,this.depth=n}get start(){return this.$from.before(this.depth+1)}get end(){return this.$to.after(this.depth+1)}get parent(){return this.$from.node(this.depth)}get startIndex(){return this.$from.index(this.depth)}get endIndex(){return this.$to.indexAfter(this.depth)}}const eh=Object.create(null);class et{constructor(e,t,n,s=J.none){this.type=e,this.attrs=t,this.marks=s,this.content=n||_.empty}get nodeSize(){return this.isLeaf?1:2+this.content.size}get childCount(){return this.content.childCount}child(e){return this.content.child(e)}maybeChild(e){return this.content.maybeChild(e)}forEach(e){this.content.forEach(e)}nodesBetween(e,t,n,s=0){this.content.nodesBetween(e,t,n,s,this)}descendants(e){this.nodesBetween(0,this.content.size,e)}get textContent(){return this.isLeaf&&this.type.spec.leafText?this.type.spec.leafText(this):this.textBetween(0,this.content.size,"")}textBetween(e,t,n,s){return this.content.textBetween(e,t,n,s)}get firstChild(){return this.content.firstChild}get lastChild(){return this.content.lastChild}eq(e){return this==e||this.sameMarkup(e)&&this.content.eq(e.content)}sameMarkup(e){return this.hasMarkup(e.type,e.attrs,e.marks)}hasMarkup(e,t,n){return this.type==e&&Ln(this.attrs,t||e.defaultAttrs||eh)&&J.sameSet(this.marks,n||J.none)}copy(e=null){return e==this.content?this:new et(this.type,this.attrs,e,this.marks)}mark(e){return e==this.marks?this:new et(this.type,this.attrs,this.content,e)}cut(e,t=this.content.size){return e==0&&t==this.content.size?this:this.copy(this.content.cut(e,t))}slice(e,t=this.content.size,n=!1){if(e==t)return v.empty;let s=this.resolve(e),r=this.resolve(t),o=n?0:s.sharedDepth(t),a=s.start(o),d=s.node(o).content.cut(s.pos-a,r.pos-a);return new v(d,s.depth-o,r.depth-o)}replace(e,t,n){return Kd(this.resolve(e),this.resolve(t),n)}nodeAt(e){for(let t=this;;){let{index:n,offset:s}=t.content.findIndex(e);if(t=t.maybeChild(n),!t)return null;if(s==e||t.isText)return t;e-=s+1}}childAfter(e){let{index:t,offset:n}=this.content.findIndex(e);return{node:this.content.maybeChild(t),index:t,offset:n}}childBefore(e){if(e==0)return{node:null,index:0,offset:0};let{index:t,offset:n}=this.content.findIndex(e);if(n<e)return{node:this.content.child(t),index:t,offset:n};let s=this.content.child(t-1);return{node:s,index:t-1,offset:n-s.nodeSize}}resolve(e){return un.resolveCached(this,e)}resolveNoCache(e){return un.resolve(this,e)}rangeHasMark(e,t,n){let s=!1;return t>e&&this.nodesBetween(e,t,r=>(n.isInSet(r.marks)&&(s=!0),!s)),s}get isBlock(){return this.type.isBlock}get isTextblock(){return this.type.isTextblock}get inlineContent(){return this.type.inlineContent}get isInline(){return this.type.isInline}get isText(){return this.type.isText}get isLeaf(){return this.type.isLeaf}get isAtom(){return this.type.isAtom}toString(){if(this.type.spec.toDebugString)return this.type.spec.toDebugString(this);let e=this.type.name;return this.content.size&&(e+="("+this.content.toStringInner()+")"),yo(this.marks,e)}contentMatchAt(e){let t=this.type.contentMatch.matchFragment(this.content,0,e);if(!t)throw new Error("Called contentMatchAt on a node with invalid content");return t}canReplace(e,t,n=_.empty,s=0,r=n.childCount){let o=this.contentMatchAt(e).matchFragment(n,s,r),a=o&&o.matchFragment(this.content,t);if(!a||!a.validEnd)return!1;for(let l=s;l<r;l++)if(!this.type.allowsMarks(n.child(l).marks))return!1;return!0}canReplaceWith(e,t,n,s){if(s&&!this.type.allowsMarks(s))return!1;let r=this.contentMatchAt(e).matchType(n),o=r&&r.matchFragment(this.content,t);return o?o.validEnd:!1}canAppend(e){return e.content.size?this.canReplace(this.childCount,this.childCount,e.content):this.type.compatibleContent(e.type)}check(){this.type.checkContent(this.content),this.type.checkAttrs(this.attrs);let e=J.none;for(let t=0;t<this.marks.length;t++){let n=this.marks[t];n.type.checkAttrs(n.attrs),e=n.addToSet(e)}if(!J.sameSet(e,this.marks))throw new RangeError(`Invalid collection of marks for node ${this.type.name}: ${this.marks.map(t=>t.type.name)}`);this.content.forEach(t=>t.check())}toJSON(){let e={type:this.type.name};for(let t in this.attrs){e.attrs=this.attrs;break}return this.content.size&&(e.content=this.content.toJSON()),this.marks.length&&(e.marks=this.marks.map(t=>t.toJSON())),e}static fromJSON(e,t){if(!t)throw new RangeError("Invalid input for Node.fromJSON");let n;if(t.marks){if(!Array.isArray(t.marks))throw new RangeError("Invalid mark data for Node.fromJSON");n=t.marks.map(e.markFromJSON)}if(t.type=="text"){if(typeof t.text!="string")throw new RangeError("Invalid text node in JSON");return e.text(t.text,n)}let s=_.fromJSON(e,t.content),r=e.nodeType(t.type).create(t.attrs,s,n);return r.type.checkAttrs(r.attrs),r}}et.prototype.text=void 0;class Vn extends et{constructor(e,t,n,s){if(super(e,t,null,s),!n)throw new RangeError("Empty text nodes are not allowed");this.text=n}toString(){return this.type.spec.toDebugString?this.type.spec.toDebugString(this):yo(this.marks,JSON.stringify(this.text))}get textContent(){return this.text}textBetween(e,t){return this.text.slice(e,t)}get nodeSize(){return this.text.length}mark(e){return e==this.marks?this:new Vn(this.type,this.attrs,this.text,e)}withText(e){return e==this.text?this:new Vn(this.type,this.attrs,e,this.marks)}cut(e=0,t=this.text.length){return e==0&&t==this.text.length?this:this.withText(this.text.slice(e,t))}eq(e){return this.sameMarkup(e)&&this.text==e.text}toJSON(){let e=super.toJSON();return e.text=this.text,e}}function yo(i,e){for(let t=i.length-1;t>=0;t--)e=i[t].type.name+"("+e+")";return e}class vt{constructor(e){this.validEnd=e,this.next=[],this.wrapCache=[]}static parse(e,t){let n=new th(e,t);if(n.next==null)return vt.empty;let s=xo(n);n.next&&n.err("Unexpected trailing text");let r=lh(ah(s));return ch(r,n),r}matchType(e){for(let t=0;t<this.next.length;t++)if(this.next[t].type==e)return this.next[t].next;return null}matchFragment(e,t=0,n=e.childCount){let s=this;for(let r=t;s&&r<n;r++)s=s.matchType(e.child(r).type);return s}get inlineContent(){return this.next.length!=0&&this.next[0].type.isInline}get defaultType(){for(let e=0;e<this.next.length;e++){let{type:t}=this.next[e];if(!(t.isText||t.hasRequiredAttrs()))return t}return null}compatible(e){for(let t=0;t<this.next.length;t++)for(let n=0;n<e.next.length;n++)if(this.next[t].type==e.next[n].type)return!0;return!1}fillBefore(e,t=!1,n=0){let s=[this];function r(o,a){let l=o.matchFragment(e,n);if(l&&(!t||l.validEnd))return _.from(a.map(d=>d.createAndFill()));for(let d=0;d<o.next.length;d++){let{type:u,next:m}=o.next[d];if(!(u.isText||u.hasRequiredAttrs())&&s.indexOf(m)==-1){s.push(m);let p=r(m,a.concat(u));if(p)return p}}return null}return r(this,[])}findWrapping(e){for(let n=0;n<this.wrapCache.length;n+=2)if(this.wrapCache[n]==e)return this.wrapCache[n+1];let t=this.computeWrapping(e);return this.wrapCache.push(e,t),t}computeWrapping(e){let t=Object.create(null),n=[{match:this,type:null,via:null}];for(;n.length;){let s=n.shift(),r=s.match;if(r.matchType(e)){let o=[];for(let a=s;a.type;a=a.via)o.push(a.type);return o.reverse()}for(let o=0;o<r.next.length;o++){let{type:a,next:l}=r.next[o];!a.isLeaf&&!a.hasRequiredAttrs()&&!(a.name in t)&&(!s.type||l.validEnd)&&(n.push({match:a.contentMatch,type:a,via:s}),t[a.name]=!0)}}return null}get edgeCount(){return this.next.length}edge(e){if(e>=this.next.length)throw new RangeError(`There's no ${e}th edge in this content match`);return this.next[e]}toString(){let e=[];function t(n){e.push(n);for(let s=0;s<n.next.length;s++)e.indexOf(n.next[s].next)==-1&&t(n.next[s].next)}return t(this),e.map((n,s)=>{let r=s+(n.validEnd?"*":" ")+" ";for(let o=0;o<n.next.length;o++)r+=(o?", ":"")+n.next[o].type.name+"->"+e.indexOf(n.next[o].next);return r}).join(`
`)}}vt.empty=new vt(!0);class th{constructor(e,t){this.string=e,this.nodeTypes=t,this.inline=null,this.pos=0,this.tokens=e.split(/\s*(?=\b|\W|$)/),this.tokens[this.tokens.length-1]==""&&this.tokens.pop(),this.tokens[0]==""&&this.tokens.shift()}get next(){return this.tokens[this.pos]}eat(e){return this.next==e&&(this.pos++||!0)}err(e){throw new SyntaxError(e+" (in content expression '"+this.string+"')")}}function xo(i){let e=[];do e.push(nh(i));while(i.eat("|"));return e.length==1?e[0]:{type:"choice",exprs:e}}function nh(i){let e=[];do e.push(ih(i));while(i.next&&i.next!=")"&&i.next!="|");return e.length==1?e[0]:{type:"seq",exprs:e}}function ih(i){let e=oh(i);for(;;)if(i.eat("+"))e={type:"plus",expr:e};else if(i.eat("*"))e={type:"star",expr:e};else if(i.eat("?"))e={type:"opt",expr:e};else if(i.eat("{"))e=sh(i,e);else break;return e}function Rs(i){/\D/.test(i.next)&&i.err("Expected number, got '"+i.next+"'");let e=Number(i.next);return i.pos++,e}function sh(i,e){let t=Rs(i),n=t;return i.eat(",")&&(i.next!="}"?n=Rs(i):n=-1),i.eat("}")||i.err("Unclosed braced range"),{type:"range",min:t,max:n,expr:e}}function rh(i,e){let t=i.nodeTypes,n=t[e];if(n)return[n];let s=[];for(let r in t){let o=t[r];o.groups.indexOf(e)>-1&&s.push(o)}return s.length==0&&i.err("No node type or group '"+e+"' found"),s}function oh(i){if(i.eat("(")){let e=xo(i);return i.eat(")")||i.err("Missing closing paren"),e}else if(/\W/.test(i.next))i.err("Unexpected token '"+i.next+"'");else{let e=rh(i,i.next).map(t=>(i.inline==null?i.inline=t.isInline:i.inline!=t.isInline&&i.err("Mixing inline and block content"),{type:"name",value:t}));return i.pos++,e.length==1?e[0]:{type:"choice",exprs:e}}}function ah(i){let e=[[]];return s(r(i,0),t()),e;function t(){return e.push([])-1}function n(o,a,l){let d={term:l,to:a};return e[o].push(d),d}function s(o,a){o.forEach(l=>l.to=a)}function r(o,a){if(o.type=="choice")return o.exprs.reduce((l,d)=>l.concat(r(d,a)),[]);if(o.type=="seq")for(let l=0;;l++){let d=r(o.exprs[l],a);if(l==o.exprs.length-1)return d;s(d,a=t())}else if(o.type=="star"){let l=t();return n(a,l),s(r(o.expr,l),l),[n(l)]}else if(o.type=="plus"){let l=t();return s(r(o.expr,a),l),s(r(o.expr,l),l),[n(l)]}else{if(o.type=="opt")return[n(a)].concat(r(o.expr,a));if(o.type=="range"){let l=a;for(let d=0;d<o.min;d++){let u=t();s(r(o.expr,l),u),l=u}if(o.max==-1)s(r(o.expr,l),l);else for(let d=o.min;d<o.max;d++){let u=t();n(l,u),s(r(o.expr,l),u),l=u}return[n(l)]}else{if(o.type=="name")return[n(a,void 0,o.value)];throw new Error("Unknown expr type")}}}}function ko(i,e){return e-i}function As(i,e){let t=[];return n(e),t.sort(ko);function n(s){let r=i[s];if(r.length==1&&!r[0].term)return n(r[0].to);t.push(s);for(let o=0;o<r.length;o++){let{term:a,to:l}=r[o];!a&&t.indexOf(l)==-1&&n(l)}}}function lh(i){let e=Object.create(null);return t(As(i,0));function t(n){let s=[];n.forEach(o=>{i[o].forEach(({term:a,to:l})=>{if(!a)return;let d;for(let u=0;u<s.length;u++)s[u][0]==a&&(d=s[u][1]);As(i,l).forEach(u=>{d||s.push([a,d=[]]),d.indexOf(u)==-1&&d.push(u)})})});let r=e[n.join(",")]=new vt(n.indexOf(i.length-1)>-1);for(let o=0;o<s.length;o++){let a=s[o][1].sort(ko);r.next.push({type:s[o][0],next:e[a.join(",")]||t(a)})}return r}}function ch(i,e){for(let t=0,n=[i];t<n.length;t++){let s=n[t],r=!s.validEnd,o=[];for(let a=0;a<s.next.length;a++){let{type:l,next:d}=s.next[a];o.push(l.name),r&&!(l.isText||l.hasRequiredAttrs())&&(r=!1),n.indexOf(d)==-1&&n.push(d)}r&&e.err("Only non-generatable nodes ("+o.join(", ")+") in a required position (see https://prosemirror.net/docs/guide/#generatable)")}}function bo(i){let e=Object.create(null);for(let t in i){let n=i[t];if(!n.hasDefault)return null;e[t]=n.default}return e}function wo(i,e){let t=Object.create(null);for(let n in i){let s=e&&e[n];if(s===void 0){let r=i[n];if(r.hasDefault)s=r.default;else throw new RangeError("No value supplied for attribute "+n)}t[n]=s}return t}function So(i,e,t,n){for(let s in e)if(!(s in i))throw new RangeError(`Unsupported attribute ${s} for ${t} of type ${s}`);for(let s in i){let r=i[s];r.validate&&r.validate(e[s])}}function Co(i,e){let t=Object.create(null);if(e)for(let n in e)t[n]=new hh(i,n,e[n]);return t}let vs=class To{constructor(e,t,n){this.name=e,this.schema=t,this.spec=n,this.markSet=null,this.groups=n.group?n.group.split(" "):[],this.attrs=Co(e,n.attrs),this.defaultAttrs=bo(this.attrs),this.contentMatch=null,this.inlineContent=null,this.isBlock=!(n.inline||e=="text"),this.isText=e=="text"}get isInline(){return!this.isBlock}get isTextblock(){return this.isBlock&&this.inlineContent}get isLeaf(){return this.contentMatch==vt.empty}get isAtom(){return this.isLeaf||!!this.spec.atom}get whitespace(){return this.spec.whitespace||(this.spec.code?"pre":"normal")}hasRequiredAttrs(){for(let e in this.attrs)if(this.attrs[e].isRequired)return!0;return!1}compatibleContent(e){return this==e||this.contentMatch.compatible(e.contentMatch)}computeAttrs(e){return!e&&this.defaultAttrs?this.defaultAttrs:wo(this.attrs,e)}create(e=null,t,n){if(this.isText)throw new Error("NodeType.create can't construct text nodes");return new et(this,this.computeAttrs(e),_.from(t),J.setFrom(n))}createChecked(e=null,t,n){return t=_.from(t),this.checkContent(t),new et(this,this.computeAttrs(e),t,J.setFrom(n))}createAndFill(e=null,t,n){if(e=this.computeAttrs(e),t=_.from(t),t.size){let o=this.contentMatch.fillBefore(t);if(!o)return null;t=o.append(t)}let s=this.contentMatch.matchFragment(t),r=s&&s.fillBefore(_.empty,!0);return r?new et(this,e,t.append(r),J.setFrom(n)):null}validContent(e){let t=this.contentMatch.matchFragment(e);if(!t||!t.validEnd)return!1;for(let n=0;n<e.childCount;n++)if(!this.allowsMarks(e.child(n).marks))return!1;return!0}checkContent(e){if(!this.validContent(e))throw new RangeError(`Invalid content for node ${this.name}: ${e.toString().slice(0,50)}`)}checkAttrs(e){So(this.attrs,e,"node",this.name)}allowsMarkType(e){return this.markSet==null||this.markSet.indexOf(e)>-1}allowsMarks(e){if(this.markSet==null)return!0;for(let t=0;t<e.length;t++)if(!this.allowsMarkType(e[t].type))return!1;return!0}allowedMarks(e){if(this.markSet==null)return e;let t;for(let n=0;n<e.length;n++)this.allowsMarkType(e[n].type)?t&&t.push(e[n]):t||(t=e.slice(0,n));return t?t.length?t:J.none:e}static compile(e,t){let n=Object.create(null);e.forEach((r,o)=>n[r]=new To(r,t,o));let s=t.spec.topNode||"doc";if(!n[s])throw new RangeError("Schema is missing its top node type ('"+s+"')");if(!n.text)throw new RangeError("Every schema needs a 'text' type");for(let r in n.text.attrs)throw new RangeError("The text node type should not have attributes");return n}};function dh(i,e,t){let n=t.split("|");return s=>{let r=s===null?"null":typeof s;if(n.indexOf(r)<0)throw new RangeError(`Expected value of type ${n} for attribute ${e} on type ${i}, got ${r}`)}}class hh{constructor(e,t,n){this.hasDefault=Object.prototype.hasOwnProperty.call(n,"default"),this.default=n.default,this.validate=typeof n.validate=="string"?dh(e,t,n.validate):n.validate}get isRequired(){return!this.hasDefault}}class Qn{constructor(e,t,n,s){this.name=e,this.rank=t,this.schema=n,this.spec=s,this.attrs=Co(e,s.attrs),this.excluded=null;let r=bo(this.attrs);this.instance=r?new J(this,r):null}create(e=null){return!e&&this.instance?this.instance:new J(this,wo(this.attrs,e))}static compile(e,t){let n=Object.create(null),s=0;return e.forEach((r,o)=>n[r]=new Qn(r,s++,t,o)),n}removeFromSet(e){for(var t=0;t<e.length;t++)e[t].type==this&&(e=e.slice(0,t).concat(e.slice(t+1)),t--);return e}isInSet(e){for(let t=0;t<e.length;t++)if(e[t].type==this)return e[t]}checkAttrs(e){So(this.attrs,e,"mark",this.name)}excludes(e){return this.excluded.indexOf(e)>-1}}class Rm{constructor(e){this.linebreakReplacement=null,this.cached=Object.create(null);let t=this.spec={};for(let s in e)t[s]=e[s];t.nodes=xs.from(e.nodes),t.marks=xs.from(e.marks||{}),this.nodes=vs.compile(this.spec.nodes,this),this.marks=Qn.compile(this.spec.marks,this);let n=Object.create(null);for(let s in this.nodes){if(s in this.marks)throw new RangeError(s+" can not be both a node and a mark");let r=this.nodes[s],o=r.spec.content||"",a=r.spec.marks;if(r.contentMatch=n[o]||(n[o]=vt.parse(o,this.nodes)),r.inlineContent=r.contentMatch.inlineContent,r.spec.linebreakReplacement){if(this.linebreakReplacement)throw new RangeError("Multiple linebreak nodes defined");if(!r.isInline||!r.isLeaf)throw new RangeError("Linebreak replacement nodes must be inline leaf nodes");this.linebreakReplacement=r}r.markSet=a=="_"?null:a?Bs(this,a.split(" ")):a==""||!r.inlineContent?[]:null}for(let s in this.marks){let r=this.marks[s],o=r.spec.excludes;r.excluded=o==null?[r]:o==""?[]:Bs(this,o.split(" "))}this.nodeFromJSON=this.nodeFromJSON.bind(this),this.markFromJSON=this.markFromJSON.bind(this),this.topNodeType=this.nodes[this.spec.topNode||"doc"],this.cached.wrappings=Object.create(null)}node(e,t=null,n,s){if(typeof e=="string")e=this.nodeType(e);else if(e instanceof vs){if(e.schema!=this)throw new RangeError("Node type from different schema used ("+e.name+")")}else throw new RangeError("Invalid node type: "+e);return e.createChecked(t,n,s)}text(e,t){let n=this.nodes.text;return new Vn(n,n.defaultAttrs,e,J.setFrom(t))}mark(e,t){return typeof e=="string"&&(e=this.marks[e]),e.create(t)}nodeFromJSON(e){return et.fromJSON(this,e)}markFromJSON(e){return J.fromJSON(this,e)}nodeType(e){let t=this.nodes[e];if(!t)throw new RangeError("Unknown node type: "+e);return t}}function Bs(i,e){let t=[];for(let n=0;n<e.length;n++){let s=e[n],r=i.marks[s],o=r;if(r)t.push(r);else for(let a in i.marks){let l=i.marks[a];(s=="_"||l.spec.group&&l.spec.group.split(" ").indexOf(s)>-1)&&t.push(o=l)}if(!o)throw new SyntaxError("Unknown mark type: '"+e[n]+"'")}return t}function uh(i){return i.tag!=null}function fh(i){return i.style!=null}class fn{constructor(e,t){this.schema=e,this.rules=t,this.tags=[],this.styles=[];let n=this.matchedStyles=[];t.forEach(s=>{if(uh(s))this.tags.push(s);else if(fh(s)){let r=/[^=]*/.exec(s.style)[0];n.indexOf(r)<0&&n.push(r),this.styles.push(s)}}),this.normalizeLists=!this.tags.some(s=>{if(!/^(ul|ol)\b/.test(s.tag)||!s.node)return!1;let r=e.nodes[s.node];return r.contentMatch.matchType(r)})}parse(e,t={}){let n=new Ps(this,t,!1);return n.addAll(e,t.from,t.to),n.finish()}parseSlice(e,t={}){let n=new Ps(this,t,!0);return n.addAll(e,t.from,t.to),v.maxOpen(n.finish())}matchTag(e,t,n){for(let s=n?this.tags.indexOf(n)+1:0;s<this.tags.length;s++){let r=this.tags[s];if(gh(e,r.tag)&&(r.namespace===void 0||e.namespaceURI==r.namespace)&&(!r.context||t.matchesContext(r.context))){if(r.getAttrs){let o=r.getAttrs(e);if(o===!1)continue;r.attrs=o||void 0}return r}}}matchStyle(e,t,n,s){for(let r=s?this.styles.indexOf(s)+1:0;r<this.styles.length;r++){let o=this.styles[r],a=o.style;if(!(a.indexOf(e)!=0||o.context&&!n.matchesContext(o.context)||a.length>e.length&&(a.charCodeAt(e.length)!=61||a.slice(e.length+1)!=t))){if(o.getAttrs){let l=o.getAttrs(t);if(l===!1)continue;o.attrs=l||void 0}return o}}}static schemaRules(e){let t=[];function n(s){let r=s.priority==null?50:s.priority,o=0;for(;o<t.length;o++){let a=t[o];if((a.priority==null?50:a.priority)<r)break}t.splice(o,0,s)}for(let s in e.marks){let r=e.marks[s].spec.parseDOM;r&&r.forEach(o=>{n(o=Ls(o)),o.mark||o.ignore||o.clearMark||(o.mark=s)})}for(let s in e.nodes){let r=e.nodes[s].spec.parseDOM;r&&r.forEach(o=>{n(o=Ls(o)),o.node||o.ignore||o.mark||(o.node=s)})}return t}static fromSchema(e){return e.cached.domParser||(e.cached.domParser=new fn(e,fn.schemaRules(e)))}}const Mo={address:!0,article:!0,aside:!0,blockquote:!0,canvas:!0,dd:!0,div:!0,dl:!0,fieldset:!0,figcaption:!0,figure:!0,footer:!0,form:!0,h1:!0,h2:!0,h3:!0,h4:!0,h5:!0,h6:!0,header:!0,hgroup:!0,hr:!0,li:!0,noscript:!0,ol:!0,output:!0,p:!0,pre:!0,section:!0,table:!0,tfoot:!0,ul:!0},ph={head:!0,noscript:!0,object:!0,script:!0,style:!0,title:!0},Eo={ol:!0,ul:!0},Un=1,qn=2,ln=4;function Fs(i,e,t){return e!=null?(e?Un:0)|(e==="full"?qn:0):i&&i.whitespace=="pre"?Un|qn:t&~ln}class In{constructor(e,t,n,s,r,o,a){this.type=e,this.attrs=t,this.marks=n,this.pendingMarks=s,this.solid=r,this.options=a,this.content=[],this.activeMarks=J.none,this.stashMarks=[],this.match=o||(a&ln?null:e.contentMatch)}findWrapping(e){if(!this.match){if(!this.type)return[];let t=this.type.contentMatch.fillBefore(_.from(e));if(t)this.match=this.type.contentMatch.matchFragment(t);else{let n=this.type.contentMatch,s;return(s=n.findWrapping(e.type))?(this.match=n,s):null}}return this.match.findWrapping(e.type)}finish(e){if(!(this.options&Un)){let n=this.content[this.content.length-1],s;if(n&&n.isText&&(s=/[ \t\r\n\u000c]+$/.exec(n.text))){let r=n;n.text.length==s[0].length?this.content.pop():this.content[this.content.length-1]=r.withText(r.text.slice(0,r.text.length-s[0].length))}}let t=_.from(this.content);return!e&&this.match&&(t=t.append(this.match.fillBefore(_.empty,!0))),this.type?this.type.create(this.attrs,t,this.marks):t}popFromStashMark(e){for(let t=this.stashMarks.length-1;t>=0;t--)if(e.eq(this.stashMarks[t]))return this.stashMarks.splice(t,1)[0]}applyPending(e){for(let t=0,n=this.pendingMarks;t<n.length;t++){let s=n[t];(this.type?this.type.allowsMarkType(s.type):yh(s.type,e))&&!s.isInSet(this.activeMarks)&&(this.activeMarks=s.addToSet(this.activeMarks),this.pendingMarks=s.removeFromSet(this.pendingMarks))}}inlineContext(e){return this.type?this.type.inlineContent:this.content.length?this.content[0].isInline:e.parentNode&&!Mo.hasOwnProperty(e.parentNode.nodeName.toLowerCase())}}class Ps{constructor(e,t,n){this.parser=e,this.options=t,this.isOpen=n,this.open=0;let s=t.topNode,r,o=Fs(null,t.preserveWhitespace,0)|(n?ln:0);s?r=new In(s.type,s.attrs,J.none,J.none,!0,t.topMatch||s.type.contentMatch,o):n?r=new In(null,null,J.none,J.none,!0,null,o):r=new In(e.schema.topNodeType,null,J.none,J.none,!0,null,o),this.nodes=[r],this.find=t.findPositions,this.needsBlock=!1}get top(){return this.nodes[this.open]}addDOM(e){e.nodeType==3?this.addTextNode(e):e.nodeType==1&&this.addElement(e)}withStyleRules(e,t){let n=e.style;if(!n||!n.length)return t();let s=this.readStyles(e.style);if(!s)return;let[r,o]=s,a=this.top;for(let l=0;l<o.length;l++)this.removePendingMark(o[l],a);for(let l=0;l<r.length;l++)this.addPendingMark(r[l]);t();for(let l=0;l<r.length;l++)this.removePendingMark(r[l],a);for(let l=0;l<o.length;l++)this.addPendingMark(o[l])}addTextNode(e){let t=e.nodeValue,n=this.top;if(n.options&qn||n.inlineContext(e)||/[^ \t\r\n\u000c]/.test(t)){if(n.options&Un)n.options&qn?t=t.replace(/\r\n?/g,`
`):t=t.replace(/\r?\n|\r/g," ");else if(t=t.replace(/[ \t\r\n\u000c]+/g," "),/^[ \t\r\n\u000c]/.test(t)&&this.open==this.nodes.length-1){let s=n.content[n.content.length-1],r=e.previousSibling;(!s||r&&r.nodeName=="BR"||s.isText&&/[ \t\r\n\u000c]$/.test(s.text))&&(t=t.slice(1))}t&&this.insertNode(this.parser.schema.text(t)),this.findInText(e)}else this.findInside(e)}addElement(e,t){let n=e.nodeName.toLowerCase(),s;Eo.hasOwnProperty(n)&&this.parser.normalizeLists&&mh(e);let r=this.options.ruleFromNode&&this.options.ruleFromNode(e)||(s=this.parser.matchTag(e,this,t));if(r?r.ignore:ph.hasOwnProperty(n))this.findInside(e),this.ignoreFallback(e);else if(!r||r.skip||r.closeParent){r&&r.closeParent?this.open=Math.max(0,this.open-1):r&&r.skip.nodeType&&(e=r.skip);let o,a=this.top,l=this.needsBlock;if(Mo.hasOwnProperty(n))a.content.length&&a.content[0].isInline&&this.open&&(this.open--,a=this.top),o=!0,a.type||(this.needsBlock=!0);else if(!e.firstChild){this.leafFallback(e);return}r&&r.skip?this.addAll(e):this.withStyleRules(e,()=>this.addAll(e)),o&&this.sync(a),this.needsBlock=l}else this.withStyleRules(e,()=>{this.addElementByRule(e,r,r.consuming===!1?s:void 0)})}leafFallback(e){e.nodeName=="BR"&&this.top.type&&this.top.type.inlineContent&&this.addTextNode(e.ownerDocument.createTextNode(`
`))}ignoreFallback(e){e.nodeName=="BR"&&(!this.top.type||!this.top.type.inlineContent)&&this.findPlace(this.parser.schema.text("-"))}readStyles(e){let t=J.none,n=J.none;if(e.length)for(let s=0;s<this.parser.matchedStyles.length;s++){let r=this.parser.matchedStyles[s],o=e.getPropertyValue(r);if(o)for(let a=void 0;;){let l=this.parser.matchStyle(r,o,this,a);if(!l)break;if(l.ignore)return null;if(l.clearMark?this.top.pendingMarks.concat(this.top.activeMarks).forEach(d=>{l.clearMark(d)&&(n=d.addToSet(n))}):t=this.parser.schema.marks[l.mark].create(l.attrs).addToSet(t),l.consuming===!1)a=l;else break}}return[t,n]}addElementByRule(e,t,n){let s,r,o;t.node?(r=this.parser.schema.nodes[t.node],r.isLeaf?this.insertNode(r.create(t.attrs))||this.leafFallback(e):s=this.enter(r,t.attrs||null,t.preserveWhitespace)):(o=this.parser.schema.marks[t.mark].create(t.attrs),this.addPendingMark(o));let a=this.top;if(r&&r.isLeaf)this.findInside(e);else if(n)this.addElement(e,n);else if(t.getContent)this.findInside(e),t.getContent(e,this.parser.schema).forEach(l=>this.insertNode(l));else{let l=e;typeof t.contentElement=="string"?l=e.querySelector(t.contentElement):typeof t.contentElement=="function"?l=t.contentElement(e):t.contentElement&&(l=t.contentElement),this.findAround(e,l,!0),this.addAll(l)}s&&this.sync(a)&&this.open--,o&&this.removePendingMark(o,a)}addAll(e,t,n){let s=t||0;for(let r=t?e.childNodes[t]:e.firstChild,o=n==null?null:e.childNodes[n];r!=o;r=r.nextSibling,++s)this.findAtPoint(e,s),this.addDOM(r);this.findAtPoint(e,s)}findPlace(e){let t,n;for(let s=this.open;s>=0;s--){let r=this.nodes[s],o=r.findWrapping(e);if(o&&(!t||t.length>o.length)&&(t=o,n=r,!o.length)||r.solid)break}if(!t)return!1;this.sync(n);for(let s=0;s<t.length;s++)this.enterInner(t[s],null,!1);return!0}insertNode(e){if(e.isInline&&this.needsBlock&&!this.top.type){let t=this.textblockFromContext();t&&this.enterInner(t)}if(this.findPlace(e)){this.closeExtra();let t=this.top;t.applyPending(e.type),t.match&&(t.match=t.match.matchType(e.type));let n=t.activeMarks;for(let s=0;s<e.marks.length;s++)(!t.type||t.type.allowsMarkType(e.marks[s].type))&&(n=e.marks[s].addToSet(n));return t.content.push(e.mark(n)),!0}return!1}enter(e,t,n){let s=this.findPlace(e.create(t));return s&&this.enterInner(e,t,!0,n),s}enterInner(e,t=null,n=!1,s){this.closeExtra();let r=this.top;r.applyPending(e),r.match=r.match&&r.match.matchType(e);let o=Fs(e,s,r.options);r.options&ln&&r.content.length==0&&(o|=ln),this.nodes.push(new In(e,t,r.activeMarks,r.pendingMarks,n,null,o)),this.open++}closeExtra(e=!1){let t=this.nodes.length-1;if(t>this.open){for(;t>this.open;t--)this.nodes[t-1].content.push(this.nodes[t].finish(e));this.nodes.length=this.open+1}}finish(){return this.open=0,this.closeExtra(this.isOpen),this.nodes[0].finish(this.isOpen||this.options.topOpen)}sync(e){for(let t=this.open;t>=0;t--)if(this.nodes[t]==e)return this.open=t,!0;return!1}get currentPos(){this.closeExtra();let e=0;for(let t=this.open;t>=0;t--){let n=this.nodes[t].content;for(let s=n.length-1;s>=0;s--)e+=n[s].nodeSize;t&&e++}return e}findAtPoint(e,t){if(this.find)for(let n=0;n<this.find.length;n++)this.find[n].node==e&&this.find[n].offset==t&&(this.find[n].pos=this.currentPos)}findInside(e){if(this.find)for(let t=0;t<this.find.length;t++)this.find[t].pos==null&&e.nodeType==1&&e.contains(this.find[t].node)&&(this.find[t].pos=this.currentPos)}findAround(e,t,n){if(e!=t&&this.find)for(let s=0;s<this.find.length;s++)this.find[s].pos==null&&e.nodeType==1&&e.contains(this.find[s].node)&&t.compareDocumentPosition(this.find[s].node)&(n?2:4)&&(this.find[s].pos=this.currentPos)}findInText(e){if(this.find)for(let t=0;t<this.find.length;t++)this.find[t].node==e&&(this.find[t].pos=this.currentPos-(e.nodeValue.length-this.find[t].offset))}matchesContext(e){if(e.indexOf("|")>-1)return e.split(/\s*\|\s*/).some(this.matchesContext,this);let t=e.split("/"),n=this.options.context,s=!this.isOpen&&(!n||n.parent.type==this.nodes[0].type),r=-(n?n.depth+1:0)+(s?0:1),o=(a,l)=>{for(;a>=0;a--){let d=t[a];if(d==""){if(a==t.length-1||a==0)continue;for(;l>=r;l--)if(o(a-1,l))return!0;return!1}else{let u=l>0||l==0&&s?this.nodes[l].type:n&&l>=r?n.node(l-r).type:null;if(!u||u.name!=d&&u.groups.indexOf(d)==-1)return!1;l--}}return!0};return o(t.length-1,this.open)}textblockFromContext(){let e=this.options.context;if(e)for(let t=e.depth;t>=0;t--){let n=e.node(t).contentMatchAt(e.indexAfter(t)).defaultType;if(n&&n.isTextblock&&n.defaultAttrs)return n}for(let t in this.parser.schema.nodes){let n=this.parser.schema.nodes[t];if(n.isTextblock&&n.defaultAttrs)return n}}addPendingMark(e){let t=xh(e,this.top.pendingMarks);t&&this.top.stashMarks.push(t),this.top.pendingMarks=e.addToSet(this.top.pendingMarks)}removePendingMark(e,t){for(let n=this.open;n>=0;n--){let s=this.nodes[n];if(s.pendingMarks.lastIndexOf(e)>-1)s.pendingMarks=e.removeFromSet(s.pendingMarks);else{s.activeMarks=e.removeFromSet(s.activeMarks);let o=s.popFromStashMark(e);o&&s.type&&s.type.allowsMarkType(o.type)&&(s.activeMarks=o.addToSet(s.activeMarks))}if(s==t)break}}}function mh(i){for(let e=i.firstChild,t=null;e;e=e.nextSibling){let n=e.nodeType==1?e.nodeName.toLowerCase():null;n&&Eo.hasOwnProperty(n)&&t?(t.appendChild(e),e=t):n=="li"?t=e:n&&(t=null)}}function gh(i,e){return(i.matches||i.msMatchesSelector||i.webkitMatchesSelector||i.mozMatchesSelector).call(i,e)}function Ls(i){let e={};for(let t in i)e[t]=i[t];return e}function yh(i,e){let t=e.schema.nodes;for(let n in t){let s=t[n];if(!s.allowsMarkType(i))continue;let r=[],o=a=>{r.push(a);for(let l=0;l<a.edgeCount;l++){let{type:d,next:u}=a.edge(l);if(d==e||r.indexOf(u)<0&&o(u))return!0}};if(o(s.contentMatch))return!0}}function xh(i,e){for(let t=0;t<e.length;t++)if(i.eq(e[t]))return e[t]}class Qt{constructor(e,t){this.nodes=e,this.marks=t}serializeFragment(e,t={},n){n||(n=di(t).createDocumentFragment());let s=n,r=[];return e.forEach(o=>{if(r.length||o.marks.length){let a=0,l=0;for(;a<r.length&&l<o.marks.length;){let d=o.marks[l];if(!this.marks[d.type.name]){l++;continue}if(!d.eq(r[a][0])||d.type.spec.spanning===!1)break;a++,l++}for(;a<r.length;)s=r.pop()[1];for(;l<o.marks.length;){let d=o.marks[l++],u=this.serializeMark(d,o.isInline,t);u&&(r.push([d,s]),s.appendChild(u.dom),s=u.contentDOM||u.dom)}}s.appendChild(this.serializeNodeInner(o,t))}),n}serializeNodeInner(e,t){let{dom:n,contentDOM:s}=An(di(t),this.nodes[e.type.name](e),null,e.attrs);if(s){if(e.isLeaf)throw new RangeError("Content hole not allowed in a leaf node spec");this.serializeFragment(e.content,t,s)}return n}serializeNode(e,t={}){let n=this.serializeNodeInner(e,t);for(let s=e.marks.length-1;s>=0;s--){let r=this.serializeMark(e.marks[s],e.isInline,t);r&&((r.contentDOM||r.dom).appendChild(n),n=r.dom)}return n}serializeMark(e,t,n={}){let s=this.marks[e.type.name];return s&&An(di(n),s(e,t),null,e.attrs)}static renderSpec(e,t,n=null,s){return An(e,t,n,s)}static fromSchema(e){return e.cached.domSerializer||(e.cached.domSerializer=new Qt(this.nodesFromSchema(e),this.marksFromSchema(e)))}static nodesFromSchema(e){let t=js(e.nodes);return t.text||(t.text=n=>n.text),t}static marksFromSchema(e){return js(e.marks)}}function js(i){let e={};for(let t in i){let n=i[t].spec.toDOM;n&&(e[t]=n)}return e}function di(i){return i.document||window.document}const zs=new WeakMap;function kh(i){let e=zs.get(i);return e===void 0&&zs.set(i,e=bh(i)),e}function bh(i){let e=null;function t(n){if(n&&typeof n=="object")if(Array.isArray(n))if(typeof n[0]=="string")e||(e=[]),e.push(n);else for(let s=0;s<n.length;s++)t(n[s]);else for(let s in n)t(n[s])}return t(i),e}function An(i,e,t,n){if(typeof e=="string")return{dom:i.createTextNode(e)};if(e.nodeType!=null)return{dom:e};if(e.dom&&e.dom.nodeType!=null)return e;let s=e[0],r;if(typeof s!="string")throw new RangeError("Invalid array passed to renderSpec");if(n&&(r=kh(n))&&r.indexOf(e)>-1)throw new RangeError("Using an array from an attribute object as a DOM spec. This may be an attempted cross site scripting attack.");let o=s.indexOf(" ");o>0&&(t=s.slice(0,o),s=s.slice(o+1));let a,l=t?i.createElementNS(t,s):i.createElement(s),d=e[1],u=1;if(d&&typeof d=="object"&&d.nodeType==null&&!Array.isArray(d)){u=2;for(let m in d)if(d[m]!=null){let p=m.indexOf(" ");p>0?l.setAttributeNS(m.slice(0,p),m.slice(p+1),d[m]):l.setAttribute(m,d[m])}}for(let m=u;m<e.length;m++){let p=e[m];if(p===0){if(m<e.length-1||m>u)throw new RangeError("Content hole must be the only child of its parent node");return{dom:l,contentDOM:l}}else{let{dom:k,contentDOM:y}=An(i,p,t,n);if(l.appendChild(k),y){if(a)throw new RangeError("Multiple content holes");a=y}}}return{dom:l,contentDOM:a}}const Io=65535,No=Math.pow(2,16);function wh(i,e){return i+e*No}function Vs(i){return i&Io}function Sh(i){return(i-(i&Io))/No}const _o=1,Oo=2,vn=4,Do=8;class Ai{constructor(e,t,n){this.pos=e,this.delInfo=t,this.recover=n}get deleted(){return(this.delInfo&Do)>0}get deletedBefore(){return(this.delInfo&(_o|vn))>0}get deletedAfter(){return(this.delInfo&(Oo|vn))>0}get deletedAcross(){return(this.delInfo&vn)>0}}class Fe{constructor(e,t=!1){if(this.ranges=e,this.inverted=t,!e.length&&Fe.empty)return Fe.empty}recover(e){let t=0,n=Vs(e);if(!this.inverted)for(let s=0;s<n;s++)t+=this.ranges[s*3+2]-this.ranges[s*3+1];return this.ranges[n*3]+t+Sh(e)}mapResult(e,t=1){return this._map(e,t,!1)}map(e,t=1){return this._map(e,t,!0)}_map(e,t,n){let s=0,r=this.inverted?2:1,o=this.inverted?1:2;for(let a=0;a<this.ranges.length;a+=3){let l=this.ranges[a]-(this.inverted?s:0);if(l>e)break;let d=this.ranges[a+r],u=this.ranges[a+o],m=l+d;if(e<=m){let p=d?e==l?-1:e==m?1:t:t,k=l+s+(p<0?0:u);if(n)return k;let y=e==(t<0?l:m)?null:wh(a/3,e-l),w=e==l?Oo:e==m?_o:vn;return(t<0?e!=l:e!=m)&&(w|=Do),new Ai(k,w,y)}s+=u-d}return n?e+s:new Ai(e+s,0,null)}touches(e,t){let n=0,s=Vs(t),r=this.inverted?2:1,o=this.inverted?1:2;for(let a=0;a<this.ranges.length;a+=3){let l=this.ranges[a]-(this.inverted?n:0);if(l>e)break;let d=this.ranges[a+r],u=l+d;if(e<=u&&a==s*3)return!0;n+=this.ranges[a+o]-d}return!1}forEach(e){let t=this.inverted?2:1,n=this.inverted?1:2;for(let s=0,r=0;s<this.ranges.length;s+=3){let o=this.ranges[s],a=o-(this.inverted?r:0),l=o+(this.inverted?0:r),d=this.ranges[s+t],u=this.ranges[s+n];e(a,a+d,l,l+u),r+=u-d}}invert(){return new Fe(this.ranges,!this.inverted)}toString(){return(this.inverted?"-":"")+JSON.stringify(this.ranges)}static offset(e){return e==0?Fe.empty:new Fe(e<0?[0,-e,0]:[0,0,e])}}Fe.empty=new Fe([]);class cn{constructor(e=[],t,n=0,s=e.length){this.maps=e,this.mirror=t,this.from=n,this.to=s}slice(e=0,t=this.maps.length){return new cn(this.maps,this.mirror,e,t)}copy(){return new cn(this.maps.slice(),this.mirror&&this.mirror.slice(),this.from,this.to)}appendMap(e,t){this.to=this.maps.push(e),t!=null&&this.setMirror(this.maps.length-1,t)}appendMapping(e){for(let t=0,n=this.maps.length;t<e.maps.length;t++){let s=e.getMirror(t);this.appendMap(e.maps[t],s!=null&&s<t?n+s:void 0)}}getMirror(e){if(this.mirror){for(let t=0;t<this.mirror.length;t++)if(this.mirror[t]==e)return this.mirror[t+(t%2?-1:1)]}}setMirror(e,t){this.mirror||(this.mirror=[]),this.mirror.push(e,t)}appendMappingInverted(e){for(let t=e.maps.length-1,n=this.maps.length+e.maps.length;t>=0;t--){let s=e.getMirror(t);this.appendMap(e.maps[t].invert(),s!=null&&s>t?n-s-1:void 0)}}invert(){let e=new cn;return e.appendMappingInverted(this),e}map(e,t=1){if(this.mirror)return this._map(e,t,!0);for(let n=this.from;n<this.to;n++)e=this.maps[n].map(e,t);return e}mapResult(e,t=1){return this._map(e,t,!1)}_map(e,t,n){let s=0;for(let r=this.from;r<this.to;r++){let o=this.maps[r],a=o.mapResult(e,t);if(a.recover!=null){let l=this.getMirror(r);if(l!=null&&l>r&&l<this.to){r=l,e=this.maps[l].recover(a.recover);continue}}s|=a.delInfo,e=a.pos}return n?e:new Ai(e,s,null)}}const hi=Object.create(null);class we{getMap(){return Fe.empty}merge(e){return null}static fromJSON(e,t){if(!t||!t.stepType)throw new RangeError("Invalid input for Step.fromJSON");let n=hi[t.stepType];if(!n)throw new RangeError(`No step type ${t.stepType} defined`);return n.fromJSON(e,t)}static jsonID(e,t){if(e in hi)throw new RangeError("Duplicate use of step JSON ID "+e);return hi[e]=t,t.prototype.jsonID=e,t}}class oe{constructor(e,t){this.doc=e,this.failed=t}static ok(e){return new oe(e,null)}static fail(e){return new oe(null,e)}static fromReplace(e,t,n,s){try{return oe.ok(e.replace(t,n,s))}catch(r){if(r instanceof jn)return oe.fail(r.message);throw r}}}function ss(i,e,t){let n=[];for(let s=0;s<i.childCount;s++){let r=i.child(s);r.content.size&&(r=r.copy(ss(r.content,e,r))),r.isInline&&(r=e(r,t,s)),n.push(r)}return _.fromArray(n)}class yt extends we{constructor(e,t,n){super(),this.from=e,this.to=t,this.mark=n}apply(e){let t=e.slice(this.from,this.to),n=e.resolve(this.from),s=n.node(n.sharedDepth(this.to)),r=new v(ss(t.content,(o,a)=>!o.isAtom||!a.type.allowsMarkType(this.mark.type)?o:o.mark(this.mark.addToSet(o.marks)),s),t.openStart,t.openEnd);return oe.fromReplace(e,this.from,this.to,r)}invert(){return new Xe(this.from,this.to,this.mark)}map(e){let t=e.mapResult(this.from,1),n=e.mapResult(this.to,-1);return t.deleted&&n.deleted||t.pos>=n.pos?null:new yt(t.pos,n.pos,this.mark)}merge(e){return e instanceof yt&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from?new yt(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark):null}toJSON(){return{stepType:"addMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for AddMarkStep.fromJSON");return new yt(t.from,t.to,e.markFromJSON(t.mark))}}we.jsonID("addMark",yt);class Xe extends we{constructor(e,t,n){super(),this.from=e,this.to=t,this.mark=n}apply(e){let t=e.slice(this.from,this.to),n=new v(ss(t.content,s=>s.mark(this.mark.removeFromSet(s.marks)),e),t.openStart,t.openEnd);return oe.fromReplace(e,this.from,this.to,n)}invert(){return new yt(this.from,this.to,this.mark)}map(e){let t=e.mapResult(this.from,1),n=e.mapResult(this.to,-1);return t.deleted&&n.deleted||t.pos>=n.pos?null:new Xe(t.pos,n.pos,this.mark)}merge(e){return e instanceof Xe&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from?new Xe(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark):null}toJSON(){return{stepType:"removeMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for RemoveMarkStep.fromJSON");return new Xe(t.from,t.to,e.markFromJSON(t.mark))}}we.jsonID("removeMark",Xe);class xt extends we{constructor(e,t){super(),this.pos=e,this.mark=t}apply(e){let t=e.nodeAt(this.pos);if(!t)return oe.fail("No node at mark step's position");let n=t.type.create(t.attrs,null,this.mark.addToSet(t.marks));return oe.fromReplace(e,this.pos,this.pos+1,new v(_.from(n),0,t.isLeaf?0:1))}invert(e){let t=e.nodeAt(this.pos);if(t){let n=this.mark.addToSet(t.marks);if(n.length==t.marks.length){for(let s=0;s<t.marks.length;s++)if(!t.marks[s].isInSet(n))return new xt(this.pos,t.marks[s]);return new xt(this.pos,this.mark)}}return new Gt(this.pos,this.mark)}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new xt(t.pos,this.mark)}toJSON(){return{stepType:"addNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for AddNodeMarkStep.fromJSON");return new xt(t.pos,e.markFromJSON(t.mark))}}we.jsonID("addNodeMark",xt);class Gt extends we{constructor(e,t){super(),this.pos=e,this.mark=t}apply(e){let t=e.nodeAt(this.pos);if(!t)return oe.fail("No node at mark step's position");let n=t.type.create(t.attrs,null,this.mark.removeFromSet(t.marks));return oe.fromReplace(e,this.pos,this.pos+1,new v(_.from(n),0,t.isLeaf?0:1))}invert(e){let t=e.nodeAt(this.pos);return!t||!this.mark.isInSet(t.marks)?this:new xt(this.pos,this.mark)}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new Gt(t.pos,this.mark)}toJSON(){return{stepType:"removeNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for RemoveNodeMarkStep.fromJSON");return new Gt(t.pos,e.markFromJSON(t.mark))}}we.jsonID("removeNodeMark",Gt);class xe extends we{constructor(e,t,n,s=!1){super(),this.from=e,this.to=t,this.slice=n,this.structure=s}apply(e){return this.structure&&vi(e,this.from,this.to)?oe.fail("Structure replace would overwrite content"):oe.fromReplace(e,this.from,this.to,this.slice)}getMap(){return new Fe([this.from,this.to-this.from,this.slice.size])}invert(e){return new xe(this.from,this.from+this.slice.size,e.slice(this.from,this.to))}map(e){let t=e.mapResult(this.from,1),n=e.mapResult(this.to,-1);return t.deletedAcross&&n.deletedAcross?null:new xe(t.pos,Math.max(t.pos,n.pos),this.slice)}merge(e){if(!(e instanceof xe)||e.structure||this.structure)return null;if(this.from+this.slice.size==e.from&&!this.slice.openEnd&&!e.slice.openStart){let t=this.slice.size+e.slice.size==0?v.empty:new v(this.slice.content.append(e.slice.content),this.slice.openStart,e.slice.openEnd);return new xe(this.from,this.to+(e.to-e.from),t,this.structure)}else if(e.to==this.from&&!this.slice.openStart&&!e.slice.openEnd){let t=this.slice.size+e.slice.size==0?v.empty:new v(e.slice.content.append(this.slice.content),e.slice.openStart,this.slice.openEnd);return new xe(e.from,this.to,t,this.structure)}else return null}toJSON(){let e={stepType:"replace",from:this.from,to:this.to};return this.slice.size&&(e.slice=this.slice.toJSON()),this.structure&&(e.structure=!0),e}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for ReplaceStep.fromJSON");return new xe(t.from,t.to,v.fromJSON(e,t.slice),!!t.structure)}}we.jsonID("replace",xe);class Ge extends we{constructor(e,t,n,s,r,o,a=!1){super(),this.from=e,this.to=t,this.gapFrom=n,this.gapTo=s,this.slice=r,this.insert=o,this.structure=a}apply(e){if(this.structure&&(vi(e,this.from,this.gapFrom)||vi(e,this.gapTo,this.to)))return oe.fail("Structure gap-replace would overwrite content");let t=e.slice(this.gapFrom,this.gapTo);if(t.openStart||t.openEnd)return oe.fail("Gap is not a flat range");let n=this.slice.insertAt(this.insert,t.content);return n?oe.fromReplace(e,this.from,this.to,n):oe.fail("Content does not fit in gap")}getMap(){return new Fe([this.from,this.gapFrom-this.from,this.insert,this.gapTo,this.to-this.gapTo,this.slice.size-this.insert])}invert(e){let t=this.gapTo-this.gapFrom;return new Ge(this.from,this.from+this.slice.size+t,this.from+this.insert,this.from+this.insert+t,e.slice(this.from,this.to).removeBetween(this.gapFrom-this.from,this.gapTo-this.from),this.gapFrom-this.from,this.structure)}map(e){let t=e.mapResult(this.from,1),n=e.mapResult(this.to,-1),s=this.from==this.gapFrom?t.pos:e.map(this.gapFrom,-1),r=this.to==this.gapTo?n.pos:e.map(this.gapTo,1);return t.deletedAcross&&n.deletedAcross||s<t.pos||r>n.pos?null:new Ge(t.pos,n.pos,s,r,this.slice,this.insert,this.structure)}toJSON(){let e={stepType:"replaceAround",from:this.from,to:this.to,gapFrom:this.gapFrom,gapTo:this.gapTo,insert:this.insert};return this.slice.size&&(e.slice=this.slice.toJSON()),this.structure&&(e.structure=!0),e}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number"||typeof t.gapFrom!="number"||typeof t.gapTo!="number"||typeof t.insert!="number")throw new RangeError("Invalid input for ReplaceAroundStep.fromJSON");return new Ge(t.from,t.to,t.gapFrom,t.gapTo,v.fromJSON(e,t.slice),t.insert,!!t.structure)}}we.jsonID("replaceAround",Ge);function vi(i,e,t){let n=i.resolve(e),s=t-e,r=n.depth;for(;s>0&&r>0&&n.indexAfter(r)==n.node(r).childCount;)r--,s--;if(s>0){let o=n.node(r).maybeChild(n.indexAfter(r));for(;s>0;){if(!o||o.isLeaf)return!0;o=o.firstChild,s--}}return!1}function Ch(i,e,t,n){let s=[],r=[],o,a;i.doc.nodesBetween(e,t,(l,d,u)=>{if(!l.isInline)return;let m=l.marks;if(!n.isInSet(m)&&u.type.allowsMarkType(n.type)){let p=Math.max(d,e),k=Math.min(d+l.nodeSize,t),y=n.addToSet(m);for(let w=0;w<m.length;w++)m[w].isInSet(y)||(o&&o.to==p&&o.mark.eq(m[w])?o.to=k:s.push(o=new Xe(p,k,m[w])));a&&a.to==p?a.to=k:r.push(a=new yt(p,k,n))}}),s.forEach(l=>i.step(l)),r.forEach(l=>i.step(l))}function Th(i,e,t,n){let s=[],r=0;i.doc.nodesBetween(e,t,(o,a)=>{if(!o.isInline)return;r++;let l=null;if(n instanceof Qn){let d=o.marks,u;for(;u=n.isInSet(d);)(l||(l=[])).push(u),d=u.removeFromSet(d)}else n?n.isInSet(o.marks)&&(l=[n]):l=o.marks;if(l&&l.length){let d=Math.min(a+o.nodeSize,t);for(let u=0;u<l.length;u++){let m=l[u],p;for(let k=0;k<s.length;k++){let y=s[k];y.step==r-1&&m.eq(s[k].style)&&(p=y)}p?(p.to=d,p.step=r):s.push({style:m,from:Math.max(a,e),to:d,step:r})}}}),s.forEach(o=>i.step(new Xe(o.from,o.to,o.style)))}function Ro(i,e,t,n=t.contentMatch,s=!0){let r=i.doc.nodeAt(e),o=[],a=e+1;for(let l=0;l<r.childCount;l++){let d=r.child(l),u=a+d.nodeSize,m=n.matchType(d.type);if(!m)o.push(new xe(a,u,v.empty));else{n=m;for(let p=0;p<d.marks.length;p++)t.allowsMarkType(d.marks[p].type)||i.step(new Xe(a,u,d.marks[p]));if(s&&d.isText&&t.whitespace!="pre"){let p,k=/\r?\n|\r/g,y;for(;p=k.exec(d.text);)y||(y=new v(_.from(t.schema.text(" ",t.allowedMarks(d.marks))),0,0)),o.push(new xe(a+p.index,a+p.index+p[0].length,y))}}a=u}if(!n.validEnd){let l=n.fillBefore(_.empty,!0);i.replace(a,a,new v(l,0,0))}for(let l=o.length-1;l>=0;l--)i.step(o[l])}function Mh(i,e,t){return(e==0||i.canReplace(e,i.childCount))&&(t==i.childCount||i.canReplace(0,t))}function Am(i){let t=i.parent.content.cutByIndex(i.startIndex,i.endIndex);for(let n=i.depth;;--n){let s=i.$from.node(n),r=i.$from.index(n),o=i.$to.indexAfter(n);if(n<i.depth&&s.canReplace(r,o,t))return n;if(n==0||s.type.spec.isolating||!Mh(s,r,o))break}return null}function Eh(i,e,t){let{$from:n,$to:s,depth:r}=e,o=n.before(r+1),a=s.after(r+1),l=o,d=a,u=_.empty,m=0;for(let y=r,w=!1;y>t;y--)w||n.index(y)>0?(w=!0,u=_.from(n.node(y).copy(u)),m++):l--;let p=_.empty,k=0;for(let y=r,w=!1;y>t;y--)w||s.after(y+1)<s.end(y)?(w=!0,p=_.from(s.node(y).copy(p)),k++):d++;i.step(new Ge(l,d,o,a,new v(u.append(p),m,k),u.size-m,!0))}function vm(i,e,t=null,n=i){let s=Ih(i,e),r=s&&Nh(n,e);return r?s.map(Us).concat({type:e,attrs:t}).concat(r.map(Us)):null}function Us(i){return{type:i,attrs:null}}function Ih(i,e){let{parent:t,startIndex:n,endIndex:s}=i,r=t.contentMatchAt(n).findWrapping(e);if(!r)return null;let o=r.length?r[0]:e;return t.canReplaceWith(n,s,o)?r:null}function Nh(i,e){let{parent:t,startIndex:n,endIndex:s}=i,r=t.child(n),o=e.contentMatch.findWrapping(r.type);if(!o)return null;let l=(o.length?o[o.length-1]:e).contentMatch;for(let d=n;l&&d<s;d++)l=l.matchType(t.child(d).type);return!l||!l.validEnd?null:o}function _h(i,e,t){let n=_.empty;for(let o=t.length-1;o>=0;o--){if(n.size){let a=t[o].type.contentMatch.matchFragment(n);if(!a||!a.validEnd)throw new RangeError("Wrapper type given to Transform.wrap does not form valid content of its parent wrapper")}n=_.from(t[o].type.create(t[o].attrs,n))}let s=e.start,r=e.end;i.step(new Ge(s,r,s,r,new v(n,0,0),t.length,!0))}function Oh(i,e,t,n,s){if(!n.isTextblock)throw new RangeError("Type given to setBlockType should be a textblock");let r=i.steps.length;i.doc.nodesBetween(e,t,(o,a)=>{if(o.isTextblock&&!o.hasMarkup(n,s)&&Ah(i.doc,i.mapping.slice(r).map(a),n)){let l=null;if(n.schema.linebreakReplacement){let p=n.whitespace=="pre",k=!!n.contentMatch.matchType(n.schema.linebreakReplacement);p&&!k?l=!1:!p&&k&&(l=!0)}l===!1&&Rh(i,o,a,r),Ro(i,i.mapping.slice(r).map(a,1),n,void 0,l===null);let d=i.mapping.slice(r),u=d.map(a,1),m=d.map(a+o.nodeSize,1);return i.step(new Ge(u,m,u+1,m-1,new v(_.from(n.create(s,null,o.marks)),0,0),1,!0)),l===!0&&Dh(i,o,a,r),!1}})}function Dh(i,e,t,n){e.forEach((s,r)=>{if(s.isText){let o,a=/\r?\n|\r/g;for(;o=a.exec(s.text);){let l=i.mapping.slice(n).map(t+1+r+o.index);i.replaceWith(l,l+1,e.type.schema.linebreakReplacement.create())}}})}function Rh(i,e,t,n){e.forEach((s,r)=>{if(s.type==s.type.schema.linebreakReplacement){let o=i.mapping.slice(n).map(t+1+r);i.replaceWith(o,o+1,e.type.schema.text(`
`))}})}function Ah(i,e,t){let n=i.resolve(e),s=n.index();return n.parent.canReplaceWith(s,s+1,t)}function vh(i,e,t,n,s){let r=i.doc.nodeAt(e);if(!r)throw new RangeError("No node at given position");t||(t=r.type);let o=t.create(n,null,s||r.marks);if(r.isLeaf)return i.replaceWith(e,e+r.nodeSize,o);if(!t.validContent(r.content))throw new RangeError("Invalid content for node type "+t.name);i.step(new Ge(e,e+r.nodeSize,e+1,e+r.nodeSize-1,new v(_.from(o),0,0),1,!0))}function Bm(i,e,t=1,n){let s=i.resolve(e),r=s.depth-t,o=n&&n[n.length-1]||s.parent;if(r<0||s.parent.type.spec.isolating||!s.parent.canReplace(s.index(),s.parent.childCount)||!o.type.validContent(s.parent.content.cutByIndex(s.index(),s.parent.childCount)))return!1;for(let d=s.depth-1,u=t-2;d>r;d--,u--){let m=s.node(d),p=s.index(d);if(m.type.spec.isolating)return!1;let k=m.content.cutByIndex(p,m.childCount),y=n&&n[u+1];y&&(k=k.replaceChild(0,y.type.create(y.attrs)));let w=n&&n[u]||m;if(!m.canReplace(p+1,m.childCount)||!w.type.validContent(k))return!1}let a=s.indexAfter(r),l=n&&n[0];return s.node(r).canReplaceWith(a,a,l?l.type:s.node(r+1).type)}function Bh(i,e,t=1,n){let s=i.doc.resolve(e),r=_.empty,o=_.empty;for(let a=s.depth,l=s.depth-t,d=t-1;a>l;a--,d--){r=_.from(s.node(a).copy(r));let u=n&&n[d];o=_.from(u?u.type.create(u.attrs,o):s.node(a).copy(o))}i.step(new xe(e,e,new v(r.append(o),t,t),!0))}function Fm(i,e){let t=i.resolve(e),n=t.index();return Fh(t.nodeBefore,t.nodeAfter)&&t.parent.canReplace(n,n+1)}function Fh(i,e){return!!(i&&e&&!i.isLeaf&&i.canAppend(e))}function Ph(i,e,t){let n=new xe(e-t,e+t,v.empty,!0);i.step(n)}function Lh(i,e,t){let n=i.resolve(e);if(n.parent.canReplaceWith(n.index(),n.index(),t))return e;if(n.parentOffset==0)for(let s=n.depth-1;s>=0;s--){let r=n.index(s);if(n.node(s).canReplaceWith(r,r,t))return n.before(s+1);if(r>0)return null}if(n.parentOffset==n.parent.content.size)for(let s=n.depth-1;s>=0;s--){let r=n.indexAfter(s);if(n.node(s).canReplaceWith(r,r,t))return n.after(s+1);if(r<n.node(s).childCount)return null}return null}function jh(i,e,t){let n=i.resolve(e);if(!t.content.size)return e;let s=t.content;for(let r=0;r<t.openStart;r++)s=s.firstChild.content;for(let r=1;r<=(t.openStart==0&&t.size?2:1);r++)for(let o=n.depth;o>=0;o--){let a=o==n.depth?0:n.pos<=(n.start(o+1)+n.end(o+1))/2?-1:1,l=n.index(o)+(a>0?1:0),d=n.node(o),u=!1;if(r==1)u=d.canReplace(l,l,s);else{let m=d.contentMatchAt(l).findWrapping(s.firstChild.type);u=m&&d.canReplaceWith(l,l,m[0])}if(u)return a==0?n.pos:a<0?n.before(o+1):n.after(o+1)}return null}function zh(i,e,t=e,n=v.empty){if(e==t&&!n.size)return null;let s=i.resolve(e),r=i.resolve(t);return Ao(s,r,n)?new xe(e,t,n):new Vh(s,r,n).fit()}function Ao(i,e,t){return!t.openStart&&!t.openEnd&&i.start()==e.start()&&i.parent.canReplace(i.index(),e.index(),t.content)}class Vh{constructor(e,t,n){this.$from=e,this.$to=t,this.unplaced=n,this.frontier=[],this.placed=_.empty;for(let s=0;s<=e.depth;s++){let r=e.node(s);this.frontier.push({type:r.type,match:r.contentMatchAt(e.indexAfter(s))})}for(let s=e.depth;s>0;s--)this.placed=_.from(e.node(s).copy(this.placed))}get depth(){return this.frontier.length-1}fit(){for(;this.unplaced.size;){let d=this.findFittable();d?this.placeNodes(d):this.openMore()||this.dropNode()}let e=this.mustMoveInline(),t=this.placed.size-this.depth-this.$from.depth,n=this.$from,s=this.close(e<0?this.$to:n.doc.resolve(e));if(!s)return null;let r=this.placed,o=n.depth,a=s.depth;for(;o&&a&&r.childCount==1;)r=r.firstChild.content,o--,a--;let l=new v(r,o,a);return e>-1?new Ge(n.pos,e,this.$to.pos,this.$to.end(),l,t):l.size||n.pos!=this.$to.pos?new xe(n.pos,s.pos,l):null}findFittable(){let e=this.unplaced.openStart;for(let t=this.unplaced.content,n=0,s=this.unplaced.openEnd;n<e;n++){let r=t.firstChild;if(t.childCount>1&&(s=0),r.type.spec.isolating&&s<=n){e=n;break}t=r.content}for(let t=1;t<=2;t++)for(let n=t==1?e:this.unplaced.openStart;n>=0;n--){let s,r=null;n?(r=ui(this.unplaced.content,n-1).firstChild,s=r.content):s=this.unplaced.content;let o=s.firstChild;for(let a=this.depth;a>=0;a--){let{type:l,match:d}=this.frontier[a],u,m=null;if(t==1&&(o?d.matchType(o.type)||(m=d.fillBefore(_.from(o),!1)):r&&l.compatibleContent(r.type)))return{sliceDepth:n,frontierDepth:a,parent:r,inject:m};if(t==2&&o&&(u=d.findWrapping(o.type)))return{sliceDepth:n,frontierDepth:a,parent:r,wrap:u};if(r&&d.matchType(r.type))break}}}openMore(){let{content:e,openStart:t,openEnd:n}=this.unplaced,s=ui(e,t);return!s.childCount||s.firstChild.isLeaf?!1:(this.unplaced=new v(e,t+1,Math.max(n,s.size+t>=e.size-n?t+1:0)),!0)}dropNode(){let{content:e,openStart:t,openEnd:n}=this.unplaced,s=ui(e,t);if(s.childCount<=1&&t>0){let r=e.size-t<=t+s.size;this.unplaced=new v(en(e,t-1,1),t-1,r?t-1:n)}else this.unplaced=new v(en(e,t,1),t,n)}placeNodes({sliceDepth:e,frontierDepth:t,parent:n,inject:s,wrap:r}){for(;this.depth>t;)this.closeFrontierNode();if(r)for(let w=0;w<r.length;w++)this.openFrontierNode(r[w]);let o=this.unplaced,a=n?n.content:o.content,l=o.openStart-e,d=0,u=[],{match:m,type:p}=this.frontier[t];if(s){for(let w=0;w<s.childCount;w++)u.push(s.child(w));m=m.matchFragment(s)}let k=a.size+e-(o.content.size-o.openEnd);for(;d<a.childCount;){let w=a.child(d),C=m.matchType(w.type);if(!C)break;d++,(d>1||l==0||w.content.size)&&(m=C,u.push(vo(w.mark(p.allowedMarks(w.marks)),d==1?l:0,d==a.childCount?k:-1)))}let y=d==a.childCount;y||(k=-1),this.placed=tn(this.placed,t,_.from(u)),this.frontier[t].match=m,y&&k<0&&n&&n.type==this.frontier[this.depth].type&&this.frontier.length>1&&this.closeFrontierNode();for(let w=0,C=a;w<k;w++){let N=C.lastChild;this.frontier.push({type:N.type,match:N.contentMatchAt(N.childCount)}),C=N.content}this.unplaced=y?e==0?v.empty:new v(en(o.content,e-1,1),e-1,k<0?o.openEnd:e-1):new v(en(o.content,e,d),o.openStart,o.openEnd)}mustMoveInline(){if(!this.$to.parent.isTextblock)return-1;let e=this.frontier[this.depth],t;if(!e.type.isTextblock||!fi(this.$to,this.$to.depth,e.type,e.match,!1)||this.$to.depth==this.depth&&(t=this.findCloseLevel(this.$to))&&t.depth==this.depth)return-1;let{depth:n}=this.$to,s=this.$to.after(n);for(;n>1&&s==this.$to.end(--n);)++s;return s}findCloseLevel(e){e:for(let t=Math.min(this.depth,e.depth);t>=0;t--){let{match:n,type:s}=this.frontier[t],r=t<e.depth&&e.end(t+1)==e.pos+(e.depth-(t+1)),o=fi(e,t,s,n,r);if(o){for(let a=t-1;a>=0;a--){let{match:l,type:d}=this.frontier[a],u=fi(e,a,d,l,!0);if(!u||u.childCount)continue e}return{depth:t,fit:o,move:r?e.doc.resolve(e.after(t+1)):e}}}}close(e){let t=this.findCloseLevel(e);if(!t)return null;for(;this.depth>t.depth;)this.closeFrontierNode();t.fit.childCount&&(this.placed=tn(this.placed,t.depth,t.fit)),e=t.move;for(let n=t.depth+1;n<=e.depth;n++){let s=e.node(n),r=s.type.contentMatch.fillBefore(s.content,!0,e.index(n));this.openFrontierNode(s.type,s.attrs,r)}return e}openFrontierNode(e,t=null,n){let s=this.frontier[this.depth];s.match=s.match.matchType(e),this.placed=tn(this.placed,this.depth,_.from(e.create(t,n))),this.frontier.push({type:e,match:e.contentMatch})}closeFrontierNode(){let t=this.frontier.pop().match.fillBefore(_.empty,!0);t.childCount&&(this.placed=tn(this.placed,this.frontier.length,t))}}function en(i,e,t){return e==0?i.cutByIndex(t,i.childCount):i.replaceChild(0,i.firstChild.copy(en(i.firstChild.content,e-1,t)))}function tn(i,e,t){return e==0?i.append(t):i.replaceChild(i.childCount-1,i.lastChild.copy(tn(i.lastChild.content,e-1,t)))}function ui(i,e){for(let t=0;t<e;t++)i=i.firstChild.content;return i}function vo(i,e,t){if(e<=0)return i;let n=i.content;return e>1&&(n=n.replaceChild(0,vo(n.firstChild,e-1,n.childCount==1?t-1:0))),e>0&&(n=i.type.contentMatch.fillBefore(n).append(n),t<=0&&(n=n.append(i.type.contentMatch.matchFragment(n).fillBefore(_.empty,!0)))),i.copy(n)}function fi(i,e,t,n,s){let r=i.node(e),o=s?i.indexAfter(e):i.index(e);if(o==r.childCount&&!t.compatibleContent(r.type))return null;let a=n.fillBefore(r.content,!0,o);return a&&!Uh(t,r.content,o)?a:null}function Uh(i,e,t){for(let n=t;n<e.childCount;n++)if(!i.allowsMarks(e.child(n).marks))return!0;return!1}function qh(i){return i.spec.defining||i.spec.definingForContent}function Wh(i,e,t,n){if(!n.size)return i.deleteRange(e,t);let s=i.doc.resolve(e),r=i.doc.resolve(t);if(Ao(s,r,n))return i.step(new xe(e,t,n));let o=Fo(s,i.doc.resolve(t));o[o.length-1]==0&&o.pop();let a=-(s.depth+1);o.unshift(a);for(let p=s.depth,k=s.pos-1;p>0;p--,k--){let y=s.node(p).type.spec;if(y.defining||y.definingAsContext||y.isolating)break;o.indexOf(p)>-1?a=p:s.before(p)==k&&o.splice(1,0,-p)}let l=o.indexOf(a),d=[],u=n.openStart;for(let p=n.content,k=0;;k++){let y=p.firstChild;if(d.push(y),k==n.openStart)break;p=y.content}for(let p=u-1;p>=0;p--){let k=d[p],y=qh(k.type);if(y&&!k.sameMarkup(s.node(Math.abs(a)-1)))u=p;else if(y||!k.type.isTextblock)break}for(let p=n.openStart;p>=0;p--){let k=(p+u+1)%(n.openStart+1),y=d[k];if(y)for(let w=0;w<o.length;w++){let C=o[(w+l)%o.length],N=!0;C<0&&(N=!1,C=-C);let O=s.node(C-1),F=s.index(C-1);if(O.canReplaceWith(F,F,y.type,y.marks))return i.replace(s.before(C),N?r.after(C):t,new v(Bo(n.content,0,n.openStart,k),k,n.openEnd))}}let m=i.steps.length;for(let p=o.length-1;p>=0&&(i.replace(e,t,n),!(i.steps.length>m));p--){let k=o[p];k<0||(e=s.before(k),t=r.after(k))}}function Bo(i,e,t,n,s){if(e<t){let r=i.firstChild;i=i.replaceChild(0,r.copy(Bo(r.content,e+1,t,n,r)))}if(e>n){let r=s.contentMatchAt(0),o=r.fillBefore(i).append(i);i=o.append(r.matchFragment(o).fillBefore(_.empty,!0))}return i}function Hh(i,e,t,n){if(!n.isInline&&e==t&&i.doc.resolve(e).parent.content.size){let s=Lh(i.doc,e,n.type);s!=null&&(e=t=s)}i.replaceRange(e,t,new v(_.from(n),0,0))}function Jh(i,e,t){let n=i.doc.resolve(e),s=i.doc.resolve(t),r=Fo(n,s);for(let o=0;o<r.length;o++){let a=r[o],l=o==r.length-1;if(l&&a==0||n.node(a).type.contentMatch.validEnd)return i.delete(n.start(a),s.end(a));if(a>0&&(l||n.node(a-1).canReplace(n.index(a-1),s.indexAfter(a-1))))return i.delete(n.before(a),s.after(a))}for(let o=1;o<=n.depth&&o<=s.depth;o++)if(e-n.start(o)==n.depth-o&&t>n.end(o)&&s.end(o)-t!=s.depth-o)return i.delete(n.before(o),t);i.delete(e,t)}function Fo(i,e){let t=[],n=Math.min(i.depth,e.depth);for(let s=n;s>=0;s--){let r=i.start(s);if(r<i.pos-(i.depth-s)||e.end(s)>e.pos+(e.depth-s)||i.node(s).type.spec.isolating||e.node(s).type.spec.isolating)break;(r==e.start(s)||s==i.depth&&s==e.depth&&i.parent.inlineContent&&e.parent.inlineContent&&s&&e.start(s-1)==r-1)&&t.push(s)}return t}class Wt extends we{constructor(e,t,n){super(),this.pos=e,this.attr=t,this.value=n}apply(e){let t=e.nodeAt(this.pos);if(!t)return oe.fail("No node at attribute step's position");let n=Object.create(null);for(let r in t.attrs)n[r]=t.attrs[r];n[this.attr]=this.value;let s=t.type.create(n,null,t.marks);return oe.fromReplace(e,this.pos,this.pos+1,new v(_.from(s),0,t.isLeaf?0:1))}getMap(){return Fe.empty}invert(e){return new Wt(this.pos,this.attr,e.nodeAt(this.pos).attrs[this.attr])}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new Wt(t.pos,this.attr,this.value)}toJSON(){return{stepType:"attr",pos:this.pos,attr:this.attr,value:this.value}}static fromJSON(e,t){if(typeof t.pos!="number"||typeof t.attr!="string")throw new RangeError("Invalid input for AttrStep.fromJSON");return new Wt(t.pos,t.attr,t.value)}}we.jsonID("attr",Wt);class pn extends we{constructor(e,t){super(),this.attr=e,this.value=t}apply(e){let t=Object.create(null);for(let s in e.attrs)t[s]=e.attrs[s];t[this.attr]=this.value;let n=e.type.create(t,e.content,e.marks);return oe.ok(n)}getMap(){return Fe.empty}invert(e){return new pn(this.attr,e.attrs[this.attr])}map(e){return this}toJSON(){return{stepType:"docAttr",attr:this.attr,value:this.value}}static fromJSON(e,t){if(typeof t.attr!="string")throw new RangeError("Invalid input for DocAttrStep.fromJSON");return new pn(t.attr,t.value)}}we.jsonID("docAttr",pn);let Kt=class extends Error{};Kt=function i(e){let t=Error.call(this,e);return t.__proto__=i.prototype,t};Kt.prototype=Object.create(Error.prototype);Kt.prototype.constructor=Kt;Kt.prototype.name="TransformError";class $h{constructor(e){this.doc=e,this.steps=[],this.docs=[],this.mapping=new cn}get before(){return this.docs.length?this.docs[0]:this.doc}step(e){let t=this.maybeStep(e);if(t.failed)throw new Kt(t.failed);return this}maybeStep(e){let t=e.apply(this.doc);return t.failed||this.addStep(e,t.doc),t}get docChanged(){return this.steps.length>0}addStep(e,t){this.docs.push(this.doc),this.steps.push(e),this.mapping.appendMap(e.getMap()),this.doc=t}replace(e,t=e,n=v.empty){let s=zh(this.doc,e,t,n);return s&&this.step(s),this}replaceWith(e,t,n){return this.replace(e,t,new v(_.from(n),0,0))}delete(e,t){return this.replace(e,t,v.empty)}insert(e,t){return this.replaceWith(e,e,t)}replaceRange(e,t,n){return Wh(this,e,t,n),this}replaceRangeWith(e,t,n){return Hh(this,e,t,n),this}deleteRange(e,t){return Jh(this,e,t),this}lift(e,t){return Eh(this,e,t),this}join(e,t=1){return Ph(this,e,t),this}wrap(e,t){return _h(this,e,t),this}setBlockType(e,t=e,n,s=null){return Oh(this,e,t,n,s),this}setNodeMarkup(e,t,n=null,s){return vh(this,e,t,n,s),this}setNodeAttribute(e,t,n){return this.step(new Wt(e,t,n)),this}setDocAttribute(e,t){return this.step(new pn(e,t)),this}addNodeMark(e,t){return this.step(new xt(e,t)),this}removeNodeMark(e,t){if(!(t instanceof J)){let n=this.doc.nodeAt(e);if(!n)throw new RangeError("No node at position "+e);if(t=t.isInSet(n.marks),!t)return this}return this.step(new Gt(e,t)),this}split(e,t=1,n){return Bh(this,e,t,n),this}addMark(e,t,n){return Ch(this,e,t,n),this}removeMark(e,t,n){return Th(this,e,t,n),this}clearIncompatible(e,t,n){return Ro(this,e,t,n),this}}const pi=Object.create(null);class Y{constructor(e,t,n){this.$anchor=e,this.$head=t,this.ranges=n||[new Gh(e.min(t),e.max(t))]}get anchor(){return this.$anchor.pos}get head(){return this.$head.pos}get from(){return this.$from.pos}get to(){return this.$to.pos}get $from(){return this.ranges[0].$from}get $to(){return this.ranges[0].$to}get empty(){let e=this.ranges;for(let t=0;t<e.length;t++)if(e[t].$from.pos!=e[t].$to.pos)return!1;return!0}content(){return this.$from.doc.slice(this.from,this.to,!0)}replace(e,t=v.empty){let n=t.content.lastChild,s=null;for(let a=0;a<t.openEnd;a++)s=n,n=n.lastChild;let r=e.steps.length,o=this.ranges;for(let a=0;a<o.length;a++){let{$from:l,$to:d}=o[a],u=e.mapping.slice(r);e.replaceRange(u.map(l.pos),u.map(d.pos),a?v.empty:t),a==0&&Hs(e,r,(n?n.isInline:s&&s.isTextblock)?-1:1)}}replaceWith(e,t){let n=e.steps.length,s=this.ranges;for(let r=0;r<s.length;r++){let{$from:o,$to:a}=s[r],l=e.mapping.slice(n),d=l.map(o.pos),u=l.map(a.pos);r?e.deleteRange(d,u):(e.replaceRangeWith(d,u,t),Hs(e,n,t.isInline?-1:1))}}static findFrom(e,t,n=!1){let s=e.parent.inlineContent?new X(e):Ut(e.node(0),e.parent,e.pos,e.index(),t,n);if(s)return s;for(let r=e.depth-1;r>=0;r--){let o=t<0?Ut(e.node(0),e.node(r),e.before(r+1),e.index(r),t,n):Ut(e.node(0),e.node(r),e.after(r+1),e.index(r)+1,t,n);if(o)return o}return null}static near(e,t=1){return this.findFrom(e,t)||this.findFrom(e,-t)||new tt(e.node(0))}static atStart(e){return Ut(e,e,0,0,1)||new tt(e)}static atEnd(e){return Ut(e,e,e.content.size,e.childCount,-1)||new tt(e)}static fromJSON(e,t){if(!t||!t.type)throw new RangeError("Invalid input for Selection.fromJSON");let n=pi[t.type];if(!n)throw new RangeError(`No selection type ${t.type} defined`);return n.fromJSON(e,t)}static jsonID(e,t){if(e in pi)throw new RangeError("Duplicate use of selection JSON ID "+e);return pi[e]=t,t.prototype.jsonID=e,t}getBookmark(){return X.between(this.$anchor,this.$head).getBookmark()}}Y.prototype.visible=!0;class Gh{constructor(e,t){this.$from=e,this.$to=t}}let qs=!1;function Ws(i){!qs&&!i.parent.inlineContent&&(qs=!0,console.warn("TextSelection endpoint not pointing into a node with inline content ("+i.parent.type.name+")"))}class X extends Y{constructor(e,t=e){Ws(e),Ws(t),super(e,t)}get $cursor(){return this.$anchor.pos==this.$head.pos?this.$head:null}map(e,t){let n=e.resolve(t.map(this.head));if(!n.parent.inlineContent)return Y.near(n);let s=e.resolve(t.map(this.anchor));return new X(s.parent.inlineContent?s:n,n)}replace(e,t=v.empty){if(super.replace(e,t),t==v.empty){let n=this.$from.marksAcross(this.$to);n&&e.ensureMarks(n)}}eq(e){return e instanceof X&&e.anchor==this.anchor&&e.head==this.head}getBookmark(){return new Zn(this.anchor,this.head)}toJSON(){return{type:"text",anchor:this.anchor,head:this.head}}static fromJSON(e,t){if(typeof t.anchor!="number"||typeof t.head!="number")throw new RangeError("Invalid input for TextSelection.fromJSON");return new X(e.resolve(t.anchor),e.resolve(t.head))}static create(e,t,n=t){let s=e.resolve(t);return new this(s,n==t?s:e.resolve(n))}static between(e,t,n){let s=e.pos-t.pos;if((!n||s)&&(n=s>=0?1:-1),!t.parent.inlineContent){let r=Y.findFrom(t,n,!0)||Y.findFrom(t,-n,!0);if(r)t=r.$head;else return Y.near(t,n)}return e.parent.inlineContent||(s==0?e=t:(e=(Y.findFrom(e,-n,!0)||Y.findFrom(e,n,!0)).$anchor,e.pos<t.pos!=s<0&&(e=t))),new X(e,t)}}Y.jsonID("text",X);class Zn{constructor(e,t){this.anchor=e,this.head=t}map(e){return new Zn(e.map(this.anchor),e.map(this.head))}resolve(e){return X.between(e.resolve(this.anchor),e.resolve(this.head))}}class q extends Y{constructor(e){let t=e.nodeAfter,n=e.node(0).resolve(e.pos+t.nodeSize);super(e,n),this.node=t}map(e,t){let{deleted:n,pos:s}=t.mapResult(this.anchor),r=e.resolve(s);return n?Y.near(r):new q(r)}content(){return new v(_.from(this.node),0,0)}eq(e){return e instanceof q&&e.anchor==this.anchor}toJSON(){return{type:"node",anchor:this.anchor}}getBookmark(){return new rs(this.anchor)}static fromJSON(e,t){if(typeof t.anchor!="number")throw new RangeError("Invalid input for NodeSelection.fromJSON");return new q(e.resolve(t.anchor))}static create(e,t){return new q(e.resolve(t))}static isSelectable(e){return!e.isText&&e.type.spec.selectable!==!1}}q.prototype.visible=!1;Y.jsonID("node",q);class rs{constructor(e){this.anchor=e}map(e){let{deleted:t,pos:n}=e.mapResult(this.anchor);return t?new Zn(n,n):new rs(n)}resolve(e){let t=e.resolve(this.anchor),n=t.nodeAfter;return n&&q.isSelectable(n)?new q(t):Y.near(t)}}class tt extends Y{constructor(e){super(e.resolve(0),e.resolve(e.content.size))}replace(e,t=v.empty){if(t==v.empty){e.delete(0,e.doc.content.size);let n=Y.atStart(e.doc);n.eq(e.selection)||e.setSelection(n)}else super.replace(e,t)}toJSON(){return{type:"all"}}static fromJSON(e){return new tt(e)}map(e){return new tt(e)}eq(e){return e instanceof tt}getBookmark(){return Kh}}Y.jsonID("all",tt);const Kh={map(){return this},resolve(i){return new tt(i)}};function Ut(i,e,t,n,s,r=!1){if(e.inlineContent)return X.create(i,t);for(let o=n-(s>0?0:1);s>0?o<e.childCount:o>=0;o+=s){let a=e.child(o);if(a.isAtom){if(!r&&q.isSelectable(a))return q.create(i,t-(s<0?a.nodeSize:0))}else{let l=Ut(i,a,t+s,s<0?a.childCount:0,s,r);if(l)return l}t+=a.nodeSize*s}return null}function Hs(i,e,t){let n=i.steps.length-1;if(n<e)return;let s=i.steps[n];if(!(s instanceof xe||s instanceof Ge))return;let r=i.mapping.maps[n],o;r.forEach((a,l,d,u)=>{o==null&&(o=u)}),i.setSelection(Y.near(i.doc.resolve(o),t))}const Js=1,Nn=2,$s=4;class Yh extends $h{constructor(e){super(e.doc),this.curSelectionFor=0,this.updated=0,this.meta=Object.create(null),this.time=Date.now(),this.curSelection=e.selection,this.storedMarks=e.storedMarks}get selection(){return this.curSelectionFor<this.steps.length&&(this.curSelection=this.curSelection.map(this.doc,this.mapping.slice(this.curSelectionFor)),this.curSelectionFor=this.steps.length),this.curSelection}setSelection(e){if(e.$from.doc!=this.doc)throw new RangeError("Selection passed to setSelection must point at the current document");return this.curSelection=e,this.curSelectionFor=this.steps.length,this.updated=(this.updated|Js)&~Nn,this.storedMarks=null,this}get selectionSet(){return(this.updated&Js)>0}setStoredMarks(e){return this.storedMarks=e,this.updated|=Nn,this}ensureMarks(e){return J.sameSet(this.storedMarks||this.selection.$from.marks(),e)||this.setStoredMarks(e),this}addStoredMark(e){return this.ensureMarks(e.addToSet(this.storedMarks||this.selection.$head.marks()))}removeStoredMark(e){return this.ensureMarks(e.removeFromSet(this.storedMarks||this.selection.$head.marks()))}get storedMarksSet(){return(this.updated&Nn)>0}addStep(e,t){super.addStep(e,t),this.updated=this.updated&~Nn,this.storedMarks=null}setTime(e){return this.time=e,this}replaceSelection(e){return this.selection.replace(this,e),this}replaceSelectionWith(e,t=!0){let n=this.selection;return t&&(e=e.mark(this.storedMarks||(n.empty?n.$from.marks():n.$from.marksAcross(n.$to)||J.none))),n.replaceWith(this,e),this}deleteSelection(){return this.selection.replace(this),this}insertText(e,t,n){let s=this.doc.type.schema;if(t==null)return e?this.replaceSelectionWith(s.text(e),!0):this.deleteSelection();{if(n==null&&(n=t),n=n??t,!e)return this.deleteRange(t,n);let r=this.storedMarks;if(!r){let o=this.doc.resolve(t);r=n==t?o.marks():o.marksAcross(this.doc.resolve(n))}return this.replaceRangeWith(t,n,s.text(e,r)),this.selection.empty||this.setSelection(Y.near(this.selection.$to)),this}}setMeta(e,t){return this.meta[typeof e=="string"?e:e.key]=t,this}getMeta(e){return this.meta[typeof e=="string"?e:e.key]}get isGeneric(){for(let e in this.meta)return!1;return!0}scrollIntoView(){return this.updated|=$s,this}get scrolledIntoView(){return(this.updated&$s)>0}}function Gs(i,e){return!e||!i?i:i.bind(e)}class nn{constructor(e,t,n){this.name=e,this.init=Gs(t.init,n),this.apply=Gs(t.apply,n)}}const Qh=[new nn("doc",{init(i){return i.doc||i.schema.topNodeType.createAndFill()},apply(i){return i.doc}}),new nn("selection",{init(i,e){return i.selection||Y.atStart(e.doc)},apply(i){return i.selection}}),new nn("storedMarks",{init(i){return i.storedMarks||null},apply(i,e,t,n){return n.selection.$cursor?i.storedMarks:null}}),new nn("scrollToSelection",{init(){return 0},apply(i,e){return i.scrolledIntoView?e+1:e}})];class mi{constructor(e,t){this.schema=e,this.plugins=[],this.pluginsByKey=Object.create(null),this.fields=Qh.slice(),t&&t.forEach(n=>{if(this.pluginsByKey[n.key])throw new RangeError("Adding different instances of a keyed plugin ("+n.key+")");this.plugins.push(n),this.pluginsByKey[n.key]=n,n.spec.state&&this.fields.push(new nn(n.key,n.spec.state,n))})}}class sn{constructor(e){this.config=e}get schema(){return this.config.schema}get plugins(){return this.config.plugins}apply(e){return this.applyTransaction(e).state}filterTransaction(e,t=-1){for(let n=0;n<this.config.plugins.length;n++)if(n!=t){let s=this.config.plugins[n];if(s.spec.filterTransaction&&!s.spec.filterTransaction.call(s,e,this))return!1}return!0}applyTransaction(e){if(!this.filterTransaction(e))return{state:this,transactions:[]};let t=[e],n=this.applyInner(e),s=null;for(;;){let r=!1;for(let o=0;o<this.config.plugins.length;o++){let a=this.config.plugins[o];if(a.spec.appendTransaction){let l=s?s[o].n:0,d=s?s[o].state:this,u=l<t.length&&a.spec.appendTransaction.call(a,l?t.slice(l):t,d,n);if(u&&n.filterTransaction(u,o)){if(u.setMeta("appendedTransaction",e),!s){s=[];for(let m=0;m<this.config.plugins.length;m++)s.push(m<o?{state:n,n:t.length}:{state:this,n:0})}t.push(u),n=n.applyInner(u),r=!0}s&&(s[o]={state:n,n:t.length})}}if(!r)return{state:n,transactions:t}}}applyInner(e){if(!e.before.eq(this.doc))throw new RangeError("Applying a mismatched transaction");let t=new sn(this.config),n=this.config.fields;for(let s=0;s<n.length;s++){let r=n[s];t[r.name]=r.apply(e,this[r.name],this,t)}return t}get tr(){return new Yh(this)}static create(e){let t=new mi(e.doc?e.doc.type.schema:e.schema,e.plugins),n=new sn(t);for(let s=0;s<t.fields.length;s++)n[t.fields[s].name]=t.fields[s].init(e,n);return n}reconfigure(e){let t=new mi(this.schema,e.plugins),n=t.fields,s=new sn(t);for(let r=0;r<n.length;r++){let o=n[r].name;s[o]=this.hasOwnProperty(o)?this[o]:n[r].init(e,s)}return s}toJSON(e){let t={doc:this.doc.toJSON(),selection:this.selection.toJSON()};if(this.storedMarks&&(t.storedMarks=this.storedMarks.map(n=>n.toJSON())),e&&typeof e=="object")for(let n in e){if(n=="doc"||n=="selection")throw new RangeError("The JSON fields `doc` and `selection` are reserved");let s=e[n],r=s.spec.state;r&&r.toJSON&&(t[n]=r.toJSON.call(s,this[s.key]))}return t}static fromJSON(e,t,n){if(!t)throw new RangeError("Invalid input for EditorState.fromJSON");if(!e.schema)throw new RangeError("Required config field 'schema' missing");let s=new mi(e.schema,e.plugins),r=new sn(s);return s.fields.forEach(o=>{if(o.name=="doc")r.doc=et.fromJSON(e.schema,t.doc);else if(o.name=="selection")r.selection=Y.fromJSON(r.doc,t.selection);else if(o.name=="storedMarks")t.storedMarks&&(r.storedMarks=t.storedMarks.map(e.schema.markFromJSON));else{if(n)for(let a in n){let l=n[a],d=l.spec.state;if(l.key==o.name&&d&&d.fromJSON&&Object.prototype.hasOwnProperty.call(t,a)){r[o.name]=d.fromJSON.call(l,e,t[a],r);return}}r[o.name]=o.init(e,r)}}),r}}function Po(i,e,t){for(let n in i){let s=i[n];s instanceof Function?s=s.bind(e):n=="handleDOMEvents"&&(s=Po(s,e,{})),t[n]=s}return t}class Pm{constructor(e){this.spec=e,this.props={},e.props&&Po(e.props,this,this.props),this.key=e.key?e.key.key:Lo("plugin")}getState(e){return e[this.key]}}const gi=Object.create(null);function Lo(i){return i in gi?i+"$"+ ++gi[i]:(gi[i]=0,i+"$")}class Lm{constructor(e="key"){this.key=Lo(e)}get(e){return e.config.pluginsByKey[this.key]}getState(e){return e[this.key]}}const he=function(i){for(var e=0;;e++)if(i=i.previousSibling,!i)return e},mn=function(i){let e=i.assignedSlot||i.parentNode;return e&&e.nodeType==11?e.host:e};let Bi=null;const at=function(i,e,t){let n=Bi||(Bi=document.createRange());return n.setEnd(i,t??i.nodeValue.length),n.setStart(i,e||0),n},Zh=function(){Bi=null},Bt=function(i,e,t,n){return t&&(Ks(i,e,t,n,-1)||Ks(i,e,t,n,1))},Xh=/^(img|br|input|textarea|hr)$/i;function Ks(i,e,t,n,s){for(;;){if(i==t&&e==n)return!0;if(e==(s<0?0:Ze(i))){let r=i.parentNode;if(!r||r.nodeType!=1||bn(i)||Xh.test(i.nodeName)||i.contentEditable=="false")return!1;e=he(i)+(s<0?0:1),i=r}else if(i.nodeType==1){if(i=i.childNodes[e+(s<0?-1:0)],i.contentEditable=="false")return!1;e=s<0?Ze(i):0}else return!1}}function Ze(i){return i.nodeType==3?i.nodeValue.length:i.childNodes.length}function eu(i,e){for(;;){if(i.nodeType==3&&e)return i;if(i.nodeType==1&&e>0){if(i.contentEditable=="false")return null;i=i.childNodes[e-1],e=Ze(i)}else if(i.parentNode&&!bn(i))e=he(i),i=i.parentNode;else return null}}function tu(i,e){for(;;){if(i.nodeType==3&&e<i.nodeValue.length)return i;if(i.nodeType==1&&e<i.childNodes.length){if(i.contentEditable=="false")return null;i=i.childNodes[e],e=0}else if(i.parentNode&&!bn(i))e=he(i)+1,i=i.parentNode;else return null}}function nu(i,e,t){for(let n=e==0,s=e==Ze(i);n||s;){if(i==t)return!0;let r=he(i);if(i=i.parentNode,!i)return!1;n=n&&r==0,s=s&&r==Ze(i)}}function bn(i){let e;for(let t=i;t&&!(e=t.pmViewDesc);t=t.parentNode);return e&&e.node&&e.node.isBlock&&(e.dom==i||e.contentDOM==i)}const Xn=function(i){return i.focusNode&&Bt(i.focusNode,i.focusOffset,i.anchorNode,i.anchorOffset)};function It(i,e){let t=document.createEvent("Event");return t.initEvent("keydown",!0,!0),t.keyCode=i,t.key=t.code=e,t}function iu(i){let e=i.activeElement;for(;e&&e.shadowRoot;)e=e.shadowRoot.activeElement;return e}function su(i,e,t){if(i.caretPositionFromPoint)try{let n=i.caretPositionFromPoint(e,t);if(n)return{node:n.offsetNode,offset:n.offset}}catch{}if(i.caretRangeFromPoint){let n=i.caretRangeFromPoint(e,t);if(n)return{node:n.startContainer,offset:n.startOffset}}}const nt=typeof navigator<"u"?navigator:null,Ys=typeof document<"u"?document:null,Mt=nt&&nt.userAgent||"",Fi=/Edge\/(\d+)/.exec(Mt),jo=/MSIE \d/.exec(Mt),Pi=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(Mt),Oe=!!(jo||Pi||Fi),wt=jo?document.documentMode:Pi?+Pi[1]:Fi?+Fi[1]:0,Ke=!Oe&&/gecko\/(\d+)/i.test(Mt);Ke&&+(/Firefox\/(\d+)/.exec(Mt)||[0,0])[1];const Li=!Oe&&/Chrome\/(\d+)/.exec(Mt),ke=!!Li,zo=Li?+Li[1]:0,Te=!Oe&&!!nt&&/Apple Computer/.test(nt.vendor),Yt=Te&&(/Mobile\/\w+/.test(Mt)||!!nt&&nt.maxTouchPoints>2),Le=Yt||(nt?/Mac/.test(nt.platform):!1),ru=nt?/Win/.test(nt.platform):!1,We=/Android \d/.test(Mt),wn=!!Ys&&"webkitFontSmoothing"in Ys.documentElement.style,ou=wn?+(/\bAppleWebKit\/(\d+)/.exec(navigator.userAgent)||[0,0])[1]:0;function au(i){let e=i.defaultView&&i.defaultView.visualViewport;return e?{left:0,right:e.width,top:0,bottom:e.height}:{left:0,right:i.documentElement.clientWidth,top:0,bottom:i.documentElement.clientHeight}}function rt(i,e){return typeof i=="number"?i:i[e]}function lu(i){let e=i.getBoundingClientRect(),t=e.width/i.offsetWidth||1,n=e.height/i.offsetHeight||1;return{left:e.left,right:e.left+i.clientWidth*t,top:e.top,bottom:e.top+i.clientHeight*n}}function Qs(i,e,t){let n=i.someProp("scrollThreshold")||0,s=i.someProp("scrollMargin")||5,r=i.dom.ownerDocument;for(let o=t||i.dom;o;o=mn(o)){if(o.nodeType!=1)continue;let a=o,l=a==r.body,d=l?au(r):lu(a),u=0,m=0;if(e.top<d.top+rt(n,"top")?m=-(d.top-e.top+rt(s,"top")):e.bottom>d.bottom-rt(n,"bottom")&&(m=e.bottom-e.top>d.bottom-d.top?e.top+rt(s,"top")-d.top:e.bottom-d.bottom+rt(s,"bottom")),e.left<d.left+rt(n,"left")?u=-(d.left-e.left+rt(s,"left")):e.right>d.right-rt(n,"right")&&(u=e.right-d.right+rt(s,"right")),u||m)if(l)r.defaultView.scrollBy(u,m);else{let p=a.scrollLeft,k=a.scrollTop;m&&(a.scrollTop+=m),u&&(a.scrollLeft+=u);let y=a.scrollLeft-p,w=a.scrollTop-k;e={left:e.left-y,top:e.top-w,right:e.right-y,bottom:e.bottom-w}}if(l||/^(fixed|sticky)$/.test(getComputedStyle(o).position))break}}function cu(i){let e=i.dom.getBoundingClientRect(),t=Math.max(0,e.top),n,s;for(let r=(e.left+e.right)/2,o=t+1;o<Math.min(innerHeight,e.bottom);o+=5){let a=i.root.elementFromPoint(r,o);if(!a||a==i.dom||!i.dom.contains(a))continue;let l=a.getBoundingClientRect();if(l.top>=t-20){n=a,s=l.top;break}}return{refDOM:n,refTop:s,stack:Vo(i.dom)}}function Vo(i){let e=[],t=i.ownerDocument;for(let n=i;n&&(e.push({dom:n,top:n.scrollTop,left:n.scrollLeft}),i!=t);n=mn(n));return e}function du({refDOM:i,refTop:e,stack:t}){let n=i?i.getBoundingClientRect().top:0;Uo(t,n==0?0:n-e)}function Uo(i,e){for(let t=0;t<i.length;t++){let{dom:n,top:s,left:r}=i[t];n.scrollTop!=s+e&&(n.scrollTop=s+e),n.scrollLeft!=r&&(n.scrollLeft=r)}}let Lt=null;function hu(i){if(i.setActive)return i.setActive();if(Lt)return i.focus(Lt);let e=Vo(i);i.focus(Lt==null?{get preventScroll(){return Lt={preventScroll:!0},!0}}:void 0),Lt||(Lt=!1,Uo(e,0))}function qo(i,e){let t,n=2e8,s,r=0,o=e.top,a=e.top,l,d;for(let u=i.firstChild,m=0;u;u=u.nextSibling,m++){let p;if(u.nodeType==1)p=u.getClientRects();else if(u.nodeType==3)p=at(u).getClientRects();else continue;for(let k=0;k<p.length;k++){let y=p[k];if(y.top<=o&&y.bottom>=a){o=Math.max(y.bottom,o),a=Math.min(y.top,a);let w=y.left>e.left?y.left-e.left:y.right<e.left?e.left-y.right:0;if(w<n){t=u,n=w,s=w&&t.nodeType==3?{left:y.right<e.left?y.right:y.left,top:e.top}:e,u.nodeType==1&&w&&(r=m+(e.left>=(y.left+y.right)/2?1:0));continue}}else y.top>e.top&&!l&&y.left<=e.left&&y.right>=e.left&&(l=u,d={left:Math.max(y.left,Math.min(y.right,e.left)),top:y.top});!t&&(e.left>=y.right&&e.top>=y.top||e.left>=y.left&&e.top>=y.bottom)&&(r=m+1)}}return!t&&l&&(t=l,s=d,n=0),t&&t.nodeType==3?uu(t,s):!t||n&&t.nodeType==1?{node:i,offset:r}:qo(t,s)}function uu(i,e){let t=i.nodeValue.length,n=document.createRange();for(let s=0;s<t;s++){n.setEnd(i,s+1),n.setStart(i,s);let r=pt(n,1);if(r.top!=r.bottom&&os(e,r))return{node:i,offset:s+(e.left>=(r.left+r.right)/2?1:0)}}return{node:i,offset:0}}function os(i,e){return i.left>=e.left-1&&i.left<=e.right+1&&i.top>=e.top-1&&i.top<=e.bottom+1}function fu(i,e){let t=i.parentNode;return t&&/^li$/i.test(t.nodeName)&&e.left<i.getBoundingClientRect().left?t:i}function pu(i,e,t){let{node:n,offset:s}=qo(e,t),r=-1;if(n.nodeType==1&&!n.firstChild){let o=n.getBoundingClientRect();r=o.left!=o.right&&t.left>(o.left+o.right)/2?1:-1}return i.docView.posFromDOM(n,s,r)}function mu(i,e,t,n){let s=-1;for(let r=e,o=!1;r!=i.dom;){let a=i.docView.nearestDesc(r,!0);if(!a)return null;if(a.dom.nodeType==1&&(a.node.isBlock&&a.parent||!a.contentDOM)){let l=a.dom.getBoundingClientRect();if(a.node.isBlock&&a.parent&&(!o&&l.left>n.left||l.top>n.top?s=a.posBefore:(!o&&l.right<n.left||l.bottom<n.top)&&(s=a.posAfter),o=!0),!a.contentDOM&&s<0&&!a.node.isText)return(a.node.isBlock?n.top<(l.top+l.bottom)/2:n.left<(l.left+l.right)/2)?a.posBefore:a.posAfter}r=a.dom.parentNode}return s>-1?s:i.docView.posFromDOM(e,t,-1)}function Wo(i,e,t){let n=i.childNodes.length;if(n&&t.top<t.bottom)for(let s=Math.max(0,Math.min(n-1,Math.floor(n*(e.top-t.top)/(t.bottom-t.top))-2)),r=s;;){let o=i.childNodes[r];if(o.nodeType==1){let a=o.getClientRects();for(let l=0;l<a.length;l++){let d=a[l];if(os(e,d))return Wo(o,e,d)}}if((r=(r+1)%n)==s)break}return i}function gu(i,e){let t=i.dom.ownerDocument,n,s=0,r=su(t,e.left,e.top);r&&({node:n,offset:s}=r);let o=(i.root.elementFromPoint?i.root:t).elementFromPoint(e.left,e.top),a;if(!o||!i.dom.contains(o.nodeType!=1?o.parentNode:o)){let d=i.dom.getBoundingClientRect();if(!os(e,d)||(o=Wo(i.dom,e,d),!o))return null}if(Te)for(let d=o;n&&d;d=mn(d))d.draggable&&(n=void 0);if(o=fu(o,e),n){if(Ke&&n.nodeType==1&&(s=Math.min(s,n.childNodes.length),s<n.childNodes.length)){let u=n.childNodes[s],m;u.nodeName=="IMG"&&(m=u.getBoundingClientRect()).right<=e.left&&m.bottom>e.top&&s++}let d;wn&&s&&n.nodeType==1&&(d=n.childNodes[s-1]).nodeType==1&&d.contentEditable=="false"&&d.getBoundingClientRect().top>=e.top&&s--,n==i.dom&&s==n.childNodes.length-1&&n.lastChild.nodeType==1&&e.top>n.lastChild.getBoundingClientRect().bottom?a=i.state.doc.content.size:(s==0||n.nodeType!=1||n.childNodes[s-1].nodeName!="BR")&&(a=mu(i,n,s,e))}a==null&&(a=pu(i,o,e));let l=i.docView.nearestDesc(o,!0);return{pos:a,inside:l?l.posAtStart-l.border:-1}}function Zs(i){return i.top<i.bottom||i.left<i.right}function pt(i,e){let t=i.getClientRects();if(t.length){let n=t[e<0?0:t.length-1];if(Zs(n))return n}return Array.prototype.find.call(t,Zs)||i.getBoundingClientRect()}const yu=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/;function Ho(i,e,t){let{node:n,offset:s,atom:r}=i.docView.domFromPos(e,t<0?-1:1),o=wn||Ke;if(n.nodeType==3)if(o&&(yu.test(n.nodeValue)||(t<0?!s:s==n.nodeValue.length))){let l=pt(at(n,s,s),t);if(Ke&&s&&/\s/.test(n.nodeValue[s-1])&&s<n.nodeValue.length){let d=pt(at(n,s-1,s-1),-1);if(d.top==l.top){let u=pt(at(n,s,s+1),-1);if(u.top!=l.top)return Xt(u,u.left<d.left)}}return l}else{let l=s,d=s,u=t<0?1:-1;return t<0&&!s?(d++,u=-1):t>=0&&s==n.nodeValue.length?(l--,u=1):t<0?l--:d++,Xt(pt(at(n,l,d),u),u<0)}if(!i.state.doc.resolve(e-(r||0)).parent.inlineContent){if(r==null&&s&&(t<0||s==Ze(n))){let l=n.childNodes[s-1];if(l.nodeType==1)return yi(l.getBoundingClientRect(),!1)}if(r==null&&s<Ze(n)){let l=n.childNodes[s];if(l.nodeType==1)return yi(l.getBoundingClientRect(),!0)}return yi(n.getBoundingClientRect(),t>=0)}if(r==null&&s&&(t<0||s==Ze(n))){let l=n.childNodes[s-1],d=l.nodeType==3?at(l,Ze(l)-(o?0:1)):l.nodeType==1&&(l.nodeName!="BR"||!l.nextSibling)?l:null;if(d)return Xt(pt(d,1),!1)}if(r==null&&s<Ze(n)){let l=n.childNodes[s];for(;l.pmViewDesc&&l.pmViewDesc.ignoreForCoords;)l=l.nextSibling;let d=l?l.nodeType==3?at(l,0,o?0:1):l.nodeType==1?l:null:null;if(d)return Xt(pt(d,-1),!0)}return Xt(pt(n.nodeType==3?at(n):n,-t),t>=0)}function Xt(i,e){if(i.width==0)return i;let t=e?i.left:i.right;return{top:i.top,bottom:i.bottom,left:t,right:t}}function yi(i,e){if(i.height==0)return i;let t=e?i.top:i.bottom;return{top:t,bottom:t,left:i.left,right:i.right}}function Jo(i,e,t){let n=i.state,s=i.root.activeElement;n!=e&&i.updateState(e),s!=i.dom&&i.focus();try{return t()}finally{n!=e&&i.updateState(n),s!=i.dom&&s&&s.focus()}}function xu(i,e,t){let n=e.selection,s=t=="up"?n.$from:n.$to;return Jo(i,e,()=>{let{node:r}=i.docView.domFromPos(s.pos,t=="up"?-1:1);for(;;){let a=i.docView.nearestDesc(r,!0);if(!a)break;if(a.node.isBlock){r=a.contentDOM||a.dom;break}r=a.dom.parentNode}let o=Ho(i,s.pos,1);for(let a=r.firstChild;a;a=a.nextSibling){let l;if(a.nodeType==1)l=a.getClientRects();else if(a.nodeType==3)l=at(a,0,a.nodeValue.length).getClientRects();else continue;for(let d=0;d<l.length;d++){let u=l[d];if(u.bottom>u.top+1&&(t=="up"?o.top-u.top>(u.bottom-o.top)*2:u.bottom-o.bottom>(o.bottom-u.top)*2))return!1}}return!0})}const ku=/[\u0590-\u08ac]/;function bu(i,e,t){let{$head:n}=e.selection;if(!n.parent.isTextblock)return!1;let s=n.parentOffset,r=!s,o=s==n.parent.content.size,a=i.domSelection();return!ku.test(n.parent.textContent)||!a.modify?t=="left"||t=="backward"?r:o:Jo(i,e,()=>{let{focusNode:l,focusOffset:d,anchorNode:u,anchorOffset:m}=i.domSelectionRange(),p=a.caretBidiLevel;a.modify("move",t,"character");let k=n.depth?i.docView.domAfterPos(n.before()):i.dom,{focusNode:y,focusOffset:w}=i.domSelectionRange(),C=y&&!k.contains(y.nodeType==1?y:y.parentNode)||l==y&&d==w;try{a.collapse(u,m),l&&(l!=u||d!=m)&&a.extend&&a.extend(l,d)}catch{}return p!=null&&(a.caretBidiLevel=p),C})}let Xs=null,er=null,tr=!1;function wu(i,e,t){return Xs==e&&er==t?tr:(Xs=e,er=t,tr=t=="up"||t=="down"?xu(i,e,t):bu(i,e,t))}const Ve=0,nr=1,Nt=2,it=3;class Sn{constructor(e,t,n,s){this.parent=e,this.children=t,this.dom=n,this.contentDOM=s,this.dirty=Ve,n.pmViewDesc=this}matchesWidget(e){return!1}matchesMark(e){return!1}matchesNode(e,t,n){return!1}matchesHack(e){return!1}parseRule(){return null}stopEvent(e){return!1}get size(){let e=0;for(let t=0;t<this.children.length;t++)e+=this.children[t].size;return e}get border(){return 0}destroy(){this.parent=void 0,this.dom.pmViewDesc==this&&(this.dom.pmViewDesc=void 0);for(let e=0;e<this.children.length;e++)this.children[e].destroy()}posBeforeChild(e){for(let t=0,n=this.posAtStart;;t++){let s=this.children[t];if(s==e)return n;n+=s.size}}get posBefore(){return this.parent.posBeforeChild(this)}get posAtStart(){return this.parent?this.parent.posBeforeChild(this)+this.border:0}get posAfter(){return this.posBefore+this.size}get posAtEnd(){return this.posAtStart+this.size-2*this.border}localPosFromDOM(e,t,n){if(this.contentDOM&&this.contentDOM.contains(e.nodeType==1?e:e.parentNode))if(n<0){let r,o;if(e==this.contentDOM)r=e.childNodes[t-1];else{for(;e.parentNode!=this.contentDOM;)e=e.parentNode;r=e.previousSibling}for(;r&&!((o=r.pmViewDesc)&&o.parent==this);)r=r.previousSibling;return r?this.posBeforeChild(o)+o.size:this.posAtStart}else{let r,o;if(e==this.contentDOM)r=e.childNodes[t];else{for(;e.parentNode!=this.contentDOM;)e=e.parentNode;r=e.nextSibling}for(;r&&!((o=r.pmViewDesc)&&o.parent==this);)r=r.nextSibling;return r?this.posBeforeChild(o):this.posAtEnd}let s;if(e==this.dom&&this.contentDOM)s=t>he(this.contentDOM);else if(this.contentDOM&&this.contentDOM!=this.dom&&this.dom.contains(this.contentDOM))s=e.compareDocumentPosition(this.contentDOM)&2;else if(this.dom.firstChild){if(t==0)for(let r=e;;r=r.parentNode){if(r==this.dom){s=!1;break}if(r.previousSibling)break}if(s==null&&t==e.childNodes.length)for(let r=e;;r=r.parentNode){if(r==this.dom){s=!0;break}if(r.nextSibling)break}}return s??n>0?this.posAtEnd:this.posAtStart}nearestDesc(e,t=!1){for(let n=!0,s=e;s;s=s.parentNode){let r=this.getDesc(s),o;if(r&&(!t||r.node))if(n&&(o=r.nodeDOM)&&!(o.nodeType==1?o.contains(e.nodeType==1?e:e.parentNode):o==e))n=!1;else return r}}getDesc(e){let t=e.pmViewDesc;for(let n=t;n;n=n.parent)if(n==this)return t}posFromDOM(e,t,n){for(let s=e;s;s=s.parentNode){let r=this.getDesc(s);if(r)return r.localPosFromDOM(e,t,n)}return-1}descAt(e){for(let t=0,n=0;t<this.children.length;t++){let s=this.children[t],r=n+s.size;if(n==e&&r!=n){for(;!s.border&&s.children.length;)s=s.children[0];return s}if(e<r)return s.descAt(e-n-s.border);n=r}}domFromPos(e,t){if(!this.contentDOM)return{node:this.dom,offset:0,atom:e+1};let n=0,s=0;for(let r=0;n<this.children.length;n++){let o=this.children[n],a=r+o.size;if(a>e||o instanceof Go){s=e-r;break}r=a}if(s)return this.children[n].domFromPos(s-this.children[n].border,t);for(let r;n&&!(r=this.children[n-1]).size&&r instanceof $o&&r.side>=0;n--);if(t<=0){let r,o=!0;for(;r=n?this.children[n-1]:null,!(!r||r.dom.parentNode==this.contentDOM);n--,o=!1);return r&&t&&o&&!r.border&&!r.domAtom?r.domFromPos(r.size,t):{node:this.contentDOM,offset:r?he(r.dom)+1:0}}else{let r,o=!0;for(;r=n<this.children.length?this.children[n]:null,!(!r||r.dom.parentNode==this.contentDOM);n++,o=!1);return r&&o&&!r.border&&!r.domAtom?r.domFromPos(0,t):{node:this.contentDOM,offset:r?he(r.dom):this.contentDOM.childNodes.length}}}parseRange(e,t,n=0){if(this.children.length==0)return{node:this.contentDOM,from:e,to:t,fromOffset:0,toOffset:this.contentDOM.childNodes.length};let s=-1,r=-1;for(let o=n,a=0;;a++){let l=this.children[a],d=o+l.size;if(s==-1&&e<=d){let u=o+l.border;if(e>=u&&t<=d-l.border&&l.node&&l.contentDOM&&this.contentDOM.contains(l.contentDOM))return l.parseRange(e,t,u);e=o;for(let m=a;m>0;m--){let p=this.children[m-1];if(p.size&&p.dom.parentNode==this.contentDOM&&!p.emptyChildAt(1)){s=he(p.dom)+1;break}e-=p.size}s==-1&&(s=0)}if(s>-1&&(d>t||a==this.children.length-1)){t=d;for(let u=a+1;u<this.children.length;u++){let m=this.children[u];if(m.size&&m.dom.parentNode==this.contentDOM&&!m.emptyChildAt(-1)){r=he(m.dom);break}t+=m.size}r==-1&&(r=this.contentDOM.childNodes.length);break}o=d}return{node:this.contentDOM,from:e,to:t,fromOffset:s,toOffset:r}}emptyChildAt(e){if(this.border||!this.contentDOM||!this.children.length)return!1;let t=this.children[e<0?0:this.children.length-1];return t.size==0||t.emptyChildAt(e)}domAfterPos(e){let{node:t,offset:n}=this.domFromPos(e,0);if(t.nodeType!=1||n==t.childNodes.length)throw new RangeError("No node after pos "+e);return t.childNodes[n]}setSelection(e,t,n,s=!1){let r=Math.min(e,t),o=Math.max(e,t);for(let p=0,k=0;p<this.children.length;p++){let y=this.children[p],w=k+y.size;if(r>k&&o<w)return y.setSelection(e-k-y.border,t-k-y.border,n,s);k=w}let a=this.domFromPos(e,e?-1:1),l=t==e?a:this.domFromPos(t,t?-1:1),d=n.getSelection(),u=!1;if((Ke||Te)&&e==t){let{node:p,offset:k}=a;if(p.nodeType==3){if(u=!!(k&&p.nodeValue[k-1]==`
`),u&&k==p.nodeValue.length)for(let y=p,w;y;y=y.parentNode){if(w=y.nextSibling){w.nodeName=="BR"&&(a=l={node:w.parentNode,offset:he(w)+1});break}let C=y.pmViewDesc;if(C&&C.node&&C.node.isBlock)break}}else{let y=p.childNodes[k-1];u=y&&(y.nodeName=="BR"||y.contentEditable=="false")}}if(Ke&&d.focusNode&&d.focusNode!=l.node&&d.focusNode.nodeType==1){let p=d.focusNode.childNodes[d.focusOffset];p&&p.contentEditable=="false"&&(s=!0)}if(!(s||u&&Te)&&Bt(a.node,a.offset,d.anchorNode,d.anchorOffset)&&Bt(l.node,l.offset,d.focusNode,d.focusOffset))return;let m=!1;if((d.extend||e==t)&&!u){d.collapse(a.node,a.offset);try{e!=t&&d.extend(l.node,l.offset),m=!0}catch{}}if(!m){if(e>t){let k=a;a=l,l=k}let p=document.createRange();p.setEnd(l.node,l.offset),p.setStart(a.node,a.offset),d.removeAllRanges(),d.addRange(p)}}ignoreMutation(e){return!this.contentDOM&&e.type!="selection"}get contentLost(){return this.contentDOM&&this.contentDOM!=this.dom&&!this.dom.contains(this.contentDOM)}markDirty(e,t){for(let n=0,s=0;s<this.children.length;s++){let r=this.children[s],o=n+r.size;if(n==o?e<=o&&t>=n:e<o&&t>n){let a=n+r.border,l=o-r.border;if(e>=a&&t<=l){this.dirty=e==n||t==o?Nt:nr,e==a&&t==l&&(r.contentLost||r.dom.parentNode!=this.contentDOM)?r.dirty=it:r.markDirty(e-a,t-a);return}else r.dirty=r.dom==r.contentDOM&&r.dom.parentNode==this.contentDOM&&!r.children.length?Nt:it}n=o}this.dirty=Nt}markParentsDirty(){let e=1;for(let t=this.parent;t;t=t.parent,e++){let n=e==1?Nt:nr;t.dirty<n&&(t.dirty=n)}}get domAtom(){return!1}get ignoreForCoords(){return!1}isText(e){return!1}}class $o extends Sn{constructor(e,t,n,s){let r,o=t.type.toDOM;if(typeof o=="function"&&(o=o(n,()=>{if(!r)return s;if(r.parent)return r.parent.posBeforeChild(r)})),!t.type.spec.raw){if(o.nodeType!=1){let a=document.createElement("span");a.appendChild(o),o=a}o.contentEditable="false",o.classList.add("ProseMirror-widget")}super(e,[],o,null),this.widget=t,this.widget=t,r=this}matchesWidget(e){return this.dirty==Ve&&e.type.eq(this.widget.type)}parseRule(){return{ignore:!0}}stopEvent(e){let t=this.widget.spec.stopEvent;return t?t(e):!1}ignoreMutation(e){return e.type!="selection"||this.widget.spec.ignoreSelection}destroy(){this.widget.type.destroy(this.dom),super.destroy()}get domAtom(){return!0}get side(){return this.widget.type.side}}class Su extends Sn{constructor(e,t,n,s){super(e,[],t,null),this.textDOM=n,this.text=s}get size(){return this.text.length}localPosFromDOM(e,t){return e!=this.textDOM?this.posAtStart+(t?this.size:0):this.posAtStart+t}domFromPos(e){return{node:this.textDOM,offset:e}}ignoreMutation(e){return e.type==="characterData"&&e.target.nodeValue==e.oldValue}}class Ft extends Sn{constructor(e,t,n,s){super(e,[],n,s),this.mark=t}static create(e,t,n,s){let r=s.nodeViews[t.type.name],o=r&&r(t,s,n);return(!o||!o.dom)&&(o=Qt.renderSpec(document,t.type.spec.toDOM(t,n),null,t.attrs)),new Ft(e,t,o.dom,o.contentDOM||o.dom)}parseRule(){return this.dirty&it||this.mark.type.spec.reparseInView?null:{mark:this.mark.type.name,attrs:this.mark.attrs,contentElement:this.contentDOM}}matchesMark(e){return this.dirty!=it&&this.mark.eq(e)}markDirty(e,t){if(super.markDirty(e,t),this.dirty!=Ve){let n=this.parent;for(;!n.node;)n=n.parent;n.dirty<this.dirty&&(n.dirty=this.dirty),this.dirty=Ve}}slice(e,t,n){let s=Ft.create(this.parent,this.mark,!0,n),r=this.children,o=this.size;t<o&&(r=Vi(r,t,o,n)),e>0&&(r=Vi(r,0,e,n));for(let a=0;a<r.length;a++)r[a].parent=s;return s.children=r,s}}class St extends Sn{constructor(e,t,n,s,r,o,a,l,d){super(e,[],r,o),this.node=t,this.outerDeco=n,this.innerDeco=s,this.nodeDOM=a}static create(e,t,n,s,r,o){let a=r.nodeViews[t.type.name],l,d=a&&a(t,r,()=>{if(!l)return o;if(l.parent)return l.parent.posBeforeChild(l)},n,s),u=d&&d.dom,m=d&&d.contentDOM;if(t.isText){if(!u)u=document.createTextNode(t.text);else if(u.nodeType!=3)throw new RangeError("Text must be rendered as a DOM text node")}else u||({dom:u,contentDOM:m}=Qt.renderSpec(document,t.type.spec.toDOM(t),null,t.attrs));!m&&!t.isText&&u.nodeName!="BR"&&(u.hasAttribute("contenteditable")||(u.contentEditable="false"),t.type.spec.draggable&&(u.draggable=!0));let p=u;return u=Qo(u,n,t),d?l=new Cu(e,t,n,s,u,m||null,p,d,r,o+1):t.isText?new ei(e,t,n,s,u,p,r):new St(e,t,n,s,u,m||null,p,r,o+1)}parseRule(){if(this.node.type.spec.reparseInView)return null;let e={node:this.node.type.name,attrs:this.node.attrs};if(this.node.type.whitespace=="pre"&&(e.preserveWhitespace="full"),!this.contentDOM)e.getContent=()=>this.node.content;else if(!this.contentLost)e.contentElement=this.contentDOM;else{for(let t=this.children.length-1;t>=0;t--){let n=this.children[t];if(this.dom.contains(n.dom.parentNode)){e.contentElement=n.dom.parentNode;break}}e.contentElement||(e.getContent=()=>_.empty)}return e}matchesNode(e,t,n){return this.dirty==Ve&&e.eq(this.node)&&zi(t,this.outerDeco)&&n.eq(this.innerDeco)}get size(){return this.node.nodeSize}get border(){return this.node.isLeaf?0:1}updateChildren(e,t){let n=this.node.inlineContent,s=t,r=e.composing?this.localCompositionInfo(e,t):null,o=r&&r.pos>-1?r:null,a=r&&r.pos<0,l=new Mu(this,o&&o.node,e);Nu(this.node,this.innerDeco,(d,u,m)=>{d.spec.marks?l.syncToMarks(d.spec.marks,n,e):d.type.side>=0&&!m&&l.syncToMarks(u==this.node.childCount?J.none:this.node.child(u).marks,n,e),l.placeWidget(d,e,s)},(d,u,m,p)=>{l.syncToMarks(d.marks,n,e);let k;l.findNodeMatch(d,u,m,p)||a&&e.state.selection.from>s&&e.state.selection.to<s+d.nodeSize&&(k=l.findIndexWithChild(r.node))>-1&&l.updateNodeAt(d,u,m,k,e)||l.updateNextNode(d,u,m,e,p,s)||l.addNode(d,u,m,e,s),s+=d.nodeSize}),l.syncToMarks([],n,e),this.node.isTextblock&&l.addTextblockHacks(),l.destroyRest(),(l.changed||this.dirty==Nt)&&(o&&this.protectLocalComposition(e,o),Ko(this.contentDOM,this.children,e),Yt&&_u(this.dom))}localCompositionInfo(e,t){let{from:n,to:s}=e.state.selection;if(!(e.state.selection instanceof X)||n<t||s>t+this.node.content.size)return null;let r=e.input.compositionNode;if(!r||!this.dom.contains(r.parentNode))return null;if(this.node.inlineContent){let o=r.nodeValue,a=Ou(this.node.content,o,n-t,s-t);return a<0?null:{node:r,pos:a,text:o}}else return{node:r,pos:-1,text:""}}protectLocalComposition(e,{node:t,pos:n,text:s}){if(this.getDesc(t))return;let r=t;for(;r.parentNode!=this.contentDOM;r=r.parentNode){for(;r.previousSibling;)r.parentNode.removeChild(r.previousSibling);for(;r.nextSibling;)r.parentNode.removeChild(r.nextSibling);r.pmViewDesc&&(r.pmViewDesc=void 0)}let o=new Su(this,r,t,s);e.input.compositionNodes.push(o),this.children=Vi(this.children,n,n+s.length,e,o)}update(e,t,n,s){return this.dirty==it||!e.sameMarkup(this.node)?!1:(this.updateInner(e,t,n,s),!0)}updateInner(e,t,n,s){this.updateOuterDeco(t),this.node=e,this.innerDeco=n,this.contentDOM&&this.updateChildren(s,this.posAtStart),this.dirty=Ve}updateOuterDeco(e){if(zi(e,this.outerDeco))return;let t=this.nodeDOM.nodeType!=1,n=this.dom;this.dom=Yo(this.dom,this.nodeDOM,ji(this.outerDeco,this.node,t),ji(e,this.node,t)),this.dom!=n&&(n.pmViewDesc=void 0,this.dom.pmViewDesc=this),this.outerDeco=e}selectNode(){this.nodeDOM.nodeType==1&&this.nodeDOM.classList.add("ProseMirror-selectednode"),(this.contentDOM||!this.node.type.spec.draggable)&&(this.dom.draggable=!0)}deselectNode(){this.nodeDOM.nodeType==1&&(this.nodeDOM.classList.remove("ProseMirror-selectednode"),(this.contentDOM||!this.node.type.spec.draggable)&&this.dom.removeAttribute("draggable"))}get domAtom(){return this.node.isAtom}}function ir(i,e,t,n,s){Qo(n,e,i);let r=new St(void 0,i,e,t,n,n,n,s,0);return r.contentDOM&&r.updateChildren(s,0),r}class ei extends St{constructor(e,t,n,s,r,o,a){super(e,t,n,s,r,null,o,a,0)}parseRule(){let e=this.nodeDOM.parentNode;for(;e&&e!=this.dom&&!e.pmIsDeco;)e=e.parentNode;return{skip:e||!0}}update(e,t,n,s){return this.dirty==it||this.dirty!=Ve&&!this.inParent()||!e.sameMarkup(this.node)?!1:(this.updateOuterDeco(t),(this.dirty!=Ve||e.text!=this.node.text)&&e.text!=this.nodeDOM.nodeValue&&(this.nodeDOM.nodeValue=e.text,s.trackWrites==this.nodeDOM&&(s.trackWrites=null)),this.node=e,this.dirty=Ve,!0)}inParent(){let e=this.parent.contentDOM;for(let t=this.nodeDOM;t;t=t.parentNode)if(t==e)return!0;return!1}domFromPos(e){return{node:this.nodeDOM,offset:e}}localPosFromDOM(e,t,n){return e==this.nodeDOM?this.posAtStart+Math.min(t,this.node.text.length):super.localPosFromDOM(e,t,n)}ignoreMutation(e){return e.type!="characterData"&&e.type!="selection"}slice(e,t,n){let s=this.node.cut(e,t),r=document.createTextNode(s.text);return new ei(this.parent,s,this.outerDeco,this.innerDeco,r,r,n)}markDirty(e,t){super.markDirty(e,t),this.dom!=this.nodeDOM&&(e==0||t==this.nodeDOM.nodeValue.length)&&(this.dirty=it)}get domAtom(){return!1}isText(e){return this.node.text==e}}class Go extends Sn{parseRule(){return{ignore:!0}}matchesHack(e){return this.dirty==Ve&&this.dom.nodeName==e}get domAtom(){return!0}get ignoreForCoords(){return this.dom.nodeName=="IMG"}}class Cu extends St{constructor(e,t,n,s,r,o,a,l,d,u){super(e,t,n,s,r,o,a,d,u),this.spec=l}update(e,t,n,s){if(this.dirty==it)return!1;if(this.spec.update){let r=this.spec.update(e,t,n);return r&&this.updateInner(e,t,n,s),r}else return!this.contentDOM&&!e.isLeaf?!1:super.update(e,t,n,s)}selectNode(){this.spec.selectNode?this.spec.selectNode():super.selectNode()}deselectNode(){this.spec.deselectNode?this.spec.deselectNode():super.deselectNode()}setSelection(e,t,n,s){this.spec.setSelection?this.spec.setSelection(e,t,n):super.setSelection(e,t,n,s)}destroy(){this.spec.destroy&&this.spec.destroy(),super.destroy()}stopEvent(e){return this.spec.stopEvent?this.spec.stopEvent(e):!1}ignoreMutation(e){return this.spec.ignoreMutation?this.spec.ignoreMutation(e):super.ignoreMutation(e)}}function Ko(i,e,t){let n=i.firstChild,s=!1;for(let r=0;r<e.length;r++){let o=e[r],a=o.dom;if(a.parentNode==i){for(;a!=n;)n=sr(n),s=!0;n=n.nextSibling}else s=!0,i.insertBefore(a,n);if(o instanceof Ft){let l=n?n.previousSibling:i.lastChild;Ko(o.contentDOM,o.children,t),n=l?l.nextSibling:i.firstChild}}for(;n;)n=sr(n),s=!0;s&&t.trackWrites==i&&(t.trackWrites=null)}const dn=function(i){i&&(this.nodeName=i)};dn.prototype=Object.create(null);const _t=[new dn];function ji(i,e,t){if(i.length==0)return _t;let n=t?_t[0]:new dn,s=[n];for(let r=0;r<i.length;r++){let o=i[r].type.attrs;if(o){o.nodeName&&s.push(n=new dn(o.nodeName));for(let a in o){let l=o[a];l!=null&&(t&&s.length==1&&s.push(n=new dn(e.isInline?"span":"div")),a=="class"?n.class=(n.class?n.class+" ":"")+l:a=="style"?n.style=(n.style?n.style+";":"")+l:a!="nodeName"&&(n[a]=l))}}}return s}function Yo(i,e,t,n){if(t==_t&&n==_t)return e;let s=e;for(let r=0;r<n.length;r++){let o=n[r],a=t[r];if(r){let l;a&&a.nodeName==o.nodeName&&s!=i&&(l=s.parentNode)&&l.nodeName.toLowerCase()==o.nodeName||(l=document.createElement(o.nodeName),l.pmIsDeco=!0,l.appendChild(s),a=_t[0]),s=l}Tu(s,a||_t[0],o)}return s}function Tu(i,e,t){for(let n in e)n!="class"&&n!="style"&&n!="nodeName"&&!(n in t)&&i.removeAttribute(n);for(let n in t)n!="class"&&n!="style"&&n!="nodeName"&&t[n]!=e[n]&&i.setAttribute(n,t[n]);if(e.class!=t.class){let n=e.class?e.class.split(" ").filter(Boolean):[],s=t.class?t.class.split(" ").filter(Boolean):[];for(let r=0;r<n.length;r++)s.indexOf(n[r])==-1&&i.classList.remove(n[r]);for(let r=0;r<s.length;r++)n.indexOf(s[r])==-1&&i.classList.add(s[r]);i.classList.length==0&&i.removeAttribute("class")}if(e.style!=t.style){if(e.style){let n=/\s*([\w\-\xa1-\uffff]+)\s*:(?:"(?:\\.|[^"])*"|'(?:\\.|[^'])*'|\(.*?\)|[^;])*/g,s;for(;s=n.exec(e.style);)i.style.removeProperty(s[1])}t.style&&(i.style.cssText+=t.style)}}function Qo(i,e,t){return Yo(i,i,_t,ji(e,t,i.nodeType!=1))}function zi(i,e){if(i.length!=e.length)return!1;for(let t=0;t<i.length;t++)if(!i[t].type.eq(e[t].type))return!1;return!0}function sr(i){let e=i.nextSibling;return i.parentNode.removeChild(i),e}class Mu{constructor(e,t,n){this.lock=t,this.view=n,this.index=0,this.stack=[],this.changed=!1,this.top=e,this.preMatch=Eu(e.node.content,e)}destroyBetween(e,t){if(e!=t){for(let n=e;n<t;n++)this.top.children[n].destroy();this.top.children.splice(e,t-e),this.changed=!0}}destroyRest(){this.destroyBetween(this.index,this.top.children.length)}syncToMarks(e,t,n){let s=0,r=this.stack.length>>1,o=Math.min(r,e.length);for(;s<o&&(s==r-1?this.top:this.stack[s+1<<1]).matchesMark(e[s])&&e[s].type.spec.spanning!==!1;)s++;for(;s<r;)this.destroyRest(),this.top.dirty=Ve,this.index=this.stack.pop(),this.top=this.stack.pop(),r--;for(;r<e.length;){this.stack.push(this.top,this.index+1);let a=-1;for(let l=this.index;l<Math.min(this.index+3,this.top.children.length);l++){let d=this.top.children[l];if(d.matchesMark(e[r])&&!this.isLocked(d.dom)){a=l;break}}if(a>-1)a>this.index&&(this.changed=!0,this.destroyBetween(this.index,a)),this.top=this.top.children[this.index];else{let l=Ft.create(this.top,e[r],t,n);this.top.children.splice(this.index,0,l),this.top=l,this.changed=!0}this.index=0,r++}}findNodeMatch(e,t,n,s){let r=-1,o;if(s>=this.preMatch.index&&(o=this.preMatch.matches[s-this.preMatch.index]).parent==this.top&&o.matchesNode(e,t,n))r=this.top.children.indexOf(o,this.index);else for(let a=this.index,l=Math.min(this.top.children.length,a+5);a<l;a++){let d=this.top.children[a];if(d.matchesNode(e,t,n)&&!this.preMatch.matched.has(d)){r=a;break}}return r<0?!1:(this.destroyBetween(this.index,r),this.index++,!0)}updateNodeAt(e,t,n,s,r){let o=this.top.children[s];return o.dirty==it&&o.dom==o.contentDOM&&(o.dirty=Nt),o.update(e,t,n,r)?(this.destroyBetween(this.index,s),this.index++,!0):!1}findIndexWithChild(e){for(;;){let t=e.parentNode;if(!t)return-1;if(t==this.top.contentDOM){let n=e.pmViewDesc;if(n){for(let s=this.index;s<this.top.children.length;s++)if(this.top.children[s]==n)return s}return-1}e=t}}updateNextNode(e,t,n,s,r,o){for(let a=this.index;a<this.top.children.length;a++){let l=this.top.children[a];if(l instanceof St){let d=this.preMatch.matched.get(l);if(d!=null&&d!=r)return!1;let u=l.dom,m,p=this.isLocked(u)&&!(e.isText&&l.node&&l.node.isText&&l.nodeDOM.nodeValue==e.text&&l.dirty!=it&&zi(t,l.outerDeco));if(!p&&l.update(e,t,n,s))return this.destroyBetween(this.index,a),l.dom!=u&&(this.changed=!0),this.index++,!0;if(!p&&(m=this.recreateWrapper(l,e,t,n,s,o)))return this.top.children[this.index]=m,m.contentDOM&&(m.dirty=Nt,m.updateChildren(s,o+1),m.dirty=Ve),this.changed=!0,this.index++,!0;break}}return!1}recreateWrapper(e,t,n,s,r,o){if(e.dirty||t.isAtom||!e.children.length||!e.node.content.eq(t.content))return null;let a=St.create(this.top,t,n,s,r,o);if(a.contentDOM){a.children=e.children,e.children=[];for(let l of a.children)l.parent=a}return e.destroy(),a}addNode(e,t,n,s,r){let o=St.create(this.top,e,t,n,s,r);o.contentDOM&&o.updateChildren(s,r+1),this.top.children.splice(this.index++,0,o),this.changed=!0}placeWidget(e,t,n){let s=this.index<this.top.children.length?this.top.children[this.index]:null;if(s&&s.matchesWidget(e)&&(e==s.widget||!s.widget.type.toDOM.parentNode))this.index++;else{let r=new $o(this.top,e,t,n);this.top.children.splice(this.index++,0,r),this.changed=!0}}addTextblockHacks(){let e=this.top.children[this.index-1],t=this.top;for(;e instanceof Ft;)t=e,e=t.children[t.children.length-1];(!e||!(e instanceof ei)||/\n$/.test(e.node.text)||this.view.requiresGeckoHackNode&&/\s$/.test(e.node.text))&&((Te||ke)&&e&&e.dom.contentEditable=="false"&&this.addHackNode("IMG",t),this.addHackNode("BR",this.top))}addHackNode(e,t){if(t==this.top&&this.index<t.children.length&&t.children[this.index].matchesHack(e))this.index++;else{let n=document.createElement(e);e=="IMG"&&(n.className="ProseMirror-separator",n.alt=""),e=="BR"&&(n.className="ProseMirror-trailingBreak");let s=new Go(this.top,[],n,null);t!=this.top?t.children.push(s):t.children.splice(this.index++,0,s),this.changed=!0}}isLocked(e){return this.lock&&(e==this.lock||e.nodeType==1&&e.contains(this.lock.parentNode))}}function Eu(i,e){let t=e,n=t.children.length,s=i.childCount,r=new Map,o=[];e:for(;s>0;){let a;for(;;)if(n){let d=t.children[n-1];if(d instanceof Ft)t=d,n=d.children.length;else{a=d,n--;break}}else{if(t==e)break e;n=t.parent.children.indexOf(t),t=t.parent}let l=a.node;if(l){if(l!=i.child(s-1))break;--s,r.set(a,s),o.push(a)}}return{index:s,matched:r,matches:o.reverse()}}function Iu(i,e){return i.type.side-e.type.side}function Nu(i,e,t,n){let s=e.locals(i),r=0;if(s.length==0){for(let d=0;d<i.childCount;d++){let u=i.child(d);n(u,s,e.forChild(r,u),d),r+=u.nodeSize}return}let o=0,a=[],l=null;for(let d=0;;){let u,m;for(;o<s.length&&s[o].to==r;){let C=s[o++];C.widget&&(u?(m||(m=[u])).push(C):u=C)}if(u)if(m){m.sort(Iu);for(let C=0;C<m.length;C++)t(m[C],d,!!l)}else t(u,d,!!l);let p,k;if(l)k=-1,p=l,l=null;else if(d<i.childCount)k=d,p=i.child(d++);else break;for(let C=0;C<a.length;C++)a[C].to<=r&&a.splice(C--,1);for(;o<s.length&&s[o].from<=r&&s[o].to>r;)a.push(s[o++]);let y=r+p.nodeSize;if(p.isText){let C=y;o<s.length&&s[o].from<C&&(C=s[o].from);for(let N=0;N<a.length;N++)a[N].to<C&&(C=a[N].to);C<y&&(l=p.cut(C-r),p=p.cut(0,C-r),y=C,k=-1)}else for(;o<s.length&&s[o].to<y;)o++;let w=p.isInline&&!p.isLeaf?a.filter(C=>!C.inline):a.slice();n(p,w,e.forChild(r,p),k),r=y}}function _u(i){if(i.nodeName=="UL"||i.nodeName=="OL"){let e=i.style.cssText;i.style.cssText=e+"; list-style: square !important",window.getComputedStyle(i).listStyle,i.style.cssText=e}}function Ou(i,e,t,n){for(let s=0,r=0;s<i.childCount&&r<=n;){let o=i.child(s++),a=r;if(r+=o.nodeSize,!o.isText)continue;let l=o.text;for(;s<i.childCount;){let d=i.child(s++);if(r+=d.nodeSize,!d.isText)break;l+=d.text}if(r>=t){if(r>=n&&l.slice(n-e.length-a,n-a)==e)return n-e.length;let d=a<n?l.lastIndexOf(e,n-a-1):-1;if(d>=0&&d+e.length+a>=t)return a+d;if(t==n&&l.length>=n+e.length-a&&l.slice(n-a,n-a+e.length)==e)return n}}return-1}function Vi(i,e,t,n,s){let r=[];for(let o=0,a=0;o<i.length;o++){let l=i[o],d=a,u=a+=l.size;d>=t||u<=e?r.push(l):(d<e&&r.push(l.slice(0,e-d,n)),s&&(r.push(s),s=void 0),u>t&&r.push(l.slice(t-d,l.size,n)))}return r}function as(i,e=null){let t=i.domSelectionRange(),n=i.state.doc;if(!t.focusNode)return null;let s=i.docView.nearestDesc(t.focusNode),r=s&&s.size==0,o=i.docView.posFromDOM(t.focusNode,t.focusOffset,1);if(o<0)return null;let a=n.resolve(o),l,d;if(Xn(t)){for(l=a;s&&!s.node;)s=s.parent;let u=s.node;if(s&&u.isAtom&&q.isSelectable(u)&&s.parent&&!(u.isInline&&nu(t.focusNode,t.focusOffset,s.dom))){let m=s.posBefore;d=new q(o==m?a:n.resolve(m))}}else{let u=i.docView.posFromDOM(t.anchorNode,t.anchorOffset,1);if(u<0)return null;l=n.resolve(u)}if(!d){let u=e=="pointer"||i.state.selection.head<a.pos&&!r?1:-1;d=ls(i,l,a,u)}return d}function Zo(i){return i.editable?i.hasFocus():ea(i)&&document.activeElement&&document.activeElement.contains(i.dom)}function dt(i,e=!1){let t=i.state.selection;if(Xo(i,t),!!Zo(i)){if(!e&&i.input.mouseDown&&i.input.mouseDown.allowDefault&&ke){let n=i.domSelectionRange(),s=i.domObserver.currentSelection;if(n.anchorNode&&s.anchorNode&&Bt(n.anchorNode,n.anchorOffset,s.anchorNode,s.anchorOffset)){i.input.mouseDown.delayedSelectionSync=!0,i.domObserver.setCurSelection();return}}if(i.domObserver.disconnectSelection(),i.cursorWrapper)Ru(i);else{let{anchor:n,head:s}=t,r,o;rr&&!(t instanceof X)&&(t.$from.parent.inlineContent||(r=or(i,t.from)),!t.empty&&!t.$from.parent.inlineContent&&(o=or(i,t.to))),i.docView.setSelection(n,s,i.root,e),rr&&(r&&ar(r),o&&ar(o)),t.visible?i.dom.classList.remove("ProseMirror-hideselection"):(i.dom.classList.add("ProseMirror-hideselection"),"onselectionchange"in document&&Du(i))}i.domObserver.setCurSelection(),i.domObserver.connectSelection()}}const rr=Te||ke&&zo<63;function or(i,e){let{node:t,offset:n}=i.docView.domFromPos(e,0),s=n<t.childNodes.length?t.childNodes[n]:null,r=n?t.childNodes[n-1]:null;if(Te&&s&&s.contentEditable=="false")return xi(s);if((!s||s.contentEditable=="false")&&(!r||r.contentEditable=="false")){if(s)return xi(s);if(r)return xi(r)}}function xi(i){return i.contentEditable="true",Te&&i.draggable&&(i.draggable=!1,i.wasDraggable=!0),i}function ar(i){i.contentEditable="false",i.wasDraggable&&(i.draggable=!0,i.wasDraggable=null)}function Du(i){let e=i.dom.ownerDocument;e.removeEventListener("selectionchange",i.input.hideSelectionGuard);let t=i.domSelectionRange(),n=t.anchorNode,s=t.anchorOffset;e.addEventListener("selectionchange",i.input.hideSelectionGuard=()=>{(t.anchorNode!=n||t.anchorOffset!=s)&&(e.removeEventListener("selectionchange",i.input.hideSelectionGuard),setTimeout(()=>{(!Zo(i)||i.state.selection.visible)&&i.dom.classList.remove("ProseMirror-hideselection")},20))})}function Ru(i){let e=i.domSelection(),t=document.createRange(),n=i.cursorWrapper.dom,s=n.nodeName=="IMG";s?t.setEnd(n.parentNode,he(n)+1):t.setEnd(n,0),t.collapse(!1),e.removeAllRanges(),e.addRange(t),!s&&!i.state.selection.visible&&Oe&&wt<=11&&(n.disabled=!0,n.disabled=!1)}function Xo(i,e){if(e instanceof q){let t=i.docView.descAt(e.from);t!=i.lastSelectedViewDesc&&(lr(i),t&&t.selectNode(),i.lastSelectedViewDesc=t)}else lr(i)}function lr(i){i.lastSelectedViewDesc&&(i.lastSelectedViewDesc.parent&&i.lastSelectedViewDesc.deselectNode(),i.lastSelectedViewDesc=void 0)}function ls(i,e,t,n){return i.someProp("createSelectionBetween",s=>s(i,e,t))||X.between(e,t,n)}function cr(i){return i.editable&&!i.hasFocus()?!1:ea(i)}function ea(i){let e=i.domSelectionRange();if(!e.anchorNode)return!1;try{return i.dom.contains(e.anchorNode.nodeType==3?e.anchorNode.parentNode:e.anchorNode)&&(i.editable||i.dom.contains(e.focusNode.nodeType==3?e.focusNode.parentNode:e.focusNode))}catch{return!1}}function Au(i){let e=i.docView.domFromPos(i.state.selection.anchor,0),t=i.domSelectionRange();return Bt(e.node,e.offset,t.anchorNode,t.anchorOffset)}function Ui(i,e){let{$anchor:t,$head:n}=i.selection,s=e>0?t.max(n):t.min(n),r=s.parent.inlineContent?s.depth?i.doc.resolve(e>0?s.after():s.before()):null:s;return r&&Y.findFrom(r,e)}function mt(i,e){return i.dispatch(i.state.tr.setSelection(e).scrollIntoView()),!0}function dr(i,e,t){let n=i.state.selection;if(n instanceof X)if(t.indexOf("s")>-1){let{$head:s}=n,r=s.textOffset?null:e<0?s.nodeBefore:s.nodeAfter;if(!r||r.isText||!r.isLeaf)return!1;let o=i.state.doc.resolve(s.pos+r.nodeSize*(e<0?-1:1));return mt(i,new X(n.$anchor,o))}else if(n.empty){if(i.endOfTextblock(e>0?"forward":"backward")){let s=Ui(i.state,e);return s&&s instanceof q?mt(i,s):!1}else if(!(Le&&t.indexOf("m")>-1)){let s=n.$head,r=s.textOffset?null:e<0?s.nodeBefore:s.nodeAfter,o;if(!r||r.isText)return!1;let a=e<0?s.pos-r.nodeSize:s.pos;return r.isAtom||(o=i.docView.descAt(a))&&!o.contentDOM?q.isSelectable(r)?mt(i,new q(e<0?i.state.doc.resolve(s.pos-r.nodeSize):s)):wn?mt(i,new X(i.state.doc.resolve(e<0?a:a+r.nodeSize))):!1:!1}}else return!1;else{if(n instanceof q&&n.node.isInline)return mt(i,new X(e>0?n.$to:n.$from));{let s=Ui(i.state,e);return s?mt(i,s):!1}}}function Wn(i){return i.nodeType==3?i.nodeValue.length:i.childNodes.length}function hn(i,e){let t=i.pmViewDesc;return t&&t.size==0&&(e<0||i.nextSibling||i.nodeName!="BR")}function jt(i,e){return e<0?vu(i):Bu(i)}function vu(i){let e=i.domSelectionRange(),t=e.focusNode,n=e.focusOffset;if(!t)return;let s,r,o=!1;for(Ke&&t.nodeType==1&&n<Wn(t)&&hn(t.childNodes[n],-1)&&(o=!0);;)if(n>0){if(t.nodeType!=1)break;{let a=t.childNodes[n-1];if(hn(a,-1))s=t,r=--n;else if(a.nodeType==3)t=a,n=t.nodeValue.length;else break}}else{if(ta(t))break;{let a=t.previousSibling;for(;a&&hn(a,-1);)s=t.parentNode,r=he(a),a=a.previousSibling;if(a)t=a,n=Wn(t);else{if(t=t.parentNode,t==i.dom)break;n=0}}}o?qi(i,t,n):s&&qi(i,s,r)}function Bu(i){let e=i.domSelectionRange(),t=e.focusNode,n=e.focusOffset;if(!t)return;let s=Wn(t),r,o;for(;;)if(n<s){if(t.nodeType!=1)break;let a=t.childNodes[n];if(hn(a,1))r=t,o=++n;else break}else{if(ta(t))break;{let a=t.nextSibling;for(;a&&hn(a,1);)r=a.parentNode,o=he(a)+1,a=a.nextSibling;if(a)t=a,n=0,s=Wn(t);else{if(t=t.parentNode,t==i.dom)break;n=s=0}}}r&&qi(i,r,o)}function ta(i){let e=i.pmViewDesc;return e&&e.node&&e.node.isBlock}function Fu(i,e){for(;i&&e==i.childNodes.length&&!bn(i);)e=he(i)+1,i=i.parentNode;for(;i&&e<i.childNodes.length;){let t=i.childNodes[e];if(t.nodeType==3)return t;if(t.nodeType==1&&t.contentEditable=="false")break;i=t,e=0}}function Pu(i,e){for(;i&&!e&&!bn(i);)e=he(i),i=i.parentNode;for(;i&&e;){let t=i.childNodes[e-1];if(t.nodeType==3)return t;if(t.nodeType==1&&t.contentEditable=="false")break;i=t,e=i.childNodes.length}}function qi(i,e,t){if(e.nodeType!=3){let r,o;(o=Fu(e,t))?(e=o,t=0):(r=Pu(e,t))&&(e=r,t=r.nodeValue.length)}let n=i.domSelection();if(Xn(n)){let r=document.createRange();r.setEnd(e,t),r.setStart(e,t),n.removeAllRanges(),n.addRange(r)}else n.extend&&n.extend(e,t);i.domObserver.setCurSelection();let{state:s}=i;setTimeout(()=>{i.state==s&&dt(i)},50)}function hr(i,e){let t=i.state.doc.resolve(e);if(!(ke||ru)&&t.parent.inlineContent){let s=i.coordsAtPos(e);if(e>t.start()){let r=i.coordsAtPos(e-1),o=(r.top+r.bottom)/2;if(o>s.top&&o<s.bottom&&Math.abs(r.left-s.left)>1)return r.left<s.left?"ltr":"rtl"}if(e<t.end()){let r=i.coordsAtPos(e+1),o=(r.top+r.bottom)/2;if(o>s.top&&o<s.bottom&&Math.abs(r.left-s.left)>1)return r.left>s.left?"ltr":"rtl"}}return getComputedStyle(i.dom).direction=="rtl"?"rtl":"ltr"}function ur(i,e,t){let n=i.state.selection;if(n instanceof X&&!n.empty||t.indexOf("s")>-1||Le&&t.indexOf("m")>-1)return!1;let{$from:s,$to:r}=n;if(!s.parent.inlineContent||i.endOfTextblock(e<0?"up":"down")){let o=Ui(i.state,e);if(o&&o instanceof q)return mt(i,o)}if(!s.parent.inlineContent){let o=e<0?s:r,a=n instanceof tt?Y.near(o,e):Y.findFrom(o,e);return a?mt(i,a):!1}return!1}function fr(i,e){if(!(i.state.selection instanceof X))return!0;let{$head:t,$anchor:n,empty:s}=i.state.selection;if(!t.sameParent(n))return!0;if(!s)return!1;if(i.endOfTextblock(e>0?"forward":"backward"))return!0;let r=!t.textOffset&&(e<0?t.nodeBefore:t.nodeAfter);if(r&&!r.isText){let o=i.state.tr;return e<0?o.delete(t.pos-r.nodeSize,t.pos):o.delete(t.pos,t.pos+r.nodeSize),i.dispatch(o),!0}return!1}function pr(i,e,t){i.domObserver.stop(),e.contentEditable=t,i.domObserver.start()}function Lu(i){if(!Te||i.state.selection.$head.parentOffset>0)return!1;let{focusNode:e,focusOffset:t}=i.domSelectionRange();if(e&&e.nodeType==1&&t==0&&e.firstChild&&e.firstChild.contentEditable=="false"){let n=e.firstChild;pr(i,n,"true"),setTimeout(()=>pr(i,n,"false"),20)}return!1}function ju(i){let e="";return i.ctrlKey&&(e+="c"),i.metaKey&&(e+="m"),i.altKey&&(e+="a"),i.shiftKey&&(e+="s"),e}function zu(i,e){let t=e.keyCode,n=ju(e);if(t==8||Le&&t==72&&n=="c")return fr(i,-1)||jt(i,-1);if(t==46&&!e.shiftKey||Le&&t==68&&n=="c")return fr(i,1)||jt(i,1);if(t==13||t==27)return!0;if(t==37||Le&&t==66&&n=="c"){let s=t==37?hr(i,i.state.selection.from)=="ltr"?-1:1:-1;return dr(i,s,n)||jt(i,s)}else if(t==39||Le&&t==70&&n=="c"){let s=t==39?hr(i,i.state.selection.from)=="ltr"?1:-1:1;return dr(i,s,n)||jt(i,s)}else{if(t==38||Le&&t==80&&n=="c")return ur(i,-1,n)||jt(i,-1);if(t==40||Le&&t==78&&n=="c")return Lu(i)||ur(i,1,n)||jt(i,1);if(n==(Le?"m":"c")&&(t==66||t==73||t==89||t==90))return!0}return!1}function na(i,e){i.someProp("transformCopied",k=>{e=k(e,i)});let t=[],{content:n,openStart:s,openEnd:r}=e;for(;s>1&&r>1&&n.childCount==1&&n.firstChild.childCount==1;){s--,r--;let k=n.firstChild;t.push(k.type.name,k.attrs!=k.type.defaultAttrs?k.attrs:null),n=k.content}let o=i.someProp("clipboardSerializer")||Qt.fromSchema(i.state.schema),a=la(),l=a.createElement("div");l.appendChild(o.serializeFragment(n,{document:a}));let d=l.firstChild,u,m=0;for(;d&&d.nodeType==1&&(u=aa[d.nodeName.toLowerCase()]);){for(let k=u.length-1;k>=0;k--){let y=a.createElement(u[k]);for(;l.firstChild;)y.appendChild(l.firstChild);l.appendChild(y),m++}d=l.firstChild}d&&d.nodeType==1&&d.setAttribute("data-pm-slice",`${s} ${r}${m?` -${m}`:""} ${JSON.stringify(t)}`);let p=i.someProp("clipboardTextSerializer",k=>k(e,i))||e.content.textBetween(0,e.content.size,`

`);return{dom:l,text:p,slice:e}}function ia(i,e,t,n,s){let r=s.parent.type.spec.code,o,a;if(!t&&!e)return null;let l=e&&(n||r||!t);if(l){if(i.someProp("transformPastedText",p=>{e=p(e,r||n,i)}),r)return e?new v(_.from(i.state.schema.text(e.replace(/\r\n?/g,`
`))),0,0):v.empty;let m=i.someProp("clipboardTextParser",p=>p(e,s,n,i));if(m)a=m;else{let p=s.marks(),{schema:k}=i.state,y=Qt.fromSchema(k);o=document.createElement("div"),e.split(/(?:\r\n?|\n)+/).forEach(w=>{let C=o.appendChild(document.createElement("p"));w&&C.appendChild(y.serializeNode(k.text(w,p)))})}}else i.someProp("transformPastedHTML",m=>{t=m(t,i)}),o=qu(t),wn&&Wu(o);let d=o&&o.querySelector("[data-pm-slice]"),u=d&&/^(\d+) (\d+)(?: -(\d+))? (.*)/.exec(d.getAttribute("data-pm-slice")||"");if(u&&u[3])for(let m=+u[3];m>0;m--){let p=o.firstChild;for(;p&&p.nodeType!=1;)p=p.nextSibling;if(!p)break;o=p}if(a||(a=(i.someProp("clipboardParser")||i.someProp("domParser")||fn.fromSchema(i.state.schema)).parseSlice(o,{preserveWhitespace:!!(l||u),context:s,ruleFromNode(p){return p.nodeName=="BR"&&!p.nextSibling&&p.parentNode&&!Vu.test(p.parentNode.nodeName)?{ignore:!0}:null}})),u)a=Hu(mr(a,+u[1],+u[2]),u[4]);else if(a=v.maxOpen(Uu(a.content,s),!0),a.openStart||a.openEnd){let m=0,p=0;for(let k=a.content.firstChild;m<a.openStart&&!k.type.spec.isolating;m++,k=k.firstChild);for(let k=a.content.lastChild;p<a.openEnd&&!k.type.spec.isolating;p++,k=k.lastChild);a=mr(a,m,p)}return i.someProp("transformPasted",m=>{a=m(a,i)}),a}const Vu=/^(a|abbr|acronym|b|cite|code|del|em|i|ins|kbd|label|output|q|ruby|s|samp|span|strong|sub|sup|time|u|tt|var)$/i;function Uu(i,e){if(i.childCount<2)return i;for(let t=e.depth;t>=0;t--){let s=e.node(t).contentMatchAt(e.index(t)),r,o=[];if(i.forEach(a=>{if(!o)return;let l=s.findWrapping(a.type),d;if(!l)return o=null;if(d=o.length&&r.length&&ra(l,r,a,o[o.length-1],0))o[o.length-1]=d;else{o.length&&(o[o.length-1]=oa(o[o.length-1],r.length));let u=sa(a,l);o.push(u),s=s.matchType(u.type),r=l}}),o)return _.from(o)}return i}function sa(i,e,t=0){for(let n=e.length-1;n>=t;n--)i=e[n].create(null,_.from(i));return i}function ra(i,e,t,n,s){if(s<i.length&&s<e.length&&i[s]==e[s]){let r=ra(i,e,t,n.lastChild,s+1);if(r)return n.copy(n.content.replaceChild(n.childCount-1,r));if(n.contentMatchAt(n.childCount).matchType(s==i.length-1?t.type:i[s+1]))return n.copy(n.content.append(_.from(sa(t,i,s+1))))}}function oa(i,e){if(e==0)return i;let t=i.content.replaceChild(i.childCount-1,oa(i.lastChild,e-1)),n=i.contentMatchAt(i.childCount).fillBefore(_.empty,!0);return i.copy(t.append(n))}function Wi(i,e,t,n,s,r){let o=e<0?i.firstChild:i.lastChild,a=o.content;return i.childCount>1&&(r=0),s<n-1&&(a=Wi(a,e,t,n,s+1,r)),s>=t&&(a=e<0?o.contentMatchAt(0).fillBefore(a,r<=s).append(a):a.append(o.contentMatchAt(o.childCount).fillBefore(_.empty,!0))),i.replaceChild(e<0?0:i.childCount-1,o.copy(a))}function mr(i,e,t){return e<i.openStart&&(i=new v(Wi(i.content,-1,e,i.openStart,0,i.openEnd),e,i.openEnd)),t<i.openEnd&&(i=new v(Wi(i.content,1,t,i.openEnd,0,0),i.openStart,t)),i}const aa={thead:["table"],tbody:["table"],tfoot:["table"],caption:["table"],colgroup:["table"],col:["table","colgroup"],tr:["table","tbody"],td:["table","tbody","tr"],th:["table","tbody","tr"]};let gr=null;function la(){return gr||(gr=document.implementation.createHTMLDocument("title"))}function qu(i){let e=/^(\s*<meta [^>]*>)*/.exec(i);e&&(i=i.slice(e[0].length));let t=la().createElement("div"),n=/<([a-z][^>\s]+)/i.exec(i),s;if((s=n&&aa[n[1].toLowerCase()])&&(i=s.map(r=>"<"+r+">").join("")+i+s.map(r=>"</"+r+">").reverse().join("")),t.innerHTML=i,s)for(let r=0;r<s.length;r++)t=t.querySelector(s[r])||t;return t}function Wu(i){let e=i.querySelectorAll(ke?"span:not([class]):not([style])":"span.Apple-converted-space");for(let t=0;t<e.length;t++){let n=e[t];n.childNodes.length==1&&n.textContent==""&&n.parentNode&&n.parentNode.replaceChild(i.ownerDocument.createTextNode(" "),n)}}function Hu(i,e){if(!i.size)return i;let t=i.content.firstChild.type.schema,n;try{n=JSON.parse(e)}catch{return i}let{content:s,openStart:r,openEnd:o}=i;for(let a=n.length-2;a>=0;a-=2){let l=t.nodes[n[a]];if(!l||l.hasRequiredAttrs())break;s=_.from(l.create(n[a+1],s)),r++,o++}return new v(s,r,o)}const Me={},Ee={},Ju={touchstart:!0,touchmove:!0};class $u{constructor(){this.shiftKey=!1,this.mouseDown=null,this.lastKeyCode=null,this.lastKeyCodeTime=0,this.lastClick={time:0,x:0,y:0,type:""},this.lastSelectionOrigin=null,this.lastSelectionTime=0,this.lastIOSEnter=0,this.lastIOSEnterFallbackTimeout=-1,this.lastFocus=0,this.lastTouch=0,this.lastAndroidDelete=0,this.composing=!1,this.compositionNode=null,this.composingTimeout=-1,this.compositionNodes=[],this.compositionEndedAt=-2e8,this.compositionID=1,this.compositionPendingChanges=0,this.domChangeCount=0,this.eventHandlers=Object.create(null),this.hideSelectionGuard=null}}function Gu(i){for(let e in Me){let t=Me[e];i.dom.addEventListener(e,i.input.eventHandlers[e]=n=>{Yu(i,n)&&!cs(i,n)&&(i.editable||!(n.type in Ee))&&t(i,n)},Ju[e]?{passive:!0}:void 0)}Te&&i.dom.addEventListener("input",()=>null),Hi(i)}function kt(i,e){i.input.lastSelectionOrigin=e,i.input.lastSelectionTime=Date.now()}function Ku(i){i.domObserver.stop();for(let e in i.input.eventHandlers)i.dom.removeEventListener(e,i.input.eventHandlers[e]);clearTimeout(i.input.composingTimeout),clearTimeout(i.input.lastIOSEnterFallbackTimeout)}function Hi(i){i.someProp("handleDOMEvents",e=>{for(let t in e)i.input.eventHandlers[t]||i.dom.addEventListener(t,i.input.eventHandlers[t]=n=>cs(i,n))})}function cs(i,e){return i.someProp("handleDOMEvents",t=>{let n=t[e.type];return n?n(i,e)||e.defaultPrevented:!1})}function Yu(i,e){if(!e.bubbles)return!0;if(e.defaultPrevented)return!1;for(let t=e.target;t!=i.dom;t=t.parentNode)if(!t||t.nodeType==11||t.pmViewDesc&&t.pmViewDesc.stopEvent(e))return!1;return!0}function Qu(i,e){!cs(i,e)&&Me[e.type]&&(i.editable||!(e.type in Ee))&&Me[e.type](i,e)}Ee.keydown=(i,e)=>{let t=e;if(i.input.shiftKey=t.keyCode==16||t.shiftKey,!da(i,t)&&(i.input.lastKeyCode=t.keyCode,i.input.lastKeyCodeTime=Date.now(),!(We&&ke&&t.keyCode==13)))if(t.keyCode!=229&&i.domObserver.forceFlush(),Yt&&t.keyCode==13&&!t.ctrlKey&&!t.altKey&&!t.metaKey){let n=Date.now();i.input.lastIOSEnter=n,i.input.lastIOSEnterFallbackTimeout=setTimeout(()=>{i.input.lastIOSEnter==n&&(i.someProp("handleKeyDown",s=>s(i,It(13,"Enter"))),i.input.lastIOSEnter=0)},200)}else i.someProp("handleKeyDown",n=>n(i,t))||zu(i,t)?t.preventDefault():kt(i,"key")};Ee.keyup=(i,e)=>{e.keyCode==16&&(i.input.shiftKey=!1)};Ee.keypress=(i,e)=>{let t=e;if(da(i,t)||!t.charCode||t.ctrlKey&&!t.altKey||Le&&t.metaKey)return;if(i.someProp("handleKeyPress",s=>s(i,t))){t.preventDefault();return}let n=i.state.selection;if(!(n instanceof X)||!n.$from.sameParent(n.$to)){let s=String.fromCharCode(t.charCode);!/[\r\n]/.test(s)&&!i.someProp("handleTextInput",r=>r(i,n.$from.pos,n.$to.pos,s))&&i.dispatch(i.state.tr.insertText(s).scrollIntoView()),t.preventDefault()}};function ti(i){return{left:i.clientX,top:i.clientY}}function Zu(i,e){let t=e.x-i.clientX,n=e.y-i.clientY;return t*t+n*n<100}function ds(i,e,t,n,s){if(n==-1)return!1;let r=i.state.doc.resolve(n);for(let o=r.depth+1;o>0;o--)if(i.someProp(e,a=>o>r.depth?a(i,t,r.nodeAfter,r.before(o),s,!0):a(i,t,r.node(o),r.before(o),s,!1)))return!0;return!1}function Ht(i,e,t){i.focused||i.focus();let n=i.state.tr.setSelection(e);n.setMeta("pointer",!0),i.dispatch(n)}function Xu(i,e){if(e==-1)return!1;let t=i.state.doc.resolve(e),n=t.nodeAfter;return n&&n.isAtom&&q.isSelectable(n)?(Ht(i,new q(t)),!0):!1}function ef(i,e){if(e==-1)return!1;let t=i.state.selection,n,s;t instanceof q&&(n=t.node);let r=i.state.doc.resolve(e);for(let o=r.depth+1;o>0;o--){let a=o>r.depth?r.nodeAfter:r.node(o);if(q.isSelectable(a)){n&&t.$from.depth>0&&o>=t.$from.depth&&r.before(t.$from.depth+1)==t.$from.pos?s=r.before(t.$from.depth):s=r.before(o);break}}return s!=null?(Ht(i,q.create(i.state.doc,s)),!0):!1}function tf(i,e,t,n,s){return ds(i,"handleClickOn",e,t,n)||i.someProp("handleClick",r=>r(i,e,n))||(s?ef(i,t):Xu(i,t))}function nf(i,e,t,n){return ds(i,"handleDoubleClickOn",e,t,n)||i.someProp("handleDoubleClick",s=>s(i,e,n))}function sf(i,e,t,n){return ds(i,"handleTripleClickOn",e,t,n)||i.someProp("handleTripleClick",s=>s(i,e,n))||rf(i,t,n)}function rf(i,e,t){if(t.button!=0)return!1;let n=i.state.doc;if(e==-1)return n.inlineContent?(Ht(i,X.create(n,0,n.content.size)),!0):!1;let s=n.resolve(e);for(let r=s.depth+1;r>0;r--){let o=r>s.depth?s.nodeAfter:s.node(r),a=s.before(r);if(o.inlineContent)Ht(i,X.create(n,a+1,a+1+o.content.size));else if(q.isSelectable(o))Ht(i,q.create(n,a));else continue;return!0}}function hs(i){return Hn(i)}const ca=Le?"metaKey":"ctrlKey";Me.mousedown=(i,e)=>{let t=e;i.input.shiftKey=t.shiftKey;let n=hs(i),s=Date.now(),r="singleClick";s-i.input.lastClick.time<500&&Zu(t,i.input.lastClick)&&!t[ca]&&(i.input.lastClick.type=="singleClick"?r="doubleClick":i.input.lastClick.type=="doubleClick"&&(r="tripleClick")),i.input.lastClick={time:s,x:t.clientX,y:t.clientY,type:r};let o=i.posAtCoords(ti(t));o&&(r=="singleClick"?(i.input.mouseDown&&i.input.mouseDown.done(),i.input.mouseDown=new of(i,o,t,!!n)):(r=="doubleClick"?nf:sf)(i,o.pos,o.inside,t)?t.preventDefault():kt(i,"pointer"))};class of{constructor(e,t,n,s){this.view=e,this.pos=t,this.event=n,this.flushed=s,this.delayedSelectionSync=!1,this.mightDrag=null,this.startDoc=e.state.doc,this.selectNode=!!n[ca],this.allowDefault=n.shiftKey;let r,o;if(t.inside>-1)r=e.state.doc.nodeAt(t.inside),o=t.inside;else{let u=e.state.doc.resolve(t.pos);r=u.parent,o=u.depth?u.before():0}const a=s?null:n.target,l=a?e.docView.nearestDesc(a,!0):null;this.target=l&&l.dom.nodeType==1?l.dom:null;let{selection:d}=e.state;(n.button==0&&r.type.spec.draggable&&r.type.spec.selectable!==!1||d instanceof q&&d.from<=o&&d.to>o)&&(this.mightDrag={node:r,pos:o,addAttr:!!(this.target&&!this.target.draggable),setUneditable:!!(this.target&&Ke&&!this.target.hasAttribute("contentEditable"))}),this.target&&this.mightDrag&&(this.mightDrag.addAttr||this.mightDrag.setUneditable)&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&(this.target.draggable=!0),this.mightDrag.setUneditable&&setTimeout(()=>{this.view.input.mouseDown==this&&this.target.setAttribute("contentEditable","false")},20),this.view.domObserver.start()),e.root.addEventListener("mouseup",this.up=this.up.bind(this)),e.root.addEventListener("mousemove",this.move=this.move.bind(this)),kt(e,"pointer")}done(){this.view.root.removeEventListener("mouseup",this.up),this.view.root.removeEventListener("mousemove",this.move),this.mightDrag&&this.target&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&this.target.removeAttribute("draggable"),this.mightDrag.setUneditable&&this.target.removeAttribute("contentEditable"),this.view.domObserver.start()),this.delayedSelectionSync&&setTimeout(()=>dt(this.view)),this.view.input.mouseDown=null}up(e){if(this.done(),!this.view.dom.contains(e.target))return;let t=this.pos;this.view.state.doc!=this.startDoc&&(t=this.view.posAtCoords(ti(e))),this.updateAllowDefault(e),this.allowDefault||!t?kt(this.view,"pointer"):tf(this.view,t.pos,t.inside,e,this.selectNode)?e.preventDefault():e.button==0&&(this.flushed||Te&&this.mightDrag&&!this.mightDrag.node.isAtom||ke&&!this.view.state.selection.visible&&Math.min(Math.abs(t.pos-this.view.state.selection.from),Math.abs(t.pos-this.view.state.selection.to))<=2)?(Ht(this.view,Y.near(this.view.state.doc.resolve(t.pos))),e.preventDefault()):kt(this.view,"pointer")}move(e){this.updateAllowDefault(e),kt(this.view,"pointer"),e.buttons==0&&this.done()}updateAllowDefault(e){!this.allowDefault&&(Math.abs(this.event.x-e.clientX)>4||Math.abs(this.event.y-e.clientY)>4)&&(this.allowDefault=!0)}}Me.touchstart=i=>{i.input.lastTouch=Date.now(),hs(i),kt(i,"pointer")};Me.touchmove=i=>{i.input.lastTouch=Date.now(),kt(i,"pointer")};Me.contextmenu=i=>hs(i);function da(i,e){return i.composing?!0:Te&&Math.abs(e.timeStamp-i.input.compositionEndedAt)<500?(i.input.compositionEndedAt=-2e8,!0):!1}const af=We?5e3:-1;Ee.compositionstart=Ee.compositionupdate=i=>{if(!i.composing){i.domObserver.flush();let{state:e}=i,t=e.selection.$from;if(e.selection.empty&&(e.storedMarks||!t.textOffset&&t.parentOffset&&t.nodeBefore.marks.some(n=>n.type.spec.inclusive===!1)))i.markCursor=i.state.storedMarks||t.marks(),Hn(i,!0),i.markCursor=null;else if(Hn(i),Ke&&e.selection.empty&&t.parentOffset&&!t.textOffset&&t.nodeBefore.marks.length){let n=i.domSelectionRange();for(let s=n.focusNode,r=n.focusOffset;s&&s.nodeType==1&&r!=0;){let o=r<0?s.lastChild:s.childNodes[r-1];if(!o)break;if(o.nodeType==3){i.domSelection().collapse(o,o.nodeValue.length);break}else s=o,r=-1}}i.input.composing=!0}ha(i,af)};Ee.compositionend=(i,e)=>{i.composing&&(i.input.composing=!1,i.input.compositionEndedAt=e.timeStamp,i.input.compositionPendingChanges=i.domObserver.pendingRecords().length?i.input.compositionID:0,i.input.compositionNode=null,i.input.compositionPendingChanges&&Promise.resolve().then(()=>i.domObserver.flush()),i.input.compositionID++,ha(i,20))};function ha(i,e){clearTimeout(i.input.composingTimeout),e>-1&&(i.input.composingTimeout=setTimeout(()=>Hn(i),e))}function ua(i){for(i.composing&&(i.input.composing=!1,i.input.compositionEndedAt=cf());i.input.compositionNodes.length>0;)i.input.compositionNodes.pop().markParentsDirty()}function lf(i){let e=i.domSelectionRange();if(!e.focusNode)return null;let t=eu(e.focusNode,e.focusOffset),n=tu(e.focusNode,e.focusOffset);if(t&&n&&t!=n){let s=n.pmViewDesc,r=i.domObserver.lastChangedTextNode;if(t==r||n==r)return r;if(!s||!s.isText(n.nodeValue))return n;if(i.input.compositionNode==n){let o=t.pmViewDesc;if(!(!o||!o.isText(t.nodeValue)))return n}}return t||n}function cf(){let i=document.createEvent("Event");return i.initEvent("event",!0,!0),i.timeStamp}function Hn(i,e=!1){if(!(We&&i.domObserver.flushingSoon>=0)){if(i.domObserver.forceFlush(),ua(i),e||i.docView&&i.docView.dirty){let t=as(i);return t&&!t.eq(i.state.selection)?i.dispatch(i.state.tr.setSelection(t)):i.updateState(i.state),!0}return!1}}function df(i,e){if(!i.dom.parentNode)return;let t=i.dom.parentNode.appendChild(document.createElement("div"));t.appendChild(e),t.style.cssText="position: fixed; left: -10000px; top: 10px";let n=getSelection(),s=document.createRange();s.selectNodeContents(e),i.dom.blur(),n.removeAllRanges(),n.addRange(s),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t),i.focus()},50)}const gn=Oe&&wt<15||Yt&&ou<604;Me.copy=Ee.cut=(i,e)=>{let t=e,n=i.state.selection,s=t.type=="cut";if(n.empty)return;let r=gn?null:t.clipboardData,o=n.content(),{dom:a,text:l}=na(i,o);r?(t.preventDefault(),r.clearData(),r.setData("text/html",a.innerHTML),r.setData("text/plain",l)):df(i,a),s&&i.dispatch(i.state.tr.deleteSelection().scrollIntoView().setMeta("uiEvent","cut"))};function hf(i){return i.openStart==0&&i.openEnd==0&&i.content.childCount==1?i.content.firstChild:null}function uf(i,e){if(!i.dom.parentNode)return;let t=i.input.shiftKey||i.state.selection.$from.parent.type.spec.code,n=i.dom.parentNode.appendChild(document.createElement(t?"textarea":"div"));t||(n.contentEditable="true"),n.style.cssText="position: fixed; left: -10000px; top: 10px",n.focus();let s=i.input.shiftKey&&i.input.lastKeyCode!=45;setTimeout(()=>{i.focus(),n.parentNode&&n.parentNode.removeChild(n),t?yn(i,n.value,null,s,e):yn(i,n.textContent,n.innerHTML,s,e)},50)}function yn(i,e,t,n,s){let r=ia(i,e,t,n,i.state.selection.$from);if(i.someProp("handlePaste",l=>l(i,s,r||v.empty)))return!0;if(!r)return!1;let o=hf(r),a=o?i.state.tr.replaceSelectionWith(o,n):i.state.tr.replaceSelection(r);return i.dispatch(a.scrollIntoView().setMeta("paste",!0).setMeta("uiEvent","paste")),!0}function fa(i){let e=i.getData("text/plain")||i.getData("Text");if(e)return e;let t=i.getData("text/uri-list");return t?t.replace(/\r?\n/g," "):""}Ee.paste=(i,e)=>{let t=e;if(i.composing&&!We)return;let n=gn?null:t.clipboardData,s=i.input.shiftKey&&i.input.lastKeyCode!=45;n&&yn(i,fa(n),n.getData("text/html"),s,t)?t.preventDefault():uf(i,t)};class pa{constructor(e,t,n){this.slice=e,this.move=t,this.node=n}}const ma=Le?"altKey":"ctrlKey";Me.dragstart=(i,e)=>{let t=e,n=i.input.mouseDown;if(n&&n.done(),!t.dataTransfer)return;let s=i.state.selection,r=s.empty?null:i.posAtCoords(ti(t)),o;if(!(r&&r.pos>=s.from&&r.pos<=(s instanceof q?s.to-1:s.to))){if(n&&n.mightDrag)o=q.create(i.state.doc,n.mightDrag.pos);else if(t.target&&t.target.nodeType==1){let m=i.docView.nearestDesc(t.target,!0);m&&m.node.type.spec.draggable&&m!=i.docView&&(o=q.create(i.state.doc,m.posBefore))}}let a=(o||i.state.selection).content(),{dom:l,text:d,slice:u}=na(i,a);(!t.dataTransfer.files.length||!ke||zo>120)&&t.dataTransfer.clearData(),t.dataTransfer.setData(gn?"Text":"text/html",l.innerHTML),t.dataTransfer.effectAllowed="copyMove",gn||t.dataTransfer.setData("text/plain",d),i.dragging=new pa(u,!t[ma],o)};Me.dragend=i=>{let e=i.dragging;window.setTimeout(()=>{i.dragging==e&&(i.dragging=null)},50)};Ee.dragover=Ee.dragenter=(i,e)=>e.preventDefault();Ee.drop=(i,e)=>{let t=e,n=i.dragging;if(i.dragging=null,!t.dataTransfer)return;let s=i.posAtCoords(ti(t));if(!s)return;let r=i.state.doc.resolve(s.pos),o=n&&n.slice;o?i.someProp("transformPasted",y=>{o=y(o,i)}):o=ia(i,fa(t.dataTransfer),gn?null:t.dataTransfer.getData("text/html"),!1,r);let a=!!(n&&!t[ma]);if(i.someProp("handleDrop",y=>y(i,t,o||v.empty,a))){t.preventDefault();return}if(!o)return;t.preventDefault();let l=o?jh(i.state.doc,r.pos,o):r.pos;l==null&&(l=r.pos);let d=i.state.tr;if(a){let{node:y}=n;y?y.replace(d):d.deleteSelection()}let u=d.mapping.map(l),m=o.openStart==0&&o.openEnd==0&&o.content.childCount==1,p=d.doc;if(m?d.replaceRangeWith(u,u,o.content.firstChild):d.replaceRange(u,u,o),d.doc.eq(p))return;let k=d.doc.resolve(u);if(m&&q.isSelectable(o.content.firstChild)&&k.nodeAfter&&k.nodeAfter.sameMarkup(o.content.firstChild))d.setSelection(new q(k));else{let y=d.mapping.map(l);d.mapping.maps[d.mapping.maps.length-1].forEach((w,C,N,O)=>y=O),d.setSelection(ls(i,k,d.doc.resolve(y)))}i.focus(),i.dispatch(d.setMeta("uiEvent","drop"))};Me.focus=i=>{i.input.lastFocus=Date.now(),i.focused||(i.domObserver.stop(),i.dom.classList.add("ProseMirror-focused"),i.domObserver.start(),i.focused=!0,setTimeout(()=>{i.docView&&i.hasFocus()&&!i.domObserver.currentSelection.eq(i.domSelectionRange())&&dt(i)},20))};Me.blur=(i,e)=>{let t=e;i.focused&&(i.domObserver.stop(),i.dom.classList.remove("ProseMirror-focused"),i.domObserver.start(),t.relatedTarget&&i.dom.contains(t.relatedTarget)&&i.domObserver.currentSelection.clear(),i.focused=!1)};Me.beforeinput=(i,e)=>{if(ke&&We&&e.inputType=="deleteContentBackward"){i.domObserver.flushSoon();let{domChangeCount:n}=i.input;setTimeout(()=>{if(i.input.domChangeCount!=n||(i.dom.blur(),i.focus(),i.someProp("handleKeyDown",r=>r(i,It(8,"Backspace")))))return;let{$cursor:s}=i.state.selection;s&&s.pos>0&&i.dispatch(i.state.tr.delete(s.pos-1,s.pos).scrollIntoView())},50)}};for(let i in Ee)Me[i]=Ee[i];function xn(i,e){if(i==e)return!0;for(let t in i)if(i[t]!==e[t])return!1;for(let t in e)if(!(t in i))return!1;return!0}class Jn{constructor(e,t){this.toDOM=e,this.spec=t||Rt,this.side=this.spec.side||0}map(e,t,n,s){let{pos:r,deleted:o}=e.mapResult(t.from+s,this.side<0?-1:1);return o?null:new Je(r-n,r-n,this)}valid(){return!0}eq(e){return this==e||e instanceof Jn&&(this.spec.key&&this.spec.key==e.spec.key||this.toDOM==e.toDOM&&xn(this.spec,e.spec))}destroy(e){this.spec.destroy&&this.spec.destroy(e)}}class Ct{constructor(e,t){this.attrs=e,this.spec=t||Rt}map(e,t,n,s){let r=e.map(t.from+s,this.spec.inclusiveStart?-1:1)-n,o=e.map(t.to+s,this.spec.inclusiveEnd?1:-1)-n;return r>=o?null:new Je(r,o,this)}valid(e,t){return t.from<t.to}eq(e){return this==e||e instanceof Ct&&xn(this.attrs,e.attrs)&&xn(this.spec,e.spec)}static is(e){return e.type instanceof Ct}destroy(){}}class us{constructor(e,t){this.attrs=e,this.spec=t||Rt}map(e,t,n,s){let r=e.mapResult(t.from+s,1);if(r.deleted)return null;let o=e.mapResult(t.to+s,-1);return o.deleted||o.pos<=r.pos?null:new Je(r.pos-n,o.pos-n,this)}valid(e,t){let{index:n,offset:s}=e.content.findIndex(t.from),r;return s==t.from&&!(r=e.child(n)).isText&&s+r.nodeSize==t.to}eq(e){return this==e||e instanceof us&&xn(this.attrs,e.attrs)&&xn(this.spec,e.spec)}destroy(){}}class Je{constructor(e,t,n){this.from=e,this.to=t,this.type=n}copy(e,t){return new Je(e,t,this.type)}eq(e,t=0){return this.type.eq(e.type)&&this.from+t==e.from&&this.to+t==e.to}map(e,t,n){return this.type.map(e,this,t,n)}static widget(e,t,n){return new Je(e,e,new Jn(t,n))}static inline(e,t,n,s){return new Je(e,t,new Ct(n,s))}static node(e,t,n,s){return new Je(e,t,new us(n,s))}get spec(){return this.type.spec}get inline(){return this.type instanceof Ct}get widget(){return this.type instanceof Jn}}const qt=[],Rt={};class le{constructor(e,t){this.local=e.length?e:qt,this.children=t.length?t:qt}static create(e,t){return t.length?$n(t,e,0,Rt):ye}find(e,t,n){let s=[];return this.findInner(e??0,t??1e9,s,0,n),s}findInner(e,t,n,s,r){for(let o=0;o<this.local.length;o++){let a=this.local[o];a.from<=t&&a.to>=e&&(!r||r(a.spec))&&n.push(a.copy(a.from+s,a.to+s))}for(let o=0;o<this.children.length;o+=3)if(this.children[o]<t&&this.children[o+1]>e){let a=this.children[o]+1;this.children[o+2].findInner(e-a,t-a,n,s+a,r)}}map(e,t,n){return this==ye||e.maps.length==0?this:this.mapInner(e,t,0,0,n||Rt)}mapInner(e,t,n,s,r){let o;for(let a=0;a<this.local.length;a++){let l=this.local[a].map(e,n,s);l&&l.type.valid(t,l)?(o||(o=[])).push(l):r.onRemove&&r.onRemove(this.local[a].spec)}return this.children.length?ff(this.children,o||[],e,t,n,s,r):o?new le(o.sort(At),qt):ye}add(e,t){return t.length?this==ye?le.create(e,t):this.addInner(e,t,0):this}addInner(e,t,n){let s,r=0;e.forEach((a,l)=>{let d=l+n,u;if(u=ya(t,a,d)){for(s||(s=this.children.slice());r<s.length&&s[r]<l;)r+=3;s[r]==l?s[r+2]=s[r+2].addInner(a,u,d+1):s.splice(r,0,l,l+a.nodeSize,$n(u,a,d+1,Rt)),r+=3}});let o=ga(r?xa(t):t,-n);for(let a=0;a<o.length;a++)o[a].type.valid(e,o[a])||o.splice(a--,1);return new le(o.length?this.local.concat(o).sort(At):this.local,s||this.children)}remove(e){return e.length==0||this==ye?this:this.removeInner(e,0)}removeInner(e,t){let n=this.children,s=this.local;for(let r=0;r<n.length;r+=3){let o,a=n[r]+t,l=n[r+1]+t;for(let u=0,m;u<e.length;u++)(m=e[u])&&m.from>a&&m.to<l&&(e[u]=null,(o||(o=[])).push(m));if(!o)continue;n==this.children&&(n=this.children.slice());let d=n[r+2].removeInner(o,a+1);d!=ye?n[r+2]=d:(n.splice(r,3),r-=3)}if(s.length){for(let r=0,o;r<e.length;r++)if(o=e[r])for(let a=0;a<s.length;a++)s[a].eq(o,t)&&(s==this.local&&(s=this.local.slice()),s.splice(a--,1))}return n==this.children&&s==this.local?this:s.length||n.length?new le(s,n):ye}forChild(e,t){if(this==ye)return this;if(t.isLeaf)return le.empty;let n,s;for(let a=0;a<this.children.length;a+=3)if(this.children[a]>=e){this.children[a]==e&&(n=this.children[a+2]);break}let r=e+1,o=r+t.content.size;for(let a=0;a<this.local.length;a++){let l=this.local[a];if(l.from<o&&l.to>r&&l.type instanceof Ct){let d=Math.max(r,l.from)-r,u=Math.min(o,l.to)-r;d<u&&(s||(s=[])).push(l.copy(d,u))}}if(s){let a=new le(s.sort(At),qt);return n?new gt([a,n]):a}return n||ye}eq(e){if(this==e)return!0;if(!(e instanceof le)||this.local.length!=e.local.length||this.children.length!=e.children.length)return!1;for(let t=0;t<this.local.length;t++)if(!this.local[t].eq(e.local[t]))return!1;for(let t=0;t<this.children.length;t+=3)if(this.children[t]!=e.children[t]||this.children[t+1]!=e.children[t+1]||!this.children[t+2].eq(e.children[t+2]))return!1;return!0}locals(e){return fs(this.localsInner(e))}localsInner(e){if(this==ye)return qt;if(e.inlineContent||!this.local.some(Ct.is))return this.local;let t=[];for(let n=0;n<this.local.length;n++)this.local[n].type instanceof Ct||t.push(this.local[n]);return t}}le.empty=new le([],[]);le.removeOverlap=fs;const ye=le.empty;class gt{constructor(e){this.members=e}map(e,t){const n=this.members.map(s=>s.map(e,t,Rt));return gt.from(n)}forChild(e,t){if(t.isLeaf)return le.empty;let n=[];for(let s=0;s<this.members.length;s++){let r=this.members[s].forChild(e,t);r!=ye&&(r instanceof gt?n=n.concat(r.members):n.push(r))}return gt.from(n)}eq(e){if(!(e instanceof gt)||e.members.length!=this.members.length)return!1;for(let t=0;t<this.members.length;t++)if(!this.members[t].eq(e.members[t]))return!1;return!0}locals(e){let t,n=!0;for(let s=0;s<this.members.length;s++){let r=this.members[s].localsInner(e);if(r.length)if(!t)t=r;else{n&&(t=t.slice(),n=!1);for(let o=0;o<r.length;o++)t.push(r[o])}}return t?fs(n?t:t.sort(At)):qt}static from(e){switch(e.length){case 0:return ye;case 1:return e[0];default:return new gt(e.every(t=>t instanceof le)?e:e.reduce((t,n)=>t.concat(n instanceof le?n:n.members),[]))}}}function ff(i,e,t,n,s,r,o){let a=i.slice();for(let d=0,u=r;d<t.maps.length;d++){let m=0;t.maps[d].forEach((p,k,y,w)=>{let C=w-y-(k-p);for(let N=0;N<a.length;N+=3){let O=a[N+1];if(O<0||p>O+u-m)continue;let F=a[N]+u-m;k>=F?a[N+1]=p<=F?-2:-1:p>=u&&C&&(a[N]+=C,a[N+1]+=C)}m+=C}),u=t.maps[d].map(u,-1)}let l=!1;for(let d=0;d<a.length;d+=3)if(a[d+1]<0){if(a[d+1]==-2){l=!0,a[d+1]=-1;continue}let u=t.map(i[d]+r),m=u-s;if(m<0||m>=n.content.size){l=!0;continue}let p=t.map(i[d+1]+r,-1),k=p-s,{index:y,offset:w}=n.content.findIndex(m),C=n.maybeChild(y);if(C&&w==m&&w+C.nodeSize==k){let N=a[d+2].mapInner(t,C,u+1,i[d]+r+1,o);N!=ye?(a[d]=m,a[d+1]=k,a[d+2]=N):(a[d+1]=-2,l=!0)}else l=!0}if(l){let d=pf(a,i,e,t,s,r,o),u=$n(d,n,0,o);e=u.local;for(let m=0;m<a.length;m+=3)a[m+1]<0&&(a.splice(m,3),m-=3);for(let m=0,p=0;m<u.children.length;m+=3){let k=u.children[m];for(;p<a.length&&a[p]<k;)p+=3;a.splice(p,0,u.children[m],u.children[m+1],u.children[m+2])}}return new le(e.sort(At),a)}function ga(i,e){if(!e||!i.length)return i;let t=[];for(let n=0;n<i.length;n++){let s=i[n];t.push(new Je(s.from+e,s.to+e,s.type))}return t}function pf(i,e,t,n,s,r,o){function a(l,d){for(let u=0;u<l.local.length;u++){let m=l.local[u].map(n,s,d);m?t.push(m):o.onRemove&&o.onRemove(l.local[u].spec)}for(let u=0;u<l.children.length;u+=3)a(l.children[u+2],l.children[u]+d+1)}for(let l=0;l<i.length;l+=3)i[l+1]==-1&&a(i[l+2],e[l]+r+1);return t}function ya(i,e,t){if(e.isLeaf)return null;let n=t+e.nodeSize,s=null;for(let r=0,o;r<i.length;r++)(o=i[r])&&o.from>t&&o.to<n&&((s||(s=[])).push(o),i[r]=null);return s}function xa(i){let e=[];for(let t=0;t<i.length;t++)i[t]!=null&&e.push(i[t]);return e}function $n(i,e,t,n){let s=[],r=!1;e.forEach((a,l)=>{let d=ya(i,a,l+t);if(d){r=!0;let u=$n(d,a,t+l+1,n);u!=ye&&s.push(l,l+a.nodeSize,u)}});let o=ga(r?xa(i):i,-t).sort(At);for(let a=0;a<o.length;a++)o[a].type.valid(e,o[a])||(n.onRemove&&n.onRemove(o[a].spec),o.splice(a--,1));return o.length||s.length?new le(o,s):ye}function At(i,e){return i.from-e.from||i.to-e.to}function fs(i){let e=i;for(let t=0;t<e.length-1;t++){let n=e[t];if(n.from!=n.to)for(let s=t+1;s<e.length;s++){let r=e[s];if(r.from==n.from){r.to!=n.to&&(e==i&&(e=i.slice()),e[s]=r.copy(r.from,n.to),yr(e,s+1,r.copy(n.to,r.to)));continue}else{r.from<n.to&&(e==i&&(e=i.slice()),e[t]=n.copy(n.from,r.from),yr(e,s,n.copy(r.from,n.to)));break}}}return e}function yr(i,e,t){for(;e<i.length&&At(t,i[e])>0;)e++;i.splice(e,0,t)}function ki(i){let e=[];return i.someProp("decorations",t=>{let n=t(i.state);n&&n!=ye&&e.push(n)}),i.cursorWrapper&&e.push(le.create(i.state.doc,[i.cursorWrapper.deco])),gt.from(e)}const mf={childList:!0,characterData:!0,characterDataOldValue:!0,attributes:!0,attributeOldValue:!0,subtree:!0},gf=Oe&&wt<=11;class yf{constructor(){this.anchorNode=null,this.anchorOffset=0,this.focusNode=null,this.focusOffset=0}set(e){this.anchorNode=e.anchorNode,this.anchorOffset=e.anchorOffset,this.focusNode=e.focusNode,this.focusOffset=e.focusOffset}clear(){this.anchorNode=this.focusNode=null}eq(e){return e.anchorNode==this.anchorNode&&e.anchorOffset==this.anchorOffset&&e.focusNode==this.focusNode&&e.focusOffset==this.focusOffset}}class xf{constructor(e,t){this.view=e,this.handleDOMChange=t,this.queue=[],this.flushingSoon=-1,this.observer=null,this.currentSelection=new yf,this.onCharData=null,this.suppressingSelectionUpdates=!1,this.lastChangedTextNode=null,this.observer=window.MutationObserver&&new window.MutationObserver(n=>{for(let s=0;s<n.length;s++)this.queue.push(n[s]);Oe&&wt<=11&&n.some(s=>s.type=="childList"&&s.removedNodes.length||s.type=="characterData"&&s.oldValue.length>s.target.nodeValue.length)?this.flushSoon():this.flush()}),gf&&(this.onCharData=n=>{this.queue.push({target:n.target,type:"characterData",oldValue:n.prevValue}),this.flushSoon()}),this.onSelectionChange=this.onSelectionChange.bind(this)}flushSoon(){this.flushingSoon<0&&(this.flushingSoon=window.setTimeout(()=>{this.flushingSoon=-1,this.flush()},20))}forceFlush(){this.flushingSoon>-1&&(window.clearTimeout(this.flushingSoon),this.flushingSoon=-1,this.flush())}start(){this.observer&&(this.observer.takeRecords(),this.observer.observe(this.view.dom,mf)),this.onCharData&&this.view.dom.addEventListener("DOMCharacterDataModified",this.onCharData),this.connectSelection()}stop(){if(this.observer){let e=this.observer.takeRecords();if(e.length){for(let t=0;t<e.length;t++)this.queue.push(e[t]);window.setTimeout(()=>this.flush(),20)}this.observer.disconnect()}this.onCharData&&this.view.dom.removeEventListener("DOMCharacterDataModified",this.onCharData),this.disconnectSelection()}connectSelection(){this.view.dom.ownerDocument.addEventListener("selectionchange",this.onSelectionChange)}disconnectSelection(){this.view.dom.ownerDocument.removeEventListener("selectionchange",this.onSelectionChange)}suppressSelectionUpdates(){this.suppressingSelectionUpdates=!0,setTimeout(()=>this.suppressingSelectionUpdates=!1,50)}onSelectionChange(){if(cr(this.view)){if(this.suppressingSelectionUpdates)return dt(this.view);if(Oe&&wt<=11&&!this.view.state.selection.empty){let e=this.view.domSelectionRange();if(e.focusNode&&Bt(e.focusNode,e.focusOffset,e.anchorNode,e.anchorOffset))return this.flushSoon()}this.flush()}}setCurSelection(){this.currentSelection.set(this.view.domSelectionRange())}ignoreSelectionChange(e){if(!e.focusNode)return!0;let t=new Set,n;for(let r=e.focusNode;r;r=mn(r))t.add(r);for(let r=e.anchorNode;r;r=mn(r))if(t.has(r)){n=r;break}let s=n&&this.view.docView.nearestDesc(n);if(s&&s.ignoreMutation({type:"selection",target:n.nodeType==3?n.parentNode:n}))return this.setCurSelection(),!0}pendingRecords(){if(this.observer)for(let e of this.observer.takeRecords())this.queue.push(e);return this.queue}flush(){let{view:e}=this;if(!e.docView||this.flushingSoon>-1)return;let t=this.pendingRecords();t.length&&(this.queue=[]);let n=e.domSelectionRange(),s=!this.suppressingSelectionUpdates&&!this.currentSelection.eq(n)&&cr(e)&&!this.ignoreSelectionChange(n),r=-1,o=-1,a=!1,l=[];if(e.editable)for(let u=0;u<t.length;u++){let m=this.registerMutation(t[u],l);m&&(r=r<0?m.from:Math.min(m.from,r),o=o<0?m.to:Math.max(m.to,o),m.typeOver&&(a=!0))}if(Ke&&l.length){let u=l.filter(m=>m.nodeName=="BR");if(u.length==2){let[m,p]=u;m.parentNode&&m.parentNode.parentNode==p.parentNode?p.remove():m.remove()}else{let{focusNode:m}=this.currentSelection;for(let p of u){let k=p.parentNode;k&&k.nodeName=="LI"&&(!m||wf(e,m)!=k)&&p.remove()}}}let d=null;r<0&&s&&e.input.lastFocus>Date.now()-200&&Math.max(e.input.lastTouch,e.input.lastClick.time)<Date.now()-300&&Xn(n)&&(d=as(e))&&d.eq(Y.near(e.state.doc.resolve(0),1))?(e.input.lastFocus=0,dt(e),this.currentSelection.set(n),e.scrollToSelection()):(r>-1||s)&&(r>-1&&(e.docView.markDirty(r,o),kf(e)),this.handleDOMChange(r,o,a,l),e.docView&&e.docView.dirty?e.updateState(e.state):this.currentSelection.eq(n)||dt(e),this.currentSelection.set(n))}registerMutation(e,t){if(t.indexOf(e.target)>-1)return null;let n=this.view.docView.nearestDesc(e.target);if(e.type=="attributes"&&(n==this.view.docView||e.attributeName=="contenteditable"||e.attributeName=="style"&&!e.oldValue&&!e.target.getAttribute("style"))||!n||n.ignoreMutation(e))return null;if(e.type=="childList"){for(let u=0;u<e.addedNodes.length;u++){let m=e.addedNodes[u];t.push(m),m.nodeType==3&&(this.lastChangedTextNode=m)}if(n.contentDOM&&n.contentDOM!=n.dom&&!n.contentDOM.contains(e.target))return{from:n.posBefore,to:n.posAfter};let s=e.previousSibling,r=e.nextSibling;if(Oe&&wt<=11&&e.addedNodes.length)for(let u=0;u<e.addedNodes.length;u++){let{previousSibling:m,nextSibling:p}=e.addedNodes[u];(!m||Array.prototype.indexOf.call(e.addedNodes,m)<0)&&(s=m),(!p||Array.prototype.indexOf.call(e.addedNodes,p)<0)&&(r=p)}let o=s&&s.parentNode==e.target?he(s)+1:0,a=n.localPosFromDOM(e.target,o,-1),l=r&&r.parentNode==e.target?he(r):e.target.childNodes.length,d=n.localPosFromDOM(e.target,l,1);return{from:a,to:d}}else return e.type=="attributes"?{from:n.posAtStart-n.border,to:n.posAtEnd+n.border}:(this.lastChangedTextNode=e.target,{from:n.posAtStart,to:n.posAtEnd,typeOver:e.target.nodeValue==e.oldValue})}}let xr=new WeakMap,kr=!1;function kf(i){if(!xr.has(i)&&(xr.set(i,null),["normal","nowrap","pre-line"].indexOf(getComputedStyle(i.dom).whiteSpace)!==-1)){if(i.requiresGeckoHackNode=Ke,kr)return;console.warn("ProseMirror expects the CSS white-space property to be set, preferably to 'pre-wrap'. It is recommended to load style/prosemirror.css from the prosemirror-view package."),kr=!0}}function br(i,e){let t=e.startContainer,n=e.startOffset,s=e.endContainer,r=e.endOffset,o=i.domAtPos(i.state.selection.anchor);return Bt(o.node,o.offset,s,r)&&([t,n,s,r]=[s,r,t,n]),{anchorNode:t,anchorOffset:n,focusNode:s,focusOffset:r}}function bf(i,e){if(e.getComposedRanges){let s=e.getComposedRanges(i.root)[0];if(s)return br(i,s)}let t;function n(s){s.preventDefault(),s.stopImmediatePropagation(),t=s.getTargetRanges()[0]}return i.dom.addEventListener("beforeinput",n,!0),document.execCommand("indent"),i.dom.removeEventListener("beforeinput",n,!0),t?br(i,t):null}function wf(i,e){for(let t=e.parentNode;t&&t!=i.dom;t=t.parentNode){let n=i.docView.nearestDesc(t,!0);if(n&&n.node.isBlock)return t}return null}function Sf(i,e,t){let{node:n,fromOffset:s,toOffset:r,from:o,to:a}=i.docView.parseRange(e,t),l=i.domSelectionRange(),d,u=l.anchorNode;if(u&&i.dom.contains(u.nodeType==1?u:u.parentNode)&&(d=[{node:u,offset:l.anchorOffset}],Xn(l)||d.push({node:l.focusNode,offset:l.focusOffset})),ke&&i.input.lastKeyCode===8)for(let C=r;C>s;C--){let N=n.childNodes[C-1],O=N.pmViewDesc;if(N.nodeName=="BR"&&!O){r=C;break}if(!O||O.size)break}let m=i.state.doc,p=i.someProp("domParser")||fn.fromSchema(i.state.schema),k=m.resolve(o),y=null,w=p.parse(n,{topNode:k.parent,topMatch:k.parent.contentMatchAt(k.index()),topOpen:!0,from:s,to:r,preserveWhitespace:k.parent.type.whitespace=="pre"?"full":!0,findPositions:d,ruleFromNode:Cf,context:k});if(d&&d[0].pos!=null){let C=d[0].pos,N=d[1]&&d[1].pos;N==null&&(N=C),y={anchor:C+o,head:N+o}}return{doc:w,sel:y,from:o,to:a}}function Cf(i){let e=i.pmViewDesc;if(e)return e.parseRule();if(i.nodeName=="BR"&&i.parentNode){if(Te&&/^(ul|ol)$/i.test(i.parentNode.nodeName)){let t=document.createElement("div");return t.appendChild(document.createElement("li")),{skip:t}}else if(i.parentNode.lastChild==i||Te&&/^(tr|table)$/i.test(i.parentNode.nodeName))return{ignore:!0}}else if(i.nodeName=="IMG"&&i.getAttribute("mark-placeholder"))return{ignore:!0};return null}const Tf=/^(a|abbr|acronym|b|bd[io]|big|br|button|cite|code|data(list)?|del|dfn|em|i|ins|kbd|label|map|mark|meter|output|q|ruby|s|samp|small|span|strong|su[bp]|time|u|tt|var)$/i;function Mf(i,e,t,n,s){let r=i.input.compositionPendingChanges||(i.composing?i.input.compositionID:0);if(i.input.compositionPendingChanges=0,e<0){let D=i.input.lastSelectionTime>Date.now()-50?i.input.lastSelectionOrigin:null,W=as(i,D);if(W&&!i.state.selection.eq(W)){if(ke&&We&&i.input.lastKeyCode===13&&Date.now()-100<i.input.lastKeyCodeTime&&i.someProp("handleKeyDown",ae=>ae(i,It(13,"Enter"))))return;let $=i.state.tr.setSelection(W);D=="pointer"?$.setMeta("pointer",!0):D=="key"&&$.scrollIntoView(),r&&$.setMeta("composition",r),i.dispatch($)}return}let o=i.state.doc.resolve(e),a=o.sharedDepth(t);e=o.before(a+1),t=i.state.doc.resolve(t).after(a+1);let l=i.state.selection,d=Sf(i,e,t),u=i.state.doc,m=u.slice(d.from,d.to),p,k;i.input.lastKeyCode===8&&Date.now()-100<i.input.lastKeyCodeTime?(p=i.state.selection.to,k="end"):(p=i.state.selection.from,k="start"),i.input.lastKeyCode=null;let y=Nf(m.content,d.doc.content,d.from,p,k);if((Yt&&i.input.lastIOSEnter>Date.now()-225||We)&&s.some(D=>D.nodeType==1&&!Tf.test(D.nodeName))&&(!y||y.endA>=y.endB)&&i.someProp("handleKeyDown",D=>D(i,It(13,"Enter")))){i.input.lastIOSEnter=0;return}if(!y)if(n&&l instanceof X&&!l.empty&&l.$head.sameParent(l.$anchor)&&!i.composing&&!(d.sel&&d.sel.anchor!=d.sel.head))y={start:l.from,endA:l.to,endB:l.to};else{if(d.sel){let D=wr(i,i.state.doc,d.sel);if(D&&!D.eq(i.state.selection)){let W=i.state.tr.setSelection(D);r&&W.setMeta("composition",r),i.dispatch(W)}}return}i.input.domChangeCount++,i.state.selection.from<i.state.selection.to&&y.start==y.endB&&i.state.selection instanceof X&&(y.start>i.state.selection.from&&y.start<=i.state.selection.from+2&&i.state.selection.from>=d.from?y.start=i.state.selection.from:y.endA<i.state.selection.to&&y.endA>=i.state.selection.to-2&&i.state.selection.to<=d.to&&(y.endB+=i.state.selection.to-y.endA,y.endA=i.state.selection.to)),Oe&&wt<=11&&y.endB==y.start+1&&y.endA==y.start&&y.start>d.from&&d.doc.textBetween(y.start-d.from-1,y.start-d.from+1)==" "&&(y.start--,y.endA--,y.endB--);let w=d.doc.resolveNoCache(y.start-d.from),C=d.doc.resolveNoCache(y.endB-d.from),N=u.resolve(y.start),O=w.sameParent(C)&&w.parent.inlineContent&&N.end()>=y.endA,F;if((Yt&&i.input.lastIOSEnter>Date.now()-225&&(!O||s.some(D=>D.nodeName=="DIV"||D.nodeName=="P"))||!O&&w.pos<d.doc.content.size&&!w.sameParent(C)&&(F=Y.findFrom(d.doc.resolve(w.pos+1),1,!0))&&F.head==C.pos)&&i.someProp("handleKeyDown",D=>D(i,It(13,"Enter")))){i.input.lastIOSEnter=0;return}if(i.state.selection.anchor>y.start&&If(u,y.start,y.endA,w,C)&&i.someProp("handleKeyDown",D=>D(i,It(8,"Backspace")))){We&&ke&&i.domObserver.suppressSelectionUpdates();return}ke&&We&&y.endB==y.start&&(i.input.lastAndroidDelete=Date.now()),We&&!O&&w.start()!=C.start()&&C.parentOffset==0&&w.depth==C.depth&&d.sel&&d.sel.anchor==d.sel.head&&d.sel.head==y.endA&&(y.endB-=2,C=d.doc.resolveNoCache(y.endB-d.from),setTimeout(()=>{i.someProp("handleKeyDown",function(D){return D(i,It(13,"Enter"))})},20));let L=y.start,M=y.endA,R,U,j;if(O){if(w.pos==C.pos)Oe&&wt<=11&&w.parentOffset==0&&(i.domObserver.suppressSelectionUpdates(),setTimeout(()=>dt(i),20)),R=i.state.tr.delete(L,M),U=u.resolve(y.start).marksAcross(u.resolve(y.endA));else if(y.endA==y.endB&&(j=Ef(w.parent.content.cut(w.parentOffset,C.parentOffset),N.parent.content.cut(N.parentOffset,y.endA-N.start()))))R=i.state.tr,j.type=="add"?R.addMark(L,M,j.mark):R.removeMark(L,M,j.mark);else if(w.parent.child(w.index()).isText&&w.index()==C.index()-(C.textOffset?0:1)){let D=w.parent.textBetween(w.parentOffset,C.parentOffset);if(i.someProp("handleTextInput",W=>W(i,L,M,D)))return;R=i.state.tr.insertText(D,L,M)}}if(R||(R=i.state.tr.replace(L,M,d.doc.slice(y.start-d.from,y.endB-d.from))),d.sel){let D=wr(i,R.doc,d.sel);D&&!(ke&&We&&i.composing&&D.empty&&(y.start!=y.endB||i.input.lastAndroidDelete<Date.now()-100)&&(D.head==L||D.head==R.mapping.map(M)-1)||Oe&&D.empty&&D.head==L)&&R.setSelection(D)}U&&R.ensureMarks(U),r&&R.setMeta("composition",r),i.dispatch(R.scrollIntoView())}function wr(i,e,t){return Math.max(t.anchor,t.head)>e.content.size?null:ls(i,e.resolve(t.anchor),e.resolve(t.head))}function Ef(i,e){let t=i.firstChild.marks,n=e.firstChild.marks,s=t,r=n,o,a,l;for(let u=0;u<n.length;u++)s=n[u].removeFromSet(s);for(let u=0;u<t.length;u++)r=t[u].removeFromSet(r);if(s.length==1&&r.length==0)a=s[0],o="add",l=u=>u.mark(a.addToSet(u.marks));else if(s.length==0&&r.length==1)a=r[0],o="remove",l=u=>u.mark(a.removeFromSet(u.marks));else return null;let d=[];for(let u=0;u<e.childCount;u++)d.push(l(e.child(u)));if(_.from(d).eq(i))return{mark:a,type:o}}function If(i,e,t,n,s){if(t-e<=s.pos-n.pos||bi(n,!0,!1)<s.pos)return!1;let r=i.resolve(e);if(!n.parent.isTextblock){let a=r.nodeAfter;return a!=null&&t==e+a.nodeSize}if(r.parentOffset<r.parent.content.size||!r.parent.isTextblock)return!1;let o=i.resolve(bi(r,!0,!0));return!o.parent.isTextblock||o.pos>t||bi(o,!0,!1)<t?!1:n.parent.content.cut(n.parentOffset).eq(o.parent.content)}function bi(i,e,t){let n=i.depth,s=e?i.end():i.pos;for(;n>0&&(e||i.indexAfter(n)==i.node(n).childCount);)n--,s++,e=!1;if(t){let r=i.node(n).maybeChild(i.indexAfter(n));for(;r&&!r.isLeaf;)r=r.firstChild,s++}return s}function Nf(i,e,t,n,s){let r=i.findDiffStart(e,t);if(r==null)return null;let{a:o,b:a}=i.findDiffEnd(e,t+i.size,t+e.size);if(s=="end"){let l=Math.max(0,r-Math.min(o,a));n-=o+l-r}if(o<r&&i.size<e.size){let l=n<=r&&n>=o?r-n:0;r-=l,r&&r<e.size&&Sr(e.textBetween(r-1,r+1))&&(r+=l?1:-1),a=r+(a-o),o=r}else if(a<r){let l=n<=r&&n>=a?r-n:0;r-=l,r&&r<i.size&&Sr(i.textBetween(r-1,r+1))&&(r+=l?1:-1),o=r+(o-a),a=r}return{start:r,endA:o,endB:a}}function Sr(i){if(i.length!=2)return!1;let e=i.charCodeAt(0),t=i.charCodeAt(1);return e>=56320&&e<=57343&&t>=55296&&t<=56319}class jm{constructor(e,t){this._root=null,this.focused=!1,this.trackWrites=null,this.mounted=!1,this.markCursor=null,this.cursorWrapper=null,this.lastSelectedViewDesc=void 0,this.input=new $u,this.prevDirectPlugins=[],this.pluginViews=[],this.requiresGeckoHackNode=!1,this.dragging=null,this._props=t,this.state=t.state,this.directPlugins=t.plugins||[],this.directPlugins.forEach(Ir),this.dispatch=this.dispatch.bind(this),this.dom=e&&e.mount||document.createElement("div"),e&&(e.appendChild?e.appendChild(this.dom):typeof e=="function"?e(this.dom):e.mount&&(this.mounted=!0)),this.editable=Mr(this),Tr(this),this.nodeViews=Er(this),this.docView=ir(this.state.doc,Cr(this),ki(this),this.dom,this),this.domObserver=new xf(this,(n,s,r,o)=>Mf(this,n,s,r,o)),this.domObserver.start(),Gu(this),this.updatePluginViews()}get composing(){return this.input.composing}get props(){if(this._props.state!=this.state){let e=this._props;this._props={};for(let t in e)this._props[t]=e[t];this._props.state=this.state}return this._props}update(e){e.handleDOMEvents!=this._props.handleDOMEvents&&Hi(this);let t=this._props;this._props=e,e.plugins&&(e.plugins.forEach(Ir),this.directPlugins=e.plugins),this.updateStateInner(e.state,t)}setProps(e){let t={};for(let n in this._props)t[n]=this._props[n];t.state=this.state;for(let n in e)t[n]=e[n];this.update(t)}updateState(e){this.updateStateInner(e,this._props)}updateStateInner(e,t){var n;let s=this.state,r=!1,o=!1;e.storedMarks&&this.composing&&(ua(this),o=!0),this.state=e;let a=s.plugins!=e.plugins||this._props.plugins!=t.plugins;if(a||this._props.plugins!=t.plugins||this._props.nodeViews!=t.nodeViews){let k=Er(this);Of(k,this.nodeViews)&&(this.nodeViews=k,r=!0)}(a||t.handleDOMEvents!=this._props.handleDOMEvents)&&Hi(this),this.editable=Mr(this),Tr(this);let l=ki(this),d=Cr(this),u=s.plugins!=e.plugins&&!s.doc.eq(e.doc)?"reset":e.scrollToSelection>s.scrollToSelection?"to selection":"preserve",m=r||!this.docView.matchesNode(e.doc,d,l);(m||!e.selection.eq(s.selection))&&(o=!0);let p=u=="preserve"&&o&&this.dom.style.overflowAnchor==null&&cu(this);if(o){this.domObserver.stop();let k=m&&(Oe||ke)&&!this.composing&&!s.selection.empty&&!e.selection.empty&&_f(s.selection,e.selection);if(m){let y=ke?this.trackWrites=this.domSelectionRange().focusNode:null;this.composing&&(this.input.compositionNode=lf(this)),(r||!this.docView.update(e.doc,d,l,this))&&(this.docView.updateOuterDeco(d),this.docView.destroy(),this.docView=ir(e.doc,d,l,this.dom,this)),y&&!this.trackWrites&&(k=!0)}k||!(this.input.mouseDown&&this.domObserver.currentSelection.eq(this.domSelectionRange())&&Au(this))?dt(this,k):(Xo(this,e.selection),this.domObserver.setCurSelection()),this.domObserver.start()}this.updatePluginViews(s),!((n=this.dragging)===null||n===void 0)&&n.node&&!s.doc.eq(e.doc)&&this.updateDraggedNode(this.dragging,s),u=="reset"?this.dom.scrollTop=0:u=="to selection"?this.scrollToSelection():p&&du(p)}scrollToSelection(){let e=this.domSelectionRange().focusNode;if(!this.someProp("handleScrollToSelection",t=>t(this)))if(this.state.selection instanceof q){let t=this.docView.domAfterPos(this.state.selection.from);t.nodeType==1&&Qs(this,t.getBoundingClientRect(),e)}else Qs(this,this.coordsAtPos(this.state.selection.head,1),e)}destroyPluginViews(){let e;for(;e=this.pluginViews.pop();)e.destroy&&e.destroy()}updatePluginViews(e){if(!e||e.plugins!=this.state.plugins||this.directPlugins!=this.prevDirectPlugins){this.prevDirectPlugins=this.directPlugins,this.destroyPluginViews();for(let t=0;t<this.directPlugins.length;t++){let n=this.directPlugins[t];n.spec.view&&this.pluginViews.push(n.spec.view(this))}for(let t=0;t<this.state.plugins.length;t++){let n=this.state.plugins[t];n.spec.view&&this.pluginViews.push(n.spec.view(this))}}else for(let t=0;t<this.pluginViews.length;t++){let n=this.pluginViews[t];n.update&&n.update(this,e)}}updateDraggedNode(e,t){let n=e.node,s=-1;if(this.state.doc.nodeAt(n.from)==n.node)s=n.from;else{let r=n.from+(this.state.doc.content.size-t.doc.content.size);(r>0&&this.state.doc.nodeAt(r))==n.node&&(s=r)}this.dragging=new pa(e.slice,e.move,s<0?void 0:q.create(this.state.doc,s))}someProp(e,t){let n=this._props&&this._props[e],s;if(n!=null&&(s=t?t(n):n))return s;for(let o=0;o<this.directPlugins.length;o++){let a=this.directPlugins[o].props[e];if(a!=null&&(s=t?t(a):a))return s}let r=this.state.plugins;if(r)for(let o=0;o<r.length;o++){let a=r[o].props[e];if(a!=null&&(s=t?t(a):a))return s}}hasFocus(){if(Oe){let e=this.root.activeElement;if(e==this.dom)return!0;if(!e||!this.dom.contains(e))return!1;for(;e&&this.dom!=e&&this.dom.contains(e);){if(e.contentEditable=="false")return!1;e=e.parentElement}return!0}return this.root.activeElement==this.dom}focus(){this.domObserver.stop(),this.editable&&hu(this.dom),dt(this),this.domObserver.start()}get root(){let e=this._root;if(e==null){for(let t=this.dom.parentNode;t;t=t.parentNode)if(t.nodeType==9||t.nodeType==11&&t.host)return t.getSelection||(Object.getPrototypeOf(t).getSelection=()=>t.ownerDocument.getSelection()),this._root=t}return e||document}updateRoot(){this._root=null}posAtCoords(e){return gu(this,e)}coordsAtPos(e,t=1){return Ho(this,e,t)}domAtPos(e,t=0){return this.docView.domFromPos(e,t)}nodeDOM(e){let t=this.docView.descAt(e);return t?t.nodeDOM:null}posAtDOM(e,t,n=-1){let s=this.docView.posFromDOM(e,t,n);if(s==null)throw new RangeError("DOM position not inside the editor");return s}endOfTextblock(e,t){return wu(this,t||this.state,e)}pasteHTML(e,t){return yn(this,"",e,!1,t||new ClipboardEvent("paste"))}pasteText(e,t){return yn(this,e,null,!0,t||new ClipboardEvent("paste"))}destroy(){this.docView&&(Ku(this),this.destroyPluginViews(),this.mounted?(this.docView.update(this.state.doc,[],ki(this),this),this.dom.textContent=""):this.dom.parentNode&&this.dom.parentNode.removeChild(this.dom),this.docView.destroy(),this.docView=null,Zh())}get isDestroyed(){return this.docView==null}dispatchEvent(e){return Qu(this,e)}dispatch(e){let t=this._props.dispatchTransaction;t?t.call(this,e):this.updateState(this.state.apply(e))}domSelectionRange(){let e=this.domSelection();return Te&&this.root.nodeType===11&&iu(this.dom.ownerDocument)==this.dom&&bf(this,e)||e}domSelection(){return this.root.getSelection()}}function Cr(i){let e=Object.create(null);return e.class="ProseMirror",e.contenteditable=String(i.editable),i.someProp("attributes",t=>{if(typeof t=="function"&&(t=t(i.state)),t)for(let n in t)n=="class"?e.class+=" "+t[n]:n=="style"?e.style=(e.style?e.style+";":"")+t[n]:!e[n]&&n!="contenteditable"&&n!="nodeName"&&(e[n]=String(t[n]))}),e.translate||(e.translate="no"),[Je.node(0,i.state.doc.content.size,e)]}function Tr(i){if(i.markCursor){let e=document.createElement("img");e.className="ProseMirror-separator",e.setAttribute("mark-placeholder","true"),e.setAttribute("alt",""),i.cursorWrapper={dom:e,deco:Je.widget(i.state.selection.head,e,{raw:!0,marks:i.markCursor})}}else i.cursorWrapper=null}function Mr(i){return!i.someProp("editable",e=>e(i.state)===!1)}function _f(i,e){let t=Math.min(i.$anchor.sharedDepth(i.head),e.$anchor.sharedDepth(e.head));return i.$anchor.start(t)!=e.$anchor.start(t)}function Er(i){let e=Object.create(null);function t(n){for(let s in n)Object.prototype.hasOwnProperty.call(e,s)||(e[s]=n[s])}return i.someProp("nodeViews",t),i.someProp("markViews",t),e}function Of(i,e){let t=0,n=0;for(let s in i){if(i[s]!=e[s])return!0;t++}for(let s in e)n++;return t!=n}function Ir(i){if(i.spec.state||i.spec.filterTransaction||i.spec.appendTransaction)throw new RangeError("Plugins passed directly to the view must not have a state component")}const Df=({onScroll:i,textdocId:e})=>{const t=hd(e),{windowWidth:n}=Oc(u=>u,{windowWidth:0,windowHeight:0});if(!t)return null;const{versions:s}=t,r=s.length-1,o=s[r],a=o.comments.filter(u=>u.status!==Ua.DISMISSED),l=!!(o!=null&&o.isPartial);let d=null;switch(o.type){case qr.DOCUMENT:d=x.jsx(Gd,{value:o.content,comments:[],edits:[],isRequestActive:l,isPreview:!0,isDisabled:!0,hideAccelerators:!0,hideComments:!0,hideToolbar:!0,hideEditOverlay:!0,width:n,modelCursor:o.modelCursor});break;default:Ur(o.type)&&(d=x.jsx(Jd,{id:"codemirror",currentlyStreamingLineIndex:null,language:qa(o.type),value:o.content,hideComments:!0,hideToolbar:!0,hideAccelerators:!0,comments:a,readonlyReason:Wa.Streaming,isRequestActive:l}))}return x.jsx($t,{children:x.jsx($t.Content,{onScroll:i,children:d})})},Rf=B.memo(Df);function Af(i,e){switch(i){case"presentation":return x.jsx(Za,{});case"table":return x.jsx(Qa,{});case"chart":return x.jsx(Ya,{});case qr.DOCUMENT:return x.jsx(ad,{className:ne("icon-md",{"text-token-text-primary":e,"text-token-text-tertiary":!e})});default:return Ur(i)?x.jsx(Ga,{className:ne("icon-md",{"text-token-text-primary":e,"text-token-text-tertiary":!e})}):x.jsx(Ka,{})}}const Ji=({type:i,name:e,isStreaming:t=!1,isFocused:n=!1,onClick:s,textdocId:r,isFetching:o=!1,isCanvasOpen:a=!1,showInlinePreview:l=!1,isMissingFromThread:d=!1})=>{const[u,m]=B.useState(!1),p=kn(),{resolvedTheme:k}=Gn(),y=B.useRef(null),w=k==="dark",C=Ki(r),[N,O]=B.useState(!1),F=d,L=()=>{!y.current||F||(Xa.logButtonClick(el.MESSAGE_ATTACHMENT,{type:i}),tl(y.current),s==null||s())},M=t&&x.jsx(Ha,{size:20,className:ne("flex-shrink-0",n?"text-blue-selection":"text-token-text-secondary")}),R=i?x.jsx("span",{className:ne("flex-shrink-0 transition-[filter]",{grayscale:!n&&!u}),children:Af(i,C&&a)}):x.jsx("div",{className:"flex h-6 w-6 flex-shrink-0 items-center overflow-hidden",children:x.jsx(Fn,{lines:1,size:"base",width:100,widthVariance:0})}),[U]=B.useState(()=>Ja(100,180,!1)),j=d?x.jsx("span",{className:"min-w-0 truncate",children:p.formatMessage({id:"oZTAp8",defaultMessage:"Unknown title"})}):e?x.jsx("span",{className:"min-w-0 truncate",children:e}):x.jsx("div",{className:"flex h-5 flex-grow items-center overflow-hidden",style:{width:U},children:x.jsx(Fn,{lines:1,size:"base",width:100,widthVariance:0})}),D=W=>{O(W>0)};return x.jsxs(bt.div,{role:"button",id:$a(r),initial:{opacity:t?0:1,scale:t?.9:1},animate:{opacity:1,scale:1},transition:{type:"spring",bounce:0,duration:.72},className:ne("popover relative flex select-none flex-col overflow-hidden border bg-token-main-surface-primary transition-shadow duration-500",F?"cursor-default":"cursor-pointer",{"border-token-text-tertiary font-medium dark:border-gray-600":C&&a,"font-regular":!C,"border-token-border-light":!u&&!C,"border-token-border-medium":u&&!C,"mb-3 flex min-w-0 max-w-full flex-shrink flex-grow-0 items-center justify-between self-start rounded-xl":a||!l,"mb-4 h-96 w-full rounded-2xl":!a&&l}),onMouseEnter:()=>!F&&m(!0),onMouseLeave:()=>m(!1),onClick:L,ref:y,style:{boxShadow:a?C?"0px 2px 6px 0px rgba(0, 0, 0, 0.06)":"0px 2px 6px 0px rgba(0, 0, 0, 0)":l?u||C?"0px 12px 32px 0px rgba(0, 0, 0, 0.064)":"0px 6px 14px 0px rgba(0, 0, 0, 0.04)":"0px 2px 6px 0px rgba(0, 0, 0, 0)"},children:[x.jsxs("div",{className:ne("flex w-full min-w-0 items-center justify-between gap-2 self-start border-token-border-light px-4 transition-colors duration-700",{"border-token-border-light":!u&&!C,"border-token-border-medium":u&&!C,"text-sm font-medium text-token-text-primary":!a&&u&&l,"py-2":a||!l,"py-3":!a&&l,"text-sm font-medium text-token-text-secondary":!a&&!u&&l}),children:[x.jsxs("div",{className:ne("flex min-w-0 items-center",{"gap-2":a||!l,"gap-3.5":!a&&l}),children:[R,j]}),a?x.jsx(bt.span,{animate:M?"show":"initial",variants:{initial:{opacity:0,paddingLeft:0,width:"0"},show:{opacity:1,paddingLeft:2,width:"24px"}},transition:{type:"tween",duration:.18},children:M}):l&&!F?x.jsx(Gi,{label:p.formatMessage({id:"KMbgyZ",defaultMessage:"Open in canvas"}),children:x.jsx(bt.div,{role:"button",animate:{opacity:u?1:.64},transition:{type:"tween",duration:.18},className:"text-token-text-secondary transition-colors",children:x.jsx(od,{className:"icon-md"})})}):null]}),!a&&l&&r&&x.jsxs(x.Fragment,{children:[x.jsx("div",{className:ne("relative flex min-h-0 flex-auto flex-col overflow-hidden border-t transition-colors",{"border-token-border-light":N,"border-transparent":!N}),children:d?x.jsx("div",{className:"m-auto text-token-text-secondary",children:x.jsx(re,{id:"DZUSSk",defaultMessage:"Canvas not found"})}):o?x.jsx(lo,{}):x.jsx(Rf,{onScroll:D,textdocId:r})}),x.jsx("div",{className:"absolute bottom-0 z-20 h-24 w-full transition-colors",style:{background:`linear-gradient(${w?"rgba(0,0,0,0)":"rgba(255,255,255,0)"}, ${w?"#2f2f2f":"#ffffff"})`}})]})]})},vf=({messages:i,isRequestActive:e})=>{const t=kn(),n=nl(i),s=il(i),r=B.useMemo(()=>{if(sl(n==null?void 0:n.message))return rl(e,n.message,(s==null?void 0:s.message)??null)},[e,n,s]),o=ol(),a=(r==null?void 0:r.textdocId)??o??void 0,l=so(a),d=al(),u=Ki(a),m=ud(),p=ll(),k=fd(),y=cl(),w=pd(j=>{const D=j==null?void 0:j.lastCanvasAssistantMessageById;return D==null||a==null?null:D[a]}),C=w===(n==null?void 0:n.nodeId);if(!r)return null;const N=!k&&!l&&r.status!==Q.STREAMING&&r.status!==Q.WAITING;let O,F;if(r.status!==Q.REDACTED&&r.status!==Q.FAILED&&!N&&a){const j=y&&r.function===Dn.UpdateTextdoc&&r.status===Q.COMPLETE;O=()=>{j&&r.versionInt?dl(a,r.versionInt):Ti(a)},F=()=>{j&&r.versionInt&&p(a,r.versionInt)}}const L=Bf(r,l);if(r.function===Dn.CreateTextdoc){if(r.status===Q.STREAMING||r.status===Q.WAITING||r.status===Q.COMPLETE){const D=k===!0&&(r.status===Q.STREAMING||r.status===Q.WAITING);return x.jsx(Ji,{showInlinePreview:C||w==null,isMissingFromThread:N,isFetching:D,type:r.type??null,name:L,isFocused:u,isStreaming:r.status===Q.STREAMING,onClick:O,isCanvasOpen:d,textdocId:a})}let j;switch(r.status){case Q.FAILED:j=t.formatMessage({id:"SNarKX",defaultMessage:"Failed to generate"});break;case Q.CANCELED:j=t.formatMessage({id:"1A6W36",defaultMessage:"Stopped generating"});break;case Q.REDACTED:j=x.jsx(Gi,{align:"start",label:t.formatMessage({id:"F6q1k7",defaultMessage:"Removed from shared conversation"}),children:t.formatMessage({id:"BqyYDu",defaultMessage:"Created document"})});break}return x.jsx(Nr,{children:j})}const M=N||r.status===Q.REDACTED,R=m&&!M?L:null,U=x.jsx(Nr,{onClick:O,onMouseOver:F,isStreaming:r.status===Q.STREAMING,children:r.function===Dn.CommentTextdoc?Pf(t,r,R):Ff(t,r,R)});return C&&!d?x.jsxs("div",{className:"flex flex-col gap-2",children:[x.jsx(Ji,{showInlinePreview:!0,isMissingFromThread:N,isFetching:!1,type:(l==null?void 0:l.type)??null,name:L,isFocused:u,isStreaming:r.status===Q.STREAMING,onClick:a!=null?()=>Ti(a):void 0,isCanvasOpen:d,textdocId:a}),U]}):U};function Bf(i,e){return e!=null&&e.title?ks(e.title):i.function===Dn.CreateTextdoc&&i.title?ks(i.title):null}const Nr=({isStreaming:i=!1,onClick:e,onMouseOver:t,children:n})=>x.jsx("button",{disabled:!e,className:ne(i&&"loading-shimmer","flex min-h-5 w-fit select-none pt-[3px] text-start text-token-text-secondary",e&&"hover:text-token-text-primary"),onClick:e,onMouseOver:t,children:n}),ka=9;function Ff(i,e,t){var s;if(e.status===Q.STREAMING)return t?i.formatMessage({id:"W2xN1Z",defaultMessage:"Editing {documentTitle}"},{documentTitle:t}):i.formatMessage({id:"8taq8v",defaultMessage:"Editing"});if(e.status===Q.FAILED)return t?i.formatMessage({id:"UjJKYZ",defaultMessage:"Failed to edit {documentTitle}"},{documentTitle:t}):i.formatMessage({id:"kWUVkg",defaultMessage:"Failed to edit"});if(e.status===Q.CANCELED)return t?i.formatMessage({id:"TmSrCd",defaultMessage:"Stopped editing {documentTitle}"},{documentTitle:t}):i.formatMessage({id:"bYV7xA",defaultMessage:"Stopped editing"});const n=(s=e.updates)==null?void 0:s.length;return e.status===Q.REDACTED||!n||n>ka?t?i.formatMessage({id:"n+G/ct",defaultMessage:"Edited {documentTitle}"},{documentTitle:t}):i.formatMessage({id:"aegqpL",defaultMessage:"Edited"}):t?i.formatMessage({id:"osYMSb",defaultMessage:"{numEdits, plural, one {Edited {documentTitle}} other {Made {numEdits} edits to {documentTitle}}}"},{numEdits:n,documentTitle:t}):i.formatMessage({id:"xJD3WR",defaultMessage:"{numEdits, plural, one {Edited} other {Made {numEdits} edits}}"},{numEdits:n})}function Pf(i,e,t){var s;if(e.status===Q.STREAMING)return t?i.formatMessage({id:"8xQH/P",defaultMessage:"Commenting on {documentTitle}"},{documentTitle:t}):i.formatMessage({id:"5yqLeN",defaultMessage:"Commenting"});if(e.status===Q.FAILED)return t?i.formatMessage({id:"Rl821S",defaultMessage:"Failed to comment on {documentTitle}"},{documentTitle:t}):i.formatMessage({id:"W007jt",defaultMessage:"Failed to comment"});if(e.status===Q.CANCELED)return t?i.formatMessage({id:"bozPdq",defaultMessage:"Stopped commenting on {documentTitle}"},{documentTitle:t}):i.formatMessage({id:"hyBGa7",defaultMessage:"Stopped commenting"});const n=(s=e.comments)==null?void 0:s.length;return e.status===Q.REDACTED||!n||n>ka?t?i.formatMessage({id:"LXEzK7",defaultMessage:"Commented on {documentTitle}"},{documentTitle:t}):i.formatMessage({id:"KeMYhy",defaultMessage:"Commented"}):t?i.formatMessage({id:"Ql5lPq",defaultMessage:"{numComments, plural, one {Commented on {documentTitle}} other {Added {numComments} comments on {documentTitle}}}"},{numComments:n,documentTitle:t}):i.formatMessage({id:"FHtyJQ",defaultMessage:"{numComments, plural, one {Commented} other {Added {numComments} comments}}"},{numComments:n})}function Lf(i){var e,t;return((t=(e=i.message.metadata)==null?void 0:e.finish_details)==null?void 0:t.type)==="content_filter"}function ps(i){if(i===void 0)return{flagSeverity:void 0,shouldHideContent:!1,errCode:void 0,errMessage:void 0};const{errType:e,errCode:t,err:n,disclaimers:s}=i,r=Lf(i);return!(s&&s.length>0)&&r?{flagSeverity:"warning",shouldHideContent:!0,errCode:ct.ContentOrTos,errMessage:n}:{flagSeverity:e,shouldHideContent:e==="danger"&&(t===ct.ContentPolicy||t===ct.ModelIncompatibility),disclaimers:s,errCode:t,errMessage:n}}function jf(i){return x.jsx(Et,{flag:"danger",isUserTurn:!1,children:x.jsx(re,{...Be.somethingWentWrong})})}function zf({message:i,onRequestMoreCompletions:e,clientThreadId:t,id:n,isFeedbackEnabled:s,isUserTurn:r,className:o}){const{errCode:a,errMessage:l,flagSeverity:d}=ps(i);switch(a){case ct.ContentPolicy:return x.jsx(Et,{flag:d,isUserTurn:r,className:o,children:x.jsx(qf,{isFeedbackEnabled:s})});case ct.ModelIncompatibility:return x.jsx(Et,{flag:d,isUserTurn:r,className:o,children:x.jsx(re,{...Be.modelIncompatibilityMessage})});case ct.ContentOrTos:return x.jsx(Et,{flag:d,isUserTurn:r,className:o,children:x.jsx(Uf,{isFeedbackEnabled:s})});case Mi:return x.jsx(Vf,{className:o,id:n,onRequestMoreCompletions:e,flag:d,clientThreadId:t,isUserTurn:r});case Qr:return x.jsx(Et,{flag:d,isUserTurn:r,className:o,children:x.jsx(re,{...Be.historyDisabledConversationMissing})});default:return l!==void 0?x.jsx(Et,{flag:d,isUserTurn:r,className:o,children:x.jsx(hl,{rehypePlugins:[[ul,{target:"_new",rel:"noopener noreferrer"}]],className:"markdown prose w-full break-words dark:prose-invert",children:l})}):null}}function Vf({className:i,id:e,onRequestMoreCompletions:t,flag:n,clientThreadId:s,isUserTurn:r}){const o=fl(w=>w.isoDate),a=pl(o),l=ns(s??Dc),d=l&&l.kind!==je.PrimaryAssistant,u=gd(),m=yd(),p=B.useCallback(()=>{const w=new bs;t(e,{eventSource:"mouse"},w,!0,"none",!1)},[e,t]),k=B.useCallback(()=>{const w=new bs,C=m.id;u({modelId:C,location:"Model switcher menu item"}),t(e,{eventSource:"mouse"},w,!0,"none",!0)},[t,e,m.id,u]);let y;return d?y=o!=null?x.jsx("span",{children:x.jsx(re,{...Be.gptUsageCapExceededCustomFeature,values:{link:_r,formattedTime:a}})}):x.jsx(re,{...Be.gptUsageCapExceededExpired}):y=o!=null?x.jsx("span",{children:x.jsx(re,{...Be.gptUsageCapExceeded,values:{link:_r,formattedTime:a}})}):x.jsx(re,{...Be.gptUsageCapExceededExpired}),x.jsx(Et,{flag:o!=null?n:void 0,isUserTurn:r,className:i,children:x.jsxs("div",{className:"flex items-center gap-6",children:[y,o==null&&x.jsx(Cs,{color:"secondary",className:"flex-shrink-0",onClick:p,children:x.jsx(re,{...Be.buttonTryAgain})}),o!=null&&!d&&x.jsx(Cs,{color:"secondary",className:"flex-shrink-0",onClick:k,children:x.jsx(re,{...Be.buttonUseDefaultModel})})]})})}const _r=i=>x.jsx("a",{href:"https://share.hsforms.com/16d0ZZVM3QZirXnCD_q7u1Q4sk30",target:"_blank",rel:"noreferrer",className:"underline",children:i});function Uf({isFeedbackEnabled:i}){return x.jsxs(x.Fragment,{children:[x.jsx("div",{className:i?"font-semibold":"",children:x.jsx(re,{...Be.contentOrTosViolationNoFeedback,values:{contentPolicyLink:ba,termsLink:Wf}})}),x.jsx("div",{children:i&&x.jsx(re,{...Be.contentPolicyFeedback})})]})}function qf({isFeedbackEnabled:i}){return x.jsxs(x.Fragment,{children:[x.jsx("div",{className:i?"font-semibold":"",children:x.jsx(re,{...Be.contentPolicyViolationNoFeedback,values:{contentPolicyLink:ba}})}),x.jsx("div",{children:i&&x.jsx(re,{...Be.contentPolicyFeedback})})]})}const ba=i=>x.jsx(Wr,{target:"_blank",href:"https://openai.com/policies/usage-policies",rel:"noreferrer",children:i}),Wf=i=>x.jsx(Wr,{target:"_blank",href:"https://openai.com/policies/terms-of-use",rel:"noreferrer",children:i}),Be=Xi({contentPolicyFeedback:{id:"TextMessageDisplay.contentPolicyFeedback",defaultMessage:"Did we get it wrong? Please tell us by giving this response a thumbs down."},contentPolicyViolation:{id:"TextMessageDisplay.contentPolicyViolation.2",defaultMessage:"This content may violate our <contentPolicyLink>usage policies</contentPolicyLink>. Did we get it wrong? Please tell us by giving this response a thumbs down."},contentPolicyViolationNoFeedback:{id:"TextMessageDisplay.contentPolicyViolationNoFeedback",defaultMessage:"This content may violate our <contentPolicyLink>usage policies</contentPolicyLink>."},modelIncompatibilityMessage:{id:"cyOWhN",defaultMessage:"Your request was flagged as potentially violating our usage policy. Please try again with a different prompt."},contentOrTosViolation:{id:"TextMessageDisplay.contentOrTosViolation.2",defaultMessage:"This content may violate our <termsLink>Terms of Use</termsLink> or <contentPolicyLink>usage policies</contentPolicyLink>. Did we get it wrong? Please tell us by giving this response a thumbs down."},contentOrTosViolationNoFeedback:{id:"TextMessageDisplay.contentOrTosViolationNoFeedback",defaultMessage:"This content may violate our <termsLink>Terms of Use</termsLink> or <contentPolicyLink>usage policies</contentPolicyLink>."},historyDisabledConversationMissing:{id:"TextMessageDisplay.historyDisabledConversationMissing",defaultMessage:"Sorry, conversations created when Chat History is off expire after 6 hours of inactivity. Please start a new conversation to continue using ChatGPT."},somethingWentWrong:{id:"TextMessageDisplay.somethingWentWrong",defaultMessage:"Something went wrong."},gptUsageCapExceeded:{id:"TextMessageDisplay.gptUsageCapExceeded",defaultMessage:"You've reached the current usage cap for GPT-4. You can continue with the default model now, or try again {formattedTime}. <link>Learn more</link>"},gptUsageCapExceededCustomFeature:{id:"TextMessageDisplay.gptUsageCapExceededCustomFeature",defaultMessage:"You've reached the current usage cap for GPT-4, please try again {formattedTime}. <link>Learn more</link>"},gptUsageCapExceededExpired:{id:"TextMessageDisplay.gptUsageCapExceededExpired",defaultMessage:"You previously reached your usage cap for GPT-4, but you can now try sending your message again"},buttonUseDefaultModel:{id:"TextMessageDisplay.buttonUseDefaultModel",defaultMessage:"Use default model"},buttonTryAgain:{id:"TextMessageDisplay.buttonTryAgain",defaultMessage:"Try again"}}),Hf=({textdocId:i})=>{const e=so(i),t=Ki(e==null?void 0:e.textdocId);if(!e)return null;const n=()=>{Ti(e==null?void 0:e.textdocId)};return x.jsx("div",{children:x.jsx(Ji,{type:e.type,name:e.title,isFocused:t,onClick:n,showInlinePreview:!0})})},Jf=({messages:i})=>{var n;const[e]=i,t=(n=e==null?void 0:e.message.metadata)==null?void 0:n.canvas;return!t||t.user_message_type!=null?null:x.jsx(Hf,{textdocId:t.textdoc_id})};function ms(){return Zr(Xr.DataAnalysisV2)}function zm(){const i=ml(),e=Ac();return e&&i&&!vc(i)&&e.isEnterprise()}function $f(){return Zr(Xr.ChartSerialization)}function Vm(i,e){const t=i==="chart"?Ts.HasSeenAdaInteractiveChart:Ts.HasSeenAdaInteractiveTable,[n,s]=B.useState(Ms.getItem(t,{userId:e})??!1),r=B.useCallback(()=>{s(!0),Ms.setItem(t,!0,{userId:e})},[t,e]);return[n,r]}function Um(i){const[e,t]=B.useState([]),n=Pn(()=>{const s=P.resolveThreadId(i),r=P.getThreadCurrentLeafId(i);return P.getTree(s).getBranchFromLeaf(r)});return B.useEffect(()=>{const s=Sa(n);s.length!==e.length&&t(s)},[e.length,i,n]),e}function Gf(i){return Pn(()=>{const e=P.resolveThreadId(i),t=P.getThreadCurrentLeafId(i),s=P.getTree(e).getBranchFromLeaf(t);return Sa(s).length>0})}function wa(i){var r,o,a,l;const e=((o=(r=i.metadata)==null?void 0:r.aggregate_result)==null?void 0:o.messages.filter(oo))??[];let t=0;const n=(((a=i.metadata)==null?void 0:a.ada_visualizations)??[]).map(d=>{let u=d;return d.type=="chart"&&(u={...d,fallback_image:e[t++]}),u}),s=(((l=i.metadata)==null?void 0:l.attachments)??[]).filter(d=>Hr(d.name)).map(d=>({type:"table",file_id:d.id??"",title:xl(d),file_name:d.name,context_connector_info:d.context_connector_info}));return[...n,...s]}function Sa(i){return i.filter(t=>{var n,s,r,o;return((n=t.message)==null?void 0:n.author.role)==="tool"&&((s=t.message)==null?void 0:s.author.name)==="python"||(((o=(r=t.message)==null?void 0:r.metadata)==null?void 0:o.attachments)??[]).length>0}).flatMap(t=>wa(t.message))}Rc(i=>({selectedSpreadsheet:null,setSelectedSpreadsheet:e=>i({selectedSpreadsheet:e})}));async function Kf(i,e,t){const n=await i.text(),{parse:s}=await ue(async()=>{const{parse:o}=await import("./oeujip5i1ptrxie5.js");return{parse:o}},[]),r=s(n);return{content:{columnNames:r.shift(),columnTypes:r[0].map(()=>"string"),rows:r},file_name:e,download_url:t}}function Yf(i){const e=i[0].values.length,t=[];for(let n=0;n<e;n++){const s=i.map(r=>r.values[n]);t.push(s)}return t}function qm(i){return es({queryKey:["ada-visualization","chart",i.file_id],queryFn:async()=>{const e=await ht.getFileDownloadLink(i.file_id);if(e.status===eo.Success){const n=await(await fetch(e.download_url)).json();return{content:{chart_type:n.type,title:n.title,labels:n.labels,datasets:n.datasets,x_label:n.x_label,y_label:n.y_label},file_name:e.file_name??"",download_url:e.download_url}}else throw new Error("Failed to download chart json from interpreter")}})}function Wm(i){return es({queryKey:["ada-visualization","table",i.file_id],queryFn:async()=>{if(i.file_name&&gl(i.file_name)){const e=await ht.getAdaExcelFileContents(i.file_id);return{content:e.sheets.map(t=>({name:t.name,columnNames:t.columns.map(n=>n.name),columnTypes:t.columns.map(()=>"string"),rows:Yf(t.columns)})),download_url:e.download_url,file_name:i.file_name}}else{const e=await ht.getFileDownloadLink(i.file_id);if(e.status===eo.Success){const t=await fetch(e.download_url);return Kf(t,e.file_name??"",e.download_url)}else throw new Error("Failed to download from interpreter")}}})}function Hm(i){const e=yl(),t=Gf(i),n=ms();return t&&n&&!e.displayingSideBySideFeedback}const Qf=be(()=>ue(()=>import("./g0qdp7qa568rqza7.js"),__vite__mapDeps([30,1,2,3,31,5,6,7,32,33,34,35,15,36,14,20,21,12,13,16,17,18,19,22,23])).then(i=>i.default)),Zf=Tt.div`flex gap-2 flex-wrap mt-1 max-w-[80%] justify-end`,Xf=Tt.div`flex flex-col gap-2`,ep=({parts:i,attachments:e,isUserTurn:t,clientThreadId:n})=>{const s=Bc(),r=ms(),o=kl.getImageAssetPointersFromParts(i),a=new Set(o.map(k=>bl(k.asset_pointer))),d=wl()||s,u=(e??[]).filter(k=>Hr(k.name)),m=(e??[]).filter(k=>k.id==null||a.has(k.id)?!1:r?!u.includes(k):!0);return(r?(m.length>0||u.length>0)&&t:m.length>0&&t)?x.jsxs(x.Fragment,{children:[x.jsx(Zf,{children:m.map(k=>x.jsx(Sl,{file:k.name,fileId:k.id,contextConnectorInfo:Cl(k.context_connector_info),width:s?"normal":"wide",alwaysShowData:!0},k.id))}),r&&x.jsx(Xf,{className:ne(!d&&"w-[80%]"),children:u.map(k=>x.jsx(Qf,{clientThreadId:n,visualization:Tl(k)},k.id))})]}):null};function Ca(i){return Ml(i)&&!El(i)}const _n=50,tp=95;function np(i,e){if(i<=e)return i/e*_n;{const t=_n,n=tp-_n,s=i-e,o=-(_n/e)/n;return t+n*(1-Math.exp(o*s))}}class ip{constructor(){H(this,"mostRecentCompletionRequest");H(this,"loggedRequestIds",new Set)}onCompletionRequestStarted(e){this.mostRecentCompletionRequest={requestId:e,timestamp:Date.now()}}onDisplayTextAfterBrowsingSession(e,t){const n=this.mostRecentCompletionRequest;if(n!=null&&!this.loggedRequestIds.has(n.requestId)){const r=P.getThreadConversationTurns(e,t).find(o=>o.messages.some(a=>a.message.id===t));r!=null&&r.messages.some(o=>o.nodeId===n.requestId)&&($e.logEvent(_e.browsingTimeToFirstTextToken,{messageId:t,timeMs:Date.now()-n.timestamp}),this.loggedRequestIds.add(n.requestId))}}}const Ta=new ip;function sp(i){var s;const e=i.find(r=>{var o;return((o=r.message.metadata)==null?void 0:o.image_search_results)!==void 0});return(((s=e==null?void 0:e.message.metadata)==null?void 0:s.image_search_results)??[]).slice(0,5)}function rp({messages:i}){const e=sp(i),t=Il();return e.length===0?null:x.jsx("div",{className:ne({"mb-2":!0,"grid grid-flow-col gap-3":e.length>1,"w-1/3":e.length===1}),children:e.filter(({contentUrl:n})=>t.has(n)).map((n,s)=>x.jsx("a",{href:n.hostPageUrl,target:"_blank",rel:"noreferrer",children:x.jsx("img",{src:n.contentUrl,alt:n.name,className:"aspect-square rounded-xl object-cover"})},s))})}function Ma({attachments:i,citations:e,contentReferences:t,className:n,clientThreadId:s,displayParts:r,isCompletionInProgress:o,id:a,isActivelyStreaming:l,isUserTurn:d,turnIndex:u,isFeedbackEnabled:m,messages:p,onRequestMoreCompletions:k,parts:y,prevGroupedMessageType:w,prevGroupedMessages:C,showEditButton:N,onEnterEdit:O,size:F="medium"}){var W,$;const L=md(s),M=p.length>1,{flagSeverity:R,shouldHideContent:U}=ps(M?void 0:p[0]),j=!y.some(ae=>ae!==""),D=((W=p[0].message.metadata)==null?void 0:W.targeted_reply_label)??(($=p[0].message.metadata)==null?void 0:$.targeted_reply);return B.useEffect(()=>{!j&&w===z.Browsing&&Ta.onDisplayTextAfterBrowsingSession(s,p[0].message.id)},[j,p,s,w]),x.jsxs("div",{"data-message-author-role":p[0].message.author.role,"data-message-id":p[0].message.id,dir:"auto",className:ne(n,"text-message flex w-full flex-col items-end gap-2 whitespace-normal break-words [.text-message+&]:mt-5"),children:[D&&x.jsxs("div",{className:"mb-1 ml-6 mt-1 flex items-start gap-1.5 text-sm font-normal text-token-text-tertiary sm:ml-7 lg:ml-8",children:[x.jsx(ld,{className:"icon-md mt-1 shrink-0"}),x.jsx("p",{className:"mr-2 line-clamp-3",children:D})]}),d&&L&&x.jsx(Jf,{messages:p}),x.jsx(Nl,{messages:p}),x.jsx(op,{parts:y,attachments:i,isUserTurn:d,isCompletionInProgress:o,turnIndex:u,displayParts:r,isActivelyStreaming:l,shouldHideContent:U,showEditButton:N,onEnterEdit:O,clientThreadId:s,id:a,isEmpty:j,prevGroupedMessageType:w,prevGroupedMessages:C,flagSeverity:R,messages:p,citations:e,contentReferences:t,size:F}),x.jsx(zf,{message:M?void 0:p[0],id:a,isFeedbackEnabled:m,onRequestMoreCompletions:k,clientThreadId:s,isUserTurn:d}),x.jsx(_l,{isUserTurn:d,message:M?void 0:p[0]}),!d&&!l&&C&&w===z.SearchResult&&x.jsx(rp,{messages:C})]})}function op({clientThreadId:i,id:e,displayParts:t,isCompletionInProgress:n,turnIndex:s,isActivelyStreaming:r,shouldHideContent:o,showEditButton:a=!1,onEnterEdit:l,isEmpty:d,prevGroupedMessageType:u,prevGroupedMessages:m,messages:p,citations:k,contentReferences:y,size:w,isUserTurn:C,parts:N,attachments:O}){var pe,Pe;const F=kn(),L=Ol(t),[M,R]=B.useState({}),[U,j]=B.useState(!1),D=Dl(),{streamingContext:W}=Rl();B.useEffect(()=>{D&&(W.setOnStylesUpdatedCallback(R),W.onStreamingChanged(n),W.setOnResetCallback(()=>j(!1)),n&&(j(!0),R(W.createTopLevelStyles())))},[D,n,W]);const $=Al(),ae=(pe=p[0].message.metadata)==null?void 0:pe.gizmo_id,Se=(Pe=p[0].message.metadata)==null?void 0:Pe.serialization_metadata,Ue=Cd(p[0].message).length,De=B.useMemo(()=>({clientThreadId:i,messageId:e,turnIndex:s}),[i,e,s]),Ie=vl(p[0].message),ce=!!ae&&$.includes(ae),fe=B.useCallback(G=>{Bl.open(G,s,e)},[s,e]),Re=x.jsx(ep,{parts:N,attachments:O,isUserTurn:C,clientThreadId:i},"files-and-tables"),Ae=!!(O!=null&&O.length||t.some(G=>G.type==="images")),I=t.map((G,de)=>{var Ye;if(G.type==="transcription"){const ee=o?null:G.text;let me=null;return C&&o?me=x.jsx("span",{className:"italic opacity-30",children:x.jsx(re,{...On.contentRemoved})}):C&&ee!=null?me=ee.trim().length===0?x.jsx("span",{className:"italic opacity-30",children:x.jsx(Tn,{text:F.formatMessage(On.transcriptUnavailable),customSymbolOffsets:void 0})}):x.jsx("span",{className:"italic opacity-65",children:x.jsx(Tn,{text:`${ee.trim()}`,customSymbolOffsets:void 0})}):!C&&ee!=null&&(me=x.jsx(Tn,{text:ee,customSymbolOffsets:void 0})),x.jsx(ai,{containsImagesOrAttachments:Ae,isUserTurn:C,showEditButton:a,onEnterEdit:l,children:me},de)}else if(G.type==="text"){const ee=o?null:G.text;if(!d&&!o&&!C){const me=u===z.CodeInterpreter?m==null?void 0:m.map(Ce=>Ce.message):void 0,{text:qe,contentReferences:st}=Fl(L,k,y,ce),{processedText:A,displayedContentReferences:te}=Pl(qe,st,r?void 0:me);return x.jsx(Ll.Provider,{value:{analyticsMetadata:De,message:p[0].message,contentReferences:te,onShowSearchResults:fe,numImageResults:Ue,isActivelyStreaming:r,useSafeUrls:!0},children:x.jsx(Yi,{clientThreadId:i,messageId:e,isStreamingOrProcessing:U,size:w,className:ne(r&&!D&&"result-streaming",Ie&&"headers-v2"),children:A===""?"&#8203;":A})},de)}else if(d&&r&&!C)return D?x.jsx("div",{className:"pulsing-dot"},de):x.jsx("div",{className:"result-streaming",children:x.jsx("span",{children:x.jsx("pre",{})})},de);return x.jsx(ai,{containsImagesOrAttachments:Ae,isUserTurn:C,showEditButton:a,onEnterEdit:l,children:C&&o?x.jsx("span",{className:"italic opacity-30",children:x.jsx(re,{...On.contentRemoved})}):ee?x.jsx(Tn,{text:ee,customSymbolOffsets:Se==null?void 0:Se.custom_symbol_offsets}):null},de)}else if(G.type==="images"){const ee=((Ye=p[0].message.metadata)==null?void 0:Ye.attachments)??[];return x.jsx(jl,{assets:G.imageAssets,attachments:ee},de)}else return null}),E=t.findIndex(G=>G.type==="text");if(E!==-1?I.splice(E,0,Re):I.push(Re),o&&C)I.length=0,I.push(x.jsx(ai,{containsImagesOrAttachments:Ae,isUserTurn:C,onEnterEdit:Ii,children:x.jsx("span",{className:"italic opacity-30",children:x.jsx(re,{...On.contentRemoved})})}));else if(o&&!C)return null;return x.jsx("div",{className:ne("flex w-full flex-col gap-1 empty:hidden",C&&"items-end rtl:items-start",!C&&"first:pt-[3px]",U&&"streaming-response"),style:M,children:I})}const On=Xi({contentRemoved:{id:"textMessage.contentRemoved",defaultMessage:"Content removed"},transcriptUnavailable:{id:"textMessage.transcriptUnavailable",defaultMessage:"Transcript Unavailable"}});function ap(i){var d;const{isActivelyStreaming:e,...t}=i,n=Fc(),s=(n==null?void 0:n.includes("debug"))??!1,r=i.messages[i.messages.length-1].message.id,[o,a]=B.useState([]),l=B.useRef();return l.current===void 0&&(l.current=(n==null?void 0:n.includes(Pc))??!1?new zl(i.parts,a,e,void 0,{debug:s}):new Vl(i.parts,a,e)),B.useEffect(()=>{l.current!=null&&(l.current.onMessagePartsUpdated(i.parts,e),l.current.isBuffering()&&rn.addDelayedRenderingMessage(r))},[i.parts,r,e]),B.useEffect(()=>{l.current!=null&&!l.current.isBuffering()&&rn.removeDelayedRenderingMessage(r)},[o,r]),B.useEffect(()=>()=>rn.removeDelayedRenderingMessage(r),[r]),B.useEffect(()=>()=>{l.current!=null&&(l.current.destroy(),l.current=void 0)},[]),x.jsx(Ma,{...t,displayParts:o,isActivelyStreaming:e||((d=l.current)==null?void 0:d.isBuffering())})}function lp({message:i,isCompletionInProgress:e,clientThreadId:t,className:n,isUserTurn:s,turnIndex:r,isFeedbackEnabled:o,prevGroupedMessageType:a,prevGroupedMessages:l,showEditButton:d,onEnterEdit:u,onRequestMoreCompletions:m}){var k,y,w;const p=B.useMemo(()=>"parts"in i.message.content?i.message.content.parts:[Jr(i.message)],[i]);return x.jsx(dp,{parts:p,messages:[i],isCompletionInProgress:e,className:n,citations:(k=i.message.metadata)==null?void 0:k.citations,contentReferences:(y=i.message.metadata)==null?void 0:y.content_references,attachments:(w=i.message.metadata)==null?void 0:w.attachments,isUserTurn:s,turnIndex:r,id:i.nodeId,isFeedbackEnabled:o,onRequestMoreCompletions:m,clientThreadId:t,showEditButton:d,onEnterEdit:u,prevGroupedMessageType:a,prevGroupedMessages:l})}const cp=Lc.memo(lp);function dp(i){const e=i.messages.length>1,{flagSeverity:t}=ps(e?void 0:i.messages[0]),n=t!=="danger"&&i.isCompletionInProgress,s=!i.parts.some(o=>o!==""),[r]=B.useState(()=>!i.isUserTurn&&(i.isCompletionInProgress||s));return r?x.jsx(ap,{...i,isActivelyStreaming:n}):x.jsx(Ma,{...i,displayParts:Ul({isUserTurn:i.isUserTurn,parts:i.parts}),isActivelyStreaming:n})}const hp=be(()=>ue(()=>import("./goycyquo3djiwxwd.js"),__vite__mapDeps([37,1,2,3])));function Ea({animationData:i,animationSegmentToPlay:e,animationLoopCounter:t}){const n=B.useRef(null);return B.useEffect(()=>{var s;(s=n.current)==null||s.playSegments(e,!0)},[t]),x.jsx(hp,{animationData:i,lottieRef:n,loop:!1,autoplay:!1})}function up(i){return x.jsx(ts,{width:"8",height:"9",viewBox:"0 0 8 9",fill:"none",...i,children:x.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M7.66607 0.376042C8.01072 0.605806 8.10385 1.07146 7.87408 1.4161L3.54075 7.9161C3.40573 8.11863 3.18083 8.24304 2.93752 8.24979C2.69421 8.25654 2.46275 8.1448 2.31671 7.95008L0.150044 5.06119C-0.098484 4.72982 -0.0313267 4.25972 0.300044 4.01119C0.631415 3.76266 1.10152 3.82982 1.35004 4.16119L2.88068 6.20204L6.62601 0.584055C6.85577 0.239408 7.32142 0.146278 7.66607 0.376042Z",fill:"currentColor"})})}function fp(i){return x.jsxs(ts,{width:"4",height:"12",viewBox:"0 0 4 12",fill:"none",...i,children:[x.jsx("mask",{id:"path-1-inside-1_1975_4008",fill:"currentColor",children:x.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M1 6.5C1 7.05228 1.44772 7.5 2 7.5C2.55228 7.5 3 7.05228 3 6.5V1.5C3 0.947715 2.55228 0.5 2 0.5C1.44772 0.5 1 0.947715 1 1.5L1 6.5ZM0.75 10.25C0.75 10.9404 1.30964 11.5 2 11.5C2.69036 11.5 3.25 10.9404 3.25 10.25C3.25 9.55964 2.69036 9 2 9C1.30964 9 0.75 9.55964 0.75 10.25Z"})}),x.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M1 6.5C1 7.05228 1.44772 7.5 2 7.5C2.55228 7.5 3 7.05228 3 6.5V1.5C3 0.947715 2.55228 0.5 2 0.5C1.44772 0.5 1 0.947715 1 1.5L1 6.5ZM0.75 10.25C0.75 10.9404 1.30964 11.5 2 11.5C2.69036 11.5 3.25 10.9404 3.25 10.25C3.25 9.55964 2.69036 9 2 9C1.30964 9 0.75 9.55964 0.75 10.25Z",fill:"currentColor"}),x.jsx("path",{d:"M1 6.5H-0.25H1ZM1 1.5L-0.25 1.5L-0.25 1.5L1 1.5ZM2 6.25C2.13807 6.25 2.25 6.36193 2.25 6.5H-0.25C-0.25 7.74264 0.757359 8.75 2 8.75V6.25ZM1.75 6.5C1.75 6.36193 1.86193 6.25 2 6.25V8.75C3.24264 8.75 4.25 7.74264 4.25 6.5H1.75ZM1.75 1.5V6.5H4.25V1.5H1.75ZM2 1.75C1.86193 1.75 1.75 1.63807 1.75 1.5H4.25C4.25 0.257359 3.24264 -0.75 2 -0.75V1.75ZM2.25 1.5C2.25 1.63807 2.13807 1.75 2 1.75V-0.75C0.757359 -0.75 -0.25 0.257359 -0.25 1.5L2.25 1.5ZM2.25 6.5L2.25 1.5L-0.25 1.5L-0.25 6.5L2.25 6.5ZM2 10.25H-0.5C-0.5 11.6307 0.619288 12.75 2 12.75V10.25ZM2 10.25V12.75C3.38071 12.75 4.5 11.6307 4.5 10.25H2ZM2 10.25H2H4.5C4.5 8.86929 3.38071 7.75 2 7.75V10.25ZM2 10.25H2V7.75C0.619288 7.75 -0.5 8.86929 -0.5 10.25H2Z",fill:"currentColor",mask:"url(#path-1-inside-1_1975_4008)"})]})}function pp(i){return x.jsx(ts,{width:"8",height:"9",viewBox:"0 0 8 9",fill:"none",...i,children:x.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M7.32256 1.48447C7.59011 1.16827 7.55068 0.695034 7.23447 0.427476C6.91827 0.159918 6.44503 0.199354 6.17748 0.515559L4.00002 3.08892L1.82256 0.515559C1.555 0.199354 1.08176 0.159918 0.765559 0.427476C0.449355 0.695034 0.409918 1.16827 0.677476 1.48447L3.01755 4.25002L0.677476 7.01556C0.409918 7.33176 0.449354 7.805 0.765559 8.07256C1.08176 8.34011 1.555 8.30068 1.82256 7.98447L4.00002 5.41111L6.17748 7.98447C6.44503 8.30068 6.91827 8.34011 7.23447 8.07256C7.55068 7.805 7.59011 7.33176 7.32256 7.01556L4.98248 4.25002L7.32256 1.48447Z",fill:"currentColor"})})}function Jm({animationLoopCounter:i}){const{resolvedTheme:e}=Gn(),t=e==="dark";return x.jsx(Ea,{animationData:t?ql:Wl,animationSegmentToPlay:[0,300],animationLoopCounter:i})}function $m({animationLoopCounter:i}){const{resolvedTheme:e}=Gn(),t=e==="dark";return x.jsx(Ea,{animationData:t?Hl:Jl,animationSegmentToPlay:[0,400],animationLoopCounter:i})}const mp=2e3,Ia=.4,gp=.45,yp=.2,xp=.1,kp=.25;var ze=(i=>(i[i.Running=0]="Running",i[i.Finished=1]="Finished",i[i.Error=2]="Error",i[i.Stopped=3]="Stopped",i[i.Paused=4]="Paused",i))(ze||{});function Gm({conversationMessages:i,icon:e,status:t,text:n,estimatedToolDurationMs:s,animationLoopDurationMs:r=mp,shouldPersistAfterFinished:o=!1}){const[a,l]=B.useState(t===0?0:t===1&&!o?7:1),[d,u]=B.useState(0);B.useEffect(()=>{t===2?l(8):t===3?l(9):t===4?l(10):t===1?l(a===2?3:7):t===0&&a===10&&(l(2),u(p=>p+1))},[t]);const m=Sp(a);return B.useEffect(()=>{const p=i[0].message.id;if(m)return rn.addDelayedRenderingMessage(p),()=>{rn.removeDelayedRenderingMessage(p)}},[m]),$r(()=>{Jt(a)&&u(p=>p+1)},r),a===7&&!o?null:x.jsxs("div",{className:"my-2.5 flex items-center gap-2.5",children:[x.jsx(bp,{icon:e,status:t,uiState:a,estimatedToolDurationMs:s,animationLoopCounter:d,shouldPersistAfterFinished:o,onFillProgressBarAnimationComplete:()=>l(4),onFinishAnimationComplete:()=>{l(5),setTimeout(()=>{l(o?7:6)},xp*1e3)},onHideAnimationComplete:()=>l(7)}),x.jsx(wp,{text:n,uiState:a,animationLoopCounter:d,onEnterAnimationComplete:()=>l(2)})]})}const Or=50;function bp({icon:i,status:e,uiState:t,estimatedToolDurationMs:n,animationLoopCounter:s,shouldPersistAfterFinished:r,onFillProgressBarAnimationComplete:o,onFinishAnimationComplete:a,onHideAnimationComplete:l}){const[d,u]=B.useState(0);$r(()=>{Jt(t)?u(O=>O+Or):t===10&&u(0)},Or);let m,p,k;Jt(t)||t===10?(m="running",p=x.jsx(i,{animationLoopCounter:s}),k="bg-transparent"):t===4||t===5||t===7&&r?(m="finished",p=x.jsx(up,{}),k="bg-brand-purple"):e===2?(m="error",p=x.jsx(fp,{}),k="bg-orange-500"):e===3&&(m="stopped",p=x.jsx(pp,{}),k="bg-gray-300");let y={opacity:0,scale:0,rotate:-180,x:0},w={type:"spring",bounce:.3,duration:gp},C={opacity:0,scale:.6,rotate:0,x:0};t===0?(y={opacity:0,scale:.5,rotate:-180,x:-8},w={type:"spring",bounce:.3,duration:Ia}):t===1?y=!1:t===5&&(C={opacity:0,scale:0,rotate:0,x:0},w={type:"spring",bounce:.3,duration:kp});const N=np(d,n);return x.jsx("div",{className:"relative h-5 w-5 shrink-0",children:x.jsx(Bn,{onExitComplete:()=>{t===6&&l()},children:m!=null&&x.jsxs(bt.div,{className:ne("absolute left-0 top-0 flex h-full w-full items-center justify-center rounded-full text-white",k),initial:y,animate:{opacity:1,scale:1,rotate:0,x:0},exit:C,transition:w,onAnimationComplete:()=>{t===4&&a()},children:[p,(Jt(t)||t===10)&&x.jsx($l,{percentage:t===3?100:N,thickness:1.5/23,className:"absolute left-1/2 top-1/2 h-[23px] w-[23px] -translate-x-1/2 -translate-y-1/2 text-brand-purple",backgroundStrokeClassName:"stroke-brand-purple/25 dark:stroke-brand-purple/50",transitionDuration:t===3?`${(100-N)/100*yp}s`:void 0,transitionTimingFunction:t===3?"cubic-bezier(0.55, 0, 1, 1)":void 0,onTransitionEnd:()=>{t===3&&o()}})]},m)})})}function wp({text:i,uiState:e,animationLoopCounter:t,onEnterAnimationComplete:n}){const[s,r]=B.useState(i);B.useEffect(()=>{e===2&&r(i)},[t]),B.useEffect(()=>{Jt(e)||r(i)},[e,i]);let o={opacity:0,x:0,y:15},a={type:"spring",bounce:.3,opacity:{duration:.15},y:{duration:.3}};e===0?(o={opacity:0,x:-8,y:0},a={type:"spring",bounce:.3,duration:Ia,delay:.15}):e===1&&(o=!1);const l=s??void 0;return x.jsx("div",{className:ne("relative h-5 w-full leading-5",e===8||e===9?"text-token-text-tertiary":"text-token-text-secondary"),children:x.jsx(Bn,{children:l!=null&&x.jsx(bt.div,{className:"absolute left-0 top-0 line-clamp-1 overflow-visible",initial:o,animate:{opacity:1,x:0,y:0},exit:{opacity:0,x:0,y:-15},transition:a,onAnimationComplete:()=>{e===0&&n()},children:l},l.toString())})})}function Jt(i){return i===0||i===2||i===3}function Sp(i){return Jt(i)||i===4||i===5||i===6||i===10}const Dr=Tt.div`group absolute left-0 top-0 mr-1.5 h-8 overflow-hidden mt-1`;function gs({highlightedCommand:i,status:e,children:t,showWorkUserSetting:n=!1,hideOnlyIfNotInteractedWith:s=!1,onOpenAnalytics:r}){const o=t!=null,[a]=B.useState(n),[l,d]=B.useState(n),[u,m]=B.useState(!1),p=e===ze.Finished||e===ze.Error,k=s?a?!1:!u:!1,y=e===ze.Running&&"loading-shimmer";return p&&k?null:o?x.jsxs(x.Fragment,{children:[x.jsx(Rr,{$canShowWork:!0,children:x.jsx(Bn,{children:x.jsx(Dr,{children:x.jsx(bt.button,{onClick:()=>{l||r==null||r(),d(w=>!w),m(!0)},initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},className:ne(y),children:x.jsxs("div",{className:"flex items-center justify-start gap-1",children:[x.jsx("span",{children:i}),l?x.jsx(cd,{className:"icon-md"}):x.jsx(dd,{className:"icon-md"})]})},i==null?void 0:i.toString())})})}),x.jsx(Bn,{children:l&&t&&x.jsx(bt.div,{initial:"collapsed",animate:"reveal",exit:"collapsed",variants:{collapsed:{translateY:-20,opacity:0,height:0},reveal:{translateY:0,opacity:1,height:"auto"}},transition:{duration:.3,ease:"easeInOut"},className:"overflow-hidden",children:t})})]}):x.jsx(Rr,{$canShowWork:!1,children:x.jsx(Dr,{className:ne(y),children:i})})}const Rr=Tt.p`first:mt-0 relative h-8
${({$canShowWork:i})=>i?"text-token-text-secondary hover:text-token-text-primary my-1.5":"text-token-text-secondary"}`,Ar=be(()=>ue(()=>import("./g0qdp7qa568rqza7.js"),__vite__mapDeps([30,1,2,3,31,5,6,7,32,33,34,35,15,36,14,20,21,12,13,16,17,18,19,22,23])).then(i=>i.default));function Cp({messages:i,isRequestActive:e,clientThreadId:t}){var w,C,N;const[n,s]=i,r=Ca(n.message),o=(w=s==null?void 0:s.message.metadata)==null?void 0:w.aggregate_result,a=$f(),l=ms(),d=s!=null&&s.message?wa(s.message):[],u=((N=(C=s==null?void 0:s.message.metadata)==null?void 0:C.aggregate_result)==null?void 0:N.messages.filter(oo))??[],p=(d.filter(O=>O.type==="chart")??[]).length!==u.length,k=l&&!p;let y=ze.Running;return(o==null?void 0:o.status)==="success"?y=ze.Finished:s!=null&&s.message.content.content_type!==Kn.ExecutionOutput||o!=null&&o.status!=="running"?y=ze.Error:(r||!e)&&(y=ze.Stopped),x.jsxs(x.Fragment,{children:[x.jsx(Tp,{messages:i,status:y,isRequestActive:e}),k&&d.map((O,F)=>{const{type:L}=O;return L==="chart"&&!a?(O.fallback_to_image=!0,x.jsx(vr,{children:x.jsx(Ar,{clientThreadId:t,visualization:O})},F)):x.jsx(vr,{children:x.jsx(Ar,{clientThreadId:t,visualization:O})},F)}),!k&&s!=null&&x.jsx(Id,{message:s.message})]})}const vr=Tt.div`mb-3 max-w-[80%]`;function Tp({messages:i,status:e,isRequestActive:t}){var m;const[n,s]=i,r=kn(),o=(m=s==null?void 0:s.message.metadata)==null?void 0:m.aggregate_result,a=Ca(n.message),{data:l,error:d}=jc(zc.ShowExpandedCodeView);let u=r.formatMessage({id:"message.tools.data-analysis.running",defaultMessage:"Analyzing"});if((o==null?void 0:o.status)==="success"?u=r.formatMessage({id:"message.tools.data-analysis.finished",defaultMessage:"Analyzed"}):s!=null&&s.message.content.content_type!==Kn.ExecutionOutput||o!=null&&o.status!=="running"?u=r.formatMessage({id:"message.tools.data-analysis.error",defaultMessage:"Analysis errored"}):(a||!t)&&(u=r.formatMessage({id:"message.tools.data-analysis.stopped",defaultMessage:"Analysis paused"})),l!==void 0||d){const p=Nd(n.message)!=null;return x.jsx(gs,{status:e,highlightedCommand:u,showWorkUserSetting:l??!1,hideOnlyIfNotInteractedWith:!0,children:p?x.jsxs("div",{className:"mb-3 mt-0.5 overflow-hidden rounded-xl bg-black",children:[x.jsx(_d,{message:n.message,FormattedText:Yi}),s!=null&&x.jsx(Od,{message:s.message})]}):null})}return null}const Mp=3,Ep=.1,Br=[0,.26,.4];function Ip({nextMessage:i,isLastMessage:e,isRequestActive:t}){let n=e||!i||i&&!Gr(i.message);const s=Td(i==null?void 0:i.message),r=Gl(s.slice(0,Mp).map(o=>o.entries[0].url));if(n){const o=t?x.jsxs("div",{className:"flex items-center gap-1",children:[r.map((a,l)=>x.jsx(bt.div,{className:"-ml-1.5 first:ml-0 last:mr-1.5",initial:{width:l===0?0:6,opacity:0},animate:{width:20,opacity:1},transition:{duration:Ep,delay:Br[Math.min(l,Br.length-1)]},children:x.jsx("div",{className:ne("flex h-5 w-5 items-center overflow-hidden rounded","border-l-2 border-token-main-surface-primary bg-token-main-surface-primary"),children:x.jsx(Kl,{url:a,size:32,minSize:16,className:"icon-md rounded"})})},a)),x.jsx(re,{id:"jjx8Qg",defaultMessage:"Searching the web"})]}):x.jsx(re,{id:"fssXGM",defaultMessage:"Error while searching"});return x.jsx(gs,{highlightedCommand:o,status:t?ze.Running:ze.Error})}return null}const Np={strong:i=>{const{node:e,children:t,...n}=i;return x.jsx("strong",{...n,className:ne(n.className,"font-semibold text-token-text-primary"),children:t})},p:i=>{const{node:e,children:t,...n}=i;return x.jsx("p",{...n,className:ne(n.className,"text-base","has-[strong]:mb-1 [&:not(:first-child)]:has-[strong]:mt-3 [&:not(:has(strong))]:mb-3"),children:t})}};function _p({messages:i,isStreaming:e,clientThreadId:t}){var k,y;const[n,s]=B.useState(""),[r,o]=B.useState(!1),a=i[0].message,l=a.id,d=P.getServerThreadId(t),u=Jr(a);B.useEffect(()=>{var O;const w=/\*\*(.*?)(?:\*\*|\n|$)/g;let C,N="";for(;(C=w.exec(u))!=null;)N=C[1].trim();N?s(N):((O=a.metadata)==null?void 0:O.initial_text)!=null&&s(a.metadata.initial_text)},[u,(k=a.metadata)==null?void 0:k.initial_text]),B.useEffect(()=>{u.length>0&&o(!0)},[u]);const m=B.useMemo(()=>({client_thread_id:t,message_id:l,conversationId:d}),[t,l,d]);B.useEffect(()=>{r&&$e.logEvent(_e.receivedA8KM123Message,m)},[r]);const p=B.useCallback(()=>{$e.logEvent(_e.openedA8KM123Message,{...m,isStreaming:e})},[m,e]);return x.jsx(gs,{status:e?ze.Running:ze.Finished,highlightedCommand:e?n:((y=a.metadata)==null?void 0:y.finished_text)??"",onOpenAnalytics:p,children:r?x.jsx("div",{className:"mb-4 border-l-2 pl-4 dark:border-token-text-secondary",children:x.jsx(Yi,{componentOverrides:Np,className:"not-prose leading-6",children:u})}):null})}const Op=be(()=>ue(()=>import("./sso-fjuqtgpha7i6x4xz.js").then(i=>i.J),__vite__mapDeps([38,1,2,3,17,5,6,18,14,7,16,39,20,40,41,42,43,44,12,45,15,46,47,48,49,50,51,52,53,54,55,56,57,23,58,59,28,10,60,61,22,62,63,64,65,66,67,13,19,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,33,34])).then(i=>i.JawboneMessage).catch(()=>jf)),Dp=be(()=>ue(()=>import("./glb0ttf4q7286cw1.js"),__vite__mapDeps([83,1,2,3,5,6,12,7,13,14,15,16,17,18,19,20,21,22,23]))),Rp=be(()=>ue(()=>import("./dk5wzkmw29stdxh7.js"),__vite__mapDeps([84,1,2,3,5,6]))),Ap=be(()=>ue(()=>import("./g5k1tdwslualrsxd.js"),__vite__mapDeps([85,1,2,3,5,6,12,7,13,14,15,16,17,18,19,20,21,22,23]))),vp=be(()=>ue(()=>import("./njxl8rloy69l92h2.js"),__vite__mapDeps([86,1,2,3,5,6,14,7])).then(i=>i.TextMessageEditor)),Bp=be(()=>ue(()=>import("./ggpt85ykxz9xv6kf.js"),__vite__mapDeps([87,1,2,3,5,6,7,65,14,12,13,15,16,17,18,19,20,21,22,23]))),Fp=be(()=>ue(()=>import("./g26qricaohxyll21.js"),__vite__mapDeps([88,1,2,3,5,6,12,7,13,14,15,16,17,18,19,20,21,22,23]))),Pp=be(()=>ue(()=>import("./bck3j7xja3lu93x3.js"),__vite__mapDeps([89,1,2,3,5,6,16,14,7,50,12,13,15,17,18,19,20,21,22,23])).then(i=>i.BrowsingMessage)),Lp=be(()=>ue(()=>import("./ojn3miceavy70dcb.js"),__vite__mapDeps([90,1,2,3,5,6,12,7,13,14,15,16,17,18,19,20,21,22,23])).then(i=>i.SearchResultMessage)),jp=be(()=>ue(()=>import("./oasw20yvrsgthiuf.js"),__vite__mapDeps([91,1,2,3,5,6,16,14,7,64,61])).then(i=>i.GizmoContactsMessage)),zp=be(()=>ue(()=>import("./eo413091ei8e08hn.js"),__vite__mapDeps([92,1,2,3,5,6,16,14,7,12,13,15,17,18,19,20,21,22,23])).then(i=>i.JITPluginMessage));function Km(i){switch(i.type){case z.Text:case z.Debug:return[i.message];case z.MultiText:case z.Browsing:case z.CodeInterpreter:case z.JITPlugin:case z.RetrievalBrowsing:case z.ParallelBrowsing:case z.Dalle:case z.GizmoEditor:case z.SearchResult:case z.GizmoContacts:case z.a8km123:case z.f959b8c:case z.Canmore:case z.Jawbone:case z.SearchGPTQuery:return i.messages;default:throw new Error("Bad")}}function Ym({groupedMessagesToRender:i,allGroupedMessages:e,clientThreadId:t,isEditing:n,isUserTurn:s,isCompletionRequestInProgress:r,isFeedbackEnabled:o,isFinalTurn:a,turnIndex:l,hasActiveRequest:d,showEditButton:u=!1,handleEnterEdit:m,handleExitEdit:p,onChangeItemInView:k,onRequestMoreCompletions:y,onRequestCompletion:w,shouldGrowContainer:C=!0}){const{showDebugConversationTurns:N}=Yl(),O=ns(t),F=e.some(M=>Ql.includes(M.type)),L=i.map((M,R)=>{var j,D,W,$,ae,Se,Ue,De,Ie,ce,fe,Re,Ae;const U=R===e.length-1;switch(M.type){case z.Text:case z.MultiText:{const I=i[R-1],E=I==null?void 0:I.type,pe=I&&"messages"in I?I.messages:void 0;if(M.type===z.Text){const Pe=(M==null?void 0:M.message)&&!Gr(M.message.message),de=n?x.jsx(vp,{message:M.message,clientThreadId:t,onChangeItemInView:k,onRequestCompletion:w,onRequestMoreCompletions:y,onExitEdit:p,disabled:d}):F&&Pe?null:x.jsx(cp,{className:"min-h-8",message:M.message,isFeedbackEnabled:o,isCompletionInProgress:U&&r,turnIndex:l,clientThreadId:t,showEditButton:u,onEnterEdit:m,isUserTurn:s,onRequestMoreCompletions:y,prevGroupedMessageType:E,prevGroupedMessages:pe});return x.jsxs(B.Fragment,{children:[de,x.jsx(Zl,{isUserTurn:s,message:M.message.message})]},"group-"+M.message.nodeId)}else return M.type===z.MultiText?x.jsx(Ap,{clientThreadId:t,messages:M.messages,isCompletionInProgress:U&&r,isFeedbackEnabled:o,onRequestMoreCompletions:y,prevGroupedMessageType:E,prevGroupedMessages:pe},"multitext-"+(((j=M.messages[0])==null?void 0:j.nodeId)??R)):M.type}case z.Browsing:case z.RetrievalBrowsing:{const I=O!=null&&[je.GizmoInteraction,je.GizmoMagicCreate,je.GizmoTest].includes(O.kind);return x.jsx(Pp,{messages:M.messages,isRequestActive:d,isLastMessageInTurn:U,isUsingGizmo:I,isRetrieval:M.type===z.RetrievalBrowsing},"browsing-"+(((D=M.messages[0])==null?void 0:D.nodeId)??R))}case z.SearchGPTQuery:{const I=e[R+1];return x.jsx(Ip,{isRequestActive:d,isLastMessage:U,nextMessage:I&&I.type===z.Text?I.message:void 0},"searchquery-"+(((W=M.messages[0])==null?void 0:W.nodeId)??R))}case z.a8km123:return x.jsx(_p,{messages:M.messages,isStreaming:U&&r,clientThreadId:t},"sum-"+((($=M.messages[0])==null?void 0:$.nodeId)??R));case z.f959b8c:return null;case z.Jawbone:{const I=R+1<e.length?e[R+1]:void 0;return x.jsx(Op,{nextMessage:I&&I.type===z.Text?I.message:void 0,isLastMessage:U,isRequestActive:d},"jawbone-"+(((ae=M.messages[0])==null?void 0:ae.nodeId)??R))}case z.ParallelBrowsing:return x.jsx(Fp,{messages:M.messages},"parallel-"+(((Se=M.messages[0])==null?void 0:Se.nodeId)??R));case z.CodeInterpreter:return x.jsx(Cp,{messages:M.messages,isRequestActive:d,clientThreadId:t},"ada-"+(((Ue=M.messages[0])==null?void 0:Ue.nodeId)??R));case z.JITPlugin:return x.jsx(zp,{messages:M.messages,clientThreadId:t,isLastTurnInConversation:a,onRequestCompletion:w},"jit-"+(((De=M.messages[0])==null?void 0:De.nodeId)??R));case z.GizmoContacts:return x.jsx(jp,{messages:M.messages,clientThreadId:t,isLastTurnInConversation:a,onRequestCompletion:w},"gizmo-contacts-"+(((Ie=M.messages[0])==null?void 0:Ie.nodeId)??R));case z.Dalle:return x.jsx(Bp,{messages:M.messages,clientThreadId:t},"dalle-"+(((ce=M.messages[0])==null?void 0:ce.nodeId)??R));case z.GizmoEditor:return x.jsx(Dp,{messages:M.messages},"gizmo-editor-"+(((fe=M.messages[0])==null?void 0:fe.nodeId)??R));case z.Canmore:return x.jsx(vf,{messages:M.messages,isRequestActive:d},"canmore-"+(((Re=M.messages[0])==null?void 0:Re.nodeId)??R));case z.Debug:return N?x.jsx(Rp,{message:M.message},"debug-"+M.message.nodeId):null;case z.SearchResult:return x.jsx(Lp,{messages:M.messages},"search-result-"+(((Ae=M.messages[0])==null?void 0:Ae.nodeId)??R))}});return x.jsx(Up,{shouldGrowContainer:C,children:L})}function Vp(){return x.jsx(Xl,{type:"danger",children:x.jsx(re,{id:"daIg0P",defaultMessage:"Unable to display this message due to a error."})})}function Up({children:i,shouldGrowContainer:e}){return x.jsx("div",{className:ne({"flex max-w-full flex-col":!0,"flex-grow":e}),children:x.jsx(Vc,{name:"GroupedMessages",fallback:Vp,children:i})})}function qp(i){return i==null||[je.PrimaryAssistant,je.GizmoInteraction].includes(i.kind)}function Qm(i,e){const t=ns(i,e),{data:n}=xd(t!=null&&"gizmo_id"in t?t.gizmo_id:void 0,(t==null?void 0:t.kind)===je.GizmoTest);if(t!=null)switch(t.kind){case je.GizmoInteraction:case je.GizmoMagicCreate:case je.GizmoTest:return{gizmo:n,...t};case je.PrimaryAssistant:return t}}function Wp(i,e,t){const s=P.getTree(e).getMessageId(P.getThreadCurrentLeafId(e));ht.generateTitle(e,s,t).then(({title:r})=>{P.setTitle(e,r,ro.Generated),ao(i),$e.logEvent(_e.renameThread,{threadId:e,content:r,model:t})}).catch(He.addError)}function Zm(i,e,t){const n=()=>{const r=Os(t);i(r)},s=Di.getGizmoId(t);s!=null?kd(e,s).then(r=>{ec(Os(t,r))}).catch(r=>{He.addError(r),n()}):n()}const $i={onCreate(i,e,t,n){$e.logEvent(_e.newThread),!n&&qp(Di.getConversationMode(e))&&to(t).then(s=>{no(s)||(ao(t),i(e))})},onCreateFinished(i,e,t){var n;if(!(t||!e)&&!Yn.checkGate("2562876640")){const s=(n=Di.getThread(e))==null?void 0:n.initialThreadData.lastModelUsed;s==null&&He.addError("missing lastModelUsed on conversation create finished"),Wp(i,e,s)}}};function Fr(i,e){i.updateNodeMetadata(e.id,{completionSampleFinishTime:Date.now()})}class Hp{constructor(e,t,n,s,r,o,a,l,d,u,m,p){H(this,"currentTree");H(this,"currentNodeId");H(this,"firstResponse",!0);H(this,"didCreateFirstCompletionInNewThread",!1);H(this,"activeBranchLastMessage");H(this,"messagesToUpdate",{});H(this,"allIncompleteStreamedMessages",{});H(this,"responseThreadId");H(this,"isCompletionBlocked",!1);H(this,"isEitherFlagged",!1);H(this,"variantsInStreamInfo");H(this,"activeBranchNodeId");H(this,"blurDuringCompletionTracker",new nc);H(this,"completionLatencyTracker");H(this,"turnTracker");H(this,"debouncedUpdateCompletion",ic(()=>{this.isCompletionBlocked||P.updateTree(this.clientThreadId,e=>{Object.values(this.messagesToUpdate).forEach(t=>{e.updateNodeMessage(t.id,t)})}),this.messagesToUpdate={}},50,{leading:!0,maxWait:50}));H(this,"handleResponse",async e=>{if(this.turnTracker.onUpdateEventCount(),this.completionLatencyTracker.onResponse(e,this.activeBranchLastMessage,this.responseThreadId),this.responseThreadId===void 0&&"conversationId"in e){const t=e.conversationId;this.responseThreadId=t,is(this.clientThreadId)&&P.getServerThreadId(this.clientThreadId)!==t&&(P.setServerIdForNewThread(this.clientThreadId,t),$e.logEvent(_e.attributeClientThreadToServerThread,{client_thread_id:this.clientThreadId,server_thread_id:t}))}switch(e.type){case"error":this.handleError(e);break;case"num_variants_in_stream":this.bindVariantInfoToTree(e);break;case"moderation":this.handleModeration(e);break;case"url_moderation":this.handleUrlModeration(e);break;case"message":this.handleMessage(e),this.debouncedUpdateCompletion();break;case"done":this.handleDone();break;case"gizmo_inline_review":this.handleGizmoInlineReview(e);break;case"title_generation":this.handleTitleGeneration(e);break;case"conversation_detail_metadata":this.handleConversationDetailMetadata(e);break}});this.queryClient=e,this.clientThreadId=t,this.targetNodeId=n,this.completionType=s,this.model=r,this.eventSource=o,this.onCreate=a,this.callModelAgain=d,this.onCompletionFinished=u,this.isHistoryAndTrainingDisabled=p,this.currentTree=P.getTree(t),this.currentNodeId=n,this.activeBranchLastMessage=this.currentTree.getMessage(this.currentNodeId),this.completionLatencyTracker=new tc(l),this.turnTracker=m,this.turnTracker.onCompletionStarted(s,this.model)}handleError(e){const t=e.error,n=(t==null?void 0:t.message)||"Something went wrong",s=t instanceof lt&&t.code||"",r=t instanceof lt&&t.status,o=t instanceof lt?t.canRetry:void 0;switch(this.turnTracker.handleRawError(n,r),P.updateTree(this.clientThreadId,a=>{a.updateNodeMessage(this.currentNodeId,this.activeBranchLastMessage),a.updateNodeMetadata(this.currentNodeId,{err:n,errType:"danger",errCode:s,completionSampleFinishTime:Date.now(),canRetry:o})}),s){case ct.ContentPolicy:case ct.ContentOrTos:case Mi:case Qr:break;default:n!==void 0&&Yn.logEvent("chatgpt_conversation_error_web",n)}this.blurDuringCompletionTracker.onMessageError(),this.cleanUp(),this.onCompletionFinished(this.responseThreadId),t instanceof lt&&(t==null?void 0:t.code)===Mi&&(t!=null&&t.clearsIn)&&(sc(new Date(Date.now()+t.clearsIn*1e3).toISOString()),setTimeout(()=>{rc()},t.clearsIn*1e3))}handleGizmoInlineReview(e){P.setPromptGptRating(this.clientThreadId,e.gizmoId)}handleTitleGeneration(e){P.setTitle(this.clientThreadId,e.title,ro.Generated)}handleConversationDetailMetadata(e){const{default_model_slug:t}=e;t&&P.setThreadModelId(this.clientThreadId,t),Ni.updateDetails(e)}bindVariantInfoToTree(e){this.variantsInStreamInfo=e,P.updateTree(this.clientThreadId,t=>{const n=t.getParentPromptNode(this.currentNodeId);t.updateNodeMetadata(n.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}handleModeration(e){const{isCompletion:t,messageId:n,conversationId:s,flagged:r,blocked:o,disclaimers:a,metadata:l}=e,d=!!(a!=null&&a.length)&&t;(r||o||d)&&(this.isEitherFlagged=!0,o&&t&&(this.isCompletionBlocked=!0),P.updateTree(this.clientThreadId,u=>{const m=u.messageIdToNodeId(n);o&&u.clearNodeMessageParts(m),u.updateNodeMetadata(m,{...(d&&!!(a!=null&&a.length)&&oc(a,o))??{},...r&&ac,...o&&(l!=null&&l.model_incompatibility?lc:cc),completionSampleFinishTime:Date.now()})}),$e.logEvent(t?o?_e.completionBlockedByModeration:_e.completionFlaggedByModeration:o?_e.promptBlockedByModeration:_e.promptFlaggedByModeration,{threadId:s,id:n}))}handleUrlModeration(e){const{conversationId:t,url:n,isSafe:s}=e;s&&P.addThreadSafeUrl(t,n)}handleMessage(e){var r,o,a,l,d,u,m,p,k,y,w,C,N;let t=!0;const{message:n,conversationId:s}=e;if((n==null?void 0:n.author.role)===ot.Tool?this.turnTracker.onMessageUpdate((r=n.metadata)==null?void 0:r.model_slug,(o=n.metadata)==null?void 0:o.gizmo_id,n.author.name):this.turnTracker.onMessageUpdate((a=n.metadata)==null?void 0:a.model_slug,(l=n.metadata)==null?void 0:l.gizmo_id,void 0),this.firstResponse&&!this.currentTree.hasReceivedServerCompletion){if((n==null?void 0:n.author.role)===ot.System){const O=(d=n.metadata)!=null&&d.parent_id?this.currentTree.getNodeByIdOrMessageId(n.metadata.parent_id):void 0;if((O==null?void 0:O.message.author.role)!==ot.User){this.currentTree.appendSystemMessageToRoot(n);return}}else if((n==null?void 0:n.author.role)===ot.User)return;if(this.currentTree.hasNodeOrMessageId(n.id))return}if(this.firstResponse&&((u=n.metadata)!=null&&u.rebase_system_message)){P.updateTree(this.clientThreadId,O=>{var L;if(((L=n.metadata)==null?void 0:L.parent_id)==null)throw Error("Unexpected rebased system message without parent");const F=O.getNodeByIdOrMessageId(this.targetNodeId);O.deleteNode(this.targetNodeId),O.addNode(n.id,n,n.metadata.parent_id,n.author.role),O.addNode(F.id,F.message,n.id,F.message.author.role)});return}if(this.firstResponse){const O=((m=Pn.getState().threads[this.clientThreadId])==null?void 0:m.continuingFromSharedConversationId)!=null;P.removeContinuingFromSharedConversationId(this.clientThreadId),this.firstResponse=!1,this.didCreateFirstCompletionInNewThread=!this.currentTree.hasReceivedServerCompletion||O,P.updateTree(this.clientThreadId,L=>{L.updateNodeMessage(this.currentNodeId,n)}),this.didCreateFirstCompletionInNewThread&&$i.onCreate(this.onCreate,s,this.queryClient,this.isHistoryAndTrainingDisabled);const F={id:this.targetNodeId,threadId:s,completionType:this.completionType,eventSource:this.eventSource,model:this.model};if(this.completionType===on.Next){const L=Pn.getState().threads[s],M=(p=L==null?void 0:L.conversationTurns)==null?void 0:p.length,R=(k=L==null?void 0:L.conversationTurns)==null?void 0:k.filter(j=>j.role==ot.User),U=R&&((y=R[R.length-1])==null?void 0:y.messages[0].message);if((U==null?void 0:U.content.content_type)==Kn.Text){const j=U.content.parts.join("").length,D=(R==null?void 0:R.length)??0;F.countConversationTurns=M,F.countUserSubmittedMessages=D,F.countLastUserPromptTextMessageLength=j}}$e.logEvent(_e.generateCompletion,F)}else if(this.completionType!==on.Continue){const O=this.currentTree.containsNodeOrMessageId(n.id),F=(w=n.metadata)==null?void 0:w.parent_id;if(O||(this.debouncedUpdateCompletion.flush(),P.updateTree(this.clientThreadId,L=>{if(F==null)throw new Error(`Received a message with no parentId: ${JSON.stringify(n)}`);L.addNode(n.id,n,F,ot.Assistant)})),F!=null&&F===this.activeBranchNodeId){const L=this.allIncompleteStreamedMessages[F];L!=null&&(P.updateTree(this.clientThreadId,M=>{Fr(M,L)}),delete this.allIncompleteStreamedMessages[F])}if(t=(((C=this.variantsInStreamInfo)==null?void 0:C.num_variants_in_stream)??1)===1||this.activeBranchNodeId==null||this.activeBranchNodeId===n.id||this.currentTree.isAncestorOfNode(this.activeBranchNodeId,n.id),t&&this.activeBranchNodeId!==n.id){this.activeBranchNodeId=n.id,this.currentNodeId=n.id;const L=P.getThreadCurrentLeafId(this.clientThreadId);this.currentTree.messageIdToNodeId(this.currentNodeId)!==this.currentTree.messageIdToNodeId(L)&&P.setThreadCurrentLeafId(this.clientThreadId,this.currentNodeId),F!=null&&P.updateTree(this.clientThreadId,M=>{const R=M.getParentPromptNode(n.id);M.updateNodeMetadata(R.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}}if((n==null?void 0:n.author.role)===ot.Tool&&(n==null?void 0:n.author.name)==="bio"){const O=(N=n.metadata)==null?void 0:N.gizmo_id;setTimeout(()=>{this.queryClient.invalidateQueries({queryKey:dc(O)})},5e3)}t&&(this.activeBranchLastMessage=n),this.messagesToUpdate[n.id]=n,this.allIncompleteStreamedMessages[n.id]=n}async handleDone(){var e,t;if(this.turnTracker.logCompletion({type:Ei.Success}),this.isCompletionBlocked||(this.debouncedUpdateCompletion.flush(),this.isEitherFlagged||(this.didCreateFirstCompletionInNewThread&&$i.onCreateFinished(this.queryClient,this.responseThreadId,this.isHistoryAndTrainingDisabled),this.onCompletionFinished(this.responseThreadId))),P.updateTree(this.clientThreadId,n=>{Object.values(this.allIncompleteStreamedMessages).forEach(s=>{Fr(n,s)})}),Kr.publish({kind:"createConversation",clientThreadId:this.clientThreadId}),this.blurDuringCompletionTracker.onMessageDone(),this.cleanUp(),((t=(e=this.activeBranchLastMessage)==null?void 0:e.metadata)==null?void 0:t.client_actions)!==void 0){const n=await hc(this.clientThreadId,this.activeBranchLastMessage);n.length>0&&this.callModelAgain(this.currentNodeId,n)}}cleanUp(){setTimeout(()=>{Dd(this.clientThreadId,Uc.FINISHED),Qi.removeRequest(this.targetNodeId),P.releaseThread(this.clientThreadId)},0)}}/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(i){const e=uc,t=fc,n=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;i.Buffer=a,i.SlowBuffer=O,i.INSPECT_MAX_BYTES=50;const s=2147483647;i.kMaxLength=s,a.TYPED_ARRAY_SUPPORT=r(),!a.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function r(){try{const f=new Uint8Array(1),c={foo:function(){return 42}};return Object.setPrototypeOf(c,Uint8Array.prototype),Object.setPrototypeOf(f,c),f.foo()===42}catch{return!1}}Object.defineProperty(a.prototype,"parent",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.buffer}}),Object.defineProperty(a.prototype,"offset",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.byteOffset}});function o(f){if(f>s)throw new RangeError('The value "'+f+'" is invalid for option "size"');const c=new Uint8Array(f);return Object.setPrototypeOf(c,a.prototype),c}function a(f,c,h){if(typeof f=="number"){if(typeof c=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return m(f)}return l(f,c,h)}a.poolSize=8192;function l(f,c,h){if(typeof f=="string")return p(f,c);if(ArrayBuffer.isView(f))return y(f);if(f==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof f);if(Qe(f,ArrayBuffer)||f&&Qe(f.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(Qe(f,SharedArrayBuffer)||f&&Qe(f.buffer,SharedArrayBuffer)))return w(f,c,h);if(typeof f=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const g=f.valueOf&&f.valueOf();if(g!=null&&g!==f)return a.from(g,c,h);const b=C(f);if(b)return b;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof f[Symbol.toPrimitive]=="function")return a.from(f[Symbol.toPrimitive]("string"),c,h);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof f)}a.from=function(f,c,h){return l(f,c,h)},Object.setPrototypeOf(a.prototype,Uint8Array.prototype),Object.setPrototypeOf(a,Uint8Array);function d(f){if(typeof f!="number")throw new TypeError('"size" argument must be of type number');if(f<0)throw new RangeError('The value "'+f+'" is invalid for option "size"')}function u(f,c,h){return d(f),f<=0?o(f):c!==void 0?typeof h=="string"?o(f).fill(c,h):o(f).fill(c):o(f)}a.alloc=function(f,c,h){return u(f,c,h)};function m(f){return d(f),o(f<0?0:N(f)|0)}a.allocUnsafe=function(f){return m(f)},a.allocUnsafeSlow=function(f){return m(f)};function p(f,c){if((typeof c!="string"||c==="")&&(c="utf8"),!a.isEncoding(c))throw new TypeError("Unknown encoding: "+c);const h=F(f,c)|0;let g=o(h);const b=g.write(f,c);return b!==h&&(g=g.slice(0,b)),g}function k(f){const c=f.length<0?0:N(f.length)|0,h=o(c);for(let g=0;g<c;g+=1)h[g]=f[g]&255;return h}function y(f){if(Qe(f,Uint8Array)){const c=new Uint8Array(f);return w(c.buffer,c.byteOffset,c.byteLength)}return k(f)}function w(f,c,h){if(c<0||f.byteLength<c)throw new RangeError('"offset" is outside of buffer bounds');if(f.byteLength<c+(h||0))throw new RangeError('"length" is outside of buffer bounds');let g;return c===void 0&&h===void 0?g=new Uint8Array(f):h===void 0?g=new Uint8Array(f,c):g=new Uint8Array(f,c,h),Object.setPrototypeOf(g,a.prototype),g}function C(f){if(a.isBuffer(f)){const c=N(f.length)|0,h=o(c);return h.length===0||f.copy(h,0,0,c),h}if(f.length!==void 0)return typeof f.length!="number"||oi(f.length)?o(0):k(f);if(f.type==="Buffer"&&Array.isArray(f.data))return k(f.data)}function N(f){if(f>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return f|0}function O(f){return+f!=f&&(f=0),a.alloc(+f)}a.isBuffer=function(c){return c!=null&&c._isBuffer===!0&&c!==a.prototype},a.compare=function(c,h){if(Qe(c,Uint8Array)&&(c=a.from(c,c.offset,c.byteLength)),Qe(h,Uint8Array)&&(h=a.from(h,h.offset,h.byteLength)),!a.isBuffer(c)||!a.isBuffer(h))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(c===h)return 0;let g=c.length,b=h.length;for(let S=0,T=Math.min(g,b);S<T;++S)if(c[S]!==h[S]){g=c[S],b=h[S];break}return g<b?-1:b<g?1:0},a.isEncoding=function(c){switch(String(c).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},a.concat=function(c,h){if(!Array.isArray(c))throw new TypeError('"list" argument must be an Array of Buffers');if(c.length===0)return a.alloc(0);let g;if(h===void 0)for(h=0,g=0;g<c.length;++g)h+=c[g].length;const b=a.allocUnsafe(h);let S=0;for(g=0;g<c.length;++g){let T=c[g];if(Qe(T,Uint8Array))S+T.length>b.length?(a.isBuffer(T)||(T=a.from(T)),T.copy(b,S)):Uint8Array.prototype.set.call(b,T,S);else if(a.isBuffer(T))T.copy(b,S);else throw new TypeError('"list" argument must be an Array of Buffers');S+=T.length}return b};function F(f,c){if(a.isBuffer(f))return f.length;if(ArrayBuffer.isView(f)||Qe(f,ArrayBuffer))return f.byteLength;if(typeof f!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof f);const h=f.length,g=arguments.length>2&&arguments[2]===!0;if(!g&&h===0)return 0;let b=!1;for(;;)switch(c){case"ascii":case"latin1":case"binary":return h;case"utf8":case"utf-8":return Zt(f).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return h*2;case"hex":return h>>>1;case"base64":return Pt(f).length;default:if(b)return g?-1:Zt(f).length;c=(""+c).toLowerCase(),b=!0}}a.byteLength=F;function L(f,c,h){let g=!1;if((c===void 0||c<0)&&(c=0),c>this.length||((h===void 0||h>this.length)&&(h=this.length),h<=0)||(h>>>=0,c>>>=0,h<=c))return"";for(f||(f="utf8");;)switch(f){case"hex":return Re(this,c,h);case"utf8":case"utf-8":return Ue(this,c,h);case"ascii":return ce(this,c,h);case"latin1":case"binary":return fe(this,c,h);case"base64":return Se(this,c,h);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Ae(this,c,h);default:if(g)throw new TypeError("Unknown encoding: "+f);f=(f+"").toLowerCase(),g=!0}}a.prototype._isBuffer=!0;function M(f,c,h){const g=f[c];f[c]=f[h],f[h]=g}a.prototype.swap16=function(){const c=this.length;if(c%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let h=0;h<c;h+=2)M(this,h,h+1);return this},a.prototype.swap32=function(){const c=this.length;if(c%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let h=0;h<c;h+=4)M(this,h,h+3),M(this,h+1,h+2);return this},a.prototype.swap64=function(){const c=this.length;if(c%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let h=0;h<c;h+=8)M(this,h,h+7),M(this,h+1,h+6),M(this,h+2,h+5),M(this,h+3,h+4);return this},a.prototype.toString=function(){const c=this.length;return c===0?"":arguments.length===0?Ue(this,0,c):L.apply(this,arguments)},a.prototype.toLocaleString=a.prototype.toString,a.prototype.equals=function(c){if(!a.isBuffer(c))throw new TypeError("Argument must be a Buffer");return this===c?!0:a.compare(this,c)===0},a.prototype.inspect=function(){let c="";const h=i.INSPECT_MAX_BYTES;return c=this.toString("hex",0,h).replace(/(.{2})/g,"$1 ").trim(),this.length>h&&(c+=" ... "),"<Buffer "+c+">"},n&&(a.prototype[n]=a.prototype.inspect),a.prototype.compare=function(c,h,g,b,S){if(Qe(c,Uint8Array)&&(c=a.from(c,c.offset,c.byteLength)),!a.isBuffer(c))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof c);if(h===void 0&&(h=0),g===void 0&&(g=c?c.length:0),b===void 0&&(b=0),S===void 0&&(S=this.length),h<0||g>c.length||b<0||S>this.length)throw new RangeError("out of range index");if(b>=S&&h>=g)return 0;if(b>=S)return-1;if(h>=g)return 1;if(h>>>=0,g>>>=0,b>>>=0,S>>>=0,this===c)return 0;let T=S-b,V=g-h;const ie=Math.min(T,V),Z=this.slice(b,S),se=c.slice(h,g);for(let K=0;K<ie;++K)if(Z[K]!==se[K]){T=Z[K],V=se[K];break}return T<V?-1:V<T?1:0};function R(f,c,h,g,b){if(f.length===0)return-1;if(typeof h=="string"?(g=h,h=0):h>2147483647?h=2147483647:h<-2147483648&&(h=-2147483648),h=+h,oi(h)&&(h=b?0:f.length-1),h<0&&(h=f.length+h),h>=f.length){if(b)return-1;h=f.length-1}else if(h<0)if(b)h=0;else return-1;if(typeof c=="string"&&(c=a.from(c,g)),a.isBuffer(c))return c.length===0?-1:U(f,c,h,g,b);if(typeof c=="number")return c=c&255,typeof Uint8Array.prototype.indexOf=="function"?b?Uint8Array.prototype.indexOf.call(f,c,h):Uint8Array.prototype.lastIndexOf.call(f,c,h):U(f,[c],h,g,b);throw new TypeError("val must be string, number or Buffer")}function U(f,c,h,g,b){let S=1,T=f.length,V=c.length;if(g!==void 0&&(g=String(g).toLowerCase(),g==="ucs2"||g==="ucs-2"||g==="utf16le"||g==="utf-16le")){if(f.length<2||c.length<2)return-1;S=2,T/=2,V/=2,h/=2}function ie(se,K){return S===1?se[K]:se.readUInt16BE(K*S)}let Z;if(b){let se=-1;for(Z=h;Z<T;Z++)if(ie(f,Z)===ie(c,se===-1?0:Z-se)){if(se===-1&&(se=Z),Z-se+1===V)return se*S}else se!==-1&&(Z-=Z-se),se=-1}else for(h+V>T&&(h=T-V),Z=h;Z>=0;Z--){let se=!0;for(let K=0;K<V;K++)if(ie(f,Z+K)!==ie(c,K)){se=!1;break}if(se)return Z}return-1}a.prototype.includes=function(c,h,g){return this.indexOf(c,h,g)!==-1},a.prototype.indexOf=function(c,h,g){return R(this,c,h,g,!0)},a.prototype.lastIndexOf=function(c,h,g){return R(this,c,h,g,!1)};function j(f,c,h,g){h=Number(h)||0;const b=f.length-h;g?(g=Number(g),g>b&&(g=b)):g=b;const S=c.length;g>S/2&&(g=S/2);let T;for(T=0;T<g;++T){const V=parseInt(c.substr(T*2,2),16);if(oi(V))return T;f[h+T]=V}return T}function D(f,c,h,g){return Cn(Zt(c,f.length-h),f,h,g)}function W(f,c,h,g){return Cn(si(c),f,h,g)}function $(f,c,h,g){return Cn(Pt(c),f,h,g)}function ae(f,c,h,g){return Cn(ri(c,f.length-h),f,h,g)}a.prototype.write=function(c,h,g,b){if(h===void 0)b="utf8",g=this.length,h=0;else if(g===void 0&&typeof h=="string")b=h,g=this.length,h=0;else if(isFinite(h))h=h>>>0,isFinite(g)?(g=g>>>0,b===void 0&&(b="utf8")):(b=g,g=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const S=this.length-h;if((g===void 0||g>S)&&(g=S),c.length>0&&(g<0||h<0)||h>this.length)throw new RangeError("Attempt to write outside buffer bounds");b||(b="utf8");let T=!1;for(;;)switch(b){case"hex":return j(this,c,h,g);case"utf8":case"utf-8":return D(this,c,h,g);case"ascii":case"latin1":case"binary":return W(this,c,h,g);case"base64":return $(this,c,h,g);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ae(this,c,h,g);default:if(T)throw new TypeError("Unknown encoding: "+b);b=(""+b).toLowerCase(),T=!0}},a.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function Se(f,c,h){return c===0&&h===f.length?e.fromByteArray(f):e.fromByteArray(f.slice(c,h))}function Ue(f,c,h){h=Math.min(f.length,h);const g=[];let b=c;for(;b<h;){const S=f[b];let T=null,V=S>239?4:S>223?3:S>191?2:1;if(b+V<=h){let ie,Z,se,K;switch(V){case 1:S<128&&(T=S);break;case 2:ie=f[b+1],(ie&192)===128&&(K=(S&31)<<6|ie&63,K>127&&(T=K));break;case 3:ie=f[b+1],Z=f[b+2],(ie&192)===128&&(Z&192)===128&&(K=(S&15)<<12|(ie&63)<<6|Z&63,K>2047&&(K<55296||K>57343)&&(T=K));break;case 4:ie=f[b+1],Z=f[b+2],se=f[b+3],(ie&192)===128&&(Z&192)===128&&(se&192)===128&&(K=(S&15)<<18|(ie&63)<<12|(Z&63)<<6|se&63,K>65535&&K<1114112&&(T=K))}}T===null?(T=65533,V=1):T>65535&&(T-=65536,g.push(T>>>10&1023|55296),T=56320|T&1023),g.push(T),b+=V}return Ie(g)}const De=4096;function Ie(f){const c=f.length;if(c<=De)return String.fromCharCode.apply(String,f);let h="",g=0;for(;g<c;)h+=String.fromCharCode.apply(String,f.slice(g,g+=De));return h}function ce(f,c,h){let g="";h=Math.min(f.length,h);for(let b=c;b<h;++b)g+=String.fromCharCode(f[b]&127);return g}function fe(f,c,h){let g="";h=Math.min(f.length,h);for(let b=c;b<h;++b)g+=String.fromCharCode(f[b]);return g}function Re(f,c,h){const g=f.length;(!c||c<0)&&(c=0),(!h||h<0||h>g)&&(h=g);let b="";for(let S=c;S<h;++S)b+=_a[f[S]];return b}function Ae(f,c,h){const g=f.slice(c,h);let b="";for(let S=0;S<g.length-1;S+=2)b+=String.fromCharCode(g[S]+g[S+1]*256);return b}a.prototype.slice=function(c,h){const g=this.length;c=~~c,h=h===void 0?g:~~h,c<0?(c+=g,c<0&&(c=0)):c>g&&(c=g),h<0?(h+=g,h<0&&(h=0)):h>g&&(h=g),h<c&&(h=c);const b=this.subarray(c,h);return Object.setPrototypeOf(b,a.prototype),b};function I(f,c,h){if(f%1!==0||f<0)throw new RangeError("offset is not uint");if(f+c>h)throw new RangeError("Trying to access beyond buffer length")}a.prototype.readUintLE=a.prototype.readUIntLE=function(c,h,g){c=c>>>0,h=h>>>0,g||I(c,h,this.length);let b=this[c],S=1,T=0;for(;++T<h&&(S*=256);)b+=this[c+T]*S;return b},a.prototype.readUintBE=a.prototype.readUIntBE=function(c,h,g){c=c>>>0,h=h>>>0,g||I(c,h,this.length);let b=this[c+--h],S=1;for(;h>0&&(S*=256);)b+=this[c+--h]*S;return b},a.prototype.readUint8=a.prototype.readUInt8=function(c,h){return c=c>>>0,h||I(c,1,this.length),this[c]},a.prototype.readUint16LE=a.prototype.readUInt16LE=function(c,h){return c=c>>>0,h||I(c,2,this.length),this[c]|this[c+1]<<8},a.prototype.readUint16BE=a.prototype.readUInt16BE=function(c,h){return c=c>>>0,h||I(c,2,this.length),this[c]<<8|this[c+1]},a.prototype.readUint32LE=a.prototype.readUInt32LE=function(c,h){return c=c>>>0,h||I(c,4,this.length),(this[c]|this[c+1]<<8|this[c+2]<<16)+this[c+3]*16777216},a.prototype.readUint32BE=a.prototype.readUInt32BE=function(c,h){return c=c>>>0,h||I(c,4,this.length),this[c]*16777216+(this[c+1]<<16|this[c+2]<<8|this[c+3])},a.prototype.readBigUInt64LE=ut(function(c){c=c>>>0,te(c,"offset");const h=this[c],g=this[c+7];(h===void 0||g===void 0)&&Ce(c,this.length-8);const b=h+this[++c]*2**8+this[++c]*2**16+this[++c]*2**24,S=this[++c]+this[++c]*2**8+this[++c]*2**16+g*2**24;return BigInt(b)+(BigInt(S)<<BigInt(32))}),a.prototype.readBigUInt64BE=ut(function(c){c=c>>>0,te(c,"offset");const h=this[c],g=this[c+7];(h===void 0||g===void 0)&&Ce(c,this.length-8);const b=h*2**24+this[++c]*2**16+this[++c]*2**8+this[++c],S=this[++c]*2**24+this[++c]*2**16+this[++c]*2**8+g;return(BigInt(b)<<BigInt(32))+BigInt(S)}),a.prototype.readIntLE=function(c,h,g){c=c>>>0,h=h>>>0,g||I(c,h,this.length);let b=this[c],S=1,T=0;for(;++T<h&&(S*=256);)b+=this[c+T]*S;return S*=128,b>=S&&(b-=Math.pow(2,8*h)),b},a.prototype.readIntBE=function(c,h,g){c=c>>>0,h=h>>>0,g||I(c,h,this.length);let b=h,S=1,T=this[c+--b];for(;b>0&&(S*=256);)T+=this[c+--b]*S;return S*=128,T>=S&&(T-=Math.pow(2,8*h)),T},a.prototype.readInt8=function(c,h){return c=c>>>0,h||I(c,1,this.length),this[c]&128?(255-this[c]+1)*-1:this[c]},a.prototype.readInt16LE=function(c,h){c=c>>>0,h||I(c,2,this.length);const g=this[c]|this[c+1]<<8;return g&32768?g|4294901760:g},a.prototype.readInt16BE=function(c,h){c=c>>>0,h||I(c,2,this.length);const g=this[c+1]|this[c]<<8;return g&32768?g|4294901760:g},a.prototype.readInt32LE=function(c,h){return c=c>>>0,h||I(c,4,this.length),this[c]|this[c+1]<<8|this[c+2]<<16|this[c+3]<<24},a.prototype.readInt32BE=function(c,h){return c=c>>>0,h||I(c,4,this.length),this[c]<<24|this[c+1]<<16|this[c+2]<<8|this[c+3]},a.prototype.readBigInt64LE=ut(function(c){c=c>>>0,te(c,"offset");const h=this[c],g=this[c+7];(h===void 0||g===void 0)&&Ce(c,this.length-8);const b=this[c+4]+this[c+5]*2**8+this[c+6]*2**16+(g<<24);return(BigInt(b)<<BigInt(32))+BigInt(h+this[++c]*2**8+this[++c]*2**16+this[++c]*2**24)}),a.prototype.readBigInt64BE=ut(function(c){c=c>>>0,te(c,"offset");const h=this[c],g=this[c+7];(h===void 0||g===void 0)&&Ce(c,this.length-8);const b=(h<<24)+this[++c]*2**16+this[++c]*2**8+this[++c];return(BigInt(b)<<BigInt(32))+BigInt(this[++c]*2**24+this[++c]*2**16+this[++c]*2**8+g)}),a.prototype.readFloatLE=function(c,h){return c=c>>>0,h||I(c,4,this.length),t.read(this,c,!0,23,4)},a.prototype.readFloatBE=function(c,h){return c=c>>>0,h||I(c,4,this.length),t.read(this,c,!1,23,4)},a.prototype.readDoubleLE=function(c,h){return c=c>>>0,h||I(c,8,this.length),t.read(this,c,!0,52,8)},a.prototype.readDoubleBE=function(c,h){return c=c>>>0,h||I(c,8,this.length),t.read(this,c,!1,52,8)};function E(f,c,h,g,b,S){if(!a.isBuffer(f))throw new TypeError('"buffer" argument must be a Buffer instance');if(c>b||c<S)throw new RangeError('"value" argument is out of bounds');if(h+g>f.length)throw new RangeError("Index out of range")}a.prototype.writeUintLE=a.prototype.writeUIntLE=function(c,h,g,b){if(c=+c,h=h>>>0,g=g>>>0,!b){const V=Math.pow(2,8*g)-1;E(this,c,h,g,V,0)}let S=1,T=0;for(this[h]=c&255;++T<g&&(S*=256);)this[h+T]=c/S&255;return h+g},a.prototype.writeUintBE=a.prototype.writeUIntBE=function(c,h,g,b){if(c=+c,h=h>>>0,g=g>>>0,!b){const V=Math.pow(2,8*g)-1;E(this,c,h,g,V,0)}let S=g-1,T=1;for(this[h+S]=c&255;--S>=0&&(T*=256);)this[h+S]=c/T&255;return h+g},a.prototype.writeUint8=a.prototype.writeUInt8=function(c,h,g){return c=+c,h=h>>>0,g||E(this,c,h,1,255,0),this[h]=c&255,h+1},a.prototype.writeUint16LE=a.prototype.writeUInt16LE=function(c,h,g){return c=+c,h=h>>>0,g||E(this,c,h,2,65535,0),this[h]=c&255,this[h+1]=c>>>8,h+2},a.prototype.writeUint16BE=a.prototype.writeUInt16BE=function(c,h,g){return c=+c,h=h>>>0,g||E(this,c,h,2,65535,0),this[h]=c>>>8,this[h+1]=c&255,h+2},a.prototype.writeUint32LE=a.prototype.writeUInt32LE=function(c,h,g){return c=+c,h=h>>>0,g||E(this,c,h,4,4294967295,0),this[h+3]=c>>>24,this[h+2]=c>>>16,this[h+1]=c>>>8,this[h]=c&255,h+4},a.prototype.writeUint32BE=a.prototype.writeUInt32BE=function(c,h,g){return c=+c,h=h>>>0,g||E(this,c,h,4,4294967295,0),this[h]=c>>>24,this[h+1]=c>>>16,this[h+2]=c>>>8,this[h+3]=c&255,h+4};function pe(f,c,h,g,b){A(c,g,b,f,h,7);let S=Number(c&BigInt(4294967295));f[h++]=S,S=S>>8,f[h++]=S,S=S>>8,f[h++]=S,S=S>>8,f[h++]=S;let T=Number(c>>BigInt(32)&BigInt(4294967295));return f[h++]=T,T=T>>8,f[h++]=T,T=T>>8,f[h++]=T,T=T>>8,f[h++]=T,h}function Pe(f,c,h,g,b){A(c,g,b,f,h,7);let S=Number(c&BigInt(4294967295));f[h+7]=S,S=S>>8,f[h+6]=S,S=S>>8,f[h+5]=S,S=S>>8,f[h+4]=S;let T=Number(c>>BigInt(32)&BigInt(4294967295));return f[h+3]=T,T=T>>8,f[h+2]=T,T=T>>8,f[h+1]=T,T=T>>8,f[h]=T,h+8}a.prototype.writeBigUInt64LE=ut(function(c,h=0){return pe(this,c,h,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeBigUInt64BE=ut(function(c,h=0){return Pe(this,c,h,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeIntLE=function(c,h,g,b){if(c=+c,h=h>>>0,!b){const ie=Math.pow(2,8*g-1);E(this,c,h,g,ie-1,-ie)}let S=0,T=1,V=0;for(this[h]=c&255;++S<g&&(T*=256);)c<0&&V===0&&this[h+S-1]!==0&&(V=1),this[h+S]=(c/T>>0)-V&255;return h+g},a.prototype.writeIntBE=function(c,h,g,b){if(c=+c,h=h>>>0,!b){const ie=Math.pow(2,8*g-1);E(this,c,h,g,ie-1,-ie)}let S=g-1,T=1,V=0;for(this[h+S]=c&255;--S>=0&&(T*=256);)c<0&&V===0&&this[h+S+1]!==0&&(V=1),this[h+S]=(c/T>>0)-V&255;return h+g},a.prototype.writeInt8=function(c,h,g){return c=+c,h=h>>>0,g||E(this,c,h,1,127,-128),c<0&&(c=255+c+1),this[h]=c&255,h+1},a.prototype.writeInt16LE=function(c,h,g){return c=+c,h=h>>>0,g||E(this,c,h,2,32767,-32768),this[h]=c&255,this[h+1]=c>>>8,h+2},a.prototype.writeInt16BE=function(c,h,g){return c=+c,h=h>>>0,g||E(this,c,h,2,32767,-32768),this[h]=c>>>8,this[h+1]=c&255,h+2},a.prototype.writeInt32LE=function(c,h,g){return c=+c,h=h>>>0,g||E(this,c,h,4,2147483647,-2147483648),this[h]=c&255,this[h+1]=c>>>8,this[h+2]=c>>>16,this[h+3]=c>>>24,h+4},a.prototype.writeInt32BE=function(c,h,g){return c=+c,h=h>>>0,g||E(this,c,h,4,2147483647,-2147483648),c<0&&(c=4294967295+c+1),this[h]=c>>>24,this[h+1]=c>>>16,this[h+2]=c>>>8,this[h+3]=c&255,h+4},a.prototype.writeBigInt64LE=ut(function(c,h=0){return pe(this,c,h,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),a.prototype.writeBigInt64BE=ut(function(c,h=0){return Pe(this,c,h,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function G(f,c,h,g,b,S){if(h+g>f.length)throw new RangeError("Index out of range");if(h<0)throw new RangeError("Index out of range")}function de(f,c,h,g,b){return c=+c,h=h>>>0,b||G(f,c,h,4),t.write(f,c,h,g,23,4),h+4}a.prototype.writeFloatLE=function(c,h,g){return de(this,c,h,!0,g)},a.prototype.writeFloatBE=function(c,h,g){return de(this,c,h,!1,g)};function Ye(f,c,h,g,b){return c=+c,h=h>>>0,b||G(f,c,h,8),t.write(f,c,h,g,52,8),h+8}a.prototype.writeDoubleLE=function(c,h,g){return Ye(this,c,h,!0,g)},a.prototype.writeDoubleBE=function(c,h,g){return Ye(this,c,h,!1,g)},a.prototype.copy=function(c,h,g,b){if(!a.isBuffer(c))throw new TypeError("argument should be a Buffer");if(g||(g=0),!b&&b!==0&&(b=this.length),h>=c.length&&(h=c.length),h||(h=0),b>0&&b<g&&(b=g),b===g||c.length===0||this.length===0)return 0;if(h<0)throw new RangeError("targetStart out of bounds");if(g<0||g>=this.length)throw new RangeError("Index out of range");if(b<0)throw new RangeError("sourceEnd out of bounds");b>this.length&&(b=this.length),c.length-h<b-g&&(b=c.length-h+g);const S=b-g;return this===c&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(h,g,b):Uint8Array.prototype.set.call(c,this.subarray(g,b),h),S},a.prototype.fill=function(c,h,g,b){if(typeof c=="string"){if(typeof h=="string"?(b=h,h=0,g=this.length):typeof g=="string"&&(b=g,g=this.length),b!==void 0&&typeof b!="string")throw new TypeError("encoding must be a string");if(typeof b=="string"&&!a.isEncoding(b))throw new TypeError("Unknown encoding: "+b);if(c.length===1){const T=c.charCodeAt(0);(b==="utf8"&&T<128||b==="latin1")&&(c=T)}}else typeof c=="number"?c=c&255:typeof c=="boolean"&&(c=Number(c));if(h<0||this.length<h||this.length<g)throw new RangeError("Out of range index");if(g<=h)return this;h=h>>>0,g=g===void 0?this.length:g>>>0,c||(c=0);let S;if(typeof c=="number")for(S=h;S<g;++S)this[S]=c;else{const T=a.isBuffer(c)?c:a.from(c,b),V=T.length;if(V===0)throw new TypeError('The value "'+c+'" is invalid for argument "value"');for(S=0;S<g-h;++S)this[S+h]=T[S%V]}return this};const ee={};function me(f,c,h){ee[f]=class extends h{constructor(){super(),Object.defineProperty(this,"message",{value:c.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${f}]`,this.stack,delete this.name}get code(){return f}set code(b){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:b,writable:!0})}toString(){return`${this.name} [${f}]: ${this.message}`}}}me("ERR_BUFFER_OUT_OF_BOUNDS",function(f){return f?`${f} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),me("ERR_INVALID_ARG_TYPE",function(f,c){return`The "${f}" argument must be of type number. Received type ${typeof c}`},TypeError),me("ERR_OUT_OF_RANGE",function(f,c,h){let g=`The value of "${f}" is out of range.`,b=h;return Number.isInteger(h)&&Math.abs(h)>2**32?b=qe(String(h)):typeof h=="bigint"&&(b=String(h),(h>BigInt(2)**BigInt(32)||h<-(BigInt(2)**BigInt(32)))&&(b=qe(b)),b+="n"),g+=` It must be ${c}. Received ${b}`,g},RangeError);function qe(f){let c="",h=f.length;const g=f[0]==="-"?1:0;for(;h>=g+4;h-=3)c=`_${f.slice(h-3,h)}${c}`;return`${f.slice(0,h)}${c}`}function st(f,c,h){te(c,"offset"),(f[c]===void 0||f[c+h]===void 0)&&Ce(c,f.length-(h+1))}function A(f,c,h,g,b,S){if(f>h||f<c){const T=typeof c=="bigint"?"n":"";let V;throw c===0||c===BigInt(0)?V=`>= 0${T} and < 2${T} ** ${(S+1)*8}${T}`:V=`>= -(2${T} ** ${(S+1)*8-1}${T}) and < 2 ** ${(S+1)*8-1}${T}`,new ee.ERR_OUT_OF_RANGE("value",V,f)}st(g,b,S)}function te(f,c){if(typeof f!="number")throw new ee.ERR_INVALID_ARG_TYPE(c,"number",f)}function Ce(f,c,h){throw Math.floor(f)!==f?(te(f,h),new ee.ERR_OUT_OF_RANGE("offset","an integer",f)):c<0?new ee.ERR_BUFFER_OUT_OF_BOUNDS:new ee.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${c}`,f)}const ve=/[^+/0-9A-Za-z-_]/g;function ii(f){if(f=f.split("=")[0],f=f.trim().replace(ve,""),f.length<2)return"";for(;f.length%4!==0;)f=f+"=";return f}function Zt(f,c){c=c||1/0;let h;const g=f.length;let b=null;const S=[];for(let T=0;T<g;++T){if(h=f.charCodeAt(T),h>55295&&h<57344){if(!b){if(h>56319){(c-=3)>-1&&S.push(239,191,189);continue}else if(T+1===g){(c-=3)>-1&&S.push(239,191,189);continue}b=h;continue}if(h<56320){(c-=3)>-1&&S.push(239,191,189),b=h;continue}h=(b-55296<<10|h-56320)+65536}else b&&(c-=3)>-1&&S.push(239,191,189);if(b=null,h<128){if((c-=1)<0)break;S.push(h)}else if(h<2048){if((c-=2)<0)break;S.push(h>>6|192,h&63|128)}else if(h<65536){if((c-=3)<0)break;S.push(h>>12|224,h>>6&63|128,h&63|128)}else if(h<1114112){if((c-=4)<0)break;S.push(h>>18|240,h>>12&63|128,h>>6&63|128,h&63|128)}else throw new Error("Invalid code point")}return S}function si(f){const c=[];for(let h=0;h<f.length;++h)c.push(f.charCodeAt(h)&255);return c}function ri(f,c){let h,g,b;const S=[];for(let T=0;T<f.length&&!((c-=2)<0);++T)h=f.charCodeAt(T),g=h>>8,b=h%256,S.push(b),S.push(g);return S}function Pt(f){return e.toByteArray(ii(f))}function Cn(f,c,h,g){let b;for(b=0;b<g&&!(b+h>=c.length||b>=f.length);++b)c[b+h]=f[b];return b}function Qe(f,c){return f instanceof c||f!=null&&f.constructor!=null&&f.constructor.name!=null&&f.constructor.name===c.name}function oi(f){return f!==f}const _a=function(){const f="0123456789abcdef",c=new Array(256);for(let h=0;h<16;++h){const g=h*16;for(let b=0;b<16;++b)c[g+b]=f[h]+f[b]}return c}();function ut(f){return typeof BigInt>"u"?Oa:f}function Oa(){throw new Error("BigInt not supported")}})(Zi);function Jp(i){if(typeof i!="string")throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!i)throw new Error("No input");const e=JSON.parse(i),t=e;let n;if(t.type==="system")if(t.event==="connected")n=Object.assign(Object.assign({},e),{kind:"connected"});else if(t.event==="disconnected")n=Object.assign(Object.assign({},e),{kind:"disconnected"});else return null;else if(t.type==="message")if(t.from==="group"){const s=Lr(e.data,e.dataType);if(s===null)return null;n=Object.assign(Object.assign({},e),{data:s,kind:"groupData"})}else if(t.from==="server"){const s=Lr(e.data,e.dataType);if(s===null)return null;n=Object.assign(Object.assign({},e),{data:s,kind:"serverData"})}else return null;else if(t.type==="ack")n=Object.assign(Object.assign({},e),{kind:"ack"});else return null;return n}function $p(i){let e;switch(i.kind){case"joinGroup":{e={type:"joinGroup",group:i.group,ackId:i.ackId};break}case"leaveGroup":{e={type:"leaveGroup",group:i.group,ackId:i.ackId};break}case"sendEvent":{e={type:"event",event:i.event,ackId:i.ackId,dataType:i.dataType,data:Pr(i.data,i.dataType)};break}case"sendToGroup":{e={type:"sendToGroup",group:i.group,ackId:i.ackId,dataType:i.dataType,data:Pr(i.data,i.dataType),noEcho:i.noEcho};break}case"sequenceAck":{e={type:"sequenceAck",sequenceId:i.sequenceId};break}default:throw new Error(`Unsupported type: ${i.kind}`)}return JSON.stringify(e)}function Pr(i,e){switch(e){case"text":{if(typeof i!="string")throw new TypeError("Message must be a string.");return i}case"json":return i;case"binary":case"protobuf":{if(i instanceof ArrayBuffer)return Zi.Buffer.from(i).toString("base64");throw new TypeError("Message must be a ArrayBuffer")}}}function Lr(i,e){if(e==="text"){if(typeof i!="string")throw new TypeError("Message must be a string when dataType is text");return i}else{if(e==="json")return i;if(e==="binary"||e==="protobuf"){const t=Zi.Buffer.from(i,"base64");return t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}else return null}}class Gp{constructor(){this.isReliableSubProtocol=!0,this.name="json.reliable.webpubsub.azure.v1"}parseMessages(e){return Jp(e)}writeMessage(e){return $p(e)}}const Kp=()=>new Gp;var Ne;(function(i){i.Stopped="Stopped",i.Disconnected="Disconnected",i.Connecting="Connecting",i.Connected="Connected",i.Recovering="Recovering"})(Ne||(Ne={}));class Yp{nextAckId(){return this._ackId=this._ackId+1,this._ackId}constructor(e,t){this._quickSequenceAckDiff=300,this._activeTimeoutInMs=2e4,this._emitter=new pc,this._isStopping=!1,this._isInitialConnected=!1,typeof e=="string"?this._credential={getClientAccessUrl:e}:this._credential=e,t==null&&(t={}),this._buildDefaultOptions(t),this._options=t,this._messageRetryPolicy=new jr(this._options.messageRetryOptions),this._reconnectRetryPolicy=new jr(this._options.reconnectRetryOptions),this._protocol=this._options.protocol,this._groupMap=new Map,this._ackMap=new Map,this._sequenceId=new Xp,this._state=Ne.Stopped,this._ackId=0}async start(e){if(this._isStopping)throw new Error("Can't start a client during stopping");if(this._state!==Ne.Stopped)throw new Error("Client can be only started when it's Stopped");let t;e&&(t=e.abortSignal),this._activeKeepaliveTask||(this._activeKeepaliveTask=this._getActiveKeepaliveTask());try{await this._startCore(t)}catch(n){throw this._changeState(Ne.Stopped),this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0),this._isStopping=!1,n}}async _startFromRestarting(e){if(this._state!==Ne.Disconnected)throw new Error("Client can be only restarted when it's Disconnected");try{ge.verbose("Staring reconnecting."),await this._startCore(e)}catch(t){throw this._changeState(Ne.Disconnected),t}}async _startCore(e){if(this._changeState(Ne.Connecting),ge.info("Staring a new connection"),this._sequenceId.reset(),this._isInitialConnected=!1,this._lastCloseEvent=void 0,this._lastDisconnectedMessage=void 0,this._connectionId=void 0,this._reconnectionToken=void 0,this._uri=void 0,typeof this._credential.getClientAccessUrl=="string"?this._uri=this._credential.getClientAccessUrl:this._uri=await this._credential.getClientAccessUrl({abortSignal:e}),typeof this._uri!="string")throw new Error(`The clientAccessUrl must be a string but currently it's ${typeof this._uri}`);await this._connectCore(this._uri)}stop(){this._state===Ne.Stopped||this._isStopping||(this._isStopping=!0,this._wsClient&&this._wsClient.isOpen()?this._wsClient.close():this._isStopping=!1,this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0))}on(e,t){this._emitter.on(e,t)}off(e,t){this._emitter.removeListener(e,t)}_emitEvent(e,t){this._emitter.emit(e,t)}async sendEvent(e,t,n,s){return await this._operationExecuteWithRetry(()=>this._sendEventAttempt(e,t,n,s),s==null?void 0:s.abortSignal)}async _sendEventAttempt(e,t,n,s){var r;if(!((r=s==null?void 0:s.fireAndForget)!==null&&r!==void 0?r:!1))return await this._sendMessageWithAckId(l=>({kind:"sendEvent",dataType:n,data:t,ackId:l,event:e}),s==null?void 0:s.ackId,s==null?void 0:s.abortSignal);const a={kind:"sendEvent",dataType:n,data:t,event:e};return await this._sendMessage(a,s==null?void 0:s.abortSignal),{isDuplicated:!1}}async joinGroup(e,t){return await this._operationExecuteWithRetry(()=>this._joinGroupAttempt(e,t),t==null?void 0:t.abortSignal)}async _joinGroupAttempt(e,t){const n=this._getOrAddGroup(e),s=await this._joinGroupCore(e,t);return n.isJoined=!0,s}async _joinGroupCore(e,t){return await this._sendMessageWithAckId(n=>({group:e,ackId:n,kind:"joinGroup"}),t==null?void 0:t.ackId,t==null?void 0:t.abortSignal)}async leaveGroup(e,t){return await this._operationExecuteWithRetry(()=>this._leaveGroupAttempt(e,t),t==null?void 0:t.abortSignal)}async _leaveGroupAttempt(e,t){const n=this._getOrAddGroup(e),s=await this._sendMessageWithAckId(r=>({group:e,ackId:r,kind:"leaveGroup"}),t==null?void 0:t.ackId,t==null?void 0:t.abortSignal);return n.isJoined=!1,s}async sendToGroup(e,t,n,s){return await this._operationExecuteWithRetry(()=>this._sendToGroupAttempt(e,t,n,s),s==null?void 0:s.abortSignal)}async _sendToGroupAttempt(e,t,n,s){var r,o;const a=(r=s==null?void 0:s.fireAndForget)!==null&&r!==void 0?r:!1,l=(o=s==null?void 0:s.noEcho)!==null&&o!==void 0?o:!1;if(!a)return await this._sendMessageWithAckId(u=>({kind:"sendToGroup",group:e,dataType:n,data:t,ackId:u,noEcho:l}),s==null?void 0:s.ackId,s==null?void 0:s.abortSignal);const d={kind:"sendToGroup",group:e,dataType:n,data:t,noEcho:l};return await this._sendMessage(d,s==null?void 0:s.abortSignal),{isDuplicated:!1}}_getWebSocketClientFactory(){return new mc}async _trySendSequenceAck(){if(!this._protocol.isReliableSubProtocol)return;const[e,t]=this._sequenceId.tryGetSequenceId();if(e&&t){const n={kind:"sequenceAck",sequenceId:t};try{await this._sendMessage(n)}catch{this._sequenceId.tryUpdate(t)}}}_connectCore(e){if(this._isStopping)throw new Error("Can't start a client during stopping");return new Promise((t,n)=>{const s=this._wsClient=this._getWebSocketClientFactory().create(e,this._protocol.name);s.onopen(()=>{if(this._isStopping){try{s.close()}catch{}n(new Error("The client is stopped"))}ge.verbose("WebSocket connection has opened"),this._changeState(Ne.Connected),this._protocol.isReliableSubProtocol&&(this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),this._sequenceAckTask=new zr(async()=>{await this._trySendSequenceAck()},1e3)),t()}),s.onerror(r=>{this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),n(r)}),s.onclose((r,o)=>{this._state===Ne.Connected?(ge.verbose("WebSocket closed after open"),this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),ge.info(`WebSocket connection closed. Code: ${r}, Reason: ${o}`),this._lastCloseEvent={code:r,reason:o},this._handleConnectionClose.call(this)):(ge.verbose("WebSocket closed before open"),n(new Error(`Failed to start WebSocket: ${r}`)))}),s.onmessage(r=>{const o=p=>{if(this._ackMap.has(p.ackId)){const k=this._ackMap.get(p.ackId);this._ackMap.delete(p.ackId);const y=p.error!=null&&p.error.name==="Duplicate";p.success||y?k.resolve({ackId:p.ackId,isDuplicated:y}):k.reject(new Mn("Failed to send message.",{ackId:p.ackId,errorDetail:p.error}))}},a=async p=>{if(this._connectionId=p.connectionId,this._reconnectionToken=p.reconnectionToken,!this._isInitialConnected){if(this._isInitialConnected=!0,this._options.autoRejoinGroups){const k=[];this._groupMap.forEach(y=>{y.isJoined&&k.push((async()=>{try{await this._joinGroupCore(y.name)}catch(w){this._safeEmitRejoinGroupFailed(y.name,w)}})())});try{await Promise.all(k)}catch{}}this._safeEmitConnected(p.connectionId,p.userId)}},l=p=>{this._lastDisconnectedMessage=p},d=p=>{if(p.sequenceId!=null){const k=this._sequenceId.tryUpdate(p.sequenceId);if(k===0)return;k>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitGroupMessage(p)},u=p=>{if(p.sequenceId!=null){const k=this._sequenceId.tryUpdate(p.sequenceId);if(k===0)return;k>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitServerMessage(p)};let m;try{let p;if(Array.isArray(r)?p=Buffer.concat(r):p=r,m=this._protocol.parseMessages(p),m===null)return}catch(p){throw ge.warning("An error occurred while parsing the message from service",p),p}Array.isArray(m)||(m=[m]),m.forEach(p=>{try{switch(p.kind){case"ack":{o(p);break}case"connected":{a(p);break}case"disconnected":{l(p);break}case"groupData":{d(p);break}case"serverData":{u(p);break}}}catch(k){ge.warning(`An error occurred while handling the message with kind: ${p.kind} from service`,k)}})})})}async _handleConnectionCloseAndNoRecovery(){this._state=Ne.Disconnected,this._safeEmitDisconnected(this._connectionId,this._lastDisconnectedMessage),this._options.autoReconnect?await this._autoReconnect():await this._handleConnectionStopped()}async _autoReconnect(){let e=!1,t=0;try{for(;!this._isStopping;)try{await this._startFromRestarting(),e=!0;break}catch(n){ge.warning("An attempt to reconnect connection failed.",n),t++;const s=this._reconnectRetryPolicy.nextRetryDelayInMs(t);if(s==null)break;try{ge.verbose(`Delay time for reconnect attempt ${t}: ${s}`),await Rn(s)}catch{}}}finally{e||this._handleConnectionStopped()}}_handleConnectionStopped(){this._isStopping=!1,this._state=Ne.Stopped,this._safeEmitStopped()}_getActiveKeepaliveTask(){return new zr(async()=>{this._sequenceId.tryUpdate(0)},this._activeTimeoutInMs)}async _sendMessage(e,t){if(!this._wsClient||!this._wsClient.isOpen())throw new Error("The connection is not connected.");const n=this._protocol.writeMessage(e);await this._wsClient.send(n,t)}async _sendMessageWithAckId(e,t,n){t==null&&(t=this.nextAckId());const s=e(t);this._ackMap.has(t)||this._ackMap.set(t,new Zp(t));const r=this._ackMap.get(t);try{await this._sendMessage(s,n)}catch(o){this._ackMap.delete(t);let a="";throw o instanceof Error&&(a=o.message),new Mn(a,{ackId:t})}if(n)try{return await gc(r.promise(),n)}catch(o){throw o instanceof Error&&o.name==="AbortError"?new Mn("Cancelled by abortSignal",{ackId:t}):o}return await r.promise()}async _handleConnectionClose(){if(this._ackMap.forEach((s,r)=>{this._ackMap.delete(r)&&s.reject(new Mn("Connection is disconnected before receive ack from the service",{ackId:s.ackId}))}),this._isStopping){ge.warning("The client is stopping state. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(this._lastCloseEvent&&this._lastCloseEvent.code===1008){ge.warning("The websocket close with status code 1008. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(!this._protocol.isReliableSubProtocol){ge.warning("The protocol is not reliable, recovery is not applicable"),this._handleConnectionCloseAndNoRecovery();return}const e=this._buildRecoveryUri();if(!e){ge.warning("Connection id or reconnection token is not available"),this._handleConnectionCloseAndNoRecovery();return}let t=!1;this._state=Ne.Recovering;const n=Yr.timeout(30*1e3);try{for(;!n.aborted||this._isStopping;)try{await this._connectCore.call(this,e),t=!0;return}catch{await Rn(1e3)}}finally{t||(ge.warning("Recovery attempts failed more then 30 seconds or the client is stopping"),this._handleConnectionCloseAndNoRecovery())}}_safeEmitConnected(e,t){this._emitEvent("connected",{connectionId:e,userId:t})}_safeEmitDisconnected(e,t){this._emitEvent("disconnected",{connectionId:e,message:t})}_safeEmitGroupMessage(e){this._emitEvent("group-message",{message:e})}_safeEmitServerMessage(e){this._emitEvent("server-message",{message:e})}_safeEmitStopped(){this._emitEvent("stopped",{})}_safeEmitRejoinGroupFailed(e,t){this._emitEvent("rejoin-group-failed",{group:e,error:t})}_buildDefaultOptions(e){return e.autoReconnect==null&&(e.autoReconnect=!0),e.autoRejoinGroups==null&&(e.autoRejoinGroups=!0),e.protocol==null&&(e.protocol=Kp()),this._buildMessageRetryOptions(e),this._buildReconnectRetryOptions(e),e}_buildMessageRetryOptions(e){e.messageRetryOptions||(e.messageRetryOptions={}),(e.messageRetryOptions.maxRetries==null||e.messageRetryOptions.maxRetries<0)&&(e.messageRetryOptions.maxRetries=3),(e.messageRetryOptions.retryDelayInMs==null||e.messageRetryOptions.retryDelayInMs<0)&&(e.messageRetryOptions.retryDelayInMs=1e3),(e.messageRetryOptions.maxRetryDelayInMs==null||e.messageRetryOptions.maxRetryDelayInMs<0)&&(e.messageRetryOptions.maxRetryDelayInMs=3e4),e.messageRetryOptions.mode==null&&(e.messageRetryOptions.mode="Fixed")}_buildReconnectRetryOptions(e){e.reconnectRetryOptions||(e.reconnectRetryOptions={}),(e.reconnectRetryOptions.maxRetries==null||e.reconnectRetryOptions.maxRetries<0)&&(e.reconnectRetryOptions.maxRetries=Number.MAX_VALUE),(e.reconnectRetryOptions.retryDelayInMs==null||e.reconnectRetryOptions.retryDelayInMs<0)&&(e.reconnectRetryOptions.retryDelayInMs=1e3),(e.reconnectRetryOptions.maxRetryDelayInMs==null||e.reconnectRetryOptions.maxRetryDelayInMs<0)&&(e.reconnectRetryOptions.maxRetryDelayInMs=3e4),e.reconnectRetryOptions.mode==null&&(e.reconnectRetryOptions.mode="Fixed")}_buildRecoveryUri(){if(this._connectionId&&this._reconnectionToken&&this._uri){const e=new URL(this._uri);return e.searchParams.append("awps_connection_id",this._connectionId),e.searchParams.append("awps_reconnection_token",this._reconnectionToken),e.toString()}return null}_getOrAddGroup(e){return this._groupMap.has(e)||this._groupMap.set(e,new Qp(e)),this._groupMap.get(e)}_changeState(e){ge.verbose(`The client state transfer from ${this._state.toString()} to ${e.toString()}`),this._state=e}async _operationExecuteWithRetry(e,t){let n=0;for(;;)try{return await e.call(this)}catch(s){n++;const r=this._messageRetryPolicy.nextRetryDelayInMs(n);if(r==null||(await Rn(r),t!=null&&t.aborted))throw s}}}class jr{constructor(e){this._retryOptions=e,this._maxRetriesToGetMaxDelay=Math.ceil(Math.log2(this._retryOptions.maxRetryDelayInMs)-Math.log2(this._retryOptions.retryDelayInMs)+1)}nextRetryDelayInMs(e){return e>this._retryOptions.maxRetries?null:this._retryOptions.mode==="Fixed"?this._retryOptions.retryDelayInMs:this._calculateExponentialDelay(e)}_calculateExponentialDelay(e){return e>=this._maxRetriesToGetMaxDelay?this._retryOptions.maxRetryDelayInMs:(1<<e-1)*this._retryOptions.retryDelayInMs}}class Qp{constructor(e){this.isJoined=!1,this.name=e}}class Zp{constructor(e){this._promise=new Promise((t,n)=>{this._resolve=t,this._reject=n}),this.ackId=e}promise(){return this._promise}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}class Xp{constructor(){this._sequenceId=0,this._isUpdate=!1}tryUpdate(e){if(this._isUpdate=!0,e>this._sequenceId){const t=e-this._sequenceId;return this._sequenceId=e,t}return 0}tryGetSequenceId(){return this._isUpdate?(this._isUpdate=!1,[!0,this._sequenceId]):[!1,null]}reset(){this._sequenceId=0,this._isUpdate=!1}}class zr{constructor(e,t,n){this._func=e,this._abortController=new Yr,this._interval=t,this._obj=n,this._start()}abort(){try{this._abortController.abort()}catch{}}async _start(){const e=this._abortController.signal;for(;!e.aborted;)try{await this._func(this._obj)}catch{}finally{await Rn(this._interval)}}}const em=1e3*60*60,tm=1e3*30;class nm{constructor(e,t,n,s=null,r=new Map){H(this,"client");H(this,"handler");H(this,"terminationTimeout",null);H(this,"connectionUrl");H(this,"expiresAt");H(this,"connected",!1);H(this,"websocketRequestId",null);H(this,"conversationId",null);H(this,"secondaryTypeBasedHandlers",new Map);this.connectionUrl=t,this.expiresAt=n,this.client=new Yp({getClientAccessUrl:()=>e(this.connectionUrl,this.expiresAt)},{autoReconnect:!0,reconnectRetryOptions:{maxRetries:5,retryDelayInMs:100,maxRetryDelayInMs:1e4,mode:"Exponential"}}),this.handler=s,this.secondaryTypeBasedHandlers=r}async start(){const e=t=>{if(this.secondaryTypeBasedHandlers.has(t.message.data.type)){const n=this.secondaryTypeBasedHandlers.get(t.message.data.type);if(!n)return;n(t.message.data)}else{const n=t.message.data.body,s=atob(n).trim();if(s.startsWith("data: ")){const r=s.replace("data: ",""),o=this.handler;if(!o)return;o({conversationId:t.message.data.conversation_id,responseId:t.message.data.response_id,message:{id:"",event:"",data:r},websocketRequestId:t.message.data.websocket_request_id})}}};this.client.on("group-message",t=>e(t)),this.client.on("server-message",t=>e(t)),this.client.on("connected",()=>{this.connected=!0}),this.client.on("disconnected",()=>{this.connected=!1}),await this.client.start()}addSecondaryTypeHandler(e,t){this.secondaryTypeBasedHandlers.set(e,t)}isConnected(){return this.connected}async stop(e){e&&this.conversationId!==e||this.websocketRequestId&&await ht.stopWebsocketConversation(this.websocketRequestId)}setHandler(e,t,n,s){!this.handler&&this.websocketRequestId===n||(this.handler!=null&&this.websocketRequestId!==n&&(qc.warn("[websockets] Overwriting existing handler without silencing. This may indicate a race condition."),$e.logEvent(_e.asyncHandlerOverwritten,{originalWebsocketRequestId:this.websocketRequestId,newWebsocketRequestId:n,conversationId:e,responseId:t})),this.websocketRequestId=n,this.conversationId=e,this.handler=r=>{(r.websocketRequestId===n||r.conversationId===e&&r.responseId===t)&&s(r.message)})}silence(){this.handler=null}close(){this.client.stop()}scheduleForTermination(e){this.terminationTimeout=setTimeout(()=>{this.close(),e()},em)}preventTermination(){this.terminationTimeout&&(clearTimeout(this.terminationTimeout),this.terminationTimeout=null)}updateConnectionUrl(e,t){this.connectionUrl=e,this.expiresAt=t}}class im{constructor(){H(this,"activeSocketMap",new Map);H(this,"secondaryTypeBasedHandlers",new Map)}async register(){const e=await ht.postRegisterWebsocket();e.wss_url&&(this.getOrCreateSocket(e.wss_url,new Date(e.expires_at),!0),e.fallback_wss_url&&this.getOrCreateSocket(e.fallback_wss_url,new Date(e.expires_at),!1))}async registerIfNotConnected(){if(this.activeSocketMap.size===0){await this.register();return}for(const e of this.activeSocketMap.values())if(!e.isConnected()){await this.register();return}}isWebsocketConnected(){for(const e of this.activeSocketMap.values())if(e.isConnected())return!0;return this.activeSocketMap.size>0&&He.addError("Cannot connect to any websocket."),!1}async getOrCreateSocket(e,t,n){const s=e.split("?")[0];let r;const o=this.activeSocketMap.get(s);if(o&&o.isConnected())o.preventTermination(),o.updateConnectionUrl(e,t),r=o;else{o&&o.close(),r=new nm(async(a,l)=>{if(new Date<new Date(l.getTime()-5*1e3))return a;const d=await ht.postRegisterWebsocket();return n?d.wss_url:d.fallback_wss_url??""},e,t,null,this.secondaryTypeBasedHandlers),this.activeSocketMap.set(s,r);try{await r.start()}catch(a){throw He.addError(new Error("Error occurred while starting websocket: ",{cause:a})),a}}return r}preSetupWebsocket(e,t,n){for(const s of this.activeSocketMap.values())this.setupWebSocketHandler(s,null,null,null,e,t,n)}addSecondaryTypeHandler(e,t){this.secondaryTypeBasedHandlers.set(e,t);for(const n of this.activeSocketMap.values())n.addSecondaryTypeHandler(e,t)}hasSecondaryTypeHandler(e){return this.secondaryTypeBasedHandlers.has(e)}async processWebSocketConversationStream(e,t,n,s,r,o,a,l,d){const u=[this.getOrCreateSocket(e,n,!0)];t&&u.push(this.getOrCreateSocket(t,n,!1));const m=await Promise.allSettled(u),p=m[0].status==="fulfilled"?m[0].value:null,k=m.length>1&&m[1].status==="fulfilled"?m[1].value:null;if((!p||!p.isConnected())&&He.addError(`Cannot connect to primary websocket, websocketRequestId: ${o}, token: ${e.substring(0,e.indexOf("access_token="))}`),(!p||!p.isConnected())&&(!k||!k.isConnected()))throw t&&He.addError(`Cannot connect to fallback websocket, websocketRequestId: ${o}, token: ${t.substring(0,t.indexOf("access_token="))}`),new ft(`An error occurred while connecting to the websocket. ${_i}`);let y=setTimeout(()=>{He.addError(`WebSocket took too long to respond: ${r}, ${s}, ${o}, ${e.substring(0,60)}...${e.slice(-20)}`,{supportsWebSockets:"WebSocket"in window&&window.WebSocket.CLOSING===2})},tm);const w=C=>(d&&(clearTimeout(d),d=null),y&&(clearTimeout(y),y=null),a(C));p&&this.setupWebSocketHandler(p,e,s,r,o,w,l),k&&t&&this.setupWebSocketHandler(k,t,s,r,o,w,l)}async stopConversation(e){for(const t of this.activeSocketMap.values())await t.stop(e)}setupWebSocketHandler(e,t,n,s,r,o,a){e.setHandler(n,s,r,o),this.secondaryTypeBasedHandlers.forEach((d,u)=>{e.addSecondaryTypeHandler(u,d)});const l=()=>{t?e.scheduleForTermination(()=>{this.activeSocketMap.delete(t.split("?")[0])}):(this.stopConversation(n),e.silence())};a.addEventListener("abort",l)}}const ni=new im;function sm(i){return{webSocketUrl:i.wss_url,fallbackWebSocketUrl:i.fallback_wss_url,conversationId:i.conversation_id,responseId:i.response_id,expiresAt:i.expires_at&&new Date(i.expires_at),websocketRequestId:i.websocket_request_id}}async function rm(i,e,t){return ni.preSetupWebsocket(i,e,t)}async function om(i,e,t,n,s,r,o,a,l){return ni.processWebSocketConversationStream(i,e,t,n,s,r,o,a,l)}const am="OAI-Echo-Logs",zt={FOCUS_IN:0,FOCUS_OUT:1,COPY:2,PASTE:3,TOUCH_START:4,TOUCH_END:5},Na=[];function Vt(i){return()=>{Na.push({type:i,ts:Math.round(performance.now())})}}const lm={focusin:Vt(zt.FOCUS_IN),focusout:Vt(zt.FOCUS_OUT),copy:Vt(zt.COPY),paste:Vt(zt.PASTE),touchstart:Vt(zt.TOUCH_START),touchend:Vt(zt.TOUCH_END)};function eg(i){const e=i??document.getElementById(Ad);for(const[t,n]of Object.entries(lm))e==null||e.removeEventListener(t,n),e==null||e.addEventListener(t,n)}function cm(){return{[am]:Na.slice(0,10).map(i=>`${i.type},${i.ts}`).join(",")}}const dm=1e3*30,wi=io.getTracer("completion"),Si=i=>(i==null?void 0:i.code)==="challenge_required";class Ci extends Error{}function hm(i,e,t,n){const s=async(r=null,o=!1)=>{var Ue,De,Ie,ce,fe,Re,Ae;await yc();const a=new AbortController,l="threadId"in e?e.threadId:void 0,d="continueFromSharedConversationId"in e?e.continueFromSharedConversationId:void 0,u=Wc(),m=Yn.checkGate("1987334402"),p={action:e.completionType,messages:e.messages.length>0?e.messages:void 0,conversation_id:l,continue_from_shared_conversation_id:l!=null?void 0:d,parent_message_id:e.parentMessageId,model:e.model,timezone_offset_min:new Date().getTimezoneOffset(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,variant_purpose:(Ue=e.completionMetadata)==null?void 0:Ue.variantPurpose,suggestions:(De=e.completionMetadata)!=null&&De.suggestions?e.completionMetadata.suggestions.map(I=>Rd(I)):void 0,history_and_training_disabled:e.historyDisabled,juice:(Ie=e.completionMetadata)==null?void 0:Ie.juice,conversation_mode:(ce=e.completionMetadata)==null?void 0:ce.conversationMode,force_paragen:e.forceParagen,force_paragen_model_slug:e.forceParagenModel,force_indepth_feedback:e.forceIndepthFeedback,force_rate_limit:e.forceRateLimit,reset_rate_limits:e.resetRateLimits,disable_system_content_toggling:e.disableSystemContentToggling,websocket_request_id:u,source:(fe=e.completionMetadata)==null?void 0:fe.source,system_hints:(Re=e.completionMetadata)==null?void 0:Re.systemHints,prefetch_ids:(Ae=e.completionMetadata)==null?void 0:Ae.prefetchIds,force_use_sse:!ni.isWebsocketConnected(),supported_encodings:m?["v1"]:[],conversation_origin:e.conversationOrigin,force_use_search:e.forceUseSearch,client_contextual_info:e.contextualInfo},k=no(await to(i));let y="https://chatgpt.com/backend-api";k&&(y="https://chatgpt.com/backend-anon");const w=`${y}/conversation`;let C=!0,N=!0;const O=k?Es.getUnauthHeaders().additionalHeaders:await Es.getAuthedHeaders(),F=Hc(e.chatReq,r??e.arkoseToken,e.turnstileToken,e.proofToken,null),L={...O,...cm(),...F};let M,R,U;wi.startActiveSpan("completion.response",I=>{M=wi.startSpan("completion.first_response"),R=wi.startSpan("completion.first_token"),U=I});const j=io.setSpan(Is.active(),U);let D=null;function W(I){if(e.turnTracker.onBytesReceived(I.data),I.data==="[DONE]")a.abort(),U.end(),t({type:"done"}),ws();else if(I.event!=="ping")try{let E=JSON.parse(I.data);if(I.event==="delta_encoding")if(E=="v1")D=new kc;else{He.addError(`[completion-delta] unknown delta encoding: ${E}`);return}if(I.event==="delta"){if(!D){He.addError("[completion-delta] delta event before delta_encoding");return}E=D.applyDelta(E)}if(E.error){const pe=new ft(E.error);throw t({type:"error",error:pe}),pe}else"type"in E?E.type==="gizmo_inline_review"?t({type:"gizmo_inline_review",gizmoId:E.gizmo_id}):E.type==="title_generation"?t({type:"title_generation",title:E.title,conversation_id:E.conversation_id}):E.type==="moderation"?t({type:"moderation",conversationId:E.conversation_id,messageId:E.message_id,isCompletion:E.is_completion,flagged:E.moderation_response.flagged,blocked:E.moderation_response.blocked,disclaimers:E.moderation_response.disclaimers,metadata:E.moderation_response.metadata}):E.type==="url_moderation"?t({type:"url_moderation",conversationId:E.conversation_id,messageId:E.message_id,url:E.url_moderation_result.full_url,isSafe:E.url_moderation_result.is_safe}):E.type==="num_variants_in_stream"?t({type:"num_variants_in_stream",num_variants_in_stream:E.num_variants_in_stream,display_treatment:E.display_treatment}):E.type==="conversation_detail_metadata"&&t(E):(t({type:"message",message:E.message,conversationId:E.conversation_id}),N&&(N=!1,M.end()),C&&E.message.author.role==="assistant"&&E.message.content.content_type==="text"&&E.message.content.parts[0]!==""&&(C=!1,R.end()))}catch(E){if(E instanceof lt)throw new ft(E.message)}}let $=null,ae=setTimeout(()=>{$===!0?($e.logEvent(_e.asyncResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:Ei.Error,error:{reason:"timeout",message:"Async Response Took Too Long to Come Back"}})):$===!1&&($e.logEvent(_e.sseResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:Ei.Error,error:{reason:"timeout",message:"SSE Response Took Too Long to Come Back"}}))},dm);return rm(u,W,a.signal),Is.with(j,()=>xc(w,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...L},body:JSON.stringify(p),signal:a.signal,openWhenHidden:!0,async onopen(I){var Pe;const E=I.headers.get("content-type")??"",pe=I.headers.get("Cf-Ray")??null;if(I.ok&&E.includes("text/event-stream")){$=!1,n(pe,e.model,e.turnTracker);return}else if(E.includes("application/json")){const G=await I.json(),{webSocketUrl:de,fallbackWebSocketUrl:Ye,conversationId:ee,responseId:me,expiresAt:qe,websocketRequestId:st}=sm(G);if(de!=null&&ee!=null&&me!=null&&st!=null&&qe){$=!0,n(pe,e.model,e.turnTracker);try{await om(de,Ye,qe,ee,me,st,W,a.signal,ae)}catch(A){A instanceof ft&&t({type:"error",error:A})}throw new Ci}else{const A=(G==null?void 0:G.error)??(G==null?void 0:G.detail),te=(A==null?void 0:A.message)??A??"Unknown server error";if(A){if(Si(A))throw new lt(te,I.status,A.code);if(I.status>=500)throw new ft(te);{if(((A==null?void 0:A.code)==="expired_session_key"||(A==null?void 0:A.code)==="invalid_api_key"||(A==null?void 0:A.code)==="token_expired")&&typeof window<"u"&&((Pe=window._oaiHandleSessionExpired)==null||Pe.call(window,"stream",JSON.stringify(A))),(A==null?void 0:A.code)==="deactivated_workspace"){window.location.href.includes("/workspace/deactivated")||(window.location.href="/workspace/deactivated");return}const Ce=A==null?void 0:A.can_retry;throw new lt(te,I.status,A==null?void 0:A.code,A==null?void 0:A.type,void 0,A==null?void 0:A.clears_in,Ce)}}}}throw new ft(Ns)},onmessage:I=>{if($)throw new ft(Ns);ae&&(clearTimeout(ae),ae=null),W(I)},onerror(I){let E=I instanceof Error?I:new Error(JSON.stringify(I));throw E instanceof Ci||$||Si(E)&&!o||(E.message==="Failed to fetch"&&(E=new ft(`An error occurred. Either the engine you requested does not exist or there was another issue processing your request. ${_i}`)),E.message==="network error"&&(E=new lt(`A network error occurred. Please check your connection and try again. ${_i}`,400)),Jc("fetch-error:conversation:new-message",{url:w,message:E==null?void 0:E.message}),t({type:"error",error:E}),ws(E)),E}})).catch(async I=>{if(Si(I)){if(o)throw new lt("Failed to complete your call, please try again",I.status);{const E=await Oi.getEnforcementToken(e.chatReq);return s(E,!0)}}I instanceof Ci||(He.addError(I),e.turnTracker.handleRawError(I.message??"Something went wrong",I.status))}),a};return s()}function tg({clientThreadId:i,continuingFromSharedConversationId:e,onCompletionFinished:t=Ii,onCreate:n=Ii}){const s=$c(),{resolvedTheme:r}=Gn(),o=r==="dark",a=B.useRef(t),l=Gc();a.current=t;const d=B.useCallback(async function({model:u,completionType:m,parentNodeId:p,metadata:k,focusOnNewCompletion:y=!0,completionMetadata:w,chatReq:C,arkoseToken:N,turnstileToken:O,proofToken:F,preflightTime:L,extraStreamParams:M,appendMessages:R,updateTree:U,turnTracker:j}){var G,de,Ye,ee,me,qe,st;Kr.publish({kind:"requestCompletion"});const D=P.getTree(i);P.retainThread(i);const W=Md(),$=`${bc}${i}-${W}`,ae=`${i}-${W}`;U==null||U();const Se=D.getNodeByIdOrMessageId(p),De={gizmo_id:(G=Se.message.metadata)==null?void 0:G.gizmo_id};(w==null?void 0:w.juice)!=null&&(De.snorkle_status=1),P.updateTree(i,A=>{A.addNode($,"",p,ot.Assistant,void 0,De)}),y&&P.setThreadCurrentLeafId(i,$);let Ie,ce=[],fe=D.getNodeByIdOrMessageId(Se.parentId);for(;fe!=null&&(((de=fe.metadata)==null?void 0:de.isPlaceholderTemplateAssistantWelcomeMessage)===!0||((Ye=fe.metadata)==null?void 0:Ye.isClientCreatedSystemMessage)===!0);){const A=fe.message;ce.unshift(A);const te=D.getNodeByIdOrMessageId(fe.parentId);Ie=((ee=te.message)==null?void 0:ee.id)??te.id,fe=te}if(m===on.Next||m===on.Variant){const A=D.getNodeByIdOrMessageId(Se.parentId);if(Ie??(Ie=((me=A.message)==null?void 0:me.id)??A.id),ce.push(Se.message),R){let te=p;P.updateTree(i,Ce=>{for(const ve of R)Ce.insertNodeBefore($,{id:ve.id,message:ve,parentId:te,children:[]}),te=ve.id}),ce.push(...R)}ce=um(ce,M)}else Ie??(Ie=Se.message.id);const Re=P.getServerThreadId(i);Re===void 0&&is(i)&&P.updateInitialThreadDataForNewThread(i,u);async function Ae(A,te){const Ce=performance.now(),ve=await Kc();Oi.initializeAndGatherData(ve),Ss.initializeAndGatherData(ve),_s.initializeAndGatherData(ve),P.updateTree(i,ri=>{for(const Pt of te)ri.addNode(Pt.id,Pt,A,ot.Assistant,{completionSampleFinishTime:Date.now()}),A=Pt.id}),P.setThreadCurrentLeafId(i,A);const ii=await Oi.getEnforcementToken(ve),Zt=await Ss.getEnforcementToken(ve),si=await _s.getEnforcementToken(ve);d({model:u,completionType:on.Next,parentNodeId:A,metadata:{},chatReq:ve,arkoseToken:ii??null,turnstileToken:Zt??null,proofToken:si??null,preflightTime:performance.now()-Ce,extraStreamParams:M,turnTracker:j})}j.updateAttachmentCount(ce);const I=new Hp(s,i,$,m,u,k.eventSource,n,ae,Ae,(...A)=>a.current(...A),j,l),E=(A,te,Ce)=>{A&&Ce.onReceivedRequestId(A),Sc(ae,te,A,L)},pe={is_dark_mode:o,time_since_loaded:Math.floor(performance.now()/1e3),page_height:window==null?void 0:window.innerHeight,page_width:window==null?void 0:window.innerWidth,pixel_ratio:window==null?void 0:window.devicePixelRatio,screen_height:(qe=window==null?void 0:window.screen)==null?void 0:qe.height,screen_width:(st=window==null?void 0:window.screen)==null?void 0:st.width},Pe=await hm(s,{conversationOrigin:P.getConversationOrigin(i),model:u,completionType:m,threadId:Re,continueFromSharedConversationId:e,historyDisabled:l,parentMessageId:Ie,messages:ce,chatReq:C,arkoseToken:N??null,turnstileToken:O??null,proofToken:F??null,completionMetadata:w,...M,turnTracker:j,contextualInfo:pe},I.handleResponse,E);Qi.addRequest($,Pe,j),Ta.onCompletionRequestStarted($)},[i,s,n,e,l,o]);return d}const um=(i,e)=>{let t=i;return(e==null?void 0:e.forceUseSearch)===!1&&i.length>0&&(t=i.map(n=>{const{system_hints:s,...r}=n.metadata||{};return{...n,metadata:{...r,system_hints:s==null?void 0:s.filter(o=>o!==wc.Search)}}})),t};function ng(i,e,t,n){let s=Cc.getReadyFiles(i.getState());(n==null?void 0:n.kind)===je.GizmoMagicCreate?s=s.filter(p=>p.gizmoId!=null):s=s.filter(p=>p.gizmoId==null);let r=e??"";const o=[],a=[],l=Tc(t,n),u=Mc(t,n).length>0,m=l===li.Interpreter||l===li.Retrieval||l===li.ContextConnector;return s.forEach(({fileSpec:p})=>{if(m){const k=p.contextConnectorInfo;o.push({id:p.id,size:p.size,name:p.name,context_connector_info:k?{context_connector:k==null?void 0:k.contextConnector,source_url:k==null?void 0:k.sourceUrl,synthetic_extension:(k==null?void 0:k.syntheticExtension)??null,type:k==null?void 0:k.type}:void 0,mime_type:p.mimeType,width:"width"in p?p.width:void 0,height:"height"in p?p.height:void 0,file_token_size:p.fileTokenSize})}u&&"width"in p&&"height"in p&&a.push({content_type:Yc.ImageAssetPointer,asset_pointer:Ec(p.id),size_bytes:p.size,width:p.width,height:p.height})}),a.length>0&&(a.push(e??""),r={content_type:Kn.MultimodalText,parts:a}),{content:r,attachments:o}}async function ig({clientThreadId:i,currentRequestId:e,queryClient:t,isHistoryAndTrainingDisabled:n}){var a;const s=P.getServerThreadId(i);ni.stopConversation(s);const r=P.getTree(i);!r.hasReceivedServerCompletion&&!n&&((a=r.getParent(e).metadata)==null?void 0:a.errCode)!==ct.ContentPolicy&&setTimeout(()=>{$i.onCreateFinished(t,s,n)},500),s&&Yn.checkGate("3922476776")&&await ht.stopConversationProcess(s),Qi.abortRequest(e)&&P.updateTree(i,l=>{const d=P.getThreadCurrentLeafId(i);l.updateNodeMessageMetadata(d,{finish_details:{type:"interrupted"}})})}function fm(i){return`https://chatgpt.com${bd(i)}`}function sg(i,e,t,n){Ic(fm(i),e,t),n&&e.info(n)}function rg(i){return i.some(e=>e.type===Qc.JIT_PLUGIN)}function pm(i){return"gizmo_id"in i?i.gizmo_id??null:null}const mm=i=>["conversation","init",i],gm=({clientThreadId:i,conversationMode:e,clientModelId:t},n)=>{const s=pm(e),r=is(i)?null:i;return{gcTime:0,refetchOnWindowFocus:!0,refetchOnMount:"always",queryKey:mm(i),queryFn:()=>ht.getConversationDetails({conversationId:r,gizmoId:s,requestedDefaultModel:t}),enabled:!Nc(i)}},ym=i=>(Zc(),es(gm(i))),xm=(i,e)=>{const t=(typeof i=="string"?[i]:i)??[];for(const n of t)if(n&&e.has(n))return n;return null},og=(i,e)=>{const t=wd(),{query:n}=Xc(),s=Sd(n),{modelId:r=null}=_c()??{};vd(i);const o=Ed(i)??null,a=[s,o,r],l=xm(a,t);B.useEffect(()=>{P.initThread(i,e,l),Ni.reset()},[i]);const d=ed(),u=B.useCallback(()=>{const y={...n};delete y.model;const w=td.stringify(y);d({search:w.length>0?`?${w}`:""})},[n,d]),{isLoading:m,data:p}=ym({clientThreadId:i,clientModelId:a.find(y=>!!y)??null,conversationMode:e}),k=nd();B.useEffect(()=>{if(!(!s||m)){if(!t.has(s)||k.find(y=>y.model_slug===s))return u();P.setThreadModelId(i,s)}},[s,k,t,i]),B.useEffect(()=>{if(m||!p)return;const{default_model_slug:y}=p;s&&y&&s!==y&&u(),Ni.updateDetails(p),y&&P.setThreadModelId(i,y)},[m,p])};export{rg as $,tt as A,Jd as B,$t as C,le as D,jm as E,_ as F,$m as G,Gd as H,ig as I,lo as J,wa as K,qp as L,cn as M,q as N,sg as O,Pm as P,fm as Q,Ge as R,Y as S,gs as T,xe as U,Hm as V,Rm as W,sn as X,eg as Y,ni as Z,ng as _,ze as a,ps as a0,Km as a1,Gh as a2,Xd as a3,Qt as a4,yt as a5,Xe as a6,jh as a7,Qm as b,v as c,Fm as d,X as e,Bm as f,vm as g,dp as h,Ca as i,sp as j,Um as k,Am as l,Gm as m,Zm as n,Jm as o,Wm as p,qm as q,zh as r,zm as s,$f as t,og as u,Vm as v,Je as w,Lm as x,Ym as y,tg as z};
//# sourceMappingURL=nfvveyk9d6ahnf1o.js.map
