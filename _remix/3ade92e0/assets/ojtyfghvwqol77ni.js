const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/sso-bm4fdyk2eb045br6.js","assets/jipkz7wahhvzzuqx.js","assets/n5nz8vnsxibd6bik.js","assets/root-fm8m2265.css","assets/gecwa6udk6b6d8e5.js","assets/e6zhtx99a7i1g9zc.js","assets/conversation-small-cll5buey.css","assets/g70459ispqthxwkc.js","assets/hu4ya3hu1q2mtj3c.js","assets/kl3gqai6eyrksb78.js","assets/lb2bw82esu8k4ire.js","assets/lbv1zpv4g2ap41f2.js","assets/fwm14uzkyzsxflxc.js","assets/npl77qwfuvi2jyha.js","assets/ncnmvo4fatoh9z2b.js","assets/kk1rsekvjsv0g0j7.js","assets/fcr06eqoxz5nj0zr.js","assets/pd9fde109gdug6hf.js","assets/n7shmditr84egzzk.js","assets/e0q7avter61nrf4p.js","assets/g79q0kqvjf4v6sq3.js","assets/ja77flu7lr7k19zc.js","assets/mqkdkqi70tg22rmc.js","assets/itghwucfyv5ciib7.js","assets/emrzdqiwm6jh3tir.js","assets/hb9kth9i8po7iuke.js","assets/it892upc0b17konk.js","assets/jve09hpajqhwe0e9.js","assets/983a0dy92b3ronpv.js","assets/chvpkj96n5ix27m5.js","assets/kqwdyvkaaavvn8k3.js","assets/eckxh6cogpyr8kwq.js","assets/cvcqo16jowbbtkd6.js","assets/nuknfoob4u68wxce.js","assets/j4lmoxl30s4i5iwl.js","assets/e9lafxuzyeh4418f.js","assets/1nuz69lmcqqsmutm.js","assets/j2c3u9esu2do2tqk.js","assets/kgz011geyku0c84g.js","assets/f2w9prfaqv5jn6b6.js","assets/e0u9h9cxh8krpmz8.js","assets/nsw6odx5xh6i9cc3.js","assets/m6pgxcx6wl6hasxb.js","assets/bvgec6jog7bnj4h6.js","assets/fqai4h0y4a7y6yiz.js","assets/dq8hmbn2uc9rnc3l.js","assets/on9wm4zf21933kvz.js","assets/iej0cupg2dqkmejt.js","assets/jzivm9ic1efl80i1.js","assets/czxvxxbki5j1pqe9.js","assets/jk8w36bsokizpx57.js","assets/dp98tj9u73hn9ufz.js","assets/hpwzwf5t45kgizxl.js","assets/k5sy9m1ppx4ss01q.js","assets/gx6w5z6cfh3fm61x.js","assets/d3y72ugnrmac5z1v.js"])))=>i.map(i=>d[i]);
import{c as es,ah as ve,fq as ts,eB as Fn,by as jn,bi as Le,r as v,bm as qe,N as Lt,W as Te,a3 as Dn,a0 as mt,P as A,t as qt,eY as Pn,fb as Un,a5 as xe,b as B,x as d,a2 as O,n as On,Y as Me,ao as ke,fC as bt,b7 as Ne,b8 as ns,fB as rs,T as Oe,X as Ze,O as je,c3 as ss,bd as $e,$ as Wt,j as os,a7 as $t,u as et,aS as gt,aa as Ln,bQ as is,bO as as,as as lt,eh as qn,S as oe,bE as Wn,b9 as $n,be as Gn,bw as Et,br as cs,ax as ls,aw as Ue,ce as Gt,w as us,e4 as Ht,e5 as Hn,D as we,fD as ds,at as ye,fv as hs,fE as Dt,R as Ce,e3 as Qe,M as fs,ef as zn,eb as Vn,fF as Pt,bF as ps,fG as Kn,v as ms,f as sn,fH as gs,fI as on,fJ as an,fK as ys,fL as _s,B as ws,av as xs,dL as vs,bs as cn,bj as Is,bk as ln,bl as un,a9 as zt,da as Cs,aX as Ss,f8 as bs,dI as Es,fa as ks,f1 as Ts,aV as ut,bD as Ms,fh as Rs}from"./jipkz7wahhvzzuqx.js";import{am as yt,kV as As,kW as Qn,k5 as Bs,kX as Ns,kY as Fs,kZ as js,V as Ds,dp as Yn,iN as Jn,ad as Ps,k_ as Xn,jN as Zn,fZ as Us,jm as Os,jV as er,hx as Ls,c0 as _t,k$ as qs,l0 as st,l1 as Ws,l2 as tr,l3 as kt,l4 as $s,l5 as Gs,bc as Fe,l6 as Hs,l7 as zs,l8 as Vs,aQ as he,l9 as nr,aJ as dn,aK as Ge,aL as wt,aV as Ks,bk as Qs,bl as Ys,aY as Js,aZ as rr,a_ as dt,a$ as He,bb as Xs,bm as de,la as me,bn as Zs,b0 as eo,b1 as to,b2 as no,b4 as sr,b3 as ro,aN as so,b8 as oo,b9 as io,bd as ao,be as co,lb as lo,lc as uo,ld as ho,le as fo,bg as hn,lf as or,bh as po,ba as mo,bj as go,lg as yo,lh as _o,li as wo,lj as ir,lk as xo,ll as vo,lm as Tt,ln as Io,ff as Co,c1 as tt,y as Vt,r as xt,f as So,hA as Kt,d1 as ar,cd as fn,w as cr,ay as bo,bE as Eo,lo as ko,br as lr,v as ur,lp as To,bA as Mo,lq as Ro,lr as Ao,h as Bo,k0 as pn,jZ as mn,ls as No,lt as Fo,lu as jo,lv as Do,lw as Po,lx as Uo,c_ as Oo,ly as ht,ca as dr,lz as Lo,eW as Qt,lA as Yt,lB as qo,lC as Wo,lD as $o,lE as ue,lF as Go,lG as at,lH as ot,lI as Ho,lJ as hr,fo as ce,lK as zo,lL as Vo,lM as ze,lN as Ko,lO as gn,lP as Qo,lQ as Yo,cD as Jo,cm as yn,cG as Xo,lR as Zo,G as ei,lS as ti,lT as ni,lU as ri,lV as si,lW as oi,lX as ii,H as ai,lY as ci,lZ as li,cx as ui,u as di,t as hi,dC as fi,l_ as _n,cb as wn}from"./e6zhtx99a7i1g9zc.js";import{u as Jt,a9 as pi,b_ as fr,a0 as pr,aQ as mi,Y as gi,q as yi,J as _i,ae as wi,p as xi,aZ as mr,br as gr,bx as yr,b$ as _r,I as vi,c0 as Ii,bs as Ci,bb as Si,aH as bi,V as wr,b5 as Mt}from"./n5nz8vnsxibd6bik.js";import{D as Y,B as Ei}from"./it892upc0b17konk.js";import{c as xr,d as vr,r as Ir,s as Cr}from"./fqai4h0y4a7y6yiz.js";import{u as ki}from"./gf1rzma6lb3hhiaa.js";import{U as _e,G as We,a as Ti,u as Sr,b as br}from"./npl77qwfuvi2jyha.js";import{M as Er,N as kr,L as Tr,u as Mi,a as Ri,O as Ai,g as xn,G as Bi,f as Ni,Q as Fi,K as ji,F as Di}from"./lb2bw82esu8k4ire.js";import{a as ft,T as E,l as Mr,b as pt,v as Rr,j as Xt,M as Pi,N as Ui,O as Oi,P as Li,m as qi,d as Wi,k as $i}from"./lbv1zpv4g2ap41f2.js";import{i as Gi}from"./ncnmvo4fatoh9z2b.js";import{T as Hi,a as zi}from"./efad9c3t7hoskfux.js";function Vi(){return Fn(jn.DataAnalysisV2)}function Cl(){const t=yt(),e=ve();return e&&t&&!ts(t)&&e.isEnterprisey()}function Sl(){return Fn(jn.ChartSerialization)}function bl(t,e){const s=t==="chart"?Le.HasSeenAdaInteractiveChart:Le.HasSeenAdaInteractiveTable,[o,a]=v.useState(qe.getItem(s,{userId:e})??!1),u=v.useCallback(()=>{a(!0),qe.setItem(s,!0,{userId:e})},[s,e]);return[o,u]}function El(t){const[e,s]=v.useState([]),o=ft(()=>{const a=E.resolveThreadId(t),u=E.getThreadCurrentLeafId(t);return E.getTree(a).getBranchFromLeaf(u)});return v.useEffect(()=>{const a=Ar(o);a.length!==e.length&&s(a)},[e.length,t,o]),e}function Ki(t){return ft(()=>{const e=E.resolveThreadId(t),s=E.getThreadCurrentLeafId(t),a=E.getTree(e).getBranchFromLeaf(s);return Ar(a).length>0})}function Qi(t){const e=t.metadata?.aggregate_result?.messages.filter(Gi)??[];let s=0;const o=(t.metadata?.ada_visualizations??[]).map(u=>{let h=u;return u.type=="chart"&&(h={...u,fallback_image:e[s++]}),h}),a=(t.metadata?.attachments??[]).filter(u=>Bs(u.name)).map(u=>({type:"table",file_id:u.id??"",title:Ns(u),file_name:u.name,context_connector_info:u.context_connector_info}));return[...o,...a]}function Ar(t){return t.filter(s=>s.message?.author.role==="tool"&&s.message?.author.name==="python"||(s.message?.metadata?.attachments??[]).length>0).flatMap(s=>Qi(s.message))}es(t=>({selectedSpreadsheet:null,setSelectedSpreadsheet:e=>t({selectedSpreadsheet:e})}));async function Yi(t,e,s){const o=await t.text(),{parse:a}=await mt(async()=>{const{parse:h}=await import("./oeujip5i1ptrxie5.js");return{parse:h}},[]),u=a(o);return{content:{columnNames:u.shift(),columnTypes:u[0].map(()=>"string"),rows:u},file_name:e,download_url:s}}function Ji(t){const e=t[0].values.length,s=[];for(let o=0;o<e;o++){const a=t.map(u=>u.values[o]);s.push(a)}return s}function kl(t){return Lt({queryKey:["ada-visualization","chart",t.file_id],queryFn:async()=>{const e=await Te.getFileDownloadLink(t.file_id);if(e.status===Dn.Success){const o=await(await fetch(e.download_url)).json();return{content:{chart_type:o.type,title:o.title,labels:o.labels,datasets:o.datasets,x_label:o.x_label,y_label:o.y_label},file_name:e.file_name??"",download_url:e.download_url}}else throw new Error("Failed to download chart json from interpreter")}})}function Tl(t){return Lt({queryKey:["ada-visualization","table",t.file_id],queryFn:async()=>{if(t.file_name&&As(t.file_name)){const e=await Te.getAdaExcelFileContents(t.file_id);return{content:e.sheets.map(s=>({name:s.name,columnNames:s.columns.map(o=>o.name),columnTypes:s.columns.map(()=>"string"),rows:Ji(s.columns)})),download_url:e.download_url,file_name:t.file_name}}else{const e=await Te.getFileDownloadLink(t.file_id);if(e.status===Dn.Success){const s=await fetch(e.download_url);return Yi(s,e.file_name??"",e.download_url)}else throw new Error("Failed to download from interpreter")}}})}function Xi(t){const e=Qn(),s=Ki(t),o=Vi();return s&&o&&!e.displayingSideBySideFeedback}function Ml(t){return Fs(t)&&!js(t)}const it=50,Zi=95;function Rl(t,e){if(t<=e)return t/e*it;{const s=it,o=Zi-it,a=t-e,h=-(it/e)/o;return s+o*(1-Math.exp(h*a))}}class ea{mostRecentCompletionRequest;loggedRequests=new Set;onCompletionRequestStarted(e){this.mostRecentCompletionRequest={requestId:e,timestamp:Date.now()},this.loggedRequests.clear()}logEvent(e,s,o,a,u){const h=this.mostRecentCompletionRequest;if(h!=null&&!this.loggedRequests.has(e)){const g=E.getThreadConversationTurns(s,o).find(_=>_.messages.some(x=>x.message.id===o));g!=null&&g.messages.some(_=>_.nodeId===h.requestId)&&(A.logEvent(e,{messageId:o,timeMs:Date.now()-h.timestamp,...a}),u?.(),this.loggedRequests.add(e))}}}const ta=new ea;function Al(t){return(t.find(a=>a.message.metadata?.image_search_results!==void 0)?.message.metadata?.image_search_results??[]).slice(0,5)}const Br=Ds.DesktopBrowserExtensionAnnouncement,na=5,Nr="https://chromewebstore.google.com/detail/searchgpt/ejcfepkfckglbgocfkanmcdngdijcgld";function Bl({onClose:t}){v.useEffect(()=>{A.logEventWithStatsig(B.chatgptBrowserExtensionAnnouncementShown,"chatgpt_browser_extension_announcement_shown")},[]);const{markAsViewed:e}=Yn(Br),s=v.useCallback(()=>{e(),A.logEventWithStatsig(B.chatgptBrowserExtensionAnnouncementClosed,"chatgpt_browser_extension_announcement_closed"),t&&t()},[e,t]),o=v.useCallback(()=>{A.logEventWithStatsig(B.chatgptBrowserExtensionAnnouncementCTAClicked,"chatgpt_browser_extension_announcement_cta_clicked"),e(),t&&t()},[e,t]);return d.jsx(ra,{downloadUrl:Nr,handleCTAClicked:o,handleClose:s})}function ra({downloadUrl:t,handleCTAClicked:e,handleClose:s}){const o=()=>{e(),window.open(t)},a=d.jsxs("div",{className:"flex-grow",children:[d.jsx("div",{className:"mb-0.5 font-semibold",children:d.jsx(O,{id:"uAZwaE",defaultMessage:"Use ChatGPT for every search"})}),d.jsx("span",{className:"text-token-text-secondary",children:d.jsx(O,{id:"+wTq4L",defaultMessage:"Download the Chrome extension to switch your default search engine to ChatGPT, and get instant answers from trusted sources with every search."})})]});return d.jsx(Ps,{onPrimaryCtaClick:o,primaryCtaText:d.jsx(O,{id:"x9mKG0",defaultMessage:"Get Extension"}),onDismiss:s,content:a})}function Nl(t){const{value:e}=qt("2634628831"),{eligible:s,isLoading:o}=Yn(Br),a=Pn(()=>document.documentElement.dataset.searchExtension==="1"),u=Er(t.clientThreadId,Un.Search),h=sa();return{eligible:!(!e||a||!s||!u||!Jn()||!h||t.conversationMode?.kind!==xe.PrimaryAssistant),isLoading:o}}function Fl(t){const e=qe.getItem(Le.SearchSettings)??{};e.hasSearchedMinTimes||(e.searchMessageIds||(e.searchMessageIds=[]),e.searchMessageIds.includes(t)||(e.searchMessageIds.push(t),e.searchMessageIds.length>=na&&(e.hasSearchedMinTimes=!0,delete e.searchMessageIds),qe.setItem(Le.SearchSettings,e)))}function sa(){return(qe.getItem(Le.SearchSettings)??{}).hasSearchedMinTimes===!0}const oa=({children:t})=>{const e=Xn();return e?.length?d.jsxs(Y.Root,{children:[d.jsx(Y.Trigger,{className:"h-10 px-2",children:t}),d.jsx(Y.Content,{align:"end",onCloseAutoFocus:s=>s.preventDefault(),children:e.map(s=>d.jsx(ia,{textdocId:s},s))})]}):null},ia=({textdocId:t})=>{const e=On(Zn(t));return d.jsx(Y.Item,{icon:Jt,onClick:()=>{Us.logButtonClick(Os.FILE_DRAWER_ITEM),er(e.textdocId)},children:e.title})},aa=()=>{const t=Me(),e=Xn(),s=Ls();if(!e||s)return null;const o=e.length;return o===1?d.jsx(ca,{textdocId:e[0]}):d.jsx(oa,{children:d.jsx(ke,{label:t.formatMessage({id:"xX2Zyt",defaultMessage:"Open canvas"}),children:d.jsxs("div",{className:"flex items-center gap-1 text-token-text-secondary",children:[d.jsx(Jt,{className:"icon-xl-heavy"}),o]})})})},ca=({textdocId:t})=>{const e=Me(),s=On(Zn(t));return d.jsx(ke,{label:e.formatMessage({id:"xX2Zyt",defaultMessage:"Open canvas"}),children:d.jsx(_t,{onClick:()=>er(s.textdocId),icon:Jt})})},Fr={...ns},la=Fr.useInsertionEffect,ua=la||(t=>t());function jr(t){const e=v.useRef(()=>{});return ua(()=>{e.current=t}),v.useCallback(function(){for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];return e.current==null?void 0:e.current(...o)},[])}var Ut=typeof document<"u"?v.useLayoutEffect:v.useEffect;let vn=!1,da=0;const In=()=>"floating-ui-"+Math.random().toString(36).slice(2,6)+da++;function ha(){const[t,e]=v.useState(()=>vn?In():void 0);return Ut(()=>{t==null&&e(In())},[]),v.useEffect(()=>{vn=!0},[]),t}const fa=Fr.useId,pa=fa||ha;function ma(){const t=new Map;return{emit(e,s){var o;(o=t.get(e))==null||o.forEach(a=>a(s))},on(e,s){t.set(e,[...t.get(e)||[],s])},off(e,s){var o;t.set(e,((o=t.get(e))==null?void 0:o.filter(a=>a!==s))||[])}}}const ga=v.createContext(null),ya=v.createContext(null),_a=()=>{var t;return((t=v.useContext(ga))==null?void 0:t.id)||null},wa=()=>v.useContext(ya),xa="data-floating-ui-focusable";function va(t){const{open:e=!1,onOpenChange:s,elements:o}=t,a=pa(),u=v.useRef({}),[h]=v.useState(()=>ma()),c=_a()!=null,[g,_]=v.useState(o.reference),x=jr((y,C,b)=>{u.current.openEvent=y?C:void 0,h.emit("openchange",{open:y,event:C,reason:b,nested:c}),s?.(y,C,b)}),I=v.useMemo(()=>({setPositionReference:_}),[]),p=v.useMemo(()=>({reference:g||o.reference||null,floating:o.floating||null,domReference:o.reference}),[g,o.reference,o.floating]);return v.useMemo(()=>({dataRef:u,open:e,onOpenChange:x,elements:p,events:h,floatingId:a,refs:I}),[e,x,p,h,a,I])}function Ia(t){t===void 0&&(t={});const{nodeId:e}=t,s=va({...t,elements:{reference:null,floating:null,...t.elements}}),o=t.rootContext||s,a=o.elements,[u,h]=v.useState(null),[c,g]=v.useState(null),x=a?.reference||u,I=v.useRef(null),p=wa();Ut(()=>{x&&(I.current=x)},[x]);const y=qs({...t,elements:{...a,...c&&{reference:c}}}),C=v.useCallback(R=>{const U=st(R)?{getBoundingClientRect:()=>R.getBoundingClientRect(),contextElement:R}:R;g(U),y.refs.setReference(U)},[y.refs]),b=v.useCallback(R=>{(st(R)||R===null)&&(I.current=R,h(R)),(st(y.refs.reference.current)||y.refs.reference.current===null||R!==null&&!st(R))&&y.refs.setReference(R)},[y.refs]),k=v.useMemo(()=>({...y.refs,setReference:b,setPositionReference:C,domReference:I}),[y.refs,b,C]),F=v.useMemo(()=>({...y.elements,domReference:x}),[y.elements,x]),N=v.useMemo(()=>({...y,...o,refs:k,elements:F,nodeId:e}),[y,k,F,e,o]);return Ut(()=>{o.dataRef.current.floatingContext=N;const R=p?.nodesRef.current.find(U=>U.id===e);R&&(R.context=N)}),v.useMemo(()=>({...y,context:N,refs:k,elements:F}),[y,k,F,N])}const Cn="active",Sn="selected";function Rt(t,e,s){const o=new Map,a=s==="item";let u=t;if(a&&t){const{[Cn]:h,[Sn]:c,...g}=t;u=g}return{...s==="floating"&&{tabIndex:-1,[xa]:""},...u,...e.map(h=>{const c=h?h[s]:null;return typeof c=="function"?t?c(t):null:c}).concat(t).reduce((h,c)=>(c&&Object.entries(c).forEach(g=>{let[_,x]=g;if(!(a&&[Cn,Sn].includes(_)))if(_.indexOf("on")===0){if(o.has(_)||o.set(_,[]),typeof x=="function"){var I;(I=o.get(_))==null||I.push(x),h[_]=function(){for(var p,y=arguments.length,C=new Array(y),b=0;b<y;b++)C[b]=arguments[b];return(p=o.get(_))==null?void 0:p.map(k=>k(...C)).find(k=>k!==void 0)}}}else h[_]=x}),h),{})}}function Ca(t){t===void 0&&(t=[]);const e=t.map(c=>c?.reference),s=t.map(c=>c?.floating),o=t.map(c=>c?.item),a=v.useCallback(c=>Rt(c,t,"reference"),e),u=v.useCallback(c=>Rt(c,t,"floating"),s),h=v.useCallback(c=>Rt(c,t,"item"),o);return v.useMemo(()=>({getReferenceProps:a,getFloatingProps:u,getItemProps:h}),[a,u,h])}function bn(t,e){return{...t,rects:{...t.rects,floating:{...t.rects.floating,height:e}}}}const Sa=t=>({name:"inner",options:t,async fn(e){const{listRef:s,overflowRef:o,onFallbackChange:a,offset:u=0,index:h=0,minItemsVisible:c=4,referenceOverflowThreshold:g=0,scrollRef:_,...x}=Ws(t,e),{rects:I,elements:{floating:p}}=e,y=s.current[h],C=_?.current||p,b=p.clientTop||C.clientTop,k=p.clientTop!==0,F=C.clientTop!==0,N=p===C;if(!y)return{};const R={...e,...await tr(-y.offsetTop-p.clientTop-I.reference.height/2-y.offsetHeight/2-u).fn(e)},U=await bt(bn(R,C.scrollHeight+b+p.clientTop),x),q=await bt(R,{...x,elementContext:"reference"}),$=kt(0,U.top),ne=R.y+$,D=$s(kt(0,C.scrollHeight+(k&&N||F?b*2:0)-$-kt(0,U.bottom)));if(C.style.maxHeight=D+"px",C.scrollTop=$,a){const L=C.scrollHeight>C.offsetHeight&&C.offsetHeight<y.offsetHeight*c-1||q.top>=-g||q.bottom>=-g;Ne.flushSync(()=>a(L))}return o&&(o.current=await bt(bn({...R,y:ne},C.offsetHeight+b+p.clientTop),x)),{y:ne}}});function ba(t,e){const{open:s,elements:o}=t,{enabled:a=!0,overflowRef:u,scrollRef:h,onChange:c}=e,g=jr(c),_=v.useRef(!1),x=v.useRef(null),I=v.useRef(null);v.useEffect(()=>{if(!a)return;function y(b){if(b.ctrlKey||!C||u.current==null)return;const k=b.deltaY,F=u.current.top>=-.5,N=u.current.bottom>=-.5,R=C.scrollHeight-C.clientHeight,U=k<0?-1:1,q=k<0?"max":"min";C.scrollHeight<=C.clientHeight||(!F&&k>0||!N&&k<0?(b.preventDefault(),Ne.flushSync(()=>{g($=>$+Math[q](k,R*U))})):/firefox/i.test(Gs())&&(C.scrollTop+=k))}const C=h?.current||o.floating;if(s&&C)return C.addEventListener("wheel",y),requestAnimationFrame(()=>{x.current=C.scrollTop,u.current!=null&&(I.current={...u.current})}),()=>{x.current=null,I.current=null,C.removeEventListener("wheel",y)}},[a,s,o.floating,u,h,g]);const p=v.useMemo(()=>({onKeyDown(){_.current=!0},onWheel(){_.current=!1},onPointerMove(){_.current=!1},onScroll(){const y=h?.current||o.floating;if(!(!u.current||!y||!_.current)){if(x.current!==null){const C=y.scrollTop-x.current;(u.current.bottom<-.5&&C<-1||u.current.top<-.5&&C>1)&&Ne.flushSync(()=>g(b=>b+C))}requestAnimationFrame(()=>{x.current=y.scrollTop})}}}),[o.floating,g,u,h]);return v.useMemo(()=>a?{floating:p}:{},[a,p])}let Ye=v.createContext({styles:void 0,setReference:()=>{},setFloating:()=>{},getReferenceProps:()=>({}),getFloatingProps:()=>({}),slot:{}});Ye.displayName="FloatingContext";let Zt=v.createContext(null);Zt.displayName="PlacementContext";function Ea(t){return v.useMemo(()=>t?typeof t=="string"?{to:t}:t:null,[t])}function ka(){return v.useContext(Ye).setReference}function Ta(){return v.useContext(Ye).getReferenceProps}function Ma(){let{getFloatingProps:t,slot:e}=v.useContext(Ye);return v.useCallback((...s)=>Object.assign({},t(...s),{"data-anchor":e.anchor}),[t,e])}function Ra(t=null){t===!1&&(t=null),typeof t=="string"&&(t={to:t});let e=v.useContext(Zt),s=v.useMemo(()=>t,[JSON.stringify(t,(a,u)=>{var h;return(h=u?.outerHTML)!=null?h:u})]);Fe(()=>{e?.(s??null)},[e,s]);let o=v.useContext(Ye);return v.useMemo(()=>[o.setFloating,t?o.styles:{}],[o.setFloating,t,o.styles])}let En=4;function Aa({children:t,enabled:e=!0}){let[s,o]=v.useState(null),[a,u]=v.useState(0),h=v.useRef(null),[c,g]=v.useState(null);Ba(c);let _=e&&s!==null&&c!==null,{to:x="bottom",gap:I=0,offset:p=0,padding:y=0,inner:C}=Na(s,c),[b,k="center"]=x.split(" ");Fe(()=>{_&&u(0)},[_]);let{refs:F,floatingStyles:N,context:R}=Ia({open:_,placement:b==="selection"?k==="center"?"bottom":`bottom-${k}`:k==="center"?`${b}`:`${b}-${k}`,strategy:"absolute",transform:!1,middleware:[tr({mainAxis:b==="selection"?0:I,crossAxis:p}),Hs({padding:y}),b!=="selection"&&zs({padding:y}),b==="selection"&&C?Sa({...C,padding:y,overflowRef:h,offset:a,minItemsVisible:En,referenceOverflowThreshold:y,onFallbackChange(J){var X,P;if(!J)return;let W=R.elements.floating;if(!W)return;let K=parseFloat(getComputedStyle(W).scrollPaddingBottom)||0,z=Math.min(En,W.childElementCount),M=0,V=0;for(let G of(P=(X=R.elements.floating)==null?void 0:X.childNodes)!=null?P:[])if(G instanceof HTMLElement){let ie=G.offsetTop,T=ie+G.clientHeight+K,S=W.scrollTop,ae=S+W.clientHeight;if(ie>=S&&T<=ae)z--;else{V=Math.max(0,Math.min(T,ae)-Math.max(ie,S)),M=G.clientHeight;break}}z>=1&&u(G=>{let ie=M*z-V+K;return G>=ie?G:ie})}}):null,Vs({padding:y,apply({availableWidth:J,availableHeight:X,elements:P}){Object.assign(P.floating.style,{overflow:"auto",maxWidth:`${J}px`,maxHeight:`min(var(--anchor-max-height, 100vh), ${X}px)`})}})].filter(Boolean),whileElementsMounted:rs}),[U=b,q=k]=R.placement.split("-");b==="selection"&&(U="selection");let $=v.useMemo(()=>({anchor:[U,q].filter(Boolean).join(" ")}),[U,q]),ne=ba(R,{overflowRef:h,onChange:u}),{getReferenceProps:D,getFloatingProps:L}=Ca([ne]),re=he(J=>{g(J),F.setFloating(J)});return v.createElement(Zt.Provider,{value:o},v.createElement(Ye.Provider,{value:{setFloating:re,setReference:F.setReference,styles:N,getReferenceProps:D,getFloatingProps:L,slot:$}},t))}function Ba(t){Fe(()=>{if(!t)return;let e=new MutationObserver(()=>{let s=window.getComputedStyle(t).maxHeight,o=parseFloat(s);if(isNaN(o))return;let a=parseInt(s);isNaN(a)||o!==a&&(t.style.maxHeight=`${Math.ceil(o)}px`)});return e.observe(t,{attributes:!0,attributeFilter:["style"]}),()=>{e.disconnect()}},[t])}function Na(t,e){var s,o,a;let u=At((s=t?.gap)!=null?s:"var(--anchor-gap, 0)",e),h=At((o=t?.offset)!=null?o:"var(--anchor-offset, 0)",e),c=At((a=t?.padding)!=null?a:"var(--anchor-padding, 0)",e);return{...t,gap:u,offset:h,padding:c}}function At(t,e,s=void 0){let o=nr(),a=he((g,_)=>{if(g==null)return[s,null];if(typeof g=="number")return[g,null];if(typeof g=="string"){if(!_)return[s,null];let x=kn(g,_);return[x,I=>{let p=Dr(g);{let y=p.map(C=>window.getComputedStyle(_).getPropertyValue(C));o.requestAnimationFrame(function C(){o.nextFrame(C);let b=!1;for(let[F,N]of p.entries()){let R=window.getComputedStyle(_).getPropertyValue(N);if(y[F]!==R){y[F]=R,b=!0;break}}if(!b)return;let k=kn(g,_);x!==k&&(I(k),x=k)})}return o.dispose}]}return[s,null]}),u=v.useMemo(()=>a(t,e)[0],[t,e]),[h=u,c]=v.useState();return Fe(()=>{let[g,_]=a(t,e);if(c(g),!!_)return _(c)},[t,e]),h}function Dr(t){let e=/var\((.*)\)/.exec(t);if(e){let s=e[1].indexOf(",");if(s===-1)return[e[1]];let o=e[1].slice(0,s).trim(),a=e[1].slice(s+1).trim();return a?[o,...Dr(a)]:[o]}return[]}function kn(t,e){let s=document.createElement("div");e.appendChild(s),s.style.setProperty("margin-top","0px","important"),s.style.setProperty("margin-top",t,"important");let o=parseFloat(window.getComputedStyle(s).marginTop)||0;return e.removeChild(s),o}var Fa=(t=>(t[t.Open=0]="Open",t[t.Closed=1]="Closed",t))(Fa||{}),ja=(t=>(t[t.Pointer=0]="Pointer",t[t.Other=1]="Other",t))(ja||{}),Da=(t=>(t[t.OpenMenu=0]="OpenMenu",t[t.CloseMenu=1]="CloseMenu",t[t.GoToItem=2]="GoToItem",t[t.Search=3]="Search",t[t.ClearSearch=4]="ClearSearch",t[t.RegisterItem=5]="RegisterItem",t[t.UnregisterItem=6]="UnregisterItem",t[t.SetButtonElement=7]="SetButtonElement",t[t.SetItemsElement=8]="SetItemsElement",t))(Da||{});function Bt(t,e=s=>s){let s=t.activeItemIndex!==null?t.items[t.activeItemIndex]:null,o=Io(e(t.items.slice()),u=>u.dataRef.current.domRef.current),a=s?o.indexOf(s):null;return a===-1&&(a=null),{items:o,activeItemIndex:a}}let Pa={1(t){return t.menuState===1?t:{...t,activeItemIndex:null,menuState:1}},0(t){return t.menuState===0?t:{...t,__demoMode:!1,menuState:0}},2:(t,e)=>{var s,o,a,u,h;if(t.menuState===1)return t;let c={...t,searchQuery:"",activationTrigger:(s=e.trigger)!=null?s:1,__demoMode:!1};if(e.focus===me.Nothing)return{...c,activeItemIndex:null};if(e.focus===me.Specific)return{...c,activeItemIndex:t.items.findIndex(x=>x.id===e.id)};if(e.focus===me.Previous){let x=t.activeItemIndex;if(x!==null){let I=t.items[x].dataRef.current.domRef,p=Tt(e,{resolveItems:()=>t.items,resolveActiveIndex:()=>t.activeItemIndex,resolveId:y=>y.id,resolveDisabled:y=>y.dataRef.current.disabled});if(p!==null){let y=t.items[p].dataRef.current.domRef;if(((o=I.current)==null?void 0:o.previousElementSibling)===y.current||((a=y.current)==null?void 0:a.previousElementSibling)===null)return{...c,activeItemIndex:p}}}}else if(e.focus===me.Next){let x=t.activeItemIndex;if(x!==null){let I=t.items[x].dataRef.current.domRef,p=Tt(e,{resolveItems:()=>t.items,resolveActiveIndex:()=>t.activeItemIndex,resolveId:y=>y.id,resolveDisabled:y=>y.dataRef.current.disabled});if(p!==null){let y=t.items[p].dataRef.current.domRef;if(((u=I.current)==null?void 0:u.nextElementSibling)===y.current||((h=y.current)==null?void 0:h.nextElementSibling)===null)return{...c,activeItemIndex:p}}}}let g=Bt(t),_=Tt(e,{resolveItems:()=>g.items,resolveActiveIndex:()=>g.activeItemIndex,resolveId:x=>x.id,resolveDisabled:x=>x.dataRef.current.disabled});return{...c,...g,activeItemIndex:_}},3:(t,e)=>{let s=t.searchQuery!==""?0:1,o=t.searchQuery+e.value.toLowerCase(),a=(t.activeItemIndex!==null?t.items.slice(t.activeItemIndex+s).concat(t.items.slice(0,t.activeItemIndex+s)):t.items).find(h=>{var c;return((c=h.dataRef.current.textValue)==null?void 0:c.startsWith(o))&&!h.dataRef.current.disabled}),u=a?t.items.indexOf(a):-1;return u===-1||u===t.activeItemIndex?{...t,searchQuery:o}:{...t,searchQuery:o,activeItemIndex:u,activationTrigger:1}},4(t){return t.searchQuery===""?t:{...t,searchQuery:"",searchActiveItemIndex:null}},5:(t,e)=>{let s=Bt(t,o=>[...o,{id:e.id,dataRef:e.dataRef}]);return{...t,...s}},6:(t,e)=>{let s=Bt(t,o=>{let a=o.findIndex(u=>u.id===e.id);return a!==-1&&o.splice(a,1),o});return{...t,...s,activationTrigger:1}},7:(t,e)=>t.buttonElement===e.element?t:{...t,buttonElement:e.element},8:(t,e)=>t.itemsElement===e.element?t:{...t,itemsElement:e.element}},en=v.createContext(null);en.displayName="MenuContext";function vt(t){let e=v.useContext(en);if(e===null){let s=new Error(`<${t} /> is missing a parent <Menu /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(s,vt),s}return e}function Ua(t,e){return rr(e.type,Pa,t,e)}let Oa=v.Fragment;function La(t,e){let{__demoMode:s=!1,...o}=t,a=v.useReducer(Ua,{__demoMode:s,menuState:s?0:1,buttonElement:null,itemsElement:null,items:[],searchQuery:"",activeItemIndex:null,activationTrigger:1}),[{menuState:u,itemsElement:h,buttonElement:c},g]=a,_=wt(e);Ks(u===0,[c,h],(y,C)=>{g({type:1}),Qs(C,Ys.Loose)||(y.preventDefault(),c?.focus())});let x=he(()=>{g({type:1})}),I=v.useMemo(()=>({open:u===0,close:x}),[u,x]),p={ref:_};return Oe.createElement(Aa,null,Oe.createElement(en.Provider,{value:a},Oe.createElement(Js,{value:rr(u,{0:dt.Open,1:dt.Closed})},He({ourProps:p,theirProps:o,slot:I,defaultTag:Oa,name:"Menu"}))))}let qa="button";function Wa(t,e){var s;let o=v.useId(),{id:a=`headlessui-menu-button-${o}`,disabled:u=!1,autoFocus:h=!1,...c}=t,[g,_]=vt("Menu.Button"),x=Ta(),I=Xs(),p=wt(e,ka(),he(D=>_({type:7,element:D}))),y=he(D=>{switch(D.key){case de.Space:case de.Enter:case de.ArrowDown:D.preventDefault(),D.stopPropagation(),Ne.flushSync(()=>_({type:0})),_({type:2,focus:me.First});break;case de.ArrowUp:D.preventDefault(),D.stopPropagation(),Ne.flushSync(()=>_({type:0})),_({type:2,focus:me.Last});break}}),C=he(D=>{switch(D.key){case de.Space:D.preventDefault();break}}),b=he(D=>{var L;if(Zs(D.currentTarget))return D.preventDefault();u||(g.menuState===0?(Ne.flushSync(()=>_({type:1})),(L=g.buttonElement)==null||L.focus({preventScroll:!0})):(D.preventDefault(),_({type:0})))}),{isFocusVisible:k,focusProps:F}=eo({autoFocus:h}),{isHovered:N,hoverProps:R}=to({isDisabled:u}),{pressed:U,pressProps:q}=no({disabled:u}),$=v.useMemo(()=>({open:g.menuState===0,active:U||g.menuState===0,disabled:u,hover:N,focus:k,autofocus:h}),[g,N,k,U,u,h]),ne=sr(x(),{ref:p,id:a,type:ro(t,g.buttonElement),"aria-haspopup":"menu","aria-controls":(s=g.itemsElement)==null?void 0:s.id,"aria-expanded":g.menuState===0,disabled:u||void 0,autoFocus:h,onKeyDown:y,onKeyUp:C,onClick:b},F,R,q);return He({mergeRefs:I,ourProps:ne,theirProps:c,slot:$,defaultTag:qa,name:"Menu.Button"})}let $a="div",Ga=dn.RenderStrategy|dn.Static;function Ha(t,e){var s,o;let a=v.useId(),{id:u=`headlessui-menu-items-${a}`,anchor:h,portal:c=!1,modal:g=!0,transition:_=!1,...x}=t,I=Ea(h),[p,y]=vt("Menu.Items"),[C,b]=Ra(I),k=Ma(),[F,N]=v.useState(null),R=wt(e,I?C:null,he(M=>y({type:8,element:M})),N),U=so(p.itemsElement);I&&(c=!0);let q=oo(),[$,ne]=io(_,F,q!==null?(q&dt.Open)===dt.Open:p.menuState===0);ao($,p.buttonElement,()=>{y({type:1})});let D=p.__demoMode?!1:g&&p.menuState===0;co(D,U);let L=p.__demoMode?!1:g&&p.menuState===0;lo(L,{allowed:v.useCallback(()=>[p.buttonElement,p.itemsElement],[p.buttonElement,p.itemsElement])});let re=p.menuState!==0,J=uo(re,p.buttonElement)?!1:$;v.useEffect(()=>{let M=p.itemsElement;M&&p.menuState===0&&M!==U?.activeElement&&M.focus({preventScroll:!0})},[p.menuState,p.itemsElement,U]),ho(p.menuState===0,{container:p.itemsElement,accept(M){return M.getAttribute("role")==="menuitem"?NodeFilter.FILTER_REJECT:M.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(M){M.setAttribute("role","none")}});let X=nr(),P=he(M=>{var V,G,ie;switch(X.dispose(),M.key){case de.Space:if(p.searchQuery!=="")return M.preventDefault(),M.stopPropagation(),y({type:3,value:M.key});case de.Enter:if(M.preventDefault(),M.stopPropagation(),y({type:1}),p.activeItemIndex!==null){let{dataRef:T}=p.items[p.activeItemIndex];(G=(V=T.current)==null?void 0:V.domRef.current)==null||G.click()}or(p.buttonElement);break;case de.ArrowDown:return M.preventDefault(),M.stopPropagation(),y({type:2,focus:me.Next});case de.ArrowUp:return M.preventDefault(),M.stopPropagation(),y({type:2,focus:me.Previous});case de.Home:case de.PageUp:return M.preventDefault(),M.stopPropagation(),y({type:2,focus:me.First});case de.End:case de.PageDown:return M.preventDefault(),M.stopPropagation(),y({type:2,focus:me.Last});case de.Escape:M.preventDefault(),M.stopPropagation(),Ne.flushSync(()=>y({type:1})),(ie=p.buttonElement)==null||ie.focus({preventScroll:!0});break;case de.Tab:M.preventDefault(),M.stopPropagation(),Ne.flushSync(()=>y({type:1})),fo(p.buttonElement,M.shiftKey?hn.Previous:hn.Next);break;default:M.key.length===1&&(y({type:3,value:M.key}),X.setTimeout(()=>y({type:4}),350));break}}),W=he(M=>{switch(M.key){case de.Space:M.preventDefault();break}}),K=v.useMemo(()=>({open:p.menuState===0}),[p.menuState]),z=sr(I?k():{},{"aria-activedescendant":p.activeItemIndex===null||(s=p.items[p.activeItemIndex])==null?void 0:s.id,"aria-labelledby":(o=p.buttonElement)==null?void 0:o.id,id:u,onKeyDown:P,onKeyUp:W,role:"menu",tabIndex:p.menuState===0?0:void 0,ref:R,style:{...x.style,...b,"--button-width":po(p.buttonElement,!0).width},...mo(ne)});return Oe.createElement(go,{enabled:c?t.static||$:!1},He({ourProps:z,theirProps:x,slot:K,defaultTag:$a,features:Ga,visible:J,name:"Menu.Items"}))}let za=v.Fragment;function Va(t,e){let s=v.useId(),{id:o=`headlessui-menu-item-${s}`,disabled:a=!1,...u}=t,[h,c]=vt("Menu.Item"),g=h.activeItemIndex!==null?h.items[h.activeItemIndex].id===o:!1,_=v.useRef(null),x=wt(e,_);Fe(()=>{if(!h.__demoMode&&h.menuState===0&&g&&h.activationTrigger!==0)return yo().requestAnimationFrame(()=>{var L,re;(re=(L=_.current)==null?void 0:L.scrollIntoView)==null||re.call(L,{block:"nearest"})})},[h.__demoMode,_,g,h.menuState,h.activationTrigger,h.activeItemIndex]);let I=_o(_),p=v.useRef({disabled:a,domRef:_,get textValue(){return I()}});Fe(()=>{p.current.disabled=a},[p,a]),Fe(()=>(c({type:5,id:o,dataRef:p}),()=>c({type:6,id:o})),[p,o]);let y=he(()=>{c({type:1})}),C=he(L=>{if(a)return L.preventDefault();c({type:1}),or(h.buttonElement)}),b=he(()=>{if(a)return c({type:2,focus:me.Nothing});c({type:2,focus:me.Specific,id:o})}),k=wo(),F=he(L=>{k.update(L),!a&&(g||c({type:2,focus:me.Specific,id:o,trigger:0}))}),N=he(L=>{k.wasMoved(L)&&(a||g||c({type:2,focus:me.Specific,id:o,trigger:0}))}),R=he(L=>{k.wasMoved(L)&&(a||g&&c({type:2,focus:me.Nothing}))}),[U,q]=ir(),[$,ne]=xo(),D=v.useMemo(()=>({active:g,focus:g,disabled:a,close:y}),[g,a,y]);return Oe.createElement(q,null,Oe.createElement(ne,null,He({ourProps:{id:o,ref:x,role:"menuitem",tabIndex:a===!0?void 0:-1,"aria-disabled":a===!0?!0:void 0,"aria-labelledby":U,"aria-describedby":$,disabled:void 0,onClick:C,onFocus:b,onPointerEnter:F,onMouseEnter:F,onPointerMove:N,onMouseMove:N,onPointerLeave:R,onMouseLeave:R},theirProps:u,slot:D,defaultTag:za,name:"Menu.Item"})))}let Ka="div";function Qa(t,e){let[s,o]=ir();return Oe.createElement(o,null,He({ourProps:{ref:e,"aria-labelledby":s,role:"group"},theirProps:t,slot:{},defaultTag:Ka,name:"Menu.Section"}))}let Ya="header";function Ja(t,e){let s=v.useId(),{id:o=`headlessui-menu-heading-${s}`,...a}=t,u=vo();Fe(()=>u.register(o),[o,u.register]);let h={id:o,ref:e,role:"presentation",...u.props};return He({ourProps:h,theirProps:a,slot:{},defaultTag:Ya,name:"Menu.Heading"})}let Xa="div";function Za(t,e){return He({ourProps:{ref:e,role:"separator"},theirProps:t,slot:{},defaultTag:Xa,name:"Menu.Separator"})}let ec=Ge(La),tc=Ge(Wa),nc=Ge(Ha),rc=Ge(Va),sc=Ge(Qa),oc=Ge(Ja),ic=Ge(Za),Xe=Object.assign(ec,{Button:tc,Items:nc,Item:rc,Section:sc,Heading:oc,Separator:ic});function ac({show:t,appear:e,children:s}){return d.jsx(Co,{as:v.Fragment,enter:"transition ease-out duration-200",enterFrom:"opacity-0 translate-y-1",enterTo:"opacity-100 translate-y-0",leave:"transition ease-in duration-150",leaveFrom:"opacity-100 translate-y-0",leaveTo:"opacity-0 translate-y-1",show:t,appear:e,children:s})}function Be({onClick:t,href:e,target:s,children:o,disabled:a,icon:u,testId:h}){const c=tt();return d.jsx(Xe.Item,{disabled:a,children:({active:g})=>d.jsxs(It,{onClick:t,href:e,target:s,className:je({"bg-token-sidebar-surface-secondary":g,"hover:bg-token-sidebar-surface-secondary":!g&&!a||c}),"data-testid":h,children:[u&&d.jsx(u,{className:"icon-md"}),o]})})}function cc({to:t,children:e,icon:s}){return d.jsx(Xe.Item,{children:({active:o})=>d.jsx(ss,{to:t,children:d.jsxs(It,{$as:"span",className:je(o?"bg-token-sidebar-surface-secondary":"cursor-pointer"),children:[s&&d.jsx(s,{className:"icon-md"}),e]})})})}Ze.a`p-2 rounded-md hover:bg-black/10 hover:dark:bg-white/10 cursor-pointer`;const It=Ze.a`flex gap-2 rounded p-2.5 text-sm cursor-pointer focus:ring-0 hover:bg-token-main-surface-secondary radix-disabled:pointer-events-none radix-disabled:opacity-50 group items-center`,jl=Ze(It)`border dark:border-white/20 min-h-0 hover:bg-gray-500/10 h-10 rounded-lg border-[rgba(0,0,0,0.1)]`,Ot=Ze.div`h-px bg-token-border-light my-1.5`,Dl=Ze(It)`${t=>t.$active?"bg-token-sidebar-surface-secondary":"hover:bg-token-sidebar-surface-secondary"}`;function Pr({menuItemComponent:t}){const e=ve(),s=$e(),o=v.useCallback(()=>{A.logEvent(B.clickSidebarAccountPortalMenuItem),Vt(s,"Sidebar account menu item")},[s]),{value:a}=qt("1028682714"),u=Wt(()=>mt(()=>import("./sso-bm4fdyk2eb045br6.js").then(h=>h.M),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52])).then(h=>h.default));return d.jsxs(d.Fragment,{children:[e?.hasPaidSubscription()&&(a?d.jsx(u,{handleClickCustomerPortal:o,menuItemComponent:t}):d.jsx(t,{onClick:o,icon:pi,children:d.jsx(O,{id:"popoverNavigation.myPlan",defaultMessage:"My plan"})})),e?.canInteractWithGizmos()&&d.jsx(t,{onClick:()=>{A.logEvent(B.accountMenuClickMyGPTs),s(kr())},icon:fr,children:d.jsx(O,{id:"popoverNavigation.myGpts",defaultMessage:"My GPTs"})}),d.jsx(t,{icon:pr,onClick:()=>{_e.openModal(We.UserContext),A.logEvent(B.accountMenuClickCustomizeChatGPT)},children:d.jsx(O,{id:"popoverNavigation.chatPreferences.1",defaultMessage:"Customize ChatGPT"})})]})}function Ur({menuItemComponent:t,routedMenuItemComponent:e}){const s=ve(),o=os("2756095923")?.value&&s?.isEdu()&&s?.isStandardUserOfAccount();return d.jsxs(d.Fragment,{children:[!o&&d.jsx(e,{to:"/admin",icon:mi,children:d.jsx(O,{...Nt.myWorkspaceSettings})}),d.jsx(e,{to:kr(),onClick:()=>{A.logEvent(B.accountMenuClickMyGPTs)},icon:fr,children:d.jsx(O,{...Nt.myGpts})}),d.jsx(t,{onClick:()=>{_e.openModal(We.UserContext),A.logEvent(B.accountMenuClickCustomizeChatGPT)},icon:pr,children:d.jsx(O,{...Nt.chatPreferences})})]})}const Nt=$t({myWorkspaceSettings:{id:"workspacePopoverNavigation.myWorkspaceSettings",defaultMessage:"Manage workspace"},chatPreferences:{id:"B4s/Jz",defaultMessage:"Customize ChatGPT"},myGpts:{id:"workspacePopoverNavigation.myGpts",defaultMessage:"My GPTs"}}),lc=Wt(()=>mt(()=>import("./k5sy9m1ppx4ss01q.js"),__vite__mapDeps([53,1,2,3,13,5,6,12,11,8,54,55,34,35,36,18])));function Pl({onClickSettings:t}){const e=tt();return d.jsxs(Xe,{as:"div",className:je(!e&&"group relative"),children:[d.jsx(fc,{}),d.jsx(ac,{children:d.jsx(Xe.Items,{className:je("popover absolute bottom-full z-50 mb-1 w-full overflow-hidden rounded-lg border border-token-border-light bg-token-main-surface-primary p-1.5 shadow-lg outline-none",e&&"left-3 w-[var(--screen-sidebar-popover-min-width)]",!e&&"left-0"),children:d.jsx(hc,{onClickSettings:t})})})]})}function Or(){const t=!ve()?.isEnterprisey()&&!$n,e=Me(),s=yt(),o=$e();return s?d.jsxs("div",{className:"flex items-center justify-between gap-2 py-2 pl-5 pr-4",children:[d.jsx("div",{className:"text-sm text-token-text-secondary",children:s?.email}),t&&d.jsx(ke,{label:e.formatMessage(Ee.addWorkspaceTooltip),side:"right",children:d.jsx("button",{onClick:()=>Vt(o,"profile menu"),children:d.jsx(vi,{className:"icon-sm text-token-text-primary"})})})]}):null}function uc(){const t=ve();return t==null?d.jsx(d.Fragment,{children:d.jsx("div",{className:"w-full px-3 py-2",children:d.jsx(lt,{})})}):d.jsxs(d.Fragment,{children:[d.jsx(Or,{}),d.jsx("div",{className:"flex h-11 w-full items-center justify-start gap-3 px-3 py-1 text-sm",children:d.jsx(qr,{workspace:t,isLoading:!1,currentWorkspaceId:t.id,showCheck:!1})})]})}function Lr({menuItemComponent:t}){const e=xt(),s=et(),{data:o}=gt(),a=ve(),[u,h]=v.useState(!1),c=yt(),g=Me(),_=Ln();if(!a||!o)return null;const x=a.isWorkspaceAccount(),I=o.accountItems.length>1,p=o.accountItems,y=So([p.find(b=>b.isPersonalAccount()),...p.filter(b=>!b.isPersonalAccount())]);if(y.sort((b,k)=>b.isPersonalAccount()?1:k.isPersonalAccount()?-1:0),!I)return x?d.jsx(uc,{}):d.jsx(d.Fragment,{children:d.jsx("div",{className:"ml-3 mr-2 py-2 text-sm text-token-text-secondary",children:c?.email})});const C=y.map(b=>d.jsx(t,{disabled:b.isDeactivated(),onClick:()=>{if(b.isDeactivated()||b.id===a?.id)return;h(!0);const{willRedirect:k}=is(s,b.id,e,g,_);k||as()},className:"radix-disabled:pointer-events-auto radix-disabled:hover:bg-transparent",children:b.isDeactivated()?d.jsx(dc,{workspace:b,isLoading:u}):d.jsx(qr,{workspace:b,isLoading:u,currentWorkspaceId:a?.id})},b.id));return d.jsxs(d.Fragment,{children:[d.jsx(Or,{}),d.jsx(Y.Separator,{}),C]})}function qr({workspace:t,isLoading:e,currentWorkspaceId:s,showCheck:o=!0}){const a=t.canAccessWithCurrentSession,u=!e&&o&&t.id===s;return d.jsxs("div",{children:[d.jsxs("div",{className:"flex w-full items-center gap-2.5",children:[d.jsx("span",{className:"flex h-5 w-5 items-center justify-center",children:d.jsx(Kt,{iconSize:"small",workspace:t,className:je({"flex-shrink-0":!0})})}),d.jsx("div",{className:"line-clamp-1 text-token-text-primary",children:ar(Me(),t)}),e&&d.jsx(lt,{}),u&&d.jsx("span",{className:"text-token-text-primary",children:d.jsx(gi,{className:"icon-sm"})}),!a&&d.jsx("span",{className:"text-token-text-primary",children:d.jsx(yi,{className:"icon-sm"})})]}),!a&&d.jsx("div",{className:"rowDivClassName",children:d.jsx("small",{className:"text-token-text-secondary",children:d.jsx(O,{...t.ssoConnectionName?Ee.authenticateWithSSOToAccessWorkspace:Ee.authenticateWithoutSSOToAccessWorkspace})})})]})}function dc({workspace:t,isLoading:e}){const s=Me(),o=t.isOwnerOfAccount(),[a,u]=v.useState(!1),h=ki(t.id);return v.useEffect(()=>{h!=null&&a&&(_e.setPurchaseWorkspaceData({minimumSeats:Math.max(h,fn),existingAccount:t}),u(!1))},[h,a,t]),d.jsxs(d.Fragment,{children:[d.jsxs(ke,{className:"flex w-full flex-1 items-center gap-2.5",label:s.formatMessage(Ee.disabledWorkspaceTooltip),sideOffset:20,side:"right",children:[d.jsx("span",{className:"flex h-5 w-5 items-center justify-center",children:d.jsx(_i,{className:"icon-sm flex-shrink-0 opacity-30"})}),d.jsx("div",{className:"truncate opacity-30",children:ar(s,t)})]}),e&&d.jsx(lt,{}),!e&&d.jsxs(Y.Root,{children:[d.jsx(Y.Trigger,{className:"rounded text-center hover:bg-token-main-surface-secondary",children:d.jsx(wi,{className:"icon-sm m-1"})}),d.jsx(Y.Portal,{children:d.jsxs(Y.Content,{children:[o&&d.jsx(d.Fragment,{children:d.jsx(Y.Item,{onClick:()=>{h==null?u(!0):_e.setPurchaseWorkspaceData({minimumSeats:Math.max(h,fn),existingAccount:t})},children:a?d.jsx(lt,{}):d.jsx(O,{id:"navigation.reactivateWorkspace",defaultMessage:"Reactivate workspace"})})}),d.jsx(Y.Item,{onClick:()=>{_e.setLeaveWorkspaceData(t)},children:d.jsx(O,{id:"navigation.leaveWorkspace",defaultMessage:"Leave workspace"})})]})})]})]})}function hc({onClickSettings:t}){const{data:e}=gt(),s=ve(),o=cr(),a=xr(),{openModal:u}=vr(),h=qn("3905879930");var c=s?.isTeam()??!1,g=!1;if(c&&(g=h.config.get("enabled",!1)),!s||!e)return null;const _=s.isWorkspaceAccount(),x=!o;return d.jsxs("nav",{children:[d.jsx(Lr,{menuItemComponent:Be}),d.jsx(Ot,{}),_?d.jsx(Ur,{menuItemComponent:Be,routedMenuItemComponent:cc}):d.jsx(Pr,{menuItemComponent:Be}),x&&d.jsx(Be,{href:bo(),target:"_blank",onClick:()=>{A.logEvent(B.clickFaqLink)},icon:xi,children:d.jsx(O,{...Ee.helpAndFaq})}),d.jsx(Be,{onClick:t,icon:mr,testId:"accounts-settings-button",children:d.jsx(O,{...Ee.settings})}),c&&g&&d.jsxs(d.Fragment,{children:[d.jsx(Be,{onClick:()=>{_e.openModal(We.InviteUsersToWorkspace),A.logEvent(B.accountMemberInviteButton,{location:"dropdown-menu-click"}),oe.logEvent("chatgpt_invite_users_to_workspace",0,{action:"OpenAdminInviteModal",location:"dropdown-menu-click",text:"AddTeammates",step:"OpenModal"})},icon:gr,children:d.jsx(O,{...Ee.addTeammatesButton})}),d.jsx(lc,{workspace:s})]}),a&&d.jsx(pc,{openDownloadModal:u}),d.jsx(Ot,{}),d.jsx(Be,{onClick:()=>{A.logEvent(B.clickLogOut,{eventSource:"mouse"}),Wn()},icon:yr,children:d.jsx(O,{...Ee.logOut})})]})}function fc(){return yt()?d.jsx(mc,{}):null}function pc({openDownloadModal:t}){return d.jsxs("span",{children:[d.jsx(Ot,{}),d.jsx(Be,{icon:_r,onClick:()=>{A.logEvent(B.accountMenuClickDownloadApp),t()},children:d.jsx(O,{...Ee.downloadApp})})]})}function mc(){const{data:t}=gt(),e=ve(),s=Eo(),o=ko(),a=tt();if(!e||!t)return null;const u=e.isWorkspaceAccount(),h=t.accountItems.length>1;return d.jsxs(Xe.Button,{className:je("flex w-full max-w-[100%] items-center gap-2 rounded-lg text-sm hover:bg-token-sidebar-surface-secondary group-ui-open:bg-token-sidebar-surface-secondary",a&&"px-2 py-1",!a&&"p-2"),"data-testid":"accounts-profile-button",children:[d.jsx("div",{className:"flex-shrink-0",children:d.jsx(Kt,{iconSize:"gizmo"})}),d.jsxs("div",{className:"relative -top-px grow -space-y-px truncate text-start text-token-text-primary",children:[d.jsx("div",{dir:"auto",children:o}),u||h?d.jsx("div",{className:"truncate text-xs text-token-text-secondary",dir:"auto",children:s}):null]})]})}const Ee=$t({helpAndFaq:{id:"navigation.helpAndFaq",defaultMessage:"Help & FAQ"},settings:{id:"navigation.settings",defaultMessage:"Settings"},logOut:{id:"navigation.logOut",defaultMessage:"Log out"},accountSwitcherTitle:{id:"navigation.accountSwitcherTitle",defaultMessage:"Workspaces"},defaultWorkspaceTitle:{id:"useWorkspaces.defaultWorkspaceTitle",defaultMessage:"Untitled Workspace"},addWorkspaceTooltip:{id:"navigation.addWorkspaceTooltip",defaultMessage:"Create a Team workspace"},disabledWorkspaceTooltip:{id:"navigation.disabledWorkspaceTooltip",defaultMessage:"This workspace has been deactivated"},downloadApp:{id:"navigation.downloadMacApp",defaultMessage:"Download the macOS app"},authenticateWithSSOToAccessWorkspace:{id:"CV7pdM",defaultMessage:"Authenticate with SSO to access this workspace"},authenticateWithoutSSOToAccessWorkspace:{id:"zfCWFh",defaultMessage:"Authenticate without SSO to access this workspace"},addTeammatesButton:{id:"inviteMemberButton.inviteMemberButton",defaultMessage:"Add Teammates"}});function gc(t){oe.logEvent("chatgpt_web_thread_tap_new_thread"),qe.getItem(Le.HasSeenNewChatModal)===!0?lr(t):(qe.setItem(Le.HasSeenNewChatModal,!0),_e.openModal(We.NoAuthNewChat))}function Ul(){return Ti(We.NoAuthNewChat)?d.jsx(yc,{onClose:()=>{_e.closeModal(We.NoAuthNewChat)}}):null}function yc({onClose:t}){const e=xt(),s=$e(),o=Gn("1934819688"),a=o.config.get("is_redesign_enabled",!1),u=o.config.get("secondary_button_type","cancel"),h=ur(Et.signUpButtonText),c=I=>{I.preventDefault(),e({authType:"signup",callback:p=>{oe.logEvent("chatgpt_new_chat_modal_sign_up_link_clicked"),A.logSignUpButtonClicked({location:"New chat modal",provider:p})}})},g=I=>{I.preventDefault(),e({authType:"login",callback:p=>{oe.logEvent("chatgpt_new_chat_modal_log_in_link_clicked"),A.logLogInButtonClicked({location:"New chat modal",provider:p})}})},_=()=>{oe.logEvent("chatgpt_new_chat_modal_cancel_button_clicked"),A.logEvent(B.newChatModalCancelButtonClicked),t()},x=()=>{oe.logEvent("chatgpt_new_chat_modal_new_chat_button_clicked"),A.logNewChatButtonClicked({location:"New Chat Modal New Chat Button"}),lr(s),t()};return v.useEffect(()=>{oe.logEvent("chatgpt_new_chat_modal_shown"),A.logEvent(B.newChatModalShown)},[]),d.jsx(cs,{isOpen:!0,type:"success",onClose:t,noPadding:!0,size:"custom",className:"max-w-sm",children:d.jsxs("div",{className:"flex flex-col justify-center p-6",children:[d.jsxs("div",{className:"mb-2 grid w-full grid-cols-[1fr,auto,1fr] items-center",children:[d.jsx("div",{}),d.jsx("div",{className:"text-xl font-medium",children:d.jsx(O,{id:"d+R7z5",defaultMessage:"Clear current chat?"})}),d.jsx("div",{className:"flex justify-end",children:a?d.jsx(ls,{onClick:t}):null})]}),d.jsx("p",{className:"mb-6 text-center text-token-text-secondary",children:d.jsx(O,{id:"+Olycu",defaultMessage:"To start a new chat, your current conversation will be discarded. <signup>Sign up</signup> or <login>log in</login> to save chats.",values:{signup:I=>d.jsx("a",{href:"#",className:"font-medium text-token-text-primary",onClick:c,children:I}),login:I=>d.jsx("a",{href:"#",className:"font-medium text-token-text-primary",onClick:g,children:I})}})}),d.jsx(Ue,{className:"mb-3",color:a?"primary":"danger",size:"giant",onClick:x,children:d.jsx(O,{id:"cBGbrD",defaultMessage:"Clear chat"})}),u==="cancel"?d.jsx(Ue,{size:"giant",onClick:_,color:"secondary",children:d.jsx(O,{...Et.cancelButtonText})}):null,u==="login"?d.jsx(Ue,{size:"giant",onClick:()=>{e({authType:"login",callback:I=>{A.logLogInButtonClicked({location:"New chat modal",provider:I})}})},color:"ghost",children:d.jsx(O,{...Et.logInButtonText})}):null,u==="signup"?d.jsx(Ue,{size:"giant",onClick:()=>{e({authType:"signup",callback:I=>{A.logSignUpButtonClicked({location:"New chat modal",provider:I})}})},color:"ghost",children:d.jsx(O,{...h})}):null]})})}function Wr({clientThreadId:t,location:e}){const s=et(),{id:o}=Tr(t),a=Mi(!0),u=$e(),h=Gt(),c=us();return v.useCallback(()=>{Ht(Hn(s))?gc(u):h?u({pathname:c.pathname,search:c.search},{state:To()}):(a({modelId:o,location:e}),oe.logEvent("chatgpt_web_thread_tap_new_thread"))},[s,e,o,a,u,h,c])}function _c(t){return t==null||[xe.PrimaryAssistant,xe.GizmoInteraction].includes(t.kind)}function Ol(t,e){const s=Mr(t,e),{data:o}=Ri(s!=null&&"gizmo_id"in s?s.gizmo_id:void 0,s?.kind===xe.GizmoTest);if(s!=null)switch(s.kind){case xe.GizmoInteraction:case xe.GizmoMagicCreate:case xe.GizmoTest:return{gizmo:o,...s};case xe.PrimaryAssistant:return s}}function wc(t,e,s){const a=E.getTree(e).getMessageId(E.getThreadCurrentLeafId(e));Te.generateTitle(e,a,s).then(({title:u})=>{E.setTitle(e,u,Rr.Generated),Ir(t),A.logEvent(B.renameThread,{threadId:e,content:u,model:s})})}function xc(t,e,s){const o=()=>{const u=xn(s);t(u)},a=pt.getGizmoId(s);a!=null?Ai(e,a).then(u=>{Mo(xn(s,u))}).catch(u=>{we.addError(u),o()}):o()}const Tn={onCreate(t,e,s,o){A.logEvent(B.newThread),!o&&_c(pt.getConversationMode(e))&&ds(s).then(a=>{Ht(a)||(Ir(s),t(e))})},onCreateFinished(t,e,s){if(!(s||!e)&&!oe.checkGate("2562876640")){const o=pt.getThread(e)?.initialThreadData.lastModelUsed;o==null&&we.addError("missing lastModelUsed on conversation create finished"),wc(t,e,o)}}};function Mn(t,e){t.updateNodeMetadata(e.id,{completionSampleFinishTime:Date.now()})}class vc{constructor(e,s,o,a,u,h,c,g,_,x,I,p){this.queryClient=e,this.clientThreadId=s,this.targetNodeId=o,this.completionType=a,this.model=u,this.eventSource=h,this.onCreate=c,this.callModelAgain=_,this.onCompletionFinished=x,this.isHistoryAndTrainingDisabled=p,this.currentTree=E.getTree(s),this.currentNodeId=o,this.activeBranchLastMessage=this.currentTree.getMessage(this.currentNodeId),this.completionLatencyTracker=new Ro(g),this.turnTracker=I,this.turnTracker.onCompletionStarted(a,this.model)}currentTree;currentNodeId;firstResponse=!0;didCreateFirstCompletionInNewThread=!1;activeBranchLastMessage;messagesToUpdate={};allIncompleteStreamedMessages={};responseThreadId;isCompletionBlocked=!1;isEitherFlagged=!1;variantsInStreamInfo;activeBranchNodeId;blurDuringCompletionTracker=new Ao;completionLatencyTracker;turnTracker;debouncedUpdateCompletion=Bo(()=>{this.isCompletionBlocked||E.updateTree(this.clientThreadId,e=>{Object.values(this.messagesToUpdate).forEach(s=>{e.updateNodeMessage(s.id,s)})}),this.messagesToUpdate={}},50,{leading:!0,maxWait:50});handleResponse=async e=>{if(e.type!=="done"&&this.turnTracker.onUpdateEventCount(),this.completionLatencyTracker.onResponse(e,this.activeBranchLastMessage,this.responseThreadId),this.responseThreadId===void 0&&"conversationId"in e){const s=e.conversationId;this.responseThreadId=s,Xt(this.clientThreadId)&&E.getServerThreadId(this.clientThreadId)!==s&&(E.setServerIdForNewThread(this.clientThreadId,s),A.logEvent(B.attributeClientThreadToServerThread,{client_thread_id:this.clientThreadId,server_thread_id:s}))}switch(e.type){case"error":this.handleError(e);break;case"num_variants_in_stream":this.bindVariantInfoToTree(e);break;case"moderation":this.handleModeration(e);break;case"url_moderation":this.handleUrlModeration(e);break;case"message":this.handleMessage(e),this.debouncedUpdateCompletion();break;case"done":this.handleDone();break;case"gizmo_inline_review":this.handleGizmoInlineReview(e);break;case"title_generation":this.handleTitleGeneration(e);break;case"conversation_detail_metadata":this.handleConversationDetailMetadata(e);break}};handleError(e){const s=e.error,o=s?.message||"Something went wrong",a=s instanceof ye&&s.code||"",u=s instanceof ye&&s.status,h=s instanceof ye?s.detail?.can_retry:void 0;switch(this.turnTracker.handleRawError(o,u),E.updateTree(this.clientThreadId,c=>{c.updateNodeMessage(this.currentNodeId,this.activeBranchLastMessage),c.updateNodeMetadata(this.currentNodeId,{err:o,errType:"danger",errCode:a,completionSampleFinishTime:Date.now(),canRetry:h})}),a){case mn.ContentPolicy:case mn.ContentOrTos:case pn:case hs:break;default:o!==void 0&&oe.logEvent("chatgpt_conversation_error_web",o)}if(this.blurDuringCompletionTracker.onMessageError(),this.cleanUp(),this.onCompletionFinished(this.responseThreadId),s instanceof ye&&s.code===pn){const c=s.detail?.clears_in;c&&(No(new Date(Date.now()+c*1e3).toISOString()),setTimeout(()=>{Fo()},c*1e3))}}handleGizmoInlineReview(e){E.setPromptGptRating(this.clientThreadId,e.gizmoId)}handleTitleGeneration(e){E.setTitle(this.clientThreadId,e.title,Rr.Generated)}handleConversationDetailMetadata(e){const{default_model_slug:s}=e;s&&E.setThreadModelId(this.clientThreadId,s),Dt.updateDetails(e)}bindVariantInfoToTree(e){this.variantsInStreamInfo=e,E.updateTree(this.clientThreadId,s=>{const o=s.getParentPromptNode(this.currentNodeId);s.updateNodeMetadata(o.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}handleModeration(e){const{isCompletion:s,messageId:o,conversationId:a,flagged:u,blocked:h,disclaimers:c,metadata:g}=e,_=!!c?.length&&s;(u||h||_)&&(this.isEitherFlagged=!0,h&&s&&(this.isCompletionBlocked=!0),E.updateTree(this.clientThreadId,x=>{const I=x.messageIdToNodeId(o);h&&x.clearNodeMessageParts(I),x.updateNodeMetadata(I,{...(_&&!!c?.length&&jo(c,h))??{},...u&&Do,...h&&(g?.model_incompatibility?Po:Uo),completionSampleFinishTime:Date.now()})}),A.logEvent(s?h?B.completionBlockedByModeration:B.completionFlaggedByModeration:h?B.promptBlockedByModeration:B.promptFlaggedByModeration,{threadId:a,id:o}))}handleUrlModeration(e){const{conversationId:s,url:o,isSafe:a}=e;a&&E.addThreadSafeUrl(s,o)}handleMessage(e){let s=!0;const{message:o,conversationId:a}=e;if(this.turnTracker.onMessageUpdate(o.metadata?.model_slug,o.metadata?.gizmo_id,o.author.name,o.author.role),this.firstResponse&&!this.currentTree.hasReceivedServerCompletion){if(this.currentTree.hasNodeOrMessageId(o.id)&&o.author.role!==Ce.User)return;if(o?.author.role===Ce.System||o?.author.role===Ce.Developer){if((o.metadata?.parent_id?this.currentTree.getNodeByIdOrMessageId(o.metadata.parent_id):void 0)?.message.author.role!==Ce.User){this.currentTree.appendSystemMessageToRoot(o);return}}else if(o?.author.role===Ce.User)return E.updateTree(this.clientThreadId,u=>{u.updateNodeMessage(o.id,o)})}if(this.firstResponse&&o.metadata?.rebase_system_message){E.updateTree(this.clientThreadId,u=>{if(o.metadata?.parent_id==null)throw Error("Unexpected rebased system message without parent");const h=u.getNodeByIdOrMessageId(this.targetNodeId);u.deleteNode(this.targetNodeId),u.addNode(o.id,o,o.metadata.parent_id,o.author.role),u.addNode(h.id,h.message,o.id,h.message.author.role)});return}if(this.firstResponse){const u=ft.getState().threads[this.clientThreadId]?.continuingFromSharedConversationId!=null;E.removeContinuingFromSharedConversationId(this.clientThreadId),this.firstResponse=!1,this.didCreateFirstCompletionInNewThread=!this.currentTree.hasReceivedServerCompletion||u,E.updateTree(this.clientThreadId,c=>{c.updateNodeMessage(this.currentNodeId,o)}),this.didCreateFirstCompletionInNewThread&&Tn.onCreate(this.onCreate,a,this.queryClient,this.isHistoryAndTrainingDisabled);const h={id:this.targetNodeId,threadId:a,completionType:this.completionType,eventSource:this.eventSource,model:this.model};if(this.completionType===Qe.Next){const c=ft.getState().threads[a],g=c?.conversationTurns?.length,_=c?.conversationTurns?.filter(I=>I.role==Ce.User),x=_&&_[_.length-1]?.messages[0].message;if(x?.content.content_type==fs.Text){const I=x.content.parts.join("").length,p=_?.length??0;h.countConversationTurns=g,h.countUserSubmittedMessages=p,h.countLastUserPromptTextMessageLength=I}}A.logEvent(B.generateCompletion,h)}else if(this.completionType!==Qe.Continue){const u=this.currentTree.containsNodeOrMessageId(o.id),h=o.metadata?.parent_id;if(u||(this.debouncedUpdateCompletion.flush(),E.updateTree(this.clientThreadId,c=>{if(h==null)throw new Error(`Received a message with no parentId: ${JSON.stringify(o)}`);c.addNode(o.id,o,h,Ce.Assistant)})),h!=null&&h===this.activeBranchNodeId){const c=this.allIncompleteStreamedMessages[h];c!=null&&(E.updateTree(this.clientThreadId,g=>{Mn(g,c)}),delete this.allIncompleteStreamedMessages[h])}if(s=(this.variantsInStreamInfo?.num_variants_in_stream??1)===1||this.activeBranchNodeId==null||this.activeBranchNodeId===o.id||this.currentTree.isAncestorOfNode(this.activeBranchNodeId,o.id),s&&this.activeBranchNodeId!==o.id){this.activeBranchNodeId=o.id,this.currentNodeId=o.id;const c=E.getThreadCurrentLeafId(this.clientThreadId);this.currentTree.messageIdToNodeId(this.currentNodeId)!==this.currentTree.messageIdToNodeId(c)&&E.setThreadCurrentLeafId(this.clientThreadId,this.currentNodeId),h!=null&&E.updateTree(this.clientThreadId,g=>{const _=g.getParentPromptNode(o.id);g.updateNodeMetadata(_.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}}if(o?.author.role===Ce.Tool&&o?.author.name==="bio"){const u=o.metadata?.gizmo_id;setTimeout(()=>{this.queryClient.invalidateQueries({queryKey:Oo(u)})},5e3)}s&&(this.activeBranchLastMessage=o),this.messagesToUpdate[o.id]=o,this.allIncompleteStreamedMessages[o.id]=o}async handleDone(){if(this.turnTracker.model_message_update_count>0?this.turnTracker.logCompletion({type:ht.Success}):this.turnTracker.logCompletion({type:ht.Error,error:{reason:"empty_response",message:"Successful completion ended with no messages"}}),this.isCompletionBlocked||(this.debouncedUpdateCompletion.flush(),this.isEitherFlagged||(this.didCreateFirstCompletionInNewThread&&Tn.onCreateFinished(this.queryClient,this.responseThreadId,this.isHistoryAndTrainingDisabled),this.onCompletionFinished(this.responseThreadId))),E.updateTree(this.clientThreadId,e=>{Object.values(this.allIncompleteStreamedMessages).forEach(s=>{Mn(e,s)})}),dr.publish({kind:"createConversation",clientThreadId:this.clientThreadId}),this.blurDuringCompletionTracker.onMessageDone(),this.cleanUp(),this.activeBranchLastMessage?.metadata?.client_actions!==void 0){const e=await Lo(this.clientThreadId,this.activeBranchLastMessage);e.length>0&&this.callModelAgain(this.currentNodeId,e)}}cleanUp(){setTimeout(()=>{Cr(this.clientThreadId,{source:zn.CLIENT,value:Vn.UNREAD}),Qt.removeRequest(this.targetNodeId),E.releaseThread(this.clientThreadId)},0)}}/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(t){const e=qo,s=Wo,o=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;t.Buffer=c,t.SlowBuffer=N,t.INSPECT_MAX_BYTES=50;const a=2147483647;t.kMaxLength=a,c.TYPED_ARRAY_SUPPORT=u(),!c.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function u(){try{const i=new Uint8Array(1),n={foo:function(){return 42}};return Object.setPrototypeOf(n,Uint8Array.prototype),Object.setPrototypeOf(i,n),i.foo()===42}catch{return!1}}Object.defineProperty(c.prototype,"parent",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.buffer}}),Object.defineProperty(c.prototype,"offset",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.byteOffset}});function h(i){if(i>a)throw new RangeError('The value "'+i+'" is invalid for option "size"');const n=new Uint8Array(i);return Object.setPrototypeOf(n,c.prototype),n}function c(i,n,r){if(typeof i=="number"){if(typeof n=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return I(i)}return g(i,n,r)}c.poolSize=8192;function g(i,n,r){if(typeof i=="string")return p(i,n);if(ArrayBuffer.isView(i))return C(i);if(i==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof i);if(Ie(i,ArrayBuffer)||i&&Ie(i.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(Ie(i,SharedArrayBuffer)||i&&Ie(i.buffer,SharedArrayBuffer)))return b(i,n,r);if(typeof i=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const l=i.valueOf&&i.valueOf();if(l!=null&&l!==i)return c.from(l,n,r);const f=k(i);if(f)return f;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof i[Symbol.toPrimitive]=="function")return c.from(i[Symbol.toPrimitive]("string"),n,r);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof i)}c.from=function(i,n,r){return g(i,n,r)},Object.setPrototypeOf(c.prototype,Uint8Array.prototype),Object.setPrototypeOf(c,Uint8Array);function _(i){if(typeof i!="number")throw new TypeError('"size" argument must be of type number');if(i<0)throw new RangeError('The value "'+i+'" is invalid for option "size"')}function x(i,n,r){return _(i),i<=0?h(i):n!==void 0?typeof r=="string"?h(i).fill(n,r):h(i).fill(n):h(i)}c.alloc=function(i,n,r){return x(i,n,r)};function I(i){return _(i),h(i<0?0:F(i)|0)}c.allocUnsafe=function(i){return I(i)},c.allocUnsafeSlow=function(i){return I(i)};function p(i,n){if((typeof n!="string"||n==="")&&(n="utf8"),!c.isEncoding(n))throw new TypeError("Unknown encoding: "+n);const r=R(i,n)|0;let l=h(r);const f=l.write(i,n);return f!==r&&(l=l.slice(0,f)),l}function y(i){const n=i.length<0?0:F(i.length)|0,r=h(n);for(let l=0;l<n;l+=1)r[l]=i[l]&255;return r}function C(i){if(Ie(i,Uint8Array)){const n=new Uint8Array(i);return b(n.buffer,n.byteOffset,n.byteLength)}return y(i)}function b(i,n,r){if(n<0||i.byteLength<n)throw new RangeError('"offset" is outside of buffer bounds');if(i.byteLength<n+(r||0))throw new RangeError('"length" is outside of buffer bounds');let l;return n===void 0&&r===void 0?l=new Uint8Array(i):r===void 0?l=new Uint8Array(i,n):l=new Uint8Array(i,n,r),Object.setPrototypeOf(l,c.prototype),l}function k(i){if(c.isBuffer(i)){const n=F(i.length)|0,r=h(n);return r.length===0||i.copy(r,0,0,n),r}if(i.length!==void 0)return typeof i.length!="number"||St(i.length)?h(0):y(i);if(i.type==="Buffer"&&Array.isArray(i.data))return y(i.data)}function F(i){if(i>=a)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+a.toString(16)+" bytes");return i|0}function N(i){return+i!=i&&(i=0),c.alloc(+i)}c.isBuffer=function(n){return n!=null&&n._isBuffer===!0&&n!==c.prototype},c.compare=function(n,r){if(Ie(n,Uint8Array)&&(n=c.from(n,n.offset,n.byteLength)),Ie(r,Uint8Array)&&(r=c.from(r,r.offset,r.byteLength)),!c.isBuffer(n)||!c.isBuffer(r))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(n===r)return 0;let l=n.length,f=r.length;for(let m=0,w=Math.min(l,f);m<w;++m)if(n[m]!==r[m]){l=n[m],f=r[m];break}return l<f?-1:f<l?1:0},c.isEncoding=function(n){switch(String(n).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},c.concat=function(n,r){if(!Array.isArray(n))throw new TypeError('"list" argument must be an Array of Buffers');if(n.length===0)return c.alloc(0);let l;if(r===void 0)for(r=0,l=0;l<n.length;++l)r+=n[l].length;const f=c.allocUnsafe(r);let m=0;for(l=0;l<n.length;++l){let w=n[l];if(Ie(w,Uint8Array))m+w.length>f.length?(c.isBuffer(w)||(w=c.from(w)),w.copy(f,m)):Uint8Array.prototype.set.call(f,w,m);else if(c.isBuffer(w))w.copy(f,m);else throw new TypeError('"list" argument must be an Array of Buffers');m+=w.length}return f};function R(i,n){if(c.isBuffer(i))return i.length;if(ArrayBuffer.isView(i)||Ie(i,ArrayBuffer))return i.byteLength;if(typeof i!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof i);const r=i.length,l=arguments.length>2&&arguments[2]===!0;if(!l&&r===0)return 0;let f=!1;for(;;)switch(n){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":return Ct(i).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return r*2;case"hex":return r>>>1;case"base64":return rn(i).length;default:if(f)return l?-1:Ct(i).length;n=(""+n).toLowerCase(),f=!0}}c.byteLength=R;function U(i,n,r){let l=!1;if((n===void 0||n<0)&&(n=0),n>this.length||((r===void 0||r>this.length)&&(r=this.length),r<=0)||(r>>>=0,n>>>=0,r<=n))return"";for(i||(i="utf8");;)switch(i){case"hex":return G(this,n,r);case"utf8":case"utf-8":return W(this,n,r);case"ascii":return M(this,n,r);case"latin1":case"binary":return V(this,n,r);case"base64":return P(this,n,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ie(this,n,r);default:if(l)throw new TypeError("Unknown encoding: "+i);i=(i+"").toLowerCase(),l=!0}}c.prototype._isBuffer=!0;function q(i,n,r){const l=i[n];i[n]=i[r],i[r]=l}c.prototype.swap16=function(){const n=this.length;if(n%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let r=0;r<n;r+=2)q(this,r,r+1);return this},c.prototype.swap32=function(){const n=this.length;if(n%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let r=0;r<n;r+=4)q(this,r,r+3),q(this,r+1,r+2);return this},c.prototype.swap64=function(){const n=this.length;if(n%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let r=0;r<n;r+=8)q(this,r,r+7),q(this,r+1,r+6),q(this,r+2,r+5),q(this,r+3,r+4);return this},c.prototype.toString=function(){const n=this.length;return n===0?"":arguments.length===0?W(this,0,n):U.apply(this,arguments)},c.prototype.toLocaleString=c.prototype.toString,c.prototype.equals=function(n){if(!c.isBuffer(n))throw new TypeError("Argument must be a Buffer");return this===n?!0:c.compare(this,n)===0},c.prototype.inspect=function(){let n="";const r=t.INSPECT_MAX_BYTES;return n=this.toString("hex",0,r).replace(/(.{2})/g,"$1 ").trim(),this.length>r&&(n+=" ... "),"<Buffer "+n+">"},o&&(c.prototype[o]=c.prototype.inspect),c.prototype.compare=function(n,r,l,f,m){if(Ie(n,Uint8Array)&&(n=c.from(n,n.offset,n.byteLength)),!c.isBuffer(n))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof n);if(r===void 0&&(r=0),l===void 0&&(l=n?n.length:0),f===void 0&&(f=0),m===void 0&&(m=this.length),r<0||l>n.length||f<0||m>this.length)throw new RangeError("out of range index");if(f>=m&&r>=l)return 0;if(f>=m)return-1;if(r>=l)return 1;if(r>>>=0,l>>>=0,f>>>=0,m>>>=0,this===n)return 0;let w=m-f,j=l-r;const ee=Math.min(w,j),Q=this.slice(f,m),te=n.slice(r,l);for(let H=0;H<ee;++H)if(Q[H]!==te[H]){w=Q[H],j=te[H];break}return w<j?-1:j<w?1:0};function $(i,n,r,l,f){if(i.length===0)return-1;if(typeof r=="string"?(l=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),r=+r,St(r)&&(r=f?0:i.length-1),r<0&&(r=i.length+r),r>=i.length){if(f)return-1;r=i.length-1}else if(r<0)if(f)r=0;else return-1;if(typeof n=="string"&&(n=c.from(n,l)),c.isBuffer(n))return n.length===0?-1:ne(i,n,r,l,f);if(typeof n=="number")return n=n&255,typeof Uint8Array.prototype.indexOf=="function"?f?Uint8Array.prototype.indexOf.call(i,n,r):Uint8Array.prototype.lastIndexOf.call(i,n,r):ne(i,[n],r,l,f);throw new TypeError("val must be string, number or Buffer")}function ne(i,n,r,l,f){let m=1,w=i.length,j=n.length;if(l!==void 0&&(l=String(l).toLowerCase(),l==="ucs2"||l==="ucs-2"||l==="utf16le"||l==="utf-16le")){if(i.length<2||n.length<2)return-1;m=2,w/=2,j/=2,r/=2}function ee(te,H){return m===1?te[H]:te.readUInt16BE(H*m)}let Q;if(f){let te=-1;for(Q=r;Q<w;Q++)if(ee(i,Q)===ee(n,te===-1?0:Q-te)){if(te===-1&&(te=Q),Q-te+1===j)return te*m}else te!==-1&&(Q-=Q-te),te=-1}else for(r+j>w&&(r=w-j),Q=r;Q>=0;Q--){let te=!0;for(let H=0;H<j;H++)if(ee(i,Q+H)!==ee(n,H)){te=!1;break}if(te)return Q}return-1}c.prototype.includes=function(n,r,l){return this.indexOf(n,r,l)!==-1},c.prototype.indexOf=function(n,r,l){return $(this,n,r,l,!0)},c.prototype.lastIndexOf=function(n,r,l){return $(this,n,r,l,!1)};function D(i,n,r,l){r=Number(r)||0;const f=i.length-r;l?(l=Number(l),l>f&&(l=f)):l=f;const m=n.length;l>m/2&&(l=m/2);let w;for(w=0;w<l;++w){const j=parseInt(n.substr(w*2,2),16);if(St(j))return w;i[r+w]=j}return w}function L(i,n,r,l){return rt(Ct(n,i.length-r),i,r,l)}function re(i,n,r,l){return rt(Yr(n),i,r,l)}function J(i,n,r,l){return rt(rn(n),i,r,l)}function X(i,n,r,l){return rt(Jr(n,i.length-r),i,r,l)}c.prototype.write=function(n,r,l,f){if(r===void 0)f="utf8",l=this.length,r=0;else if(l===void 0&&typeof r=="string")f=r,l=this.length,r=0;else if(isFinite(r))r=r>>>0,isFinite(l)?(l=l>>>0,f===void 0&&(f="utf8")):(f=l,l=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const m=this.length-r;if((l===void 0||l>m)&&(l=m),n.length>0&&(l<0||r<0)||r>this.length)throw new RangeError("Attempt to write outside buffer bounds");f||(f="utf8");let w=!1;for(;;)switch(f){case"hex":return D(this,n,r,l);case"utf8":case"utf-8":return L(this,n,r,l);case"ascii":case"latin1":case"binary":return re(this,n,r,l);case"base64":return J(this,n,r,l);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return X(this,n,r,l);default:if(w)throw new TypeError("Unknown encoding: "+f);f=(""+f).toLowerCase(),w=!0}},c.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function P(i,n,r){return n===0&&r===i.length?e.fromByteArray(i):e.fromByteArray(i.slice(n,r))}function W(i,n,r){r=Math.min(i.length,r);const l=[];let f=n;for(;f<r;){const m=i[f];let w=null,j=m>239?4:m>223?3:m>191?2:1;if(f+j<=r){let ee,Q,te,H;switch(j){case 1:m<128&&(w=m);break;case 2:ee=i[f+1],(ee&192)===128&&(H=(m&31)<<6|ee&63,H>127&&(w=H));break;case 3:ee=i[f+1],Q=i[f+2],(ee&192)===128&&(Q&192)===128&&(H=(m&15)<<12|(ee&63)<<6|Q&63,H>2047&&(H<55296||H>57343)&&(w=H));break;case 4:ee=i[f+1],Q=i[f+2],te=i[f+3],(ee&192)===128&&(Q&192)===128&&(te&192)===128&&(H=(m&15)<<18|(ee&63)<<12|(Q&63)<<6|te&63,H>65535&&H<1114112&&(w=H))}}w===null?(w=65533,j=1):w>65535&&(w-=65536,l.push(w>>>10&1023|55296),w=56320|w&1023),l.push(w),f+=j}return z(l)}const K=4096;function z(i){const n=i.length;if(n<=K)return String.fromCharCode.apply(String,i);let r="",l=0;for(;l<n;)r+=String.fromCharCode.apply(String,i.slice(l,l+=K));return r}function M(i,n,r){let l="";r=Math.min(i.length,r);for(let f=n;f<r;++f)l+=String.fromCharCode(i[f]&127);return l}function V(i,n,r){let l="";r=Math.min(i.length,r);for(let f=n;f<r;++f)l+=String.fromCharCode(i[f]);return l}function G(i,n,r){const l=i.length;(!n||n<0)&&(n=0),(!r||r<0||r>l)&&(r=l);let f="";for(let m=n;m<r;++m)f+=Xr[i[m]];return f}function ie(i,n,r){const l=i.slice(n,r);let f="";for(let m=0;m<l.length-1;m+=2)f+=String.fromCharCode(l[m]+l[m+1]*256);return f}c.prototype.slice=function(n,r){const l=this.length;n=~~n,r=r===void 0?l:~~r,n<0?(n+=l,n<0&&(n=0)):n>l&&(n=l),r<0?(r+=l,r<0&&(r=0)):r>l&&(r=l),r<n&&(r=n);const f=this.subarray(n,r);return Object.setPrototypeOf(f,c.prototype),f};function T(i,n,r){if(i%1!==0||i<0)throw new RangeError("offset is not uint");if(i+n>r)throw new RangeError("Trying to access beyond buffer length")}c.prototype.readUintLE=c.prototype.readUIntLE=function(n,r,l){n=n>>>0,r=r>>>0,l||T(n,r,this.length);let f=this[n],m=1,w=0;for(;++w<r&&(m*=256);)f+=this[n+w]*m;return f},c.prototype.readUintBE=c.prototype.readUIntBE=function(n,r,l){n=n>>>0,r=r>>>0,l||T(n,r,this.length);let f=this[n+--r],m=1;for(;r>0&&(m*=256);)f+=this[n+--r]*m;return f},c.prototype.readUint8=c.prototype.readUInt8=function(n,r){return n=n>>>0,r||T(n,1,this.length),this[n]},c.prototype.readUint16LE=c.prototype.readUInt16LE=function(n,r){return n=n>>>0,r||T(n,2,this.length),this[n]|this[n+1]<<8},c.prototype.readUint16BE=c.prototype.readUInt16BE=function(n,r){return n=n>>>0,r||T(n,2,this.length),this[n]<<8|this[n+1]},c.prototype.readUint32LE=c.prototype.readUInt32LE=function(n,r){return n=n>>>0,r||T(n,4,this.length),(this[n]|this[n+1]<<8|this[n+2]<<16)+this[n+3]*16777216},c.prototype.readUint32BE=c.prototype.readUInt32BE=function(n,r){return n=n>>>0,r||T(n,4,this.length),this[n]*16777216+(this[n+1]<<16|this[n+2]<<8|this[n+3])},c.prototype.readBigUInt64LE=Ae(function(n){n=n>>>0,Re(n,"offset");const r=this[n],l=this[n+7];(r===void 0||l===void 0)&&be(n,this.length-8);const f=r+this[++n]*2**8+this[++n]*2**16+this[++n]*2**24,m=this[++n]+this[++n]*2**8+this[++n]*2**16+l*2**24;return BigInt(f)+(BigInt(m)<<BigInt(32))}),c.prototype.readBigUInt64BE=Ae(function(n){n=n>>>0,Re(n,"offset");const r=this[n],l=this[n+7];(r===void 0||l===void 0)&&be(n,this.length-8);const f=r*2**24+this[++n]*2**16+this[++n]*2**8+this[++n],m=this[++n]*2**24+this[++n]*2**16+this[++n]*2**8+l;return(BigInt(f)<<BigInt(32))+BigInt(m)}),c.prototype.readIntLE=function(n,r,l){n=n>>>0,r=r>>>0,l||T(n,r,this.length);let f=this[n],m=1,w=0;for(;++w<r&&(m*=256);)f+=this[n+w]*m;return m*=128,f>=m&&(f-=Math.pow(2,8*r)),f},c.prototype.readIntBE=function(n,r,l){n=n>>>0,r=r>>>0,l||T(n,r,this.length);let f=r,m=1,w=this[n+--f];for(;f>0&&(m*=256);)w+=this[n+--f]*m;return m*=128,w>=m&&(w-=Math.pow(2,8*r)),w},c.prototype.readInt8=function(n,r){return n=n>>>0,r||T(n,1,this.length),this[n]&128?(255-this[n]+1)*-1:this[n]},c.prototype.readInt16LE=function(n,r){n=n>>>0,r||T(n,2,this.length);const l=this[n]|this[n+1]<<8;return l&32768?l|4294901760:l},c.prototype.readInt16BE=function(n,r){n=n>>>0,r||T(n,2,this.length);const l=this[n+1]|this[n]<<8;return l&32768?l|4294901760:l},c.prototype.readInt32LE=function(n,r){return n=n>>>0,r||T(n,4,this.length),this[n]|this[n+1]<<8|this[n+2]<<16|this[n+3]<<24},c.prototype.readInt32BE=function(n,r){return n=n>>>0,r||T(n,4,this.length),this[n]<<24|this[n+1]<<16|this[n+2]<<8|this[n+3]},c.prototype.readBigInt64LE=Ae(function(n){n=n>>>0,Re(n,"offset");const r=this[n],l=this[n+7];(r===void 0||l===void 0)&&be(n,this.length-8);const f=this[n+4]+this[n+5]*2**8+this[n+6]*2**16+(l<<24);return(BigInt(f)<<BigInt(32))+BigInt(r+this[++n]*2**8+this[++n]*2**16+this[++n]*2**24)}),c.prototype.readBigInt64BE=Ae(function(n){n=n>>>0,Re(n,"offset");const r=this[n],l=this[n+7];(r===void 0||l===void 0)&&be(n,this.length-8);const f=(r<<24)+this[++n]*2**16+this[++n]*2**8+this[++n];return(BigInt(f)<<BigInt(32))+BigInt(this[++n]*2**24+this[++n]*2**16+this[++n]*2**8+l)}),c.prototype.readFloatLE=function(n,r){return n=n>>>0,r||T(n,4,this.length),s.read(this,n,!0,23,4)},c.prototype.readFloatBE=function(n,r){return n=n>>>0,r||T(n,4,this.length),s.read(this,n,!1,23,4)},c.prototype.readDoubleLE=function(n,r){return n=n>>>0,r||T(n,8,this.length),s.read(this,n,!0,52,8)},c.prototype.readDoubleBE=function(n,r){return n=n>>>0,r||T(n,8,this.length),s.read(this,n,!1,52,8)};function S(i,n,r,l,f,m){if(!c.isBuffer(i))throw new TypeError('"buffer" argument must be a Buffer instance');if(n>f||n<m)throw new RangeError('"value" argument is out of bounds');if(r+l>i.length)throw new RangeError("Index out of range")}c.prototype.writeUintLE=c.prototype.writeUIntLE=function(n,r,l,f){if(n=+n,r=r>>>0,l=l>>>0,!f){const j=Math.pow(2,8*l)-1;S(this,n,r,l,j,0)}let m=1,w=0;for(this[r]=n&255;++w<l&&(m*=256);)this[r+w]=n/m&255;return r+l},c.prototype.writeUintBE=c.prototype.writeUIntBE=function(n,r,l,f){if(n=+n,r=r>>>0,l=l>>>0,!f){const j=Math.pow(2,8*l)-1;S(this,n,r,l,j,0)}let m=l-1,w=1;for(this[r+m]=n&255;--m>=0&&(w*=256);)this[r+m]=n/w&255;return r+l},c.prototype.writeUint8=c.prototype.writeUInt8=function(n,r,l){return n=+n,r=r>>>0,l||S(this,n,r,1,255,0),this[r]=n&255,r+1},c.prototype.writeUint16LE=c.prototype.writeUInt16LE=function(n,r,l){return n=+n,r=r>>>0,l||S(this,n,r,2,65535,0),this[r]=n&255,this[r+1]=n>>>8,r+2},c.prototype.writeUint16BE=c.prototype.writeUInt16BE=function(n,r,l){return n=+n,r=r>>>0,l||S(this,n,r,2,65535,0),this[r]=n>>>8,this[r+1]=n&255,r+2},c.prototype.writeUint32LE=c.prototype.writeUInt32LE=function(n,r,l){return n=+n,r=r>>>0,l||S(this,n,r,4,4294967295,0),this[r+3]=n>>>24,this[r+2]=n>>>16,this[r+1]=n>>>8,this[r]=n&255,r+4},c.prototype.writeUint32BE=c.prototype.writeUInt32BE=function(n,r,l){return n=+n,r=r>>>0,l||S(this,n,r,4,4294967295,0),this[r]=n>>>24,this[r+1]=n>>>16,this[r+2]=n>>>8,this[r+3]=n&255,r+4};function ae(i,n,r,l,f){nt(n,l,f,i,r,7);let m=Number(n&BigInt(4294967295));i[r++]=m,m=m>>8,i[r++]=m,m=m>>8,i[r++]=m,m=m>>8,i[r++]=m;let w=Number(n>>BigInt(32)&BigInt(4294967295));return i[r++]=w,w=w>>8,i[r++]=w,w=w>>8,i[r++]=w,w=w>>8,i[r++]=w,r}function Se(i,n,r,l,f){nt(n,l,f,i,r,7);let m=Number(n&BigInt(4294967295));i[r+7]=m,m=m>>8,i[r+6]=m,m=m>>8,i[r+5]=m,m=m>>8,i[r+4]=m;let w=Number(n>>BigInt(32)&BigInt(4294967295));return i[r+3]=w,w=w>>8,i[r+2]=w,w=w>>8,i[r+1]=w,w=w>>8,i[r]=w,r+8}c.prototype.writeBigUInt64LE=Ae(function(n,r=0){return ae(this,n,r,BigInt(0),BigInt("0xffffffffffffffff"))}),c.prototype.writeBigUInt64BE=Ae(function(n,r=0){return Se(this,n,r,BigInt(0),BigInt("0xffffffffffffffff"))}),c.prototype.writeIntLE=function(n,r,l,f){if(n=+n,r=r>>>0,!f){const ee=Math.pow(2,8*l-1);S(this,n,r,l,ee-1,-ee)}let m=0,w=1,j=0;for(this[r]=n&255;++m<l&&(w*=256);)n<0&&j===0&&this[r+m-1]!==0&&(j=1),this[r+m]=(n/w>>0)-j&255;return r+l},c.prototype.writeIntBE=function(n,r,l,f){if(n=+n,r=r>>>0,!f){const ee=Math.pow(2,8*l-1);S(this,n,r,l,ee-1,-ee)}let m=l-1,w=1,j=0;for(this[r+m]=n&255;--m>=0&&(w*=256);)n<0&&j===0&&this[r+m+1]!==0&&(j=1),this[r+m]=(n/w>>0)-j&255;return r+l},c.prototype.writeInt8=function(n,r,l){return n=+n,r=r>>>0,l||S(this,n,r,1,127,-128),n<0&&(n=255+n+1),this[r]=n&255,r+1},c.prototype.writeInt16LE=function(n,r,l){return n=+n,r=r>>>0,l||S(this,n,r,2,32767,-32768),this[r]=n&255,this[r+1]=n>>>8,r+2},c.prototype.writeInt16BE=function(n,r,l){return n=+n,r=r>>>0,l||S(this,n,r,2,32767,-32768),this[r]=n>>>8,this[r+1]=n&255,r+2},c.prototype.writeInt32LE=function(n,r,l){return n=+n,r=r>>>0,l||S(this,n,r,4,2147483647,-2147483648),this[r]=n&255,this[r+1]=n>>>8,this[r+2]=n>>>16,this[r+3]=n>>>24,r+4},c.prototype.writeInt32BE=function(n,r,l){return n=+n,r=r>>>0,l||S(this,n,r,4,2147483647,-2147483648),n<0&&(n=4294967295+n+1),this[r]=n>>>24,this[r+1]=n>>>16,this[r+2]=n>>>8,this[r+3]=n&255,r+4},c.prototype.writeBigInt64LE=Ae(function(n,r=0){return ae(this,n,r,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),c.prototype.writeBigInt64BE=Ae(function(n,r=0){return Se(this,n,r,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function De(i,n,r,l,f,m){if(r+l>i.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function Z(i,n,r,l,f){return n=+n,r=r>>>0,f||De(i,n,r,4),s.write(i,n,r,l,23,4),r+4}c.prototype.writeFloatLE=function(n,r,l){return Z(this,n,r,!0,l)},c.prototype.writeFloatBE=function(n,r,l){return Z(this,n,r,!1,l)};function le(i,n,r,l,f){return n=+n,r=r>>>0,f||De(i,n,r,8),s.write(i,n,r,l,52,8),r+8}c.prototype.writeDoubleLE=function(n,r,l){return le(this,n,r,!0,l)},c.prototype.writeDoubleBE=function(n,r,l){return le(this,n,r,!1,l)},c.prototype.copy=function(n,r,l,f){if(!c.isBuffer(n))throw new TypeError("argument should be a Buffer");if(l||(l=0),!f&&f!==0&&(f=this.length),r>=n.length&&(r=n.length),r||(r=0),f>0&&f<l&&(f=l),f===l||n.length===0||this.length===0)return 0;if(r<0)throw new RangeError("targetStart out of bounds");if(l<0||l>=this.length)throw new RangeError("Index out of range");if(f<0)throw new RangeError("sourceEnd out of bounds");f>this.length&&(f=this.length),n.length-r<f-l&&(f=n.length-r+l);const m=f-l;return this===n&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(r,l,f):Uint8Array.prototype.set.call(n,this.subarray(l,f),r),m},c.prototype.fill=function(n,r,l,f){if(typeof n=="string"){if(typeof r=="string"?(f=r,r=0,l=this.length):typeof l=="string"&&(f=l,l=this.length),f!==void 0&&typeof f!="string")throw new TypeError("encoding must be a string");if(typeof f=="string"&&!c.isEncoding(f))throw new TypeError("Unknown encoding: "+f);if(n.length===1){const w=n.charCodeAt(0);(f==="utf8"&&w<128||f==="latin1")&&(n=w)}}else typeof n=="number"?n=n&255:typeof n=="boolean"&&(n=Number(n));if(r<0||this.length<r||this.length<l)throw new RangeError("Out of range index");if(l<=r)return this;r=r>>>0,l=l===void 0?this.length:l>>>0,n||(n=0);let m;if(typeof n=="number")for(m=r;m<l;++m)this[m]=n;else{const w=c.isBuffer(n)?n:c.from(n,f),j=w.length;if(j===0)throw new TypeError('The value "'+n+'" is invalid for argument "value"');for(m=0;m<l-r;++m)this[m+r]=w[m%j]}return this};const fe={};function se(i,n,r){fe[i]=class extends r{constructor(){super(),Object.defineProperty(this,"message",{value:n.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${i}]`,this.stack,delete this.name}get code(){return i}set code(f){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:f,writable:!0})}toString(){return`${this.name} [${i}]: ${this.message}`}}}se("ERR_BUFFER_OUT_OF_BOUNDS",function(i){return i?`${i} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),se("ERR_INVALID_ARG_TYPE",function(i,n){return`The "${i}" argument must be of type number. Received type ${typeof n}`},TypeError),se("ERR_OUT_OF_RANGE",function(i,n,r){let l=`The value of "${i}" is out of range.`,f=r;return Number.isInteger(r)&&Math.abs(r)>2**32?f=Pe(String(r)):typeof r=="bigint"&&(f=String(r),(r>BigInt(2)**BigInt(32)||r<-(BigInt(2)**BigInt(32)))&&(f=Pe(f)),f+="n"),l+=` It must be ${n}. Received ${f}`,l},RangeError);function Pe(i){let n="",r=i.length;const l=i[0]==="-"?1:0;for(;r>=l+4;r-=3)n=`_${i.slice(r-3,r)}${n}`;return`${i.slice(0,r)}${n}`}function pe(i,n,r){Re(n,"offset"),(i[n]===void 0||i[n+r]===void 0)&&be(n,i.length-(r+1))}function nt(i,n,r,l,f,m){if(i>r||i<n){const w=typeof n=="bigint"?"n":"";let j;throw n===0||n===BigInt(0)?j=`>= 0${w} and < 2${w} ** ${(m+1)*8}${w}`:j=`>= -(2${w} ** ${(m+1)*8-1}${w}) and < 2 ** ${(m+1)*8-1}${w}`,new fe.ERR_OUT_OF_RANGE("value",j,i)}pe(l,f,m)}function Re(i,n){if(typeof i!="number")throw new fe.ERR_INVALID_ARG_TYPE(n,"number",i)}function be(i,n,r){throw Math.floor(i)!==i?(Re(i,r),new fe.ERR_OUT_OF_RANGE("offset","an integer",i)):n<0?new fe.ERR_BUFFER_OUT_OF_BOUNDS:new fe.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${n}`,i)}const Kr=/[^+/0-9A-Za-z-_]/g;function Qr(i){if(i=i.split("=")[0],i=i.trim().replace(Kr,""),i.length<2)return"";for(;i.length%4!==0;)i=i+"=";return i}function Ct(i,n){n=n||1/0;let r;const l=i.length;let f=null;const m=[];for(let w=0;w<l;++w){if(r=i.charCodeAt(w),r>55295&&r<57344){if(!f){if(r>56319){(n-=3)>-1&&m.push(239,191,189);continue}else if(w+1===l){(n-=3)>-1&&m.push(239,191,189);continue}f=r;continue}if(r<56320){(n-=3)>-1&&m.push(239,191,189),f=r;continue}r=(f-55296<<10|r-56320)+65536}else f&&(n-=3)>-1&&m.push(239,191,189);if(f=null,r<128){if((n-=1)<0)break;m.push(r)}else if(r<2048){if((n-=2)<0)break;m.push(r>>6|192,r&63|128)}else if(r<65536){if((n-=3)<0)break;m.push(r>>12|224,r>>6&63|128,r&63|128)}else if(r<1114112){if((n-=4)<0)break;m.push(r>>18|240,r>>12&63|128,r>>6&63|128,r&63|128)}else throw new Error("Invalid code point")}return m}function Yr(i){const n=[];for(let r=0;r<i.length;++r)n.push(i.charCodeAt(r)&255);return n}function Jr(i,n){let r,l,f;const m=[];for(let w=0;w<i.length&&!((n-=2)<0);++w)r=i.charCodeAt(w),l=r>>8,f=r%256,m.push(f),m.push(l);return m}function rn(i){return e.toByteArray(Qr(i))}function rt(i,n,r,l){let f;for(f=0;f<l&&!(f+r>=n.length||f>=i.length);++f)n[f+r]=i[f];return f}function Ie(i,n){return i instanceof n||i!=null&&i.constructor!=null&&i.constructor.name!=null&&i.constructor.name===n.name}function St(i){return i!==i}const Xr=function(){const i="0123456789abcdef",n=new Array(256);for(let r=0;r<16;++r){const l=r*16;for(let f=0;f<16;++f)n[l+f]=i[r]+i[f]}return n}();function Ae(i){return typeof BigInt>"u"?Zr:i}function Zr(){throw new Error("BigInt not supported")}})(Yt);function Ic(t){if(typeof t!="string")throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!t)throw new Error("No input");const e=JSON.parse(t),s=e;let o;if(s.type==="system")if(s.event==="connected")o=Object.assign(Object.assign({},e),{kind:"connected"});else if(s.event==="disconnected")o=Object.assign(Object.assign({},e),{kind:"disconnected"});else return null;else if(s.type==="message")if(s.from==="group"){const a=An(e.data,e.dataType);if(a===null)return null;o=Object.assign(Object.assign({},e),{data:a,kind:"groupData"})}else if(s.from==="server"){const a=An(e.data,e.dataType);if(a===null)return null;o=Object.assign(Object.assign({},e),{data:a,kind:"serverData"})}else return null;else if(s.type==="ack")o=Object.assign(Object.assign({},e),{kind:"ack"});else return null;return o}function Cc(t){let e;switch(t.kind){case"joinGroup":{e={type:"joinGroup",group:t.group,ackId:t.ackId};break}case"leaveGroup":{e={type:"leaveGroup",group:t.group,ackId:t.ackId};break}case"sendEvent":{e={type:"event",event:t.event,ackId:t.ackId,dataType:t.dataType,data:Rn(t.data,t.dataType)};break}case"sendToGroup":{e={type:"sendToGroup",group:t.group,ackId:t.ackId,dataType:t.dataType,data:Rn(t.data,t.dataType),noEcho:t.noEcho};break}case"sequenceAck":{e={type:"sequenceAck",sequenceId:t.sequenceId};break}default:throw new Error(`Unsupported type: ${t.kind}`)}return JSON.stringify(e)}function Rn(t,e){switch(e){case"text":{if(typeof t!="string")throw new TypeError("Message must be a string.");return t}case"json":return t;case"binary":case"protobuf":{if(t instanceof ArrayBuffer)return Yt.Buffer.from(t).toString("base64");throw new TypeError("Message must be a ArrayBuffer")}}}function An(t,e){if(e==="text"){if(typeof t!="string")throw new TypeError("Message must be a string when dataType is text");return t}else{if(e==="json")return t;if(e==="binary"||e==="protobuf"){const s=Yt.Buffer.from(t,"base64");return s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength)}else return null}}class Sc{constructor(){this.isReliableSubProtocol=!0,this.name="json.reliable.webpubsub.azure.v1"}parseMessages(e){return Ic(e)}writeMessage(e){return Cc(e)}}const bc=()=>new Sc;var ge;(function(t){t.Stopped="Stopped",t.Disconnected="Disconnected",t.Connecting="Connecting",t.Connected="Connected",t.Recovering="Recovering"})(ge||(ge={}));class Ec{nextAckId(){return this._ackId=this._ackId+1,this._ackId}constructor(e,s){this._quickSequenceAckDiff=300,this._activeTimeoutInMs=2e4,this._emitter=new $o,this._isStopping=!1,this._isInitialConnected=!1,typeof e=="string"?this._credential={getClientAccessUrl:e}:this._credential=e,s==null&&(s={}),this._buildDefaultOptions(s),this._options=s,this._messageRetryPolicy=new Bn(this._options.messageRetryOptions),this._reconnectRetryPolicy=new Bn(this._options.reconnectRetryOptions),this._protocol=this._options.protocol,this._groupMap=new Map,this._ackMap=new Map,this._sequenceId=new Mc,this._state=ge.Stopped,this._ackId=0}async start(e){if(this._isStopping)throw new Error("Can't start a client during stopping");if(this._state!==ge.Stopped)throw new Error("Client can be only started when it's Stopped");let s;e&&(s=e.abortSignal),this._activeKeepaliveTask||(this._activeKeepaliveTask=this._getActiveKeepaliveTask());try{await this._startCore(s)}catch(o){throw this._changeState(ge.Stopped),this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0),this._isStopping=!1,o}}async _startFromRestarting(e){if(this._state!==ge.Disconnected)throw new Error("Client can be only restarted when it's Disconnected");try{ue.verbose("Staring reconnecting."),await this._startCore(e)}catch(s){throw this._changeState(ge.Disconnected),s}}async _startCore(e){if(this._changeState(ge.Connecting),ue.info("Staring a new connection"),this._sequenceId.reset(),this._isInitialConnected=!1,this._lastCloseEvent=void 0,this._lastDisconnectedMessage=void 0,this._connectionId=void 0,this._reconnectionToken=void 0,this._uri=void 0,typeof this._credential.getClientAccessUrl=="string"?this._uri=this._credential.getClientAccessUrl:this._uri=await this._credential.getClientAccessUrl({abortSignal:e}),typeof this._uri!="string")throw new Error(`The clientAccessUrl must be a string but currently it's ${typeof this._uri}`);await this._connectCore(this._uri)}stop(){this._state===ge.Stopped||this._isStopping||(this._isStopping=!0,this._wsClient&&this._wsClient.isOpen()?this._wsClient.close():this._isStopping=!1,this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0))}on(e,s){this._emitter.on(e,s)}off(e,s){this._emitter.removeListener(e,s)}_emitEvent(e,s){this._emitter.emit(e,s)}async sendEvent(e,s,o,a){return await this._operationExecuteWithRetry(()=>this._sendEventAttempt(e,s,o,a),a?.abortSignal)}async _sendEventAttempt(e,s,o,a){var u;if(!((u=a?.fireAndForget)!==null&&u!==void 0?u:!1))return await this._sendMessageWithAckId(g=>({kind:"sendEvent",dataType:o,data:s,ackId:g,event:e}),a?.ackId,a?.abortSignal);const c={kind:"sendEvent",dataType:o,data:s,event:e};return await this._sendMessage(c,a?.abortSignal),{isDuplicated:!1}}async joinGroup(e,s){return await this._operationExecuteWithRetry(()=>this._joinGroupAttempt(e,s),s?.abortSignal)}async _joinGroupAttempt(e,s){const o=this._getOrAddGroup(e),a=await this._joinGroupCore(e,s);return o.isJoined=!0,a}async _joinGroupCore(e,s){return await this._sendMessageWithAckId(o=>({group:e,ackId:o,kind:"joinGroup"}),s?.ackId,s?.abortSignal)}async leaveGroup(e,s){return await this._operationExecuteWithRetry(()=>this._leaveGroupAttempt(e,s),s?.abortSignal)}async _leaveGroupAttempt(e,s){const o=this._getOrAddGroup(e),a=await this._sendMessageWithAckId(u=>({group:e,ackId:u,kind:"leaveGroup"}),s?.ackId,s?.abortSignal);return o.isJoined=!1,a}async sendToGroup(e,s,o,a){return await this._operationExecuteWithRetry(()=>this._sendToGroupAttempt(e,s,o,a),a?.abortSignal)}async _sendToGroupAttempt(e,s,o,a){var u,h;const c=(u=a?.fireAndForget)!==null&&u!==void 0?u:!1,g=(h=a?.noEcho)!==null&&h!==void 0?h:!1;if(!c)return await this._sendMessageWithAckId(x=>({kind:"sendToGroup",group:e,dataType:o,data:s,ackId:x,noEcho:g}),a?.ackId,a?.abortSignal);const _={kind:"sendToGroup",group:e,dataType:o,data:s,noEcho:g};return await this._sendMessage(_,a?.abortSignal),{isDuplicated:!1}}_getWebSocketClientFactory(){return new Go}async _trySendSequenceAck(){if(!this._protocol.isReliableSubProtocol)return;const[e,s]=this._sequenceId.tryGetSequenceId();if(e&&s){const o={kind:"sequenceAck",sequenceId:s};try{await this._sendMessage(o)}catch{this._sequenceId.tryUpdate(s)}}}_connectCore(e){if(this._isStopping)throw new Error("Can't start a client during stopping");return new Promise((s,o)=>{const a=this._wsClient=this._getWebSocketClientFactory().create(e,this._protocol.name);a.onopen(()=>{if(this._isStopping){try{a.close()}catch{}o(new Error("The client is stopped"))}ue.verbose("WebSocket connection has opened"),this._changeState(ge.Connected),this._protocol.isReliableSubProtocol&&(this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),this._sequenceAckTask=new Nn(async()=>{await this._trySendSequenceAck()},1e3)),s()}),a.onerror(u=>{this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),o(u)}),a.onclose((u,h)=>{this._state===ge.Connected?(ue.verbose("WebSocket closed after open"),this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),ue.info(`WebSocket connection closed. Code: ${u}, Reason: ${h}`),this._lastCloseEvent={code:u,reason:h},this._handleConnectionClose.call(this)):(ue.verbose("WebSocket closed before open"),o(new Error(`Failed to start WebSocket: ${u}`)))}),a.onmessage(u=>{const h=p=>{if(this._ackMap.has(p.ackId)){const y=this._ackMap.get(p.ackId);this._ackMap.delete(p.ackId);const C=p.error!=null&&p.error.name==="Duplicate";p.success||C?y.resolve({ackId:p.ackId,isDuplicated:C}):y.reject(new ot("Failed to send message.",{ackId:p.ackId,errorDetail:p.error}))}},c=async p=>{if(this._connectionId=p.connectionId,this._reconnectionToken=p.reconnectionToken,!this._isInitialConnected){if(this._isInitialConnected=!0,this._options.autoRejoinGroups){const y=[];this._groupMap.forEach(C=>{C.isJoined&&y.push((async()=>{try{await this._joinGroupCore(C.name)}catch(b){this._safeEmitRejoinGroupFailed(C.name,b)}})())});try{await Promise.all(y)}catch{}}this._safeEmitConnected(p.connectionId,p.userId)}},g=p=>{this._lastDisconnectedMessage=p},_=p=>{if(p.sequenceId!=null){const y=this._sequenceId.tryUpdate(p.sequenceId);if(y===0)return;y>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitGroupMessage(p)},x=p=>{if(p.sequenceId!=null){const y=this._sequenceId.tryUpdate(p.sequenceId);if(y===0)return;y>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitServerMessage(p)};let I;try{let p;if(Array.isArray(u)?p=Buffer.concat(u):p=u,I=this._protocol.parseMessages(p),I===null)return}catch(p){throw ue.warning("An error occurred while parsing the message from service",p),p}Array.isArray(I)||(I=[I]),I.forEach(p=>{try{switch(p.kind){case"ack":{h(p);break}case"connected":{c(p);break}case"disconnected":{g(p);break}case"groupData":{_(p);break}case"serverData":{x(p);break}}}catch(y){ue.warning(`An error occurred while handling the message with kind: ${p.kind} from service`,y)}})})})}async _handleConnectionCloseAndNoRecovery(){this._state=ge.Disconnected,this._safeEmitDisconnected(this._connectionId,this._lastDisconnectedMessage),this._options.autoReconnect?await this._autoReconnect():await this._handleConnectionStopped()}async _autoReconnect(){let e=!1,s=0;try{for(;!this._isStopping;)try{await this._startFromRestarting(),e=!0;break}catch(o){ue.warning("An attempt to reconnect connection failed.",o),s++;const a=this._reconnectRetryPolicy.nextRetryDelayInMs(s);if(a==null)break;try{ue.verbose(`Delay time for reconnect attempt ${s}: ${a}`),await at(a)}catch{}}}finally{e||this._handleConnectionStopped()}}_handleConnectionStopped(){this._isStopping=!1,this._state=ge.Stopped,this._safeEmitStopped()}_getActiveKeepaliveTask(){return new Nn(async()=>{this._sequenceId.tryUpdate(0)},this._activeTimeoutInMs)}async _sendMessage(e,s){if(!this._wsClient||!this._wsClient.isOpen())throw new Error("The connection is not connected.");const o=this._protocol.writeMessage(e);await this._wsClient.send(o,s)}async _sendMessageWithAckId(e,s,o){s==null&&(s=this.nextAckId());const a=e(s);this._ackMap.has(s)||this._ackMap.set(s,new Tc(s));const u=this._ackMap.get(s);try{await this._sendMessage(a,o)}catch(h){this._ackMap.delete(s);let c="";throw h instanceof Error&&(c=h.message),new ot(c,{ackId:s})}if(o)try{return await Ho(u.promise(),o)}catch(h){throw h instanceof Error&&h.name==="AbortError"?new ot("Cancelled by abortSignal",{ackId:s}):h}return await u.promise()}async _handleConnectionClose(){if(this._ackMap.forEach((a,u)=>{this._ackMap.delete(u)&&a.reject(new ot("Connection is disconnected before receive ack from the service",{ackId:a.ackId}))}),this._isStopping){ue.warning("The client is stopping state. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(this._lastCloseEvent&&this._lastCloseEvent.code===1008){ue.warning("The websocket close with status code 1008. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(!this._protocol.isReliableSubProtocol){ue.warning("The protocol is not reliable, recovery is not applicable"),this._handleConnectionCloseAndNoRecovery();return}const e=this._buildRecoveryUri();if(!e){ue.warning("Connection id or reconnection token is not available"),this._handleConnectionCloseAndNoRecovery();return}let s=!1;this._state=ge.Recovering;const o=hr.timeout(30*1e3);try{for(;!o.aborted||this._isStopping;)try{await this._connectCore.call(this,e),s=!0;return}catch{await at(1e3)}}finally{s||(ue.warning("Recovery attempts failed more then 30 seconds or the client is stopping"),this._handleConnectionCloseAndNoRecovery())}}_safeEmitConnected(e,s){this._emitEvent("connected",{connectionId:e,userId:s})}_safeEmitDisconnected(e,s){this._emitEvent("disconnected",{connectionId:e,message:s})}_safeEmitGroupMessage(e){this._emitEvent("group-message",{message:e})}_safeEmitServerMessage(e){this._emitEvent("server-message",{message:e})}_safeEmitStopped(){this._emitEvent("stopped",{})}_safeEmitRejoinGroupFailed(e,s){this._emitEvent("rejoin-group-failed",{group:e,error:s})}_buildDefaultOptions(e){return e.autoReconnect==null&&(e.autoReconnect=!0),e.autoRejoinGroups==null&&(e.autoRejoinGroups=!0),e.protocol==null&&(e.protocol=bc()),this._buildMessageRetryOptions(e),this._buildReconnectRetryOptions(e),e}_buildMessageRetryOptions(e){e.messageRetryOptions||(e.messageRetryOptions={}),(e.messageRetryOptions.maxRetries==null||e.messageRetryOptions.maxRetries<0)&&(e.messageRetryOptions.maxRetries=3),(e.messageRetryOptions.retryDelayInMs==null||e.messageRetryOptions.retryDelayInMs<0)&&(e.messageRetryOptions.retryDelayInMs=1e3),(e.messageRetryOptions.maxRetryDelayInMs==null||e.messageRetryOptions.maxRetryDelayInMs<0)&&(e.messageRetryOptions.maxRetryDelayInMs=3e4),e.messageRetryOptions.mode==null&&(e.messageRetryOptions.mode="Fixed")}_buildReconnectRetryOptions(e){e.reconnectRetryOptions||(e.reconnectRetryOptions={}),(e.reconnectRetryOptions.maxRetries==null||e.reconnectRetryOptions.maxRetries<0)&&(e.reconnectRetryOptions.maxRetries=Number.MAX_VALUE),(e.reconnectRetryOptions.retryDelayInMs==null||e.reconnectRetryOptions.retryDelayInMs<0)&&(e.reconnectRetryOptions.retryDelayInMs=1e3),(e.reconnectRetryOptions.maxRetryDelayInMs==null||e.reconnectRetryOptions.maxRetryDelayInMs<0)&&(e.reconnectRetryOptions.maxRetryDelayInMs=3e4),e.reconnectRetryOptions.mode==null&&(e.reconnectRetryOptions.mode="Fixed")}_buildRecoveryUri(){if(this._connectionId&&this._reconnectionToken&&this._uri){const e=new URL(this._uri);return e.searchParams.append("awps_connection_id",this._connectionId),e.searchParams.append("awps_reconnection_token",this._reconnectionToken),e.toString()}return null}_getOrAddGroup(e){return this._groupMap.has(e)||this._groupMap.set(e,new kc(e)),this._groupMap.get(e)}_changeState(e){ue.verbose(`The client state transfer from ${this._state.toString()} to ${e.toString()}`),this._state=e}async _operationExecuteWithRetry(e,s){let o=0;for(;;)try{return await e.call(this)}catch(a){o++;const u=this._messageRetryPolicy.nextRetryDelayInMs(o);if(u==null||(await at(u),s?.aborted))throw a}}}class Bn{constructor(e){this._retryOptions=e,this._maxRetriesToGetMaxDelay=Math.ceil(Math.log2(this._retryOptions.maxRetryDelayInMs)-Math.log2(this._retryOptions.retryDelayInMs)+1)}nextRetryDelayInMs(e){return e>this._retryOptions.maxRetries?null:this._retryOptions.mode==="Fixed"?this._retryOptions.retryDelayInMs:this._calculateExponentialDelay(e)}_calculateExponentialDelay(e){return e>=this._maxRetriesToGetMaxDelay?this._retryOptions.maxRetryDelayInMs:(1<<e-1)*this._retryOptions.retryDelayInMs}}class kc{constructor(e){this.isJoined=!1,this.name=e}}class Tc{constructor(e){this._promise=new Promise((s,o)=>{this._resolve=s,this._reject=o}),this.ackId=e}promise(){return this._promise}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}class Mc{constructor(){this._sequenceId=0,this._isUpdate=!1}tryUpdate(e){if(this._isUpdate=!0,e>this._sequenceId){const s=e-this._sequenceId;return this._sequenceId=e,s}return 0}tryGetSequenceId(){return this._isUpdate?(this._isUpdate=!1,[!0,this._sequenceId]):[!1,null]}reset(){this._sequenceId=0,this._isUpdate=!1}}class Nn{constructor(e,s,o){this._func=e,this._abortController=new hr,this._interval=s,this._obj=o,this._start()}abort(){try{this._abortController.abort()}catch{}}async _start(){const e=this._abortController.signal;for(;!e.aborted;)try{await this._func(this._obj)}catch{}finally{await at(this._interval)}}}const Rc=1e3*60*60,Ac=1e3*30;class Bc{client;handler;terminationTimeout=null;connectionUrl;expiresAt;connected=!1;websocketRequestId=null;conversationId=null;secondaryTypeBasedHandlers=new Map;constructor(e,s,o,a=null,u=new Map){this.connectionUrl=s,this.expiresAt=o,this.client=new Ec({getClientAccessUrl:()=>e(this.connectionUrl,this.expiresAt)},{autoReconnect:!0,reconnectRetryOptions:{maxRetries:5,retryDelayInMs:100,maxRetryDelayInMs:1e4,mode:"Exponential"}}),this.handler=a,this.secondaryTypeBasedHandlers=u}async start(){const e=s=>{if(this.secondaryTypeBasedHandlers.has(s.message.data.type)){const o=this.secondaryTypeBasedHandlers.get(s.message.data.type);if(!o)return;o(s.message.data)}else{const o=s.message.data.body,a=atob(o).trim();if(a.startsWith("data: ")){const u=a.replace("data: ",""),h=this.handler;if(!h)return;h({conversationId:s.message.data.conversation_id,responseId:s.message.data.response_id,message:{id:"",event:"",data:u},websocketRequestId:s.message.data.websocket_request_id})}}};this.client.on("group-message",s=>e(s)),this.client.on("server-message",s=>e(s)),this.client.on("connected",()=>{this.connected=!0}),this.client.on("disconnected",()=>{this.connected=!1}),await this.client.start()}addSecondaryTypeHandler(e,s){this.secondaryTypeBasedHandlers.set(e,s)}isConnected(){return this.connected}async stop(e){e&&this.conversationId!==e||this.websocketRequestId&&await Te.stopWebsocketConversation(this.websocketRequestId)}setHandler(e,s,o,a){!this.handler&&this.websocketRequestId===o||(this.handler!=null&&this.websocketRequestId!==o&&(ps.warn("[websockets] Overwriting existing handler without silencing. This may indicate a race condition."),A.logEvent(B.asyncHandlerOverwritten,{originalWebsocketRequestId:this.websocketRequestId,newWebsocketRequestId:o,conversationId:e,responseId:s})),this.websocketRequestId=o,this.conversationId=e,this.handler=u=>{(u.websocketRequestId===o||u.conversationId===e&&u.responseId===s)&&a(u.message)})}silence(){this.handler=null}close(){this.client.stop()}scheduleForTermination(e){this.terminationTimeout=setTimeout(()=>{this.close(),e()},Rc)}preventTermination(){this.terminationTimeout&&(clearTimeout(this.terminationTimeout),this.terminationTimeout=null)}updateConnectionUrl(e,s){this.connectionUrl=e,this.expiresAt=s}}class Nc{activeSocketMap=new Map;secondaryTypeBasedHandlers=new Map;async register(){const e=await Te.postRegisterWebsocket();e.wss_url&&(this.getOrCreateSocket(e.wss_url,new Date(e.expires_at),!0),e.fallback_wss_url&&this.getOrCreateSocket(e.fallback_wss_url,new Date(e.expires_at),!1))}async registerIfNotConnected(){if(this.activeSocketMap.size===0){await this.register();return}for(const e of this.activeSocketMap.values())if(!e.isConnected()){await this.register();return}}isWebsocketConnected(){for(const e of this.activeSocketMap.values())if(e.isConnected())return!0;return this.activeSocketMap.size>0&&we.addError("Cannot connect to any websocket."),!1}async getOrCreateSocket(e,s,o){const a=e.split("?")[0];let u;const h=this.activeSocketMap.get(a);if(h&&h.isConnected())h.preventTermination(),h.updateConnectionUrl(e,s),u=h;else{h&&h.close(),u=new Bc(async(c,g)=>{if(new Date<new Date(g.getTime()-5*1e3))return c;const _=await Te.postRegisterWebsocket();return o?_.wss_url:_.fallback_wss_url??""},e,s,null,this.secondaryTypeBasedHandlers),this.activeSocketMap.set(a,u);try{await u.start()}catch(c){throw we.addError(new Error("Error occurred while starting websocket: ",{cause:c})),c}}return u}preSetupWebsocket(e,s,o){for(const a of this.activeSocketMap.values())this.setupWebSocketHandler(a,null,null,null,e,s,o)}addSecondaryTypeHandler(e,s){this.secondaryTypeBasedHandlers.set(e,s);for(const o of this.activeSocketMap.values())o.addSecondaryTypeHandler(e,s)}hasSecondaryTypeHandler(e){return this.secondaryTypeBasedHandlers.has(e)}async processWebSocketConversationStream(e,s,o,a,u,h,c,g,_){const x=[this.getOrCreateSocket(e,o,!0)];s&&x.push(this.getOrCreateSocket(s,o,!1));const I=await Promise.allSettled(x),p=I[0].status==="fulfilled"?I[0].value:null,y=I.length>1&&I[1].status==="fulfilled"?I[1].value:null;if((!p||!p.isConnected())&&we.addError(`Cannot connect to primary websocket, websocketRequestId: ${h}, token: ${e.substring(0,e.indexOf("access_token="))}`),(!p||!p.isConnected())&&(!y||!y.isConnected()))throw s&&we.addError(`Cannot connect to fallback websocket, websocketRequestId: ${h}, token: ${s.substring(0,s.indexOf("access_token="))}`),ye.createWithErrorMessage("websocket","server",`An error occurred while connecting to the websocket. ${Pt}`);let C=setTimeout(()=>{we.addError(`WebSocket took too long to respond: ${u}, ${a}, ${h}, ${e.substring(0,60)}...${e.slice(-20)}`,{supportsWebSockets:"WebSocket"in window&&window.WebSocket.CLOSING===2})},Ac);const b=k=>(_&&(clearTimeout(_),_=null),C&&(clearTimeout(C),C=null),c(k));p&&this.setupWebSocketHandler(p,e,a,u,h,b,g),y&&s&&this.setupWebSocketHandler(y,s,a,u,h,b,g)}async stopConversation(e){for(const s of this.activeSocketMap.values())await s.stop(e)}setupWebSocketHandler(e,s,o,a,u,h,c){e.setHandler(o,a,u,h),this.secondaryTypeBasedHandlers.forEach((_,x)=>{e.addSecondaryTypeHandler(x,_)});const g=()=>{s?e.scheduleForTermination(()=>{this.activeSocketMap.delete(s.split("?")[0])}):(this.stopConversation(o),e.silence())};c.addEventListener("abort",g)}}const tn=new Nc;function Fc(t){return{webSocketUrl:t.wss_url,fallbackWebSocketUrl:t.fallback_wss_url,conversationId:t.conversation_id,responseId:t.response_id,expiresAt:t.expires_at&&new Date(t.expires_at),websocketRequestId:t.websocket_request_id}}async function jc(t,e,s){return tn.preSetupWebsocket(t,e,s)}async function Dc(t,e,s,o,a,u,h,c,g){return tn.processWebSocketConversationStream(t,e,s,o,a,u,h,c,g)}const Je=t=>{switch(t.type){case ce.Reply:return t.text;case ce.Starter:case ce.Autocomplete:return t.prompt}},Pc=t=>t.type===ce.Reply,$r=t=>t.type===ce.Starter,nn=t=>t.type===ce.Autocomplete,ct=t=>nn(t)&&!!t.theme,ql=(t,e,s,o)=>{switch(oe.logEvent("chatgpt_prompt_use_suggestion",nn(t)&&!ct(t)?"":Je(t),{id:$r(t)||ct(t)?t.id??"":"",index:`${e}`,type:t.type}),t.type){case ce.Reply:A.logEvent(B.useSuggestedReply,{value:Je(t),prompt_type:ce.Reply,messageId:o});break;case ce.Starter:A.logEvent(B.useStarterPrompt,{value:Je(t),prompt_type:ce.Starter,title:t.title,body:t.body,id:t.id,category:t.category,client_thread_id:s,messageId:o,index:e,theme:t.theme});break;case ce.Autocomplete:{const a=ct(t);A.logEvent(B.useAutocomplete,{value:a?Je(t):"",prompt_type:ce.Autocomplete,title:a?t.title:"",body:a?t.body:"",id:a?t.id:"",category:t.category,index:e,messageId:o,client_thread_id:s,theme:t.theme??""});break}}},Wl=(t,e)=>{const s=E.getThreadCurrentLeafId(e),o=E.getTree(e).getMessageId(s);if(oe.logEvent("chatgpt_prompt_show_suggestions",`count_${t.length}`,{type:t[0].type}),t.every(Pc))A.logEvent(B.showSuggestedReplies,{prompt_count:t.length,prompt_type:ce.Reply,client_thread_id:e,suggestions:t.map(a=>a.text),message_id:o});else if(t.every($r)){const{isAdditional:a}=t[0];A.logEvent(a?B.moreStarterPromptsShown:B.showStarterPrompts,{prompt_count:t.length,prompt_type:ce.Starter,titles:t.map(u=>u.title),bodies:t.map(u=>u.body),ids:t.map(u=>u.id),client_thread_id:e,message_id:o,themes:t.map(u=>u.theme??"")}),a&&A.logEvent(B.expandMoreStarterPrompts,{client_thread_id:e,message_id:o})}else if(t.every(nn)){const a=!!t.find(u=>ct(u));A.logEvent(B.showAutocompletePrompts,{prompt_count:t.length,prompt_type:ce.Autocomplete,titles:t.map(u=>a?u.title:""),bodies:t.map(u=>a?u.body:""),ids:t.map(u=>a?u.id:""),client_thread_id:e,message_id:o,themes:t.map(u=>u.theme??"")})}else we.addError("Unhandled suggestion type",{type:t[0].type})},$l=t=>{const e=E.getThreadCurrentLeafId(t),s=E.getTree(t).getMessageId(e);A.logEvent(B.showExpandMoreStarterPromptsButton,{client_thread_id:t,message_id:s})},Gl=t=>{const e=E.getThreadCurrentLeafId(t),s=E.getTree(t).getMessageId(e);A.logEvent(B.expandMoreStarterPrompts,{client_thread_id:t,message_id:s})},Uc="OAI-Echo-Logs",Ve={FOCUS_IN:0,FOCUS_OUT:1,COPY:2,PASTE:3,TOUCH_START:4,TOUCH_END:5},Gr=[];function Ke(t){return()=>{Gr.push({type:t,ts:Math.round(performance.now())})}}const Oc={focusin:Ke(Ve.FOCUS_IN),focusout:Ke(Ve.FOCUS_OUT),copy:Ke(Ve.COPY),paste:Ke(Ve.PASTE),touchstart:Ke(Ve.TOUCH_START),touchend:Ke(Ve.TOUCH_END)};function Hl(t){const e=t??document.getElementById(Hi);for(const[s,o]of Object.entries(Oc))e?.removeEventListener(s,o),e?.addEventListener(s,o)}function Lc(){return{[Uc]:Gr.slice(0,10).map(t=>`${t.type},${t.ts}`).join(",")}}const qc=1e3*30,Ft=Kn.getTracer("completion");class jt extends Error{}function Wc(t,e,s,o){return(async(u=null)=>{zo()&&await Vo();const h=new AbortController,c="threadId"in e?e.threadId:void 0,g="continueFromSharedConversationId"in e?e.continueFromSharedConversationId:void 0,_=ms(),x=oe.checkGate("1987334402"),I=oe.checkGate("2964350589"),p=[x&&ze.V1,I&&ze.V1_TEST].filter(Boolean),y={action:e.completionType,messages:e.messages.length>0?e.messages:void 0,conversation_id:c,continue_from_shared_conversation_id:c!=null?void 0:g,parent_message_id:e.parentMessageId,model:e.model,timezone_offset_min:new Date().getTimezoneOffset(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,variant_purpose:e.completionMetadata?.variantPurpose,suggestions:e.completionMetadata?.suggestions?e.completionMetadata.suggestions.map(T=>Je(T)):void 0,chosen_suggestion:e.completionMetadata?.suggestion?{type:e.completionMetadata.suggestion.type,index:e.completionMetadata.suggestionIndex,source:e.completionMetadata?.suggestion.type===ce.Autocomplete?e.completionMetadata.suggestion.source:void 0,user_input:e.completionMetadata?.suggestion.type===ce.Autocomplete?e.completionMetadata.suggestion.userInput:void 0}:void 0,history_and_training_disabled:e.historyDisabled,juice:e.completionMetadata?.juice,conversation_mode:e.completionMetadata?.conversationMode,force_paragen:e.forceParagen,force_paragen_model_slug:e.forceParagenModel,force_indepth_feedback:e.forceIndepthFeedback,force_rate_limit:e.forceRateLimit,reset_rate_limits:e.resetRateLimits,disable_system_content_toggling:e.disableSystemContentToggling,websocket_request_id:_,source:e.completionMetadata?.source,system_hints:e.completionMetadata?.systemHints,prefetch_ids:e.completionMetadata?.prefetchIds,force_use_sse:!tn.isWebsocketConnected(),supported_encodings:p,conversation_origin:e.conversationOrigin,force_use_search:e.forceUseSearch,client_reported_search_source:e.completionMetadata?.searchSource,client_contextual_info:e.contextualInfo,paragen_stream_type_override:e.paragenStreamType==="none"?null:e.paragenStreamType,paragen_cot_summary_display_override:e.paragenCotSummaryDisplay},C=oe.checkGate("1113464293");C&&(y.supports_buffering=!0),e.turnTracker.stream_buffering=C;let b,k;const F=Hn(t);Ht(F)?(k="https://chatgpt.com/backend-anon",b=sn.getUnauthHeaders().additionalHeaders):(k="https://chatgpt.com/backend-api",b=sn.getAuthedHeadersWithAccessToken(F?.accessToken));const N=`${k}/conversation`;let R=!0,U=!0;const q=gs(e.chatReq,u??e.arkoseToken,e.turnstileToken,e.proofToken,null),$={...b,...Lc(),...q};let ne,D,L;Ft.startActiveSpan("completion.response",T=>{ne=Ft.startSpan("completion.first_response"),D=Ft.startSpan("completion.first_token"),L=T});const re=Kn.setSpan(on.active(),L);let J=null,X=null,P,W=!1,K=!1;function z(){K||(K=!0,s({type:"done"}),gn())}function M(T){if(e.turnTracker.onBytesReceived(T.data),T.data==="[DONE]")h.abort(),L.end(),z();else if(T.event!=="ping")try{let S=JSON.parse(T.data);if(T.event==="delta_encoding")if(S===ze.V1||S===ze.V1_TEST)J=S,e.turnTracker.stream_encoding=J??void 0,X=new Qo;else{we.addError(`[completion-delta] unknown delta encoding: ${S}`);return}else if(T.event==="delta"){if(!X){we.addError("[completion-delta] delta event before delta_encoding");return}const ae=X.applyDelta(S);if(J===ze.V1_TEST){!W&&!ws(ae,P)&&(W=!0,we.addError("[completion-delta] delta resulted in a different object",{differences:Yo(ae,P)}));return}else S=ae}else J===ze.V1_TEST&&!W&&(P=S);if(S.error){const ae=ye.createWithErrorMessage(N,"server",S.error);throw s({type:"error",error:ae}),ae}else"type"in S?S.type==="gizmo_inline_review"?s({type:"gizmo_inline_review",gizmoId:S.gizmo_id}):S.type==="title_generation"?s({type:"title_generation",title:S.title,conversation_id:S.conversation_id}):S.type==="moderation"?s({type:"moderation",conversationId:S.conversation_id,messageId:S.message_id,isCompletion:S.is_completion,flagged:S.moderation_response.flagged,blocked:S.moderation_response.blocked,disclaimers:S.moderation_response.disclaimers,metadata:S.moderation_response.metadata}):S.type==="url_moderation"?s({type:"url_moderation",conversationId:S.conversation_id,messageId:S.message_id,url:S.url_moderation_result.full_url,isSafe:S.url_moderation_result.is_safe}):S.type==="num_variants_in_stream"?s({type:"num_variants_in_stream",num_variants_in_stream:S.num_variants_in_stream,display_treatment:S.display_treatment}):S.type==="conversation_detail_metadata"?s(S):S.type==="message_stream_complete"&&z():(s({type:"message",message:S.message,conversationId:S.conversation_id}),U&&(U=!1,ne.end()),R&&S.message.author.role==="assistant"&&S.message.content.content_type==="text"&&S.message.content.parts[0]!==""&&(R=!1,D.end()))}catch(S){if(S instanceof ye)throw S}}let V=null,G=setTimeout(()=>{V===!0?(A.logEvent(B.asyncResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:ht.Error,error:{reason:"timeout",message:"Async Response Took Too Long to Come Back"}})):V===!1&&(A.logEvent(B.sseResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:ht.Error,error:{reason:"timeout",message:"SSE Response Took Too Long to Come Back"}}))},qc);return jc(_,M,h.signal),on.with(re,()=>(e.profiler?.logTiming("fetch_event_source"),Ko(N,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...$},body:JSON.stringify(y),signal:h.signal,openWhenHidden:!0,async onopen(T){const S=T.headers.get("content-type")??"",ae=T.headers.get("Cf-Ray")??null;if(T.ok&&S.includes("text/event-stream")){V=!1,o(ae,e.model,e.turnTracker);return}else if(S.includes("application/json")){const Se=await T.json(),{webSocketUrl:De,fallbackWebSocketUrl:Z,conversationId:le,responseId:fe,expiresAt:se,websocketRequestId:Pe}=Fc(Se);if(De!=null&&le!=null&&fe!=null&&Pe!=null&&se){V=!0,o(ae,e.model,e.turnTracker);try{await Dc(De,Z,se,le,fe,Pe,M,h.signal,G)}catch(pe){pe instanceof ye&&s({type:"error",error:pe})}throw new jt}else{const pe=new ye(N,T.status,Se);if(pe.isServerError())throw pe;if((pe?.code==="expired_session_key"||pe?.code==="invalid_api_key"||pe?.code==="token_expired")&&typeof window<"u"&&window._oaiHandleSessionExpired?.("stream",JSON.stringify(pe)),pe?.code==="deactivated_workspace"){window.location.href.includes("/workspace/deactivated")||(window.location.href="/workspace/deactivated");return}throw pe}}else{const Se=await T.text();throw new ye(N,T.status,{detail:{message:an,code:"unexpected_content_type",contentType:S,text:Se?.substring(0,1e3)}})}},onmessage:T=>{if(V)throw ye.createWithErrorMessage(N,"server",an);G&&(clearTimeout(G),G=null),M(T)},onerror(T){let S=T instanceof Error?T:new Error(JSON.stringify(T));throw S instanceof jt||V||(S.message==="Failed to fetch"&&(S=ye.createWithErrorMessage(N,"server",`An error occurred. Either the engine you requested does not exist or there was another issue processing your request. ${Pt}`)),S.message==="network error"&&(S=ye.createWithErrorMessage(N,"client",`A network error occurred. Please check your connection and try again. ${Pt}`)),ys("fetch-error:conversation:new-message",{url:N,message:S?.message}),s({type:"error",error:S}),gn(S)),S}}))).catch(async T=>{T instanceof jt||(T instanceof ye?_s(T):we.addError(T),e.turnTracker.handleRawError(T.message??"Something went wrong",T.status))}),h})()}function $c({clientThreadId:t,continuingFromSharedConversationId:e,onCompletionFinished:s=cn,onCreate:o=cn}){const a=et(),{resolvedTheme:u}=xs(),h=u==="dark",c=v.useRef(s),g=vs();c.current=s;const _=v.useCallback(async function({model:x,completionType:I,parentNodeId:p,metadata:y,focusOnNewCompletion:C=!0,completionMetadata:b,chatReq:k,arkoseToken:F,turnstileToken:N,proofToken:R,preflightTime:U,extraStreamParams:q,appendMessages:$,updateTree:ne,turnTracker:D,profiler:L}){dr.publish({kind:"requestCompletion"});const re=E.getTree(t);E.retainThread(t);const J=Pi(),X=`${Jo}${t}-${J}`,P=`${t}-${J}`;ne?.();const W=re.getNodeByIdOrMessageId(p),z={gizmo_id:W.message.metadata?.gizmo_id};b?.juice!=null&&(z.snorkle_status=1),E.updateTree(t,Z=>{Z.addNode(X,"",p,Ce.Assistant,void 0,z)}),C&&E.setThreadCurrentLeafId(t,X);let M,V=[],G=re.getNodeByIdOrMessageId(W.parentId);for(;G!=null&&(G.metadata?.isPlaceholderTemplateAssistantWelcomeMessage===!0||G.metadata?.isClientCreatedSystemMessage===!0);){const Z=G.message;V.unshift(Z);const le=re.getNodeByIdOrMessageId(G.parentId);M=le.message?.id??le.id,G=le}if(I===Qe.Next||I===Qe.Variant){const Z=re.getNodeByIdOrMessageId(W.parentId);if(M??=Z.message?.id??Z.id,V.push(W.message),$){let le=p;E.updateTree(t,fe=>{for(const se of $)fe.insertNodeBefore(X,{id:se.id,message:se,parentId:le,children:[]}),le=se.id}),V.push(...$)}V=Gc(V,q)}else M??=W.message.id;const ie=E.getServerThreadId(t);ie===void 0&&Xt(t)&&E.updateInitialThreadDataForNewThread(t,x);async function T(Z,le){const fe=performance.now(),se=await Is();ln.initializeAndGatherData(se),yn.initializeAndGatherData(se),un.initializeAndGatherData(se),E.updateTree(t,Re=>{for(const be of le)Re.addNode(be.id,be,Z,Ce.Assistant,{completionSampleFinishTime:Date.now()}),Z=be.id}),E.setThreadCurrentLeafId(t,Z);const Pe=await ln.getEnforcementToken(se),pe=await yn.getEnforcementToken(se),nt=await un.getEnforcementToken(se);_({model:x,completionType:Qe.Next,parentNodeId:Z,metadata:{},chatReq:se,arkoseToken:Pe??null,turnstileToken:pe??null,proofToken:nt??null,preflightTime:performance.now()-fe,extraStreamParams:q,turnTracker:D})}D.updateAttachmentCount(V);const S=new vc(a,t,X,I,x,y.eventSource,o,P,T,(...Z)=>c.current(...Z),D,g),ae=(Z,le,fe)=>{Z&&fe.onReceivedRequestId(Z),Zo(P,le,Z,U)},Se={is_dark_mode:h,time_since_loaded:Math.floor(performance.now()/1e3),page_height:window?.innerHeight,page_width:window?.innerWidth,pixel_ratio:window?.devicePixelRatio,screen_height:window?.screen?.height,screen_width:window?.screen?.width},De=await Wc(a,{conversationOrigin:E.getConversationOrigin(t),model:x,completionType:I,threadId:ie,continueFromSharedConversationId:e,historyDisabled:g,parentMessageId:M,messages:V,chatReq:k,arkoseToken:F??null,turnstileToken:N??null,proofToken:R??null,completionMetadata:b,...q,turnTracker:D,profiler:L,contextualInfo:Se},S.handleResponse,ae);Cr(t,{source:zn.CLIENT,value:Vn.STREAMING}),Qt.addRequest(X,De,D),ta.onCompletionRequestStarted(X)},[t,a,o,e,g,h]);return _}const Gc=(t,e)=>{let s=t;return e?.forceUseSearch===!1&&t.length>0&&(s=t.map(o=>{const{system_hints:a,...u}=o.metadata||{};return{...o,metadata:{...u,system_hints:a?.filter(h=>h!==Xo.Search)}}})),s};function Hc({clientThreadId:t,currentModelId:e,defaultModelId:s,onCompletionFinished:o,onThreadCreated:a,preRequestCompletion:u}){const h=ei(),c=xt(),{isUnauthenticated:g}=zt(),_=Ui(t),x=et(),I=Mr(t),p=ve(),y=Xi(t),C=Qn(),b=Gt(),{config:k}=Gn("1013114931"),F=k.get("show_follow_ups",!1)&&p?.isPersonalAccount(),N=!C.displayingSideBySideFeedback&&F,R=v.useCallback(P=>{const K=E.getTree(t).getLeafFromNode(P);E.setThreadCurrentLeafId(t,K.id)},[t]),U=ti(e),[q,$]=v.useState(),ne=v.useCallback(({nodeId:P,messageId:W,rating:K})=>{const z=E.getServerThreadId(t);A.logEvent(B.thumbRating,{id:W,threadId:z,rating:K,model:e});const M=E.getTree(t),V=M.getNodeByIdOrMessageId(P);if(z!==void 0&&!U&&Te.submitMessageFeedback({message_id:W,conversation_id:z,rating:K}),E.updateTree(t,G=>{G.updateNodeMetadata(P,{rating:K})}),U){$(d.jsx(ni,{citations:V.message.metadata?.citations??[],rating:K,conversationId:z??"",messageId:W,onSubmit:()=>{$(void 0)},onCancel:()=>$(void 0),conversationTree:M,nodeId:P},`${P}-${K}`));return}},[t,e,U]),D=v.useCallback(P=>{if(P==null||(o?.(P),b)||(I?.kind===xe.GizmoInteraction&&Bi.handleGizmoInteracted(x,I.gizmo_id),!(y||N)))return;const K=E.getThreadCurrentLeafId(P),z=E.getTree(P).getMessage(K);ri(z)||si(z)||oi(P,z.id,e)},[I,e,o,x,y,N,b]),L=$c({clientThreadId:t,continuingFromSharedConversationId:_,onCompletionFinished:D,onCreate:a}),re=v.useCallback(()=>{const P=E.getThreadCurrentLeafId(t);if(P==null)return;const K=E.getTree(t).getBranchFromLeaf(P);Qt.abortRequests(K.map(z=>z.id))},[t]),J=v.useCallback(P=>ii({cancelRequests:re,clientThreadId:t,currentModelId:e,debugSettings:h,defaultModelId:s,isUnauthenticated:g,navigateToAuth:c,preRequestCompletion:u,requestCompletion:L,...P}),[re,t,e,h,s,g,c,u,L]),X=v.useCallback((P,W,K,z=!0,M="none",V)=>{const ie=E.getTree(t).getParentPromptNode(P).id;J({type:Qe.Variant,promptId:ie,eventMetadata:W,cancelActiveRequests:!1,focusOnNewCompletion:z,useDefaultModel:V,completionMetadata:{variantPurpose:M,conversationMode:pt.getConversationMode(t)},turnTracker:K})},[t,J]);return{caModal:q,onRequestCompletion:J,onRequestMoreCompletions:X,onChangeItemInView:R,onChangeRating:ne,cancelRequests:re}}function zc(t){return`https://chatgpt.com${Ni(t)}`}function zl(t,e,s,o){ai(zc(t),e,s),o&&e.info(o,{testId:"copy-gizmo-url-toast"})}function Vl(t){return t.some(e=>e.type===Cs.JIT_PLUGIN)}function Vc(t){return"gizmo_id"in t?t.gizmo_id??null:null}const Kc=t=>["conversation","init",t],Qc=({clientThreadId:t,conversationMode:e,clientModelId:s},o)=>{const a=Vc(e),u=Xt(t)?null:t;return{gcTime:0,refetchOnWindowFocus:!0,refetchOnMount:"always",queryKey:Kc(t),queryFn:()=>Te.getConversationDetails({conversationId:u,gizmoId:a,requestedDefaultModel:s}),enabled:!ci(t)}},Yc=t=>(Ln(),Lt(Qc(t))),Jc=(t,e)=>{const s=(typeof t=="string"?[t]:t)??[];for(const o of s)if(o&&e.has(o))return o;return null},Xc=(t,e)=>{const s=Fi(),[o,a]=Ss(),u=o.get("model"),{modelId:h=null}=li()??{};zi(t);const c=Oi(t)??null,g=[u,c,h],_=Jc(g,s);v.useEffect(()=>{E.initThread(t,e,_),Dt.reset()},[t]);const x=()=>{a(C=>(C.delete("model"),C))},{isLoading:I,data:p}=Yc({clientThreadId:t,clientModelId:g.find(C=>!!C)??null,conversationMode:e}),y=bs();v.useEffect(()=>{if(!(!u||I)){if(!s.has(u)||y.find(C=>C.model_slug===u))return x();E.setThreadModelId(t,u)}},[u,y,s,t]),v.useEffect(()=>{if(I||!p)return;const{default_model_slug:C}=p;u&&C&&u!==C&&x(),Dt.updateDetails(p),C&&E.setThreadModelId(t,C)},[I,p])};function Zc({clientThreadId:t,setClientThreadId:e}){const s=et(),o=ui(),a=o?{kind:xe.GizmoInteraction,gizmo_id:o}:{kind:xe.PrimaryAssistant};Xc(t,a);const u=$e(),h=Tr(t),c=v.useRef(h);c.current=h;const g=Li(t),_=v.useCallback(()=>{e?.(Es());const p=c.current;u(p.tags.includes(ks.GPT_4)?"/":`/?model=${p.id}`,{replace:!0})},[e,u]),x=Wr({clientThreadId:t,location:"Model switcher menu item"}),I=v.useCallback(p=>{g||xc(u,s,p)},[s,u,g]);return{createNewThread:x,onThreadCreated:I,resetThread:_}}function Hr(){return{caModal:null,clientThreadId:"",currentModelId:"",isModelLoaded:!1,isCompanionWindow:!1,conversationLeafId:"",onNewThread:()=>{throw new Error("onNewThread not implemented")},onRequestCompletion:()=>{throw new Error("onRequestCompletion not implemented")},onChangeItemInView:()=>{throw new Error("onChangeItemInView not implemented")},onChangeRating:()=>{throw new Error("onChangeRating not implemented")},onRequestMoreCompletions:()=>{throw new Error("onRequestMoreCompletions not implemented")},resetThread:()=>{throw new Error("resetThread not implemented")}}}const zr=v.createContext(Hr());function el(){try{return v.useContext(zr)}catch{return Hr()}}function Kl({children:t,clientThreadId:e,setClientThreadId:s,prefetchSearch:o}){const{createNewThread:a,onThreadCreated:u,resetThread:h}=Zc({clientThreadId:e,setClientThreadId:s}),c=ji(),g=Di(e),_=qi(e),x=c.id,I=g??x,p=Ts(),{caModal:y,onRequestCompletion:C,onChangeItemInView:b,onChangeRating:k,onRequestMoreCompletions:F}=Hc({clientThreadId:e,currentModelId:I,defaultModelId:c.id,onThreadCreated:u});return d.jsx(zr.Provider,{value:{caModal:y,clientThreadId:e,currentModelId:I,isModelLoaded:!!g,isCompanionWindow:p,conversationLeafId:_,onNewThread:a,onRequestCompletion:C,onChangeItemInView:b,onChangeRating:k,onRequestMoreCompletions:F,resetThread:h,prefetchSearch:o},children:t})}const tl=Wt(()=>mt(()=>import("./k5sy9m1ppx4ss01q.js"),__vite__mapDeps([53,1,2,3,13,5,6,12,11,8,54,55,34,35,36,18])));function Ql({showShareButton:t,showProfileDropdown:e,clientThreadId:s}){const o=Wi(s),a=Me(),u=fi(),{layer:h}=ut("1547743984");$i(s);const{onNewThread:c}=el(),g=h.get("show_share_button_text",!1),_=a.formatMessage({id:"GizmoInformation.shareChat",defaultMessage:"Share"}),x=tt(),I=()=>_e.openSharingModal(o),p=!1,y=a.formatMessage({id:"TO+loE",defaultMessage:"New Chat"});return d.jsxs(d.Fragment,{children:[!1,u&&d.jsx(aa,{}),!1,t&&o&&d.jsx(_n,{clientThreadId:s,children:g?d.jsx(Ue,{onClick:I,icon:Mt,label:_,"data-testid":"share-chat-button",color:"secondary",className:"text-token-text-primary",style:{display:"var(--screen-size-hidden-on-compact-mode)"},children:_}):d.jsx(ke,{label:a.formatMessage({id:"CPEfES",defaultMessage:"Share chat"}),children:d.jsx(_t,{"data-testid":"share-chat-button",onClick:()=>_e.openSharingModal(o),icon:Mt})})}),x&&t&&o&&d.jsx(_n,{clientThreadId:s,children:d.jsx(ke,{label:_,children:d.jsx(wn,{style:{display:"var(--screen-size-hidden-on-wide-mode)"},onClick:I,icon:d.jsx(Mt,{}),label:_})})}),x&&!p&&d.jsx(ke,{label:y,children:d.jsx(wn,{className:Rs.sidebarIcon,icon:d.jsx(wr,{}),onClick:()=>c(),label:y,style:{display:"var(--screen-size-hidden-on-wide-mode)"}})}),e&&d.jsx(rl,{clientThreadId:s})]})}function nl({to:t,children:e,icon:s}){const o=$e();return d.jsx(Y.Item,{icon:s,onSelect:()=>o(t),children:e})}function rl({clientThreadId:t}){const{isUnauthenticated:e}=zt();return e?d.jsx(dl,{}):d.jsx(sl,{clientThreadId:t})}function sl({clientThreadId:t}){const{data:e}=gt(),s=ve(),o=s?.isPlus()??!1,a=s?.isWorkspaceAccount()??!1,{openSettings:u}=di(),h=xr(),c=al(t??"none"),{openModal:g}=vr(),_=tt(),{layer:x}=ut("2888142241"),I=qn("3905879930");var p=s?.isTeam()??!1,y=!1;p&&(y=I.config.get("enabled",!1));const{doesUserHaveAnyAccountsWithPlusFeatures:C}=Ms(),{layer:b}=ut("2670443078");if(!s||!e)return null;const k=e.accountItems.length>1;let F=o;!a&&!o&&C&&b.get("is_gating_fix_enabled",!1)&&(F=C);const N=!a&&!F&&!$n&&x.get("is_upgrade_in_settings",!1);return d.jsxs(Ei,{contentClassName:je(_&&"max-w-[256px] min-w-[256px] w-[256px]"),triggerButton:d.jsx("button",{onClick:()=>{A.logEvent(B.accountOpenProfileMenu),oe.logEvent("chatgpt_account_open_profile_menu")},"data-testid":"profile-button",className:"flex h-10 w-10 items-center justify-center rounded-full hover:bg-token-main-surface-secondary focus-visible:bg-token-main-surface-secondary focus-visible:outline-0",style:{display:"var(--screen-size-hidden-on-compact-mode, flex)"},children:d.jsx(Kt,{iconSize:"medium"})}),children:[k&&d.jsx(Lr,{menuItemComponent:Y.Item}),k?d.jsx(Y.Separator,{}):null,a?d.jsx(Ur,{menuItemComponent:Y.Item,routedMenuItemComponent:nl}):d.jsx(Pr,{menuItemComponent:Y.Item}),d.jsx(Y.Item,{icon:mr,onClick:()=>u(),"data-testid":"settings-menu-item",children:d.jsx(O,{defaultMessage:"Settings",id:"navigation.settings.0"})}),d.jsx(Y.Separator,{}),p&&y&&d.jsxs(d.Fragment,{children:[d.jsx(Y.Item,{"data-testid":"settings-menu-item-invite-teammates",onClick:()=>{_e.openModal(We.InviteUsersToWorkspace),A.logEvent(B.accountMemberInviteButton,{eventSource:"mouse",location:"profile_drop_down"}),oe.logEvent("chatgpt_invite_users_to_workspace",0,{action:"OpenAdminInviteModal",location:"dropdown-menu-click",text:"AddTeammates",step:"OpenModal"})},icon:gr,children:d.jsx(O,{...Vr.addTeammatesButton})}),d.jsx(tl,{workspace:s})]}),h&&d.jsx(il,{openDownloadModal:g}),N&&d.jsx(ll,{}),c&&d.jsx(cl,{}),(N||h||c)&&d.jsx(Y.Separator,{}),d.jsx(Y.Item,{onClick:()=>{A.logEvent(B.clickLogOut,{eventSource:"mouse"}),A.logLogOutButtonClicked({location:"profile_drop_down"}),Wn()},"data-testid":"log-out-menu-item",icon:yr,children:d.jsx(O,{defaultMessage:"Log out",id:"navigation.logOut.0"})})]})}function ol({onClick:t,className:e,testId:s}){const o=Me(),a=Gt(),u=a?o.formatMessage({id:"yqd/J5",defaultMessage:"Clear chat"}):o.formatMessage({id:"OFyxqj",defaultMessage:"New chat"});return d.jsx(ke,{sideOffset:4,label:u,className:je("flex",e),children:d.jsx(_t,{onClick:()=>{_e.closePopoverNavSidebar(),t()},icon:a?bi:wr,surfaceContext:"secondary","aria-label":u,"data-testid":s})})}function Yl({clientThreadId:t}){const[e]=Sr(a=>[a.activeStageSidebar]),s=br(),o=Wr({clientThreadId:t,location:"Navigation actions"});return!s&&!e?null:d.jsxs("div",{className:"flex items-center",children:[d.jsx(ul,{}),d.jsx(ol,{onClick:o})]})}function il({openDownloadModal:t}){return d.jsx("span",{children:d.jsx(Y.Item,{icon:_r,onClick:()=>{t(),A.logEvent(B.accountMenuClickDownloadApp)},children:d.jsx(O,{id:"navigation.downloadMacApp",defaultMessage:"Download the macOS app"})})})}const al=t=>{const{value:e}=qt("2634628831"),s=Pn(()=>document.documentElement.dataset.searchExtension==="1"),o=Er(t,Un.Search);return!s&&o&&Jn()&&e},cl=()=>d.jsx("span",{children:d.jsx(Y.Item,{icon:Ii,onClick:()=>{window.open(Nr),A.logEventWithStatsig(B.chatgptBrowserExtensionUserMenuClicked,"chatgpt_browser_extension_user_menu_clicked")},children:d.jsx(O,{id:"E5VPz/",defaultMessage:"Get ChatGPT search extension"})})});function ll(){const t=$e(),s=ve()?.wasPaidCustomer()??!1,o=()=>{oe.logEvent("chatgpt_plus_upgrade_in_settings_menu_clicked"),A.logEvent(B.plusUpgradeInSettingsMenuClicked),Vt(t,"Upper right settings menu")};return d.jsx(Y.Item,{icon:Ci,onClick:o,children:s?d.jsx(O,{id:"navigation.renewPlus",defaultMessage:"Renew Plus"}):d.jsx(O,{id:"navigation.upgradePlan",defaultMessage:"Upgrade Plan"})})}function ul(){const t=Me(),[e]=Sr(u=>[u.activeStageSidebar]),s=br(),o=cr(),{isUnauthenticated:a}=zt();return!e&&!s||!o||a?null:d.jsx(ke,{label:t.formatMessage({id:"cElEQV",defaultMessage:"Open sidebar"}),className:"flex",children:d.jsx(_t,{"aria-label":t.formatMessage({id:"pV/Etp",defaultMessage:"Open sidebar"}),onClick:_e.toggleNavSidebar,icon:Si,surfaceContext:"primary"})})}function dl(){const t=xt(),e=hi(),s=ur(Vr.signUpCta),{layer:o}=ut("3637408529"),a=o.get("is_desktop_primary_auth_button_on_right",!1),u=()=>{t({authType:"login",callback:x=>{A.logLogInButtonClicked({location:"Chat header",provider:x})}})},h=()=>{t({authType:"signup",callback:x=>{A.logSignUpButtonClicked({location:"Chat header",provider:x})}})},c=d.jsx(Ue,{onClick:u,color:e?"primary":"secondary",size:"small","data-testid":"login-button",children:d.jsx(O,{id:"B1SN7b",defaultMessage:"Log in"})},"login"),g=d.jsx(Ue,{color:e?"secondary":"primary",onClick:h,size:"small","data-testid":"signup-button",children:d.jsx(O,{...s})},"signup"),_=e?[c,g]:[g,c];return d.jsx("div",{className:"flex items-center justify-center gap-2",children:a?_.reverse():_})}const Vr=$t({signUpCta:{id:"P6cySK",defaultMessage:"Sign up"},addTeammatesButton:{id:"inviteMemberButton.inviteMemberButton",defaultMessage:"Add Teammates"}});export{Tl as $,Qi as A,Fl as B,Kl as C,tn as D,ul as E,Tn as F,$c as G,zl as H,zc as I,Nl as J,Xi as K,rl as L,Aa as M,Ul as N,Hl as O,ac as P,$r as Q,Ra as R,Pc as S,Bl as T,Dl as U,$l as V,Gl as W,Ql as X,Yl as Y,Vl as Z,Hc as _,Ol as a,kl as a0,Cl as a1,bl as a2,Ma as b,sl as c,Ml as d,El as e,el as f,Al as g,gc as h,ol as i,Je as j,Wl as k,It as l,jl as m,Pl as n,xc as o,_c as p,zr as q,Zc as r,Vi as s,ql as t,Xc as u,ta as v,Rl as w,Ea as x,ka as y,Sl as z};
//# sourceMappingURL=ojtyfghvwqol77ni.js.map
