const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/g29519l31kma7tzw.js","assets/iw5llf4a9z2k4qli.js","assets/ere5qx05or5w4r80.js","assets/root-kyx67gpb.css","assets/ffbc0egt64q2hvb1.js","assets/conversation-small-ict01xsi.css","assets/fm4rru7bwka384ji.js","assets/i2dv3y3bfx4gju2h.js","assets/i427bddftbowt48m.js","assets/hskeo4a0suuacupd.js","assets/zbbavq3fohnytg6f.js","assets/ka9urk6fl3lg45ww.js","assets/b98iri3l289u5mbt.js","assets/kbwlehwq8vsie0xg.js","assets/c4scc2r3o6ytrhqm.js","assets/iv4lrtb43trj6p9c.js","assets/kqrjukxz6t033bgj.js","assets/textdoc-sandpack-code-preview-mk0lbw6o.css"])))=>i.map(i=>d[i]);
import{aM as vn,aN as Cn,j as i,az as V,r as p,Y,aR as K,aw as re,b0 as ae,X as he,n as xn,c5 as te,R as $e,Z as yn,d3 as Tn,bS as wn,bT as En,bU as bn,ab as Sn,h as It,o as kn,gj as dt,b as ft,m as Lt,am as Mn,a5 as An}from"./iw5llf4a9z2k4qli.js";import{kh as L,m9 as Nn,gm as R,ma as Dn,mb as Z,N as jn,mc as On,md as In,kf as Rt,me as M,eq as Ln,gc as Rn,ep as _n,es as Pn,mf as Hn,a9 as _t,kd as Pt,ke as ie,mg as Ht,lH as mt,bK as be,kp as le,y as $n,mh as Se,je as $t,gp as ce,mi as ht,jc as qn,k9 as qt,j5 as Ft,mj as Ut,mk as Bt,Y as I,kj as Fn,ml as Un,ld as Bn,fr as zn,c5 as Vn,la as Yn,mm as Gn,h2 as Wn,d9 as Jn,q as pt,mn as Qn,mo as zt,mp as Xn,mq as Zn,d as Kn,mr as es,ms as ts,mt as ns,gb as ss,mu as os,mv as rs,g3 as as,mw as is,fg as ls,mx as cs,kc as us,j6 as ds,g5 as fs,g6 as ms,j8 as hs,my as ps,b5 as gs,mz as vs,mA as Cs,mB as xs,mC as ys,Z as gt,mD as Ts,mE as ws,mF as Es,mG as bs,mH as vt,mI as Ss,kg as ne}from"./ffbc0egt64q2hvb1.js";import{O as ks,b as oe,A as Ms,c as As,D as Ns}from"./i427bddftbowt48m.js";import{e as Ds,C as js}from"./sbh3gyxbsik6r1mv.js";import{S as Os}from"./ioi62ycdahm2tnd9.js";import{C as ke,S as G,a0 as Is,$ as Ls,a1 as Ct}from"./i2dv3y3bfx4gju2h.js";import{m as W}from"./zbbavq3fohnytg6f.js";import{p as Rs,Q as _s,bY as Ps,bJ as Hs,ad as $s,ar as qs,ah as Fs,bZ as Us,b_ as Bs,aO as zs}from"./ere5qx05or5w4r80.js";import{D as Vs}from"./k62b7lpgll63icj7.js";import{i as Ys}from"./hhgzgwwiotxpkejj.js";import{C as Gs}from"./iaugkapujzwqym4n.js";import{L as Ws}from"./izrqkoclzq344wn2.js";import{P as Js}from"./hskeo4a0suuacupd.js";import{u as Qs}from"./bixe314hudxgokbp.js";import{u as Xs}from"./l1hnzmdnnyhyq50n.js";var qe=(e=>(e.Close="close",e.Loaded="loaded",e.Streaming="streaming",e.Download="download",e))(qe||{});function Zs(e){return e.includes("'react'")||e.includes('"react"')}function Ks(e,t){switch(e){case L.CODE_HTML:return"static";case L.CODE_REACT:return"react";case L.CODE_JAVASCRIPT:case L.CODE_TYPESCRIPT:return Zs(t)?"react":void 0;default:return}}function Fe(e,t){return Ks(e,t)!=null}function Ge(e){return Nn([L.CODE_JAVASCRIPT,L.CODE_TYPESCRIPT,L.CODE_PYTHON],e)}function xt(){if(typeof globalThis<"u")return globalThis;if(typeof window<"u")return window;if(typeof global<"u")return global;if(typeof self<"u")return self;throw new Error("Unable to locate global object.")}function eo(){const e=eval;function t(n){return n==="this"?xt():e(n)}try{xt().eval=t}catch(n){R.logError("Failed to polyfill eval",n)}}eo();const to=vn(()=>Cn(()=>import("./g29519l31kma7tzw.js").then(e=>e.t),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17])).then(e=>e.TextdocSandpackCodePreview),{fallback:()=>i.jsx("div",{className:"h-full w-full",children:"Failed to load"}),loading:()=>i.jsx("div",{className:"h-full w-full"})});function no(e){return i.jsx(to,{...e})}function so({hidden:e,isStreaming:t,textdocContent:n,textdocType:s}){return s===L.CODE_HTML?i.jsx(Os,{className:V("min-h-full w-full",{hidden:e}),srcDoc:n}):i.jsx(no,{hidden:e,isStreaming:t,textdocContent:n,textdocType:s})}const yt=(e=[])=>e.filter(({status:t})=>t!==Dn.DISMISSED),oo=({isTextdocStreaming:e,isRequestActive:t,value:n,comments:s})=>{const[o,r]=p.useState(!1);return p.useEffect(()=>{e&&o&&(r(!1),ke.reset())},[n,s]),p.useEffect(()=>{t||(r(!1),ke.reset())},[t]),[o,r]};function ro({onClickRestore:e,onClickResetLatest:t}){const n=Y();return i.jsx(W.div,{initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{bounce:0,duration:.24},className:"absolute bottom-0 left-0 z-30 w-full items-center border-t border-gray-100 bg-token-main-surface-primary p-6 shadow-[0_-4px_32px_rgba(0,0,0,0.08)] @container dark:border-token-border-xlight dark:shadow-[0_-4px_32px_rgba(0,0,0,0.12)] lg:border-l",children:i.jsxs("div",{className:"mx-auto flex max-w-[48rem] flex-col flex-wrap justify-center gap-5 @2xl:flex-row @2xl:justify-between",children:[i.jsxs("div",{className:"flex flex-col px-2 text-center @2xl:text-start",children:[i.jsx("span",{className:"text-md text-wrap font-semibold",children:n.formatMessage({id:"gt23pb",defaultMessage:"You are viewing a previous version"})}),i.jsx("span",{className:"text-wrap text-sm text-token-text-secondary",children:n.formatMessage({id:"sAlUJn",defaultMessage:"Restore this version to make edits"})})]}),i.jsxs("div",{className:"flex flex-wrap items-center justify-center gap-4",children:[i.jsx(K,{as:"button",color:"primary",onClick:e,children:n.formatMessage({id:"+cddAb",defaultMessage:"Restore this version"})}),i.jsx(K,{as:"button",color:"secondary",onClick:t,children:n.formatMessage({id:"qCD3eu",defaultMessage:"Back to latest version"})})]})]})})}const ao=({onClose:e,onClear:t})=>i.jsxs("div",{className:"flex items-center justify-between border-b border-gray-100 bg-token-main-surface-primary p-2 dark:border-token-border-medium",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(K,{size:"small",color:"ghost",as:"button",className:"aspect-square !p-1",onClick:e,icon:Rs}),i.jsx(re,{...Tt.output})]}),i.jsx("div",{className:"flex items-center gap-2",children:i.jsx(ae,{label:i.jsx(re,{...Tt.clearConsole}),children:i.jsx(K,{size:"small",color:"ghost",as:"button",className:"aspect-square !p-1",icon:_s,onClick:t})})})]}),Tt=he({output:{id:"P/lYBq",defaultMessage:"Output"},clearConsole:{id:"gAICYK",defaultMessage:"Clear console"}}),io=({onDrag:e,onDragEnd:t,onDoubleClick:n})=>i.jsx(W.div,{drag:"y",className:"absolute top-[-2px] z-10 h-[4px] w-full cursor-ns-resize bg-token-text-quaternary opacity-0",whileHover:{opacity:.5},whileDrag:{opacity:.75,height:"8px",top:"-4px"},transition:{type:"tween",duration:.1},style:{x:0,y:0,transform:"translateY(0px)"},dragMomentum:!1,dragSnapToOrigin:!1,dragElastic:!1,dragConstraints:{left:0,right:0,top:0,bottom:0},onDrag:(s,o)=>{e?.(o)},onDragEnd:t,onDoubleClick:n});var Me=(e=>(e.RAN_CODE="ran_code",e))(Me||{});const Vt=(e,{name:t,message:n,line:s,stack:o})=>`${t}: ${n}

Stack:
${o.join("")}

Error occured in:
${e.split(`
`).slice(s-1,s+1).join(`
`)}`,lo=({name:e,message:t,stack:n})=>`${e}: ${t}
${n.join(`
`)}`,co=({time:e})=>{const[,t]=p.useState(0);return p.useEffect(()=>{const n=setInterval(()=>t(s=>s+1),6e4);return()=>clearInterval(n)},[]),On(e,{includeSeconds:!1,addSuffix:!0})},uo=({log:e,level:t})=>i.jsx("span",{className:V("whitespace-pre-wrap",t==="error"&&"text-red-500"),children:e}),fo=({error:e,isLast:t,isRequestActive:n,onRequestHelp:s})=>{const[o,r]=p.useState(!1),a=l=>async()=>{r(l),await s?.(e,l),r(!1)};return i.jsxs("div",{className:"flex flex-col gap-2",children:[i.jsx("span",{className:"whitespace-pre-wrap text-red-500",children:lo(e)}),t&&!n&&i.jsxs("div",{className:"flex gap-2",children:[i.jsx(K,{onClick:a("comment"),icon:Ps,type:"button",color:"secondary",disabled:!!o,loading:o==="comment",children:i.jsx(re,{...Ae.askForHelp})}),i.jsx(K,{onClick:a("fix"),icon:Hs,type:"button",color:"primary",disabled:!!o,loading:o==="fix",children:i.jsx(re,{...Ae.askForFix})})]})]})},mo=({ranAt:e})=>i.jsxs("div",{className:"flex items-center justify-between gap-2 font-sans",children:[i.jsx("div",{className:"rounded-full bg-token-main-surface-secondary px-2 py-0.5",children:i.jsx(re,{...Ae.ranCode})}),i.jsx("div",{className:"flex items-center gap-2",children:i.jsx(co,{time:e})})]}),ho=({output:e})=>{const t=Y();return e==null?null:typeof e=="string"&&e.startsWith("blob:")?i.jsx("img",{alt:t.formatMessage(Ae.imgAlt),src:e}):i.jsx("span",{className:"flex items-center gap-2",children:jn(e)})},po=({log:e,isLast:t=!1,isRequestActive:n=!1,onRequestHelp:s})=>{let o=null;switch(e.type){case Z.LOG:{o=i.jsx(uo,{...e});break}case Z.ERROR:{o=i.jsx(fo,{...e,isLast:t,isRequestActive:n,onRequestHelp:s});break}case Z.OUTPUT:{o=i.jsx(ho,{...e});break}case Me.RAN_CODE:{o=i.jsx(mo,{...e});break}case Z.RUN_COMPLETE:break}return i.jsx("li",{className:V("whitespace-pre px-2 py-1 font-mono",e.type===Me.RAN_CODE&&"sticky top-0 border-b border-token-border-light bg-token-main-surface-primary shadow-[0_-1px_0_0_var(--border-light)]"),children:o})},Ae=he({imgAlt:{id:"L6t7Yb",defaultMessage:"Plot"},ranCode:{id:"ffa9Nt",defaultMessage:"Ran code"},askForHelp:{id:"wMZco9",defaultMessage:"Ask ChatGPT for help"},askForFix:{id:"A9pxgT",defaultMessage:"Fix it for me"}}),Yt=`You're a professional developer highly skilled in debugging. The user ran the textdoc's code, and an error was thrown.
Please think carefully about how to fix the error`,go=(e,t)=>{const n=Vt(e,t);return`
${Yt}, and then rewrite the textdoc to fix it.

- NEVER change existing test cases unless they're clearly wrong.
- ALWAYS add more test cases if there aren't any yet.
- ALWAYS ask the user what the expected behavior is in the chat if the code is not clear.

# Error

${n}`.trim()},vo=(e,t)=>{const n=Vt(e,t);return`
${Yt}, and then add multiple comments with suggestions on where things might be going wrong.

- NEVER comment on test cases unless they are clearly incorrect, or you are unsure of what the correct behavior of the code is.
- The user sees which line the error occurred on, so do not comment on that line directly.

# Error

${n}`.trim()},Co=({logs:e,isRequestActive:t,onClear:n,onClose:s,onRequestHelp:o})=>{const[r,a]=p.useState(320),l=e.filter(u=>u.type!==Z.RUN_COMPLETE);return i.jsxs(W.div,{className:"relative w-full border-t border-token-border-light",children:[i.jsx(io,{onDrag:({delta:{y:u}})=>a(c=>c-u)}),i.jsxs("div",{className:"flex flex-col",style:{height:r},children:[i.jsx(ao,{onClear:n,onClose:s}),i.jsx("div",{className:"flex flex-1 flex-col-reverse overflow-auto bg-white dark:bg-black",children:i.jsx("ol",{className:"flex flex-1 flex-col justify-end pb-4",children:l.map((u,c)=>i.jsx(po,{log:u,isLast:c===l.length-1,isRequestActive:t,onRequestHelp:o},c))})})]})]})},xo=({textdocContent:e,isRequestActive:t,createTextdocTurn:n},s)=>{const o=In(),[r,a]=p.useState(!1),[l,u]=p.useState([]),c=(d,f)=>n({action:G.COMMENT,userMessageType:M.CONSOLE,content:f==="fix"?go(e,d):vo(e,d)});return p.useImperativeHandle(s,()=>({runCode:async(d,f)=>{if(!Ge(d))return;a(!0),u(g=>[...g,{type:Me.RAN_CODE,ranAt:Date.now()}]);const h=Rt(d),x=xn(o.current).evalAsync({code:f,type:h});for await(const g of x)g.type!==Z.READY&&u(m=>[...m,g])},open:()=>a(!0)})),r?i.jsx(Co,{logs:l,onClose:()=>a(!1),onClear:()=>u([]),isRequestActive:t,onRequestHelp:c}):null};p.forwardRef(xo);const yo={type:"spring",damping:35,stiffness:300},To=({clientThreadId:e,turn:t})=>{const n=Ln(),s=Rn(t.messages);return i.jsxs(W.div,{className:"absolute left-0 right-0 top-0 z-10 -translate-y-full",children:[i.jsx(W.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 bg-vert-light-gradient dark:bg-vert-dark-gradient"}),i.jsx(W.div,{className:"flex items-center px-6 py-2",initial:{opacity:.75,translateX:-50,translateY:"100%"},animate:{opacity:1,translateX:0,translateY:"0"},exit:{opacity:0,translateY:20},transition:yo,children:i.jsx(Gs,{clientThreadId:e,onChangeItemInView:te,onRequestCompletion:async o=>te(o),onRequestMoreCompletions:te,groupedMessagesToRender:s,allGroupedMessages:s,isEditing:!1,isUserTurn:!0,turnIndex:0,isCompletionRequestInProgress:!1,isFeedbackEnabled:!1,isFinalTurn:!1,hasActiveRequest:n,showEditButton:!1,handleEnterEdit:te,handleExitEdit:te})})]},"user-message")},wo=({clientThreadId:e})=>{const t=_n(e),n=Pn(e,t),{lastUserTurn:s,lastAssistantTurn:o}=p.useMemo(()=>{let a=null,l=null;for(let u=n.length-1;u>0;u--){const c=n[u];if(!a&&c.role===$e.User?a=c:!l&&c.role===$e.Assistant&&(l=c),a&&l)break}return{lastUserTurn:a,lastAssistantTurn:l}},[n]),r=s&&!o?.messages.find(({message:a})=>a.recipient?.startsWith(Hn));return i.jsx(_t,{initial:!1,children:r&&i.jsx(To,{turn:s,clientThreadId:e})})},Eo=({isRequestActive:e=!1,clientThreadId:t,onCancel:n,onSubmit:s,onSubmitAccelerator:o,acceleratorActions:r=[]})=>{const[a,l]=p.useState(!1),[u,c]=p.useState(""),[d,f]=p.useState(!0),h=Y(),[x,g]=p.useState(!1),m=Is(),C=()=>{s?.(u),c("")},y=v=>{const{metaKey:b,shiftKey:T,key:A}=v;A==="Enter"&&u.trim()&&!(T||b)&&(C(),v.preventDefault())};return i.jsxs(i.Fragment,{children:[a&&!m&&i.jsx(ks,{zIndexKey:"acceleratorsOverlay",className:"bg-white/95 dark:bg-black/85"}),i.jsx("div",{className:"relative mb-3 flex flex-1 justify-center",children:i.jsxs("div",{className:"mx-6 max-w-2xl flex-1",children:[i.jsx(wo,{clientThreadId:t}),i.jsx("div",{className:"flex flex-auto items-start",children:i.jsx("div",{className:V("flex min-h-12 flex-auto items-center bg-[#f4f4f4] py-1 pl-6 pr-2 dark:bg-token-main-surface-secondary",{"rounded-full":d,"rounded-2xl":!d,"bg-transparent":x}),children:i.jsxs("div",{className:"relative flex flex-auto items-center self-stretch",children:[i.jsx(Ys,{placeholder:h.formatMessage({id:"zrUbTJ",defaultMessage:"Ask ChatGPT to edit"}),disabled:e,value:u,className:V("w-full resize-none border-0 bg-transparent p-0 text-token-text-primary outline-0 placeholder:text-token-text-secondary focus:ring-0 focus-visible:ring-0",{"opacity-0":x}),maxRows:4,onChange:({target:{value:v}})=>c(v),onKeyDown:y,onHeightChange:(v,{rowHeight:b})=>f(Math.floor(v/b)<=1)}),u?i.jsx(W.button,{className:V("dark h-8 w-8 rounded-full bg-token-main-surface-primary text-center dark:bg-token-main-surface-primary",{"self-end":!d}),initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{type:"tween",duration:.1},onMouseDown:()=>C(),children:i.jsx($s,{className:"h-8 w-8 text-token-text-primary"})}):(r?.length??0)>0&&i.jsx(Ls,{disableHint:!0,disableOverlay:!0,isEmbeddedInPromptArea:!0,isRequestActive:e,actions:r,onCancel:n,onExpandedChange:v=>{m||g(v),l(v)},onSubmit:o,right:0,bottom:4})]})})})]})})]})};function _(){}_.prototype={diff:function(t,n){var s,o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},r=o.callback;typeof o=="function"&&(r=o,o={});var a=this;function l(T){return T=a.postProcess(T,o),r?(setTimeout(function(){r(T)},0),!0):T}t=this.castInput(t,o),n=this.castInput(n,o),t=this.removeEmpty(this.tokenize(t,o)),n=this.removeEmpty(this.tokenize(n,o));var u=n.length,c=t.length,d=1,f=u+c;o.maxEditLength!=null&&(f=Math.min(f,o.maxEditLength));var h=(s=o.timeout)!==null&&s!==void 0?s:1/0,x=Date.now()+h,g=[{oldPos:-1,lastComponent:void 0}],m=this.extractCommon(g[0],n,t,0,o);if(g[0].oldPos+1>=c&&m+1>=u)return l(wt(a,g[0].lastComponent,n,t,a.useLongestToken));var C=-1/0,y=1/0;function v(){for(var T=Math.max(C,-d);T<=Math.min(y,d);T+=2){var A=void 0,k=g[T-1],j=g[T+1];k&&(g[T-1]=void 0);var S=!1;if(j){var $=j.oldPos-T;S=j&&0<=$&&$<u}var q=k&&k.oldPos+1<c;if(!S&&!q){g[T]=void 0;continue}if(!q||S&&k.oldPos<j.oldPos?A=a.addToPath(j,!0,!1,0,o):A=a.addToPath(k,!1,!0,1,o),m=a.extractCommon(A,n,t,T,o),A.oldPos+1>=c&&m+1>=u)return l(wt(a,A.lastComponent,n,t,a.useLongestToken));g[T]=A,A.oldPos+1>=c&&(y=Math.min(y,T-1)),m+1>=u&&(C=Math.max(C,T+1))}d++}if(r)(function T(){setTimeout(function(){if(d>f||Date.now()>x)return r();v()||T()},0)})();else for(;d<=f&&Date.now()<=x;){var b=v();if(b)return b}},addToPath:function(t,n,s,o,r){var a=t.lastComponent;return a&&!r.oneChangePerToken&&a.added===n&&a.removed===s?{oldPos:t.oldPos+o,lastComponent:{count:a.count+1,added:n,removed:s,previousComponent:a.previousComponent}}:{oldPos:t.oldPos+o,lastComponent:{count:1,added:n,removed:s,previousComponent:a}}},extractCommon:function(t,n,s,o,r){for(var a=n.length,l=s.length,u=t.oldPos,c=u-o,d=0;c+1<a&&u+1<l&&this.equals(s[u+1],n[c+1],r);)c++,u++,d++,r.oneChangePerToken&&(t.lastComponent={count:1,previousComponent:t.lastComponent,added:!1,removed:!1});return d&&!r.oneChangePerToken&&(t.lastComponent={count:d,previousComponent:t.lastComponent,added:!1,removed:!1}),t.oldPos=u,c},equals:function(t,n,s){return s.comparator?s.comparator(t,n):t===n||s.ignoreCase&&t.toLowerCase()===n.toLowerCase()},removeEmpty:function(t){for(var n=[],s=0;s<t.length;s++)t[s]&&n.push(t[s]);return n},castInput:function(t){return t},tokenize:function(t){return Array.from(t)},join:function(t){return t.join("")},postProcess:function(t){return t}};function wt(e,t,n,s,o){for(var r=[],a;t;)r.push(t),a=t.previousComponent,delete t.previousComponent,t=a;r.reverse();for(var l=0,u=r.length,c=0,d=0;l<u;l++){var f=r[l];if(f.removed)f.value=e.join(s.slice(d,d+f.count)),d+=f.count;else{if(!f.added&&o){var h=n.slice(c,c+f.count);h=h.map(function(x,g){var m=s[d+g];return m.length>x.length?m:x}),f.value=e.join(h)}else f.value=e.join(n.slice(c,c+f.count));c+=f.count,f.added||(d+=f.count)}}return r}function Et(e,t){var n;for(n=0;n<e.length&&n<t.length;n++)if(e[n]!=t[n])return e.slice(0,n);return e.slice(0,n)}function bt(e,t){var n;if(!e||!t||e[e.length-1]!=t[t.length-1])return"";for(n=0;n<e.length&&n<t.length;n++)if(e[e.length-(n+1)]!=t[t.length-(n+1)])return e.slice(-n);return e.slice(-n)}function Ue(e,t,n){if(e.slice(0,t.length)!=t)throw Error("string ".concat(JSON.stringify(e)," doesn't start with prefix ").concat(JSON.stringify(t),"; this is a bug"));return n+e.slice(t.length)}function Be(e,t,n){if(!t)return e+n;if(e.slice(-t.length)!=t)throw Error("string ".concat(JSON.stringify(e)," doesn't end with suffix ").concat(JSON.stringify(t),"; this is a bug"));return e.slice(0,-t.length)+n}function se(e,t){return Ue(e,t,"")}function we(e,t){return Be(e,t,"")}function St(e,t){return t.slice(0,bo(e,t))}function bo(e,t){var n=0;e.length>t.length&&(n=e.length-t.length);var s=t.length;e.length<t.length&&(s=e.length);var o=Array(s),r=0;o[0]=0;for(var a=1;a<s;a++){for(t[a]==t[r]?o[a]=o[r]:o[a]=r;r>0&&t[a]!=t[r];)r=o[r];t[a]==t[r]&&r++}r=0;for(var l=n;l<e.length;l++){for(;r>0&&e[l]!=t[r];)r=o[r];e[l]==t[r]&&r++}return r}var Ne="a-zA-Z0-9_\\u{C0}-\\u{FF}\\u{D8}-\\u{F6}\\u{F8}-\\u{2C6}\\u{2C8}-\\u{2D7}\\u{2DE}-\\u{2FF}\\u{1E00}-\\u{1EFF}",So=new RegExp("[".concat(Ne,"]+|\\s+|[^").concat(Ne,"]"),"ug"),De=new _;De.equals=function(e,t,n){return n.ignoreCase&&(e=e.toLowerCase(),t=t.toLowerCase()),e.trim()===t.trim()};De.tokenize=function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n;if(t.intlSegmenter){if(t.intlSegmenter.resolvedOptions().granularity!="word")throw new Error('The segmenter passed must have a granularity of "word"');n=Array.from(t.intlSegmenter.segment(e),function(r){return r.segment})}else n=e.match(So)||[];var s=[],o=null;return n.forEach(function(r){/\s/.test(r)?o==null?s.push(r):s.push(s.pop()+r):/\s/.test(o)?s[s.length-1]==o?s.push(s.pop()+r):s.push(o+r):s.push(r),o=r}),s};De.join=function(e){return e.map(function(t,n){return n==0?t:t.replace(/^\s+/,"")}).join("")};De.postProcess=function(e,t){if(!e||t.oneChangePerToken)return e;var n=null,s=null,o=null;return e.forEach(function(r){r.added?s=r:r.removed?o=r:((s||o)&&kt(n,o,s,r),n=r,s=null,o=null)}),(s||o)&&kt(n,o,s,null),e};function kt(e,t,n,s){if(t&&n){var o=t.value.match(/^\s*/)[0],r=t.value.match(/\s*$/)[0],a=n.value.match(/^\s*/)[0],l=n.value.match(/\s*$/)[0];if(e){var u=Et(o,a);e.value=Be(e.value,a,u),t.value=se(t.value,u),n.value=se(n.value,u)}if(s){var c=bt(r,l);s.value=Ue(s.value,l,c),t.value=we(t.value,c),n.value=we(n.value,c)}}else if(n)e&&(n.value=n.value.replace(/^\s*/,"")),s&&(s.value=s.value.replace(/^\s*/,""));else if(e&&s){var d=s.value.match(/^\s*/)[0],f=t.value.match(/^\s*/)[0],h=t.value.match(/\s*$/)[0],x=Et(d,f);t.value=se(t.value,x);var g=bt(se(d,x),h);t.value=we(t.value,g),s.value=Ue(s.value,d,g),e.value=Be(e.value,d,d.slice(0,d.length-g.length))}else if(s){var m=s.value.match(/^\s*/)[0],C=t.value.match(/\s*$/)[0],y=St(C,m);t.value=we(t.value,y)}else if(e){var v=e.value.match(/\s*$/)[0],b=t.value.match(/^\s*/)[0],T=St(v,b);t.value=se(t.value,T)}}var ko=new _;ko.tokenize=function(e){var t=new RegExp("(\\r?\\n)|[".concat(Ne,"]+|[^\\S\\n\\r]+|[^").concat(Ne,"]"),"ug");return e.match(t)||[]};var je=new _;je.tokenize=function(e,t){t.stripTrailingCr&&(e=e.replace(/\r\n/g,`
`));var n=[],s=e.split(/(\n|\r\n)/);s[s.length-1]||s.pop();for(var o=0;o<s.length;o++){var r=s[o];o%2&&!t.newlineIsToken?n[n.length-1]+=r:n.push(r)}return n};je.equals=function(e,t,n){return n.ignoreWhitespace?((!n.newlineIsToken||!e.includes(`
`))&&(e=e.trim()),(!n.newlineIsToken||!t.includes(`
`))&&(t=t.trim())):n.ignoreNewlineAtEof&&!n.newlineIsToken&&(e.endsWith(`
`)&&(e=e.slice(0,-1)),t.endsWith(`
`)&&(t=t.slice(0,-1))),_.prototype.equals.call(this,e,t,n)};function Mo(e,t,n){return je.diff(e,t,n)}var Ao=new _;Ao.tokenize=function(e){return e.split(/(\S.+?[.!?])(?=\s+|$)/)};var No=new _;No.tokenize=function(e){return e.split(/([{}:;,]|\s+)/)};function ze(e){"@babel/helpers - typeof";return ze=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ze(e)}var ue=new _;ue.useLongestToken=!0;ue.tokenize=je.tokenize;ue.castInput=function(e,t){var n=t.undefinedReplacement,s=t.stringifyReplacer,o=s===void 0?function(r,a){return typeof a>"u"?n:a}:s;return typeof e=="string"?e:JSON.stringify(Ve(e,null,null,o),o,"  ")};ue.equals=function(e,t,n){return _.prototype.equals.call(ue,e.replace(/,([\r\n])/g,"$1"),t.replace(/,([\r\n])/g,"$1"),n)};function Ve(e,t,n,s,o){t=t||[],n=n||[],s&&(e=s(o,e));var r;for(r=0;r<t.length;r+=1)if(t[r]===e)return n[r];var a;if(Object.prototype.toString.call(e)==="[object Array]"){for(t.push(e),a=new Array(e.length),n.push(a),r=0;r<e.length;r+=1)a[r]=Ve(e[r],t,n,s,o);return t.pop(),n.pop(),a}if(e&&e.toJSON&&(e=e.toJSON()),ze(e)==="object"&&e!==null){t.push(e),a={},n.push(a);var l=[],u;for(u in e)Object.prototype.hasOwnProperty.call(e,u)&&l.push(u);for(l.sort(),r=0;r<l.length;r+=1)u=l[r],a[u]=Ve(e[u],t,n,s,u);t.pop(),n.pop()}else a=e;return a}var Ye=new _;Ye.tokenize=function(e){return e.slice()};Ye.join=Ye.removeEmpty=function(e){return e};var Ee=(e=>(e.ADDED="added",e.REMOVED="removed",e.UNCHANGED="unchanged",e))(Ee||{});function We(e){if(e==="")return 0;const t=e.split(`
`).length;return e.endsWith(`
`)?t-1:t}function Do(e,t){return Mo(e,t,{newlineIsToken:!0}).map(s=>({count:s.count??We(s.value),value:s.value,type:s.added?"added":s.removed?"removed":"unchanged"}))}function jo(e){let t="";for(const{type:n,value:s}of e)(n==="added"||n==="unchanged")&&(t+=s);return t}function Oo(e,t){const n=We(t),s=Ro(e,n);return{changes:Do(s,t),numLinesDiffed:n}}function Io(e){const t=[...e],n=[],s=[];for(;t.length>0;){const o=t[t.length-1];if(o.type===Ee.REMOVED)t.pop(),o.type===Ee.REMOVED&&n.unshift(o);else if(o.type===Ee.ADDED)t.pop(),s.unshift(o);else break}return{prunedChanges:[...t,...s],prunedRemovedChanges:n}}function Lo(e,t){const{changes:n,numLinesDiffed:s}=Oo(e,t),{prunedChanges:o,prunedRemovedChanges:r}=Io(n),a=jo(o),l=r.map(c=>c.value).join(`
`),u=Gt(e,s,"start");return{content:a+l+u,numLinesDiffed:We(a)}}function Ro(e,t){if(t<=0)return"";let n=0,s=e.length;for(let o=0;o<e.length;o++)if(e[o]===`
`&&(n++,n===t)){s=o+1;break}return e.substring(0,s)}function Gt(e,t,n="start"){if(t<=0)return e;if(n==="start"){let a=0;for(let l=0;l<e.length;l++)if(e[l]===`
`&&(a++,a===t))return e.substring(l+1);return""}let s=0,o=-1;const r=e.endsWith(`
`)?t+1:t;for(let a=e.length-1;a>=0;a--)if(e[a]===`
`&&(s++,s===r)){o=a;break}return o===-1?"":e.substring(0,o+1)}function _o(e,t){const n=e?.type??L.LOADING,s=e?.content??"",o=Pt(e);if(!ie(n)||t==null||!o||!Ht(e))return{content:s,currentlyStreamingLineIndex:null};const r=Gt(s,1,"end");if(r==="")return{content:t.content,currentlyStreamingLineIndex:0};const a=Lo(t.content,r);return{content:a.content,currentlyStreamingLineIndex:a.numLinesDiffed}}function Po(e,t){const n=new Set(e.map(l=>l.id)),s=new Set(t.map(l=>l.id)),o=e.filter(l=>!s.has(l.id)).map(l=>({...l,diffStatus:mt.REMOVED})),r=t.filter(l=>!n.has(l.id)).map(l=>({...l,diffStatus:mt.ADDED})),a=e.filter(l=>s.has(l.id));return o.concat(r,a)}function Ho({textdocVersion:e}){const t=Y(),n=yn(),[s,o]=p.useState(!1),r=Tn(),a=p.useRef(e?.content??"");p.useEffect(()=>{a.current=e?.content??""},[e]);const l=u=>{s||(r(()=>{R.logButtonClick(le.COPY,{contentLength:a.current.length,textdocType:e?.type}),$n(a.current,n,u)},0),o(!0),r(()=>o(!1),2e3))};return i.jsx(ae,{label:t.formatMessage($o.copy),children:i.jsx(be,{icon:s?qs:Fs,onClick:l})})}const $o=he({copy:{id:"rbIYfo",defaultMessage:"Copy"}});function qo({disabled:e=!1,textdocId:t,version:n,isHistorical:s,isShowingChanges:o,latestVersionInt:r,nextVersion:a,previousVersion:l,onHoverPrevious:u,textdocType:c}){const d=Y(),f=n==null||n===1,h=n!=null&&n>1;return f&&!s?null:i.jsxs("div",{className:"flex items-center gap-1.5",children:[i.jsx(ae,{label:h&&d.formatMessage({id:"PoD5+8",defaultMessage:"Previous version"}),children:i.jsx(be,{disabled:!h||e,icon:Us,onMouseOver:u,onClick:()=>{R.logButtonClick(le.HISTORY_PREVIOUS,{textdocType:c,isShowingChanges:o,textdocId:t,versionInt:n}),t&&n&&h&&Se(t,{beforeVersion:n},o&&l!=null?l:void 0)}})}),i.jsx(ae,{label:s&&d.formatMessage({id:"PJ8YVJ",defaultMessage:"Next version"}),children:i.jsx(be,{disabled:!s||e,icon:Bs,onClick:()=>{R.logButtonClick(le.HISTORY_NEXT,{textdocType:c,isShowingChanges:o,textdocId:t,versionInt:n}),s&&(a?Se(t,{version:a},o?a:void 0):o&&r?$t(t,r,null):ce(t))}})})]})}function Fo({disabled:e=!1,textdocId:t,textdocType:n,history:s,version:o,isShowingChanges:r,latestVersionInt:a,onMouseEnter:l}){const u=Y(),[c,d]=p.useState(!1),f=()=>{s?Se(t,s):ce(t)},h=(o?.versionInt??0)>1,x=()=>{R.logButtonClick(le.SHOW_CHANGES,{textdocType:n,textdocId:t,versionInt:o?.versionInt,latestVersionInt:a}),o?.versionInt!=null&&$t(t,o.versionInt,s)},g=()=>{d(!0),l?.()},m=()=>{d(!1)};return i.jsx(ae,{label:h&&u.formatMessage(r?Mt.hideChanges:Mt.showChanges),children:i.jsx(be,{icon:zs,disabled:!h||e,onClick:r?f:x,onMouseEnter:g,onMouseLeave:m,className:V("transition-colors",{[ht.hoverActive]:c&&r&&h,[ht.active]:!c&&r&&h,"!bg-transparent":!c&&!r&&h})})})}const Mt=he({done:{id:"0MCBfo",defaultMessage:"Done"},showChanges:{id:"3jMGNS",defaultMessage:"Show changes"},hideChanges:{id:"HWiQSk",defaultMessage:"Hide changes"}}),Uo=100,At=100,Bo=({textdocId:e,isHistoricalVersion:t,nextHistoricalTextdocVersion:n,previousHistoricalTextdocVersion:s,textdocVersion:o,readonlyReason:r,history:a,latestVersionInt:l,hasDebug:u,contentWidth:c,isEmbedded:d,isPersisting:f,isShowChangesFeatureEnabled:h,isShowingChanges:x,hideHistoryActions:g=!1,prefetchHistoricalTextdocVersion:m,restoreHistoricalTextdocVersion:C,setShowDebugView:y,onClickCodePreview:v,onClose:b,isShowingCodePreview:T})=>{const A=qn(o?.title??""),[{width:k},j]=qt(),S=c-k-Uo-At>0,$=Ft(),q=Ut(),F=Bt();o==null||Fe(o.type,o.content)&&q||Ge(o.type);const D=V("transition-opacity duration-500",r===I.Streaming&&"pointer-events-none opacity-0");return i.jsxs(oe.Header,{children:[i.jsxs("div",{className:"flex flex-1 items-center leading-[0]",children:[i.jsx(oe.CloseButton,{onClick:b}),S&&i.jsx("div",{className:"flex flex-row items-center gap-2.5",children:i.jsx(oe.Title,{style:{maxWidth:c-k-At},children:A||i.jsx("div",{className:"w-52",children:i.jsx(Js,{lines:1,size:"base",width:100,widthVariance:0})})})}),f&&i.jsx(Fn,{size:12,className:"pl-2 text-token-text-secondary"})]}),i.jsxs("div",{className:"flex select-none items-center gap-2 leading-[0]",ref:j,children:[i.jsxs("div",{className:"flex items-center gap-2",children:[!1,!g&&i.jsx("div",{className:D,children:i.jsx(qo,{disabled:r===I.Streaming,textdocId:e,isHistorical:t,isShowingChanges:x,version:o?.versionInt,previousVersion:s?.versionInt,nextVersion:n?.versionInt,readonlyReason:r,onHoverPrevious:m,onClickRestore:C,textdocType:o?.type,latestVersionInt:l})}),!g&&h&&i.jsx("div",{className:D,children:i.jsx(Fo,{disabled:r===I.Streaming,textdocId:e,textdocType:o?.type,history:a,version:o,isShowingChanges:x,latestVersionInt:l,onMouseEnter:()=>{o?.versionInt&&$(e,o.versionInt),m()}})}),!1,i.jsx(Ho,{textdocVersion:o})]}),!d&&i.jsx(Ws,{})]})]})},zo=/\s/,Vo=30;function Nt(e,t){const n=e.indexOf(t);return n===-1?!1:e.indexOf(t,n+t.length)===-1}function z(e,t){return zo.test(e[t])}function Dt(e,t,n=!1){if(t===0||n&&z(e,t-1))return t;for(;t>0&&z(e,t-1);)t--;for(;t>0&&!z(e,t-1);)t--;return z(e,t)&&t++,t}function jt(e,t,n=!1){if(t===e.length||n&&z(e,t))return t;for(;t<e.length&&z(e,t);)t++;for(;t<e.length&&!z(e,t);)t++;return z(e,t-1)&&t--,t}function Yo(e,t,n=!0,s=Vo){if(e.start<0||e.end>t.length||e.start>e.end)throw new Error("Invalid commentSourceRange provided.");const o=t.substring(e.start,e.end);let r=e.start,a=e.end;n&&(r=Dt(t,r,!0),a=jt(t,a,!0));let l=t.substring(r,e.start),u=t.substring(e.end,a),c=`${l}${o}${u}`;if(Nt(t,c)&&(s==null||c.length>=s))return{before:l,after:u,allSurrounding:c};let d=r,f=a,h=!0;for(;h&&(s==null||c.length<s);){let x=!1;const g=d>0?Dt(t,d):d;g<d&&(d=g,x=!0);const m=f<t.length?jt(t,f):f;if(m>f&&(f=m,x=!0),x){const C=t.substring(d,e.start),y=t.substring(e.end,f),v=`${C}${o}${y}`;if(Nt(t,v)&&(s==null||v.length>=s))return{before:C,after:y,allSurrounding:v};l=C,u=y,c=v}else h=!1}return{before:l,after:u,allSurrounding:c}}const de="# Context",fe="# Instructions";function me(e,t,n){if(t==null||n==null)return`The user is referring to the entire text of "${e}".`;const s=`
## Selected Text
The user has selected this text in "${e}" in particular:
${t}
`.trim();return n.allSurrounding===t?s:`
${s}

## Surrounding Context
Here is the surrounding context:
${n.allSurrounding}
`.trim()}function Wt(e,t){return e==null||t==null?"entire document":e===t.allSurrounding?"selected text":"surrounding context"}function Jt(e){return`For the update pattern, create a regex which exactly matches the ${e}. Edit just this string in order to fullfill the user's request. NEVER rewrite the entire document. Instead, ALWAYS edit ONLY the ${e}. The only exception to this rule is if the ${e} includes markdown lists or tables. In that case, fully rewrite the document using ".*" as the regex update pattern.`.trim()}function Go(e,t,n,s){if(!ie(t)&&n&&s){const o=Wt(n,s);return`
${de}
The user requests that you directly edit the document.

${me(e,n,s)}

${fe}
Use the update_textdoc tool to make this edit. ${Jt(o)}`.trim()}return`
${de}
The user requests that you directly edit the document.

${me(e,n,s)}

${fe}
Use the update_textdoc tool to make this edit. You MUST fully rewrite the entire document by using ".*" as the update regex pattern.`.trim()}function Wo(e,t,n){return`
${de}
The user requests that you add comments about some text.

${me(e,t,n)}

${fe}
Do not respond to the user's question directly, just leave comments.`.trim()}function Jo(e,t){return ie(e)?t==="entire document"?` If you choose to update the ${t}, you MUST fully rewrite the ${t} by using ".*" as the update regex pattern.`:` If you choose to update the ${t}, you MUST fully rewrite the entire document by using ".*" as the update regex pattern. When you do so, ONLY modify the ${t} and rewrite other sections exactly as is, except for parts that must change based on this update`:t==="entire document"?"":` If you choose to update the ${t}, follow these instructions: ${Jt(t)}`}function Qo(e,t,n,s){const o=Wt(n,s),r=Jo(t,o);return`
${de}
${me(e,n,s)}

${fe}
The user would like you perform one of the following actions:
- Update the ${o} via the \`update_textdoc\` tool.${r}
- Explain the selected text via chat, or answer a general question about the selected text (no tool call required).
- Comment on the ${o} with feedback via the \`comment_textdoc\` tool. This should only be used if the user very explicitly asks for feedback, critique, or comments.

Based on the user's request, choose the appropriate action.
`.trim()}function Xo(e,t,n){return`
${de}
${me(e,t,n)}

${fe}
The user would like you to create a new textdoc.
`.trim()}function Zo(e,t,n,s=null,o=null){switch(n){case G.ASK:return Qo(e,t,s,o);case G.CREATE_TEXTDOC:return Xo(e,s,o);case G.EDIT:return Go(e,t,s,o);case G.COMMENT:return Wo(e,s,o)}}function Ko(e){switch(e){case M.ACCELERATOR:case M.CONSOLE:case M.ACCEPT_COMMENT:return!0;case M.ASK_CHATGPT:case M.FULL_SCREEN_SUBMIT:return!1}}function er(e,t){switch(t){case M.ASK_CHATGPT:case M.ACCEPT_COMMENT:case M.FULL_SCREEN_SUBMIT:return e.formatMessage(nr.askChatGPT);case M.ACCELERATOR:case M.CONSOLE:return}}const tr=(e,t)=>{const n=Y(),{tags:s}=Un(e),o=Bn(),r=zn(e),a=Vn(e)??o.id,l=Yn({clientThreadId:e});return p.useCallback(async({content:u,sourceRange:c,action:d,userMessageType:f,acceleratorMetadata:h,selectionMetadata:x})=>{if(t?.versionInt==null)return;const{textdocId:g,type:m,versionInt:C,content:y}=t;let v,b=null;c&&c.start!==c.end&&(v=y.slice(c.start,c.end),b=Yo(c,y));const T=Zo(g,m,d,v,b),k=Gn(T,{exclude_after_next_user_message:!0}),j=performance.now(),S=await wn(),[$,q,F]=await Promise.all([En.getEnforcementToken(S),Wn.getEnforcementToken(S),bn.getEnforcementToken(S)]),D=new Jn,pe=pt.getThreadCurrentLeafId(e),J=`${pe}-nextPrompt`;pt.updateTree(e,Oe=>{Oe.addNode(J,u,pe,$e.User,void 0,{canvas:{textdoc_id:g,textdoc_type:m,version:C,textdoc_content_length:y.length,user_message_type:f,accelerator_metadata:h,selection_metadata:x},is_visually_hidden_from_conversation:Ko(f),targeted_reply:v,targeted_reply_label:er(n,f),open_in_canvas_view:{type:"canvas_textdoc",id:g}})}),l({model:a,completionType:Sn.Next,parentNodeId:J,metadata:{eventSource:"mouse"},completionMetadata:r?{conversationMode:r}:void 0,chatReq:S,arkoseToken:$??null,turnstileToken:q??null,proofToken:F??null,preflightTime:performance.now()-j,appendMessages:[k],turnTracker:D})},[t,s,e,l,a,r,n])},nr=he({askChatGPT:{id:"h5ANdM",defaultMessage:"Asked ChatGPT"}});function sr(e){const t=/\[([^\]]+)\]\((https?:\/\/[^\s)]+|www\.[^\s)]+)\)/gi,n=new Set,s=e.matchAll(t);for(const o of s){const r=o[2];try{let a=r;a.startsWith("www.")&&(a="http://"+r),new URL(a),n.add(r)}catch{}}return n}const or=async({lastVersion:e,textdocId:t,content:n,comments:s})=>{const o=Qn(s,n);return(await It.safePost("/textdoc/{textdoc_id}",{parameters:{path:{textdoc_id:t}},requestBody:{version:e,content:n,comments:o}})).version},rr=()=>{const e=p.useRef([]),t=p.useRef(null),{mutateAsync:n,isPending:s}=kn({mutationKey:["canvas","textdoc","persist"],mutationFn:or});return[p.useCallback(async(r,a,l)=>{const u=new AbortController,d=(async()=>{const[g]=e.current;try{await g?.promise}catch(m){R.logError("Saving document",m)}if(!u.signal.aborted)try{const m=Math.max(t.current??0,r.versionInt??zt);let C="";try{dt(a)?C=a():C=a}catch(T){R.logError("Serializing document",T)}let y=[];try{dt(l)?y=l():y=l}catch(T){R.logError("Adjusting comments",T)}const{textdocId:v}=r;Xn({textdocId:v,basedOnVersionInt:m,content:C,comments:y});const b=await n({textdocId:v,lastVersion:m,content:C,comments:y});Zn({textdocId:v,basedOnVersionInt:m,newVersion:b}),t.current=b}catch(m){R.logError("Error saving document",m)}finally{e.current.shift()}})(),f={abort:()=>u.abort(),promise:d},[h,x]=e.current;return x&&(x.abort(),e.current=h?[h]:[]),e.current=h?[h,f]:[f],d},[n]),e,s]},ar=3e3,ir=e=>{const[t,n,s]=rr(),o=Y(),r=p.useRef(null),a=p.useCallback(Kn(t,ar,{leading:!1}),[t]),l=es(e);return p.useEffect(()=>{if(!l)return;const c=ft(window,{pagehide:()=>a.flush(),beforeunload:f=>{a.flush(),f.returnValue=o.formatMessage({id:"QZrKwi",defaultMessage:"You have a canvas save in progress."})}}),d=ft(document,{visibilitychange:()=>a.flush(),keydown:()=>{r.current="keyboard"},mousemove:()=>{r.current!=="mouse"&&a.flush(),r.current="mouse"}});return()=>{r.current=null,d(),c()}},[o,l,a]),p.useEffect(()=>()=>{a.flush()},[e,a]),ts(async()=>{await a.flush(),await Promise.allSettled(n.current?.map(({promise:c})=>c)??[])}),[p.useCallback((c,d,f)=>{const{textdocId:h}=c;return ns(h),a(c,d,f)},[a]),a.flush,s||l]};function lr(e,t,n){const s=Lt(),o=n!=null&&t!=null,{data:r,error:a,fetchNextPage:l,hasNextPage:u,isFetching:c}=Mn(Ot(e,t,o)),d=p.useCallback(async()=>{const m=t!=null;await s.prefetchInfiniteQuery(Ot(e,t,m))},[s,e,t]);p.useEffect(()=>{const m=t;return()=>{s.removeQueries({queryKey:Qt(e,m),exact:!0})}},[s,e,t]);const[f,h,x,g]=p.useMemo(()=>{if(r&&n){const C=r.pages.flatMap(v=>v),y=C.findIndex(v=>"beforeVersion"in n?(v.versionInt??zt)<n.beforeVersion:v.versionInt===n.version);if(y!==-1)return[y===C.length-1,C[y],y>0?C[y-1]:null,y<C.length-1?C[y+1]:null]}const m=r?.pages.flatMap(C=>C)??[];return[!0,null,null,m.length===0?null:m[0]]},[r,n]);return p.useEffect(()=>{!c&&o&&u&&f&&l()},[c,o,u,f,l]),p.useEffect(()=>{!h&&a&&ce(e)},[h,a,e]),{historicalTextdocVersion:h,nextHistoricalTextdocVersion:x,prefetchHistoricalTextdocVersion:d,previousHistoricalTextdocVersion:g}}function Qt(e,t=null){return["textdocHistory",e,t]}function Ot(e,t,n=!0){return{queryKey:Qt(e,t),queryFn:({pageParam:s})=>cr(e,s),initialPageParam:t??void 0,getNextPageParam:s=>{const o=ss(s)?.versionInt;if(o&&o>1)return o},enabled:n,staleTime:1/0,retry:2}}async function cr(e,t){return t===void 0?[]:(await It.safeGet("/textdoc/{textdoc_id}/history",{parameters:{path:{textdoc_id:e},query:{before_version:t}}})).previous_doc_states.map(({id:s,version:o,textdoc_type:r,title:a,content:l,updated_at:u,comments:c})=>({textdocId:s,versionInt:o,messageId:null,title:a,type:os(r),content:l,status:rs.COMPLETE,createdAt:as(u),comments:is(c,l)}))}const Ar=({isFullScreen:e=!1,isEmbedded:t=!1,hideHeader:n=!1,readonlyReason:s,clientThreadId:o,focusedTextdoc:r,onClose:a,isAnimating:l=!1,width:u,hideBottomComposer:c=!1})=>{const{textdocId:d,history:f,showChangesAtVersion:h=null}=r,x=Ut(),[g,m,C]=ir(d),{targetedContent:y}=ls(),v=cs(),[b,T]=p.useState(!1),A=us(d),k=ds(),j=fs(o),S=ms(j),[$,q]=qt(),F=hs(),{data:D,isLoading:pe}=ps(d,F?h:null),[J,Oe]=p.useState(!1),P=A?.versions??[],Je=P[0]?.versionInt,{historicalTextdocVersion:ge,nextHistoricalTextdocVersion:Xt,previousHistoricalTextdocVersion:Qe,prefetchHistoricalTextdocVersion:Zt}=lr(d,Je,f),Kt=Ft();p.useEffect(()=>{ke.reset()},[d]);const Xe=P.length>0?P[P.length-1]:null,Ie=P.length>1?P[P.length-2]:null,Ze=gs(o),{restoreHistoricalTextdocVersion:Ke,optimisticRestoredTextdocVersion:en}=vs(Ze,Xe,ge),Q=f!=null,E=Q?ge:Xe,ve=F&&h!=null,Ce=tr(o,E),et=l||!F?null:D,xe=(()=>{if(l||E==null)return[];const w=yt(E.comments);return!ve&&ge!=null?ge.comments:!ve||D==null?w:D.contentBefore!==D.contentAfter?[]:Po(D.commentsBefore,D.commentsAfter)})(),H=E?.type??L.LOADING,tn=Cs(),ee=Pt(E),Le=Ht(E),nn=xs(E),sn=Xs(k);p.useEffect(()=>{P.length===0&&!k&&sn&&a?.()},[P.length,k]);const on=!!s&&s!==I.OldVersion,{content:U,currentlyStreamingLineIndex:tt}=D?.contentBefore!=null&&!ie(H)?{content:D.contentBefore,currentlyStreamingLineIndex:null}:_o(E,Ie),rn=Qs(Ze,Array.from(sr(U))),[ye,Re]=oo({value:U,isRequestActive:S,isTextdocStreaming:ee,comments:xe}),nt=ys(E);p.useEffect(()=>{d&&gt().sendMessage({type:qe.Loaded})},[d]);const st=tn===Ts.LAST_TURN||ye||C;p.useEffect(()=>{gt().sendMessage({type:qe.Streaming,streaming:st})},[st]);const an=({getSerializedDocument:w,getAdjustedComments:N})=>{E&&g(E,w,N)},ln=w=>{if(!E)return;const N=w.doc.toString();g(E,N,w.field(Ds,!1)??[])},ot=(w,N,B,X)=>{Re(!0),Ce({action:N,content:w,userMessageType:M.ASK_CHATGPT,sourceRange:B,selectionMetadata:{selection_type:X,selection_position_range:B}})},rt=({id:w})=>{nt(w,vt.DISMISS),ke.reset()},at=async w=>{Re(!0);const{id:N,at:B,content:X}=w;if(await nt(N,vt.ACCEPT)===!1)return Re(!1);Ce({content:X,userMessageType:M.ACCEPT_COMMENT,sourceRange:B,action:G.EDIT,selectionMetadata:{selection_type:Ct.SELECTION,selection_position_range:B}})},_e=(w,N,B)=>{const{action:X}=B;Ce({action:X,content:N,sourceRange:w,userMessageType:M.ACCELERATOR,acceleratorMetadata:{action:X,id:B.id,prompt:N},selectionMetadata:w!=null?{selection_type:Ct.SELECTION,selection_position_range:w}:void 0})},cn=w=>{Ce({action:G.EDIT,content:w,userMessageType:M.FULL_SCREEN_SUBMIT})},un=An(),dn=Lt(),fn=ws(),it=w=>fn?.[w]??w,Pe=()=>Ss({clientThreadId:o,currentRequestId:j,queryClient:dn,isHistoryAndTrainingDisabled:un}),mn=()=>{f?Se(d,f):ce(d)};let O=s;Q?O=I.OldVersion:ve?O=I.ShowingChanges:en!=null?O=I.Restoring:(ee||S)&&(O=I.Streaming);let Te=null;const lt=l||O!=null||ye,ct=()=>{if(l&&xe.length>0)return ne.ALL_HIDDEN;if(O==null)return ne.ENABLED;switch(O){case I.Streaming:return ne.ENABLED;case I.ShowingChanges:case I.OldVersion:return ne.COMMENTS_READONLY;default:return ne.ALL_HIDDEN}},ut=e||l;let He=[];switch(H){case L.LOADING:Te=i.jsx(Ns,{});break;case L.DOCUMENT:Te=i.jsx(As,{value:U,comments:xe,previousValue:Ie?.content,previousComments:yt(Ie?.comments),isRewriting:Le,isAnimatingFromPreview:l,getStableCommentId:it,diff:et,isRequestActive:S,isDisabled:O!=null||k,isWaitingForCommentResponse:ye,hideAccelerators:ut,hideToolbar:lt,hideEditOverlay:l,commentsMode:ct(),readonlyReason:O,onBlur:m,onSave:m,onChange:an,onCancelRequest:Pe,targetedContent:y,onAddComment:ot,onAcceptComment:at,onDismissComment:rt,onSubmitAccelerator:_e,onExitShowChanges:mn,safeUrls:rn,width:u,modelCursor:ee&&!Le?E?.modelCursor:void 0,shouldResetSelection:E?.versionInt===1}),He=Vs;break;default:if(ie(H)){const w=Fe(H,U),N=i.jsx(Ms,{id:"codemirror",getStableCommentId:it,language:Rt(H),value:U,comments:xe,hideAccelerators:ut,commentsMode:ct(),hideToolbar:lt,onSubmitAccelerator:_e,currentlyStreamingLineIndex:tt??null,readonlyReason:O,isRequestActive:S,isWaitingForCommentResponse:ye,onChange:ln,onCancelRequest:Pe,onAddComment:ot,onDismissComment:rt,onAcceptComment:at,textdocDiff:et??void 0,modelCursor:ee&&tt==null?E?.modelCursor:void 0});Te=!x||!w?N:i.jsxs(i.Fragment,{children:[i.jsx("div",{style:{display:J?"none":"block"},children:N}),i.jsx(so,{hidden:!J,isStreaming:ee,textdocContent:U,textdocType:H})]}),He=js}}const hn=p.useRef(null);Bt()&&!Q&&Ge(H);const pn=()=>{Fe(H,U)?Oe(w=>!w):hn.current?.runCode(H,U)},{eligible:gn}=Es();return i.jsxs(oe,{children:[!n&&i.jsx(Bo,{textdocId:d,isHistoricalVersion:Q,nextHistoricalTextdocVersion:Xt,previousHistoricalTextdocVersion:Qe,textdocVersion:E,readonlyReason:O,history:f,hasDebug:v,contentWidth:$.width,isEmbedded:t,isPersisting:C,isShowChangesFeatureEnabled:F,isShowingChanges:ve,latestVersionInt:Je,hideHistoryActions:O===I.QueryParam,prefetchHistoricalTextdocVersion:()=>{Zt();const w=Qe?.versionInt;w!=null&&Kt(d,w)},restoreHistoricalTextdocVersion:Ke,setShowDebugView:T,onClose:()=>{R.logButtonClick(le.CLOSE_TEXTDOC,{textdocType:E?.type}),a?.()},onClickCodePreview:pn,isShowingCodePreview:J}),i.jsxs(oe.Content,{ref:q,scrollToBottomMode:nn?"bottom":"top",shouldScrollToTop:Le,isLoading:pe,children:[!1,Te]}),!1,i.jsx(_t,{children:Q&&!on&&i.jsx(ro,{onClickRestore:Ke,onClickResetLatest:()=>ce(d)})}),e&&!Q&&!c&&i.jsx(Eo,{isRequestActive:S,clientThreadId:o,onSubmitAccelerator:_e,onSubmit:cn,onCancel:Pe,acceleratorActions:He}),!l&&!t&&gn&&i.jsx(bs,{})]})};export{qe as C,Ar as T,Ks as g,Zs as i};
//# sourceMappingURL=cl36x71jw22xq21h.js.map
