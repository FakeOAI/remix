import{a4 as w,ak as h,P as I,A as F,bK as v,J as _}from"./7q6a9ksdf0pmxyke.js";import{be as b,bf as E,bg as g,bh as y,bi as k,a6 as M}from"./g61cr21b5136jq6j.js";import{z as C}from"./iogitfx8hqgnt4ng.js";function D(e){var t,a;return((a=(t=e.metadata)==null?void 0:t.dalle)==null?void 0:a.prompt)??""}async function L(e,t,a="image/png"){return new Promise((i,n)=>{e.toBlob(o=>{o!=null?i(new File([o],t,{type:a})):n(new Error("Failed to convert canvas to blob"))},a)})}async function P(e,t){const a=document.createElement("canvas");a.width=e.width,a.height=e.height;const i=a.getContext("2d");if(i==null)throw new Error("Failed to get 2d context for mask canvas");const n=i.createImageData(e.width,e.height);for(let o=0;o<e.data.length;o+=4)e.data[o+3]!==0?(n.data[o]=0,n.data[o+1]=0,n.data[o+2]=0,n.data[o+3]=255):(n.data[o]=255,n.data[o+1]=255,n.data[o+2]=255,n.data[o+3]=255);return i.putImageData(n,0,0),L(a,t)}async function S(e,t){const i=await(await fetch(e)).blob(),n=document.createElement("a");n.href=URL.createObjectURL(i),n.download=t,n.click(),n.remove()}function G(e){const t=M(new Date,"yyyy-MM-dd HH.mm.ss");let a=e.slice(0,150);return a.endsWith(".")&&(a=a.slice(0,-1)),`DALLÂ·E ${t} - ${a}.webp`}async function A(e,t,a){var o,d,r,s,l,c,u,m,p,f;const i=D(e),n=G(i);await S(e.url,n),h.logEvent("chatgpt_dalle_image_download",null,{sourceOperation:((d=(o=e.metadata)==null?void 0:o.dalle)==null?void 0:d.edit_op)??"none",hasParent:((s=(r=e.metadata)==null?void 0:r.dalle)==null?void 0:s.parent_gen_id)!=null?"true":"false"}),I.logEvent(F.dalleImageDownload,{conversationId:t,messageId:a,generationId:(c=(l=e.metadata)==null?void 0:l.dalle)==null?void 0:c.gen_id,parentGenerationId:(m=(u=e.metadata)==null?void 0:u.dalle)==null?void 0:m.parent_gen_id,fileId:g(e.asset_pointer),sourceOperation:(f=(p=e.metadata)==null?void 0:p.dalle)==null?void 0:f.edit_op})}function H(e){const t=C(e),a=b(),i=t&&"gizmo"in t?t.gizmo:void 0;return!a&&(i==null?void 0:i.gizmo.id)===E}function N(e,t){var n,o;const a=(o=(n=t.metadata)==null?void 0:n.dalle)==null?void 0:o.gen_id,i=g(t.asset_pointer);return i==null||a==null?e:{...e,messageMetadata:{...e.messageMetadata,dalle:{from_client:{operation:{type:"transformation",original_gen_id:a,original_file_id:i}}}}}}async function U(e,t,a,i){return new Promise((n,o)=>{y(k(e),e,t,a,{kind:v.DalleAgent},{onFileCreated:_,onFileUploadProgress:_,onFileUploaded:(d,r)=>n(r),onError:(d,r)=>{o(new Error(`Failed to upload file with reason: ${r}`))}},i)})}async function O(e,t,a,i,n){var r,s;const o=(s=(r=t.metadata)==null?void 0:r.dalle)==null?void 0:s.gen_id,d=g(t.asset_pointer);if(d==null||o==null||a==null)return e;try{const l=await P(a,"mask.png"),c=await U(l,i,n,{imageDimensions:{width:t.width,height:t.height}});return{...e,messageMetadata:{...e.messageMetadata,dalle:{from_client:{operation:{type:"inpainting",original_gen_id:o,original_file_id:d,mask_file_id:c}}}}}}catch(l){return w.addError(l),e}}export{H as a,A as d,D as g,N as s,O as u};
//# sourceMappingURL=jywkt8fol4gvvvcv.js.map
