import{at as O,am as k,r as m,j as G,v as q,e4 as N,bk as B,a2 as H,bL as v,e5 as I,e6 as j,a3 as x,cI as f,cv as E,E as F,cG as $,e7 as K,a1 as Q,e8 as W,U as X,dh as Y}from"./nkav6u5sgjh9k32o.js";import{bK as J,bL as V,bM as Z,bN as ee,ax as _,ay as R,D as p,bO as re,bP as te,aT as se,_ as w,J as ne,bQ as ae,E as oe,z as de,bR as ue}from"./fvuv8t2jnmmokuz9.js";import{m as ie}from"./modnlcjxa99o7fdj.js";function Ee(){const{imageResults:e}=ce();Z([...e.map(r=>P(r))])}const le=J((...e)=>V(...e),5e3);function ce(e=!1){var l,c;const r=ee(["image_results","image_try_hard_status","execution_status"]),t=_(R.threadId),s=p(r.toReversed().flatMap(T=>{var C;return(C=T.image_results)==null?void 0:C.entries})).map(T=>({...T,thumbnail_url:T.thumbnail_url.replace(/^http:\/\//,"https://"),content_url:T.content_url.replace(/^http:\/\//,"https://")})),n=_(R.hasModelResponseText),o=r.some(T=>re(T));let d=s.length===0&&!n;return t!=null&&e&&!d&&s.length===0&&((l=r[0])==null?void 0:l.image_try_hard_status)==="not_attempted"&&(le(t,0),d=!0),e&&((c=r[0])==null?void 0:c.image_try_hard_status)==="in_progress"&&(d=!0),{imageResults:s,isLoading:d,isErrored:s.length===0&&o}}function Fe(){const e=te(),r=_(R.hasTurnError),t=_(R.hasModelResponseText),s=U(e);return{imageResults:s,isLoading:s.length===0&&!t,isErrored:s.length===0&&r}}function U(e){return p(e.flatMap(r=>r.type==="image_v2"?r.images:[]))}function he(e){const r={};return e.map(t=>{t.type==="webpage"||t.type==="webpage_extended"?t.url&&!r[t.url]&&(r[t.url]=t):t.type==="grouped_webpages"&&t.items.forEach(s=>{s.url&&!r[s.url]&&(r[s.url]=s)})}),Object.values(r)}function Te(e){return O({queryKey:["downloadImage",{imageUrl:e}],queryFn:()=>new Promise((r,t)=>{const s=new Image;s.onload=()=>{r({width:s.width,height:s.height})},s.onerror=()=>{t()},s.src=e}),enabled:e!=null})}function Ue(e){return k(Te(e))}const D={width:474,square:!0};function P(e,r=D){if(e==null)return;const t=new URL(e.thumbnail_url);if(t.hostname.indexOf(".bing.")===-1)return e.thumbnail_url;const s=Math.min(r.width,e.content_size.width),n=r.height??Math.floor(s*e.content_size.height/e.content_size.width);if(t.searchParams.delete("pid"),r.square){const o=Math.min(s,n);t.searchParams.set("w",o.toString()),t.searchParams.set("h",o.toString())}else t.searchParams.set("w",s.toString()),t.searchParams.set("h",n.toString());return t.searchParams.set("c","7"),t.toString()}function De(e,r=D){return m.useMemo(()=>P(e,r),[e,r])}const ge={type:"spring",stiffness:700,damping:82};function Pe({children:e,className:r}){return G.jsx(ie.div,{animate:{opacity:1},initial:{width:"100%",height:"100%",translateX:0,translateY:0,opacity:0},whileHover:{width:"103%",height:"103%",translateX:"-1.5%",translateY:"-1.5%"},transition:ge,className:r,children:e})}function z(e,r,t){var n,o;if(t)return t;const s=e[r];return(o=(n=s==null?void 0:s.message)==null?void 0:n.metadata)!=null&&o.model_slug?s.message.metadata.model_slug:s!=null&&s.parentId?z(e,s.parentId):null}function ze(){return`${N}${B()}`}let me=0;function Ae(){return me++}function y(e){return e.startsWith(N)}const ve=()=>new I,Ie=()=>Object.freeze({lastModelUsed:null,createTime:new Date});var fe=(e=>(e.NewChat="NewChat",e.Server="Server",e.User="User",e.Generated="Generated",e.Unknown="Unknown",e))(fe||{});const L={},i=q(H(()=>({threads:{},clientNewThreadIdToServerIdMapping:{},threadRetainCounts:{}}))),u=i.getState,g=i.setState,h={resolveThreadId:(e,r=u())=>r.clientNewThreadIdToServerIdMapping[e]??e,getThread:(e,r=u())=>{const t=h.resolveThreadId(e,r);return r.threads[t]??null},hasThread:(e,r=u())=>{const t=h.resolveThreadId(e,r);return r.threads[t]!=null},isLoading:(e,r=u())=>{var s;const t=h.resolveThreadId(e,r);return(s=r.threads[t])==null?void 0:s.isLoading},getConversationMode:(e,r=u())=>{var s;const t=h.resolveThreadId(e,r);return(s=r.threads[t])==null?void 0:s.mode},getThreadModelId:(e,r=u())=>{var t;return((t=h.getThread(e,r))==null?void 0:t.modelId)??null},getGizmoId(e,r=u()){const t=r.threads[h.resolveThreadId(e,r)];if((t==null?void 0:t.mode.kind)===v.GizmoInteraction||(t==null?void 0:t.mode.kind)===v.GizmoTest)return t.mode.gizmo_id},getThreadTitleSource(e,r=u()){const t=h.resolveThreadId(e,r),s=r.threads[t];return s!=null?s.titleSource:"Unknown"},getThreadCreateTime(e,r=u()){var s,n;const t=h.resolveThreadId(e,r);return(n=(s=r.threads[t])==null?void 0:s.initialThreadData)==null?void 0:n.createTime},getCurrentNode(e,r=u()){var n;const t=h.resolveThreadId(e,r),s=((n=r.threads[t])==null?void 0:n.currentLeafId)??"root";return a.getTree(e).getNodeByIdOrMessageId(s)},isThreadUrlSafe(e,r,t=u()){var n;const s=h.resolveThreadId(e,t);return((n=t.threads[s])==null?void 0:n.safeUrls.includes(r))??!1},getRatingPrompt(e,r=u()){var s;const t=h.resolveThreadId(e,r);return(s=r.threads[t])==null?void 0:s.promptGptRating},getTurnContentReferences(e,r,t=u()){var n,o;const s=(o=(n=h.getThread(e,t))==null?void 0:n.conversationTurns[r])==null?void 0:o.messages;return s?p(s.flatMap(d=>{var l,c;return(c=(l=d.message)==null?void 0:l.metadata)==null?void 0:c.content_references})):[]},getTurnSearchResults(e,r,t=u()){var n,o;const s=(o=(n=h.getThread(e,t))==null?void 0:n.conversationTurns[r])==null?void 0:o.messages;return s?p(s.flatMap(d=>be(d.message))):[]},getTurnImageSearchResults(e,r,t=u()){var n,o;const s=(o=(n=h.getThread(e,t))==null?void 0:n.conversationTurns[r])==null?void 0:o.messages;return s?p(s.flatMap(d=>Me(d.message))).map(d=>({...d,thumbnail_url:d.thumbnail_url.replace(/^http:\/\//,"https://"),content_url:d.content_url.replace(/^http:\/\//,"https://")})):[]},getIsArchived(e,r=u()){var t,s;return((s=(t=h.getThread(e,r))==null?void 0:t.initialThreadData)==null?void 0:s.isArchived)??!1}},a={initThread:(e,r,t=null)=>{const s=a.resolveThreadId(e);if(u().threads[s]==null){const n=K();g(o=>{o.threads[s]={initialThreadData:n,mode:r,modelId:t,tree:new I(I.createTree()),title:null,titleSource:"NewChat",currentLeafId:"root",conversationTurns:[],safeUrls:[],isLoading:!y(s),docsReferencedByURL:{},conversationOrigin:null}})}},setThreadModelId:(e,r)=>{const t=a.resolveThreadId(e);g(s=>{const n=s.threads[t];n!=null&&(n.modelId=r)})},updateConversationMode:(e,r)=>{const t=a.resolveThreadId(e);g(s=>{const n=s.threads[t];n!=null&&(n.mode=r)})},getServerThreadId:e=>y(e)?u().clientNewThreadIdToServerIdMapping[e]:e,setServerIdForNewThread:(e,r)=>{u().clientNewThreadIdToServerIdMapping[e]===void 0&&g(t=>{t.threads[r]=t.threads[e],delete t.threads[e],t.clientNewThreadIdToServerIdMapping[e]=r})},initThreadFromServerData:(e,r,t=!1,s=void 0,n=!1)=>{var M;const o=a.resolveThreadId(e);if(!n&&(u().threads[o]==null&&!t||((M=u().threads[o])==null?void 0:M.isLoading)===!1))return;const d=j(r),l=d.mapping??I.createTree(),c={lastModelUsed:z(d.mapping,d.initialCurrentLeafId,r.default_model_slug),createTime:"create_time"in r?new Date(r.create_time*1e3):void 0,isArchived:r.is_archived??!1},T=new I(l),C=d.initialCurrentLeafId??d.rootId??"root",A="has_user_editable_context"in r?{hasUserEditableContextFlag:r.has_user_editable_context,authorName:r.author_name,model:"model"in r&&r.model!=null?se(r.model):void 0}:void 0;g(b=>{const S=b.threads[o];b.threads[o]={modelId:(S==null?void 0:S.modelId)??null,initialThreadData:c,mode:r.gizmo_id!=null?{kind:v.GizmoInteraction,gizmo_id:r.gizmo_id}:{kind:v.PrimaryAssistant,plugin_ids:r.plugin_ids},sharedConversationMetadata:A,title:r.title??null,titleSource:"Server",tree:T,currentLeafId:C,isLoading:!1,continuingFromSharedConversationId:s,safeUrls:r.safe_urls??[],conversationTurns:[],docsReferencedByURL:{},conversationOrigin:r.conversation_origin??null,async_status:r.async_status??null,update_time:r.update_time??null}}),w.publish({kind:"createConversation",clientThreadId:e}),a.recomputeConversationTurnsForCurrentLeafId(o,[])},updateInitialThreadDataForNewThread:(e,r)=>{const t=a.resolveThreadId(e);g(s=>{const n=s.threads[t];n!=null&&(n.initialThreadData.lastModelUsed=r)})},getThreadCurrentLeafId:e=>{var t;const r=a.resolveThreadId(e);return((t=u().threads[r])==null?void 0:t.currentLeafId)??"root"},getThreadSafeUrls:e=>{var t;const r=a.resolveThreadId(e);return(t=u().threads[r])==null?void 0:t.safeUrls},addThreadSafeUrl:(e,r)=>{const t=a.resolveThreadId(e);t&&g(s=>{const n=s.threads[t];n!=null&&n.safeUrls.push(r)})},setThreadCurrentLeafId:(e,r)=>{const t=a.resolveThreadId(e);u().threads[t]!=null&&g(n=>{const o=n.threads[t];if(o==null)return;o.currentLeafId=r;const d=a.computeThreadConversationTurns(t,o.currentLeafId,o.conversationTurns);o.conversationTurns=d})},setTitle:(e,r,t)=>{const s=a.resolveThreadId(e);g(n=>{const o=n.threads[s];o&&(o.title=r,o.titleSource=t)})},getTitle:e=>{var t;const r=h.resolveThreadId(e);return((t=u().threads[r])==null?void 0:t.title)??void 0},getTitleAndSource:e=>({title:a.getTitle(e),titleSource:h.getThreadTitleSource(e)}),getConversationOrigin:e=>{var t;const r=h.resolveThreadId(e);return((t=u().threads[r])==null?void 0:t.conversationOrigin)??null},setConversationOrigin:(e,r)=>{const t=a.resolveThreadId(e);g(s=>{const n=s.threads[t];n&&(n.conversationOrigin=r)})},deleteNodesByFilter:(e,r)=>{const t=a.getThreadCurrentLeafId(e);a.updateTree(e,s=>{s.deleteNodesByFilter(r).includes(t)&&a.setThreadCurrentLeafId(e,"root")})},updateTree:(e,r)=>{var l;const t=a.resolveThreadId(e);if(!(u().threads[t]!=null)){console.warn("Thread does not exist, cannot update tree: ",t);return}const n=a.getTree(e);r(n);const d=((l=u().threads[t])==null?void 0:l.conversationTurns)??[];a.recomputeConversationTurnsForCurrentLeafId(t,d)},getTree:e=>{var t;const r=a.resolveThreadId(e);return((t=u().threads[r])==null?void 0:t.tree)??ve()},resolveThreadId:e=>h.resolveThreadId(e),recomputeConversationTurnsForCurrentLeafId:(e,r)=>{const t=a.resolveThreadId(e);g(s=>{const n=s.threads[t];if(n==null)return;const o=a.computeThreadConversationTurns(t,n.currentLeafId,r);n.conversationTurns=o})},computeThreadConversationTurns:(e,r,t)=>{const s=a.resolveThreadId(e);return a.getTree(s).getConversationTurns(r).map((l,c)=>{const T=t==null?void 0:t[c];return x(T,l)?T:l})},getThreadConversationTurns:(e,r,t)=>{var T;const s=a.resolveThreadId(e),o=u().threads[s];if(o==null)return[];const d=o.tree,l=d.messageIdToNodeId((o==null?void 0:o.currentLeafId)??"root"),c=r!=null?d.messageIdToNodeId(r):null;return c!=null&&c!==l?a.computeThreadConversationTurns(s,c,t??[]):((T=u().threads[s])==null?void 0:T.conversationTurns)??[]},removeContinuingFromSharedConversationId:e=>{const r=a.resolveThreadId(e);g(t=>{const s=t.threads[r];(s==null?void 0:s.continuingFromSharedConversationId)!=null&&delete s.continuingFromSharedConversationId})},updateReferencedDocState:(e,r,t)=>{const s=a.resolveThreadId(e);g(n=>{const o=n.threads[s];o&&(o.docsReferencedByURL[r]=t)})},copyLastMessageToClipboard:(e,r="mouse")=>{const t=a.getThreadCurrentLeafId(e),s=a.getThreadConversationTurns(e,t);return a.copyMessageToClipboard(e,s.length-1,r)},copyMessageToClipboard:(e,r,t="mouse")=>{const s=a.getThreadCurrentLeafId(e),o=a.getThreadConversationTurns(e,s)[r];if(!o)return Promise.reject();const{messages:d}=o,l=d.reduce((c,T)=>!T.err&&T.message.author.role===f.Assistant&&T.message.recipient==="all"?c+(c?`

`:"")+E(T.message):c,"");return ne(l).then(()=>{const c=a.getServerThreadId(e);c&&F.submitImplicitMessageFeedback({messageId:d[0].message.id,type:"copy",serverThreadId:c,selectedText:l,source:t})})},getLastMessgageSystemHints:(e,r)=>{var d;const t=a.resolveThreadId(e),o=a.getTree(t).getBranchFromLeaf(r).slice().reverse().find(l=>l.message.author.role===f.User);return((d=o==null?void 0:o.message.metadata)==null?void 0:d.system_hints)??[]},deleteThread:e=>{g(r=>{delete r.threads[e],delete r.clientNewThreadIdToServerIdMapping[e]}),w.publish({kind:"deleteConversation",serverThreadId:e})},retainThread:e=>{g(r=>{r.threadRetainCounts[e]=(r.threadRetainCounts[e]??0)+1}),clearTimeout(L[e])},releaseThread:e=>{u().threads[e]!=null&&(g(t=>{t.threadRetainCounts[e]=Math.max((t.threadRetainCounts[e]??0)-1,0)}),!(u().threadRetainCounts[e]>0)&&(clearTimeout(L[e]),L[e]=setTimeout(()=>{u().threads[e]!=null&&(u().threadRetainCounts[e]>0||a.deleteThread(e))},3e4)))},setPromptGptRating:(e,r)=>{const t=a.resolveThreadId(e);g(s=>{const n=s.threads[t];n!=null&&(r==null?n.promptGptRating=void 0:n.promptGptRating={gizmoId:r})})}};async function Oe(e,r){const t=await F.getConversation(e);return Q.addTiming("chatgpt.web.chatPage.loadExistingConversation"),a.initThreadFromServerData(e,t,r,void 0,r),t}const ke=e=>i(t=>h.getThreadModelId(e,t))??de,pe=e=>i(r=>{if(e!=null)return y(e)?r.clientNewThreadIdToServerIdMapping[e]:e}),Ge=e=>i(r=>{var s;const t=a.resolveThreadId(e);return((s=r.threads[t])==null?void 0:s.initialThreadData)??Ie()}),qe=(e,r)=>i(t=>{const s=h.getConversationMode(e,t);return r&&((s==null?void 0:s.kind)===v.GizmoInteraction||(s==null?void 0:s.kind)===v.PrimaryAssistant)?{gizmo_id:r,kind:v.GizmoInteraction}:s}),Ce=e=>{const r=ae();return i(t=>t.threads[h.resolveThreadId(e,t)]==null?r:h.getGizmoId(e,t))},Be=e=>!!Ce(e),He=e=>i(r=>{var s;const t=a.resolveThreadId(e);return((s=r.threads[t])==null?void 0:s.isLoading)??!1}),_e=e=>i(()=>a.getThreadCurrentLeafId(e)),je=(e,r)=>{const t=m.useRef([]);return i(()=>{const s=a.getThreadConversationTurns(e,r,t.current);return t.current=s,(s==null?void 0:s.length)??0})},$e=(e,r)=>{const t=m.useRef([]);return i(()=>{const s=a.getThreadConversationTurns(e,r,t.current);return t.current=s,s})},Ke=(e,r,t)=>{const s=m.useRef([]);return i(()=>{const n=a.getThreadConversationTurns(e,t,s.current);return s.current=n,r>=0&&r<n.length?n[r]:null})},Qe=(e,r)=>{const t=m.useRef([]);return i(()=>{const s=a.getThreadConversationTurns(e,r,t.current);return t.current=s,s.length>0?s[s.length-1]:null})},We=(e,r)=>{const t=m.useRef([]);return i(()=>{const s=a.getThreadConversationTurns(e,r,t.current);t.current=s;let n=0;for(let o=s.length-1;o>=0;o--){const d=s[o];if(d.messages.some(l=>{var c;return(c=l.message.metadata)==null?void 0:c.is_indepth_feedback}))return!0;if(d.messages.some(l=>l.message.author.role===f.Assistant)&&n++,n>=3)break}return!1})},Xe=(e,r)=>i(()=>{const t=a.resolveThreadId(e);return a.getTree(t).getBranchFromLeaf(r).some(o=>o.message.author.role===f.User)}),Ye=e=>{const r=_e(e);return m.useMemo(()=>{const t=a.getThreadConversationTurns(e,r,[]),s=(t==null?void 0:t.length)??0,n=(t==null?void 0:t[s-1])??null;return s===0?r:I.getRequestIdFromConversationTurn(n)},[r,e])},Je=e=>i(()=>a.getTitle(e)),Ve=e=>W(i,()=>a.getTitleAndSource(e),x),Ze=e=>i(()=>{var t;const r=a.resolveThreadId(e);return(t=u().threads[r])==null?void 0:t.continuingFromSharedConversationId}),er=e=>i(()=>{var t,s;const r=a.resolveThreadId(e);return(s=(t=u().threads[r])==null?void 0:t.sharedConversationMetadata)==null?void 0:s.authorName}),rr=(e,r)=>i(()=>{const t=a.getTree(e).getNodeByIdOrMessageId(r);if(t==null)throw new Error(`useThreadTreeNode: cannot get tree node for ${r} in thread ${e}`);return t}),tr=(e,r)=>i(()=>{var t;return((t=a.getTree(e))==null?void 0:t.getHasErrorFromNode(r))??!1}),sr=(e,r)=>i(()=>{var t;return((t=a.getTree(e))==null?void 0:t.isMessageIncomplete(r))??!1}),Re=(e,r)=>i(()=>{const t=a.getTree(e);return t==null?[]:t.getBranchFromLeaf(r).filter(s=>s.message.author.role!==f.Root)}),nr=(e,r)=>Re(e,r).map(t=>t.message),ar=(e,r)=>i(()=>{const t=a.getTree(e);return t==null?null:t.getLeafFromNode(r)}),or=(e,r)=>i(()=>{const t=a.getTree(e);return t==null?!1:r.map(n=>t.getLeafFromNode(n)).some(n=>t.getHasErrorFromNode(n.id))}),Se=e=>{var o,d;const t=a.getTree(e).getUserContext();if(t==null)return null;const{message:s}=t,n=((o=s.metadata)==null?void 0:o.shared_conversation_id)??null;if(((d=s.metadata)==null?void 0:d.user_context_message_data)!=null){const{about_user_message:l,about_model_message:c}=s.metadata.user_context_message_data;return{aboutUserMessage:(l==null?void 0:l.trim())??"",aboutModelMessage:(c==null?void 0:c.trim())??"",fallback:null,shareId:n}}return{aboutUserMessage:null,aboutModelMessage:null,fallback:E(s),shareId:n}},Le=e=>i(r=>{var s,n;const t=a.resolveThreadId(e);return(n=(s=r.threads[t])==null?void 0:s.sharedConversationMetadata)==null?void 0:n.hasUserEditableContextFlag}),dr=e=>!!a.getTree(e).findNode(t=>t.message.content.content_type==="model_editable_context"),ur=e=>{const r=Le(e);return Se(e)!=null||!!r},ir=e=>i(()=>{var t;const r=a.resolveThreadId(e);return((t=u().threads[r])==null?void 0:t.continuingFromSharedConversationId)!=null}),lr=e=>i(()=>a.getThreadCurrentLeafId(e)==="root"),cr=e=>{const r=X(),t=pe(e);return t?r.query.convId&&r.query.convId===t?!0:Y(r.query.default)?r.query.default[0]==="c"&&r.query.default[1]===t:!1:!1},hr=e=>i(()=>{var t;const r=a.resolveThreadId(e);return(t=u().threads[r])==null?void 0:t.promptGptRating}),Tr=(e,r)=>i(()=>{const t=a.resolveThreadId(e),n=a.getTree(t).getBranchFromLeaf(r);return ue(n,o=>o.message.author.role===f.System&&o.message.content.content_type==="system_content")}),gr=()=>m.useContext($)!=null;function mr(e){var n;const r=a.getTree(e),t=a.getThreadCurrentLeafId(e);let s=r.getNodeByIdOrMessageId(t);for(;s;){const o=(n=s.message.metadata)==null?void 0:n.default_model_slug;if(o)return o;if(s.parentId)s=r.getNodeByIdOrMessageId(s.parentId);else return}}function vr({clientThreadId:e,role:r}){return a.getTree(e).countMessagesByAuthor(r)}function Ir({clientThreadId:e,conversationLeafId:r}){const t=a.getTree(e);return m.useMemo(()=>t.getNodeByIdOrMessageId(r).message.end_turn,[r,t])}function ye(e,r){const t=h.getTurnContentReferences(e,r);return U(t)}function fr(e,r){const t=ye(e,r),s=h.getTurnImageSearchResults(e,r);return oe(t.concat(s),"content_url")}const pr=e=>i(()=>{var t;const r=a.resolveThreadId(e);return(t=u().threads[r])==null?void 0:t.async_status});function Cr(e,r){const t=h.getTurnContentReferences(e,r);return he(t)}const Me=e=>{var r;return((r=e==null?void 0:e.metadata)==null?void 0:r.image_results)??[]},be=e=>{var r;return((r=e==null?void 0:e.metadata)==null?void 0:r.search_result_groups)??[]};export{vr as $,He as A,Te as B,Cr as C,Ve as D,fe as E,cr as F,Ee as G,je as H,mr as I,hr as J,pr as K,tr as L,sr as M,ir as N,Me as O,ar as P,Tr as Q,We as R,Ke as S,a as T,or as U,Je as V,er as W,Ge as X,Ae as Y,Xe as Z,Ze as _,$e as a,De as a0,Pe as a1,ge as a2,Ye as b,lr as c,pe as d,Ce as e,Oe as f,h as g,Qe as h,y as i,Ir as j,ke as k,gr as l,ze as m,fr as n,ce as o,Fe as p,Ue as q,qe as r,ur as s,dr as t,_e as u,rr as v,i as w,nr as x,Re as y,Be as z};
//# sourceMappingURL=n1qrfihyqo1d937u.js.map
