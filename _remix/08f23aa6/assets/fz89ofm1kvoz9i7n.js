const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/brcyt0u3f2aodae8.js","assets/b65sqkpu1lod5t78.js","assets/ots1p6z6znnn3lu2.js","assets/root-ef8koap5.css","assets/eoos0x1mpq4487h3.js","assets/dmqais3mye801yz3.js","assets/conversation-small-eplmind9.css","assets/d7sgqxgi7cg85598.js","assets/cq8ui2bpwy76kbmo.js","assets/dm0ug3mcylyorf44.js","assets/nm04jgpfyxi6pn12.js","assets/jpo2cnjd92gl9vvx.js","assets/2x8i0j2b2e66c1mk.js","assets/shared-mk6ngktc.css","assets/5baa5t1enqvyof0u.js","assets/fmy4uepzc70n43lv.js","assets/gg8shxiw7bkrbr4v.js","assets/lbu4wpp3xetrypiv.js","assets/j00afxeh5q0igmcv.js","assets/kklzvx3pwi629kd8.js","assets/oy1o3ig4kl7r18fs.js","assets/cxi4hqngdq01js8d.js","assets/75hnbbcq7b0dfv3g.js","assets/ile032nokkqccent.js","assets/khcg11qkqsg0nh3q.js","assets/cba5x0coealgpaju.js","assets/jhk6mro9d976t6v4.js","assets/fuy11abfei7df4k9.js","assets/ecqh2if7x9b6oxn0.js","assets/i6to929fcwkp8cps.js","assets/sso-ovy7jl8cchqxgm0e.js","assets/ea69sd011ns6rigx.js","assets/esok1yp8f6h2plid.js","assets/kl7x87g3zapbje3f.js","assets/dc18wqxrfnf0a74e.js","assets/b87gbvrq6zyziajh.js","assets/jdo9ohe9hut7yg42.js","assets/c9cqi9rxu1rtnem7.js","assets/f3rwhc53ideclmto.js","assets/nwyaffreisttxffi.js","assets/eomyx1bquud3c771.js","assets/g90qad0ptjsfrxhb.js","assets/kqwdyvkaaavvn8k3.js","assets/ort45y6flx9hto2v.js","assets/gi7pvnanqx2xdyso.js","assets/jugn925k41qciomw.js","assets/kulhfkxrwhc8v8oa.js","assets/hfnuq9h3vueg2cwp.js","assets/it6aamhmwcip81nf.js","assets/cx41000dnte7ilbz.js","assets/olih6emy8dm9b16e.js","assets/j1nxn3fbqdhm3z4e.js","assets/k931637jidhw5a5y.js","assets/gy1jkjzml4gshw9v.js","assets/o4idulhuy1vxbn3m.js","assets/eu1xjw9p2f50rqwt.js","assets/nhwwej1nq0zrd7sc.js","assets/b1cw8unqhvkbgk4w.js","assets/d55fgedxm425d37g.js","assets/j17mado4pa3lky8r.js","assets/isjdmfmhzv09v01t.js","assets/abg2f8pxxbjfvgsi.js","assets/bpq8fja9wushm0px.js","assets/oke2l9i2rbbr8mws.js","assets/bge90s3zu2fe2qyq.js","assets/gs87ylyrrjko8s36.js","assets/gz86kmuuui1fwcry.js","assets/bd67sjx56fd11gdi.js","assets/ouhgf1ott2kgv0yw.js","assets/kkxuedllkmrgus1f.js","assets/iej0cupg2dqkmejt.js","assets/nt7c0uhm4o8f9yos.js","assets/jk8w36bsokizpx57.js","assets/m3shrxlhsarszdml.js","assets/e98ot0ikq58akz86.js","assets/b5ggukjk2ig3qxu2.js","assets/fnogt1gveth91z90.js","assets/hbnfzx1fj5cqvcp2.js","assets/iavrpo98tq0dwcjo.js","assets/h74l2srkz453snww.js","assets/cwh2h00ipwfj18sn.js","assets/jdmarjnv45uhu8or.js","assets/o65skkxrwtoryvsg.js","assets/b7gigfq2uco7a9lw.js","assets/carousel-bss5aguy.css","assets/sso-gptav824.css","assets/l1bg52nte9ozt9as.js","assets/e7jdhn4gug2aacgl.js","assets/gio1uwfx67lom79t.js","assets/7wkl3mzfbsfa0c3f.js","assets/obl1hm4xh7etlk7b.js","assets/ezdb0imi34ta45ou.js","assets/g9noj4wa29t5v66p.js","assets/d50j2m307tremecp.js","assets/htei2cu3w3uaur2x.js","assets/dk3m1xrwzvnnsuv9.js","assets/xva3bj8p5q2n7568.js"])))=>i.map(i=>d[i]);
var Vo=Object.defineProperty;var Wo=(t,e,s)=>e in t?Vo(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var B=(t,e,s)=>Wo(t,typeof e!="symbol"?e+"":e,s);import{R as Ye,a4 as Pe,bX as $e,g4 as _s,cV as $o,P as O,A as E,bQ as Ce,g5 as sa,fh as na,ak as qe,O as Ae,j as a,r as u,K as z,bz as _n,H as le,e4 as Ko,c as U,bO as Zo,fK as Yo,B as wt,aU as Jo,bt as kt,bv as aa,g6 as oa,fE as vs,x as ia,a5 as Qo,L as yt,N as Me,as as Qt,fz as Xo,fQ as ra,aN as Rs,y as vn,u as ca,bT as la,c2 as de,bV as ei,J as _t,en as ti,cN as be,g7 as Es,bH as da,a7 as Wt,b_ as $t,bZ as ke,U as si,V as ni,W as ai,Q as oi,ax as ii,dc as ri,g8 as As,cJ as ci,bD as Xt,X as ua,a_ as li,fb as qt,dG as di,fM as ma,eG as Sn,aM as fa,cs as ui,eF as mi,fc as fi,c$ as ha,d0 as Kt,d1 as Ss,et as hi,g9 as gi,aC as bn,ga as pi,fI as xi,e8 as Ze,fo as ga,f2 as pa,E as xa,fB as vt,e5 as yi,aQ as _i,cm as me,cK as vi,gb as Si,gc as bi,w as wi,cz as ya,d9 as Ns,c0 as Ps,c8 as es,aO as ki,aP as Ci,cn as Ii,br as He,fC as Ti,gd as ji,ge as Mi,gf as Ri,gg as Ei,gh as _a,ag as Ai,a2 as wn,gi as Ni,gj as kn,gk as Cn,gl as Pi,gm as Di}from"./b65sqkpu1lod5t78.js";import{i_ as Fi,i$ as ye,j0 as Oi,j1 as Vt,j2 as Ft,j3 as Li,j4 as va,a7 as Bi,dO as zi,bM as ts,aC as ss,eB as Ui,gu as Sa,eC as Ds,j5 as Gi,cQ as ns,n as Fs,j6 as Hi,j7 as ba,b3 as Zt,eE as Ne,bU as Os,j8 as Fe,u as Ls,A as ct,cs as qi,cv as Vi,b6 as Wi,aY as $i,aM as Ki,cr as Zi,hW as Yi,ia as Ji,j9 as Qi,i7 as St,ja as he,jb as wa,jc as bs,fM as Xi,jd as er,je as tr,jf as sr,jg as nr,b5 as ka,jh as ar,hP as Ca,ap as Ia,ji as or,eN as ir,ca as as,iV as rr,e6 as Ta,aa as cr,jj as lr,il as dr,jk as ja,eG as os,iZ as bt,jl as Ke,iR as et,jm as fs,jn as ur,a3 as mr,jo as In,jp as Ma,jq as Yt,jr as Bs,js as zs,jt as Ra,ju as Ea,e1 as Aa,iT as Na,d$ as Pa,e0 as Da,jv as fr,jw as hr,ix as Us,jx as gr,jy as Fa,iy as Gs,jz as Hs,jA as Ot,jB as pr,jC as xr,jD as yr,hT as Jt,G as Oa,jE as _r,jF as vr,jG as Sr,cC as br,hB as wr,hA as La,eP as kr,hz as Cr,jH as Ba,jI as Ir,hv as ws,dV as it,cl as Tr,cj as jr,jJ as Mr,jK as Rr,eH as Er,jL as Ar,jM as Nr,B as Pr,ak as za,jN as Dr,jO as Tn,r as ks,i8 as Fr,jP as Or,a8 as Lr,Y as jn,av as Ua,jQ as Br,jR as zr,jS as Ur,jT as Gr,jU as Hr,cO as Ga,e2 as qr,g9 as Vr,ew as Mn,jV as Wr,jW as $r,jX as Kr,p as Zr,hM as Yr,hq as Cs,hr as Jr,jY as Qr,g6 as qs,jZ as Xr,cP as ec,aq as Rn,j_ as tc,ao as N,j$ as sc,k0 as nc,k1 as ac,id as oc,ie as ic,hX as rc,hQ as cc,gp as lc,hj as Lt,k2 as hs,k3 as dc,hh as uc,hm as mc,hn as Vs,k4 as fc,k5 as hc,C as gc,k6 as xt,k7 as pc,k8 as xc,k9 as yc,ka as _c,kb as vc,gZ as Ha,e3 as Sc,E as bc,bL as wc,kc,cp as Cc,kd as Ic,ke as Tc,x as jc,kf as Mc,kg as Rc,cw as Ec,kh as Is,Z as qa,ki as Ac,kj as Nc,kk as Pc,kl as Dc,km as En,kn as Fc}from"./dmqais3mye801yz3.js";import{q as Ws,d as Oe,T as C,H as Va,Y as Oc,b as is,f as Wa,w as lt,u as dt,e as Lc,c as $a,g as Bc,Q as zc,k as Uc,Z as Gc,_ as Hc,A as qc,h as Vc,$ as Wc,a0 as $c,i as Ka,a1 as Kc}from"./5baa5t1enqvyof0u.js";import{a4 as Za,bA as Zc,ab as Ya,c0 as Yc,R as Jc,bi as Qc,c1 as Xc,Z as $s,af as el,c2 as tl,aI as sl,bS as Ja,ah as nl,z as al,a3 as ol}from"./ots1p6z6znnn3lu2.js";import{d as Ks,U as il,h as rl,J as Qa,V as cl,H as ll,u as dl,W as ul,X as ml,Y as fl,Z as hl,y as gl}from"./lbu4wpp3xetrypiv.js";import{a as pl}from"./j00afxeh5q0igmcv.js";import{m as ge}from"./d7sgqxgi7cg85598.js";import{u as xl,P as yl,I as _l}from"./kklzvx3pwi629kd8.js";import{D as X}from"./2x8i0j2b2e66c1mk.js";import{r as Xa,e as vl,f as Sl}from"./cxi4hqngdq01js8d.js";import{t as bl,i as eo,f as wl,h as to,u as so,T as kl,M as Cl,a as Il,j as Tl}from"./khcg11qkqsg0nh3q.js";import{G as jl}from"./oy1o3ig4kl7r18fs.js";import{L as Ml,G as Rl,O as El,Q as Al,U as Bt,V as Nl,X as Pl,W as Dl,F as Ct,I as no,Y as Fl}from"./cba5x0coealgpaju.js";import{a as Zs}from"./fuy11abfei7df4k9.js";import{i as ao,a as Ol,g as Ll,b as Bl,c as zl}from"./gg8shxiw7bkrbr4v.js";import{s as Ul}from"./ile032nokkqccent.js";import{g as An}from"./ecqh2if7x9b6oxn0.js";import{r as Gl}from"./i6to929fcwkp8cps.js";var oo=Gl();function Hl(t){if(typeof t!="string")throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!t)throw new Error("No input");const e=JSON.parse(t),s=e;let n;if(s.type==="system")if(s.event==="connected")n=Object.assign(Object.assign({},e),{kind:"connected"});else if(s.event==="disconnected")n=Object.assign(Object.assign({},e),{kind:"disconnected"});else return null;else if(s.type==="message")if(s.from==="group"){const o=Pn(e.data,e.dataType);if(o===null)return null;n=Object.assign(Object.assign({},e),{data:o,kind:"groupData"})}else if(s.from==="server"){const o=Pn(e.data,e.dataType);if(o===null)return null;n=Object.assign(Object.assign({},e),{data:o,kind:"serverData"})}else return null;else if(s.type==="ack")n=Object.assign(Object.assign({},e),{kind:"ack"});else return null;return n}function ql(t){let e;switch(t.kind){case"joinGroup":{e={type:"joinGroup",group:t.group,ackId:t.ackId};break}case"leaveGroup":{e={type:"leaveGroup",group:t.group,ackId:t.ackId};break}case"sendEvent":{e={type:"event",event:t.event,ackId:t.ackId,dataType:t.dataType,data:Nn(t.data,t.dataType)};break}case"sendToGroup":{e={type:"sendToGroup",group:t.group,ackId:t.ackId,dataType:t.dataType,data:Nn(t.data,t.dataType),noEcho:t.noEcho};break}case"sequenceAck":{e={type:"sequenceAck",sequenceId:t.sequenceId};break}default:throw new Error(`Unsupported type: ${t.kind}`)}return JSON.stringify(e)}function Nn(t,e){switch(e){case"text":{if(typeof t!="string")throw new TypeError("Message must be a string.");return t}case"json":return t;case"binary":case"protobuf":{if(t instanceof ArrayBuffer)return oo.Buffer.from(t).toString("base64");throw new TypeError("Message must be a ArrayBuffer")}}}function Pn(t,e){if(e==="text"){if(typeof t!="string")throw new TypeError("Message must be a string when dataType is text");return t}else{if(e==="json")return t;if(e==="binary"||e==="protobuf"){const s=oo.Buffer.from(t,"base64");return s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength)}else return null}}class Vl{constructor(){this.isReliableSubProtocol=!0,this.name="json.reliable.webpubsub.azure.v1"}parseMessages(e){return Hl(e)}writeMessage(e){return ql(e)}}const Wl=()=>new Vl;var we;(function(t){t.Stopped="Stopped",t.Disconnected="Disconnected",t.Connecting="Connecting",t.Connected="Connected",t.Recovering="Recovering"})(we||(we={}));class $l{nextAckId(){return this._ackId=this._ackId+1,this._ackId}constructor(e,s){this._quickSequenceAckDiff=300,this._activeTimeoutInMs=2e4,this._emitter=new Fi,this._isStopping=!1,this._isInitialConnected=!1,typeof e=="string"?this._credential={getClientAccessUrl:e}:this._credential=e,s==null&&(s={}),this._buildDefaultOptions(s),this._options=s,this._messageRetryPolicy=new Dn(this._options.messageRetryOptions),this._reconnectRetryPolicy=new Dn(this._options.reconnectRetryOptions),this._protocol=this._options.protocol,this._groupMap=new Map,this._ackMap=new Map,this._sequenceId=new Yl,this._state=we.Stopped,this._ackId=0}async start(e){if(this._isStopping)throw new Error("Can't start a client during stopping");if(this._state!==we.Stopped)throw new Error("Client can be only started when it's Stopped");let s;e&&(s=e.abortSignal),this._activeKeepaliveTask||(this._activeKeepaliveTask=this._getActiveKeepaliveTask());try{await this._startCore(s)}catch(n){throw this._changeState(we.Stopped),this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0),this._isStopping=!1,n}}async _startFromRestarting(e){if(this._state!==we.Disconnected)throw new Error("Client can be only restarted when it's Disconnected");try{ye.verbose("Staring reconnecting."),await this._startCore(e)}catch(s){throw this._changeState(we.Disconnected),s}}async _startCore(e){if(this._changeState(we.Connecting),ye.info("Staring a new connection"),this._sequenceId.reset(),this._isInitialConnected=!1,this._lastCloseEvent=void 0,this._lastDisconnectedMessage=void 0,this._connectionId=void 0,this._reconnectionToken=void 0,this._uri=void 0,typeof this._credential.getClientAccessUrl=="string"?this._uri=this._credential.getClientAccessUrl:this._uri=await this._credential.getClientAccessUrl({abortSignal:e}),typeof this._uri!="string")throw new Error(`The clientAccessUrl must be a string but currently it's ${typeof this._uri}`);await this._connectCore(this._uri)}stop(){this._state===we.Stopped||this._isStopping||(this._isStopping=!0,this._wsClient&&this._wsClient.isOpen()?this._wsClient.close():this._isStopping=!1,this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0))}on(e,s){this._emitter.on(e,s)}off(e,s){this._emitter.removeListener(e,s)}_emitEvent(e,s){this._emitter.emit(e,s)}async sendEvent(e,s,n,o){return await this._operationExecuteWithRetry(()=>this._sendEventAttempt(e,s,n,o),o==null?void 0:o.abortSignal)}async _sendEventAttempt(e,s,n,o){var i;if(!((i=o==null?void 0:o.fireAndForget)!==null&&i!==void 0?i:!1))return await this._sendMessageWithAckId(l=>({kind:"sendEvent",dataType:n,data:s,ackId:l,event:e}),o==null?void 0:o.ackId,o==null?void 0:o.abortSignal);const c={kind:"sendEvent",dataType:n,data:s,event:e};return await this._sendMessage(c,o==null?void 0:o.abortSignal),{isDuplicated:!1}}async joinGroup(e,s){return await this._operationExecuteWithRetry(()=>this._joinGroupAttempt(e,s),s==null?void 0:s.abortSignal)}async _joinGroupAttempt(e,s){const n=this._getOrAddGroup(e),o=await this._joinGroupCore(e,s);return n.isJoined=!0,o}async _joinGroupCore(e,s){return await this._sendMessageWithAckId(n=>({group:e,ackId:n,kind:"joinGroup"}),s==null?void 0:s.ackId,s==null?void 0:s.abortSignal)}async leaveGroup(e,s){return await this._operationExecuteWithRetry(()=>this._leaveGroupAttempt(e,s),s==null?void 0:s.abortSignal)}async _leaveGroupAttempt(e,s){const n=this._getOrAddGroup(e),o=await this._sendMessageWithAckId(i=>({group:e,ackId:i,kind:"leaveGroup"}),s==null?void 0:s.ackId,s==null?void 0:s.abortSignal);return n.isJoined=!1,o}async sendToGroup(e,s,n,o){return await this._operationExecuteWithRetry(()=>this._sendToGroupAttempt(e,s,n,o),o==null?void 0:o.abortSignal)}async _sendToGroupAttempt(e,s,n,o){var i,r;const c=(i=o==null?void 0:o.fireAndForget)!==null&&i!==void 0?i:!1,l=(r=o==null?void 0:o.noEcho)!==null&&r!==void 0?r:!1;if(!c)return await this._sendMessageWithAckId(f=>({kind:"sendToGroup",group:e,dataType:n,data:s,ackId:f,noEcho:l}),o==null?void 0:o.ackId,o==null?void 0:o.abortSignal);const m={kind:"sendToGroup",group:e,dataType:n,data:s,noEcho:l};return await this._sendMessage(m,o==null?void 0:o.abortSignal),{isDuplicated:!1}}_getWebSocketClientFactory(){return new Oi}async _trySendSequenceAck(){if(!this._protocol.isReliableSubProtocol)return;const[e,s]=this._sequenceId.tryGetSequenceId();if(e&&s){const n={kind:"sequenceAck",sequenceId:s};try{await this._sendMessage(n)}catch{this._sequenceId.tryUpdate(s)}}}_connectCore(e){if(this._isStopping)throw new Error("Can't start a client during stopping");return new Promise((s,n)=>{const o=this._wsClient=this._getWebSocketClientFactory().create(e,this._protocol.name);o.onopen(()=>{if(this._isStopping){try{o.close()}catch{}n(new Error("The client is stopped"))}ye.verbose("WebSocket connection has opened"),this._changeState(we.Connected),this._protocol.isReliableSubProtocol&&(this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),this._sequenceAckTask=new Fn(async()=>{await this._trySendSequenceAck()},1e3)),s()}),o.onerror(i=>{this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),n(i)}),o.onclose((i,r)=>{this._state===we.Connected?(ye.verbose("WebSocket closed after open"),this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),ye.info(`WebSocket connection closed. Code: ${i}, Reason: ${r}`),this._lastCloseEvent={code:i,reason:r},this._handleConnectionClose.call(this)):(ye.verbose("WebSocket closed before open"),n(new Error(`Failed to start WebSocket: ${i}`)))}),o.onmessage(i=>{const r=d=>{if(this._ackMap.has(d.ackId)){const v=this._ackMap.get(d.ackId);this._ackMap.delete(d.ackId);const p=d.error!=null&&d.error.name==="Duplicate";d.success||p?v.resolve({ackId:d.ackId,isDuplicated:p}):v.reject(new Ft("Failed to send message.",{ackId:d.ackId,errorDetail:d.error}))}},c=async d=>{if(this._connectionId=d.connectionId,this._reconnectionToken=d.reconnectionToken,!this._isInitialConnected){if(this._isInitialConnected=!0,this._options.autoRejoinGroups){const v=[];this._groupMap.forEach(p=>{p.isJoined&&v.push((async()=>{try{await this._joinGroupCore(p.name)}catch(h){this._safeEmitRejoinGroupFailed(p.name,h)}})())});try{await Promise.all(v)}catch{}}this._safeEmitConnected(d.connectionId,d.userId)}},l=d=>{this._lastDisconnectedMessage=d},m=d=>{if(d.sequenceId!=null){const v=this._sequenceId.tryUpdate(d.sequenceId);if(v===0)return;v>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitGroupMessage(d)},f=d=>{if(d.sequenceId!=null){const v=this._sequenceId.tryUpdate(d.sequenceId);if(v===0)return;v>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitServerMessage(d)};let g;try{let d;if(Array.isArray(i)?d=Buffer.concat(i):d=i,g=this._protocol.parseMessages(d),g===null)return}catch(d){throw ye.warning("An error occurred while parsing the message from service",d),d}Array.isArray(g)||(g=[g]),g.forEach(d=>{try{switch(d.kind){case"ack":{r(d);break}case"connected":{c(d);break}case"disconnected":{l(d);break}case"groupData":{m(d);break}case"serverData":{f(d);break}}}catch(v){ye.warning(`An error occurred while handling the message with kind: ${d.kind} from service`,v)}})})})}async _handleConnectionCloseAndNoRecovery(){this._state=we.Disconnected,this._safeEmitDisconnected(this._connectionId,this._lastDisconnectedMessage),this._options.autoReconnect?await this._autoReconnect():await this._handleConnectionStopped()}async _autoReconnect(){let e=!1,s=0;try{for(;!this._isStopping;)try{await this._startFromRestarting(),e=!0;break}catch(n){ye.warning("An attempt to reconnect connection failed.",n),s++;const o=this._reconnectRetryPolicy.nextRetryDelayInMs(s);if(o==null)break;try{ye.verbose(`Delay time for reconnect attempt ${s}: ${o}`),await Vt(o)}catch{}}}finally{e||this._handleConnectionStopped()}}_handleConnectionStopped(){this._isStopping=!1,this._state=we.Stopped,this._safeEmitStopped()}_getActiveKeepaliveTask(){return new Fn(async()=>{this._sequenceId.tryUpdate(0)},this._activeTimeoutInMs)}async _sendMessage(e,s){if(!this._wsClient||!this._wsClient.isOpen())throw new Error("The connection is not connected.");const n=this._protocol.writeMessage(e);await this._wsClient.send(n,s)}async _sendMessageWithAckId(e,s,n){s==null&&(s=this.nextAckId());const o=e(s);this._ackMap.has(s)||this._ackMap.set(s,new Zl(s));const i=this._ackMap.get(s);try{await this._sendMessage(o,n)}catch(r){this._ackMap.delete(s);let c="";throw r instanceof Error&&(c=r.message),new Ft(c,{ackId:s})}if(n)try{return await Li(i.promise(),n)}catch(r){throw r instanceof Error&&r.name==="AbortError"?new Ft("Cancelled by abortSignal",{ackId:s}):r}return await i.promise()}async _handleConnectionClose(){if(this._ackMap.forEach((o,i)=>{this._ackMap.delete(i)&&o.reject(new Ft("Connection is disconnected before receive ack from the service",{ackId:o.ackId}))}),this._isStopping){ye.warning("The client is stopping state. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(this._lastCloseEvent&&this._lastCloseEvent.code===1008){ye.warning("The websocket close with status code 1008. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(!this._protocol.isReliableSubProtocol){ye.warning("The protocol is not reliable, recovery is not applicable"),this._handleConnectionCloseAndNoRecovery();return}const e=this._buildRecoveryUri();if(!e){ye.warning("Connection id or reconnection token is not available"),this._handleConnectionCloseAndNoRecovery();return}let s=!1;this._state=we.Recovering;const n=va.timeout(30*1e3);try{for(;!n.aborted||this._isStopping;)try{await this._connectCore.call(this,e),s=!0;return}catch{await Vt(1e3)}}finally{s||(ye.warning("Recovery attempts failed more then 30 seconds or the client is stopping"),this._handleConnectionCloseAndNoRecovery())}}_safeEmitConnected(e,s){this._emitEvent("connected",{connectionId:e,userId:s})}_safeEmitDisconnected(e,s){this._emitEvent("disconnected",{connectionId:e,message:s})}_safeEmitGroupMessage(e){this._emitEvent("group-message",{message:e})}_safeEmitServerMessage(e){this._emitEvent("server-message",{message:e})}_safeEmitStopped(){this._emitEvent("stopped",{})}_safeEmitRejoinGroupFailed(e,s){this._emitEvent("rejoin-group-failed",{group:e,error:s})}_buildDefaultOptions(e){return e.autoReconnect==null&&(e.autoReconnect=!0),e.autoRejoinGroups==null&&(e.autoRejoinGroups=!0),e.protocol==null&&(e.protocol=Wl()),this._buildMessageRetryOptions(e),this._buildReconnectRetryOptions(e),e}_buildMessageRetryOptions(e){e.messageRetryOptions||(e.messageRetryOptions={}),(e.messageRetryOptions.maxRetries==null||e.messageRetryOptions.maxRetries<0)&&(e.messageRetryOptions.maxRetries=3),(e.messageRetryOptions.retryDelayInMs==null||e.messageRetryOptions.retryDelayInMs<0)&&(e.messageRetryOptions.retryDelayInMs=1e3),(e.messageRetryOptions.maxRetryDelayInMs==null||e.messageRetryOptions.maxRetryDelayInMs<0)&&(e.messageRetryOptions.maxRetryDelayInMs=3e4),e.messageRetryOptions.mode==null&&(e.messageRetryOptions.mode="Fixed")}_buildReconnectRetryOptions(e){e.reconnectRetryOptions||(e.reconnectRetryOptions={}),(e.reconnectRetryOptions.maxRetries==null||e.reconnectRetryOptions.maxRetries<0)&&(e.reconnectRetryOptions.maxRetries=Number.MAX_VALUE),(e.reconnectRetryOptions.retryDelayInMs==null||e.reconnectRetryOptions.retryDelayInMs<0)&&(e.reconnectRetryOptions.retryDelayInMs=1e3),(e.reconnectRetryOptions.maxRetryDelayInMs==null||e.reconnectRetryOptions.maxRetryDelayInMs<0)&&(e.reconnectRetryOptions.maxRetryDelayInMs=3e4),e.reconnectRetryOptions.mode==null&&(e.reconnectRetryOptions.mode="Fixed")}_buildRecoveryUri(){if(this._connectionId&&this._reconnectionToken&&this._uri){const e=new URL(this._uri);return e.searchParams.append("awps_connection_id",this._connectionId),e.searchParams.append("awps_reconnection_token",this._reconnectionToken),e.toString()}return null}_getOrAddGroup(e){return this._groupMap.has(e)||this._groupMap.set(e,new Kl(e)),this._groupMap.get(e)}_changeState(e){ye.verbose(`The client state transfer from ${this._state.toString()} to ${e.toString()}`),this._state=e}async _operationExecuteWithRetry(e,s){let n=0;for(;;)try{return await e.call(this)}catch(o){n++;const i=this._messageRetryPolicy.nextRetryDelayInMs(n);if(i==null||(await Vt(i),s!=null&&s.aborted))throw o}}}class Dn{constructor(e){this._retryOptions=e,this._maxRetriesToGetMaxDelay=Math.ceil(Math.log2(this._retryOptions.maxRetryDelayInMs)-Math.log2(this._retryOptions.retryDelayInMs)+1)}nextRetryDelayInMs(e){return e>this._retryOptions.maxRetries?null:this._retryOptions.mode==="Fixed"?this._retryOptions.retryDelayInMs:this._calculateExponentialDelay(e)}_calculateExponentialDelay(e){return e>=this._maxRetriesToGetMaxDelay?this._retryOptions.maxRetryDelayInMs:(1<<e-1)*this._retryOptions.retryDelayInMs}}class Kl{constructor(e){this.isJoined=!1,this.name=e}}class Zl{constructor(e){this._promise=new Promise((s,n)=>{this._resolve=s,this._reject=n}),this.ackId=e}promise(){return this._promise}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}class Yl{constructor(){this._sequenceId=0,this._isUpdate=!1}tryUpdate(e){if(this._isUpdate=!0,e>this._sequenceId){const s=e-this._sequenceId;return this._sequenceId=e,s}return 0}tryGetSequenceId(){return this._isUpdate?(this._isUpdate=!1,[!0,this._sequenceId]):[!1,null]}reset(){this._sequenceId=0,this._isUpdate=!1}}class Fn{constructor(e,s,n){this._func=e,this._abortController=new va,this._interval=s,this._obj=n,this._start()}abort(){try{this._abortController.abort()}catch{}}async _start(){const e=this._abortController.signal;for(;!e.aborted;)try{await this._func(this._obj)}catch{}finally{await Vt(this._interval)}}}const Jl=1e3*60*60,Ql=1e3*30;class Xl{constructor(e,s,n,o=null,i=new Map){B(this,"client");B(this,"handler");B(this,"terminationTimeout",null);B(this,"connectionUrl");B(this,"expiresAt");B(this,"connected",!1);B(this,"websocketRequestId",null);B(this,"conversationId",null);B(this,"secondaryTypeBasedHandlers",new Map);this.connectionUrl=s,this.expiresAt=n,this.client=new $l({getClientAccessUrl:()=>e(this.connectionUrl,this.expiresAt)},{autoReconnect:!0,reconnectRetryOptions:{maxRetries:5,retryDelayInMs:100,maxRetryDelayInMs:1e4,mode:"Exponential"}}),this.handler=o,this.secondaryTypeBasedHandlers=i}async start(){const e=s=>{if(this.secondaryTypeBasedHandlers.has(s.message.data.type)){const n=this.secondaryTypeBasedHandlers.get(s.message.data.type);if(!n)return;n(s.message.data)}else{const n=s.message.data.body,o=atob(n).trim();if(o.startsWith("data: ")){const i=o.replace("data: ",""),r=this.handler;if(!r)return;r({conversationId:s.message.data.conversation_id,responseId:s.message.data.response_id,message:{id:"",event:"",data:i},websocketRequestId:s.message.data.websocket_request_id})}}};this.client.on("group-message",s=>e(s)),this.client.on("server-message",s=>e(s)),this.client.on("connected",()=>{this.connected=!0}),this.client.on("disconnected",()=>{this.connected=!1}),await this.client.start()}addSecondaryTypeHandler(e,s){this.secondaryTypeBasedHandlers.set(e,s)}isConnected(){return this.connected}async stop(e){e&&this.conversationId!==e||this.websocketRequestId&&await Ye.stopWebsocketConversation(this.websocketRequestId)}setHandler(e,s,n,o){!this.handler&&this.websocketRequestId===n||(this.handler!=null&&this.websocketRequestId!==n&&($o.warn("[websockets] Overwriting existing handler without silencing. This may indicate a race condition."),O.logEvent(E.asyncHandlerOverwritten,{originalWebsocketRequestId:this.websocketRequestId,newWebsocketRequestId:n,conversationId:e,responseId:s})),this.websocketRequestId=n,this.conversationId=e,this.handler=i=>{(i.websocketRequestId===n||i.conversationId===e&&i.responseId===s)&&o(i.message)})}silence(){this.handler=null}close(){this.client.stop()}scheduleForTermination(e){this.terminationTimeout=setTimeout(()=>{this.close(),e()},Jl)}preventTermination(){this.terminationTimeout&&(clearTimeout(this.terminationTimeout),this.terminationTimeout=null)}updateConnectionUrl(e,s){this.connectionUrl=e,this.expiresAt=s}}class ed{constructor(){B(this,"activeSocketMap",new Map);B(this,"secondaryTypeBasedHandlers",new Map)}async register(){const e=await Ye.postRegisterWebsocket();e.wss_url&&(this.getOrCreateSocket(e.wss_url,new Date(e.expires_at),!0),e.fallback_wss_url&&this.getOrCreateSocket(e.fallback_wss_url,new Date(e.expires_at),!1))}async registerIfNotConnected(){if(this.activeSocketMap.size===0){await this.register();return}for(const e of this.activeSocketMap.values())if(!e.isConnected()){await this.register();return}}isWebsocketConnected(){for(const e of this.activeSocketMap.values())if(e.isConnected())return!0;return this.activeSocketMap.size>0&&Pe.addError("Cannot connect to any websocket."),!1}async getOrCreateSocket(e,s,n){const o=e.split("?")[0];let i;const r=this.activeSocketMap.get(o);if(r&&r.isConnected())r.preventTermination(),r.updateConnectionUrl(e,s),i=r;else{r&&r.close(),i=new Xl(async(c,l)=>{if(new Date<new Date(l.getTime()-5*1e3))return c;const m=await Ye.postRegisterWebsocket();return n?m.wss_url:m.fallback_wss_url??""},e,s,null,this.secondaryTypeBasedHandlers),this.activeSocketMap.set(o,i);try{await i.start()}catch(c){throw Pe.addError(new Error("Error occurred while starting websocket: ",{cause:c})),c}}return i}preSetupWebsocket(e,s,n){for(const o of this.activeSocketMap.values())this.setupWebSocketHandler(o,null,null,null,e,s,n)}addSecondaryTypeHandler(e,s){this.secondaryTypeBasedHandlers.set(e,s);for(const n of this.activeSocketMap.values())n.addSecondaryTypeHandler(e,s)}hasSecondaryTypeHandler(e){return this.secondaryTypeBasedHandlers.has(e)}async processWebSocketConversationStream(e,s,n,o,i,r,c,l,m){const f=[this.getOrCreateSocket(e,n,!0)];s&&f.push(this.getOrCreateSocket(s,n,!1));const g=await Promise.allSettled(f),d=g[0].status==="fulfilled"?g[0].value:null,v=g.length>1&&g[1].status==="fulfilled"?g[1].value:null;if((!d||!d.isConnected())&&Pe.addError(`Cannot connect to primary websocket, websocketRequestId: ${r}, token: ${e.substring(0,e.indexOf("access_token="))}`),(!d||!d.isConnected())&&(!v||!v.isConnected()))throw s&&Pe.addError(`Cannot connect to fallback websocket, websocketRequestId: ${r}, token: ${s.substring(0,s.indexOf("access_token="))}`),new $e(`An error occurred while connecting to the websocket. ${_s}`);let p=setTimeout(()=>{Pe.addError(`WebSocket took too long to respond: ${i}, ${o}, ${r}, ${e.substring(0,60)}...${e.slice(-20)}`,{supportsWebSockets:"WebSocket"in window&&window.WebSocket.CLOSING===2})},Ql);const h=b=>(m&&(clearTimeout(m),m=null),p&&(clearTimeout(p),p=null),c(b));d&&this.setupWebSocketHandler(d,e,o,i,r,h,l),v&&s&&this.setupWebSocketHandler(v,s,o,i,r,h,l)}async stopConversation(e){for(const s of this.activeSocketMap.values())await s.stop(e)}setupWebSocketHandler(e,s,n,o,i,r,c){e.setHandler(n,o,i,r),this.secondaryTypeBasedHandlers.forEach((m,f)=>{e.addSecondaryTypeHandler(f,m)});const l=()=>{s?e.scheduleForTermination(()=>{this.activeSocketMap.delete(s.split("?")[0])}):(this.stopConversation(n),e.silence())};c.addEventListener("abort",l)}}const It=new ed;function td(t){return{webSocketUrl:t.wss_url,fallbackWebSocketUrl:t.fallback_wss_url,conversationId:t.conversation_id,responseId:t.response_id,expiresAt:t.expires_at&&new Date(t.expires_at),websocketRequestId:t.websocket_request_id}}async function sd(t,e,s){return It.preSetupWebsocket(t,e,s)}async function nd(t,e,s,n,o,i,r,c,l){return It.processWebSocketConversationStream(t,e,s,n,o,i,r,c,l)}function ad(t){return t==null||[Ce.PrimaryAssistant,Ce.GizmoInteraction].includes(t.kind)}function Ys(t,e){const s=Ws(t,e),{data:n}=Ks(s!=null&&"gizmo_id"in s?s.gizmo_id:void 0,(s==null?void 0:s.kind)===Ce.GizmoTest);if(s!=null)switch(s.kind){case Ce.GizmoInteraction:case Ce.GizmoMagicCreate:case Ce.GizmoTest:return{gizmo:n,...s};case Ce.PrimaryAssistant:return s}}function od(t,e,s){const o=C.getTree(e).getMessageId(C.getThreadCurrentLeafId(e));Ye.generateTitle(e,o,s).then(({title:i})=>{C.setTitle(e,i,Va.Generated),Xa(t),O.logEvent(E.renameThread,{threadId:e,content:i,model:s})}).catch(Pe.addError)}function ff(t,e,s){const n=()=>{const i=An(s);t(i)},o=Oe.getGizmoId(s);o!=null?il(e,o).then(i=>{Bi(An(s,i))}).catch(i=>{Pe.addError(i),n()}):n()}const Ts={onCreate(t,e,s,n){O.logEvent(E.newThread),!n&&ad(Oe.getConversationMode(e))&&sa(s).then(o=>{na(o)||(Xa(s),t(e))})},onCreateFinished(t,e,s){var n;if(!(s||!e)&&!qe.checkGate("2562876640")){const o=(n=Oe.getThread(e))==null?void 0:n.initialThreadData.lastModelUsed;o==null&&Pe.addError("missing lastModelUsed on conversation create finished"),od(t,e,o)}}},On=Ae.div`m-8 flex flex-col items-center`;function Ln(t){return a.jsx(ge.div,{initial:{opacity:0,translateY:20},animate:{opacity:1,translateY:0,transition:{duration:.5,ease:"easeIn"}},...t})}function id({clientThreadId:t}){const e=Oc(t),s=e==null?void 0:e.gizmoId,{data:n}=Ks(s);return s==null||n==null||!zi(n)?null:a.jsx(rd,{gizmoId:s})}function rd({gizmoId:t}){const[e,s]=u.useState(!1),[n,o]=u.useState(!1),i=rl(t),r=async l=>{s(!0),setTimeout(()=>{o(!0)},5e3),O.logEvent(E.submitInlineRating,{gizmo_id:t,rating:l}),await i.mutateAsync({rating:l})},c=async()=>{o(!0),O.logEvent(E.dismissInlineRating,{gizmo_id:t}),await i.mutateAsync({})};return u.useEffect(()=>{n||O.logEvent(E.showInlineRating,{gizmo_id:t})},[n,t]),n?null:e?a.jsx(On,{children:a.jsxs(Ln,{className:"flex flex-col items-center gap-4",children:[a.jsx("div",{className:"rounded-lg border border-token-border-heavy p-4",children:a.jsxs("div",{className:"flex justify-between gap-2",children:[a.jsx(z,{id:"gizmo.inlineReview.reviewLeft",defaultMessage:"Feedback sent"}),a.jsx(_n,{onClick:()=>{o(!0)}})]})}),a.jsx("div",{className:"text-xs text-token-text-tertiary",children:a.jsx(z,{id:"gizmo.inlineReview.reviewLeftSubtext",defaultMessage:'To update your rating, click "Send Feedback" in the GPT Menu'})})]})}):a.jsx(On,{children:a.jsxs(Ln,{className:"flex flex-col items-center gap-4 rounded-lg border border-token-border-heavy p-4",children:[a.jsxs("div",{className:"flex justify-between gap-2",children:[a.jsx(z,{id:"gizmo.inlineReview.prompt",defaultMessage:"How would you rate this GPT so far?"}),a.jsx(_n,{onClick:c})]}),a.jsx(pl,{rating:void 0,onRating:r})]})})}function cd(t,e){const s=ts(ss.MentionGPTs),n=Ui(),[o,i]=u.useState(!1),r=()=>{i(!0),s.markAsViewed()};return u.useImperativeHandle(e,()=>({handleClose:r})),s.eligible&&!s.isLoading&&!n?a.jsx(ld,{wasDismissed:o,onDismiss:r}):null}function ld({wasDismissed:t,onDismiss:e}){const s=le(),{recent:n,pinned:o}=xl(),i=n&&n.pages.flatMap(r=>r.list.items).length>0||o&&o.items.length>0;return u.useEffect(()=>{i&&O.logEvent(E.mentionsDisplayNux)},[i]),i?a.jsx(Sa,{badge:"beta",align:"start",side:"top",arrowPadding:58,show:!t,title:s.formatMessage({id:"mentionGptsAnnouncement.title",defaultMessage:"GPT mentions"}),onDismiss:e,sideOffset:25,theme:"default",description:a.jsx(z,{id:"mentionGptsAnnouncement.description",defaultMessage:"Type {key} to mention a GPT and add it directly into your conversation",values:{key:a.jsx("span",{className:"font-bold",children:"@"})}}),children:a.jsx("div",{className:"absolute sm:left-16"})}):null}const dd=u.forwardRef(cd);function ud({composerController:t}){const{doesUserHaveAnyAccountsWithPlusFeatures:e}=Ko(),s=le(),n=Ds();return a.jsxs("div",{className:U("flex justify-between",!n&&"bg-gradient-to-t from-token-main-surface-primary to-transparent px-4"),children:[a.jsx("div",{className:"flex gap-2",children:a.jsx(fd,{onClickStyle:o=>{zn(s.formatMessage(o.expandedName??o.name),t)}})}),e&&a.jsx("div",{className:"flex gap-2",children:a.jsx(md,{onClickAspectRatio:o=>zn(s.formatMessage(o.expandedName),t)})})]})}function md({onClickAspectRatio:t}){const e=le();return a.jsxs(X.Root,{onOpenChange:s=>{s&&(qe.logEvent(E.dalleOpenAspectRatioDropdown),O.logEvent(E.dalleOpenAspectRatioDropdown))},children:[a.jsxs(js,{$as:X.Trigger,className:"pr-1.5",children:[a.jsx(z,{id:"dalleControls.aspectRatio",defaultMessage:"Aspect Ratio"}),a.jsx(Za,{className:"icon-md"})]}),a.jsx(X.Portal,{children:a.jsx(X.Content,{children:Gi.map(s=>a.jsx(X.Item,{onClick:()=>{var n;t(s),qe.logEvent(E.dalleClickAspectRatio,(n=s.name.defaultMessage)==null?void 0:n.toString()),O.logEvent(E.dalleClickAspectRatio,{aspectRatio:s.name.defaultMessage})},icon:s.icon,children:e.formatMessage(s.name)},s.name.id))})})]})}function fd({onClickStyle:t}){const[e,s]=u.useState(Bn()),n=Zo(),o=Yo(),i=ns(),r=le();let c=2;return i||(o?c=5:n&&(c=3)),a.jsxs(a.Fragment,{children:[e.slice(0,c).map(l=>a.jsx(Fs,{label:a.jsx(hd,{style:l}),side:"top",sideOffset:4,customPaddingClassName:"p-1",children:a.jsxs(js,{$as:"button",type:"button",onClick:()=>{var m;t(l),qe.logEvent(E.dalleClickStyle,(m=l.name.defaultMessage)==null?void 0:m.toString()),O.logEvent(E.dalleClickStyle,{style:l.name.defaultMessage})},children:[a.jsx(Zc,{className:"h-4 w-4 text-token-text-tertiary"}),r.formatMessage(l.name)]})},l.name.id)),a.jsx(js,{$as:"button",type:"button",onClick:()=>{s(Bn()),qe.logEvent(E.dalleShuffleStyles),O.logEvent(E.dalleShuffleStyles)},children:a.jsx(Hi,{className:"icon-sm text-token-text-tertiary"})}),ba.map(l=>a.jsx("img",{src:l.image.src,alt:r.formatMessage(l.name),width:100,height:100,className:"invisible fixed -left-96 -top-96"},l.name.id))]})}function hd({style:t}){const e=le();return a.jsxs("div",{className:"flex flex-col gap-1",children:[a.jsx("img",{src:t.image.src,alt:e.formatMessage(t.name),width:100,height:100,className:"rounded-md"}),a.jsx("div",{className:"text-xs font-medium",children:e.formatMessage(t.name)})]})}function Bn(){return[...ba].sort(()=>Math.random()-.5)}function gd(t,e){const s=e.getCurrentText();return s.trim()===""?t:s.endsWith(",")?` ${t.toLocaleLowerCase()}`:s.endsWith(", ")?t.toLocaleLowerCase():`, ${t.toLocaleLowerCase()}`}function zn(t,e){const s=gd(t,e);e.appendText(s),Zt()}const js=Ae.div`h-7 bg-token-main-surface-primary border border-token-border-light text-xs hover:bg-token-main-surface-secondary hover:text-token-text-primary px-2.5 radix-state-open:bg-token-main-surface-secondary radix-state-open:text-token-text-primary rounded-full flex flex-nowrap gap-0.5 items-center text-token-text-secondary font-normal`,zt={initial:{opacity:0,y:20,scale:.9},animate:{opacity:1,y:0,scale:1},transition:{delay:.1},exit:{opacity:0,scale:.5,transition:{duration:.2}}},pd=({suggestions:t,onSelectingSuggestedReply:e})=>a.jsx("div",{className:"absolute bottom-full flex w-full max-w-[100vw] grow gap-2 overflow-auto px-1 pb-1 contain-inline-size sm:mb-0 sm:justify-start sm:px-2 sm:pb-0 md:static md:mb-2 md:max-w-none md:justify-center md:overflow-visible",children:t.slice(0,2).map((s,n)=>a.jsx(ge.div,{initial:zt.initial,animate:zt.animate,transition:{delay:(n-1)*zt.transition.delay},exit:zt.exit,children:a.jsx(kt,{as:"button",color:"secondary",size:"small",onClick:()=>{e(s,t,n)},className:"group whitespace-nowrap md:whitespace-normal",children:a.jsx(yd,{suggestion:s})},n)},n))});function xd({suggestions:t,onSelectingSuggestedReply:e,clientThreadId:s}){const n=(t==null?void 0:t.length)>0;u.useEffect(()=>{n&&bl(t,s)},[n,s]);const{isUnauthenticated:o}=wt();return n?t.every(eo)?a.jsxs(ge.div,{initial:{opacity:0},animate:{opacity:1},transition:{duration:.3},className:"flex flex-col items-center",children:[o&&a.jsx(Jo,{className:"mb-6 h-12 w-12 sm:hidden"}),a.jsx(wl,{starterPrompts:t,onSelectStarterPrompt:e})]}):t.every(to)?a.jsx(pd,{suggestions:t,onSelectingSuggestedReply:e}):null:null}function yd({suggestion:t}){return to(t)?a.jsx(a.Fragment,{children:t.text}):eo(t)?a.jsxs("div",{className:"flex flex-col overflow-hidden",children:[t.title&&a.jsx("div",{className:"truncate font-semibold",children:t.title}),a.jsx("div",{className:U("truncate font-normal",t.title?"opacity-50":""),children:t.body})]}):null}function _d(){const{store:t}=Ne(),e=t.useSharedProps();return e?a.jsx(vd,{...e}):null}function vd({clientThreadId:t,suggestions:e}){const s=so();return e===void 0||e.length===0?null:a.jsx("div",{children:a.jsx(Sd,{children:a.jsx("div",{className:"grow",children:e!==void 0&&a.jsx(xd,{suggestions:e,onSelectingSuggestedReply:s,clientThreadId:t})})})})}const Sd=Ae.div`h-full flex ml-1 md:w-full md:m-auto gap-0 md:gap-2 justify-center`,io=({className:t,children:e})=>a.jsx(ge.div,{className:t,initial:{opacity:0},animate:{opacity:1},exit:{opacity:0,transition:{duration:.1,delay:0}},transition:{type:"tween",duration:.3,delay:.2},children:e});function bd({currentLeafId:t,canContinue:e,onContinueGenerating:s}){const n=u.useCallback(()=>{const i=new Os;s(t,i),Zt()},[s,t]);let o=null;return e&&(o=a.jsx(wd,{onHandleContinueGenerating:n})),o&&a.jsx("div",{className:"flex h-full w-full items-center justify-end gap-0 py-4 md:gap-2",children:o})}const wd=({onHandleContinueGenerating:t})=>{const e=aa();return a.jsx(io,{children:a.jsxs(kt,{as:"button",color:"secondary",onClick:t,className:"whitespace-nowrap border-0 md:border",children:[a.jsx(Ya,{className:U("-rotate-180",e?"icon-xs":"icon-sm")}),e&&a.jsx(z,{...Fe.continueGenerating})]})})},kd=({clientThreadId:t})=>{const e=oa(),s=is(t),n=Ls(s);u.useEffect(()=>{n&&vs.dismissBanner()},[n]);const o=e!=null&&e.is_dismissible?()=>vs.dismissBanner():void 0;return a.jsx(ct,{children:e&&a.jsx(ge.div,{transition:{type:"tween",ease:"easeInOut",duration:.1},initial:{opacity:0,transform:"translateY(8px)"},animate:{opacity:1,transform:"translateY(0px)"},exit:{opacity:0,transform:"translateY(8px)"},children:a.jsx(yl,{clientThreadId:t,rateLimitInfo:e,onDismiss:o})})})};function Cd(t){const e=is(t),s=Ls(e),n=oa();return!s&&n!=null}const Ge=window.sessionStorage,Ms=ia(Qo(()=>({memoryFullBannerDismissed:!!(Ge!=null&&Ge.getItem(yt.MemoryFullBannerDismissed))}))),ro={dismissBanner(){Ms.setState(t=>{t.memoryFullBannerDismissed=!0}),Ge==null||Ge.setItem(yt.MemoryFullBannerDismissed,"true")},clearDismissedBanner(){Ms.setState(t=>{t.memoryFullBannerDismissed=!1}),Ge==null||Ge.removeItem(yt.MemoryFullBannerDismissed)}};function Id(t){const e=Wa(t),s=qi(),{data:n}=Vi(e,!1,s),o=n!=null,i=o&&n.memoryFullPct>=100,[r,c]=u.useState(!1);u.useEffect(()=>{!i&&o&&(c(!0),ro.clearDismissedBanner())},[i,o]);const l=Ms(m=>m.memoryFullBannerDismissed);return i&&r&&!l}function Td(){const t=le(),{openSettings:e}=Wi();return a.jsx(ge.div,{initial:{opacity:0},animate:{opacity:1},children:a.jsx($i,{title:t.formatMessage(Ut.memoryFullTitle),content:t.formatMessage(Ut.memoryFullTooltip,Ut.memoryFullTooltip.values),primaryCtaText:t.formatMessage(Ut.memoryManageButton),onPrimaryCtaClick:()=>e(Ki.Personalization),onDismiss:()=>ro.dismissBanner()})})}const Ut=Me({memoryFullTitle:{id:"yRGU2/",defaultMessage:"Memory is full."},memoryManageButton:{id:"a5A88o",defaultMessage:"Manage"},memoryFullTooltip:{id:"neUc+N",defaultMessage:"New memories won’t be created until you make space. <a>Learn more</a>",values:{a:t=>a.jsx("a",{href:Zi,target:"_blank",rel:"noopener noreferrer",className:"underline",children:t})}}}),jd=()=>{const{shouldShowSkipButton:t}=Yi();return t?a.jsx(io,{className:"flex justify-center",children:a.jsx(kt,{as:"button",color:"secondary",onClick:()=>Ji.skipParagen(),children:a.jsx(z,{...Md.skip})})}):null},Md=Me({skip:{id:"dvcUbp",defaultMessage:"Skip"}}),Rd=u.memo(function({className:e}){const{store:s}=Ne(),n=s.useIsHeaderContentAreaPopulated();return a.jsx("div",{className:U(e??"absolute bottom-full left-0 right-0",bs.PromptTextareaHeader),children:a.jsx(Qi,{shouldRender:n,contentArea:St.Header,children:a.jsxs("div",{className:"mb-2 flex flex-col gap-3.5 pt-2",children:[a.jsx(Ed,{}),a.jsx(Ad,{})]})})})});function Ed(){const{store:t}=Ne(),e=t.useContentAreaId(St.HeaderTop);let s;switch(e){case he.ParagenControls:s=a.jsx(jd,{});break;case he.ItemActions:s=a.jsx(_d,{});break;case he.BannerSignup:s=a.jsx(Pd,{});break;case he.BannerTermsDisclaimer:s=a.jsx(Dd,{});break;case he.PromptTextareaAction:s=a.jsx(Fd,{});break;case he.BannersRateLimit:s=a.jsx(Od,{});break;case he.BannerSidekickAnnouncement:s=a.jsx(vl,{});break;case he.BannerMemoryFull:s=a.jsx(Td,{});break;case he.Box:s=a.jsxs("div",{className:"flex h-20 w-full items-center justify-center gap-2 bg-red-500 p-2",children:["box",a.jsxs("div",{className:"flex h-full w-full items-center justify-center gap-2 bg-blue-500 p-2",children:["inner",a.jsx("div",{className:"flex h-full w-full items-center justify-center bg-yellow-400 text-center",children:"actual content"})]})]});break;default:s=null;break}return s}function Ad(){const{store:t}=Ne(),e=t.useContentAreaId(St.HeaderBottom);let s;switch(e){case wa.DallePromptControls:s=a.jsx(Nd,{});break;default:s=null;break}return s}function Nd(){const{store:t}=Ne(),e=t.useSharedProps(s=>s==null?void 0:s.composerController);return e?a.jsx(ud,{composerController:e}):null}function Pd(){const{store:t}=Ne(),e=t.useSharedProps(o=>o==null?void 0:o.clientThreadId),s=Xi(),n=er();return e?s?a.jsx(tr,{threadId:e,showSignUp:n}):a.jsx(sr,{threadId:e,showLogin:n}):null}function Dd(){const{store:t}=Ne(),e=t.useSharedProps(s=>s==null?void 0:s.clientThreadId);return e?a.jsx(nr,{threadId:e}):null}function Fd(){const{store:t}=Ne(),e=t.useSharedProps();return e?a.jsx(bd,{...e}):null}function Od(){const{store:t}=Ne(),e=t.useSharedProps(s=>s==null?void 0:s.clientThreadId);return e?a.jsx(kd,{clientThreadId:e}):null}function Js(){return ra(Rs.DataAnalysisV2)}function hf(){const t=ka(),e=Qt();return e&&t&&!Xo(t)&&e.isEnterprise()}function Ld(){return ra(Rs.ChartSerialization)}function gf(t,e){const s=t==="chart"?yt.HasSeenAdaInteractiveChart:yt.HasSeenAdaInteractiveTable,[n,o]=u.useState(vn.getItem(s,{userId:e})??!1),i=u.useCallback(()=>{o(!0),vn.setItem(s,!0,{userId:e})},[s,e]);return[n,i]}function pf(t){const[e,s]=u.useState([]),n=lt(()=>{const o=C.resolveThreadId(t),i=C.getThreadCurrentLeafId(t);return C.getTree(o).getBranchFromLeaf(i)});return u.useEffect(()=>{const o=lo(n);o.length!==e.length&&s(o)},[e.length,t,n]),e}function Bd(t){return lt(()=>{const e=C.resolveThreadId(t),s=C.getThreadCurrentLeafId(t),o=C.getTree(e).getBranchFromLeaf(s);return lo(o).length>0})}function co(t){var i,r,c,l;const e=((r=(i=t.metadata)==null?void 0:i.aggregate_result)==null?void 0:r.messages.filter(ao))??[];let s=0;const n=(((c=t.metadata)==null?void 0:c.ada_visualizations)??[]).map(m=>{let f=m;return m.type=="chart"&&(f={...m,fallback_image:e[s++]}),f}),o=(((l=t.metadata)==null?void 0:l.attachments)??[]).filter(m=>Ia(m.name)).map(m=>({type:"table",file_id:m.id??"",title:or(m),file_name:m.name,context_connector_info:m.context_connector_info}));return[...n,...o]}function lo(t){return t.filter(s=>{var n,o,i,r;return((n=s.message)==null?void 0:n.author.role)==="tool"&&((o=s.message)==null?void 0:o.author.name)==="python"||(((r=(i=s.message)==null?void 0:i.metadata)==null?void 0:r.attachments)??[]).length>0}).flatMap(s=>co(s.message))}ia(t=>({selectedSpreadsheet:null,setSelectedSpreadsheet:e=>t({selectedSpreadsheet:e})}));async function zd(t,e,s){const n=await t.text(),{parse:o}=await de(async()=>{const{parse:r}=await import("./oeujip5i1ptrxie5.js");return{parse:r}},[]),i=o(n);return{content:{columnNames:i.shift(),columnTypes:i[0].map(()=>"string"),rows:i},file_name:e,download_url:s}}function Ud(t){const e=t[0].values.length,s=[];for(let n=0;n<e;n++){const o=t.map(i=>i.values[n]);s.push(o)}return s}function xf(t){return ca({queryKey:["ada-visualization","chart",t.file_id],queryFn:async()=>{const e=await Ye.getFileDownloadLink(t.file_id);if(e.status===la.Success){const n=await(await fetch(e.download_url)).json();return{content:{chart_type:n.type,title:n.title,labels:n.labels,datasets:n.datasets,x_label:n.x_label,y_label:n.y_label},file_name:e.file_name??"",download_url:e.download_url}}else throw new Error("Failed to download chart json from interpreter")}})}function yf(t){return ca({queryKey:["ada-visualization","table",t.file_id],queryFn:async()=>{if(t.file_name&&ar(t.file_name)){const e=await Ye.getAdaExcelFileContents(t.file_id);return{content:e.sheets.map(s=>({name:s.name,columnNames:s.columns.map(n=>n.name),columnTypes:s.columns.map(()=>"string"),rows:Ud(s.columns)})),download_url:e.download_url,file_name:t.file_name}}else{const e=await Ye.getFileDownloadLink(t.file_id);if(e.status===la.Success){const s=await fetch(e.download_url);return zd(s,e.file_name??"",e.download_url)}else throw new Error("Failed to download from interpreter")}}})}function Gd(t){const e=Ca(),s=Bd(t),n=Js();return s&&n&&!e.displayingSideBySideFeedback}function Hd(t){var e,s;return((s=(e=t.metadata)==null?void 0:e.dalle)==null?void 0:s.prompt)??""}async function qd(t,e,s="image/png"){return new Promise((n,o)=>{t.toBlob(i=>{i!=null?n(new File([i],e,{type:s})):o(new Error("Failed to convert canvas to blob"))},s)})}async function Vd(t,e){const s=document.createElement("canvas");s.width=t.width,s.height=t.height;const n=s.getContext("2d");if(n==null)throw new Error("Failed to get 2d context for mask canvas");const o=n.createImageData(t.width,t.height);for(let i=0;i<t.data.length;i+=4)t.data[i+3]!==0?(o.data[i]=0,o.data[i+1]=0,o.data[i+2]=0,o.data[i+3]=255):(o.data[i]=255,o.data[i+1]=255,o.data[i+2]=255,o.data[i+3]=255);return n.putImageData(o,0,0),qd(s,e)}async function Wd(t,e){const n=await(await fetch(t)).blob(),o=document.createElement("a");o.href=URL.createObjectURL(n),o.download=e,o.click(),o.remove()}function $d(t){const e=cr(new Date,"yyyy-MM-dd HH.mm.ss");let s=t.slice(0,150);return s.endsWith(".")&&(s=s.slice(0,-1)),`DALL·E ${e} - ${s}.webp`}async function _f(t,e,s){var i,r,c,l,m,f,g,d,v,p;const n=Hd(t),o=$d(n);await Wd(t.url,o),qe.logEvent("chatgpt_dalle_image_download",null,{sourceOperation:((r=(i=t.metadata)==null?void 0:i.dalle)==null?void 0:r.edit_op)??"none",hasParent:((l=(c=t.metadata)==null?void 0:c.dalle)==null?void 0:l.parent_gen_id)!=null?"true":"false"}),O.logEvent(E.dalleImageDownload,{conversationId:e,messageId:s,generationId:(f=(m=t.metadata)==null?void 0:m.dalle)==null?void 0:f.gen_id,parentGenerationId:(d=(g=t.metadata)==null?void 0:g.dalle)==null?void 0:d.parent_gen_id,fileId:as(t.asset_pointer),sourceOperation:(p=(v=t.metadata)==null?void 0:v.dalle)==null?void 0:p.edit_op})}function Kd(t){const e=Ys(t),s=ns(),n=e&&"gizmo"in e?e.gizmo:void 0;return!s&&(n==null?void 0:n.gizmo.id)===ir}function vf(t,e){var o,i;const s=(i=(o=e.metadata)==null?void 0:o.dalle)==null?void 0:i.gen_id,n=as(e.asset_pointer);return n==null||s==null?t:{...t,messageMetadata:{...t.messageMetadata,dalle:{from_client:{operation:{type:"transformation",original_gen_id:s,original_file_id:n}}}}}}async function Zd(t,e,s){return new Promise((n,o)=>{rr(Ta(t),t,e,{kind:ei.DalleAgent},{onFileCreated:_t,onFileUploadProgress:_t,onFileUploaded:(i,r)=>n(r),onError:(i,r)=>{o(new Error(`Failed to upload file with reason: ${r}`))}},s)})}async function Sf(t,e,s,n){var r,c;const o=(c=(r=e.metadata)==null?void 0:r.dalle)==null?void 0:c.gen_id,i=as(e.asset_pointer);if(i==null||o==null||s==null)return t;try{const l=await Vd(s,"mask.png"),m=await Zd(l,n,{imageDimensions:{width:e.width,height:e.height}});return{...t,messageMetadata:{...t.messageMetadata,dalle:{from_client:{operation:{type:"inpainting",original_gen_id:o,original_file_id:i,mask_file_id:m}}}}}}catch(l){return Pe.addError(l),t}}const Yd=u.memo(function(e){return Jd(e),Qd(e),Xd(),null});function Jd(t){const{store:e}=Ne(),s=e.useSetSharedProps();u.useLayoutEffect(()=>{s(t)},[t,s])}function Qd(t){const{clientThreadId:e,canContinue:s}=t,{store:n}=Ne(),o=u.useRef({top:n.useContentAreaApi(St.HeaderTop),bottom:n.useContentAreaApi(St.HeaderBottom)}).current,i=su(t),r=Kd(e),{shouldShowBannerSignup:c,shouldShowBannerTermsDisclaimer:l}=nu(e),m=Cd(e),f=Sl(t),g=Id(e),d=lr();u.useLayoutEffect(()=>{d?o.top.set(he.ParagenControls):l?o.top.set(he.BannerTermsDisclaimer):m?o.top.set(he.BannersRateLimit):f.eligible?o.top.set(he.BannerSidekickAnnouncement):i?o.top.set(he.ItemActions):s?o.top.set(he.PromptTextareaAction):c?o.top.set(he.BannerSignup):g?o.top.set(he.BannerMemoryFull):o.top.set(null)},[o,i,s,l,c,m,f,g,d]),u.useLayoutEffect(()=>{r&&o.bottom.set(wa.DallePromptControls)},[o,r])}function Xd(){const{store:t}=Ne();u.useEffect(()=>()=>{t.reset()},[t])}function eu(t){var o,i;const e=ja(),s=dt(t),n=(i=(o=C.getTree(t).getLastValidNode(s))==null?void 0:o.message)==null?void 0:i.id;return(e==null?void 0:e.messageId)===n?e.suggestions:[]}function tu(t){return eu(t).length>0}function su(t){const e=Gd(t.clientThreadId),s=tu(t.clientThreadId);return t.isDisabled?!1:t.isNewThread||e||s}function nu(t){var g;const{isUnauthenticated:e}=wt(),s=dt(t),{layer:n}=ti("3637408529"),o=n.get("should_show_no_auth_signup_banner",!0),i=dr(d=>d.bannerDisclaimerClientThreadId),r={shouldShowBannerTermsDisclaimer:!1,shouldShowBannerSignup:!1};if(!t)return r;const c=C.getTree(t),l=c.countMessagesByAuthor(be.User),m=c.getNodeByIdOrMessageId(s),f=((g=m==null?void 0:m.message)==null?void 0:g.author.role)===be.Assistant&&Es(m.message);return r.shouldShowBannerTermsDisclaimer=f&&e&&l===1&&(i==null||i===t),r.shouldShowBannerSignup=o&&f&&e&&l>0&&l%5===0,r}function au(t,e,s,n,o){const{getGizmoId:i}=os(),[r,c]=u.useState();u.useEffect(()=>{i?i().then(f=>c(f)):c(void 0)},[i]);const l=da(e);return u.useCallback(f=>{const{docsReferencedByURL:g}=Oe.getThread(t)??{};if(g!=null)for(const d of f){const{id:v,type:p,handler:h}=d,b=`${p}:${v}`,M=g[b],T=bt.getState().files.find(y=>y.tempId===v);if(M!=null&&M!=="failed"&&T){Wt.success(s.formatMessage(gs.fileAlreadyAttached),{hasCloseButton:!0});continue}switch(h.type){case"fetch":{C.updateReferencedDocState(t,b,"pending"),Ke.uploadFile(v,new File([],s.formatMessage(gs.fileLoading)),et.None,n,s,{skipUpload:!0,gizmoId:r},o,{contextConnector:p,sourceUrl:d.url,syntheticExtension:null,type:$t.Link}),fs.linkMetadataFetchStarted(p),h.tryFetch().then(y=>{if(Ke.remove(v,"none"),y==null)return null;const{id:_,title:k,connector:F,mimeType:P,url:D,syntheticExtension:R,o365DriveId:K}=y;fs.linkMetadataFetchSucceeded(p,P),C.updateReferencedDocState(t,b,"fetched");let W=k;F===ke.GDRIVE&&(W=R?`${k}.${R}`:k),Ke.uploadFile(_,new File([],W,{type:P.split(";")[0]}),et.Retrieval,n,s,{gizmoId:r},o,{contextConnector:F,sourceUrl:D,syntheticExtension:R,type:$t.Link,o365DriveId:K})}).catch(y=>{fs.linkMetadataFetchFailed(p,y),Wt.danger(s.formatMessage(gs.fileFetchFailed),{hasCloseButton:!0}),C.updateReferencedDocState(t,b,"failed"),Ke.remove(v,"none")});break}case"prompt":{l.appendMessageIfNotDismissed({connector:p,type:h.message}),C.updateReferencedDocState(t,b,"prompted");break}}}},[o,t,l,r,s,n])}const gs=Me({fileLoading:{id:"CCC.fileLoading",defaultMessage:"Loading…"},fileFetchFailed:{id:"CCC.fileFetchFailed",defaultMessage:"Unable to fetch file information"},fileAlreadyAttached:{id:"CCC.fileAlreadyAttached",defaultMessage:"This file is already a part of your message."}}),uo=({clientThreadId:t,rateLimitPopup:e,children:s,highlightTooltip:n=!1})=>{const o=le(),i=Lc(t),r=Qt(),[c,l]=u.useState(n),[m,f]=u.useState(!1),g=u.useCallback(()=>{m||l(!0)},[m]),d=u.useCallback(()=>{l(!1),f(!1)},[]),v=u.useCallback(()=>{l(!1),f(!0)},[]);u.useEffect(()=>{l(n)},[n]);const p=b=>{e!=null&&b&&O.logPopoverHover({type:"rate_limit",location:"file_upload",plan_type:(r==null?void 0:r.planType)??"unknown"})},h=!!e;return a.jsx(a.Fragment,{children:h?a.jsxs(si,{delayDuration:150,onOpenChange:p,children:[a.jsx(ni,{children:s}),a.jsx(ai,{children:a.jsx(ur,{$as:oi,side:"top",sideOffset:4,className:"max-w-[260px]",children:a.jsx(ou,{isNewConversation:i,rateLimitPopup:e})})})]}):a.jsx(Fs,{sideOffset:14,label:o.formatMessage({id:"oUK/GV",defaultMessage:"Attach file"}),className:"flex",open:c||n,side:"top",children:a.jsx("span",{onPointerEnter:g,onPointerLeave:d,onClick:v,children:s})})})},ou=({isNewConversation:t=!1,rateLimitPopup:e})=>{const s=Qt(),n=ii();if(e==null)return null;const{call_to_action:o,description:i}=e,r=i||a.jsx(z,{...Un.defaultDescription}),c=o==null?void 0:o.includes(ri.GET_PLUS);return a.jsxs("div",{className:"p-2 text-sm text-token-text-primary",children:[a.jsx("div",{children:r}),c?a.jsx(kt,{size:"small",color:"secondary",className:"mt-3",onClick:()=>{mr(n,"Rate limited file upload popover"),O.logRateLimitGetPlusButtonClicked({type:"file_upload",location:"popover",plan_type:(s==null?void 0:s.planType)??"unknown",is_hard_block:!1,is_new_conversation:t,hard_block_reason:""})},children:a.jsx(z,{...Un.getPlus})}):null]})},Un=Me({defaultDescription:{id:"U5qAWP",defaultMessage:"You've reached your daily upload limit. Get ChatGPT Plus to unlock more."},getPlus:{id:"TeyLcp",defaultMessage:"Get Plus"}});function iu({clientThreadId:t,getInputProps:e,openFileDialog:s,uploadType:n,icon:o,highlightTooltip:i=!1}){const r=le(),c=As(),l=!!c,m=a.jsx(Ma,{className:"mb-1",disabled:l,onClick:d=>{d.preventDefault(),O.logEvent(E.openFileViewer,{intent:n.toString()}),s()},"aria-label":r.formatMessage({id:"PromptFilePicker.attachFiles",defaultMessage:"Attach files"}),children:o}),f=a.jsx("input",{disabled:l,...e({className:"hidden"})}),g=a.jsxs("div",{className:"flex",children:[m,f]});return a.jsx(uo,{clientThreadId:t,rateLimitPopup:c,highlightTooltip:i,children:g})}function ru({code:t,message:e}){switch(t){case In.FileTooLarge:return Gn.errorFileTooLarge;case In.TooManyFiles:return O.logEvent(E.uploadedMaxFilesError),Gn.errorTooManyFiles;default:return e}}const Gn=Me({attachImages:{id:"PromptFilePicker.attachImages",defaultMessage:"Attach images"},attachFiles:{id:"PromptFilePicker.attachFiles",defaultMessage:"Attach files"},errorFileTooLarge:{id:"PromptFilePicker.errorFileTooLarge",defaultMessage:"Your file is too large. The maximum file size is {size}MB."},errorTooManyFiles:{id:"PromptFilePicker.errorTooManyFiles",defaultMessage:"You may only upload {maxNum} files at a time."},defaultFileUploadRateLimited:{id:"U5qAWP",defaultMessage:"You've reached your daily upload limit. Get ChatGPT Plus to unlock more."},getPlusButton:{id:"TeyLcp",defaultMessage:"Get Plus"}}),Hn=Me({dragInstructions:{id:"FileDropZone.dragInstructions",defaultMessage:"Add anything"},dragAllAccepted:{id:"FileDropZone.dragAllAccepted",defaultMessage:"Drop any file here to add it to the conversation"}});function bf(t){var y;const{className:e,children:s,clientThreadId:n,currentModelConfig:o}=t,i=le(),r=Ys(n),c=Yt(o,r),l=c!==et.None,m=bt(_=>_.files),f=(c===et.Multimodal?Bs:zs)-m.length,g=f<=0,{getGizmoId:d}=os(),{handleFileAccepted:v}=fo(i,Yt(o,r),Ea(o,r),"drag",d,(y=Ra(o,r))==null?void 0:y.attachments),p=As(),h=Aa(Na(o,r)),{getRootProps:b,isDragActive:M}=Pa({maxFiles:f,disabled:!l||g||p!=null,noClick:!0,onDropAccepted:v,onDropRejected:_=>mo(_,i,c),multiple:!0,maxSize:Da,...h}),I=T();function T(){if(!h.accept||Object.keys(h.accept).length===0)return[];const _=[];return Object.values(h.accept).forEach(k=>_.push(...k)),_.sort()}return a.jsxs("div",{...b({className:e}),children:[s,M&&a.jsxs(cu,{children:[a.jsx(fr,{}),a.jsx("h3",{children:a.jsx(z,{...Hn.dragInstructions})}),a.jsx("h4",{className:"w-2/3 text-center",children:I.length>0?I.join(", "):a.jsx(z,{...Hn.dragAllAccepted})})]})]})}function mo(t,e,s){const{errors:n}=t[0];n.forEach(o=>{const i=ru(o);typeof i=="string"?Wt.danger(i,{hasCloseButton:!0}):Wt.danger(e.formatMessage(i,{size:hr,maxNum:s===et.Multimodal?Bs:zs}),{hasCloseButton:!0})})}function fo(t,e,s,n,o,i){return{handleFileAccepted:u.useCallback(async(c,l)=>{O.logEvent(E.uploadFile,{client:"web",eventSource:n,intent:e.toString()});const m=o!=null?await o():void 0;c.length>0&&c.forEach(f=>{Ke.uploadFile(Ta(f),f,e,s,t,{gizmoId:m},i)})},[n,e,o,s,t,i])}}const cu=Ae.div`absolute inset-0 opacity-80 flex gap-2 flex-col justify-center items-center bg-token-main-surface-primary text-token-text-primary`;function ho({children:t,className:e,showBackground:s}){return a.jsxs("div",{className:"relative",children:[t,s&&a.jsx(ge.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:260,damping:20},className:U("pointer-events-none absolute bottom-0 top-0 h-8 w-8 rounded-full",e)})]})}function qn({entry:t,onClick:e}){const{connectorConfig:s}=Us();u.useEffect(()=>{if(!open||t.type!==ke.GDRIVE)return;const r=s.get(ke.GDRIVE),c=r==null?void 0:r.access_token;c&&gr(c)},[s,t.type]);const n=Fa(t.type),o=le(),i=t.access_token?Vn.uploadFromMessage:Vn.signinWithMessage;return a.jsx(X.Item,{onClick:e,icon:n,children:a.jsxs("div",{className:"flex flex-col",children:[a.jsx(z,{...i,values:{connectorName:Gs(t.type,o)}}),t.type===ke.O365_BUSINESS&&a.jsx("div",{className:"text-s text-token-text-tertiary",children:a.jsx(z,{...Hs.includesSharePoint})})]})},t.id)}const Vn=Me({signinWithMessage:{id:"ContextConnectorPickerDropdownItem.signInWithMessage",defaultMessage:"Connect to {connectorName}"},uploadFromMessage:{id:"ContextConnectorPickerDropdownItem.uploadWithMessage",defaultMessage:"Add from {connectorName}"}});function lu({clientThreadId:t,icon:e,setOpen:s,highlightTooltip:n=!1}){const o=As(),i=!!o,r=le();return a.jsxs(a.Fragment,{children:[a.jsx(X.Trigger,{className:"m-0 h-0 w-0 border-none bg-transparent p-0"}),a.jsx(uo,{clientThreadId:t,rateLimitPopup:o,highlightTooltip:n,children:a.jsx(Ma,{className:"mb-1","aria-disabled":i,"aria-label":r.formatMessage({id:"tA7CXR",defaultMessage:"Attach files"}),onClick:c=>{c.preventDefault(),i||s(!0)},children:e})})]})}function du({connectorEntries:t,onOauthRedirect:e}){const s=le();return a.jsxs(X.Sub,{children:[a.jsx(X.SubMenuTrigger,{icon:Yc,children:a.jsx("div",{className:"line-clamp-1 text-ellipsis",children:a.jsx(z,{...uu.connectApps})})}),a.jsx(X.Portal,{children:a.jsx(X.SubContent,{children:t.map(n=>a.jsx(X.Item,{onClick:()=>e(n),icon:Fa(n.type),children:a.jsxs("div",{className:"flex flex-col",children:[Gs(n.type,s),n.type===ke.O365_BUSINESS&&a.jsx("div",{className:"text-s text-token-text-tertiary",children:a.jsx(z,{...Hs.includesSharePoint})})]})},n.id))})})]})}const uu=Me({connectApps:{id:"ContextConnectorPicker.connectApps",defaultMessage:"Connect apps"}});function mu({onOauthRedirect:t,connectors:e}){const s=le();return a.jsxs(X.Sub,{children:[a.jsx(X.SubMenuTrigger,{icon:Jc,children:a.jsx(z,{...fu.oneDriveSubmenuName})}),a.jsx(X.Portal,{children:a.jsx(X.SubContent,{children:e.map(n=>n?a.jsx(X.Item,{onClick:()=>t(n),children:a.jsxs("div",{className:"flex flex-col",children:[Gs(n.type,s),n.type===ke.O365_BUSINESS&&a.jsx("div",{className:"text-s text-token-text-tertiary",children:a.jsx(z,{...Hs.includesSharePoint})})]})},n.id):null)})})]})}const fu=Me({oneDriveSubmenuName:{id:"ContextConnectorPickerOneDriveSubmenu.oneDriveSubmenuName",defaultMessage:"Connect to Microsoft OneDrive"}});function hu(){const{connectorConfig:t}=Us(),e=Xt(),[s,n]=Jt(Oa([...t.values()],m=>!!m.access_token),m=>!!m.access_token),[o,i]=Jt(n,m=>m.type===ke.O365_PERSONAL||m.type===ke.O365_BUSINESS),r=!e&&!qt&&s.length>0,c=!e&&!qt&&!r&&o.length>1;return{unconnectedConnectors:qt?[]:c?i:n,showUnconnectedInSubmenu:r,showOneDriveInSubmenu:c}}function gu({clientThreadId:t,icon:e,modelAcceptedMimeTypes:s,modelSupportedImageMimeTypes:n,attachmentsProductFeature:o,onOauthRedirect:i,uploadType:r,getInputProps:c,openFileDialog:l,highlightTooltip:m=!1}){const{currentLocale:f}=ci(),g=le(),d=Xt(),{connectorConfig:v,isLoading:p}=Us(),h=ts(ss.ContextConnectors),{getGizmoId:b}=os(),[M,I]=u.useState();u.useEffect(()=>{b?b().then(x=>I(x)):I(void 0)},[b]);const T=u.useRef(null),[y,_]=u.useState(!1),k=u.useRef(!1),F=u.useCallback(()=>{var Z;const x=(Z=T.current)==null?void 0:Z.files;Array.from(x??[]).forEach(pe=>Ot.uploadFile(pe,n,g,o))},[n,o,g]),[P,D]=u.useState(null),R=u.useCallback(()=>D(null),[D]),K=u.useCallback((x,Z)=>Ot.uploadPickedFile(x,Z,n,s,o,M,g),[n,s,o,M,g]),{openMenu:W,confirmMenuOpened:H}=pr();u.useEffect(()=>{W&&(_(!0),H())},[W,H,_]);const Q=ua(),ee=u.useCallback(x=>{Ot.doContextConnectorOauthRedirect(Q.asPath,x,i,$t.Picker),i()},[i,Q.asPath]),ae=u.useCallback(x=>{Ot.uploadPickedFile(x,ke.GDRIVE,n,s,o,M,g)},[n,s,o,M,g]),q=u.useCallback(async x=>{const{access_token:Z}=x;if(!Z){ee(x);return}switch(xr(x,$t.Picker),x.type){case ke.GDRIVE:yr(f,x.type,Z,pe=>pe.forEach(ae));break;case ke.O365_PERSONAL:case ke.O365_BUSINESS:D(x.type);break}},[ae,ee,D,f]),j=()=>{O.logEvent(E.openFileViewer,{intent:r.toString()}),l()},S=x=>{if(!x&&k.current&&!p)j();else if(x&&Y&&!p){j();return}_(x),x&&(h.eligible&&h.markAsViewed(),O.logEvent(E.composerOpenContextConnectorPicker),k.current=!0,setTimeout(()=>{k.current=!1},250))},[A,oe]=Jt(Oa([...v.values()],x=>!!x.access_token),x=>!!x.access_token);pu(A,q);const[te]=Jt(oe,x=>x.type===ke.O365_PERSONAL||x.type===ke.O365_BUSINESS),{unconnectedConnectors:ce,showUnconnectedInSubmenu:se,showOneDriveInSubmenu:$}=hu(),Y=!A.length&&!ce.length,fe=a.jsxs(a.Fragment,{children:[se&&ce.length>0&&a.jsx(du,{connectorEntries:ce,onOauthRedirect:x=>ee(x)}),!se&&ce.map(x=>a.jsx(qn,{entry:x,onClick:()=>q(x)},x.id)),$&&a.jsx(mu,{connectors:te,onOauthRedirect:ee}),p&&a.jsx(X.Item,{icon:a.jsx(li,{className:"text-token-text-secondary"})}),(ce.length>0||p)&&a.jsx(X.Separator,{}),A.map(x=>a.jsx(qn,{entry:x,onClick:()=>q(x)},x.id)),a.jsx(X.Item,{onClick:j,icon:Qc,children:a.jsx(z,{...d?Wn.uploadFileMobile:Wn.uploadFile})},"upload")]}),ne=a.jsxs("div",{className:"flex flex-col",children:[a.jsx(_r,{type:P,onClose:R,uploadPickedFile:K}),a.jsx("input",{onChange:F,...c({className:"hidden"})}),a.jsxs(X.Root,{open:y,onOpenChange:S,children:[a.jsx(lu,{clientThreadId:t,icon:e,setOpen:S,highlightTooltip:m}),a.jsx(X.Portal,{children:a.jsx(X.Content,{size:"large",children:fe})})]}),a.jsx(vr,{hasConnectors:!p&&!Y})]});return{dropdownItems:fe,mainComponent:ne}}function pu(t,e){const{connector:s,clearParam:n}=Sr(),o=t.find(i=>i.type===s&&!!i.access_token);u.useEffect(()=>{o&&(e(o),n())},[o,e,n])}function xu(t){const{mainComponent:e}=gu(t);return e}const Wn=Me({attachFiles:{id:"ContextConnectorPicker.attachFiles",defaultMessage:"Attach files"},uploadFile:{id:"LocalFileDropdownItem.uploadFile",defaultMessage:"Upload from computer"},uploadFileMobile:{id:"LocalFileDropdownItem.uploadFileMobile",defaultMessage:"Upload file"}});function yu({clientThreadId:t,uploadType:e,modelAcceptedMimeTypes:s,modelSupportedImageMimeTypes:n,attachmentsProductFeature:o,getInputProps:i,openFileDialog:r,onOauthRedirect:c,historyDisabled:l,className:m,highlightTooltip:f}){const{gdriveStatus:g,o365Status:d}=br(),v=a.jsx(Xc,{className:l?"text-white":f?"text-brand-blue-800":void 0});return a.jsx("div",{className:U("relative",m),children:a.jsx(ho,{showBackground:f,className:"bg-brand-blue-800/20",children:g!=="false"||d!=="false"?a.jsx(xu,{clientThreadId:t,icon:v,modelAcceptedMimeTypes:s,modelSupportedImageMimeTypes:n,attachmentsProductFeature:o,onOauthRedirect:c,uploadType:e,openFileDialog:r,getInputProps:i,highlightTooltip:f}):a.jsx(iu,{clientThreadId:t,uploadType:e,openFileDialog:r,getInputProps:i,icon:v,highlightTooltip:f})})})}const _u=u.forwardRef(function({type:e,placeholder:s,replyRegions:n,state:o,renderFiles:i,leftSideActions:r,onSubmit:c,inputState:l,currentLeafId:m,composerController:f,clientThreadId:g,gizmoId:d},v){const p=Ds(),h=wr();return u.useEffect(()=>{f.focus()},[h==null?void 0:h.modelId,f]),a.jsxs("div",{ref:v,className:U("flex w-full flex-col gap-1.5 rounded-[26px] p-1.5 transition-colors",p&&"backdrop-blur-2xl no-transparency:backdrop-blur-none",p&&e!=="temporary"&&"bg-token-composer-surface",!p&&e!=="temporary"&&"bg-[#f4f4f4] dark:bg-token-main-surface-secondary",e==="temporary"&&"dark bg-black"),children:[a.jsx(ct,{children:n.length>0&&a.jsx(ge.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0,transition:{duration:.06}},transition:{ease:"easeOut",duration:.1},children:a.jsx(wu,{replyRegions:n})})}),a.jsxs("div",{className:"flex items-end gap-1.5 pl-4 md:gap-2",children:[!!(r!=null&&r.length)&&a.jsx(ge.div,{initial:{opacity:0},animate:{opacity:1},transition:{ease:"easeOut",duration:.06},className:"-ml-2.5 flex",children:r},"leftSideActions"),a.jsxs(ge.div,{layout:!0,transition:{duration:.1},className:U("flex min-w-0 flex-1 flex-col"),children:[i,f instanceof La?a.jsx(vu,{composerController:f,currentLeafId:m,placeholder:s,inputState:l}):a.jsx(Ml,{composerController:f,placeholder:s})]}),a.jsx(Su,{inputState:l,state:o,onSubmit:c,composerController:f,clientThreadId:g,gizmoId:d})]})]})});function vu({composerController:t,currentLeafId:e,placeholder:s,inputState:n}){const o=u.useContext(di);return a.jsxs(a.Fragment,{children:[a.jsx(kr,{id:Cr,autoFocus:!0,tabIndex:0,"data-id":e,dir:"auto",ref:i=>{if(!(t instanceof La))throw new Error("Expected TextAreaComposerController");i!=null&&(t.textArea=i,t.logPageMount())},rows:1,placeholder:s,disabled:n!=="default",className:U("m-0 resize-none border-0 bg-transparent px-0 text-token-text-primary focus:ring-0 focus-visible:ring-0",n==="disabled"&&"text-center",["max-h-[25dvh]","max-h-52"])}),a.jsx("script",{nonce:o.cspScriptNonce,suppressHydrationWarning:!0,children:"requestAnimationFrame((function(){window.__oai_logTTI?window.__oai_logTTI():window.__oai_SSR_TTI=window.__oai_SSR_TTI??Date.now()}))"})]})}function Su(t){const{isUnauthenticated:e}=wt(),s=bt(Ba.hasUploadInProgress);if(t.inputState==="disabled")return null;const n=a.jsx(bu,{state:t.state,onSubmit:t.onSubmit});return!e&&!s&&t.state==="disabled"&&t.clientThreadId?a.jsx("div",{className:"min-w-8",children:a.jsx(Ir,{clientThreadId:t.clientThreadId,gizmoId:t.gizmoId,fallback:()=>n})}):n}function bu({state:t,onSubmit:e}){const s=t==="streaming"?tl:sl,n=le(),o=n.formatMessage({id:"+yfm/p",defaultMessage:"Stop streaming"}),i=n.formatMessage({id:"xfIykB",defaultMessage:"Send prompt"}),r=Ds();return a.jsx("button",{onClick:e,disabled:t==="disabled","aria-label":t==="streaming"?o:i,"data-testid":t==="streaming"?"stop-button":"send-button",className:U("mb-1 me-1 flex h-8 w-8 items-center justify-center rounded-full bg-black text-white transition-colors hover:opacity-70 focus-visible:outline-none focus-visible:outline-black disabled:text-[#f4f4f4] disabled:hover:opacity-100 dark:bg-white dark:text-black dark:focus-visible:outline-white disabled:dark:bg-token-text-quaternary dark:disabled:text-token-main-surface-secondary",r&&"disabled:bg-black disabled:bg-opacity-[0.27]",!r&&"disabled:bg-[#D7D7D7]"),children:a.jsx(s,{className:U(t==="streaming"?"icon-lg":"icon-2xl")})})}function wu({replyRegions:t}){return a.jsx("div",{className:"flex flex-col divide-y divide-token-border-light overflow-hidden rounded-b-lg rounded-t-[20px] bg-token-main-surface-primary",children:t.map((e,s)=>{switch(e.type){case"text":return a.jsx(ku,{value:e.value,onRemoveRegion:e.onRemoveRegion},s);case"object":return a.jsx(Cu,{value:e.value,onRemoveRegion:e.onRemoveRegion},s);case"mention":case"system_hint":return a.jsx(Iu,{value:e.value,icon:e.icon,onRemoveRegion:e.onRemoveRegion},s)}})})}function ku({value:t,onRemoveRegion:e}){return a.jsxs(Xs,{className:"text-token-text-secondary",children:[a.jsx(en,{children:a.jsx($s,{className:"icon-lg-heavy"})}),a.jsx(tn,{children:`“${t}”`}),a.jsx(Qs,{onClick:e})]})}function Cu({value:t,onRemoveRegion:e}){return a.jsxs(Xs,{className:"text-blue-selection",children:[a.jsx(en,{children:a.jsx($s,{className:"icon-lg-heavy"})}),a.jsx(tn,{className:"font-semibold",children:t}),a.jsx(Qs,{onClick:e})]})}function Iu({value:t,icon:e,onRemoveRegion:s}){return a.jsxs(Xs,{children:[a.jsx(en,{className:"mt-0",children:e}),a.jsx(tn,{className:"font-semibold text-token-text-primary",children:t}),a.jsx(Qs,{onClick:s})]})}function Qs({onClick:t}){return a.jsx("button",{onClick:t,type:"button",className:"flex-shrink-0 text-token-text-secondary",children:a.jsx(el,{className:"icon-lg"})})}const Xs=Ae.div`flex items-start py-2.5 gap-3 pl-3 pr-1.5 text-sm`,en=Ae.span`flex-shrink-0 mt-0.5 w-7 h-6 flex justify-center items-center`,tn=Ae.span`flex-1 line-clamp-3 py-0.5`;function Tu({composerController:t,highlightTooltip:e}){return a.jsx(Mu,{highlightTooltip:e,children:a.jsx(ho,{showBackground:e,className:"bg-brand-purple/20",children:a.jsx("button",{className:"mb-1 flex h-8 w-8 items-center justify-center text-token-text-primary",onClick:()=>{O.logEvent(E.composerSearchButtonClicked),ws.addPersistedSystemHint(it.Search),/^search\s?$/i.test(t.getCurrentText())&&t.setText(""),t.replaceSlashCommandTokensWithText(),t.focus()},children:a.jsx(Ja,{className:U(e&&"text-brand-purple-800 dark:text-brand-purple-600")})})})})}function ju(){const t=ts(ss.hasSeenComposerSearchButtonTooltip);return!t.isLoading&&t.eligible}function Mu({children:t,highlightTooltip:e}){const s=ju(),n=le(),o=ts(ss.hasSeenComposerSearchButtonTooltip);return s?a.jsx(Sa,{side:"top",show:!0,dismissOnOutsideClick:!0,badge:"none",title:n.formatMessage({id:"WhBf/L",defaultMessage:"The web is now in ChatGPT"}),contentAlign:"center",onDismiss:o.markAsViewed,sideOffset:2,className:"!max-w-2xs",description:n.formatMessage({id:"INHpvZ",defaultMessage:"Search the web for instant answers and links to trusted sources."}),children:a.jsx("div",{children:t})}):a.jsx("div",{children:a.jsx(Fs,{sideOffset:14,label:n.formatMessage({id:"c+4o2s",defaultMessage:"Search the web"}),side:"top",open:e?!0:void 0,onOpenChange:i=>{i&&O.logEvent(E.composerSearchButtonHovered)},children:t})})}function Ru({composerController:t,clientThreadId:e}){const s=$a(e),n=Qa(e,ma.Search),o=cl(e),[i,r]=u.useState([]),[c,l]=u.useState(void 0),[m,f]=u.useState(0);u.useEffect(()=>{r(c?o.filter(_=>_.name.toLocaleLowerCase().startsWith(c.text.toLocaleLowerCase())||_.systemHint.toLocaleLowerCase().startsWith(c.text.toLocaleLowerCase())):[])},[c]);const g=t.useState(_=>_.getSystemHints().length>0);u.useEffect(()=>{const _=k=>{l(F=>!F||!k?k:F.text===k.text&&F.range.from===k.range.to&&F.range.to?F:k)};t.view.dispatch(t.view.state.tr.setMeta(El,{onHintMatch:_}))},[t]);const d=g||!o.length||!i.length||!c;u.useEffect(()=>{d&&f(0)},[d]);const v=i.length,p=u.useCallback(_=>{f(k=>(_(k)%v+v)%v)},[v]),h=i[m],b=({hintToSave:_=h,expectPerfectMatch:k,appendSpace:F=!0})=>{if(!c||!h||k&&_.name.toLowerCase()!==c.text.toLowerCase())return;O.logEvent(E.systemHintSelected,{system_hint:_.systemHint,conversation_id:s??Sn});const P=c.text+_.name.slice(c.text.length);Nl(t.view,{id:_.systemHint,hint:P},c.range,F,n),Bt(t.view)},M=u.useRef(b);M.current=b;const I=u.useRef(p);I.current=p;const T=u.useRef(c);T.current=c;const y=t.view;return u.useEffect(()=>(d||Al(y,_=>{_==="up"?I.current(k=>k-1):_==="down"?I.current(k=>k+1):_==="cancel"?(Bt(y),Pl(y)):_==="submit"?(M.current({expectPerfectMatch:!1}),Bt(y)):_==="checkMatch"&&M.current({expectPerfectMatch:!0,appendSpace:!1})}),()=>Bt(y)),[d,y]),u.useEffect(()=>{d||O.logEvent(E.systemHintListOpened,{conversation_id:s??Sn})},[d]),d?null:a.jsx(Tr,{className:"max-w-60",onMouseDown:_=>{_.preventDefault()},children:i.map((_,k)=>a.jsx("div",{onMouseOver:()=>f(k),onClick:()=>{b({hintToSave:_,expectPerfectMatch:!1}),t.focus()},children:a.jsx(jr,{autoFocus:!1,className:"hover:bg-inherit rounded-lg px-1 py-2",spoofHovered:k===m,children:a.jsx(Eu,{title:_.name,description:_.description,icon:a.jsx(Mr,{svgString:_.logo,className:"icon-lg text-token-text-secondary"}),checked:!1})})},_.systemHint))})}function Eu({title:t,description:e,icon:s,checked:n}){return a.jsxs("div",{className:"inline-flex w-full items-center justify-start gap-1.5 pl-1.5 pr-3",children:[a.jsx("div",{className:"flex h-7 w-7 items-center justify-center gap-2.5",children:s}),a.jsxs("div",{className:"shrink grow basis-0",children:[a.jsx("p",{className:"text-sm font-normal leading-tight text-token-text-primary",children:t}),!!e&&a.jsx("p",{className:"text-[13px] font-normal leading-[18px] text-token-text-secondary",children:e})]}),n&&a.jsx(nl,{className:U("icon-md text-token-text-primary",{"group-hover:hidden":!n})})]})}function Au({composerController:t,clientThreadId:e}){return t instanceof Rl?a.jsx(Ru,{composerController:t,clientThreadId:e}):null}function Nu({suggestions:t,composerController:e,onSelect:s,onChange:n}){const o=so(),i=u.useCallback((l,m,f)=>{s==null||s(l,m,f),o(l,m,f)},[s,o]),[r,c]=u.useState(-1);return u.useEffect(()=>{const l=m=>{if(m.key==="ArrowDown"){const f=r===t.length-1?0:r+1;c(f),n==null||n(f,!0,t[f])}else if(m.key==="ArrowUp"){m.preventDefault();const f=r<=0?t.length-1:r-1;c(f),n==null||n(f,!0,t[f])}else m.key==="Enter"&&t[r]&&i(t[r],t,r)};return e.subscribe("keydown",l)},[t,r,n,i,e]),u.useEffect(()=>e.subscribe("blur",()=>{c(-1),n==null||n(-1,!1)}),[e,n]),a.jsx(ge.ul,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"hidden w-full flex-col p-2.5 group-focus-within:block",children:t.map((l,m)=>a.jsxs(ge.li,{initial:{opacity:0,translateY:4},animate:{opacity:1,translateY:0},transition:{delay:m*.03},exit:{opacity:0,translateY:4},className:"w-full",children:[m>0&&a.jsx("div",{className:U("h-[1px] opacity-60",r===m||r===m-1?"mx-2 bg-token-main-surface-secondary":"bg-token-border-light")}),a.jsxs("button",{className:U("inline w-full cursor-pointer items-center justify-start rounded-lg px-2.5 py-3 text-start",r===m?"bg-token-main-surface-secondary":"bg-token-main-surface-primary"),onClick:f=>{f.preventDefault(),i(l,t,m)},onMouseEnter:()=>{c(m),n==null||n(m,!1,l)},onMouseLeave:()=>{c(-1),n==null||n(-1,!1,l)},children:[a.jsx("span",{className:"text-token-text-tertiary",children:l.title}),a.jsx("span",{className:"text-token-text-primary",children:l.body})]})]},l.id??m))})}const Pu=1,Du=3e3;function Fu({files:t,className:e}){const s=Xt();return a.jsx("div",{className:e,children:t.map(n=>a.jsx(Ga,{width:s?"normal":"wide",onRemoveFileClick:()=>Ke.remove(n.tempId,"none"),file:n.file,fileId:n.fileId??void 0,contextConnectorInfo:n.contextConnectorInfo,loadingPercentage:n.status===qr.Uploading?n.progress:void 0},n.tempId))})}function Ou({onAbortCompletion:t,onCreateNewCompletion:e,onContinueGenerating:s,currentModelId:n,clientThreadId:o,isNewThread:i,isCompletionInProgress:r,className:c,disabled:l=!1,disabledReason:m,canPause:f=!1,canContinue:g=!1,suggestions:d,isInteractableSharedThread:v,composerContainerRef:p,composerController:h,autocompletions:b,requiresFileUpload:M,onComposerInput:I,onComposerChange:T,onAutocompleteSelect:y,headerClassName:_,hideHeader:k,setComposerBarElement:F,onTaggingDropdownOpen:P,onTaggingDropdownClose:D}){var gn,pn;const R=ka(),K=Qt(),{isUnauthenticated:W}=wt(),H=le(),Q=dt(o),ee=is(o),ae=ua(),{gizmoEditorData:q,mode:j,getGizmoId:S}=os(),A=fa(),oe=aa(),te=ui(),ce=ns(),se=$a(o),$=!!mi(),Y=Rr(),fe=!!fi(),[ne,x]=u.useState({}),[Z,pe]=u.useState(!1),[G,re]=u.useState(!1),_e=u.useRef(!1),ue=ll(),ve=n!==null?ue[n]:void 0,De=Y.has(it.Search);let L=Ys(o),Se=L&&"gizmo"in L?L.gizmo:void 0;const[ie,tt]=u.useState(null);ie!==null&&(L={gizmo:ie,gizmo_id:ie.gizmo.id,kind:Ce.GizmoInteraction},Se=ie);const Le=Yt(ve,L);let Tt=!1;Er(L)&&(Se==null?void 0:Se.gizmo.id)===Ar&&(Tt=!0);const ut=!l&&Le!==et.None&&!Tt&&!W,Ve=Ea(ve,L),Re=Na(ve,L);let J=bt(w=>w.files);const[Ie]=u.useState(()=>Nr());j==="magic"?J=J.filter(w=>w.gizmoId!=null):J=J.filter(w=>w.gizmoId==null);const We=J.length>0,jt=bt(Ba.hasUploadInProgress),st=h.useState(w=>!w.isEmpty()),Be=We?!jt:st,nt=(Le===et.Multimodal?Bs:zs)-J.length,Mt=nt<=0,at=Be&&!l&&!r&&!fe,[nn,vo]=u.useState(!1),So=dl(),bo=n||So.id,wo=Qa(o,ma.Search),rs=!l&&wo&&!Se&&!De,ko=(gn=ue[bo])==null?void 0:gn.tags,{targetedContent:Rt,setTargetedContent:Et}=Pr(),V=Rt!=null&&Rt.isFocusedViewContent&&!ce?void 0:Rt,{rebaseSystemMessageContent:an}=za();u.useEffect(()=>{Dr()}),u.useEffect(()=>{if(!(R!=null&&R.id))return;const w=Tn.getAndReset(R==null?void 0:R.id,se);w&&h.setText(w.inputText)},[R==null?void 0:R.id,se,h]),u.useEffect(()=>{nn!==at&&(vo(at),at&&(ha(!0).then(w=>{Kt.startEnforcement(w),ks.startEnforcement(w),Ss.startEnforcement(w)}),A!=null&&A.includes(Rs.SharedWebsocket)&&It.registerIfNotConnected()))},[at,nn,L==null?void 0:L.kind,A]);const ze=Ra(ve,L),{handleFileAccepted:Co}=fo(H,Yt(ve,L),Ve,"mouse",S,ze==null?void 0:ze.attachments),{getInputProps:Io,open:To}=Pa({disabled:l||!ut||Mt,noClick:!0,onDropAccepted:Co,onDropRejected:w=>mo(w,H,Le),multiple:!0,maxSize:Da,maxFiles:nt,...Aa(Re)}),on=da(Ie),rn=u.useCallback(()=>{h.eraseContent(),on.clearMessages(),h.resize(Pu),Fr();for(const w of J)Ke.remove(w.tempId,"none")},[J,on,h]),mt=async(w,xe)=>{var yn;if(w==null||w.preventDefault(),l||!Be&&!xe||!L||Oe.isLoading(o)!==!1)return;const Te=new Os;pe(!0);const Ue=h.getContentToSend(),Qe=Ue.content.replace(/[\u{E0000}-\u{E007F}]+/gu,""),Ee=`${Q}-nextPrompt`,Xe=Vr({namespace:Mn.CompletionRequest,key:Ee,opts:{expectedTimingLogs:[{name:"prompt_submitted",expectedInMs:3e3}]}}),{content:qo,attachments:xn}=Wr(Qe,ve,L),ds=[];an&&ds.push(pi(an));const us={...L};"gizmo"in us&&delete us.gizmo;const ms=h.getSystemHints();let pt={promptId:Ee,content:qo,eventMetadata:{eventSource:w?"mouse":"keyboard"},completionMetadata:{suggestions:d,conversationMode:us,systemHints:ms},messageMetadata:{...xn.length>0&&{attachments:xn},...ie&&{gizmo_id:ie==null?void 0:ie.gizmo.id},...ne,...ms.length>0&&{system_hints:ms},...!!Ue.metadata&&{serialization_metadata:Ue.metadata}},appendMessages:ds.length>0?ds:void 0,turnTracker:Te};pt=$r(pt),V!=null&&V.createNewCompletionParams&&(pt=await V.createNewCompletionParams(pt)),Xe.logTiming("request_params_ready"),await e(pt),(yn=V==null?void 0:V.onCreateCompletion)==null||yn.call(V,{serverThreadId:se,currentLeafId:Q}),(V==null?void 0:V.shouldPersistAcrossMessages)!==!0&&Et(void 0),jn.hideThreadHeader(),rn(),pe(!1),Xe.logTiming("prompt_submitted"),Kr({namespace:Mn.CompletionRequest,key:Ee}),d!==void 0&&(qe.logEvent("chatgpt_prompt_ignore_suggestions"),O.logEvent(E.promptIgnoreSuggestions))},cn=u.useRef(mt);u.useLayoutEffect(()=>{cn.current=mt}),u.useEffect(()=>hi.subscribe(gi.SEND_PROMPT,({prompt:w})=>{h.setText(w),cn.current(void 0,!0)}),[h]);const jo=w=>{Et(w.targetedReply),w.targetedReply&&(h.focus(),O.logEvent(E.targetedReplyButtonClicked,{conversationId:se,sourceMessageId:w.messageId}))},ln=u.useCallback(()=>{var w;(w=V==null?void 0:V.onCleared)==null||w.call(V,{serverThreadId:se,currentLeafId:Q}),Et(void 0),h.focus()},[Q,se,V,Et,h]),dn={Enter:{validator:w=>{const xe=w.isComposing||w.keyCode===229,Te=G&&_e.current;return at&&!Te&&(w.metaKey||(oe||qt)&&!w.shiftKey&&!xe)},handler:w=>{w.preventDefault(),mt()}},Escape:{validator:w=>!w.isComposing,handler:w=>{f&&r&&(t("",ee),O.logEvent(E.pauseCompletion,{threadId:C.getServerThreadId(o),currentLeafId:C.getTree(o).getMessageId(Q),eventSource:"keyboard"})),w.target.value===""&&ln()}}},ft=u.useRef(dn);ft.current=dn;const un=u.useRef(null),ht=ul(ko,L==null?void 0:L.kind),[cs,At]=u.useState(!1),[ls,mn]=u.useState(!1),Nt=ht&&cs,fn=h.isReady();u.useEffect(()=>h.subscribe("keydown",w=>{var Ue,Qe;h.acceptLegacyKeydown()&&((Ue=ft.current[w.key])!=null&&Ue.validator(w))&&ft.current[w.key].handler(w);const Te=h.getCurrentText();if(w.key==="@"){const Ee=h.getSelectionStart(),Xe=Te.substring(0,Ee);(!Xe||/\s$/.test(Xe)||Ee===0)&&((Qe=un.current)==null||Qe.handleClose(),setTimeout(()=>At(!0),10))}else cs&&At(!1);if(w.key==="Escape"&&(tt(null),re(!1)),rs){let Ee;w.key==="Backspace"?Ee=Te.substring(0,Te.length-1):Ee=Te+w.key,/^search\s?$/i.test(Ee)?mn(!0):ls&&mn(!1)}De&&w.key==="Escape"&&ws.removePersistedSystemHint(it.Search)}),[h,fn,cs,ls,rs,De]),u.useEffect(()=>{const w=Object.fromEntries(Object.keys(ft.current).map(xe=>[xe,Ue=>{const Qe=ft.current[xe];if(!Qe||h.acceptLegacyKeydown())return!1;const{validator:Ee,handler:Xe}=Qe;return Ee(Ue)?(Xe(Ue),!0):!1}]));h.registerKeyHandlers(w)},[h,fn]),u.useEffect(()=>h.subscribe("paste",w=>{Or({event:w,intl:H,clientThreadId:o,conversationMode:L,currentModelConfig:ve,getEditorGizmoId:S,modelSupportedImageMimeTypes:Ve})}),[H,o,L,ve,S,Ve,h]);const Mo=w=>{$||tt(w),h.trimLeadingText("@"),Zt(),At(!1)},Ro=au(o,Ie,H,Ve,ze==null?void 0:ze.attachments),Eo=u.useCallback(()=>{t("",ee),O.logEvent(E.pauseCompletion,{threadId:C.getServerThreadId(o),currentLeafId:C.getTree(o).getMessageId(Q),eventSource:"mouse"}),Zt()},[t,o,ee,Q]),hn=u.useCallback(()=>{Tn.set(R==null?void 0:R.id,se,h.getCurrentText())},[se,R==null?void 0:R.id,h]);u.useEffect(()=>{q||Z||h.focus()},[Z,h]),u.useEffect(()=>{q||Ke.reset()},[n,q]),u.useEffect(()=>{(!ht&&ie||$)&&tt(null)},[ht,ie,$]);const[Ao,No]=(()=>{switch(m){case"workspaceDisallowsGizmo":return[Fe.disallowedByWorkspacePlaceholder,!0];case"feedbackRequired":return[Fe.disabledFeedbackPlaceholder,!0];case"noModelsAvailable":return[Fe.noModelsAvailablePlaceholder,!0];case"requiresPluginsToBeInstalled":return[Fe.requiresPluginsToBeInstalled,!0];case"loadingPlugins":return[Fe.loading,!0];case"noTestGizmoId":return[Fe.noTestGizmoId,!0];default:return v?[Fe.continueSharedConversationPlaceholder,!1]:(V==null?void 0:V.placeholderTextOverride)!=null?[V.placeholderTextOverride,!1]:[Fe.placeholderWithName,!1]}})(),Po=H.formatMessage(Ao,{name:q!=null?j==="magic"?ml:q.name||"GPT":(Se==null?void 0:Se.gizmo.display.name)??"ChatGPT"});u.useEffect(()=>h.subscribe("input",()=>{Lr.getState().isThreadHeaderVisible&&jn.hideThreadHeader(),re(!0)}),[h]),u.useEffect(()=>{if(I)return h.subscribe("input",()=>{I==null||I()})},[h,I]),u.useEffect(()=>{if(T)return h.subscribe("change",()=>{T==null||T()})},[h,T]),u.useEffect(()=>h.subscribe("focus",()=>{re(!0)}),[h]);const Do={clientThreadId:o,uploadType:Le,modelAcceptedMimeTypes:Re,modelSupportedImageMimeTypes:Ve,attachmentsProductFeature:ze==null?void 0:ze.attachments,getInputProps:Io,openFileDialog:To,historyDisabled:te,onOauthRedirect:hn,highlightTooltip:M&&!We},Je=[];!l&&!Mt&&ut&&!De&&Je.push(a.jsx(yu,{...Do},"file-upload-button")),rs&&Je.push(a.jsx(Tu,{composerController:h,highlightTooltip:ls},"search-button"));const Fo=We&&a.jsxs(a.Fragment,{children:[j==="magic"&&a.jsx("div",{className:"m-2 mb-0 rounded-lg bg-token-main-surface-secondary p-2 text-xs text-token-text-secondary",children:a.jsx(z,{...Fe.gizmoKnowledgeWarning})}),a.jsx(Fu,{files:J,className:"flex flex-nowrap gap-2 overflow-x-auto pb-1.5 pt-[7px]"})]}),Oo=No?"disabled":"default",Pt=r&&f?"streaming":!(at||De)||Z?"disabled":"idle",gt=u.useRef(null),ot=u.useRef(null),{layer:Lo}=bn("387752763"),{layer:Bo}=bn("51287004"),zo=Lo.get("enable_slash_commands",!1)&&(W||!(K!=null&&K.isFree())||Bo.get("enable",!1)),Uo=n&&[fl,hl].includes(n),Go=zo&&(L==null?void 0:L.kind)===Ce.PrimaryAssistant&&!De;u.useEffect(()=>{const w=()=>{gt.current!=null&&Pe.addAction("composer_state_disabled",{threadId:C.getServerThreadId(o),disabledReason:gt.current})};if(Be&&Pt==="disabled"){let xe="unknown";l?xe=m??"component_disabled_unknown":r?xe="completion_in_progress":fe?xe="thread_hard_blocked":Z&&(xe="starting_new_completion_request"),gt.current!==xe&&(ot.current&&clearTimeout(ot.current),ot.current=setTimeout(w,Du)),gt.current=xe}else gt.current=null;return()=>{ot.current&&(clearTimeout(ot.current),ot.current=null)}},[o,Be,Pt,l,m,r,fe,Z]);const Dt=[];if(V!=null&&V.label&&Dt.push({type:V.type,value:V.label,onRemoveRegion:ln}),Y!=null&&Y.has(it.Search)&&Dt.push({type:"system_hint",value:H.formatMessage(Lu.searchMode),icon:a.jsx("span",{className:"flex h-7 w-7 items-center justify-center rounded-full bg-brand-purple/15",children:a.jsx(Ja,{className:"h-[20px] w-[20px] shrink-0 text-[#814CFF]"})}),onRemoveRegion:()=>{ws.removePersistedSystemHint(it.Search),h.focus()}}),ie!==null){const w=!!((pn=ie.gizmo.tags)!=null&&pn.includes(Ua.FirstParty));Dt.push({type:"mention",value:ie.gizmo.display.name,icon:a.jsx(jl,{isFirstParty:w,src:ie.gizmo.display.profile_picture_url,className:"icon-md"}),onRemoveRegion:()=>{tt(null),h.focus()}})}u.useEffect(()=>{(!b||b.length===0||!G)&&(_e.current=!1)},[b,G]);const Ho=(w,xe,Te)=>{_e.current=w>=0,xe&&h.setText(Te?`${Te.title}${Te.body}`:"")};return u.useEffect(()=>{Nt?P==null||P():D==null||D()},[Nt,P,D]),a.jsxs(Br.Provider,{value:Ie,children:[a.jsx(zr,{onOauthRedirect:hn,children:a.jsx("form",{className:c,onSubmit:mt,children:a.jsxs("div",{className:"relative flex h-full max-w-full flex-1 flex-col",children:[!k&&a.jsx(Rd,{className:_}),a.jsxs("div",{ref:p,className:"group relative flex w-full items-center",children:[i&&"from_template_row"in ae.query&&a.jsx("button",{type:"button",onClick:()=>{ae.push("/",void 0,{shallow:!0})},className:"mr-2 flex h-8 w-8 items-center justify-center text-token-text-tertiary hover:text-token-text-secondary",children:a.jsx(al,{className:"icon-lg"})}),ht&&!!se&&a.jsx(dd,{ref:un}),Nt&&a.jsx("div",{className:U("absolute bottom-16 w-full space-y-2",bs.TagGpt),children:a.jsx(_l,{onClick:w=>Mo(w),onClose:()=>{At(!1),h.focus()}})}),Go&&a.jsx("div",{className:U("absolute bottom-16 space-y-2",bs.TagGpt),children:a.jsx(Au,{composerController:h,clientThreadId:o})}),a.jsx(_u,{type:te?"temporary":"default",ref:F,replyRegions:Dt,placeholder:Po,inputState:Oo,composerController:h,leftSideActions:Je,state:Pt,onSubmit:Pt==="streaming"?Eo:mt,renderFiles:Fo,currentLeafId:Q,clientThreadId:o,gizmoId:Se==null?void 0:Se.gizmo.id}),G&&b&&b.length>0&&!Nt&&h.canShowAutocompletion()&&a.jsx("div",{className:U("absolute left-0 top-full z-10 mt-2 box-border w-full bg-token-main-surface-primary",(Je==null?void 0:Je.length)>0?`px-${Je.length*8}`:"pl-0"),children:a.jsx(Nu,{suggestions:b,composerController:h,onSelect:y,onChange:Ho})})]}),a.jsx(Ur,{composerController:h,parsedDocumentHandler:Ro})]})})}),a.jsx(Yd,{canUseInlineTagging:ht,isDisabled:l,clientThreadId:o,currentLeafId:Q,currentRequestId:ee,canContinue:g,composerController:h,setPromptInputMetadata:x,suggestions:d,isNewThread:i,onCreateNewCompletion:e,onContinueGenerating:s,onResetState:rn,conversationMode:L}),L!=null&&!Uo&&Gr.includes(L.kind)&&a.jsx(Hr,{onTargetedReply:jo})]})}const Lu=Me({searchMode:{id:"LSO1pB",defaultMessage:"Search the web"}});function Bu(t){const e=u.useContext(xi);return({id:n,requestedModelId:o,eventMetadata:i,focusOnNewCompletion:r=!0,variantPurpose:c="none",useDefaultModel:l,appendMessages:m,conversationMode:f,juice:g=void 0,turnTracker:d,extraStreamParams:v})=>{var M;const h=C.getTree(t).getParentPromptNode(n),b=h.id;e({type:Ze.Variant,promptId:b,requestedModelId:o,eventMetadata:i,cancelActiveRequests:!1,focusOnNewCompletion:r,useDefaultModel:l,completionMetadata:{variantPurpose:c,conversationMode:f,juice:g,systemHints:(M=h.message.metadata)==null?void 0:M.system_hints},appendMessages:m,turnTracker:d,extraStreamParams:v})}}function zu(t){var o,i,r,c,l;const e=((o=t.message)==null?void 0:o.author.role)===be.User,s=((i=t.metadata)==null?void 0:i.err)!=null&&((r=t.metadata)==null?void 0:r.errCode)!==vt.ContentPolicy,n=((c=t.metadata)==null?void 0:c.errCode)===vt.ModelIncompatibility;return((l=t.metadata)==null?void 0:l.canRetry)===!1||n?!1:e||s}function wf(t){return t.composerController?a.jsx($n,{...t,composerController:t.composerController}):a.jsx(Dl,{children:e=>a.jsx($n,{...t,composerController:e})})}function $n({clientThreadId:t,isNewThread:e,currentModelId:s,showPromptStarters:n,onRequestCompletion:o,composerContainerRef:i,composerController:r,setComposerBarElement:c}){const l=Bc(),m=Zr(),f=lt(g=>{const d=Oe.getCurrentNode(t,g);return zu(d)});return Yr(r),!m&&f?a.jsx(Uu,{clientThreadId:t}):a.jsxs(a.Fragment,{children:[a.jsx(id,{clientThreadId:t}),a.jsx(kl,{clientThreadId:t,isStaticSharedThread:l,showInlineEmbeddedDisplay:!1,withVerticalPadding:!1,withHorizontalPadding:!0,children:a.jsx(Cl,{children:a.jsx(Gu,{composerContainerRef:i,composerController:r,clientThreadId:t,currentModelId:s,isNewThread:e,showPromptStarters:n,setComposerBarElement:c,onRequestCompletion:o})})})]})}function Uu({clientThreadId:t}){const e=Bu(t),s=lt(i=>{var c;return((c=Oe.getCurrentNode(t,i).metadata)==null?void 0:c.errCode)===Cs}),n=Jr(i=>i.isoDate),o=dt(t);return s&&n!=null&&n!==""?null:a.jsxs("div",{children:[a.jsx("div",{className:"mb-3 text-center text-xs",children:a.jsx(z,{...Kn.errorGeneratingResponse})}),a.jsx("div",{className:"flex items-center md:mb-4",children:a.jsx(kt,{as:"button",color:"primary",onClick:()=>{const i=new Os;e({id:o,eventMetadata:{eventSource:"mouse"},conversationMode:Oe.getConversationMode(t),turnTracker:i})},className:"m-auto",icon:Ya,children:a.jsx(z,{...Kn.regenerateResponse})})})]})}function Gu({clientThreadId:t,currentModelId:e,isNewThread:s,onRequestCompletion:n,showPromptStarters:o,composerContainerRef:i,composerController:r,autocompletions:c,requiresFileUpload:l,onComposerInput:m,onComposerChange:f,onAutocompleteSelect:g,headerClassName:d,hideHeader:v,setComposerBarElement:p,onTaggingDropdownClose:h,onTaggingDropdownOpen:b}){var ut,Ve;const M=dt(t),I=is(t),T=Ca(),{isUnauthenticated:y}=wt(),k=zc(t)===ga.PENDING,F=Uc({clientThreadId:t,conversationLeafId:M}),P=Ls(I),D=(P||k)&&!F,R=dt(t),K=!y,W=pa(),{isOpen:H,onClose:Q}=Qr(),ee=u.useCallback((Re,J)=>{O.logEvent(E.continueCompletion),n({type:Ze.Continue,promptId:Re,eventMetadata:{eventSource:"mouse"},cancelActiveRequests:!1,completionMetadata:{conversationMode:Oe.getConversationMode(t)},turnTracker:J})},[n,t]),ae=xa(),q=u.useCallback(async(Re,J)=>{var st;const Ie=C.getServerThreadId(t);It.stopConversation(Ie);const We=C.getTree(t);!We.hasReceivedServerCompletion&&!W&&((st=We.getParent(J).metadata)==null?void 0:st.errCode)!==vt.ContentPolicy&&setTimeout(()=>{Ts.onCreateFinished(ae,Ie,W)},500),Ie&&qe.checkGate("3922476776")&&await Ye.stopConversationProcess(Ie),qs.abortRequest(J)&&C.updateTree(t,Be=>{const nt=C.getThreadCurrentLeafId(t);Be.updateNodeMessageMetadata(nt,{finish_details:{type:"interrupted"}})})},[t,W,ae]),j=u.useCallback(async({promptId:Re,content:J,eventMetadata:Ie,completionMetadata:We,messageMetadata:jt,appendMessages:st,turnTracker:Be})=>{const nt=C.getThreadCurrentLeafId(t);C.updateTree(t,Mt=>{Mt.addNode(Re,J,nt,be.User,void 0,jt)}),await n({type:Ze.Next,promptId:Re,eventMetadata:Ie,cancelActiveRequests:!0,completionMetadata:We,appendMessages:st,turnTracker:Be})},[t,n]),S=Gc(t,M),A=Hc(t,M),oe=!F&&(P||k),te=u.useMemo(()=>oe?!1:!S&&A,[S,A,oe]),ce=oe&&e!=="gpt-4-pbrowse",se=qc(t),$=Wa(t),Y=Ks($).data,{promptStarters:fe,isSuccess:ne}=Il(s&&!se,t,4),x=ja(),Z=(()=>{var Re,J;if((x==null?void 0:x.messageId)===((J=(Re=C.getTree(t).getLastValidNode(M))==null?void 0:Re.message)==null?void 0:J.id))return x==null?void 0:x.suggestions;if(o&&!se&&ne&&!K)return fe})(),pe=C.getTree(t),G=pe.countMessagesByAuthor(be.User),re=u.useRef(),_e=u.useRef();let ue=!1;re.current==G&&_e.current==R?ue=!0:re.current!==G&&_e.current!==R&&(ue=!0,re.current=G,_e.current=R);const ve=pe.getNodeByIdOrMessageId(M),De=ue&&((ut=ve==null?void 0:ve.message)==null?void 0:ut.author.role)==be.Assistant&&Es(ve.message),L=gl(),Se=yi(),ie=(()=>{var Ie;if(((Ie=Y==null?void 0:Y.gizmo.tags)==null?void 0:Ie.includes(Ua.WorkspaceDisabled))&&!Se)return"workspaceDisallowsGizmo";if(L.size){if(T.displayingSideBySideFeedback&&T.unskippable)return"feedbackRequired"}else return"noModelsAvailable";const J=Oe.getConversationMode(t);return(J==null?void 0:J.kind)===Ce.GizmoTest&&J.gizmo_id==null?"noTestGizmoId":null})(),tt=Vc(t),Le=Ws(t),Tt=(Ve=_i("15117983"))==null?void 0:Ve.value;return a.jsxs(a.Fragment,{children:[(s||De)&&H?a.jsx(Xr,{onClose:Q}):null,Tt&&Le&&Le.kind===Ce.PrimaryAssistant&&Le.plugin_ids&&Le.plugin_ids.length>0?a.jsx(Hu,{}):a.jsx(Ou,{composerContainerRef:i,composerController:r,clientThreadId:t,onCreateNewCompletion:j,onAbortCompletion:q,onContinueGenerating:ee,currentModelId:e,isNewThread:s,isCompletionInProgress:D,className:"w-full",canContinue:te,suggestions:Z??[],disabled:!!ie,disabledReason:ie??void 0,canPause:ce,isInteractableSharedThread:tt,autocompletions:c,requiresFileUpload:l,onComposerInput:m,onComposerChange:f,onAutocompleteSelect:g,headerClassName:d,hideHeader:v,setComposerBarElement:p,onTaggingDropdownClose:h,onTaggingDropdownOpen:b},t)]})}function Hu(){return a.jsxs("div",{className:"mx-auto flex max-w-md flex-col items-center justify-center gap-2 rounded-xl border border-token-border-light bg-token-main-surface-primary p-6 shadow-lg",children:[a.jsx("span",{className:"text-token-text-primary",children:a.jsx(z,{id:"PluginsDecrepatedNotice.pluginsDeprecationTitle",defaultMessage:"Conversations with plugins are archived"})}),a.jsx("span",{className:"text-token-text-secondary",children:a.jsx(z,{id:"PluginsDecrepatedNotice.pluginsDeprecationSubtitle",defaultMessage:"Explore GPT Store to find a replacement"})}),a.jsxs("a",{href:"https://chat.openai.com/gpts",className:"text-green-500 hover:cursor-pointer dark:text-green-400",children:[a.jsx(z,{id:"PluginsDecrepatedNotice.pluginsDeprecationGptStoreLink",defaultMessage:"Explore GPTs"}),a.jsx("span",{className:"ml-2",children:a.jsx(z,{id:"PluginsDecrepatedNotice.pluginsDeprecationGptStoreLinkArrow",defaultMessage:"→"})})]})]})}const Kn=Me({errorGeneratingResponse:{id:"PromptTextarea.errorGeneratingResponse",defaultMessage:"There was an error generating a response"},regenerateResponse:{id:"PromptTextarea.regenerateResponse",defaultMessage:"Regenerate"}}),qu=me(()=>de(()=>import("./brcyt0u3f2aodae8.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29])).then(t=>t.default)),Vu=me(()=>de(()=>import("./sso-ovy7jl8cchqxgm0e.js").then(t=>t.j),__vite__mapDeps([30,1,2,3,31,5,6,15,32,33,34,35,36,37,12,38,7,14,39,40,41,42,43,28,17,44,45,46,47,48,20,23,26,49,21,22,50,51,27,52,53,54,55,56,57,58,59,60,25,61,62,63,64,65,19,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,9,10,4,8,11,13,16,85])).then(t=>t.default).catch(()=>Ct)),Wu=Ae.div`flex gap-2 flex-wrap mt-1 max-w-[80%] justify-end`,$u=Ae.div`flex flex-col gap-2`,Ku=({parts:t,attachments:e,isUserTurn:s,clientThreadId:n})=>{const o=Xt(),i=Zs(n),r=Js(),c=vi.getImageAssetPointersFromParts(t),l=new Set(c.map(p=>as(p.asset_pointer))),f=ns()||o,g=(e??[]).filter(p=>Ia(p.name)),d=(e??[]).filter(p=>p.id==null||l.has(p.id)?!1:r||i?!g.includes(p):!0);return(r||i?(d.length>0||g.length>0)&&s:d.length>0&&s)?a.jsxs(a.Fragment,{children:[a.jsxs(Wu,{children:[d.map(p=>a.jsx(Ga,{file:p.name,fileId:p.id,contextConnectorInfo:ec(p.context_connector_info),width:o?"normal":"wide",alwaysShowData:!0},p.id)),i&&g.map(p=>a.jsx(Vu,{visualization:Rn(p)},p.id))]}),r&&!i&&a.jsx($u,{className:U(!f&&"w-[80%]"),children:g.map(p=>a.jsx(qu,{clientThreadId:n,visualization:Rn(p)},p.id))})]}):null};function go(t){return Es(t)&&!Si(t)}const Gt=50,Zu=95;function Yu(t,e){if(t<=e)return t/e*Gt;{const s=Gt,n=Zu-Gt,o=t-e,r=-(Gt/e)/n;return s+n*(1-Math.exp(r*o))}}class Ju{constructor(){B(this,"mostRecentCompletionRequest");B(this,"loggedRequestIds",new Set)}onCompletionRequestStarted(e){this.mostRecentCompletionRequest={requestId:e,timestamp:Date.now()}}onDisplayTextAfterBrowsingSession(e,s){const n=this.mostRecentCompletionRequest;if(n!=null&&!this.loggedRequestIds.has(n.requestId)){const i=C.getThreadConversationTurns(e,s).find(r=>r.messages.some(c=>c.message.id===s));i!=null&&i.messages.some(r=>r.nodeId===n.requestId)&&(O.logEvent(E.browsingTimeToFirstTextToken,{messageId:s,timeMs:Date.now()-n.timestamp}),this.loggedRequestIds.add(n.requestId))}}}const po=new Ju;function Qu(t){var o;const e=t.find(i=>{var r;return((r=i.message.metadata)==null?void 0:r.image_search_results)!==void 0});return(((o=e==null?void 0:e.message.metadata)==null?void 0:o.image_search_results)??[]).slice(0,5)}function Xu({messages:t}){const e=Qu(t),s=tc();return e.length===0?null:a.jsx("div",{className:U({"mb-2":!0,"grid grid-flow-col gap-3":e.length>1,"w-1/3":e.length===1}),children:e.filter(({contentUrl:n})=>s.has(n)).map((n,o)=>a.jsx("a",{href:n.hostPageUrl,target:"_blank",rel:"noreferrer",children:a.jsx("img",{src:n.contentUrl,alt:n.name,className:"aspect-square rounded-xl object-cover"})},o))})}const em=me(()=>de(()=>import("./sso-ovy7jl8cchqxgm0e.js").then(t=>t.k),__vite__mapDeps([30,1,2,3,31,5,6,15,32,33,34,35,36,37,12,38,7,14,39,40,41,42,43,28,17,44,45,46,47,48,20,23,26,49,21,22,50,51,27,52,53,54,55,56,57,58,59,60,25,61,62,63,64,65,19,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,9,10,4,8,11,13,16,85])).then(t=>t.default).catch(()=>Ct));function xo({attachments:t,citations:e,contentReferences:s,className:n,clientThreadId:o,displayParts:i,isCompletionInProgress:r,id:c,isActivelyStreaming:l,isUserTurn:m,turnIndex:f,isFeedbackEnabled:g,messages:d,onRequestMoreCompletions:v,parts:p,prevGroupedMessageType:h,prevGroupedMessages:b,showEditButton:M,onEnterEdit:I,size:T="medium"}){var R,K;const y=Zs(o),_=d.length>1,{flagSeverity:k,shouldHideContent:F}=no(_?void 0:d[0]),P=!p.some(W=>W!==""),D=((R=d[0].message.metadata)==null?void 0:R.targeted_reply_label)??((K=d[0].message.metadata)==null?void 0:K.targeted_reply);return u.useEffect(()=>{!P&&h===N.Browsing&&po.onDisplayTextAfterBrowsingSession(o,d[0].message.id)},[P,d,o,h]),a.jsxs("div",{"data-message-author-role":d[0].message.author.role,"data-message-id":d[0].message.id,dir:"auto",className:U(n,"text-message flex w-full flex-col items-end gap-2 whitespace-normal break-words [.text-message+&]:mt-5"),children:[D&&a.jsxs("div",{className:"mb-1 ml-6 mt-1 flex items-start gap-1.5 text-sm font-normal text-token-text-tertiary sm:ml-7 lg:ml-8",children:[a.jsx($s,{className:"icon-md mt-1 shrink-0"}),a.jsx("p",{className:"mr-2 line-clamp-3",children:D})]}),m&&y&&a.jsx(em,{messages:d}),a.jsx(sc,{messages:d}),a.jsx(tm,{parts:p,attachments:t,isUserTurn:m,isCompletionInProgress:r,turnIndex:f,displayParts:i,isActivelyStreaming:l,shouldHideContent:F,showEditButton:M,onEnterEdit:I,clientThreadId:o,id:c,isEmpty:P,prevGroupedMessageType:h,prevGroupedMessages:b,flagSeverity:k,messages:d,citations:e,contentReferences:s,size:T}),a.jsx(Fl,{message:_?void 0:d[0],id:c,isFeedbackEnabled:g,onRequestMoreCompletions:v,clientThreadId:o,isUserTurn:m}),a.jsx(nc,{isUserTurn:m,message:_?void 0:d[0]}),!m&&!l&&b&&h===N.SearchResult&&a.jsx(Xu,{messages:b})]})}function tm({clientThreadId:t,id:e,displayParts:s,isCompletionInProgress:n,turnIndex:o,isActivelyStreaming:i,shouldHideContent:r,showEditButton:c=!1,onEnterEdit:l,isEmpty:m,prevGroupedMessageType:f,prevGroupedMessages:g,messages:d,citations:v,contentReferences:p,size:h,isUserTurn:b,parts:M,attachments:I}){var ce,se;const T=le(),y=ac(s),[_,k]=u.useState({}),[F,P]=u.useState(!1),D=oc(),{streamingContext:R}=ic();u.useEffect(()=>{D&&(R.setOnStylesUpdatedCallback(k),R.onStreamingChanged(n),R.setOnResetCallback(()=>P(!1)),n&&(P(!0),k(R.createTopLevelStyles())))},[D,n,R]);const K=rc(),W=(ce=d[0].message.metadata)==null?void 0:ce.gizmo_id,H=(se=d[0].message.metadata)==null?void 0:se.serialization_metadata,Q=Wc(d[0].message).length,ee=u.useMemo(()=>({clientThreadId:t,messageId:e,turnIndex:o}),[t,e,o]),ae=cc(d[0].message),q=!!W&&K.includes(W),j=u.useCallback($=>{lc.open($,o,e)},[o,e]),S=a.jsx(Ku,{parts:M,attachments:I,isUserTurn:b,clientThreadId:t},"files-and-tables"),A=!!(I!=null&&I.length||s.some($=>$.type==="images")),oe=s.map(($,Y)=>{var fe;if($.type==="transcription"){const ne=r?null:$.text;let x=null;return b&&r?x=a.jsx("span",{className:"italic opacity-30",children:a.jsx(z,{...Ht.contentRemoved})}):b&&ne!=null?x=ne.trim().length===0?a.jsx("span",{className:"italic opacity-30",children:a.jsx(Lt,{text:T.formatMessage(Ht.transcriptUnavailable),customSymbolOffsets:void 0})}):a.jsx("span",{className:"italic opacity-65",children:a.jsx(Lt,{text:`“${ne.trim()}”`,customSymbolOffsets:void 0})}):!b&&ne!=null&&(x=a.jsx(Lt,{text:ne,customSymbolOffsets:void 0})),a.jsx(hs,{containsImagesOrAttachments:A,isUserTurn:b,showEditButton:c,onEnterEdit:l,children:x},Y)}else if($.type==="text"){const ne=r?null:$.text;if(!m&&!r&&!b){const x=f===N.CodeInterpreter?g==null?void 0:g.map(_e=>_e.message):void 0,{text:Z,contentReferences:pe}=dc(y,v,p,q),{processedText:G,displayedContentReferences:re}=uc(Z,pe,i?void 0:x);return a.jsx(mc.Provider,{value:{analyticsMetadata:ee,message:d[0].message,contentReferences:re,onShowSearchResults:j,numImageResults:Q,isActivelyStreaming:i,useSafeUrls:!0},children:a.jsx(Vs,{clientThreadId:t,messageId:e,isStreamingOrProcessing:F,size:h,className:U(i&&!D&&"result-streaming",ae&&"headers-v2"),children:G===""?"&#8203;":G})},Y)}else if(m&&i&&!b)return D?a.jsx("div",{className:"pulsing-dot"},Y):a.jsx("div",{className:"result-streaming",children:a.jsx("div",{children:a.jsx("pre",{})})},Y);return a.jsx(hs,{containsImagesOrAttachments:A,isUserTurn:b,showEditButton:c,onEnterEdit:l,children:b&&r?a.jsx("span",{className:"italic opacity-30",children:a.jsx(z,{...Ht.contentRemoved})}):ne?a.jsx(Lt,{text:ne,customSymbolOffsets:H==null?void 0:H.custom_symbol_offsets}):null},Y)}else if($.type==="images"){const ne=((fe=d[0].message.metadata)==null?void 0:fe.attachments)??[];return a.jsx(fc,{assets:$.imageAssets,attachments:ne},Y)}else return null}),te=s.findIndex($=>$.type==="text");if(te!==-1?oe.splice(te,0,S):oe.push(S),r&&b)oe.length=0,oe.push(a.jsx(hs,{containsImagesOrAttachments:A,isUserTurn:b,onEnterEdit:_t,children:a.jsx("span",{className:"italic opacity-30",children:a.jsx(z,{...Ht.contentRemoved})})}));else if(r&&!b)return null;return a.jsx("div",{className:U("flex w-full flex-col gap-1 empty:hidden",b&&"items-end rtl:items-start",!b&&"first:pt-[3px]",F&&"streaming-response"),style:_,children:oe})}const Ht=Me({contentRemoved:{id:"textMessage.contentRemoved",defaultMessage:"Content removed"},transcriptUnavailable:{id:"textMessage.transcriptUnavailable",defaultMessage:"Transcript Unavailable"}});function sm(t){var m;const{isActivelyStreaming:e,...s}=t,n=fa(),o=(n==null?void 0:n.includes("debug"))??!1,i=t.messages[t.messages.length-1].message.id,[r,c]=u.useState([]),l=u.useRef();return l.current===void 0&&(l.current=(n==null?void 0:n.includes(bi))??!1?new hc(t.parts,c,e,void 0,{debug:o}):new gc(t.parts,c,e)),u.useEffect(()=>{l.current!=null&&(l.current.onMessagePartsUpdated(t.parts,e),l.current.isBuffering()&&xt.addDelayedRenderingMessage(i))},[t.parts,i,e]),u.useEffect(()=>{l.current!=null&&!l.current.isBuffering()&&xt.removeDelayedRenderingMessage(i)},[r,i]),u.useEffect(()=>()=>xt.removeDelayedRenderingMessage(i),[i]),u.useEffect(()=>()=>{l.current!=null&&(l.current.destroy(),l.current=void 0)},[]),a.jsx(xo,{...s,displayParts:r,isActivelyStreaming:e||((m=l.current)==null?void 0:m.isBuffering())})}function nm({message:t,isCompletionInProgress:e,clientThreadId:s,className:n,isUserTurn:o,turnIndex:i,isFeedbackEnabled:r,prevGroupedMessageType:c,prevGroupedMessages:l,showEditButton:m,onEnterEdit:f,onRequestMoreCompletions:g}){var v,p,h;const d=u.useMemo(()=>"parts"in t.message.content?t.message.content.parts:[ya(t.message)],[t]);return a.jsx(om,{parts:d,messages:[t],isCompletionInProgress:e,className:n,citations:(v=t.message.metadata)==null?void 0:v.citations,contentReferences:(p=t.message.metadata)==null?void 0:p.content_references,attachments:(h=t.message.metadata)==null?void 0:h.attachments,isUserTurn:o,turnIndex:i,id:t.nodeId,isFeedbackEnabled:r,onRequestMoreCompletions:g,clientThreadId:s,showEditButton:m,onEnterEdit:f,prevGroupedMessageType:c,prevGroupedMessages:l})}const am=wi.memo(nm);function om(t){const e=t.messages.length>1,{flagSeverity:s}=no(e?void 0:t.messages[0]),n=s!=="danger"&&t.isCompletionInProgress,o=!t.parts.some(r=>r!==""),[i]=u.useState(()=>!t.isUserTurn&&(t.isCompletionInProgress||o));return i?a.jsx(sm,{...t,isActivelyStreaming:n}):a.jsx(xo,{...t,displayParts:pc({isUserTurn:t.isUserTurn,parts:t.parts}),isActivelyStreaming:n})}const im=me(()=>de(()=>import("./l1bg52nte9ozt9as.js"),__vite__mapDeps([86,1,2,3])));function yo({animationData:t,animationSegmentToPlay:e,animationLoopCounter:s}){const n=u.useRef(null);return u.useEffect(()=>{var o;(o=n.current)==null||o.playSegments(e,!0)},[s]),a.jsx(im,{animationData:t,lottieRef:n,loop:!1,autoplay:!1})}function rm(t){return a.jsx(Ps,{width:"8",height:"9",viewBox:"0 0 8 9",fill:"none",...t,children:a.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M7.66607 0.376042C8.01072 0.605806 8.10385 1.07146 7.87408 1.4161L3.54075 7.9161C3.40573 8.11863 3.18083 8.24304 2.93752 8.24979C2.69421 8.25654 2.46275 8.1448 2.31671 7.95008L0.150044 5.06119C-0.098484 4.72982 -0.0313267 4.25972 0.300044 4.01119C0.631415 3.76266 1.10152 3.82982 1.35004 4.16119L2.88068 6.20204L6.62601 0.584055C6.85577 0.239408 7.32142 0.146278 7.66607 0.376042Z",fill:"currentColor"})})}function cm(t){return a.jsxs(Ps,{width:"4",height:"12",viewBox:"0 0 4 12",fill:"none",...t,children:[a.jsx("mask",{id:"path-1-inside-1_1975_4008",fill:"currentColor",children:a.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M1 6.5C1 7.05228 1.44772 7.5 2 7.5C2.55228 7.5 3 7.05228 3 6.5V1.5C3 0.947715 2.55228 0.5 2 0.5C1.44772 0.5 1 0.947715 1 1.5L1 6.5ZM0.75 10.25C0.75 10.9404 1.30964 11.5 2 11.5C2.69036 11.5 3.25 10.9404 3.25 10.25C3.25 9.55964 2.69036 9 2 9C1.30964 9 0.75 9.55964 0.75 10.25Z"})}),a.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M1 6.5C1 7.05228 1.44772 7.5 2 7.5C2.55228 7.5 3 7.05228 3 6.5V1.5C3 0.947715 2.55228 0.5 2 0.5C1.44772 0.5 1 0.947715 1 1.5L1 6.5ZM0.75 10.25C0.75 10.9404 1.30964 11.5 2 11.5C2.69036 11.5 3.25 10.9404 3.25 10.25C3.25 9.55964 2.69036 9 2 9C1.30964 9 0.75 9.55964 0.75 10.25Z",fill:"currentColor"}),a.jsx("path",{d:"M1 6.5H-0.25H1ZM1 1.5L-0.25 1.5L-0.25 1.5L1 1.5ZM2 6.25C2.13807 6.25 2.25 6.36193 2.25 6.5H-0.25C-0.25 7.74264 0.757359 8.75 2 8.75V6.25ZM1.75 6.5C1.75 6.36193 1.86193 6.25 2 6.25V8.75C3.24264 8.75 4.25 7.74264 4.25 6.5H1.75ZM1.75 1.5V6.5H4.25V1.5H1.75ZM2 1.75C1.86193 1.75 1.75 1.63807 1.75 1.5H4.25C4.25 0.257359 3.24264 -0.75 2 -0.75V1.75ZM2.25 1.5C2.25 1.63807 2.13807 1.75 2 1.75V-0.75C0.757359 -0.75 -0.25 0.257359 -0.25 1.5L2.25 1.5ZM2.25 6.5L2.25 1.5L-0.25 1.5L-0.25 6.5L2.25 6.5ZM2 10.25H-0.5C-0.5 11.6307 0.619288 12.75 2 12.75V10.25ZM2 10.25V12.75C3.38071 12.75 4.5 11.6307 4.5 10.25H2ZM2 10.25H2H4.5C4.5 8.86929 3.38071 7.75 2 7.75V10.25ZM2 10.25H2V7.75C0.619288 7.75 -0.5 8.86929 -0.5 10.25H2Z",fill:"currentColor",mask:"url(#path-1-inside-1_1975_4008)"})]})}function lm(t){return a.jsx(Ps,{width:"8",height:"9",viewBox:"0 0 8 9",fill:"none",...t,children:a.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M7.32256 1.48447C7.59011 1.16827 7.55068 0.695034 7.23447 0.427476C6.91827 0.159918 6.44503 0.199354 6.17748 0.515559L4.00002 3.08892L1.82256 0.515559C1.555 0.199354 1.08176 0.159918 0.765559 0.427476C0.449355 0.695034 0.409918 1.16827 0.677476 1.48447L3.01755 4.25002L0.677476 7.01556C0.409918 7.33176 0.449354 7.805 0.765559 8.07256C1.08176 8.34011 1.555 8.30068 1.82256 7.98447L4.00002 5.41111L6.17748 7.98447C6.44503 8.30068 6.91827 8.34011 7.23447 8.07256C7.55068 7.805 7.59011 7.33176 7.32256 7.01556L4.98248 4.25002L7.32256 1.48447Z",fill:"currentColor"})})}function kf({animationLoopCounter:t}){const{resolvedTheme:e}=Ns(),s=e==="dark";return a.jsx(yo,{animationData:s?xc:yc,animationSegmentToPlay:[0,300],animationLoopCounter:t})}function Cf({animationLoopCounter:t}){const{resolvedTheme:e}=Ns(),s=e==="dark";return a.jsx(yo,{animationData:s?_c:vc,animationSegmentToPlay:[0,400],animationLoopCounter:t})}const dm=2e3,_o=.4,um=.45,mm=.2,fm=.1,hm=.25;var je=(t=>(t[t.Running=0]="Running",t[t.Finished=1]="Finished",t[t.Error=2]="Error",t[t.Stopped=3]="Stopped",t[t.Paused=4]="Paused",t))(je||{});function If({conversationMessages:t,icon:e,status:s,text:n,estimatedToolDurationMs:o,animationLoopDurationMs:i=dm,shouldPersistAfterFinished:r=!1}){const[c,l]=u.useState(s===0?0:s===1&&!r?7:1),[m,f]=u.useState(0);u.useEffect(()=>{s===2?l(8):s===3?l(9):s===4?l(10):s===1?l(c===2?3:7):s===0&&c===10&&(l(2),f(d=>d+1))},[s]);const g=xm(c);return u.useEffect(()=>{const d=t[0].message.id;if(g)return xt.addDelayedRenderingMessage(d),()=>{xt.removeDelayedRenderingMessage(d)}},[g]),Ha(()=>{rt(c)&&f(d=>d+1)},i),c===7&&!r?null:a.jsxs("div",{className:"my-2.5 flex items-center gap-2.5",children:[a.jsx(gm,{icon:e,status:s,uiState:c,estimatedToolDurationMs:o,animationLoopCounter:m,shouldPersistAfterFinished:r,onFillProgressBarAnimationComplete:()=>l(4),onFinishAnimationComplete:()=>{l(5),setTimeout(()=>{l(r?7:6)},fm*1e3)},onHideAnimationComplete:()=>l(7)}),a.jsx(pm,{text:n,uiState:c,animationLoopCounter:m,onEnterAnimationComplete:()=>l(2)})]})}const Zn=50;function gm({icon:t,status:e,uiState:s,estimatedToolDurationMs:n,animationLoopCounter:o,shouldPersistAfterFinished:i,onFillProgressBarAnimationComplete:r,onFinishAnimationComplete:c,onHideAnimationComplete:l}){const[m,f]=u.useState(0);Ha(()=>{rt(s)?f(I=>I+Zn):s===10&&f(0)},Zn);let g,d,v;rt(s)||s===10?(g="running",d=a.jsx(t,{animationLoopCounter:o}),v="bg-transparent"):s===4||s===5||s===7&&i?(g="finished",d=a.jsx(rm,{}),v="bg-brand-purple"):e===2?(g="error",d=a.jsx(cm,{}),v="bg-orange-500"):e===3&&(g="stopped",d=a.jsx(lm,{}),v="bg-gray-300");let p={opacity:0,scale:0,rotate:-180,x:0},h={type:"spring",bounce:.3,duration:um},b={opacity:0,scale:.6,rotate:0,x:0};s===0?(p={opacity:0,scale:.5,rotate:-180,x:-8},h={type:"spring",bounce:.3,duration:_o}):s===1?p=!1:s===5&&(b={opacity:0,scale:0,rotate:0,x:0},h={type:"spring",bounce:.3,duration:hm});const M=Yu(m,n);return a.jsx("div",{className:"relative h-5 w-5 shrink-0",children:a.jsx(ct,{onExitComplete:()=>{s===6&&l()},children:g!=null&&a.jsxs(ge.div,{className:U("absolute left-0 top-0 flex h-full w-full items-center justify-center rounded-full text-white",v),initial:p,animate:{opacity:1,scale:1,rotate:0,x:0},exit:b,transition:h,onAnimationComplete:()=>{s===4&&c()},children:[d,(rt(s)||s===10)&&a.jsx(Sc,{percentage:s===3?100:M,thickness:1.5/23,className:"absolute left-1/2 top-1/2 h-[23px] w-[23px] -translate-x-1/2 -translate-y-1/2 text-brand-purple",backgroundStrokeClassName:"stroke-brand-purple/25 dark:stroke-brand-purple/50",transitionDuration:s===3?`${(100-M)/100*mm}s`:void 0,transitionTimingFunction:s===3?"cubic-bezier(0.55, 0, 1, 1)":void 0,onTransitionEnd:()=>{s===3&&r()}})]},g)})})}function pm({text:t,uiState:e,animationLoopCounter:s,onEnterAnimationComplete:n}){const[o,i]=u.useState(t);u.useEffect(()=>{e===2&&i(t)},[s]),u.useEffect(()=>{rt(e)||i(t)},[e,t]);let r={opacity:0,x:0,y:15},c={type:"spring",bounce:.3,opacity:{duration:.15},y:{duration:.3}};e===0?(r={opacity:0,x:-8,y:0},c={type:"spring",bounce:.3,duration:_o,delay:.15}):e===1&&(r=!1);const l=o??void 0;return a.jsx("div",{className:U("relative h-5 w-full leading-5",e===8||e===9?"text-token-text-tertiary":"text-token-text-secondary"),children:a.jsx(ct,{children:l!=null&&a.jsx(ge.div,{className:"absolute left-0 top-0 line-clamp-1 overflow-visible",initial:r,animate:{opacity:1,x:0,y:0},exit:{opacity:0,x:0,y:-15},transition:c,onAnimationComplete:()=>{e===0&&n()},children:l},l.toString())})})}function rt(t){return t===0||t===2||t===3}function xm(t){return rt(t)||t===4||t===5||t===6||t===10}const Yn=Ae.div`group absolute left-0 top-0 mr-1.5 h-8 overflow-hidden mt-1`;function sn({highlightedCommand:t,status:e,children:s,showWorkUserSetting:n=!1,hideOnlyIfNotInteractedWith:o=!1,onOpenAnalytics:i}){const r=s!=null,[c]=u.useState(n),[l,m]=u.useState(n),[f,g]=u.useState(!1),d=e===je.Finished||e===je.Error,v=o?c?!1:!f:!1,p=e===je.Running&&"loading-shimmer";return d&&v?null:r?a.jsxs(a.Fragment,{children:[a.jsx(Jn,{$canShowWork:!0,children:a.jsx(ct,{children:a.jsx(Yn,{children:a.jsx(ge.button,{onClick:()=>{l||i==null||i(),m(h=>!h),g(!0)},initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},className:U(p),children:a.jsxs("div",{className:"flex items-center justify-start gap-1",children:[a.jsx("span",{children:t}),l?a.jsx(ol,{className:"icon-md"}):a.jsx(Za,{className:"icon-md"})]})},t==null?void 0:t.toString())})})}),a.jsx(ct,{children:l&&s&&a.jsx(ge.div,{initial:"collapsed",animate:"reveal",exit:"collapsed",variants:{collapsed:{translateY:-20,opacity:0,height:0},reveal:{translateY:0,opacity:1,height:"auto"}},transition:{duration:.3,ease:"easeInOut"},className:"overflow-hidden",children:s})})]}):a.jsx(Jn,{$canShowWork:!1,children:a.jsx(Yn,{className:U(p),children:t})})}const Jn=Ae.p`first:mt-0 my-1.5 relative h-8
${({$canShowWork:t})=>t?"text-token-text-secondary hover:text-token-text-primary":"text-token-text-secondary"}`,ym=me(()=>de(()=>import("./sso-ovy7jl8cchqxgm0e.js").then(t=>t.j),__vite__mapDeps([30,1,2,3,31,5,6,15,32,33,34,35,36,37,12,38,7,14,39,40,41,42,43,28,17,44,45,46,47,48,20,23,26,49,21,22,50,51,27,52,53,54,55,56,57,58,59,60,25,61,62,63,64,65,19,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,9,10,4,8,11,13,16,85])).then(t=>t.default).catch(()=>Ct)),Qn=me(()=>de(()=>import("./brcyt0u3f2aodae8.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29])).then(t=>t.default));function _m({messages:t,isRequestActive:e,clientThreadId:s}){var b,M,I;const[n,o]=t,i=go(n.message),r=(b=o==null?void 0:o.message.metadata)==null?void 0:b.aggregate_result,c=Ld(),l=Js(),m=Zs(s),f=o!=null&&o.message?co(o.message):[],g=((I=(M=o==null?void 0:o.message.metadata)==null?void 0:M.aggregate_result)==null?void 0:I.messages.filter(ao))??[],v=(f.filter(T=>T.type==="chart")??[]).length!==g.length,p=l&&!v;let h=je.Running;return(r==null?void 0:r.status)==="success"?h=je.Finished:o!=null&&o.message.content.content_type!==es.ExecutionOutput||r!=null&&r.status!=="running"?h=je.Error:(i||!e)&&(h=je.Stopped),a.jsxs(a.Fragment,{children:[a.jsx(vm,{messages:t,status:h,isRequestActive:e}),p&&f.map((T,y)=>{const{file_id:_,type:k}=T;return m?a.jsx(ym,{isStreaming:h===je.Running,visualization:T},_):k==="chart"&&!c?(T.fallback_to_image=!0,a.jsx(Xn,{children:a.jsx(Qn,{clientThreadId:s,visualization:T})},y)):a.jsx(Xn,{children:a.jsx(Qn,{clientThreadId:s,visualization:T})},y)}),!p&&o!=null&&a.jsx(Ol,{message:o.message})]})}const Xn=Ae.div`mb-3 max-w-[80%]`;function vm({messages:t,status:e,isRequestActive:s}){var g;const[n,o]=t,i=le(),r=(g=o==null?void 0:o.message.metadata)==null?void 0:g.aggregate_result,c=go(n.message),{data:l,error:m}=ki(Ci.ShowExpandedCodeView);let f=i.formatMessage({id:"message.tools.data-analysis.running",defaultMessage:"Analyzing"});if((r==null?void 0:r.status)==="success"?f=i.formatMessage({id:"message.tools.data-analysis.finished",defaultMessage:"Analyzed"}):o!=null&&o.message.content.content_type!==es.ExecutionOutput||r!=null&&r.status!=="running"?f=i.formatMessage({id:"message.tools.data-analysis.error",defaultMessage:"Analysis errored"}):(c||!s)&&(f=i.formatMessage({id:"message.tools.data-analysis.stopped",defaultMessage:"Analysis paused"})),l!==void 0||m){const d=Ll(n.message)!=null;return a.jsx(sn,{status:e,highlightedCommand:f,showWorkUserSetting:l??!1,hideOnlyIfNotInteractedWith:!0,children:d?a.jsxs("div",{className:"mb-3 mt-0.5 overflow-hidden rounded-xl bg-black",children:[a.jsx(Bl,{message:n.message,FormattedText:Vs}),o!=null&&a.jsx(zl,{message:o.message})]}):null})}return null}const Sm=3,bm=.1,ea=[0,.6,.9];function wm({nextMessage:t,isLastMessage:e,isRequestActive:s}){let n=e||(t==null?void 0:t.message.content.content_type)===es.Text&&!(t!=null&&t.message.content.parts.some(r=>r.length>0));const o=$c(t==null?void 0:t.message),i=bc(o.slice(0,Sm).map(r=>r.entries[0].url));if(n){const r=s?a.jsxs("div",{className:"flex items-center gap-1",children:[i.map((c,l)=>a.jsx(ge.div,{className:"-ml-1.5 first:ml-0 last:mr-1.5",initial:{width:l===0?0:6,opacity:0},animate:{width:20,opacity:1},transition:{duration:bm,delay:ea[Math.min(l,ea.length-1)]},children:a.jsx("div",{className:U("flex h-5 w-5 items-center overflow-hidden rounded","border-l-2 border-token-main-surface-primary bg-token-main-surface-primary"),children:a.jsx(wc,{url:c,size:32,minSize:16,className:"icon-md rounded"})})},c)),a.jsx(z,{id:"jjx8Qg",defaultMessage:"Searching the web"})]}):a.jsx(z,{id:"fssXGM",defaultMessage:"Error while searching"});return a.jsx(sn,{highlightedCommand:r,status:s?je.Running:je.Error})}return null}const km={strong:t=>{const{node:e,children:s,...n}=t;return a.jsx("strong",{...n,className:U(n.className,"font-semibold text-token-text-primary"),children:s})},p:t=>{const{node:e,children:s,...n}=t;return a.jsx("p",{...n,className:U(n.className,"text-base","has-[strong]:mb-1 [&:not(:first-child)]:has-[strong]:mt-3 [&:not(:has(strong))]:mb-3"),children:s})}};function Cm({messages:t,isStreaming:e,clientThreadId:s}){var v,p;const[n,o]=u.useState(""),[i,r]=u.useState(!1),c=t[0].message,l=c.id,m=C.getServerThreadId(s),f=ya(c);u.useEffect(()=>{var I;const h=/\*\*(.*?)(?:\*\*|\n|$)/g;let b,M="";for(;(b=h.exec(f))!=null;)M=b[1].trim();M?o(M):((I=c.metadata)==null?void 0:I.initial_text)!=null&&o(c.metadata.initial_text)},[f,(v=c.metadata)==null?void 0:v.initial_text]),u.useEffect(()=>{f.length>0&&r(!0)},[f]);const g=u.useMemo(()=>({client_thread_id:s,message_id:l,conversationId:m}),[s,l,m]);u.useEffect(()=>{i&&O.logEvent(E.receivedA8KM123Message,g)},[i]);const d=u.useCallback(()=>{O.logEvent(E.openedA8KM123Message,{...g,isStreaming:e})},[g,e]);return a.jsx(sn,{status:e?je.Running:je.Finished,highlightedCommand:e?n:((p=c.metadata)==null?void 0:p.finished_text)??"",onOpenAnalytics:d,children:i?a.jsx("div",{className:"mb-4 border-l-2 pl-4 dark:border-token-text-secondary",children:a.jsx(Vs,{componentOverrides:km,className:"not-prose leading-6",children:f})}):null})}const Im=me(()=>de(()=>import("./sso-ovy7jl8cchqxgm0e.js").then(t=>t.l),__vite__mapDeps([30,1,2,3,31,5,6,15,32,33,34,35,36,37,12,38,7,14,39,40,41,42,43,28,17,44,45,46,47,48,20,23,26,49,21,22,50,51,27,52,53,54,55,56,57,58,59,60,25,61,62,63,64,65,19,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,9,10,4,8,11,13,16,85])).then(t=>t.default).catch(()=>Ct)),Tm=me(()=>de(()=>import("./sso-ovy7jl8cchqxgm0e.js").then(t=>t.J),__vite__mapDeps([30,1,2,3,31,5,6,15,32,33,34,35,36,37,12,38,7,14,39,40,41,42,43,28,17,44,45,46,47,48,20,23,26,49,21,22,50,51,27,52,53,54,55,56,57,58,59,60,25,61,62,63,64,65,19,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,9,10,4,8,11,13,16,85])).then(t=>t.JawboneMessage).catch(()=>Ct)),jm=me(()=>de(()=>import("./e7jdhn4gug2aacgl.js"),__vite__mapDeps([87,1,2,3,5,6,14,7,17,18,19,20,12,21,22,23,24,25,26,27,16,28,29]))),Mm=me(()=>de(()=>import("./gio1uwfx67lom79t.js"),__vite__mapDeps([88,1,2,3]))),Rm=me(()=>de(()=>import("./7wkl3mzfbsfa0c3f.js"),__vite__mapDeps([89,1,2,3,5,6,14,7,17,18,19,20,12,21,22,23,24,25,26,27,16,28,29]))),Em=me(()=>de(()=>import("./obl1hm4xh7etlk7b.js"),__vite__mapDeps([90,1,2,3,5,6,14,7])).then(t=>t.TextMessageEditor)),Am=me(()=>de(()=>import("./ezdb0imi34ta45ou.js"),__vite__mapDeps([91,1,2,3,5,6,7,14,17,18,19,20,12,21,22,23,24,25,26,27,16,28,29]))),Nm=me(()=>de(()=>import("./g9noj4wa29t5v66p.js"),__vite__mapDeps([92,1,2,3,5,6,14,7,17,18,19,20,12,21,22,23,24,25,26,27,16,28,29]))),Pm=me(()=>de(()=>import("./d50j2m307tremecp.js"),__vite__mapDeps([93,1,2,3,5,6,28,17,14,7,43,18,19,20,12,21,22,23,24,25,26,27,16,29])).then(t=>t.BrowsingMessage)),Dm=me(()=>de(()=>import("./htei2cu3w3uaur2x.js"),__vite__mapDeps([94,1,2,3,5,6,14,7,17,18,19,20,12,21,22,23,24,25,26,27,16,28,29])).then(t=>t.SearchResultMessage)),Fm=me(()=>de(()=>import("./dk3m1xrwzvnnsuv9.js"),__vite__mapDeps([95,1,2,3,5,6,17,14,7,19,20])).then(t=>t.GizmoContactsMessage)),Om=me(()=>de(()=>import("./xva3bj8p5q2n7568.js"),__vite__mapDeps([96,1,2,3,5,6,17,14,7,28,18,19,20,12,21,22,23,24,25,26,27,16,29])).then(t=>t.JITPluginMessage));function Tf(t){switch(t.type){case N.Text:case N.Debug:return[t.message];case N.MultiText:case N.Browsing:case N.CodeInterpreter:case N.JITPlugin:case N.RetrievalBrowsing:case N.ParallelBrowsing:case N.Dalle:case N.GizmoEditor:case N.SearchResult:case N.GizmoContacts:case N.a8km123:case N.Canmore:case N.Jawbone:case N.SearchGPTQuery:return t.messages;default:throw new Error("Bad")}}function jf({groupedMessagesToRender:t,allGroupedMessages:e,clientThreadId:s,isEditing:n,isUserTurn:o,isCompletionRequestInProgress:i,isFeedbackEnabled:r,isFinalTurn:c,turnIndex:l,hasActiveRequest:m,showEditButton:f=!1,handleEnterEdit:g,handleExitEdit:d,onChangeItemInView:v,onRequestMoreCompletions:p,onRequestCompletion:h,shouldGrowContainer:b=!0}){const{showDebugConversationTurns:M}=za(),I=Ws(s),T=t.map((y,_)=>{var F,P,D,R,K,W,H,Q,ee,ae,q,j,S;const k=_===e.length-1;switch(y.type){case N.Text:case N.MultiText:{const A=t[_-1],oe=A==null?void 0:A.type,te=A&&"messages"in A?A.messages:void 0;if(y.type===N.Text){const ce=n?a.jsx(Em,{message:y.message,clientThreadId:s,onChangeItemInView:v,onRequestCompletion:h,onRequestMoreCompletions:p,onExitEdit:d,disabled:m}):a.jsx(am,{className:"min-h-[20px]",message:y.message,isFeedbackEnabled:r,isCompletionInProgress:k&&i,turnIndex:l,clientThreadId:s,showEditButton:f,onEnterEdit:g,isUserTurn:o,onRequestMoreCompletions:p,prevGroupedMessageType:oe,prevGroupedMessages:te});return a.jsxs(u.Fragment,{children:[ce,a.jsx(kc,{isUserTurn:o,message:y.message.message})]},"group-"+y.message.nodeId)}else return y.type===N.MultiText?a.jsx(Rm,{clientThreadId:s,messages:y.messages,isCompletionInProgress:k&&i,isFeedbackEnabled:r,onRequestMoreCompletions:p,prevGroupedMessageType:oe,prevGroupedMessages:te},"multitext-"+(((F=y.messages[0])==null?void 0:F.nodeId)??_)):y.type}case N.Browsing:case N.RetrievalBrowsing:{const A=I!=null&&[Ce.GizmoInteraction,Ce.GizmoMagicCreate,Ce.GizmoTest].includes(I.kind);return a.jsx(Pm,{messages:y.messages,isRequestActive:m,isLastMessageInTurn:k,isUsingGizmo:A,isRetrieval:y.type===N.RetrievalBrowsing},"browsing-"+(((P=y.messages[0])==null?void 0:P.nodeId)??_))}case N.SearchGPTQuery:{const A=e[_+1];return a.jsx(wm,{isRequestActive:m,isLastMessage:k,nextMessage:A&&A.type===N.Text?A.message:void 0},"searchquery-"+(((D=y.messages[0])==null?void 0:D.nodeId)??_))}case N.a8km123:return a.jsx(Cm,{messages:y.messages,isStreaming:k&&i,clientThreadId:s},"sum-"+(((R=y.messages[0])==null?void 0:R.nodeId)??_));case N.Jawbone:{const A=_+1<e.length?e[_+1]:void 0;return a.jsx(Tm,{nextMessage:A&&A.type===N.Debug?A.message:void 0,isLastMessage:k,isRequestActive:m},"jawbone-"+(((K=y.messages[0])==null?void 0:K.nodeId)??_))}case N.ParallelBrowsing:return a.jsx(Nm,{messages:y.messages},"parallel-"+(((W=y.messages[0])==null?void 0:W.nodeId)??_));case N.CodeInterpreter:return a.jsx(_m,{messages:y.messages,isRequestActive:m,clientThreadId:s},"ada-"+(((H=y.messages[0])==null?void 0:H.nodeId)??_));case N.JITPlugin:return a.jsx(Om,{messages:y.messages,clientThreadId:s,isLastTurnInConversation:c,onRequestCompletion:h},"jit-"+(((Q=y.messages[0])==null?void 0:Q.nodeId)??_));case N.GizmoContacts:return a.jsx(Fm,{messages:y.messages,clientThreadId:s,isLastTurnInConversation:c,onRequestCompletion:h},"gizmo-contacts-"+(((ee=y.messages[0])==null?void 0:ee.nodeId)??_));case N.Dalle:return a.jsx(Am,{messages:y.messages,clientThreadId:s},"dalle-"+(((ae=y.messages[0])==null?void 0:ae.nodeId)??_));case N.GizmoEditor:return a.jsx(jm,{messages:y.messages},"gizmo-editor-"+(((q=y.messages[0])==null?void 0:q.nodeId)??_));case N.Canmore:return a.jsx(Im,{clientThreadId:s,messages:y.messages,isRequestActive:m},"canmore-"+(((j=y.messages[0])==null?void 0:j.nodeId)??_));case N.Debug:return M?a.jsx(Mm,{message:y.message},"debug-"+y.message.nodeId):null;case N.SearchResult:return a.jsx(Dm,{messages:y.messages},"search-result-"+(((S=y.messages[0])==null?void 0:S.nodeId)??_))}});return a.jsx(Bm,{shouldGrowContainer:b,children:T})}function Lm(){return a.jsx(Cc,{type:"danger",children:a.jsx(z,{id:"daIg0P",defaultMessage:"Unable to display this message due to a error."})})}function Bm({children:t,shouldGrowContainer:e}){return a.jsx("div",{className:U({"flex max-w-full flex-col":!0,"flex-grow":e}),children:a.jsx(Ii,{name:"GroupedMessages",fallback:Lm,children:t})})}function ta(t,e){t.updateNodeMetadata(e.id,{completionSampleFinishTime:Date.now()})}class zm{constructor(e,s,n,o,i,r,c,l,m,f,g,d){B(this,"currentTree");B(this,"currentNodeId");B(this,"firstResponse",!0);B(this,"didCreateFirstCompletionInNewThread",!1);B(this,"activeBranchLastMessage");B(this,"messagesToUpdate",{});B(this,"allIncompleteStreamedMessages",{});B(this,"responseThreadId");B(this,"isCompletionBlocked",!1);B(this,"isEitherFlagged",!1);B(this,"variantsInStreamInfo");B(this,"activeBranchNodeId");B(this,"blurDuringCompletionTracker",new Tc);B(this,"completionLatencyTracker");B(this,"turnTracker");B(this,"debouncedUpdateCompletion",jc(()=>{this.isCompletionBlocked||C.updateTree(this.clientThreadId,e=>{Object.values(this.messagesToUpdate).forEach(s=>{e.updateNodeMessage(s.id,s)})}),this.messagesToUpdate={}},50,{leading:!0,maxWait:50}));B(this,"handleResponse",async e=>{if(this.turnTracker.onUpdateEventCount(),this.completionLatencyTracker.onResponse(e,this.activeBranchLastMessage,this.responseThreadId),this.responseThreadId===void 0&&"conversationId"in e){const s=e.conversationId;this.responseThreadId=s,Ka(this.clientThreadId)&&C.getServerThreadId(this.clientThreadId)!==s&&(C.setServerIdForNewThread(this.clientThreadId,s),O.logEvent(E.attributeClientThreadToServerThread,{client_thread_id:this.clientThreadId,server_thread_id:s}))}switch(e.type){case"error":this.handleError(e);break;case"num_variants_in_stream":this.bindVariantInfoToTree(e);break;case"moderation":this.handleModeration(e);break;case"url_moderation":this.handleUrlModeration(e);break;case"message":this.handleMessage(e),this.debouncedUpdateCompletion();break;case"done":this.handleDone();break;case"gizmo_inline_review":this.handleGizmoInlineReview(e);break;case"title_generation":this.handleTitleGeneration(e);break;case"conversation_detail_metadata":this.handleConversationDetailMetadata(e);break}});this.queryClient=e,this.clientThreadId=s,this.targetNodeId=n,this.completionType=o,this.model=i,this.eventSource=r,this.onCreate=c,this.callModelAgain=m,this.onCompletionFinished=f,this.isHistoryAndTrainingDisabled=d,this.currentTree=C.getTree(s),this.currentNodeId=n,this.activeBranchLastMessage=this.currentTree.getMessage(this.currentNodeId),this.completionLatencyTracker=new Ic(l),this.turnTracker=g,this.turnTracker.onCompletionStarted(o,this.model)}handleError(e){const s=e.error,n=(s==null?void 0:s.message)||"Something went wrong",o=s instanceof He&&s.code||"",i=s instanceof He&&s.status,r=s instanceof He?s.canRetry:void 0;switch(this.turnTracker.handleRawError(n,i),C.updateTree(this.clientThreadId,c=>{c.updateNodeMessage(this.currentNodeId,this.activeBranchLastMessage),c.updateNodeMetadata(this.currentNodeId,{err:n,errType:"danger",errCode:o,completionSampleFinishTime:Date.now(),canRetry:r})}),o){case vt.ContentPolicy:case vt.ContentOrTos:case Cs:case Ti:break;default:n!==void 0&&qe.logEvent("chatgpt_conversation_error_web",n)}this.blurDuringCompletionTracker.onMessageError(),this.cleanUp(),this.onCompletionFinished(this.responseThreadId),s instanceof He&&(s==null?void 0:s.code)===Cs&&(s!=null&&s.clearsIn)&&(Mc(new Date(Date.now()+s.clearsIn*1e3).toISOString()),setTimeout(()=>{Rc()},s.clearsIn*1e3))}handleGizmoInlineReview(e){C.setPromptGptRating(this.clientThreadId,e.gizmoId)}handleTitleGeneration(e){C.setTitle(this.clientThreadId,e.title,Va.Generated)}handleConversationDetailMetadata(e){const{default_model_slug:s}=e;s&&C.setThreadModelId(this.clientThreadId,s),vs.updateDetails(e)}bindVariantInfoToTree(e){this.variantsInStreamInfo=e,C.updateTree(this.clientThreadId,s=>{const n=s.getParentPromptNode(this.currentNodeId);s.updateNodeMetadata(n.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}handleModeration(e){const{isCompletion:s,messageId:n,conversationId:o,flagged:i,blocked:r,disclaimers:c,metadata:l}=e,m=!!(c!=null&&c.length)&&s;(i||r||m)&&(this.isEitherFlagged=!0,r&&s&&(this.isCompletionBlocked=!0),C.updateTree(this.clientThreadId,f=>{const g=f.messageIdToNodeId(n);r&&f.clearNodeMessageParts(g),f.updateNodeMetadata(g,{...(m&&!!(c!=null&&c.length)&&ji(c,r))??{},...i&&Mi,...r&&(l!=null&&l.model_incompatibility?Ri:Ei),completionSampleFinishTime:Date.now()})}),O.logEvent(s?r?E.completionBlockedByModeration:E.completionFlaggedByModeration:r?E.promptBlockedByModeration:E.promptFlaggedByModeration,{threadId:o,id:n}))}handleUrlModeration(e){const{conversationId:s,url:n,isSafe:o}=e;o&&C.addThreadSafeUrl(s,n)}handleMessage(e){var i,r,c,l,m,f,g,d,v,p,h,b,M;let s=!0;const{message:n,conversationId:o}=e;if((n==null?void 0:n.author.role)===be.Tool?this.turnTracker.onMessageUpdate((i=n.metadata)==null?void 0:i.model_slug,(r=n.metadata)==null?void 0:r.gizmo_id,n.author.name):this.turnTracker.onMessageUpdate((c=n.metadata)==null?void 0:c.model_slug,(l=n.metadata)==null?void 0:l.gizmo_id,void 0),this.firstResponse&&!this.currentTree.hasReceivedServerCompletion){if((n==null?void 0:n.author.role)===be.System){const I=(m=n.metadata)!=null&&m.parent_id?this.currentTree.getNodeByIdOrMessageId(n.metadata.parent_id):void 0;if((I==null?void 0:I.message.author.role)!==be.User){this.currentTree.appendSystemMessageToRoot(n);return}}else if((n==null?void 0:n.author.role)===be.User)return;if(this.currentTree.hasNodeOrMessageId(n.id))return}if(this.firstResponse&&((f=n.metadata)!=null&&f.rebase_system_message)){C.updateTree(this.clientThreadId,I=>{var y;if(((y=n.metadata)==null?void 0:y.parent_id)==null)throw Error("Unexpected rebased system message without parent");const T=I.getNodeByIdOrMessageId(this.targetNodeId);I.deleteNode(this.targetNodeId),I.addNode(n.id,n,n.metadata.parent_id,n.author.role),I.addNode(T.id,T.message,n.id,T.message.author.role)});return}if(this.firstResponse){const I=((g=lt.getState().threads[this.clientThreadId])==null?void 0:g.continuingFromSharedConversationId)!=null;C.removeContinuingFromSharedConversationId(this.clientThreadId),this.firstResponse=!1,this.didCreateFirstCompletionInNewThread=!this.currentTree.hasReceivedServerCompletion||I,C.updateTree(this.clientThreadId,y=>{y.updateNodeMessage(this.currentNodeId,n)}),this.didCreateFirstCompletionInNewThread&&Ts.onCreate(this.onCreate,o,this.queryClient,this.isHistoryAndTrainingDisabled);const T={id:this.targetNodeId,threadId:o,completionType:this.completionType,eventSource:this.eventSource,model:this.model};if(this.completionType===Ze.Next){const y=lt.getState().threads[o],_=(d=y==null?void 0:y.conversationTurns)==null?void 0:d.length,k=(v=y==null?void 0:y.conversationTurns)==null?void 0:v.filter(P=>P.role==be.User),F=k&&((p=k[k.length-1])==null?void 0:p.messages[0].message);if((F==null?void 0:F.content.content_type)==es.Text){const P=F.content.parts.join("").length,D=(k==null?void 0:k.length)??0;T.countConversationTurns=_,T.countUserSubmittedMessages=D,T.countLastUserPromptTextMessageLength=P}}O.logEvent(E.generateCompletion,T)}else if(this.completionType!==Ze.Continue){const I=this.currentTree.containsNodeOrMessageId(n.id),T=(h=n.metadata)==null?void 0:h.parent_id;if(I||(this.debouncedUpdateCompletion.flush(),C.updateTree(this.clientThreadId,y=>{if(T==null)throw new Error(`Received a message with no parentId: ${JSON.stringify(n)}`);y.addNode(n.id,n,T,be.Assistant)})),T!=null&&T===this.activeBranchNodeId){const y=this.allIncompleteStreamedMessages[T];y!=null&&(C.updateTree(this.clientThreadId,_=>{ta(_,y)}),delete this.allIncompleteStreamedMessages[T])}if(s=(((b=this.variantsInStreamInfo)==null?void 0:b.num_variants_in_stream)??1)===1||this.activeBranchNodeId==null||this.activeBranchNodeId===n.id||this.currentTree.isAncestorOfNode(this.activeBranchNodeId,n.id),s&&this.activeBranchNodeId!==n.id){this.activeBranchNodeId=n.id,this.currentNodeId=n.id;const y=C.getThreadCurrentLeafId(this.clientThreadId);this.currentTree.messageIdToNodeId(this.currentNodeId)!==this.currentTree.messageIdToNodeId(y)&&C.setThreadCurrentLeafId(this.clientThreadId,this.currentNodeId),T!=null&&C.updateTree(this.clientThreadId,_=>{const k=_.getParentPromptNode(n.id);_.updateNodeMetadata(k.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}}if((n==null?void 0:n.author.role)===be.Tool&&(n==null?void 0:n.author.name)==="bio"){const I=(M=n.metadata)==null?void 0:M.gizmo_id;setTimeout(()=>{this.queryClient.invalidateQueries({queryKey:Ec(I)})},5e3)}s&&(this.activeBranchLastMessage=n),this.messagesToUpdate[n.id]=n,this.allIncompleteStreamedMessages[n.id]=n}async handleDone(){var e,s;if(this.turnTracker.logCompletion({type:Is.Success}),this.isCompletionBlocked||(this.debouncedUpdateCompletion.flush(),this.isEitherFlagged||(this.didCreateFirstCompletionInNewThread&&Ts.onCreateFinished(this.queryClient,this.responseThreadId,this.isHistoryAndTrainingDisabled),this.onCompletionFinished(this.responseThreadId))),C.updateTree(this.clientThreadId,n=>{Object.values(this.allIncompleteStreamedMessages).forEach(o=>{ta(n,o)})}),qa.publish({kind:"createConversation",clientThreadId:this.clientThreadId}),this.blurDuringCompletionTracker.onMessageDone(),this.cleanUp(),((s=(e=this.activeBranchLastMessage)==null?void 0:e.metadata)==null?void 0:s.client_actions)!==void 0){const n=await Ac(this.clientThreadId,this.activeBranchLastMessage);n.length>0&&this.callModelAgain(this.currentNodeId,n)}}cleanUp(){setTimeout(()=>{Ul(this.clientThreadId,ga.FINISHED),qs.removeRequest(this.targetNodeId),C.releaseThread(this.clientThreadId)},0)}}const Um=1e3*30,ps=_a.getTracer("completion"),xs=t=>(t==null?void 0:t.code)==="challenge_required";class ys extends Error{}function Gm(t,e,s,n){const o=async(i=null,r=!1)=>{var W,H,Q,ee,ae,q;await Nc();const c=new AbortController,l="threadId"in e?e.threadId:void 0,m="continueFromSharedConversationId"in e?e.continueFromSharedConversationId:void 0,f=Ai(),g={action:e.completionType,messages:e.messages.length>0?e.messages:void 0,conversation_id:l,continue_from_shared_conversation_id:l!=null?void 0:m,parent_message_id:e.parentMessageId,model:e.model,timezone_offset_min:new Date().getTimezoneOffset(),variant_purpose:(W=e.completionMetadata)==null?void 0:W.variantPurpose,suggestions:(H=e.completionMetadata)!=null&&H.suggestions?e.completionMetadata.suggestions.map(j=>Tl(j)):void 0,history_and_training_disabled:e.historyDisabled,juice:(Q=e.completionMetadata)==null?void 0:Q.juice,conversation_mode:(ee=e.completionMetadata)==null?void 0:ee.conversationMode,force_paragen:e.forceParagen,force_paragen_model_slug:e.forceParagenModel,force_nulligen:e.forceNulligen,force_indepth_feedback:e.forceIndepthFeedback,force_rate_limit:e.forceRateLimit,reset_rate_limits:e.resetRateLimits,disable_system_content_toggling:e.disableSystemContentToggling,websocket_request_id:f,source:(ae=e.completionMetadata)==null?void 0:ae.source,system_hints:(q=e.completionMetadata)==null?void 0:q.systemHints,force_use_sse:!It.isWebsocketConnected(),conversation_origin:e.conversationOrigin,force_use_search:e.forceUseSearch,client_contextual_info:e.contextualInfo},d=na(await sa(t));let v="https://chatgpt.com/backend-api";d&&(v="https://chatgpt.com/backend-anon");const p=`${v}/conversation`;let h=!0,b=!0;const M=d?wn.getUnauthHeaders().additionalHeaders:await wn.getAuthedHeaders(),I=Ni(e.chatReq,i??e.arkoseToken,e.turnstileToken,e.proofToken,null),T={...M,...Pc(),...I};let y,_,k;ps.startActiveSpan("completion.response",j=>{y=ps.startSpan("completion.first_response"),_=ps.startSpan("completion.first_token"),k=j});const F=_a.setSpan(kn.active(),k);function P(j){if(j.data==="[DONE]")c.abort(),k.end(),s({type:"done"}),En();else if(j.event!=="ping")try{const S=JSON.parse(j.data);if(S.error){const A=new $e(S.error);throw s({type:"error",error:A}),A}else"type"in S?S.type==="gizmo_inline_review"?s({type:"gizmo_inline_review",gizmoId:S.gizmo_id}):S.type==="title_generation"?s({type:"title_generation",title:S.title,conversation_id:S.conversation_id}):S.type==="moderation"?s({type:"moderation",conversationId:S.conversation_id,messageId:S.message_id,isCompletion:S.is_completion,flagged:S.moderation_response.flagged,blocked:S.moderation_response.blocked,disclaimers:S.moderation_response.disclaimers,metadata:S.moderation_response.metadata}):S.type==="url_moderation"?s({type:"url_moderation",conversationId:S.conversation_id,messageId:S.message_id,url:S.url_moderation_result.full_url,isSafe:S.url_moderation_result.is_safe}):S.type==="num_variants_in_stream"?s({type:"num_variants_in_stream",num_variants_in_stream:S.num_variants_in_stream,display_treatment:S.display_treatment}):S.type==="conversation_detail_metadata"&&s(S):(s({type:"message",message:S.message,conversationId:S.conversation_id}),b&&(b=!1,y.end()),h&&S.message.author.role==="assistant"&&S.message.content.content_type==="text"&&S.message.content.parts[0]!==""&&(h=!1,_.end()))}catch(S){if(S instanceof He)throw new $e(S.message)}}let D=null,R=setTimeout(()=>{D===!0?(O.logEvent(E.asyncResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:Is.Error,error:{reason:"timeout",message:"Async Response Took Too Long to Come Back"}})):D===!1&&(O.logEvent(E.sseResponseWaitTooLong,{}),e.turnTracker.logCompletion({type:Is.Error,error:{reason:"timeout",message:"SSE Response Took Too Long to Come Back"}}))},Um);return sd(f,P,c.signal),kn.with(F,()=>Dc(p,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...T},body:JSON.stringify(g),signal:c.signal,openWhenHidden:!0,async onopen(j){var oe;const S=j.headers.get("content-type")??"",A=j.headers.get("Cf-Ray")??null;if(j.ok&&S.includes("text/event-stream")){D=!1,n(A,e.model,e.turnTracker);return}else if(S.includes("application/json")){const te=await j.json(),{webSocketUrl:ce,fallbackWebSocketUrl:se,conversationId:$,responseId:Y,expiresAt:fe,websocketRequestId:ne}=td(te);if(ce!=null&&$!=null&&Y!=null&&ne!=null&&fe){D=!0,n(A,e.model,e.turnTracker);try{await nd(ce,se,fe,$,Y,ne,P,c.signal,R)}catch(x){x instanceof $e&&s({type:"error",error:x})}throw new ys}else{const x=(te==null?void 0:te.error)??(te==null?void 0:te.detail),Z=(x==null?void 0:x.message)??x??"Unknown server error";if(x){if(xs(x))throw new He(Z,j.status,x.code);if(j.status>=500)throw new $e(Z);{if(((x==null?void 0:x.code)==="expired_session_key"||(x==null?void 0:x.code)==="invalid_api_key"||(x==null?void 0:x.code)==="token_expired")&&typeof window<"u"&&((oe=window._oaiHandleSessionExpired)==null||oe.call(window,"stream",JSON.stringify(x))),(x==null?void 0:x.code)==="deactivated_workspace"){window.location.href.includes("/workspace/deactivated")||(window.location.href="/workspace/deactivated");return}const pe=x==null?void 0:x.can_retry;throw new He(Z,j.status,x==null?void 0:x.code,x==null?void 0:x.type,void 0,x==null?void 0:x.clears_in,pe)}}}}throw new $e(Cn)},onmessage:j=>{if(D)throw new $e(Cn);R&&(clearTimeout(R),R=null),P(j)},onerror(j){let S=j instanceof Error?j:new Error(JSON.stringify(j));throw S instanceof ys||D||xs(S)&&!r||(S.message==="Failed to fetch"&&(S=new $e(`An error occurred. Either the engine you requested does not exist or there was another issue processing your request. ${_s}`)),S.message==="network error"&&(S=new He(`A network error occurred. Please check your connection and try again. ${_s}`,400)),Pi("fetch-error:conversation:new-message",{url:p,message:S==null?void 0:S.message}),s({type:"error",error:S}),En(S)),S}})).catch(async j=>{if(xs(j)){if(r)throw new He("Failed to complete your call, please try again",j.status);{const S=await Kt.getEnforcementToken(e.chatReq);return o(S,!0)}}j instanceof ys||(Pe.addError(j),e.turnTracker.handleRawError(j.message??"Something went wrong",j.status))}),c};return o()}function Mf({clientThreadId:t,continuingFromSharedConversationId:e,onCompletionFinished:s=_t,onCreate:n=_t}){const o=xa(),{resolvedTheme:i}=Ns(),r=i==="dark",c=u.useRef(s),l=pa();c.current=s;const m=u.useCallback(async function({model:f,completionType:g,parentNodeId:d,metadata:v,focusOnNewCompletion:p=!0,completionMetadata:h,chatReq:b,arkoseToken:M,turnstileToken:I,proofToken:T,preflightTime:y,extraStreamParams:_,appendMessages:k,updateTree:F,turnTracker:P}){var $,Y,fe,ne,x,Z,pe;qa.publish({kind:"requestCompletion"});const D=C.getTree(t);C.retainThread(t);const R=Kc(),K=`${Di}${t}-${R}`,W=`${t}-${R}`;F==null||F();const H=D.getNodeByIdOrMessageId(d),ee={gizmo_id:($=H.message.metadata)==null?void 0:$.gizmo_id};(h==null?void 0:h.juice)!=null&&(ee.snorkle_status=1),C.updateTree(t,G=>{G.addNode(K,"",d,be.Assistant,void 0,ee)}),p&&C.setThreadCurrentLeafId(t,K);let ae,q=[],j=D.getNodeByIdOrMessageId(H.parentId);for(;j!=null&&(((Y=j.metadata)==null?void 0:Y.isPlaceholderTemplateAssistantWelcomeMessage)===!0||((fe=j.metadata)==null?void 0:fe.isClientCreatedSystemMessage)===!0);){const G=j.message;q.unshift(G);const re=D.getNodeByIdOrMessageId(j.parentId);ae=((ne=re.message)==null?void 0:ne.id)??re.id,j=re}if(g===Ze.Next||g===Ze.Variant){const G=D.getNodeByIdOrMessageId(H.parentId);if(ae??(ae=((x=G.message)==null?void 0:x.id)??G.id),q.push(H.message),k){let re=d;C.updateTree(t,_e=>{for(const ue of k)_e.insertNodeBefore(K,{id:ue.id,message:ue,parentId:re,children:[]}),re=ue.id}),q.push(...k)}q=Hm(q,_)}else ae??(ae=H.message.id);const S=C.getServerThreadId(t);S===void 0&&Ka(t)&&C.updateInitialThreadDataForNewThread(t,f);async function A(G,re){const _e=performance.now(),ue=await ha();Kt.initializeAndGatherData(ue),ks.initializeAndGatherData(ue),Ss.initializeAndGatherData(ue),C.updateTree(t,Se=>{for(const ie of re)Se.addNode(ie.id,ie,G,be.Assistant,{completionSampleFinishTime:Date.now()}),G=ie.id}),C.setThreadCurrentLeafId(t,G);const ve=await Kt.getEnforcementToken(ue),De=await ks.getEnforcementToken(ue),L=await Ss.getEnforcementToken(ue);m({model:f,completionType:Ze.Next,parentNodeId:G,metadata:{},chatReq:ue,arkoseToken:ve??null,turnstileToken:De??null,proofToken:L??null,preflightTime:performance.now()-_e,extraStreamParams:_,turnTracker:P})}P.updateAttachmentCount(q);const oe=new zm(o,t,K,g,f,v.eventSource,n,W,A,(...G)=>c.current(...G),P,l),te=(G,re,_e)=>{G&&_e.onReceivedRequestId(G),Fc(W,re,G,y)},ce={is_dark_mode:r,time_since_loaded:Math.floor(performance.now()/1e3),page_height:window==null?void 0:window.innerHeight,page_width:window==null?void 0:window.innerWidth,pixel_ratio:window==null?void 0:window.devicePixelRatio,screen_height:(Z=window==null?void 0:window.screen)==null?void 0:Z.height,screen_width:(pe=window==null?void 0:window.screen)==null?void 0:pe.width},se=await Gm(o,{conversationOrigin:C.getConversationOrigin(t),model:f,completionType:g,threadId:S,continueFromSharedConversationId:e,historyDisabled:l,parentMessageId:ae,messages:q,chatReq:b,arkoseToken:M??null,turnstileToken:I??null,proofToken:T??null,completionMetadata:h,..._,turnTracker:P,contextualInfo:ce},oe.handleResponse,te);qs.addRequest(K,se,P),po.onCompletionRequestStarted(K)},[t,o,n,e,l,r]);return m}const Hm=(t,e)=>{let s=t;return(e==null?void 0:e.forceUseSearch)===!1&&t.length>0&&(s=t.map(n=>{const{system_hints:o,...i}=n.metadata||{};return{...n,metadata:{...i,system_hints:o==null?void 0:o.filter(r=>r!==it.Search)}}})),s};export{mo as A,jf as C,bf as F,Cf as G,Gu as P,wf as T,sn as a,je as b,yf as c,hf as d,Ld as e,xf as f,co as g,pf as h,om as i,go as j,Qu as k,Ys as l,If as m,ff as n,kf as o,gf as p,Hd as q,_f as r,vf as s,Sf as t,Mf as u,Bu as v,Tf as w,ad as x,Gd as y,It as z};
//# sourceMappingURL=fz89ofm1kvoz9i7n.js.map
