const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/gemyz0lgmemdwlhs.js","assets/gblfh15g18zr7pwb.js","assets/fxihrcxhyf7cscoy.js","assets/root-mumb2j74.css","assets/excramzz6zmdjrf7.js","assets/conversation-small-ict01xsi.css","assets/oxj8598n9sgda2lx.js","assets/ipcdr5chr156c54w.js","assets/m0mw406kbxcyqjdt.js","assets/k5sh7u8yh3bk12bi.js","assets/k04ck5jz7xpugaan.js","assets/fae6lgtd8eq36gap.js","assets/borfbfzxf550b8oy.js","assets/n6b2ylcn7k2442tf.js","assets/ndu8us7t5cvdpd53.js","assets/ovqu5mwgi9r7jedm.js","assets/ol3r77bux2nn41h6.js","assets/textdoc-sandpack-code-preview-mk0lbw6o.css"])))=>i.map(i=>d[i]);
import{aM as Cn,aN as xn,j as i,az as $,r as p,Y as q,aR as ee,aw as ce,b0 as te,X as se,n as yn,c5 as re,R as qe,Z as Tn,d2 as En,bS as wn,bT as bn,bU as Sn,ab as Mn,h as Rt,o as kn,gj as ft,b as mt,m as Lt,am as An,a5 as Nn}from"./gblfh15g18zr7pwb.js";import{j$ as R,mj as Dn,fO as L,mk as jn,ml as K,O as In,mm as On,mn as Rn,kH as _t,mo as k,dS as Ln,fE as _n,dR as Pn,dU as Hn,mp as $n,br as Pt,kF as Ht,kG as ue,mq as $t,ko as ht,bJ as ne,kv as de,B as qn,mr as Se,hu as qt,fR as fe,ms as Me,hs as Fn,kg as Ft,hl as Ut,mt as Bt,mu as zt,Z as O,ku as Un,mv as Bn,jL as zn,fm as Gn,cj as Vn,jI as Yn,mw as Wn,iW as Jn,dl as Qn,v as pt,mx as Xn,my as Gt,mz as Zn,mA as Kn,d as es,mB as ts,mC as ns,mD as ss,fD as os,mE as rs,mF as as,fu as is,mG as ls,fw as cs,mH as us,kE as ds,hm as fs,fx as ms,fy as hs,ho as ps,mI as gs,b4 as vs,mJ as Cs,mK as xs,mL as ys,mM as Ts,_ as gt,mN as Es,mO as ws,mP as bs,mQ as Ss,mR as vt,mS as Ms,kj as ae}from"./excramzz6zmdjrf7.js";import{O as ks,k as le,l as As,A as Ns,m as Ds,D as js}from"./m0mw406kbxcyqjdt.js";import{e as Is,C as Os}from"./e3y0zzek4ws7m7o0.js";import{S as Rs}from"./jhtv6cipbujuvdx6.js";import{C as ke,S as J,a0 as Ls,$ as _s,a1 as Ct}from"./ipcdr5chr156c54w.js";import{m as Q}from"./k04ck5jz7xpugaan.js";import{p as Ps,Q as Hs,bY as $s,bI as qs,ad as Fs,ar as Us,ah as Bs,bZ as zs,b_ as Gs,aI as Vs,aO as Ys,B as Ws}from"./fxihrcxhyf7cscoy.js";import{D as Js}from"./e2entq3r9l4ds8ev.js";import{i as Qs}from"./bktpkru86bu1aaer.js";import{C as Xs}from"./p5e2madetvxqyl82.js";import{P as Zs}from"./fae6lgtd8eq36gap.js";import{u as Ks}from"./1rbjla1tgjw6yynt.js";import{u as eo}from"./4idux1in6zu9zhnc.js";var Fe=(e=>(e.Close="close",e.Loaded="loaded",e.Streaming="streaming",e.Download="download",e))(Fe||{});function to(e){return e.includes("'react'")||e.includes('"react"')}function no(e,t){switch(e){case R.CODE_HTML:return"static";case R.CODE_REACT:return"react";case R.CODE_JAVASCRIPT:case R.CODE_TYPESCRIPT:return to(t)?"react":void 0;default:return}}function Ue(e,t){return no(e,t)!=null}function We(e){return Dn([R.CODE_JAVASCRIPT,R.CODE_TYPESCRIPT,R.CODE_PYTHON],e)}function xt(){if(typeof globalThis<"u")return globalThis;if(typeof window<"u")return window;if(typeof global<"u")return global;if(typeof self<"u")return self;throw new Error("Unable to locate global object.")}function so(){const e=eval;function t(n){return n==="this"?xt():e(n)}try{xt().eval=t}catch(n){L.logError("Failed to polyfill eval",n)}}so();const oo=Cn(()=>xn(()=>import("./gemyz0lgmemdwlhs.js").then(e=>e.t),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17])).then(e=>e.TextdocSandpackCodePreview),{fallback:()=>i.jsx("div",{className:"h-full w-full",children:"Failed to load"}),loading:()=>i.jsx("div",{className:"h-full w-full"})});function ro(e){return i.jsx(oo,{...e})}function ao({hidden:e,isStreaming:t,textdocContent:n,textdocType:s}){return s===R.CODE_HTML?i.jsx(Rs,{className:$("min-h-full w-full",{hidden:e}),srcDoc:n}):i.jsx(ro,{hidden:e,isStreaming:t,textdocContent:n,textdocType:s})}const yt=(e=[])=>e.filter(({status:t})=>t!==jn.DISMISSED),io=({isTextdocStreaming:e,isRequestActive:t,value:n,comments:s})=>{const[o,r]=p.useState(!1);return p.useEffect(()=>{e&&o&&(r(!1),ke.reset())},[n,s]),p.useEffect(()=>{t||(r(!1),ke.reset())},[t]),[o,r]};function lo({onClickRestore:e,onClickResetLatest:t}){const n=q();return i.jsx(Q.div,{initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{bounce:0,duration:.24},className:"absolute bottom-0 left-0 z-30 w-full items-center border-t border-gray-100 bg-token-main-surface-primary p-6 shadow-[0_-4px_32px_rgba(0,0,0,0.08)] @container dark:border-token-border-xlight dark:shadow-[0_-4px_32px_rgba(0,0,0,0.12)] lg:border-l",children:i.jsxs("div",{className:"mx-auto flex max-w-[48rem] flex-col flex-wrap justify-center gap-5 @2xl:flex-row @2xl:justify-between",children:[i.jsxs("div",{className:"flex flex-col px-2 text-center @2xl:text-start",children:[i.jsx("span",{className:"text-md text-wrap font-semibold",children:n.formatMessage({id:"gt23pb",defaultMessage:"You are viewing a previous version"})}),i.jsx("span",{className:"text-wrap text-sm text-token-text-secondary",children:n.formatMessage({id:"sAlUJn",defaultMessage:"Restore this version to make edits"})})]}),i.jsxs("div",{className:"flex flex-wrap items-center justify-center gap-4",children:[i.jsx(ee,{as:"button",color:"primary",onClick:e,children:n.formatMessage({id:"+cddAb",defaultMessage:"Restore this version"})}),i.jsx(ee,{as:"button",color:"secondary",onClick:t,children:n.formatMessage({id:"qCD3eu",defaultMessage:"Back to latest version"})})]})]})})}const co=({onClose:e,onClear:t})=>i.jsxs("div",{className:"flex items-center justify-between border-b border-gray-100 bg-token-main-surface-primary p-2 dark:border-token-border-medium",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(ee,{size:"small",color:"ghost",as:"button",className:"aspect-square !p-1",onClick:e,icon:Ps}),i.jsx(ce,{...Tt.output})]}),i.jsx("div",{className:"flex items-center gap-2",children:i.jsx(te,{label:i.jsx(ce,{...Tt.clearConsole}),children:i.jsx(ee,{size:"small",color:"ghost",as:"button",className:"aspect-square !p-1",icon:Hs,onClick:t})})})]}),Tt=se({output:{id:"P/lYBq",defaultMessage:"Output"},clearConsole:{id:"gAICYK",defaultMessage:"Clear console"}}),uo=({onDrag:e,onDragEnd:t,onDoubleClick:n})=>i.jsx(Q.div,{drag:"y",className:"absolute top-[-2px] z-10 h-[4px] w-full cursor-ns-resize bg-token-text-quaternary opacity-0",whileHover:{opacity:.5},whileDrag:{opacity:.75,height:"8px",top:"-4px"},transition:{type:"tween",duration:.1},style:{x:0,y:0,transform:"translateY(0px)"},dragMomentum:!1,dragSnapToOrigin:!1,dragElastic:!1,dragConstraints:{left:0,right:0,top:0,bottom:0},onDrag:(s,o)=>{e?.(o)},onDragEnd:t,onDoubleClick:n});var Ae=(e=>(e.RAN_CODE="ran_code",e))(Ae||{});const Vt=(e,{name:t,message:n,line:s,stack:o})=>`${t}: ${n}

Stack:
${o.join("")}

Error occured in:
${e.split(`
`).slice(s-1,s+1).join(`
`)}`,fo=({name:e,message:t,stack:n})=>`${e}: ${t}
${n.join(`
`)}`,mo=({time:e})=>{const[,t]=p.useState(0);return p.useEffect(()=>{const n=setInterval(()=>t(s=>s+1),6e4);return()=>clearInterval(n)},[]),On(e,{includeSeconds:!1,addSuffix:!0})},ho=({log:e,level:t})=>i.jsx("span",{className:$("whitespace-pre-wrap",t==="error"&&"text-red-500"),children:e}),po=({error:e,isLast:t,isRequestActive:n,onRequestHelp:s})=>{const[o,r]=p.useState(!1),a=l=>async()=>{r(l),await s?.(e,l),r(!1)};return i.jsxs("div",{className:"flex flex-col gap-2",children:[i.jsx("span",{className:"whitespace-pre-wrap text-red-500",children:fo(e)}),t&&!n&&i.jsxs("div",{className:"flex gap-2",children:[i.jsx(ee,{onClick:a("comment"),icon:$s,type:"button",color:"secondary",disabled:!!o,loading:o==="comment",children:i.jsx(ce,{...Ne.askForHelp})}),i.jsx(ee,{onClick:a("fix"),icon:qs,type:"button",color:"primary",disabled:!!o,loading:o==="fix",children:i.jsx(ce,{...Ne.askForFix})})]})]})},go=({ranAt:e})=>i.jsxs("div",{className:"flex items-center justify-between gap-2 font-sans",children:[i.jsx("div",{className:"rounded-full bg-token-main-surface-secondary px-2 py-0.5",children:i.jsx(ce,{...Ne.ranCode})}),i.jsx("div",{className:"flex items-center gap-2",children:i.jsx(mo,{time:e})})]}),vo=({output:e})=>{const t=q();return e==null?null:typeof e=="string"&&e.startsWith("blob:")?i.jsx("img",{alt:t.formatMessage(Ne.imgAlt),src:e}):i.jsx("span",{className:"flex items-center gap-2",children:In(e)})},Co=({log:e,isLast:t=!1,isRequestActive:n=!1,onRequestHelp:s})=>{let o=null;switch(e.type){case K.LOG:{o=i.jsx(ho,{...e});break}case K.ERROR:{o=i.jsx(po,{...e,isLast:t,isRequestActive:n,onRequestHelp:s});break}case K.OUTPUT:{o=i.jsx(vo,{...e});break}case Ae.RAN_CODE:{o=i.jsx(go,{...e});break}case K.RUN_COMPLETE:break}return i.jsx("li",{className:$("whitespace-pre px-2 py-1 font-mono",e.type===Ae.RAN_CODE&&"sticky top-0 border-b border-token-border-light bg-token-main-surface-primary shadow-[0_-1px_0_0_var(--border-light)]"),children:o})},Ne=se({imgAlt:{id:"L6t7Yb",defaultMessage:"Plot"},ranCode:{id:"ffa9Nt",defaultMessage:"Ran code"},askForHelp:{id:"wMZco9",defaultMessage:"Ask ChatGPT for help"},askForFix:{id:"A9pxgT",defaultMessage:"Fix it for me"}}),Yt=`You're a professional developer highly skilled in debugging. The user ran the textdoc's code, and an error was thrown.
Please think carefully about how to fix the error`,xo=(e,t)=>{const n=Vt(e,t);return`
${Yt}, and then rewrite the textdoc to fix it.

- NEVER change existing test cases unless they're clearly wrong.
- ALWAYS add more test cases if there aren't any yet.
- ALWAYS ask the user what the expected behavior is in the chat if the code is not clear.

# Error

${n}`.trim()},yo=(e,t)=>{const n=Vt(e,t);return`
${Yt}, and then add multiple comments with suggestions on where things might be going wrong.

- NEVER comment on test cases unless they are clearly incorrect, or you are unsure of what the correct behavior of the code is.
- The user sees which line the error occurred on, so do not comment on that line directly.

# Error

${n}`.trim()},To=({logs:e,isRequestActive:t,onClear:n,onClose:s,onRequestHelp:o})=>{const[r,a]=p.useState(320),l=e.filter(u=>u.type!==K.RUN_COMPLETE);return i.jsxs(Q.div,{className:"relative w-full border-t border-token-border-light",children:[i.jsx(uo,{onDrag:({delta:{y:u}})=>a(c=>c-u)}),i.jsxs("div",{className:"flex flex-col",style:{height:r},children:[i.jsx(co,{onClear:n,onClose:s}),i.jsx("div",{className:"flex flex-1 flex-col-reverse overflow-auto bg-white dark:bg-black",children:i.jsx("ol",{className:"flex flex-1 flex-col justify-end pb-4",children:l.map((u,c)=>i.jsx(Co,{log:u,isLast:c===l.length-1,isRequestActive:t,onRequestHelp:o},c))})})]})]})},Eo=({textdocContent:e,isRequestActive:t,createTextdocTurn:n},s)=>{const o=Rn(),[r,a]=p.useState(!1),[l,u]=p.useState([]),c=(d,f)=>n({action:J.COMMENT,userMessageType:k.CONSOLE,content:f==="fix"?xo(e,d):yo(e,d)});return p.useImperativeHandle(s,()=>({runCode:async(d,f)=>{if(!We(d))return;a(!0),u(g=>[...g,{type:Ae.RAN_CODE,ranAt:Date.now()}]);const h=_t(d),T=yn(o.current).evalAsync({code:f,type:h});for await(const g of T)g.type!==K.READY&&u(m=>[...m,g])},open:()=>a(!0)})),r?i.jsx(To,{logs:l,onClose:()=>a(!1),onClear:()=>u([]),isRequestActive:t,onRequestHelp:c}):null};p.forwardRef(Eo);const wo={type:"spring",damping:35,stiffness:300},bo=({clientThreadId:e,turn:t})=>{const n=Ln(),s=_n(t.messages);return i.jsxs(Q.div,{className:"absolute left-0 right-0 top-0 z-10 -translate-y-full",children:[i.jsx(Q.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 bg-vert-light-gradient dark:bg-vert-dark-gradient"}),i.jsx(Q.div,{className:"flex items-center px-6 py-2",initial:{opacity:.75,translateX:-50,translateY:"100%"},animate:{opacity:1,translateX:0,translateY:"0"},exit:{opacity:0,translateY:20},transition:wo,children:i.jsx(Xs,{clientThreadId:e,onChangeItemInView:re,onRequestCompletion:async o=>re(o),onRequestMoreCompletions:re,groupedMessagesToRender:s,allGroupedMessages:s,isEditing:!1,isUserTurn:!0,turnIndex:0,isCompletionRequestInProgress:!1,isFeedbackEnabled:!1,isFinalTurn:!1,hasActiveRequest:n,showEditButton:!1,handleEnterEdit:re,handleExitEdit:re})})]},"user-message")},So=({clientThreadId:e})=>{const t=Pn(e),n=Hn(e,t),{lastUserTurn:s,lastAssistantTurn:o}=p.useMemo(()=>{let a=null,l=null;for(let u=n.length-1;u>0;u--){const c=n[u];if(!a&&c.role===qe.User?a=c:!l&&c.role===qe.Assistant&&(l=c),a&&l)break}return{lastUserTurn:a,lastAssistantTurn:l}},[n]),r=s&&!o?.messages.find(({message:a})=>a.recipient?.startsWith($n));return i.jsx(Pt,{initial:!1,children:r&&i.jsx(bo,{turn:s,clientThreadId:e})})},Mo=({isRequestActive:e=!1,clientThreadId:t,onCancel:n,onSubmit:s,onSubmitAccelerator:o,acceleratorActions:r=[]})=>{const[a,l]=p.useState(!1),[u,c]=p.useState(""),[d,f]=p.useState(!0),h=q(),[T,g]=p.useState(!1),m=Ls(),C=()=>{s?.(u),c("")},x=v=>{const{metaKey:b,shiftKey:y,key:A}=v;A==="Enter"&&u.trim()&&!(y||b)&&(C(),v.preventDefault())};return i.jsxs(i.Fragment,{children:[a&&!m&&i.jsx(ks,{zIndexKey:"acceleratorsOverlay",className:"bg-white/95 dark:bg-black/85"}),i.jsx("div",{className:"relative mb-3 flex flex-1 justify-center",children:i.jsxs("div",{className:"mx-6 max-w-2xl flex-1",children:[i.jsx(So,{clientThreadId:t}),i.jsx("div",{className:"flex flex-auto items-start",children:i.jsx("div",{className:$("flex min-h-12 flex-auto items-center bg-[#f4f4f4] py-1 pl-6 pr-2 dark:bg-token-main-surface-secondary",{"rounded-full":d,"rounded-2xl":!d,"bg-transparent":T}),children:i.jsxs("div",{className:"relative flex flex-auto items-center self-stretch",children:[i.jsx(Qs,{placeholder:h.formatMessage({id:"zrUbTJ",defaultMessage:"Ask ChatGPT to edit"}),disabled:e,value:u,className:$("w-full resize-none border-0 bg-transparent p-0 text-token-text-primary outline-0 placeholder:text-token-text-secondary focus:ring-0 focus-visible:ring-0",{"opacity-0":T}),maxRows:4,onChange:({target:{value:v}})=>c(v),onKeyDown:x,onHeightChange:(v,{rowHeight:b})=>f(Math.floor(v/b)<=1)}),u?i.jsx(Q.button,{className:$("dark h-8 w-8 rounded-full bg-token-main-surface-primary text-center dark:bg-token-main-surface-primary",{"self-end":!d}),initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{type:"tween",duration:.1},onMouseDown:()=>C(),children:i.jsx(Fs,{className:"h-8 w-8 text-token-text-primary"})}):(r?.length??0)>0&&i.jsx(_s,{disableHint:!0,disableOverlay:!0,isEmbeddedInPromptArea:!0,isRequestActive:e,actions:r,onCancel:n,onExpandedChange:v=>{m||g(v),l(v)},onSubmit:o,right:0,bottom:4})]})})})]})})]})};function _(){}_.prototype={diff:function(t,n){var s,o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},r=o.callback;typeof o=="function"&&(r=o,o={});var a=this;function l(y){return y=a.postProcess(y,o),r?(setTimeout(function(){r(y)},0),!0):y}t=this.castInput(t,o),n=this.castInput(n,o),t=this.removeEmpty(this.tokenize(t,o)),n=this.removeEmpty(this.tokenize(n,o));var u=n.length,c=t.length,d=1,f=u+c;o.maxEditLength!=null&&(f=Math.min(f,o.maxEditLength));var h=(s=o.timeout)!==null&&s!==void 0?s:1/0,T=Date.now()+h,g=[{oldPos:-1,lastComponent:void 0}],m=this.extractCommon(g[0],n,t,0,o);if(g[0].oldPos+1>=c&&m+1>=u)return l(Et(a,g[0].lastComponent,n,t,a.useLongestToken));var C=-1/0,x=1/0;function v(){for(var y=Math.max(C,-d);y<=Math.min(x,d);y+=2){var A=void 0,M=g[y-1],D=g[y+1];M&&(g[y-1]=void 0);var S=!1;if(D){var F=D.oldPos-y;S=D&&0<=F&&F<u}var U=M&&M.oldPos+1<c;if(!S&&!U){g[y]=void 0;continue}if(!U||S&&M.oldPos<D.oldPos?A=a.addToPath(D,!0,!1,0,o):A=a.addToPath(M,!1,!0,1,o),m=a.extractCommon(A,n,t,y,o),A.oldPos+1>=c&&m+1>=u)return l(Et(a,A.lastComponent,n,t,a.useLongestToken));g[y]=A,A.oldPos+1>=c&&(x=Math.min(x,y-1)),m+1>=u&&(C=Math.max(C,y+1))}d++}if(r)(function y(){setTimeout(function(){if(d>f||Date.now()>T)return r();v()||y()},0)})();else for(;d<=f&&Date.now()<=T;){var b=v();if(b)return b}},addToPath:function(t,n,s,o,r){var a=t.lastComponent;return a&&!r.oneChangePerToken&&a.added===n&&a.removed===s?{oldPos:t.oldPos+o,lastComponent:{count:a.count+1,added:n,removed:s,previousComponent:a.previousComponent}}:{oldPos:t.oldPos+o,lastComponent:{count:1,added:n,removed:s,previousComponent:a}}},extractCommon:function(t,n,s,o,r){for(var a=n.length,l=s.length,u=t.oldPos,c=u-o,d=0;c+1<a&&u+1<l&&this.equals(s[u+1],n[c+1],r);)c++,u++,d++,r.oneChangePerToken&&(t.lastComponent={count:1,previousComponent:t.lastComponent,added:!1,removed:!1});return d&&!r.oneChangePerToken&&(t.lastComponent={count:d,previousComponent:t.lastComponent,added:!1,removed:!1}),t.oldPos=u,c},equals:function(t,n,s){return s.comparator?s.comparator(t,n):t===n||s.ignoreCase&&t.toLowerCase()===n.toLowerCase()},removeEmpty:function(t){for(var n=[],s=0;s<t.length;s++)t[s]&&n.push(t[s]);return n},castInput:function(t){return t},tokenize:function(t){return Array.from(t)},join:function(t){return t.join("")},postProcess:function(t){return t}};function Et(e,t,n,s,o){for(var r=[],a;t;)r.push(t),a=t.previousComponent,delete t.previousComponent,t=a;r.reverse();for(var l=0,u=r.length,c=0,d=0;l<u;l++){var f=r[l];if(f.removed)f.value=e.join(s.slice(d,d+f.count)),d+=f.count;else{if(!f.added&&o){var h=n.slice(c,c+f.count);h=h.map(function(T,g){var m=s[d+g];return m.length>T.length?m:T}),f.value=e.join(h)}else f.value=e.join(n.slice(c,c+f.count));c+=f.count,f.added||(d+=f.count)}}return r}function wt(e,t){var n;for(n=0;n<e.length&&n<t.length;n++)if(e[n]!=t[n])return e.slice(0,n);return e.slice(0,n)}function bt(e,t){var n;if(!e||!t||e[e.length-1]!=t[t.length-1])return"";for(n=0;n<e.length&&n<t.length;n++)if(e[e.length-(n+1)]!=t[t.length-(n+1)])return e.slice(-n);return e.slice(-n)}function Be(e,t,n){if(e.slice(0,t.length)!=t)throw Error("string ".concat(JSON.stringify(e)," doesn't start with prefix ").concat(JSON.stringify(t),"; this is a bug"));return n+e.slice(t.length)}function ze(e,t,n){if(!t)return e+n;if(e.slice(-t.length)!=t)throw Error("string ".concat(JSON.stringify(e)," doesn't end with suffix ").concat(JSON.stringify(t),"; this is a bug"));return e.slice(0,-t.length)+n}function ie(e,t){return Be(e,t,"")}function we(e,t){return ze(e,t,"")}function St(e,t){return t.slice(0,ko(e,t))}function ko(e,t){var n=0;e.length>t.length&&(n=e.length-t.length);var s=t.length;e.length<t.length&&(s=e.length);var o=Array(s),r=0;o[0]=0;for(var a=1;a<s;a++){for(t[a]==t[r]?o[a]=o[r]:o[a]=r;r>0&&t[a]!=t[r];)r=o[r];t[a]==t[r]&&r++}r=0;for(var l=n;l<e.length;l++){for(;r>0&&e[l]!=t[r];)r=o[r];e[l]==t[r]&&r++}return r}var De="a-zA-Z0-9_\\u{C0}-\\u{FF}\\u{D8}-\\u{F6}\\u{F8}-\\u{2C6}\\u{2C8}-\\u{2D7}\\u{2DE}-\\u{2FF}\\u{1E00}-\\u{1EFF}",Ao=new RegExp("[".concat(De,"]+|\\s+|[^").concat(De,"]"),"ug"),je=new _;je.equals=function(e,t,n){return n.ignoreCase&&(e=e.toLowerCase(),t=t.toLowerCase()),e.trim()===t.trim()};je.tokenize=function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n;if(t.intlSegmenter){if(t.intlSegmenter.resolvedOptions().granularity!="word")throw new Error('The segmenter passed must have a granularity of "word"');n=Array.from(t.intlSegmenter.segment(e),function(r){return r.segment})}else n=e.match(Ao)||[];var s=[],o=null;return n.forEach(function(r){/\s/.test(r)?o==null?s.push(r):s.push(s.pop()+r):/\s/.test(o)?s[s.length-1]==o?s.push(s.pop()+r):s.push(o+r):s.push(r),o=r}),s};je.join=function(e){return e.map(function(t,n){return n==0?t:t.replace(/^\s+/,"")}).join("")};je.postProcess=function(e,t){if(!e||t.oneChangePerToken)return e;var n=null,s=null,o=null;return e.forEach(function(r){r.added?s=r:r.removed?o=r:((s||o)&&Mt(n,o,s,r),n=r,s=null,o=null)}),(s||o)&&Mt(n,o,s,null),e};function Mt(e,t,n,s){if(t&&n){var o=t.value.match(/^\s*/)[0],r=t.value.match(/\s*$/)[0],a=n.value.match(/^\s*/)[0],l=n.value.match(/\s*$/)[0];if(e){var u=wt(o,a);e.value=ze(e.value,a,u),t.value=ie(t.value,u),n.value=ie(n.value,u)}if(s){var c=bt(r,l);s.value=Be(s.value,l,c),t.value=we(t.value,c),n.value=we(n.value,c)}}else if(n)e&&(n.value=n.value.replace(/^\s*/,"")),s&&(s.value=s.value.replace(/^\s*/,""));else if(e&&s){var d=s.value.match(/^\s*/)[0],f=t.value.match(/^\s*/)[0],h=t.value.match(/\s*$/)[0],T=wt(d,f);t.value=ie(t.value,T);var g=bt(ie(d,T),h);t.value=we(t.value,g),s.value=Be(s.value,d,g),e.value=ze(e.value,d,d.slice(0,d.length-g.length))}else if(s){var m=s.value.match(/^\s*/)[0],C=t.value.match(/\s*$/)[0],x=St(C,m);t.value=we(t.value,x)}else if(e){var v=e.value.match(/\s*$/)[0],b=t.value.match(/^\s*/)[0],y=St(v,b);t.value=ie(t.value,y)}}var No=new _;No.tokenize=function(e){var t=new RegExp("(\\r?\\n)|[".concat(De,"]+|[^\\S\\n\\r]+|[^").concat(De,"]"),"ug");return e.match(t)||[]};var Ie=new _;Ie.tokenize=function(e,t){t.stripTrailingCr&&(e=e.replace(/\r\n/g,`
`));var n=[],s=e.split(/(\n|\r\n)/);s[s.length-1]||s.pop();for(var o=0;o<s.length;o++){var r=s[o];o%2&&!t.newlineIsToken?n[n.length-1]+=r:n.push(r)}return n};Ie.equals=function(e,t,n){return n.ignoreWhitespace?((!n.newlineIsToken||!e.includes(`
`))&&(e=e.trim()),(!n.newlineIsToken||!t.includes(`
`))&&(t=t.trim())):n.ignoreNewlineAtEof&&!n.newlineIsToken&&(e.endsWith(`
`)&&(e=e.slice(0,-1)),t.endsWith(`
`)&&(t=t.slice(0,-1))),_.prototype.equals.call(this,e,t,n)};function Do(e,t,n){return Ie.diff(e,t,n)}var jo=new _;jo.tokenize=function(e){return e.split(/(\S.+?[.!?])(?=\s+|$)/)};var Io=new _;Io.tokenize=function(e){return e.split(/([{}:;,]|\s+)/)};function Ge(e){"@babel/helpers - typeof";return Ge=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Ge(e)}var me=new _;me.useLongestToken=!0;me.tokenize=Ie.tokenize;me.castInput=function(e,t){var n=t.undefinedReplacement,s=t.stringifyReplacer,o=s===void 0?function(r,a){return typeof a>"u"?n:a}:s;return typeof e=="string"?e:JSON.stringify(Ve(e,null,null,o),o,"  ")};me.equals=function(e,t,n){return _.prototype.equals.call(me,e.replace(/,([\r\n])/g,"$1"),t.replace(/,([\r\n])/g,"$1"),n)};function Ve(e,t,n,s,o){t=t||[],n=n||[],s&&(e=s(o,e));var r;for(r=0;r<t.length;r+=1)if(t[r]===e)return n[r];var a;if(Object.prototype.toString.call(e)==="[object Array]"){for(t.push(e),a=new Array(e.length),n.push(a),r=0;r<e.length;r+=1)a[r]=Ve(e[r],t,n,s,o);return t.pop(),n.pop(),a}if(e&&e.toJSON&&(e=e.toJSON()),Ge(e)==="object"&&e!==null){t.push(e),a={},n.push(a);var l=[],u;for(u in e)Object.prototype.hasOwnProperty.call(e,u)&&l.push(u);for(l.sort(),r=0;r<l.length;r+=1)u=l[r],a[u]=Ve(e[u],t,n,s,u);t.pop(),n.pop()}else a=e;return a}var Ye=new _;Ye.tokenize=function(e){return e.slice()};Ye.join=Ye.removeEmpty=function(e){return e};var be=(e=>(e.ADDED="added",e.REMOVED="removed",e.UNCHANGED="unchanged",e))(be||{});function Je(e){if(e==="")return 0;const t=e.split(`
`).length;return e.endsWith(`
`)?t-1:t}function Oo(e,t){return Do(e,t,{newlineIsToken:!0}).map(s=>({count:s.count??Je(s.value),value:s.value,type:s.added?"added":s.removed?"removed":"unchanged"}))}function Ro(e){let t="";for(const{type:n,value:s}of e)(n==="added"||n==="unchanged")&&(t+=s);return t}function Lo(e,t){const n=Je(t),s=Ho(e,n);return{changes:Oo(s,t),numLinesDiffed:n}}function _o(e){const t=[...e],n=[],s=[];for(;t.length>0;){const o=t[t.length-1];if(o.type===be.REMOVED)t.pop(),o.type===be.REMOVED&&n.unshift(o);else if(o.type===be.ADDED)t.pop(),s.unshift(o);else break}return{prunedChanges:[...t,...s],prunedRemovedChanges:n}}function Po(e,t){const{changes:n,numLinesDiffed:s}=Lo(e,t),{prunedChanges:o,prunedRemovedChanges:r}=_o(n),a=Ro(o),l=r.map(c=>c.value).join(`
`),u=Wt(e,s,"start");return{content:a+l+u,numLinesDiffed:Je(a)}}function Ho(e,t){if(t<=0)return"";let n=0,s=e.length;for(let o=0;o<e.length;o++)if(e[o]===`
`&&(n++,n===t)){s=o+1;break}return e.substring(0,s)}function Wt(e,t,n="start"){if(t<=0)return e;if(n==="start"){let a=0;for(let l=0;l<e.length;l++)if(e[l]===`
`&&(a++,a===t))return e.substring(l+1);return""}let s=0,o=-1;const r=e.endsWith(`
`)?t+1:t;for(let a=e.length-1;a>=0;a--)if(e[a]===`
`&&(s++,s===r)){o=a;break}return o===-1?"":e.substring(0,o+1)}function $o(e,t){const n=e?.type??R.LOADING,s=e?.content??"",o=Ht(e);if(!ue(n)||t==null||!o||!$t(e))return{content:s,currentlyStreamingLineIndex:null};const r=Wt(s,1,"end");if(r==="")return{content:t.content,currentlyStreamingLineIndex:0};const a=Po(t.content,r);return{content:a.content,currentlyStreamingLineIndex:a.numLinesDiffed}}function qo(e,t){const n=new Set(e.map(l=>l.id)),s=new Set(t.map(l=>l.id)),o=e.filter(l=>!s.has(l.id)).map(l=>({...l,diffStatus:ht.REMOVED})),r=t.filter(l=>!n.has(l.id)).map(l=>({...l,diffStatus:ht.ADDED})),a=e.filter(l=>s.has(l.id));return o.concat(r,a)}function Fo({textdocVersion:e}){const t=q(),n=Tn(),[s,o]=p.useState(!1),r=En(),a=p.useRef(e?.content??"");p.useEffect(()=>{a.current=e?.content??""},[e]);const l=u=>{s||(r(()=>{L.logButtonClick(de.COPY,{contentLength:a.current.length,textdocType:e?.type}),qn(a.current,n,u)},0),o(!0),r(()=>o(!1),2e3))};return i.jsx(te,{label:t.formatMessage(Uo.copy),children:i.jsx(ne,{icon:s?Us:Bs,onClick:l})})}const Uo=se({copy:{id:"rbIYfo",defaultMessage:"Copy"}});function Bo({disabled:e=!1,textdocId:t,version:n,isHistorical:s,isShowingChanges:o,latestVersionInt:r,nextVersion:a,previousVersion:l,onHoverPrevious:u,textdocType:c}){const d=q(),f=n==null||n===1,h=n!=null&&n>1;return f&&!s?null:i.jsxs("div",{className:"flex items-center gap-1.5",children:[i.jsx(te,{label:h&&d.formatMessage({id:"PoD5+8",defaultMessage:"Previous version"}),children:i.jsx(ne,{disabled:!h||e,icon:zs,onMouseOver:u,onClick:()=>{L.logButtonClick(de.HISTORY_PREVIOUS,{textdocType:c,isShowingChanges:o,textdocId:t,versionInt:n}),t&&n&&h&&Se(t,{beforeVersion:n},o&&l!=null?l:void 0)}})}),i.jsx(te,{label:s&&d.formatMessage({id:"PJ8YVJ",defaultMessage:"Next version"}),children:i.jsx(ne,{disabled:!s||e,icon:Gs,onClick:()=>{L.logButtonClick(de.HISTORY_NEXT,{textdocType:c,isShowingChanges:o,textdocId:t,versionInt:n}),s&&(a?Se(t,{version:a},o?a:void 0):o&&r?qt(t,r,null):fe(t))}})})]})}function zo({disabled:e=!1,isShowingCodePreview:t,onClick:n}){const[s,o]=p.useState(!1),r=q(),a=()=>{o(!0)},l=()=>{o(!1)};return i.jsx(te,{label:t?r.formatMessage(kt.hidePreview):r.formatMessage(kt.showPreview),children:i.jsx(ne,{disabled:e,onMouseEnter:a,onMouseLeave:l,icon:Vs,onClick:n,className:$("transition-colors",{[Me.hoverActive]:s&&t,[Me.active]:!s&&t})})})}const kt=se({showPreview:{id:"m61vYn",defaultMessage:"Preview code"},hidePreview:{id:"ot1Rmq",defaultMessage:"Preview code"}});function Go({disabled:e=!1,textdocId:t,textdocType:n,history:s,version:o,isShowingChanges:r,latestVersionInt:a,onMouseEnter:l}){const u=q(),[c,d]=p.useState(!1),f=()=>{s?Se(t,s):fe(t)},h=(o?.versionInt??0)>1,T=()=>{L.logButtonClick(de.SHOW_CHANGES,{textdocType:n,textdocId:t,versionInt:o?.versionInt,latestVersionInt:a}),o?.versionInt!=null&&qt(t,o.versionInt,s)},g=()=>{d(!0),l?.()},m=()=>{d(!1)};return i.jsx(te,{label:h&&u.formatMessage(r?At.hideChanges:At.showChanges),children:i.jsx(ne,{icon:Ys,disabled:!h||e,onClick:r?f:T,onMouseEnter:g,onMouseLeave:m,className:$("transition-colors",{[Me.hoverActive]:c&&r&&h,[Me.active]:!c&&r&&h,"!bg-transparent":!c&&!r&&h})})})}const At=se({done:{id:"0MCBfo",defaultMessage:"Done"},showChanges:{id:"3jMGNS",defaultMessage:"Show changes"},hideChanges:{id:"HWiQSk",defaultMessage:"Hide changes"}}),Vo=800,Yo=100,Nt=100,Wo=({textdocId:e,isHistoricalVersion:t,nextHistoricalTextdocVersion:n,previousHistoricalTextdocVersion:s,textdocVersion:o,readonlyReason:r,history:a,latestVersionInt:l,hasDebug:u,contentWidth:c,isEmbedded:d,isPersisting:f,isShowChangesFeatureEnabled:h,isShowingChanges:T,hideHistoryActions:g=!1,prefetchHistoricalTextdocVersion:m,restoreHistoricalTextdocVersion:C,setShowDebugView:x,onClickCodePreview:v,onClose:b,isShowingCodePreview:y})=>{const A=Fn(o?.title??""),[{width:M},D]=Ft(),S=c-M-Yo-Nt>0,F=Ut(),U=Bt(),B=zt(),j=o==null?!1:Ue(o.type,o.content)&&U||We(o.type)&&B,W=$("transition-opacity duration-500",r===O.Streaming&&"pointer-events-none opacity-0");return i.jsxs(le.Header,{children:[i.jsxs("div",{className:"flex flex-1 items-center leading-[0]",children:[i.jsx(le.CloseButton,{onClick:b}),S&&i.jsx("div",{className:"flex flex-row items-center gap-2.5",children:i.jsx(le.Title,{style:{maxWidth:c-M-Nt},children:A||i.jsx("div",{className:"w-52",children:i.jsx(Zs,{lines:1,size:"base",width:100,widthVariance:0})})})}),f&&i.jsx(Un,{size:12,className:"pl-2 text-token-text-secondary"})]}),i.jsxs("div",{className:"flex select-none items-center gap-2 leading-[0]",ref:D,children:[i.jsxs("div",{className:"flex items-center gap-2",children:[u&&c>Vo&&i.jsx(ne,{icon:Ws,onClick:()=>x(z=>!z)}),!g&&i.jsx("div",{className:W,children:i.jsx(Bo,{disabled:r===O.Streaming,textdocId:e,isHistorical:t,isShowingChanges:T,version:o?.versionInt,previousVersion:s?.versionInt,nextVersion:n?.versionInt,readonlyReason:r,onHoverPrevious:m,onClickRestore:C,textdocType:o?.type,latestVersionInt:l})}),!g&&h&&i.jsx("div",{className:W,children:i.jsx(Go,{disabled:r===O.Streaming,textdocId:e,textdocType:o?.type,history:a,version:o,isShowingChanges:T,latestVersionInt:l,onMouseEnter:()=>{o?.versionInt&&F(e,o.versionInt),m()}})}),j&&i.jsx(zo,{disabled:o?.versionInt==null,onClick:v,isShowingCodePreview:y}),i.jsx(Fo,{textdocVersion:o})]}),!d&&i.jsx(As,{})]})]})},Jo=/\s/,Qo=30;function Dt(e,t){const n=e.indexOf(t);return n===-1?!1:e.indexOf(t,n+t.length)===-1}function Y(e,t){return Jo.test(e[t])}function jt(e,t,n=!1){if(t===0||n&&Y(e,t-1))return t;for(;t>0&&Y(e,t-1);)t--;for(;t>0&&!Y(e,t-1);)t--;return Y(e,t)&&t++,t}function It(e,t,n=!1){if(t===e.length||n&&Y(e,t))return t;for(;t<e.length&&Y(e,t);)t++;for(;t<e.length&&!Y(e,t);)t++;return Y(e,t-1)&&t--,t}function Xo(e,t,n=!0,s=Qo){if(e.start<0||e.end>t.length||e.start>e.end)throw new Error("Invalid commentSourceRange provided.");const o=t.substring(e.start,e.end);let r=e.start,a=e.end;n&&(r=jt(t,r,!0),a=It(t,a,!0));let l=t.substring(r,e.start),u=t.substring(e.end,a),c=`${l}${o}${u}`;if(Dt(t,c)&&(s==null||c.length>=s))return{before:l,after:u,allSurrounding:c};let d=r,f=a,h=!0;for(;h&&(s==null||c.length<s);){let T=!1;const g=d>0?jt(t,d):d;g<d&&(d=g,T=!0);const m=f<t.length?It(t,f):f;if(m>f&&(f=m,T=!0),T){const C=t.substring(d,e.start),x=t.substring(e.end,f),v=`${C}${o}${x}`;if(Dt(t,v)&&(s==null||v.length>=s))return{before:C,after:x,allSurrounding:v};l=C,u=x,c=v}else h=!1}return{before:l,after:u,allSurrounding:c}}const he="# Context",pe="# Instructions";function ge(e,t,n){if(t==null||n==null)return`The user is referring to the entire text of "${e}".`;const s=`
## Selected Text
The user has selected this text in "${e}" in particular:
${t}
`.trim();return n.allSurrounding===t?s:`
${s}

## Surrounding Context
Here is the surrounding context:
${n.allSurrounding}
`.trim()}function Jt(e,t){return e==null||t==null?"entire document":e===t.allSurrounding?"selected text":"surrounding context"}function Qt(e){return`For the update pattern, create a regex which exactly matches the ${e}. Edit just this string in order to fullfill the user's request. NEVER rewrite the entire document. Instead, ALWAYS edit ONLY the ${e}. The only exception to this rule is if the ${e} includes markdown lists or tables. In that case, fully rewrite the document using ".*" as the regex update pattern.`.trim()}function Zo(e,t,n,s){if(!ue(t)&&n&&s){const o=Jt(n,s);return`
${he}
The user requests that you directly edit the document.

${ge(e,n,s)}

${pe}
Use the update_textdoc tool to make this edit. ${Qt(o)}`.trim()}return`
${he}
The user requests that you directly edit the document.

${ge(e,n,s)}

${pe}
Use the update_textdoc tool to make this edit. You MUST fully rewrite the entire document by using ".*" as the update regex pattern.`.trim()}function Ko(e,t,n){return`
${he}
The user requests that you add comments about some text.

${ge(e,t,n)}

${pe}
Do not respond to the user's question directly, just leave comments.`.trim()}function er(e,t){return ue(e)?t==="entire document"?` If you choose to update the ${t}, you MUST fully rewrite the ${t} by using ".*" as the update regex pattern.`:` If you choose to update the ${t}, you MUST fully rewrite the entire document by using ".*" as the update regex pattern. When you do so, ONLY modify the ${t} and rewrite other sections exactly as is, except for parts that must change based on this update`:t==="entire document"?"":` If you choose to update the ${t}, follow these instructions: ${Qt(t)}`}function tr(e,t,n,s){const o=Jt(n,s),r=er(t,o);return`
${he}
${ge(e,n,s)}

${pe}
The user would like you perform one of the following actions:
- Update the ${o} via the \`update_textdoc\` tool.${r}
- Explain the selected text via chat, or answer a general question about the selected text (no tool call required).
- Comment on the ${o} with feedback via the \`comment_textdoc\` tool. This should only be used if the user very explicitly asks for feedback, critique, or comments.

Based on the user's request, choose the appropriate action.
`.trim()}function nr(e,t,n){return`
${he}
${ge(e,t,n)}

${pe}
The user would like you to create a new textdoc.
`.trim()}function sr(e,t,n,s=null,o=null){switch(n){case J.ASK:return tr(e,t,s,o);case J.CREATE_TEXTDOC:return nr(e,s,o);case J.EDIT:return Zo(e,t,s,o);case J.COMMENT:return Ko(e,s,o)}}function or(e){switch(e){case k.ACCELERATOR:case k.CONSOLE:case k.ACCEPT_COMMENT:return!0;case k.ASK_CHATGPT:case k.FULL_SCREEN_SUBMIT:return!1}}function rr(e,t){switch(t){case k.ASK_CHATGPT:case k.ACCEPT_COMMENT:case k.FULL_SCREEN_SUBMIT:return e.formatMessage(ir.askChatGPT);case k.ACCELERATOR:case k.CONSOLE:return}}const ar=(e,t)=>{const n=q(),{tags:s}=Bn(e),o=zn(),r=Gn(e),a=Vn(e)??o.id,l=Yn({clientThreadId:e});return p.useCallback(async({content:u,sourceRange:c,action:d,userMessageType:f,acceleratorMetadata:h,selectionMetadata:T})=>{if(t?.versionInt==null)return;const{textdocId:g,type:m,versionInt:C,content:x}=t;let v,b=null;c&&c.start!==c.end&&(v=x.slice(c.start,c.end),b=Xo(c,x));const y=sr(g,m,d,v,b),M=Wn(y,{exclude_after_next_user_message:!0}),D=performance.now(),S=await wn(),[F,U,B]=await Promise.all([bn.getEnforcementToken(S),Jn.getEnforcementToken(S),Sn.getEnforcementToken(S)]),j=new Qn,W=pt.getThreadCurrentLeafId(e),z=`${W}-nextPrompt`;pt.updateTree(e,Oe=>{Oe.addNode(z,u,W,qe.User,void 0,{canvas:{textdoc_id:g,textdoc_type:m,version:C,textdoc_content_length:x.length,user_message_type:f,accelerator_metadata:h,selection_metadata:T},is_visually_hidden_from_conversation:or(f),targeted_reply:v,targeted_reply_label:rr(n,f),open_in_canvas_view:{type:"canvas_textdoc",id:g}})}),l({model:a,completionType:Mn.Next,parentNodeId:z,metadata:{eventSource:"mouse"},completionMetadata:r?{conversationMode:r}:void 0,chatReq:S,arkoseToken:F??null,turnstileToken:U??null,proofToken:B??null,preflightTime:performance.now()-D,appendMessages:[M],turnTracker:j})},[t,s,e,l,a,r,n])},ir=se({askChatGPT:{id:"h5ANdM",defaultMessage:"Asked ChatGPT"}});function lr(e){const t=/\[([^\]]+)\]\((https?:\/\/[^\s)]+|www\.[^\s)]+)\)/gi,n=new Set,s=e.matchAll(t);for(const o of s){const r=o[2];try{let a=r;a.startsWith("www.")&&(a="http://"+r),new URL(a),n.add(r)}catch{}}return n}const cr=async({lastVersion:e,textdocId:t,content:n,comments:s})=>{const o=Xn(s,n);return(await Rt.safePost("/textdoc/{textdoc_id}",{parameters:{path:{textdoc_id:t}},requestBody:{version:e,content:n,comments:o}})).version},ur=()=>{const e=p.useRef([]),t=p.useRef(null),{mutateAsync:n,isPending:s}=kn({mutationKey:["canvas","textdoc","persist"],mutationFn:cr});return[p.useCallback(async(r,a,l)=>{const u=new AbortController,d=(async()=>{const[g]=e.current;try{await g?.promise}catch(m){L.logError("Saving document",m)}if(!u.signal.aborted)try{const m=Math.max(t.current??0,r.versionInt??Gt);let C="";try{ft(a)?C=a():C=a}catch(y){L.logError("Serializing document",y)}let x=[];try{ft(l)?x=l():x=l}catch(y){L.logError("Adjusting comments",y)}const{textdocId:v}=r;Zn({textdocId:v,basedOnVersionInt:m,content:C,comments:x});const b=await n({textdocId:v,lastVersion:m,content:C,comments:x});Kn({textdocId:v,basedOnVersionInt:m,newVersion:b}),t.current=b}catch(m){L.logError("Error saving document",m)}finally{e.current.shift()}})(),f={abort:()=>u.abort(),promise:d},[h,T]=e.current;return T&&(T.abort(),e.current=h?[h]:[]),e.current=h?[h,f]:[f],d},[n]),e,s]},dr=3e3,fr=e=>{const[t,n,s]=ur(),o=q(),r=p.useRef(null),a=p.useCallback(es(t,dr,{leading:!1}),[t]),l=ts(e);return p.useEffect(()=>{if(!l)return;const c=mt(window,{pagehide:()=>a.flush(),beforeunload:f=>{a.flush(),f.returnValue=o.formatMessage({id:"QZrKwi",defaultMessage:"You have a canvas save in progress."})}}),d=mt(document,{visibilitychange:()=>a.flush(),keydown:()=>{r.current="keyboard"},mousemove:()=>{r.current!=="mouse"&&a.flush(),r.current="mouse"}});return()=>{r.current=null,d(),c()}},[o,l,a]),p.useEffect(()=>()=>{a.flush()},[e,a]),ns(async()=>{await a.flush(),await Promise.allSettled(n.current?.map(({promise:c})=>c)??[])}),[p.useCallback((c,d,f)=>{const{textdocId:h}=c;return ss(h),a(c,d,f)},[a]),a.flush,s||l]};function mr(e,t,n){const s=Lt(),o=n!=null&&t!=null,{data:r,error:a,fetchNextPage:l,hasNextPage:u,isFetching:c}=An(Ot(e,t,o)),d=p.useCallback(async()=>{const m=t!=null;await s.prefetchInfiniteQuery(Ot(e,t,m))},[s,e,t]);p.useEffect(()=>{const m=t;return()=>{s.removeQueries({queryKey:Xt(e,m),exact:!0})}},[s,e,t]);const[f,h,T,g]=p.useMemo(()=>{if(r&&n){const C=r.pages.flatMap(v=>v),x=C.findIndex(v=>"beforeVersion"in n?(v.versionInt??Gt)<n.beforeVersion:v.versionInt===n.version);if(x!==-1)return[x===C.length-1,C[x],x>0?C[x-1]:null,x<C.length-1?C[x+1]:null]}const m=r?.pages.flatMap(C=>C)??[];return[!0,null,null,m.length===0?null:m[0]]},[r,n]);return p.useEffect(()=>{!c&&o&&u&&f&&l()},[c,o,u,f,l]),p.useEffect(()=>{!h&&a&&fe(e)},[h,a,e]),{historicalTextdocVersion:h,nextHistoricalTextdocVersion:T,prefetchHistoricalTextdocVersion:d,previousHistoricalTextdocVersion:g}}function Xt(e,t=null){return["textdocHistory",e,t]}function Ot(e,t,n=!0){return{queryKey:Xt(e,t),queryFn:({pageParam:s})=>hr(e,s),initialPageParam:t??void 0,getNextPageParam:s=>{const o=os(s)?.versionInt;if(o&&o>1)return o},enabled:n,staleTime:1/0,retry:2}}async function hr(e,t){return t===void 0?[]:(await Rt.safeGet("/textdoc/{textdoc_id}/history",{parameters:{path:{textdoc_id:e},query:{before_version:t}}})).previous_doc_states.map(({id:s,version:o,textdoc_type:r,title:a,content:l,updated_at:u,comments:c})=>({textdocId:s,versionInt:o,messageId:null,title:a,type:rs(r),content:l,status:as.COMPLETE,createdAt:is(u),comments:ls(c,l)}))}const Ir=({isFullScreen:e=!1,isEmbedded:t=!1,hideHeader:n=!1,readonlyReason:s,clientThreadId:o,focusedTextdoc:r,onClose:a,isAnimating:l=!1,width:u,hideBottomComposer:c=!1})=>{const{textdocId:d,history:f,showChangesAtVersion:h=null}=r,T=Bt(),[g,m,C]=fr(d),{targetedContent:x}=cs(),v=us(),[b,y]=p.useState(!1),A=ds(d),M=fs(),D=ms(o),S=hs(D),[F,U]=Ft(),B=ps(),{data:j,isLoading:W}=gs(d,B?h:null),[z,Oe]=p.useState(!1),P=A?.versions??[],Qe=P[0]?.versionInt,{historicalTextdocVersion:ve,nextHistoricalTextdocVersion:Zt,previousHistoricalTextdocVersion:Xe,prefetchHistoricalTextdocVersion:Kt}=mr(d,Qe,f),en=Ut();p.useEffect(()=>{ke.reset()},[d]);const Ze=P.length>0?P[P.length-1]:null,Re=P.length>1?P[P.length-2]:null,Ke=vs(o),{restoreHistoricalTextdocVersion:et,optimisticRestoredTextdocVersion:tn}=Cs(Ke,Ze,ve),X=f!=null,w=X?ve:Ze,Ce=B&&h!=null,xe=ar(o,w),tt=l||!B?null:j,ye=(()=>{if(l||w==null)return[];const E=yt(w.comments);return!Ce&&ve!=null?ve.comments:!Ce||j==null?E:j.contentBefore!==j.contentAfter?[]:qo(j.commentsBefore,j.commentsAfter)})(),H=w?.type??R.LOADING,nn=xs(),oe=Ht(w),Le=$t(w),sn=ys(w),on=eo(M);p.useEffect(()=>{P.length===0&&!M&&on&&a?.()},[P.length,M]);const rn=!!s&&s!==O.OldVersion,{content:G,currentlyStreamingLineIndex:nt}=j?.contentBefore!=null&&!ue(H)?{content:j.contentBefore,currentlyStreamingLineIndex:null}:$o(w,Re),an=Ks(Ke,Array.from(lr(G))),[Te,_e]=io({value:G,isRequestActive:S,isTextdocStreaming:oe,comments:ye}),st=Ts(w);p.useEffect(()=>{d&&gt().sendMessage({type:Fe.Loaded})},[d]);const ot=nn===Es.LAST_TURN||Te||C;p.useEffect(()=>{gt().sendMessage({type:Fe.Streaming,streaming:ot})},[ot]);const ln=({getSerializedDocument:E,getAdjustedComments:N})=>{w&&g(w,E,N)},cn=E=>{if(!w)return;const N=E.doc.toString();g(w,N,E.field(Is,!1)??[])},rt=(E,N,V,Z)=>{_e(!0),xe({action:N,content:E,userMessageType:k.ASK_CHATGPT,sourceRange:V,selectionMetadata:{selection_type:Z,selection_position_range:V}})},at=({id:E})=>{st(E,vt.DISMISS),ke.reset()},it=async E=>{_e(!0);const{id:N,at:V,content:Z}=E;if(await st(N,vt.ACCEPT)===!1)return _e(!1);xe({content:Z,userMessageType:k.ACCEPT_COMMENT,sourceRange:V,action:J.EDIT,selectionMetadata:{selection_type:Ct.SELECTION,selection_position_range:V}})},Pe=(E,N,V)=>{const{action:Z}=V;xe({action:Z,content:N,sourceRange:E,userMessageType:k.ACCELERATOR,acceleratorMetadata:{action:Z,id:V.id,prompt:N},selectionMetadata:E!=null?{selection_type:Ct.SELECTION,selection_position_range:E}:void 0})},un=E=>{xe({action:J.EDIT,content:E,userMessageType:k.FULL_SCREEN_SUBMIT})},dn=Nn(),fn=Lt(),mn=ws(),lt=E=>mn?.[E]??E,He=()=>Ms({clientThreadId:o,currentRequestId:D,queryClient:fn,isHistoryAndTrainingDisabled:dn}),hn=()=>{f?Se(d,f):fe(d)};let I=s;X?I=O.OldVersion:Ce?I=O.ShowingChanges:tn!=null?I=O.Restoring:(oe||S)&&(I=O.Streaming);let Ee=null;const ct=l||I!=null||Te,ut=()=>{if(l&&ye.length>0)return ae.ALL_HIDDEN;if(I==null)return ae.ENABLED;switch(I){case O.Streaming:return ae.ENABLED;case O.ShowingChanges:case O.OldVersion:return ae.COMMENTS_READONLY;default:return ae.ALL_HIDDEN}},dt=e||l;let $e=[];switch(H){case R.LOADING:Ee=i.jsx(js,{});break;case R.DOCUMENT:Ee=i.jsx(Ds,{value:G,comments:ye,previousValue:Re?.content,previousComments:yt(Re?.comments),isRewriting:Le,isAnimatingFromPreview:l,getStableCommentId:lt,diff:tt,isRequestActive:S,isDisabled:I!=null||M,isWaitingForCommentResponse:Te,hideAccelerators:dt,hideToolbar:ct,hideEditOverlay:l,commentsMode:ut(),readonlyReason:I,onBlur:m,onSave:m,onChange:ln,onCancelRequest:He,targetedContent:x,onAddComment:rt,onAcceptComment:it,onDismissComment:at,onSubmitAccelerator:Pe,onExitShowChanges:hn,safeUrls:an,width:u,modelCursor:oe&&!Le?w?.modelCursor:void 0,shouldResetSelection:w?.versionInt===1}),$e=Js;break;default:if(ue(H)){const E=Ue(H,G),N=i.jsx(Ns,{id:"codemirror",getStableCommentId:lt,language:_t(H),value:G,comments:ye,hideAccelerators:dt,commentsMode:ut(),hideToolbar:ct,onSubmitAccelerator:Pe,currentlyStreamingLineIndex:nt??null,readonlyReason:I,isRequestActive:S,isWaitingForCommentResponse:Te,onChange:cn,onCancelRequest:He,onAddComment:rt,onDismissComment:at,onAcceptComment:it,textdocDiff:tt??void 0,modelCursor:oe&&nt==null?w?.modelCursor:void 0});Ee=!T||!E?N:i.jsxs(i.Fragment,{children:[i.jsx("div",{style:{display:z?"none":"block"},children:N}),i.jsx(ao,{hidden:!z,isStreaming:oe,textdocContent:G,textdocType:H})]}),$e=Os}}const pn=p.useRef(null);zt()&&!X&&We(H);const gn=()=>{Ue(H,G)?Oe(E=>!E):pn.current?.runCode(H,G)},{eligible:vn}=bs();return i.jsxs(le,{children:[!n&&i.jsx(Wo,{textdocId:d,isHistoricalVersion:X,nextHistoricalTextdocVersion:Zt,previousHistoricalTextdocVersion:Xe,textdocVersion:w,readonlyReason:I,history:f,hasDebug:v,contentWidth:F.width,isEmbedded:t,isPersisting:C,isShowChangesFeatureEnabled:B,isShowingChanges:Ce,latestVersionInt:Qe,hideHistoryActions:I===O.QueryParam,prefetchHistoricalTextdocVersion:()=>{Kt();const E=Xe?.versionInt;E!=null&&en(d,E)},restoreHistoricalTextdocVersion:et,setShowDebugView:y,onClose:()=>{L.logButtonClick(de.CLOSE_TEXTDOC,{textdocType:w?.type}),a?.()},onClickCodePreview:gn,isShowingCodePreview:z}),i.jsxs(le.Content,{ref:U,scrollToBottomMode:sn?"bottom":"top",shouldScrollToTop:Le,isLoading:W,children:[!1,Ee]}),!1,i.jsx(Pt,{children:X&&!rn&&i.jsx(lo,{onClickRestore:et,onClickResetLatest:()=>fe(d)})}),e&&!X&&!c&&i.jsx(Mo,{isRequestActive:S,clientThreadId:o,onSubmitAccelerator:Pe,onSubmit:un,onCancel:He,acceleratorActions:$e}),!l&&vn&&i.jsx(Ss,{})]})};export{Fe as C,Ir as T,no as g,to as i};
//# sourceMappingURL=nko4k8qxio6odphu.js.map
