const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/sso-dud3eqjhdwr0lbxq.js","assets/jeen44fo1keunqlc.js","assets/hisz4iug0sf9ooju.js","assets/root-dqeznvm0.css","assets/osf8maqq52t0ie0w.js","assets/index-small-c8xg50op.css","assets/h2ieknsganxwp6x6.js","assets/m3qjut27is4ffm4j.js","assets/ca4desjes5mv8zbl.js","assets/nhwwej1nq0zrd7sc.js","assets/dr07qw6lnct4p2zz.js","assets/iw6awycy9wj28390.js","assets/gy8d176d0tsqf86m.js","assets/b4y2ge3nobhogt80.js","assets/gzlpoy4y44ngaze8.js","assets/902js3wv32aa6t6i.js","assets/fo7v79q2e1o0khon.js","assets/go83o9hn30nv31xb.js","assets/d0g8ptgc5gcqjwyj.js","assets/mb7mlvvuuhva3i2t.js","assets/i2voxlhkxkv1hfuj.js","assets/isjdmfmhzv09v01t.js","assets/b0f338h0n7rkc1qg.js","assets/jgpw9njq8se3lohd.js","assets/dkhpiq5qymmlvz34.js","assets/go2vsa5jpfhtubby.js","assets/jel7etjldxf47nf5.js","assets/fauj73bf32iau7uq.js","assets/oerftj7hix4so9t1.js","assets/nd1t87udoodrtith.js","assets/kpoveei5hnu2tqeb.js","assets/kcsmafgkk9zt34c5.js","assets/gm90afxwqsk9j981.js","assets/fsddy3bxlesj6ecw.js","assets/e667zy3qj22ojntx.js","assets/kv1b7h6ossvj0k3i.js","assets/eiw3ge7me4cbbamx.js","assets/f2hwvhq32k7re39q.js","assets/jbhpedrb0o8s6tju.js","assets/em54eqpr1go2ghsv.js","assets/liwusplx5fik20va.js","assets/a9x7fowchvgnildi.js","assets/edr7zsyu569x650b.js","assets/blvykoe59vobqjjq.js","assets/kqwdyvkaaavvn8k3.js","assets/capxvpo538g3c7n4.js","assets/fbo1zgjv6ucuepy1.js","assets/hv8fan3byrg2vuj5.js","assets/iqbtuomdp97euntf.js","assets/am0myj3j48shg00a.js","assets/oehpgltglxpk3yng.js","assets/o4gc7biyrgs6j44g.js","assets/f475833pfp5ebqb5.js","assets/ni1gkzpwgvg6c4gl.js","assets/jwp6mj1i6r2q5yxw.js","assets/iej0cupg2dqkmejt.js","assets/cacp3zyw4i6eozz4.js","assets/gbm9epxdbci6qd6c.js","assets/dc18mrl8omp9engn.js","assets/ww57o50ogjnwfwaq.js","assets/hfki79wwacic5tya.js","assets/i8bhsnf6jctxiy9b.js","assets/shared-mk6ngktc.css","assets/jg5y8gnjf1fznxrp.js","assets/kypwb46y6cxfczuc.js","assets/7lnz43ua7cr9unyj.js","assets/sso-bmfhfemd.css","assets/jrj4op36v0n8rn8p.js","assets/hcswsju5nnjfkxb0.js","assets/d6kbjp69kfvnqwxu.js","assets/kwc5lgmx6wmoirm9.js","assets/fhb0s3d4z4ar8r7r.js","assets/dw6i4boivalgxpjk.js","assets/k9ac8ekc7w2zazoh.js","assets/o4j2mpljbxy1weg5.js","assets/hkjj1ibmvoo343qq.js","assets/ku9yiem9ldo3gk9i.js","assets/igjw8hgs072zy6lh.js","assets/i7u6ch1xxy4kc0si.js","assets/i48vclyb1hf86efc.js","assets/gopiwaseyqpuxy69.js","assets/kxujte5n2etw64qp.js","assets/kagl43t4s7klopz3.js","assets/gmt682ybu48z7sis.js","assets/h9alw8xbmjdggtxz.js","assets/md0l7w147qjjk6hm.js","assets/deo7a6swbi5be1ab.js","assets/j2mfqfaqdef4w2pz.js","assets/ifcgxrsjho0xeov3.js","assets/cqppd44u8oln3jgn.js","assets/ltg32d4oc61vs3ho.js","assets/l4xb2bl81z8yaaur.js","assets/ndt0qnj9my99dh2o.js","assets/cmku8nj12laj71aa.js","assets/ewk3v6ll2f27ssy4.js","assets/g6gw0kjqzti1otcc.js"])))=>i.map(i=>d[i]);
var Cm=Object.defineProperty;var Ac=n=>{throw TypeError(n)};var Mm=(n,e,t)=>e in n?Cm(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var re=(n,e,t)=>Mm(n,typeof e!="symbol"?e+"":e,t),ra=(n,e,t)=>e.has(n)||Ac("Cannot "+t);var k=(n,e,t)=>(ra(n,e,"read from private field"),t?t.call(n):e.get(n)),je=(n,e,t)=>e.has(n)?Ac("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),le=(n,e,t,s)=>(ra(n,e,"write to private field"),s?s.call(n,t):e.set(n,t),t),ie=(n,e,t)=>(ra(n,e,"access private method"),t);var Or=(n,e,t,s)=>({set _(i){le(n,e,i,t)},get _(){return k(n,e,s)}});import{hK as vm,K as Tm,hL as Wu,hG as Gu,bW as kl,bV as Do,bY as jo,e as ti,hM as Cl,hN as Em,hO as _m,hP as Nm,hQ as Mt,hR as Im,hS as Jr,hT as Pr,hU as Am,hV as qu,r as Ml,bs as Rc,cZ as Rm,bi as Oo,ay as Po,g5 as Dm,fs as vl,eM as Fo,hW as jm,ce as kr,hX as Om,hY as Hu,ax as $u,aQ as ar,aT as Ku,eO as Xt,hZ as Tn,u as Xn,A as Ys,aS as Pm,bC as Ju,fx as Fm,bU as Bm,h_ as Yu,h$ as Qu,i0 as Lm,i1 as _i,i2 as xt,i3 as Xu,i4 as La,fa as zm,i5 as Um,i6 as Vm,i7 as Wm,aD as Bo,i8 as Gm,i9 as Ni,v as Zu,ia as qm,dX as Hm,bD as Lo,gG as $m,dG as eh,k as Km,ib as Jm,ic as th,id as nh,eP as Cr,gK as uo,ie as ms,gB as Qs,ig as oa,ih as Ym,s as Tl,ii as Dc,ij as sh,ik as ho,il as El,im as _l,io as ih,ip as rh,dB as oh,gD as ah,dz as lh,dA as ch,iq as Qm,ir as Xm,hx as Nl,is as Zm,it as dh,hy as Il,iu as Al,iv as Fr,iw as eg,ix as tg,iy as ng,gE as fo,aa as uh,iz as sg,iA as ig,iB as rg,cS as og,iC as jc,iD as ag,h5 as lg,h6 as cg,iE as hh,iF as dg,iG as fh,iH as za,iI as ph,iJ as ug,eQ as hg,iK as fg,iL as pg,iM as mg,V as mh,dP as ni,iN as gg,iO as Oc,a7 as po,iP as Ua,iQ as yg,j as gh,U as Ii,aq as Rl,iR as xg,iS as bg,iT as wg,iU as Sg,iV as kg,cc as yh,dC as Cg,fT as Mg,fS as mo,iW as vg,iX as Tg,iY as Eg,a6 as Dl,iZ as go,i_ as xh,L as Pc,i$ as _g,fP as zo,j0 as Ng,l as jl,eN as Fc,eR as Ig,j1 as bh,j2 as Ag,j3 as Rg,ao as Dg,j4 as jg,aM as wh,j5 as Sh,j6 as Fs,j7 as Og,j8 as Pg,j9 as Fg,ja as kh,i as Bg,jb as Lg,a0 as Yr,aF as Va,aE as zg,cd as Ug,w as Bc,jc as Vg,G as he,jd as Wg,je as Gg,jf as qg,jg as Ch,jh as Hg,hd as Br,ji as aa,jj as $g,hb as Kg,hg as Jg,hh as Mh,jk as Yg,jl as Qg,C as Xg,jm as tr,jn as Zg,jo as ey,jp as ty,jq as ny,jr as sy,js as Ol,gp as vh,dD as iy,jt as ry,ju as oy,bS as ay,fE as ly,aR as lr,fq as cy,jv as Th,jw as dy,jx as Eh,q as yo,cn as xo,co as Pl,dW as uy,eS as _h,f as hy,jy as fy,jz as py,cb as my,jA as gy,jB as yy,jC as xy,jD as by,jE as wy,jF as Sy,jG as ky,jH as Cy,Q as nn,b0 as My,aH as vy,B as Ty,fR as Nh,b1 as Ih,jI as Ey,aL as la,D as _y,g9 as Ny,f9 as Iy,jJ as Ay,dL as Ry,jK as Dy,c1 as jy,bz as Oy,dM as Lc,jL as Py,hi as Fy,jM as By,jN as Ly,jO as zy,jP as Uy,jQ as Vy,bZ as Wy,jR as Gy,jS as qy,jT as Hy,jU as $y,n as Ky,jV as Jy,jW as Yy,fg as zc,jX as Qy,a8 as Xy,jY as Zy,jZ as ex,j_ as tx,j$ as nx,k0 as sx,k1 as ix,k2 as rx}from"./osf8maqq52t0ie0w.js";import{h as Fl,i as ox,j as Ah,c as Bl,e as Rh,k as ax,b as Mr,l as lx,S as cx,u as Dh,G as dx,f as Ll,a as ux}from"./ca4desjes5mv8zbl.js";import{S as Pi,cM as es,af as vr,a2 as on,da as hx,C as Ge,r as S,fr as cr,bd as Fi,fs as fx,ft as jh,D as Fe,j as c,H as Ke,Z as jt,bO as rs,fu as Wa,cN as px,P as ee,x as $,bH as it,eS as Uo,b6 as rt,fv as Oh,eK as Ph,I as Xe,G as U,bc as Ga,c as se,dA as Bi,bA as mx,ff as zl,bB as Zt,b5 as It,b8 as Tr,fw as Fh,w as Bh,a0 as gx,L as Ai,ai as On,fd as Lh,fh as zh,ar as si,v as Uc,bK as Uh,bU as Oe,bM as yx,F as _t,eV as Vh,cC as Ve,fx as Ul,bp as Wh,bR as bo,bQ as zt,N as xx,O as bx,Q as wx,J as Sx,cS as kx,fy as Vl,cy as Cx,bn as Er,aC as Gh,eN as Mx,eF as vx,ce as ze,aq as Li,ee as Tx,eH as Wl,d1 as Gl,d2 as dr,d3 as wo,dL as Ex,fz as _x,au as Jn,fA as Nx,fB as Ix,fC as ql,dT as In,a8 as Vo,fD as qh,bj as Ax,z as Wo,fE as an,dU as Rx,a7 as zi,c3 as _r,fF as Dx,fG as Vc,ci as Go,fH as jx,dz as Ox,ew as Hh,cp as Px,fI as Fx,b$ as cn,fJ as $h,ef as Bx,cs as Lx,ct as zx,cw as nr,cu as Wc,cv as Ux,fK as Vx,cU as Kh,fL as Wx,fM as Gx,u as Hl,co as qo,d8 as Jh,as as qx,at as Hx,an as $i,eU as $x,cP as Ki,dZ as ur,c1 as Kx,by as ht,cA as Yh,M as Gn,E as Qh,fN as Jx,fO as Gc,b0 as Yx,b1 as Qx,ex as Xx,b3 as Bs,fP as Zx,fQ as e0,fR as t0,fS as n0,fT as Xh,X as qc,fU as s0,fV as Hc,fW as $c,fX as i0,fY as r0,aw as o0,fZ as a0,bk as l0,cm as c0,f_ as d0,e2 as u0,f$ as h0,eL as f0,be as p0,a_ as m0}from"./jeen44fo1keunqlc.js";import{I as Zh,e as ef,u as Ms,J as g0,g as Kc,a as y0,K as x0,L as b0,G as w0,M as S0}from"./iw6awycy9wj28390.js";import{j as Ui,f as k0,i as Yn,G as C0,T as O,c as $l,p as vs,B as tf,g as Ot,H as M0,u as Nr,e as Mn,t as Zn,a as Rn,d as Ir,I as nf,J as v0,K as T0,y as Kl,L as sf,M as Jc,z as Yc,N as E0,b as rf,O as _0,P as N0,Q as I0,R as A0,S as of,q as R0,r as D0,U as af,D as lf,V as j0,W as O0,X as P0,Y as cf}from"./h2ieknsganxwp6x6.js";import{G as F0,T as B0}from"./hcswsju5nnjfkxb0.js";import{u as df,t as So,i as uf,S as L0,a as hf,T as Jl,M as Yl,b as ff,H as z0,c as U0,d as V0,e as W0,G as G0,L as q0,f as H0,g as $0}from"./d6kbjp69kfvnqwxu.js";import{_ as pf,E as hr,Y as Ho,bq as K0,ay as mf,bN as J0,R as Y0,b9 as gf,bO as Q0,U as Ql,ao as X0,bP as Z0,aH as eb,x as tb,af as Xl,aI as yf,b3 as nb,bJ as sb,bK as ib,X as rb,bQ as ob,u as ab,am as Zl,an as ec,B as lb,al as cb,ak as db,a1 as ub,aA as hb,a2 as fb,ai as pb,bR as mb,bS as gb,r as yb,bA as xb}from"./hisz4iug0sf9ooju.js";import{a as bb}from"./kwc5lgmx6wmoirm9.js";import{m as ft}from"./m3qjut27is4ffm4j.js";import{u as wb,P as Sb,I as kb}from"./oehpgltglxpk3yng.js";import{d as $o,e as Cb,f as Mb,C as vb}from"./b4y2ge3nobhogt80.js";import{D as Ae,$ as Tb,B as Eb}from"./gy8d176d0tsqf86m.js";import{c as _b,d as Nb,e as Ib}from"./gzlpoy4y44ngaze8.js";import{i as tc,a as Ab,g as Rb,b as Db,c as jb}from"./jg5y8gnjf1fznxrp.js";import{G as xf,a as Ob}from"./dkhpiq5qymmlvz34.js";import{a as Pb}from"./dc18mrl8omp9engn.js";import{I as Fb,B as Bb}from"./b0f338h0n7rkc1qg.js";import{H as Lb}from"./fhb0s3d4z4ar8r7r.js";const zb=n=>{const{asPath:e,replace:t}=Pi(),s=es(),i=Ui();vr({queryKey:["conversation",n],queryFn:()=>k0(n).catch(r=>{const o=vm(e),a=o!=null?Zh(o):"/";throw t(a,void 0,{shallow:!0}),on.danger(`Unable to load conversation ${n}`),r}),enabled:!Yn(n)&&!s&&!i})};function Ub(n){return`https://chatgpt.com${ef(n)}`}function a_(n,e){Tm(Ub(n)),e&&on.info(e)}function Vb(n){return n.some(e=>e.type===hx.JIT_PLUGIN)}function Wb(n){return"gizmo_id"in n?n.gizmo_id??null:null}const Gb=n=>["conversation","init",n],qb=({clientThreadId:n,conversationMode:e,clientModelId:t})=>{const s=Wb(e),i=Yn(n)?null:n;return{gcTime:0,refetchOnWindowFocus:!0,refetchOnMount:"always",queryKey:Gb(n),queryFn:()=>Ge.getConversationDetails({conversationId:i,gizmoId:s,requestedDefaultModel:t})}},Hb=n=>vr(qb(n)),$b=(n,e)=>{const t=(typeof n=="string"?[n]:n)??[];for(const s of t)if(s&&e.has(s))return s;return null},l_=(n,e)=>{const t=Fl(),{query:s}=Pi(),i=ox(s),{modelId:r=null}=Wu()??{};zb(n);const o=C0(n)??null,a=[i,o,r],l=$b(a,t);S.useEffect(()=>{O.initThread(n,e,l),cr.reset()},[n]);const d=Fi(),u=S.useCallback(()=>{const g={...s};delete g.model;const y=fx.stringify(g);d({search:y.length>0?`?${y}`:""})},[s,d]),{isLoading:p,data:m}=Hb({clientThreadId:n,clientModelId:a.find(g=>!!g)??null,conversationMode:e}),b=jh();S.useEffect(()=>{if(!(!i||p)){if(!t.has(i)||b.find(g=>g.model_slug===i))return u();O.setThreadModelId(n,i)}},[i,b,t,n]),S.useEffect(()=>{if(p||!m)return;const{default_model_slug:g}=m;i&&g&&i!==g&&u(),cr.updateDetails(m),g&&O.setThreadModelId(n,g)},[p,m])};function ca({label:n,tooltip:e,Icon:t}){return c.jsxs("div",{className:"flex items-center gap-1 text-sm font-semibold opacity-70",children:[t&&c.jsx(t,{className:"icon-sm"}),c.jsx("div",{children:n}),c.jsx(ti,{label:e,children:c.jsx(hr,{className:"icon-sm ml-1"})})]})}function Kb({clientThreadId:n,gizmoId:e}){const t=Fe(),s=Gu(),i=kl(),r=Do(),{data:o}=jo(e,!1,r),a=!!e,l=es(),d=$l(n);return r?l&&(!d||a)?c.jsx(ca,{label:t.formatMessage(hi.temporaryChat),tooltip:t.formatMessage(hi.temporaryChatTooltip),Icon:pf}):s&&!i&&!l?c.jsx(ca,{label:t.formatMessage(hi.memoryOff),tooltip:t.formatMessage(hi.memoryOffTooltip)}):o&&(o==null?void 0:o.memoryFullPct)>=100?c.jsx(ca,{label:t.formatMessage(hi.memoryFull),tooltip:t.formatMessage(hi.memoryFullTooltip)}):null:null}const hi=Ke({temporaryChat:{id:"ConversationPrivacyIndicator.temporaryChat",defaultMessage:"Temporary Chat"},temporaryChatTooltip:{id:"ConversationPrivacyIndicator.temporaryChatTooltip",defaultMessage:"Temporary Chats won't appear in your history, and ChatGPT won't remember anything you talk about."},memoryOff:{id:"ConversationPrivacyIndicator.memoryOff",defaultMessage:"Memory Off"},memoryOffTooltip:{id:"ConversationPrivacyIndicator.memoryOffTooltip",defaultMessage:"ChatGPT won't remember anything you talk about in this conversation."},memoryFull:{id:"2Eq+5y",defaultMessage:"Memory Full"},memoryFullTooltip:{id:"dNA8jQ",defaultMessage:"ChatGPT's memory is full. You can forget existing memories to make space."}});/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(n){const e=Em,t=_m,s=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;n.Buffer=a,n.SlowBuffer=_,n.INSPECT_MAX_BYTES=50;const i=2147483647;n.kMaxLength=i,a.TYPED_ARRAY_SUPPORT=r(),!a.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function r(){try{const x=new Uint8Array(1),h={foo:function(){return 42}};return Object.setPrototypeOf(h,Uint8Array.prototype),Object.setPrototypeOf(x,h),x.foo()===42}catch{return!1}}Object.defineProperty(a.prototype,"parent",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.buffer}}),Object.defineProperty(a.prototype,"offset",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.byteOffset}});function o(x){if(x>i)throw new RangeError('The value "'+x+'" is invalid for option "size"');const h=new Uint8Array(x);return Object.setPrototypeOf(h,a.prototype),h}function a(x,h,f){if(typeof x=="number"){if(typeof h=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return p(x)}return l(x,h,f)}a.poolSize=8192;function l(x,h,f){if(typeof x=="string")return m(x,h);if(ArrayBuffer.isView(x))return g(x);if(x==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof x);if(De(x,ArrayBuffer)||x&&De(x.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(De(x,SharedArrayBuffer)||x&&De(x.buffer,SharedArrayBuffer)))return y(x,h,f);if(typeof x=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const w=x.valueOf&&x.valueOf();if(w!=null&&w!==x)return a.from(w,h,f);const v=C(x);if(v)return v;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof x[Symbol.toPrimitive]=="function")return a.from(x[Symbol.toPrimitive]("string"),h,f);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof x)}a.from=function(x,h,f){return l(x,h,f)},Object.setPrototypeOf(a.prototype,Uint8Array.prototype),Object.setPrototypeOf(a,Uint8Array);function d(x){if(typeof x!="number")throw new TypeError('"size" argument must be of type number');if(x<0)throw new RangeError('The value "'+x+'" is invalid for option "size"')}function u(x,h,f){return d(x),x<=0?o(x):h!==void 0?typeof f=="string"?o(x).fill(h,f):o(x).fill(h):o(x)}a.alloc=function(x,h,f){return u(x,h,f)};function p(x){return d(x),o(x<0?0:M(x)|0)}a.allocUnsafe=function(x){return p(x)},a.allocUnsafeSlow=function(x){return p(x)};function m(x,h){if((typeof h!="string"||h==="")&&(h="utf8"),!a.isEncoding(h))throw new TypeError("Unknown encoding: "+h);const f=R(x,h)|0;let w=o(f);const v=w.write(x,h);return v!==f&&(w=w.slice(0,v)),w}function b(x){const h=x.length<0?0:M(x.length)|0,f=o(h);for(let w=0;w<h;w+=1)f[w]=x[w]&255;return f}function g(x){if(De(x,Uint8Array)){const h=new Uint8Array(x);return y(h.buffer,h.byteOffset,h.byteLength)}return b(x)}function y(x,h,f){if(h<0||x.byteLength<h)throw new RangeError('"offset" is outside of buffer bounds');if(x.byteLength<h+(f||0))throw new RangeError('"length" is outside of buffer bounds');let w;return h===void 0&&f===void 0?w=new Uint8Array(x):f===void 0?w=new Uint8Array(x,h):w=new Uint8Array(x,h,f),Object.setPrototypeOf(w,a.prototype),w}function C(x){if(a.isBuffer(x)){const h=M(x.length)|0,f=o(h);return f.length===0||x.copy(f,0,0,h),f}if(x.length!==void 0)return typeof x.length!="number"||St(x.length)?o(0):b(x);if(x.type==="Buffer"&&Array.isArray(x.data))return b(x.data)}function M(x){if(x>=i)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+i.toString(16)+" bytes");return x|0}function _(x){return+x!=x&&(x=0),a.alloc(+x)}a.isBuffer=function(h){return h!=null&&h._isBuffer===!0&&h!==a.prototype},a.compare=function(h,f){if(De(h,Uint8Array)&&(h=a.from(h,h.offset,h.byteLength)),De(f,Uint8Array)&&(f=a.from(f,f.offset,f.byteLength)),!a.isBuffer(h)||!a.isBuffer(f))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(h===f)return 0;let w=h.length,v=f.length;for(let T=0,I=Math.min(w,v);T<I;++T)if(h[T]!==f[T]){w=h[T],v=f[T];break}return w<v?-1:v<w?1:0},a.isEncoding=function(h){switch(String(h).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},a.concat=function(h,f){if(!Array.isArray(h))throw new TypeError('"list" argument must be an Array of Buffers');if(h.length===0)return a.alloc(0);let w;if(f===void 0)for(f=0,w=0;w<h.length;++w)f+=h[w].length;const v=a.allocUnsafe(f);let T=0;for(w=0;w<h.length;++w){let I=h[w];if(De(I,Uint8Array))T+I.length>v.length?(a.isBuffer(I)||(I=a.from(I)),I.copy(v,T)):Uint8Array.prototype.set.call(v,I,T);else if(a.isBuffer(I))I.copy(v,T);else throw new TypeError('"list" argument must be an Array of Buffers');T+=I.length}return v};function R(x,h){if(a.isBuffer(x))return x.length;if(ArrayBuffer.isView(x)||De(x,ArrayBuffer))return x.byteLength;if(typeof x!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof x);const f=x.length,w=arguments.length>2&&arguments[2]===!0;if(!w&&f===0)return 0;let v=!1;for(;;)switch(h){case"ascii":case"latin1":case"binary":return f;case"utf8":case"utf-8":return wt(x).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return f*2;case"hex":return f>>>1;case"base64":return $e(x).length;default:if(v)return w?-1:wt(x).length;h=(""+h).toLowerCase(),v=!0}}a.byteLength=R;function N(x,h,f){let w=!1;if((h===void 0||h<0)&&(h=0),h>this.length||((f===void 0||f>this.length)&&(f=this.length),f<=0)||(f>>>=0,h>>>=0,f<=h))return"";for(x||(x="utf8");;)switch(x){case"hex":return B(this,h,f);case"utf8":case"utf-8":return H(this,h,f);case"ascii":return de(this,h,f);case"latin1":case"binary":return V(this,h,f);case"base64":return z(this,h,f);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return we(this,h,f);default:if(w)throw new TypeError("Unknown encoding: "+x);x=(x+"").toLowerCase(),w=!0}}a.prototype._isBuffer=!0;function E(x,h,f){const w=x[h];x[h]=x[f],x[f]=w}a.prototype.swap16=function(){const h=this.length;if(h%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let f=0;f<h;f+=2)E(this,f,f+1);return this},a.prototype.swap32=function(){const h=this.length;if(h%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let f=0;f<h;f+=4)E(this,f,f+3),E(this,f+1,f+2);return this},a.prototype.swap64=function(){const h=this.length;if(h%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let f=0;f<h;f+=8)E(this,f,f+7),E(this,f+1,f+6),E(this,f+2,f+5),E(this,f+3,f+4);return this},a.prototype.toString=function(){const h=this.length;return h===0?"":arguments.length===0?H(this,0,h):N.apply(this,arguments)},a.prototype.toLocaleString=a.prototype.toString,a.prototype.equals=function(h){if(!a.isBuffer(h))throw new TypeError("Argument must be a Buffer");return this===h?!0:a.compare(this,h)===0},a.prototype.inspect=function(){let h="";const f=n.INSPECT_MAX_BYTES;return h=this.toString("hex",0,f).replace(/(.{2})/g,"$1 ").trim(),this.length>f&&(h+=" ... "),"<Buffer "+h+">"},s&&(a.prototype[s]=a.prototype.inspect),a.prototype.compare=function(h,f,w,v,T){if(De(h,Uint8Array)&&(h=a.from(h,h.offset,h.byteLength)),!a.isBuffer(h))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof h);if(f===void 0&&(f=0),w===void 0&&(w=h?h.length:0),v===void 0&&(v=0),T===void 0&&(T=this.length),f<0||w>h.length||v<0||T>this.length)throw new RangeError("out of range index");if(v>=T&&f>=w)return 0;if(v>=T)return-1;if(f>=w)return 1;if(f>>>=0,w>>>=0,v>>>=0,T>>>=0,this===h)return 0;let I=T-v,ue=w-f;const Ee=Math.min(I,ue),ke=this.slice(v,T),Te=h.slice(f,w);for(let Q=0;Q<Ee;++Q)if(ke[Q]!==Te[Q]){I=ke[Q],ue=Te[Q];break}return I<ue?-1:ue<I?1:0};function P(x,h,f,w,v){if(x.length===0)return-1;if(typeof f=="string"?(w=f,f=0):f>2147483647?f=2147483647:f<-2147483648&&(f=-2147483648),f=+f,St(f)&&(f=v?0:x.length-1),f<0&&(f=x.length+f),f>=x.length){if(v)return-1;f=x.length-1}else if(f<0)if(v)f=0;else return-1;if(typeof h=="string"&&(h=a.from(h,w)),a.isBuffer(h))return h.length===0?-1:F(x,h,f,w,v);if(typeof h=="number")return h=h&255,typeof Uint8Array.prototype.indexOf=="function"?v?Uint8Array.prototype.indexOf.call(x,h,f):Uint8Array.prototype.lastIndexOf.call(x,h,f):F(x,[h],f,w,v);throw new TypeError("val must be string, number or Buffer")}function F(x,h,f,w,v){let T=1,I=x.length,ue=h.length;if(w!==void 0&&(w=String(w).toLowerCase(),w==="ucs2"||w==="ucs-2"||w==="utf16le"||w==="utf-16le")){if(x.length<2||h.length<2)return-1;T=2,I/=2,ue/=2,f/=2}function Ee(Te,Q){return T===1?Te[Q]:Te.readUInt16BE(Q*T)}let ke;if(v){let Te=-1;for(ke=f;ke<I;ke++)if(Ee(x,ke)===Ee(h,Te===-1?0:ke-Te)){if(Te===-1&&(Te=ke),ke-Te+1===ue)return Te*T}else Te!==-1&&(ke-=ke-Te),Te=-1}else for(f+ue>I&&(f=I-ue),ke=f;ke>=0;ke--){let Te=!0;for(let Q=0;Q<ue;Q++)if(Ee(x,ke+Q)!==Ee(h,Q)){Te=!1;break}if(Te)return ke}return-1}a.prototype.includes=function(h,f,w){return this.indexOf(h,f,w)!==-1},a.prototype.indexOf=function(h,f,w){return P(this,h,f,w,!0)},a.prototype.lastIndexOf=function(h,f,w){return P(this,h,f,w,!1)};function D(x,h,f,w){f=Number(f)||0;const v=x.length-f;w?(w=Number(w),w>v&&(w=v)):w=v;const T=h.length;w>T/2&&(w=T/2);let I;for(I=0;I<w;++I){const ue=parseInt(h.substr(I*2,2),16);if(St(ue))return I;x[f+I]=ue}return I}function A(x,h,f,w){return gt(wt(h,x.length-f),x,f,w)}function G(x,h,f,w){return gt(Ze(h),x,f,w)}function W(x,h,f,w){return gt($e(h),x,f,w)}function j(x,h,f,w){return gt(at(h,x.length-f),x,f,w)}a.prototype.write=function(h,f,w,v){if(f===void 0)v="utf8",w=this.length,f=0;else if(w===void 0&&typeof f=="string")v=f,w=this.length,f=0;else if(isFinite(f))f=f>>>0,isFinite(w)?(w=w>>>0,v===void 0&&(v="utf8")):(v=w,w=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const T=this.length-f;if((w===void 0||w>T)&&(w=T),h.length>0&&(w<0||f<0)||f>this.length)throw new RangeError("Attempt to write outside buffer bounds");v||(v="utf8");let I=!1;for(;;)switch(v){case"hex":return D(this,h,f,w);case"utf8":case"utf-8":return A(this,h,f,w);case"ascii":case"latin1":case"binary":return G(this,h,f,w);case"base64":return W(this,h,f,w);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return j(this,h,f,w);default:if(I)throw new TypeError("Unknown encoding: "+v);v=(""+v).toLowerCase(),I=!0}},a.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function z(x,h,f){return h===0&&f===x.length?e.fromByteArray(x):e.fromByteArray(x.slice(h,f))}function H(x,h,f){f=Math.min(x.length,f);const w=[];let v=h;for(;v<f;){const T=x[v];let I=null,ue=T>239?4:T>223?3:T>191?2:1;if(v+ue<=f){let Ee,ke,Te,Q;switch(ue){case 1:T<128&&(I=T);break;case 2:Ee=x[v+1],(Ee&192)===128&&(Q=(T&31)<<6|Ee&63,Q>127&&(I=Q));break;case 3:Ee=x[v+1],ke=x[v+2],(Ee&192)===128&&(ke&192)===128&&(Q=(T&15)<<12|(Ee&63)<<6|ke&63,Q>2047&&(Q<55296||Q>57343)&&(I=Q));break;case 4:Ee=x[v+1],ke=x[v+2],Te=x[v+3],(Ee&192)===128&&(ke&192)===128&&(Te&192)===128&&(Q=(T&15)<<18|(Ee&63)<<12|(ke&63)<<6|Te&63,Q>65535&&Q<1114112&&(I=Q))}}I===null?(I=65533,ue=1):I>65535&&(I-=65536,w.push(I>>>10&1023|55296),I=56320|I&1023),w.push(I),v+=ue}return J(w)}const K=4096;function J(x){const h=x.length;if(h<=K)return String.fromCharCode.apply(String,x);let f="",w=0;for(;w<h;)f+=String.fromCharCode.apply(String,x.slice(w,w+=K));return f}function de(x,h,f){let w="";f=Math.min(x.length,f);for(let v=h;v<f;++v)w+=String.fromCharCode(x[v]&127);return w}function V(x,h,f){let w="";f=Math.min(x.length,f);for(let v=h;v<f;++v)w+=String.fromCharCode(x[v]);return w}function B(x,h,f){const w=x.length;(!h||h<0)&&(h=0),(!f||f<0||f>w)&&(f=w);let v="";for(let T=h;T<f;++T)v+=Ne[x[T]];return v}function we(x,h,f){const w=x.slice(h,f);let v="";for(let T=0;T<w.length-1;T+=2)v+=String.fromCharCode(w[T]+w[T+1]*256);return v}a.prototype.slice=function(h,f){const w=this.length;h=~~h,f=f===void 0?w:~~f,h<0?(h+=w,h<0&&(h=0)):h>w&&(h=w),f<0?(f+=w,f<0&&(f=0)):f>w&&(f=w),f<h&&(f=h);const v=this.subarray(h,f);return Object.setPrototypeOf(v,a.prototype),v};function te(x,h,f){if(x%1!==0||x<0)throw new RangeError("offset is not uint");if(x+h>f)throw new RangeError("Trying to access beyond buffer length")}a.prototype.readUintLE=a.prototype.readUIntLE=function(h,f,w){h=h>>>0,f=f>>>0,w||te(h,f,this.length);let v=this[h],T=1,I=0;for(;++I<f&&(T*=256);)v+=this[h+I]*T;return v},a.prototype.readUintBE=a.prototype.readUIntBE=function(h,f,w){h=h>>>0,f=f>>>0,w||te(h,f,this.length);let v=this[h+--f],T=1;for(;f>0&&(T*=256);)v+=this[h+--f]*T;return v},a.prototype.readUint8=a.prototype.readUInt8=function(h,f){return h=h>>>0,f||te(h,1,this.length),this[h]},a.prototype.readUint16LE=a.prototype.readUInt16LE=function(h,f){return h=h>>>0,f||te(h,2,this.length),this[h]|this[h+1]<<8},a.prototype.readUint16BE=a.prototype.readUInt16BE=function(h,f){return h=h>>>0,f||te(h,2,this.length),this[h]<<8|this[h+1]},a.prototype.readUint32LE=a.prototype.readUInt32LE=function(h,f){return h=h>>>0,f||te(h,4,this.length),(this[h]|this[h+1]<<8|this[h+2]<<16)+this[h+3]*16777216},a.prototype.readUint32BE=a.prototype.readUInt32BE=function(h,f){return h=h>>>0,f||te(h,4,this.length),this[h]*16777216+(this[h+1]<<16|this[h+2]<<8|this[h+3])},a.prototype.readBigUInt64LE=Ue(function(h){h=h>>>0,ae(h,"offset");const f=this[h],w=this[h+7];(f===void 0||w===void 0)&&Re(h,this.length-8);const v=f+this[++h]*2**8+this[++h]*2**16+this[++h]*2**24,T=this[++h]+this[++h]*2**8+this[++h]*2**16+w*2**24;return BigInt(v)+(BigInt(T)<<BigInt(32))}),a.prototype.readBigUInt64BE=Ue(function(h){h=h>>>0,ae(h,"offset");const f=this[h],w=this[h+7];(f===void 0||w===void 0)&&Re(h,this.length-8);const v=f*2**24+this[++h]*2**16+this[++h]*2**8+this[++h],T=this[++h]*2**24+this[++h]*2**16+this[++h]*2**8+w;return(BigInt(v)<<BigInt(32))+BigInt(T)}),a.prototype.readIntLE=function(h,f,w){h=h>>>0,f=f>>>0,w||te(h,f,this.length);let v=this[h],T=1,I=0;for(;++I<f&&(T*=256);)v+=this[h+I]*T;return T*=128,v>=T&&(v-=Math.pow(2,8*f)),v},a.prototype.readIntBE=function(h,f,w){h=h>>>0,f=f>>>0,w||te(h,f,this.length);let v=f,T=1,I=this[h+--v];for(;v>0&&(T*=256);)I+=this[h+--v]*T;return T*=128,I>=T&&(I-=Math.pow(2,8*f)),I},a.prototype.readInt8=function(h,f){return h=h>>>0,f||te(h,1,this.length),this[h]&128?(255-this[h]+1)*-1:this[h]},a.prototype.readInt16LE=function(h,f){h=h>>>0,f||te(h,2,this.length);const w=this[h]|this[h+1]<<8;return w&32768?w|4294901760:w},a.prototype.readInt16BE=function(h,f){h=h>>>0,f||te(h,2,this.length);const w=this[h+1]|this[h]<<8;return w&32768?w|4294901760:w},a.prototype.readInt32LE=function(h,f){return h=h>>>0,f||te(h,4,this.length),this[h]|this[h+1]<<8|this[h+2]<<16|this[h+3]<<24},a.prototype.readInt32BE=function(h,f){return h=h>>>0,f||te(h,4,this.length),this[h]<<24|this[h+1]<<16|this[h+2]<<8|this[h+3]},a.prototype.readBigInt64LE=Ue(function(h){h=h>>>0,ae(h,"offset");const f=this[h],w=this[h+7];(f===void 0||w===void 0)&&Re(h,this.length-8);const v=this[h+4]+this[h+5]*2**8+this[h+6]*2**16+(w<<24);return(BigInt(v)<<BigInt(32))+BigInt(f+this[++h]*2**8+this[++h]*2**16+this[++h]*2**24)}),a.prototype.readBigInt64BE=Ue(function(h){h=h>>>0,ae(h,"offset");const f=this[h],w=this[h+7];(f===void 0||w===void 0)&&Re(h,this.length-8);const v=(f<<24)+this[++h]*2**16+this[++h]*2**8+this[++h];return(BigInt(v)<<BigInt(32))+BigInt(this[++h]*2**24+this[++h]*2**16+this[++h]*2**8+w)}),a.prototype.readFloatLE=function(h,f){return h=h>>>0,f||te(h,4,this.length),t.read(this,h,!0,23,4)},a.prototype.readFloatBE=function(h,f){return h=h>>>0,f||te(h,4,this.length),t.read(this,h,!1,23,4)},a.prototype.readDoubleLE=function(h,f){return h=h>>>0,f||te(h,8,this.length),t.read(this,h,!0,52,8)},a.prototype.readDoubleBE=function(h,f){return h=h>>>0,f||te(h,8,this.length),t.read(this,h,!1,52,8)};function ne(x,h,f,w,v,T){if(!a.isBuffer(x))throw new TypeError('"buffer" argument must be a Buffer instance');if(h>v||h<T)throw new RangeError('"value" argument is out of bounds');if(f+w>x.length)throw new RangeError("Index out of range")}a.prototype.writeUintLE=a.prototype.writeUIntLE=function(h,f,w,v){if(h=+h,f=f>>>0,w=w>>>0,!v){const ue=Math.pow(2,8*w)-1;ne(this,h,f,w,ue,0)}let T=1,I=0;for(this[f]=h&255;++I<w&&(T*=256);)this[f+I]=h/T&255;return f+w},a.prototype.writeUintBE=a.prototype.writeUIntBE=function(h,f,w,v){if(h=+h,f=f>>>0,w=w>>>0,!v){const ue=Math.pow(2,8*w)-1;ne(this,h,f,w,ue,0)}let T=w-1,I=1;for(this[f+T]=h&255;--T>=0&&(I*=256);)this[f+T]=h/I&255;return f+w},a.prototype.writeUint8=a.prototype.writeUInt8=function(h,f,w){return h=+h,f=f>>>0,w||ne(this,h,f,1,255,0),this[f]=h&255,f+1},a.prototype.writeUint16LE=a.prototype.writeUInt16LE=function(h,f,w){return h=+h,f=f>>>0,w||ne(this,h,f,2,65535,0),this[f]=h&255,this[f+1]=h>>>8,f+2},a.prototype.writeUint16BE=a.prototype.writeUInt16BE=function(h,f,w){return h=+h,f=f>>>0,w||ne(this,h,f,2,65535,0),this[f]=h>>>8,this[f+1]=h&255,f+2},a.prototype.writeUint32LE=a.prototype.writeUInt32LE=function(h,f,w){return h=+h,f=f>>>0,w||ne(this,h,f,4,4294967295,0),this[f+3]=h>>>24,this[f+2]=h>>>16,this[f+1]=h>>>8,this[f]=h&255,f+4},a.prototype.writeUint32BE=a.prototype.writeUInt32BE=function(h,f,w){return h=+h,f=f>>>0,w||ne(this,h,f,4,4294967295,0),this[f]=h>>>24,this[f+1]=h>>>16,this[f+2]=h>>>8,this[f+3]=h&255,f+4};function xe(x,h,f,w,v){be(h,w,v,x,f,7);let T=Number(h&BigInt(4294967295));x[f++]=T,T=T>>8,x[f++]=T,T=T>>8,x[f++]=T,T=T>>8,x[f++]=T;let I=Number(h>>BigInt(32)&BigInt(4294967295));return x[f++]=I,I=I>>8,x[f++]=I,I=I>>8,x[f++]=I,I=I>>8,x[f++]=I,f}function Se(x,h,f,w,v){be(h,w,v,x,f,7);let T=Number(h&BigInt(4294967295));x[f+7]=T,T=T>>8,x[f+6]=T,T=T>>8,x[f+5]=T,T=T>>8,x[f+4]=T;let I=Number(h>>BigInt(32)&BigInt(4294967295));return x[f+3]=I,I=I>>8,x[f+2]=I,I=I>>8,x[f+1]=I,I=I>>8,x[f]=I,f+8}a.prototype.writeBigUInt64LE=Ue(function(h,f=0){return xe(this,h,f,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeBigUInt64BE=Ue(function(h,f=0){return Se(this,h,f,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeIntLE=function(h,f,w,v){if(h=+h,f=f>>>0,!v){const Ee=Math.pow(2,8*w-1);ne(this,h,f,w,Ee-1,-Ee)}let T=0,I=1,ue=0;for(this[f]=h&255;++T<w&&(I*=256);)h<0&&ue===0&&this[f+T-1]!==0&&(ue=1),this[f+T]=(h/I>>0)-ue&255;return f+w},a.prototype.writeIntBE=function(h,f,w,v){if(h=+h,f=f>>>0,!v){const Ee=Math.pow(2,8*w-1);ne(this,h,f,w,Ee-1,-Ee)}let T=w-1,I=1,ue=0;for(this[f+T]=h&255;--T>=0&&(I*=256);)h<0&&ue===0&&this[f+T+1]!==0&&(ue=1),this[f+T]=(h/I>>0)-ue&255;return f+w},a.prototype.writeInt8=function(h,f,w){return h=+h,f=f>>>0,w||ne(this,h,f,1,127,-128),h<0&&(h=255+h+1),this[f]=h&255,f+1},a.prototype.writeInt16LE=function(h,f,w){return h=+h,f=f>>>0,w||ne(this,h,f,2,32767,-32768),this[f]=h&255,this[f+1]=h>>>8,f+2},a.prototype.writeInt16BE=function(h,f,w){return h=+h,f=f>>>0,w||ne(this,h,f,2,32767,-32768),this[f]=h>>>8,this[f+1]=h&255,f+2},a.prototype.writeInt32LE=function(h,f,w){return h=+h,f=f>>>0,w||ne(this,h,f,4,2147483647,-2147483648),this[f]=h&255,this[f+1]=h>>>8,this[f+2]=h>>>16,this[f+3]=h>>>24,f+4},a.prototype.writeInt32BE=function(h,f,w){return h=+h,f=f>>>0,w||ne(this,h,f,4,2147483647,-2147483648),h<0&&(h=4294967295+h+1),this[f]=h>>>24,this[f+1]=h>>>16,this[f+2]=h>>>8,this[f+3]=h&255,f+4},a.prototype.writeBigInt64LE=Ue(function(h,f=0){return xe(this,h,f,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),a.prototype.writeBigInt64BE=Ue(function(h,f=0){return Se(this,h,f,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function ge(x,h,f,w,v,T){if(f+w>x.length)throw new RangeError("Index out of range");if(f<0)throw new RangeError("Index out of range")}function ce(x,h,f,w,v){return h=+h,f=f>>>0,v||ge(x,h,f,4),t.write(x,h,f,w,23,4),f+4}a.prototype.writeFloatLE=function(h,f,w){return ce(this,h,f,!0,w)},a.prototype.writeFloatBE=function(h,f,w){return ce(this,h,f,!1,w)};function Ce(x,h,f,w,v){return h=+h,f=f>>>0,v||ge(x,h,f,8),t.write(x,h,f,w,52,8),f+8}a.prototype.writeDoubleLE=function(h,f,w){return Ce(this,h,f,!0,w)},a.prototype.writeDoubleBE=function(h,f,w){return Ce(this,h,f,!1,w)},a.prototype.copy=function(h,f,w,v){if(!a.isBuffer(h))throw new TypeError("argument should be a Buffer");if(w||(w=0),!v&&v!==0&&(v=this.length),f>=h.length&&(f=h.length),f||(f=0),v>0&&v<w&&(v=w),v===w||h.length===0||this.length===0)return 0;if(f<0)throw new RangeError("targetStart out of bounds");if(w<0||w>=this.length)throw new RangeError("Index out of range");if(v<0)throw new RangeError("sourceEnd out of bounds");v>this.length&&(v=this.length),h.length-f<v-w&&(v=h.length-f+w);const T=v-w;return this===h&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(f,w,v):Uint8Array.prototype.set.call(h,this.subarray(w,v),f),T},a.prototype.fill=function(h,f,w,v){if(typeof h=="string"){if(typeof f=="string"?(v=f,f=0,w=this.length):typeof w=="string"&&(v=w,w=this.length),v!==void 0&&typeof v!="string")throw new TypeError("encoding must be a string");if(typeof v=="string"&&!a.isEncoding(v))throw new TypeError("Unknown encoding: "+v);if(h.length===1){const I=h.charCodeAt(0);(v==="utf8"&&I<128||v==="latin1")&&(h=I)}}else typeof h=="number"?h=h&255:typeof h=="boolean"&&(h=Number(h));if(f<0||this.length<f||this.length<w)throw new RangeError("Out of range index");if(w<=f)return this;f=f>>>0,w=w===void 0?this.length:w>>>0,h||(h=0);let T;if(typeof h=="number")for(T=f;T<w;++T)this[T]=h;else{const I=a.isBuffer(h)?h:a.from(h,v),ue=I.length;if(ue===0)throw new TypeError('The value "'+h+'" is invalid for argument "value"');for(T=0;T<w-f;++T)this[T+f]=I[T%ue]}return this};const ye={};function L(x,h,f){ye[x]=class extends f{constructor(){super(),Object.defineProperty(this,"message",{value:h.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${x}]`,this.stack,delete this.name}get code(){return x}set code(v){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:v,writable:!0})}toString(){return`${this.name} [${x}]: ${this.message}`}}}L("ERR_BUFFER_OUT_OF_BOUNDS",function(x){return x?`${x} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),L("ERR_INVALID_ARG_TYPE",function(x,h){return`The "${x}" argument must be of type number. Received type ${typeof h}`},TypeError),L("ERR_OUT_OF_RANGE",function(x,h,f){let w=`The value of "${x}" is out of range.`,v=f;return Number.isInteger(f)&&Math.abs(f)>2**32?v=Me(String(f)):typeof f=="bigint"&&(v=String(f),(f>BigInt(2)**BigInt(32)||f<-(BigInt(2)**BigInt(32)))&&(v=Me(v)),v+="n"),w+=` It must be ${h}. Received ${v}`,w},RangeError);function Me(x){let h="",f=x.length;const w=x[0]==="-"?1:0;for(;f>=w+4;f-=3)h=`_${x.slice(f-3,f)}${h}`;return`${x.slice(0,f)}${h}`}function qe(x,h,f){ae(h,"offset"),(x[h]===void 0||x[h+f]===void 0)&&Re(h,x.length-(f+1))}function be(x,h,f,w,v,T){if(x>f||x<h){const I=typeof h=="bigint"?"n":"";let ue;throw h===0||h===BigInt(0)?ue=`>= 0${I} and < 2${I} ** ${(T+1)*8}${I}`:ue=`>= -(2${I} ** ${(T+1)*8-1}${I}) and < 2 ** ${(T+1)*8-1}${I}`,new ye.ERR_OUT_OF_RANGE("value",ue,x)}qe(w,v,T)}function ae(x,h){if(typeof x!="number")throw new ye.ERR_INVALID_ARG_TYPE(h,"number",x)}function Re(x,h,f){throw Math.floor(x)!==x?(ae(x,f),new ye.ERR_OUT_OF_RANGE("offset","an integer",x)):h<0?new ye.ERR_BUFFER_OUT_OF_BOUNDS:new ye.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${h}`,x)}const oe=/[^+/0-9A-Za-z-_]/g;function ot(x){if(x=x.split("=")[0],x=x.trim().replace(oe,""),x.length<2)return"";for(;x.length%4!==0;)x=x+"=";return x}function wt(x,h){h=h||1/0;let f;const w=x.length;let v=null;const T=[];for(let I=0;I<w;++I){if(f=x.charCodeAt(I),f>55295&&f<57344){if(!v){if(f>56319){(h-=3)>-1&&T.push(239,191,189);continue}else if(I+1===w){(h-=3)>-1&&T.push(239,191,189);continue}v=f;continue}if(f<56320){(h-=3)>-1&&T.push(239,191,189),v=f;continue}f=(v-55296<<10|f-56320)+65536}else v&&(h-=3)>-1&&T.push(239,191,189);if(v=null,f<128){if((h-=1)<0)break;T.push(f)}else if(f<2048){if((h-=2)<0)break;T.push(f>>6|192,f&63|128)}else if(f<65536){if((h-=3)<0)break;T.push(f>>12|224,f>>6&63|128,f&63|128)}else if(f<1114112){if((h-=4)<0)break;T.push(f>>18|240,f>>12&63|128,f>>6&63|128,f&63|128)}else throw new Error("Invalid code point")}return T}function Ze(x){const h=[];for(let f=0;f<x.length;++f)h.push(x.charCodeAt(f)&255);return h}function at(x,h){let f,w,v;const T=[];for(let I=0;I<x.length&&!((h-=2)<0);++I)f=x.charCodeAt(I),w=f>>8,v=f%256,T.push(v),T.push(w);return T}function $e(x){return e.toByteArray(ot(x))}function gt(x,h,f,w){let v;for(v=0;v<w&&!(v+f>=h.length||v>=x.length);++v)h[v+f]=x[v];return v}function De(x,h){return x instanceof h||x!=null&&x.constructor!=null&&x.constructor.name!=null&&x.constructor.name===h.name}function St(x){return x!==x}const Ne=function(){const x="0123456789abcdef",h=new Array(256);for(let f=0;f<16;++f){const w=f*16;for(let v=0;v<16;++v)h[w+v]=x[f]+x[v]}return h}();function Ue(x){return typeof BigInt>"u"?We:x}function We(){throw new Error("BigInt not supported")}})(Cl);function Jb(n){if(typeof n!="string")throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!n)throw new Error("No input");const e=JSON.parse(n),t=e;let s;if(t.type==="system")if(t.event==="connected")s=Object.assign(Object.assign({},e),{kind:"connected"});else if(t.event==="disconnected")s=Object.assign(Object.assign({},e),{kind:"disconnected"});else return null;else if(t.type==="message")if(t.from==="group"){const i=Xc(e.data,e.dataType);if(i===null)return null;s=Object.assign(Object.assign({},e),{data:i,kind:"groupData"})}else if(t.from==="server"){const i=Xc(e.data,e.dataType);if(i===null)return null;s=Object.assign(Object.assign({},e),{data:i,kind:"serverData"})}else return null;else if(t.type==="ack")s=Object.assign(Object.assign({},e),{kind:"ack"});else return null;return s}function Yb(n){let e;switch(n.kind){case"joinGroup":{e={type:"joinGroup",group:n.group,ackId:n.ackId};break}case"leaveGroup":{e={type:"leaveGroup",group:n.group,ackId:n.ackId};break}case"sendEvent":{e={type:"event",event:n.event,ackId:n.ackId,dataType:n.dataType,data:Qc(n.data,n.dataType)};break}case"sendToGroup":{e={type:"sendToGroup",group:n.group,ackId:n.ackId,dataType:n.dataType,data:Qc(n.data,n.dataType),noEcho:n.noEcho};break}case"sequenceAck":{e={type:"sequenceAck",sequenceId:n.sequenceId};break}default:throw new Error(`Unsupported type: ${n.kind}`)}return JSON.stringify(e)}function Qc(n,e){switch(e){case"text":{if(typeof n!="string")throw new TypeError("Message must be a string.");return n}case"json":return n;case"binary":case"protobuf":{if(n instanceof ArrayBuffer)return Cl.Buffer.from(n).toString("base64");throw new TypeError("Message must be a ArrayBuffer")}}}function Xc(n,e){if(e==="text"){if(typeof n!="string")throw new TypeError("Message must be a string when dataType is text");return n}else{if(e==="json")return n;if(e==="binary"||e==="protobuf"){const t=Cl.Buffer.from(n,"base64");return t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}else return null}}class Qb{constructor(){this.isReliableSubProtocol=!0,this.name="json.reliable.webpubsub.azure.v1"}parseMessages(e){return Jb(e)}writeMessage(e){return Yb(e)}}const Xb=()=>new Qb;var Lt;(function(n){n.Stopped="Stopped",n.Disconnected="Disconnected",n.Connecting="Connecting",n.Connected="Connected",n.Recovering="Recovering"})(Lt||(Lt={}));class Zb{nextAckId(){return this._ackId=this._ackId+1,this._ackId}constructor(e,t){this._quickSequenceAckDiff=300,this._activeTimeoutInMs=2e4,this._emitter=new Nm,this._isStopping=!1,this._isInitialConnected=!1,typeof e=="string"?this._credential={getClientAccessUrl:e}:this._credential=e,t==null&&(t={}),this._buildDefaultOptions(t),this._options=t,this._messageRetryPolicy=new Zc(this._options.messageRetryOptions),this._reconnectRetryPolicy=new Zc(this._options.reconnectRetryOptions),this._protocol=this._options.protocol,this._groupMap=new Map,this._ackMap=new Map,this._sequenceId=new nw,this._state=Lt.Stopped,this._ackId=0}async start(e){if(this._isStopping)throw new Error("Can't start a client during stopping");if(this._state!==Lt.Stopped)throw new Error("Client can be only started when it's Stopped");let t;e&&(t=e.abortSignal),this._activeKeepaliveTask||(this._activeKeepaliveTask=this._getActiveKeepaliveTask());try{await this._startCore(t)}catch(s){throw this._changeState(Lt.Stopped),this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0),this._isStopping=!1,s}}async _startFromRestarting(e){if(this._state!==Lt.Disconnected)throw new Error("Client can be only restarted when it's Disconnected");try{Mt.verbose("Staring reconnecting."),await this._startCore(e)}catch(t){throw this._changeState(Lt.Disconnected),t}}async _startCore(e){if(this._changeState(Lt.Connecting),Mt.info("Staring a new connection"),this._sequenceId.reset(),this._isInitialConnected=!1,this._lastCloseEvent=void 0,this._lastDisconnectedMessage=void 0,this._connectionId=void 0,this._reconnectionToken=void 0,this._uri=void 0,typeof this._credential.getClientAccessUrl=="string"?this._uri=this._credential.getClientAccessUrl:this._uri=await this._credential.getClientAccessUrl({abortSignal:e}),typeof this._uri!="string")throw new Error(`The clientAccessUrl must be a string but currently it's ${typeof this._uri}`);await this._connectCore(this._uri)}stop(){this._state===Lt.Stopped||this._isStopping||(this._isStopping=!0,this._wsClient&&this._wsClient.isOpen()?this._wsClient.close():this._isStopping=!1,this._activeKeepaliveTask&&(this._activeKeepaliveTask.abort(),this._activeKeepaliveTask=void 0))}on(e,t){this._emitter.on(e,t)}off(e,t){this._emitter.removeListener(e,t)}_emitEvent(e,t){this._emitter.emit(e,t)}async sendEvent(e,t,s,i){return await this._operationExecuteWithRetry(()=>this._sendEventAttempt(e,t,s,i),i==null?void 0:i.abortSignal)}async _sendEventAttempt(e,t,s,i){var r;if(!((r=i==null?void 0:i.fireAndForget)!==null&&r!==void 0?r:!1))return await this._sendMessageWithAckId(l=>({kind:"sendEvent",dataType:s,data:t,ackId:l,event:e}),i==null?void 0:i.ackId,i==null?void 0:i.abortSignal);const a={kind:"sendEvent",dataType:s,data:t,event:e};return await this._sendMessage(a,i==null?void 0:i.abortSignal),{isDuplicated:!1}}async joinGroup(e,t){return await this._operationExecuteWithRetry(()=>this._joinGroupAttempt(e,t),t==null?void 0:t.abortSignal)}async _joinGroupAttempt(e,t){const s=this._getOrAddGroup(e),i=await this._joinGroupCore(e,t);return s.isJoined=!0,i}async _joinGroupCore(e,t){return await this._sendMessageWithAckId(s=>({group:e,ackId:s,kind:"joinGroup"}),t==null?void 0:t.ackId,t==null?void 0:t.abortSignal)}async leaveGroup(e,t){return await this._operationExecuteWithRetry(()=>this._leaveGroupAttempt(e,t),t==null?void 0:t.abortSignal)}async _leaveGroupAttempt(e,t){const s=this._getOrAddGroup(e),i=await this._sendMessageWithAckId(r=>({group:e,ackId:r,kind:"leaveGroup"}),t==null?void 0:t.ackId,t==null?void 0:t.abortSignal);return s.isJoined=!1,i}async sendToGroup(e,t,s,i){return await this._operationExecuteWithRetry(()=>this._sendToGroupAttempt(e,t,s,i),i==null?void 0:i.abortSignal)}async _sendToGroupAttempt(e,t,s,i){var r,o;const a=(r=i==null?void 0:i.fireAndForget)!==null&&r!==void 0?r:!1,l=(o=i==null?void 0:i.noEcho)!==null&&o!==void 0?o:!1;if(!a)return await this._sendMessageWithAckId(u=>({kind:"sendToGroup",group:e,dataType:s,data:t,ackId:u,noEcho:l}),i==null?void 0:i.ackId,i==null?void 0:i.abortSignal);const d={kind:"sendToGroup",group:e,dataType:s,data:t,noEcho:l};return await this._sendMessage(d,i==null?void 0:i.abortSignal),{isDuplicated:!1}}_getWebSocketClientFactory(){return new Im}async _trySendSequenceAck(){if(!this._protocol.isReliableSubProtocol)return;const[e,t]=this._sequenceId.tryGetSequenceId();if(e&&t){const s={kind:"sequenceAck",sequenceId:t};try{await this._sendMessage(s)}catch{this._sequenceId.tryUpdate(t)}}}_connectCore(e){if(this._isStopping)throw new Error("Can't start a client during stopping");return new Promise((t,s)=>{const i=this._wsClient=this._getWebSocketClientFactory().create(e,this._protocol.name);i.onopen(()=>{if(this._isStopping){try{i.close()}catch{}s(new Error("The client is stopped"))}Mt.verbose("WebSocket connection has opened"),this._changeState(Lt.Connected),this._protocol.isReliableSubProtocol&&(this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),this._sequenceAckTask=new ed(async()=>{await this._trySendSequenceAck()},1e3)),t()}),i.onerror(r=>{this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),s(r)}),i.onclose((r,o)=>{this._state===Lt.Connected?(Mt.verbose("WebSocket closed after open"),this._sequenceAckTask!=null&&this._sequenceAckTask.abort(),Mt.info(`WebSocket connection closed. Code: ${r}, Reason: ${o}`),this._lastCloseEvent={code:r,reason:o},this._handleConnectionClose.call(this)):(Mt.verbose("WebSocket closed before open"),s(new Error(`Failed to start WebSocket: ${r}`)))}),i.onmessage(r=>{const o=m=>{if(this._ackMap.has(m.ackId)){const b=this._ackMap.get(m.ackId);this._ackMap.delete(m.ackId);const g=m.error!=null&&m.error.name==="Duplicate";m.success||g?b.resolve({ackId:m.ackId,isDuplicated:g}):b.reject(new Pr("Failed to send message.",{ackId:m.ackId,errorDetail:m.error}))}},a=async m=>{if(this._connectionId=m.connectionId,this._reconnectionToken=m.reconnectionToken,!this._isInitialConnected){if(this._isInitialConnected=!0,this._options.autoRejoinGroups){const b=[];this._groupMap.forEach(g=>{g.isJoined&&b.push((async()=>{try{await this._joinGroupCore(g.name)}catch(y){this._safeEmitRejoinGroupFailed(g.name,y)}})())});try{await Promise.all(b)}catch{}}this._safeEmitConnected(m.connectionId,m.userId)}},l=m=>{this._lastDisconnectedMessage=m},d=m=>{if(m.sequenceId!=null){const b=this._sequenceId.tryUpdate(m.sequenceId);if(b===0)return;b>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitGroupMessage(m)},u=m=>{if(m.sequenceId!=null){const b=this._sequenceId.tryUpdate(m.sequenceId);if(b===0)return;b>this._quickSequenceAckDiff&&this._trySendSequenceAck()}this._safeEmitServerMessage(m)};let p;try{let m;if(Array.isArray(r)?m=Buffer.concat(r):m=r,p=this._protocol.parseMessages(m),p===null)return}catch(m){throw Mt.warning("An error occurred while parsing the message from service",m),m}Array.isArray(p)||(p=[p]),p.forEach(m=>{try{switch(m.kind){case"ack":{o(m);break}case"connected":{a(m);break}case"disconnected":{l(m);break}case"groupData":{d(m);break}case"serverData":{u(m);break}}}catch(b){Mt.warning(`An error occurred while handling the message with kind: ${m.kind} from service`,b)}})})})}async _handleConnectionCloseAndNoRecovery(){this._state=Lt.Disconnected,this._safeEmitDisconnected(this._connectionId,this._lastDisconnectedMessage),this._options.autoReconnect?await this._autoReconnect():await this._handleConnectionStopped()}async _autoReconnect(){let e=!1,t=0;try{for(;!this._isStopping;)try{await this._startFromRestarting(),e=!0;break}catch(s){Mt.warning("An attempt to reconnect connection failed.",s),t++;const i=this._reconnectRetryPolicy.nextRetryDelayInMs(t);if(i==null)break;try{Mt.verbose(`Delay time for reconnect attempt ${t}: ${i}`),await Jr(i)}catch{}}}finally{e||this._handleConnectionStopped()}}_handleConnectionStopped(){this._isStopping=!1,this._state=Lt.Stopped,this._safeEmitStopped()}_getActiveKeepaliveTask(){return new ed(async()=>{this._sequenceId.tryUpdate(0)},this._activeTimeoutInMs)}async _sendMessage(e,t){if(!this._wsClient||!this._wsClient.isOpen())throw new Error("The connection is not connected.");const s=this._protocol.writeMessage(e);await this._wsClient.send(s,t)}async _sendMessageWithAckId(e,t,s){t==null&&(t=this.nextAckId());const i=e(t);this._ackMap.has(t)||this._ackMap.set(t,new tw(t));const r=this._ackMap.get(t);try{await this._sendMessage(i,s)}catch(o){this._ackMap.delete(t);let a="";throw o instanceof Error&&(a=o.message),new Pr(a,{ackId:t})}if(s)try{return await Am(r.promise(),s)}catch(o){throw o instanceof Error&&o.name==="AbortError"?new Pr("Cancelled by abortSignal",{ackId:t}):o}return await r.promise()}async _handleConnectionClose(){if(this._ackMap.forEach((i,r)=>{this._ackMap.delete(r)&&i.reject(new Pr("Connection is disconnected before receive ack from the service",{ackId:i.ackId}))}),this._isStopping){Mt.warning("The client is stopping state. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(this._lastCloseEvent&&this._lastCloseEvent.code===1008){Mt.warning("The websocket close with status code 1008. Stop recovery."),this._handleConnectionCloseAndNoRecovery();return}if(!this._protocol.isReliableSubProtocol){Mt.warning("The protocol is not reliable, recovery is not applicable"),this._handleConnectionCloseAndNoRecovery();return}const e=this._buildRecoveryUri();if(!e){Mt.warning("Connection id or reconnection token is not available"),this._handleConnectionCloseAndNoRecovery();return}let t=!1;this._state=Lt.Recovering;const s=qu.timeout(30*1e3);try{for(;!s.aborted||this._isStopping;)try{await this._connectCore.call(this,e),t=!0;return}catch{await Jr(1e3)}}finally{t||(Mt.warning("Recovery attempts failed more then 30 seconds or the client is stopping"),this._handleConnectionCloseAndNoRecovery())}}_safeEmitConnected(e,t){this._emitEvent("connected",{connectionId:e,userId:t})}_safeEmitDisconnected(e,t){this._emitEvent("disconnected",{connectionId:e,message:t})}_safeEmitGroupMessage(e){this._emitEvent("group-message",{message:e})}_safeEmitServerMessage(e){this._emitEvent("server-message",{message:e})}_safeEmitStopped(){this._emitEvent("stopped",{})}_safeEmitRejoinGroupFailed(e,t){this._emitEvent("rejoin-group-failed",{group:e,error:t})}_buildDefaultOptions(e){return e.autoReconnect==null&&(e.autoReconnect=!0),e.autoRejoinGroups==null&&(e.autoRejoinGroups=!0),e.protocol==null&&(e.protocol=Xb()),this._buildMessageRetryOptions(e),this._buildReconnectRetryOptions(e),e}_buildMessageRetryOptions(e){e.messageRetryOptions||(e.messageRetryOptions={}),(e.messageRetryOptions.maxRetries==null||e.messageRetryOptions.maxRetries<0)&&(e.messageRetryOptions.maxRetries=3),(e.messageRetryOptions.retryDelayInMs==null||e.messageRetryOptions.retryDelayInMs<0)&&(e.messageRetryOptions.retryDelayInMs=1e3),(e.messageRetryOptions.maxRetryDelayInMs==null||e.messageRetryOptions.maxRetryDelayInMs<0)&&(e.messageRetryOptions.maxRetryDelayInMs=3e4),e.messageRetryOptions.mode==null&&(e.messageRetryOptions.mode="Fixed")}_buildReconnectRetryOptions(e){e.reconnectRetryOptions||(e.reconnectRetryOptions={}),(e.reconnectRetryOptions.maxRetries==null||e.reconnectRetryOptions.maxRetries<0)&&(e.reconnectRetryOptions.maxRetries=Number.MAX_VALUE),(e.reconnectRetryOptions.retryDelayInMs==null||e.reconnectRetryOptions.retryDelayInMs<0)&&(e.reconnectRetryOptions.retryDelayInMs=1e3),(e.reconnectRetryOptions.maxRetryDelayInMs==null||e.reconnectRetryOptions.maxRetryDelayInMs<0)&&(e.reconnectRetryOptions.maxRetryDelayInMs=3e4),e.reconnectRetryOptions.mode==null&&(e.reconnectRetryOptions.mode="Fixed")}_buildRecoveryUri(){if(this._connectionId&&this._reconnectionToken&&this._uri){const e=new URL(this._uri);return e.searchParams.append("awps_connection_id",this._connectionId),e.searchParams.append("awps_reconnection_token",this._reconnectionToken),e.toString()}return null}_getOrAddGroup(e){return this._groupMap.has(e)||this._groupMap.set(e,new ew(e)),this._groupMap.get(e)}_changeState(e){Mt.verbose(`The client state transfer from ${this._state.toString()} to ${e.toString()}`),this._state=e}async _operationExecuteWithRetry(e,t){let s=0;for(;;)try{return await e.call(this)}catch(i){s++;const r=this._messageRetryPolicy.nextRetryDelayInMs(s);if(r==null||(await Jr(r),t!=null&&t.aborted))throw i}}}class Zc{constructor(e){this._retryOptions=e,this._maxRetriesToGetMaxDelay=Math.ceil(Math.log2(this._retryOptions.maxRetryDelayInMs)-Math.log2(this._retryOptions.retryDelayInMs)+1)}nextRetryDelayInMs(e){return e>this._retryOptions.maxRetries?null:this._retryOptions.mode==="Fixed"?this._retryOptions.retryDelayInMs:this._calculateExponentialDelay(e)}_calculateExponentialDelay(e){return e>=this._maxRetriesToGetMaxDelay?this._retryOptions.maxRetryDelayInMs:(1<<e-1)*this._retryOptions.retryDelayInMs}}class ew{constructor(e){this.isJoined=!1,this.name=e}}class tw{constructor(e){this._promise=new Promise((t,s)=>{this._resolve=t,this._reject=s}),this.ackId=e}promise(){return this._promise}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}class nw{constructor(){this._sequenceId=0,this._isUpdate=!1}tryUpdate(e){if(this._isUpdate=!0,e>this._sequenceId){const t=e-this._sequenceId;return this._sequenceId=e,t}return 0}tryGetSequenceId(){return this._isUpdate?(this._isUpdate=!1,[!0,this._sequenceId]):[!1,null]}reset(){this._sequenceId=0,this._isUpdate=!1}}class ed{constructor(e,t,s){this._func=e,this._abortController=new qu,this._interval=t,this._obj=s,this._start()}abort(){try{this._abortController.abort()}catch{}}async _start(){const e=this._abortController.signal;for(;!e.aborted;)try{await this._func(this._obj)}catch{}finally{await Jr(this._interval)}}}const sw=1e3*60*60,iw=1e3*30;class rw{constructor(e,t,s,i=null,r=new Map){re(this,"client");re(this,"handler");re(this,"terminationTimeout",null);re(this,"connectionUrl");re(this,"expiresAt");re(this,"connected",!1);re(this,"websocketRequestId",null);re(this,"conversationId",null);re(this,"secondaryTypeBasedHandlers",new Map);this.connectionUrl=t,this.expiresAt=s,this.client=new Zb({getClientAccessUrl:()=>e(this.connectionUrl,this.expiresAt)},{autoReconnect:!0,reconnectRetryOptions:{maxRetries:5,retryDelayInMs:100,maxRetryDelayInMs:1e4,mode:"Exponential"}}),this.handler=i,this.secondaryTypeBasedHandlers=r}async start(){const e=t=>{if(this.secondaryTypeBasedHandlers.has(t.message.data.type)){const s=this.secondaryTypeBasedHandlers.get(t.message.data.type);if(!s)return;s(t.message.data)}else{const s=t.message.data.body,i=atob(s).trim();if(i.startsWith("data: ")){const r=i.replace("data: ",""),o=this.handler;if(!o)return;o({conversationId:t.message.data.conversation_id,responseId:t.message.data.response_id,message:{id:"",event:"",data:r},websocketRequestId:t.message.data.websocket_request_id})}}};this.client.on("group-message",t=>e(t)),this.client.on("server-message",t=>e(t)),this.client.on("connected",()=>{this.connected=!0}),this.client.on("disconnected",()=>{this.connected=!1}),await this.client.start()}addSecondaryTypeHandler(e,t){this.secondaryTypeBasedHandlers.set(e,t)}isConnected(){return this.connected}async stop(e){e&&this.conversationId!==e||this.websocketRequestId&&await Ge.stopWebsocketConversation(this.websocketRequestId)}setHandler(e,t,s,i){!this.handler&&this.websocketRequestId===s||(this.handler!=null&&this.websocketRequestId!==s&&(px.warn("[websockets] Overwriting existing handler without silencing. This may indicate a race condition."),ee.logEvent($.asyncHandlerOverwritten,{originalWebsocketRequestId:this.websocketRequestId,newWebsocketRequestId:s,conversationId:e,responseId:t})),this.websocketRequestId=s,this.conversationId=e,this.handler=r=>{(r.websocketRequestId===s||r.conversationId===e&&r.responseId===t)&&i(r.message)})}silence(){this.handler=null}close(){this.client.stop()}scheduleForTermination(e){this.terminationTimeout=setTimeout(()=>{this.close(),e()},sw)}preventTermination(){this.terminationTimeout&&(clearTimeout(this.terminationTimeout),this.terminationTimeout=null)}updateConnectionUrl(e,t){this.connectionUrl=e,this.expiresAt=t}}class ow{constructor(){re(this,"activeSocketMap",new Map);re(this,"secondaryTypeBasedHandlers",new Map)}async register(){const e=await Ge.postRegisterWebsocket();e.wss_url&&(this.getOrCreateSocket(e.wss_url,new Date(e.expires_at),!0),e.fallback_wss_url&&this.getOrCreateSocket(e.fallback_wss_url,new Date(e.expires_at),!1))}async registerIfNotConnected(){if(this.activeSocketMap.size===0){await this.register();return}for(const e of this.activeSocketMap.values())if(!e.isConnected()){await this.register();return}}isWebsocketConnected(){for(const e of this.activeSocketMap.values())if(e.isConnected())return!0;return this.activeSocketMap.size>0&&jt.addError("Cannot connect to any websocket."),!1}async getOrCreateSocket(e,t,s){const i=e.split("?")[0];let r;const o=this.activeSocketMap.get(i);if(o&&o.isConnected())o.preventTermination(),o.updateConnectionUrl(e,t),r=o;else{o&&o.close(),r=new rw(async(a,l)=>{if(new Date<new Date(l.getTime()-5*1e3))return a;const d=await Ge.postRegisterWebsocket();return s?d.wss_url:d.fallback_wss_url??""},e,t,null,this.secondaryTypeBasedHandlers),this.activeSocketMap.set(i,r);try{await r.start()}catch(a){throw jt.addError(new Error("Error occurred while starting websocket: ",{cause:a})),a}}return r}preSetupWebsocket(e,t,s){for(const i of this.activeSocketMap.values())this.setupWebSocketHandler(i,null,null,null,e,t,s)}addSecondaryTypeHandler(e,t){this.secondaryTypeBasedHandlers.set(e,t);for(const s of this.activeSocketMap.values())s.addSecondaryTypeHandler(e,t)}hasSecondaryTypeHandler(e){return this.secondaryTypeBasedHandlers.has(e)}async processWebSocketConversationStream(e,t,s,i,r,o,a,l,d){const u=[this.getOrCreateSocket(e,s,!0)];t&&u.push(this.getOrCreateSocket(t,s,!1));const p=await Promise.allSettled(u),m=p[0].status==="fulfilled"?p[0].value:null,b=p.length>1&&p[1].status==="fulfilled"?p[1].value:null;if((!m||!m.isConnected())&&jt.addError(`Cannot connect to primary websocket, websocketRequestId: ${o}, token: ${e.substring(0,e.indexOf("access_token="))}`),(!m||!m.isConnected())&&(!b||!b.isConnected()))throw t&&jt.addError(`Cannot connect to fallback websocket, websocketRequestId: ${o}, token: ${t.substring(0,t.indexOf("access_token="))}`),new rs(`An error occurred while connecting to the websocket. ${Wa}`);let g=setTimeout(()=>{jt.addError(`WebSocket took too long to respond: ${r}, ${i}, ${o}, ${e.substring(0,60)}...${e.slice(-20)}`,{supportsWebSockets:"WebSocket"in window&&window.WebSocket.CLOSING===2})},iw);const y=C=>(d&&(clearTimeout(d),d=null),g&&(clearTimeout(g),g=null),a(C));m&&this.setupWebSocketHandler(m,e,i,r,o,y,l),b&&t&&this.setupWebSocketHandler(b,t,i,r,o,y,l)}async stopConversation(e){for(const t of this.activeSocketMap.values())await t.stop(e)}setupWebSocketHandler(e,t,s,i,r,o,a){e.setHandler(s,i,r,o),this.secondaryTypeBasedHandlers.forEach((d,u)=>{e.addSecondaryTypeHandler(u,d)});const l=()=>{t?e.scheduleForTermination(()=>{this.activeSocketMap.delete(t.split("?")[0])}):(this.stopConversation(s),e.silence())};a.addEventListener("abort",l)}}const bs=new ow;function aw(n){return{webSocketUrl:n.wss_url,fallbackWebSocketUrl:n.fallback_wss_url,conversationId:n.conversation_id,responseId:n.response_id,expiresAt:n.expires_at&&new Date(n.expires_at),websocketRequestId:n.websocket_request_id}}async function lw(n,e,t){return bs.preSetupWebsocket(n,e,t)}async function cw(n,e,t,s,i,r,o,a,l){return bs.processWebSocketConversationStream(n,e,t,s,i,r,o,a,l)}function Qr(n){return n==null||[it.PrimaryAssistant,it.GizmoInteraction].includes(n.kind)}function Ko(n,e){const t=vs(n,e),{data:s}=Ms(t!=null&&"gizmo_id"in t?t.gizmo_id:void 0,(t==null?void 0:t.kind)===it.GizmoTest);if(t!=null)switch(t.kind){case it.GizmoInteraction:case it.GizmoMagicCreate:case it.GizmoTest:return{gizmo:s,...t};case it.PrimaryAssistant:return t}}function dw(n,e,t){const i=O.getTree(e).getMessageId(O.getThreadCurrentLeafId(e));Ge.generateTitle(e,i,t).then(({title:r})=>{O.setTitle(e,r,tf.Generated),Ml(n),ee.logEvent($.renameThread,{threadId:e,content:r,model:t})}).catch(jt.addError)}function uw(n,e,t){const s=()=>{const r=Kc(t);Rc(r)},i=Ot.getGizmoId(t);i!=null?g0(e,i).then(r=>{Rc(Kc(t,r))}).catch(r=>{jt.addError(r),s()}):s()}const qa={onCreate(n){Ml(n),ee.logEvent($.newThread)},onCreateFinished(n,e,t){var i;if(Uo()||!t)return;if(!rt.checkGate("2562876640")){const r=(i=Ot.getThread(t))==null?void 0:i.initialThreadData.lastModelUsed;r==null&&jt.addError("missing lastModelUsed on conversation create finished"),dw(e,t,r)}const s=Ot.getConversationMode(t);Qr(s)&&Oh(e).then(r=>{Ph(r)||uw(n,e,t)})}},td=Xe.div`m-8 flex flex-col items-center`;function nd(n){return c.jsx(ft.div,{initial:{opacity:0,translateY:20},animate:{opacity:1,translateY:0,transition:{duration:.5,ease:"easeIn"}},...n})}function hw({clientThreadId:n}){const e=M0(n),t=e==null?void 0:e.gizmoId,{data:s}=Ms(t);return t==null||s==null||!Rm(s)?null:c.jsx(fw,{gizmoId:t})}function fw({gizmoId:n}){const[e,t]=S.useState(!1),[s,i]=S.useState(!1),r=y0(n),o=async l=>{t(!0),setTimeout(()=>{i(!0)},5e3),ee.logEvent($.submitInlineRating,{gizmo_id:n,rating:l}),await r.mutateAsync({rating:l})},a=async()=>{i(!0),ee.logEvent($.dismissInlineRating,{gizmo_id:n}),await r.mutateAsync({})};return S.useEffect(()=>{s||ee.logEvent($.showInlineRating,{gizmo_id:n})},[s,n]),s?null:e?c.jsx(td,{children:c.jsxs(nd,{className:"flex flex-col items-center gap-4",children:[c.jsx("div",{className:"rounded-lg border border-token-border-heavy p-4",children:c.jsxs("div",{className:"flex justify-between gap-2",children:[c.jsx(U,{id:"gizmo.inlineReview.reviewLeft",defaultMessage:"Feedback sent"}),c.jsx(Ga,{onClick:()=>{i(!0)}})]})}),c.jsx("div",{className:"text-xs text-token-text-tertiary",children:c.jsx(U,{id:"gizmo.inlineReview.reviewLeftSubtext",defaultMessage:'To update your rating, click "Send Feedback" in the GPT Menu'})})]})}):c.jsx(td,{children:c.jsxs(nd,{className:"flex flex-col items-center gap-4 rounded-lg border border-token-border-heavy p-4",children:[c.jsxs("div",{className:"flex justify-between gap-2",children:[c.jsx(U,{id:"gizmo.inlineReview.prompt",defaultMessage:"How would you rate this GPT so far?"}),c.jsx(Ga,{onClick:a})]}),c.jsx(bb,{rating:void 0,onRating:o})]})})}function pw(n,e){const t=Oo(Po.MentionGPTs),s=Dm(),[i,r]=S.useState(!1),o=()=>{r(!0),t.markAsViewed()};return S.useImperativeHandle(e,()=>({handleClose:o})),t.eligible&&!t.isLoading&&!s?c.jsx(mw,{wasDismissed:i,onDismiss:o}):null}function mw({wasDismissed:n,onDismiss:e}){const t=Fe(),{recent:s,pinned:i}=wb(),r=s&&s.pages.flatMap(o=>o.list.items).length>0||i&&i.items.length>0;return S.useEffect(()=>{r&&ee.logEvent($.mentionsDisplayNux)},[r]),r?c.jsx(vl,{badge:"beta",align:"start",side:"top",arrowPadding:58,show:!n,title:t.formatMessage({id:"mentionGptsAnnouncement.title",defaultMessage:"GPT mentions"}),onDismiss:e,sideOffset:25,theme:"default",description:c.jsx(U,{id:"mentionGptsAnnouncement.description",defaultMessage:"Type {key} to mention a GPT and add it directly into your conversation",values:{key:c.jsx("span",{className:"font-bold",children:"@"})}}),children:c.jsx("div",{className:"absolute sm:left-16"})}):null}const gw=S.forwardRef(pw);function yw({suggestions:n,composerController:e,onSelect:t,onChange:s}){const i=df(),r=S.useCallback((l,d,u)=>{t==null||t(l,d,u),i(l,d,u)},[t,i]),[o,a]=S.useState(-1);return S.useEffect(()=>{const l=d=>{if(d.key==="ArrowDown"){const u=o===n.length-1?0:o+1;a(u),s==null||s(u,!0,n[u])}else if(d.key==="ArrowUp"){d.preventDefault();const u=o===0?n.length-1:o-1;a(u),s==null||s(u,!0,n[u])}else d.key==="Enter"&&n[o]&&r(n[o],n,o)};return e.subscribe("keydown",l)},[n,o,s,r,e]),S.useEffect(()=>e.subscribe("blur",()=>{a(-1),s==null||s(-1,!1)}),[e,s]),c.jsx(ft.ul,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"hidden w-full flex-col p-2.5 group-focus-within:block",children:n.map((l,d)=>c.jsxs(ft.li,{initial:{opacity:0},animate:{opacity:1},transition:{delay:d*.03},exit:{opacity:0},className:"w-full",children:[d>0&&c.jsx("div",{className:se("h-[1px] opacity-60",o===d||o===d-1?"mx-2 bg-token-main-surface-secondary":"bg-token-border-light")}),c.jsxs("button",{className:se("inline w-full cursor-pointer items-center justify-start rounded-lg px-2.5 py-3 text-start",o===d?"bg-token-main-surface-secondary":"bg-token-main-surface-primary"),onClick:u=>{u.preventDefault(),r(l,n,d)},onMouseEnter:()=>{a(d),s==null||s(d,!1,l)},onMouseLeave:()=>{a(-1),s==null||s(-1,!1,l)},children:[c.jsx("span",{className:"text-token-text-primary",children:l.title}),c.jsx("span",{className:"ml-1 text-token-text-secondary",children:l.body})]})]},l.id??d))})}function xw({composerController:n}){const{doesUserHaveAnyAccountsWithPlusFeatures:e}=Bi(),t=Fe(),s=Fo();return c.jsxs("div",{className:se("flex justify-between",!s&&"bg-gradient-to-t from-token-main-surface-primary to-transparent px-4"),children:[c.jsx("div",{className:"flex gap-2",children:c.jsx(ww,{onClickStyle:i=>{id(t.formatMessage(i.expandedName??i.name),n)}})}),e&&c.jsx("div",{className:"flex gap-2",children:c.jsx(bw,{onClickAspectRatio:i=>id(t.formatMessage(i.expandedName),n)})})]})}function bw({onClickAspectRatio:n}){const e=Fe();return c.jsxs(Ae.Root,{onOpenChange:t=>{t&&(rt.logEvent($.dalleOpenAspectRatioDropdown),ee.logEvent($.dalleOpenAspectRatioDropdown))},children:[c.jsxs(Ha,{$as:Ae.Trigger,className:"pr-1.5",children:[c.jsx(U,{id:"dalleControls.aspectRatio",defaultMessage:"Aspect Ratio"}),c.jsx(Ho,{className:"icon-md"})]}),c.jsx(Ae.Portal,{children:c.jsx(Ae.Content,{children:jm.map(t=>c.jsx(Ae.Item,{onClick:()=>{var s;n(t),rt.logEvent($.dalleClickAspectRatio,(s=t.name.defaultMessage)==null?void 0:s.toString()),ee.logEvent($.dalleClickAspectRatio,{aspectRatio:t.name.defaultMessage})},icon:t.icon,children:e.formatMessage(t.name)},t.name.id))})})]})}function ww({onClickStyle:n}){const[e,t]=S.useState(sd()),s=mx(),i=zl(),r=kr(),o=Fe();let a=2;return r||(i?a=5:s&&(a=3)),c.jsxs(c.Fragment,{children:[e.slice(0,a).map(l=>c.jsx(ti,{label:c.jsx(Sw,{style:l}),side:"top",sideOffset:4,customPaddingClassName:"p-1",children:c.jsxs(Ha,{$as:"button",type:"button",onClick:()=>{var d;n(l),rt.logEvent($.dalleClickStyle,(d=l.name.defaultMessage)==null?void 0:d.toString()),ee.logEvent($.dalleClickStyle,{style:l.name.defaultMessage})},children:[c.jsx(K0,{className:"h-4 w-4 text-token-text-tertiary"}),o.formatMessage(l.name)]})},l.name.id)),c.jsx(Ha,{$as:"button",type:"button",onClick:()=>{t(sd()),rt.logEvent($.dalleShuffleStyles),ee.logEvent($.dalleShuffleStyles)},children:c.jsx(Om,{className:"icon-sm text-token-text-tertiary"})}),Hu.map(l=>c.jsx($u,{src:l.image,alt:o.formatMessage(l.name),width:100,height:100,className:"invisible fixed -left-96 -top-96"},l.name.id))]})}function Sw({style:n}){const e=Fe();return c.jsxs("div",{className:"flex flex-col gap-1",children:[c.jsx($u,{src:n.image,alt:e.formatMessage(n.name),width:100,height:100,className:"rounded-md"}),c.jsx("div",{className:"text-xs font-medium",children:e.formatMessage(n.name)})]})}function sd(){return[...Hu].sort(()=>Math.random()-.5)}function kw(n,e){const t=e.getCurrentText();return t.trim()===""?n:t.endsWith(",")?` ${n.toLocaleLowerCase()}`:t.endsWith(", ")?n.toLocaleLowerCase():`, ${n.toLocaleLowerCase()}`}function id(n,e){const t=kw(n,e);e.appendText(t),ar()}const Ha=Xe.div`h-7 bg-token-main-surface-primary border border-token-border-light text-xs hover:bg-token-main-surface-secondary hover:text-token-text-primary px-2.5 radix-state-open:bg-token-main-surface-secondary radix-state-open:text-token-text-primary rounded-full flex flex-nowrap gap-0.5 items-center text-token-text-secondary font-normal`,Lr={initial:{opacity:0,y:20,scale:.9},animate:{opacity:1,y:0,scale:1},transition:{delay:.1},exit:{opacity:0,scale:.5,transition:{duration:.2}}},Cw=({suggestions:n,onSelectingSuggestedReply:e})=>c.jsx("div",{className:"absolute bottom-full flex w-full max-w-[100vw] grow gap-2 overflow-auto px-1 pb-1 contain-inline-size sm:mb-0 sm:justify-start sm:px-2 sm:pb-0 md:static md:mb-2 md:max-w-none md:justify-center md:overflow-visible",children:n.slice(0,2).map((t,s)=>c.jsx(ft.div,{initial:Lr.initial,animate:Lr.animate,transition:{delay:(s-1)*Lr.transition.delay},exit:Lr.exit,children:c.jsx(It,{as:"button",color:"secondary",size:"small",onClick:()=>{e(t,n,s)},className:"group whitespace-nowrap md:whitespace-normal",children:c.jsx(vw,{suggestion:t})},s)},s))});function Mw({suggestions:n,onSelectingSuggestedReply:e,clientThreadId:t}){const s=(n==null?void 0:n.length)>0;S.useEffect(()=>{s&&So(n,t)},[s,t]);const{isUnauthenticated:i}=Zt();return s?n.every(uf)?c.jsxs(ft.div,{initial:{opacity:0},animate:{opacity:1},transition:{duration:.3},className:"flex flex-col items-center",children:[i&&c.jsx(Ku,{className:"mb-6 h-12 w-12 sm:hidden"}),c.jsx(L0,{starterPrompts:n,onSelectStarterPrompt:e})]}):n.every(hf)?c.jsx(Cw,{suggestions:n,onSelectingSuggestedReply:e}):null:null}function vw({suggestion:n}){return hf(n)?c.jsx(c.Fragment,{children:n.text}):uf(n)?c.jsxs("div",{className:"flex flex-col overflow-hidden",children:[n.title&&c.jsx("div",{className:"truncate font-semibold",children:n.title}),c.jsx("div",{className:se("truncate font-normal",n.title?"opacity-50":""),children:n.body})]}):null}function Tw(){const{store:n}=Xt(),e=n.useSharedProps();return e?c.jsx(Ew,{...e}):null}function Ew({clientThreadId:n,suggestions:e}){const t=df();return e===void 0||e.length===0?null:c.jsx("div",{children:c.jsx(_w,{children:c.jsx("div",{className:"grow",children:e!==void 0&&c.jsx(Mw,{suggestions:e,onSelectingSuggestedReply:t,clientThreadId:n})})})})}const _w=Xe.div`h-full flex ml-1 md:w-full md:m-auto gap-0 md:gap-2 justify-center`,bf=({className:n,children:e})=>c.jsx(ft.div,{className:n,initial:{opacity:0},animate:{opacity:1},exit:{opacity:0,transition:{duration:.1,delay:0}},transition:{type:"tween",duration:.3,delay:.2},children:e});function Nw({currentLeafId:n,canContinue:e,onContinueGenerating:t}){const s=S.useCallback(()=>{t(n),ar()},[t,n]);let i=null;return e&&(i=c.jsx(Iw,{onHandleContinueGenerating:s})),i&&c.jsx("div",{className:"flex h-full w-full items-center justify-end gap-0 py-4 md:gap-2",children:i})}const Iw=({onHandleContinueGenerating:n})=>{const e=Tr();return c.jsx(bf,{children:c.jsxs(It,{as:"button",color:"secondary",onClick:n,className:"whitespace-nowrap border-0 md:border",children:[c.jsx(mf,{className:se("-rotate-180",e?"icon-xs":"icon-sm")}),e&&c.jsx(U,{...Tn.continueGenerating})]})})},Aw=({clientThreadId:n})=>{const e=Fh(),t=Nr(n),s=Xn(t);S.useEffect(()=>{s&&cr.dismissBanner()},[s]);const i=e!=null&&e.is_dismissible?()=>cr.dismissBanner():void 0;return c.jsx(Ys,{children:e&&c.jsx(ft.div,{transition:{type:"tween",ease:"easeInOut",duration:.1},initial:{opacity:0,transform:"translateY(8px)"},animate:{opacity:1,transform:"translateY(0px)"},exit:{opacity:0,transform:"translateY(8px)"},children:c.jsx(Sb,{clientThreadId:n,rateLimitInfo:e,onDismiss:i})})})};function Rw(n){const e=Nr(n),t=Xn(e),s=Fh();return!t&&s!=null}const Hn=window.sessionStorage,$a=Bh(gx(()=>({memoryFullBannerDismissed:!!(Hn!=null&&Hn.getItem(Ai.MemoryFullBannerDismissed))}))),wf={dismissBanner(){$a.setState(n=>{n.memoryFullBannerDismissed=!0}),Hn==null||Hn.setItem(Ai.MemoryFullBannerDismissed,"true")},clearDismissedBanner(){$a.setState(n=>{n.memoryFullBannerDismissed=!1}),Hn==null||Hn.removeItem(Ai.MemoryFullBannerDismissed)}};function Dw(n){const e=Mn(n),t=Do(),{data:s}=jo(e,!1,t),i=s!=null,r=i&&s.memoryFullPct>=100,[o,a]=S.useState(!1);S.useEffect(()=>{!r&&i&&(a(!0),wf.clearDismissedBanner())},[r,i]);const l=$a(d=>d.memoryFullBannerDismissed);return r&&o&&!l}function jw(){const n=Fe(),{openSettings:e}=Pm();return c.jsx(ft.div,{initial:{opacity:0},animate:{opacity:1},children:c.jsx(Ju,{title:n.formatMessage(zr.memoryFullTitle),content:n.formatMessage(zr.memoryFullTooltip,zr.memoryFullTooltip.values),primaryCtaText:n.formatMessage(zr.memoryManageButton),onPrimaryCtaClick:()=>e(Fm.Personalization),onDismiss:()=>wf.dismissBanner()})})}const zr=Ke({memoryFullTitle:{id:"yRGU2/",defaultMessage:"Memory is full."},memoryManageButton:{id:"a5A88o",defaultMessage:"Manage"},memoryFullTooltip:{id:"neUc+N",defaultMessage:"New memories wont be created until you make space. <a>Learn more</a>",values:{a:n=>c.jsx("a",{href:Bm,target:"_blank",rel:"noopener noreferrer",className:"underline",children:n})}}}),Ow=()=>{const{shouldShowSkipButton:n}=Yu();return n?c.jsx(bf,{className:"flex justify-center",children:c.jsx(It,{as:"button",color:"secondary",onClick:()=>Qu.skipParagen(),children:c.jsx(U,{...Pw.skip})})}):null},Pw=Ke({skip:{id:"dvcUbp",defaultMessage:"Skip"}}),Fw=S.memo(function({className:e}){const{store:t}=Xt(),s=t.useIsHeaderContentAreaPopulated();return c.jsx("div",{className:se(e??"absolute bottom-full left-0 right-0",La.PromptTextareaHeader),children:c.jsx(Lm,{shouldRender:s,contentArea:_i.Header,children:c.jsxs("div",{className:"flex flex-col gap-3.5 pt-2",children:[c.jsx(Bw,{}),c.jsx(Lw,{})]})})})});function Bw(){const{store:n}=Xt(),e=n.useContentAreaId(_i.HeaderTop);let t;switch(e){case xt.ParagenControls:t=c.jsx(Ow,{});break;case xt.ItemActions:t=c.jsx(Tw,{});break;case xt.BannerSignup:t=c.jsx(Uw,{});break;case xt.BannerTermsDisclaimer:t=c.jsx(Vw,{});break;case xt.PromptTextareaAction:t=c.jsx(Ww,{});break;case xt.BannersRateLimit:t=c.jsx(Gw,{});break;case xt.BannerSidekickAnnouncement:t=c.jsx(_b,{});break;case xt.BannerMemoryFull:t=c.jsx(jw,{});break;case xt.Box:t=c.jsxs("div",{className:"flex h-20 w-full items-center justify-center gap-2 bg-red-500 p-2",children:["box",c.jsxs("div",{className:"flex h-full w-full items-center justify-center gap-2 bg-blue-500 p-2",children:["inner",c.jsx("div",{className:"flex h-full w-full items-center justify-center bg-yellow-400 text-center",children:"actual content"})]})]});break;default:t=null;break}return t}function Lw(){const{store:n}=Xt(),e=n.useContentAreaId(_i.HeaderBottom);let t;switch(e){case Xu.DallePromptControls:t=c.jsx(zw,{});break;default:t=null;break}return t}function zw(){const{store:n}=Xt(),e=n.useSharedProps(t=>t==null?void 0:t.composerController);return e?c.jsx(xw,{composerController:e}):null}function Uw(){const{store:n}=Xt(),e=n.useSharedProps(s=>s==null?void 0:s.clientThreadId),t=zm();return e?t?c.jsx(Um,{threadId:e}):c.jsx(Vm,{threadId:e}):null}function Vw(){const{store:n}=Xt(),e=n.useSharedProps(t=>t==null?void 0:t.clientThreadId);return e?c.jsx(Wm,{threadId:e}):null}function Ww(){const{store:n}=Xt(),e=n.useSharedProps();return e?c.jsx(Nw,{...e}):null}function Gw(){const{store:n}=Xt(),e=n.useSharedProps(t=>t==null?void 0:t.clientThreadId);return e?c.jsx(Aw,{clientThreadId:e}):null}function nc(){return zh(si.DataAnalysisV2)}function d_(){const n=Bo(),e=On();return e&&n&&!Lh(n)&&e.isEnterprise()}function qw(){return zh(si.ChartSerialization)}function u_(n,e){const t=n==="chart"?Ai.HasSeenAdaInteractiveChart:Ai.HasSeenAdaInteractiveTable,[s,i]=S.useState(Uc.getItem(t,{userId:e})??!1),r=S.useCallback(()=>{i(!0),Uc.setItem(t,!0,{userId:e})},[t,e]);return[s,r]}function h_(n){const[e,t]=S.useState([]),s=Zn(()=>{const i=O.resolveThreadId(n),r=O.getThreadCurrentLeafId(n);return O.getTree(i).getBranchFromLeaf(r)});return S.useEffect(()=>{const i=kf(s);i.length!==e.length&&t(i)},[e.length,n,s]),e}function Hw(n){return Zn(()=>{const e=O.resolveThreadId(n),t=O.getThreadCurrentLeafId(n),i=O.getTree(e).getBranchFromLeaf(t);return kf(i).length>0})}function Sf(n){var r,o,a,l;const e=((o=(r=n.metadata)==null?void 0:r.aggregate_result)==null?void 0:o.messages.filter(tc))??[];let t=0;const s=(((a=n.metadata)==null?void 0:a.ada_visualizations)??[]).map(d=>{let u=d;return d.type=="chart"&&(u={...d,fallback_image:e[t++]}),u}),i=(((l=n.metadata)==null?void 0:l.attachments)??[]).filter(d=>Zu(d.name)).map(d=>({type:"table",file_id:d.id??"",title:qm(d),file_name:d.name,context_connector_info:d.context_connector_info}));return[...s,...i]}function kf(n){return n.filter(t=>{var s,i,r,o;return((s=t.message)==null?void 0:s.author.role)==="tool"&&((i=t.message)==null?void 0:i.author.name)==="python"||(((o=(r=t.message)==null?void 0:r.metadata)==null?void 0:o.attachments)??[]).length>0}).flatMap(t=>Sf(t.message))}Bh(n=>({selectedSpreadsheet:null,setSelectedSpreadsheet:e=>n({selectedSpreadsheet:e})}));async function $w(n,e,t){const s=await n.text(),{parse:i}=await Oe(async()=>{const{parse:o}=await import("./oeujip5i1ptrxie5.js");return{parse:o}},[]),r=i(s);return{content:{columnNames:r.shift(),columnTypes:r[0].map(()=>"string"),rows:r},file_name:e,download_url:t}}function Kw(n){const e=n[0].values.length,t=[];for(let s=0;s<e;s++){const i=n.map(r=>r.values[s]);t.push(i)}return t}function f_(n){return vr({queryKey:["ada-visualization","chart",n.file_id],queryFn:async()=>{const e=await Ge.getFileDownloadLink(n.file_id);if(e.status===Uh.Success){const s=await(await fetch(e.download_url)).json();return{content:{chart_type:s.type,title:s.title,labels:s.labels,datasets:s.datasets,x_label:s.x_label,y_label:s.y_label},file_name:e.file_name??"",download_url:e.download_url}}else throw new Error("Failed to download chart json from interpreter")}})}function p_(n){return vr({queryKey:["ada-visualization","table",n.file_id],queryFn:async()=>{if(n.file_name&&Gm(n.file_name)){const e=await Ge.getAdaExcelFileContents(n.file_id);return{content:e.sheets.map(t=>({name:t.name,columnNames:t.columns.map(s=>s.name),columnTypes:t.columns.map(()=>"string"),rows:Kw(t.columns)})),download_url:e.download_url,file_name:n.file_name}}else{const e=await Ge.getFileDownloadLink(n.file_id);if(e.status===Uh.Success){const t=await fetch(e.download_url);return $w(t,e.file_name??"",e.download_url)}else throw new Error("Failed to download from interpreter")}}})}function Cf(n){const e=Ni(),t=Hw(n),s=nc();return t&&s&&!e.displayingSideBySideFeedback}function Jw(n){var e,t;return((t=(e=n.metadata)==null?void 0:e.dalle)==null?void 0:t.prompt)??""}async function Yw(n,e,t="image/png"){return new Promise((s,i)=>{n.toBlob(r=>{r!=null?s(new File([r],e,{type:t})):i(new Error("Failed to convert canvas to blob"))},t)})}async function Qw(n,e){const t=document.createElement("canvas");t.width=n.width,t.height=n.height;const s=t.getContext("2d");if(s==null)throw new Error("Failed to get 2d context for mask canvas");const i=s.createImageData(n.width,n.height);for(let r=0;r<n.data.length;r+=4)n.data[r+3]!==0?(i.data[r]=0,i.data[r+1]=0,i.data[r+2]=0,i.data[r+3]=255):(i.data[r]=255,i.data[r+1]=255,i.data[r+2]=255,i.data[r+3]=255);return s.putImageData(i,0,0),Yw(t,e)}async function Xw(n,e){const s=await(await fetch(n)).blob(),i=document.createElement("a");i.href=URL.createObjectURL(s),i.download=e,i.click(),i.remove()}function Zw(n){const e=Km(new Date,"yyyy-MM-dd HH.mm.ss");let t=n.slice(0,150);return t.endsWith(".")&&(t=t.slice(0,-1)),`DALLE ${e} - ${t}.webp`}async function m_(n,e,t){var r,o,a,l,d,u,p,m,b,g;const s=Jw(n),i=Zw(s);await Xw(n.url,i),rt.logEvent("chatgpt_dalle_image_download",null,{sourceOperation:((o=(r=n.metadata)==null?void 0:r.dalle)==null?void 0:o.edit_op)??"none",hasParent:((l=(a=n.metadata)==null?void 0:a.dalle)==null?void 0:l.parent_gen_id)!=null?"true":"false"}),ee.logEvent($.dalleImageDownload,{conversationId:e,messageId:t,generationId:(u=(d=n.metadata)==null?void 0:d.dalle)==null?void 0:u.gen_id,parentGenerationId:(m=(p=n.metadata)==null?void 0:p.dalle)==null?void 0:m.parent_gen_id,fileId:Lo(n.asset_pointer),sourceOperation:(g=(b=n.metadata)==null?void 0:b.dalle)==null?void 0:g.edit_op})}function eS(n){const e=Ko(n),t=kr(),s=e&&"gizmo"in e?e.gizmo:void 0;return!t&&(s==null?void 0:s.gizmo.id)===Hm}function g_(n,e){var i,r;const t=(r=(i=e.metadata)==null?void 0:i.dalle)==null?void 0:r.gen_id,s=Lo(e.asset_pointer);return s==null||t==null?n:{...n,messageMetadata:{...n.messageMetadata,dalle:{from_client:{operation:{type:"transformation",original_gen_id:t,original_file_id:s}}}}}}async function tS(n,e,t){return new Promise((s,i)=>{$m(eh(n),n,e,{kind:yx.DalleAgent},{onFileCreated:_t,onFileUploadProgress:_t,onFileUploaded:(r,o)=>s(o),onError:(r,o)=>{i(new Error(`Failed to upload file with reason: ${o}`))}},t)})}async function y_(n,e,t,s){var o,a;const i=(a=(o=e.metadata)==null?void 0:o.dalle)==null?void 0:a.gen_id,r=Lo(e.asset_pointer);if(r==null||i==null||t==null)return n;try{const l=await Qw(t,"mask.png"),d=await tS(l,s,{imageDimensions:{width:e.width,height:e.height}});return{...n,messageMetadata:{...n.messageMetadata,dalle:{from_client:{operation:{type:"inpainting",original_gen_id:i,original_file_id:r,mask_file_id:d}}}}}}catch(l){return jt.addError(l),n}}const nS=S.memo(function(e){return sS(e),iS(e),rS(),null});function sS(n){const{store:e}=Xt(),t=e.useSetSharedProps();S.useLayoutEffect(()=>{t(n)},[n,t])}function iS(n){const{clientThreadId:e,canContinue:t}=n,{store:s}=Xt(),i=S.useRef({top:s.useContentAreaApi(_i.HeaderTop),bottom:s.useContentAreaApi(_i.HeaderBottom)}).current,r=lS(n),o=eS(e),{shouldShowBannerSignup:a,shouldShowBannerTermsDisclaimer:l}=cS(e),d=Rw(e),u=Nb(n),p=Dw(e),m=Jm();S.useLayoutEffect(()=>{m?i.top.set(xt.ParagenControls):l?i.top.set(xt.BannerTermsDisclaimer):d?i.top.set(xt.BannersRateLimit):u.eligible?i.top.set(xt.BannerSidekickAnnouncement):r?i.top.set(xt.ItemActions):t?i.top.set(xt.PromptTextareaAction):a?i.top.set(xt.BannerSignup):p?i.top.set(xt.BannerMemoryFull):i.top.set(null)},[i,r,t,l,a,d,u,p,m]),S.useLayoutEffect(()=>{o&&i.bottom.set(Xu.DallePromptControls)},[i,o])}function rS(){const{store:n}=Xt();S.useEffect(()=>()=>{n.reset()},[n])}function oS(n){var i,r;const e=nh(),t=Rn(n),s=(r=(i=O.getTree(n).getLastValidNode(t))==null?void 0:i.message)==null?void 0:r.id;return(e==null?void 0:e.messageId)===s?e.suggestions:[]}function aS(n){return oS(n).length>0}function lS(n){const e=Cf(n.clientThreadId),t=aS(n.clientThreadId);return n.isDisabled?!1:n.isNewThread||e||t}function cS(n){var p;const{isUnauthenticated:e}=Zt(),t=Rn(n),{layer:s}=Vh("3637408529"),i=s.get("should_show_no_auth_signup_banner",!0),r=th(m=>m.bannerDisclaimerClientThreadId),o={shouldShowBannerTermsDisclaimer:!1,shouldShowBannerSignup:!1};if(!n)return o;const a=O.getTree(n),l=a.countMessagesByAuthor(Ve.User),d=a.getNodeByIdOrMessageId(t),u=((p=d==null?void 0:d.message)==null?void 0:p.author.role)===Ve.Assistant&&Ul(d.message);return o.shouldShowBannerTermsDisclaimer=u&&e&&l===1&&(r==null||r===n),o.shouldShowBannerSignup=i&&u&&e&&l>0&&l%5===0,o}function dS(n,e,t,s,i){const{getGizmoId:r}=Cr(),[o,a]=S.useState();S.useEffect(()=>{r?r().then(u=>a(u)):a(void 0)},[r]);const l=Wh(e);return S.useCallback(u=>{const{docsReferencedByURL:p}=Ot.getThread(n)??{};if(p!=null)for(const m of u){const{id:b,type:g,handler:y}=m,C=`${g}:${b}`,M=p[C],R=uo.getState().files.find(N=>N.tempId===b);if(M!=null&&M!=="failed"&&R){on.success(t.formatMessage(da.fileAlreadyAttached),{hasCloseButton:!0});continue}switch(y.type){case"fetch":{O.updateReferencedDocState(n,C,"pending"),ms.uploadFile(b,new File([],t.formatMessage(da.fileLoading)),Qs.None,s,t,{skipUpload:!0,gizmoId:o},i,{contextConnector:g,sourceUrl:m.url,syntheticExtension:null,type:bo.Link}),oa.linkMetadataFetchStarted(g),y.tryFetch().then(N=>{if(ms.remove(b,"none"),N==null)return null;const{id:E,title:P,connector:F,mimeType:D,url:A,syntheticExtension:G,o365DriveId:W}=N;oa.linkMetadataFetchSucceeded(g,D),O.updateReferencedDocState(n,C,"fetched");let j=P;F===zt.GDRIVE&&(j=G?`${P}.${G}`:P),ms.uploadFile(E,new File([],j,{type:D.split(";")[0]}),Qs.Retrieval,s,t,{gizmoId:o},i,{contextConnector:F,sourceUrl:A,syntheticExtension:G,type:bo.Link,o365DriveId:W})}).catch(N=>{oa.linkMetadataFetchFailed(g,N),on.danger(t.formatMessage(da.fileFetchFailed),{hasCloseButton:!0}),O.updateReferencedDocState(n,C,"failed"),ms.remove(b,"none")});break}case"prompt":{l.appendMessageIfNotDismissed({connector:g,type:y.message}),O.updateReferencedDocState(n,C,"prompted");break}}}},[i,n,l,o,t,s])}const da=Ke({fileLoading:{id:"CCC.fileLoading",defaultMessage:"Loading"},fileFetchFailed:{id:"CCC.fileFetchFailed",defaultMessage:"Unable to fetch file information"},fileAlreadyAttached:{id:"CCC.fileAlreadyAttached",defaultMessage:"This file is already a part of your message."}}),Mf=({clientThreadId:n,rateLimitPopup:e,children:t,highlightTooltip:s=!1})=>{const i=Fe(),r=$l(n),o=On(),[a,l]=S.useState(s);S.useEffect(()=>{l(s)},[s]);const d=m=>{e!=null&&m&&ee.logPopoverHover({type:"rate_limit",location:"file_upload",plan_type:(o==null?void 0:o.planType)??"unknown"})},u=m=>{s||l(m)},p=!!e;return c.jsx(c.Fragment,{children:p?c.jsxs(xx,{delayDuration:150,onOpenChange:d,children:[c.jsx(bx,{children:t}),c.jsx(wx,{children:c.jsx(Ym,{$as:Sx,side:"top",sideOffset:4,className:"max-w-[260px]",children:c.jsx(uS,{isNewConversation:r,rateLimitPopup:e})})})]}):c.jsx(ti,{sideOffset:14,label:i.formatMessage({id:"oUK/GV",defaultMessage:"Attach file"}),className:"flex",open:a,onOpenChange:u,side:"top",children:t})})},uS=({isNewConversation:n=!1,rateLimitPopup:e})=>{const t=On(),s=Fi();if(e==null)return null;const{call_to_action:i,description:r}=e,o=r||c.jsx(U,{...rd.defaultDescription}),a=i==null?void 0:i.includes(kx.GET_PLUS);return c.jsxs("div",{className:"p-2 text-sm text-token-text-primary",children:[c.jsx("div",{children:o}),a?c.jsx(It,{size:"small",color:"secondary",className:"mt-3",onClick:()=>{Tl(s,"Rate limited file upload popover"),ee.logRateLimitGetPlusButtonClicked({type:"file_upload",location:"popover",plan_type:(t==null?void 0:t.planType)??"unknown",is_hard_block:!1,is_new_conversation:n,hard_block_reason:""})},children:c.jsx(U,{...rd.getPlus})}):null]})},rd=Ke({defaultDescription:{id:"U5qAWP",defaultMessage:"You've reached your daily upload limit. Get ChatGPT Plus to unlock more."},getPlus:{id:"TeyLcp",defaultMessage:"Get Plus"}});function hS({clientThreadId:n,getInputProps:e,openFileDialog:t,uploadType:s,icon:i,highlightTooltip:r=!1}){const o=Fe(),a=Vl(),l=!!a,d=c.jsx(sh,{className:"mb-1 ml-1.5",disabled:l,onClick:m=>{m.preventDefault(),ee.logEvent($.openFileViewer,{intent:s.toString()}),t()},"aria-label":o.formatMessage({id:"PromptFilePicker.attachFiles",defaultMessage:"Attach files"}),children:i}),u=c.jsx("input",{disabled:l,...e({className:"hidden"})}),p=c.jsxs("div",{className:"flex",children:[d,u]});return c.jsx(Mf,{clientThreadId:n,rateLimitPopup:a,highlightTooltip:r,children:p})}function fS({code:n,message:e}){switch(n){case Dc.FileTooLarge:return od.errorFileTooLarge;case Dc.TooManyFiles:return ee.logEvent($.uploadedMaxFilesError),od.errorTooManyFiles;default:return e}}const od=Ke({attachImages:{id:"PromptFilePicker.attachImages",defaultMessage:"Attach images"},attachFiles:{id:"PromptFilePicker.attachFiles",defaultMessage:"Attach files"},errorFileTooLarge:{id:"PromptFilePicker.errorFileTooLarge",defaultMessage:"Your file is too large. The maximum file size is {size}MB."},errorTooManyFiles:{id:"PromptFilePicker.errorTooManyFiles",defaultMessage:"You may only upload {maxNum} files at a time."},defaultFileUploadRateLimited:{id:"U5qAWP",defaultMessage:"You've reached your daily upload limit. Get ChatGPT Plus to unlock more."},getPlusButton:{id:"TeyLcp",defaultMessage:"Get Plus"}}),ad=Ke({dragInstructions:{id:"FileDropZone.dragInstructions",defaultMessage:"Add anything"},dragAllAccepted:{id:"FileDropZone.dragAllAccepted",defaultMessage:"Drop any file here to add it to the conversation"}});function pS(n){var N;const{className:e,children:t,clientThreadId:s,currentModelConfig:i}=n,r=Fe(),o=Ko(s),a=ho(i,o),l=a!==Qs.None,d=uo(E=>E.files),u=(a===Qs.Multimodal?El:_l)-d.length,p=u<=0,{getGizmoId:m}=Cr(),{handleFileAccepted:b}=Tf(r,ho(i,o),rh(i,o),"drag",m,(N=ih(i,o))==null?void 0:N.attachments),g=Vl(),y=oh(ah(i,o)),{getRootProps:C,isDragActive:M}=lh({maxFiles:u,disabled:!l||p||g!=null,noClick:!0,onDropAccepted:b,onDropRejected:E=>vf(E,r,a),multiple:!0,maxSize:ch,...y}),_=R();function R(){if(!y.accept||Object.keys(y.accept).length===0)return[];const E=[];return Object.values(y.accept).forEach(P=>E.push(...P)),E.sort()}return c.jsxs("div",{...C({className:e}),children:[t,M&&c.jsxs(mS,{children:[c.jsx(Qm,{}),c.jsx("h3",{children:c.jsx(U,{...ad.dragInstructions})}),c.jsx("h4",{className:"w-2/3 text-center",children:_.length>0?_.join(", "):c.jsx(U,{...ad.dragAllAccepted})})]})]})}function vf(n,e,t){const{errors:s}=n[0];s.forEach(i=>{const r=fS(i);typeof r=="string"?on.danger(r,{hasCloseButton:!0}):on.danger(e.formatMessage(r,{size:Xm,maxNum:t===Qs.Multimodal?El:_l}),{hasCloseButton:!0})})}function Tf(n,e,t,s,i,r){return{handleFileAccepted:S.useCallback(async(a,l)=>{ee.logEvent($.uploadFile,{client:"web",eventSource:s,intent:e.toString()});const d=i!=null?await i():void 0;a.length>0&&a.forEach(u=>{ms.uploadFile(eh(u),u,e,t,n,{gizmoId:d},r)})},[s,e,i,t,n,r])}}const mS=Xe.div`absolute inset-0 opacity-80 flex gap-2 flex-col justify-center items-center bg-token-main-surface-primary text-token-text-primary`;function ld({entry:n,onClick:e}){const{connectorConfig:t}=Nl();S.useEffect(()=>{if(!open||n.type!==zt.GDRIVE)return;const o=t.get(zt.GDRIVE),a=o==null?void 0:o.access_token;a&&Zm(a)},[t,n.type]);const s=dh(n.type),i=Fe(),r=n.access_token?cd.uploadFromMessage:cd.signinWithMessage;return c.jsx(Ae.Item,{onClick:e,icon:s,children:c.jsxs("div",{className:"flex flex-col",children:[c.jsx(U,{...r,values:{connectorName:Il(n.type,i)}}),n.type===zt.O365_BUSINESS&&c.jsx("div",{className:"text-s text-token-text-tertiary",children:c.jsx(U,{...Al.includesSharePoint})})]})},n.id)}const cd=Ke({signinWithMessage:{id:"ContextConnectorPickerDropdownItem.signInWithMessage",defaultMessage:"Connect to {connectorName}"},uploadFromMessage:{id:"ContextConnectorPickerDropdownItem.uploadWithMessage",defaultMessage:"Add from {connectorName}"}});function gS({clientThreadId:n,icon:e,setOpen:t,highlightTooltip:s=!1}){const i=Vl(),r=!!i,o=Fe();return c.jsxs(c.Fragment,{children:[c.jsx(Ae.Trigger,{className:"m-0 h-0 w-0 border-none bg-transparent p-0"}),c.jsx(Mf,{clientThreadId:n,rateLimitPopup:i,highlightTooltip:s,children:c.jsx(sh,{className:"mb-1 ml-1.5","aria-disabled":r,"aria-label":o.formatMessage({id:"tA7CXR",defaultMessage:"Attach files"}),onClick:a=>{a.preventDefault(),r||t(!0)},children:e})})]})}function yS({connectorEntries:n,onOauthRedirect:e}){const t=Fe();return c.jsxs(Ae.Sub,{children:[c.jsx(Ae.SubMenuTrigger,{icon:J0,children:c.jsx("div",{className:"line-clamp-1 text-ellipsis",children:c.jsx(U,{...xS.connectApps})})}),c.jsx(Ae.Portal,{children:c.jsx(Ae.SubContent,{children:n.map(s=>c.jsx(Ae.Item,{onClick:()=>e(s),icon:dh(s.type),children:c.jsxs("div",{className:"flex flex-col",children:[Il(s.type,t),s.type===zt.O365_BUSINESS&&c.jsx("div",{className:"text-s text-token-text-tertiary",children:c.jsx(U,{...Al.includesSharePoint})})]})},s.id))})})]})}const xS=Ke({connectApps:{id:"ContextConnectorPicker.connectApps",defaultMessage:"Connect apps"}});function bS({onOauthRedirect:n,connectors:e}){const t=Fe();return c.jsxs(Ae.Sub,{children:[c.jsx(Ae.SubMenuTrigger,{icon:Y0,children:c.jsx(U,{...wS.oneDriveSubmenuName})}),c.jsx(Ae.Portal,{children:c.jsx(Ae.SubContent,{children:e.map(s=>s?c.jsx(Ae.Item,{onClick:()=>n(s),children:c.jsxs("div",{className:"flex flex-col",children:[Il(s.type,t),s.type===zt.O365_BUSINESS&&c.jsx("div",{className:"text-s text-token-text-tertiary",children:c.jsx(U,{...Al.includesSharePoint})})]})},s.id):null)})})]})}const wS=Ke({oneDriveSubmenuName:{id:"ContextConnectorPickerOneDriveSubmenu.oneDriveSubmenuName",defaultMessage:"Connect to Microsoft OneDrive"}});function SS(){const{connectorConfig:n}=Nl(),e=Er(),[t,s]=fo(uh([...n.values()],d=>!!d.access_token),d=>!!d.access_token),[i,r]=fo(s,d=>d.type===zt.O365_PERSONAL||d.type===zt.O365_BUSINESS),o=!e&&t.length>0,a=!e&&!o&&i.length>1;return{unconnectedConnectors:a?r:s,showUnconnectedInSubmenu:o,showOneDriveInSubmenu:a}}function kS({clientThreadId:n,icon:e,modelAcceptedMimeTypes:t,modelSupportedImageMimeTypes:s,attachmentsProductFeature:i,onOauthRedirect:r,uploadType:o,getInputProps:a,openFileDialog:l,highlightTooltip:d=!1}){const{currentLocale:u}=Cx(),p=Fe(),m=Er(),{connectorConfig:b,isLoading:g}=Nl(),y=Oo(Po.ContextConnectors),{getGizmoId:C}=Cr(),[M,_]=S.useState();S.useEffect(()=>{C?C().then(L=>_(L)):_(void 0)},[C]);const R=S.useRef(null),[N,E]=S.useState(!1),P=S.useRef(!1),F=S.useCallback(()=>{var Me;const L=(Me=R.current)==null?void 0:Me.files;Array.from(L??[]).forEach(qe=>Fr.uploadFile(qe,s,p,i))},[s,i,p]),[D,A]=S.useState(null),G=S.useCallback(()=>A(null),[A]),W=S.useCallback((L,Me)=>Fr.uploadPickedFile(L,Me,s,t,i,M,p),[s,t,i,M,p]),{openMenu:j,confirmMenuOpened:z}=eg();S.useEffect(()=>{j&&(E(!0),z())},[j,z,E]);const H=Pi(),K=S.useCallback(L=>{Fr.doContextConnectorOauthRedirect(H.asPath,L,r,bo.Picker),r()},[r,H.asPath]),J=S.useCallback(L=>{Fr.uploadPickedFile(L,zt.GDRIVE,s,t,i,M,p)},[s,t,i,M,p]),de=S.useCallback(async L=>{const{access_token:Me}=L;if(!Me){K(L);return}switch(tg(L,bo.Picker),L.type){case zt.GDRIVE:ng(u,L.type,Me,qe=>qe.forEach(J));break;case zt.O365_PERSONAL:case zt.O365_BUSINESS:A(L.type);break}},[J,K,A,u]),V=()=>{ee.logEvent($.openFileViewer,{intent:o.toString()}),l()},B=L=>{if(!L&&P.current&&!g)V();else if(L&&ce&&!g){V();return}E(L),L&&(y.eligible&&y.markAsViewed(),ee.logEvent($.composerOpenContextConnectorPicker),P.current=!0,setTimeout(()=>{P.current=!1},250))},[we,te]=fo(uh([...b.values()],L=>!!L.access_token),L=>!!L.access_token);CS(we,de);const[ne]=fo(te,L=>L.type===zt.O365_PERSONAL||L.type===zt.O365_BUSINESS),{unconnectedConnectors:xe,showUnconnectedInSubmenu:Se,showOneDriveInSubmenu:ge}=SS(),ce=!we.length&&!xe.length,Ce=c.jsxs(c.Fragment,{children:[Se&&xe.length>0&&c.jsx(yS,{connectorEntries:xe,onOauthRedirect:L=>K(L)}),!Se&&xe.map(L=>c.jsx(ld,{entry:L,onClick:()=>de(L)},L.id)),ge&&c.jsx(bS,{connectors:ne,onOauthRedirect:K}),g&&c.jsx(Ae.Item,{icon:c.jsx(Gh,{className:"text-token-text-secondary"})}),(xe.length>0||g)&&c.jsx(Ae.Separator,{}),we.map(L=>c.jsx(ld,{entry:L,onClick:()=>de(L)},L.id)),c.jsx(Ae.Item,{onClick:V,icon:gf,children:c.jsx(U,{...m?dd.uploadFileMobile:dd.uploadFile})},"upload")]}),ye=c.jsxs("div",{className:"flex flex-col",children:[c.jsx(sg,{type:D,onClose:G,uploadPickedFile:W}),c.jsx("input",{onChange:F,...a({className:"hidden"})}),c.jsxs(Ae.Root,{open:N,onOpenChange:B,children:[c.jsx(gS,{clientThreadId:n,icon:e,setOpen:B,highlightTooltip:d}),c.jsx(Ae.Portal,{children:c.jsx(Ae.Content,{size:"large",children:Ce})})]}),c.jsx(ig,{hasConnectors:!g&&!ce})]});return{dropdownItems:Ce,mainComponent:ye}}function CS(n,e){const{connector:t,clearParam:s}=rg(),i=n.find(r=>r.type===t&&!!r.access_token);S.useEffect(()=>{i&&(e(i),s())},[i,e,s])}function MS(n){const{mainComponent:e}=kS(n);return e}const dd=Ke({attachFiles:{id:"ContextConnectorPicker.attachFiles",defaultMessage:"Attach files"},uploadFile:{id:"LocalFileDropdownItem.uploadFile",defaultMessage:"Upload from computer"},uploadFileMobile:{id:"LocalFileDropdownItem.uploadFileMobile",defaultMessage:"Upload file"}});function vS({clientThreadId:n,uploadType:e,modelAcceptedMimeTypes:t,modelSupportedImageMimeTypes:s,attachmentsProductFeature:i,getInputProps:r,openFileDialog:o,onOauthRedirect:a,historyDisabled:l,className:d,highlightTooltip:u}){const{gdriveStatus:p,o365Status:m}=og(),b=c.jsx(Q0,{className:l?"text-white":u?"text-brand-blue-800":void 0});return c.jsxs("div",{className:se("relative",d),children:[p!=="false"||m!=="false"?c.jsx(MS,{clientThreadId:n,icon:b,modelAcceptedMimeTypes:t,modelSupportedImageMimeTypes:s,attachmentsProductFeature:i,onOauthRedirect:a,uploadType:e,openFileDialog:o,getInputProps:r,highlightTooltip:u}):c.jsx(hS,{clientThreadId:n,uploadType:e,openFileDialog:o,getInputProps:r,icon:b,highlightTooltip:u}),u&&c.jsx(ft.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:260,damping:20},className:"pointer-events-none absolute bottom-1 left-1.5 h-8 w-8 rounded-full bg-brand-blue-800/20"})]})}function Ef(n,e,t){for(let s=0;;s++){if(s==n.childCount||s==e.childCount)return n.childCount==e.childCount?null:t;let i=n.child(s),r=e.child(s);if(i==r){t+=i.nodeSize;continue}if(!i.sameMarkup(r))return t;if(i.isText&&i.text!=r.text){for(let o=0;i.text[o]==r.text[o];o++)t++;return t}if(i.content.size||r.content.size){let o=Ef(i.content,r.content,t+1);if(o!=null)return o}t+=i.nodeSize}}function _f(n,e,t,s){for(let i=n.childCount,r=e.childCount;;){if(i==0||r==0)return i==r?null:{a:t,b:s};let o=n.child(--i),a=e.child(--r),l=o.nodeSize;if(o==a){t-=l,s-=l;continue}if(!o.sameMarkup(a))return{a:t,b:s};if(o.isText&&o.text!=a.text){let d=0,u=Math.min(o.text.length,a.text.length);for(;d<u&&o.text[o.text.length-d-1]==a.text[a.text.length-d-1];)d++,t--,s--;return{a:t,b:s}}if(o.content.size||a.content.size){let d=_f(o.content,a.content,t-1,s-1);if(d)return d}t-=l,s-=l}}class q{constructor(e,t){if(this.content=e,this.size=t||0,t==null)for(let s=0;s<e.length;s++)this.size+=e[s].nodeSize}nodesBetween(e,t,s,i=0,r){for(let o=0,a=0;a<t;o++){let l=this.content[o],d=a+l.nodeSize;if(d>e&&s(l,i+a,r||null,o)!==!1&&l.content.size){let u=a+1;l.nodesBetween(Math.max(0,e-u),Math.min(l.content.size,t-u),s,i+u)}a=d}}descendants(e){this.nodesBetween(0,this.size,e)}textBetween(e,t,s,i){let r="",o=!0;return this.nodesBetween(e,t,(a,l)=>{let d=a.isText?a.text.slice(Math.max(e,l)-l,t-l):a.isLeaf?i?typeof i=="function"?i(a):i:a.type.spec.leafText?a.type.spec.leafText(a):"":"";a.isBlock&&(a.isLeaf&&d||a.isTextblock)&&s&&(o?o=!1:r+=s),r+=d},0),r}append(e){if(!e.size)return this;if(!this.size)return e;let t=this.lastChild,s=e.firstChild,i=this.content.slice(),r=0;for(t.isText&&t.sameMarkup(s)&&(i[i.length-1]=t.withText(t.text+s.text),r=1);r<e.content.length;r++)i.push(e.content[r]);return new q(i,this.size+e.size)}cut(e,t=this.size){if(e==0&&t==this.size)return this;let s=[],i=0;if(t>e)for(let r=0,o=0;o<t;r++){let a=this.content[r],l=o+a.nodeSize;l>e&&((o<e||l>t)&&(a.isText?a=a.cut(Math.max(0,e-o),Math.min(a.text.length,t-o)):a=a.cut(Math.max(0,e-o-1),Math.min(a.content.size,t-o-1))),s.push(a),i+=a.nodeSize),o=l}return new q(s,i)}cutByIndex(e,t){return e==t?q.empty:e==0&&t==this.content.length?this:new q(this.content.slice(e,t))}replaceChild(e,t){let s=this.content[e];if(s==t)return this;let i=this.content.slice(),r=this.size+t.nodeSize-s.nodeSize;return i[e]=t,new q(i,r)}addToStart(e){return new q([e].concat(this.content),this.size+e.nodeSize)}addToEnd(e){return new q(this.content.concat(e),this.size+e.nodeSize)}eq(e){if(this.content.length!=e.content.length)return!1;for(let t=0;t<this.content.length;t++)if(!this.content[t].eq(e.content[t]))return!1;return!0}get firstChild(){return this.content.length?this.content[0]:null}get lastChild(){return this.content.length?this.content[this.content.length-1]:null}get childCount(){return this.content.length}child(e){let t=this.content[e];if(!t)throw new RangeError("Index "+e+" out of range for "+this);return t}maybeChild(e){return this.content[e]||null}forEach(e){for(let t=0,s=0;t<this.content.length;t++){let i=this.content[t];e(i,s,t),s+=i.nodeSize}}findDiffStart(e,t=0){return Ef(this,e,t)}findDiffEnd(e,t=this.size,s=e.size){return _f(this,e,t,s)}findIndex(e,t=-1){if(e==0)return Ur(0,e);if(e==this.size)return Ur(this.content.length,e);if(e>this.size||e<0)throw new RangeError(`Position ${e} outside of fragment (${this})`);for(let s=0,i=0;;s++){let r=this.child(s),o=i+r.nodeSize;if(o>=e)return o==e||t>0?Ur(s+1,o):Ur(s,i);i=o}}toString(){return"<"+this.toStringInner()+">"}toStringInner(){return this.content.join(", ")}toJSON(){return this.content.length?this.content.map(e=>e.toJSON()):null}static fromJSON(e,t){if(!t)return q.empty;if(!Array.isArray(t))throw new RangeError("Invalid input for Fragment.fromJSON");return new q(t.map(e.nodeFromJSON))}static fromArray(e){if(!e.length)return q.empty;let t,s=0;for(let i=0;i<e.length;i++){let r=e[i];s+=r.nodeSize,i&&r.isText&&e[i-1].sameMarkup(r)?(t||(t=e.slice(0,i)),t[t.length-1]=r.withText(t[t.length-1].text+r.text)):t&&t.push(r)}return new q(t||e,s)}static from(e){if(!e)return q.empty;if(e instanceof q)return e;if(Array.isArray(e))return this.fromArray(e);if(e.attrs)return new q([e],e.nodeSize);throw new RangeError("Can not convert "+e+" to a Fragment"+(e.nodesBetween?" (looks like multiple versions of prosemirror-model were loaded)":""))}}q.empty=new q([],0);const ua={index:0,offset:0};function Ur(n,e){return ua.index=n,ua.offset=e,ua}function ko(n,e){if(n===e)return!0;if(!(n&&typeof n=="object")||!(e&&typeof e=="object"))return!1;let t=Array.isArray(n);if(Array.isArray(e)!=t)return!1;if(t){if(n.length!=e.length)return!1;for(let s=0;s<n.length;s++)if(!ko(n[s],e[s]))return!1}else{for(let s in n)if(!(s in e)||!ko(n[s],e[s]))return!1;for(let s in e)if(!(s in n))return!1}return!0}class Pe{constructor(e,t){this.type=e,this.attrs=t}addToSet(e){let t,s=!1;for(let i=0;i<e.length;i++){let r=e[i];if(this.eq(r))return e;if(this.type.excludes(r.type))t||(t=e.slice(0,i));else{if(r.type.excludes(this.type))return e;!s&&r.type.rank>this.type.rank&&(t||(t=e.slice(0,i)),t.push(this),s=!0),t&&t.push(r)}}return t||(t=e.slice()),s||t.push(this),t}removeFromSet(e){for(let t=0;t<e.length;t++)if(this.eq(e[t]))return e.slice(0,t).concat(e.slice(t+1));return e}isInSet(e){for(let t=0;t<e.length;t++)if(this.eq(e[t]))return!0;return!1}eq(e){return this==e||this.type==e.type&&ko(this.attrs,e.attrs)}toJSON(){let e={type:this.type.name};for(let t in this.attrs){e.attrs=this.attrs;break}return e}static fromJSON(e,t){if(!t)throw new RangeError("Invalid input for Mark.fromJSON");let s=e.marks[t.type];if(!s)throw new RangeError(`There is no mark type ${t.type} in this schema`);let i=s.create(t.attrs);return s.checkAttrs(i.attrs),i}static sameSet(e,t){if(e==t)return!0;if(e.length!=t.length)return!1;for(let s=0;s<e.length;s++)if(!e[s].eq(t[s]))return!1;return!0}static setFrom(e){if(!e||Array.isArray(e)&&e.length==0)return Pe.none;if(e instanceof Pe)return[e];let t=e.slice();return t.sort((s,i)=>s.type.rank-i.type.rank),t}}Pe.none=[];class Co extends Error{}class X{constructor(e,t,s){this.content=e,this.openStart=t,this.openEnd=s}get size(){return this.content.size-this.openStart-this.openEnd}insertAt(e,t){let s=If(this.content,e+this.openStart,t);return s&&new X(s,this.openStart,this.openEnd)}removeBetween(e,t){return new X(Nf(this.content,e+this.openStart,t+this.openStart),this.openStart,this.openEnd)}eq(e){return this.content.eq(e.content)&&this.openStart==e.openStart&&this.openEnd==e.openEnd}toString(){return this.content+"("+this.openStart+","+this.openEnd+")"}toJSON(){if(!this.content.size)return null;let e={content:this.content.toJSON()};return this.openStart>0&&(e.openStart=this.openStart),this.openEnd>0&&(e.openEnd=this.openEnd),e}static fromJSON(e,t){if(!t)return X.empty;let s=t.openStart||0,i=t.openEnd||0;if(typeof s!="number"||typeof i!="number")throw new RangeError("Invalid input for Slice.fromJSON");return new X(q.fromJSON(e,t.content),s,i)}static maxOpen(e,t=!0){let s=0,i=0;for(let r=e.firstChild;r&&!r.isLeaf&&(t||!r.type.spec.isolating);r=r.firstChild)s++;for(let r=e.lastChild;r&&!r.isLeaf&&(t||!r.type.spec.isolating);r=r.lastChild)i++;return new X(e,s,i)}}X.empty=new X(q.empty,0,0);function Nf(n,e,t){let{index:s,offset:i}=n.findIndex(e),r=n.maybeChild(s),{index:o,offset:a}=n.findIndex(t);if(i==e||r.isText){if(a!=t&&!n.child(o).isText)throw new RangeError("Removing non-flat range");return n.cut(0,e).append(n.cut(t))}if(s!=o)throw new RangeError("Removing non-flat range");return n.replaceChild(s,r.copy(Nf(r.content,e-i-1,t-i-1)))}function If(n,e,t,s){let{index:i,offset:r}=n.findIndex(e),o=n.maybeChild(i);if(r==e||o.isText)return n.cut(0,e).append(t).append(n.cut(e));let a=If(o.content,e-r-1,t);return a&&n.replaceChild(i,o.copy(a))}function TS(n,e,t){if(t.openStart>n.depth)throw new Co("Inserted content deeper than insertion position");if(n.depth-t.openStart!=e.depth-t.openEnd)throw new Co("Inconsistent open depths");return Af(n,e,t,0)}function Af(n,e,t,s){let i=n.index(s),r=n.node(s);if(i==e.index(s)&&s<n.depth-t.openStart){let o=Af(n,e,t,s+1);return r.copy(r.content.replaceChild(i,o))}else if(t.content.size)if(!t.openStart&&!t.openEnd&&n.depth==s&&e.depth==s){let o=n.parent,a=o.content;return Hs(o,a.cut(0,n.parentOffset).append(t.content).append(a.cut(e.parentOffset)))}else{let{start:o,end:a}=ES(t,n);return Hs(r,Df(n,o,a,e,s))}else return Hs(r,Mo(n,e,s))}function Rf(n,e){if(!e.type.compatibleContent(n.type))throw new Co("Cannot join "+e.type.name+" onto "+n.type.name)}function Ka(n,e,t){let s=n.node(t);return Rf(s,e.node(t)),s}function qs(n,e){let t=e.length-1;t>=0&&n.isText&&n.sameMarkup(e[t])?e[t]=n.withText(e[t].text+n.text):e.push(n)}function sr(n,e,t,s){let i=(e||n).node(t),r=0,o=e?e.index(t):i.childCount;n&&(r=n.index(t),n.depth>t?r++:n.textOffset&&(qs(n.nodeAfter,s),r++));for(let a=r;a<o;a++)qs(i.child(a),s);e&&e.depth==t&&e.textOffset&&qs(e.nodeBefore,s)}function Hs(n,e){return n.type.checkContent(e),n.copy(e)}function Df(n,e,t,s,i){let r=n.depth>i&&Ka(n,e,i+1),o=s.depth>i&&Ka(t,s,i+1),a=[];return sr(null,n,i,a),r&&o&&e.index(i)==t.index(i)?(Rf(r,o),qs(Hs(r,Df(n,e,t,s,i+1)),a)):(r&&qs(Hs(r,Mo(n,e,i+1)),a),sr(e,t,i,a),o&&qs(Hs(o,Mo(t,s,i+1)),a)),sr(s,null,i,a),new q(a)}function Mo(n,e,t){let s=[];if(sr(null,n,t,s),n.depth>t){let i=Ka(n,e,t+1);qs(Hs(i,Mo(n,e,t+1)),s)}return sr(e,null,t,s),new q(s)}function ES(n,e){let t=e.depth-n.openStart,i=e.node(t).copy(n.content);for(let r=t-1;r>=0;r--)i=e.node(r).copy(q.from(i));return{start:i.resolveNoCache(n.openStart+t),end:i.resolveNoCache(i.content.size-n.openEnd-t)}}class fr{constructor(e,t,s){this.pos=e,this.path=t,this.parentOffset=s,this.depth=t.length/3-1}resolveDepth(e){return e==null?this.depth:e<0?this.depth+e:e}get parent(){return this.node(this.depth)}get doc(){return this.node(0)}node(e){return this.path[this.resolveDepth(e)*3]}index(e){return this.path[this.resolveDepth(e)*3+1]}indexAfter(e){return e=this.resolveDepth(e),this.index(e)+(e==this.depth&&!this.textOffset?0:1)}start(e){return e=this.resolveDepth(e),e==0?0:this.path[e*3-1]+1}end(e){return e=this.resolveDepth(e),this.start(e)+this.node(e).content.size}before(e){if(e=this.resolveDepth(e),!e)throw new RangeError("There is no position before the top-level node");return e==this.depth+1?this.pos:this.path[e*3-1]}after(e){if(e=this.resolveDepth(e),!e)throw new RangeError("There is no position after the top-level node");return e==this.depth+1?this.pos:this.path[e*3-1]+this.path[e*3].nodeSize}get textOffset(){return this.pos-this.path[this.path.length-1]}get nodeAfter(){let e=this.parent,t=this.index(this.depth);if(t==e.childCount)return null;let s=this.pos-this.path[this.path.length-1],i=e.child(t);return s?e.child(t).cut(s):i}get nodeBefore(){let e=this.index(this.depth),t=this.pos-this.path[this.path.length-1];return t?this.parent.child(e).cut(0,t):e==0?null:this.parent.child(e-1)}posAtIndex(e,t){t=this.resolveDepth(t);let s=this.path[t*3],i=t==0?0:this.path[t*3-1]+1;for(let r=0;r<e;r++)i+=s.child(r).nodeSize;return i}marks(){let e=this.parent,t=this.index();if(e.content.size==0)return Pe.none;if(this.textOffset)return e.child(t).marks;let s=e.maybeChild(t-1),i=e.maybeChild(t);if(!s){let a=s;s=i,i=a}let r=s.marks;for(var o=0;o<r.length;o++)r[o].type.spec.inclusive===!1&&(!i||!r[o].isInSet(i.marks))&&(r=r[o--].removeFromSet(r));return r}marksAcross(e){let t=this.parent.maybeChild(this.index());if(!t||!t.isInline)return null;let s=t.marks,i=e.parent.maybeChild(e.index());for(var r=0;r<s.length;r++)s[r].type.spec.inclusive===!1&&(!i||!s[r].isInSet(i.marks))&&(s=s[r--].removeFromSet(s));return s}sharedDepth(e){for(let t=this.depth;t>0;t--)if(this.start(t)<=e&&this.end(t)>=e)return t;return 0}blockRange(e=this,t){if(e.pos<this.pos)return e.blockRange(this);for(let s=this.depth-(this.parent.inlineContent||this.pos==e.pos?1:0);s>=0;s--)if(e.pos<=this.end(s)&&(!t||t(this.node(s))))return new IS(this,e,s);return null}sameParent(e){return this.pos-this.parentOffset==e.pos-e.parentOffset}max(e){return e.pos>this.pos?e:this}min(e){return e.pos<this.pos?e:this}toString(){let e="";for(let t=1;t<=this.depth;t++)e+=(e?"/":"")+this.node(t).type.name+"_"+this.index(t-1);return e+":"+this.parentOffset}static resolve(e,t){if(!(t>=0&&t<=e.content.size))throw new RangeError("Position "+t+" out of range");let s=[],i=0,r=t;for(let o=e;;){let{index:a,offset:l}=o.content.findIndex(r),d=r-l;if(s.push(o,a,i+l),!d||(o=o.child(a),o.isText))break;r=d-1,i+=l+1}return new fr(t,s,r)}static resolveCached(e,t){let s=ud.get(e);if(s)for(let r=0;r<s.elts.length;r++){let o=s.elts[r];if(o.pos==t)return o}else ud.set(e,s=new _S);let i=s.elts[s.i]=fr.resolve(e,t);return s.i=(s.i+1)%NS,i}}class _S{constructor(){this.elts=[],this.i=0}}const NS=12,ud=new WeakMap;class IS{constructor(e,t,s){this.$from=e,this.$to=t,this.depth=s}get start(){return this.$from.before(this.depth+1)}get end(){return this.$to.after(this.depth+1)}get parent(){return this.$from.node(this.depth)}get startIndex(){return this.$from.index(this.depth)}get endIndex(){return this.$to.indexAfter(this.depth)}}const AS=Object.create(null);class An{constructor(e,t,s,i=Pe.none){this.type=e,this.attrs=t,this.marks=i,this.content=s||q.empty}get nodeSize(){return this.isLeaf?1:2+this.content.size}get childCount(){return this.content.childCount}child(e){return this.content.child(e)}maybeChild(e){return this.content.maybeChild(e)}forEach(e){this.content.forEach(e)}nodesBetween(e,t,s,i=0){this.content.nodesBetween(e,t,s,i,this)}descendants(e){this.nodesBetween(0,this.content.size,e)}get textContent(){return this.isLeaf&&this.type.spec.leafText?this.type.spec.leafText(this):this.textBetween(0,this.content.size,"")}textBetween(e,t,s,i){return this.content.textBetween(e,t,s,i)}get firstChild(){return this.content.firstChild}get lastChild(){return this.content.lastChild}eq(e){return this==e||this.sameMarkup(e)&&this.content.eq(e.content)}sameMarkup(e){return this.hasMarkup(e.type,e.attrs,e.marks)}hasMarkup(e,t,s){return this.type==e&&ko(this.attrs,t||e.defaultAttrs||AS)&&Pe.sameSet(this.marks,s||Pe.none)}copy(e=null){return e==this.content?this:new An(this.type,this.attrs,e,this.marks)}mark(e){return e==this.marks?this:new An(this.type,this.attrs,this.content,e)}cut(e,t=this.content.size){return e==0&&t==this.content.size?this:this.copy(this.content.cut(e,t))}slice(e,t=this.content.size,s=!1){if(e==t)return X.empty;let i=this.resolve(e),r=this.resolve(t),o=s?0:i.sharedDepth(t),a=i.start(o),d=i.node(o).content.cut(i.pos-a,r.pos-a);return new X(d,i.depth-o,r.depth-o)}replace(e,t,s){return TS(this.resolve(e),this.resolve(t),s)}nodeAt(e){for(let t=this;;){let{index:s,offset:i}=t.content.findIndex(e);if(t=t.maybeChild(s),!t)return null;if(i==e||t.isText)return t;e-=i+1}}childAfter(e){let{index:t,offset:s}=this.content.findIndex(e);return{node:this.content.maybeChild(t),index:t,offset:s}}childBefore(e){if(e==0)return{node:null,index:0,offset:0};let{index:t,offset:s}=this.content.findIndex(e);if(s<e)return{node:this.content.child(t),index:t,offset:s};let i=this.content.child(t-1);return{node:i,index:t-1,offset:s-i.nodeSize}}resolve(e){return fr.resolveCached(this,e)}resolveNoCache(e){return fr.resolve(this,e)}rangeHasMark(e,t,s){let i=!1;return t>e&&this.nodesBetween(e,t,r=>(s.isInSet(r.marks)&&(i=!0),!i)),i}get isBlock(){return this.type.isBlock}get isTextblock(){return this.type.isTextblock}get inlineContent(){return this.type.inlineContent}get isInline(){return this.type.isInline}get isText(){return this.type.isText}get isLeaf(){return this.type.isLeaf}get isAtom(){return this.type.isAtom}toString(){if(this.type.spec.toDebugString)return this.type.spec.toDebugString(this);let e=this.type.name;return this.content.size&&(e+="("+this.content.toStringInner()+")"),jf(this.marks,e)}contentMatchAt(e){let t=this.type.contentMatch.matchFragment(this.content,0,e);if(!t)throw new Error("Called contentMatchAt on a node with invalid content");return t}canReplace(e,t,s=q.empty,i=0,r=s.childCount){let o=this.contentMatchAt(e).matchFragment(s,i,r),a=o&&o.matchFragment(this.content,t);if(!a||!a.validEnd)return!1;for(let l=i;l<r;l++)if(!this.type.allowsMarks(s.child(l).marks))return!1;return!0}canReplaceWith(e,t,s,i){if(i&&!this.type.allowsMarks(i))return!1;let r=this.contentMatchAt(e).matchType(s),o=r&&r.matchFragment(this.content,t);return o?o.validEnd:!1}canAppend(e){return e.content.size?this.canReplace(this.childCount,this.childCount,e.content):this.type.compatibleContent(e.type)}check(){this.type.checkContent(this.content),this.type.checkAttrs(this.attrs);let e=Pe.none;for(let t=0;t<this.marks.length;t++){let s=this.marks[t];s.type.checkAttrs(s.attrs),e=s.addToSet(e)}if(!Pe.sameSet(e,this.marks))throw new RangeError(`Invalid collection of marks for node ${this.type.name}: ${this.marks.map(t=>t.type.name)}`);this.content.forEach(t=>t.check())}toJSON(){let e={type:this.type.name};for(let t in this.attrs){e.attrs=this.attrs;break}return this.content.size&&(e.content=this.content.toJSON()),this.marks.length&&(e.marks=this.marks.map(t=>t.toJSON())),e}static fromJSON(e,t){if(!t)throw new RangeError("Invalid input for Node.fromJSON");let s;if(t.marks){if(!Array.isArray(t.marks))throw new RangeError("Invalid mark data for Node.fromJSON");s=t.marks.map(e.markFromJSON)}if(t.type=="text"){if(typeof t.text!="string")throw new RangeError("Invalid text node in JSON");return e.text(t.text,s)}let i=q.fromJSON(e,t.content),r=e.nodeType(t.type).create(t.attrs,i,s);return r.type.checkAttrs(r.attrs),r}}An.prototype.text=void 0;class vo extends An{constructor(e,t,s,i){if(super(e,t,null,i),!s)throw new RangeError("Empty text nodes are not allowed");this.text=s}toString(){return this.type.spec.toDebugString?this.type.spec.toDebugString(this):jf(this.marks,JSON.stringify(this.text))}get textContent(){return this.text}textBetween(e,t){return this.text.slice(e,t)}get nodeSize(){return this.text.length}mark(e){return e==this.marks?this:new vo(this.type,this.attrs,this.text,e)}withText(e){return e==this.text?this:new vo(this.type,this.attrs,e,this.marks)}cut(e=0,t=this.text.length){return e==0&&t==this.text.length?this:this.withText(this.text.slice(e,t))}eq(e){return this.sameMarkup(e)&&this.text==e.text}toJSON(){let e=super.toJSON();return e.text=this.text,e}}function jf(n,e){for(let t=n.length-1;t>=0;t--)e=n[t].type.name+"("+e+")";return e}class Xs{constructor(e){this.validEnd=e,this.next=[],this.wrapCache=[]}static parse(e,t){let s=new RS(e,t);if(s.next==null)return Xs.empty;let i=Of(s);s.next&&s.err("Unexpected trailing text");let r=LS(BS(i));return zS(r,s),r}matchType(e){for(let t=0;t<this.next.length;t++)if(this.next[t].type==e)return this.next[t].next;return null}matchFragment(e,t=0,s=e.childCount){let i=this;for(let r=t;i&&r<s;r++)i=i.matchType(e.child(r).type);return i}get inlineContent(){return this.next.length!=0&&this.next[0].type.isInline}get defaultType(){for(let e=0;e<this.next.length;e++){let{type:t}=this.next[e];if(!(t.isText||t.hasRequiredAttrs()))return t}return null}compatible(e){for(let t=0;t<this.next.length;t++)for(let s=0;s<e.next.length;s++)if(this.next[t].type==e.next[s].type)return!0;return!1}fillBefore(e,t=!1,s=0){let i=[this];function r(o,a){let l=o.matchFragment(e,s);if(l&&(!t||l.validEnd))return q.from(a.map(d=>d.createAndFill()));for(let d=0;d<o.next.length;d++){let{type:u,next:p}=o.next[d];if(!(u.isText||u.hasRequiredAttrs())&&i.indexOf(p)==-1){i.push(p);let m=r(p,a.concat(u));if(m)return m}}return null}return r(this,[])}findWrapping(e){for(let s=0;s<this.wrapCache.length;s+=2)if(this.wrapCache[s]==e)return this.wrapCache[s+1];let t=this.computeWrapping(e);return this.wrapCache.push(e,t),t}computeWrapping(e){let t=Object.create(null),s=[{match:this,type:null,via:null}];for(;s.length;){let i=s.shift(),r=i.match;if(r.matchType(e)){let o=[];for(let a=i;a.type;a=a.via)o.push(a.type);return o.reverse()}for(let o=0;o<r.next.length;o++){let{type:a,next:l}=r.next[o];!a.isLeaf&&!a.hasRequiredAttrs()&&!(a.name in t)&&(!i.type||l.validEnd)&&(s.push({match:a.contentMatch,type:a,via:i}),t[a.name]=!0)}}return null}get edgeCount(){return this.next.length}edge(e){if(e>=this.next.length)throw new RangeError(`There's no ${e}th edge in this content match`);return this.next[e]}toString(){let e=[];function t(s){e.push(s);for(let i=0;i<s.next.length;i++)e.indexOf(s.next[i].next)==-1&&t(s.next[i].next)}return t(this),e.map((s,i)=>{let r=i+(s.validEnd?"*":" ")+" ";for(let o=0;o<s.next.length;o++)r+=(o?", ":"")+s.next[o].type.name+"->"+e.indexOf(s.next[o].next);return r}).join(`
`)}}Xs.empty=new Xs(!0);class RS{constructor(e,t){this.string=e,this.nodeTypes=t,this.inline=null,this.pos=0,this.tokens=e.split(/\s*(?=\b|\W|$)/),this.tokens[this.tokens.length-1]==""&&this.tokens.pop(),this.tokens[0]==""&&this.tokens.shift()}get next(){return this.tokens[this.pos]}eat(e){return this.next==e&&(this.pos++||!0)}err(e){throw new SyntaxError(e+" (in content expression '"+this.string+"')")}}function Of(n){let e=[];do e.push(DS(n));while(n.eat("|"));return e.length==1?e[0]:{type:"choice",exprs:e}}function DS(n){let e=[];do e.push(jS(n));while(n.next&&n.next!=")"&&n.next!="|");return e.length==1?e[0]:{type:"seq",exprs:e}}function jS(n){let e=FS(n);for(;;)if(n.eat("+"))e={type:"plus",expr:e};else if(n.eat("*"))e={type:"star",expr:e};else if(n.eat("?"))e={type:"opt",expr:e};else if(n.eat("{"))e=OS(n,e);else break;return e}function hd(n){/\D/.test(n.next)&&n.err("Expected number, got '"+n.next+"'");let e=Number(n.next);return n.pos++,e}function OS(n,e){let t=hd(n),s=t;return n.eat(",")&&(n.next!="}"?s=hd(n):s=-1),n.eat("}")||n.err("Unclosed braced range"),{type:"range",min:t,max:s,expr:e}}function PS(n,e){let t=n.nodeTypes,s=t[e];if(s)return[s];let i=[];for(let r in t){let o=t[r];o.groups.indexOf(e)>-1&&i.push(o)}return i.length==0&&n.err("No node type or group '"+e+"' found"),i}function FS(n){if(n.eat("(")){let e=Of(n);return n.eat(")")||n.err("Missing closing paren"),e}else if(/\W/.test(n.next))n.err("Unexpected token '"+n.next+"'");else{let e=PS(n,n.next).map(t=>(n.inline==null?n.inline=t.isInline:n.inline!=t.isInline&&n.err("Mixing inline and block content"),{type:"name",value:t}));return n.pos++,e.length==1?e[0]:{type:"choice",exprs:e}}}function BS(n){let e=[[]];return i(r(n,0),t()),e;function t(){return e.push([])-1}function s(o,a,l){let d={term:l,to:a};return e[o].push(d),d}function i(o,a){o.forEach(l=>l.to=a)}function r(o,a){if(o.type=="choice")return o.exprs.reduce((l,d)=>l.concat(r(d,a)),[]);if(o.type=="seq")for(let l=0;;l++){let d=r(o.exprs[l],a);if(l==o.exprs.length-1)return d;i(d,a=t())}else if(o.type=="star"){let l=t();return s(a,l),i(r(o.expr,l),l),[s(l)]}else if(o.type=="plus"){let l=t();return i(r(o.expr,a),l),i(r(o.expr,l),l),[s(l)]}else{if(o.type=="opt")return[s(a)].concat(r(o.expr,a));if(o.type=="range"){let l=a;for(let d=0;d<o.min;d++){let u=t();i(r(o.expr,l),u),l=u}if(o.max==-1)i(r(o.expr,l),l);else for(let d=o.min;d<o.max;d++){let u=t();s(l,u),i(r(o.expr,l),u),l=u}return[s(l)]}else{if(o.type=="name")return[s(a,void 0,o.value)];throw new Error("Unknown expr type")}}}}function Pf(n,e){return e-n}function fd(n,e){let t=[];return s(e),t.sort(Pf);function s(i){let r=n[i];if(r.length==1&&!r[0].term)return s(r[0].to);t.push(i);for(let o=0;o<r.length;o++){let{term:a,to:l}=r[o];!a&&t.indexOf(l)==-1&&s(l)}}}function LS(n){let e=Object.create(null);return t(fd(n,0));function t(s){let i=[];s.forEach(o=>{n[o].forEach(({term:a,to:l})=>{if(!a)return;let d;for(let u=0;u<i.length;u++)i[u][0]==a&&(d=i[u][1]);fd(n,l).forEach(u=>{d||i.push([a,d=[]]),d.indexOf(u)==-1&&d.push(u)})})});let r=e[s.join(",")]=new Xs(s.indexOf(n.length-1)>-1);for(let o=0;o<i.length;o++){let a=i[o][1].sort(Pf);r.next.push({type:i[o][0],next:e[a.join(",")]||t(a)})}return r}}function zS(n,e){for(let t=0,s=[n];t<s.length;t++){let i=s[t],r=!i.validEnd,o=[];for(let a=0;a<i.next.length;a++){let{type:l,next:d}=i.next[a];o.push(l.name),r&&!(l.isText||l.hasRequiredAttrs())&&(r=!1),s.indexOf(d)==-1&&s.push(d)}r&&e.err("Only non-generatable nodes ("+o.join(", ")+") in a required position (see https://prosemirror.net/docs/guide/#generatable)")}}function Ff(n){let e=Object.create(null);for(let t in n){let s=n[t];if(!s.hasDefault)return null;e[t]=s.default}return e}function Bf(n,e){let t=Object.create(null);for(let s in n){let i=e&&e[s];if(i===void 0){let r=n[s];if(r.hasDefault)i=r.default;else throw new RangeError("No value supplied for attribute "+s)}t[s]=i}return t}function Lf(n,e,t,s){for(let i in e)if(!(i in n))throw new RangeError(`Unsupported attribute ${i} for ${t} of type ${i}`);for(let i in n){let r=n[i];r.validate&&r.validate(e[i])}}function zf(n,e){let t=Object.create(null);if(e)for(let s in e)t[s]=new VS(n,s,e[s]);return t}let pd=class Uf{constructor(e,t,s){this.name=e,this.schema=t,this.spec=s,this.markSet=null,this.groups=s.group?s.group.split(" "):[],this.attrs=zf(e,s.attrs),this.defaultAttrs=Ff(this.attrs),this.contentMatch=null,this.inlineContent=null,this.isBlock=!(s.inline||e=="text"),this.isText=e=="text"}get isInline(){return!this.isBlock}get isTextblock(){return this.isBlock&&this.inlineContent}get isLeaf(){return this.contentMatch==Xs.empty}get isAtom(){return this.isLeaf||!!this.spec.atom}get whitespace(){return this.spec.whitespace||(this.spec.code?"pre":"normal")}hasRequiredAttrs(){for(let e in this.attrs)if(this.attrs[e].isRequired)return!0;return!1}compatibleContent(e){return this==e||this.contentMatch.compatible(e.contentMatch)}computeAttrs(e){return!e&&this.defaultAttrs?this.defaultAttrs:Bf(this.attrs,e)}create(e=null,t,s){if(this.isText)throw new Error("NodeType.create can't construct text nodes");return new An(this,this.computeAttrs(e),q.from(t),Pe.setFrom(s))}createChecked(e=null,t,s){return t=q.from(t),this.checkContent(t),new An(this,this.computeAttrs(e),t,Pe.setFrom(s))}createAndFill(e=null,t,s){if(e=this.computeAttrs(e),t=q.from(t),t.size){let o=this.contentMatch.fillBefore(t);if(!o)return null;t=o.append(t)}let i=this.contentMatch.matchFragment(t),r=i&&i.fillBefore(q.empty,!0);return r?new An(this,e,t.append(r),Pe.setFrom(s)):null}validContent(e){let t=this.contentMatch.matchFragment(e);if(!t||!t.validEnd)return!1;for(let s=0;s<e.childCount;s++)if(!this.allowsMarks(e.child(s).marks))return!1;return!0}checkContent(e){if(!this.validContent(e))throw new RangeError(`Invalid content for node ${this.name}: ${e.toString().slice(0,50)}`)}checkAttrs(e){Lf(this.attrs,e,"node",this.name)}allowsMarkType(e){return this.markSet==null||this.markSet.indexOf(e)>-1}allowsMarks(e){if(this.markSet==null)return!0;for(let t=0;t<e.length;t++)if(!this.allowsMarkType(e[t].type))return!1;return!0}allowedMarks(e){if(this.markSet==null)return e;let t;for(let s=0;s<e.length;s++)this.allowsMarkType(e[s].type)?t&&t.push(e[s]):t||(t=e.slice(0,s));return t?t.length?t:Pe.none:e}static compile(e,t){let s=Object.create(null);e.forEach((r,o)=>s[r]=new Uf(r,t,o));let i=t.spec.topNode||"doc";if(!s[i])throw new RangeError("Schema is missing its top node type ('"+i+"')");if(!s.text)throw new RangeError("Every schema needs a 'text' type");for(let r in s.text.attrs)throw new RangeError("The text node type should not have attributes");return s}};function US(n,e,t){let s=t.split("|");return i=>{let r=i===null?"null":typeof i;if(s.indexOf(r)<0)throw new RangeError(`Expected value of type ${s} for attribute ${e} on type ${n}, got ${r}`)}}class VS{constructor(e,t,s){this.hasDefault=Object.prototype.hasOwnProperty.call(s,"default"),this.default=s.default,this.validate=typeof s.validate=="string"?US(e,t,s.validate):s.validate}get isRequired(){return!this.hasDefault}}class Jo{constructor(e,t,s,i){this.name=e,this.rank=t,this.schema=s,this.spec=i,this.attrs=zf(e,i.attrs),this.excluded=null;let r=Ff(this.attrs);this.instance=r?new Pe(this,r):null}create(e=null){return!e&&this.instance?this.instance:new Pe(this,Bf(this.attrs,e))}static compile(e,t){let s=Object.create(null),i=0;return e.forEach((r,o)=>s[r]=new Jo(r,i++,t,o)),s}removeFromSet(e){for(var t=0;t<e.length;t++)e[t].type==this&&(e=e.slice(0,t).concat(e.slice(t+1)),t--);return e}isInSet(e){for(let t=0;t<e.length;t++)if(e[t].type==this)return e[t]}checkAttrs(e){Lf(this.attrs,e,"mark",this.name)}excludes(e){return this.excluded.indexOf(e)>-1}}class WS{constructor(e){this.linebreakReplacement=null,this.cached=Object.create(null);let t=this.spec={};for(let i in e)t[i]=e[i];t.nodes=jc.from(e.nodes),t.marks=jc.from(e.marks||{}),this.nodes=pd.compile(this.spec.nodes,this),this.marks=Jo.compile(this.spec.marks,this);let s=Object.create(null);for(let i in this.nodes){if(i in this.marks)throw new RangeError(i+" can not be both a node and a mark");let r=this.nodes[i],o=r.spec.content||"",a=r.spec.marks;if(r.contentMatch=s[o]||(s[o]=Xs.parse(o,this.nodes)),r.inlineContent=r.contentMatch.inlineContent,r.spec.linebreakReplacement){if(this.linebreakReplacement)throw new RangeError("Multiple linebreak nodes defined");if(!r.isInline||!r.isLeaf)throw new RangeError("Linebreak replacement nodes must be inline leaf nodes");this.linebreakReplacement=r}r.markSet=a=="_"?null:a?md(this,a.split(" ")):a==""||!r.inlineContent?[]:null}for(let i in this.marks){let r=this.marks[i],o=r.spec.excludes;r.excluded=o==null?[r]:o==""?[]:md(this,o.split(" "))}this.nodeFromJSON=this.nodeFromJSON.bind(this),this.markFromJSON=this.markFromJSON.bind(this),this.topNodeType=this.nodes[this.spec.topNode||"doc"],this.cached.wrappings=Object.create(null)}node(e,t=null,s,i){if(typeof e=="string")e=this.nodeType(e);else if(e instanceof pd){if(e.schema!=this)throw new RangeError("Node type from different schema used ("+e.name+")")}else throw new RangeError("Invalid node type: "+e);return e.createChecked(t,s,i)}text(e,t){let s=this.nodes.text;return new vo(s,s.defaultAttrs,e,Pe.setFrom(t))}mark(e,t){return typeof e=="string"&&(e=this.marks[e]),e.create(t)}nodeFromJSON(e){return An.fromJSON(this,e)}markFromJSON(e){return Pe.fromJSON(this,e)}nodeType(e){let t=this.nodes[e];if(!t)throw new RangeError("Unknown node type: "+e);return t}}function md(n,e){let t=[];for(let s=0;s<e.length;s++){let i=e[s],r=n.marks[i],o=r;if(r)t.push(r);else for(let a in n.marks){let l=n.marks[a];(i=="_"||l.spec.group&&l.spec.group.split(" ").indexOf(i)>-1)&&t.push(o=l)}if(!o)throw new SyntaxError("Unknown mark type: '"+e[s]+"'")}return t}function GS(n){return n.tag!=null}function qS(n){return n.style!=null}class pr{constructor(e,t){this.schema=e,this.rules=t,this.tags=[],this.styles=[];let s=this.matchedStyles=[];t.forEach(i=>{if(GS(i))this.tags.push(i);else if(qS(i)){let r=/[^=]*/.exec(i.style)[0];s.indexOf(r)<0&&s.push(r),this.styles.push(i)}}),this.normalizeLists=!this.tags.some(i=>{if(!/^(ul|ol)\b/.test(i.tag)||!i.node)return!1;let r=e.nodes[i.node];return r.contentMatch.matchType(r)})}parse(e,t={}){let s=new yd(this,t,!1);return s.addAll(e,t.from,t.to),s.finish()}parseSlice(e,t={}){let s=new yd(this,t,!0);return s.addAll(e,t.from,t.to),X.maxOpen(s.finish())}matchTag(e,t,s){for(let i=s?this.tags.indexOf(s)+1:0;i<this.tags.length;i++){let r=this.tags[i];if(KS(e,r.tag)&&(r.namespace===void 0||e.namespaceURI==r.namespace)&&(!r.context||t.matchesContext(r.context))){if(r.getAttrs){let o=r.getAttrs(e);if(o===!1)continue;r.attrs=o||void 0}return r}}}matchStyle(e,t,s,i){for(let r=i?this.styles.indexOf(i)+1:0;r<this.styles.length;r++){let o=this.styles[r],a=o.style;if(!(a.indexOf(e)!=0||o.context&&!s.matchesContext(o.context)||a.length>e.length&&(a.charCodeAt(e.length)!=61||a.slice(e.length+1)!=t))){if(o.getAttrs){let l=o.getAttrs(t);if(l===!1)continue;o.attrs=l||void 0}return o}}}static schemaRules(e){let t=[];function s(i){let r=i.priority==null?50:i.priority,o=0;for(;o<t.length;o++){let a=t[o];if((a.priority==null?50:a.priority)<r)break}t.splice(o,0,i)}for(let i in e.marks){let r=e.marks[i].spec.parseDOM;r&&r.forEach(o=>{s(o=xd(o)),o.mark||o.ignore||o.clearMark||(o.mark=i)})}for(let i in e.nodes){let r=e.nodes[i].spec.parseDOM;r&&r.forEach(o=>{s(o=xd(o)),o.node||o.ignore||o.mark||(o.node=i)})}return t}static fromSchema(e){return e.cached.domParser||(e.cached.domParser=new pr(e,pr.schemaRules(e)))}}const Vf={address:!0,article:!0,aside:!0,blockquote:!0,canvas:!0,dd:!0,div:!0,dl:!0,fieldset:!0,figcaption:!0,figure:!0,footer:!0,form:!0,h1:!0,h2:!0,h3:!0,h4:!0,h5:!0,h6:!0,header:!0,hgroup:!0,hr:!0,li:!0,noscript:!0,ol:!0,output:!0,p:!0,pre:!0,section:!0,table:!0,tfoot:!0,ul:!0},HS={head:!0,noscript:!0,object:!0,script:!0,style:!0,title:!0},Wf={ol:!0,ul:!0},To=1,Eo=2,ir=4;function gd(n,e,t){return e!=null?(e?To:0)|(e==="full"?Eo:0):n&&n.whitespace=="pre"?To|Eo:t&~ir}class Vr{constructor(e,t,s,i,r,o,a){this.type=e,this.attrs=t,this.marks=s,this.pendingMarks=i,this.solid=r,this.options=a,this.content=[],this.activeMarks=Pe.none,this.stashMarks=[],this.match=o||(a&ir?null:e.contentMatch)}findWrapping(e){if(!this.match){if(!this.type)return[];let t=this.type.contentMatch.fillBefore(q.from(e));if(t)this.match=this.type.contentMatch.matchFragment(t);else{let s=this.type.contentMatch,i;return(i=s.findWrapping(e.type))?(this.match=s,i):null}}return this.match.findWrapping(e.type)}finish(e){if(!(this.options&To)){let s=this.content[this.content.length-1],i;if(s&&s.isText&&(i=/[ \t\r\n\u000c]+$/.exec(s.text))){let r=s;s.text.length==i[0].length?this.content.pop():this.content[this.content.length-1]=r.withText(r.text.slice(0,r.text.length-i[0].length))}}let t=q.from(this.content);return!e&&this.match&&(t=t.append(this.match.fillBefore(q.empty,!0))),this.type?this.type.create(this.attrs,t,this.marks):t}popFromStashMark(e){for(let t=this.stashMarks.length-1;t>=0;t--)if(e.eq(this.stashMarks[t]))return this.stashMarks.splice(t,1)[0]}applyPending(e){for(let t=0,s=this.pendingMarks;t<s.length;t++){let i=s[t];(this.type?this.type.allowsMarkType(i.type):JS(i.type,e))&&!i.isInSet(this.activeMarks)&&(this.activeMarks=i.addToSet(this.activeMarks),this.pendingMarks=i.removeFromSet(this.pendingMarks))}}inlineContext(e){return this.type?this.type.inlineContent:this.content.length?this.content[0].isInline:e.parentNode&&!Vf.hasOwnProperty(e.parentNode.nodeName.toLowerCase())}}class yd{constructor(e,t,s){this.parser=e,this.options=t,this.isOpen=s,this.open=0;let i=t.topNode,r,o=gd(null,t.preserveWhitespace,0)|(s?ir:0);i?r=new Vr(i.type,i.attrs,Pe.none,Pe.none,!0,t.topMatch||i.type.contentMatch,o):s?r=new Vr(null,null,Pe.none,Pe.none,!0,null,o):r=new Vr(e.schema.topNodeType,null,Pe.none,Pe.none,!0,null,o),this.nodes=[r],this.find=t.findPositions,this.needsBlock=!1}get top(){return this.nodes[this.open]}addDOM(e){e.nodeType==3?this.addTextNode(e):e.nodeType==1&&this.addElement(e)}withStyleRules(e,t){let s=e.style;if(!s||!s.length)return t();let i=this.readStyles(e.style);if(!i)return;let[r,o]=i,a=this.top;for(let l=0;l<o.length;l++)this.removePendingMark(o[l],a);for(let l=0;l<r.length;l++)this.addPendingMark(r[l]);t();for(let l=0;l<r.length;l++)this.removePendingMark(r[l],a);for(let l=0;l<o.length;l++)this.addPendingMark(o[l])}addTextNode(e){let t=e.nodeValue,s=this.top;if(s.options&Eo||s.inlineContext(e)||/[^ \t\r\n\u000c]/.test(t)){if(s.options&To)s.options&Eo?t=t.replace(/\r\n?/g,`
`):t=t.replace(/\r?\n|\r/g," ");else if(t=t.replace(/[ \t\r\n\u000c]+/g," "),/^[ \t\r\n\u000c]/.test(t)&&this.open==this.nodes.length-1){let i=s.content[s.content.length-1],r=e.previousSibling;(!i||r&&r.nodeName=="BR"||i.isText&&/[ \t\r\n\u000c]$/.test(i.text))&&(t=t.slice(1))}t&&this.insertNode(this.parser.schema.text(t)),this.findInText(e)}else this.findInside(e)}addElement(e,t){let s=e.nodeName.toLowerCase(),i;Wf.hasOwnProperty(s)&&this.parser.normalizeLists&&$S(e);let r=this.options.ruleFromNode&&this.options.ruleFromNode(e)||(i=this.parser.matchTag(e,this,t));if(r?r.ignore:HS.hasOwnProperty(s))this.findInside(e),this.ignoreFallback(e);else if(!r||r.skip||r.closeParent){r&&r.closeParent?this.open=Math.max(0,this.open-1):r&&r.skip.nodeType&&(e=r.skip);let o,a=this.top,l=this.needsBlock;if(Vf.hasOwnProperty(s))a.content.length&&a.content[0].isInline&&this.open&&(this.open--,a=this.top),o=!0,a.type||(this.needsBlock=!0);else if(!e.firstChild){this.leafFallback(e);return}r&&r.skip?this.addAll(e):this.withStyleRules(e,()=>this.addAll(e)),o&&this.sync(a),this.needsBlock=l}else this.withStyleRules(e,()=>{this.addElementByRule(e,r,r.consuming===!1?i:void 0)})}leafFallback(e){e.nodeName=="BR"&&this.top.type&&this.top.type.inlineContent&&this.addTextNode(e.ownerDocument.createTextNode(`
`))}ignoreFallback(e){e.nodeName=="BR"&&(!this.top.type||!this.top.type.inlineContent)&&this.findPlace(this.parser.schema.text("-"))}readStyles(e){let t=Pe.none,s=Pe.none;if(e.length)for(let i=0;i<this.parser.matchedStyles.length;i++){let r=this.parser.matchedStyles[i],o=e.getPropertyValue(r);if(o)for(let a=void 0;;){let l=this.parser.matchStyle(r,o,this,a);if(!l)break;if(l.ignore)return null;if(l.clearMark?this.top.pendingMarks.concat(this.top.activeMarks).forEach(d=>{l.clearMark(d)&&(s=d.addToSet(s))}):t=this.parser.schema.marks[l.mark].create(l.attrs).addToSet(t),l.consuming===!1)a=l;else break}}return[t,s]}addElementByRule(e,t,s){let i,r,o;t.node?(r=this.parser.schema.nodes[t.node],r.isLeaf?this.insertNode(r.create(t.attrs))||this.leafFallback(e):i=this.enter(r,t.attrs||null,t.preserveWhitespace)):(o=this.parser.schema.marks[t.mark].create(t.attrs),this.addPendingMark(o));let a=this.top;if(r&&r.isLeaf)this.findInside(e);else if(s)this.addElement(e,s);else if(t.getContent)this.findInside(e),t.getContent(e,this.parser.schema).forEach(l=>this.insertNode(l));else{let l=e;typeof t.contentElement=="string"?l=e.querySelector(t.contentElement):typeof t.contentElement=="function"?l=t.contentElement(e):t.contentElement&&(l=t.contentElement),this.findAround(e,l,!0),this.addAll(l)}i&&this.sync(a)&&this.open--,o&&this.removePendingMark(o,a)}addAll(e,t,s){let i=t||0;for(let r=t?e.childNodes[t]:e.firstChild,o=s==null?null:e.childNodes[s];r!=o;r=r.nextSibling,++i)this.findAtPoint(e,i),this.addDOM(r);this.findAtPoint(e,i)}findPlace(e){let t,s;for(let i=this.open;i>=0;i--){let r=this.nodes[i],o=r.findWrapping(e);if(o&&(!t||t.length>o.length)&&(t=o,s=r,!o.length)||r.solid)break}if(!t)return!1;this.sync(s);for(let i=0;i<t.length;i++)this.enterInner(t[i],null,!1);return!0}insertNode(e){if(e.isInline&&this.needsBlock&&!this.top.type){let t=this.textblockFromContext();t&&this.enterInner(t)}if(this.findPlace(e)){this.closeExtra();let t=this.top;t.applyPending(e.type),t.match&&(t.match=t.match.matchType(e.type));let s=t.activeMarks;for(let i=0;i<e.marks.length;i++)(!t.type||t.type.allowsMarkType(e.marks[i].type))&&(s=e.marks[i].addToSet(s));return t.content.push(e.mark(s)),!0}return!1}enter(e,t,s){let i=this.findPlace(e.create(t));return i&&this.enterInner(e,t,!0,s),i}enterInner(e,t=null,s=!1,i){this.closeExtra();let r=this.top;r.applyPending(e),r.match=r.match&&r.match.matchType(e);let o=gd(e,i,r.options);r.options&ir&&r.content.length==0&&(o|=ir),this.nodes.push(new Vr(e,t,r.activeMarks,r.pendingMarks,s,null,o)),this.open++}closeExtra(e=!1){let t=this.nodes.length-1;if(t>this.open){for(;t>this.open;t--)this.nodes[t-1].content.push(this.nodes[t].finish(e));this.nodes.length=this.open+1}}finish(){return this.open=0,this.closeExtra(this.isOpen),this.nodes[0].finish(this.isOpen||this.options.topOpen)}sync(e){for(let t=this.open;t>=0;t--)if(this.nodes[t]==e)return this.open=t,!0;return!1}get currentPos(){this.closeExtra();let e=0;for(let t=this.open;t>=0;t--){let s=this.nodes[t].content;for(let i=s.length-1;i>=0;i--)e+=s[i].nodeSize;t&&e++}return e}findAtPoint(e,t){if(this.find)for(let s=0;s<this.find.length;s++)this.find[s].node==e&&this.find[s].offset==t&&(this.find[s].pos=this.currentPos)}findInside(e){if(this.find)for(let t=0;t<this.find.length;t++)this.find[t].pos==null&&e.nodeType==1&&e.contains(this.find[t].node)&&(this.find[t].pos=this.currentPos)}findAround(e,t,s){if(e!=t&&this.find)for(let i=0;i<this.find.length;i++)this.find[i].pos==null&&e.nodeType==1&&e.contains(this.find[i].node)&&t.compareDocumentPosition(this.find[i].node)&(s?2:4)&&(this.find[i].pos=this.currentPos)}findInText(e){if(this.find)for(let t=0;t<this.find.length;t++)this.find[t].node==e&&(this.find[t].pos=this.currentPos-(e.nodeValue.length-this.find[t].offset))}matchesContext(e){if(e.indexOf("|")>-1)return e.split(/\s*\|\s*/).some(this.matchesContext,this);let t=e.split("/"),s=this.options.context,i=!this.isOpen&&(!s||s.parent.type==this.nodes[0].type),r=-(s?s.depth+1:0)+(i?0:1),o=(a,l)=>{for(;a>=0;a--){let d=t[a];if(d==""){if(a==t.length-1||a==0)continue;for(;l>=r;l--)if(o(a-1,l))return!0;return!1}else{let u=l>0||l==0&&i?this.nodes[l].type:s&&l>=r?s.node(l-r).type:null;if(!u||u.name!=d&&u.groups.indexOf(d)==-1)return!1;l--}}return!0};return o(t.length-1,this.open)}textblockFromContext(){let e=this.options.context;if(e)for(let t=e.depth;t>=0;t--){let s=e.node(t).contentMatchAt(e.indexAfter(t)).defaultType;if(s&&s.isTextblock&&s.defaultAttrs)return s}for(let t in this.parser.schema.nodes){let s=this.parser.schema.nodes[t];if(s.isTextblock&&s.defaultAttrs)return s}}addPendingMark(e){let t=YS(e,this.top.pendingMarks);t&&this.top.stashMarks.push(t),this.top.pendingMarks=e.addToSet(this.top.pendingMarks)}removePendingMark(e,t){for(let s=this.open;s>=0;s--){let i=this.nodes[s];if(i.pendingMarks.lastIndexOf(e)>-1)i.pendingMarks=e.removeFromSet(i.pendingMarks);else{i.activeMarks=e.removeFromSet(i.activeMarks);let o=i.popFromStashMark(e);o&&i.type&&i.type.allowsMarkType(o.type)&&(i.activeMarks=o.addToSet(i.activeMarks))}if(i==t)break}}}function $S(n){for(let e=n.firstChild,t=null;e;e=e.nextSibling){let s=e.nodeType==1?e.nodeName.toLowerCase():null;s&&Wf.hasOwnProperty(s)&&t?(t.appendChild(e),e=t):s=="li"?t=e:s&&(t=null)}}function KS(n,e){return(n.matches||n.msMatchesSelector||n.webkitMatchesSelector||n.mozMatchesSelector).call(n,e)}function xd(n){let e={};for(let t in n)e[t]=n[t];return e}function JS(n,e){let t=e.schema.nodes;for(let s in t){let i=t[s];if(!i.allowsMarkType(n))continue;let r=[],o=a=>{r.push(a);for(let l=0;l<a.edgeCount;l++){let{type:d,next:u}=a.edge(l);if(d==e||r.indexOf(u)<0&&o(u))return!0}};if(o(i.contentMatch))return!0}}function YS(n,e){for(let t=0;t<e.length;t++)if(n.eq(e[t]))return e[t]}class Vi{constructor(e,t){this.nodes=e,this.marks=t}serializeFragment(e,t={},s){s||(s=ha(t).createDocumentFragment());let i=s,r=[];return e.forEach(o=>{if(r.length||o.marks.length){let a=0,l=0;for(;a<r.length&&l<o.marks.length;){let d=o.marks[l];if(!this.marks[d.type.name]){l++;continue}if(!d.eq(r[a][0])||d.type.spec.spanning===!1)break;a++,l++}for(;a<r.length;)i=r.pop()[1];for(;l<o.marks.length;){let d=o.marks[l++],u=this.serializeMark(d,o.isInline,t);u&&(r.push([d,i]),i.appendChild(u.dom),i=u.contentDOM||u.dom)}}i.appendChild(this.serializeNodeInner(o,t))}),s}serializeNodeInner(e,t){let{dom:s,contentDOM:i}=Xr(ha(t),this.nodes[e.type.name](e),null,e.attrs);if(i){if(e.isLeaf)throw new RangeError("Content hole not allowed in a leaf node spec");this.serializeFragment(e.content,t,i)}return s}serializeNode(e,t={}){let s=this.serializeNodeInner(e,t);for(let i=e.marks.length-1;i>=0;i--){let r=this.serializeMark(e.marks[i],e.isInline,t);r&&((r.contentDOM||r.dom).appendChild(s),s=r.dom)}return s}serializeMark(e,t,s={}){let i=this.marks[e.type.name];return i&&Xr(ha(s),i(e,t),null,e.attrs)}static renderSpec(e,t,s=null,i){return Xr(e,t,s,i)}static fromSchema(e){return e.cached.domSerializer||(e.cached.domSerializer=new Vi(this.nodesFromSchema(e),this.marksFromSchema(e)))}static nodesFromSchema(e){let t=bd(e.nodes);return t.text||(t.text=s=>s.text),t}static marksFromSchema(e){return bd(e.marks)}}function bd(n){let e={};for(let t in n){let s=n[t].spec.toDOM;s&&(e[t]=s)}return e}function ha(n){return n.document||window.document}const wd=new WeakMap;function QS(n){let e=wd.get(n);return e===void 0&&wd.set(n,e=XS(n)),e}function XS(n){let e=null;function t(s){if(s&&typeof s=="object")if(Array.isArray(s))if(typeof s[0]=="string")e||(e=[]),e.push(s);else for(let i=0;i<s.length;i++)t(s[i]);else for(let i in s)t(s[i])}return t(n),e}function Xr(n,e,t,s){if(typeof e=="string")return{dom:n.createTextNode(e)};if(e.nodeType!=null)return{dom:e};if(e.dom&&e.dom.nodeType!=null)return e;let i=e[0],r;if(typeof i!="string")throw new RangeError("Invalid array passed to renderSpec");if(s&&(r=QS(s))&&r.indexOf(e)>-1)throw new RangeError("Using an array from an attribute object as a DOM spec. This may be an attempted cross site scripting attack.");let o=i.indexOf(" ");o>0&&(t=i.slice(0,o),i=i.slice(o+1));let a,l=t?n.createElementNS(t,i):n.createElement(i),d=e[1],u=1;if(d&&typeof d=="object"&&d.nodeType==null&&!Array.isArray(d)){u=2;for(let p in d)if(d[p]!=null){let m=p.indexOf(" ");m>0?l.setAttributeNS(p.slice(0,m),p.slice(m+1),d[p]):l.setAttribute(p,d[p])}}for(let p=u;p<e.length;p++){let m=e[p];if(m===0){if(p<e.length-1||p>u)throw new RangeError("Content hole must be the only child of its parent node");return{dom:l,contentDOM:l}}else{let{dom:b,contentDOM:g}=Xr(n,m,t,s);if(l.appendChild(b),g){if(a)throw new RangeError("Multiple content holes");a=g}}}return{dom:l,contentDOM:a}}const Gf=65535,qf=Math.pow(2,16);function ZS(n,e){return n+e*qf}function Sd(n){return n&Gf}function ek(n){return(n-(n&Gf))/qf}const Hf=1,$f=2,Zr=4,Kf=8;class Ja{constructor(e,t,s){this.pos=e,this.delInfo=t,this.recover=s}get deleted(){return(this.delInfo&Kf)>0}get deletedBefore(){return(this.delInfo&(Hf|Zr))>0}get deletedAfter(){return(this.delInfo&($f|Zr))>0}get deletedAcross(){return(this.delInfo&Zr)>0}}class Kt{constructor(e,t=!1){if(this.ranges=e,this.inverted=t,!e.length&&Kt.empty)return Kt.empty}recover(e){let t=0,s=Sd(e);if(!this.inverted)for(let i=0;i<s;i++)t+=this.ranges[i*3+2]-this.ranges[i*3+1];return this.ranges[s*3]+t+ek(e)}mapResult(e,t=1){return this._map(e,t,!1)}map(e,t=1){return this._map(e,t,!0)}_map(e,t,s){let i=0,r=this.inverted?2:1,o=this.inverted?1:2;for(let a=0;a<this.ranges.length;a+=3){let l=this.ranges[a]-(this.inverted?i:0);if(l>e)break;let d=this.ranges[a+r],u=this.ranges[a+o],p=l+d;if(e<=p){let m=d?e==l?-1:e==p?1:t:t,b=l+i+(m<0?0:u);if(s)return b;let g=e==(t<0?l:p)?null:ZS(a/3,e-l),y=e==l?$f:e==p?Hf:Zr;return(t<0?e!=l:e!=p)&&(y|=Kf),new Ja(b,y,g)}i+=u-d}return s?e+i:new Ja(e+i,0,null)}touches(e,t){let s=0,i=Sd(t),r=this.inverted?2:1,o=this.inverted?1:2;for(let a=0;a<this.ranges.length;a+=3){let l=this.ranges[a]-(this.inverted?s:0);if(l>e)break;let d=this.ranges[a+r],u=l+d;if(e<=u&&a==i*3)return!0;s+=this.ranges[a+o]-d}return!1}forEach(e){let t=this.inverted?2:1,s=this.inverted?1:2;for(let i=0,r=0;i<this.ranges.length;i+=3){let o=this.ranges[i],a=o-(this.inverted?r:0),l=o+(this.inverted?0:r),d=this.ranges[i+t],u=this.ranges[i+s];e(a,a+d,l,l+u),r+=u-d}}invert(){return new Kt(this.ranges,!this.inverted)}toString(){return(this.inverted?"-":"")+JSON.stringify(this.ranges)}static offset(e){return e==0?Kt.empty:new Kt(e<0?[0,-e,0]:[0,0,e])}}Kt.empty=new Kt([]);class bi{constructor(e=[],t,s=0,i=e.length){this.maps=e,this.mirror=t,this.from=s,this.to=i}slice(e=0,t=this.maps.length){return new bi(this.maps,this.mirror,e,t)}copy(){return new bi(this.maps.slice(),this.mirror&&this.mirror.slice(),this.from,this.to)}appendMap(e,t){this.to=this.maps.push(e),t!=null&&this.setMirror(this.maps.length-1,t)}appendMapping(e){for(let t=0,s=this.maps.length;t<e.maps.length;t++){let i=e.getMirror(t);this.appendMap(e.maps[t],i!=null&&i<t?s+i:void 0)}}getMirror(e){if(this.mirror){for(let t=0;t<this.mirror.length;t++)if(this.mirror[t]==e)return this.mirror[t+(t%2?-1:1)]}}setMirror(e,t){this.mirror||(this.mirror=[]),this.mirror.push(e,t)}appendMappingInverted(e){for(let t=e.maps.length-1,s=this.maps.length+e.maps.length;t>=0;t--){let i=e.getMirror(t);this.appendMap(e.maps[t].invert(),i!=null&&i>t?s-i-1:void 0)}}invert(){let e=new bi;return e.appendMappingInverted(this),e}map(e,t=1){if(this.mirror)return this._map(e,t,!0);for(let s=this.from;s<this.to;s++)e=this.maps[s].map(e,t);return e}mapResult(e,t=1){return this._map(e,t,!1)}_map(e,t,s){let i=0;for(let r=this.from;r<this.to;r++){let o=this.maps[r],a=o.mapResult(e,t);if(a.recover!=null){let l=this.getMirror(r);if(l!=null&&l>r&&l<this.to){r=l,e=this.maps[l].recover(a.recover);continue}}i|=a.delInfo,e=a.pos}return s?e:new Ja(e,i,null)}}const fa=Object.create(null);class At{getMap(){return Kt.empty}merge(e){return null}static fromJSON(e,t){if(!t||!t.stepType)throw new RangeError("Invalid input for Step.fromJSON");let s=fa[t.stepType];if(!s)throw new RangeError(`No step type ${t.stepType} defined`);return s.fromJSON(e,t)}static jsonID(e,t){if(e in fa)throw new RangeError("Duplicate use of step JSON ID "+e);return fa[e]=t,t.prototype.jsonID=e,t}}class dt{constructor(e,t){this.doc=e,this.failed=t}static ok(e){return new dt(e,null)}static fail(e){return new dt(null,e)}static fromReplace(e,t,s,i){try{return dt.ok(e.replace(t,s,i))}catch(r){if(r instanceof Co)return dt.fail(r.message);throw r}}}function sc(n,e,t){let s=[];for(let i=0;i<n.childCount;i++){let r=n.child(i);r.content.size&&(r=r.copy(sc(r.content,e,r))),r.isInline&&(r=e(r,t,i)),s.push(r)}return q.fromArray(s)}class gs extends At{constructor(e,t,s){super(),this.from=e,this.to=t,this.mark=s}apply(e){let t=e.slice(this.from,this.to),s=e.resolve(this.from),i=s.node(s.sharedDepth(this.to)),r=new X(sc(t.content,(o,a)=>!o.isAtom||!a.type.allowsMarkType(this.mark.type)?o:o.mark(this.mark.addToSet(o.marks)),i),t.openStart,t.openEnd);return dt.fromReplace(e,this.from,this.to,r)}invert(){return new Nn(this.from,this.to,this.mark)}map(e){let t=e.mapResult(this.from,1),s=e.mapResult(this.to,-1);return t.deleted&&s.deleted||t.pos>=s.pos?null:new gs(t.pos,s.pos,this.mark)}merge(e){return e instanceof gs&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from?new gs(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark):null}toJSON(){return{stepType:"addMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for AddMarkStep.fromJSON");return new gs(t.from,t.to,e.markFromJSON(t.mark))}}At.jsonID("addMark",gs);class Nn extends At{constructor(e,t,s){super(),this.from=e,this.to=t,this.mark=s}apply(e){let t=e.slice(this.from,this.to),s=new X(sc(t.content,i=>i.mark(this.mark.removeFromSet(i.marks)),e),t.openStart,t.openEnd);return dt.fromReplace(e,this.from,this.to,s)}invert(){return new gs(this.from,this.to,this.mark)}map(e){let t=e.mapResult(this.from,1),s=e.mapResult(this.to,-1);return t.deleted&&s.deleted||t.pos>=s.pos?null:new Nn(t.pos,s.pos,this.mark)}merge(e){return e instanceof Nn&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from?new Nn(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark):null}toJSON(){return{stepType:"removeMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for RemoveMarkStep.fromJSON");return new Nn(t.from,t.to,e.markFromJSON(t.mark))}}At.jsonID("removeMark",Nn);class ys extends At{constructor(e,t){super(),this.pos=e,this.mark=t}apply(e){let t=e.nodeAt(this.pos);if(!t)return dt.fail("No node at mark step's position");let s=t.type.create(t.attrs,null,this.mark.addToSet(t.marks));return dt.fromReplace(e,this.pos,this.pos+1,new X(q.from(s),0,t.isLeaf?0:1))}invert(e){let t=e.nodeAt(this.pos);if(t){let s=this.mark.addToSet(t.marks);if(s.length==t.marks.length){for(let i=0;i<t.marks.length;i++)if(!t.marks[i].isInSet(s))return new ys(this.pos,t.marks[i]);return new ys(this.pos,this.mark)}}return new Ri(this.pos,this.mark)}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new ys(t.pos,this.mark)}toJSON(){return{stepType:"addNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for AddNodeMarkStep.fromJSON");return new ys(t.pos,e.markFromJSON(t.mark))}}At.jsonID("addNodeMark",ys);class Ri extends At{constructor(e,t){super(),this.pos=e,this.mark=t}apply(e){let t=e.nodeAt(this.pos);if(!t)return dt.fail("No node at mark step's position");let s=t.type.create(t.attrs,null,this.mark.removeFromSet(t.marks));return dt.fromReplace(e,this.pos,this.pos+1,new X(q.from(s),0,t.isLeaf?0:1))}invert(e){let t=e.nodeAt(this.pos);return!t||!this.mark.isInSet(t.marks)?this:new ys(this.pos,this.mark)}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new Ri(t.pos,this.mark)}toJSON(){return{stepType:"removeNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for RemoveNodeMarkStep.fromJSON");return new Ri(t.pos,e.markFromJSON(t.mark))}}At.jsonID("removeNodeMark",Ri);class Et extends At{constructor(e,t,s,i=!1){super(),this.from=e,this.to=t,this.slice=s,this.structure=i}apply(e){return this.structure&&Ya(e,this.from,this.to)?dt.fail("Structure replace would overwrite content"):dt.fromReplace(e,this.from,this.to,this.slice)}getMap(){return new Kt([this.from,this.to-this.from,this.slice.size])}invert(e){return new Et(this.from,this.from+this.slice.size,e.slice(this.from,this.to))}map(e){let t=e.mapResult(this.from,1),s=e.mapResult(this.to,-1);return t.deletedAcross&&s.deletedAcross?null:new Et(t.pos,Math.max(t.pos,s.pos),this.slice)}merge(e){if(!(e instanceof Et)||e.structure||this.structure)return null;if(this.from+this.slice.size==e.from&&!this.slice.openEnd&&!e.slice.openStart){let t=this.slice.size+e.slice.size==0?X.empty:new X(this.slice.content.append(e.slice.content),this.slice.openStart,e.slice.openEnd);return new Et(this.from,this.to+(e.to-e.from),t,this.structure)}else if(e.to==this.from&&!this.slice.openStart&&!e.slice.openEnd){let t=this.slice.size+e.slice.size==0?X.empty:new X(e.slice.content.append(this.slice.content),e.slice.openStart,this.slice.openEnd);return new Et(e.from,this.to,t,this.structure)}else return null}toJSON(){let e={stepType:"replace",from:this.from,to:this.to};return this.slice.size&&(e.slice=this.slice.toJSON()),this.structure&&(e.structure=!0),e}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for ReplaceStep.fromJSON");return new Et(t.from,t.to,X.fromJSON(e,t.slice),!!t.structure)}}At.jsonID("replace",Et);class Yt extends At{constructor(e,t,s,i,r,o,a=!1){super(),this.from=e,this.to=t,this.gapFrom=s,this.gapTo=i,this.slice=r,this.insert=o,this.structure=a}apply(e){if(this.structure&&(Ya(e,this.from,this.gapFrom)||Ya(e,this.gapTo,this.to)))return dt.fail("Structure gap-replace would overwrite content");let t=e.slice(this.gapFrom,this.gapTo);if(t.openStart||t.openEnd)return dt.fail("Gap is not a flat range");let s=this.slice.insertAt(this.insert,t.content);return s?dt.fromReplace(e,this.from,this.to,s):dt.fail("Content does not fit in gap")}getMap(){return new Kt([this.from,this.gapFrom-this.from,this.insert,this.gapTo,this.to-this.gapTo,this.slice.size-this.insert])}invert(e){let t=this.gapTo-this.gapFrom;return new Yt(this.from,this.from+this.slice.size+t,this.from+this.insert,this.from+this.insert+t,e.slice(this.from,this.to).removeBetween(this.gapFrom-this.from,this.gapTo-this.from),this.gapFrom-this.from,this.structure)}map(e){let t=e.mapResult(this.from,1),s=e.mapResult(this.to,-1),i=this.from==this.gapFrom?t.pos:e.map(this.gapFrom,-1),r=this.to==this.gapTo?s.pos:e.map(this.gapTo,1);return t.deletedAcross&&s.deletedAcross||i<t.pos||r>s.pos?null:new Yt(t.pos,s.pos,i,r,this.slice,this.insert,this.structure)}toJSON(){let e={stepType:"replaceAround",from:this.from,to:this.to,gapFrom:this.gapFrom,gapTo:this.gapTo,insert:this.insert};return this.slice.size&&(e.slice=this.slice.toJSON()),this.structure&&(e.structure=!0),e}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number"||typeof t.gapFrom!="number"||typeof t.gapTo!="number"||typeof t.insert!="number")throw new RangeError("Invalid input for ReplaceAroundStep.fromJSON");return new Yt(t.from,t.to,t.gapFrom,t.gapTo,X.fromJSON(e,t.slice),t.insert,!!t.structure)}}At.jsonID("replaceAround",Yt);function Ya(n,e,t){let s=n.resolve(e),i=t-e,r=s.depth;for(;i>0&&r>0&&s.indexAfter(r)==s.node(r).childCount;)r--,i--;if(i>0){let o=s.node(r).maybeChild(s.indexAfter(r));for(;i>0;){if(!o||o.isLeaf)return!0;o=o.firstChild,i--}}return!1}function tk(n,e,t,s){let i=[],r=[],o,a;n.doc.nodesBetween(e,t,(l,d,u)=>{if(!l.isInline)return;let p=l.marks;if(!s.isInSet(p)&&u.type.allowsMarkType(s.type)){let m=Math.max(d,e),b=Math.min(d+l.nodeSize,t),g=s.addToSet(p);for(let y=0;y<p.length;y++)p[y].isInSet(g)||(o&&o.to==m&&o.mark.eq(p[y])?o.to=b:i.push(o=new Nn(m,b,p[y])));a&&a.to==m?a.to=b:r.push(a=new gs(m,b,s))}}),i.forEach(l=>n.step(l)),r.forEach(l=>n.step(l))}function nk(n,e,t,s){let i=[],r=0;n.doc.nodesBetween(e,t,(o,a)=>{if(!o.isInline)return;r++;let l=null;if(s instanceof Jo){let d=o.marks,u;for(;u=s.isInSet(d);)(l||(l=[])).push(u),d=u.removeFromSet(d)}else s?s.isInSet(o.marks)&&(l=[s]):l=o.marks;if(l&&l.length){let d=Math.min(a+o.nodeSize,t);for(let u=0;u<l.length;u++){let p=l[u],m;for(let b=0;b<i.length;b++){let g=i[b];g.step==r-1&&p.eq(i[b].style)&&(m=g)}m?(m.to=d,m.step=r):i.push({style:p,from:Math.max(a,e),to:d,step:r})}}}),i.forEach(o=>n.step(new Nn(o.from,o.to,o.style)))}function Jf(n,e,t,s=t.contentMatch,i=!0){let r=n.doc.nodeAt(e),o=[],a=e+1;for(let l=0;l<r.childCount;l++){let d=r.child(l),u=a+d.nodeSize,p=s.matchType(d.type);if(!p)o.push(new Et(a,u,X.empty));else{s=p;for(let m=0;m<d.marks.length;m++)t.allowsMarkType(d.marks[m].type)||n.step(new Nn(a,u,d.marks[m]));if(i&&d.isText&&t.whitespace!="pre"){let m,b=/\r?\n|\r/g,g;for(;m=b.exec(d.text);)g||(g=new X(q.from(t.schema.text(" ",t.allowedMarks(d.marks))),0,0)),o.push(new Et(a+m.index,a+m.index+m[0].length,g))}}a=u}if(!s.validEnd){let l=s.fillBefore(q.empty,!0);n.replace(a,a,new X(l,0,0))}for(let l=o.length-1;l>=0;l--)n.step(o[l])}function sk(n,e,t){return(e==0||n.canReplace(e,n.childCount))&&(t==n.childCount||n.canReplace(0,t))}function ic(n){let t=n.parent.content.cutByIndex(n.startIndex,n.endIndex);for(let s=n.depth;;--s){let i=n.$from.node(s),r=n.$from.index(s),o=n.$to.indexAfter(s);if(s<n.depth&&i.canReplace(r,o,t))return s;if(s==0||i.type.spec.isolating||!sk(i,r,o))break}return null}function ik(n,e,t){let{$from:s,$to:i,depth:r}=e,o=s.before(r+1),a=i.after(r+1),l=o,d=a,u=q.empty,p=0;for(let g=r,y=!1;g>t;g--)y||s.index(g)>0?(y=!0,u=q.from(s.node(g).copy(u)),p++):l--;let m=q.empty,b=0;for(let g=r,y=!1;g>t;g--)y||i.after(g+1)<i.end(g)?(y=!0,m=q.from(i.node(g).copy(m)),b++):d++;n.step(new Yt(l,d,o,a,new X(u.append(m),p,b),u.size-p,!0))}function rk(n,e,t=null,s=n){let i=ok(n,e),r=i&&ak(s,e);return r?i.map(kd).concat({type:e,attrs:t}).concat(r.map(kd)):null}function kd(n){return{type:n,attrs:null}}function ok(n,e){let{parent:t,startIndex:s,endIndex:i}=n,r=t.contentMatchAt(s).findWrapping(e);if(!r)return null;let o=r.length?r[0]:e;return t.canReplaceWith(s,i,o)?r:null}function ak(n,e){let{parent:t,startIndex:s,endIndex:i}=n,r=t.child(s),o=e.contentMatch.findWrapping(r.type);if(!o)return null;let l=(o.length?o[o.length-1]:e).contentMatch;for(let d=s;l&&d<i;d++)l=l.matchType(t.child(d).type);return!l||!l.validEnd?null:o}function lk(n,e,t){let s=q.empty;for(let o=t.length-1;o>=0;o--){if(s.size){let a=t[o].type.contentMatch.matchFragment(s);if(!a||!a.validEnd)throw new RangeError("Wrapper type given to Transform.wrap does not form valid content of its parent wrapper")}s=q.from(t[o].type.create(t[o].attrs,s))}let i=e.start,r=e.end;n.step(new Yt(i,r,i,r,new X(s,0,0),t.length,!0))}function ck(n,e,t,s,i){if(!s.isTextblock)throw new RangeError("Type given to setBlockType should be a textblock");let r=n.steps.length;n.doc.nodesBetween(e,t,(o,a)=>{if(o.isTextblock&&!o.hasMarkup(s,i)&&hk(n.doc,n.mapping.slice(r).map(a),s)){let l=null;if(s.schema.linebreakReplacement){let m=s.whitespace=="pre",b=!!s.contentMatch.matchType(s.schema.linebreakReplacement);m&&!b?l=!1:!m&&b&&(l=!0)}l===!1&&uk(n,o,a,r),Jf(n,n.mapping.slice(r).map(a,1),s,void 0,l===null);let d=n.mapping.slice(r),u=d.map(a,1),p=d.map(a+o.nodeSize,1);return n.step(new Yt(u,p,u+1,p-1,new X(q.from(s.create(i,null,o.marks)),0,0),1,!0)),l===!0&&dk(n,o,a,r),!1}})}function dk(n,e,t,s){e.forEach((i,r)=>{if(i.isText){let o,a=/\r?\n|\r/g;for(;o=a.exec(i.text);){let l=n.mapping.slice(s).map(t+1+r+o.index);n.replaceWith(l,l+1,e.type.schema.linebreakReplacement.create())}}})}function uk(n,e,t,s){e.forEach((i,r)=>{if(i.type==i.type.schema.linebreakReplacement){let o=n.mapping.slice(s).map(t+1+r);n.replaceWith(o,o+1,e.type.schema.text(`
`))}})}function hk(n,e,t){let s=n.resolve(e),i=s.index();return s.parent.canReplaceWith(i,i+1,t)}function fk(n,e,t,s,i){let r=n.doc.nodeAt(e);if(!r)throw new RangeError("No node at given position");t||(t=r.type);let o=t.create(s,null,i||r.marks);if(r.isLeaf)return n.replaceWith(e,e+r.nodeSize,o);if(!t.validContent(r.content))throw new RangeError("Invalid content for node type "+t.name);n.step(new Yt(e,e+r.nodeSize,e+1,e+r.nodeSize-1,new X(q.from(o),0,0),1,!0))}function eo(n,e,t=1,s){let i=n.resolve(e),r=i.depth-t,o=s&&s[s.length-1]||i.parent;if(r<0||i.parent.type.spec.isolating||!i.parent.canReplace(i.index(),i.parent.childCount)||!o.type.validContent(i.parent.content.cutByIndex(i.index(),i.parent.childCount)))return!1;for(let d=i.depth-1,u=t-2;d>r;d--,u--){let p=i.node(d),m=i.index(d);if(p.type.spec.isolating)return!1;let b=p.content.cutByIndex(m,p.childCount),g=s&&s[u+1];g&&(b=b.replaceChild(0,g.type.create(g.attrs)));let y=s&&s[u]||p;if(!p.canReplace(m+1,p.childCount)||!y.type.validContent(b))return!1}let a=i.indexAfter(r),l=s&&s[0];return i.node(r).canReplaceWith(a,a,l?l.type:i.node(r+1).type)}function pk(n,e,t=1,s){let i=n.doc.resolve(e),r=q.empty,o=q.empty;for(let a=i.depth,l=i.depth-t,d=t-1;a>l;a--,d--){r=q.from(i.node(a).copy(r));let u=s&&s[d];o=q.from(u?u.type.create(u.attrs,o):i.node(a).copy(o))}n.step(new Et(e,e,new X(r.append(o),t,t),!0))}function Yf(n,e){let t=n.resolve(e),s=t.index();return mk(t.nodeBefore,t.nodeAfter)&&t.parent.canReplace(s,s+1)}function mk(n,e){return!!(n&&e&&!n.isLeaf&&n.canAppend(e))}function gk(n,e,t){let s=new Et(e-t,e+t,X.empty,!0);n.step(s)}function yk(n,e,t){let s=n.resolve(e);if(s.parent.canReplaceWith(s.index(),s.index(),t))return e;if(s.parentOffset==0)for(let i=s.depth-1;i>=0;i--){let r=s.index(i);if(s.node(i).canReplaceWith(r,r,t))return s.before(i+1);if(r>0)return null}if(s.parentOffset==s.parent.content.size)for(let i=s.depth-1;i>=0;i--){let r=s.indexAfter(i);if(s.node(i).canReplaceWith(r,r,t))return s.after(i+1);if(r<s.node(i).childCount)return null}return null}function xk(n,e,t){let s=n.resolve(e);if(!t.content.size)return e;let i=t.content;for(let r=0;r<t.openStart;r++)i=i.firstChild.content;for(let r=1;r<=(t.openStart==0&&t.size?2:1);r++)for(let o=s.depth;o>=0;o--){let a=o==s.depth?0:s.pos<=(s.start(o+1)+s.end(o+1))/2?-1:1,l=s.index(o)+(a>0?1:0),d=s.node(o),u=!1;if(r==1)u=d.canReplace(l,l,i);else{let p=d.contentMatchAt(l).findWrapping(i.firstChild.type);u=p&&d.canReplaceWith(l,l,p[0])}if(u)return a==0?s.pos:a<0?s.before(o+1):s.after(o+1)}return null}function rc(n,e,t=e,s=X.empty){if(e==t&&!s.size)return null;let i=n.resolve(e),r=n.resolve(t);return Qf(i,r,s)?new Et(e,t,s):new bk(i,r,s).fit()}function Qf(n,e,t){return!t.openStart&&!t.openEnd&&n.start()==e.start()&&n.parent.canReplace(n.index(),e.index(),t.content)}class bk{constructor(e,t,s){this.$from=e,this.$to=t,this.unplaced=s,this.frontier=[],this.placed=q.empty;for(let i=0;i<=e.depth;i++){let r=e.node(i);this.frontier.push({type:r.type,match:r.contentMatchAt(e.indexAfter(i))})}for(let i=e.depth;i>0;i--)this.placed=q.from(e.node(i).copy(this.placed))}get depth(){return this.frontier.length-1}fit(){for(;this.unplaced.size;){let d=this.findFittable();d?this.placeNodes(d):this.openMore()||this.dropNode()}let e=this.mustMoveInline(),t=this.placed.size-this.depth-this.$from.depth,s=this.$from,i=this.close(e<0?this.$to:s.doc.resolve(e));if(!i)return null;let r=this.placed,o=s.depth,a=i.depth;for(;o&&a&&r.childCount==1;)r=r.firstChild.content,o--,a--;let l=new X(r,o,a);return e>-1?new Yt(s.pos,e,this.$to.pos,this.$to.end(),l,t):l.size||s.pos!=this.$to.pos?new Et(s.pos,i.pos,l):null}findFittable(){let e=this.unplaced.openStart;for(let t=this.unplaced.content,s=0,i=this.unplaced.openEnd;s<e;s++){let r=t.firstChild;if(t.childCount>1&&(i=0),r.type.spec.isolating&&i<=s){e=s;break}t=r.content}for(let t=1;t<=2;t++)for(let s=t==1?e:this.unplaced.openStart;s>=0;s--){let i,r=null;s?(r=pa(this.unplaced.content,s-1).firstChild,i=r.content):i=this.unplaced.content;let o=i.firstChild;for(let a=this.depth;a>=0;a--){let{type:l,match:d}=this.frontier[a],u,p=null;if(t==1&&(o?d.matchType(o.type)||(p=d.fillBefore(q.from(o),!1)):r&&l.compatibleContent(r.type)))return{sliceDepth:s,frontierDepth:a,parent:r,inject:p};if(t==2&&o&&(u=d.findWrapping(o.type)))return{sliceDepth:s,frontierDepth:a,parent:r,wrap:u};if(r&&d.matchType(r.type))break}}}openMore(){let{content:e,openStart:t,openEnd:s}=this.unplaced,i=pa(e,t);return!i.childCount||i.firstChild.isLeaf?!1:(this.unplaced=new X(e,t+1,Math.max(s,i.size+t>=e.size-s?t+1:0)),!0)}dropNode(){let{content:e,openStart:t,openEnd:s}=this.unplaced,i=pa(e,t);if(i.childCount<=1&&t>0){let r=e.size-t<=t+i.size;this.unplaced=new X(Ji(e,t-1,1),t-1,r?t-1:s)}else this.unplaced=new X(Ji(e,t,1),t,s)}placeNodes({sliceDepth:e,frontierDepth:t,parent:s,inject:i,wrap:r}){for(;this.depth>t;)this.closeFrontierNode();if(r)for(let y=0;y<r.length;y++)this.openFrontierNode(r[y]);let o=this.unplaced,a=s?s.content:o.content,l=o.openStart-e,d=0,u=[],{match:p,type:m}=this.frontier[t];if(i){for(let y=0;y<i.childCount;y++)u.push(i.child(y));p=p.matchFragment(i)}let b=a.size+e-(o.content.size-o.openEnd);for(;d<a.childCount;){let y=a.child(d),C=p.matchType(y.type);if(!C)break;d++,(d>1||l==0||y.content.size)&&(p=C,u.push(Xf(y.mark(m.allowedMarks(y.marks)),d==1?l:0,d==a.childCount?b:-1)))}let g=d==a.childCount;g||(b=-1),this.placed=Yi(this.placed,t,q.from(u)),this.frontier[t].match=p,g&&b<0&&s&&s.type==this.frontier[this.depth].type&&this.frontier.length>1&&this.closeFrontierNode();for(let y=0,C=a;y<b;y++){let M=C.lastChild;this.frontier.push({type:M.type,match:M.contentMatchAt(M.childCount)}),C=M.content}this.unplaced=g?e==0?X.empty:new X(Ji(o.content,e-1,1),e-1,b<0?o.openEnd:e-1):new X(Ji(o.content,e,d),o.openStart,o.openEnd)}mustMoveInline(){if(!this.$to.parent.isTextblock)return-1;let e=this.frontier[this.depth],t;if(!e.type.isTextblock||!ma(this.$to,this.$to.depth,e.type,e.match,!1)||this.$to.depth==this.depth&&(t=this.findCloseLevel(this.$to))&&t.depth==this.depth)return-1;let{depth:s}=this.$to,i=this.$to.after(s);for(;s>1&&i==this.$to.end(--s);)++i;return i}findCloseLevel(e){e:for(let t=Math.min(this.depth,e.depth);t>=0;t--){let{match:s,type:i}=this.frontier[t],r=t<e.depth&&e.end(t+1)==e.pos+(e.depth-(t+1)),o=ma(e,t,i,s,r);if(o){for(let a=t-1;a>=0;a--){let{match:l,type:d}=this.frontier[a],u=ma(e,a,d,l,!0);if(!u||u.childCount)continue e}return{depth:t,fit:o,move:r?e.doc.resolve(e.after(t+1)):e}}}}close(e){let t=this.findCloseLevel(e);if(!t)return null;for(;this.depth>t.depth;)this.closeFrontierNode();t.fit.childCount&&(this.placed=Yi(this.placed,t.depth,t.fit)),e=t.move;for(let s=t.depth+1;s<=e.depth;s++){let i=e.node(s),r=i.type.contentMatch.fillBefore(i.content,!0,e.index(s));this.openFrontierNode(i.type,i.attrs,r)}return e}openFrontierNode(e,t=null,s){let i=this.frontier[this.depth];i.match=i.match.matchType(e),this.placed=Yi(this.placed,this.depth,q.from(e.create(t,s))),this.frontier.push({type:e,match:e.contentMatch})}closeFrontierNode(){let t=this.frontier.pop().match.fillBefore(q.empty,!0);t.childCount&&(this.placed=Yi(this.placed,this.frontier.length,t))}}function Ji(n,e,t){return e==0?n.cutByIndex(t,n.childCount):n.replaceChild(0,n.firstChild.copy(Ji(n.firstChild.content,e-1,t)))}function Yi(n,e,t){return e==0?n.append(t):n.replaceChild(n.childCount-1,n.lastChild.copy(Yi(n.lastChild.content,e-1,t)))}function pa(n,e){for(let t=0;t<e;t++)n=n.firstChild.content;return n}function Xf(n,e,t){if(e<=0)return n;let s=n.content;return e>1&&(s=s.replaceChild(0,Xf(s.firstChild,e-1,s.childCount==1?t-1:0))),e>0&&(s=n.type.contentMatch.fillBefore(s).append(s),t<=0&&(s=s.append(n.type.contentMatch.matchFragment(s).fillBefore(q.empty,!0)))),n.copy(s)}function ma(n,e,t,s,i){let r=n.node(e),o=i?n.indexAfter(e):n.index(e);if(o==r.childCount&&!t.compatibleContent(r.type))return null;let a=s.fillBefore(r.content,!0,o);return a&&!wk(t,r.content,o)?a:null}function wk(n,e,t){for(let s=t;s<e.childCount;s++)if(!n.allowsMarks(e.child(s).marks))return!0;return!1}function Sk(n){return n.spec.defining||n.spec.definingForContent}function kk(n,e,t,s){if(!s.size)return n.deleteRange(e,t);let i=n.doc.resolve(e),r=n.doc.resolve(t);if(Qf(i,r,s))return n.step(new Et(e,t,s));let o=ep(i,n.doc.resolve(t));o[o.length-1]==0&&o.pop();let a=-(i.depth+1);o.unshift(a);for(let m=i.depth,b=i.pos-1;m>0;m--,b--){let g=i.node(m).type.spec;if(g.defining||g.definingAsContext||g.isolating)break;o.indexOf(m)>-1?a=m:i.before(m)==b&&o.splice(1,0,-m)}let l=o.indexOf(a),d=[],u=s.openStart;for(let m=s.content,b=0;;b++){let g=m.firstChild;if(d.push(g),b==s.openStart)break;m=g.content}for(let m=u-1;m>=0;m--){let b=d[m],g=Sk(b.type);if(g&&!b.sameMarkup(i.node(Math.abs(a)-1)))u=m;else if(g||!b.type.isTextblock)break}for(let m=s.openStart;m>=0;m--){let b=(m+u+1)%(s.openStart+1),g=d[b];if(g)for(let y=0;y<o.length;y++){let C=o[(y+l)%o.length],M=!0;C<0&&(M=!1,C=-C);let _=i.node(C-1),R=i.index(C-1);if(_.canReplaceWith(R,R,g.type,g.marks))return n.replace(i.before(C),M?r.after(C):t,new X(Zf(s.content,0,s.openStart,b),b,s.openEnd))}}let p=n.steps.length;for(let m=o.length-1;m>=0&&(n.replace(e,t,s),!(n.steps.length>p));m--){let b=o[m];b<0||(e=i.before(b),t=r.after(b))}}function Zf(n,e,t,s,i){if(e<t){let r=n.firstChild;n=n.replaceChild(0,r.copy(Zf(r.content,e+1,t,s,r)))}if(e>s){let r=i.contentMatchAt(0),o=r.fillBefore(n).append(n);n=o.append(r.matchFragment(o).fillBefore(q.empty,!0))}return n}function Ck(n,e,t,s){if(!s.isInline&&e==t&&n.doc.resolve(e).parent.content.size){let i=yk(n.doc,e,s.type);i!=null&&(e=t=i)}n.replaceRange(e,t,new X(q.from(s),0,0))}function Mk(n,e,t){let s=n.doc.resolve(e),i=n.doc.resolve(t),r=ep(s,i);for(let o=0;o<r.length;o++){let a=r[o],l=o==r.length-1;if(l&&a==0||s.node(a).type.contentMatch.validEnd)return n.delete(s.start(a),i.end(a));if(a>0&&(l||s.node(a-1).canReplace(s.index(a-1),i.indexAfter(a-1))))return n.delete(s.before(a),i.after(a))}for(let o=1;o<=s.depth&&o<=i.depth;o++)if(e-s.start(o)==s.depth-o&&t>s.end(o)&&i.end(o)-t!=i.depth-o)return n.delete(s.before(o),t);n.delete(e,t)}function ep(n,e){let t=[],s=Math.min(n.depth,e.depth);for(let i=s;i>=0;i--){let r=n.start(i);if(r<n.pos-(n.depth-i)||e.end(i)>e.pos+(e.depth-i)||n.node(i).type.spec.isolating||e.node(i).type.spec.isolating)break;(r==e.start(i)||i==n.depth&&i==e.depth&&n.parent.inlineContent&&e.parent.inlineContent&&i&&e.start(i-1)==r-1)&&t.push(i)}return t}class wi extends At{constructor(e,t,s){super(),this.pos=e,this.attr=t,this.value=s}apply(e){let t=e.nodeAt(this.pos);if(!t)return dt.fail("No node at attribute step's position");let s=Object.create(null);for(let r in t.attrs)s[r]=t.attrs[r];s[this.attr]=this.value;let i=t.type.create(s,null,t.marks);return dt.fromReplace(e,this.pos,this.pos+1,new X(q.from(i),0,t.isLeaf?0:1))}getMap(){return Kt.empty}invert(e){return new wi(this.pos,this.attr,e.nodeAt(this.pos).attrs[this.attr])}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new wi(t.pos,this.attr,this.value)}toJSON(){return{stepType:"attr",pos:this.pos,attr:this.attr,value:this.value}}static fromJSON(e,t){if(typeof t.pos!="number"||typeof t.attr!="string")throw new RangeError("Invalid input for AttrStep.fromJSON");return new wi(t.pos,t.attr,t.value)}}At.jsonID("attr",wi);class mr extends At{constructor(e,t){super(),this.attr=e,this.value=t}apply(e){let t=Object.create(null);for(let i in e.attrs)t[i]=e.attrs[i];t[this.attr]=this.value;let s=e.type.create(t,e.content,e.marks);return dt.ok(s)}getMap(){return Kt.empty}invert(e){return new mr(this.attr,e.attrs[this.attr])}map(e){return this}toJSON(){return{stepType:"docAttr",attr:this.attr,value:this.value}}static fromJSON(e,t){if(typeof t.attr!="string")throw new RangeError("Invalid input for DocAttrStep.fromJSON");return new mr(t.attr,t.value)}}At.jsonID("docAttr",mr);let Di=class extends Error{};Di=function n(e){let t=Error.call(this,e);return t.__proto__=n.prototype,t};Di.prototype=Object.create(Error.prototype);Di.prototype.constructor=Di;Di.prototype.name="TransformError";class vk{constructor(e){this.doc=e,this.steps=[],this.docs=[],this.mapping=new bi}get before(){return this.docs.length?this.docs[0]:this.doc}step(e){let t=this.maybeStep(e);if(t.failed)throw new Di(t.failed);return this}maybeStep(e){let t=e.apply(this.doc);return t.failed||this.addStep(e,t.doc),t}get docChanged(){return this.steps.length>0}addStep(e,t){this.docs.push(this.doc),this.steps.push(e),this.mapping.appendMap(e.getMap()),this.doc=t}replace(e,t=e,s=X.empty){let i=rc(this.doc,e,t,s);return i&&this.step(i),this}replaceWith(e,t,s){return this.replace(e,t,new X(q.from(s),0,0))}delete(e,t){return this.replace(e,t,X.empty)}insert(e,t){return this.replaceWith(e,e,t)}replaceRange(e,t,s){return kk(this,e,t,s),this}replaceRangeWith(e,t,s){return Ck(this,e,t,s),this}deleteRange(e,t){return Mk(this,e,t),this}lift(e,t){return ik(this,e,t),this}join(e,t=1){return gk(this,e,t),this}wrap(e,t){return lk(this,e,t),this}setBlockType(e,t=e,s,i=null){return ck(this,e,t,s,i),this}setNodeMarkup(e,t,s=null,i){return fk(this,e,t,s,i),this}setNodeAttribute(e,t,s){return this.step(new wi(e,t,s)),this}setDocAttribute(e,t){return this.step(new mr(e,t)),this}addNodeMark(e,t){return this.step(new ys(e,t)),this}removeNodeMark(e,t){if(!(t instanceof Pe)){let s=this.doc.nodeAt(e);if(!s)throw new RangeError("No node at position "+e);if(t=t.isInSet(s.marks),!t)return this}return this.step(new Ri(e,t)),this}split(e,t=1,s){return pk(this,e,t,s),this}addMark(e,t,s){return tk(this,e,t,s),this}removeMark(e,t,s){return nk(this,e,t,s),this}clearIncompatible(e,t,s){return Jf(this,e,t,s),this}}const ga=Object.create(null);class _e{constructor(e,t,s){this.$anchor=e,this.$head=t,this.ranges=s||[new Tk(e.min(t),e.max(t))]}get anchor(){return this.$anchor.pos}get head(){return this.$head.pos}get from(){return this.$from.pos}get to(){return this.$to.pos}get $from(){return this.ranges[0].$from}get $to(){return this.ranges[0].$to}get empty(){let e=this.ranges;for(let t=0;t<e.length;t++)if(e[t].$from.pos!=e[t].$to.pos)return!1;return!0}content(){return this.$from.doc.slice(this.from,this.to,!0)}replace(e,t=X.empty){let s=t.content.lastChild,i=null;for(let a=0;a<t.openEnd;a++)i=s,s=s.lastChild;let r=e.steps.length,o=this.ranges;for(let a=0;a<o.length;a++){let{$from:l,$to:d}=o[a],u=e.mapping.slice(r);e.replaceRange(u.map(l.pos),u.map(d.pos),a?X.empty:t),a==0&&vd(e,r,(s?s.isInline:i&&i.isTextblock)?-1:1)}}replaceWith(e,t){let s=e.steps.length,i=this.ranges;for(let r=0;r<i.length;r++){let{$from:o,$to:a}=i[r],l=e.mapping.slice(s),d=l.map(o.pos),u=l.map(a.pos);r?e.deleteRange(d,u):(e.replaceRangeWith(d,u,t),vd(e,s,t.isInline?-1:1))}}static findFrom(e,t,s=!1){let i=e.parent.inlineContent?new Le(e):gi(e.node(0),e.parent,e.pos,e.index(),t,s);if(i)return i;for(let r=e.depth-1;r>=0;r--){let o=t<0?gi(e.node(0),e.node(r),e.before(r+1),e.index(r),t,s):gi(e.node(0),e.node(r),e.after(r+1),e.index(r)+1,t,s);if(o)return o}return null}static near(e,t=1){return this.findFrom(e,t)||this.findFrom(e,-t)||new Qt(e.node(0))}static atStart(e){return gi(e,e,0,0,1)||new Qt(e)}static atEnd(e){return gi(e,e,e.content.size,e.childCount,-1)||new Qt(e)}static fromJSON(e,t){if(!t||!t.type)throw new RangeError("Invalid input for Selection.fromJSON");let s=ga[t.type];if(!s)throw new RangeError(`No selection type ${t.type} defined`);return s.fromJSON(e,t)}static jsonID(e,t){if(e in ga)throw new RangeError("Duplicate use of selection JSON ID "+e);return ga[e]=t,t.prototype.jsonID=e,t}getBookmark(){return Le.between(this.$anchor,this.$head).getBookmark()}}_e.prototype.visible=!0;class Tk{constructor(e,t){this.$from=e,this.$to=t}}let Cd=!1;function Md(n){!Cd&&!n.parent.inlineContent&&(Cd=!0,console.warn("TextSelection endpoint not pointing into a node with inline content ("+n.parent.type.name+")"))}class Le extends _e{constructor(e,t=e){Md(e),Md(t),super(e,t)}get $cursor(){return this.$anchor.pos==this.$head.pos?this.$head:null}map(e,t){let s=e.resolve(t.map(this.head));if(!s.parent.inlineContent)return _e.near(s);let i=e.resolve(t.map(this.anchor));return new Le(i.parent.inlineContent?i:s,s)}replace(e,t=X.empty){if(super.replace(e,t),t==X.empty){let s=this.$from.marksAcross(this.$to);s&&e.ensureMarks(s)}}eq(e){return e instanceof Le&&e.anchor==this.anchor&&e.head==this.head}getBookmark(){return new Yo(this.anchor,this.head)}toJSON(){return{type:"text",anchor:this.anchor,head:this.head}}static fromJSON(e,t){if(typeof t.anchor!="number"||typeof t.head!="number")throw new RangeError("Invalid input for TextSelection.fromJSON");return new Le(e.resolve(t.anchor),e.resolve(t.head))}static create(e,t,s=t){let i=e.resolve(t);return new this(i,s==t?i:e.resolve(s))}static between(e,t,s){let i=e.pos-t.pos;if((!s||i)&&(s=i>=0?1:-1),!t.parent.inlineContent){let r=_e.findFrom(t,s,!0)||_e.findFrom(t,-s,!0);if(r)t=r.$head;else return _e.near(t,s)}return e.parent.inlineContent||(i==0?e=t:(e=(_e.findFrom(e,-s,!0)||_e.findFrom(e,s,!0)).$anchor,e.pos<t.pos!=i<0&&(e=t))),new Le(e,t)}}_e.jsonID("text",Le);class Yo{constructor(e,t){this.anchor=e,this.head=t}map(e){return new Yo(e.map(this.anchor),e.map(this.head))}resolve(e){return Le.between(e.resolve(this.anchor),e.resolve(this.head))}}class fe extends _e{constructor(e){let t=e.nodeAfter,s=e.node(0).resolve(e.pos+t.nodeSize);super(e,s),this.node=t}map(e,t){let{deleted:s,pos:i}=t.mapResult(this.anchor),r=e.resolve(i);return s?_e.near(r):new fe(r)}content(){return new X(q.from(this.node),0,0)}eq(e){return e instanceof fe&&e.anchor==this.anchor}toJSON(){return{type:"node",anchor:this.anchor}}getBookmark(){return new oc(this.anchor)}static fromJSON(e,t){if(typeof t.anchor!="number")throw new RangeError("Invalid input for NodeSelection.fromJSON");return new fe(e.resolve(t.anchor))}static create(e,t){return new fe(e.resolve(t))}static isSelectable(e){return!e.isText&&e.type.spec.selectable!==!1}}fe.prototype.visible=!1;_e.jsonID("node",fe);class oc{constructor(e){this.anchor=e}map(e){let{deleted:t,pos:s}=e.mapResult(this.anchor);return t?new Yo(s,s):new oc(s)}resolve(e){let t=e.resolve(this.anchor),s=t.nodeAfter;return s&&fe.isSelectable(s)?new fe(t):_e.near(t)}}class Qt extends _e{constructor(e){super(e.resolve(0),e.resolve(e.content.size))}replace(e,t=X.empty){if(t==X.empty){e.delete(0,e.doc.content.size);let s=_e.atStart(e.doc);s.eq(e.selection)||e.setSelection(s)}else super.replace(e,t)}toJSON(){return{type:"all"}}static fromJSON(e){return new Qt(e)}map(e){return new Qt(e)}eq(e){return e instanceof Qt}getBookmark(){return Ek}}_e.jsonID("all",Qt);const Ek={map(){return this},resolve(n){return new Qt(n)}};function gi(n,e,t,s,i,r=!1){if(e.inlineContent)return Le.create(n,t);for(let o=s-(i>0?0:1);i>0?o<e.childCount:o>=0;o+=i){let a=e.child(o);if(a.isAtom){if(!r&&fe.isSelectable(a))return fe.create(n,t-(i<0?a.nodeSize:0))}else{let l=gi(n,a,t+i,i<0?a.childCount:0,i,r);if(l)return l}t+=a.nodeSize*i}return null}function vd(n,e,t){let s=n.steps.length-1;if(s<e)return;let i=n.steps[s];if(!(i instanceof Et||i instanceof Yt))return;let r=n.mapping.maps[s],o;r.forEach((a,l,d,u)=>{o==null&&(o=u)}),n.setSelection(_e.near(n.doc.resolve(o),t))}const Td=1,Wr=2,Ed=4;class _k extends vk{constructor(e){super(e.doc),this.curSelectionFor=0,this.updated=0,this.meta=Object.create(null),this.time=Date.now(),this.curSelection=e.selection,this.storedMarks=e.storedMarks}get selection(){return this.curSelectionFor<this.steps.length&&(this.curSelection=this.curSelection.map(this.doc,this.mapping.slice(this.curSelectionFor)),this.curSelectionFor=this.steps.length),this.curSelection}setSelection(e){if(e.$from.doc!=this.doc)throw new RangeError("Selection passed to setSelection must point at the current document");return this.curSelection=e,this.curSelectionFor=this.steps.length,this.updated=(this.updated|Td)&~Wr,this.storedMarks=null,this}get selectionSet(){return(this.updated&Td)>0}setStoredMarks(e){return this.storedMarks=e,this.updated|=Wr,this}ensureMarks(e){return Pe.sameSet(this.storedMarks||this.selection.$from.marks(),e)||this.setStoredMarks(e),this}addStoredMark(e){return this.ensureMarks(e.addToSet(this.storedMarks||this.selection.$head.marks()))}removeStoredMark(e){return this.ensureMarks(e.removeFromSet(this.storedMarks||this.selection.$head.marks()))}get storedMarksSet(){return(this.updated&Wr)>0}addStep(e,t){super.addStep(e,t),this.updated=this.updated&~Wr,this.storedMarks=null}setTime(e){return this.time=e,this}replaceSelection(e){return this.selection.replace(this,e),this}replaceSelectionWith(e,t=!0){let s=this.selection;return t&&(e=e.mark(this.storedMarks||(s.empty?s.$from.marks():s.$from.marksAcross(s.$to)||Pe.none))),s.replaceWith(this,e),this}deleteSelection(){return this.selection.replace(this),this}insertText(e,t,s){let i=this.doc.type.schema;if(t==null)return e?this.replaceSelectionWith(i.text(e),!0):this.deleteSelection();{if(s==null&&(s=t),s=s??t,!e)return this.deleteRange(t,s);let r=this.storedMarks;if(!r){let o=this.doc.resolve(t);r=s==t?o.marks():o.marksAcross(this.doc.resolve(s))}return this.replaceRangeWith(t,s,i.text(e,r)),this.selection.empty||this.setSelection(_e.near(this.selection.$to)),this}}setMeta(e,t){return this.meta[typeof e=="string"?e:e.key]=t,this}getMeta(e){return this.meta[typeof e=="string"?e:e.key]}get isGeneric(){for(let e in this.meta)return!1;return!0}scrollIntoView(){return this.updated|=Ed,this}get scrolledIntoView(){return(this.updated&Ed)>0}}function _d(n,e){return!e||!n?n:n.bind(e)}class Qi{constructor(e,t,s){this.name=e,this.init=_d(t.init,s),this.apply=_d(t.apply,s)}}const Nk=[new Qi("doc",{init(n){return n.doc||n.schema.topNodeType.createAndFill()},apply(n){return n.doc}}),new Qi("selection",{init(n,e){return n.selection||_e.atStart(e.doc)},apply(n){return n.selection}}),new Qi("storedMarks",{init(n){return n.storedMarks||null},apply(n,e,t,s){return s.selection.$cursor?n.storedMarks:null}}),new Qi("scrollToSelection",{init(){return 0},apply(n,e){return n.scrolledIntoView?e+1:e}})];class ya{constructor(e,t){this.schema=e,this.plugins=[],this.pluginsByKey=Object.create(null),this.fields=Nk.slice(),t&&t.forEach(s=>{if(this.pluginsByKey[s.key])throw new RangeError("Adding different instances of a keyed plugin ("+s.key+")");this.plugins.push(s),this.pluginsByKey[s.key]=s,s.spec.state&&this.fields.push(new Qi(s.key,s.spec.state,s))})}}class xi{constructor(e){this.config=e}get schema(){return this.config.schema}get plugins(){return this.config.plugins}apply(e){return this.applyTransaction(e).state}filterTransaction(e,t=-1){for(let s=0;s<this.config.plugins.length;s++)if(s!=t){let i=this.config.plugins[s];if(i.spec.filterTransaction&&!i.spec.filterTransaction.call(i,e,this))return!1}return!0}applyTransaction(e){if(!this.filterTransaction(e))return{state:this,transactions:[]};let t=[e],s=this.applyInner(e),i=null;for(;;){let r=!1;for(let o=0;o<this.config.plugins.length;o++){let a=this.config.plugins[o];if(a.spec.appendTransaction){let l=i?i[o].n:0,d=i?i[o].state:this,u=l<t.length&&a.spec.appendTransaction.call(a,l?t.slice(l):t,d,s);if(u&&s.filterTransaction(u,o)){if(u.setMeta("appendedTransaction",e),!i){i=[];for(let p=0;p<this.config.plugins.length;p++)i.push(p<o?{state:s,n:t.length}:{state:this,n:0})}t.push(u),s=s.applyInner(u),r=!0}i&&(i[o]={state:s,n:t.length})}}if(!r)return{state:s,transactions:t}}}applyInner(e){if(!e.before.eq(this.doc))throw new RangeError("Applying a mismatched transaction");let t=new xi(this.config),s=this.config.fields;for(let i=0;i<s.length;i++){let r=s[i];t[r.name]=r.apply(e,this[r.name],this,t)}return t}get tr(){return new _k(this)}static create(e){let t=new ya(e.doc?e.doc.type.schema:e.schema,e.plugins),s=new xi(t);for(let i=0;i<t.fields.length;i++)s[t.fields[i].name]=t.fields[i].init(e,s);return s}reconfigure(e){let t=new ya(this.schema,e.plugins),s=t.fields,i=new xi(t);for(let r=0;r<s.length;r++){let o=s[r].name;i[o]=this.hasOwnProperty(o)?this[o]:s[r].init(e,i)}return i}toJSON(e){let t={doc:this.doc.toJSON(),selection:this.selection.toJSON()};if(this.storedMarks&&(t.storedMarks=this.storedMarks.map(s=>s.toJSON())),e&&typeof e=="object")for(let s in e){if(s=="doc"||s=="selection")throw new RangeError("The JSON fields `doc` and `selection` are reserved");let i=e[s],r=i.spec.state;r&&r.toJSON&&(t[s]=r.toJSON.call(i,this[i.key]))}return t}static fromJSON(e,t,s){if(!t)throw new RangeError("Invalid input for EditorState.fromJSON");if(!e.schema)throw new RangeError("Required config field 'schema' missing");let i=new ya(e.schema,e.plugins),r=new xi(i);return i.fields.forEach(o=>{if(o.name=="doc")r.doc=An.fromJSON(e.schema,t.doc);else if(o.name=="selection")r.selection=_e.fromJSON(r.doc,t.selection);else if(o.name=="storedMarks")t.storedMarks&&(r.storedMarks=t.storedMarks.map(e.schema.markFromJSON));else{if(s)for(let a in s){let l=s[a],d=l.spec.state;if(l.key==o.name&&d&&d.fromJSON&&Object.prototype.hasOwnProperty.call(t,a)){r[o.name]=d.fromJSON.call(l,e,t[a],r);return}}r[o.name]=o.init(e,r)}}),r}}function tp(n,e,t){for(let s in n){let i=n[s];i instanceof Function?i=i.bind(e):s=="handleDOMEvents"&&(i=tp(i,e,{})),t[s]=i}return t}class Ts{constructor(e){this.spec=e,this.props={},e.props&&tp(e.props,this,this.props),this.key=e.key?e.key.key:np("plugin")}getState(e){return e[this.key]}}const xa=Object.create(null);function np(n){return n in xa?n+"$"+ ++xa[n]:(xa[n]=0,n+"$")}class ii{constructor(e="key"){this.key=np(e)}get(e){return e.config.pluginsByKey[this.key]}getState(e){return e[this.key]}}const sp=new ii("transactionEventPlugin"),Qa="prosemirrorDispatchTransaction";function Nd(n,e){const{eventTarget:t}=sp.getState(n.state);return t.addEventListener(Qa,e),()=>{t.removeEventListener(Qa,e)}}function Ik(n){return new Ts({key:sp,state:{init(){return{eventTarget:n}},apply(e,t){return t}}})}const to=new ii("customKeymapPlugin");function Ak(n,e){n.dispatch(n.state.tr.setMeta(to,{handlers:e}))}function Rk(n={handlers:{}}){return new Ts({key:to,state:{init(){return{...n}},apply(e,t){const s=e.getMeta(to);return s?{...t,...s}:t}},props:{handleKeyDown(e,t){const i=to.getState(e.state).handlers[t.key];return i?i(t):!1}}})}const ip=(n,e)=>n.selection.empty?!1:(e&&e(n.tr.deleteSelection().scrollIntoView()),!0);function Dk(n,e){let{$cursor:t}=n.selection;return!t||(e?!e.endOfTextblock("backward",n):t.parentOffset>0)?null:t}const jk=(n,e,t)=>{let s=Dk(n,t);if(!s)return!1;let i=rp(s);if(!i){let o=s.blockRange(),a=o&&ic(o);return a==null?!1:(e&&e(n.tr.lift(o,a).scrollIntoView()),!0)}let r=i.nodeBefore;if(!r.type.spec.isolating&&dp(n,i,e))return!0;if(s.parent.content.size==0&&(ji(r,"end")||fe.isSelectable(r))){let o=rc(n.doc,s.before(),s.after(),X.empty);if(o&&o.slice.size<o.to-o.from){if(e){let a=n.tr.step(o);a.setSelection(ji(r,"end")?_e.findFrom(a.doc.resolve(a.mapping.map(i.pos,-1)),-1):fe.create(a.doc,i.pos-r.nodeSize)),e(a.scrollIntoView())}return!0}}return r.isAtom&&i.depth==s.depth-1?(e&&e(n.tr.delete(i.pos-r.nodeSize,i.pos).scrollIntoView()),!0):!1};function ji(n,e,t=!1){for(let s=n;s;s=e=="start"?s.firstChild:s.lastChild){if(s.isTextblock)return!0;if(t&&s.childCount!=1)return!1}return!1}const Ok=(n,e,t)=>{let{$head:s,empty:i}=n.selection,r=s;if(!i)return!1;if(s.parent.isTextblock){if(t?!t.endOfTextblock("backward",n):s.parentOffset>0)return!1;r=rp(s)}let o=r&&r.nodeBefore;return!o||!fe.isSelectable(o)?!1:(e&&e(n.tr.setSelection(fe.create(n.doc,r.pos-o.nodeSize)).scrollIntoView()),!0)};function rp(n){if(!n.parent.type.spec.isolating)for(let e=n.depth-1;e>=0;e--){if(n.index(e)>0)return n.doc.resolve(n.before(e+1));if(n.node(e).type.spec.isolating)break}return null}function Pk(n,e){let{$cursor:t}=n.selection;return!t||(e?!e.endOfTextblock("forward",n):t.parentOffset<t.parent.content.size)?null:t}const Fk=(n,e,t)=>{let s=Pk(n,t);if(!s)return!1;let i=op(s);if(!i)return!1;let r=i.nodeAfter;if(dp(n,i,e))return!0;if(s.parent.content.size==0&&(ji(r,"start")||fe.isSelectable(r))){let o=rc(n.doc,s.before(),s.after(),X.empty);if(o&&o.slice.size<o.to-o.from){if(e){let a=n.tr.step(o);a.setSelection(ji(r,"start")?_e.findFrom(a.doc.resolve(a.mapping.map(i.pos)),1):fe.create(a.doc,a.mapping.map(i.pos))),e(a.scrollIntoView())}return!0}}return r.isAtom&&i.depth==s.depth-1?(e&&e(n.tr.delete(i.pos,i.pos+r.nodeSize).scrollIntoView()),!0):!1},Bk=(n,e,t)=>{let{$head:s,empty:i}=n.selection,r=s;if(!i)return!1;if(s.parent.isTextblock){if(t?!t.endOfTextblock("forward",n):s.parentOffset<s.parent.content.size)return!1;r=op(s)}let o=r&&r.nodeAfter;return!o||!fe.isSelectable(o)?!1:(e&&e(n.tr.setSelection(fe.create(n.doc,r.pos)).scrollIntoView()),!0)};function op(n){if(!n.parent.type.spec.isolating)for(let e=n.depth-1;e>=0;e--){let t=n.node(e);if(n.index(e)+1<t.childCount)return n.doc.resolve(n.after(e+1));if(t.type.spec.isolating)break}return null}const Lk=(n,e)=>{let{$head:t,$anchor:s}=n.selection;return!t.parent.type.spec.code||!t.sameParent(s)?!1:(e&&e(n.tr.insertText(`
`).scrollIntoView()),!0)};function ac(n){for(let e=0;e<n.edgeCount;e++){let{type:t}=n.edge(e);if(t.isTextblock&&!t.hasRequiredAttrs())return t}return null}const zk=(n,e)=>{let{$head:t,$anchor:s}=n.selection;if(!t.parent.type.spec.code||!t.sameParent(s))return!1;let i=t.node(-1),r=t.indexAfter(-1),o=ac(i.contentMatchAt(r));if(!o||!i.canReplaceWith(r,r,o))return!1;if(e){let a=t.after(),l=n.tr.replaceWith(a,a,o.createAndFill());l.setSelection(_e.near(l.doc.resolve(a),1)),e(l.scrollIntoView())}return!0},ap=(n,e)=>{let t=n.selection,{$from:s,$to:i}=t;if(t instanceof Qt||s.parent.inlineContent||i.parent.inlineContent)return!1;let r=ac(i.parent.contentMatchAt(i.indexAfter()));if(!r||!r.isTextblock)return!1;if(e){let o=(!s.parentOffset&&i.index()<i.parent.childCount?s:i).pos,a=n.tr.insert(o,r.createAndFill());a.setSelection(Le.create(a.doc,o+1)),e(a.scrollIntoView())}return!0},lp=(n,e)=>{let{$cursor:t}=n.selection;if(!t||t.parent.content.size)return!1;if(t.depth>1&&t.after()!=t.end(-1)){let r=t.before();if(eo(n.doc,r))return e&&e(n.tr.split(r).scrollIntoView()),!0}let s=t.blockRange(),i=s&&ic(s);return i==null?!1:(e&&e(n.tr.lift(s,i).scrollIntoView()),!0)};function Uk(n){return(e,t)=>{let{$from:s,$to:i}=e.selection;if(e.selection instanceof fe&&e.selection.node.isBlock)return!s.parentOffset||!eo(e.doc,s.pos)?!1:(t&&t(e.tr.split(s.pos).scrollIntoView()),!0);if(!s.parent.isBlock)return!1;if(t){let r=i.parentOffset==i.parent.content.size,o=e.tr;(e.selection instanceof Le||e.selection instanceof Qt)&&o.deleteSelection();let a=s.depth==0?null:ac(s.node(-1).contentMatchAt(s.indexAfter(-1))),l=r&&a?[{type:a}]:void 0,d=eo(o.doc,o.mapping.map(s.pos),1,l);if(!l&&!d&&eo(o.doc,o.mapping.map(s.pos),1,a?[{type:a}]:void 0)&&(a&&(l=[{type:a}]),d=!0),d&&(o.split(o.mapping.map(s.pos),1,l),!r&&!s.parentOffset&&s.parent.type!=a)){let u=o.mapping.map(s.before()),p=o.doc.resolve(u);a&&s.node(-1).canReplaceWith(p.index(),p.index()+1,a)&&o.setNodeMarkup(o.mapping.map(s.before()),a)}t(o.scrollIntoView())}return!0}}const cp=Uk(),Vk=(n,e)=>(e&&e(n.tr.setSelection(new Qt(n.doc))),!0);function Wk(n,e,t){let s=e.nodeBefore,i=e.nodeAfter,r=e.index();return!s||!i||!s.type.compatibleContent(i.type)?!1:!s.content.size&&e.parent.canReplace(r-1,r)?(t&&t(n.tr.delete(e.pos-s.nodeSize,e.pos).scrollIntoView()),!0):!e.parent.canReplace(r,r+1)||!(i.isTextblock||Yf(n.doc,e.pos))?!1:(t&&t(n.tr.clearIncompatible(e.pos,s.type,s.contentMatchAt(s.childCount)).join(e.pos).scrollIntoView()),!0)}function dp(n,e,t){let s=e.nodeBefore,i=e.nodeAfter,r,o;if(s.type.spec.isolating||i.type.spec.isolating)return!1;if(Wk(n,e,t))return!0;let a=e.parent.canReplace(e.index(),e.index()+1);if(a&&(r=(o=s.contentMatchAt(s.childCount)).findWrapping(i.type))&&o.matchType(r[0]||i.type).validEnd){if(t){let p=e.pos+i.nodeSize,m=q.empty;for(let y=r.length-1;y>=0;y--)m=q.from(r[y].create(null,m));m=q.from(s.copy(m));let b=n.tr.step(new Yt(e.pos-1,p,e.pos,p,new X(m,1,0),r.length,!0)),g=p+2*r.length;Yf(b.doc,g)&&b.join(g),t(b.scrollIntoView())}return!0}let l=_e.findFrom(e,1),d=l&&l.$from.blockRange(l.$to),u=d&&ic(d);if(u!=null&&u>=e.depth)return t&&t(n.tr.lift(d,u).scrollIntoView()),!0;if(a&&ji(i,"start",!0)&&ji(s,"end")){let p=s,m=[];for(;m.push(p),!p.isTextblock;)p=p.lastChild;let b=i,g=1;for(;!b.isTextblock;b=b.firstChild)g++;if(p.canReplace(p.childCount,p.childCount,b.content)){if(t){let y=q.empty;for(let M=m.length-1;M>=0;M--)y=q.from(m[M].copy(y));let C=n.tr.step(new Yt(e.pos-m.length,e.pos+i.nodeSize,e.pos+g,e.pos+i.nodeSize-g,new X(y,m.length,0),0,!0));t(C.scrollIntoView())}return!0}}return!1}function up(n){return function(e,t){let s=e.selection,i=n<0?s.$from:s.$to,r=i.depth;for(;i.node(r).isInline;){if(!r)return!1;r--}return i.node(r).isTextblock?(t&&t(e.tr.setSelection(Le.create(e.doc,n<0?i.start(r):i.end(r)))),!0):!1}}const Gk=up(-1),qk=up(1);function x_(n,e=null){return function(t,s){let{$from:i,$to:r}=t.selection,o=i.blockRange(r),a=o&&rk(o,n,e);return a?(s&&s(t.tr.wrap(o,a).scrollIntoView()),!0):!1}}function b_(n,e=null){return function(t,s){let i=!1;for(let r=0;r<t.selection.ranges.length&&!i;r++){let{$from:{pos:o},$to:{pos:a}}=t.selection.ranges[r];t.doc.nodesBetween(o,a,(l,d)=>{if(i)return!1;if(!(!l.isTextblock||l.hasMarkup(n,e)))if(l.type==n)i=!0;else{let u=t.doc.resolve(d),p=u.index();i=u.parent.canReplaceWith(p,p+1,n)}})}if(!i)return!1;if(s){let r=t.tr;for(let o=0;o<t.selection.ranges.length;o++){let{$from:{pos:a},$to:{pos:l}}=t.selection.ranges[o];r.setBlockType(a,l,n,e)}s(r.scrollIntoView())}return!0}}function Hk(n,e,t){for(let s=0;s<e.length;s++){let{$from:i,$to:r}=e[s],o=i.depth==0?n.inlineContent&&n.type.allowsMarkType(t):!1;if(n.nodesBetween(i.pos,r.pos,a=>{if(o)return!1;o=a.inlineContent&&a.type.allowsMarkType(t)}),o)return!0}return!1}function w_(n,e=null){return function(t,s){let{empty:i,$cursor:r,ranges:o}=t.selection;if(i&&!r||!Hk(t.doc,o,n))return!1;if(s)if(r)n.isInSet(t.storedMarks||r.marks())?s(t.tr.removeStoredMark(n)):s(t.tr.addStoredMark(n.create(e)));else{let a=!1,l=t.tr;for(let d=0;!a&&d<o.length;d++){let{$from:u,$to:p}=o[d];a=t.doc.rangeHasMark(u.pos,p.pos,n)}for(let d=0;d<o.length;d++){let{$from:u,$to:p}=o[d];if(a)l.removeMark(u.pos,p.pos,n);else{let m=u.pos,b=p.pos,g=u.nodeAfter,y=p.nodeBefore,C=g&&g.isText?/^\s*/.exec(g.text)[0].length:0,M=y&&y.isText?/\s*$/.exec(y.text)[0].length:0;m+C<b&&(m+=C,b-=M),l.addMark(m,b,n.create(e))}}s(l.scrollIntoView())}return!0}}function Qo(...n){return function(e,t,s){for(let i=0;i<n.length;i++)if(n[i](e,t,s))return!0;return!1}}let ba=Qo(ip,jk,Ok),Id=Qo(ip,Fk,Bk);const $n={Enter:Qo(Lk,ap,lp,cp),"Mod-Enter":zk,Backspace:ba,"Mod-Backspace":ba,"Shift-Backspace":ba,Delete:Id,"Mod-Delete":Id,"Mod-a":Vk},hp={"Ctrl-h":$n.Backspace,"Alt-Backspace":$n["Mod-Backspace"],"Ctrl-d":$n.Delete,"Ctrl-Alt-Backspace":$n["Mod-Delete"],"Alt-Delete":$n["Mod-Delete"],"Alt-d":$n["Mod-Delete"],"Ctrl-a":Gk,"Ctrl-e":qk};for(let n in $n)hp[n]=$n[n];const $k=typeof navigator<"u"?/Mac|iP(hone|[oa]d)/.test(navigator.platform):typeof os<"u"&&os.platform?os.platform()=="darwin":!1,Kk=$k?hp:$n;function fp(n){let e="",t=!1;function s(i){if(t=!1,i.type.name==="paragraph")return i.descendants(r=>s(r)),e+=`
`,t=!0,!1;i.isText&&(e+=i.text)}return n.descendants(i=>s(i)),t&&e.endsWith(`
`)&&(e=e.slice(0,-1)),e}function Jk(n){return fp(n.state.doc)}const Xa=Qo(ap,lp,cp);async function Yk(n,e){e.split(`
`).forEach((t,s)=>{s!==0&&Xa(n.state,n.dispatch),n.dispatch(n.state.tr.insertText(t))})}const Si=new ii("menuSelectorPlugin");function Qk(n){n.dispatch(n.state.tr.setMeta(Si,{active:!1,onMenuAction:void 0}))}function Xk(n,e){n.dispatch(n.state.tr.setMeta(Si,{active:!0,onMenuAction:e}))}function Zk(n={submitKeys:["Enter","Tab"],cancelKeys:["Escape"],checkStrictMatchKeys:[]}){return new Ts({key:Si,state:{init(){return{...n,active:!1}},apply(e,t){const s=e.getMeta(Si);return s?{...t,...s}:t}},props:{handleKeyDown(e,t){var i,r,o,a,l;const s=Si.getState(e.state);return s.active?s.submitKeys.includes(t.key)?(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),(i=s.onMenuAction)==null||i.call(s,"submit"),Qk(e),!0):s.cancelKeys.includes(t.key)?(t.preventDefault(),(r=s.onMenuAction)==null||r.call(s,"cancel"),Xk(e,s.onMenuAction),!0):t.key==="ArrowUp"?(t.preventDefault(),(o=s.onMenuAction)==null||o.call(s,"up"),!0):t.key==="ArrowDown"?(t.preventDefault(),(a=s.onMenuAction)==null||a.call(s,"down"),!0):(s.checkStrictMatchKeys.includes(t.key)&&((l=s.onMenuAction)==null||l.call(s,"checkMatch")),!1):!1}}})}const bt=function(n){for(var e=0;;e++)if(n=n.previousSibling,!n)return e},gr=function(n){let e=n.assignedSlot||n.parentNode;return e&&e.nodeType==11?e.host:e};let Za=null;const qn=function(n,e,t){let s=Za||(Za=document.createRange());return s.setEnd(n,t??n.nodeValue.length),s.setStart(n,e||0),s},eC=function(){Za=null},Zs=function(n,e,t,s){return t&&(Ad(n,e,t,s,-1)||Ad(n,e,t,s,1))},tC=/^(img|br|input|textarea|hr)$/i;function Ad(n,e,t,s,i){for(;;){if(n==t&&e==s)return!0;if(e==(i<0?0:_n(n))){let r=n.parentNode;if(!r||r.nodeType!=1||Ar(n)||tC.test(n.nodeName)||n.contentEditable=="false")return!1;e=bt(n)+(i<0?0:1),n=r}else if(n.nodeType==1){if(n=n.childNodes[e+(i<0?-1:0)],n.contentEditable=="false")return!1;e=i<0?_n(n):0}else return!1}}function _n(n){return n.nodeType==3?n.nodeValue.length:n.childNodes.length}function nC(n,e){for(;;){if(n.nodeType==3&&e)return n;if(n.nodeType==1&&e>0){if(n.contentEditable=="false")return null;n=n.childNodes[e-1],e=_n(n)}else if(n.parentNode&&!Ar(n))e=bt(n),n=n.parentNode;else return null}}function sC(n,e){for(;;){if(n.nodeType==3&&e<n.nodeValue.length)return n;if(n.nodeType==1&&e<n.childNodes.length){if(n.contentEditable=="false")return null;n=n.childNodes[e],e=0}else if(n.parentNode&&!Ar(n))e=bt(n)+1,n=n.parentNode;else return null}}function iC(n,e,t){for(let s=e==0,i=e==_n(n);s||i;){if(n==t)return!0;let r=bt(n);if(n=n.parentNode,!n)return!1;s=s&&r==0,i=i&&r==_n(n)}}function Ar(n){let e;for(let t=n;t&&!(e=t.pmViewDesc);t=t.parentNode);return e&&e.node&&e.node.isBlock&&(e.dom==n||e.contentDOM==n)}const Xo=function(n){return n.focusNode&&Zs(n.focusNode,n.focusOffset,n.anchorNode,n.anchorOffset)};function Ls(n,e){let t=document.createEvent("Event");return t.initEvent("keydown",!0,!0),t.keyCode=n,t.key=t.code=e,t}function rC(n){let e=n.activeElement;for(;e&&e.shadowRoot;)e=e.shadowRoot.activeElement;return e}function oC(n,e,t){if(n.caretPositionFromPoint)try{let s=n.caretPositionFromPoint(e,t);if(s)return{node:s.offsetNode,offset:s.offset}}catch{}if(n.caretRangeFromPoint){let s=n.caretRangeFromPoint(e,t);if(s)return{node:s.startContainer,offset:s.startOffset}}}const Dn=typeof navigator<"u"?navigator:null,Rd=typeof document<"u"?document:null,Es=Dn&&Dn.userAgent||"",el=/Edge\/(\d+)/.exec(Es),pp=/MSIE \d/.exec(Es),tl=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(Es),Ut=!!(pp||tl||el),ws=pp?document.documentMode:tl?+tl[1]:el?+el[1]:0,Cn=!Ut&&/gecko\/(\d+)/i.test(Es);Cn&&+(/Firefox\/(\d+)/.exec(Es)||[0,0])[1];const nl=!Ut&&/Chrome\/(\d+)/.exec(Es),Nt=!!nl,mp=nl?+nl[1]:0,Pt=!Ut&&!!Dn&&/Apple Computer/.test(Dn.vendor),Oi=Pt&&(/Mobile\/\w+/.test(Es)||!!Dn&&Dn.maxTouchPoints>2),sn=Oi||(Dn?/Mac/.test(Dn.platform):!1),aC=Dn?/Win/.test(Dn.platform):!1,wn=/Android \d/.test(Es),Rr=!!Rd&&"webkitFontSmoothing"in Rd.documentElement.style,lC=Rr?+(/\bAppleWebKit\/(\d+)/.exec(navigator.userAgent)||[0,0])[1]:0;function cC(n){let e=n.defaultView&&n.defaultView.visualViewport;return e?{left:0,right:e.width,top:0,bottom:e.height}:{left:0,right:n.documentElement.clientWidth,top:0,bottom:n.documentElement.clientHeight}}function Wn(n,e){return typeof n=="number"?n:n[e]}function dC(n){let e=n.getBoundingClientRect(),t=e.width/n.offsetWidth||1,s=e.height/n.offsetHeight||1;return{left:e.left,right:e.left+n.clientWidth*t,top:e.top,bottom:e.top+n.clientHeight*s}}function Dd(n,e,t){let s=n.someProp("scrollThreshold")||0,i=n.someProp("scrollMargin")||5,r=n.dom.ownerDocument;for(let o=t||n.dom;o;o=gr(o)){if(o.nodeType!=1)continue;let a=o,l=a==r.body,d=l?cC(r):dC(a),u=0,p=0;if(e.top<d.top+Wn(s,"top")?p=-(d.top-e.top+Wn(i,"top")):e.bottom>d.bottom-Wn(s,"bottom")&&(p=e.bottom-e.top>d.bottom-d.top?e.top+Wn(i,"top")-d.top:e.bottom-d.bottom+Wn(i,"bottom")),e.left<d.left+Wn(s,"left")?u=-(d.left-e.left+Wn(i,"left")):e.right>d.right-Wn(s,"right")&&(u=e.right-d.right+Wn(i,"right")),u||p)if(l)r.defaultView.scrollBy(u,p);else{let m=a.scrollLeft,b=a.scrollTop;p&&(a.scrollTop+=p),u&&(a.scrollLeft+=u);let g=a.scrollLeft-m,y=a.scrollTop-b;e={left:e.left-g,top:e.top-y,right:e.right-g,bottom:e.bottom-y}}if(l||/^(fixed|sticky)$/.test(getComputedStyle(o).position))break}}function uC(n){let e=n.dom.getBoundingClientRect(),t=Math.max(0,e.top),s,i;for(let r=(e.left+e.right)/2,o=t+1;o<Math.min(innerHeight,e.bottom);o+=5){let a=n.root.elementFromPoint(r,o);if(!a||a==n.dom||!n.dom.contains(a))continue;let l=a.getBoundingClientRect();if(l.top>=t-20){s=a,i=l.top;break}}return{refDOM:s,refTop:i,stack:gp(n.dom)}}function gp(n){let e=[],t=n.ownerDocument;for(let s=n;s&&(e.push({dom:s,top:s.scrollTop,left:s.scrollLeft}),n!=t);s=gr(s));return e}function hC({refDOM:n,refTop:e,stack:t}){let s=n?n.getBoundingClientRect().top:0;yp(t,s==0?0:s-e)}function yp(n,e){for(let t=0;t<n.length;t++){let{dom:s,top:i,left:r}=n[t];s.scrollTop!=i+e&&(s.scrollTop=i+e),s.scrollLeft!=r&&(s.scrollLeft=r)}}let fi=null;function fC(n){if(n.setActive)return n.setActive();if(fi)return n.focus(fi);let e=gp(n);n.focus(fi==null?{get preventScroll(){return fi={preventScroll:!0},!0}}:void 0),fi||(fi=!1,yp(e,0))}function xp(n,e){let t,s=2e8,i,r=0,o=e.top,a=e.top,l,d;for(let u=n.firstChild,p=0;u;u=u.nextSibling,p++){let m;if(u.nodeType==1)m=u.getClientRects();else if(u.nodeType==3)m=qn(u).getClientRects();else continue;for(let b=0;b<m.length;b++){let g=m[b];if(g.top<=o&&g.bottom>=a){o=Math.max(g.bottom,o),a=Math.min(g.top,a);let y=g.left>e.left?g.left-e.left:g.right<e.left?e.left-g.right:0;if(y<s){t=u,s=y,i=y&&t.nodeType==3?{left:g.right<e.left?g.right:g.left,top:e.top}:e,u.nodeType==1&&y&&(r=p+(e.left>=(g.left+g.right)/2?1:0));continue}}else g.top>e.top&&!l&&g.left<=e.left&&g.right>=e.left&&(l=u,d={left:Math.max(g.left,Math.min(g.right,e.left)),top:g.top});!t&&(e.left>=g.right&&e.top>=g.top||e.left>=g.left&&e.top>=g.bottom)&&(r=p+1)}}return!t&&l&&(t=l,i=d,s=0),t&&t.nodeType==3?pC(t,i):!t||s&&t.nodeType==1?{node:n,offset:r}:xp(t,i)}function pC(n,e){let t=n.nodeValue.length,s=document.createRange();for(let i=0;i<t;i++){s.setEnd(n,i+1),s.setStart(n,i);let r=as(s,1);if(r.top!=r.bottom&&lc(e,r))return{node:n,offset:i+(e.left>=(r.left+r.right)/2?1:0)}}return{node:n,offset:0}}function lc(n,e){return n.left>=e.left-1&&n.left<=e.right+1&&n.top>=e.top-1&&n.top<=e.bottom+1}function mC(n,e){let t=n.parentNode;return t&&/^li$/i.test(t.nodeName)&&e.left<n.getBoundingClientRect().left?t:n}function gC(n,e,t){let{node:s,offset:i}=xp(e,t),r=-1;if(s.nodeType==1&&!s.firstChild){let o=s.getBoundingClientRect();r=o.left!=o.right&&t.left>(o.left+o.right)/2?1:-1}return n.docView.posFromDOM(s,i,r)}function yC(n,e,t,s){let i=-1;for(let r=e,o=!1;r!=n.dom;){let a=n.docView.nearestDesc(r,!0);if(!a)return null;if(a.dom.nodeType==1&&(a.node.isBlock&&a.parent||!a.contentDOM)){let l=a.dom.getBoundingClientRect();if(a.node.isBlock&&a.parent&&(!o&&l.left>s.left||l.top>s.top?i=a.posBefore:(!o&&l.right<s.left||l.bottom<s.top)&&(i=a.posAfter),o=!0),!a.contentDOM&&i<0&&!a.node.isText)return(a.node.isBlock?s.top<(l.top+l.bottom)/2:s.left<(l.left+l.right)/2)?a.posBefore:a.posAfter}r=a.dom.parentNode}return i>-1?i:n.docView.posFromDOM(e,t,-1)}function bp(n,e,t){let s=n.childNodes.length;if(s&&t.top<t.bottom)for(let i=Math.max(0,Math.min(s-1,Math.floor(s*(e.top-t.top)/(t.bottom-t.top))-2)),r=i;;){let o=n.childNodes[r];if(o.nodeType==1){let a=o.getClientRects();for(let l=0;l<a.length;l++){let d=a[l];if(lc(e,d))return bp(o,e,d)}}if((r=(r+1)%s)==i)break}return n}function xC(n,e){let t=n.dom.ownerDocument,s,i=0,r=oC(t,e.left,e.top);r&&({node:s,offset:i}=r);let o=(n.root.elementFromPoint?n.root:t).elementFromPoint(e.left,e.top),a;if(!o||!n.dom.contains(o.nodeType!=1?o.parentNode:o)){let d=n.dom.getBoundingClientRect();if(!lc(e,d)||(o=bp(n.dom,e,d),!o))return null}if(Pt)for(let d=o;s&&d;d=gr(d))d.draggable&&(s=void 0);if(o=mC(o,e),s){if(Cn&&s.nodeType==1&&(i=Math.min(i,s.childNodes.length),i<s.childNodes.length)){let u=s.childNodes[i],p;u.nodeName=="IMG"&&(p=u.getBoundingClientRect()).right<=e.left&&p.bottom>e.top&&i++}let d;Rr&&i&&s.nodeType==1&&(d=s.childNodes[i-1]).nodeType==1&&d.contentEditable=="false"&&d.getBoundingClientRect().top>=e.top&&i--,s==n.dom&&i==s.childNodes.length-1&&s.lastChild.nodeType==1&&e.top>s.lastChild.getBoundingClientRect().bottom?a=n.state.doc.content.size:(i==0||s.nodeType!=1||s.childNodes[i-1].nodeName!="BR")&&(a=yC(n,s,i,e))}a==null&&(a=gC(n,o,e));let l=n.docView.nearestDesc(o,!0);return{pos:a,inside:l?l.posAtStart-l.border:-1}}function jd(n){return n.top<n.bottom||n.left<n.right}function as(n,e){let t=n.getClientRects();if(t.length){let s=t[e<0?0:t.length-1];if(jd(s))return s}return Array.prototype.find.call(t,jd)||n.getBoundingClientRect()}const bC=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/;function wp(n,e,t){let{node:s,offset:i,atom:r}=n.docView.domFromPos(e,t<0?-1:1),o=Rr||Cn;if(s.nodeType==3)if(o&&(bC.test(s.nodeValue)||(t<0?!i:i==s.nodeValue.length))){let l=as(qn(s,i,i),t);if(Cn&&i&&/\s/.test(s.nodeValue[i-1])&&i<s.nodeValue.length){let d=as(qn(s,i-1,i-1),-1);if(d.top==l.top){let u=as(qn(s,i,i+1),-1);if(u.top!=l.top)return Hi(u,u.left<d.left)}}return l}else{let l=i,d=i,u=t<0?1:-1;return t<0&&!i?(d++,u=-1):t>=0&&i==s.nodeValue.length?(l--,u=1):t<0?l--:d++,Hi(as(qn(s,l,d),u),u<0)}if(!n.state.doc.resolve(e-(r||0)).parent.inlineContent){if(r==null&&i&&(t<0||i==_n(s))){let l=s.childNodes[i-1];if(l.nodeType==1)return wa(l.getBoundingClientRect(),!1)}if(r==null&&i<_n(s)){let l=s.childNodes[i];if(l.nodeType==1)return wa(l.getBoundingClientRect(),!0)}return wa(s.getBoundingClientRect(),t>=0)}if(r==null&&i&&(t<0||i==_n(s))){let l=s.childNodes[i-1],d=l.nodeType==3?qn(l,_n(l)-(o?0:1)):l.nodeType==1&&(l.nodeName!="BR"||!l.nextSibling)?l:null;if(d)return Hi(as(d,1),!1)}if(r==null&&i<_n(s)){let l=s.childNodes[i];for(;l.pmViewDesc&&l.pmViewDesc.ignoreForCoords;)l=l.nextSibling;let d=l?l.nodeType==3?qn(l,0,o?0:1):l.nodeType==1?l:null:null;if(d)return Hi(as(d,-1),!0)}return Hi(as(s.nodeType==3?qn(s):s,-t),t>=0)}function Hi(n,e){if(n.width==0)return n;let t=e?n.left:n.right;return{top:n.top,bottom:n.bottom,left:t,right:t}}function wa(n,e){if(n.height==0)return n;let t=e?n.top:n.bottom;return{top:t,bottom:t,left:n.left,right:n.right}}function Sp(n,e,t){let s=n.state,i=n.root.activeElement;s!=e&&n.updateState(e),i!=n.dom&&n.focus();try{return t()}finally{s!=e&&n.updateState(s),i!=n.dom&&i&&i.focus()}}function wC(n,e,t){let s=e.selection,i=t=="up"?s.$from:s.$to;return Sp(n,e,()=>{let{node:r}=n.docView.domFromPos(i.pos,t=="up"?-1:1);for(;;){let a=n.docView.nearestDesc(r,!0);if(!a)break;if(a.node.isBlock){r=a.contentDOM||a.dom;break}r=a.dom.parentNode}let o=wp(n,i.pos,1);for(let a=r.firstChild;a;a=a.nextSibling){let l;if(a.nodeType==1)l=a.getClientRects();else if(a.nodeType==3)l=qn(a,0,a.nodeValue.length).getClientRects();else continue;for(let d=0;d<l.length;d++){let u=l[d];if(u.bottom>u.top+1&&(t=="up"?o.top-u.top>(u.bottom-o.top)*2:u.bottom-o.bottom>(o.bottom-u.top)*2))return!1}}return!0})}const SC=/[\u0590-\u08ac]/;function kC(n,e,t){let{$head:s}=e.selection;if(!s.parent.isTextblock)return!1;let i=s.parentOffset,r=!i,o=i==s.parent.content.size,a=n.domSelection();return!SC.test(s.parent.textContent)||!a.modify?t=="left"||t=="backward"?r:o:Sp(n,e,()=>{let{focusNode:l,focusOffset:d,anchorNode:u,anchorOffset:p}=n.domSelectionRange(),m=a.caretBidiLevel;a.modify("move",t,"character");let b=s.depth?n.docView.domAfterPos(s.before()):n.dom,{focusNode:g,focusOffset:y}=n.domSelectionRange(),C=g&&!b.contains(g.nodeType==1?g:g.parentNode)||l==g&&d==y;try{a.collapse(u,p),l&&(l!=u||d!=p)&&a.extend&&a.extend(l,d)}catch{}return m!=null&&(a.caretBidiLevel=m),C})}let Od=null,Pd=null,Fd=!1;function CC(n,e,t){return Od==e&&Pd==t?Fd:(Od=e,Pd=t,Fd=t=="up"||t=="down"?wC(n,e,t):kC(n,e,t))}const ln=0,Bd=1,Us=2,jn=3;class Dr{constructor(e,t,s,i){this.parent=e,this.children=t,this.dom=s,this.contentDOM=i,this.dirty=ln,s.pmViewDesc=this}matchesWidget(e){return!1}matchesMark(e){return!1}matchesNode(e,t,s){return!1}matchesHack(e){return!1}parseRule(){return null}stopEvent(e){return!1}get size(){let e=0;for(let t=0;t<this.children.length;t++)e+=this.children[t].size;return e}get border(){return 0}destroy(){this.parent=void 0,this.dom.pmViewDesc==this&&(this.dom.pmViewDesc=void 0);for(let e=0;e<this.children.length;e++)this.children[e].destroy()}posBeforeChild(e){for(let t=0,s=this.posAtStart;;t++){let i=this.children[t];if(i==e)return s;s+=i.size}}get posBefore(){return this.parent.posBeforeChild(this)}get posAtStart(){return this.parent?this.parent.posBeforeChild(this)+this.border:0}get posAfter(){return this.posBefore+this.size}get posAtEnd(){return this.posAtStart+this.size-2*this.border}localPosFromDOM(e,t,s){if(this.contentDOM&&this.contentDOM.contains(e.nodeType==1?e:e.parentNode))if(s<0){let r,o;if(e==this.contentDOM)r=e.childNodes[t-1];else{for(;e.parentNode!=this.contentDOM;)e=e.parentNode;r=e.previousSibling}for(;r&&!((o=r.pmViewDesc)&&o.parent==this);)r=r.previousSibling;return r?this.posBeforeChild(o)+o.size:this.posAtStart}else{let r,o;if(e==this.contentDOM)r=e.childNodes[t];else{for(;e.parentNode!=this.contentDOM;)e=e.parentNode;r=e.nextSibling}for(;r&&!((o=r.pmViewDesc)&&o.parent==this);)r=r.nextSibling;return r?this.posBeforeChild(o):this.posAtEnd}let i;if(e==this.dom&&this.contentDOM)i=t>bt(this.contentDOM);else if(this.contentDOM&&this.contentDOM!=this.dom&&this.dom.contains(this.contentDOM))i=e.compareDocumentPosition(this.contentDOM)&2;else if(this.dom.firstChild){if(t==0)for(let r=e;;r=r.parentNode){if(r==this.dom){i=!1;break}if(r.previousSibling)break}if(i==null&&t==e.childNodes.length)for(let r=e;;r=r.parentNode){if(r==this.dom){i=!0;break}if(r.nextSibling)break}}return i??s>0?this.posAtEnd:this.posAtStart}nearestDesc(e,t=!1){for(let s=!0,i=e;i;i=i.parentNode){let r=this.getDesc(i),o;if(r&&(!t||r.node))if(s&&(o=r.nodeDOM)&&!(o.nodeType==1?o.contains(e.nodeType==1?e:e.parentNode):o==e))s=!1;else return r}}getDesc(e){let t=e.pmViewDesc;for(let s=t;s;s=s.parent)if(s==this)return t}posFromDOM(e,t,s){for(let i=e;i;i=i.parentNode){let r=this.getDesc(i);if(r)return r.localPosFromDOM(e,t,s)}return-1}descAt(e){for(let t=0,s=0;t<this.children.length;t++){let i=this.children[t],r=s+i.size;if(s==e&&r!=s){for(;!i.border&&i.children.length;)i=i.children[0];return i}if(e<r)return i.descAt(e-s-i.border);s=r}}domFromPos(e,t){if(!this.contentDOM)return{node:this.dom,offset:0,atom:e+1};let s=0,i=0;for(let r=0;s<this.children.length;s++){let o=this.children[s],a=r+o.size;if(a>e||o instanceof Cp){i=e-r;break}r=a}if(i)return this.children[s].domFromPos(i-this.children[s].border,t);for(let r;s&&!(r=this.children[s-1]).size&&r instanceof kp&&r.side>=0;s--);if(t<=0){let r,o=!0;for(;r=s?this.children[s-1]:null,!(!r||r.dom.parentNode==this.contentDOM);s--,o=!1);return r&&t&&o&&!r.border&&!r.domAtom?r.domFromPos(r.size,t):{node:this.contentDOM,offset:r?bt(r.dom)+1:0}}else{let r,o=!0;for(;r=s<this.children.length?this.children[s]:null,!(!r||r.dom.parentNode==this.contentDOM);s++,o=!1);return r&&o&&!r.border&&!r.domAtom?r.domFromPos(0,t):{node:this.contentDOM,offset:r?bt(r.dom):this.contentDOM.childNodes.length}}}parseRange(e,t,s=0){if(this.children.length==0)return{node:this.contentDOM,from:e,to:t,fromOffset:0,toOffset:this.contentDOM.childNodes.length};let i=-1,r=-1;for(let o=s,a=0;;a++){let l=this.children[a],d=o+l.size;if(i==-1&&e<=d){let u=o+l.border;if(e>=u&&t<=d-l.border&&l.node&&l.contentDOM&&this.contentDOM.contains(l.contentDOM))return l.parseRange(e,t,u);e=o;for(let p=a;p>0;p--){let m=this.children[p-1];if(m.size&&m.dom.parentNode==this.contentDOM&&!m.emptyChildAt(1)){i=bt(m.dom)+1;break}e-=m.size}i==-1&&(i=0)}if(i>-1&&(d>t||a==this.children.length-1)){t=d;for(let u=a+1;u<this.children.length;u++){let p=this.children[u];if(p.size&&p.dom.parentNode==this.contentDOM&&!p.emptyChildAt(-1)){r=bt(p.dom);break}t+=p.size}r==-1&&(r=this.contentDOM.childNodes.length);break}o=d}return{node:this.contentDOM,from:e,to:t,fromOffset:i,toOffset:r}}emptyChildAt(e){if(this.border||!this.contentDOM||!this.children.length)return!1;let t=this.children[e<0?0:this.children.length-1];return t.size==0||t.emptyChildAt(e)}domAfterPos(e){let{node:t,offset:s}=this.domFromPos(e,0);if(t.nodeType!=1||s==t.childNodes.length)throw new RangeError("No node after pos "+e);return t.childNodes[s]}setSelection(e,t,s,i=!1){let r=Math.min(e,t),o=Math.max(e,t);for(let m=0,b=0;m<this.children.length;m++){let g=this.children[m],y=b+g.size;if(r>b&&o<y)return g.setSelection(e-b-g.border,t-b-g.border,s,i);b=y}let a=this.domFromPos(e,e?-1:1),l=t==e?a:this.domFromPos(t,t?-1:1),d=s.getSelection(),u=!1;if((Cn||Pt)&&e==t){let{node:m,offset:b}=a;if(m.nodeType==3){if(u=!!(b&&m.nodeValue[b-1]==`
`),u&&b==m.nodeValue.length)for(let g=m,y;g;g=g.parentNode){if(y=g.nextSibling){y.nodeName=="BR"&&(a=l={node:y.parentNode,offset:bt(y)+1});break}let C=g.pmViewDesc;if(C&&C.node&&C.node.isBlock)break}}else{let g=m.childNodes[b-1];u=g&&(g.nodeName=="BR"||g.contentEditable=="false")}}if(Cn&&d.focusNode&&d.focusNode!=l.node&&d.focusNode.nodeType==1){let m=d.focusNode.childNodes[d.focusOffset];m&&m.contentEditable=="false"&&(i=!0)}if(!(i||u&&Pt)&&Zs(a.node,a.offset,d.anchorNode,d.anchorOffset)&&Zs(l.node,l.offset,d.focusNode,d.focusOffset))return;let p=!1;if((d.extend||e==t)&&!u){d.collapse(a.node,a.offset);try{e!=t&&d.extend(l.node,l.offset),p=!0}catch{}}if(!p){if(e>t){let b=a;a=l,l=b}let m=document.createRange();m.setEnd(l.node,l.offset),m.setStart(a.node,a.offset),d.removeAllRanges(),d.addRange(m)}}ignoreMutation(e){return!this.contentDOM&&e.type!="selection"}get contentLost(){return this.contentDOM&&this.contentDOM!=this.dom&&!this.dom.contains(this.contentDOM)}markDirty(e,t){for(let s=0,i=0;i<this.children.length;i++){let r=this.children[i],o=s+r.size;if(s==o?e<=o&&t>=s:e<o&&t>s){let a=s+r.border,l=o-r.border;if(e>=a&&t<=l){this.dirty=e==s||t==o?Us:Bd,e==a&&t==l&&(r.contentLost||r.dom.parentNode!=this.contentDOM)?r.dirty=jn:r.markDirty(e-a,t-a);return}else r.dirty=r.dom==r.contentDOM&&r.dom.parentNode==this.contentDOM&&!r.children.length?Us:jn}s=o}this.dirty=Us}markParentsDirty(){let e=1;for(let t=this.parent;t;t=t.parent,e++){let s=e==1?Us:Bd;t.dirty<s&&(t.dirty=s)}}get domAtom(){return!1}get ignoreForCoords(){return!1}isText(e){return!1}}class kp extends Dr{constructor(e,t,s,i){let r,o=t.type.toDOM;if(typeof o=="function"&&(o=o(s,()=>{if(!r)return i;if(r.parent)return r.parent.posBeforeChild(r)})),!t.type.spec.raw){if(o.nodeType!=1){let a=document.createElement("span");a.appendChild(o),o=a}o.contentEditable="false",o.classList.add("ProseMirror-widget")}super(e,[],o,null),this.widget=t,this.widget=t,r=this}matchesWidget(e){return this.dirty==ln&&e.type.eq(this.widget.type)}parseRule(){return{ignore:!0}}stopEvent(e){let t=this.widget.spec.stopEvent;return t?t(e):!1}ignoreMutation(e){return e.type!="selection"||this.widget.spec.ignoreSelection}destroy(){this.widget.type.destroy(this.dom),super.destroy()}get domAtom(){return!0}get side(){return this.widget.type.side}}class MC extends Dr{constructor(e,t,s,i){super(e,[],t,null),this.textDOM=s,this.text=i}get size(){return this.text.length}localPosFromDOM(e,t){return e!=this.textDOM?this.posAtStart+(t?this.size:0):this.posAtStart+t}domFromPos(e){return{node:this.textDOM,offset:e}}ignoreMutation(e){return e.type==="characterData"&&e.target.nodeValue==e.oldValue}}class ei extends Dr{constructor(e,t,s,i){super(e,[],s,i),this.mark=t}static create(e,t,s,i){let r=i.nodeViews[t.type.name],o=r&&r(t,i,s);return(!o||!o.dom)&&(o=Vi.renderSpec(document,t.type.spec.toDOM(t,s),null,t.attrs)),new ei(e,t,o.dom,o.contentDOM||o.dom)}parseRule(){return this.dirty&jn||this.mark.type.spec.reparseInView?null:{mark:this.mark.type.name,attrs:this.mark.attrs,contentElement:this.contentDOM}}matchesMark(e){return this.dirty!=jn&&this.mark.eq(e)}markDirty(e,t){if(super.markDirty(e,t),this.dirty!=ln){let s=this.parent;for(;!s.node;)s=s.parent;s.dirty<this.dirty&&(s.dirty=this.dirty),this.dirty=ln}}slice(e,t,s){let i=ei.create(this.parent,this.mark,!0,s),r=this.children,o=this.size;t<o&&(r=rl(r,t,o,s)),e>0&&(r=rl(r,0,e,s));for(let a=0;a<r.length;a++)r[a].parent=i;return i.children=r,i}}class Ss extends Dr{constructor(e,t,s,i,r,o,a,l,d){super(e,[],r,o),this.node=t,this.outerDeco=s,this.innerDeco=i,this.nodeDOM=a}static create(e,t,s,i,r,o){let a=r.nodeViews[t.type.name],l,d=a&&a(t,r,()=>{if(!l)return o;if(l.parent)return l.parent.posBeforeChild(l)},s,i),u=d&&d.dom,p=d&&d.contentDOM;if(t.isText){if(!u)u=document.createTextNode(t.text);else if(u.nodeType!=3)throw new RangeError("Text must be rendered as a DOM text node")}else u||({dom:u,contentDOM:p}=Vi.renderSpec(document,t.type.spec.toDOM(t),null,t.attrs));!p&&!t.isText&&u.nodeName!="BR"&&(u.hasAttribute("contenteditable")||(u.contentEditable="false"),t.type.spec.draggable&&(u.draggable=!0));let m=u;return u=Tp(u,s,t),d?l=new vC(e,t,s,i,u,p||null,m,d,r,o+1):t.isText?new Zo(e,t,s,i,u,m,r):new Ss(e,t,s,i,u,p||null,m,r,o+1)}parseRule(){if(this.node.type.spec.reparseInView)return null;let e={node:this.node.type.name,attrs:this.node.attrs};if(this.node.type.whitespace=="pre"&&(e.preserveWhitespace="full"),!this.contentDOM)e.getContent=()=>this.node.content;else if(!this.contentLost)e.contentElement=this.contentDOM;else{for(let t=this.children.length-1;t>=0;t--){let s=this.children[t];if(this.dom.contains(s.dom.parentNode)){e.contentElement=s.dom.parentNode;break}}e.contentElement||(e.getContent=()=>q.empty)}return e}matchesNode(e,t,s){return this.dirty==ln&&e.eq(this.node)&&il(t,this.outerDeco)&&s.eq(this.innerDeco)}get size(){return this.node.nodeSize}get border(){return this.node.isLeaf?0:1}updateChildren(e,t){let s=this.node.inlineContent,i=t,r=e.composing?this.localCompositionInfo(e,t):null,o=r&&r.pos>-1?r:null,a=r&&r.pos<0,l=new EC(this,o&&o.node,e);IC(this.node,this.innerDeco,(d,u,p)=>{d.spec.marks?l.syncToMarks(d.spec.marks,s,e):d.type.side>=0&&!p&&l.syncToMarks(u==this.node.childCount?Pe.none:this.node.child(u).marks,s,e),l.placeWidget(d,e,i)},(d,u,p,m)=>{l.syncToMarks(d.marks,s,e);let b;l.findNodeMatch(d,u,p,m)||a&&e.state.selection.from>i&&e.state.selection.to<i+d.nodeSize&&(b=l.findIndexWithChild(r.node))>-1&&l.updateNodeAt(d,u,p,b,e)||l.updateNextNode(d,u,p,e,m,i)||l.addNode(d,u,p,e,i),i+=d.nodeSize}),l.syncToMarks([],s,e),this.node.isTextblock&&l.addTextblockHacks(),l.destroyRest(),(l.changed||this.dirty==Us)&&(o&&this.protectLocalComposition(e,o),Mp(this.contentDOM,this.children,e),Oi&&AC(this.dom))}localCompositionInfo(e,t){let{from:s,to:i}=e.state.selection;if(!(e.state.selection instanceof Le)||s<t||i>t+this.node.content.size)return null;let r=e.input.compositionNode;if(!r||!this.dom.contains(r.parentNode))return null;if(this.node.inlineContent){let o=r.nodeValue,a=RC(this.node.content,o,s-t,i-t);return a<0?null:{node:r,pos:a,text:o}}else return{node:r,pos:-1,text:""}}protectLocalComposition(e,{node:t,pos:s,text:i}){if(this.getDesc(t))return;let r=t;for(;r.parentNode!=this.contentDOM;r=r.parentNode){for(;r.previousSibling;)r.parentNode.removeChild(r.previousSibling);for(;r.nextSibling;)r.parentNode.removeChild(r.nextSibling);r.pmViewDesc&&(r.pmViewDesc=void 0)}let o=new MC(this,r,t,i);e.input.compositionNodes.push(o),this.children=rl(this.children,s,s+i.length,e,o)}update(e,t,s,i){return this.dirty==jn||!e.sameMarkup(this.node)?!1:(this.updateInner(e,t,s,i),!0)}updateInner(e,t,s,i){this.updateOuterDeco(t),this.node=e,this.innerDeco=s,this.contentDOM&&this.updateChildren(i,this.posAtStart),this.dirty=ln}updateOuterDeco(e){if(il(e,this.outerDeco))return;let t=this.nodeDOM.nodeType!=1,s=this.dom;this.dom=vp(this.dom,this.nodeDOM,sl(this.outerDeco,this.node,t),sl(e,this.node,t)),this.dom!=s&&(s.pmViewDesc=void 0,this.dom.pmViewDesc=this),this.outerDeco=e}selectNode(){this.nodeDOM.nodeType==1&&this.nodeDOM.classList.add("ProseMirror-selectednode"),(this.contentDOM||!this.node.type.spec.draggable)&&(this.dom.draggable=!0)}deselectNode(){this.nodeDOM.nodeType==1&&(this.nodeDOM.classList.remove("ProseMirror-selectednode"),(this.contentDOM||!this.node.type.spec.draggable)&&this.dom.removeAttribute("draggable"))}get domAtom(){return this.node.isAtom}}function Ld(n,e,t,s,i){Tp(s,e,n);let r=new Ss(void 0,n,e,t,s,s,s,i,0);return r.contentDOM&&r.updateChildren(i,0),r}class Zo extends Ss{constructor(e,t,s,i,r,o,a){super(e,t,s,i,r,null,o,a,0)}parseRule(){let e=this.nodeDOM.parentNode;for(;e&&e!=this.dom&&!e.pmIsDeco;)e=e.parentNode;return{skip:e||!0}}update(e,t,s,i){return this.dirty==jn||this.dirty!=ln&&!this.inParent()||!e.sameMarkup(this.node)?!1:(this.updateOuterDeco(t),(this.dirty!=ln||e.text!=this.node.text)&&e.text!=this.nodeDOM.nodeValue&&(this.nodeDOM.nodeValue=e.text,i.trackWrites==this.nodeDOM&&(i.trackWrites=null)),this.node=e,this.dirty=ln,!0)}inParent(){let e=this.parent.contentDOM;for(let t=this.nodeDOM;t;t=t.parentNode)if(t==e)return!0;return!1}domFromPos(e){return{node:this.nodeDOM,offset:e}}localPosFromDOM(e,t,s){return e==this.nodeDOM?this.posAtStart+Math.min(t,this.node.text.length):super.localPosFromDOM(e,t,s)}ignoreMutation(e){return e.type!="characterData"&&e.type!="selection"}slice(e,t,s){let i=this.node.cut(e,t),r=document.createTextNode(i.text);return new Zo(this.parent,i,this.outerDeco,this.innerDeco,r,r,s)}markDirty(e,t){super.markDirty(e,t),this.dom!=this.nodeDOM&&(e==0||t==this.nodeDOM.nodeValue.length)&&(this.dirty=jn)}get domAtom(){return!1}isText(e){return this.node.text==e}}class Cp extends Dr{parseRule(){return{ignore:!0}}matchesHack(e){return this.dirty==ln&&this.dom.nodeName==e}get domAtom(){return!0}get ignoreForCoords(){return this.dom.nodeName=="IMG"}}class vC extends Ss{constructor(e,t,s,i,r,o,a,l,d,u){super(e,t,s,i,r,o,a,d,u),this.spec=l}update(e,t,s,i){if(this.dirty==jn)return!1;if(this.spec.update){let r=this.spec.update(e,t,s);return r&&this.updateInner(e,t,s,i),r}else return!this.contentDOM&&!e.isLeaf?!1:super.update(e,t,s,i)}selectNode(){this.spec.selectNode?this.spec.selectNode():super.selectNode()}deselectNode(){this.spec.deselectNode?this.spec.deselectNode():super.deselectNode()}setSelection(e,t,s,i){this.spec.setSelection?this.spec.setSelection(e,t,s):super.setSelection(e,t,s,i)}destroy(){this.spec.destroy&&this.spec.destroy(),super.destroy()}stopEvent(e){return this.spec.stopEvent?this.spec.stopEvent(e):!1}ignoreMutation(e){return this.spec.ignoreMutation?this.spec.ignoreMutation(e):super.ignoreMutation(e)}}function Mp(n,e,t){let s=n.firstChild,i=!1;for(let r=0;r<e.length;r++){let o=e[r],a=o.dom;if(a.parentNode==n){for(;a!=s;)s=zd(s),i=!0;s=s.nextSibling}else i=!0,n.insertBefore(a,s);if(o instanceof ei){let l=s?s.previousSibling:n.lastChild;Mp(o.contentDOM,o.children,t),s=l?l.nextSibling:n.firstChild}}for(;s;)s=zd(s),i=!0;i&&t.trackWrites==n&&(t.trackWrites=null)}const rr=function(n){n&&(this.nodeName=n)};rr.prototype=Object.create(null);const Vs=[new rr];function sl(n,e,t){if(n.length==0)return Vs;let s=t?Vs[0]:new rr,i=[s];for(let r=0;r<n.length;r++){let o=n[r].type.attrs;if(o){o.nodeName&&i.push(s=new rr(o.nodeName));for(let a in o){let l=o[a];l!=null&&(t&&i.length==1&&i.push(s=new rr(e.isInline?"span":"div")),a=="class"?s.class=(s.class?s.class+" ":"")+l:a=="style"?s.style=(s.style?s.style+";":"")+l:a!="nodeName"&&(s[a]=l))}}}return i}function vp(n,e,t,s){if(t==Vs&&s==Vs)return e;let i=e;for(let r=0;r<s.length;r++){let o=s[r],a=t[r];if(r){let l;a&&a.nodeName==o.nodeName&&i!=n&&(l=i.parentNode)&&l.nodeName.toLowerCase()==o.nodeName||(l=document.createElement(o.nodeName),l.pmIsDeco=!0,l.appendChild(i),a=Vs[0]),i=l}TC(i,a||Vs[0],o)}return i}function TC(n,e,t){for(let s in e)s!="class"&&s!="style"&&s!="nodeName"&&!(s in t)&&n.removeAttribute(s);for(let s in t)s!="class"&&s!="style"&&s!="nodeName"&&t[s]!=e[s]&&n.setAttribute(s,t[s]);if(e.class!=t.class){let s=e.class?e.class.split(" ").filter(Boolean):[],i=t.class?t.class.split(" ").filter(Boolean):[];for(let r=0;r<s.length;r++)i.indexOf(s[r])==-1&&n.classList.remove(s[r]);for(let r=0;r<i.length;r++)s.indexOf(i[r])==-1&&n.classList.add(i[r]);n.classList.length==0&&n.removeAttribute("class")}if(e.style!=t.style){if(e.style){let s=/\s*([\w\-\xa1-\uffff]+)\s*:(?:"(?:\\.|[^"])*"|'(?:\\.|[^'])*'|\(.*?\)|[^;])*/g,i;for(;i=s.exec(e.style);)n.style.removeProperty(i[1])}t.style&&(n.style.cssText+=t.style)}}function Tp(n,e,t){return vp(n,n,Vs,sl(e,t,n.nodeType!=1))}function il(n,e){if(n.length!=e.length)return!1;for(let t=0;t<n.length;t++)if(!n[t].type.eq(e[t].type))return!1;return!0}function zd(n){let e=n.nextSibling;return n.parentNode.removeChild(n),e}class EC{constructor(e,t,s){this.lock=t,this.view=s,this.index=0,this.stack=[],this.changed=!1,this.top=e,this.preMatch=_C(e.node.content,e)}destroyBetween(e,t){if(e!=t){for(let s=e;s<t;s++)this.top.children[s].destroy();this.top.children.splice(e,t-e),this.changed=!0}}destroyRest(){this.destroyBetween(this.index,this.top.children.length)}syncToMarks(e,t,s){let i=0,r=this.stack.length>>1,o=Math.min(r,e.length);for(;i<o&&(i==r-1?this.top:this.stack[i+1<<1]).matchesMark(e[i])&&e[i].type.spec.spanning!==!1;)i++;for(;i<r;)this.destroyRest(),this.top.dirty=ln,this.index=this.stack.pop(),this.top=this.stack.pop(),r--;for(;r<e.length;){this.stack.push(this.top,this.index+1);let a=-1;for(let l=this.index;l<Math.min(this.index+3,this.top.children.length);l++){let d=this.top.children[l];if(d.matchesMark(e[r])&&!this.isLocked(d.dom)){a=l;break}}if(a>-1)a>this.index&&(this.changed=!0,this.destroyBetween(this.index,a)),this.top=this.top.children[this.index];else{let l=ei.create(this.top,e[r],t,s);this.top.children.splice(this.index,0,l),this.top=l,this.changed=!0}this.index=0,r++}}findNodeMatch(e,t,s,i){let r=-1,o;if(i>=this.preMatch.index&&(o=this.preMatch.matches[i-this.preMatch.index]).parent==this.top&&o.matchesNode(e,t,s))r=this.top.children.indexOf(o,this.index);else for(let a=this.index,l=Math.min(this.top.children.length,a+5);a<l;a++){let d=this.top.children[a];if(d.matchesNode(e,t,s)&&!this.preMatch.matched.has(d)){r=a;break}}return r<0?!1:(this.destroyBetween(this.index,r),this.index++,!0)}updateNodeAt(e,t,s,i,r){let o=this.top.children[i];return o.dirty==jn&&o.dom==o.contentDOM&&(o.dirty=Us),o.update(e,t,s,r)?(this.destroyBetween(this.index,i),this.index++,!0):!1}findIndexWithChild(e){for(;;){let t=e.parentNode;if(!t)return-1;if(t==this.top.contentDOM){let s=e.pmViewDesc;if(s){for(let i=this.index;i<this.top.children.length;i++)if(this.top.children[i]==s)return i}return-1}e=t}}updateNextNode(e,t,s,i,r,o){for(let a=this.index;a<this.top.children.length;a++){let l=this.top.children[a];if(l instanceof Ss){let d=this.preMatch.matched.get(l);if(d!=null&&d!=r)return!1;let u=l.dom,p,m=this.isLocked(u)&&!(e.isText&&l.node&&l.node.isText&&l.nodeDOM.nodeValue==e.text&&l.dirty!=jn&&il(t,l.outerDeco));if(!m&&l.update(e,t,s,i))return this.destroyBetween(this.index,a),l.dom!=u&&(this.changed=!0),this.index++,!0;if(!m&&(p=this.recreateWrapper(l,e,t,s,i,o)))return this.top.children[this.index]=p,p.contentDOM&&(p.dirty=Us,p.updateChildren(i,o+1),p.dirty=ln),this.changed=!0,this.index++,!0;break}}return!1}recreateWrapper(e,t,s,i,r,o){if(e.dirty||t.isAtom||!e.children.length||!e.node.content.eq(t.content))return null;let a=Ss.create(this.top,t,s,i,r,o);if(a.contentDOM){a.children=e.children,e.children=[];for(let l of a.children)l.parent=a}return e.destroy(),a}addNode(e,t,s,i,r){let o=Ss.create(this.top,e,t,s,i,r);o.contentDOM&&o.updateChildren(i,r+1),this.top.children.splice(this.index++,0,o),this.changed=!0}placeWidget(e,t,s){let i=this.index<this.top.children.length?this.top.children[this.index]:null;if(i&&i.matchesWidget(e)&&(e==i.widget||!i.widget.type.toDOM.parentNode))this.index++;else{let r=new kp(this.top,e,t,s);this.top.children.splice(this.index++,0,r),this.changed=!0}}addTextblockHacks(){let e=this.top.children[this.index-1],t=this.top;for(;e instanceof ei;)t=e,e=t.children[t.children.length-1];(!e||!(e instanceof Zo)||/\n$/.test(e.node.text)||this.view.requiresGeckoHackNode&&/\s$/.test(e.node.text))&&((Pt||Nt)&&e&&e.dom.contentEditable=="false"&&this.addHackNode("IMG",t),this.addHackNode("BR",this.top))}addHackNode(e,t){if(t==this.top&&this.index<t.children.length&&t.children[this.index].matchesHack(e))this.index++;else{let s=document.createElement(e);e=="IMG"&&(s.className="ProseMirror-separator",s.alt=""),e=="BR"&&(s.className="ProseMirror-trailingBreak");let i=new Cp(this.top,[],s,null);t!=this.top?t.children.push(i):t.children.splice(this.index++,0,i),this.changed=!0}}isLocked(e){return this.lock&&(e==this.lock||e.nodeType==1&&e.contains(this.lock.parentNode))}}function _C(n,e){let t=e,s=t.children.length,i=n.childCount,r=new Map,o=[];e:for(;i>0;){let a;for(;;)if(s){let d=t.children[s-1];if(d instanceof ei)t=d,s=d.children.length;else{a=d,s--;break}}else{if(t==e)break e;s=t.parent.children.indexOf(t),t=t.parent}let l=a.node;if(l){if(l!=n.child(i-1))break;--i,r.set(a,i),o.push(a)}}return{index:i,matched:r,matches:o.reverse()}}function NC(n,e){return n.type.side-e.type.side}function IC(n,e,t,s){let i=e.locals(n),r=0;if(i.length==0){for(let d=0;d<n.childCount;d++){let u=n.child(d);s(u,i,e.forChild(r,u),d),r+=u.nodeSize}return}let o=0,a=[],l=null;for(let d=0;;){let u,p;for(;o<i.length&&i[o].to==r;){let C=i[o++];C.widget&&(u?(p||(p=[u])).push(C):u=C)}if(u)if(p){p.sort(NC);for(let C=0;C<p.length;C++)t(p[C],d,!!l)}else t(u,d,!!l);let m,b;if(l)b=-1,m=l,l=null;else if(d<n.childCount)b=d,m=n.child(d++);else break;for(let C=0;C<a.length;C++)a[C].to<=r&&a.splice(C--,1);for(;o<i.length&&i[o].from<=r&&i[o].to>r;)a.push(i[o++]);let g=r+m.nodeSize;if(m.isText){let C=g;o<i.length&&i[o].from<C&&(C=i[o].from);for(let M=0;M<a.length;M++)a[M].to<C&&(C=a[M].to);C<g&&(l=m.cut(C-r),m=m.cut(0,C-r),g=C,b=-1)}else for(;o<i.length&&i[o].to<g;)o++;let y=m.isInline&&!m.isLeaf?a.filter(C=>!C.inline):a.slice();s(m,y,e.forChild(r,m),b),r=g}}function AC(n){if(n.nodeName=="UL"||n.nodeName=="OL"){let e=n.style.cssText;n.style.cssText=e+"; list-style: square !important",window.getComputedStyle(n).listStyle,n.style.cssText=e}}function RC(n,e,t,s){for(let i=0,r=0;i<n.childCount&&r<=s;){let o=n.child(i++),a=r;if(r+=o.nodeSize,!o.isText)continue;let l=o.text;for(;i<n.childCount;){let d=n.child(i++);if(r+=d.nodeSize,!d.isText)break;l+=d.text}if(r>=t){if(r>=s&&l.slice(s-e.length-a,s-a)==e)return s-e.length;let d=a<s?l.lastIndexOf(e,s-a-1):-1;if(d>=0&&d+e.length+a>=t)return a+d;if(t==s&&l.length>=s+e.length-a&&l.slice(s-a,s-a+e.length)==e)return s}}return-1}function rl(n,e,t,s,i){let r=[];for(let o=0,a=0;o<n.length;o++){let l=n[o],d=a,u=a+=l.size;d>=t||u<=e?r.push(l):(d<e&&r.push(l.slice(0,e-d,s)),i&&(r.push(i),i=void 0),u>t&&r.push(l.slice(t-d,l.size,s)))}return r}function cc(n,e=null){let t=n.domSelectionRange(),s=n.state.doc;if(!t.focusNode)return null;let i=n.docView.nearestDesc(t.focusNode),r=i&&i.size==0,o=n.docView.posFromDOM(t.focusNode,t.focusOffset,1);if(o<0)return null;let a=s.resolve(o),l,d;if(Xo(t)){for(l=a;i&&!i.node;)i=i.parent;let u=i.node;if(i&&u.isAtom&&fe.isSelectable(u)&&i.parent&&!(u.isInline&&iC(t.focusNode,t.focusOffset,i.dom))){let p=i.posBefore;d=new fe(o==p?a:s.resolve(p))}}else{let u=n.docView.posFromDOM(t.anchorNode,t.anchorOffset,1);if(u<0)return null;l=s.resolve(u)}if(!d){let u=e=="pointer"||n.state.selection.head<a.pos&&!r?1:-1;d=dc(n,l,a,u)}return d}function Ep(n){return n.editable?n.hasFocus():Np(n)&&document.activeElement&&document.activeElement.contains(n.dom)}function Qn(n,e=!1){let t=n.state.selection;if(_p(n,t),!!Ep(n)){if(!e&&n.input.mouseDown&&n.input.mouseDown.allowDefault&&Nt){let s=n.domSelectionRange(),i=n.domObserver.currentSelection;if(s.anchorNode&&i.anchorNode&&Zs(s.anchorNode,s.anchorOffset,i.anchorNode,i.anchorOffset)){n.input.mouseDown.delayedSelectionSync=!0,n.domObserver.setCurSelection();return}}if(n.domObserver.disconnectSelection(),n.cursorWrapper)jC(n);else{let{anchor:s,head:i}=t,r,o;Ud&&!(t instanceof Le)&&(t.$from.parent.inlineContent||(r=Vd(n,t.from)),!t.empty&&!t.$from.parent.inlineContent&&(o=Vd(n,t.to))),n.docView.setSelection(s,i,n.root,e),Ud&&(r&&Wd(r),o&&Wd(o)),t.visible?n.dom.classList.remove("ProseMirror-hideselection"):(n.dom.classList.add("ProseMirror-hideselection"),"onselectionchange"in document&&DC(n))}n.domObserver.setCurSelection(),n.domObserver.connectSelection()}}const Ud=Pt||Nt&&mp<63;function Vd(n,e){let{node:t,offset:s}=n.docView.domFromPos(e,0),i=s<t.childNodes.length?t.childNodes[s]:null,r=s?t.childNodes[s-1]:null;if(Pt&&i&&i.contentEditable=="false")return Sa(i);if((!i||i.contentEditable=="false")&&(!r||r.contentEditable=="false")){if(i)return Sa(i);if(r)return Sa(r)}}function Sa(n){return n.contentEditable="true",Pt&&n.draggable&&(n.draggable=!1,n.wasDraggable=!0),n}function Wd(n){n.contentEditable="false",n.wasDraggable&&(n.draggable=!0,n.wasDraggable=null)}function DC(n){let e=n.dom.ownerDocument;e.removeEventListener("selectionchange",n.input.hideSelectionGuard);let t=n.domSelectionRange(),s=t.anchorNode,i=t.anchorOffset;e.addEventListener("selectionchange",n.input.hideSelectionGuard=()=>{(t.anchorNode!=s||t.anchorOffset!=i)&&(e.removeEventListener("selectionchange",n.input.hideSelectionGuard),setTimeout(()=>{(!Ep(n)||n.state.selection.visible)&&n.dom.classList.remove("ProseMirror-hideselection")},20))})}function jC(n){let e=n.domSelection(),t=document.createRange(),s=n.cursorWrapper.dom,i=s.nodeName=="IMG";i?t.setEnd(s.parentNode,bt(s)+1):t.setEnd(s,0),t.collapse(!1),e.removeAllRanges(),e.addRange(t),!i&&!n.state.selection.visible&&Ut&&ws<=11&&(s.disabled=!0,s.disabled=!1)}function _p(n,e){if(e instanceof fe){let t=n.docView.descAt(e.from);t!=n.lastSelectedViewDesc&&(Gd(n),t&&t.selectNode(),n.lastSelectedViewDesc=t)}else Gd(n)}function Gd(n){n.lastSelectedViewDesc&&(n.lastSelectedViewDesc.parent&&n.lastSelectedViewDesc.deselectNode(),n.lastSelectedViewDesc=void 0)}function dc(n,e,t,s){return n.someProp("createSelectionBetween",i=>i(n,e,t))||Le.between(e,t,s)}function qd(n){return n.editable&&!n.hasFocus()?!1:Np(n)}function Np(n){let e=n.domSelectionRange();if(!e.anchorNode)return!1;try{return n.dom.contains(e.anchorNode.nodeType==3?e.anchorNode.parentNode:e.anchorNode)&&(n.editable||n.dom.contains(e.focusNode.nodeType==3?e.focusNode.parentNode:e.focusNode))}catch{return!1}}function OC(n){let e=n.docView.domFromPos(n.state.selection.anchor,0),t=n.domSelectionRange();return Zs(e.node,e.offset,t.anchorNode,t.anchorOffset)}function ol(n,e){let{$anchor:t,$head:s}=n.selection,i=e>0?t.max(s):t.min(s),r=i.parent.inlineContent?i.depth?n.doc.resolve(e>0?i.after():i.before()):null:i;return r&&_e.findFrom(r,e)}function us(n,e){return n.dispatch(n.state.tr.setSelection(e).scrollIntoView()),!0}function Hd(n,e,t){let s=n.state.selection;if(s instanceof Le)if(t.indexOf("s")>-1){let{$head:i}=s,r=i.textOffset?null:e<0?i.nodeBefore:i.nodeAfter;if(!r||r.isText||!r.isLeaf)return!1;let o=n.state.doc.resolve(i.pos+r.nodeSize*(e<0?-1:1));return us(n,new Le(s.$anchor,o))}else if(s.empty){if(n.endOfTextblock(e>0?"forward":"backward")){let i=ol(n.state,e);return i&&i instanceof fe?us(n,i):!1}else if(!(sn&&t.indexOf("m")>-1)){let i=s.$head,r=i.textOffset?null:e<0?i.nodeBefore:i.nodeAfter,o;if(!r||r.isText)return!1;let a=e<0?i.pos-r.nodeSize:i.pos;return r.isAtom||(o=n.docView.descAt(a))&&!o.contentDOM?fe.isSelectable(r)?us(n,new fe(e<0?n.state.doc.resolve(i.pos-r.nodeSize):i)):Rr?us(n,new Le(n.state.doc.resolve(e<0?a:a+r.nodeSize))):!1:!1}}else return!1;else{if(s instanceof fe&&s.node.isInline)return us(n,new Le(e>0?s.$to:s.$from));{let i=ol(n.state,e);return i?us(n,i):!1}}}function _o(n){return n.nodeType==3?n.nodeValue.length:n.childNodes.length}function or(n,e){let t=n.pmViewDesc;return t&&t.size==0&&(e<0||n.nextSibling||n.nodeName!="BR")}function pi(n,e){return e<0?PC(n):FC(n)}function PC(n){let e=n.domSelectionRange(),t=e.focusNode,s=e.focusOffset;if(!t)return;let i,r,o=!1;for(Cn&&t.nodeType==1&&s<_o(t)&&or(t.childNodes[s],-1)&&(o=!0);;)if(s>0){if(t.nodeType!=1)break;{let a=t.childNodes[s-1];if(or(a,-1))i=t,r=--s;else if(a.nodeType==3)t=a,s=t.nodeValue.length;else break}}else{if(Ip(t))break;{let a=t.previousSibling;for(;a&&or(a,-1);)i=t.parentNode,r=bt(a),a=a.previousSibling;if(a)t=a,s=_o(t);else{if(t=t.parentNode,t==n.dom)break;s=0}}}o?al(n,t,s):i&&al(n,i,r)}function FC(n){let e=n.domSelectionRange(),t=e.focusNode,s=e.focusOffset;if(!t)return;let i=_o(t),r,o;for(;;)if(s<i){if(t.nodeType!=1)break;let a=t.childNodes[s];if(or(a,1))r=t,o=++s;else break}else{if(Ip(t))break;{let a=t.nextSibling;for(;a&&or(a,1);)r=a.parentNode,o=bt(a)+1,a=a.nextSibling;if(a)t=a,s=0,i=_o(t);else{if(t=t.parentNode,t==n.dom)break;s=i=0}}}r&&al(n,r,o)}function Ip(n){let e=n.pmViewDesc;return e&&e.node&&e.node.isBlock}function BC(n,e){for(;n&&e==n.childNodes.length&&!Ar(n);)e=bt(n)+1,n=n.parentNode;for(;n&&e<n.childNodes.length;){let t=n.childNodes[e];if(t.nodeType==3)return t;if(t.nodeType==1&&t.contentEditable=="false")break;n=t,e=0}}function LC(n,e){for(;n&&!e&&!Ar(n);)e=bt(n),n=n.parentNode;for(;n&&e;){let t=n.childNodes[e-1];if(t.nodeType==3)return t;if(t.nodeType==1&&t.contentEditable=="false")break;n=t,e=n.childNodes.length}}function al(n,e,t){if(e.nodeType!=3){let r,o;(o=BC(e,t))?(e=o,t=0):(r=LC(e,t))&&(e=r,t=r.nodeValue.length)}let s=n.domSelection();if(Xo(s)){let r=document.createRange();r.setEnd(e,t),r.setStart(e,t),s.removeAllRanges(),s.addRange(r)}else s.extend&&s.extend(e,t);n.domObserver.setCurSelection();let{state:i}=n;setTimeout(()=>{n.state==i&&Qn(n)},50)}function $d(n,e){let t=n.state.doc.resolve(e);if(!(Nt||aC)&&t.parent.inlineContent){let i=n.coordsAtPos(e);if(e>t.start()){let r=n.coordsAtPos(e-1),o=(r.top+r.bottom)/2;if(o>i.top&&o<i.bottom&&Math.abs(r.left-i.left)>1)return r.left<i.left?"ltr":"rtl"}if(e<t.end()){let r=n.coordsAtPos(e+1),o=(r.top+r.bottom)/2;if(o>i.top&&o<i.bottom&&Math.abs(r.left-i.left)>1)return r.left>i.left?"ltr":"rtl"}}return getComputedStyle(n.dom).direction=="rtl"?"rtl":"ltr"}function Kd(n,e,t){let s=n.state.selection;if(s instanceof Le&&!s.empty||t.indexOf("s")>-1||sn&&t.indexOf("m")>-1)return!1;let{$from:i,$to:r}=s;if(!i.parent.inlineContent||n.endOfTextblock(e<0?"up":"down")){let o=ol(n.state,e);if(o&&o instanceof fe)return us(n,o)}if(!i.parent.inlineContent){let o=e<0?i:r,a=s instanceof Qt?_e.near(o,e):_e.findFrom(o,e);return a?us(n,a):!1}return!1}function Jd(n,e){if(!(n.state.selection instanceof Le))return!0;let{$head:t,$anchor:s,empty:i}=n.state.selection;if(!t.sameParent(s))return!0;if(!i)return!1;if(n.endOfTextblock(e>0?"forward":"backward"))return!0;let r=!t.textOffset&&(e<0?t.nodeBefore:t.nodeAfter);if(r&&!r.isText){let o=n.state.tr;return e<0?o.delete(t.pos-r.nodeSize,t.pos):o.delete(t.pos,t.pos+r.nodeSize),n.dispatch(o),!0}return!1}function Yd(n,e,t){n.domObserver.stop(),e.contentEditable=t,n.domObserver.start()}function zC(n){if(!Pt||n.state.selection.$head.parentOffset>0)return!1;let{focusNode:e,focusOffset:t}=n.domSelectionRange();if(e&&e.nodeType==1&&t==0&&e.firstChild&&e.firstChild.contentEditable=="false"){let s=e.firstChild;Yd(n,s,"true"),setTimeout(()=>Yd(n,s,"false"),20)}return!1}function UC(n){let e="";return n.ctrlKey&&(e+="c"),n.metaKey&&(e+="m"),n.altKey&&(e+="a"),n.shiftKey&&(e+="s"),e}function VC(n,e){let t=e.keyCode,s=UC(e);if(t==8||sn&&t==72&&s=="c")return Jd(n,-1)||pi(n,-1);if(t==46&&!e.shiftKey||sn&&t==68&&s=="c")return Jd(n,1)||pi(n,1);if(t==13||t==27)return!0;if(t==37||sn&&t==66&&s=="c"){let i=t==37?$d(n,n.state.selection.from)=="ltr"?-1:1:-1;return Hd(n,i,s)||pi(n,i)}else if(t==39||sn&&t==70&&s=="c"){let i=t==39?$d(n,n.state.selection.from)=="ltr"?1:-1:1;return Hd(n,i,s)||pi(n,i)}else{if(t==38||sn&&t==80&&s=="c")return Kd(n,-1,s)||pi(n,-1);if(t==40||sn&&t==78&&s=="c")return zC(n)||Kd(n,1,s)||pi(n,1);if(s==(sn?"m":"c")&&(t==66||t==73||t==89||t==90))return!0}return!1}function Ap(n,e){n.someProp("transformCopied",b=>{e=b(e,n)});let t=[],{content:s,openStart:i,openEnd:r}=e;for(;i>1&&r>1&&s.childCount==1&&s.firstChild.childCount==1;){i--,r--;let b=s.firstChild;t.push(b.type.name,b.attrs!=b.type.defaultAttrs?b.attrs:null),s=b.content}let o=n.someProp("clipboardSerializer")||Vi.fromSchema(n.state.schema),a=Fp(),l=a.createElement("div");l.appendChild(o.serializeFragment(s,{document:a}));let d=l.firstChild,u,p=0;for(;d&&d.nodeType==1&&(u=Pp[d.nodeName.toLowerCase()]);){for(let b=u.length-1;b>=0;b--){let g=a.createElement(u[b]);for(;l.firstChild;)g.appendChild(l.firstChild);l.appendChild(g),p++}d=l.firstChild}d&&d.nodeType==1&&d.setAttribute("data-pm-slice",`${i} ${r}${p?` -${p}`:""} ${JSON.stringify(t)}`);let m=n.someProp("clipboardTextSerializer",b=>b(e,n))||e.content.textBetween(0,e.content.size,`

`);return{dom:l,text:m,slice:e}}function Rp(n,e,t,s,i){let r=i.parent.type.spec.code,o,a;if(!t&&!e)return null;let l=e&&(s||r||!t);if(l){if(n.someProp("transformPastedText",m=>{e=m(e,r||s,n)}),r)return e?new X(q.from(n.state.schema.text(e.replace(/\r\n?/g,`
`))),0,0):X.empty;let p=n.someProp("clipboardTextParser",m=>m(e,i,s,n));if(p)a=p;else{let m=i.marks(),{schema:b}=n.state,g=Vi.fromSchema(b);o=document.createElement("div"),e.split(/(?:\r\n?|\n)+/).forEach(y=>{let C=o.appendChild(document.createElement("p"));y&&C.appendChild(g.serializeNode(b.text(y,m)))})}}else n.someProp("transformPastedHTML",p=>{t=p(t,n)}),o=qC(t),Rr&&HC(o);let d=o&&o.querySelector("[data-pm-slice]"),u=d&&/^(\d+) (\d+)(?: -(\d+))? (.*)/.exec(d.getAttribute("data-pm-slice")||"");if(u&&u[3])for(let p=+u[3];p>0;p--){let m=o.firstChild;for(;m&&m.nodeType!=1;)m=m.nextSibling;if(!m)break;o=m}if(a||(a=(n.someProp("clipboardParser")||n.someProp("domParser")||pr.fromSchema(n.state.schema)).parseSlice(o,{preserveWhitespace:!!(l||u),context:i,ruleFromNode(m){return m.nodeName=="BR"&&!m.nextSibling&&m.parentNode&&!WC.test(m.parentNode.nodeName)?{ignore:!0}:null}})),u)a=$C(Qd(a,+u[1],+u[2]),u[4]);else if(a=X.maxOpen(GC(a.content,i),!0),a.openStart||a.openEnd){let p=0,m=0;for(let b=a.content.firstChild;p<a.openStart&&!b.type.spec.isolating;p++,b=b.firstChild);for(let b=a.content.lastChild;m<a.openEnd&&!b.type.spec.isolating;m++,b=b.lastChild);a=Qd(a,p,m)}return n.someProp("transformPasted",p=>{a=p(a,n)}),a}const WC=/^(a|abbr|acronym|b|cite|code|del|em|i|ins|kbd|label|output|q|ruby|s|samp|span|strong|sub|sup|time|u|tt|var)$/i;function GC(n,e){if(n.childCount<2)return n;for(let t=e.depth;t>=0;t--){let i=e.node(t).contentMatchAt(e.index(t)),r,o=[];if(n.forEach(a=>{if(!o)return;let l=i.findWrapping(a.type),d;if(!l)return o=null;if(d=o.length&&r.length&&jp(l,r,a,o[o.length-1],0))o[o.length-1]=d;else{o.length&&(o[o.length-1]=Op(o[o.length-1],r.length));let u=Dp(a,l);o.push(u),i=i.matchType(u.type),r=l}}),o)return q.from(o)}return n}function Dp(n,e,t=0){for(let s=e.length-1;s>=t;s--)n=e[s].create(null,q.from(n));return n}function jp(n,e,t,s,i){if(i<n.length&&i<e.length&&n[i]==e[i]){let r=jp(n,e,t,s.lastChild,i+1);if(r)return s.copy(s.content.replaceChild(s.childCount-1,r));if(s.contentMatchAt(s.childCount).matchType(i==n.length-1?t.type:n[i+1]))return s.copy(s.content.append(q.from(Dp(t,n,i+1))))}}function Op(n,e){if(e==0)return n;let t=n.content.replaceChild(n.childCount-1,Op(n.lastChild,e-1)),s=n.contentMatchAt(n.childCount).fillBefore(q.empty,!0);return n.copy(t.append(s))}function ll(n,e,t,s,i,r){let o=e<0?n.firstChild:n.lastChild,a=o.content;return n.childCount>1&&(r=0),i<s-1&&(a=ll(a,e,t,s,i+1,r)),i>=t&&(a=e<0?o.contentMatchAt(0).fillBefore(a,r<=i).append(a):a.append(o.contentMatchAt(o.childCount).fillBefore(q.empty,!0))),n.replaceChild(e<0?0:n.childCount-1,o.copy(a))}function Qd(n,e,t){return e<n.openStart&&(n=new X(ll(n.content,-1,e,n.openStart,0,n.openEnd),e,n.openEnd)),t<n.openEnd&&(n=new X(ll(n.content,1,t,n.openEnd,0,0),n.openStart,t)),n}const Pp={thead:["table"],tbody:["table"],tfoot:["table"],caption:["table"],colgroup:["table"],col:["table","colgroup"],tr:["table","tbody"],td:["table","tbody","tr"],th:["table","tbody","tr"]};let Xd=null;function Fp(){return Xd||(Xd=document.implementation.createHTMLDocument("title"))}function qC(n){let e=/^(\s*<meta [^>]*>)*/.exec(n);e&&(n=n.slice(e[0].length));let t=Fp().createElement("div"),s=/<([a-z][^>\s]+)/i.exec(n),i;if((i=s&&Pp[s[1].toLowerCase()])&&(n=i.map(r=>"<"+r+">").join("")+n+i.map(r=>"</"+r+">").reverse().join("")),t.innerHTML=n,i)for(let r=0;r<i.length;r++)t=t.querySelector(i[r])||t;return t}function HC(n){let e=n.querySelectorAll(Nt?"span:not([class]):not([style])":"span.Apple-converted-space");for(let t=0;t<e.length;t++){let s=e[t];s.childNodes.length==1&&s.textContent==""&&s.parentNode&&s.parentNode.replaceChild(n.ownerDocument.createTextNode(" "),s)}}function $C(n,e){if(!n.size)return n;let t=n.content.firstChild.type.schema,s;try{s=JSON.parse(e)}catch{return n}let{content:i,openStart:r,openEnd:o}=n;for(let a=s.length-2;a>=0;a-=2){let l=t.nodes[s[a]];if(!l||l.hasRequiredAttrs())break;i=q.from(l.create(s[a+1],i)),r++,o++}return new X(i,r,o)}const Ft={},Bt={},KC={touchstart:!0,touchmove:!0};class JC{constructor(){this.shiftKey=!1,this.mouseDown=null,this.lastKeyCode=null,this.lastKeyCodeTime=0,this.lastClick={time:0,x:0,y:0,type:""},this.lastSelectionOrigin=null,this.lastSelectionTime=0,this.lastIOSEnter=0,this.lastIOSEnterFallbackTimeout=-1,this.lastFocus=0,this.lastTouch=0,this.lastAndroidDelete=0,this.composing=!1,this.compositionNode=null,this.composingTimeout=-1,this.compositionNodes=[],this.compositionEndedAt=-2e8,this.compositionID=1,this.compositionPendingChanges=0,this.domChangeCount=0,this.eventHandlers=Object.create(null),this.hideSelectionGuard=null}}function YC(n){for(let e in Ft){let t=Ft[e];n.dom.addEventListener(e,n.input.eventHandlers[e]=s=>{XC(n,s)&&!uc(n,s)&&(n.editable||!(s.type in Bt))&&t(n,s)},KC[e]?{passive:!0}:void 0)}Pt&&n.dom.addEventListener("input",()=>null),cl(n)}function xs(n,e){n.input.lastSelectionOrigin=e,n.input.lastSelectionTime=Date.now()}function QC(n){n.domObserver.stop();for(let e in n.input.eventHandlers)n.dom.removeEventListener(e,n.input.eventHandlers[e]);clearTimeout(n.input.composingTimeout),clearTimeout(n.input.lastIOSEnterFallbackTimeout)}function cl(n){n.someProp("handleDOMEvents",e=>{for(let t in e)n.input.eventHandlers[t]||n.dom.addEventListener(t,n.input.eventHandlers[t]=s=>uc(n,s))})}function uc(n,e){return n.someProp("handleDOMEvents",t=>{let s=t[e.type];return s?s(n,e)||e.defaultPrevented:!1})}function XC(n,e){if(!e.bubbles)return!0;if(e.defaultPrevented)return!1;for(let t=e.target;t!=n.dom;t=t.parentNode)if(!t||t.nodeType==11||t.pmViewDesc&&t.pmViewDesc.stopEvent(e))return!1;return!0}function ZC(n,e){!uc(n,e)&&Ft[e.type]&&(n.editable||!(e.type in Bt))&&Ft[e.type](n,e)}Bt.keydown=(n,e)=>{let t=e;if(n.input.shiftKey=t.keyCode==16||t.shiftKey,!Lp(n,t)&&(n.input.lastKeyCode=t.keyCode,n.input.lastKeyCodeTime=Date.now(),!(wn&&Nt&&t.keyCode==13)))if(t.keyCode!=229&&n.domObserver.forceFlush(),Oi&&t.keyCode==13&&!t.ctrlKey&&!t.altKey&&!t.metaKey){let s=Date.now();n.input.lastIOSEnter=s,n.input.lastIOSEnterFallbackTimeout=setTimeout(()=>{n.input.lastIOSEnter==s&&(n.someProp("handleKeyDown",i=>i(n,Ls(13,"Enter"))),n.input.lastIOSEnter=0)},200)}else n.someProp("handleKeyDown",s=>s(n,t))||VC(n,t)?t.preventDefault():xs(n,"key")};Bt.keyup=(n,e)=>{e.keyCode==16&&(n.input.shiftKey=!1)};Bt.keypress=(n,e)=>{let t=e;if(Lp(n,t)||!t.charCode||t.ctrlKey&&!t.altKey||sn&&t.metaKey)return;if(n.someProp("handleKeyPress",i=>i(n,t))){t.preventDefault();return}let s=n.state.selection;if(!(s instanceof Le)||!s.$from.sameParent(s.$to)){let i=String.fromCharCode(t.charCode);!/[\r\n]/.test(i)&&!n.someProp("handleTextInput",r=>r(n,s.$from.pos,s.$to.pos,i))&&n.dispatch(n.state.tr.insertText(i).scrollIntoView()),t.preventDefault()}};function ea(n){return{left:n.clientX,top:n.clientY}}function eM(n,e){let t=e.x-n.clientX,s=e.y-n.clientY;return t*t+s*s<100}function hc(n,e,t,s,i){if(s==-1)return!1;let r=n.state.doc.resolve(s);for(let o=r.depth+1;o>0;o--)if(n.someProp(e,a=>o>r.depth?a(n,t,r.nodeAfter,r.before(o),i,!0):a(n,t,r.node(o),r.before(o),i,!1)))return!0;return!1}function ki(n,e,t){n.focused||n.focus();let s=n.state.tr.setSelection(e);s.setMeta("pointer",!0),n.dispatch(s)}function tM(n,e){if(e==-1)return!1;let t=n.state.doc.resolve(e),s=t.nodeAfter;return s&&s.isAtom&&fe.isSelectable(s)?(ki(n,new fe(t)),!0):!1}function nM(n,e){if(e==-1)return!1;let t=n.state.selection,s,i;t instanceof fe&&(s=t.node);let r=n.state.doc.resolve(e);for(let o=r.depth+1;o>0;o--){let a=o>r.depth?r.nodeAfter:r.node(o);if(fe.isSelectable(a)){s&&t.$from.depth>0&&o>=t.$from.depth&&r.before(t.$from.depth+1)==t.$from.pos?i=r.before(t.$from.depth):i=r.before(o);break}}return i!=null?(ki(n,fe.create(n.state.doc,i)),!0):!1}function sM(n,e,t,s,i){return hc(n,"handleClickOn",e,t,s)||n.someProp("handleClick",r=>r(n,e,s))||(i?nM(n,t):tM(n,t))}function iM(n,e,t,s){return hc(n,"handleDoubleClickOn",e,t,s)||n.someProp("handleDoubleClick",i=>i(n,e,s))}function rM(n,e,t,s){return hc(n,"handleTripleClickOn",e,t,s)||n.someProp("handleTripleClick",i=>i(n,e,s))||oM(n,t,s)}function oM(n,e,t){if(t.button!=0)return!1;let s=n.state.doc;if(e==-1)return s.inlineContent?(ki(n,Le.create(s,0,s.content.size)),!0):!1;let i=s.resolve(e);for(let r=i.depth+1;r>0;r--){let o=r>i.depth?i.nodeAfter:i.node(r),a=i.before(r);if(o.inlineContent)ki(n,Le.create(s,a+1,a+1+o.content.size));else if(fe.isSelectable(o))ki(n,fe.create(s,a));else continue;return!0}}function fc(n){return No(n)}const Bp=sn?"metaKey":"ctrlKey";Ft.mousedown=(n,e)=>{let t=e;n.input.shiftKey=t.shiftKey;let s=fc(n),i=Date.now(),r="singleClick";i-n.input.lastClick.time<500&&eM(t,n.input.lastClick)&&!t[Bp]&&(n.input.lastClick.type=="singleClick"?r="doubleClick":n.input.lastClick.type=="doubleClick"&&(r="tripleClick")),n.input.lastClick={time:i,x:t.clientX,y:t.clientY,type:r};let o=n.posAtCoords(ea(t));o&&(r=="singleClick"?(n.input.mouseDown&&n.input.mouseDown.done(),n.input.mouseDown=new aM(n,o,t,!!s)):(r=="doubleClick"?iM:rM)(n,o.pos,o.inside,t)?t.preventDefault():xs(n,"pointer"))};class aM{constructor(e,t,s,i){this.view=e,this.pos=t,this.event=s,this.flushed=i,this.delayedSelectionSync=!1,this.mightDrag=null,this.startDoc=e.state.doc,this.selectNode=!!s[Bp],this.allowDefault=s.shiftKey;let r,o;if(t.inside>-1)r=e.state.doc.nodeAt(t.inside),o=t.inside;else{let u=e.state.doc.resolve(t.pos);r=u.parent,o=u.depth?u.before():0}const a=i?null:s.target,l=a?e.docView.nearestDesc(a,!0):null;this.target=l&&l.dom.nodeType==1?l.dom:null;let{selection:d}=e.state;(s.button==0&&r.type.spec.draggable&&r.type.spec.selectable!==!1||d instanceof fe&&d.from<=o&&d.to>o)&&(this.mightDrag={node:r,pos:o,addAttr:!!(this.target&&!this.target.draggable),setUneditable:!!(this.target&&Cn&&!this.target.hasAttribute("contentEditable"))}),this.target&&this.mightDrag&&(this.mightDrag.addAttr||this.mightDrag.setUneditable)&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&(this.target.draggable=!0),this.mightDrag.setUneditable&&setTimeout(()=>{this.view.input.mouseDown==this&&this.target.setAttribute("contentEditable","false")},20),this.view.domObserver.start()),e.root.addEventListener("mouseup",this.up=this.up.bind(this)),e.root.addEventListener("mousemove",this.move=this.move.bind(this)),xs(e,"pointer")}done(){this.view.root.removeEventListener("mouseup",this.up),this.view.root.removeEventListener("mousemove",this.move),this.mightDrag&&this.target&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&this.target.removeAttribute("draggable"),this.mightDrag.setUneditable&&this.target.removeAttribute("contentEditable"),this.view.domObserver.start()),this.delayedSelectionSync&&setTimeout(()=>Qn(this.view)),this.view.input.mouseDown=null}up(e){if(this.done(),!this.view.dom.contains(e.target))return;let t=this.pos;this.view.state.doc!=this.startDoc&&(t=this.view.posAtCoords(ea(e))),this.updateAllowDefault(e),this.allowDefault||!t?xs(this.view,"pointer"):sM(this.view,t.pos,t.inside,e,this.selectNode)?e.preventDefault():e.button==0&&(this.flushed||Pt&&this.mightDrag&&!this.mightDrag.node.isAtom||Nt&&!this.view.state.selection.visible&&Math.min(Math.abs(t.pos-this.view.state.selection.from),Math.abs(t.pos-this.view.state.selection.to))<=2)?(ki(this.view,_e.near(this.view.state.doc.resolve(t.pos))),e.preventDefault()):xs(this.view,"pointer")}move(e){this.updateAllowDefault(e),xs(this.view,"pointer"),e.buttons==0&&this.done()}updateAllowDefault(e){!this.allowDefault&&(Math.abs(this.event.x-e.clientX)>4||Math.abs(this.event.y-e.clientY)>4)&&(this.allowDefault=!0)}}Ft.touchstart=n=>{n.input.lastTouch=Date.now(),fc(n),xs(n,"pointer")};Ft.touchmove=n=>{n.input.lastTouch=Date.now(),xs(n,"pointer")};Ft.contextmenu=n=>fc(n);function Lp(n,e){return n.composing?!0:Pt&&Math.abs(e.timeStamp-n.input.compositionEndedAt)<500?(n.input.compositionEndedAt=-2e8,!0):!1}const lM=wn?5e3:-1;Bt.compositionstart=Bt.compositionupdate=n=>{if(!n.composing){n.domObserver.flush();let{state:e}=n,t=e.selection.$from;if(e.selection.empty&&(e.storedMarks||!t.textOffset&&t.parentOffset&&t.nodeBefore.marks.some(s=>s.type.spec.inclusive===!1)))n.markCursor=n.state.storedMarks||t.marks(),No(n,!0),n.markCursor=null;else if(No(n),Cn&&e.selection.empty&&t.parentOffset&&!t.textOffset&&t.nodeBefore.marks.length){let s=n.domSelectionRange();for(let i=s.focusNode,r=s.focusOffset;i&&i.nodeType==1&&r!=0;){let o=r<0?i.lastChild:i.childNodes[r-1];if(!o)break;if(o.nodeType==3){n.domSelection().collapse(o,o.nodeValue.length);break}else i=o,r=-1}}n.input.composing=!0}zp(n,lM)};Bt.compositionend=(n,e)=>{n.composing&&(n.input.composing=!1,n.input.compositionEndedAt=e.timeStamp,n.input.compositionPendingChanges=n.domObserver.pendingRecords().length?n.input.compositionID:0,n.input.compositionNode=null,n.input.compositionPendingChanges&&Promise.resolve().then(()=>n.domObserver.flush()),n.input.compositionID++,zp(n,20))};function zp(n,e){clearTimeout(n.input.composingTimeout),e>-1&&(n.input.composingTimeout=setTimeout(()=>No(n),e))}function Up(n){for(n.composing&&(n.input.composing=!1,n.input.compositionEndedAt=dM());n.input.compositionNodes.length>0;)n.input.compositionNodes.pop().markParentsDirty()}function cM(n){let e=n.domSelectionRange();if(!e.focusNode)return null;let t=nC(e.focusNode,e.focusOffset),s=sC(e.focusNode,e.focusOffset);if(t&&s&&t!=s){let i=s.pmViewDesc,r=n.domObserver.lastChangedTextNode;if(t==r||s==r)return r;if(!i||!i.isText(s.nodeValue))return s;if(n.input.compositionNode==s){let o=t.pmViewDesc;if(!(!o||!o.isText(t.nodeValue)))return s}}return t||s}function dM(){let n=document.createEvent("Event");return n.initEvent("event",!0,!0),n.timeStamp}function No(n,e=!1){if(!(wn&&n.domObserver.flushingSoon>=0)){if(n.domObserver.forceFlush(),Up(n),e||n.docView&&n.docView.dirty){let t=cc(n);return t&&!t.eq(n.state.selection)?n.dispatch(n.state.tr.setSelection(t)):n.updateState(n.state),!0}return!1}}function uM(n,e){if(!n.dom.parentNode)return;let t=n.dom.parentNode.appendChild(document.createElement("div"));t.appendChild(e),t.style.cssText="position: fixed; left: -10000px; top: 10px";let s=getSelection(),i=document.createRange();i.selectNodeContents(e),n.dom.blur(),s.removeAllRanges(),s.addRange(i),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t),n.focus()},50)}const yr=Ut&&ws<15||Oi&&lC<604;Ft.copy=Bt.cut=(n,e)=>{let t=e,s=n.state.selection,i=t.type=="cut";if(s.empty)return;let r=yr?null:t.clipboardData,o=s.content(),{dom:a,text:l}=Ap(n,o);r?(t.preventDefault(),r.clearData(),r.setData("text/html",a.innerHTML),r.setData("text/plain",l)):uM(n,a),i&&n.dispatch(n.state.tr.deleteSelection().scrollIntoView().setMeta("uiEvent","cut"))};function hM(n){return n.openStart==0&&n.openEnd==0&&n.content.childCount==1?n.content.firstChild:null}function fM(n,e){if(!n.dom.parentNode)return;let t=n.input.shiftKey||n.state.selection.$from.parent.type.spec.code,s=n.dom.parentNode.appendChild(document.createElement(t?"textarea":"div"));t||(s.contentEditable="true"),s.style.cssText="position: fixed; left: -10000px; top: 10px",s.focus();let i=n.input.shiftKey&&n.input.lastKeyCode!=45;setTimeout(()=>{n.focus(),s.parentNode&&s.parentNode.removeChild(s),t?xr(n,s.value,null,i,e):xr(n,s.textContent,s.innerHTML,i,e)},50)}function xr(n,e,t,s,i){let r=Rp(n,e,t,s,n.state.selection.$from);if(n.someProp("handlePaste",l=>l(n,i,r||X.empty)))return!0;if(!r)return!1;let o=hM(r),a=o?n.state.tr.replaceSelectionWith(o,s):n.state.tr.replaceSelection(r);return n.dispatch(a.scrollIntoView().setMeta("paste",!0).setMeta("uiEvent","paste")),!0}function Vp(n){let e=n.getData("text/plain")||n.getData("Text");if(e)return e;let t=n.getData("text/uri-list");return t?t.replace(/\r?\n/g," "):""}Bt.paste=(n,e)=>{let t=e;if(n.composing&&!wn)return;let s=yr?null:t.clipboardData,i=n.input.shiftKey&&n.input.lastKeyCode!=45;s&&xr(n,Vp(s),s.getData("text/html"),i,t)?t.preventDefault():fM(n,t)};class Wp{constructor(e,t,s){this.slice=e,this.move=t,this.node=s}}const Gp=sn?"altKey":"ctrlKey";Ft.dragstart=(n,e)=>{let t=e,s=n.input.mouseDown;if(s&&s.done(),!t.dataTransfer)return;let i=n.state.selection,r=i.empty?null:n.posAtCoords(ea(t)),o;if(!(r&&r.pos>=i.from&&r.pos<=(i instanceof fe?i.to-1:i.to))){if(s&&s.mightDrag)o=fe.create(n.state.doc,s.mightDrag.pos);else if(t.target&&t.target.nodeType==1){let p=n.docView.nearestDesc(t.target,!0);p&&p.node.type.spec.draggable&&p!=n.docView&&(o=fe.create(n.state.doc,p.posBefore))}}let a=(o||n.state.selection).content(),{dom:l,text:d,slice:u}=Ap(n,a);(!t.dataTransfer.files.length||!Nt||mp>120)&&t.dataTransfer.clearData(),t.dataTransfer.setData(yr?"Text":"text/html",l.innerHTML),t.dataTransfer.effectAllowed="copyMove",yr||t.dataTransfer.setData("text/plain",d),n.dragging=new Wp(u,!t[Gp],o)};Ft.dragend=n=>{let e=n.dragging;window.setTimeout(()=>{n.dragging==e&&(n.dragging=null)},50)};Bt.dragover=Bt.dragenter=(n,e)=>e.preventDefault();Bt.drop=(n,e)=>{let t=e,s=n.dragging;if(n.dragging=null,!t.dataTransfer)return;let i=n.posAtCoords(ea(t));if(!i)return;let r=n.state.doc.resolve(i.pos),o=s&&s.slice;o?n.someProp("transformPasted",g=>{o=g(o,n)}):o=Rp(n,Vp(t.dataTransfer),yr?null:t.dataTransfer.getData("text/html"),!1,r);let a=!!(s&&!t[Gp]);if(n.someProp("handleDrop",g=>g(n,t,o||X.empty,a))){t.preventDefault();return}if(!o)return;t.preventDefault();let l=o?xk(n.state.doc,r.pos,o):r.pos;l==null&&(l=r.pos);let d=n.state.tr;if(a){let{node:g}=s;g?g.replace(d):d.deleteSelection()}let u=d.mapping.map(l),p=o.openStart==0&&o.openEnd==0&&o.content.childCount==1,m=d.doc;if(p?d.replaceRangeWith(u,u,o.content.firstChild):d.replaceRange(u,u,o),d.doc.eq(m))return;let b=d.doc.resolve(u);if(p&&fe.isSelectable(o.content.firstChild)&&b.nodeAfter&&b.nodeAfter.sameMarkup(o.content.firstChild))d.setSelection(new fe(b));else{let g=d.mapping.map(l);d.mapping.maps[d.mapping.maps.length-1].forEach((y,C,M,_)=>g=_),d.setSelection(dc(n,b,d.doc.resolve(g)))}n.focus(),n.dispatch(d.setMeta("uiEvent","drop"))};Ft.focus=n=>{n.input.lastFocus=Date.now(),n.focused||(n.domObserver.stop(),n.dom.classList.add("ProseMirror-focused"),n.domObserver.start(),n.focused=!0,setTimeout(()=>{n.docView&&n.hasFocus()&&!n.domObserver.currentSelection.eq(n.domSelectionRange())&&Qn(n)},20))};Ft.blur=(n,e)=>{let t=e;n.focused&&(n.domObserver.stop(),n.dom.classList.remove("ProseMirror-focused"),n.domObserver.start(),t.relatedTarget&&n.dom.contains(t.relatedTarget)&&n.domObserver.currentSelection.clear(),n.focused=!1)};Ft.beforeinput=(n,e)=>{if(Nt&&wn&&e.inputType=="deleteContentBackward"){n.domObserver.flushSoon();let{domChangeCount:s}=n.input;setTimeout(()=>{if(n.input.domChangeCount!=s||(n.dom.blur(),n.focus(),n.someProp("handleKeyDown",r=>r(n,Ls(8,"Backspace")))))return;let{$cursor:i}=n.state.selection;i&&i.pos>0&&n.dispatch(n.state.tr.delete(i.pos-1,i.pos).scrollIntoView())},50)}};for(let n in Bt)Ft[n]=Bt[n];function br(n,e){if(n==e)return!0;for(let t in n)if(n[t]!==e[t])return!1;for(let t in e)if(!(t in n))return!1;return!0}class Io{constructor(e,t){this.toDOM=e,this.spec=t||$s,this.side=this.spec.side||0}map(e,t,s,i){let{pos:r,deleted:o}=e.mapResult(t.from+i,this.side<0?-1:1);return o?null:new Jt(r-s,r-s,this)}valid(){return!0}eq(e){return this==e||e instanceof Io&&(this.spec.key&&this.spec.key==e.spec.key||this.toDOM==e.toDOM&&br(this.spec,e.spec))}destroy(e){this.spec.destroy&&this.spec.destroy(e)}}class ks{constructor(e,t){this.attrs=e,this.spec=t||$s}map(e,t,s,i){let r=e.map(t.from+i,this.spec.inclusiveStart?-1:1)-s,o=e.map(t.to+i,this.spec.inclusiveEnd?1:-1)-s;return r>=o?null:new Jt(r,o,this)}valid(e,t){return t.from<t.to}eq(e){return this==e||e instanceof ks&&br(this.attrs,e.attrs)&&br(this.spec,e.spec)}static is(e){return e.type instanceof ks}destroy(){}}class pc{constructor(e,t){this.attrs=e,this.spec=t||$s}map(e,t,s,i){let r=e.mapResult(t.from+i,1);if(r.deleted)return null;let o=e.mapResult(t.to+i,-1);return o.deleted||o.pos<=r.pos?null:new Jt(r.pos-s,o.pos-s,this)}valid(e,t){let{index:s,offset:i}=e.content.findIndex(t.from),r;return i==t.from&&!(r=e.child(s)).isText&&i+r.nodeSize==t.to}eq(e){return this==e||e instanceof pc&&br(this.attrs,e.attrs)&&br(this.spec,e.spec)}destroy(){}}class Jt{constructor(e,t,s){this.from=e,this.to=t,this.type=s}copy(e,t){return new Jt(e,t,this.type)}eq(e,t=0){return this.type.eq(e.type)&&this.from+t==e.from&&this.to+t==e.to}map(e,t,s){return this.type.map(e,this,t,s)}static widget(e,t,s){return new Jt(e,e,new Io(t,s))}static inline(e,t,s,i){return new Jt(e,t,new ks(s,i))}static node(e,t,s,i){return new Jt(e,t,new pc(s,i))}get spec(){return this.type.spec}get inline(){return this.type instanceof ks}get widget(){return this.type instanceof Io}}const yi=[],$s={};class ct{constructor(e,t){this.local=e.length?e:yi,this.children=t.length?t:yi}static create(e,t){return t.length?Ao(t,e,0,$s):Tt}find(e,t,s){let i=[];return this.findInner(e??0,t??1e9,i,0,s),i}findInner(e,t,s,i,r){for(let o=0;o<this.local.length;o++){let a=this.local[o];a.from<=t&&a.to>=e&&(!r||r(a.spec))&&s.push(a.copy(a.from+i,a.to+i))}for(let o=0;o<this.children.length;o+=3)if(this.children[o]<t&&this.children[o+1]>e){let a=this.children[o]+1;this.children[o+2].findInner(e-a,t-a,s,i+a,r)}}map(e,t,s){return this==Tt||e.maps.length==0?this:this.mapInner(e,t,0,0,s||$s)}mapInner(e,t,s,i,r){let o;for(let a=0;a<this.local.length;a++){let l=this.local[a].map(e,s,i);l&&l.type.valid(t,l)?(o||(o=[])).push(l):r.onRemove&&r.onRemove(this.local[a].spec)}return this.children.length?pM(this.children,o||[],e,t,s,i,r):o?new ct(o.sort(Ks),yi):Tt}add(e,t){return t.length?this==Tt?ct.create(e,t):this.addInner(e,t,0):this}addInner(e,t,s){let i,r=0;e.forEach((a,l)=>{let d=l+s,u;if(u=Hp(t,a,d)){for(i||(i=this.children.slice());r<i.length&&i[r]<l;)r+=3;i[r]==l?i[r+2]=i[r+2].addInner(a,u,d+1):i.splice(r,0,l,l+a.nodeSize,Ao(u,a,d+1,$s)),r+=3}});let o=qp(r?$p(t):t,-s);for(let a=0;a<o.length;a++)o[a].type.valid(e,o[a])||o.splice(a--,1);return new ct(o.length?this.local.concat(o).sort(Ks):this.local,i||this.children)}remove(e){return e.length==0||this==Tt?this:this.removeInner(e,0)}removeInner(e,t){let s=this.children,i=this.local;for(let r=0;r<s.length;r+=3){let o,a=s[r]+t,l=s[r+1]+t;for(let u=0,p;u<e.length;u++)(p=e[u])&&p.from>a&&p.to<l&&(e[u]=null,(o||(o=[])).push(p));if(!o)continue;s==this.children&&(s=this.children.slice());let d=s[r+2].removeInner(o,a+1);d!=Tt?s[r+2]=d:(s.splice(r,3),r-=3)}if(i.length){for(let r=0,o;r<e.length;r++)if(o=e[r])for(let a=0;a<i.length;a++)i[a].eq(o,t)&&(i==this.local&&(i=this.local.slice()),i.splice(a--,1))}return s==this.children&&i==this.local?this:i.length||s.length?new ct(i,s):Tt}forChild(e,t){if(this==Tt)return this;if(t.isLeaf)return ct.empty;let s,i;for(let a=0;a<this.children.length;a+=3)if(this.children[a]>=e){this.children[a]==e&&(s=this.children[a+2]);break}let r=e+1,o=r+t.content.size;for(let a=0;a<this.local.length;a++){let l=this.local[a];if(l.from<o&&l.to>r&&l.type instanceof ks){let d=Math.max(r,l.from)-r,u=Math.min(o,l.to)-r;d<u&&(i||(i=[])).push(l.copy(d,u))}}if(i){let a=new ct(i.sort(Ks),yi);return s?new fs([a,s]):a}return s||Tt}eq(e){if(this==e)return!0;if(!(e instanceof ct)||this.local.length!=e.local.length||this.children.length!=e.children.length)return!1;for(let t=0;t<this.local.length;t++)if(!this.local[t].eq(e.local[t]))return!1;for(let t=0;t<this.children.length;t+=3)if(this.children[t]!=e.children[t]||this.children[t+1]!=e.children[t+1]||!this.children[t+2].eq(e.children[t+2]))return!1;return!0}locals(e){return mc(this.localsInner(e))}localsInner(e){if(this==Tt)return yi;if(e.inlineContent||!this.local.some(ks.is))return this.local;let t=[];for(let s=0;s<this.local.length;s++)this.local[s].type instanceof ks||t.push(this.local[s]);return t}}ct.empty=new ct([],[]);ct.removeOverlap=mc;const Tt=ct.empty;class fs{constructor(e){this.members=e}map(e,t){const s=this.members.map(i=>i.map(e,t,$s));return fs.from(s)}forChild(e,t){if(t.isLeaf)return ct.empty;let s=[];for(let i=0;i<this.members.length;i++){let r=this.members[i].forChild(e,t);r!=Tt&&(r instanceof fs?s=s.concat(r.members):s.push(r))}return fs.from(s)}eq(e){if(!(e instanceof fs)||e.members.length!=this.members.length)return!1;for(let t=0;t<this.members.length;t++)if(!this.members[t].eq(e.members[t]))return!1;return!0}locals(e){let t,s=!0;for(let i=0;i<this.members.length;i++){let r=this.members[i].localsInner(e);if(r.length)if(!t)t=r;else{s&&(t=t.slice(),s=!1);for(let o=0;o<r.length;o++)t.push(r[o])}}return t?mc(s?t:t.sort(Ks)):yi}static from(e){switch(e.length){case 0:return Tt;case 1:return e[0];default:return new fs(e.every(t=>t instanceof ct)?e:e.reduce((t,s)=>t.concat(s instanceof ct?s:s.members),[]))}}}function pM(n,e,t,s,i,r,o){let a=n.slice();for(let d=0,u=r;d<t.maps.length;d++){let p=0;t.maps[d].forEach((m,b,g,y)=>{let C=y-g-(b-m);for(let M=0;M<a.length;M+=3){let _=a[M+1];if(_<0||m>_+u-p)continue;let R=a[M]+u-p;b>=R?a[M+1]=m<=R?-2:-1:m>=u&&C&&(a[M]+=C,a[M+1]+=C)}p+=C}),u=t.maps[d].map(u,-1)}let l=!1;for(let d=0;d<a.length;d+=3)if(a[d+1]<0){if(a[d+1]==-2){l=!0,a[d+1]=-1;continue}let u=t.map(n[d]+r),p=u-i;if(p<0||p>=s.content.size){l=!0;continue}let m=t.map(n[d+1]+r,-1),b=m-i,{index:g,offset:y}=s.content.findIndex(p),C=s.maybeChild(g);if(C&&y==p&&y+C.nodeSize==b){let M=a[d+2].mapInner(t,C,u+1,n[d]+r+1,o);M!=Tt?(a[d]=p,a[d+1]=b,a[d+2]=M):(a[d+1]=-2,l=!0)}else l=!0}if(l){let d=mM(a,n,e,t,i,r,o),u=Ao(d,s,0,o);e=u.local;for(let p=0;p<a.length;p+=3)a[p+1]<0&&(a.splice(p,3),p-=3);for(let p=0,m=0;p<u.children.length;p+=3){let b=u.children[p];for(;m<a.length&&a[m]<b;)m+=3;a.splice(m,0,u.children[p],u.children[p+1],u.children[p+2])}}return new ct(e.sort(Ks),a)}function qp(n,e){if(!e||!n.length)return n;let t=[];for(let s=0;s<n.length;s++){let i=n[s];t.push(new Jt(i.from+e,i.to+e,i.type))}return t}function mM(n,e,t,s,i,r,o){function a(l,d){for(let u=0;u<l.local.length;u++){let p=l.local[u].map(s,i,d);p?t.push(p):o.onRemove&&o.onRemove(l.local[u].spec)}for(let u=0;u<l.children.length;u+=3)a(l.children[u+2],l.children[u]+d+1)}for(let l=0;l<n.length;l+=3)n[l+1]==-1&&a(n[l+2],e[l]+r+1);return t}function Hp(n,e,t){if(e.isLeaf)return null;let s=t+e.nodeSize,i=null;for(let r=0,o;r<n.length;r++)(o=n[r])&&o.from>t&&o.to<s&&((i||(i=[])).push(o),n[r]=null);return i}function $p(n){let e=[];for(let t=0;t<n.length;t++)n[t]!=null&&e.push(n[t]);return e}function Ao(n,e,t,s){let i=[],r=!1;e.forEach((a,l)=>{let d=Hp(n,a,l+t);if(d){r=!0;let u=Ao(d,a,t+l+1,s);u!=Tt&&i.push(l,l+a.nodeSize,u)}});let o=qp(r?$p(n):n,-t).sort(Ks);for(let a=0;a<o.length;a++)o[a].type.valid(e,o[a])||(s.onRemove&&s.onRemove(o[a].spec),o.splice(a--,1));return o.length||i.length?new ct(o,i):Tt}function Ks(n,e){return n.from-e.from||n.to-e.to}function mc(n){let e=n;for(let t=0;t<e.length-1;t++){let s=e[t];if(s.from!=s.to)for(let i=t+1;i<e.length;i++){let r=e[i];if(r.from==s.from){r.to!=s.to&&(e==n&&(e=n.slice()),e[i]=r.copy(r.from,s.to),Zd(e,i+1,r.copy(s.to,r.to)));continue}else{r.from<s.to&&(e==n&&(e=n.slice()),e[t]=s.copy(s.from,r.from),Zd(e,i,s.copy(r.from,s.to)));break}}}return e}function Zd(n,e,t){for(;e<n.length&&Ks(t,n[e])>0;)e++;n.splice(e,0,t)}function ka(n){let e=[];return n.someProp("decorations",t=>{let s=t(n.state);s&&s!=Tt&&e.push(s)}),n.cursorWrapper&&e.push(ct.create(n.state.doc,[n.cursorWrapper.deco])),fs.from(e)}const gM={childList:!0,characterData:!0,characterDataOldValue:!0,attributes:!0,attributeOldValue:!0,subtree:!0},yM=Ut&&ws<=11;class xM{constructor(){this.anchorNode=null,this.anchorOffset=0,this.focusNode=null,this.focusOffset=0}set(e){this.anchorNode=e.anchorNode,this.anchorOffset=e.anchorOffset,this.focusNode=e.focusNode,this.focusOffset=e.focusOffset}clear(){this.anchorNode=this.focusNode=null}eq(e){return e.anchorNode==this.anchorNode&&e.anchorOffset==this.anchorOffset&&e.focusNode==this.focusNode&&e.focusOffset==this.focusOffset}}class bM{constructor(e,t){this.view=e,this.handleDOMChange=t,this.queue=[],this.flushingSoon=-1,this.observer=null,this.currentSelection=new xM,this.onCharData=null,this.suppressingSelectionUpdates=!1,this.lastChangedTextNode=null,this.observer=window.MutationObserver&&new window.MutationObserver(s=>{for(let i=0;i<s.length;i++)this.queue.push(s[i]);Ut&&ws<=11&&s.some(i=>i.type=="childList"&&i.removedNodes.length||i.type=="characterData"&&i.oldValue.length>i.target.nodeValue.length)?this.flushSoon():this.flush()}),yM&&(this.onCharData=s=>{this.queue.push({target:s.target,type:"characterData",oldValue:s.prevValue}),this.flushSoon()}),this.onSelectionChange=this.onSelectionChange.bind(this)}flushSoon(){this.flushingSoon<0&&(this.flushingSoon=window.setTimeout(()=>{this.flushingSoon=-1,this.flush()},20))}forceFlush(){this.flushingSoon>-1&&(window.clearTimeout(this.flushingSoon),this.flushingSoon=-1,this.flush())}start(){this.observer&&(this.observer.takeRecords(),this.observer.observe(this.view.dom,gM)),this.onCharData&&this.view.dom.addEventListener("DOMCharacterDataModified",this.onCharData),this.connectSelection()}stop(){if(this.observer){let e=this.observer.takeRecords();if(e.length){for(let t=0;t<e.length;t++)this.queue.push(e[t]);window.setTimeout(()=>this.flush(),20)}this.observer.disconnect()}this.onCharData&&this.view.dom.removeEventListener("DOMCharacterDataModified",this.onCharData),this.disconnectSelection()}connectSelection(){this.view.dom.ownerDocument.addEventListener("selectionchange",this.onSelectionChange)}disconnectSelection(){this.view.dom.ownerDocument.removeEventListener("selectionchange",this.onSelectionChange)}suppressSelectionUpdates(){this.suppressingSelectionUpdates=!0,setTimeout(()=>this.suppressingSelectionUpdates=!1,50)}onSelectionChange(){if(qd(this.view)){if(this.suppressingSelectionUpdates)return Qn(this.view);if(Ut&&ws<=11&&!this.view.state.selection.empty){let e=this.view.domSelectionRange();if(e.focusNode&&Zs(e.focusNode,e.focusOffset,e.anchorNode,e.anchorOffset))return this.flushSoon()}this.flush()}}setCurSelection(){this.currentSelection.set(this.view.domSelectionRange())}ignoreSelectionChange(e){if(!e.focusNode)return!0;let t=new Set,s;for(let r=e.focusNode;r;r=gr(r))t.add(r);for(let r=e.anchorNode;r;r=gr(r))if(t.has(r)){s=r;break}let i=s&&this.view.docView.nearestDesc(s);if(i&&i.ignoreMutation({type:"selection",target:s.nodeType==3?s.parentNode:s}))return this.setCurSelection(),!0}pendingRecords(){if(this.observer)for(let e of this.observer.takeRecords())this.queue.push(e);return this.queue}flush(){let{view:e}=this;if(!e.docView||this.flushingSoon>-1)return;let t=this.pendingRecords();t.length&&(this.queue=[]);let s=e.domSelectionRange(),i=!this.suppressingSelectionUpdates&&!this.currentSelection.eq(s)&&qd(e)&&!this.ignoreSelectionChange(s),r=-1,o=-1,a=!1,l=[];if(e.editable)for(let u=0;u<t.length;u++){let p=this.registerMutation(t[u],l);p&&(r=r<0?p.from:Math.min(p.from,r),o=o<0?p.to:Math.max(p.to,o),p.typeOver&&(a=!0))}if(Cn&&l.length){let u=l.filter(p=>p.nodeName=="BR");if(u.length==2){let[p,m]=u;p.parentNode&&p.parentNode.parentNode==m.parentNode?m.remove():p.remove()}else{let{focusNode:p}=this.currentSelection;for(let m of u){let b=m.parentNode;b&&b.nodeName=="LI"&&(!p||kM(e,p)!=b)&&m.remove()}}}let d=null;r<0&&i&&e.input.lastFocus>Date.now()-200&&Math.max(e.input.lastTouch,e.input.lastClick.time)<Date.now()-300&&Xo(s)&&(d=cc(e))&&d.eq(_e.near(e.state.doc.resolve(0),1))?(e.input.lastFocus=0,Qn(e),this.currentSelection.set(s),e.scrollToSelection()):(r>-1||i)&&(r>-1&&(e.docView.markDirty(r,o),wM(e)),this.handleDOMChange(r,o,a,l),e.docView&&e.docView.dirty?e.updateState(e.state):this.currentSelection.eq(s)||Qn(e),this.currentSelection.set(s))}registerMutation(e,t){if(t.indexOf(e.target)>-1)return null;let s=this.view.docView.nearestDesc(e.target);if(e.type=="attributes"&&(s==this.view.docView||e.attributeName=="contenteditable"||e.attributeName=="style"&&!e.oldValue&&!e.target.getAttribute("style"))||!s||s.ignoreMutation(e))return null;if(e.type=="childList"){for(let u=0;u<e.addedNodes.length;u++){let p=e.addedNodes[u];t.push(p),p.nodeType==3&&(this.lastChangedTextNode=p)}if(s.contentDOM&&s.contentDOM!=s.dom&&!s.contentDOM.contains(e.target))return{from:s.posBefore,to:s.posAfter};let i=e.previousSibling,r=e.nextSibling;if(Ut&&ws<=11&&e.addedNodes.length)for(let u=0;u<e.addedNodes.length;u++){let{previousSibling:p,nextSibling:m}=e.addedNodes[u];(!p||Array.prototype.indexOf.call(e.addedNodes,p)<0)&&(i=p),(!m||Array.prototype.indexOf.call(e.addedNodes,m)<0)&&(r=m)}let o=i&&i.parentNode==e.target?bt(i)+1:0,a=s.localPosFromDOM(e.target,o,-1),l=r&&r.parentNode==e.target?bt(r):e.target.childNodes.length,d=s.localPosFromDOM(e.target,l,1);return{from:a,to:d}}else return e.type=="attributes"?{from:s.posAtStart-s.border,to:s.posAtEnd+s.border}:(this.lastChangedTextNode=e.target,{from:s.posAtStart,to:s.posAtEnd,typeOver:e.target.nodeValue==e.oldValue})}}let eu=new WeakMap,tu=!1;function wM(n){if(!eu.has(n)&&(eu.set(n,null),["normal","nowrap","pre-line"].indexOf(getComputedStyle(n.dom).whiteSpace)!==-1)){if(n.requiresGeckoHackNode=Cn,tu)return;console.warn("ProseMirror expects the CSS white-space property to be set, preferably to 'pre-wrap'. It is recommended to load style/prosemirror.css from the prosemirror-view package."),tu=!0}}function nu(n,e){let t=e.startContainer,s=e.startOffset,i=e.endContainer,r=e.endOffset,o=n.domAtPos(n.state.selection.anchor);return Zs(o.node,o.offset,i,r)&&([t,s,i,r]=[i,r,t,s]),{anchorNode:t,anchorOffset:s,focusNode:i,focusOffset:r}}function SM(n,e){if(e.getComposedRanges){let i=e.getComposedRanges(n.root)[0];if(i)return nu(n,i)}let t;function s(i){i.preventDefault(),i.stopImmediatePropagation(),t=i.getTargetRanges()[0]}return n.dom.addEventListener("beforeinput",s,!0),document.execCommand("indent"),n.dom.removeEventListener("beforeinput",s,!0),t?nu(n,t):null}function kM(n,e){for(let t=e.parentNode;t&&t!=n.dom;t=t.parentNode){let s=n.docView.nearestDesc(t,!0);if(s&&s.node.isBlock)return t}return null}function CM(n,e,t){let{node:s,fromOffset:i,toOffset:r,from:o,to:a}=n.docView.parseRange(e,t),l=n.domSelectionRange(),d,u=l.anchorNode;if(u&&n.dom.contains(u.nodeType==1?u:u.parentNode)&&(d=[{node:u,offset:l.anchorOffset}],Xo(l)||d.push({node:l.focusNode,offset:l.focusOffset})),Nt&&n.input.lastKeyCode===8)for(let C=r;C>i;C--){let M=s.childNodes[C-1],_=M.pmViewDesc;if(M.nodeName=="BR"&&!_){r=C;break}if(!_||_.size)break}let p=n.state.doc,m=n.someProp("domParser")||pr.fromSchema(n.state.schema),b=p.resolve(o),g=null,y=m.parse(s,{topNode:b.parent,topMatch:b.parent.contentMatchAt(b.index()),topOpen:!0,from:i,to:r,preserveWhitespace:b.parent.type.whitespace=="pre"?"full":!0,findPositions:d,ruleFromNode:MM,context:b});if(d&&d[0].pos!=null){let C=d[0].pos,M=d[1]&&d[1].pos;M==null&&(M=C),g={anchor:C+o,head:M+o}}return{doc:y,sel:g,from:o,to:a}}function MM(n){let e=n.pmViewDesc;if(e)return e.parseRule();if(n.nodeName=="BR"&&n.parentNode){if(Pt&&/^(ul|ol)$/i.test(n.parentNode.nodeName)){let t=document.createElement("div");return t.appendChild(document.createElement("li")),{skip:t}}else if(n.parentNode.lastChild==n||Pt&&/^(tr|table)$/i.test(n.parentNode.nodeName))return{ignore:!0}}else if(n.nodeName=="IMG"&&n.getAttribute("mark-placeholder"))return{ignore:!0};return null}const vM=/^(a|abbr|acronym|b|bd[io]|big|br|button|cite|code|data(list)?|del|dfn|em|i|ins|kbd|label|map|mark|meter|output|q|ruby|s|samp|small|span|strong|su[bp]|time|u|tt|var)$/i;function TM(n,e,t,s,i){let r=n.input.compositionPendingChanges||(n.composing?n.input.compositionID:0);if(n.input.compositionPendingChanges=0,e<0){let A=n.input.lastSelectionTime>Date.now()-50?n.input.lastSelectionOrigin:null,G=cc(n,A);if(G&&!n.state.selection.eq(G)){if(Nt&&wn&&n.input.lastKeyCode===13&&Date.now()-100<n.input.lastKeyCodeTime&&n.someProp("handleKeyDown",j=>j(n,Ls(13,"Enter"))))return;let W=n.state.tr.setSelection(G);A=="pointer"?W.setMeta("pointer",!0):A=="key"&&W.scrollIntoView(),r&&W.setMeta("composition",r),n.dispatch(W)}return}let o=n.state.doc.resolve(e),a=o.sharedDepth(t);e=o.before(a+1),t=n.state.doc.resolve(t).after(a+1);let l=n.state.selection,d=CM(n,e,t),u=n.state.doc,p=u.slice(d.from,d.to),m,b;n.input.lastKeyCode===8&&Date.now()-100<n.input.lastKeyCodeTime?(m=n.state.selection.to,b="end"):(m=n.state.selection.from,b="start"),n.input.lastKeyCode=null;let g=NM(p.content,d.doc.content,d.from,m,b);if((Oi&&n.input.lastIOSEnter>Date.now()-225||wn)&&i.some(A=>A.nodeType==1&&!vM.test(A.nodeName))&&(!g||g.endA>=g.endB)&&n.someProp("handleKeyDown",A=>A(n,Ls(13,"Enter")))){n.input.lastIOSEnter=0;return}if(!g)if(s&&l instanceof Le&&!l.empty&&l.$head.sameParent(l.$anchor)&&!n.composing&&!(d.sel&&d.sel.anchor!=d.sel.head))g={start:l.from,endA:l.to,endB:l.to};else{if(d.sel){let A=su(n,n.state.doc,d.sel);if(A&&!A.eq(n.state.selection)){let G=n.state.tr.setSelection(A);r&&G.setMeta("composition",r),n.dispatch(G)}}return}n.input.domChangeCount++,n.state.selection.from<n.state.selection.to&&g.start==g.endB&&n.state.selection instanceof Le&&(g.start>n.state.selection.from&&g.start<=n.state.selection.from+2&&n.state.selection.from>=d.from?g.start=n.state.selection.from:g.endA<n.state.selection.to&&g.endA>=n.state.selection.to-2&&n.state.selection.to<=d.to&&(g.endB+=n.state.selection.to-g.endA,g.endA=n.state.selection.to)),Ut&&ws<=11&&g.endB==g.start+1&&g.endA==g.start&&g.start>d.from&&d.doc.textBetween(g.start-d.from-1,g.start-d.from+1)==" "&&(g.start--,g.endA--,g.endB--);let y=d.doc.resolveNoCache(g.start-d.from),C=d.doc.resolveNoCache(g.endB-d.from),M=u.resolve(g.start),_=y.sameParent(C)&&y.parent.inlineContent&&M.end()>=g.endA,R;if((Oi&&n.input.lastIOSEnter>Date.now()-225&&(!_||i.some(A=>A.nodeName=="DIV"||A.nodeName=="P"))||!_&&y.pos<d.doc.content.size&&!y.sameParent(C)&&(R=_e.findFrom(d.doc.resolve(y.pos+1),1,!0))&&R.head==C.pos)&&n.someProp("handleKeyDown",A=>A(n,Ls(13,"Enter")))){n.input.lastIOSEnter=0;return}if(n.state.selection.anchor>g.start&&_M(u,g.start,g.endA,y,C)&&n.someProp("handleKeyDown",A=>A(n,Ls(8,"Backspace")))){wn&&Nt&&n.domObserver.suppressSelectionUpdates();return}Nt&&wn&&g.endB==g.start&&(n.input.lastAndroidDelete=Date.now()),wn&&!_&&y.start()!=C.start()&&C.parentOffset==0&&y.depth==C.depth&&d.sel&&d.sel.anchor==d.sel.head&&d.sel.head==g.endA&&(g.endB-=2,C=d.doc.resolveNoCache(g.endB-d.from),setTimeout(()=>{n.someProp("handleKeyDown",function(A){return A(n,Ls(13,"Enter"))})},20));let N=g.start,E=g.endA,P,F,D;if(_){if(y.pos==C.pos)Ut&&ws<=11&&y.parentOffset==0&&(n.domObserver.suppressSelectionUpdates(),setTimeout(()=>Qn(n),20)),P=n.state.tr.delete(N,E),F=u.resolve(g.start).marksAcross(u.resolve(g.endA));else if(g.endA==g.endB&&(D=EM(y.parent.content.cut(y.parentOffset,C.parentOffset),M.parent.content.cut(M.parentOffset,g.endA-M.start()))))P=n.state.tr,D.type=="add"?P.addMark(N,E,D.mark):P.removeMark(N,E,D.mark);else if(y.parent.child(y.index()).isText&&y.index()==C.index()-(C.textOffset?0:1)){let A=y.parent.textBetween(y.parentOffset,C.parentOffset);if(n.someProp("handleTextInput",G=>G(n,N,E,A)))return;P=n.state.tr.insertText(A,N,E)}}if(P||(P=n.state.tr.replace(N,E,d.doc.slice(g.start-d.from,g.endB-d.from))),d.sel){let A=su(n,P.doc,d.sel);A&&!(Nt&&wn&&n.composing&&A.empty&&(g.start!=g.endB||n.input.lastAndroidDelete<Date.now()-100)&&(A.head==N||A.head==P.mapping.map(E)-1)||Ut&&A.empty&&A.head==N)&&P.setSelection(A)}F&&P.ensureMarks(F),r&&P.setMeta("composition",r),n.dispatch(P.scrollIntoView())}function su(n,e,t){return Math.max(t.anchor,t.head)>e.content.size?null:dc(n,e.resolve(t.anchor),e.resolve(t.head))}function EM(n,e){let t=n.firstChild.marks,s=e.firstChild.marks,i=t,r=s,o,a,l;for(let u=0;u<s.length;u++)i=s[u].removeFromSet(i);for(let u=0;u<t.length;u++)r=t[u].removeFromSet(r);if(i.length==1&&r.length==0)a=i[0],o="add",l=u=>u.mark(a.addToSet(u.marks));else if(i.length==0&&r.length==1)a=r[0],o="remove",l=u=>u.mark(a.removeFromSet(u.marks));else return null;let d=[];for(let u=0;u<e.childCount;u++)d.push(l(e.child(u)));if(q.from(d).eq(n))return{mark:a,type:o}}function _M(n,e,t,s,i){if(t-e<=i.pos-s.pos||Ca(s,!0,!1)<i.pos)return!1;let r=n.resolve(e);if(!s.parent.isTextblock){let a=r.nodeAfter;return a!=null&&t==e+a.nodeSize}if(r.parentOffset<r.parent.content.size||!r.parent.isTextblock)return!1;let o=n.resolve(Ca(r,!0,!0));return!o.parent.isTextblock||o.pos>t||Ca(o,!0,!1)<t?!1:s.parent.content.cut(s.parentOffset).eq(o.parent.content)}function Ca(n,e,t){let s=n.depth,i=e?n.end():n.pos;for(;s>0&&(e||n.indexAfter(s)==n.node(s).childCount);)s--,i++,e=!1;if(t){let r=n.node(s).maybeChild(n.indexAfter(s));for(;r&&!r.isLeaf;)r=r.firstChild,i++}return i}function NM(n,e,t,s,i){let r=n.findDiffStart(e,t);if(r==null)return null;let{a:o,b:a}=n.findDiffEnd(e,t+n.size,t+e.size);if(i=="end"){let l=Math.max(0,r-Math.min(o,a));s-=o+l-r}if(o<r&&n.size<e.size){let l=s<=r&&s>=o?r-s:0;r-=l,r&&r<e.size&&iu(e.textBetween(r-1,r+1))&&(r+=l?1:-1),a=r+(a-o),o=r}else if(a<r){let l=s<=r&&s>=a?r-s:0;r-=l,r&&r<n.size&&iu(n.textBetween(r-1,r+1))&&(r+=l?1:-1),o=r+(o-a),a=r}return{start:r,endA:o,endB:a}}function iu(n){if(n.length!=2)return!1;let e=n.charCodeAt(0),t=n.charCodeAt(1);return e>=56320&&e<=57343&&t>=55296&&t<=56319}class IM{constructor(e,t){this._root=null,this.focused=!1,this.trackWrites=null,this.mounted=!1,this.markCursor=null,this.cursorWrapper=null,this.lastSelectedViewDesc=void 0,this.input=new JC,this.prevDirectPlugins=[],this.pluginViews=[],this.requiresGeckoHackNode=!1,this.dragging=null,this._props=t,this.state=t.state,this.directPlugins=t.plugins||[],this.directPlugins.forEach(cu),this.dispatch=this.dispatch.bind(this),this.dom=e&&e.mount||document.createElement("div"),e&&(e.appendChild?e.appendChild(this.dom):typeof e=="function"?e(this.dom):e.mount&&(this.mounted=!0)),this.editable=au(this),ou(this),this.nodeViews=lu(this),this.docView=Ld(this.state.doc,ru(this),ka(this),this.dom,this),this.domObserver=new bM(this,(s,i,r,o)=>TM(this,s,i,r,o)),this.domObserver.start(),YC(this),this.updatePluginViews()}get composing(){return this.input.composing}get props(){if(this._props.state!=this.state){let e=this._props;this._props={};for(let t in e)this._props[t]=e[t];this._props.state=this.state}return this._props}update(e){e.handleDOMEvents!=this._props.handleDOMEvents&&cl(this);let t=this._props;this._props=e,e.plugins&&(e.plugins.forEach(cu),this.directPlugins=e.plugins),this.updateStateInner(e.state,t)}setProps(e){let t={};for(let s in this._props)t[s]=this._props[s];t.state=this.state;for(let s in e)t[s]=e[s];this.update(t)}updateState(e){this.updateStateInner(e,this._props)}updateStateInner(e,t){var s;let i=this.state,r=!1,o=!1;e.storedMarks&&this.composing&&(Up(this),o=!0),this.state=e;let a=i.plugins!=e.plugins||this._props.plugins!=t.plugins;if(a||this._props.plugins!=t.plugins||this._props.nodeViews!=t.nodeViews){let b=lu(this);RM(b,this.nodeViews)&&(this.nodeViews=b,r=!0)}(a||t.handleDOMEvents!=this._props.handleDOMEvents)&&cl(this),this.editable=au(this),ou(this);let l=ka(this),d=ru(this),u=i.plugins!=e.plugins&&!i.doc.eq(e.doc)?"reset":e.scrollToSelection>i.scrollToSelection?"to selection":"preserve",p=r||!this.docView.matchesNode(e.doc,d,l);(p||!e.selection.eq(i.selection))&&(o=!0);let m=u=="preserve"&&o&&this.dom.style.overflowAnchor==null&&uC(this);if(o){this.domObserver.stop();let b=p&&(Ut||Nt)&&!this.composing&&!i.selection.empty&&!e.selection.empty&&AM(i.selection,e.selection);if(p){let g=Nt?this.trackWrites=this.domSelectionRange().focusNode:null;this.composing&&(this.input.compositionNode=cM(this)),(r||!this.docView.update(e.doc,d,l,this))&&(this.docView.updateOuterDeco(d),this.docView.destroy(),this.docView=Ld(e.doc,d,l,this.dom,this)),g&&!this.trackWrites&&(b=!0)}b||!(this.input.mouseDown&&this.domObserver.currentSelection.eq(this.domSelectionRange())&&OC(this))?Qn(this,b):(_p(this,e.selection),this.domObserver.setCurSelection()),this.domObserver.start()}this.updatePluginViews(i),!((s=this.dragging)===null||s===void 0)&&s.node&&!i.doc.eq(e.doc)&&this.updateDraggedNode(this.dragging,i),u=="reset"?this.dom.scrollTop=0:u=="to selection"?this.scrollToSelection():m&&hC(m)}scrollToSelection(){let e=this.domSelectionRange().focusNode;if(!this.someProp("handleScrollToSelection",t=>t(this)))if(this.state.selection instanceof fe){let t=this.docView.domAfterPos(this.state.selection.from);t.nodeType==1&&Dd(this,t.getBoundingClientRect(),e)}else Dd(this,this.coordsAtPos(this.state.selection.head,1),e)}destroyPluginViews(){let e;for(;e=this.pluginViews.pop();)e.destroy&&e.destroy()}updatePluginViews(e){if(!e||e.plugins!=this.state.plugins||this.directPlugins!=this.prevDirectPlugins){this.prevDirectPlugins=this.directPlugins,this.destroyPluginViews();for(let t=0;t<this.directPlugins.length;t++){let s=this.directPlugins[t];s.spec.view&&this.pluginViews.push(s.spec.view(this))}for(let t=0;t<this.state.plugins.length;t++){let s=this.state.plugins[t];s.spec.view&&this.pluginViews.push(s.spec.view(this))}}else for(let t=0;t<this.pluginViews.length;t++){let s=this.pluginViews[t];s.update&&s.update(this,e)}}updateDraggedNode(e,t){let s=e.node,i=-1;if(this.state.doc.nodeAt(s.from)==s.node)i=s.from;else{let r=s.from+(this.state.doc.content.size-t.doc.content.size);(r>0&&this.state.doc.nodeAt(r))==s.node&&(i=r)}this.dragging=new Wp(e.slice,e.move,i<0?void 0:fe.create(this.state.doc,i))}someProp(e,t){let s=this._props&&this._props[e],i;if(s!=null&&(i=t?t(s):s))return i;for(let o=0;o<this.directPlugins.length;o++){let a=this.directPlugins[o].props[e];if(a!=null&&(i=t?t(a):a))return i}let r=this.state.plugins;if(r)for(let o=0;o<r.length;o++){let a=r[o].props[e];if(a!=null&&(i=t?t(a):a))return i}}hasFocus(){if(Ut){let e=this.root.activeElement;if(e==this.dom)return!0;if(!e||!this.dom.contains(e))return!1;for(;e&&this.dom!=e&&this.dom.contains(e);){if(e.contentEditable=="false")return!1;e=e.parentElement}return!0}return this.root.activeElement==this.dom}focus(){this.domObserver.stop(),this.editable&&fC(this.dom),Qn(this),this.domObserver.start()}get root(){let e=this._root;if(e==null){for(let t=this.dom.parentNode;t;t=t.parentNode)if(t.nodeType==9||t.nodeType==11&&t.host)return t.getSelection||(Object.getPrototypeOf(t).getSelection=()=>t.ownerDocument.getSelection()),this._root=t}return e||document}updateRoot(){this._root=null}posAtCoords(e){return xC(this,e)}coordsAtPos(e,t=1){return wp(this,e,t)}domAtPos(e,t=0){return this.docView.domFromPos(e,t)}nodeDOM(e){let t=this.docView.descAt(e);return t?t.nodeDOM:null}posAtDOM(e,t,s=-1){let i=this.docView.posFromDOM(e,t,s);if(i==null)throw new RangeError("DOM position not inside the editor");return i}endOfTextblock(e,t){return CC(this,t||this.state,e)}pasteHTML(e,t){return xr(this,"",e,!1,t||new ClipboardEvent("paste"))}pasteText(e,t){return xr(this,e,null,!0,t||new ClipboardEvent("paste"))}destroy(){this.docView&&(QC(this),this.destroyPluginViews(),this.mounted?(this.docView.update(this.state.doc,[],ka(this),this),this.dom.textContent=""):this.dom.parentNode&&this.dom.parentNode.removeChild(this.dom),this.docView.destroy(),this.docView=null,eC())}get isDestroyed(){return this.docView==null}dispatchEvent(e){return ZC(this,e)}dispatch(e){let t=this._props.dispatchTransaction;t?t.call(this,e):this.updateState(this.state.apply(e))}domSelectionRange(){let e=this.domSelection();return Pt&&this.root.nodeType===11&&rC(this.dom.ownerDocument)==this.dom&&SM(this,e)||e}domSelection(){return this.root.getSelection()}}function ru(n){let e=Object.create(null);return e.class="ProseMirror",e.contenteditable=String(n.editable),n.someProp("attributes",t=>{if(typeof t=="function"&&(t=t(n.state)),t)for(let s in t)s=="class"?e.class+=" "+t[s]:s=="style"?e.style=(e.style?e.style+";":"")+t[s]:!e[s]&&s!="contenteditable"&&s!="nodeName"&&(e[s]=String(t[s]))}),e.translate||(e.translate="no"),[Jt.node(0,n.state.doc.content.size,e)]}function ou(n){if(n.markCursor){let e=document.createElement("img");e.className="ProseMirror-separator",e.setAttribute("mark-placeholder","true"),e.setAttribute("alt",""),n.cursorWrapper={dom:e,deco:Jt.widget(n.state.selection.head,e,{raw:!0,marks:n.markCursor})}}else n.cursorWrapper=null}function au(n){return!n.someProp("editable",e=>e(n.state)===!1)}function AM(n,e){let t=Math.min(n.$anchor.sharedDepth(n.head),e.$anchor.sharedDepth(e.head));return n.$anchor.start(t)!=e.$anchor.start(t)}function lu(n){let e=Object.create(null);function t(s){for(let i in s)Object.prototype.hasOwnProperty.call(e,i)||(e[i]=s[i])}return n.someProp("nodeViews",t),n.someProp("markViews",t),e}function RM(n,e){let t=0,s=0;for(let i in n){if(n[i]!=e[i])return!0;t++}for(let i in e)s++;return t!=s}function cu(n){if(n.spec.state||n.spec.filterTransaction||n.spec.appendTransaction)throw new RangeError("Plugins passed directly to the view must not have a state component")}const Xi=new ii("placeholderPlugin");function DM(n){return new Ts({key:Xi,state:{init(){return{placeholder:n}},apply(e,t){return e.getMeta(Xi)?{placeholder:e.getMeta(Xi).placeholder}:t}},props:{decorations(e){var i;const{doc:t}=e;if(t.childCount===1&&((i=t.firstChild)==null?void 0:i.isTextblock)&&t.firstChild.content.size===0){const r=[],{placeholder:o}=Xi.getState(e);return e.doc.descendants((a,l)=>{const d=Jt.node(l,l+a.nodeSize,{class:"placeholder","data-placeholder":o});r.push(d)}),ct.create(t,r)}}}})}const gc="command_token",jM={group:"inline",inline:!0,atom:!0,content:"text*",attrs:{id:"",hint:""},selectable:!1,draggable:!1,toDOM:n=>["span",{"data-mention-id":n.attrs.id,"data-mention-hint":n.attrs.hint,class:"shimmer-blue"},n.attrs.hint],parseDOM:[{tag:"span[data-mention-id][data-mention-hint]",getAttrs:n=>{const e=n.getAttribute("data-mention-id"),t=n.getAttribute("data-mention-hint");return{id:e,hint:t}}}]};function OM(n){if(n.depth===0)return;const e=n.before(),s=n.doc.textBetween(e,n.pos,`
`,"\0").match(new RegExp(/(^|\s)\/(\w*)$/));if(s&&s.index!==void 0){const i=s[0].startsWith(" ")?s.index+1:s.index,r=s[0].startsWith(" ")?s[0].length-1:s[0].length,o=n.start()+i,a=o+r;return{range:{from:o,to:a},queryText:s[2]}}}const du=new ii("slashCommandPlugin");function uu(){return{queryText:"",active:!1,range:void 0}}function S_(n,e,t,s){const i=n.state.schema.nodes[gc].create({...e},n.state.schema.text(e.hint)),r=n.state.tr.replaceWith(t.from,t.to,i);s&&r.insertText(" ",t.from+i.nodeSize),n.dispatch(r)}function hu(n){const{active:e,range:t,queryText:s,onHintMatch:i}=n;if(i)return i(!e||!t?void 0:{text:s,range:t})}function PM(n){const e=[];return n.descendants(t=>{var s;t.type.name===gc&&typeof((s=t.attrs)==null?void 0:s.id)=="string"&&e.push(t.attrs.id)}),e}function FM(){return new Ts({key:du,state:{init(){return uu()},apply(n,e){const t=n.getMeta(du),s=n.selection,i=s.$from,r=OM(i),o={...uu(),...e,...t};return s.from!==s.to?(hu(o),o):(o.active=!!r,r&&(o.queryText=r.queryText,o.range=r.range),hu(o),o)}}})}class yc extends ag{constructor(e){super(),this.view=e}isEmpty(){return!this.view.state.doc.textContent}trimLeadingText(e){const s=this.view.state.tr;let i=!1,r=!1;return s.doc.descendants((o,a)=>{var l;i||!o.isText||(i=!0,(l=o.text)!=null&&l.startsWith(e)&&(r=!0,s.insertText(o.text.replace(e,""),a,a+o.text.length)))}),r&&this.view.dispatch(s),r}replaceAll(e,t){const i=this.view.state.tr,r=[];i.doc.descendants((o,a)=>{!o.isText||o.text===void 0||r.push({node:o,pos:a})}),r.reverse(),r.forEach(({node:o,pos:a})=>{!o.isText||o.text===void 0||o.text.includes(e)&&i.insertText(o.text.replaceAll(e,t),a,a+o.text.length)}),this.view.dispatch(i)}appendText(e){this.view.dispatch(this.view.state.tr.insertText(e))}focus(){this.view.dom.focus()}setText(e){const{tr:t,schema:s}=this.view.state,i=e?s.nodes.paragraph.create(null,s.text(e)):s.nodes.paragraph.create();this.view.dispatch(t.replaceWith(0,this.view.state.doc.content.size,i)),this.view.hasFocus()&&this.view.dispatch(this.view.state.tr.setSelection(Le.atEnd(this.view.state.doc)))}getCurrentText(){return this.view.state.doc.textContent}getTextToSend(){return Jk(this.view)}resize(){}isReady(){return!!this.view.state.doc}setPlaceholder(e){this.view.dispatch(this.view.state.tr.setMeta(Xi,{placeholder:e}))}getSelectionStart(){return this.view.state.selection.ranges[0].$from.pos}isMenuSelectorActive(){return Si.getState(this.view.state).active}registerKeyHandlers(e){Ak(this.view,e)}acceptLegacyKeydown(){return!1}subscribe(e,t){var s;if(e==="change"){const i=()=>t(void 0);return Nd(this.view,i)}return(s=this.view.dom)==null||s.addEventListener(e,t),()=>{var i;(i=this.view.dom)==null||i.removeEventListener(e,t)}}useState(e){return S.useSyncExternalStore(t=>Nd(this.view,t),()=>e(this))}getSystemHints(){const e=PM(this.view.state.tr.doc);return e.length?[e[0]]:[]}canShowAutocompletion(){return!this.isMenuSelectorActive()&&!this.getSystemHints().length}}const BM=typeof navigator<"u"?/Mac|iP(hone|[oa]d)/.test(navigator.platform):!1;function LM(n){let e=n.split(/-(?!$)/),t=e[e.length-1];t=="Space"&&(t=" ");let s,i,r,o;for(let a=0;a<e.length-1;a++){let l=e[a];if(/^(cmd|meta|m)$/i.test(l))o=!0;else if(/^a(lt)?$/i.test(l))s=!0;else if(/^(c|ctrl|control)$/i.test(l))i=!0;else if(/^s(hift)?$/i.test(l))r=!0;else if(/^mod$/i.test(l))BM?o=!0:i=!0;else throw new Error("Unrecognized modifier name: "+l)}return s&&(t="Alt-"+t),i&&(t="Ctrl-"+t),o&&(t="Meta-"+t),r&&(t="Shift-"+t),t}function zM(n){let e=Object.create(null);for(let t in n)e[LM(t)]=n[t];return e}function Ma(n,e,t=!0){return e.altKey&&(n="Alt-"+n),e.ctrlKey&&(n="Ctrl-"+n),e.metaKey&&(n="Meta-"+n),t&&e.shiftKey&&(n="Shift-"+n),n}function dl(n){return new Ts({props:{handleKeyDown:Kp(n)}})}function Kp(n){let e=zM(n);return function(t,s){let i=lg(s),r,o=e[Ma(i,s)];if(o&&o(t.state,t.dispatch,t))return!0;if(i.length==1&&i!=" "){if(s.shiftKey){let a=e[Ma(i,s,!1)];if(a&&a(t.state,t.dispatch,t))return!0}if((s.shiftKey||s.altKey||s.metaKey||i.charCodeAt(0)>127)&&(r=cg[s.keyCode])&&r!=i){let a=e[Ma(r,s)];if(a&&a(t.state,t.dispatch,t))return!0}}return!1}}class st extends _e{constructor(e){super(e,e)}map(e,t){let s=e.resolve(t.map(this.head));return st.valid(s)?new st(s):_e.near(s)}content(){return X.empty}eq(e){return e instanceof st&&e.head==this.head}toJSON(){return{type:"gapcursor",pos:this.head}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for GapCursor.fromJSON");return new st(e.resolve(t.pos))}getBookmark(){return new xc(this.anchor)}static valid(e){let t=e.parent;if(t.isTextblock||!UM(e)||!VM(e))return!1;let s=t.type.spec.allowGapCursor;if(s!=null)return s;let i=t.contentMatchAt(e.index()).defaultType;return i&&i.isTextblock}static findGapCursorFrom(e,t,s=!1){e:for(;;){if(!s&&st.valid(e))return e;let i=e.pos,r=null;for(let o=e.depth;;o--){let a=e.node(o);if(t>0?e.indexAfter(o)<a.childCount:e.index(o)>0){r=a.child(t>0?e.indexAfter(o):e.index(o)-1);break}else if(o==0)return null;i+=t;let l=e.doc.resolve(i);if(st.valid(l))return l}for(;;){let o=t>0?r.firstChild:r.lastChild;if(!o){if(r.isAtom&&!r.isText&&!fe.isSelectable(r)){e=e.doc.resolve(i+r.nodeSize*t),s=!1;continue e}break}r=o,i+=t;let a=e.doc.resolve(i);if(st.valid(a))return a}return null}}}st.prototype.visible=!1;st.findFrom=st.findGapCursorFrom;_e.jsonID("gapcursor",st);class xc{constructor(e){this.pos=e}map(e){return new xc(e.map(this.pos))}resolve(e){let t=e.resolve(this.pos);return st.valid(t)?new st(t):_e.near(t)}}function UM(n){for(let e=n.depth;e>=0;e--){let t=n.index(e),s=n.node(e);if(t==0){if(s.type.spec.isolating)return!0;continue}for(let i=s.child(t-1);;i=i.lastChild){if(i.childCount==0&&!i.inlineContent||i.isAtom||i.type.spec.isolating)return!0;if(i.inlineContent)return!1}}return!0}function VM(n){for(let e=n.depth;e>=0;e--){let t=n.indexAfter(e),s=n.node(e);if(t==s.childCount){if(s.type.spec.isolating)return!0;continue}for(let i=s.child(t);;i=i.firstChild){if(i.childCount==0&&!i.inlineContent||i.isAtom||i.type.spec.isolating)return!0;if(i.inlineContent)return!1}}return!0}function WM(){return new Ts({props:{decorations:$M,createSelectionBetween(n,e,t){return e.pos==t.pos&&st.valid(t)?new st(t):null},handleClick:qM,handleKeyDown:GM,handleDOMEvents:{beforeinput:HM}}})}const GM=Kp({ArrowLeft:Gr("horiz",-1),ArrowRight:Gr("horiz",1),ArrowUp:Gr("vert",-1),ArrowDown:Gr("vert",1)});function Gr(n,e){const t=n=="vert"?e>0?"down":"up":e>0?"right":"left";return function(s,i,r){let o=s.selection,a=e>0?o.$to:o.$from,l=o.empty;if(o instanceof Le){if(!r.endOfTextblock(t)||a.depth==0)return!1;l=!1,a=s.doc.resolve(e>0?a.after():a.before())}let d=st.findGapCursorFrom(a,e,l);return d?(i&&i(s.tr.setSelection(new st(d))),!0):!1}}function qM(n,e,t){if(!n||!n.editable)return!1;let s=n.state.doc.resolve(e);if(!st.valid(s))return!1;let i=n.posAtCoords({left:t.clientX,top:t.clientY});return i&&i.inside>-1&&fe.isSelectable(n.state.doc.nodeAt(i.inside))?!1:(n.dispatch(n.state.tr.setSelection(new st(s))),!0)}function HM(n,e){if(e.inputType!="insertCompositionText"||!(n.state.selection instanceof st))return!1;let{$from:t}=n.state.selection,s=t.parent.contentMatchAt(t.index()).findWrapping(n.state.schema.nodes.text);if(!s)return!1;let i=q.empty;for(let o=s.length-1;o>=0;o--)i=q.from(s[o].createAndFill(null,i));let r=n.state.tr.replace(t.pos,t.pos,new X(i,0,0));return r.setSelection(Le.near(r.doc.resolve(t.pos+1))),n.dispatch(r),!1}function $M(n){if(!(n.selection instanceof st))return null;let e=document.createElement("div");return e.className="ProseMirror-gapcursor",ct.create(n.doc,[Jt.widget(n.selection.head,e,{key:"gapcursor"})])}const KM=500;class Sn{constructor(e,t){this.items=e,this.eventCount=t}popEvent(e,t){if(this.eventCount==0)return null;let s=this.items.length;for(;;s--)if(this.items.get(s-1).selection){--s;break}let i,r;t&&(i=this.remapping(s,this.items.length),r=i.maps.length);let o=e.tr,a,l,d=[],u=[];return this.items.forEach((p,m)=>{if(!p.step){i||(i=this.remapping(s,m+1),r=i.maps.length),r--,u.push(p);return}if(i){u.push(new En(p.map));let b=p.step.map(i.slice(r)),g;b&&o.maybeStep(b).doc&&(g=o.mapping.maps[o.mapping.maps.length-1],d.push(new En(g,void 0,void 0,d.length+u.length))),r--,g&&i.appendMap(g,r)}else o.maybeStep(p.step);if(p.selection)return a=i?p.selection.map(i.slice(r)):p.selection,l=new Sn(this.items.slice(0,s).append(u.reverse().concat(d)),this.eventCount-1),!1},this.items.length,0),{remaining:l,transform:o,selection:a}}addTransform(e,t,s,i){let r=[],o=this.eventCount,a=this.items,l=!i&&a.length?a.get(a.length-1):null;for(let u=0;u<e.steps.length;u++){let p=e.steps[u].invert(e.docs[u]),m=new En(e.mapping.maps[u],p,t),b;(b=l&&l.merge(m))&&(m=b,u?r.pop():a=a.slice(0,a.length-1)),r.push(m),t&&(o++,t=void 0),i||(l=m)}let d=o-s.depth;return d>YM&&(a=JM(a,d),o-=d),new Sn(a.append(r),o)}remapping(e,t){let s=new bi;return this.items.forEach((i,r)=>{let o=i.mirrorOffset!=null&&r-i.mirrorOffset>=e?s.maps.length-i.mirrorOffset:void 0;s.appendMap(i.map,o)},e,t),s}addMaps(e){return this.eventCount==0?this:new Sn(this.items.append(e.map(t=>new En(t))),this.eventCount)}rebased(e,t){if(!this.eventCount)return this;let s=[],i=Math.max(0,this.items.length-t),r=e.mapping,o=e.steps.length,a=this.eventCount;this.items.forEach(m=>{m.selection&&a--},i);let l=t;this.items.forEach(m=>{let b=r.getMirror(--l);if(b==null)return;o=Math.min(o,b);let g=r.maps[b];if(m.step){let y=e.steps[b].invert(e.docs[b]),C=m.selection&&m.selection.map(r.slice(l+1,b));C&&a++,s.push(new En(g,y,C))}else s.push(new En(g))},i);let d=[];for(let m=t;m<o;m++)d.push(new En(r.maps[m]));let u=this.items.slice(0,i).append(d).append(s),p=new Sn(u,a);return p.emptyItemCount()>KM&&(p=p.compress(this.items.length-s.length)),p}emptyItemCount(){let e=0;return this.items.forEach(t=>{t.step||e++}),e}compress(e=this.items.length){let t=this.remapping(0,e),s=t.maps.length,i=[],r=0;return this.items.forEach((o,a)=>{if(a>=e)i.push(o),o.selection&&r++;else if(o.step){let l=o.step.map(t.slice(s)),d=l&&l.getMap();if(s--,d&&t.appendMap(d,s),l){let u=o.selection&&o.selection.map(t.slice(s));u&&r++;let p=new En(d.invert(),l,u),m,b=i.length-1;(m=i.length&&i[b].merge(p))?i[b]=m:i.push(p)}}else o.map&&s--},this.items.length,0),new Sn(hh.from(i.reverse()),r)}}Sn.empty=new Sn(hh.empty,0);function JM(n,e){let t;return n.forEach((s,i)=>{if(s.selection&&e--==0)return t=i,!1}),n.slice(t)}class En{constructor(e,t,s,i){this.map=e,this.step=t,this.selection=s,this.mirrorOffset=i}merge(e){if(this.step&&e.step&&!e.selection){let t=e.step.merge(this.step);if(t)return new En(t.getMap().invert(),t,this.selection)}}}class hs{constructor(e,t,s,i,r){this.done=e,this.undone=t,this.prevRanges=s,this.prevTime=i,this.prevComposition=r}}const YM=20;function QM(n,e,t,s){let i=t.getMeta(Js),r;if(i)return i.historyState;t.getMeta(ev)&&(n=new hs(n.done,n.undone,null,0,-1));let o=t.getMeta("appendedTransaction");if(t.steps.length==0)return n;if(o&&o.getMeta(Js))return o.getMeta(Js).redo?new hs(n.done.addTransform(t,void 0,s,no(e)),n.undone,fu(t.mapping.maps),n.prevTime,n.prevComposition):new hs(n.done,n.undone.addTransform(t,void 0,s,no(e)),null,n.prevTime,n.prevComposition);if(t.getMeta("addToHistory")!==!1&&!(o&&o.getMeta("addToHistory")===!1)){let a=t.getMeta("composition"),l=n.prevTime==0||!o&&n.prevComposition!=a&&(n.prevTime<(t.time||0)-s.newGroupDelay||!XM(t,n.prevRanges)),d=o?va(n.prevRanges,t.mapping):fu(t.mapping.maps);return new hs(n.done.addTransform(t,l?e.selection.getBookmark():void 0,s,no(e)),Sn.empty,d,t.time,a??n.prevComposition)}else return(r=t.getMeta("rebased"))?new hs(n.done.rebased(t,r),n.undone.rebased(t,r),va(n.prevRanges,t.mapping),n.prevTime,n.prevComposition):new hs(n.done.addMaps(t.mapping.maps),n.undone.addMaps(t.mapping.maps),va(n.prevRanges,t.mapping),n.prevTime,n.prevComposition)}function XM(n,e){if(!e)return!1;if(!n.docChanged)return!0;let t=!1;return n.mapping.maps[0].forEach((s,i)=>{for(let r=0;r<e.length;r+=2)s<=e[r+1]&&i>=e[r]&&(t=!0)}),t}function fu(n){let e=[];for(let t=n.length-1;t>=0&&e.length==0;t--)n[t].forEach((s,i,r,o)=>e.push(r,o));return e}function va(n,e){if(!n)return null;let t=[];for(let s=0;s<n.length;s+=2){let i=e.map(n[s],1),r=e.map(n[s+1],-1);i<=r&&t.push(i,r)}return t}function ZM(n,e,t){let s=no(e),i=Js.get(e).spec.config,r=(t?n.undone:n.done).popEvent(e,s);if(!r)return null;let o=r.selection.resolve(r.transform.doc),a=(t?n.done:n.undone).addTransform(r.transform,e.selection.getBookmark(),i,s),l=new hs(t?a:r.remaining,t?r.remaining:a,null,0,-1);return r.transform.setSelection(o).setMeta(Js,{redo:t,historyState:l})}let Ta=!1,pu=null;function no(n){let e=n.plugins;if(pu!=e){Ta=!1,pu=e;for(let t=0;t<e.length;t++)if(e[t].spec.historyPreserveItems){Ta=!0;break}}return Ta}const Js=new ii("history"),ev=new ii("closeHistory");function tv(n={}){return n={depth:n.depth||100,newGroupDelay:n.newGroupDelay||500},new Ts({key:Js,state:{init(){return new hs(Sn.empty,Sn.empty,null,0,-1)},apply(e,t,s){return QM(t,s,e,n)}},config:n,props:{handleDOMEvents:{beforeinput(e,t){let s=t.inputType,i=s=="historyUndo"?Yp:s=="historyRedo"?ul:null;return i?(t.preventDefault(),i(e.state,e.dispatch)):!1}}}})}function Jp(n,e){return(t,s)=>{let i=Js.getState(t);if(!i||(n?i.undone:i.done).eventCount==0)return!1;if(s){let r=ZM(i,t,n);r&&s(e?r.scrollIntoView():r)}return!0}}const Yp=Jp(!1,!0),ul=Jp(!0,!0);function nv(){return dl({"Shift-Enter":(n,e)=>Xa(n,e),Enter:(n,e)=>window.innerWidth>Mx[vx.Medium]?!1:Xa(n,e)})}const sv=["p",0],iv=["br"],rv=new WS({nodes:{paragraph:{content:"inline*",group:"block",parseDOM:[{tag:"p",preserveWhitespace:"full"}],toDOM(){return sv}},text:{group:"inline"},hard_break:{inline:!0,group:"inline",selectable:!1,parseDOM:[{tag:"br"}],toDOM(){return iv}},[gc]:jM,doc:{content:"block+"}},marks:{}});function ov(){const n=new EventTarget,e=new IM(null,{state:xi.create({schema:rv,plugins:[tv(),Zk({submitKeys:["Enter","Tab"],cancelKeys:["Escape"],checkStrictMatchKeys:[" "]}),DM(""),FM(),nv(),dl({"Mod-z":Yp,"Mod-y":ul,"Mod-Shift-z":ul}),Rk(),dl(Kk),Ik(n),WM()]}),dispatchTransaction(t){const s=e.state.apply(t);e.updateState(s),t.docChanged&&n.dispatchEvent(new Event(Qa))},handlePaste(t,s){var r;const i=(r=s.clipboardData)==null?void 0:r.getData("text/plain");return i===void 0?!1:(Yk(t,i),!0)},clipboardTextSerializer(t){return fp(t.content)}});return e}function av(){try{return navigator.userAgent.toLocaleLowerCase().includes("firefox")}catch{return!1}}const lv=[se([dg["prosemirror-parent"],"text-token-text-primary","max-h-[25dvh]","max-h-52","overflow-auto",av()?"firefox":"default-browser"])],cv=({children:n})=>{const[e]=S.useState(()=>ov()),[t]=S.useState(()=>new yc(e));return n(t)},dv=({composerController:n,placeholder:e})=>{if(!(n instanceof yc))throw new Error(`Expected instance of ProseMirrorComposerController but got ${n.constructor.name}`);const t=S.useRef(null);return S.useEffect(()=>{t.current.appendChild(n.view.dom)},[]),S.useEffect(()=>{const s=n.view.dom;s&&(s.id=fh,n.focus())},[n]),S.useEffect(()=>{n.setPlaceholder(e)},[e,n]),S.useEffect(()=>{n.logPageMount()},[]),c.jsx("div",{ref:t,className:se(lv)})},uv=S.forwardRef(function({type:e,placeholder:t,replyRegions:s,state:i,renderFiles:r,icon:o,onSubmit:a,inputState:l,currentLeafId:d,composerController:u,clientThreadId:p,gizmoId:m},b){const g=Fo(),y=Wu();return S.useEffect(()=>{u.focus()},[y==null?void 0:y.modelId,u]),c.jsxs("div",{ref:b,className:se("flex w-full flex-col gap-1.5 rounded-[26px] p-1.5 transition-colors",g&&"backdrop-blur-2xl no-transparency:backdrop-blur-none",g&&e!=="temporary"&&"bg-token-composer-surface",!g&&e!=="temporary"&&"bg-[#f4f4f4] dark:bg-token-main-surface-secondary",e==="temporary"&&"dark bg-black"),children:[s.length>0&&c.jsx(pv,{replyRegions:s}),c.jsxs("div",{className:"flex items-end gap-1.5 md:gap-2",children:[o,c.jsxs("div",{className:se("flex min-w-0 flex-1 flex-col",!o&&"pl-4"),children:[r,u instanceof za?c.jsx(ph,{id:fh,tabIndex:0,"data-id":d,dir:"auto",ref:C=>{if(!(u instanceof za))throw new Error("Expected TextAreaComposerController");C!=null&&(u.textArea=C,u.logPageMount())},rows:1,placeholder:t,disabled:l!=="default",className:se("m-0 resize-none border-0 bg-transparent px-0 text-token-text-primary focus:ring-0 focus-visible:ring-0",l==="disabled"&&"text-center",["max-h-[25dvh]","max-h-52"])}):c.jsx(dv,{composerController:u,placeholder:t})]}),c.jsx(hv,{inputState:l,state:i,onSubmit:a,composerController:u,clientThreadId:p,gizmoId:m})]})]})});function hv(n){const{isUnauthenticated:e}=Zt();if(n.inputState==="disabled")return null;const t=c.jsx(fv,{state:n.state,onSubmit:n.onSubmit});return!e&&n.state==="disabled"&&n.clientThreadId?c.jsx(ug,{clientThreadId:n.clientThreadId,gizmoId:n.gizmoId,fallback:()=>t}):t}function fv({state:n,onSubmit:e}){const t=n==="streaming"?Z0:eb,s=Fe(),i=s.formatMessage({id:"+yfm/p",defaultMessage:"Stop streaming"}),r=s.formatMessage({id:"xfIykB",defaultMessage:"Send prompt"}),o=Fo();return c.jsx("button",{onClick:e,disabled:n==="disabled","aria-label":n==="streaming"?i:r,"data-testid":n==="streaming"?"stop-button":"send-button",className:se("mb-1 me-1 flex h-8 w-8 items-center justify-center rounded-full bg-black text-white transition-colors hover:opacity-70 focus-visible:outline-none focus-visible:outline-black disabled:text-[#f4f4f4] disabled:hover:opacity-100 dark:bg-white dark:text-black dark:focus-visible:outline-white disabled:dark:bg-token-text-quaternary dark:disabled:text-token-main-surface-secondary",o&&"disabled:bg-black disabled:bg-opacity-[0.27]",!o&&"disabled:bg-[#D7D7D7]"),children:c.jsx(t,{className:se(n==="streaming"?"icon-lg":"icon-2xl")})})}function pv({replyRegions:n}){return c.jsx("div",{className:"flex flex-col divide-y divide-token-border-light overflow-hidden rounded-b-lg rounded-t-[20px] bg-token-main-surface-primary",children:n.map((e,t)=>{switch(e.type){case"text":return c.jsx(mv,{value:e.value,onRemoveRegion:e.onRemoveRegion},t);case"object":return c.jsx(gv,{value:e.value,onRemoveRegion:e.onRemoveRegion},t);case"mention":return c.jsx(yv,{value:e.value,icon:e.icon,onRemoveRegion:e.onRemoveRegion},t)}})})}function mv({value:n,onRemoveRegion:e}){return c.jsxs(wc,{className:"text-token-text-secondary",children:[c.jsx(Sc,{children:c.jsx(Ql,{className:"icon-lg-heavy"})}),c.jsx(kc,{children:`${n}`}),c.jsx(bc,{onClick:e})]})}function gv({value:n,onRemoveRegion:e}){return c.jsxs(wc,{className:"text-blue-selection",children:[c.jsx(Sc,{children:c.jsx(Ql,{className:"icon-lg-heavy"})}),c.jsx(kc,{className:"font-semibold",children:n}),c.jsx(bc,{onClick:e})]})}function yv({value:n,icon:e,onRemoveRegion:t}){return c.jsxs(wc,{children:[c.jsx(Sc,{className:"mt-0",children:e}),c.jsx(kc,{className:"font-semibold text-token-text-secondary",children:n}),c.jsx(bc,{onClick:t})]})}function bc({onClick:n}){return c.jsx("button",{onClick:n,className:"flex-shrink-0 text-token-text-secondary",children:c.jsx(X0,{className:"icon-lg"})})}const wc=Xe.div`flex items-start py-2.5 gap-4 pl-3 pr-1.5 text-sm`,Sc=Xe.span`flex-shrink-0 mt-0.5 w-6 h-6 flex justify-center items-center`,kc=Xe.span`flex-1 line-clamp-3 py-0.5`,Qp=ze(()=>Oe(()=>import("./sso-dud3eqjhdwr0lbxq.js").then(n=>n.b),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66])).then(n=>n.default),{ssr:!1}),xv=ze(()=>Oe(()=>import("./jrj4op36v0n8rn8p.js"),__vite__mapDeps([67,1,2,3,4,5,8,6,7,11,68,69,24,57,12,70,50,13,14,15,16,17,63,58,22,71])).then(n=>n.SystemHintSuggestor)),bv=ze(()=>Oe(()=>import("./sso-dud3eqjhdwr0lbxq.js").then(n=>n.d),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66])).then(n=>n.default),{ssr:!1}),wv=1,Sv=3e3;function kv({files:n,className:e,clientThreadId:t,isCanmoreEnabled:s=!1}){const i=Er();return c.jsxs("div",{className:e,children:[s&&c.jsx(Qp,{clientThreadId:t}),n.map(r=>c.jsx(yh,{width:i?"normal":"wide",onRemoveFileClick:()=>ms.remove(r.tempId,"none"),file:r.file,fileId:r.fileId??void 0,contextConnectorInfo:r.contextConnectorInfo,loadingPercentage:r.status===Cg.Uploading?r.progress:void 0},r.tempId))]})}function Cv({onAbortCompletion:n,onCreateNewCompletion:e,onContinueGenerating:t,currentModelId:s,clientThreadId:i,isNewThread:r,isCompletionInProgress:o,className:a,disabled:l=!1,disabledReason:d,canPause:u=!1,canContinue:p=!1,suggestions:m,isInteractableSharedThread:b,composerContainerRef:g,composerController:y,autocompletions:C,requiresFileUpload:M,onComposerInput:_,onAutocompleteSelect:R,headerClassName:N,setComposerBarElement:E,onTaggingDropdownOpen:P,onTaggingDropdownClose:F}){var jr,Nc;const D=Bo(),{isUnauthenticated:A}=Zt(),G=Fe(),W=Rn(i),j=Nr(i),z=Pi(),{gizmoEditorData:H,mode:K,getGizmoId:J}=Cr(),de=Li(),V=Tr(),B=es(),we=kr(),te=Ir(i),ne=!!Tx(),xe=!!Wl(),[Se,ge]=S.useState({}),[ce,Ce]=S.useState(!1),[ye,L]=S.useState(!1),Me=S.useRef(!1),qe=Ah(),be=s!==null?qe[s]:void 0;let ae=Ko(i),Re=ae&&"gizmo"in ae?ae.gizmo:void 0;const[oe,ot]=S.useState(null);oe!==null&&(ae={gizmo:oe,gizmo_id:oe.gizmo.id,kind:it.GizmoInteraction},Re=oe);const wt=ho(be,ae);let Ze=!1;hg(ae)&&(Re==null?void 0:Re.gizmo.id)===fg&&(Ze=!0);const at=!l&&wt!==Qs.None&&!Ze&&!A,$e=rh(be,ae),gt=ah(be,ae);let De=uo(Z=>Z.files);const[St]=S.useState(()=>pg());K==="magic"?De=De.filter(Z=>Z.gizmoId!=null):De=De.filter(Z=>Z.gizmoId==null);const Ne=De.length>0,Ue=uo(mg.hasUploadInProgress),We=y.useState(Z=>!Z.isEmpty()),x=Ne?!Ue:We,h=(wt===Qs.Multimodal?El:_l)-De.length,f=h<=0,w=x&&!l&&!o&&!xe,[v,T]=S.useState(!1),I=Bl(),ue=s||I.id,Ee=(jr=qe[ue])==null?void 0:jr.tags,{targetedContent:ke,setTargetedContent:Te}=mh(),Q=ke!=null&&ke.isFocusedViewContent&&!we?void 0:ke,{rebaseSystemMessageContent:dn}=ni();S.useEffect(()=>{gg()}),S.useEffect(()=>{if(!(D!=null&&D.id))return;const Z=Oc.getAndReset(D==null?void 0:D.id,te);Z&&y.setText(Z.inputText)},[D==null?void 0:D.id,te,y]),S.useEffect(()=>{v!==w&&(T(w),w&&(Gl(!0).then(Z=>{dr.startEnforcement(Z),po.startEnforcement(Z),wo.startEnforcement(Z)}),de!=null&&de.includes(si.SharedWebsocket)&&bs.registerIfNotConnected()))},[w,v,ae==null?void 0:ae.kind,de]);const kt=ih(be,ae),{handleFileAccepted:_s}=Tf(G,ho(be,ae),$e,"mouse",J,kt==null?void 0:kt.attachments),{getInputProps:Ns,open:un}=lh({disabled:l||!at||f,noClick:!0,onDropAccepted:_s,onDropRejected:Z=>vf(Z,G,wt),multiple:!0,maxSize:ch,maxFiles:h,...oh(gt)}),Be=Wh(St),et=S.useCallback(()=>{y.eraseContent(),Be.clearMessages(),y.resize(wv),Ua();for(const Z of De)ms.remove(Z.tempId,"none")},[De,Be,y]),He=async(Z,Ct)=>{var Ic;if(Z==null||Z.preventDefault(),l||!x&&!Ct||!ae||Ot.isLoading(i)!==!1)return;Ce(!0);const vn=y.getTextToSend().replace(/[\u{E0000}-\u{E007F}]+/gu,""),Vn=`${W}-nextPrompt`,is=Mg({namespace:mo.CompletionRequest,key:Vn,opts:{expectedTimingLogs:[{name:"prompt_submitted",expectedInMs:3e3}]}}),{content:ui,attachments:js}=vg(vn,be,ae),sa=[];dn&&sa.push(Nx(dn));const ia={...ae};"gizmo"in ia&&delete ia.gizmo;let qi={promptId:Vn,content:ui,eventMetadata:{eventSource:Z?"mouse":"keyboard"},completionMetadata:{suggestions:m,conversationMode:ia,systemHints:y.getSystemHints()},messageMetadata:{...js.length>0&&{attachments:js},...oe&&{gizmo_id:oe==null?void 0:oe.gizmo.id},...Se},appendMessages:sa.length>0?sa:void 0};qi=Tg(qi),Q!=null&&Q.createNewCompletionParams&&(qi=await Q.createNewCompletionParams(qi)),is.logTiming("request_params_ready"),await e(qi),(Ic=Q==null?void 0:Q.onCreateCompletion)==null||Ic.call(Q,{serverThreadId:te,currentLeafId:W}),(Q==null?void 0:Q.shouldPersistAcrossMessages)!==!0&&Te(void 0),Ii.hideThreadHeader(),et(),Ce(!1),is.logTiming("prompt_submitted"),Eg({namespace:mo.CompletionRequest,key:Vn}),m!==void 0&&(rt.logEvent("chatgpt_prompt_ignore_suggestions"),ee.logEvent($.promptIgnoreSuggestions))},Pn=S.useRef(He);S.useLayoutEffect(()=>{Pn.current=He}),S.useEffect(()=>Ex.subscribe(_x.SEND_PROMPT,({prompt:Z})=>{y.setText(Z),Pn.current(void 0,!0)}),[y]);const ts=Z=>{Te(Z.targetedReply),Z.targetedReply&&(y.focus(),ee.logEvent($.targetedReplyButtonClicked,{conversationId:te,sourceMessageId:Z.messageId}))},Fn=S.useCallback(()=>{var Z;(Z=Q==null?void 0:Q.onCleared)==null||Z.call(Q,{serverThreadId:te,currentLeafId:W}),Te(void 0),y.focus()},[W,te,Q,Te,y]),Bn={Enter:{validator:Z=>{const Ct=Z.isComposing||Z.keyCode===229,vn=ye&&Me.current;return w&&!vn&&(Z.metaKey||(V||Ix)&&!Z.shiftKey&&!Ct)},handler:Z=>{Z.preventDefault(),He()}},Escape:{validator:Z=>!Z.isComposing,handler:Z=>{u&&o&&(n("",j),ee.logEvent($.pauseCompletion,{threadId:O.getServerThreadId(i),currentLeafId:O.getTree(i).getMessageId(W),eventSource:"keyboard"})),Z.target.value===""&&Fn()}}},en=S.useRef(Bn);en.current=Bn;const ri=S.useRef(null),Vt=x0(Ee,ae==null?void 0:ae.kind),[oi,ns]=S.useState(!1),Ln=Vt&&oi,ai=y.isReady();S.useEffect(()=>y.subscribe("keydown",Z=>{var Vn,is;y.acceptLegacyKeydown()&&((Vn=en.current[Z.key])!=null&&Vn.validator(Z))&&en.current[Z.key].handler(Z);const vn=y.getCurrentText();if(Z.key==="@"){const ui=y.getSelectionStart(),js=vn.substring(0,ui);(!js||/\s$/.test(js)||ui===0)&&((is=ri.current)==null||is.handleClose(),setTimeout(()=>ns(!0),10))}else oi&&ns(!1);Z.key==="Escape"&&(ot(null),L(!1))}),[y,ai,oi]),S.useEffect(()=>{const Z=Object.fromEntries(Object.keys(en.current).map(Ct=>[Ct,Vn=>{const is=en.current[Ct];if(!is||y.acceptLegacyKeydown())return!1;const{validator:ui,handler:js}=is;return ui(Vn)?(js(Vn),!0):!1}]));y.registerKeyHandlers(Z)},[y,ai]),S.useEffect(()=>y.subscribe("paste",Z=>{yg({event:Z,intl:G,clientThreadId:i,conversationMode:ae,currentModelConfig:be,getEditorGizmoId:J,modelSupportedImageMimeTypes:$e})}),[G,i,ae,be,J,$e,y]);const li=Z=>{ne||ot(Z),y.trimLeadingText("@"),ar(),ns(!1)},ci=dS(i,St,G,$e,kt==null?void 0:kt.attachments),di=S.useCallback(()=>{n("",j),ee.logEvent($.pauseCompletion,{threadId:O.getServerThreadId(i),currentLeafId:O.getTree(i).getMessageId(W),eventSource:"mouse"}),ar()},[n,i,j,W]),me=S.useCallback(()=>{Oc.set(D==null?void 0:D.id,te,y.getCurrentText())},[te,D==null?void 0:D.id,y]);S.useEffect(()=>{H||ce||y.focus()},[ce,y]),S.useEffect(()=>{H||ms.reset()},[s,H]),S.useEffect(()=>{(!Vt&&oe||ne)&&ot(null)},[Vt,oe,ne]);const[yt,tt]=(()=>{switch(d){case"workspaceDisallowsGizmo":return[Tn.disallowedByWorkspacePlaceholder,!0];case"feedbackRequired":return[Tn.disabledFeedbackPlaceholder,!0];case"noModelsAvailable":return[Tn.noModelsAvailablePlaceholder,!0];case"requiresPluginsToBeInstalled":return[Tn.requiresPluginsToBeInstalled,!0];case"loadingPlugins":return[Tn.loading,!0];case"noTestGizmoId":return[Tn.noTestGizmoId,!0];default:return b?[Tn.continueSharedConversationPlaceholder,!1]:(Q==null?void 0:Q.placeholderTextOverride)!=null?[Q.placeholderTextOverride,!1]:[Tn.placeholderWithName,!1]}})(),ve=G.formatMessage(yt,{name:H!=null?K==="magic"?b0:H.name||"GPT":(Re==null?void 0:Re.gizmo.display.name)??"ChatGPT"});S.useEffect(()=>y.subscribe("input",()=>{gh.getState().isThreadHeaderVisible&&Ii.hideThreadHeader(),L(!0)}),[y]),S.useEffect(()=>{if(_)return y instanceof yc?y.subscribe("change",()=>{_==null||_()}):y.subscribe("input",()=>{_==null||_()})},[y,_]),S.useEffect(()=>y.subscribe("focus",()=>{L(!0)}),[y]);const Je={clientThreadId:i,uploadType:wt,modelAcceptedMimeTypes:gt,modelSupportedImageMimeTypes:$e,attachmentsProductFeature:kt==null?void 0:kt.attachments,getInputProps:Ns,openFileDialog:un,historyDisabled:B,onOauthRedirect:me,highlightTooltip:M&&!Ne},zn=!l&&!f&&at&&c.jsx(vS,{...Je}),Is=$o(i),As=Ne?c.jsxs(c.Fragment,{children:[K==="magic"&&c.jsx("div",{className:"m-2 mb-0 rounded-lg bg-token-main-surface-secondary p-2 text-xs text-token-text-secondary",children:c.jsx(U,{...Tn.gizmoKnowledgeWarning})}),c.jsx(kv,{files:De,clientThreadId:i,className:"flex flex-nowrap gap-2 overflow-x-auto pb-1.5 pt-[7px]"})]}):Is&&c.jsx(Qp,{wrapperClassName:"flex flex-nowrap gap-2 overflow-x-auto pb-1.5 pt-[7px]",clientThreadId:i}),Rs=tt?"disabled":"default",ss=o&&u?"streaming":!w||ce?"disabled":"idle",Un=S.useRef(null),nt=S.useRef(null),{value:Ds}=Jn("364642024");S.useEffect(()=>{const Z=()=>{Un.current!=null&&jt.addAction("composer_state_disabled",{threadId:O.getServerThreadId(i),disabledReason:Un.current})};if(x&&ss==="disabled"){let Ct="unknown";l?Ct=d??"component_disabled_unknown":o?Ct="completion_in_progress":xe?Ct="thread_hard_blocked":ce&&(Ct="starting_new_completion_request"),Un.current!==Ct&&(nt.current&&clearTimeout(nt.current),nt.current=setTimeout(Z,Sv)),Un.current=Ct}else Un.current=null;return()=>{nt.current&&(clearTimeout(nt.current),nt.current=null)}},[i,x,ss,l,d,o,xe,ce]);const Gi=[];if(Q!=null&&Q.label&&Gi.push({type:Q.type,value:Q.label,onRemoveRegion:Fn}),oe!==null){const Z=!!((Nc=oe.gizmo.tags)!=null&&Nc.includes(Rl.FirstParty));Gi.push({type:"mention",value:oe.gizmo.display.name,icon:c.jsx(xf,{isFirstParty:Z,src:oe.gizmo.display.profile_picture_url,className:"icon-md"}),onRemoveRegion:()=>{ot(null),y.focus()}})}S.useEffect(()=>{(!C||C.length===0||!ye)&&(Me.current=!1)},[C,ye]);const na=(Z,Ct,vn)=>{Me.current=Z>=0,Ct&&y.setText(vn?`${vn.title} ${vn.body}`:"")};return S.useEffect(()=>{Ln?P==null||P():F==null||F()},[Ln,P,F]),c.jsxs(xg.Provider,{value:St,children:[c.jsx(bg,{onOauthRedirect:me,children:c.jsx("form",{className:a,onSubmit:He,children:c.jsxs("div",{className:"relative flex h-full max-w-full flex-1 flex-col",children:[c.jsx(Fw,{className:N}),c.jsxs("div",{ref:g,className:"group relative flex w-full items-center",children:[r&&"from_template_row"in z.query&&c.jsx("button",{type:"button",onClick:()=>{z.push("/",void 0,{shallow:!0})},className:"mr-2 flex h-8 w-8 items-center justify-center text-token-text-tertiary hover:text-token-text-secondary",children:c.jsx(tb,{className:"icon-lg"})}),Vt&&!!te&&c.jsx(gw,{ref:ri}),Ln&&c.jsx("div",{className:se("absolute bottom-16 w-full space-y-2",La.TagGpt),children:c.jsx(kb,{onClick:Z=>li(Z),onClose:()=>{ns(!1),y.focus()}})}),Ds&&c.jsx("div",{className:se("absolute bottom-16 w-full space-y-2",La.TagGpt),children:c.jsx(xv,{composerController:y,clientThreadId:i})}),Is&&c.jsx(bv,{composerController:y}),c.jsx(uv,{type:B?"temporary":"default",ref:E,replyRegions:Gi,placeholder:ve,inputState:Rs,composerController:y,icon:zn,state:ss,onSubmit:ss==="streaming"?di:He,renderFiles:As,currentLeafId:W,clientThreadId:i,gizmoId:Re==null?void 0:Re.gizmo.id}),ye&&C&&C.length>0&&!Ln&&y.canShowAutocompletion()&&c.jsx("div",{className:se("absolute left-0 top-full z-10 mt-2 box-border w-full bg-token-main-surface-primary",zn?"px-8":"pl-0"),children:c.jsx(yw,{suggestions:C,composerController:y,onSelect:R,onChange:na})})]}),c.jsx(wg,{composerController:y,parsedDocumentHandler:ci})]})})}),c.jsx(nS,{canUseInlineTagging:Vt,isDisabled:l,clientThreadId:i,currentLeafId:W,currentRequestId:j,canContinue:p,composerController:y,setPromptInputMetadata:ge,suggestions:m,isNewThread:r,onCreateNewCompletion:e,onContinueGenerating:t,onResetState:et,conversationMode:ae}),ae!=null&&Sg.includes(ae.kind)&&c.jsx(kg,{onTargetedReply:ts})]})}function Xp(n){const e=S.useContext(ql);return({id:s,requestedModelId:i,eventMetadata:r,focusOnNewCompletion:o=!0,variantPurpose:a="none",useDefaultModel:l,appendMessages:d,conversationMode:u,juice:p=void 0})=>{const b=O.getTree(n).getParentPromptNode(s).id;e({type:In.Variant,promptId:b,requestedModelId:i,eventMetadata:r,cancelActiveRequests:!1,focusOnNewCompletion:o,useDefaultModel:l,completionMetadata:{variantPurpose:a,conversationMode:u,juice:p},appendMessages:d})}}const Mv=({children:n})=>{const[e]=S.useState(()=>new za);return n(e)},Zp=({children:n})=>{const{value:e}=Vo("374328013");return e?c.jsx(cv,{children:n}):c.jsx(Mv,{children:n})};function vv(n){var s,i,r;const e=((s=n.message)==null?void 0:s.author.role)===Ve.User,t=((i=n.metadata)==null?void 0:i.err)!=null&&((r=n.metadata)==null?void 0:r.errCode)!==an.ContentPolicy;return e||t}function Tv(n){return c.jsx(Zp,{children:e=>c.jsx(Ev,{...n,composerController:e})})}function Ev({clientThreadId:n,isNewThread:e,currentModelId:t,showPromptStarters:s,onRequestCompletion:i,composerContainerRef:r,composerController:o,setComposerBarElement:a}){const l=Ui(),d=Dl(),u=Zn(p=>{const m=Ot.getCurrentNode(n,p);return vv(m)});return!d&&u?c.jsx(_v,{clientThreadId:n}):c.jsxs(qh,{children:[c.jsx(hw,{clientThreadId:n}),c.jsx(Jl,{clientThreadId:n,isStaticSharedThread:l,showInlineEmbeddedDisplay:!1,withVerticalPadding:!1,withHorizontalPadding:!0,children:c.jsx(Yl,{children:c.jsx(em,{composerContainerRef:r,composerController:o,clientThreadId:n,currentModelId:t,isNewThread:e,showPromptStarters:s,setComposerBarElement:a,onRequestCompletion:i})})})]})}function _v({clientThreadId:n}){const e=Xp(n),t=Zn(r=>{var a;return((a=Ot.getCurrentNode(n,r).metadata)==null?void 0:a.errCode)===go}),s=xh(r=>r.isoDate),i=Rn(n);return t&&s!=null&&s!==""?null:c.jsxs("div",{children:[c.jsx("div",{className:"mb-3 text-center text-xs",children:c.jsx(U,{...mu.errorGeneratingResponse})}),c.jsx("div",{className:"flex items-center md:mb-4",children:c.jsx(It,{as:"button",color:"primary",onClick:()=>{e({id:i,eventMetadata:{eventSource:"mouse"},conversationMode:Ot.getConversationMode(n)})},className:"m-auto",icon:mf,children:c.jsx(U,{...mu.regenerateResponse})})})]})}function em({clientThreadId:n,currentModelId:e,isNewThread:t,onRequestCompletion:s,showPromptStarters:i,composerContainerRef:r,composerController:o,autocompletions:a,requiresFileUpload:l,onComposerInput:d,onAutocompleteSelect:u,headerClassName:p,setComposerBarElement:m,onTaggingDropdownClose:b,onTaggingDropdownOpen:g}){var De,St;const y=Rn(n),C=Nr(n),M=Ni(),{isUnauthenticated:_}=Zt(),N=Pc.useState(Pc.selectConversationStatus)(n)===Ax.PENDING,E=nf({clientThreadId:n,conversationLeafId:y}),P=Xn(C),F=(P||N)&&!E,D=Rn(n),A=!_,{isOpen:G,onClose:W}=_g(),j=S.useCallback(Ne=>{ee.logEvent($.continueCompletion),s({type:In.Continue,promptId:Ne,eventMetadata:{eventSource:"mouse"},cancelActiveRequests:!1,completionMetadata:{conversationMode:Ot.getConversationMode(n)}})},[s,n]),z=Wo(),H=Fi(),K=S.useCallback(async(Ne,Ue)=>{var f;const We=O.getServerThreadId(n);bs.stopConversation(We);const x=O.getTree(n);!x.hasReceivedServerCompletion&&!Uo()&&((f=x.getParent(Ue).metadata)==null?void 0:f.errCode)!==an.ContentPolicy&&setTimeout(()=>{qa.onCreateFinished(H,z,We)},500),We&&rt.checkGate("3922476776")&&await Ge.stopConversationProcess(We),zo.abortRequest(Ue)&&O.updateTree(n,w=>{const v=O.getThreadCurrentLeafId(n);w.updateNodeMessageMetadata(v,{finish_details:{type:"interrupted"}})})},[z,n,H]),J=S.useCallback(async({promptId:Ne,content:Ue,eventMetadata:We,completionMetadata:x,messageMetadata:h,appendMessages:f})=>{const w=O.getThreadCurrentLeafId(n);O.updateTree(n,v=>{v.addNode(Ne,Ue,w,Ve.User,void 0,h)}),await s({type:In.Next,promptId:Ne,eventMetadata:We,cancelActiveRequests:!0,completionMetadata:x,appendMessages:f})},[n,s]),de=v0(n,y),V=T0(n,y),B=!E&&P,we=S.useMemo(()=>B?!1:!de&&V,[de,V,B]),te=B&&e!=="gpt-4-pbrowse",ne=Kl(n),xe=Mn(n),Se=Ms(xe).data,{promptStarters:ge,isSuccess:ce}=ff(t&&!ne,n,4),Ce=nh(),ye=(()=>{var Ne,Ue;if((Ce==null?void 0:Ce.messageId)===((Ue=(Ne=O.getTree(n).getLastValidNode(y))==null?void 0:Ne.message)==null?void 0:Ue.id))return Ce==null?void 0:Ce.suggestions;if(i&&!ne&&ce&&!A)return ge})(),L=O.getTree(n),Me=L.countMessagesByAuthor(Ve.User),qe=S.useRef(),be=S.useRef();let ae=!1;qe.current==Me&&be.current==D?ae=!0:qe.current!==Me&&be.current!==D&&(ae=!0,qe.current=Me,be.current=D);const Re=L.getNodeByIdOrMessageId(y),oe=ae&&((De=Re==null?void 0:Re.message)==null?void 0:De.author.role)==Ve.Assistant&&Ul(Re.message),ot=Fl(),wt=Rx(),Ze=(()=>{var We;if(((We=Se==null?void 0:Se.gizmo.tags)==null?void 0:We.includes(Rl.WorkspaceDisabled))&&!wt)return"workspaceDisallowsGizmo";if(ot.size){if(M.displayingSideBySideFeedback&&M.unskippable)return"feedbackRequired"}else return"noModelsAvailable";const Ue=Ot.getConversationMode(n);return(Ue==null?void 0:Ue.kind)===it.GizmoTest&&Ue.gizmo_id==null?"noTestGizmoId":null})(),at=sf(n),$e=vs(n),gt=(St=Jn("15117983"))==null?void 0:St.value;return c.jsxs(c.Fragment,{children:[(t||oe)&&G?c.jsx(Ng,{onClose:W}):null,gt&&$e&&$e.kind===it.PrimaryAssistant&&$e.plugin_ids&&$e.plugin_ids.length>0?c.jsx(Nv,{}):c.jsx(Cv,{composerContainerRef:r,composerController:o,clientThreadId:n,onCreateNewCompletion:J,onAbortCompletion:K,onContinueGenerating:j,currentModelId:e,isNewThread:t,isCompletionInProgress:F,className:"w-full",canContinue:we,suggestions:ye??[],disabled:!!Ze,disabledReason:Ze??void 0,canPause:te,isInteractableSharedThread:at,autocompletions:a,requiresFileUpload:l,onComposerInput:d,onAutocompleteSelect:u,headerClassName:p,setComposerBarElement:m,onTaggingDropdownClose:b,onTaggingDropdownOpen:g},n)]})}function Nv(){return c.jsxs("div",{className:"mx-auto flex max-w-md flex-col items-center justify-center gap-2 rounded-xl border border-token-border-light bg-token-main-surface-primary p-6 shadow-lg",children:[c.jsx("span",{className:"text-token-text-primary",children:c.jsx(U,{id:"PluginsDecrepatedNotice.pluginsDeprecationTitle",defaultMessage:"Conversations with plugins are archived"})}),c.jsx("span",{className:"text-token-text-secondary",children:c.jsx(U,{id:"PluginsDecrepatedNotice.pluginsDeprecationSubtitle",defaultMessage:"Explore GPT Store to find a replacement"})}),c.jsxs("a",{href:"https://chat.openai.com/gpts",className:"text-green-500 hover:cursor-pointer dark:text-green-400",children:[c.jsx(U,{id:"PluginsDecrepatedNotice.pluginsDeprecationGptStoreLink",defaultMessage:"Explore GPTs"}),c.jsx("span",{className:"ml-2",children:c.jsx(U,{id:"PluginsDecrepatedNotice.pluginsDeprecationGptStoreLinkArrow",defaultMessage:""})})]})]})}const mu=Ke({errorGeneratingResponse:{id:"PromptTextarea.errorGeneratingResponse",defaultMessage:"There was an error generating a response"},regenerateResponse:{id:"PromptTextarea.regenerateResponse",defaultMessage:"Regenerate"}});function Iv(n){const{layer:e}=zi("4031588851"),{layer:t}=Vh("4031588851");return n?e.get("enable_new_homepage",!1):t.get("enable_new_homepage",!1)}function Av(n){return c.jsx(Zp,{children:e=>c.jsx(Rv,{...n,composerController:e})})}function Rv({clientThreadId:n,currentModelId:e,onRequestCompletion:t,composerController:s}){const i=Yn(n),r=Kl(n),o=Wl(),a=Er(),[l,d]=S.useState([]),u=S.useRef(!1),p=Vo("589604007").value,{promptStarters:m,isSuccess:b,isError:g}=ff(i&&!r,n,a?4:8,p,!0),y=!!l.find(j=>!!j.requires_file_upload),C=S.useRef(null),M=S.useRef(null),_=(j,z,H)=>{const K=j.title;d([]),s.focus(),s.setText(K),requestAnimationFrame(()=>{const J=((m==null?void 0:m.filter(de=>de.theme===j.theme))??[]).map(de=>({...de,type:Fc.Autocomplete}));d(J),J.length>0&&So(J,n),U0(j,H,n)})},R=m==null?void 0:m.reduce((j,z)=>(z.theme&&!j[z.theme]&&(j[z.theme]=z),j),{}),N=[];if(R)for(const j in R)N.push(R[j]);const E=N&&N.length>0,P=!!(b&&E),{layer:F}=zi("4031588851"),D=F.get("autocomplete_mode","HARDCODED"),A=S.useCallback(jl(async()=>{const j=s.getCurrentText();if(!j){d([]);return}if(u.current)return;d(H=>H.filter(K=>K.title===j));const z=Date.now();M.current=j,C.current=z;try{const H=await Ge.generateAutocompletions(j,4);if(C.current!==z||s.getCurrentText()!==M.current)return;const K=H.completions.map(J=>({id:_r(),type:Fc.Autocomplete,title:j,body:J,oneliner:J,prompt:`${j} ${J}`}));d(K),K.length>0&&So(K,n)}catch{}},250),[s]);S.useEffect(()=>{u.current&&d([])},[u]);const G=S.useCallback(()=>{d(s.getCurrentText()?l.filter(j=>`${j.title} ${j.body}`.startsWith(s.getCurrentText())):[])},[s,l]),W=S.useMemo(()=>D==="MODEL"?A:G,[D,A,G]);return c.jsx(c.Fragment,{children:c.jsx(Ys,{children:(g||b)&&c.jsx(c.Fragment,{children:c.jsx(Jl,{isStaticSharedThread:!1,showInlineEmbeddedDisplay:!1,withVerticalPadding:!0,withHorizontalPadding:!0,clientThreadId:n,children:c.jsxs(z0,{children:[c.jsx(Dv,{}),c.jsx(qh,{children:c.jsx("div",{className:"w-full",children:c.jsx(em,{clientThreadId:n,isNewThread:i,currentModelId:e,onRequestCompletion:t,showPromptStarters:!1,composerController:s,autocompletions:l,requiresFileUpload:y,onComposerInput:W,onAutocompleteSelect:(j,z,H)=>{d([z[H]])},onTaggingDropdownClose:()=>{u.current=!1},onTaggingDropdownOpen:()=>{u.current=!0},headerClassName:"hidden"})})}),P&&c.jsx(jv,{initial:{opacity:0},animate:{opacity:1},transition:{duration:.3},promptStarters:N,onSelectStarterPrompt:_,isSendBlocked:o,clientThreadId:n,className:"h-8"})]})})})})})}function Dv(){const{layer:n}=zi("4031588851"),e=n.get("headline_option","HELP_WITH"),s=Fe().formatMessage(e==="WHERE_TO_START"?hl.whereShouldWeStart:hl.whatCanIHelpWith),[i,r]=S.useState(1),[o,a]=S.useState(!0),l=20;return S.useEffect(()=>{let d;return i<s.length?d=setTimeout(()=>{r(i+1)},l):o&&(d=setTimeout(()=>{a(!1)},500)),()=>clearTimeout(d)},[s,i,o]),c.jsxs("div",{className:"mb-7 flex justify-center text-center text-2xl font-semibold leading-9",children:[c.jsx("h1",{children:s.substring(0,i)}),c.jsx("h1",{className:"result-streaming transition-opacity",style:{opacity:o?1:0},children:c.jsx("span",{})})]})}function jv({promptStarters:n,onSelectStarterPrompt:e,isSendBlocked:t,clientThreadId:s,...i}){return c.jsx(ft.div,{...i,children:c.jsx(Bv,{starterPrompts:n,onSelectStarterPrompt:e,disabled:t,clientThreadId:s})})}const Ov=/\s/;function Pv({starterPrompt:n,starterPrompts:e,index:t,disabled:s,onSelectStarterPrompt:i}){const r=n.theme??n.title,o=Ov.test(r);return c.jsxs("button",{className:"relative flex items-center gap-1.5 rounded-full border border-token-border-light px-3 py-2 text-start text-[13px] shadow-xxs transition enabled:hover:bg-token-main-surface-secondary disabled:cursor-not-allowed xl:gap-2 xl:text-[14px]",disabled:s,onClick:()=>i(n,e,t),children:[c.jsx(Ig,{starterPrompt:n,useV2Colors:!0}),c.jsx("div",{className:se("max-w-full text-balance text-gray-600 dark:text-gray-500",o?"break-word":"break-all"),children:r})]})}function gu({starterPrompts:n,onSelectStarterPrompt:e,disabled:t,clientThreadId:s,children:i}){return S.useEffect(()=>{So(n,s)},[s]),c.jsxs("ul",{className:"flex max-w-3xl flex-wrap items-stretch justify-center gap-2 xl:mx-3 xl:gap-2.5",children:[n.map((r,o)=>c.jsx(ft.li,{initial:{opacity:0},animate:{opacity:1},transition:{delay:o*.03},exit:{opacity:0},children:c.jsx(Pv,{starterPrompt:r,starterPrompts:n,index:o,disabled:t,onSelectStarterPrompt:e})},r.id??o)),i]})}function Fv({clientThreadId:n,onClick:e}){S.useEffect(()=>{V0(n)},[n]);const t=Fe();return c.jsx("button",{className:"relative flex max-w-full items-center gap-2 text-balance rounded-full border border-token-border-light px-3 py-2 text-start text-[14px] text-gray-600 shadow-xxs transition enabled:hover:bg-token-main-surface-secondary disabled:cursor-not-allowed dark:text-gray-500",onClick:()=>{W0(n),e()},children:t.formatMessage(hl.moreStarterPrompts)})}function Bv({starterPrompts:n,onSelectStarterPrompt:e,disabled:t,clientThreadId:s}){const[i,r]=S.useState(4),o=4,a=n.slice(0,o),l=n.slice(o,i).map(d=>({...d,isAdditional:!0}));return c.jsxs("div",{className:"mt-7 flex flex-col flex-wrap gap-y-2.5",children:[c.jsx("div",{children:c.jsx(gu,{starterPrompts:a,onSelectStarterPrompt:e,disabled:t,clientThreadId:s,children:n.length>i&&c.jsx(Fv,{clientThreadId:s,onClick:()=>{r(n.length)}})})}),l&&l.length>0&&c.jsx(gu,{starterPrompts:l,onSelectStarterPrompt:e,disabled:t,clientThreadId:s})]})}const hl=Ke({whatCanIHelpWith:{id:"SplashScreenV2.whatCanIHelpWith",defaultMessage:"What can I help with?"},whereShouldWeStart:{id:"SplashScreenV2.whereShouldWeStart",defaultMessage:"Where should we start?"},moreStarterPrompts:{id:"SplashScreenV2.moreStarterPrompts",defaultMessage:"More"}});function tm(n){const t=Rn(n)==="root",s=Nr(n),i=Xn(s),{serviceStatus:r}=S.useContext(Dx),o=Ni(),{isUnauthenticated:a}=Zt();return!t&&!i&&!(r!=null&&r.oof)&&!o.displayingSideBySideFeedback&&!a}function nm({clientThreadId:n}){var o;const e=O.getThreadCurrentLeafId(n),s=((o=O.getTree(n).getMessage(e).metadata)==null?void 0:o.model_switcher_deny)??[],i={};s.forEach(a=>{const{slug:l,context:d,reason:u,description:p}=a,m=i[l]??{},b=m[d]??[];b.push({reason:u,description:p}),m[d]=b,i[l]=m});const r=jh();for(const{resets_after:a,model_slug:l}of r)[Vc.CONVERSATION,Vc.REGENERATE].forEach(d=>{const u=i[l]??{},p=u[d]??[],m={reason:Go.RATE_LIMIT,resetsAfter:a};p.push(m),u[d]=p,i[l]=u});return i}var sm=(n=>(n.BROWSING="browsing_model",n.CODE_INTERPRETER="code_interpreter_model",n.DALLE="dalle_model",n))(sm||{}),Os=(n=>(n.ALPHA="alpha",n.EXPERIMENTS="experiments",n.MAINLINE="mainline",n))(Os||{});const Ea={browsing_model:{name:c.jsxs("span",{children:["Browse with ",c.jsx(jg,{className:"icon-sm mt-[-3px] inline-block"})," Bing"]})},code_interpreter_model:{name:"Advanced Data Analysis"},dalle_model:{name:"DALLE 3"}};function Lv(n){const e=zv(n??void 0);return bh(["alpha","experiments","mainline"],e)?"bg-orange-500 text-white":"bg-token-main-surface-primary text-token-text-primary"}function zv(n){const e=Cc();for(const t of e)if(t.options.length>0&&t.options.find(i=>i.value===n))return t.categoryId;return null}function Uv(n,e){const{data:t}=Rh();return(t==null?void 0:t.categories.some(i=>i[e]===n))??!1}const Vv=n=>Dg(n,({id:e})=>e.split(":").slice(0,1).join(":"));function Cc(){const{data:n}=Rh(),e=Ag(),t=On(),s=jx(t==null?void 0:t.getWorkspaceId()),i=(t==null?void 0:t.isEnterprise())??!1,{modelSwitcherDisclaimer:r}=Rg(),o=Fl();return S.useMemo(()=>{const a=[];if(!n)return a;const{categories:l,groups:d,modelsMap:u}=n;for(const p of l){const{defaultModel:m,categoryId:b,label:g}=p;if(o.has(m)){const y=e===m,C=n.modelsMap[m],M=y?[]:Wv(s.data,p,o,n.modelsMap,i);a.push({categoryId:b,value:m,name:g,description:y?r:C.description,options:[Ci(C,{name:"Default"}),...M]})}}for(const p of d){const{group:m,label:b,modelIds:g}=p,y=g[0],C=g.map(M=>u[M]).filter(({tags:M})=>!M.includes(Ox.HIDDEN));if(m==="experiments"){const M=Vv(C),_=Object.entries(M).map(([R,N])=>{const E=R.split(":").slice(-1)[0];return{key:R,value:E,name:E,options:N.map(P=>{const{title:F}=P;return Ci({...P,title:F.replace(E,"")})})}});a.push({categoryId:m,value:y,name:b,options:_})}else a.push({categoryId:m,value:y,name:b,options:C.map(M=>Ci(M))})}return a},[n,o,e,s.data,i,r])}function Ci(n,e={}){return{value:n.id,name:n.title,...e}}function Wv(n,e,t,s,i){const r=[],o=n==null?void 0:n.browsing;if((i&&o||!i)&&e.browsing_model!=null&&t.has(e.browsing_model)){const l=Ea.browsing_model;r.push(Ci(s[e.browsing_model],{name:l.name}))}if(e.code_interpreter_model!=null&&t.has(e.code_interpreter_model)){const l=Ea.code_interpreter_model;r.push(Ci(s[e.code_interpreter_model],{name:l.name}))}if(e.dalle_model!=null&&t.has(e.dalle_model)){const l=Ea.dalle_model;r.push(Ci(s[e.dalle_model],{name:l.name}))}return r}const Mc=({categoryId:n,type:e,className:t})=>{const{data:s,isLoading:i}=ax(),r=c.jsx("div",{className:t});if(i)return r;const{iconFilledSrc:o,iconOutlineSrc:a}=(s==null?void 0:s[n])??{},l=(e==="filled"?o:a)??"";return c.jsx(Hh,{name:"ModelCategoryIcon",fallback:r,children:c.jsx("div",{className:se("[&_svg]:h-full [&_svg]:w-full",t),dangerouslySetInnerHTML:{__html:l}})})},Gv=({clientThreadId:n,message:e})=>{var y,C,M,_,R,N,E,P;const t=Cc(),s=Oo(Po.ModelSwitcherAutoDowngrade),{categories:i}=Mr({isRegen:!0}),r=nm({clientThreadId:n}),{doesUserHaveAnyAccountsWithPlusFeatures:o}=Bi(),a=lx()!=null,l=[];for(const F of i){if(wh(F))continue;const{defaultModel:D,label:A,tagline:G,categoryId:W,subscriptionLevel:j}=F,z=(C=(y=r[D])==null?void 0:y.regenerate)==null?void 0:C[0];l.push({label:A,value:D,subtitle:G,icon:c.jsx(Mc,{className:"icon-md h-4 w-4",categoryId:W,type:"filled"}),modelSwitcherDeny:z,subscriptionLevel:j})}const d=qv(n,e.nodeId),u=(M=e.message.metadata)==null?void 0:M.model_slug,p=(_=t.find(F=>F.value===u))==null?void 0:_.name,m=Hv(a,d,u),b=(R=e.message.metadata)==null?void 0:R.model_adjustments,g=o&&s.eligible&&!s.isLoading&&p&&((N=l[0])==null?void 0:N.label)&&p!==((E=l[0])==null?void 0:E.label)&&(b==null?void 0:b.some(F=>F.startsWith("auto:smaller_model")));return{modelOptions:l,modelSlug:u,animateModelLabelOnRender:m,nuxProps:{shouldRenderNux:g,usedModelName:p,largestModelName:(P=l[0])==null?void 0:P.label,announcement:s}}};function qv(n,e){var o,a;return(a=(o=O.getTree(n).getConversationTurns(e).flatMap(l=>l.messages).filter(l=>l.message.author.role===Ve.Assistant&&!Px(l.message)).reverse()[1])==null?void 0:o.message.metadata)==null?void 0:a.model_slug}function Hv(n,e,t){return n&&!e?!0:!!(e&&t!==e)}function $v(){const{doesUserHaveAnyAccountsWithPlusFeatures:n}=Bi(),{categories:e}=Mr();return!!n||!!e.find(wh)}const Kv=({modelSwitcherDeny:n,value:e,label:t,subtitle:s,icon:i,onMouseEnter:r,onMouseLeave:o,onSelect:a,messageModelSlug:l,isHovered:d=!1,shouldShowUpsell:u=!1,className:p,includeCheck:m,includeRegenerate:b})=>{const g=On(),y=!n,C=!y&&!u,M=Fi(),_=()=>{if(!u){a==null||a();return}ee.logEvent($.openModalAccountPaymentfromMessageModelPicker),ee.logRateLimitGetPlusButtonClicked({type:Go.RATE_LIMIT,location:"message_model_switcher_dropdown",plan_type:(g==null?void 0:g.planType)??"unknown",is_hard_block:!1,hard_block_reason:"",is_new_conversation:!1}),Tl(M,"Message model switcher dropdown")};return c.jsx(Ae.Item,{onSelect:_,onMouseEnter:()=>y&&(r==null?void 0:r()),onMouseLeave:()=>y&&(o==null?void 0:o()),disabled:C,className:p??"radix-disabled:pointer-events-auto radix-disabled:cursor-not-allowed radix-disabled:hover:bg-transparent",children:c.jsxs(ti,{label:n&&c.jsx(Sh,{modelSwitcherDeny:n}),className:"flex w-full items-center justify-between gap-2",sideOffset:0,children:[c.jsxs("div",{className:"flex items-center gap-3",children:[c.jsx("span",{className:"flex h-7 w-7 items-center justify-center rounded-full bg-token-main-surface-secondary",children:i}),c.jsxs("div",{children:[c.jsx("div",{children:t}),c.jsx("div",{className:se({"text-sm text-token-text-secondary":!C},{"text-sm text-token-text-quaternary":C}),children:s})]})]}),u?c.jsx(It,{color:"secondary",size:"small",children:c.jsx(U,{id:"54fmrA",defaultMessage:"Get Plus"})}):c.jsx(Jv,{messageModelSlug:l,isHovered:d,modelSwitcherDeny:n,optionModelSlug:e,includeCheck:m,includeRegenerate:b})]})})},Jv=({modelSwitcherDeny:n,optionModelSlug:e,isHovered:t,messageModelSlug:s,includeRegenerate:i=!0,includeCheck:r=!0})=>{let o=null;if(n)switch(n.reason){case Go.RATE_LIMIT:o=nb;break;default:o=hr;break}if(n)return c.jsx(o,{className:"icon-md"});const a=!!i&&c.jsx(Xl,{className:se("icon-md hidden text-token-text-tertiary",{"group-hover:block":t})});return s===e&&r?c.jsxs(c.Fragment,{children:[c.jsx(yf,{className:se("icon-md text-token-text-primary",{"group-hover:hidden":t})}),a]}):a};function Yv({className:n,clientThreadId:e,message:t,onModelSelect:s,onDropdownChange:i}){const[r,o]=S.useState(null),[a,l]=S.useState(!1),[d,u]=S.useState(!1),p=$v(),m=tm(e),b=Mn(e),g=Gv({clientThreadId:e,message:t}),{doesUserHaveAnyAccountsWithPlusFeatures:y}=Bi(),C=S.useRef(null),M=A=>{A||setTimeout(()=>{C.current&&C.current.blur()},10)};if(S.useEffect(()=>{M(a)},[a]),!p||b)return null;const{modelOptions:_,modelSlug:R,animateModelLabelOnRender:N,nuxProps:E}=g;let P,F;E.shouldRenderNux?(P=Zv,F={title:c.jsx(U,{id:"g/+2Hh",defaultMessage:"Optimized your response"}),description:c.jsx(U,{id:"H0Flqm",defaultMessage:"Used {usedModelName} for a faster response that saves your limited {largestModelName} messages",values:{usedModelName:E.usedModelName,largestModelName:E.largestModelName}}),markAsViewed:E.announcement.markAsViewed}):(P=Xv,F={label:m?c.jsx(U,{id:"LBYK9a",defaultMessage:"Change model"}):c.jsx(U,{id:"nygjPN",defaultMessage:"Used {modelName}",values:{modelName:E.usedModelName}})});const D=m&&_.some(A=>yu(A,y));return c.jsxs(Ae.Root,{onOpenChange:A=>{m&&(l(A),i(A),M(A)),A&&ee.logEvent($.conversationOpenMessageModelSelector,{has_get_plus_button:D})},children:[c.jsx(P,{...F,children:c.jsx(Tb,{ref:C,className:se("cursor-pointer",n),onMouseEnter:()=>u(!0),onMouseLeave:()=>u(!1),children:c.jsx(Qv,{modelSlug:R,animateModelLabelOnRender:N,isDropdownOpen:a,isRegenerateEnabled:m,isHovered:d})})}),m&&c.jsx(Ae.Content,{className:"z-30 origin-top-right text-token-text-primary",side:"bottom",align:"start",children:_.map(A=>{var z;const G=yu(A,y),{value:W,...j}=A;return c.jsx(Kv,{value:W,onSelect:()=>s(W),onMouseEnter:()=>o(W),onMouseLeave:()=>o(null),isHovered:r===W,messageModelSlug:(z=t.message.metadata)==null?void 0:z.model_slug,shouldShowUpsell:G,...j},W)})})]})}function Qv({modelSlug:n,animateModelLabelOnRender:e,isDropdownOpen:t,isRegenerateEnabled:s,isHovered:i,isRegenLabel:r=!1}){const[o,a]=S.useState("initial"),{categories:l}=Mr({isRegen:!!r});S.useEffect(()=>{if(e){const y=setTimeout(()=>a("show"),500),C=setTimeout(()=>a("initial"),2e3);return()=>{clearTimeout(y),clearTimeout(C)}}a("initial")},[e]);const d=l.find(({defaultModel:y})=>y===n),u=n===cx?{categoryId:"gpt_3.5",shorterLabel:"3.5"}:{},{categoryId:p,shorterLabel:m}=d??u,b={initial:{opacity:0,paddingLeft:0,width:"0"},show:{opacity:1,paddingLeft:2,width:"100%"},visible:{opacity:1,paddingLeft:2,width:"100%",transition:{delay:0,duration:0}}},g=t?"visible":i?"show":o;return c.jsxs(ft.div,{initial:"initial",animate:g,className:"flex items-center pb-0",children:[r?c.jsx(Xl,{className:"icon-md h-4 w-4"}):p&&c.jsx(Mc,{type:"outline",categoryId:p,className:"icon-md h-4 w-4"}),s&&c.jsx(ft.span,{className:"overflow-hidden text-clip whitespace-nowrap text-sm",variants:b,transition:{type:"tween",duration:.18},children:m}),s&&c.jsx(Ho,{className:se("icon-sm",{"text-token-text-quaternary":!i},{"text-token-text-secondary":i})})]})}function Xv({children:n,label:e}){return c.jsx(ti,{label:e,sideOffset:0,children:n})}function Zv({children:n,title:e,description:t,markAsViewed:s}){return c.jsx(vl,{show:!0,side:"bottom",sideOffset:-4,title:e,description:t,badge:"beta",onDismiss:s,dismissOnOutsideClick:!0,children:n})}function yu(n,e){const{modelSwitcherDeny:t,subscriptionLevel:s}=n;return!!t&&t.reason===Go.RATE_LIMIT&&s===Fx.PLUS&&!e}const eT=S.memo(Yv),xu=Ai.IndepthFeedbackDismissedAt;function tT(){const[n,e]=S.useState(()=>{const s=localStorage.getItem(xu);return s?nT(new Date(s)):!1}),t=S.useCallback(()=>{e(!0),localStorage.setItem(xu,new Date().toISOString())},[]);return[n,t]}function nT(n){const e=new Date;return n.getFullYear()===e.getFullYear()&&n.getMonth()===e.getMonth()&&n.getDate()===e.getDate()}function sT({clientThreadId:n,conversationLeafId:e,trigger:t,variantIds:s}){const i=s.find(u=>u!==e),r=ni(u=>u.forceIndepthFeedback&&u.forceIndepthFeedbackPrompt),o=rt.getExperimentValue({experimentName:"4146182738",key:t==="paragen"?"enable_indepth_feedback_paragen":"enable_indepth_feedback_thumbsdown",defaultValue:!1,shouldLogExposure:!1}),a=rt.getExperimentValue({experimentName:"4146182738",key:t==="paragen"?"indepth_feedback_paragen_prompt":"indepth_feedback_thumbsdown_prompt",defaultValue:"",shouldLogExposure:!1}),l=i?O.getTree(n).getTextFromNode(i):"NONE";return(r||(o?a:"")).replace("{paragen_losing_response}",l)}function iT({clientThreadId:n,conversationLeafId:e,trigger:t,variantIds:s}){const[i,r]=tT(),o=oT({clientThreadId:n}),a=sT({clientThreadId:n,conversationLeafId:e,trigger:t,variantIds:s}),l=()=>{r(),ee.logEventWithStatsig($.messageIndepthFeedbackDeclined,"chatgpt_indepth_feedback_declined",{trigger:t})},d=()=>{o(e,{intent:"indepth_feedback"},a),ee.logEventWithStatsig($.messageIndepthFeedbackAccepted,"chatgpt_indepth_feedback_accepted",{trigger:t})};return i||!a?null:c.jsx(Ju,{content:c.jsx(U,{..._a.indepthFeedbackPrompt}),primaryCtaText:c.jsx(U,{..._a.indepthFeedbackAcceptButton}),onPrimaryCtaClick:d,secondaryCtaText:c.jsx(U,{..._a.indepthFeedbackRejectButton}),onSecondaryCtaClick:l})}function rT(n){const e=n.rating==="thumbsDown"?"thumbsDown":bh(["original","new"],n.inlineComparisonRating)?"paragen":void 0,t=ni(i=>i.forceIndepthFeedback);if(!e||t||e==="paragen"||rt.getExperimentValue({experimentName:"4146182738",key:"enable_indepth_feedback_thumbsdown",defaultValue:!1,shouldLogExposure:!0}))return e}function oT({clientThreadId:n}){const e=S.useContext(ql),t=Ot.getConversationMode(n);return(i,r,o)=>{e({type:In.Next,promptId:i,eventMetadata:r,focusOnNewCompletion:!0,cancelActiveRequests:!1,completionMetadata:{conversationMode:t},useDefaultModel:!1,appendMessages:[{id:_r(),author:{role:Ve.System},content:{content_type:cn.Text,parts:[o]},metadata:{is_indepth_feedback:!0,indepth_feedback_prompt:o}}]})}}const _a=Ke({indepthFeedbackPrompt:{id:"qEHwDx",defaultMessage:"Would you like to tell ChatGPT more about your feedback, so it can improve its responses?"},indepthFeedbackAcceptButton:{id:"IeyTQ7",defaultMessage:"Continue"},indepthFeedbackRejectButton:{id:"+o5xmp",defaultMessage:"Not now"},indepthFeedbackRejectAlwaysButton:{id:"Qdko+f",defaultMessage:"Don't ask again"}});function aT({clientThreadId:n,conversationMode:e}){const t=Xp(n);return(i,r,o,a,l)=>{const u=O.getTree(n).getConversationTurns(i),p=u==null?void 0:u[(u==null?void 0:u.length)-1].variantIds,m=(p==null?void 0:p.length)===1,b=m?{...r,intent:"comparison_implicit"}:r;t({id:i,requestedModelId:o,eventMetadata:b,focusOnNewCompletion:!0,variantPurpose:m?"comparison_implicit":"none",conversationMode:e??Ot.getConversationMode(n),useDefaultModel:!1,appendMessages:a?[{id:_r(),author:{role:Ve.System},content:{content_type:cn.Text,parts:[a]},metadata:{exclude_after_next_user_message:!0}}]:void 0,juice:l})}}function lT(n){var e,t;return((t=(e=n.message.metadata)==null?void 0:e.finish_details)==null?void 0:t.type)==="content_filter"}function Wi(n){if(n===void 0)return{flagSeverity:void 0,shouldHideContent:!1,errCode:void 0,errMessage:void 0};const{errType:e,errCode:t,err:s,disclaimers:i}=n,r=lT(n);return!(i&&i.length>0)&&r?{flagSeverity:"warning",shouldHideContent:!1,errCode:an.ContentOrTos,errMessage:s}:{flagSeverity:e,shouldHideContent:e==="danger"&&(t===an.ContentPolicy||t===an.ModelIncompatibility),disclaimers:i,errCode:t,errMessage:s}}function ta(n){return c.jsx(Fs,{flag:"danger",isUserTurn:!1,children:c.jsx(U,{...$t.somethingWentWrong})})}function cT({message:n,onRequestMoreCompletions:e,clientThreadId:t,id:s,isFeedbackEnabled:i,isUserTurn:r,className:o}){const{errCode:a,errMessage:l,flagSeverity:d}=Wi(n);switch(a){case an.ContentPolicy:return c.jsx(Fs,{flag:d,isUserTurn:r,className:o,children:c.jsx(hT,{isFeedbackEnabled:i})});case an.ModelIncompatibility:return c.jsx(Fs,{flag:d,isUserTurn:r,className:o,children:c.jsx(U,{...$t.modelIncompatibilityMessage})});case an.ContentOrTos:return c.jsx(Fs,{flag:d,isUserTurn:r,className:o,children:c.jsx(uT,{isFeedbackEnabled:i})});case go:return c.jsx(dT,{className:o,id:s,onRequestMoreCompletions:e,flag:d,clientThreadId:t,isUserTurn:r});case $h:return c.jsx(Fs,{flag:d,isUserTurn:r,className:o,children:c.jsx(U,{...$t.historyDisabledConversationMissing})});default:return l!==void 0?c.jsx(Fs,{flag:d,isUserTurn:r,className:o,children:c.jsx(Og,{rehypePlugins:[[Pg,{target:"_new",rel:"noopener noreferrer"}]],className:"markdown prose w-full break-words dark:prose-invert",children:l})}):null}}function dT({className:n,id:e,onRequestMoreCompletions:t,flag:s,clientThreadId:i,isUserTurn:r}){const o=xh(y=>y.isoDate),a=Fg(o),l=vs(i??Bx),d=l&&l.kind!==it.PrimaryAssistant,u=Dh(),p=Bl(),m=S.useCallback(()=>{t(e,{eventSource:"mouse"},!0,"none",!1)},[e,t]),b=S.useCallback(()=>{const y=p.id;u({modelId:y,location:"Model switcher menu item"}),t(e,{eventSource:"mouse"},!0,"none",!0)},[t,e,p.id,u]);let g;return d?g=o!=null?c.jsx("span",{children:c.jsx(U,{...$t.gptUsageCapExceededCustomFeature,values:{link:bu,formattedTime:a}})}):c.jsx(U,{...$t.gptUsageCapExceededExpired}):g=o!=null?c.jsx("span",{children:c.jsx(U,{...$t.gptUsageCapExceeded,values:{link:bu,formattedTime:a}})}):c.jsx(U,{...$t.gptUsageCapExceededExpired}),c.jsx(Fs,{flag:o!=null?s:void 0,isUserTurn:r,className:n,children:c.jsxs("div",{className:"flex items-center gap-6",children:[g,o==null&&c.jsx(It,{color:"secondary",className:"flex-shrink-0",onClick:m,children:c.jsx(U,{...$t.buttonTryAgain})}),o!=null&&!d&&c.jsx(It,{color:"secondary",className:"flex-shrink-0",onClick:b,children:c.jsx(U,{...$t.buttonUseDefaultModel})})]})})}const bu=n=>c.jsx("a",{href:"https://share.hsforms.com/16d0ZZVM3QZirXnCD_q7u1Q4sk30",target:"_blank",rel:"noreferrer",className:"underline",children:n});function uT({isFeedbackEnabled:n}){return c.jsxs(c.Fragment,{children:[c.jsx("div",{className:n?"font-semibold":"",children:c.jsx(U,{...$t.contentOrTosViolationNoFeedback,values:{contentPolicyLink:im,termsLink:fT}})}),c.jsx("div",{children:n&&c.jsx(U,{...$t.contentPolicyFeedback})})]})}function hT({isFeedbackEnabled:n}){return c.jsxs(c.Fragment,{children:[c.jsx("div",{className:n?"font-semibold":"",children:c.jsx(U,{...$t.contentPolicyViolationNoFeedback,values:{contentPolicyLink:im}})}),c.jsx("div",{children:n&&c.jsx(U,{...$t.contentPolicyFeedback})})]})}const im=n=>c.jsx(kh,{target:"_blank",href:"https://openai.com/policies/usage-policies",rel:"noreferrer",children:n}),fT=n=>c.jsx(kh,{target:"_blank",href:"https://openai.com/policies/terms-of-use",rel:"noreferrer",children:n}),$t=Ke({contentPolicyFeedback:{id:"TextMessageDisplay.contentPolicyFeedback",defaultMessage:"Did we get it wrong? Please tell us by giving this response a thumbs down."},contentPolicyViolation:{id:"TextMessageDisplay.contentPolicyViolation.2",defaultMessage:"This content may violate our <contentPolicyLink>usage policies</contentPolicyLink>. Did we get it wrong? Please tell us by giving this response a thumbs down."},contentPolicyViolationNoFeedback:{id:"TextMessageDisplay.contentPolicyViolationNoFeedback",defaultMessage:"This content may violate our <contentPolicyLink>usage policies</contentPolicyLink>."},modelIncompatibilityMessage:{id:"zXOUK3",defaultMessage:"This model can't support this action. Try again with a different model."},contentOrTosViolation:{id:"TextMessageDisplay.contentOrTosViolation.2",defaultMessage:"This content may violate our <termsLink>Terms of Use</termsLink> or <contentPolicyLink>usage policies</contentPolicyLink>. Did we get it wrong? Please tell us by giving this response a thumbs down."},contentOrTosViolationNoFeedback:{id:"TextMessageDisplay.contentOrTosViolationNoFeedback",defaultMessage:"This content may violate our <termsLink>Terms of Use</termsLink> or <contentPolicyLink>usage policies</contentPolicyLink>."},historyDisabledConversationMissing:{id:"TextMessageDisplay.historyDisabledConversationMissing",defaultMessage:"Sorry, conversations created when Chat History is off expire after 6 hours of inactivity. Please start a new conversation to continue using ChatGPT."},somethingWentWrong:{id:"TextMessageDisplay.somethingWentWrong",defaultMessage:"Something went wrong."},gptUsageCapExceeded:{id:"TextMessageDisplay.gptUsageCapExceeded",defaultMessage:"You've reached the current usage cap for GPT-4. You can continue with the default model now, or try again {formattedTime}. <link>Learn more</link>"},gptUsageCapExceededCustomFeature:{id:"TextMessageDisplay.gptUsageCapExceededCustomFeature",defaultMessage:"You've reached the current usage cap for GPT-4, please try again {formattedTime}. <link>Learn more</link>"},gptUsageCapExceededExpired:{id:"TextMessageDisplay.gptUsageCapExceededExpired",defaultMessage:"You previously reached your usage cap for GPT-4, but you can now try sending your message again"},buttonUseDefaultModel:{id:"TextMessageDisplay.buttonUseDefaultModel",defaultMessage:"Use default model"},buttonTryAgain:{id:"TextMessageDisplay.buttonTryAgain",defaultMessage:"Try again"}}),mi=typeof performance=="object"&&performance&&typeof performance.now=="function"?performance:Date,rm=new Set,fl=typeof process=="object"&&process?process:{},om=(n,e,t,s)=>{typeof fl.emitWarning=="function"?fl.emitWarning(n,e,t,s):console.error(`[${t}] ${e}: ${n}`)};let Ro=globalThis.AbortController,wu=globalThis.AbortSignal;var zu;if(typeof Ro>"u"){wu=class{constructor(){re(this,"onabort");re(this,"_onabort",[]);re(this,"reason");re(this,"aborted",!1)}addEventListener(s,i){this._onabort.push(i)}},Ro=class{constructor(){re(this,"signal",new wu);e()}abort(s){var i,r;if(!this.signal.aborted){this.signal.reason=s,this.signal.aborted=!0;for(const o of this.signal._onabort)o(s);(r=(i=this.signal).onabort)==null||r.call(i,s)}}};let n=((zu=fl.env)==null?void 0:zu.LRU_CACHE_IGNORE_AC_WARNING)!=="1";const e=()=>{n&&(n=!1,om("AbortController is not defined. If using lru-cache in node 14, load an AbortController polyfill from the `node-abort-controller` package. A minimal polyfill is provided for use by LRUCache.fetch(), but it should not be relied upon in other contexts (eg, passing it to other APIs that use AbortController/AbortSignal might have undesirable effects). You may disable this with LRU_CACHE_IGNORE_AC_WARNING=1 in the env.","NO_ABORT_CONTROLLER","ENOTSUP",e))}}const pT=n=>!rm.has(n),ls=n=>n&&n===Math.floor(n)&&n>0&&isFinite(n),am=n=>ls(n)?n<=Math.pow(2,8)?Uint8Array:n<=Math.pow(2,16)?Uint16Array:n<=Math.pow(2,32)?Uint32Array:n<=Number.MAX_SAFE_INTEGER?so:null:null;class so extends Array{constructor(e){super(e),this.fill(0)}}var vi;const zs=class zs{constructor(e,t){re(this,"heap");re(this,"length");if(!k(zs,vi))throw new TypeError("instantiate Stack using Stack.create(n)");this.heap=new t(e),this.length=0}static create(e){const t=am(e);if(!t)return[];le(zs,vi,!0);const s=new zs(e,t);return le(zs,vi,!1),s}push(e){this.heap[this.length++]=e}pop(){return this.heap[--this.length]}};vi=new WeakMap,je(zs,vi,!1);let pl=zs;var Uu,Vu,hn,Wt,fn,pn,Ti,ut,mn,lt,Qe,pe,Rt,Gt,vt,pt,gn,mt,yn,xn,qt,bn,ps,Dt,Y,gl,Ws,Kn,wr,Ht,lm,Gs,Ei,Sr,cs,ds,yl,io,ro,Ye,xl,Zi;const _c=class _c{constructor(e){je(this,Y);je(this,hn);je(this,Wt);je(this,fn);je(this,pn);je(this,Ti);re(this,"ttl");re(this,"ttlResolution");re(this,"ttlAutopurge");re(this,"updateAgeOnGet");re(this,"updateAgeOnHas");re(this,"allowStale");re(this,"noDisposeOnSet");re(this,"noUpdateTTL");re(this,"maxEntrySize");re(this,"sizeCalculation");re(this,"noDeleteOnFetchRejection");re(this,"noDeleteOnStaleGet");re(this,"allowStaleOnFetchAbort");re(this,"allowStaleOnFetchRejection");re(this,"ignoreFetchAbort");je(this,ut);je(this,mn);je(this,lt);je(this,Qe);je(this,pe);je(this,Rt);je(this,Gt);je(this,vt);je(this,pt);je(this,gn);je(this,mt);je(this,yn);je(this,xn);je(this,qt);je(this,bn);je(this,ps);je(this,Dt);je(this,Ws,()=>{});je(this,Kn,()=>{});je(this,wr,()=>{});je(this,Ht,()=>!1);je(this,Gs,e=>{});je(this,Ei,(e,t,s)=>{});je(this,Sr,(e,t,s,i)=>{if(s||i)throw new TypeError("cannot set size without setting maxSize or maxEntrySize on cache");return 0});re(this,Uu,"LRUCache");const{max:t=0,ttl:s,ttlResolution:i=1,ttlAutopurge:r,updateAgeOnGet:o,updateAgeOnHas:a,allowStale:l,dispose:d,disposeAfter:u,noDisposeOnSet:p,noUpdateTTL:m,maxSize:b=0,maxEntrySize:g=0,sizeCalculation:y,fetchMethod:C,noDeleteOnFetchRejection:M,noDeleteOnStaleGet:_,allowStaleOnFetchRejection:R,allowStaleOnFetchAbort:N,ignoreFetchAbort:E}=e;if(t!==0&&!ls(t))throw new TypeError("max option must be a nonnegative integer");const P=t?am(t):Array;if(!P)throw new Error("invalid max value: "+t);if(le(this,hn,t),le(this,Wt,b),this.maxEntrySize=g||k(this,Wt),this.sizeCalculation=y,this.sizeCalculation){if(!k(this,Wt)&&!this.maxEntrySize)throw new TypeError("cannot set sizeCalculation without setting maxSize or maxEntrySize");if(typeof this.sizeCalculation!="function")throw new TypeError("sizeCalculation set to non-function")}if(C!==void 0&&typeof C!="function")throw new TypeError("fetchMethod must be a function if specified");if(le(this,Ti,C),le(this,ps,!!C),le(this,lt,new Map),le(this,Qe,new Array(t).fill(void 0)),le(this,pe,new Array(t).fill(void 0)),le(this,Rt,new P(t)),le(this,Gt,new P(t)),le(this,vt,0),le(this,pt,0),le(this,gn,pl.create(t)),le(this,ut,0),le(this,mn,0),typeof d=="function"&&le(this,fn,d),typeof u=="function"?(le(this,pn,u),le(this,mt,[])):(le(this,pn,void 0),le(this,mt,void 0)),le(this,bn,!!k(this,fn)),le(this,Dt,!!k(this,pn)),this.noDisposeOnSet=!!p,this.noUpdateTTL=!!m,this.noDeleteOnFetchRejection=!!M,this.allowStaleOnFetchRejection=!!R,this.allowStaleOnFetchAbort=!!N,this.ignoreFetchAbort=!!E,this.maxEntrySize!==0){if(k(this,Wt)!==0&&!ls(k(this,Wt)))throw new TypeError("maxSize must be a positive integer if specified");if(!ls(this.maxEntrySize))throw new TypeError("maxEntrySize must be a positive integer if specified");ie(this,Y,lm).call(this)}if(this.allowStale=!!l,this.noDeleteOnStaleGet=!!_,this.updateAgeOnGet=!!o,this.updateAgeOnHas=!!a,this.ttlResolution=ls(i)||i===0?i:1,this.ttlAutopurge=!!r,this.ttl=s||0,this.ttl){if(!ls(this.ttl))throw new TypeError("ttl must be a positive integer if specified");ie(this,Y,gl).call(this)}if(k(this,hn)===0&&this.ttl===0&&k(this,Wt)===0)throw new TypeError("At least one of max, maxSize, or ttl is required");if(!this.ttlAutopurge&&!k(this,hn)&&!k(this,Wt)){const F="LRU_CACHE_UNBOUNDED";pT(F)&&(rm.add(F),om("TTL caching without ttlAutopurge, max, or maxSize can result in unbounded memory consumption.","UnboundedCacheWarning",F,_c))}}static unsafeExposeInternals(e){return{starts:k(e,xn),ttls:k(e,qt),sizes:k(e,yn),keyMap:k(e,lt),keyList:k(e,Qe),valList:k(e,pe),next:k(e,Rt),prev:k(e,Gt),get head(){return k(e,vt)},get tail(){return k(e,pt)},free:k(e,gn),isBackgroundFetch:t=>{var s;return ie(s=e,Y,Ye).call(s,t)},backgroundFetch:(t,s,i,r)=>{var o;return ie(o=e,Y,ro).call(o,t,s,i,r)},moveToTail:t=>{var s;return ie(s=e,Y,Zi).call(s,t)},indexes:t=>{var s;return ie(s=e,Y,cs).call(s,t)},rindexes:t=>{var s;return ie(s=e,Y,ds).call(s,t)},isStale:t=>{var s;return k(s=e,Ht).call(s,t)}}}get max(){return k(this,hn)}get maxSize(){return k(this,Wt)}get calculatedSize(){return k(this,mn)}get size(){return k(this,ut)}get fetchMethod(){return k(this,Ti)}get dispose(){return k(this,fn)}get disposeAfter(){return k(this,pn)}getRemainingTTL(e){return k(this,lt).has(e)?1/0:0}*entries(){for(const e of ie(this,Y,cs).call(this))k(this,pe)[e]!==void 0&&k(this,Qe)[e]!==void 0&&!ie(this,Y,Ye).call(this,k(this,pe)[e])&&(yield[k(this,Qe)[e],k(this,pe)[e]])}*rentries(){for(const e of ie(this,Y,ds).call(this))k(this,pe)[e]!==void 0&&k(this,Qe)[e]!==void 0&&!ie(this,Y,Ye).call(this,k(this,pe)[e])&&(yield[k(this,Qe)[e],k(this,pe)[e]])}*keys(){for(const e of ie(this,Y,cs).call(this)){const t=k(this,Qe)[e];t!==void 0&&!ie(this,Y,Ye).call(this,k(this,pe)[e])&&(yield t)}}*rkeys(){for(const e of ie(this,Y,ds).call(this)){const t=k(this,Qe)[e];t!==void 0&&!ie(this,Y,Ye).call(this,k(this,pe)[e])&&(yield t)}}*values(){for(const e of ie(this,Y,cs).call(this))k(this,pe)[e]!==void 0&&!ie(this,Y,Ye).call(this,k(this,pe)[e])&&(yield k(this,pe)[e])}*rvalues(){for(const e of ie(this,Y,ds).call(this))k(this,pe)[e]!==void 0&&!ie(this,Y,Ye).call(this,k(this,pe)[e])&&(yield k(this,pe)[e])}[(Vu=Symbol.iterator,Uu=Symbol.toStringTag,Vu)](){return this.entries()}find(e,t={}){for(const s of ie(this,Y,cs).call(this)){const i=k(this,pe)[s],r=ie(this,Y,Ye).call(this,i)?i.__staleWhileFetching:i;if(r!==void 0&&e(r,k(this,Qe)[s],this))return this.get(k(this,Qe)[s],t)}}forEach(e,t=this){for(const s of ie(this,Y,cs).call(this)){const i=k(this,pe)[s],r=ie(this,Y,Ye).call(this,i)?i.__staleWhileFetching:i;r!==void 0&&e.call(t,r,k(this,Qe)[s],this)}}rforEach(e,t=this){for(const s of ie(this,Y,ds).call(this)){const i=k(this,pe)[s],r=ie(this,Y,Ye).call(this,i)?i.__staleWhileFetching:i;r!==void 0&&e.call(t,r,k(this,Qe)[s],this)}}purgeStale(){let e=!1;for(const t of ie(this,Y,ds).call(this,{allowStale:!0}))k(this,Ht).call(this,t)&&(this.delete(k(this,Qe)[t]),e=!0);return e}info(e){const t=k(this,lt).get(e);if(t===void 0)return;const s=k(this,pe)[t],i=ie(this,Y,Ye).call(this,s)?s.__staleWhileFetching:s;if(i===void 0)return;const r={value:i};if(k(this,qt)&&k(this,xn)){const o=k(this,qt)[t],a=k(this,xn)[t];if(o&&a){const l=o-(mi.now()-a);r.ttl=l,r.start=Date.now()}}return k(this,yn)&&(r.size=k(this,yn)[t]),r}dump(){const e=[];for(const t of ie(this,Y,cs).call(this,{allowStale:!0})){const s=k(this,Qe)[t],i=k(this,pe)[t],r=ie(this,Y,Ye).call(this,i)?i.__staleWhileFetching:i;if(r===void 0||s===void 0)continue;const o={value:r};if(k(this,qt)&&k(this,xn)){o.ttl=k(this,qt)[t];const a=mi.now()-k(this,xn)[t];o.start=Math.floor(Date.now()-a)}k(this,yn)&&(o.size=k(this,yn)[t]),e.unshift([s,o])}return e}load(e){this.clear();for(const[t,s]of e){if(s.start){const i=Date.now()-s.start;s.start=mi.now()-i}this.set(t,s.value,s)}}set(e,t,s={}){var m,b,g,y,C;if(t===void 0)return this.delete(e),this;const{ttl:i=this.ttl,start:r,noDisposeOnSet:o=this.noDisposeOnSet,sizeCalculation:a=this.sizeCalculation,status:l}=s;let{noUpdateTTL:d=this.noUpdateTTL}=s;const u=k(this,Sr).call(this,e,t,s.size||0,a);if(this.maxEntrySize&&u>this.maxEntrySize)return l&&(l.set="miss",l.maxEntrySizeExceeded=!0),this.delete(e),this;let p=k(this,ut)===0?void 0:k(this,lt).get(e);if(p===void 0)p=k(this,ut)===0?k(this,pt):k(this,gn).length!==0?k(this,gn).pop():k(this,ut)===k(this,hn)?ie(this,Y,io).call(this,!1):k(this,ut),k(this,Qe)[p]=e,k(this,pe)[p]=t,k(this,lt).set(e,p),k(this,Rt)[k(this,pt)]=p,k(this,Gt)[p]=k(this,pt),le(this,pt,p),Or(this,ut)._++,k(this,Ei).call(this,p,u,l),l&&(l.set="add"),d=!1;else{ie(this,Y,Zi).call(this,p);const M=k(this,pe)[p];if(t!==M){if(k(this,ps)&&ie(this,Y,Ye).call(this,M)){M.__abortController.abort(new Error("replaced"));const{__staleWhileFetching:_}=M;_!==void 0&&!o&&(k(this,bn)&&((m=k(this,fn))==null||m.call(this,_,e,"set")),k(this,Dt)&&((b=k(this,mt))==null||b.push([_,e,"set"])))}else o||(k(this,bn)&&((g=k(this,fn))==null||g.call(this,M,e,"set")),k(this,Dt)&&((y=k(this,mt))==null||y.push([M,e,"set"])));if(k(this,Gs).call(this,p),k(this,Ei).call(this,p,u,l),k(this,pe)[p]=t,l){l.set="replace";const _=M&&ie(this,Y,Ye).call(this,M)?M.__staleWhileFetching:M;_!==void 0&&(l.oldValue=_)}}else l&&(l.set="update")}if(i!==0&&!k(this,qt)&&ie(this,Y,gl).call(this),k(this,qt)&&(d||k(this,wr).call(this,p,i,r),l&&k(this,Kn).call(this,l,p)),!o&&k(this,Dt)&&k(this,mt)){const M=k(this,mt);let _;for(;_=M==null?void 0:M.shift();)(C=k(this,pn))==null||C.call(this,..._)}return this}pop(){var e;try{for(;k(this,ut);){const t=k(this,pe)[k(this,vt)];if(ie(this,Y,io).call(this,!0),ie(this,Y,Ye).call(this,t)){if(t.__staleWhileFetching)return t.__staleWhileFetching}else if(t!==void 0)return t}}finally{if(k(this,Dt)&&k(this,mt)){const t=k(this,mt);let s;for(;s=t==null?void 0:t.shift();)(e=k(this,pn))==null||e.call(this,...s)}}}has(e,t={}){const{updateAgeOnHas:s=this.updateAgeOnHas,status:i}=t,r=k(this,lt).get(e);if(r!==void 0){const o=k(this,pe)[r];if(ie(this,Y,Ye).call(this,o)&&o.__staleWhileFetching===void 0)return!1;if(k(this,Ht).call(this,r))i&&(i.has="stale",k(this,Kn).call(this,i,r));else return s&&k(this,Ws).call(this,r),i&&(i.has="hit",k(this,Kn).call(this,i,r)),!0}else i&&(i.has="miss");return!1}peek(e,t={}){const{allowStale:s=this.allowStale}=t,i=k(this,lt).get(e);if(i===void 0||!s&&k(this,Ht).call(this,i))return;const r=k(this,pe)[i];return ie(this,Y,Ye).call(this,r)?r.__staleWhileFetching:r}async fetch(e,t={}){const{allowStale:s=this.allowStale,updateAgeOnGet:i=this.updateAgeOnGet,noDeleteOnStaleGet:r=this.noDeleteOnStaleGet,ttl:o=this.ttl,noDisposeOnSet:a=this.noDisposeOnSet,size:l=0,sizeCalculation:d=this.sizeCalculation,noUpdateTTL:u=this.noUpdateTTL,noDeleteOnFetchRejection:p=this.noDeleteOnFetchRejection,allowStaleOnFetchRejection:m=this.allowStaleOnFetchRejection,ignoreFetchAbort:b=this.ignoreFetchAbort,allowStaleOnFetchAbort:g=this.allowStaleOnFetchAbort,context:y,forceRefresh:C=!1,status:M,signal:_}=t;if(!k(this,ps))return M&&(M.fetch="get"),this.get(e,{allowStale:s,updateAgeOnGet:i,noDeleteOnStaleGet:r,status:M});const R={allowStale:s,updateAgeOnGet:i,noDeleteOnStaleGet:r,ttl:o,noDisposeOnSet:a,size:l,sizeCalculation:d,noUpdateTTL:u,noDeleteOnFetchRejection:p,allowStaleOnFetchRejection:m,allowStaleOnFetchAbort:g,ignoreFetchAbort:b,status:M,signal:_};let N=k(this,lt).get(e);if(N===void 0){M&&(M.fetch="miss");const E=ie(this,Y,ro).call(this,e,N,R,y);return E.__returned=E}else{const E=k(this,pe)[N];if(ie(this,Y,Ye).call(this,E)){const G=s&&E.__staleWhileFetching!==void 0;return M&&(M.fetch="inflight",G&&(M.returnedStale=!0)),G?E.__staleWhileFetching:E.__returned=E}const P=k(this,Ht).call(this,N);if(!C&&!P)return M&&(M.fetch="hit"),ie(this,Y,Zi).call(this,N),i&&k(this,Ws).call(this,N),M&&k(this,Kn).call(this,M,N),E;const F=ie(this,Y,ro).call(this,e,N,R,y),A=F.__staleWhileFetching!==void 0&&s;return M&&(M.fetch=P?"stale":"refresh",A&&P&&(M.returnedStale=!0)),A?F.__staleWhileFetching:F.__returned=F}}get(e,t={}){const{allowStale:s=this.allowStale,updateAgeOnGet:i=this.updateAgeOnGet,noDeleteOnStaleGet:r=this.noDeleteOnStaleGet,status:o}=t,a=k(this,lt).get(e);if(a!==void 0){const l=k(this,pe)[a],d=ie(this,Y,Ye).call(this,l);return o&&k(this,Kn).call(this,o,a),k(this,Ht).call(this,a)?(o&&(o.get="stale"),d?(o&&s&&l.__staleWhileFetching!==void 0&&(o.returnedStale=!0),s?l.__staleWhileFetching:void 0):(r||this.delete(e),o&&s&&(o.returnedStale=!0),s?l:void 0)):(o&&(o.get="hit"),d?l.__staleWhileFetching:(ie(this,Y,Zi).call(this,a),i&&k(this,Ws).call(this,a),l))}else o&&(o.get="miss")}delete(e){var s,i,r,o;let t=!1;if(k(this,ut)!==0){const a=k(this,lt).get(e);if(a!==void 0)if(t=!0,k(this,ut)===1)this.clear();else{k(this,Gs).call(this,a);const l=k(this,pe)[a];if(ie(this,Y,Ye).call(this,l)?l.__abortController.abort(new Error("deleted")):(k(this,bn)||k(this,Dt))&&(k(this,bn)&&((s=k(this,fn))==null||s.call(this,l,e,"delete")),k(this,Dt)&&((i=k(this,mt))==null||i.push([l,e,"delete"]))),k(this,lt).delete(e),k(this,Qe)[a]=void 0,k(this,pe)[a]=void 0,a===k(this,pt))le(this,pt,k(this,Gt)[a]);else if(a===k(this,vt))le(this,vt,k(this,Rt)[a]);else{const d=k(this,Gt)[a];k(this,Rt)[d]=k(this,Rt)[a];const u=k(this,Rt)[a];k(this,Gt)[u]=k(this,Gt)[a]}Or(this,ut)._--,k(this,gn).push(a)}}if(k(this,Dt)&&((r=k(this,mt))!=null&&r.length)){const a=k(this,mt);let l;for(;l=a==null?void 0:a.shift();)(o=k(this,pn))==null||o.call(this,...l)}return t}clear(){var e,t,s;for(const i of ie(this,Y,ds).call(this,{allowStale:!0})){const r=k(this,pe)[i];if(ie(this,Y,Ye).call(this,r))r.__abortController.abort(new Error("deleted"));else{const o=k(this,Qe)[i];k(this,bn)&&((e=k(this,fn))==null||e.call(this,r,o,"delete")),k(this,Dt)&&((t=k(this,mt))==null||t.push([r,o,"delete"]))}}if(k(this,lt).clear(),k(this,pe).fill(void 0),k(this,Qe).fill(void 0),k(this,qt)&&k(this,xn)&&(k(this,qt).fill(0),k(this,xn).fill(0)),k(this,yn)&&k(this,yn).fill(0),le(this,vt,0),le(this,pt,0),k(this,gn).length=0,le(this,mn,0),le(this,ut,0),k(this,Dt)&&k(this,mt)){const i=k(this,mt);let r;for(;r=i==null?void 0:i.shift();)(s=k(this,pn))==null||s.call(this,...r)}}};hn=new WeakMap,Wt=new WeakMap,fn=new WeakMap,pn=new WeakMap,Ti=new WeakMap,ut=new WeakMap,mn=new WeakMap,lt=new WeakMap,Qe=new WeakMap,pe=new WeakMap,Rt=new WeakMap,Gt=new WeakMap,vt=new WeakMap,pt=new WeakMap,gn=new WeakMap,mt=new WeakMap,yn=new WeakMap,xn=new WeakMap,qt=new WeakMap,bn=new WeakMap,ps=new WeakMap,Dt=new WeakMap,Y=new WeakSet,gl=function(){const e=new so(k(this,hn)),t=new so(k(this,hn));le(this,qt,e),le(this,xn,t),le(this,wr,(r,o,a=mi.now())=>{if(t[r]=o!==0?a:0,e[r]=o,o!==0&&this.ttlAutopurge){const l=setTimeout(()=>{k(this,Ht).call(this,r)&&this.delete(k(this,Qe)[r])},o+1);l.unref&&l.unref()}}),le(this,Ws,r=>{t[r]=e[r]!==0?mi.now():0}),le(this,Kn,(r,o)=>{if(e[o]){const a=e[o],l=t[o];if(!a||!l)return;r.ttl=a,r.start=l,r.now=s||i();const d=r.now-l;r.remainingTTL=a-d}});let s=0;const i=()=>{const r=mi.now();if(this.ttlResolution>0){s=r;const o=setTimeout(()=>s=0,this.ttlResolution);o.unref&&o.unref()}return r};this.getRemainingTTL=r=>{const o=k(this,lt).get(r);if(o===void 0)return 0;const a=e[o],l=t[o];if(!a||!l)return 1/0;const d=(s||i())-l;return a-d},le(this,Ht,r=>{const o=t[r],a=e[r];return!!a&&!!o&&(s||i())-o>a})},Ws=new WeakMap,Kn=new WeakMap,wr=new WeakMap,Ht=new WeakMap,lm=function(){const e=new so(k(this,hn));le(this,mn,0),le(this,yn,e),le(this,Gs,t=>{le(this,mn,k(this,mn)-e[t]),e[t]=0}),le(this,Sr,(t,s,i,r)=>{if(ie(this,Y,Ye).call(this,s))return 0;if(!ls(i))if(r){if(typeof r!="function")throw new TypeError("sizeCalculation must be a function");if(i=r(s,t),!ls(i))throw new TypeError("sizeCalculation return invalid (expect positive integer)")}else throw new TypeError("invalid size value (must be positive integer). When maxSize or maxEntrySize is used, sizeCalculation or size must be set.");return i}),le(this,Ei,(t,s,i)=>{if(e[t]=s,k(this,Wt)){const r=k(this,Wt)-e[t];for(;k(this,mn)>r;)ie(this,Y,io).call(this,!0)}le(this,mn,k(this,mn)+e[t]),i&&(i.entrySize=s,i.totalCalculatedSize=k(this,mn))})},Gs=new WeakMap,Ei=new WeakMap,Sr=new WeakMap,cs=function*({allowStale:e=this.allowStale}={}){if(k(this,ut))for(let t=k(this,pt);!(!ie(this,Y,yl).call(this,t)||((e||!k(this,Ht).call(this,t))&&(yield t),t===k(this,vt)));)t=k(this,Gt)[t]},ds=function*({allowStale:e=this.allowStale}={}){if(k(this,ut))for(let t=k(this,vt);!(!ie(this,Y,yl).call(this,t)||((e||!k(this,Ht).call(this,t))&&(yield t),t===k(this,pt)));)t=k(this,Rt)[t]},yl=function(e){return e!==void 0&&k(this,lt).get(k(this,Qe)[e])===e},io=function(e){var r,o;const t=k(this,vt),s=k(this,Qe)[t],i=k(this,pe)[t];return k(this,ps)&&ie(this,Y,Ye).call(this,i)?i.__abortController.abort(new Error("evicted")):(k(this,bn)||k(this,Dt))&&(k(this,bn)&&((r=k(this,fn))==null||r.call(this,i,s,"evict")),k(this,Dt)&&((o=k(this,mt))==null||o.push([i,s,"evict"]))),k(this,Gs).call(this,t),e&&(k(this,Qe)[t]=void 0,k(this,pe)[t]=void 0,k(this,gn).push(t)),k(this,ut)===1?(le(this,vt,le(this,pt,0)),k(this,gn).length=0):le(this,vt,k(this,Rt)[t]),k(this,lt).delete(s),Or(this,ut)._--,t},ro=function(e,t,s,i){const r=t===void 0?void 0:k(this,pe)[t];if(ie(this,Y,Ye).call(this,r))return r;const o=new Ro,{signal:a}=s;a==null||a.addEventListener("abort",()=>o.abort(a.reason),{signal:o.signal});const l={signal:o.signal,options:s,context:i},d=(y,C=!1)=>{const{aborted:M}=o.signal,_=s.ignoreFetchAbort&&y!==void 0;if(s.status&&(M&&!C?(s.status.fetchAborted=!0,s.status.fetchError=o.signal.reason,_&&(s.status.fetchAbortIgnored=!0)):s.status.fetchResolved=!0),M&&!_&&!C)return p(o.signal.reason);const R=b;return k(this,pe)[t]===b&&(y===void 0?R.__staleWhileFetching?k(this,pe)[t]=R.__staleWhileFetching:this.delete(e):(s.status&&(s.status.fetchUpdated=!0),this.set(e,y,l.options))),y},u=y=>(s.status&&(s.status.fetchRejected=!0,s.status.fetchError=y),p(y)),p=y=>{const{aborted:C}=o.signal,M=C&&s.allowStaleOnFetchAbort,_=M||s.allowStaleOnFetchRejection,R=_||s.noDeleteOnFetchRejection,N=b;if(k(this,pe)[t]===b&&(!R||N.__staleWhileFetching===void 0?this.delete(e):M||(k(this,pe)[t]=N.__staleWhileFetching)),_)return s.status&&N.__staleWhileFetching!==void 0&&(s.status.returnedStale=!0),N.__staleWhileFetching;if(N.__returned===N)throw y},m=(y,C)=>{var _;const M=(_=k(this,Ti))==null?void 0:_.call(this,e,r,l);M&&M instanceof Promise&&M.then(R=>y(R===void 0?void 0:R),C),o.signal.addEventListener("abort",()=>{(!s.ignoreFetchAbort||s.allowStaleOnFetchAbort)&&(y(void 0),s.allowStaleOnFetchAbort&&(y=R=>d(R,!0)))})};s.status&&(s.status.fetchDispatched=!0);const b=new Promise(m).then(d,u),g=Object.assign(b,{__abortController:o,__staleWhileFetching:r,__returned:void 0});return t===void 0?(this.set(e,g,{...l.options,status:void 0}),t=k(this,lt).get(e)):k(this,pe)[t]=g,g},Ye=function(e){if(!k(this,ps))return!1;const t=e;return!!t&&t instanceof Promise&&t.hasOwnProperty("__staleWhileFetching")&&t.__abortController instanceof Ro},xl=function(e,t){k(this,Gt)[t]=e,k(this,Rt)[e]=t},Zi=function(e){e!==k(this,pt)&&(e===k(this,vt)?le(this,vt,k(this,Rt)[e]):ie(this,Y,xl).call(this,k(this,Gt)[e],k(this,Rt)[e]),ie(this,Y,xl).call(this,k(this,pt),e),le(this,pt,e))};let ml=_c;function mT({conversationId:n,messageId:e}){const[t,s]=S.useState(!1),i=S.useRef({isMediaSourceAvailable:vc(),mediaSourceFormat:Tc()??"n/a",playPromise:null,shouldAbortQueuedPlayback:!1}).current,r=Fe(),{voiceName:o}=Bg(),a=`${n}.${e}.${o}`,l=Lx(),d=zx(g=>{var y;return g.isPlaying&&g.sourceUrl===((y=rn.get(a))==null?void 0:y.src)}),u=S.useCallback(async()=>{if(!l)return;s(!0);const g={isMediaSourceAvailable:i.isMediaSourceAvailable,format:i.mediaSourceFormat};try{const y=await gT({key:a,message_id:e,conversation_id:n,voice:o,onStreamingError:C=>{nr.readAloud.error(C,g),s(!1),on.danger(r.formatMessage(Su.playbackError,{error:C.message}))},onStreamingStart:()=>{s(!1)}});if(i.shouldAbortQueuedPlayback){i.shouldAbortQueuedPlayback=!1;return}l.changeSource(y),i.playPromise=l.play()}catch(y){nr.readAloud.error(y,g),s(!1),on.danger(r.formatMessage(Su.playbackError,{error:y.message}))}},[l,a,e,n,o,i,r]),p=S.useCallback(()=>{const g=Wc();g&&(i.playPromise?i.playPromise.then(()=>{g.stop(),i.playPromise=null}):g.stop())},[i]),m=S.useCallback(()=>{var y;const g=Wc();g&&(g.state.isPlaying&&g.state.sourceUrl===((y=rn.get(a))==null?void 0:y.src)?p():(nr.readAloud.click({isMediaSourceAvailable:i.isMediaSourceAvailable,format:i.mediaSourceFormat}),u()))},[a,i,u,p]);S.useEffect(()=>{t&&d&&s(!1)},[t,d]);const b=S.useRef(a);return S.useEffect(()=>{b.current=a}),S.useEffect(()=>(i.shouldAbortQueuedPlayback=!1,()=>{var C;const g=Ux();g.isPlaying&&g.sourceUrl===((C=rn.get(b.current))==null?void 0:C.src)?p():i.shouldAbortQueuedPlayback=!0}),[i,p]),{togglePlayback:m,isPlaying:d,isLoading:t}}async function cm({message_id:n,conversation_id:e,voice:t}){const s=await Ge.synthesize({message_id:n,conversation_id:e,voice:t,format:Tc()}),i=s.headers.get("content-type")??"audio/aac";return{response:s,format:i}}async function gT(n){return vc()?xT(n):yT(n)}async function yT({key:n,...e}){const t=rn.get(n);if(t!=null&&t.blob)return t.src;const{response:s,format:i}=await cm(e),r=await s.arrayBuffer(),o=new Blob([r],{type:i}),a=dm({key:n,src:URL.createObjectURL(o),format:i,blob:o});return rn.set(n,a),a.src}async function xT({key:n,onStreamingError:e,onStreamingStart:t,...s}){let i=rn.get(n);i!=null&&i.streaming&&(rn.delete(n),i=void 0);let r,o;const a=wT(),l=new a;if(i)r=i,r.src=URL.createObjectURL(l);else{const{format:p,response:m}=await cm(s);o=m,r=dm({key:n,src:URL.createObjectURL(l),format:p})}const d=bT(r.id),u={sourceopen:async()=>{var b,g;d("sourceopen");const p=l.addSourceBuffer(r.format),m=async()=>{p.updating&&await new Promise(y=>p.addEventListener("updateend",y,{once:!0}))};if(r.segments.length&&!r.streaming){d("streaming from cache"),r.streaming=!0,t();for(const y of r.segments)p.appendBuffer(y),await m();l.readyState==="open"&&l.endOfStream(),r.streaming=!1,d("done streaming from cache");return}if(o){d("fetching audio");try{const y=(b=o.body)==null?void 0:b.getReader();if(!y)return;for(;((g=rn.get(n))==null?void 0:g.id)===r.id;){const{done:C,value:M}=await y.read();if(C){d("done streaming"),r.streaming=!1,l.readyState==="open"&&l.endOfStream();break}if(!Array.from(l.sourceBuffers).includes(p)){d("stop streaming, source buffer removed"),r.streaming=!1;break}r.streaming||(d("start streaming"),r.streaming=!0,t()),p.appendBuffer(M),r.segments.push(M),await m()}}catch(y){if(d("error while streaming",y),r.streaming=!1,l.readyState==="open")try{l.endOfStream("network")}catch(C){nr.readAloud.error(C)}rn.delete(n),e(y)}}},sourceclose:()=>{var p;d("sourceclose"),r.streaming&&(r.streaming=!1,((p=rn.get(n))==null?void 0:p.id)===r.id&&(d("sourceclosed while streaming, cleaning up cache"),rn.delete(n)))},sourceended:_t};for(const[p,m]of Object.entries(u))l.addEventListener(p,()=>{try{return m()}catch(b){nr.readAloud.error(b)}});return rn.set(n,r),r.src}const Su=Ke({playbackError:{id:"useVoiceReadAloudAudio.playbackError",defaultMessage:"Failed to play message"}}),bT=n=>_t;function wT(){return vc()?window.MediaSource:null}function vc(){return!!Tc()}function Tc(){if("MediaSource"in window){const n=e=>Vx(e)&&MediaSource.isTypeSupported(e);if(n("audio/aac"))return"aac";if(n("audio/mpeg"))return"mp3";if(n("audio/ogg"))return"ogg"}}const dm=n=>({id:_r(),segments:[],streaming:!1,...n}),rn=new ml({max:50,dispose:n=>{URL.revokeObjectURL(n.src)}}),ST=S.memo(function(e){var o;const t=(o=Jn("1923022511"))==null?void 0:o.value,s=Ir(e.conversationId),{errCode:i}=Wi(e.message);if(!t||!s||i)return null;const r=Kh.getAudioAssetPointers(e.message.message)[0];return r?c.jsx(kT,{audioAssetPointer:r}):c.jsx(CT,{...e,conversationId:s})});function kT({audioAssetPointer:n}){const{isLoading:e,isPlaying:t,togglePlayback:s}=Lg({audioAssetPointer:n});return c.jsx(um,{onClick:s,isPlaying:t,isLoading:e,playText:Ec.replay})}function CT({conversationId:n,message:e}){const{isLoading:t,isPlaying:s,togglePlayback:i}=mT({conversationId:n,messageId:e.message.id});return c.jsx(um,{onClick:i,isPlaying:s,isLoading:t,playText:Ec.play})}function um({onClick:n,isPlaying:e,isLoading:t,playText:s}){let i,r;const o=Fe();return t?i=Gh:e?(i=sb,r=Ec.stop):(i=ib,r=s),c.jsx(Yr,{icon:i,label:r?o.formatMessage(r):void 0,disabled:t,onClick:n,style:e||t?{visibility:"visible"}:void 0})}const Ec={replay:{id:"VoiceReadOutLoudButton.replay",defaultMessage:"Replay",description:"The tooltip for the replay button"},play:{id:"VoiceReadOutLoudButton.play",defaultMessage:"Read Aloud",description:"The tooltip for the read aloud button"},stop:{id:"VoiceReadOutLoudButton.stop",defaultMessage:"Stop",description:"The tooltip for the stop button"}},MT="bg-token-main-surface-primary text-token-text-primary",vT="openai",ku=["bg-blue-300 text-white"];function TT(n){return ku[((n==null?void 0:n.charCodeAt(0))??0)%ku.length]}const qr=({children:n})=>c.jsx("div",{className:"pt-0",children:c.jsx("div",{className:se(S.isValidElement(n)&&n.type===Va?"gizmo-bot-avatar":"gizmo-shadow-stroke","flex h-8 w-8 items-center justify-center overflow-hidden rounded-full"),children:n})});function bl({messages:n,isUserTurn:e,avatarClassName:t,gizmo:s,showInlineEmbeddedDisplay:i=!1}){var b;const r="medium",o=n[0],a=(b=o==null?void 0:o.message.metadata)==null?void 0:b.shared_conversation_id,l=a!=null,d=Bo(),{gizmoEditorData:u,mode:p}=Cr();let m=c.jsx(qr,{children:c.jsx(Va,{className:t??MT,iconName:vT,size:r})});return s?m=c.jsx(qr,{children:c.jsx(Ob,{gizmoId:s.gizmo.id,className:"h-full w-full"})}):u!=null&&p==="test"&&(m=c.jsx(xf,{isFirstParty:!1,src:u.profilePictureUrl,className:"h-8 w-8 first:pt-[3px]"})),c.jsx("div",{children:e?l||i?c.jsx(qr,{children:c.jsx(Va,{className:TT(a),iconName:"user",size:r})}):c.jsx(qr,{children:c.jsx(zg,{user:d,size:r})}):m})}const ET=ze(()=>Oe(()=>import("./dw6i4boivalgxpjk.js"),__vite__mapDeps([72,1,2,3,59,4,5,7,60,61,12,62,6,17,63,8,11,68,69,24,57,70,50,13,14,15,16,58,22,71])).then(n=>n.default)),_T=ze(()=>Oe(()=>import("./sso-dud3eqjhdwr0lbxq.js").then(n=>n.e),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66])).then(n=>n.CanmoreADAMessage).catch(()=>ta)),NT=Xe.div`flex gap-2 flex-wrap mt-1 max-w-[80%] justify-end`,IT=Xe.div`flex flex-col gap-2`,AT=({parts:n,attachments:e,isUserTurn:t,clientThreadId:s})=>{const i=Er(),r=$o(s),o=nc(),a=Kh.getImageAssetPointersFromParts(n),l=new Set(a.map(g=>Lo(g.asset_pointer))),u=kr()||i,p=(e??[]).filter(g=>Zu(g.name)),m=(e??[]).filter(g=>g.id==null||l.has(g.id)?!1:o||r?!p.includes(g):!0);return(o||r?(m.length>0||p.length>0)&&t:m.length>0&&t)?c.jsxs(c.Fragment,{children:[c.jsxs(NT,{children:[m.map(g=>c.jsx(yh,{file:g.name,fileId:g.id,contextConnectorInfo:Ug(g.context_connector_info),width:i?"normal":"wide",alwaysShowData:!0},g.id)),r&&p.map(g=>c.jsx(_T,{clientThreadId:s,visualization:Bc(g)},g.id))]}),o&&!r&&c.jsx(IT,{className:se(!u&&"w-[80%]"),children:p.map(g=>c.jsx(ET,{clientThreadId:s,visualization:Bc(g)},g.id))})]}):null};function hm(n){return Ul(n)&&!Wx(n)}const Hr=50,RT=95;function DT(n,e){if(n<=e)return n/e*Hr;{const t=Hr,s=RT-Hr,i=n-e,o=-(Hr/e)/s;return t+s*(1-Math.exp(o*i))}}class jT{constructor(){re(this,"mostRecentCompletionRequest");re(this,"loggedRequestIds",new Set)}onCompletionRequestStarted(e){this.mostRecentCompletionRequest={requestId:e,timestamp:Date.now()}}onDisplayTextAfterBrowsingSession(e,t){const s=this.mostRecentCompletionRequest;if(s!=null&&!this.loggedRequestIds.has(s.requestId)){const r=O.getThreadConversationTurns(e,t).find(o=>o.messages.some(a=>a.message.id===t));r!=null&&r.messages.some(o=>o.nodeId===s.requestId)&&(ee.logEvent($.browsingTimeToFirstTextToken,{messageId:t,timeMs:Date.now()-s.timestamp}),this.loggedRequestIds.add(s.requestId))}}}const fm=new jT;function OT(n){var i;const e=n.find(r=>{var o;return((o=r.message.metadata)==null?void 0:o.image_search_results)!==void 0});return(((i=e==null?void 0:e.message.metadata)==null?void 0:i.image_search_results)??[]).slice(0,5)}function PT({messages:n}){const e=OT(n),t=Vg();return e.length===0?null:c.jsx("div",{className:se({"mb-2":!0,"grid grid-flow-col gap-3":e.length>1,"w-1/3":e.length===1}),children:e.filter(({contentUrl:s})=>t.has(s)).map((s,i)=>c.jsx("a",{href:s.hostPageUrl,target:"_blank",rel:"noreferrer",children:c.jsx("img",{src:s.contentUrl,alt:s.name,className:"aspect-square rounded-xl object-cover"})},i))})}const FT=ze(()=>Oe(()=>import("./sso-dud3eqjhdwr0lbxq.js").then(n=>n.f),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66])).then(n=>n.default).catch(()=>ta));function pm({attachments:n,citations:e,contentReferences:t,className:s,clientThreadId:i,displayParts:r,id:o,isActivelyStreaming:a,isUserTurn:l,turnIndex:d,isFeedbackEnabled:u,messages:p,onRequestMoreCompletions:m,parts:b,prevGroupedMessageType:g,prevGroupedMessages:y,showEditButton:C,onEnterEdit:M,size:_="medium"}){var G,W,j;const R=$o(i),N=p.length>1,{flagSeverity:E,shouldHideContent:P}=Wi(N?void 0:p[0]),F=!b.some(z=>z!==""),D=((G=Vo("2342431234"))==null?void 0:G.value)!==!0,A=((W=p[0].message.metadata)==null?void 0:W.targeted_reply_label)??((j=p[0].message.metadata)==null?void 0:j.targeted_reply);return S.useEffect(()=>{!F&&g===he.Browsing&&fm.onDisplayTextAfterBrowsingSession(i,p[0].message.id)},[F,p,i,g]),c.jsxs("div",{"data-message-author-role":p[0].message.author.role,"data-message-id":p[0].message.id,dir:"auto",className:se(s,"text-message flex w-full flex-col items-end gap-2 break-words [.text-message+&]:mt-5",!F&&"overflow-x-auto",D?"whitespace-pre-wrap":"whitespace-normal"),children:[A&&c.jsxs("div",{className:"mb-1 mt-1 flex items-start gap-1.5 text-sm font-normal text-token-text-tertiary",children:[c.jsx(Ql,{className:"icon-md mt-1 shrink-0"}),c.jsx("p",{className:"mr-5 line-clamp-3",children:A})]}),l&&R&&c.jsx(FT,{clientThreadId:i,messages:p}),c.jsx(Wg,{messages:p}),c.jsx(BT,{parts:b,attachments:n,isUserTurn:l,turnIndex:d,displayParts:r,isActivelyStreaming:a,shouldHideContent:P,showEditButton:C,onEnterEdit:M,clientThreadId:i,id:o,isEmpty:F,prevGroupedMessageType:g,prevGroupedMessages:y,flagSeverity:E,messages:p,citations:e,contentReferences:t,size:_}),c.jsx(cT,{message:N?void 0:p[0],id:o,isFeedbackEnabled:u,onRequestMoreCompletions:m,clientThreadId:i,isUserTurn:l}),c.jsx(Gg,{isUserTurn:l,message:N?void 0:p[0]}),!l&&!a&&y&&g===he.SearchResult&&c.jsx(PT,{messages:y})]})}function BT({clientThreadId:n,id:e,displayParts:t,turnIndex:s,isActivelyStreaming:i,shouldHideContent:r,showEditButton:o=!1,onEnterEdit:a,isEmpty:l,prevGroupedMessageType:d,prevGroupedMessages:u,messages:p,citations:m,contentReferences:b,size:g,isUserTurn:y,parts:C,attachments:M}){var j;const _=Fe(),R=qg(t),N=Ch(),E=(j=p[0].message.metadata)==null?void 0:j.gizmo_id,P=Hg(p[0].message),F=!!E&&N.includes(E),D=c.jsx(AT,{parts:C,attachments:M,isUserTurn:y,clientThreadId:n},"files-and-tables"),A=!!(M!=null&&M.length||t.some(z=>z.type==="images")),G=t.map((z,H)=>{var K;if(z.type==="transcription"){const J=r?null:z.text;let de=null;return y&&r?de=c.jsx("span",{className:"italic opacity-30",children:c.jsx(U,{...$r.contentRemoved})}):y&&J!=null?de=J.trim().length===0?c.jsx("span",{className:"italic opacity-30",children:c.jsx(Br,{text:_.formatMessage($r.transcriptUnavailable)})}):c.jsx("span",{className:"italic opacity-65",children:c.jsx(Br,{text:`${J.trim()}`})}):!y&&J!=null&&(de=c.jsx(Br,{text:J})),c.jsx(aa,{containsImagesOrAttachments:A,isUserTurn:y,showEditButton:o,onEnterEdit:a,children:de},H)}else if(z.type==="text"){const J=r?null:z.text;if(!l&&!r&&!y){const de=d===he.CodeInterpreter?u==null?void 0:u.map(ne=>ne.message):void 0,{text:V,contentReferences:B}=$g(R,m,b,F),{processedText:we,displayedContentReferences:te}=Kg(V,B,i?void 0:de);return c.jsx(Jg.Provider,{value:{clientThreadId:n,message:p[0].message,contentReferences:te,isActivelyStreaming:i,turnIndex:s,useSafeUrls:!0},children:c.jsx(Mh,{clientThreadId:n,messageId:e,size:g,className:se(i&&"result-streaming",P&&"headers-v2"),children:we===""?"&#8203;":we})},H)}else if(l&&i&&!y)return c.jsx("div",{className:"result-streaming",children:c.jsx("div",{children:c.jsx("pre",{})})},H);return c.jsx(aa,{containsImagesOrAttachments:A,isUserTurn:y,showEditButton:o,onEnterEdit:a,children:y&&r?c.jsx("span",{className:"italic opacity-30",children:c.jsx(U,{...$r.contentRemoved})}):J?c.jsx(Br,{text:J}):null},H)}else if(z.type==="images"){const J=((K=p[0].message.metadata)==null?void 0:K.attachments)??[];return c.jsx(Yg,{assets:z.imageAssets,attachments:J},H)}else return null}),W=t.findIndex(z=>z.type==="text");if(W!==-1?G.splice(W,0,D):G.push(D),r&&y)G.length=0,G.push(c.jsx(aa,{containsImagesOrAttachments:A,isUserTurn:y,onEnterEdit:_t,children:c.jsx("span",{className:"italic opacity-30",children:c.jsx(U,{...$r.contentRemoved})})}));else if(r&&!y)return null;return c.jsx("div",{className:se("flex w-full flex-col gap-1 empty:hidden",y&&"items-end rtl:items-start",!y&&"first:pt-[3px]"),children:G})}const $r=Ke({contentRemoved:{id:"textMessage.contentRemoved",defaultMessage:"Content removed"},transcriptUnavailable:{id:"textMessage.transcriptUnavailable",defaultMessage:"Transcript Unavailable"}});function LT(n){var d;const{isActivelyStreaming:e,...t}=n,s=Li(),i=(s==null?void 0:s.includes("debug"))??!1,r=n.messages[n.messages.length-1].message.id,[o,a]=S.useState([]),l=S.useRef();return l.current===void 0&&(l.current=(s==null?void 0:s.includes(Gx))??!1?new Qg(n.parts,a,e,void 0,{debug:i}):new Xg(n.parts,a,e)),S.useEffect(()=>{l.current!=null&&(l.current.onMessagePartsUpdated(n.parts,e),l.current.isBuffering()&&tr.addDelayedRenderingMessage(r))},[n.parts,r,e]),S.useEffect(()=>{l.current!=null&&!l.current.isBuffering()&&tr.removeDelayedRenderingMessage(r)},[o,r]),S.useEffect(()=>()=>tr.removeDelayedRenderingMessage(r),[r]),S.useEffect(()=>()=>{l.current!=null&&(l.current.destroy(),l.current=void 0)},[]),c.jsx(pm,{...t,displayParts:o,isActivelyStreaming:e||((d=l.current)==null?void 0:d.isBuffering())})}function zT({message:n,isCompletionInProgress:e,clientThreadId:t,className:s,isUserTurn:i,turnIndex:r,isFeedbackEnabled:o,prevGroupedMessageType:a,prevGroupedMessages:l,showEditButton:d,onEnterEdit:u,onRequestMoreCompletions:p}){var b,g,y;const m=S.useMemo(()=>"parts"in n.message.content?n.message.content.parts:[qo(n.message)],[n]);return c.jsx(VT,{parts:m,messages:[n],isCompletionInProgress:e,className:s,citations:(b=n.message.metadata)==null?void 0:b.citations,contentReferences:(g=n.message.metadata)==null?void 0:g.content_references,attachments:(y=n.message.metadata)==null?void 0:y.attachments,isUserTurn:i,turnIndex:r,id:n.nodeId,isFeedbackEnabled:o,onRequestMoreCompletions:p,clientThreadId:t,showEditButton:d,onEnterEdit:u,prevGroupedMessageType:a,prevGroupedMessages:l})}const UT=Hl.memo(zT);function VT(n){const e=n.messages.length>1,{flagSeverity:t}=Wi(e?void 0:n.messages[0]),s=t!=="danger"&&n.isCompletionInProgress,i=!n.parts.some(o=>o!==""),[r]=S.useState(()=>!n.isUserTurn&&(n.isCompletionInProgress||i));return r?c.jsx(LT,{...n,isActivelyStreaming:s}):c.jsx(pm,{...n,displayParts:Zg({isUserTurn:n.isUserTurn,parts:n.parts}),isActivelyStreaming:s})}const WT=ze(()=>Oe(()=>import("./k9ac8ekc7w2zazoh.js"),__vite__mapDeps([73,1,2,3])));function mm({animationData:n,animationSegmentToPlay:e,animationLoopCounter:t}){const s=S.useRef(null);return S.useEffect(()=>{var i;(i=s.current)==null||i.playSegments(e,!0)},[t]),c.jsx(WT,{animationData:n,lottieRef:s,loop:!1,autoplay:!1})}function GT(n){return c.jsx(Ol,{width:"8",height:"9",viewBox:"0 0 8 9",fill:"none",...n,children:c.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M7.66607 0.376042C8.01072 0.605806 8.10385 1.07146 7.87408 1.4161L3.54075 7.9161C3.40573 8.11863 3.18083 8.24304 2.93752 8.24979C2.69421 8.25654 2.46275 8.1448 2.31671 7.95008L0.150044 5.06119C-0.098484 4.72982 -0.0313267 4.25972 0.300044 4.01119C0.631415 3.76266 1.10152 3.82982 1.35004 4.16119L2.88068 6.20204L6.62601 0.584055C6.85577 0.239408 7.32142 0.146278 7.66607 0.376042Z",fill:"currentColor"})})}function qT(n){return c.jsxs(Ol,{width:"4",height:"12",viewBox:"0 0 4 12",fill:"none",...n,children:[c.jsx("mask",{id:"path-1-inside-1_1975_4008",fill:"currentColor",children:c.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M1 6.5C1 7.05228 1.44772 7.5 2 7.5C2.55228 7.5 3 7.05228 3 6.5V1.5C3 0.947715 2.55228 0.5 2 0.5C1.44772 0.5 1 0.947715 1 1.5L1 6.5ZM0.75 10.25C0.75 10.9404 1.30964 11.5 2 11.5C2.69036 11.5 3.25 10.9404 3.25 10.25C3.25 9.55964 2.69036 9 2 9C1.30964 9 0.75 9.55964 0.75 10.25Z"})}),c.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M1 6.5C1 7.05228 1.44772 7.5 2 7.5C2.55228 7.5 3 7.05228 3 6.5V1.5C3 0.947715 2.55228 0.5 2 0.5C1.44772 0.5 1 0.947715 1 1.5L1 6.5ZM0.75 10.25C0.75 10.9404 1.30964 11.5 2 11.5C2.69036 11.5 3.25 10.9404 3.25 10.25C3.25 9.55964 2.69036 9 2 9C1.30964 9 0.75 9.55964 0.75 10.25Z",fill:"currentColor"}),c.jsx("path",{d:"M1 6.5H-0.25H1ZM1 1.5L-0.25 1.5L-0.25 1.5L1 1.5ZM2 6.25C2.13807 6.25 2.25 6.36193 2.25 6.5H-0.25C-0.25 7.74264 0.757359 8.75 2 8.75V6.25ZM1.75 6.5C1.75 6.36193 1.86193 6.25 2 6.25V8.75C3.24264 8.75 4.25 7.74264 4.25 6.5H1.75ZM1.75 1.5V6.5H4.25V1.5H1.75ZM2 1.75C1.86193 1.75 1.75 1.63807 1.75 1.5H4.25C4.25 0.257359 3.24264 -0.75 2 -0.75V1.75ZM2.25 1.5C2.25 1.63807 2.13807 1.75 2 1.75V-0.75C0.757359 -0.75 -0.25 0.257359 -0.25 1.5L2.25 1.5ZM2.25 6.5L2.25 1.5L-0.25 1.5L-0.25 6.5L2.25 6.5ZM2 10.25H-0.5C-0.5 11.6307 0.619288 12.75 2 12.75V10.25ZM2 10.25V12.75C3.38071 12.75 4.5 11.6307 4.5 10.25H2ZM2 10.25H2H4.5C4.5 8.86929 3.38071 7.75 2 7.75V10.25ZM2 10.25H2V7.75C0.619288 7.75 -0.5 8.86929 -0.5 10.25H2Z",fill:"currentColor",mask:"url(#path-1-inside-1_1975_4008)"})]})}function HT(n){return c.jsx(Ol,{width:"8",height:"9",viewBox:"0 0 8 9",fill:"none",...n,children:c.jsx("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M7.32256 1.48447C7.59011 1.16827 7.55068 0.695034 7.23447 0.427476C6.91827 0.159918 6.44503 0.199354 6.17748 0.515559L4.00002 3.08892L1.82256 0.515559C1.555 0.199354 1.08176 0.159918 0.765559 0.427476C0.449355 0.695034 0.409918 1.16827 0.677476 1.48447L3.01755 4.25002L0.677476 7.01556C0.409918 7.33176 0.449354 7.805 0.765559 8.07256C1.08176 8.34011 1.555 8.30068 1.82256 7.98447L4.00002 5.41111L6.17748 7.98447C6.44503 8.30068 6.91827 8.34011 7.23447 8.07256C7.55068 7.805 7.59011 7.33176 7.32256 7.01556L4.98248 4.25002L7.32256 1.48447Z",fill:"currentColor"})})}function M_({animationLoopCounter:n}){const{resolvedTheme:e}=Jh(),t=e==="dark";return c.jsx(mm,{animationData:t?ey:ty,animationSegmentToPlay:[0,300],animationLoopCounter:n})}function v_({animationLoopCounter:n}){const{resolvedTheme:e}=Jh(),t=e==="dark";return c.jsx(mm,{animationData:t?ny:sy,animationSegmentToPlay:[0,400],animationLoopCounter:n})}const $T=2e3,gm=.4,KT=.45,JT=.2,YT=.1,QT=.25;var kn=(n=>(n[n.Running=0]="Running",n[n.Finished=1]="Finished",n[n.Error=2]="Error",n[n.Stopped=3]="Stopped",n[n.Paused=4]="Paused",n))(kn||{});function T_({conversationMessages:n,icon:e,status:t,text:s,estimatedToolDurationMs:i,animationLoopDurationMs:r=$T,shouldPersistAfterFinished:o=!1}){const[a,l]=S.useState(t===0?0:t===1&&!o?7:1),[d,u]=S.useState(0);S.useEffect(()=>{t===2?l(8):t===3?l(9):t===4?l(10):t===1?l(a===2?3:7):t===0&&a===10&&(l(2),u(m=>m+1))},[t]);const p=e1(a);return S.useEffect(()=>{const m=n[0].message.id;if(p)return tr.addDelayedRenderingMessage(m),()=>{tr.removeDelayedRenderingMessage(m)}},[p]),vh(()=>{Mi(a)&&u(m=>m+1)},r),a===7&&!o?null:c.jsxs("div",{className:"my-2.5 flex items-center gap-2.5",children:[c.jsx(XT,{icon:e,status:t,uiState:a,estimatedToolDurationMs:i,animationLoopCounter:d,shouldPersistAfterFinished:o,onFillProgressBarAnimationComplete:()=>l(4),onFinishAnimationComplete:()=>{l(5),setTimeout(()=>{l(o?7:6)},YT*1e3)},onHideAnimationComplete:()=>l(7)}),c.jsx(ZT,{text:s,uiState:a,animationLoopCounter:d,onEnterAnimationComplete:()=>l(2)})]})}const Cu=50;function XT({icon:n,status:e,uiState:t,estimatedToolDurationMs:s,animationLoopCounter:i,shouldPersistAfterFinished:r,onFillProgressBarAnimationComplete:o,onFinishAnimationComplete:a,onHideAnimationComplete:l}){const[d,u]=S.useState(0);vh(()=>{Mi(t)?u(_=>_+Cu):t===10&&u(0)},Cu);let p,m,b;Mi(t)||t===10?(p="running",m=c.jsx(n,{animationLoopCounter:i}),b="bg-transparent"):t===4||t===5||t===7&&r?(p="finished",m=c.jsx(GT,{}),b="bg-brand-purple"):e===2?(p="error",m=c.jsx(qT,{}),b="bg-orange-500"):e===3&&(p="stopped",m=c.jsx(HT,{}),b="bg-gray-300");let g={opacity:0,scale:0,rotate:-180,x:0},y={type:"spring",bounce:.3,duration:KT},C={opacity:0,scale:.6,rotate:0,x:0};t===0?(g={opacity:0,scale:.5,rotate:-180,x:-8},y={type:"spring",bounce:.3,duration:gm}):t===1?g=!1:t===5&&(C={opacity:0,scale:0,rotate:0,x:0},y={type:"spring",bounce:.3,duration:QT});const M=DT(d,s);return c.jsx("div",{className:"relative h-5 w-5 shrink-0",children:c.jsx(Ys,{onExitComplete:()=>{t===6&&l()},children:p!=null&&c.jsxs(ft.div,{className:se("absolute left-0 top-0 flex h-full w-full items-center justify-center rounded-full text-white",b),initial:g,animate:{opacity:1,scale:1,rotate:0,x:0},exit:C,transition:y,onAnimationComplete:()=>{t===4&&a()},children:[m,(Mi(t)||t===10)&&c.jsx(iy,{percentage:t===3?100:M,thickness:1.5/23,className:"absolute left-1/2 top-1/2 h-[23px] w-[23px] -translate-x-1/2 -translate-y-1/2 text-brand-purple",backgroundStrokeClassName:"stroke-brand-purple/25 dark:stroke-brand-purple/50",transitionDuration:t===3?`${(100-M)/100*JT}s`:void 0,transitionTimingFunction:t===3?"cubic-bezier(0.55, 0, 1, 1)":void 0,onTransitionEnd:()=>{t===3&&o()}})]},p)})})}function ZT({text:n,uiState:e,animationLoopCounter:t,onEnterAnimationComplete:s}){const[i,r]=S.useState(n);S.useEffect(()=>{e===2&&r(n)},[t]),S.useEffect(()=>{Mi(e)||r(n)},[e,n]);let o={opacity:0,x:0,y:15},a={type:"spring",bounce:.3,opacity:{duration:.15},y:{duration:.3}};e===0?(o={opacity:0,x:-8,y:0},a={type:"spring",bounce:.3,duration:gm,delay:.15}):e===1&&(o=!1);const l=i??void 0;return c.jsx("div",{className:se("relative h-5 w-full leading-5",e===8||e===9?"text-token-text-tertiary":"text-token-text-secondary"),children:c.jsx(Ys,{children:l!=null&&c.jsx(ft.div,{className:"absolute left-0 top-0 line-clamp-1 overflow-visible",initial:o,animate:{opacity:1,x:0,y:0},exit:{opacity:0,x:0,y:-15},transition:a,onAnimationComplete:()=>{e===0&&s()},children:l},l.toString())})})}function Mi(n){return n===0||n===2||n===3}function e1(n){return Mi(n)||n===4||n===5||n===6||n===10}function ym({highlightedCommand:n,status:e,children:t,showWorkUserSetting:s=!1,hideOnlyIfNotInteractedWith:i=!1}){const r=t!=null,[o]=S.useState(s),[a,l]=S.useState(s),[d,u]=S.useState(!1);return(e===kn.Finished||e===kn.Error)&&(i?o?!1:!d:!1)?null:r?c.jsxs(c.Fragment,{children:[c.jsx(Mu,{$canShowWork:!0,children:c.jsx(Ys,{children:c.jsx(ft.button,{onClick:()=>{l(b=>!b),u(!0)},initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},className:se(e===kn.Running&&"loading-shimmer","group absolute left-0 top-0 mr-1.5 h-8 overflow-hidden"),children:c.jsxs("div",{className:"flex items-center justify-start gap-1",children:[c.jsx("span",{children:n}),a?c.jsx(rb,{className:"icon-md group-hover:visible md:invisible"}):c.jsx(Ho,{className:"icon-md group-hover:visible md:invisible"})]})},n==null?void 0:n.toString())})}),c.jsx(Ys,{children:a&&t&&c.jsx(ft.div,{initial:"collapsed",animate:"reveal",exit:"collapsed",variants:{collapsed:{translateY:-20,opacity:0,height:0},reveal:{translateY:0,opacity:1,height:"auto"}},transition:{duration:.3,ease:"easeInOut"},className:"overflow-hidden",children:t})})]}):c.jsx(Mu,{$canShowWork:!1,children:n})}const Mu=Xe.p`first:mt-0 my-1.5 relative h-8
${({$canShowWork:n})=>n?"text-token-text-secondary hover:text-token-text-primary":"text-token-text-secondary"}`,t1=ze(()=>Oe(()=>import("./sso-dud3eqjhdwr0lbxq.js").then(n=>n.e),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66])).then(n=>n.CanmoreADAMessage).catch(()=>ta)),vu=ze(()=>Oe(()=>import("./dw6i4boivalgxpjk.js"),__vite__mapDeps([72,1,2,3,59,4,5,7,60,61,12,62,6,17,63,8,11,68,69,24,57,70,50,13,14,15,16,58,22,71])).then(n=>n.default));function n1({messages:n,isRequestActive:e,clientThreadId:t}){var C,M,_;const[s,i]=n,r=hm(s.message),o=(C=i==null?void 0:i.message.metadata)==null?void 0:C.aggregate_result,a=qw(),l=nc(),d=$o(t),u=i!=null&&i.message?Sf(i.message):[],p=((_=(M=i==null?void 0:i.message.metadata)==null?void 0:M.aggregate_result)==null?void 0:_.messages.filter(tc))??[],b=(u.filter(R=>R.type==="chart")??[]).length!==p.length,g=l&&!b;let y=kn.Running;return(o==null?void 0:o.status)==="success"?y=kn.Finished:i!=null&&i.message.content.content_type!==cn.ExecutionOutput||o!=null&&o.status!=="running"?y=kn.Error:(r||!e)&&(y=kn.Stopped),c.jsxs(c.Fragment,{children:[c.jsx(s1,{messages:n,status:y,isRequestActive:e}),g&&u.map((R,N)=>{const{file_id:E,type:P}=R;return d?c.jsx(t1,{clientThreadId:t,isGenerating:y===kn.Running,visualization:R},E):P==="chart"&&!a?(R.fallback_to_image=!0,c.jsx(Tu,{children:c.jsx(vu,{clientThreadId:t,visualization:R})},N)):c.jsx(Tu,{children:c.jsx(vu,{clientThreadId:t,visualization:R})},N)}),!g&&i!=null&&c.jsx(Ab,{message:i.message})]})}const Tu=Xe.div`mb-3 max-w-[80%]`;function s1({messages:n,status:e,isRequestActive:t}){var p;const[s,i]=n,r=Fe(),o=(p=i==null?void 0:i.message.metadata)==null?void 0:p.aggregate_result,a=hm(s.message),{data:l,error:d}=qx(Hx.ShowExpandedCodeView);let u=r.formatMessage({id:"message.tools.data-analysis.running",defaultMessage:"Analyzing"});if((o==null?void 0:o.status)==="success"?u=r.formatMessage({id:"message.tools.data-analysis.finished",defaultMessage:"Analyzed"}):i!=null&&i.message.content.content_type!==cn.ExecutionOutput||o!=null&&o.status!=="running"?u=r.formatMessage({id:"message.tools.data-analysis.error",defaultMessage:"Analysis errored"}):(a||!t)&&(u=r.formatMessage({id:"message.tools.data-analysis.stopped",defaultMessage:"Analysis paused"})),l!==void 0||d){const m=Rb(s.message)!=null;return c.jsx(ym,{status:e,highlightedCommand:u,showWorkUserSetting:l??!1,hideOnlyIfNotInteractedWith:!0,children:m?c.jsxs("div",{className:"mb-3 mt-0.5 overflow-hidden rounded-xl bg-black",children:[c.jsx(Db,{message:s.message,FormattedText:Mh}),i!=null&&c.jsx(jb,{message:i.message})]}):null})}return null}function i1({nextMessage:n,isLastMessage:e,isRequestActive:t}){if(e||(n==null?void 0:n.message.content.content_type)===cn.Text&&!(n!=null&&n.message.content.parts.some(i=>i.length>0))){const i=t?c.jsx(U,{id:"O+zD9o",defaultMessage:"Searching..."}):c.jsx(U,{id:"fssXGM",defaultMessage:"Error while searching"});return c.jsx(ym,{highlightedCommand:i,status:t?kn.Running:kn.Error,children:i})}return null}const r1=ze(()=>Oe(()=>import("./sso-dud3eqjhdwr0lbxq.js").then(n=>n.e),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66])).then(n=>n.CanmoreCanvasMessage).catch(()=>ta)),o1=ze(()=>Oe(()=>import("./o4j2mpljbxy1weg5.js"),__vite__mapDeps([74,1,2,3,4,5,8,6,7,11,68,69,24,57,12,70,50,13,14,15,16,17,63,58,22,71]))),a1=ze(()=>Oe(()=>import("./hkjj1ibmvoo343qq.js"),__vite__mapDeps([75,1,2,3]))),l1=ze(()=>Oe(()=>import("./ku9yiem9ldo3gk9i.js"),__vite__mapDeps([76,1,2,3,4,5,8,6,7,11,68,69,24,57,12,70,50,13,14,15,16,17,63,58,22,71]))),c1=ze(()=>Oe(()=>import("./igjw8hgs072zy6lh.js"),__vite__mapDeps([77,1,2,3,4,5,6,7])).then(n=>n.TextMessageEditor)),d1=ze(()=>Oe(()=>import("./i7u6ch1xxy4kc0si.js"),__vite__mapDeps([78,1,2,3,4,5,7,6,8,11,68,69,24,57,12,70,50,13,14,15,16,17,63,58,22,71]))),u1=ze(()=>Oe(()=>import("./i48vclyb1hf86efc.js"),__vite__mapDeps([79,1,2,3,4,5,8,6,7,11,68,69,24,57,12,70,50,13,14,15,16,17,63,58,22,71]))),h1=ze(()=>Oe(()=>import("./gopiwaseyqpuxy69.js"),__vite__mapDeps([80,1,2,3,4,5,43,11,8,6,7,45,68,69,24,57,12,70,50,13,14,15,16,17,63,58,22,71])).then(n=>n.BrowsingMessage)),f1=ze(()=>Oe(()=>import("./kxujte5n2etw64qp.js"),__vite__mapDeps([81,1,2,3,43,4,5,8,6,7,11,68,69,24,57,12,70,50,13,14,15,16,17,63,58,22,71])).then(n=>n.SearchResultMessage)),p1=ze(()=>Oe(()=>import("./kagl43t4s7klopz3.js"),__vite__mapDeps([82,1,2,3,11,4,5,8,6,7,50,24])).then(n=>n.GizmoContactsMessage)),m1=ze(()=>Oe(()=>import("./gmt682ybu48z7sis.js"),__vite__mapDeps([83,1,2,3,4,5,11,8,6,7,68,69,24,57,12,70,50,13,14,15,16,17,63,58,22,71])).then(n=>n.JITPluginMessage));function g1(n){switch(n.type){case he.Text:case he.Debug:return[n.message];case he.MultiText:case he.Browsing:case he.CodeInterpreter:case he.JITPlugin:case he.RetrievalBrowsing:case he.ParallelBrowsing:case he.Dalle:case he.GizmoEditor:case he.SearchResult:case he.GizmoContacts:case he.a8km123:case he.Canmore:case he.SearchGPTQuery:return n.messages;default:throw new Error("Bad")}}function wl({groupedMessagesToRender:n,allGroupedMessages:e,clientThreadId:t,isEditing:s,isUserTurn:i,isCompletionRequestInProgress:r,isFeedbackEnabled:o,isFinalTurn:a,turnIndex:l,hasActiveRequest:d,showEditButton:u=!1,handleEnterEdit:p,handleExitEdit:m,onChangeItemInView:b,onRequestMoreCompletions:g,onRequestCompletion:y,shouldGrowContainer:C=!0}){const{showDebugConversationTurns:M}=ni(),_=vs(t),R=n.map((N,E)=>{var F,D,A,G,W,j,z,H,K,J,de,V;const P=E===e.length-1;switch(N.type){case he.Text:case he.MultiText:{const B=n[E-1],we=B==null?void 0:B.type,te=B&&"messages"in B?B.messages:void 0;if(N.type===he.Text){const ne=s?c.jsx(c1,{message:N.message,clientThreadId:t,onChangeItemInView:b,onRequestCompletion:y,onRequestMoreCompletions:g,onExitEdit:m,disabled:d}):c.jsx(UT,{className:"min-h-[20px]",message:N.message,isFeedbackEnabled:o,isCompletionInProgress:P&&r,turnIndex:l,clientThreadId:t,showEditButton:u,onEnterEdit:p,isUserTurn:i,onRequestMoreCompletions:g,prevGroupedMessageType:we,prevGroupedMessages:te});return c.jsxs(S.Fragment,{children:[ne,c.jsx(oy,{isUserTurn:i,message:N.message.message})]},"group-"+N.message.nodeId)}else return N.type===he.MultiText?c.jsx(l1,{clientThreadId:t,messages:N.messages,isCompletionInProgress:P&&r,isFeedbackEnabled:o,onRequestMoreCompletions:g,prevGroupedMessageType:we,prevGroupedMessages:te},"multitext-"+(((F=N.messages[0])==null?void 0:F.nodeId)??E)):N.type}case he.Browsing:case he.RetrievalBrowsing:{const B=_!=null&&[it.GizmoInteraction,it.GizmoMagicCreate,it.GizmoTest].includes(_.kind);return c.jsx(h1,{messages:N.messages,isRequestActive:d,isLastMessageInTurn:P,isUsingGizmo:B,isRetrieval:N.type===he.RetrievalBrowsing},"browsing-"+(((D=N.messages[0])==null?void 0:D.nodeId)??E))}case he.SearchGPTQuery:{const B=e[E+1];return c.jsx(i1,{isRequestActive:d,isLastMessage:P,nextMessage:B&&B.type===he.Text?B.message:void 0},"searchquery-"+(((A=N.messages[0])==null?void 0:A.nodeId)??E))}case he.a8km123:return c.jsx(ry,{messages:N.messages,isStreaming:P&&r},"sum-"+(((G=N.messages[0])==null?void 0:G.nodeId)??E));case he.ParallelBrowsing:return c.jsx(u1,{messages:N.messages},"parallel-"+(((W=N.messages[0])==null?void 0:W.nodeId)??E));case he.CodeInterpreter:return c.jsx(n1,{messages:N.messages,isRequestActive:d,clientThreadId:t},"ada-"+(((j=N.messages[0])==null?void 0:j.nodeId)??E));case he.JITPlugin:return c.jsx(m1,{messages:N.messages,clientThreadId:t,isLastTurnInConversation:a,onRequestCompletion:y},"jit-"+(((z=N.messages[0])==null?void 0:z.nodeId)??E));case he.GizmoContacts:return c.jsx(p1,{messages:N.messages,clientThreadId:t,isLastTurnInConversation:a,onRequestCompletion:y},"gizmo-contacts-"+(((H=N.messages[0])==null?void 0:H.nodeId)??E));case he.Dalle:return c.jsx(d1,{messages:N.messages,clientThreadId:t},"dalle-"+(((K=N.messages[0])==null?void 0:K.nodeId)??E));case he.GizmoEditor:return c.jsx(o1,{messages:N.messages},"gizmo-editor-"+(((J=N.messages[0])==null?void 0:J.nodeId)??E));case he.Canmore:return c.jsx(r1,{messages:N.messages,isRequestActive:d,clientThreadId:t},"canmore-"+(((de=N.messages[0])==null?void 0:de.nodeId)??E));case he.Debug:return M?c.jsx(a1,{message:N.message},"debug-"+N.message.nodeId):null;case he.SearchResult:return c.jsx(f1,{messages:N.messages},"search-result-"+(((V=N.messages[0])==null?void 0:V.nodeId)??E))}});return c.jsx(x1,{shouldGrowContainer:C,children:R})}function y1(){return c.jsx(ay,{type:"danger",children:c.jsx(U,{id:"daIg0P",defaultMessage:"Unable to display this message due to a error."})})}function x1({children:n,shouldGrowContainer:e}){return c.jsx("div",{className:se({"flex max-w-full flex-col":!0,"flex-grow":e}),children:c.jsx(Hh,{name:"GroupedMessages",fallback:y1,children:n})})}function Sl({messages:n,isMemoryEnabled:e,isMemoryFull:t,gizmoId:s,isParagen:i}){const[r,o]=S.useState(!1),[a,l]=S.useState(!1),{eligible:d,isLoading:u}=ly(),p=e&&!t,m=n.filter((y,C)=>{const M=n[C+1],R=(M==null?void 0:M.message.recipient)==="assistant"&&(M==null?void 0:M.message.author.role)===Ve.Tool&&(M==null?void 0:M.message.author.name)==="bio"&&qo(M.message)==="Model set context updated."||!M&&p;return y.message.author.role===Ve.Assistant&&y.message.recipient==="bio"&&R}).flatMap(y=>{const C=y.message.content.content_type;return C===cn.Text?y.message.content.parts:C===cn.Code?[y.message.content.text]:[]}).map(b1),b=S.useMemo(()=>m.length>0,[m]);if(S.useEffect(()=>{b&&d&&!u&&Ii.openModal(lr.GlobalMemoryOnboarding)},[b,d,u]),m.length===0)return null;const g=y=>{const C=y??!a;l(C),C&&ee.logEvent($.memoryUpdatePopoverShown,{updateCount:m.length})};return c.jsxs(c.Fragment,{children:[c.jsx("div",{className:"inline-block",onMouseEnter:()=>g(!0),onMouseLeave:()=>g(!1),children:c.jsxs(cy,{open:a,sideOffset:4,side:"bottom",alignAgainstAnchor:"start",size:"none",className:"z-10 min-w-60 max-w-96 text-sm",onOpenChange:y=>g(y),disableAutofocus:!0,triggerButton:c.jsxs("button",{className:se("my-1 flex items-center gap-1 text-sm font-semibold outline-none",a?"text-token-text-secondary":"text-token-text-tertiary"),children:[c.jsx(ob,{className:"mb-[-1px]"}),m.length===1?c.jsx(U,{id:"MemoryActionResult.memoryWriteSingular.1",defaultMessage:"Memory updated"}):c.jsx(U,{id:"MemoryActionResult.memoryWritePlural.1",defaultMessage:"Memories updated"})]}),children:[c.jsx("div",{className:"mb-2 rounded border border-token-border-light bg-token-main-surface-secondary",children:m.map((y,C)=>c.jsx("div",{className:"border-b border-token-border-light px-3 py-2 first-letter:uppercase last:border-b-0",children:y},C))}),i?c.jsx("div",{className:"text-xs text-token-text-tertiary",children:c.jsx(U,{id:"MemoryActionResult.paragenMessage",defaultMessage:"This memory will be saved if you choose this response."})}):c.jsxs("button",{className:"flex w-full items-center justify-between rounded px-3 py-2 font-semibold hover:bg-token-main-surface-secondary",onClick:()=>{o(!0),ee.logEvent($.memoryUpdatePopoverManageButtonClicked,{updateCount:m.length})},children:[c.jsx(U,{id:"MemoryActionResult.manageMemories",defaultMessage:"Manage memories"}),c.jsx(ab,{className:"icon-md -mr-1 text-token-text-tertiary"})]})]})}),r&&c.jsx(Pb,{initialGizmoId:s,onClose:()=>o(!1)})]})}function b1(n){const e=["The user ","The user's ","User ","User's "];for(const t of e)if(n.startsWith(t))return n.slice(t.length);return n}function Eu(n,e,t){O.updateTree(n,s=>{s.updateNodeMetadata(e,{inlineComparisonRating:t})})}const _u=({messages:n})=>{for(const{message:{metadata:e}}of n){const{augmented_paragen_prompt_label:t}=e??{};if(t)return t}};function w1(n){const e=v1(),t=S.useRef({left_visibility_initial:null,left_visibility_max:null,right_visibility_initial:null,right_visibility_max:null});return n.stubSideBySideFeedback?c.jsx(xm,{shouldEnableUnifiedDesign:e,setPreferredFeedback:()=>{},leftVariantId:"left-placeholder",rightVariantId:"right-placeholder",leftTurn:null,rightTurn:null,originalTurn:null,hasActiveRequest:!0,visibilityStateRef:t,...n}):c.jsx(S1,{...n,shouldEnableUnifiedDesign:e,visibilityStateRef:t})}function S1({shouldEnableUnifiedDesign:n,...e}){const{clientThreadId:t,variantIds:s,variantsInStreamInfo:i}=e;if(s.length!==2)throw new Error("ConversationTurnSideBySideFeedback requires exactly two variant IDs");const[r]=S.useState(()=>Date.now()),o=Dl(),[a,l]=S.useMemo(()=>Th(s.join(""))()<.5?[0,1]:[1,0],[s[0],s[1]]),d=a<l?"left":"right",u=d==="left"?"right":"left",p=s[a],m=s[l],b=Jc(t,p),g=Jc(t,m),y=$i(Yc(t,$i(b).id)),C=$i(Yc(t,$i(g).id)),M=d==="left"?y:C,_=d==="left"?C:y,R=i.display_treatment==="unskippable",N=R?"unskippable_parallel_2_in_stream:a:1.0":n?"skippable_parallel_2_in_stream:a:1.5":"skippable_parallel_2_in_stream:a:1.0";S.useEffect(()=>(Ni.setState({displayingSideBySideFeedback:!0,unskippable:R}),()=>{Ni.setState({displayingSideBySideFeedback:!1,unskippable:!1})}),[R]),dy();const E=S.useRef({left_visibility_initial:null,left_visibility_max:null,right_visibility_initial:null,right_visibility_max:null});S.useEffect(()=>$x(Eh,{requestCompletion:()=>{var A,G,W,j;const F=(A=Ki(M.messages))==null?void 0:A.completionSampleFinishTime,D=(G=Ki(_.messages))==null?void 0:G.completionSampleFinishTime;Ge.submitMessageComparisonFeedback({feedback_version:N,original_message_id:(W=M.messages[M.messages.length-1])==null?void 0:W.message.id,new_message_id:(j=_.messages[_.messages.length-1])==null?void 0:j.message.id,rating:"none",conversation_id:O.getServerThreadId(t),text:"",tags:[],completion_comparison_rating:"skip",new_completion_placement:u,feedback_start_time:r,compare_step_start_time:r,original_completion_load_start_time:r,original_completion_load_end_time:F??0,new_completion_load_start_time:r,new_completion_load_end_time:D??0,frontend_submission_time:Date.now(),timezone_offset_min:new Date().getTimezoneOffset(),...E.current})}}),[y,C,t,r,N,u,M==null?void 0:M.messages,_==null?void 0:_.messages]);const P=F=>{var K,J,de,V;const A=O.getTree(t).getLeafFromNode(F);O.setThreadCurrentLeafId(t,A.id);const W=F===p===(d==="left"),j=(K=Ki(M.messages))==null?void 0:K.completionSampleFinishTime,z=(J=Ki(_.messages))==null?void 0:J.completionSampleFinishTime;M.messages.length>0&&Eu(t,M.messages[M.messages.length-1].nodeId,W?"original":"new"),_.messages.length>0&&Eu(t,_.messages[_.messages.length-1].nodeId,W?"original":"new");let H;j==null||z==null?H=W?"partial_load_comparison_original":"partial_load_comparison_new":H=W?"original":"new",Ge.submitMessageComparisonFeedback({feedback_version:N,original_message_id:(de=M.messages[M.messages.length-1])==null?void 0:de.message.id,new_message_id:(V=_.messages[_.messages.length-1])==null?void 0:V.message.id,rating:"none",conversation_id:O.getServerThreadId(t),text:"",tags:[],completion_comparison_rating:H,new_completion_placement:u,feedback_start_time:r,compare_step_start_time:r,original_completion_load_start_time:r,original_completion_load_end_time:j??null,new_completion_load_start_time:r,new_completion_load_end_time:z??null,frontend_submission_time:Date.now(),timezone_offset_min:new Date().getTimezoneOffset(),...E.current})};return c.jsx(xm,{...e,setPreferredFeedback:P,leftVariantId:p,rightVariantId:m,leftTurn:y,rightTurn:C,hasActiveRequest:o,shouldEnableUnifiedDesign:n,originalTurn:M,visibilityStateRef:E})}function k1(n){if(!n.length)return!1;const e=n.filter(t=>t.type===he.Text||t.type===he.MultiText).filter(t=>{var s;return t.message.message.status!=="finished_successfully"&&((s=t.message.message.metadata)==null?void 0:s.snorkle_status)!==void 0});return e.length>0&&e.every(t=>{const s=t.message.message.content;return(s==null?void 0:s.content_type)===cn.Text&&s.parts.join("")===""})}function xm({setPreferredFeedback:n,shouldEnableUnifiedDesign:e,leftVariantId:t,rightVariantId:s,leftTurn:i,rightTurn:r,hasActiveRequest:o,originalTurn:a,visibilityStateRef:l,...d}){const{defaultParagenLabel:u,shouldShowParagenLabels:p=!1}=Yu(),m=i&&_u(i)||u,b=r&&_u(r)||u,g=S.useMemo(()=>(i==null?void 0:i.messages)??[],[i==null?void 0:i.messages]),y=S.useMemo(()=>(r==null?void 0:r.messages)??[],[r==null?void 0:r.messages]),{avatarClassName:C}=d,M=S.useMemo(()=>yo(g),[g]),_=S.useMemo(()=>yo(y),[y]),R=Do(),N=ni();function E(xe){var Ce,ye;if(!N.showDebugConversationTurns&&!N.forceParagen)return null;let Se=xe===a?"ORIGINAL":"NEW";const ge=xe.messages[xe.messages.length-1],ce=(ye=(Ce=ge==null?void 0:ge.message)==null?void 0:Ce.metadata)==null?void 0:ye.__internal;if(ce){const{model_id:L,model_definition_slug:Me,model_definition_virtual_model_id:qe,augmented_paragen_prompt_group_id:be,augmented_paragen_prompt_id:ae,augmented_paragen_prompt:Re}=ce;L&&(Se+=`
Model ID: ${L}`),Me&&(Se+=`
Model Slug: ${Me}`),qe&&(Se+=`
Virtual Model ID: ${qe}`),be&&(Se+=`
Prompt Group ID: ${be}`),ae&&(Se+=`
Prompt ID: ${ae}`),Re&&(Se+=`
Prompt: ${Re}`)}return c.jsx("div",{className:"whitespace-pre-wrap text-sm text-red-500",children:Se})}const[P,F]=S.useMemo(()=>[M,_].map(xe=>k1(xe)),[M,_]),D=Xn(i?ur.getRequestIdFromConversationTurn(i):"")||P,A=Xn(r?ur.getRequestIdFromConversationTurn(r):"")||F,G=(i==null?void 0:i.role)===Ve.User,W=(r==null?void 0:r.role)===Ve.User,j=kl(),z=S.useRef(null),H=S.useRef(null),K=S.useRef(null);S.useEffect(()=>{if(z.current&&H.current&&K.current){const xe=Array(11).fill(0).map((ge,ce)=>ce/10),Se=new IntersectionObserver(ge=>ge.forEach(ce=>{ce.target===H.current?(l.current.left_visibility_initial==null&&(l.current.left_visibility_initial=ce.intersectionRatio),l.current.left_visibility_max=Math.max(l.current.left_visibility_max??0,ce.intersectionRatio)):ce.target===K.current&&(l.current.right_visibility_initial==null&&(l.current.right_visibility_initial=ce.intersectionRatio),l.current.right_visibility_max=Math.max(l.current.right_visibility_max??0,ce.intersectionRatio))}),{root:z.current,threshold:xe});return Se.observe(H.current),Se.observe(K.current),()=>Se.disconnect()}},[l]);const{data:J}=jo(void 0,!1,R),de=T1(),V=J==null?void 0:J.memoryFullPct,B=typeof V=="number"&&V>=100,we=c.jsx(U,{id:"TK934w",defaultMessage:"Which response do you prefer? Responses may take a moment to load."});let te,ne;switch(de){case 1:{te=c.jsx(U,{id:"JgCHDY",defaultMessage:"Youre giving feedback on a new version of ChatGPT."}),ne=we;break}case 2:{te=c.jsx(U,{id:"AOeHRv",defaultMessage:"Youre giving feedback on an experimental version of ChatGPT."}),ne=we;break}case 0:default:{te=c.jsx(U,{...er.responsePrompt}),ne=c.jsx(U,{...er.responsePromptExplanation});break}}return c.jsxs("div",{className:"relative flex flex-col",children:[c.jsx("div",{className:"sticky top-[-1px] z-[1] text-pretty bg-token-main-surface-primary px-6 text-center text-lg md:static",children:te}),c.jsx("div",{className:"text-pretty px-6 pb-5 pt-1 text-center text-sm text-token-text-secondary",children:ne}),c.jsx("div",{className:"sticky top-[calc(1.75em-1px)] z-[1] h-3 bg-gradient-to-b from-token-main-surface-primary from-50% to-transparent md:static"}),c.jsx("div",{className:"-mb-2 snap-x snap-mandatory overflow-x-auto px-3 pb-4 md:px-5 lg:px-10",ref:z,children:c.jsx("div",{className:"min-w-fit",children:c.jsxs("div",{className:se({"mx-auto flex max-w-6xl":!0,"gap-2 sm:gap-3":!e,"items-start gap-4 sm:gap-6":e}),children:[c.jsxs(Nu,{elemRef:H,onClick:()=>{n(t)},shouldEnableUnifiedDesign:e,hasActiveRequest:o,children:[c.jsxs(Au,{children:[c.jsx(bl,{messages:g,isUserTurn:G,avatarClassName:C,showInlineEmbeddedDisplay:!1}),c.jsx(Iu,{children:p?c.jsx("span",{className:"font-bold text-token-text-primary",children:m}):c.jsx(U,{...er.responseNumber,values:{responseIndex:1}})})]}),J!=null&&!G&&c.jsx(Sl,{messages:g,isMemoryEnabled:j,isMemoryFull:B,isParagen:!0}),c.jsx(wl,{...d,groupedMessagesToRender:M,allGroupedMessages:M,isEditing:!1,isUserTurn:G,isCompletionRequestInProgress:D,hasActiveRequest:o,handleEnterEdit:_t,handleExitEdit:_t,shouldGrowContainer:!e}),!!i&&E(i)]}),c.jsxs(Nu,{elemRef:K,onClick:()=>{n(s)},shouldEnableUnifiedDesign:e,hasActiveRequest:o,children:[c.jsxs(Au,{children:[c.jsx(bl,{messages:y,isUserTurn:W,avatarClassName:C,showInlineEmbeddedDisplay:!1}),c.jsx(Iu,{children:p?c.jsx("span",{className:"font-bold text-token-text-primary",children:b}):c.jsx(U,{...er.responseNumber,values:{responseIndex:2}})})]}),J!=null&&!W&&c.jsx(Sl,{messages:y,isMemoryEnabled:j,isMemoryFull:B,isParagen:!0}),c.jsx(wl,{...d,groupedMessagesToRender:_,allGroupedMessages:_,isEditing:!1,isUserTurn:W,isCompletionRequestInProgress:A,hasActiveRequest:o,handleEnterEdit:_t,handleExitEdit:_t,shouldGrowContainer:!e}),!!r&&E(r)]})]})})})]})}function Nu({shouldEnableUnifiedDesign:n,...e}){return n?c.jsx(C1,{...e}):c.jsx(M1,{...e})}function C1({elemRef:n,onClick:e,children:t,hasActiveRequest:s}){return c.jsxs("div",{className:"relative flex w-full min-w-[min(450px,80vw)] snap-center flex-col gap-1 truncate rounded-2xl border border-token-main-surface-tertiary bg-white p-5 text-left dark:bg-gray-700",ref:n,children:[t,s?null:c.jsx(It,{className:"mt-4 self-start",onClick:e,children:c.jsx(U,{id:"U2EAH6",defaultMessage:"I prefer this response"})})]})}function M1({elemRef:n,onClick:e,children:t}){const s=Kx(),i="relative flex w-full flex-col gap-1 bg-white cursor-pointer truncate rounded-lg border border-token-main-surface-tertiary text-left dark:bg-gray-700 p-3 sm:py-4 sm:px-5 hover:border-gray-300 min-w-[min(450px,80vw)] snap-center";return s?c.jsx("button",{className:i,onClick:e,ref:n,children:t}):c.jsxs("div",{className:i,ref:n,children:[t,c.jsx("button",{className:"mt-4 rounded-full bg-token-main-surface-primary p-2",onClick:e,children:c.jsx(U,{...er.responseChoice})})]})}const Iu=Xe.div`text-sm text-token-text-tertiary font-semibold`,Au=Xe.div`flex gap-4 items-center mb-1`,er=Ke({responsePrompt:{id:"ConversationTurnTwoUpFeedback.responsePrompt",defaultMessage:"Which response do you prefer?"},responsePromptExplanation:{id:"ConversationTurnTwoUpFeedback.responsePromptExplanation",defaultMessage:"Your choice will help make ChatGPT better."},responseNumber:{id:"ConversationTurnTwoUpFeedback.responseNumber",defaultMessage:"Response {responseIndex, number}"},responseChoice:{id:"ConversationTurnTwoUpFeedback.responseChoice",defaultMessage:"Choose this response"}});function v1(){const{layer:n}=zi("229662723");return n.get("should-enable-chair",!1)}function T1(){const{layer:n}=zi("229662723");return n.get("bread-version",0)}function E1({clientThreadId:n,messageForRating:e,variantIds:t,conversationTurnMountTime:s}){const[i]=S.useState(()=>e.message.create_time!=null?e.message.create_time*1e3:Date.now()),[r]=S.useState(()=>Date.now());function o(a){var E,P;const l=O.getTree(n),d=t[0]||"",u=(l==null?void 0:l.getConversationTurns(d))||[],p=u[u.length-1],m=(p==null?void 0:p.messages)||[],b=m[m.length-1],g=((E=b==null?void 0:b.message)==null?void 0:E.id)||"",y=t[1]||"",C=(l==null?void 0:l.getConversationTurns(y))||[],M=C[C.length-1],_=(M==null?void 0:M.messages)||[],R=_[_.length-1],N=((P=R==null?void 0:R.message)==null?void 0:P.id)||"";Ge.submitMessageComparisonFeedback({feedback_version:"inline_regen_feedback:a:1.0",original_message_id:g,new_message_id:N,rating:"none",conversation_id:O.getServerThreadId(n),text:"",tags:[],completion_comparison_rating:a,new_completion_placement:"not-applicable",feedback_start_time:s,compare_step_start_time:s,new_completion_load_start_time:i,new_completion_load_end_time:r,frontend_submission_time:Date.now(),timezone_offset_min:new Date().getTimezoneOffset()}),O.updateTree(n,F=>{F.updateNodeMetadata(e.nodeId,{inlineComparisonRating:a})}),O.updateTree(n,F=>{F.updateNodeMetadata(b.nodeId,{inlineComparisonRating:"baseline"})})}return c.jsxs(_1,{children:[c.jsx("h6",{className:"min-w-[150px] grow",children:c.jsx(U,{...Kr.regenTitle})}),c.jsxs("div",{className:"flex flex-wrap items-end justify-center gap-2",children:[c.jsx(It,{color:"secondary",onClick:()=>o("new"),children:c.jsx(U,{...Kr.regenBetterText})}),c.jsx(It,{color:"secondary",onClick:()=>o("original"),children:c.jsx(U,{...Kr.regenWorseText})}),c.jsx(It,{color:"secondary",onClick:()=>o("same"),children:c.jsx(U,{...Kr.regenSameText})})]}),c.jsx(Ga,{onClick:()=>{O.updateTree(n,a=>{a.updateNodeMetadata(e.nodeId,{inlineComparisonRating:"skip"})})}})]})}const _1=Xe.div`flex items-center p-4 rounded-2xl bg-token-main-surface-primary text-token-text-primary text-sm border border-token-border-light gap-5 mt-3`,Kr=Ke({regenTitle:{id:"ConversationTurnInlineFeedback.regenTitle",defaultMessage:"Was this response better or worse?"},regenBetterText:{id:"ConversationTurnInlineFeedback.regenBetterText",defaultMessage:"Better"},regenWorseText:{id:"ConversationTurnInlineFeedback.regenWorseText",defaultMessage:"Worse"},regenSameText:{id:"ConversationTurnInlineFeedback.regenSameText",defaultMessage:"Same"}}),Ru=({allGroupedMessages:n})=>n.some(e=>[he.Browsing,he.RetrievalBrowsing,he.ParallelBrowsing].includes(e.type)),Du=({allGroupedMessages:n})=>n.some(e=>e.type===he.CodeInterpreter);function N1(n){return!n||!n.instructions?"":typeof n.instructions=="string"?n.instructions:n.instructions.filter(e=>typeof e=="string").join("")}const I1=[{match:Ru,tag:"Shouldn't have searched the web",label:ht({id:"kL047b",defaultMessage:"Shouldn't have searched the web"})},{match:Ru,tag:"Don't like the source it cited",label:ht({id:"+ds/Q/",defaultMessage:"Don't like the source it cited"})},{match:Du,tag:"Shouldn't have run code",label:ht({id:"53w4ay",defaultMessage:"Shouldn't have run code"})},{match:Du,tag:"Couldn't handle my file",label:ht({id:"EkFTQ5",defaultMessage:"Couldn't handle my file"})},{match:({allGroupedMessages:n})=>n.some(e=>e.type===he.Dalle),tag:"Shouldn't have created an image",label:ht({id:"S8FRsr",defaultMessage:"Shouldn't have created an image"})},{match:({allGroupedMessages:n})=>n.some(e=>{if(e.type!==he.Text)return!1;const{message:t}=e.message,{content:s}=t;return s.content_type===cn.Text&&qo(t).match(/^```[\S]+\n/gm)}),tag:"Code was incorrect",label:ht({id:"4EBdQk",defaultMessage:"Code was incorrect"})},{match:({systemContent:n})=>N1(n).includes("Personality")??!1,tag:"Too chatty or casual",label:ht({id:"ATzJKW",defaultMessage:"Too chatty or casual"})},{match:({features:n})=>n.includes(si.Sunshine),tag:"Shouldn't have used Memory",label:ht({id:"yfUEiz",defaultMessage:"Shouldn't have used Memory"})},{tag:"Don't like the style",label:ht({id:"nGxjdj",defaultMessage:"Don't like the style"})},{tag:"Not factually correct",label:ht({id:"Ke7JtQ",defaultMessage:"Not factually correct"})},{tag:"Didn't fully follow instructions",label:ht({id:"Rdlt9V",defaultMessage:"Didn't fully follow instructions"})},{tag:"Refused when it shouldn't have",label:ht({id:"2yRS/Q",defaultMessage:"Refused when it shouldn't have"})},{tag:"Being lazy",label:ht({id:"14MPmT",defaultMessage:"Being lazy"})},{tag:"Unsafe or problematic",label:ht({id:"02pXBl",defaultMessage:"Unsafe or problematic"})},{tag:"Other",label:ht({id:"WiIGE+",defaultMessage:"Other"})}],A1=[{tag:"I disagree with the policy",label:ht({id:"oKyDLz",defaultMessage:"I disagree with the policy"})},{tag:"This didn't violate the policy",label:ht({id:"7fUkVF",defaultMessage:"This didn't violate the policy"})},{tag:"I don't understand the policy",label:ht({id:"4Cdp6N",defaultMessage:"I don't understand the policy"})},{tag:"This didn't take the full context",label:ht({id:"vnZJDP",defaultMessage:"This didn't take the full context"})}];function R1(n,e,t){return e.filter(s=>!s.match||s.match(t)).map(s=>({value:s.tag,label:n.formatMessage(s.label)}))}function D1(n){const e=n[n.length-1];if(!e)return!1;const t="message"in e?e.message:null;if(t){const{errCode:s}=Wi(t);return[an.ContentPolicy,an.ContentOrTos].includes(s)}else return!1}function j1({clientThreadId:n,conversationMessage:e,currentModelId:t,allGroupedMessages:s}){const i=Fe(),r=Li()??[],o=e.rating,{value:a}=Jn("1410082514"),l=E0(n,e.message.id),d=(l==null?void 0:l.message.content.content_type)===cn.SystemContent?l==null?void 0:l.message.content:null,u=S.useCallback(b=>{var M;const g=O.getServerThreadId(n);if(!g||b.tags.length===0&&!b.textFeedback)return;ee.logEvent(b.source==="inline"?$.messageFeedbackInlineSubmitted:$.messageFeedbackDialogSubmitted,{id:e.message.id,threadId:g,tags:b.tags,content:b.textFeedback,model:t,rating:o});const C=a&&((M=e.message.metadata)==null?void 0:M.snorkle_status)!=null?Ge.submitSnorkleFeedback:Ge.submitMessageFeedback;o&&C({message_id:e.message.id,conversation_id:g,rating:o,text:b.textFeedback,tags:b.tags,tag_choices:b.tagChoices})},[n,e.message,t,o,a]),p=()=>{ee.logEvent($.messageFeedbackMoreOptionsClicked,{id:e.message.id,threadId:O.getServerThreadId(n),model:t,rating:o})},m=R1(i,D1(s)?A1:I1,{allGroupedMessages:s,features:r,currentModelId:t,systemContent:d});return o==="thumbsUp"?null:c.jsx(Fb,{tagOptions:m,onSubmit:u,onMoreClicked:p})}const ju=[1,2,3,4],O1=.5;function P1({clientThreadId:n,conversationLeafId:e}){const t=xo(Pl.isBusinessWorkspace),s=S.useRef(!1),i=Ir(n),r=vs(n),{isUnauthenticated:o}=Zt(),{value:a}=Jn("1410082514"),l=S.useMemo(()=>{if(!i)return-1;const j=Th(i);return j()>O1?-1:ju[Math.floor(j()*ju.length)]},[i]),d=rf(n,e),u=d[d.length-1],p=S.useMemo(()=>ur.getRequestIdFromConversationTurn(u),[u]),m=Xn(p),[b,g]=S.useState(null),[y,C]=S.useState(!1),[M,_]=S.useState(!1),[R,N]=S.useState(!1),E=j=>{var H,K;const z=(K=(H=Ki(d))==null?void 0:H.messages[0])==null?void 0:K.message.id;g(j),G(z,j)},P=d.filter(j=>j.role===Ve.Assistant).length,F=(u==null?void 0:u.role)===Ve.Assistant,D=u==null?void 0:u.messages.some(j=>{var z;return(z=j.message.metadata)==null?void 0:z.is_nulligen}),A=a&&(u==null?void 0:u.messages.some(j=>{var z;return((z=j.message.metadata)==null?void 0:z.snorkle_status)!=null})),G=S.useMemo(()=>jl((j,z)=>{i&&j&&(A?Ge.submitSnorkleFeedback({conversation_id:i,message_id:j,rating:z}):Ge.submitConversationRating({conversation_id:i,message_id:j,rating:z,shown_at_assistant_turn:l})),ee.logEvent($.conversationRatingSubmitted,{rating:z,showAtAssistantTurn:l,conversationId:i}),C(!0),setTimeout(()=>{_(!0)},1500)},2e3),[i,l,A]),W=P!==l||m||!F||D||!!t||(r==null?void 0:r.kind)!==it.PrimaryAssistant||R||o;return S.useEffect(()=>{!W&&!s.current&&(ee.logEvent($.conversationRatingShown,{showAtAssistantTurn:l,conversationId:i}),s.current=!0)},[W]),R||W&&!A?null:c.jsxs("div",{className:"mx-auto",children:[c.jsx(Ys,{children:y&&!M&&c.jsx(ft.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},children:c.jsx(Ou,{$padded:!0,children:c.jsx("span",{className:"text-sm text-token-text-tertiary",children:c.jsx(U,{id:"rating.thanks",defaultMessage:"Thanks for your feedback!"})})})},"submitted")}),!y&&c.jsx(ft.div,{initial:{opacity:0},animate:{opacity:1},transition:{duration:.1},children:c.jsxs(Ou,{$padded:!1,children:[c.jsxs("div",{className:"flex items-center justify-center gap-4 px-4 py-3 text-sm text-token-text-secondary",children:[c.jsx(U,{id:"rating.instructions",defaultMessage:"Is this conversation helpful so far?"}),c.jsxs("div",{className:"flex items-center gap-5",children:[c.jsx(Na,{$selected:b==="thumbsUp",onClick:()=>E("thumbsUp"),children:c.jsx(Zl,{className:"icon-md"})}),c.jsx(Na,{$selected:b==="thumbsDown",onClick:()=>E("thumbsDown"),children:c.jsx(ec,{className:"icon-md"})})]})]}),c.jsx("div",{className:"w-px flex-1 self-stretch bg-token-main-surface-tertiary"}),c.jsx(Na,{className:"p-3",$selected:!1,onClick:()=>N(!0),children:c.jsx(lb,{className:"icon-md text-token-text-secondary hover:text-token-text-primary"})})]})},"rating")]})}const Na=Xe.button`
  ${n=>n.$selected?"text-token-text-primary":"text-token-text-secondary"}
  hover:text-token-text-primary
`,Ou=Xe.div`inline-flex rounded-xl border border-gray-100 dark:border-gray-700
${n=>n.$padded&&"py-3 px-4"}
`;function F1({clientThreadId:n,conversationLeafId:e,canShowIndepthFeedbackType:t,canShowInlineComparisonFeedback:s,canShowInlineMessageFeedback:i,messageForRating:r,allGroupedMessages:o,currentModelId:a,conversationTurnMountTime:l,variantIds:d}){let u=null;return _0(n,e)?null:(t!==void 0?u=c.jsx(iT,{clientThreadId:n,conversationLeafId:e,trigger:t,variantIds:d}):r.rating&&i?u=c.jsx(j1,{clientThreadId:n,conversationMessage:r,allGroupedMessages:o,currentModelId:a}):s?u=c.jsx(E1,{clientThreadId:n,messageForRating:r,variantIds:d,conversationTurnMountTime:l}):u=c.jsx("div",{className:"text-center",children:c.jsx(P1,{clientThreadId:n,conversationLeafId:e})}),c.jsx("div",{className:"mt-3 w-full empty:hidden",children:u}))}const B1=ze(()=>Oe(()=>import("./sso-dud3eqjhdwr0lbxq.js").then(n=>n.R),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66])),{ssr:!1}),L1=ze(()=>Oe(()=>import("./sso-dud3eqjhdwr0lbxq.js").then(n=>n.g),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66])).then(n=>n.ContextualAnswerCitationCards).catch(()=>()=>null));function z1(n){var tt;const{turnIndex:e,conversationLeafId:t,isFinalTurn:s,clientThreadId:i,onChangeItemInView:r,onChangeRating:o,showInlineEmbeddedDisplay:a=!1,currentModelId:l,initiallyHighlightedMessageId:d,avatarClassName:u,scrollToBottom:p}=n,m=Fe(),b=Ui(),g=xo(Pl.isBusinessWorkspace),y=kl(),C=Do(),M=$i(N0(i,e,t)),{messages:_,variantIds:R,variantsInStreamInfo:N}=M,E=yo(_),P=uy();let F=_[_.length-1];for(const ve of E){const Je=g1(ve);if(Je.some(tn=>P.has(tn.message.id))){F=Je[Je.length-1];break}}const D=_.slice(0,_.indexOf(F)+1),A=zl(),[G,W]=S.useState(!1),[j,z]=S.useState(!1),H=R.findIndex(ve=>D.some(Je=>Je.nodeId===ve)),K=M.role===Ve.User,J=es(),de=Mn(i),V=(tt=Ms(M.gizmoId??de))==null?void 0:tt.data,B=Ch(),we=V&&B.includes(V.gizmo.id),te=_h(l),ne=vs(i,V==null?void 0:V.gizmo.id),{data:xe}=jo(V==null?void 0:V.gizmo.id,!1,C),Se=xe==null?void 0:xe.memoryFullPct,ge=Se!==void 0&&Se>=100,ce=Li(),{value:Ce}=Jn("1410082514"),ye=D.some(ve=>ve.message.content.content_type===cn.MultimodalText),{isUnauthenticated:L}=Zt(),[Me,qe]=S.useState(!1),[be,ae]=S.useState(!1);hy(()=>{M.role==="user"&&p&&p()});const Re=S.useRef(null);S.useEffect(()=>{var Je;if(d==null)return;M.messages.map(tn=>tn.message.id).includes(d)&&((Je=Re.current)==null||Je.scrollIntoView({behavior:"auto"}))},[d]);const oe=_[_.length-1],ot=oe.rating,wt=()=>{D.length===1&&(ee.logEvent($.editPrompt,{id:D[0].message.id,threadId:O.getServerThreadId(i)}),rt.logEvent("chatgpt_edit_prompt"),W(!0))},Ze=S.useCallback(()=>{W(!1)},[]),at=S.useCallback(()=>{O.copyMessageToClipboard(i,e)},[i,e]),$e=ve=>{o({nodeId:oe.nodeId,messageId:oe.message.id,rating:ve}),rt.getExperimentValue({experimentName:"101132775",key:"show_new_ui",defaultValue:!1})&&(ee.logEvent($.messageFeedbackThumbsDownClicked,{id:oe.message.id,threadId:O.getServerThreadId(i),model:l,rating:ve}),z(!0))},[gt]=S.useState(()=>Date.now()),De=S.useMemo(()=>ur.getRequestIdFromConversationTurn(M),[M]),St=nf({clientThreadId:i,conversationLeafId:t}),Ne=Xn(De)&&!St,Ue=Dl(),We=yo(D),{showDebugConversationTurns:x}=ni(),h=sf(i),f=tm(i),w=aT({clientThreadId:i,conversationMode:ne}),v=Rn(i),T=S.useCallback((ve,Je,tn)=>{w(oe.nodeId,{eventSource:"mouse"},ve,Je,tn)},[oe,w]),I=Ce&&D.some(ve=>{var Je;return((Je=ve.message.metadata)==null?void 0:Je.snorkle_status)!=null}),ue=!b&&!h&&!J&&!K,Ee=ue&&(!g||I),ke=fy(),Te=!L&&Ee&&A&&!Ne&&!a&&!G&&(ne==null?void 0:ne.kind)!==it.GizmoMagicCreate&&H===1&&s&&!oe.inlineComparisonRating&&!ot&&R.length===2&&!ke&&Date.now()-(oe.message.create_time??0)*1e3<1e3*60*10,Q=!L&&Ee&&!Ne&&!a&&!G&&(ne==null?void 0:ne.kind)!==it.GizmoMagicCreate&&l===dx&&s&&y&&!ge&&Date.now()-(oe.message.create_time??0)*1e3<1e3*60*10,dn=rT(oe),kt=F.message.author.role===Ve.Assistant?F.message:null;py({isCompletionRequestInProgress:Ne,isUserTurn:K,message:kt});const _s=Q?dn:void 0,Ns=I0(i,R),un=my(ne),Be=!ke&&!un&&ue&&s&&(N==null?void 0:N.num_variants_in_stream)===2&&!oe.inlineComparisonRating&&!Ns,et=R.length===2,He=Be,Pn=Be&&!et,ts=!K&&!a&&!b&&!h&&!un&&!Ne,Fn=ts&&(!g||I||te)&&!un&&!L&&!J,Bn=!b&&!a&&!(Ne&&s)&&R.length>1&&!G&&!He;let en=!1;if(K&&D.length===1){const{shouldHideContent:ve}=Wi(D[0]);ve&&(en=!0)}const ri=K&&!a&&!un&&!b&&!ye&&D.length===1&&!en&&!G&&!L,Vt=ve=>{r(R[ve]),ee.logEvent($.changeNode,{intent:"toggle_between"})};if(!(M.role===Ve.Root?!1:M.role===Ve.System||D.every(ve=>{var Je;return(Je=ve.message.metadata)==null?void 0:Je.is_visually_hidden_from_conversation})?x:!0)&&!He)return null;const ns=s&&f&&!Ce?c.jsx(Yr,{onClick:()=>{w(v,{eventSource:"mouse"}),ar()},icon:Xl,label:m.formatMessage({id:"ConversationTurn.regenerateTooltip",defaultMessage:"Regenerate"})}):null,Ln="h-[30px] rounded-md px-1 text-token-text-secondary hover:bg-token-main-surface-secondary",ai=f&&Ce?c.jsx(B1,{className:Ln,clientThreadId:i,message:oe,onModelSelect:T,onDropdownChange:qe}):null,li=!K&&!en&&!a&&(!s||!Ne)?c.jsx(ky,{onClick:at}):null,ci=!K&&!a&&(!s||!Ne)&&(oe.disclaimers??[]).length===0&&oe.nodeId?c.jsx(ST,{conversationId:i,message:oe,iconClassName:"icon-md",className:"gap-1.5 rounded-md p-1 text-xs text-token-text-tertiary hover:text-token-text-primary"}):null,di=!K&&!a&&oe&&(!s||!Ne)?c.jsx(Cy,{message:oe,isFinalTurn:s,iconClassName:"icon-md",className:"gap-1.5 rounded-md p-1 text-token-text-tertiary hover:text-token-text-primary"}):null,me=Fn&&!Ne?c.jsxs("div",{className:"flex",children:[!(ce!=null&&ce.includes(si.ThumbsDownOnly))&&ot!=="thumbsDown"&&c.jsx(Yr,{onClick:()=>$e("thumbsUp"),disabled:ot==="thumbsUp",icon:ot==="thumbsUp"?cb:Zl,label:m.formatMessage({id:"ConversationTurn.goodResponseTooltip",defaultMessage:"Good response"})},`thumbsUp:${oe.nodeId}`),ot!=="thumbsUp"&&c.jsx(Yr,{onClick:()=>$e("thumbsDown"),disabled:ot==="thumbsDown",icon:ot==="thumbsDown"?db:ec,label:m.formatMessage({id:"ConversationTurn.badResponseTooltip",defaultMessage:"Bad response"})},`thumbsDown:${oe.nodeId}`)]}):null,yt=!Ce&&c.jsx(eT,{className:Ln,clientThreadId:i,message:oe,onModelSelect:T,onDropdownChange:qe});return c.jsxs("article",{className:"w-full text-token-text-primary focus-visible:outline-2 focus-visible:outline-offset-[-4px]",ref:Re,dir:"auto","data-testid":`conversation-turn-${e}`,"data-scroll-anchor":s,onMouseEnter:()=>ae(!0),onMouseLeave:()=>ae(!1),children:[c.jsx(gy,{role:M.role}),c.jsx(Jl,{clientThreadId:i,showInlineEmbeddedDisplay:a,isStaticSharedThread:b,withVerticalPadding:!0,withHorizontalPadding:!He,children:He?c.jsx(w1,{isFeedbackEnabled:Fn,variantIds:R,variantsInStreamInfo:N,conversationTurnMountTime:gt,stubSideBySideFeedback:Pn,...n}):c.jsxs(Yl,{children:[!K&&c.jsx(U1,{children:c.jsx(bl,{messages:D,isUserTurn:K,avatarClassName:u,showInlineEmbeddedDisplay:a,gizmo:V})}),c.jsx("div",{className:se("group/conversation-turn relative flex w-full min-w-0 flex-col",!K&&yy),children:c.jsx("div",{className:"flex-col gap-1 md:gap-3",children:c.jsxs(c.Fragment,{children:[!K&&!b&&c.jsx(Sl,{messages:D,isMemoryEnabled:y,isMemoryFull:ge,gizmoId:V==null?void 0:V.gizmo.id}),c.jsx(wl,{groupedMessagesToRender:We,allGroupedMessages:E,...n,isEditing:G,isUserTurn:K,isCompletionRequestInProgress:Ne,isFeedbackEnabled:Fn,isFinalTurn:s,hasActiveRequest:Ue,showEditButton:ri,handleEnterEdit:wt,handleExitEdit:Ze}),we&&c.jsx("div",{className:"mb-4",children:c.jsx(xy,{messages:D})}),te&&c.jsx("div",{className:"mb-4",children:c.jsx(L1,{messages:D})}),(ts||Bn)&&c.jsxs(c.Fragment,{children:[c.jsx("div",{className:se("mt-1 flex gap-3 empty:hidden",K?"mr-1 flex-row-reverse":"-ml-2"),children:c.jsx(by,{alwaysShow:s,showInline:s||Bn,isHovered:be||Me,pagination:Bn&&c.jsx(wy,{showInline:s||Bn,currentPage:H,onChangeIndex:Vt,length:R.length,className:se("self-center",R.length>1?"visible":"!invisible")}),actions:ts&&c.jsxs(c.Fragment,{children:[ci,li,ns,me,di,yt,ai]})})}),ts&&!Ne?c.jsx("div",{className:"pr-2 lg:pr-0",children:c.jsx(Sy,{message:oe,isFinalTurn:s})}):null,s&&!Ne&&c.jsx(F1,{canShowIndepthFeedbackType:_s,canShowInlineComparisonFeedback:Te,canShowInlineMessageFeedback:j,clientThreadId:i,conversationLeafId:t,messageForRating:oe,allGroupedMessages:E,currentModelId:l,conversationTurnMountTime:gt,variantIds:R})]})]})})})]})})]})}const oo=Hl.memo(z1),U1=Xe.div`flex-shrink-0 flex flex-col relative items-end`,Ie=Ke({submitFeedback:{id:"feedbackModal.submitFeedback",defaultMessage:"Submit feedback"},submitReport:{id:"feedbackModal.submitReport",defaultMessage:"Submit report"},submitRejectModeration:{id:"feedbackModal.moderationReject",defaultMessage:"Block Content"},submitAcceptModeration:{id:"feedbackModal.moderationAccept",defaultMessage:"Allow Content"},thumbsUpPlaceholder:{id:"feedbackModal.thumbsUpPlaceholder",defaultMessage:"What do you like about the response?"},thumbsDownPlaceholder:{id:"feedbackModal.thumbsDownPlaceholder",defaultMessage:"What was the issue with the response? How could it be improved?"},reportContentExplanationPlaceholder:{id:"feedbackModal.reportContentExplanationPlaceholder",defaultMessage:"What is wrong with the response? What about this response is harmful? Please be as specific as possible, and add any details that are not present in the checkboxes below."},harmfulUnsafe:{id:"feedbackModal.harmfulUnsafe",defaultMessage:"This is harmful / unsafe"},harmfulOffensive:{id:"feedbackModal.harmfulOffensive",defaultMessage:"This content is harmful or offensive"},copyrightContent:{id:"feedbackModal.copyrightContent",defaultMessage:"This content violates copyright law"},reportOtherContent:{id:"feedbackModal.reportOtherContent",defaultMessage:"I don't like this for some other reason (please describe)"},notTrue:{id:"feedbackModal.notTrue",defaultMessage:"This isn't true"},notHelpful:{id:"feedbackModal.notHelpful",defaultMessage:"This isn't helpful"},dontLikeThis:{id:"feedbackModal.dontLikeThis",defaultMessage:"I don't like this"},sexualAbuse:{id:"feedbackModal.sexualAbuse",defaultMessage:"This content contains sexual abuse"},provideAdditionalFeedback:{id:"feedbackModal.provideAdditionalFeedback",defaultMessage:"Provide additional feedback"},provideReportModalTitle:{id:"feedbackModal.provideReportModalTitle",defaultMessage:"Report This Content"},pickBestAnswer:{id:"feedbackModal.pickBestAnswer",defaultMessage:"Pick the best answer to improve the model"},newAnswer:{id:"feedbackModal.newAnswer",defaultMessage:"New Answer"},originalAnswer:{id:"feedbackModal.originalAnswer",defaultMessage:"Original Answer"},newAnswerBetter:{id:"feedbackModal.newAnswerBetter",defaultMessage:"New answer is better"},originalAnswerBetter:{id:"feedbackModal.originalAnswerBetter",defaultMessage:"Original answer is better"},neitherAnswerBetter:{id:"feedbackModal.neitherAnswerBetter",defaultMessage:"Neither answer is better"},skipStep:{id:"feedbackModal.skipStep",defaultMessage:"Skip this step"},continueWithChosenAnswer:{id:"feedbackModal.continueWithChosenAnswer",defaultMessage:"The conversation will continue with the answer you choose."},employeeConsent:{id:"feedbackModal.employeeConsent",defaultMessage:"Allow this content to be used for model evals"},employeeConsentExplanation:{id:"feedbackModal.employeeConsentExplanation",defaultMessage:"Allow your feedback and conversation to be used to in model evals. Please verify there is no confidential data in the conversation."}});function ao(n,e=!1){var t,s,i;return((t=n==null?void 0:n.messages)==null?void 0:t.length)===1&&!((s=n==null?void 0:n.messages)!=null&&s.some(r=>"error"in r))&&(e?!(((i=n==null?void 0:n.messages)==null?void 0:i.length)===1&&qo(n==null?void 0:n.messages[0].message).length<20):!0)}function Ia({ratingModalNodeId:n,ratingModalOpen:e,onCloseRatingModal:t,onSubmitFeedback:s,onHandleChangeFeedbackComparisonRating:i,feedbackTextareaRef:r,clientThreadId:o,currentModelId:a,onChangeItemInView:l,onRequestMoreCompletions:d,onRequestCompletion:u}){var un;const p=Fe(),m=O.getTree(o),b=(un=S.useContext(Yh))==null?void 0:un.serverSharedThreadId,g=O.getServerThreadId(o),y=b??g,C=Bo(),M=!!C&&Lh(C),[_,R]=S.useState(!1),N=S.useRef(Math.random()<.5?"left":"right"),E=m==null?void 0:m.getConversationTurns(n||"root"),P=E.length-1,F=E[E.length-1],[D,A]=S.useState("critique"),G=Tr(),W=ao(F,!0)&&G,j=S.useMemo(()=>({id:n||"root",threadId:O.getServerThreadId(o),rating:e,model:a}),[n,o,e,a]),z=E==null?void 0:E[(E==null?void 0:E.length)-1].variantIds,H=z==null?void 0:z[(z==null?void 0:z.length)-1],K=function(){const Be=m==null?void 0:m.getConversationTurns(H),et=Be[Be.length-1];return et.messages[et.messages.length-1].nodeId}(),J=function(){return m==null?void 0:m.getConversationTurns(K)}(),de=S.useMemo(()=>{const Be=J==null?void 0:J[(J==null?void 0:J.length)-1];return e==="thumbsDown"&&W&&ao(Be)&&ao(F)},[e,W,J,F]),V=S.useRef(Date.now()),B=S.useRef(-1),we=S.useRef(Date.now()),te=S.useRef(Date.now());S.useEffect(()=>{D==="compare"?(B.current=Date.now(),ee.logEvent($.displayedComparisonUIV0,j)):D==="critique"&&e==="thumbsDown"&&ee.logEvent($.displayedThumbsDownFeedbackForm,j)},[D]);const ne=E.length-2,xe=J.length-1,Se=J[J.length-1],ge=S.useMemo(()=>Se&&ur.getRequestIdFromConversationTurn(Se),[Se]),ce=Xn(ge);S.useMemo(()=>{ce||(te.current=Date.now())},[ce]);const Ce=F.messages,ye=Ce[Ce.length-1],L=ye.message.id,Me=ye.nodeId,qe=m.getLeafFromNode(Me),be=Se.messages,ae=be[be.length-1],Re=ae.message.id,oe=ae.nodeId,ot=m.getLeafFromNode(oe),wt=D==="critique"?e==="report"?p.formatMessage(Ie.provideReportModalTitle):p.formatMessage(Ie.provideAdditionalFeedback):p.formatMessage(Ie.pickBestAnswer),Ze=S.useRef([]),at=S.useRef(""),$e=S.useCallback(()=>{var et;const Be=(et=r.current)==null?void 0:et.elements;Ze.current=[...Be||[]].filter(He=>He.checked).map(He=>He.id).map(He=>He.replace("feedback-","")),at.current=(Be==null?void 0:Be["feedback-other"].value)||""},[r]),gt=S.useCallback(()=>{$e(),s({customFeedback:at.current,tags:Ze.current,employeeConsented:M?_:void 0}),e==="thumbsDown"&&ee.logEvent($.submitThumbsDownFeedbackForm,j),de?A("compare"):t()},[$e,s,M,_,e,de,j,t]),De=S.useCallback((Be,et)=>{if(y==null){on.danger("Moderation NOT logged successfully! serverThreadId is null"),jt.addError("Moderation: serverThreadId is null");return}const He=m.getMessageId(O.getThreadCurrentLeafId(o));Ge.submitSharedConversationReportFeedback({message_id:He,shared_conversation_id:y,text:Be,tags:et}).then(()=>{on.success("Moderation logged successfully")}).catch(Pn=>{on.danger("Moderation NOT logged successfully! Please try again"),jt.addError(new Error("Moderation: failed to log",{cause:Pn}))}),t()},[m,o,t,y]),St=S.useCallback(()=>{$e(),Ze.current.push("moderation-reject"),De(at.current,Ze.current)},[De,$e]),Ne=S.useCallback(()=>{$e(),Ze.current.push("moderation-accept"),De(at.current,Ze.current)},[De,$e]),Ue=e==="moderate"?c.jsxs(c.Fragment,{children:[c.jsx(Gn.Button,{title:p.formatMessage(Ie.submitRejectModeration),color:"danger",onClick:St}),c.jsx(Gn.Button,{title:p.formatMessage(Ie.submitAcceptModeration),color:"primary",onClick:Ne})]}):D==="critique"?c.jsxs("div",{className:"flex items-center gap-3",children:[M&&e!=="report"&&c.jsx(ti,{label:p.formatMessage(Ie.employeeConsentExplanation),children:c.jsx(nn,{id:"employee-consent",checked:_,onChange:Be=>R(Be.currentTarget.checked),label:p.formatMessage(Ie.employeeConsent)})}),c.jsx(Gn.Button,{title:p.formatMessage(e==="report"?Ie.submitReport:Ie.submitFeedback),onClick:gt})]}):null,We=N.current==="left",x=We?xe:P,h=We?P:xe,f=We?oe:Me,w=We?Me:oe,v=We?"new":"original",T=We?"original":"new",I=We?p.formatMessage(Ie.newAnswer):p.formatMessage(Ie.originalAnswer),ue=We?p.formatMessage(Ie.originalAnswer):p.formatMessage(Ie.newAnswer),Ee=We?p.formatMessage(Ie.newAnswerBetter):p.formatMessage(Ie.originalAnswerBetter),ke=We?p.formatMessage(Ie.originalAnswerBetter):p.formatMessage(Ie.newAnswerBetter),Te=e&&e!=="report"&&e!=="moderate",Q=S.useCallback(Be=>{const et=Be==="left"?v:Be==="right"?T:"same";if(ee.logEvent($.submittedComparisonUIV0,Object.assign({},j,{choice:et})),Te){const He=O.getTree(o);He.updateNodeMetadata(Me,{inlineComparisonRating:"baseline"}),He.updateNodeMetadata(oe,{inlineComparisonRating:et}),i(L,Re,e,et,N.current,V.current,B.current,we.current,te.current,at.current,Ze.current)}O.setThreadCurrentLeafId(o,Be===N.current?ot.id:qe.id),t()},[v,T,j,Te,o,ot.id,qe.id,t,Me,oe,i,L,Re,e]),dn=!ce&&te.current!=null&&de,kt=S.useCallback(()=>{t(),D==="critique"?ee.logEvent($.skippedThumbsDownFeedbackForm,Object.assign({},j)):D==="compare"&&ee.logEvent($.skippedComparisonUIV0,Object.assign({},j))},[t,j,D]),[_s,Ns]=S.useState([]);return S.useEffect(()=>{e==="moderate"&&Ge.fetchShareModerationCategories().then(Be=>{const et=Be.moderation_categories;Ns(Object.keys(et).map(He=>[He,et[He]]))})},[]),c.jsxs(Qh,{isOpen:!0,onClose:kt,showCloseButton:!0,size:"custom",className:"md:max-w-[672px] lg:max-w-[896px] xl:max-w-6xl",type:D==="critique"?e==="thumbsUp"?"success":"danger":"success",icon:D==="critique"?e==="thumbsUp"?Zl:ec:void 0,title:wt,children:[D==="critique"&&c.jsxs("form",{ref:r,children:[c.jsx(ph,{id:"feedback-other",placeholder:e==="thumbsUp"?p.formatMessage(Ie.thumbsUpPlaceholder):e==="report"?p.formatMessage(Ie.reportContentExplanationPlaceholder):p.formatMessage(Ie.thumbsDownPlaceholder),rows:3,className:"mb-1 mt-4 w-full resize-none rounded-md bg-token-main-surface-primary"}),e==="thumbsDown"&&c.jsxs("div",{className:"mb-4",children:[c.jsx(nn,{id:"feedback-harmful",label:p.formatMessage(Ie.harmfulUnsafe)}),c.jsx(nn,{id:"feedback-false",label:p.formatMessage(Ie.notTrue)}),c.jsx(nn,{id:"feedback-not-helpful",label:p.formatMessage(Ie.notHelpful)})]}),e!=null&&!Te&&c.jsx(c.Fragment,{children:c.jsxs("div",{className:"mb-4",children:[e==="report"&&c.jsxs(c.Fragment,{children:[c.jsx(nn,{id:"feedback-dont-like-this",label:p.formatMessage(Ie.dontLikeThis)}),c.jsx(nn,{id:"feedback-false",label:p.formatMessage(Ie.notTrue)}),c.jsx(nn,{id:"feedback-not-helpful",label:p.formatMessage(Ie.notHelpful)}),c.jsx(nn,{id:"feedback-harmful-offensive",label:p.formatMessage(Ie.harmfulOffensive)}),c.jsx(nn,{id:"feedback-sexual-abuse",label:p.formatMessage(Ie.sexualAbuse)})]}),e==="moderate"&&c.jsxs(c.Fragment,{children:[_s.map(([Be,et])=>c.jsx(nn,{id:"feedback-"+Be,label:et},Be)),c.jsx(nn,{id:"feedback-copyright",label:p.formatMessage(Ie.copyrightContent)})]}),c.jsx(nn,{id:"feedback-content-other",label:p.formatMessage(Ie.reportOtherContent)})]})})]}),D==="compare"&&J&&y!==void 0&&c.jsxs("div",{className:se("w-full"),children:[c.jsx("p",{className:se("mb-7 mt-3"),children:c.jsx(U,{...Ie.continueWithChosenAnswer})}),c.jsx(V1,{className:"rounded-md",children:c.jsx(Aa,{children:c.jsx(oo,{currentModelId:a,turnIndex:ne,conversationLeafId:w,isFinalTurn:!1,clientThreadId:o,onChangeItemInView:l,onChangeRating:_t,onRequestMoreCompletions:d,onRequestCompletion:u,showInlineEmbeddedDisplay:!0})})}),c.jsxs("div",{className:se(),children:[c.jsxs("div",{className:se("mb-2 grid w-full grid-cols-2 gap-5"),children:[c.jsx("div",{children:c.jsx("p",{className:se("font-semibold"),children:I})}),c.jsx("div",{children:c.jsx("p",{className:se("font-semibold"),children:ue})})]}),c.jsxs("div",{className:se("mb-5 grid w-full grid-cols-2 gap-5"),children:[c.jsxs(Fu,{children:[c.jsx(Aa,{children:c.jsx(oo,{currentModelId:a,turnIndex:x,conversationLeafId:f,isFinalTurn:!0,clientThreadId:o,onChangeItemInView:l,onChangeRating:_t,onRequestMoreCompletions:d,onRequestCompletion:u,showInlineEmbeddedDisplay:!0})}),c.jsx(Pu,{children:c.jsx(Gn.Button,{disabled:!dn,title:Ee,onClick:()=>Q("left"),color:"primary"})})]}),c.jsxs(Fu,{children:[c.jsx(Aa,{children:c.jsx(oo,{currentModelId:a,turnIndex:h,conversationLeafId:w,isFinalTurn:!0,clientThreadId:o,onChangeItemInView:l,onChangeRating:_t,onRequestMoreCompletions:d,onRequestCompletion:u,showInlineEmbeddedDisplay:!0})}),c.jsx(Pu,{children:c.jsx(Gn.Button,{disabled:!dn,title:ke,onClick:()=>Q("right"),color:"primary"})})]})]}),c.jsx("div",{className:se("grid w-full"),children:c.jsxs("div",{className:se("mb-2 text-right"),children:[c.jsx(Gn.Button,{disabled:!dn,title:p.formatMessage(Ie.neitherAnswerBetter),color:"primary",onClick:()=>Q("same"),className:se("mr-2")}),c.jsx(Gn.Button,{title:p.formatMessage(Ie.skipStep),onClick:()=>t()})]})})]})]}),c.jsx(Gn.Actions,{primaryButton:Ue})]},`RatingModal-${n}`)}const Pu=Xe.div`mb-2 mt-auto ml-auto mr-auto`,Fu=Xe.div`relative rounded-md border border-token-border-light bg-token-main-surface-secondary flex flex-col overflow-hidden`,V1=Xe.div`mb-5 border bg-token-main-surface-primary overflow-hidden`,Aa=Xe.div``;function W1({clientThreadId:n,currentLeafId:e,currentModelId:t,onChangeItemInView:s,onRequestMoreCompletions:i,onChangeRating:r,onRequestCompletion:o,ratingModalOpen:a,ratingModalNodeId:l,ratingModalCompletionId:d,sharedConversationReportModalNodeId:u,setRatingModalOpen:p,setSharedConversationReportModalNodeId:m}){const b=Fe(),g=S.useRef(null),y=My(lr.SharedConversationModeration),[C,M]=S.useState(!1),_=S.useCallback(E=>{const{customFeedback:P,tags:F,employeeConsented:D}=E;if(a&&l!=null&&l!==""&&(P||F.length>0||D)){const A=O.getServerThreadId(n);ee.logEvent($.reportResult,{id:d,threadId:A,content:P,model:t,rating:a,tags:F}),n&&d&&Ge.submitMessageFeedback({message_id:d,conversation_id:A,rating:a,text:P,tags:F,employee_consented:D})}},[a,l,n,d,t]),R=S.useCallback(E=>{const{customFeedback:P,tags:F}=E;if(u!=null&&u!==""){const D=O.getServerThreadId(n);ee.logEvent($.reportResult,{id:d,threadId:D,content:P,model:t,rating:a,tags:F}),Ge.submitSharedConversationReportFeedback({message_id:u,shared_conversation_id:D,text:P,tags:F}),M(!0)}},[u,n,d,t,a,M]),N=S.useCallback(async(E,P,F,D,A,G,W,j,z,H,K)=>{await Ge.submitMessageComparisonFeedback({feedback_version:"comparison_feedback_modal:a:1.0",original_message_id:E,new_message_id:P,rating:F,conversation_id:O.getServerThreadId(n),text:H,tags:K.map(J=>J.replace("feedback-","")),completion_comparison_rating:D,new_completion_placement:A,feedback_start_time:G,compare_step_start_time:W,new_completion_load_start_time:j,new_completion_load_end_time:z,frontend_submission_time:Date.now(),timezone_offset_min:new Date().getTimezoneOffset()})},[n]);return a!=null?c.jsx(Ia,{ratingModalNodeId:l,ratingModalOpen:a,onCloseRatingModal:()=>p(void 0),onSubmitFeedback:_,onHandleChangeFeedbackComparisonRating:N,currentModelId:t,feedbackTextareaRef:g,clientThreadId:n,onChangeItemInView:s,onRequestMoreCompletions:i,onChangeRating:r,onRequestCompletion:o}):u!=null?c.jsx(Ia,{ratingModalNodeId:u,ratingModalOpen:"report",onCloseRatingModal:()=>m(void 0),onSubmitFeedback:R,onHandleChangeFeedbackComparisonRating:_t,currentModelId:t,feedbackTextareaRef:g,clientThreadId:n,onChangeItemInView:s,onRequestMoreCompletions:i,onChangeRating:r,onRequestCompletion:o}):C?c.jsx(Qh,{onClose:()=>M(!1),isOpen:!0,icon:ub,title:b.formatMessage(Ra.reportModalThankYouTitle),description:b.formatMessage(Ra.reportModalThankYouDescription),primaryButton:c.jsx(Gn.Button,{onClick:()=>M(!1),title:b.formatMessage(Ra.reportModalThankYouDismiss)}),type:"danger"}):y?c.jsx(Ia,{ratingModalNodeId:e,ratingModalOpen:"moderate",onCloseRatingModal:()=>Ii.closeModal(lr.SharedConversationModeration),onSubmitFeedback:_t,onHandleChangeFeedbackComparisonRating:_t,currentModelId:t,feedbackTextareaRef:g,clientThreadId:n,onChangeItemInView:s,onRequestMoreCompletions:i,onChangeRating:r,onRequestCompletion:o}):null}const Ra=Ke({reportModalThankYouTitle:{id:"thread.modal.reportModalThankYou.title",defaultMessage:"Thank you for your report!"},reportModalThankYouDescription:{id:"thread.modal.reportModalThankYou.description",defaultMessage:"Thank you for your report."},reportModalThankYouDismiss:{id:"thread.modal.reportModalThankYou.dismissButton",defaultMessage:"Close"}}),G1=({clientThreadId:n})=>{const e=On(),t=Mn(n),{data:s,isLoading:i}=Ms(t);if(i)return null;const r=e!=null&&e.id?s?Da.loggedInCtaGizmo:Da.loggedInCta:Da.loggedOutCta,o=e&&s?ef(s):"/";let a=$.sharedConversationLoggedOutClicked;return e&&(e.isFree()?a=s?$.sharedConversationFreeGizmoClicked:$.sharedConversationFreeClicked:a=s?$.sharedConversationPaidGizmoClicked:$.sharedConversationPaidClicked),c.jsx("div",{className:"flex flex-col items-center gap-4",children:c.jsx(vy,{href:o,onClickTrackingEventName:a,children:c.jsx(U,{...r,values:{name:s==null?void 0:s.gizmo.display.name}})})})},Da=Ke({loggedOutCta:{id:"GizmoSharedConversationCTA.loggedOutCta",defaultMessage:"Sign up to chat"},loggedInCtaGizmo:{id:"GizmoSharedConversationCTA.loggedInCtaGizmo",defaultMessage:"Get started with {name}"},loggedInCta:{id:"GizmoSharedConversationCTA.loggedInCta",defaultMessage:"Get started with ChatGPT"}});function q1({clientThreadId:n,isModeratingThread:e,continueConversationUrl:t}){const s=Li(),i=Fe();return c.jsxs("div",{className:"relative flex w-full flex-1 flex-col items-center justify-center gap-2 pt-3 empty:hidden sm:flex-row",children:[c.jsx(G1,{clientThreadId:n}),e&&c.jsx(It,{onClick:()=>{Ii.openModal(lr.SharedConversationModeration)},children:i.formatMessage({id:"thread.sharedConversation.moderate",defaultMessage:"Moderate conversation"})}),(s==null?void 0:s.includes("debug"))&&t&&c.jsx(It,{color:"secondary",as:"link",to:t,icon:hb,size:"giant",children:i.formatMessage({id:"thread.sharedConversation.continue",defaultMessage:"Continue this conversation"})})]})}function H1({children:n}){const e=Oo(Po.AG8PqS2q),{eligible:t,isLoading:s}=Ib(),{doesUserHaveAnyAccountsWithPlusFeatures:i}=Bi(),r=t&&!s;if(S.useEffect(()=>{r&&ee.logEvent($.gpt4oNUXTooltipShown)},[r]),!r)return c.jsx(c.Fragment,{children:n});const o=()=>{ee.logEvent($.gpt4oNUXTooltipDismissed),e.markAsViewed()};return c.jsx(vl,{side:"bottom",show:!0,title:c.jsx(U,{...ja.title,values:{modelName:"GPT4o"}}),onDismiss:o,sideOffset:0,theme:"default",description:c.jsx(U,{...i?ja.bodyPaidFinal:ja.bodyFreeFinal,values:{modelName:"GPT4o",anotherModelName:"GPT4"}}),children:n})}const ja=Ke({title:{id:"1kewDD",defaultMessage:"Introducing {modelName}"},bodyPaidFinal:{id:"Z6KHqN",defaultMessage:"You can now try our newest model, {modelName}. Its faster than {anotherModelName}, better at understanding images, and speaks more languages."},bodyFreeFinal:{id:"w8Y79o",defaultMessage:"You now have limited access to our latest model, {modelName}. Its smarter, understands images, can browse the web, and speaks more languages."}});function $1({currentModel:n,categoryOptions:e,className:t,modelSwitcherDenialsBySlug:s}){const i=n==null?void 0:n.id;return c.jsx(Ae.Portal,{children:c.jsx(Ae.SubContent,{className:t,children:e.map(r=>{const{value:o}=r;return"options"in r?c.jsx(lo,{currentModel:n,isSelected:i.startsWith(o),option:r,modelSwitcherDenialsBySlug:s},o):c.jsx(co,{isSelected:i===o,value:o,renderName:()=>r.name,modelSwitcherDenialsBySlug:s,showNewChatHint:!1},o)})})})}function lo({currentModel:n,option:e,isSelected:t=!1,modelSwitcherDenialsBySlug:s}){const{name:i,options:r,categoryId:o}=e,a=`${i} Models`,l=()=>c.jsx("div",{className:"flex shrink-0 grow justify-between gap-2",children:c.jsxs("div",{className:"flex items-center gap-3",children:[c.jsx(pb,{className:"icon-md w-7 text-token-text-secondary"}),a]})});return c.jsxs(Ae.Sub,{children:[c.jsx(Ae.SubMenuTrigger,{children:c.jsxs("div",{className:"flex grow justify-between gap-2 overflow-hidden",children:[o?l():i,t&&c.jsx("div",{className:"truncate text-token-text-tertiary",children:n.title})]})}),c.jsx($1,{currentModel:n,categoryOptions:r,modelSwitcherDenialsBySlug:s})]})}function co({value:n,renderName:e,isSelected:t,showNewChatHint:s=!0,onClick:i,modelSwitcherDenialsBySlug:r,isUpgradeUpsell:o=!1}){var p,m;const a=Dh(),l=Ty(),d=n?(m=(p=r[n])==null?void 0:p.conversation)==null?void 0:m[0]:null,u=c.jsx(Ae.Item,{onClick:()=>{if(i)i();else if(n){const b=n;a({modelId:b,location:"Model switcher menu item"}),l(b)}},className:se("!pr-3",t&&"!opacity-100",d&&"pointer-events-none text-token-text-quaternary"),children:c.jsxs("div",{className:"flex grow items-center justify-between gap-2",children:[c.jsx("div",{children:e(d!=null)}),o&&c.jsx(It,{color:"secondary",size:"small",children:c.jsx(U,{id:"oKo8wt",defaultMessage:"Upgrade"})}),o?c.jsx(c.Fragment,{children:t&&c.jsx(yf,{className:se("icon-md group-hover:invisible",!s&&"block group-hover:hidden")})}):t&&c.jsx(fb,{className:"icon-md"})]})},n);return d?c.jsx(ti,{isLeftArrow:!0,sideOffset:-10,label:c.jsx(Sh,{modelSwitcherDeny:d}),children:u}):u}const K1=ze(()=>Oe(()=>import("./h9alw8xbmjdggtxz.js"),__vite__mapDeps([84,1,2,3,11,4,5,8,6,7,85,68])).then(n=>n.ThreadHeaderGizmoDropdown)),J1=ze(()=>Oe(()=>import("./sso-dud3eqjhdwr0lbxq.js").then(n=>n.h),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66])).then(n=>n.default)),Bu=Xe.div`group flex cursor-pointer items-center gap-1 rounded-lg py-1.5 px-3 text-lg font-semibold hover:bg-token-main-surface-secondary radix-state-open:bg-token-main-surface-secondary text-token-text-secondary overflow-hidden whitespace-nowrap`;function Y1({clientThreadId:n}){const e=Fe(),t=es(),s=$l(n),i=Pi(),r=()=>{Iy(i,s,t,!0)};return c.jsx(Ae.Item,{size:"large",className:"!pr-3",onClick:r,icon:pf,children:c.jsxs("div",{className:"flex grow items-center justify-between gap-2",children:[c.jsx("div",{className:"flex flex-1 items-center gap-3",children:c.jsx(U,{...nE.temporaryChat})}),c.jsx(_y,{onChange:r,enabled:t,label:e.formatMessage({defaultMessage:"Temporary",id:"temporaryChatToggleLabel"})})]})})}function bm(n,e,t){let s=n;if(n===Gc.AUTO){const o=e.filter(({defaultModel:a})=>a!==Gc.AUTO);o.length===1&&(s=o[0].defaultModel)}const i=e.find(({defaultModel:o})=>o===s);if(i){const{categoryId:o,shortLabel:a}=i;return{selectedCategory:o,modelLabel:a}}const r=t.find(({modelIds:o})=>o.includes(s));if(r){const{group:o,shortLabel:a}=r;return{selectedCategory:o,modelLabel:a}}return{selectedCategory:null,modelLabel:null}}function Q1({modelLabel:n}){return c.jsx("span",{className:"text-token-text-secondary",children:n})}function X1({clientThreadId:n,inMobileHeader:e}){const{isLoading:t,categories:s,groups:i}=Mr(),r=Jx(),a=Ll(n).id,l=Cc(),{modelLabel:d}=bm(a,s,i),u=Z1(n,l),p=Fe(),{isUnauthenticated:m}=Zt(),b=wm(),g=(!m||!b)&&!r;S.useEffect(()=>{var C;t||(C=Nh({namespace:mo.ChatPageLoad}))==null||C.logTiming("render_model_switcher")},[t]);const y=c.jsxs("div",{className:"text-token-text-secondary",children:[Ny," ",g?c.jsx("span",{className:"text-token-text-secondary",children:d}):m&&d?c.jsx(Q1,{modelLabel:d}):null]});return u.length?t?null:c.jsx(Eb,{sideOffset:8,size:"large",triggerButton:c.jsxs(Bu,{"aria-label":d?p.formatMessage({id:"JrtGPQ",defaultMessage:"Model selector, current model is {modelLabel}"},{modelLabel:d}):"",children:[y,c.jsx(Ho,{className:"icon-md text-token-text-tertiary"})]}),onOpenChange:C=>{ee.logEvent($.toggleModelSwitcher,{isOpen:C}),rt.logEvent("toggle_model_switcher",null,{isOpen:String(C)})},contentAlign:e?"center":"start",children:c.jsx(eE,{sections:u})}):c.jsx(Bu,{className:"cursor-default",children:y})}function wm(){return Vo("462735957").value}function Z1(n,e){var K,J,de;const t=Ll(n),s=t.id,i=Mn(n),{categories:r,groups:o}=Mr(),{doesUserHaveAnyAccountsWithPlusFeatures:a}=Bi(),l=O.getServerThreadId(n),d=nm({clientThreadId:n}),u=Cb(),p=Fe(),m=!l,{isUnauthenticated:b}=Zt(),g=Ih(),{layer:y}=zi("2723963139"),C=y.get("is_dynamic_model_enabled",!1),M=wm(),_=e.find(({categoryId:V})=>V===Os.ALPHA),R=e.find(({categoryId:V})=>V===Os.EXPERIMENTS),N=e.find(({categoryId:V})=>V===Os.MAINLINE),E=!!((K=_==null?void 0:_.options)!=null&&K.length),P=!!((J=R==null?void 0:R.options)!=null&&J.length),F=!!((de=N==null?void 0:N.options)!=null&&de.length),D=Fi(),A=S.useCallback(()=>{ee.logEvent($.openModalAccountPaymentfromModelPicker,{content:"gizmo-button"}),Tl(D,"Thread header dropdown")},[D]),G=()=>{if(rt.logEvent("chatgpt_model_switcher_plus_upgrade_button_clicked"),ee.logEvent($.modelSwitcherPlusUpgradeButtonClicked),b){Yx.setCookie(Qx.ShowPaymentModal,!0,{maxAge:6*60*60});const V=g();ee.logSignUpButtonClicked({location:"Model switcher GPT-4 upsell",provider:V})}else A()},W=[],j=c.jsxs("div",{className:"mb-1 flex items-center justify-between px-5 pt-2",children:[c.jsx("span",{className:"text-sm text-token-text-tertiary",children:c.jsx(U,{id:"ilkdMh",defaultMessage:"Model"})}),c.jsx("a",{href:C?"https://help.openai.com/en/articles/9155758-what-is-the-chatgpt-plus-model-selector":"https://help.openai.com/en/articles/7102672-how-can-i-access-gpt-4",target:"_blank",rel:"noreferrer",children:c.jsx(hr,{className:"icon-md h-5 w-5 pl-0.5 text-token-text-tertiary"})})]},"header");if(M&&b){const V={id:"modelSection",content:[]};V.content.push(c.jsx(Ey,{},"noAuthUpsell")),W.push(V)}else if(a){const V={id:"modelSection",content:[]};r.length&&V.content.push(j);for(const{categoryId:B,defaultModel:we,label:te,description:ne}of r)V.content.push(c.jsx(co,{value:we,modelSwitcherDenialsBySlug:d,renderName:xe=>c.jsx(Oa,{categoryId:B,name:te,description:ne,isDisabled:xe}),isSelected:!i&&s===we},we));W.push(V)}else{const V={id:"modelSection",content:[]};V.content.push(c.jsx(co,{value:"",onClick:G,modelSwitcherDenialsBySlug:d,isUpgradeUpsell:!0,renderName:B=>c.jsx(Oa,{icon:gb,isDisabled:B,name:p.formatMessage({id:"mzDzkX",defaultMessage:"ChatGPT Plus"}),description:p.formatMessage({id:"bqTHri",defaultMessage:"Our smartest model & more"})}),isSelected:!1,showNewChatHint:!1},"plusUpgrade")),V.content.push(c.jsx(co,{value:la.AUTO,modelSwitcherDenialsBySlug:d,renderName:B=>c.jsx(Oa,{icon:mb,name:p.formatMessage({id:"U9E7Rx",defaultMessage:"ChatGPT"}),description:p.formatMessage({id:"n96qML",defaultMessage:"Great for everyday tasks"}),isDisabled:B}),isSelected:!i&&s===la.AUTO,showNewChatHint:!0},la.AUTO)),W.push(V)}const z={id:"otherOptionsSection",content:[]},{selectedCategory:H}=bm(s,r,o);return m&&(E&&z.content.push(c.jsx(lo,{isSelected:H===Os.ALPHA,currentModel:t,option:_,modelSwitcherDenialsBySlug:d},_.value)),P&&z.content.push(c.jsx(lo,{currentModel:t,isSelected:H===Os.EXPERIMENTS,option:R,modelSwitcherDenialsBySlug:d},R.value)),F&&z.content.push(c.jsx(lo,{isSelected:H===Os.MAINLINE,currentModel:t,option:N,modelSwitcherDenialsBySlug:d},N.value))),u&&z.content.push(c.jsx(J1,{clientThreadId:n},"c")),z.content.length&&W.push(z),b||W.push({id:"temporaryChatSection",content:[c.jsx(Y1,{clientThreadId:n},"tempChat")]}),W}function Oa({isDisabled:n,name:e,icon:t,categoryId:s,description:i,extra:r}){return c.jsxs("div",{className:"flex items-center gap-3",children:[c.jsx("span",{className:"flex h-7 w-7 flex-shrink-0 items-center justify-center rounded-full bg-token-main-surface-secondary",children:t?c.jsx(t,{className:"h-4 w-4 text-token-text-primary"}):s&&c.jsx(Mc,{type:"filled",className:se("h-4 w-4",n&&"text-gray-300",!n&&"text-token-text-primary"),categoryId:s})}),c.jsxs("div",{children:[e,c.jsxs("div",{className:se(!n&&"text-token-text-secondary","text-xs"),children:[i,r]})]})]})}function eE({sections:n}){return c.jsx(c.Fragment,{children:n.map((e,t)=>c.jsxs(Hl.Fragment,{children:[t!==0?c.jsx(Ae.Separator,{}):null,e.content]},e.id))})}function tE({clientThreadId:n,inMobileHeader:e=!1}){const t=Mn(n);return t==null?c.jsx(X1,{clientThreadId:n,inMobileHeader:e}):c.jsx(K1,{clientThreadId:n,gizmoId:t,inMobileHeader:e})}const nE=Ke({gpt35ShortExplainer:{defaultMessage:"Great for everyday tasks",id:"ModelSwitcher.gpt35ShortExplainer"},modelTunerSmartSelectionTitle:{id:"czjW8I",defaultMessage:"Dynamic"},modelTunerSmartSelectionExplainer:{id:"gp/YH1",defaultMessage:"Optimized for speed and intelligence"},gpt4ShortExplainer:{defaultMessage:"With DALLE, browsing and analysis",id:"ModelSwitcher.gpt4ShortExplainer"},gpt4ShortExplainerWithoutBrowse:{defaultMessage:"With DALLE and analysis",id:"ModelSwitcher.gpt4ShortExplainerWithoutBrowse"},gpt4UpsellExplainer:{id:"ModelSwitcher.gpt4Upsell",defaultMessage:"Our smartest and most capable model. Includes DALLE, browsing and more."},userUpgrade:{id:"ModelSwithcer.upgradeButton",defaultMessage:"Upgrade to Plus"},userUpgradeSignup:{id:"ModelSwitcher.signupUpgradeButton",defaultMessage:"Sign up for ChatGPT Plus"},temporaryChat:{id:"ModelSwitcher.temporaryChat",defaultMessage:"Temporary chat"},shareChat:{id:"ModelSwitcher.shareChat",defaultMessage:"Share chat"}}),sE=ze(()=>Oe(()=>import("./deo7a6swbi5be1ab.js"),__vite__mapDeps([86,1,2,3,87,88,4,5,89,11,8,6,7,17,90,12,57,24,69,91,68,85,92,93,13,14,15,16])).then(n=>n.GizmoUsingAsOwnerNotice)),iE=({clientThreadId:n})=>{const e=gh(l=>l.activeStageSidebar),t=O.getServerThreadId(n),s=jy(si.WorkspaceShareLinks),{isUnauthenticated:i}=Zt(),r=es(),o=s&&t&&!i&&!r,a=!e;return c.jsx("div",{className:"flex items-center gap-2 pr-1 leading-[0]",children:c.jsx(vb,{showShareButton:o,showProfileDropdown:a,clientThreadId:n})})};function rE({clientThreadId:n,gizmoId:e}){var r;const t=Ay(),{data:s}=Ms(e),i=On();return c.jsxs(c.Fragment,{children:[c.jsxs(Ry,{children:[c.jsxs("div",{className:"absolute start-1/2 ltr:-translate-x-1/2 rtl:translate-x-1/2",children:[s!=null&&(i==null?void 0:i.isWorkspaceAccount())&&((r=s.gizmo.tags)==null?void 0:r.includes(Rl.WorkspaceDisabled))&&c.jsx(sE,{gizmo:s}),c.jsx(Kb,{gizmoId:e,clientThreadId:n})]}),c.jsx(H1,{children:c.jsxs("div",{className:"flex items-center gap-0 overflow-hidden",children:[c.jsx(Mb,{clientThreadId:n}),c.jsx(tE,{clientThreadId:n})]})}),c.jsx(iE,{clientThreadId:n})]}),t&&c.jsx(Dy,{})]})}function Sm({clientThreadId:n}){const e=Mn(n),t=Ui();return Tr()?t?null:c.jsx(rE,{gizmoId:e,clientThreadId:n}):c.jsx("div",{className:"h-1.5"})}function oE({clientThreadId:n,currentModelId:e,onRequestCompletion:t,enableV2Homepage:s}){const i=es();let r=c.jsx(q0,{}),o;return i?(o=c.jsx(aE,{}),r=c.jsx(Ku,{className:"mb-6 h-12 w-12"})):n!=null?(o=s?c.jsx(Av,{clientThreadId:n,currentModelId:e,onRequestCompletion:t}):c.jsx(H0,{clientThreadId:n}),r=null):o=c.jsx(lE,{}),c.jsxs("div",{className:"flex h-full flex-col items-center justify-center text-token-text-primary",children:[r,o]})}function aE({gizmo:n}){const e=Gu(),t=n?Vb(n.tools):!1,s=On();return c.jsxs(c.Fragment,{children:[c.jsx("div",{className:"mb-5 text-2xl font-semibold",children:c.jsx(U,{...Ps.temporaryChat})}),c.jsxs("div",{className:"max-w-sm text-center text-sm font-normal text-token-text-tertiary",children:[c.jsx(U,{...s!=null&&s.isWorkspaceAccount()?e?Ps.temporaryChatBizMemoryAvailable:Ps.temporaryChatBizMemoryUnavailable:e?Ps.temporaryChatDescriptionMemoryAvailable:Ps.temporaryChatDescriptionMemoryUnavailable}),t&&c.jsx("div",{className:"mt-3",children:c.jsx(U,{...Ps.temporaryChatDescriptionGptActions,values:{link:i=>c.jsx("a",{href:"https://help.openai.com/en/articles/8914046-temporary-chat-faq",target:"_blank",className:"underline",rel:"noreferrer",children:i})}})})]})]})}function lE(){return c.jsx("div",{className:"mb-5 text-2xl font-semibold",children:c.jsx(U,{...Ps.howCanIHelpYouToday})})}function cE({clientThreadId:n,currentModelId:e,onRequestCompletion:t,enableV2Homepage:s}){const i=Mn(n),r=Oy(),o=Wl(),{data:a}=Ms(i);return(r!=null||i!=null)&&a==null?null:c.jsxs("div",{className:"relative h-full",children:[c.jsx("div",{className:"absolute left-0 right-0",children:c.jsx(Sm,{clientThreadId:n})}),a!=null?c.jsx(G0,{gizmo:a,showStarterPrompts:!0,disableStarterPrompts:o}):c.jsx(oE,{clientThreadId:n,currentModelId:e,onRequestCompletion:t,enableV2Homepage:s})]})}const Ps=Ke({temporaryChat:{id:"GizmoLanding.temporaryChat",defaultMessage:"Temporary Chat"},temporaryChatBizMemoryAvailable:{id:"g1opBW",defaultMessage:"This chat won't appear in your history and won't use or create memories."},temporaryChatBizMemoryUnavailable:{id:"fQmbtG",defaultMessage:"This chat won't appear your conversation history."},temporaryChatDescriptionMemoryAvailable:{id:"GizmoLanding.temporaryChatDescriptionMemoryAvailable",defaultMessage:"This chat won't appear in history, use or create memories, or be used to train our models. For safety purposes, we may keep a copy for up to 30 days."},temporaryChatDescriptionMemoryUnavailable:{id:"GizmoLanding.temporaryChatDescriptionMemoryUnavailable",defaultMessage:"This chat won't appear in history or be used to train our models. For safety purposes, we may keep a copy of this chat for up to 30 days."},temporaryChatDescriptionGptActions:{id:"GizmoLanding.temporaryChatDescriptionGptActions",defaultMessage:"Any data shared with a third party through GPT actions are subject to the third party's privacy policy. <link>Learn more</link>"},howCanIHelpYouToday:{id:"GizmoLanding.howCanIHelpYouToday",defaultMessage:"How can I help you today?"}});function dE(n){var t,s;const e=(t=n.message.metadata)==null?void 0:t.aggregate_result;return(s=e==null?void 0:e.messages)==null?void 0:s.some(tc)}function uE(n){const e=n.message.content;return("parts"in e?e.parts.join(""):"").includes("sandbox:")}function hE(n){return n.some(e=>e.messages.some(t=>dE(t)||uE(t)))}function fE({clientThreadId:n}){const e=A0(n),t=of(n),s=Zn(u=>Ot.getThreadCreateTime(n,u)),i=Rn(n),r=rf(n,i),o=S.useMemo(()=>hE(r),[r]),a=R0(n),l=D0(n),d=a||l;return c.jsxs("div",{className:"border-b border-gray-100 px-4 pb-4 pt-3 sm:mb-2 sm:pb-6 sm:pt-8 md:px-0",children:[c.jsx("h1",{className:"text-3xl font-semibold leading-tight text-token-text-primary sm:text-4xl",children:e}),(t!=null||s!=null)&&c.jsxs("div",{className:"pt-3 text-base text-gray-400 sm:pt-4",children:[t!=null&&c.jsx("span",{children:t}),t!=null&&s!=null&&c.jsx("span",{className:"px-2",children:""}),s!=null&&c.jsx(Xx,{value:s,month:"long",year:"numeric",day:"numeric"})]}),c.jsx(pE,{shouldShowCodeInterpreterDisclaimer:o,shouldShowPersonalizedDataDisclaimer:d})]})}const pE=({shouldShowCodeInterpreterDisclaimer:n,shouldShowPersonalizedDataDisclaimer:e})=>c.jsxs(c.Fragment,{children:[n&&c.jsx("div",{className:"mt-4",children:c.jsx(Lc,{icon:hr,children:c.jsx(U,{id:"sharedConversation.advancedDataAnalysisSupportDisclaimer",defaultMessage:"This chat contains files or images produced by Advanced Data Analysis which are not yet visible in Shared Chats."})})}),e&&c.jsx("div",{className:"mt-4",children:c.jsx(Lc,{icon:hr,children:c.jsx(U,{id:"sharedConversation.personalizedDataDisclaimer",defaultMessage:"This conversation may reflect the link creators personalized data, which isnt shared and can meaningfully change how the model responds."})})})]}),mE=n=>{const e=es();return S.useCallback(t=>{var a,l;Py(t);const{target:s}=t;if(!(s instanceof Element))return;const i=(a=s.closest("[data-message-id]"))==null?void 0:a.getAttribute("data-message-id"),r=(l=document.getSelection())==null?void 0:l.toString(),o=O.getServerThreadId(n);!i||!r||!o||e||Ge.submitImplicitMessageFeedback({source:"keyboard",type:"copy",messageId:i,serverThreadId:o,selectedText:r})},[n,e])};function gE({onChangeItemInView:n,onRequestMoreCompletions:e,onChangeRating:t,onRequestCompletion:s,clientThreadId:i,conversationLeafId:r,inlineEmbeddedDisplay:o,initiallyHighlightedMessageId:a,hideHeader:l,renderOnlyTurns:d}){const u=Xt(),p=Ui(),m=Fy(),[b]=By(),g=vs(i),y=On(),C=Ll(i),M=u.store.useContentAreaDimensions(_i.Header,z=>z!=null&&z.height?z.height:void 0),_=u.store.useIsHeaderContentAreaPopulated(),R=af(i),{isArchived:N}=R,E=Lv(C.id),P=(g==null?void 0:g.kind)===it.GizmoMagicCreate?"bg-token-main-surface-primary text-token-text-primary":E,F=lf(i,r),D=Fo(),A=S.useCallback(()=>{m({behavior:"smooth"})},[m]),G=(z=!0)=>[...new Array(F).keys()].map(H=>c.jsx(oo,{isFinalTurn:z&&H===F-1,turnIndex:H,clientThreadId:i,conversationLeafId:r,onChangeItemInView:n,onChangeRating:t,onRequestMoreCompletions:e,onRequestCompletion:s,currentModelId:C.id,showInlineEmbeddedDisplay:o,initiallyHighlightedMessageId:a,avatarClassName:P,scrollToBottom:A},H)),W=mE(i),j=D&&!N;return d?c.jsx(c.Fragment,{children:G(!1)}):c.jsxs("div",{onCopy:W,className:se("flex flex-col text-sm",p&&"pt-2",j&&"pb-[120px]",M||j?null:"md:pb-9"),style:{paddingBottom:j?void 0:M},children:[!l&&(p||(y==null?void 0:y.data))&&!o&&c.jsx(Sm,{clientThreadId:i}),p&&!o&&c.jsx(Yl,{children:c.jsx(fE,{clientThreadId:i})}),G(),!b&&!o&&c.jsx(yE,{className:se(M?null:"bottom-5",j?_?"translate-y-[-50px]":"translate-y-[-10px]":""),style:{bottom:D?"calc(var(--composer-bar_footer-current-height) + var(--composer-bar_current-height))":M},onClick:()=>{rt.logEvent("chatgpt_thread_scroll_to_bottom"),m({behavior:"smooth"})},children:c.jsx(yb,{className:"icon-md text-token-text-primary"})})]})}const yE=Xe.button`cursor-pointer absolute z-10 rounded-full bg-clip-padding border text-token-text-secondary border-token-border-light right-1/2 translate-x-1/2 bg-token-main-surface-primary w-8 h-8 flex items-center justify-center`;function Lu(n,e){n.updateNodeMetadata(e.id,{completionSampleFinishTime:Date.now()})}class xE{constructor(e,t,s,i,r,o,a,l,d,u){re(this,"currentTree");re(this,"currentNodeId");re(this,"firstResponse",!0);re(this,"didCreateFirstCompletionInNewThread",!1);re(this,"activeBranchLastMessage");re(this,"messagesToUpdate",{});re(this,"allIncompleteStreamedMessages",{});re(this,"responseThreadId");re(this,"isCompletionBlocked",!1);re(this,"isEitherFlagged",!1);re(this,"variantsInStreamInfo");re(this,"activeBranchNodeId");re(this,"blurDuringCompletionTracker",new zy);re(this,"completionLatencyTracker");re(this,"debouncedUpdateCompletion",jl(()=>{this.isCompletionBlocked||O.updateTree(this.clientThreadId,e=>{Object.values(this.messagesToUpdate).forEach(t=>{e.updateNodeMessage(t.id,t)})}),this.messagesToUpdate={}},50,{leading:!0,maxWait:50}));re(this,"handleResponse",async e=>{if(this.completionLatencyTracker.onResponse(e,this.activeBranchLastMessage,this.responseThreadId),this.responseThreadId===void 0&&"conversationId"in e){const t=e.conversationId;this.responseThreadId=t,Yn(this.clientThreadId)&&O.getServerThreadId(this.clientThreadId)!==t&&(O.setServerIdForNewThread(this.clientThreadId,t),ee.logEvent($.attributeClientThreadToServerThread,{client_thread_id:this.clientThreadId,server_thread_id:t}))}switch(e.type){case"error":this.handleError(e);break;case"num_variants_in_stream":this.bindVariantInfoToTree(e);break;case"moderation":this.handleModeration(e);break;case"url_moderation":this.handleUrlModeration(e);break;case"message":this.handleMessage(e),this.debouncedUpdateCompletion();break;case"done":this.handleDone();break;case"gizmo_inline_review":this.handleGizmoInlineReview(e);break;case"title_generation":this.handleTitleGeneration(e);break;case"conversation_detail_metadata":this.handleConversationDetailMetadata(e);break}});this.queryClient=e,this.clientThreadId=t,this.targetNodeId=s,this.completionType=i,this.model=r,this.eventSource=o,this.navigate=a,this.callModelAgain=d,this.onCompletionFinished=u,this.currentTree=O.getTree(t),this.currentNodeId=s,this.activeBranchLastMessage=this.currentTree.getMessage(this.currentNodeId),this.completionLatencyTracker=new Ly(l)}handleError(e){const t=e.error,s=(t==null?void 0:t.message)||"Something went wrong",i=t instanceof Bs&&t.code||"";switch(O.updateTree(this.clientThreadId,r=>{r.updateNodeMessage(this.currentNodeId,this.activeBranchLastMessage),r.updateNodeMetadata(this.currentNodeId,{err:s,errType:"danger",errCode:i,completionSampleFinishTime:Date.now()})}),i){case an.ContentPolicy:case an.ContentOrTos:case go:case $h:break;default:s!==void 0&&rt.logEvent("chatgpt_conversation_error_web",s)}this.blurDuringCompletionTracker.onMessageError(),this.cleanUp(),this.onCompletionFinished(this.responseThreadId),t instanceof Bs&&(t==null?void 0:t.code)===go&&(t!=null&&t.clearsIn)&&(Uy(new Date(Date.now()+t.clearsIn*1e3).toISOString()),setTimeout(()=>{Vy()},t.clearsIn*1e3))}handleGizmoInlineReview(e){O.setPromptGptRating(this.clientThreadId,e.gizmoId)}handleTitleGeneration(e){O.setTitle(this.clientThreadId,e.title,tf.Generated)}handleConversationDetailMetadata(e){const{default_model_slug:t}=e;t&&O.setThreadModelId(this.clientThreadId,t),cr.updateDetails(e)}bindVariantInfoToTree(e){this.variantsInStreamInfo=e,O.updateTree(this.clientThreadId,t=>{const s=t.getParentPromptNode(this.currentNodeId);t.updateNodeMetadata(s.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}handleModeration(e){const{isCompletion:t,messageId:s,conversationId:i,flagged:r,blocked:o,disclaimers:a,metadata:l}=e,d=!!(a!=null&&a.length)&&t;(r||o||d)&&(this.isEitherFlagged=!0,o&&t&&(this.isCompletionBlocked=!0),O.updateTree(this.clientThreadId,u=>{const p=u.messageIdToNodeId(s);o&&u.clearNodeMessageParts(p),u.updateNodeMetadata(p,{...(d&&!!(a!=null&&a.length)&&Zx(a,o))??{},...r&&e0,...o&&(l!=null&&l.model_incompatibility?t0:n0),completionSampleFinishTime:Date.now()})}),ee.logEvent(t?o?$.completionBlockedByModeration:$.completionFlaggedByModeration:o?$.promptBlockedByModeration:$.promptFlaggedByModeration,{threadId:i,id:s}))}handleUrlModeration(e){const{conversationId:t,url:s,isSafe:i}=e;i&&O.addThreadSafeUrl(t,s)}handleMessage(e){var r,o,a,l,d,u,p,m,b;let t=!0;const{message:s,conversationId:i}=e;if(this.firstResponse&&!this.currentTree.hasReceivedServerCompletion){if((s==null?void 0:s.author.role)===Ve.System){const g=(r=s.metadata)!=null&&r.parent_id?this.currentTree.getNodeByIdOrMessageId(s.metadata.parent_id):void 0;if((g==null?void 0:g.message.author.role)!==Ve.User){this.currentTree.appendSystemMessageToRoot(s);return}}else if((s==null?void 0:s.author.role)===Ve.User)return;if(this.currentTree.hasNodeOrMessageId(s.id))return}if(this.firstResponse&&((o=s.metadata)!=null&&o.rebase_system_message)){O.updateTree(this.clientThreadId,g=>{var C;if(((C=s.metadata)==null?void 0:C.parent_id)==null)throw Error("Unexpected rebased system message without parent");const y=g.getNodeByIdOrMessageId(this.targetNodeId);g.deleteNode(this.targetNodeId),g.addNode(s.id,s,s.metadata.parent_id,s.author.role),g.addNode(y.id,y.message,s.id,y.message.author.role)});return}if(this.firstResponse){const g=((a=Zn.getState().threads[this.clientThreadId])==null?void 0:a.continuingFromSharedConversationId)!=null;O.removeContinuingFromSharedConversationId(this.clientThreadId),this.firstResponse=!1,this.didCreateFirstCompletionInNewThread=!this.currentTree.hasReceivedServerCompletion||g,O.updateTree(this.clientThreadId,C=>{C.updateNodeMessage(this.currentNodeId,s)}),this.didCreateFirstCompletionInNewThread&&qa.onCreate(this.queryClient);const y={id:this.targetNodeId,threadId:i,completionType:this.completionType,eventSource:this.eventSource,model:this.model};if(this.completionType===In.Next){const C=Zn.getState().threads[i],M=(l=C==null?void 0:C.conversationTurns)==null?void 0:l.length,_=(d=C==null?void 0:C.conversationTurns)==null?void 0:d.filter(N=>N.role==Ve.User),R=_&&((u=_[_.length-1])==null?void 0:u.messages[0].message);if((R==null?void 0:R.content.content_type)==cn.Text){const N=R.content.parts.join("").length,E=(_==null?void 0:_.length)??0;y.countConversationTurns=M,y.countUserSubmittedMessages=E,y.countLastUserPromptTextMessageLength=N}}ee.logEvent($.generateCompletion,y)}else if(this.completionType!==In.Continue){const g=this.currentTree.containsNodeOrMessageId(s.id),y=(p=s.metadata)==null?void 0:p.parent_id;if(g||(this.debouncedUpdateCompletion.flush(),O.updateTree(this.clientThreadId,C=>{if(y==null)throw new Error(`Received a message with no parentId: ${JSON.stringify(s)}`);C.addNode(s.id,s,y,Ve.Assistant)})),y!=null&&y===this.activeBranchNodeId){const C=this.allIncompleteStreamedMessages[y];C!=null&&(O.updateTree(this.clientThreadId,M=>{Lu(M,C)}),delete this.allIncompleteStreamedMessages[y])}if(t=(((m=this.variantsInStreamInfo)==null?void 0:m.num_variants_in_stream)??1)===1||this.activeBranchNodeId==null||this.activeBranchNodeId===s.id||this.currentTree.isAncestorOfNode(this.activeBranchNodeId,s.id),t&&this.activeBranchNodeId!==s.id){this.activeBranchNodeId=s.id,this.currentNodeId=s.id;const C=O.getThreadCurrentLeafId(this.clientThreadId);this.currentTree.messageIdToNodeId(this.currentNodeId)!==this.currentTree.messageIdToNodeId(C)&&O.setThreadCurrentLeafId(this.clientThreadId,this.currentNodeId),y!=null&&O.updateTree(this.clientThreadId,M=>{const _=M.getParentPromptNode(s.id);M.updateNodeMetadata(_.id,{variantsInStreamInfo:this.variantsInStreamInfo})})}}if((s==null?void 0:s.author.role)===Ve.Tool&&(s==null?void 0:s.author.name)==="bio"){const g=(b=s.metadata)==null?void 0:b.gizmo_id;setTimeout(()=>{this.queryClient.invalidateQueries({queryKey:Wy(g)})},5e3)}t&&(this.activeBranchLastMessage=s),this.messagesToUpdate[s.id]=s,this.allIncompleteStreamedMessages[s.id]=s}async handleDone(){var e,t;if(this.isCompletionBlocked||(this.debouncedUpdateCompletion.flush(),this.isEitherFlagged||(this.didCreateFirstCompletionInNewThread&&qa.onCreateFinished(this.navigate,this.queryClient,this.responseThreadId),this.onCompletionFinished(this.responseThreadId))),O.updateTree(this.clientThreadId,s=>{Object.values(this.allIncompleteStreamedMessages).forEach(i=>{Lu(s,i)})}),rt.checkGate("187267097")===!0){const s=await Oe(()=>import("./sso-dud3eqjhdwr0lbxq.js").then(i=>i.F),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66])).then(i=>i).catch(()=>null);s==null||s.addConversation(this.clientThreadId,this.currentNodeId)}if(this.blurDuringCompletionTracker.onMessageDone(),this.cleanUp(),((t=(e=this.activeBranchLastMessage)==null?void 0:e.metadata)==null?void 0:t.client_actions)!==void 0){const s=await Gy(this.clientThreadId,this.activeBranchLastMessage);s.length>0&&this.callModelAgain(this.currentNodeId,s)}}cleanUp(){setTimeout(()=>{zo.removeRequest(this.targetNodeId),O.releaseThread(this.clientThreadId)},0)}}const bE=1e3*30,Pa=Xh.getTracer("completion"),Fa=n=>(n==null?void 0:n.code)==="challenge_required";class Ba extends Error{}function wE(n,e,t,s){const i=async(r=null,o=!1)=>{var j,z,H,K,J,de;const a=new AbortController,l="threadId"in e?e.threadId:void 0,d="continueFromSharedConversationId"in e?e.continueFromSharedConversationId:void 0,u=_r(),p={action:e.completionType,messages:e.messages.length>0?e.messages:void 0,conversation_id:l,continue_from_shared_conversation_id:l!=null?void 0:d,parent_message_id:e.parentMessageId,model:e.model,timezone_offset_min:new Date().getTimezoneOffset(),variant_purpose:(j=e.completionMetadata)==null?void 0:j.variantPurpose,suggestions:(z=e.completionMetadata)!=null&&z.suggestions?e.completionMetadata.suggestions.map(V=>$0(V)):void 0,history_and_training_disabled:e.historyDisabled,juice:(H=e.completionMetadata)==null?void 0:H.juice,conversation_mode:(K=e.completionMetadata)==null?void 0:K.conversationMode,force_paragen:e.forceParagen,force_paragen_model_slug:e.forceParagenModel,force_nulligen:e.forceNulligen,force_indepth_feedback:e.forceIndepthFeedback,force_rate_limit:e.forceRateLimit,reset_rate_limits:e.resetRateLimits,disable_system_content_toggling:e.disableSystemContentToggling,websocket_request_id:u,source:(J=e.completionMetadata)==null?void 0:J.source,system_hints:(de=e.completionMetadata)==null?void 0:de.systemHints,force_use_sse:!bs.isWebsocketConnected(),conversation_origin:e.conversationOrigin,force_use_search:e.forceUseSearch},m=Ph(await Oh(n));let b="https://chatgpt.com/backend-api";m&&(b="https://chatgpt.com/backend-anon");const g=`${b}/conversation`;let y=!0,C=!0;const M=m?qc.getUnauthHeaders().additionalHeaders:await qc.getAuthedHeaders(),_=s0(e.chatReq,r??e.arkoseToken,e.turnstileToken,e.proofToken,null),R={...M,...qy(),..._};let N,E,P;Pa.startActiveSpan("completion.response",V=>{N=Pa.startSpan("completion.first_response"),E=Pa.startSpan("completion.first_token"),P=V});const F=Xh.setSpan(Hc.active(),P);function D(V){if(V.data==="[DONE]")a.abort(),P.end(),t({type:"done"});else if(V.event!=="ping")try{const B=JSON.parse(V.data);if(B.error){const we=new rs(B.error);throw t({type:"error",error:we}),we}else"type"in B?B.type==="gizmo_inline_review"?t({type:"gizmo_inline_review",gizmoId:B.gizmo_id}):B.type==="title_generation"?t({type:"title_generation",title:B.title,conversation_id:B.conversation_id}):B.type==="moderation"?t({type:"moderation",conversationId:B.conversation_id,messageId:B.message_id,isCompletion:B.is_completion,flagged:B.moderation_response.flagged,blocked:B.moderation_response.blocked,disclaimers:B.moderation_response.disclaimers,metadata:B.moderation_response.metadata}):B.type==="url_moderation"?t({type:"url_moderation",conversationId:B.conversation_id,messageId:B.message_id,url:B.url_moderation_result.full_url,isSafe:B.url_moderation_result.is_safe}):B.type==="num_variants_in_stream"?t({type:"num_variants_in_stream",num_variants_in_stream:B.num_variants_in_stream,display_treatment:B.display_treatment}):B.type==="conversation_detail_metadata"&&t(B):(t({type:"message",message:B.message,conversationId:B.conversation_id}),C&&(C=!1,N.end()),y&&B.message.author.role==="assistant"&&B.message.content.content_type==="text"&&B.message.content.parts[0]!==""&&(y=!1,E.end()))}catch(B){if(B instanceof Bs)throw new rs(B.message)}}let A=null,G=setTimeout(()=>{A===!0?ee.logEvent($.asyncResponseWaitTooLong,{}):A===!1&&ee.logEvent($.sseResponseWaitTooLong,{})},bE);return lw(u,D,a.signal),Hc.with(F,()=>Hy(g,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",...R},body:JSON.stringify(p),signal:a.signal,openWhenHidden:!0,async onopen(V){var te;const B=V.headers.get("content-type")??"",we=V.headers.get("Cf-Ray")??null;if(V.ok&&B.includes("text/event-stream")){A=!1,s(we,e.model);return}else if(B.includes("application/json")){const ne=await V.json(),{webSocketUrl:xe,fallbackWebSocketUrl:Se,conversationId:ge,responseId:ce,expiresAt:Ce,websocketRequestId:ye}=aw(ne);if(xe!=null&&ge!=null&&ce!=null&&ye!=null&&Ce){A=!0,s(we,e.model);try{await cw(xe,Se,Ce,ge,ce,ye,D,a.signal,G)}catch(L){L instanceof rs&&t({type:"error",error:L})}throw new Ba}else{const L=(ne==null?void 0:ne.error)??(ne==null?void 0:ne.detail),Me=(L==null?void 0:L.message)??L??"Unknown server error";if(L){if(Fa(L))throw new Bs(Me,V.status,L.code);if(V.status>=500)throw new rs(Me);if(((L==null?void 0:L.code)==="expired_session_key"||(L==null?void 0:L.code)==="invalid_api_key"||(L==null?void 0:L.code)==="token_expired")&&typeof window<"u"&&((te=window._oaiHandleSessionExpired)==null||te.call(window,"stream",JSON.stringify(L))),(L==null?void 0:L.code)==="deactivated_workspace"){window.location.href.includes("/workspace/deactivated")||(window.location.href="/workspace/deactivated");return}throw new Bs(Me,V.status,L==null?void 0:L.code,L==null?void 0:L.type,void 0,L==null?void 0:L.clears_in)}}}throw new rs($c)},onmessage:V=>{if(A)throw new rs($c);G&&(clearTimeout(G),G=null),D(V)},onerror(V){let B=V instanceof Error?V:new Error(JSON.stringify(V));throw B instanceof Ba||A||Fa(B)&&!o||(B.message==="Failed to fetch"&&(B=new rs(`An error occurred. Either the engine you requested does not exist or there was another issue processing your request. ${Wa}`)),B.message==="network error"&&(B=new Bs(`A network error occurred. Please check your connection and try again. ${Wa}`,400)),i0("fetch-error:conversation:new-message",{url:g,message:B==null?void 0:B.message}),t({type:"error",error:B})),B}})).catch(async V=>{if(Fa(V)){if(o)throw new Bs("Failed to complete your call, please try again",V.status);{const B=await dr.getEnforcementToken(e.chatReq);return i(B,!0)}}V instanceof Ba||jt.addError(V)}),a};return i()}function SE(n,e,t){const s=Wo(),i=Fi(),r=S.useRef(t);r.current=t;const o=S.useCallback(async function({model:a,completionType:l,parentNodeId:d,metadata:u,focusOnNewCompletion:p=!0,completionMetadata:m,chatReq:b,arkoseToken:g,turnstileToken:y,proofToken:C,preflightTime:M,extraStreamParams:_,appendMessages:R,updateTree:N}){var we,te,ne,xe,Se;Eh.publish({kind:"requestCompletion"});const E=O.getTree(n);O.retainThread(n);const P=j0(),F=`${r0}${n}-${P}`,D=`${n}-${P}`;N==null||N();const A=E.getNodeByIdOrMessageId(d),W={gizmo_id:(we=A.message.metadata)==null?void 0:we.gizmo_id};(m==null?void 0:m.juice)!=null&&(W.snorkle_status=1),O.updateTree(n,ge=>{ge.addNode(F,"",d,Ve.Assistant,void 0,W)}),p&&O.setThreadCurrentLeafId(n,F);let j;const z=[];let H=E.getNodeByIdOrMessageId(A.parentId);for(;H!=null&&(((te=H.metadata)==null?void 0:te.isPlaceholderTemplateAssistantWelcomeMessage)===!0||((ne=H.metadata)==null?void 0:ne.isClientCreatedSystemMessage)===!0);){const ge=H.message;z.unshift(ge);const ce=E.getNodeByIdOrMessageId(H.parentId);j=((xe=ce.message)==null?void 0:xe.id)??ce.id,H=ce}if(l===In.Next||l===In.Variant){const ge=E.getNodeByIdOrMessageId(A.parentId);if(j??(j=((Se=ge.message)==null?void 0:Se.id)??ge.id),z.push(A.message),R){let ce=d;O.updateTree(n,Ce=>{for(const ye of R)Ce.insertNodeBefore(F,{id:ye.id,message:ye,parentId:ce,children:[]}),ce=ye.id}),z.push(...R)}}else j??(j=A.message.id);const K=O.getServerThreadId(n);K===void 0&&Yn(n)&&O.updateInitialThreadDataForNewThread(n,a);async function J(ge,ce){const Ce=performance.now(),ye=await Gl();dr.initializeAndGatherData(ye),po.initializeAndGatherData(ye),wo.initializeAndGatherData(ye),O.updateTree(n,be=>{for(const ae of ce)be.addNode(ae.id,ae,ge,Ve.Assistant,{completionSampleFinishTime:Date.now()}),ge=ae.id}),O.setThreadCurrentLeafId(n,ge);const L=await dr.getEnforcementToken(ye),Me=await po.getEnforcementToken(ye),qe=await wo.getEnforcementToken(ye);o({model:a,completionType:In.Next,parentNodeId:ge,metadata:{},chatReq:ye,arkoseToken:L??null,turnstileToken:Me??null,proofToken:qe??null,preflightTime:performance.now()-Ce,extraStreamParams:_})}const de=new xE(s,n,F,l,a,u.eventSource,i,D,J,(...ge)=>r.current(...ge)),V=(ge,ce)=>{$y(D,ce,ge,M)},B=await wE(s,{conversationOrigin:O.getConversationOrigin(n),model:a,completionType:l,threadId:K,continueFromSharedConversationId:e,historyDisabled:Uo(),parentMessageId:j,messages:z,chatReq:b,arkoseToken:g??null,turnstileToken:y??null,proofToken:C??null,completionMetadata:m,..._},de.handleResponse,V);zo.addRequest(F,B),fm.onCompletionRequestStarted(F)},[s,n,e,i]);return o}function kE({clientThreadId:n,currentModelId:e}){const t=Uv(e,sm.CODE_INTERPRETER);ME(t,n)}async function CE({queryKey:[n,e]}){return await Ge.getThreadInterpreterState(e).then(t=>(t.time_remaining_ms===0&&t.kernel_started&&on.warning("This advanced data analysis (beta) chat has timed out. You may continue the conversation, but previous files, links, and code blocks below may not work as expected.",{hasCloseButton:!0,duration:0}),t))}function ME(n,e){const t=Ui(),s=O.getServerThreadId(e);return vr({queryKey:["interpreterState",s],queryFn:CE,enabled:!!(n&&s&&!t),gcTime:0})}const vE=60,TE=({children:n,scrollViewClassName:e,scrollAnchorTopOffset:t=0})=>{const s=S.useRef(null);return c.jsx("div",{className:"h-full",ref:s,children:c.jsx(o0,{children:c.jsx(Bb,{className:"h-full",followButtonClassName:"hidden",initialScrollBehavior:"auto",scrollViewClassName:e,scroller:()=>EE(s,t)?0:1/0,children:n})})})},EE=(n,e)=>{const t=_E(n.current);if(t==null)return!1;const s=t>e,i=t<e-vE;return!s&&!i};function _E(n){if(!n)return null;const e=n.querySelector('[data-scroll-anchor="true"]');if(!e)return null;const t=e.getBoundingClientRect().top,s=n.getBoundingClientRect().top;return t-s}const NE=ze(()=>Oe(()=>import("./ewk3v6ll2f27ssy4.js"),__vite__mapDeps([94,1,2,3,6,4,5,7,8,49,47,48,30,11,68,69,24,57,12,70,50,13,14,15,16,17,63,58,22,71])).then(n=>n.OpenDebugSidebarButton)),IE=ze(()=>Oe(()=>import("./g6gw0kjqzti1otcc.js"),__vite__mapDeps([95,1,2,3,4,5,65,7])),{ssr:!1}),AE=ze(()=>Oe(()=>import("./sso-dud3eqjhdwr0lbxq.js").then(n=>n.j),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66])).catch(()=>()=>null),{ssr:!1}),RE=ze(()=>Oe(()=>import("./sso-dud3eqjhdwr0lbxq.js").then(n=>n.P),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66])).then(n=>n.default)),DE=ze(()=>Oe(()=>import("./sso-dud3eqjhdwr0lbxq.js").then(n=>n.k),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66])).then(n=>n.CAFeedbackModal).catch(()=>()=>null)),Cs=Ke({doNotShareSensitive:{id:"thread.modal.onboarding.title",defaultMessage:"Do not share sensitive materials with this application"},mayProduceInaccurateInformation:{id:"thread.chatgptMayProduceInaccurateInformation-oct-30",defaultMessage:"ChatGPT can make mistakes. Check important info."},mayProduceInaccurateInformationNoAuth:{id:"thread.chatgptMayProduceInaccurateInformationNoAuth-march-27",defaultMessage:"ChatGPT can make mistakes. Check important info. Read our <termsLink>Terms</termsLink> and <privacyLink>Privacy Policy</privacyLink>."},mayProduceInaccurateInformationNoAuthV2:{id:"thread.chatgptMayProduceInaccurateInformationNoAuth-may-06",defaultMessage:"By messaging ChatGPT, you agree to our <termsLink>Terms</termsLink> and have read our <privacyLink>Privacy Policy</privacyLink>."},mayProduceInaccurateInformationNoAuthKorea:{id:"thread.chatgptMayProduceInaccurateInformationNoAuthKorea-may-06",defaultMessage:"By messaging ChatGPT, you agree to our <termsLink>Terms</termsLink> and have read our <privacyLink>Privacy Policy</privacyLink> and its <koreaAddendumLink>Korea addendum</koreaAddendumLink>."},businessDisclaimer:{id:"thread.businessDisclaimer-oct-30",defaultMessage:"{workspaceName} workspace chats aren't used to train our models. ChatGPT can make mistakes."},businessDisclaimerNoName:{id:"thread.businessDisclaimerNoName-oct-30",defaultMessage:"Your workspace chats aren'ts used to train our models. ChatGPT can make mistakes."},outdatedGptDisclaimer:{id:"thread.outdatedGptDisclaimer.0",defaultMessage:"<bold>New version of GPT available</bold> - Continue chatting to use the old version, or start a <link>new chat</link> for the latest version."},somethingWentWrong:{id:"thread.modal.unrecoverableError.title",defaultMessage:"Something went wrong"},tryAgainLater:{id:"thread.modal.unrecoverableError.description",defaultMessage:"We're sorry, but something went wrong. Please try again later."},resetThread:{id:"thread.modal.unrecoverableError.resetThread",defaultMessage:"Reset thread"},sharedConversationReportConversation:{id:"thread.sharedConversation.report",defaultMessage:"Report conversation"},latencyButton:{id:"thread.latencyButton",defaultMessage:"Latency"},archivedConversationDescription:{id:"thread.archivedConversationDescription",defaultMessage:"This conversation is archived. To continue, please unarchive it first."},unarchiveButton:{id:"thread.unarchiveButton",defaultMessage:"Unarchive"}});function jE({clientThreadId:n}){const e=Mn(n);return e!=null?c.jsx(OE,{clientThreadId:n,gizmoId:e}):c.jsx(km,{clientThreadId:n})}function OE({clientThreadId:n,gizmoId:e}){const t=Ms(e).data,s=Zn(r=>Ot.getThreadCreateTime(n,r)),i=(t==null?void 0:t.gizmo.updated_at)!=null?new Date(t.gizmo.updated_at):void 0;return(t==null?void 0:t.gizmo.short_url)==null||i==null||s==null||i<=s?c.jsx(km,{clientThreadId:n}):c.jsxs("span",{className:"text-token-text-tertiary",children:[c.jsx(gf,{className:"text-token-secondary mb-1 mr-1 inline-block h-4 w-4 stroke-0"}),c.jsx(U,{...Cs.outdatedGptDisclaimer,values:{link:r=>c.jsx(p0,{href:Zh(t.gizmo.short_url),className:"underline",shallow:!0,children:r}),bold:r=>c.jsx("span",{className:"text-token-secondary font-semibold",children:r})}})]})}function km({clientThreadId:n}){const e=xo(Pl.isBusinessWorkspace),t=xo(u=>u.currentWorkspace),s=t==null?void 0:t.name,{isUnauthenticated:i,isLoading:r}=Zt(),a=cf({clientThreadId:n,role:Ve.User})>0,l=th(u=>u.hasAcceptedFooterDisclaimer),d=i&&!a&&!l;return r?null:e?c.jsx("span",{children:s!=null?c.jsx(U,{...Cs.businessDisclaimer,values:{workspaceName:s}}):c.jsx(U,{...Cs.businessDisclaimerNoName})}):d?c.jsx(PE,{clientThreadId:n}):c.jsx("span",{children:c.jsx(U,{...Cs.mayProduceInaccurateInformation})})}function PE({clientThreadId:n}){const{country:e}=m0(),t=e==="KR"?Cs.mayProduceInaccurateInformationNoAuthKorea:Cs.mayProduceInaccurateInformationNoAuthV2;return S.useEffect(()=>()=>{cf({clientThreadId:n,role:Ve.User})>0&&ix.updateHasAcceptedFooterDisclaimer()},[n]),c.jsx("span",{className:"text-sm",children:c.jsx(U,{...t,values:{privacyLink:s=>c.jsx("a",{href:"https://openai.com/privacy",target:"_blank",className:"text-token-text-primary underline decoration-token-text-primary",onClick:()=>{rt.logEvent("chatgpt_footer_disclaimer_privacy_link_clicked"),ee.logEvent($.footerDisclaimerPrivacyLinkClicked)},children:s}),termsLink:s=>c.jsx("a",{href:"https://openai.com/terms",target:"_blank",className:"text-token-text-primary underline decoration-token-text-primary",onClick:()=>{rt.logEvent("chatgpt_footer_disclaimer_terms_link_clicked"),ee.logEvent($.footerDisclaimerTermsLinkClicked)},children:s}),koreaAddendumLink:s=>c.jsx("a",{href:"https://openai.com/ko/policies/kr-privacy-policy-addendum",target:"_blank",className:"text-token-text-primary underline decoration-token-text-primary",onClick:()=>{rt.logEvent("chatgpt_footer_disclaimer_korea_addendum_link_clicked"),ee.logEvent($.footerDisclaimerKoreaAddendumLinkClicked)},children:s})}})})}function FE({clientThreadId:n}){const e=Wo(),t=Ir(n),s=async()=>{t&&(await Ge.patchConversation(t,{is_archived:!1}),e.invalidateQueries({queryKey:["conversation",n]}),Zn.setState(i=>{const r=i.threads[t];r!=null&&(r.initialThreadData.isArchived=!1)}),Ml(e))};return c.jsxs("div",{className:"my-6 flex flex-col items-center justify-center gap-4",children:[c.jsx("div",{className:"px-3 text-center text-sm text-token-text-secondary",children:c.jsx(U,{...Cs.archivedConversationDescription})}),c.jsx("div",{children:c.jsx(It,{disabled:!t,onClick:s,icon:xb,children:c.jsx(U,{...Cs.unarchiveButton})})})]})}function BE(n,e){const t=Yn(n),s=O.getTitle(n);return e&&e.kind===it.GizmoInteraction&&e.gizmo?t?`ChatGPT - ${e.gizmo.gizmo.display.name}`:s&&`${e.gizmo.gizmo.display.name} - ${s}`:t?"ChatGPT":s}const E_=function({clientThreadId:n,initiallyHighlightedMessageId:e,continueConversationUrl:t,onCompletionFinished:s,preRequestCompletion:i,hideHeader:r,hideMessages:o,hideFooter:a,hideToolsOverlay:l,messagesVerticalAlign:d="top",prependThreadChildren:u,renderEmptyState:p}){var li,ci,di;const m=Wo(),b=S.useContext(Yh),g=b!=null,y=On(),C=Li(),M=Tr(),_=zl(),R=M,N=Ni(),E=Ko(n),P=Pi(),F=g&&((ci=(li=P.query)==null?void 0:li.shareParams)==null?void 0:ci[1])==="moderate",D=Kl(n),A=Rn(n),W=af(n).isArchived;S.useEffect(()=>{D||(Yn(n)?jt.addTiming("chatgpt.web.chatPage.renderNewConversation"):jt.addTiming("chatgpt.web.chatPage.renderExistingConversation"))},[n,D]);const j=O0(n,A),z=lf(n,A),H=of(n),{setTargetedContent:K}=mh(),J=(di=Jn("90459671"))==null?void 0:di.value,[de,V]=S.useState(),[B,we]=S.useState(),[te,ne]=S.useState(),[xe,Se]=S.useState(),ge=C==null?void 0:C.includes(a0),ce=Ky(),Ce=z>=2,ye=Yn(n)&&!Ce&&Qr(E),L=Yn(n)&&!j&&(Qr(E)||(E==null?void 0:E.kind)===it.GizmoTest),qe=Bl().id,be=ux(n)??qe,{value:ae}=Jn("1410082514"),{value:Re}=Jn("4203174056"),oe=_h(be),wt=Ah()[be],Ze=BE(n,E),at=vs(n),$e=kr(),gt=Cf(n),{config:De}=l0("1013114931"),St=De.get("show_follow_ups",!1)&&(y==null?void 0:y.isPersonalAccount()),Ne=!N.displayingSideBySideFeedback&&St;S.useEffect(()=>{Ua()},[]),S.useEffect(()=>{$e||K(void 0)},[n,K,$e]);const Ue=S.useCallback(me=>{if(me==null||(s==null||s(me),Uo())||((at==null?void 0:at.kind)===it.GizmoInteraction&&w0.handleGizmoInteracted(m,at.gizmo_id),!(gt||Ne)))return;const tt=O.getThreadCurrentLeafId(me),ve=O.getTree(me).getMessage(tt);c0(ve)||d0(ve)||Jy(me,ve.id,be)},[m,s,at,gt,Ne,be]),We=P0(n),x=SE(n,We,Ue),h=S.useCallback(()=>{const me=O.getThreadCurrentLeafId(n);if(me==null)return;const tt=O.getTree(n).getBranchFromLeaf(me);zo.abortRequests(tt.map(ve=>ve.id))},[n]),f=ni(),{isUnauthenticated:w}=Zt(),v=Ih(),T=S.useCallback(async({type:me,promptId:yt,requestedModelId:tt,eventMetadata:ve,cancelActiveRequests:Je,focusOnNewCompletion:tn=!0,useDefaultModel:zn,completionMetadata:Is,appendMessages:As,updateTree:Rs})=>{Ua(),Qu.reset(),Je&&h();const ss=performance.now();let Un=be;tt?Un=tt:zn&&(Un=qe);const nt=Nh({namespace:mo.CompletionRequest,key:yt});nt==null||nt.logTiming("start_chat_requirements");const Ds=await Gl();nt==null||nt.logTiming("fetched_chat_requirements"),Ds.force_login&&v({authType:"login"});const Gi=await dr.getEnforcementToken(Ds);nt==null||nt.logTiming("fetched_arkose_token");const na=await po.getEnforcementToken(Ds);nt==null||nt.logTiming("fetched_turnstile_token");const jr=await wo.getEnforcementToken(Ds);nt==null||nt.logTiming("fetched_p_token"),i==null||i(n,yt),x({model:Un,completionType:me,parentNodeId:yt,metadata:ve,focusOnNewCompletion:tn,completionMetadata:Is,chatReq:Ds,arkoseToken:Gi??null,turnstileToken:na??null,proofToken:jr??null,preflightTime:performance.now()-ss,extraStreamParams:{forceParagen:f.forceParagen,forceParagenModel:f.forceParagenModel.value,forceNulligen:f.forceNulligen,forceRateLimit:f.forceRateLimit,resetRateLimits:f.resetRateLimits,disableSystemContentToggling:f.rebaseSystemMessageContent?!0:void 0,forceUseSearch:f.forceUseSearch??void 0},appendMessages:As,updateTree:Rs}),w&&Yy.incrementUserMessageCount()},[qe,be,i,n,x,f.forceParagen,f.forceParagenModel,f.forceNulligen,f.forceRateLimit,f.resetRateLimits,f.rebaseSystemMessageContent,f.forceUseSearch,h,v,w]),I=!!(y!=null&&y.features.includes(si.SharedWebsocket));S.useEffect(()=>{I&&bs.registerIfNotConnected()},[I]),S.useEffect(()=>{const me=()=>{if(document.visibilityState==="visible"){if(!I)return;bs.registerIfNotConnected()}};return document.addEventListener("visibilitychange",me),()=>{document.removeEventListener("visibilitychange",me)}},[I]);const ue=Ir(n);S.useEffect(()=>{const me=()=>{bs.stopConversation(ue)};return window.addEventListener("beforeunload",me),()=>{window.removeEventListener("beforeunload",me)}},[ue]),S0({clientThreadId:n,currentLeafId:A,handleRequestCompletion:T});const Ee=S.useCallback((me,yt,tt=!0,ve="none",Je)=>{const zn=O.getTree(n).getParentPromptNode(me).id;T({type:In.Variant,promptId:zn,eventMetadata:yt,cancelActiveRequests:!1,focusOnNewCompletion:tt,useDefaultModel:Je,completionMetadata:{variantPurpose:ve,conversationMode:Ot.getConversationMode(n)}})},[T,n]),ke=S.useCallback(me=>{const tt=O.getTree(n).getLeafFromNode(me);O.setThreadCurrentLeafId(n,tt.id)},[n]),[Te,Q]=S.useState(),dn=S.useCallback(({nodeId:me,messageId:yt,rating:tt})=>{var zn,Is;const ve=O.getServerThreadId(n);ee.logEvent($.thumbRating,{id:yt,threadId:ve,rating:tt,model:be});const Je=O.getTree(n),tn=Je.getNodeByIdOrMessageId(me);if(ve!==void 0&&(ae&&((zn=tn.message.metadata)==null?void 0:zn.snorkle_status)!=null?Ge.submitSnorkleFeedback:oe?_t:Ge.submitMessageFeedback)({message_id:yt,conversation_id:ve,rating:tt}),O.updateTree(n,As=>{As.updateNodeMetadata(me,{rating:tt})}),oe){Q(c.jsx(DE,{citations:((Is=tn.message.metadata)==null?void 0:Is.citations)??[],rating:tt,conversationId:ve??"",messageId:yt,onSubmit:()=>{Q(void 0)},onCancel:()=>Q(void 0),conversationTree:Je,nodeId:me},`${me}-${tt}`));return}if(!rt.getExperimentValue({experimentName:"101132775",key:"show_new_ui",defaultValue:!1})&&(ne(me),Se(yt),we(tt),tt==="thumbsDown"&&R)){const Rs=O.getTree(n).getConversationTurns(me||"root"),ss=Rs[Rs.length-1];ao(ss)&&Ee(me,{eventSource:"mouse",intent:"comparison"},!1,"comparison")}},[n,be,R,Ee,oe,ae]),{setShowReferralInviteModal:kt}=zc(me=>({setShowReferralInviteModal:me.setShowReferralInviteModal})),_s=S.useCallback(()=>{kt(!1)},[kt]),Ns=zc(me=>me.showReferralInviteModal);kE({clientThreadId:n,currentModelId:be});const un=me=>g?c.jsx("div",{className:"h-full overflow-auto bg-token-main-surface-primary",children:me}):c.jsx(TE,{scrollAnchorTopOffset:r?0:rx,children:d==="bottom"?c.jsxs("div",{className:"flex h-full flex-col",children:[c.jsx("div",{className:"flex-1"}),me]}):me}),Be=(me=!1)=>c.jsx(gE,{onChangeItemInView:ke,onRequestMoreCompletions:Ee,onChangeRating:dn,onRequestCompletion:T,clientThreadId:n,initiallyHighlightedMessageId:e,inlineEmbeddedDisplay:!1,conversationLeafId:A,hideHeader:r,renderOnlyTurns:me},n);S.useEffect(()=>{document.title=Ze??"ChatGPT"},[Ze]);const et=Mn(n),He=es(),Pn=L&&!p&&_&&!et&&!oe&&!He,ts=Iv(Pn),Fn=Pn&&ts,{composerBarSize:Bn,composerSkeleton:en,footerBarSize:ri,isClippedComposerBar:Vt,setComposerBarElement:oi,setFooterBarElement:ns,ThreadSizeWrapper:Ln}=Qy({isArchived:W}),ai=Vt?{footerBarSize:ri,composerBarSize:Bn}:{};return c.jsxs(Ln,{...ai,children:[ge&&c.jsx(IE,{}),Re&&c.jsx(RE,{}),c.jsxs(u0,{children:[Ze!=null&&c.jsx("title",{children:Ze}),g&&c.jsxs(c.Fragment,{children:[c.jsx("meta",{property:"og:site_name",content:"ChatGPT"}),c.jsx("meta",{name:"robots",content:b.isIndexable?"index,nofollow":"noindex,nofollow"},"robots"),c.jsx("meta",{property:"og:title",content:Ze??"Shared Chat on ChatGPT"},"og:title"),c.jsx("meta",{property:"og:description",content:"Shared "+(H!=null?`by ${H} `:"")+"via ChatGPT"},"og:description"),c.jsx("meta",{property:"og:image",content:h0.src},"og:image")]})]}),(E==null?void 0:E.kind)===it.GizmoInteraction&&E.gizmo&&c.jsx(F0,{gizmo:E.gizmo}),c.jsx(ql.Provider,{value:T,children:c.jsxs(Xy,{children:[c.jsxs(pS,{clientThreadId:n,currentModelConfig:wt,className:"composer-parent flex h-full flex-col focus-visible:outline-0",children:[!o&&c.jsx(LE,{className:se(Vt&&"masked-content"),style:{"--composer-bar_skeleton":en},children:D?null:L?p??c.jsx(cE,{clientThreadId:n,currentModelId:be,onRequestCompletion:T,enableV2Homepage:Fn}):Ce?un(c.jsxs(c.Fragment,{children:[u,Be()]})):null}),c.jsx(zE,{className:se(Vt&&"mask-scrollbars absolute bottom-0 z-20"),children:W?c.jsx(FE,{clientThreadId:n}):c.jsxs("div",{className:se(Vt&&"relative mx-auto flex max-w-3xl flex-1 flex-col"),children:[Vt?c.jsx(Zy,{skeleton:en}):null,g?c.jsx(q1,{clientThreadId:n,isModeratingThread:F,continueConversationUrl:t}):!Fn&&c.jsx(Tv,{clientThreadId:n,isNewThread:ye,setComposerBarElement:oi,showPromptStarters:ye||!j,currentModelId:be,onRequestCompletion:T}),!a&&c.jsx("div",{ref:ns,className:"relative w-full px-2 py-2 text-center text-xs text-token-text-secondary empty:hidden md:px-[60px]",children:g?c.jsx(ex,{onClickReportSharedConversation:()=>{J?Ii.openModal(lr.ReportConversation):V(A)}}):Qr(E)&&c.jsx(jE,{clientThreadId:n})})]})})]}),!l&&c.jsxs("div",{className:"group absolute bottom-2 end-2 z-20 hidden gap-1 md:flex lg:bottom-3 lg:end-3",children:[ce?c.jsxs(c.Fragment,{children:[c.jsx(NE,{}),c.jsx(AE,{})]}):null,c.jsx(Lb,{})]}),Te,c.jsx(B0,{serverThreadId:(b==null?void 0:b.serverSharedThreadId)??void 0,clientThreadId:n,isStaticSharedThread:g}),c.jsx(W1,{clientThreadId:n,currentLeafId:A,currentModelId:be,onChangeItemInView:ke,onRequestMoreCompletions:Ee,onChangeRating:dn,onRequestCompletion:T,ratingModalOpen:B,ratingModalNodeId:te,ratingModalCompletionId:xe,setRatingModalOpen:we,sharedConversationReportModalNodeId:de,setSharedConversationReportModalNodeId:V}),c.jsx(tx,{}),(C==null?void 0:C.includes(f0))&&c.jsx(nx,{isOpen:Ns,onClose:_s}),c.jsx(sx,{conversationId:n,currentModelId:be})]})})]})},LE=Xe.div`grow flex-1 overflow-hidden`,zE=Xe.div`md:pt-0 dark:border-white/20 md:border-transparent md:dark:border-transparent w-full`;export{Xk as $,gs as A,l_ as B,wl as C,ct as D,xi as E,q as F,Bu as G,E_ as H,h_ as I,VT as J,kn as K,ym as L,Qv as M,hm as N,OT as O,ii as P,ta as Q,Et as R,Tk as S,Le as T,T_ as U,v_ as V,TE as W,M_ as X,u_ as Y,yc as Z,du as _,Gv as a,Qk as a0,S_ as a1,hE as a2,gE as a3,Cc as a4,xk as a5,Jw as a6,Ko as a7,m_ as a8,g_ as a9,y_ as aa,tE as ab,Kb as ac,a_ as ad,Ub as ae,vf as af,oo as ag,rk as ah,Yf as ai,IS as aj,Yt as ak,X as al,eo as am,ic as an,Kv as b,Ts as c,Jt as d,Qo as e,zk as f,Sf as g,_e as h,Kk as i,WS as j,dl as k,SE as l,Tv as m,p_ as n,d_ as o,qw as p,f_ as q,Nn as r,b_ as s,w_ as t,tm as u,bi as v,x_ as w,WM as x,tv as y,IM as z};
//# sourceMappingURL=iwqw67jj1czpe0l0.js.map
